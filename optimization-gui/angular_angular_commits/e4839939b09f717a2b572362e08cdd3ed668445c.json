{
    "author": "JoostK",
    "message": "test(ngcc): don't use the workspace typescript version to generate integration test fixtures (#44448)\n\nNow that ViewEngine libraries can no longer be created, the latest\nTypeScript version that ngcc should be able to process is TypeScript 4.3,\ni.e. the version of TypeScript that was supported in Angular 12.\nHowever, ngcc's integration tests used the TypeScript version of the\nworkspace to create the JavaScript files from TypeScript sources on\ndemand. This introduces friction when upgrading the TypeScript version\nwithin the workspace, as changes to TypeScript's emit format may affect\nngcc's ability to process it correctly.\n\nThe on demand creation of JavaScript files was convenient for authoring\ntests, but it also helped to detect incompatibilities with newer\nversions of TypeScript. Now that ngcc no longer has to process newer\nversions of TypeScript, we want to pin the integration suite to use\nJavaScript code as if it were compiled using TypeScript 4.3, i.e. a\nversion of TypeScript that is actually supported by ngcc.\n\nThis commit updates the integration test to inline all the generated\nfiles directly in the tests, instead of compiling them on demand. This\nwas done by temporarily installing TypeScript 4.3 and using it to create\nthe `loadTestFiles` statement from the original TypeScript inputs.\n\nAn alternative could have been to install TypeScript 4.3 as an actual\ndependency in the workspace and using that to continue compiling the\nintegration suite on demand, but this brings some overhead in package\ninstallations (TypeScript is ~60MB) and the authoring aspect of ngcc\nintegration test is expected to diminish, now that ngcc's support is no\nlonger a moving target.\n\nPR Close #44448",
    "sha": "e4839939b09f717a2b572362e08cdd3ed668445c",
    "files": [
        {
            "sha": "30bfbb57763a6a07daa27a1fb02e585f5e6aaa1c",
            "filename": "packages/compiler-cli/ngcc/test/integration/ngcc_spec.ts",
            "status": "modified",
            "additions": 1668,
            "deletions": 359,
            "changes": 2027,
            "blob_url": "https://github.com/angular/angular/blob/e4839939b09f717a2b572362e08cdd3ed668445c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e4839939b09f717a2b572362e08cdd3ed668445c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts?ref=e4839939b09f717a2b572362e08cdd3ed668445c",
            "patch": "@@ -24,7 +24,7 @@ import {Transformer} from '../../src/packages/transformer';\n import {DirectPackageJsonUpdater, PackageJsonUpdater} from '../../src/writing/package_json_updater';\n import {mockRequireResolveForLockfile} from '../helpers/utils';\n \n-import {compileIntoApf, compileIntoFlatEs2015Package, compileIntoFlatEs5Package, loadNgccIntegrationTestFiles} from './util';\n+import {loadNgccIntegrationTestFiles} from './util';\n \n const ANGULAR_CORE_IMPORT_REGEX = /import \\* as ɵngcc\\d+ from '@angular\\/core';/;\n const testFiles = loadNgccIntegrationTestFiles();\n@@ -237,22 +237,77 @@ runInEachFileSystem(() => {\n \n     it('should generate correct metadata for decorated getter/setter properties', () => {\n       setupAngularCoreEsm5();\n-      compileIntoFlatEs5Package('test-package', {\n-        '/index.ts': `\n-          import {Directive, Input, NgModule} from '@angular/core';\n-\n-          @Directive({selector: '[foo]'})\n-          export class FooDirective {\n-            @Input() get bar() { return 'bar'; }\n-            set bar(value: string) {}\n-          }\n-\n-          @NgModule({\n-            declarations: [FooDirective],\n-          })\n-          export class FooModule {}\n-        `,\n-      });\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test-package/index.d.ts'),\n+          contents: `\n+            export declare class FooDirective {\n+                get bar(): string;\n+                set bar(value: string);\n+            }\n+            export declare class FooModule {\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            var __metadata = (this && this.__metadata) || function (k, v) {\n+                if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n+            };\n+            import { Directive, Input, NgModule } from '@angular/core';\n+            var FooDirective = /** @class */ (function () {\n+                function FooDirective() {\n+                }\n+                Object.defineProperty(FooDirective.prototype, \"bar\", {\n+                    get: function () { return 'bar'; },\n+                    set: function (value) { },\n+                    enumerable: false,\n+                    configurable: true\n+                });\n+                __decorate([\n+                    Input(),\n+                    __metadata(\"design:type\", String),\n+                    __metadata(\"design:paramtypes\", [String])\n+                ], FooDirective.prototype, \"bar\", null);\n+                FooDirective = __decorate([\n+                    Directive({ selector: '[foo]' })\n+                ], FooDirective);\n+                return FooDirective;\n+            }());\n+            export { FooDirective };\n+            var FooModule = /** @class */ (function () {\n+                function FooModule() {\n+                }\n+                FooModule = __decorate([\n+                    NgModule({\n+                        declarations: [FooDirective],\n+                    })\n+                ], FooModule);\n+                return FooModule;\n+            }());\n+            export { FooModule };`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.metadata.json'),\n+          contents: `{}`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/package.json'),\n+          contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+        },\n+      ]);\n \n       mainNgcc({\n         basePath: '/node_modules',\n@@ -275,27 +330,100 @@ runInEachFileSystem(() => {\n              target} format (imported helpers)`,\n          () => {\n            setupAngularCoreEsm5();\n-           compileIntoApf(\n-               'test-package', {\n-                 '/index.ts': `\n-                  import {Directive, Input, NgModule} from '@angular/core';\n-\n-                  const a = { '[class.a]': 'true' };\n-                  const b = { '[class.b]': 'true' };\n-\n-                  @Directive({\n-                    selector: '[foo]',\n-                    host: {...a, ...b, '[class.c]': 'false'}\n-                  })\n-                  export class FooDirective {}\n-\n-                  @NgModule({\n-                    declarations: [FooDirective],\n-                  })\n-                  export class FooModule {}\n-                `,\n-               },\n-               {importHelpers: true, noEmitHelpers: true});\n+           loadTestFiles([\n+             {\n+               name: _('/node_modules/test-package/src/index.d.ts'),\n+               contents: `\n+                export declare class FooDirective {\n+                }\n+                export declare class FooModule {\n+                }`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm2015/src/index.js'),\n+               contents: `\n+                import { __decorate } from \"tslib\";\n+                import { Directive, NgModule } from '@angular/core';\n+                const a = { '[class.a]': 'true' };\n+                const b = { '[class.b]': 'true' };\n+                let FooDirective = class FooDirective {\n+                };\n+                FooDirective = __decorate([\n+                    Directive({\n+                        selector: '[foo]',\n+                        host: Object.assign(Object.assign(Object.assign({}, a), b), { '[class.c]': 'false' })\n+                    })\n+                ], FooDirective);\n+                export { FooDirective };\n+                let FooModule = class FooModule {\n+                };\n+                FooModule = __decorate([\n+                    NgModule({\n+                        declarations: [FooDirective],\n+                    })\n+                ], FooModule);\n+                export { FooModule };`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm2015/index.js'),\n+               contents: `export * from './src/index';`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm5/src/index.js'),\n+               contents: `\n+                import { __assign, __decorate } from \"tslib\";\n+                import { Directive, NgModule } from '@angular/core';\n+                var a = { '[class.a]': 'true' };\n+                var b = { '[class.b]': 'true' };\n+                var FooDirective = /** @class */ (function () {\n+                    function FooDirective() {\n+                    }\n+                    FooDirective = __decorate([\n+                        Directive({\n+                            selector: '[foo]',\n+                            host: __assign(__assign(__assign({}, a), b), { '[class.c]': 'false' })\n+                        })\n+                    ], FooDirective);\n+                    return FooDirective;\n+                }());\n+                export { FooDirective };\n+                var FooModule = /** @class */ (function () {\n+                    function FooModule() {\n+                    }\n+                    FooModule = __decorate([\n+                        NgModule({\n+                            declarations: [FooDirective],\n+                        })\n+                    ], FooModule);\n+                    return FooModule;\n+                }());\n+                export { FooModule };`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm5/index.js'),\n+               contents: `export * from './src/index';`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.d.ts'),\n+               contents: `export * from './src/index';`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.metadata.json'),\n+               contents: `{}`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/package.json'),\n+               contents: `\n+                {\n+                  \"name\": \"test-package\",\n+                  \"version\": \"0.0.1\",\n+                  \"esm5\": \"./esm5/index.js\",\n+                  \"esm2015\": \"./esm2015/index.js\",\n+                  \"module\": \"./esm2015/index.js\",\n+                  \"typings\": \"./index.d.ts\"\n+                }`,\n+             },\n+           ]);\n \n            fs.writeFile(\n                _('/node_modules/tslib/index.d.ts'),\n@@ -316,27 +444,121 @@ runInEachFileSystem(() => {\n              target} format (emitted helpers)`,\n          () => {\n            setupAngularCoreEsm5();\n-           compileIntoApf(\n-               'test-package', {\n-                 '/index.ts': `\n-                    import {Directive, Input, NgModule} from '@angular/core';\n-\n-                    const a = { '[class.a]': 'true' };\n-                    const b = { '[class.b]': 'true' };\n-\n-                    @Directive({\n-                      selector: '[foo]',\n-                      host: {...a, ...b, '[class.c]': 'false'}\n+           loadTestFiles([\n+             {\n+               name: _('/node_modules/test-package/src/index.d.ts'),\n+               contents: `\n+                export declare class FooDirective {\n+                }\n+                export declare class FooModule {\n+                }`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm2015/src/index.js'),\n+               contents: `\n+                var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                    return c > 3 && r && Object.defineProperty(target, key, r), r;\n+                };\n+                import { Directive, NgModule } from '@angular/core';\n+                const a = { '[class.a]': 'true' };\n+                const b = { '[class.b]': 'true' };\n+                let FooDirective = class FooDirective {\n+                };\n+                FooDirective = __decorate([\n+                    Directive({\n+                        selector: '[foo]',\n+                        host: Object.assign(Object.assign(Object.assign({}, a), b), { '[class.c]': 'false' })\n                     })\n-                    export class FooDirective {}\n-\n-                    @NgModule({\n-                      declarations: [FooDirective],\n+                ], FooDirective);\n+                export { FooDirective };\n+                let FooModule = class FooModule {\n+                };\n+                FooModule = __decorate([\n+                    NgModule({\n+                        declarations: [FooDirective],\n                     })\n-                    export class FooModule {}\n-                  `,\n-               },\n-               {importHelpers: false, noEmitHelpers: false});\n+                ], FooModule);\n+                export { FooModule };`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm2015/index.js'),\n+               contents: `export * from './src/index';`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm5/src/index.js'),\n+               contents: `\n+                var __assign = (this && this.__assign) || function () {\n+                    __assign = Object.assign || function(t) {\n+                        for (var s, i = 1, n = arguments.length; i < n; i++) {\n+                            s = arguments[i];\n+                            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n+                                t[p] = s[p];\n+                        }\n+                        return t;\n+                    };\n+                    return __assign.apply(this, arguments);\n+                };\n+                var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                    return c > 3 && r && Object.defineProperty(target, key, r), r;\n+                };\n+                import { Directive, NgModule } from '@angular/core';\n+                var a = { '[class.a]': 'true' };\n+                var b = { '[class.b]': 'true' };\n+                var FooDirective = /** @class */ (function () {\n+                    function FooDirective() {\n+                    }\n+                    FooDirective = __decorate([\n+                        Directive({\n+                            selector: '[foo]',\n+                            host: __assign(__assign(__assign({}, a), b), { '[class.c]': 'false' })\n+                        })\n+                    ], FooDirective);\n+                    return FooDirective;\n+                }());\n+                export { FooDirective };\n+                var FooModule = /** @class */ (function () {\n+                    function FooModule() {\n+                    }\n+                    FooModule = __decorate([\n+                        NgModule({\n+                            declarations: [FooDirective],\n+                        })\n+                    ], FooModule);\n+                    return FooModule;\n+                }());\n+                export { FooModule };`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm5/index.js'),\n+               contents: `export * from './src/index';`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.d.ts'),\n+               contents: `export * from './src/index';`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.metadata.json'),\n+               contents: `{}`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/package.json'),\n+               contents: `\n+                {\n+                  \"name\": \"test-package\",\n+                  \"version\": \"0.0.1\",\n+                  \"esm5\": \"./esm5/index.js\",\n+                  \"esm2015\": \"./esm2015/index.js\",\n+                  \"module\": \"./esm2015/index.js\",\n+                  \"typings\": \"./index.d.ts\"\n+                }`,\n+             },\n+           ]);\n \n            mainNgcc({\n              basePath: '/node_modules',\n@@ -353,27 +575,100 @@ runInEachFileSystem(() => {\n     it(`should be able to detect synthesized constructors in ES5 with downlevelIteration enabled (imported helpers)`,\n        () => {\n          setupAngularCoreEsm5();\n-         compileIntoApf(\n-             'test-package', {\n-               '/index.ts': `\n-                import {Injectable} from '@angular/core';\n-\n-                @Injectable()\n-                export class Base {}\n-\n-                @Injectable()\n-                export class SubClass extends Base {\n-                  constructor() {\n+         loadTestFiles([\n+           {\n+             name: _('/node_modules/test-package/src/index.d.ts'),\n+             contents: `\n+            export declare class Base {\n+            }\n+            export declare class SubClass extends Base {\n+                constructor();\n+            }`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm2015/src/index.js'),\n+             contents: `\n+            import { __decorate, __metadata } from \"tslib\";\n+            import { Injectable } from '@angular/core';\n+            let Base = class Base {\n+            };\n+            Base = __decorate([\n+                Injectable()\n+            ], Base);\n+            export { Base };\n+            let SubClass = class SubClass extends Base {\n+                constructor() {\n                     // Note: mimic the situation where TS is first emitted into ES2015, resulting\n                     // in the spread super call below, and then downleveled into ES5 using the\n                     // \"downlevelIteration\" option.\n                     super(...arguments);\n                     this.foo = 'bar';\n-                  }\n                 }\n-              `,\n-             },\n-             {importHelpers: true, noEmitHelpers: true, downlevelIteration: true});\n+            };\n+            SubClass = __decorate([\n+                Injectable(),\n+                __metadata(\"design:paramtypes\", [])\n+            ], SubClass);\n+            export { SubClass };`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm2015/index.js'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm5/src/index.js'),\n+             contents: `\n+            import { __decorate, __extends, __metadata, __read, __spreadArray } from \"tslib\";\n+            import { Injectable } from '@angular/core';\n+            var Base = /** @class */ (function () {\n+                function Base() {\n+                }\n+                Base = __decorate([\n+                    Injectable()\n+                ], Base);\n+                return Base;\n+            }());\n+            export { Base };\n+            var SubClass = /** @class */ (function (_super) {\n+                __extends(SubClass, _super);\n+                function SubClass() {\n+                    var _this = _super.apply(this, __spreadArray([], __read(arguments))) || this;\n+                    _this.foo = 'bar';\n+                    return _this;\n+                }\n+                SubClass = __decorate([\n+                    Injectable(),\n+                    __metadata(\"design:paramtypes\", [])\n+                ], SubClass);\n+                return SubClass;\n+            }(Base));\n+            export { SubClass };`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm5/index.js'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/index.d.ts'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/index.metadata.json'),\n+             contents: `{}`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/package.json'),\n+             contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./esm5/index.js\",\n+              \"esm2015\": \"./esm2015/index.js\",\n+              \"module\": \"./esm2015/index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+           },\n+         ]);\n \n          mainNgcc({\n            basePath: '/node_modules',\n@@ -382,8 +677,6 @@ runInEachFileSystem(() => {\n          });\n \n          const jsContents = fs.readFile(_(`/node_modules/test-package/esm5/src/index.js`));\n-         // Verify that the ES5 bundle does contain the expected downleveling syntax.\n-         expect(jsContents).toContain('__spreadArray([], __read(arguments), false)');\n          expect(jsContents)\n              .toContain(\n                  'var ɵSubClass_BaseFactory; return function SubClass_Factory(t) { return (ɵSubClass_BaseFactory || (ɵSubClass_BaseFactory = ɵngcc0.ɵɵgetInheritedFactory(SubClass)))(t || SubClass); };');\n@@ -392,27 +685,152 @@ runInEachFileSystem(() => {\n     it(`should be able to detect synthesized constructors in ES5 with downlevelIteration enabled (emitted helpers)`,\n        () => {\n          setupAngularCoreEsm5();\n-         compileIntoApf(\n-             'test-package', {\n-               '/index.ts': `\n-                import {Injectable} from '@angular/core';\n-\n-                @Injectable()\n-                export class Base {}\n-\n-                @Injectable()\n-                export class SubClass extends Base {\n-                  constructor() {\n+         loadTestFiles([\n+           {\n+             name: _('/node_modules/test-package/src/index.d.ts'),\n+             contents: `\n+            export declare class Base {\n+            }\n+            export declare class SubClass extends Base {\n+                constructor();\n+            }`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm2015/src/index.js'),\n+             contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            var __metadata = (this && this.__metadata) || function (k, v) {\n+                if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n+            };\n+            import { Injectable } from '@angular/core';\n+            let Base = class Base {\n+            };\n+            Base = __decorate([\n+                Injectable()\n+            ], Base);\n+            export { Base };\n+            let SubClass = class SubClass extends Base {\n+                constructor() {\n                     // Note: mimic the situation where TS is first emitted into ES2015, resulting\n                     // in the spread super call below, and then downleveled into ES5 using the\n                     // \"downlevelIteration\" option.\n                     super(...arguments);\n                     this.foo = 'bar';\n-                  }\n                 }\n-              `,\n-             },\n-             {importHelpers: false, noEmitHelpers: false, downlevelIteration: true});\n+            };\n+            SubClass = __decorate([\n+                Injectable(),\n+                __metadata(\"design:paramtypes\", [])\n+            ], SubClass);\n+            export { SubClass };`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm2015/index.js'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm5/src/index.js'),\n+             contents: `\n+            var __extends = (this && this.__extends) || (function () {\n+                var extendStatics = function (d, b) {\n+                    extendStatics = Object.setPrototypeOf ||\n+                        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n+                        function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n+                    return extendStatics(d, b);\n+                };\n+                return function (d, b) {\n+                    if (typeof b !== \"function\" && b !== null)\n+                        throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n+                    extendStatics(d, b);\n+                    function __() { this.constructor = d; }\n+                    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n+                };\n+            })();\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            var __metadata = (this && this.__metadata) || function (k, v) {\n+                if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n+            };\n+            var __read = (this && this.__read) || function (o, n) {\n+                var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n+                if (!m) return o;\n+                var i = m.call(o), r, ar = [], e;\n+                try {\n+                    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n+                }\n+                catch (error) { e = { error: error }; }\n+                finally {\n+                    try {\n+                        if (r && !r.done && (m = i[\"return\"])) m.call(i);\n+                    }\n+                    finally { if (e) throw e.error; }\n+                }\n+                return ar;\n+            };\n+            var __spreadArray = (this && this.__spreadArray) || function (to, from) {\n+                for (var i = 0, il = from.length, j = to.length; i < il; i++, j++)\n+                    to[j] = from[i];\n+                return to;\n+            };\n+            import { Injectable } from '@angular/core';\n+            var Base = /** @class */ (function () {\n+                function Base() {\n+                }\n+                Base = __decorate([\n+                    Injectable()\n+                ], Base);\n+                return Base;\n+            }());\n+            export { Base };\n+            var SubClass = /** @class */ (function (_super) {\n+                __extends(SubClass, _super);\n+                function SubClass() {\n+                    var _this = _super.apply(this, __spreadArray([], __read(arguments))) || this;\n+                    _this.foo = 'bar';\n+                    return _this;\n+                }\n+                SubClass = __decorate([\n+                    Injectable(),\n+                    __metadata(\"design:paramtypes\", [])\n+                ], SubClass);\n+                return SubClass;\n+            }(Base));\n+            export { SubClass };`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm5/index.js'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/index.d.ts'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/index.metadata.json'),\n+             contents: `{}`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/package.json'),\n+             contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./esm5/index.js\",\n+              \"esm2015\": \"./esm2015/index.js\",\n+              \"module\": \"./esm2015/index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+           },\n+         ]);\n \n          mainNgcc({\n            basePath: '/node_modules',\n@@ -421,32 +839,71 @@ runInEachFileSystem(() => {\n          });\n \n          const jsContents = fs.readFile(_(`/node_modules/test-package/esm5/src/index.js`));\n-         // Verify that the ES5 bundle does contain the expected downleveling syntax.\n-         expect(jsContents).toContain('__spreadArray([], __read(arguments), false)');\n          expect(jsContents)\n              .toContain(\n                  'var ɵSubClass_BaseFactory; return function SubClass_Factory(t) { return (ɵSubClass_BaseFactory || (ɵSubClass_BaseFactory = ɵngcc0.ɵɵgetInheritedFactory(SubClass)))(t || SubClass); };');\n        });\n \n     it('should not add `const` in ES5 generated code', () => {\n       setupAngularCoreEsm5();\n-      compileIntoFlatEs5Package('test-package', {\n-        '/index.ts': `\n-          import {Directive, Input, NgModule} from '@angular/core';\n-\n-          @Directive({\n-            selector: '[foo]',\n-            host: {bar: ''},\n-          })\n-          export class FooDirective {\n-          }\n-\n-          @NgModule({\n-            declarations: [FooDirective],\n-          })\n-          export class FooModule {}\n-        `,\n-      });\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test-package/index.d.ts'),\n+          contents: `\n+            export declare class FooDirective {\n+            }\n+            export declare class FooModule {\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Directive, NgModule } from '@angular/core';\n+            var FooDirective = /** @class */ (function () {\n+                function FooDirective() {\n+                }\n+                FooDirective = __decorate([\n+                    Directive({\n+                        selector: '[foo]',\n+                        host: { bar: '' },\n+                    })\n+                ], FooDirective);\n+                return FooDirective;\n+            }());\n+            export { FooDirective };\n+            var FooModule = /** @class */ (function () {\n+                function FooModule() {\n+                }\n+                FooModule = __decorate([\n+                    NgModule({\n+                        declarations: [FooDirective],\n+                    })\n+                ], FooModule);\n+                return FooModule;\n+            }());\n+            export { FooModule };`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.metadata.json'),\n+          contents: `{}`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/package.json'),\n+          contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+        },\n+      ]);\n \n       mainNgcc({\n         basePath: '/node_modules',\n@@ -459,56 +916,207 @@ runInEachFileSystem(() => {\n     });\n \n     it('should be able to reflect into external libraries', () => {\n-      compileIntoApf('lib', {\n-        '/index.ts': `\n-          export * from './constants';\n-          export * from './module';\n-        `,\n-        '/constants.ts': `\n-          export const selectorA = '[selector-a]';\n-\n-          export class Selectors {\n-            static readonly B = '[selector-b]';\n-          }\n-        `,\n-        '/module.ts': `\n-          import {NgModule, ModuleWithProviders} from '@angular/core';\n-\n-          @NgModule()\n-          export class MyOtherModule {}\n-\n-          export class MyModule {\n-            static forRoot(): ModuleWithProviders<MyOtherModule> {\n-              return {ngModule: MyOtherModule};\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/lib/src/index.d.ts'),\n+          contents: `\n+            export * from './constants';\n+            export * from './module';`,\n+        },\n+        {\n+          name: _('/node_modules/lib/esm2015/src/index.js'),\n+          contents: `\n+            export * from './constants';\n+            export * from './module';`,\n+        },\n+        {\n+          name: _('/node_modules/lib/src/constants.d.ts'),\n+          contents: `\n+            export declare const selectorA = \"[selector-a]\";\n+            export declare class Selectors {\n+                static readonly B = \"[selector-b]\";\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/lib/esm2015/src/constants.js'),\n+          contents: `\n+            export const selectorA = '[selector-a]';\n+            export class Selectors {\n             }\n-          }\n-        `\n-      });\n-\n-      compileIntoFlatEs2015Package('test-package', {\n-        '/index.ts': `\n-          import {Directive, Input, NgModule} from '@angular/core';\n-          import * as lib from 'lib';\n-\n-          @Directive({\n-            selector: lib.selectorA,\n-          })\n-          export class DirectiveA {\n-          }\n-\n-          @Directive({\n-            selector: lib.Selectors.B,\n-          })\n-          export class DirectiveB {\n-          }\n+            Selectors.B = '[selector-b]';`,\n+        },\n+        {\n+          name: _('/node_modules/lib/src/module.d.ts'),\n+          contents: `\n+            import { ModuleWithProviders } from '@angular/core';\n+            export declare class MyOtherModule {\n+            }\n+            export declare class MyModule {\n+                static forRoot(): ModuleWithProviders<MyOtherModule>;\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/lib/esm2015/src/module.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { NgModule } from '@angular/core';\n+            let MyOtherModule = class MyOtherModule {\n+            };\n+            MyOtherModule = __decorate([\n+                NgModule()\n+            ], MyOtherModule);\n+            export { MyOtherModule };\n+            export class MyModule {\n+                static forRoot() {\n+                    return { ngModule: MyOtherModule };\n+                }\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/lib/esm2015/index.js'),\n+          contents: `export * from './src/index';`,\n+        },\n+        {\n+          name: _('/node_modules/lib/esm5/src/index.js'),\n+          contents: `\n+            export * from './constants';\n+            export * from './module';`,\n+        },\n+        {\n+          name: _('/node_modules/lib/esm5/src/constants.js'),\n+          contents: `\n+            export var selectorA = '[selector-a]';\n+            var Selectors = /** @class */ (function () {\n+                function Selectors() {\n+                }\n+                Selectors.B = '[selector-b]';\n+                return Selectors;\n+            }());\n+            export { Selectors };`,\n+        },\n+        {\n+          name: _('/node_modules/lib/esm5/src/module.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { NgModule } from '@angular/core';\n+            var MyOtherModule = /** @class */ (function () {\n+                function MyOtherModule() {\n+                }\n+                MyOtherModule = __decorate([\n+                    NgModule()\n+                ], MyOtherModule);\n+                return MyOtherModule;\n+            }());\n+            export { MyOtherModule };\n+            var MyModule = /** @class */ (function () {\n+                function MyModule() {\n+                }\n+                MyModule.forRoot = function () {\n+                    return { ngModule: MyOtherModule };\n+                };\n+                return MyModule;\n+            }());\n+            export { MyModule };`,\n+        },\n+        {\n+          name: _('/node_modules/lib/esm5/index.js'),\n+          contents: `export * from './src/index';`,\n+        },\n+        {\n+          name: _('/node_modules/lib/index.d.ts'),\n+          contents: `export * from './src/index';`,\n+        },\n+        {\n+          name: _('/node_modules/lib/index.metadata.json'),\n+          contents: `{}`,\n+        },\n+        {\n+          name: _('/node_modules/lib/package.json'),\n+          contents: `\n+            {\n+              \"name\": \"lib\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./esm5/index.js\",\n+              \"esm2015\": \"./esm2015/index.js\",\n+              \"module\": \"./esm2015/index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+        },\n+      ]);\n \n-          @NgModule({\n-            imports: [lib.MyModule.forRoot()],\n-            declarations: [DirectiveA, DirectiveB],\n-          })\n-          export class FooModule {}\n-        `,\n-      });\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test-package/index.d.ts'),\n+          contents: `\n+            export declare class DirectiveA {\n+            }\n+            export declare class DirectiveB {\n+            }\n+            export declare class FooModule {\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Directive, NgModule } from '@angular/core';\n+            import * as lib from 'lib';\n+            let DirectiveA = class DirectiveA {\n+            };\n+            DirectiveA = __decorate([\n+                Directive({\n+                    selector: lib.selectorA,\n+                })\n+            ], DirectiveA);\n+            export { DirectiveA };\n+            let DirectiveB = class DirectiveB {\n+            };\n+            DirectiveB = __decorate([\n+                Directive({\n+                    selector: lib.Selectors.B,\n+                })\n+            ], DirectiveB);\n+            export { DirectiveB };\n+            let FooModule = class FooModule {\n+            };\n+            FooModule = __decorate([\n+                NgModule({\n+                    imports: [lib.MyModule.forRoot()],\n+                    declarations: [DirectiveA, DirectiveB],\n+                })\n+            ], FooModule);\n+            export { FooModule };`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.metadata.json'),\n+          contents: `{}`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/package.json'),\n+          contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm2015\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+        },\n+      ]);\n \n       mainNgcc({\n         basePath: '/node_modules',\n@@ -523,31 +1131,132 @@ runInEachFileSystem(() => {\n     });\n \n     it('should be able to resolve enum values', () => {\n-      compileIntoApf('test-package', {\n-        '/index.ts': `\n-          import {Component, NgModule} from '@angular/core';\n-\n-          export enum StringEnum {\n-            ValueA = \"a\",\n-            ValueB = \"b\",\n-          }\n-\n-          export enum NumericEnum {\n-            Value3 = 3,\n-            Value4,\n-          }\n-\n-          @Component({\n-            template: \\`\\${StringEnum.ValueA} - \\${StringEnum.ValueB} - \\${NumericEnum.Value3} - \\${NumericEnum.Value4}\\`,\n-          })\n-          export class FooCmp {}\n-\n-          @NgModule({\n-            declarations: [FooCmp],\n-          })\n-          export class FooModule {}\n-        `,\n-      });\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test-package/src/index.d.ts'),\n+          contents: `\n+            export declare enum StringEnum {\n+                ValueA = \"a\",\n+                ValueB = \"b\"\n+            }\n+            export declare enum NumericEnum {\n+                Value3 = 3,\n+                Value4 = 4\n+            }\n+            export declare class FooCmp {\n+            }\n+            export declare class FooModule {\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/esm2015/src/index.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Component, NgModule } from '@angular/core';\n+            export var StringEnum;\n+            (function (StringEnum) {\n+                StringEnum[\"ValueA\"] = \"a\";\n+                StringEnum[\"ValueB\"] = \"b\";\n+            })(StringEnum || (StringEnum = {}));\n+            export var NumericEnum;\n+            (function (NumericEnum) {\n+                NumericEnum[NumericEnum[\"Value3\"] = 3] = \"Value3\";\n+                NumericEnum[NumericEnum[\"Value4\"] = 4] = \"Value4\";\n+            })(NumericEnum || (NumericEnum = {}));\n+            let FooCmp = class FooCmp {\n+            };\n+            FooCmp = __decorate([\n+                Component({\n+                    template: \\`\\${StringEnum.ValueA} - \\${StringEnum.ValueB} - \\${NumericEnum.Value3} - \\${NumericEnum.Value4}\\`,\n+                })\n+            ], FooCmp);\n+            export { FooCmp };\n+            let FooModule = class FooModule {\n+            };\n+            FooModule = __decorate([\n+                NgModule({\n+                    declarations: [FooCmp],\n+                })\n+            ], FooModule);\n+            export { FooModule };`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/esm2015/index.js'),\n+          contents: `export * from './src/index';`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/esm5/src/index.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Component, NgModule } from '@angular/core';\n+            export var StringEnum;\n+            (function (StringEnum) {\n+                StringEnum[\"ValueA\"] = \"a\";\n+                StringEnum[\"ValueB\"] = \"b\";\n+            })(StringEnum || (StringEnum = {}));\n+            export var NumericEnum;\n+            (function (NumericEnum) {\n+                NumericEnum[NumericEnum[\"Value3\"] = 3] = \"Value3\";\n+                NumericEnum[NumericEnum[\"Value4\"] = 4] = \"Value4\";\n+            })(NumericEnum || (NumericEnum = {}));\n+            var FooCmp = /** @class */ (function () {\n+                function FooCmp() {\n+                }\n+                FooCmp = __decorate([\n+                    Component({\n+                        template: StringEnum.ValueA + \" - \" + StringEnum.ValueB + \" - \" + NumericEnum.Value3 + \" - \" + NumericEnum.Value4,\n+                    })\n+                ], FooCmp);\n+                return FooCmp;\n+            }());\n+            export { FooCmp };\n+            var FooModule = /** @class */ (function () {\n+                function FooModule() {\n+                }\n+                FooModule = __decorate([\n+                    NgModule({\n+                        declarations: [FooCmp],\n+                    })\n+                ], FooModule);\n+                return FooModule;\n+            }());\n+            export { FooModule };`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/esm5/index.js'),\n+          contents: `export * from './src/index';`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.d.ts'),\n+          contents: `export * from './src/index';`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.metadata.json'),\n+          contents: `{}`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/package.json'),\n+          contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./esm5/index.js\",\n+              \"esm2015\": \"./esm2015/index.js\",\n+              \"module\": \"./esm2015/index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+        },\n+      ]);\n \n       mainNgcc({\n         basePath: '/node_modules',\n@@ -705,24 +1414,108 @@ runInEachFileSystem(() => {\n            },\n          ]);\n \n-         compileIntoApf('test-package', {\n-           '/index.ts': `\n-          import {NgModule, Component} from '@angular/core';\n-          import {selector} from 'external';\n-\n-          @Component({\n-            selector,\n-            template: ''\n-          })\n-          export class FooComponent {\n-          }\n-\n-          @NgModule({\n-            declarations: [FooComponent],\n-          })\n-          export class FooModule {}\n-        `,\n-         });\n+         loadTestFiles([\n+           {\n+             name: _('/node_modules/test-package/src/index.d.ts'),\n+             contents: `\n+            export declare class FooComponent {\n+            }\n+            export declare class FooModule {\n+            }`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm2015/src/index.js'),\n+             contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { NgModule, Component } from '@angular/core';\n+            import { selector } from 'external';\n+            let FooComponent = class FooComponent {\n+            };\n+            FooComponent = __decorate([\n+                Component({\n+                    selector,\n+                    template: ''\n+                })\n+            ], FooComponent);\n+            export { FooComponent };\n+            let FooModule = class FooModule {\n+            };\n+            FooModule = __decorate([\n+                NgModule({\n+                    declarations: [FooComponent],\n+                })\n+            ], FooModule);\n+            export { FooModule };`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm2015/index.js'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm5/src/index.js'),\n+             contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { NgModule, Component } from '@angular/core';\n+            import { selector } from 'external';\n+            var FooComponent = /** @class */ (function () {\n+                function FooComponent() {\n+                }\n+                FooComponent = __decorate([\n+                    Component({\n+                        selector: selector,\n+                        template: ''\n+                    })\n+                ], FooComponent);\n+                return FooComponent;\n+            }());\n+            export { FooComponent };\n+            var FooModule = /** @class */ (function () {\n+                function FooModule() {\n+                }\n+                FooModule = __decorate([\n+                    NgModule({\n+                        declarations: [FooComponent],\n+                    })\n+                ], FooModule);\n+                return FooModule;\n+            }());\n+            export { FooModule };`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm5/index.js'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/index.d.ts'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/index.metadata.json'),\n+             contents: `{}`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/package.json'),\n+             contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./esm5/index.js\",\n+              \"esm2015\": \"./esm2015/index.js\",\n+              \"module\": \"./esm2015/index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+           },\n+         ]);\n \n          try {\n            mainNgcc({\n@@ -740,16 +1533,49 @@ runInEachFileSystem(() => {\n        });\n \n     it('should add ɵfac but not duplicate ɵprov properties on injectables', () => {\n-      compileIntoFlatEs2015Package('test-package', {\n-        '/index.ts': `\n-        import {Injectable, ɵɵdefineInjectable} from '@angular/core';\n-        export const TestClassToken = 'TestClassToken';\n-        @Injectable({providedIn: 'module'})\n-        export class TestClass {\n-          static ɵprov = ɵɵdefineInjectable({ factory: () => {}, token: TestClassToken, providedIn: \"module\" });\n-        }\n-        `,\n-      });\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test-package/index.d.ts'),\n+          contents: `\n+            export declare const TestClassToken = \"TestClassToken\";\n+            export declare class TestClass {\n+                static ɵprov: unknown;\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Injectable, ɵɵdefineInjectable } from '@angular/core';\n+            export const TestClassToken = 'TestClassToken';\n+            let TestClass = class TestClass {\n+            };\n+            TestClass.ɵprov = ɵɵdefineInjectable({ factory: () => { }, token: TestClassToken, providedIn: \"module\" });\n+            TestClass = __decorate([\n+                Injectable({ providedIn: 'module' })\n+            ], TestClass);\n+            export { TestClass };`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.metadata.json'),\n+          contents: `{}`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/package.json'),\n+          contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm2015\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+        },\n+      ]);\n \n       const before = fs.readFile(_(`/node_modules/test-package/index.js`));\n       const originalProp = /ɵprov[^;]+/.exec(before)![0];\n@@ -771,19 +1597,51 @@ runInEachFileSystem(() => {\n \n     // This is necessary to ensure XPipeDef.fac is defined when delegated from injectable def\n     it('should always generate factory def (fac) before injectable def (prov)', () => {\n-      compileIntoFlatEs2015Package('test-package', {\n-        '/index.ts': `\n-        import {Injectable, Pipe, PipeTransform} from '@angular/core';\n-\n-        @Injectable()\n-        @Pipe({\n-          name: 'myTestPipe'\n-        })\n-        export class TestClass implements PipeTransform {\n-          transform(value: any) { return value; }\n-        }\n-        `,\n-      });\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test-package/index.d.ts'),\n+          contents: `\n+            import { PipeTransform } from '@angular/core';\n+            export declare class TestClass implements PipeTransform {\n+                transform(value: any): any;\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Injectable, Pipe } from '@angular/core';\n+            let TestClass = class TestClass {\n+                transform(value) { return value; }\n+            };\n+            TestClass = __decorate([\n+                Injectable(),\n+                Pipe({\n+                    name: 'myTestPipe'\n+                })\n+            ], TestClass);\n+            export { TestClass };`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.metadata.json'),\n+          contents: `{}`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/package.json'),\n+          contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm2015\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+        },\n+      ]);\n \n       mainNgcc({\n         basePath: '/node_modules',\n@@ -801,19 +1659,56 @@ runInEachFileSystem(() => {\n \n     // https://github.com/angular/angular/issues/38883\n     it('should recognize ChangeDetectorRef as special symbol for pipes', () => {\n-      compileIntoFlatEs2015Package('test-package', {\n-        '/index.ts': `\n-        import {ChangeDetectorRef, Pipe, PipeTransform} from '@angular/core';\n-\n-        @Pipe({\n-          name: 'myTestPipe'\n-        })\n-        export class TestClass implements PipeTransform {\n-          constructor(cdr: ChangeDetectorRef) {}\n-          transform(value: any) { return value; }\n-        }\n-        `,\n-      });\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test-package/index.d.ts'),\n+          contents: `\n+            import { ChangeDetectorRef, PipeTransform } from '@angular/core';\n+            export declare class TestClass implements PipeTransform {\n+                constructor(cdr: ChangeDetectorRef);\n+                transform(value: any): any;\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            var __metadata = (this && this.__metadata) || function (k, v) {\n+                if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n+            };\n+            import { ChangeDetectorRef, Pipe } from '@angular/core';\n+            let TestClass = class TestClass {\n+                constructor(cdr) { }\n+                transform(value) { return value; }\n+            };\n+            TestClass = __decorate([\n+                Pipe({\n+                    name: 'myTestPipe'\n+                }),\n+                __metadata(\"design:paramtypes\", [ChangeDetectorRef])\n+            ], TestClass);\n+            export { TestClass };`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.metadata.json'),\n+          contents: `{}`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/package.json'),\n+          contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm2015\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+        },\n+      ]);\n \n       mainNgcc({\n         basePath: '/node_modules',\n@@ -873,26 +1768,115 @@ runInEachFileSystem(() => {\n \n     it('should add generic type for ModuleWithProviders and generate exports for private modules',\n        () => {\n-         compileIntoApf('test-package', {\n-           '/index.ts': `\n-              import {ModuleWithProviders} from '@angular/core';\n-              import {InternalFooModule} from './internal';\n-\n-              export class FooModule {\n-                static forRoot(): ModuleWithProviders {\n-                  return {\n-                    ngModule: InternalFooModule,\n-                  };\n+         loadTestFiles([\n+           {\n+             name: _('/node_modules/test-package/src/index.d.ts'),\n+             contents: `\n+            import { ModuleWithProviders } from '@angular/core';\n+            export declare class FooModule {\n+                static forRoot(): ModuleWithProviders;\n+            }`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm2015/src/index.js'),\n+             contents: `\n+            import { InternalFooModule } from './internal';\n+            export class FooModule {\n+                static forRoot() {\n+                    return {\n+                        ngModule: InternalFooModule,\n+                    };\n                 }\n-              }\n-            `,\n-           '/internal.ts': `\n-              import {NgModule} from '@angular/core';\n-\n-              @NgModule()\n-              export class InternalFooModule {}\n-           `,\n-         });\n+            }`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/src/internal.d.ts'),\n+             contents: `\n+            export declare class InternalFooModule {\n+            }`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm2015/src/internal.js'),\n+             contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { NgModule } from '@angular/core';\n+            let InternalFooModule = class InternalFooModule {\n+            };\n+            InternalFooModule = __decorate([\n+                NgModule()\n+            ], InternalFooModule);\n+            export { InternalFooModule };`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm2015/index.js'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm5/src/index.js'),\n+             contents: `\n+            import { InternalFooModule } from './internal';\n+            var FooModule = /** @class */ (function () {\n+                function FooModule() {\n+                }\n+                FooModule.forRoot = function () {\n+                    return {\n+                        ngModule: InternalFooModule,\n+                    };\n+                };\n+                return FooModule;\n+            }());\n+            export { FooModule };`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm5/src/internal.js'),\n+             contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { NgModule } from '@angular/core';\n+            var InternalFooModule = /** @class */ (function () {\n+                function InternalFooModule() {\n+                }\n+                InternalFooModule = __decorate([\n+                    NgModule()\n+                ], InternalFooModule);\n+                return InternalFooModule;\n+            }());\n+            export { InternalFooModule };`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/esm5/index.js'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/index.d.ts'),\n+             contents: `export * from './src/index';`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/index.metadata.json'),\n+             contents: `{}`,\n+           },\n+           {\n+             name: _('/node_modules/test-package/package.json'),\n+             contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./esm5/index.js\",\n+              \"esm2015\": \"./esm2015/index.js\",\n+              \"module\": \"./esm2015/index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+           },\n+         ]);\n \n          mainNgcc({\n            basePath: '/node_modules',\n@@ -921,23 +1905,64 @@ runInEachFileSystem(() => {\n \n     it('should use `$localize` calls rather than tagged templates in ES5 generated code', () => {\n       setupAngularCoreEsm5();\n-      compileIntoFlatEs5Package('test-package', {\n-        '/index.ts': `\n-        import {Component, Input, NgModule} from '@angular/core';\n-\n-        @Component({\n-          selector: '[foo]',\n-          template: '<div i18n=\"some:\\`description\\`\">A message</div>'\n-        })\n-        export class FooComponent {\n-        }\n-\n-        @NgModule({\n-          declarations: [FooComponent],\n-        })\n-        export class FooModule {}\n-      `,\n-      });\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test-package/index.d.ts'),\n+          contents: `\n+            export declare class FooComponent {\n+            }\n+            export declare class FooModule {\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Component, NgModule } from '@angular/core';\n+            var FooComponent = /** @class */ (function () {\n+                function FooComponent() {\n+                }\n+                FooComponent = __decorate([\n+                    Component({\n+                        selector: '[foo]',\n+                        template: '<div i18n=\"some:\\`description\\`\">A message</div>'\n+                    })\n+                ], FooComponent);\n+                return FooComponent;\n+            }());\n+            export { FooComponent };\n+            var FooModule = /** @class */ (function () {\n+                function FooModule() {\n+                }\n+                FooModule = __decorate([\n+                    NgModule({\n+                        declarations: [FooComponent],\n+                    })\n+                ], FooModule);\n+                return FooModule;\n+            }());\n+            export { FooModule };`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.metadata.json'),\n+          contents: `{}`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/package.json'),\n+          contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+        },\n+      ]);\n \n       mainNgcc({\n         basePath: '/node_modules',\n@@ -1207,15 +2232,45 @@ runInEachFileSystem(() => {\n     });\n \n     it('should clean up outdated artifacts', () => {\n-      compileIntoFlatEs2015Package('test-package', {\n-        'index.ts': `\n-        import {Directive} from '@angular/core';\n-\n-        @Directive({selector: '[foo]'})\n-        export class FooDirective {\n-        }\n-      `,\n-      });\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test-package/index.d.ts'),\n+          contents: `\n+            export declare class FooDirective {\n+            }`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.js'),\n+          contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Directive } from '@angular/core';\n+            let FooDirective = class FooDirective {\n+            };\n+            FooDirective = __decorate([\n+                Directive({ selector: '[foo]' })\n+            ], FooDirective);\n+            export { FooDirective };`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.metadata.json'),\n+          contents: `{}`,\n+        },\n+        {\n+          name: _('/node_modules/test-package/package.json'),\n+          contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm2015\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+        },\n+      ]);\n       mainNgcc({\n         basePath: '/node_modules',\n         propertiesToConsider: ['esm2015'],\n@@ -2241,24 +3296,62 @@ runInEachFileSystem(() => {\n     describe('undecorated child class migration', () => {\n       it('should generate a directive definition with CopyDefinitionFeature for an undecorated child directive',\n          () => {\n-           compileIntoFlatEs2015Package('test-package', {\n-             '/index.ts': `\n-              import {Directive, NgModule} from '@angular/core';\n-\n-              @Directive({\n-                selector: '[base]',\n-                exportAs: 'base1, base2',\n-              })\n-              export class BaseDir {}\n-\n-              export class DerivedDir extends BaseDir {}\n-\n-              @NgModule({\n-                declarations: [DerivedDir],\n-              })\n-              export class Module {}\n-            `,\n-           });\n+           loadTestFiles([\n+             {\n+               name: _('/node_modules/test-package/index.d.ts'),\n+               contents: `\n+            export declare class BaseDir {\n+            }\n+            export declare class DerivedDir extends BaseDir {\n+            }\n+            export declare class Module {\n+            }`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.js'),\n+               contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Directive, NgModule } from '@angular/core';\n+            let BaseDir = class BaseDir {\n+            };\n+            BaseDir = __decorate([\n+                Directive({\n+                    selector: '[base]',\n+                    exportAs: 'base1, base2',\n+                })\n+            ], BaseDir);\n+            export { BaseDir };\n+            export class DerivedDir extends BaseDir {\n+            }\n+            let Module = class Module {\n+            };\n+            Module = __decorate([\n+                NgModule({\n+                    declarations: [DerivedDir],\n+                })\n+            ], Module);\n+            export { Module };`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.metadata.json'),\n+               contents: `{}`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/package.json'),\n+               contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm2015\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+             },\n+           ]);\n \n            mainNgcc({\n              basePath: '/node_modules',\n@@ -2282,24 +3375,62 @@ runInEachFileSystem(() => {\n \n       it('should generate a component definition with CopyDefinitionFeature for an undecorated child component',\n          () => {\n-           compileIntoFlatEs2015Package('test-package', {\n-             '/index.ts': `\n-           import {Component, NgModule} from '@angular/core';\n-\n-           @Component({\n-             selector: '[base]',\n-             template: '<span>This is the base template</span>',\n-           })\n-           export class BaseCmp {}\n-\n-           export class DerivedCmp extends BaseCmp {}\n-\n-           @NgModule({\n-             declarations: [DerivedCmp],\n-           })\n-           export class Module {}\n-         `,\n-           });\n+           loadTestFiles([\n+             {\n+               name: _('/node_modules/test-package/index.d.ts'),\n+               contents: `\n+            export declare class BaseCmp {\n+            }\n+            export declare class DerivedCmp extends BaseCmp {\n+            }\n+            export declare class Module {\n+            }`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.js'),\n+               contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Component, NgModule } from '@angular/core';\n+            let BaseCmp = class BaseCmp {\n+            };\n+            BaseCmp = __decorate([\n+                Component({\n+                    selector: '[base]',\n+                    template: '<span>This is the base template</span>',\n+                })\n+            ], BaseCmp);\n+            export { BaseCmp };\n+            export class DerivedCmp extends BaseCmp {\n+            }\n+            let Module = class Module {\n+            };\n+            Module = __decorate([\n+                NgModule({\n+                    declarations: [DerivedCmp],\n+                })\n+            ], Module);\n+            export { Module };`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.metadata.json'),\n+               contents: `{}`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/package.json'),\n+               contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm2015\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+             },\n+           ]);\n \n            mainNgcc({\n              basePath: '/node_modules',\n@@ -2322,27 +3453,69 @@ runInEachFileSystem(() => {\n \n       it('should generate directive definitions with CopyDefinitionFeature for undecorated child directives in a long inheritance chain',\n          () => {\n-           compileIntoFlatEs2015Package('test-package', {\n-             '/index.ts': `\n-           import {Directive, NgModule} from '@angular/core';\n-\n-           @Directive({\n-             selector: '[base]',\n-           })\n-           export class BaseDir {}\n-\n-           export class DerivedDir1 extends BaseDir {}\n-\n-           export class DerivedDir2 extends DerivedDir1 {}\n-\n-           export class DerivedDir3 extends DerivedDir2 {}\n-\n-           @NgModule({\n-             declarations: [DerivedDir3],\n-           })\n-           export class Module {}\n-         `,\n-           });\n+           loadTestFiles([\n+             {\n+               name: _('/node_modules/test-package/index.d.ts'),\n+               contents: `\n+            export declare class BaseDir {\n+            }\n+            export declare class DerivedDir1 extends BaseDir {\n+            }\n+            export declare class DerivedDir2 extends DerivedDir1 {\n+            }\n+            export declare class DerivedDir3 extends DerivedDir2 {\n+            }\n+            export declare class Module {\n+            }`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.js'),\n+               contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Directive, NgModule } from '@angular/core';\n+            let BaseDir = class BaseDir {\n+            };\n+            BaseDir = __decorate([\n+                Directive({\n+                    selector: '[base]',\n+                })\n+            ], BaseDir);\n+            export { BaseDir };\n+            export class DerivedDir1 extends BaseDir {\n+            }\n+            export class DerivedDir2 extends DerivedDir1 {\n+            }\n+            export class DerivedDir3 extends DerivedDir2 {\n+            }\n+            let Module = class Module {\n+            };\n+            Module = __decorate([\n+                NgModule({\n+                    declarations: [DerivedDir3],\n+                })\n+            ], Module);\n+            export { Module };`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.metadata.json'),\n+               contents: `{}`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/package.json'),\n+               contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm2015\": \"./index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+             },\n+           ]);\n \n            mainNgcc({\n              basePath: '/node_modules',\n@@ -2505,17 +3678,85 @@ runInEachFileSystem(() => {\n \n     describe('legacy message ids', () => {\n       it('should render legacy message ids when compiling i18n tags in component templates', () => {\n-        compileIntoApf('test-package', {\n-          '/index.ts': `\n-           import {Component} from '@angular/core';\n-\n-           @Component({\n-             selector: '[base]',\n-             template: '<div i18n>Some message</div>'\n-           })\n-           export class AppComponent {}\n-         `,\n-        });\n+        loadTestFiles([\n+          {\n+            name: _('/node_modules/test-package/src/index.d.ts'),\n+            contents: `\n+            export declare class AppComponent {\n+            }`,\n+          },\n+          {\n+            name: _('/node_modules/test-package/esm2015/src/index.js'),\n+            contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Component } from '@angular/core';\n+            let AppComponent = class AppComponent {\n+            };\n+            AppComponent = __decorate([\n+                Component({\n+                    selector: '[base]',\n+                    template: '<div i18n>Some message</div>'\n+                })\n+            ], AppComponent);\n+            export { AppComponent };`,\n+          },\n+          {\n+            name: _('/node_modules/test-package/esm2015/index.js'),\n+            contents: `export * from './src/index';`,\n+          },\n+          {\n+            name: _('/node_modules/test-package/esm5/src/index.js'),\n+            contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Component } from '@angular/core';\n+            var AppComponent = /** @class */ (function () {\n+                function AppComponent() {\n+                }\n+                AppComponent = __decorate([\n+                    Component({\n+                        selector: '[base]',\n+                        template: '<div i18n>Some message</div>'\n+                    })\n+                ], AppComponent);\n+                return AppComponent;\n+            }());\n+            export { AppComponent };`,\n+          },\n+          {\n+            name: _('/node_modules/test-package/esm5/index.js'),\n+            contents: `export * from './src/index';`,\n+          },\n+          {\n+            name: _('/node_modules/test-package/index.d.ts'),\n+            contents: `export * from './src/index';`,\n+          },\n+          {\n+            name: _('/node_modules/test-package/index.metadata.json'),\n+            contents: `{}`,\n+          },\n+          {\n+            name: _('/node_modules/test-package/package.json'),\n+            contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./esm5/index.js\",\n+              \"esm2015\": \"./esm2015/index.js\",\n+              \"module\": \"./esm2015/index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+          },\n+        ]);\n \n         mainNgcc({\n           basePath: '/node_modules',\n@@ -2532,17 +3773,85 @@ runInEachFileSystem(() => {\n \n       it('should not render legacy message ids when compiling i18n tags in component templates if `enableI18nLegacyMessageIdFormat` is false',\n          () => {\n-           compileIntoApf('test-package', {\n-             '/index.ts': `\n-           import {Component} from '@angular/core';\n-\n-           @Component({\n-             selector: '[base]',\n-             template: '<div i18n>Some message</div>'\n-           })\n-           export class AppComponent {}\n-         `,\n-           });\n+           loadTestFiles([\n+             {\n+               name: _('/node_modules/test-package/src/index.d.ts'),\n+               contents: `\n+            export declare class AppComponent {\n+            }`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm2015/src/index.js'),\n+               contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Component } from '@angular/core';\n+            let AppComponent = class AppComponent {\n+            };\n+            AppComponent = __decorate([\n+                Component({\n+                    selector: '[base]',\n+                    template: '<div i18n>Some message</div>'\n+                })\n+            ], AppComponent);\n+            export { AppComponent };`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm2015/index.js'),\n+               contents: `export * from './src/index';`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm5/src/index.js'),\n+               contents: `\n+            var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n+                var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n+                if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n+                else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n+                return c > 3 && r && Object.defineProperty(target, key, r), r;\n+            };\n+            import { Component } from '@angular/core';\n+            var AppComponent = /** @class */ (function () {\n+                function AppComponent() {\n+                }\n+                AppComponent = __decorate([\n+                    Component({\n+                        selector: '[base]',\n+                        template: '<div i18n>Some message</div>'\n+                    })\n+                ], AppComponent);\n+                return AppComponent;\n+            }());\n+            export { AppComponent };`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/esm5/index.js'),\n+               contents: `export * from './src/index';`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.d.ts'),\n+               contents: `export * from './src/index';`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/index.metadata.json'),\n+               contents: `{}`,\n+             },\n+             {\n+               name: _('/node_modules/test-package/package.json'),\n+               contents: `\n+            {\n+              \"name\": \"test-package\",\n+              \"version\": \"0.0.1\",\n+              \"esm5\": \"./esm5/index.js\",\n+              \"esm2015\": \"./esm2015/index.js\",\n+              \"module\": \"./esm2015/index.js\",\n+              \"typings\": \"./index.d.ts\"\n+            }`,\n+             },\n+           ]);\n \n            mainNgcc({\n              basePath: '/node_modules',"
        },
        {
            "sha": "6fa9e211d8b37380e17b939c062ce74e431268ef",
            "filename": "packages/compiler-cli/ngcc/test/integration/util.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 280,
            "changes": 281,
            "blob_url": "https://github.com/angular/angular/blob/e4839939b09f717a2b572362e08cdd3ed668445c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/e4839939b09f717a2b572362e08cdd3ed668445c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Futil.ts?ref=e4839939b09f717a2b572362e08cdd3ed668445c",
            "patch": "@@ -6,224 +6,10 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import ts from 'typescript';\n-\n-import {AbsoluteFsPath, FileSystem, getFileSystem} from '../../../src/ngtsc/file_system';\n+import {AbsoluteFsPath} from '../../../src/ngtsc/file_system';\n import {Folder, MockFileSystemPosix} from '../../../src/ngtsc/file_system/testing';\n-\n import {loadTestDirectory, loadTsLib, resolveNpmTreeArtifact} from '../../../src/ngtsc/testing';\n \n-export type PackageSources = {\n-  [path: string]: string;\n-};\n-\n-/**\n- * Instead of writing packaged code by hand, and manually describing the layout of the package, this\n- * function transpiles the TypeScript sources into a flat file structure using the ES5 format. In\n- * this package layout, all compiled sources are at the root of the package, with `.d.ts` files next\n- * to the `.js` files. Each `.js` also has a corresponding `.metadata.json` file alongside with it.\n- *\n- * All generated code is written into the `node_modules` in the top-level filesystem, ready for use\n- * in testing ngcc.\n- *\n- * @param pkgName The name of the package to compile.\n- * @param sources The TypeScript sources to compile.\n- */\n-export function compileIntoFlatEs5Package(pkgName: string, sources: PackageSources): void {\n-  compileIntoFlatPackage(pkgName, sources, {\n-    target: ts.ScriptTarget.ES5,\n-    module: ts.ModuleKind.ESNext,\n-    formatProperty: 'esm5',\n-  });\n-}\n-\n-/**\n- * Instead of writing packaged code by hand, and manually describing the layout of the package,\n- * this function transpiles the TypeScript sources into a flat file structure using the ES2015\n- * format. In this package layout, all compiled sources are at the root of the package, with\n- * `.d.ts` files next to the `.js` files. Each `.js` also has a corresponding `.metadata.json`\n- * file alongside with it.\n- *\n- * All generated code is written into the `node_modules` in the top-level filesystem, ready for use\n- * in testing ngcc.\n- *\n- * @param pkgName The name of the package to compile.\n- * @param sources The TypeScript sources to compile.\n- */\n-export function compileIntoFlatEs2015Package(pkgName: string, sources: PackageSources): void {\n-  compileIntoFlatPackage(pkgName, sources, {\n-    target: ts.ScriptTarget.ES2015,\n-    module: ts.ModuleKind.ESNext,\n-    formatProperty: 'esm2015',\n-  });\n-}\n-\n-export interface FlatLayoutOptions {\n-  /**\n-   * The script target version to compile into.\n-   */\n-  target: ts.ScriptTarget;\n-\n-  /**\n-   * The module kind to use in the compiled result.\n-   */\n-  module: ts.ModuleKind;\n-\n-  /**\n-   * The name of the property in package.json that refers to the root source file.\n-   */\n-  formatProperty: string;\n-}\n-\n-/**\n- * Instead of writing packaged code by hand, and manually describing the layout of the package, this\n- * function transpiles the TypeScript sources into a flat file structure using a single format. In\n- * this package layout, all compiled sources are at the root of the package, with `.d.ts` files next\n- * to the `.js` files. Each `.js` also has a corresponding `.metadata.json` file alongside with it.\n- *\n- * All generated code is written into the `node_modules` in the top-level filesystem, ready for use\n- * in testing ngcc.\n- *\n- * @param pkgName The name of the package to compile.\n- * @param sources The TypeScript sources to compile.\n- * @param options Allows for configuration of how the sources are compiled.\n- */\n-function compileIntoFlatPackage(\n-    pkgName: string, sources: PackageSources, options: FlatLayoutOptions): void {\n-  const fs = getFileSystem();\n-  const {rootNames, compileFs} = setupCompileFs(sources);\n-\n-  const emit = (options: ts.CompilerOptions) => {\n-    const host = new MockCompilerHost(compileFs);\n-    const program = ts.createProgram({host, rootNames, options});\n-    program.emit();\n-  };\n-\n-  emit({\n-    declaration: true,\n-    emitDecoratorMetadata: true,\n-    moduleResolution: ts.ModuleResolutionKind.NodeJs,\n-    module: options.module,\n-    target: options.target,\n-    lib: [],\n-  });\n-\n-  // Copy over the JS and .d.ts files, and add a .metadata.json for each .d.ts file.\n-  for (const file of rootNames) {\n-    const inFileBase = file.replace(/\\.ts$/, '');\n-\n-    const dtsContents = compileFs.readFile(compileFs.resolve(`/${inFileBase}.d.ts`));\n-    fs.writeFile(fs.resolve(`/node_modules/${pkgName}/${inFileBase}.d.ts`), dtsContents);\n-\n-    const jsContents = compileFs.readFile(compileFs.resolve(`/${inFileBase}.js`));\n-    fs.writeFile(fs.resolve(`/node_modules/${pkgName}/${inFileBase}.js`), jsContents);\n-    fs.writeFile(fs.resolve(`/node_modules/${pkgName}/${inFileBase}.metadata.json`), '{}');\n-  }\n-\n-  // Write the package.json\n-  const pkgJson: unknown = {\n-    name: pkgName,\n-    version: '0.0.1',\n-    [options.formatProperty]: './index.js',\n-    typings: './index.d.ts',\n-  };\n-\n-  fs.writeFile(\n-      fs.resolve(`/node_modules/${pkgName}/package.json`), JSON.stringify(pkgJson, null, 2));\n-}\n-\n-/**\n- * Instead of writing packaged code by hand, and manually describing the layout of the package, this\n- * function transpiles the TypeScript sources into a package layout that of Angular Package Format.\n- * Both esm2015 and esm5 bundles are present in this layout. The .d.ts files reside in the /src\n- * directory and a public .d.ts file is present in the root, re-exporting /src/index.ts.\n- *\n- * Flat modules (fesm2015 and fesm5) and UMD bundles are not generated like they ought to be in APF.\n- *\n- * All generated code is written into the `node_modules` in the top-level filesystem, ready for use\n- * in testing ngcc.\n- */\n-export function compileIntoApf(\n-    pkgName: string, sources: PackageSources, extraCompilerOptions: ts.CompilerOptions = {}): void {\n-  const fs = getFileSystem();\n-  const {rootNames, compileFs} = setupCompileFs(sources);\n-\n-  const emit = (options: ts.CompilerOptions) => {\n-    const host = new MockCompilerHost(compileFs);\n-    const program =\n-        ts.createProgram({host, rootNames, options: {...extraCompilerOptions, ...options}});\n-    program.emit();\n-  };\n-\n-  // Compile esm2015 into /esm2015\n-  compileFs.ensureDir(compileFs.resolve('esm2015'));\n-  emit({\n-    declaration: true,\n-    emitDecoratorMetadata: true,\n-    outDir: './esm2015',\n-    moduleResolution: ts.ModuleResolutionKind.NodeJs,\n-    module: ts.ModuleKind.ESNext,\n-    target: ts.ScriptTarget.ES2015,\n-    lib: [],\n-  });\n-\n-  fs.ensureDir(fs.resolve(`/node_modules/${pkgName}/src`));\n-  fs.ensureDir(fs.resolve(`/node_modules/${pkgName}/esm2015/src`));\n-  for (const file of rootNames) {\n-    const inFileBase = file.replace(/\\.ts$/, '');\n-\n-    // Copy declaration file into /src tree\n-    const dtsContents = compileFs.readFile(compileFs.resolve(`/esm2015/${inFileBase}.d.ts`));\n-    fs.writeFile(fs.resolve(`/node_modules/${pkgName}/src/${inFileBase}.d.ts`), dtsContents);\n-\n-    // Copy compiled source file into /esm2015/src tree\n-    const jsContents = compileFs.readFile(compileFs.resolve(`/esm2015/${inFileBase}.js`));\n-    fs.writeFile(fs.resolve(`/node_modules/${pkgName}/esm2015/src/${inFileBase}.js`), jsContents);\n-  }\n-  fs.writeFile(\n-      fs.resolve(`/node_modules/${pkgName}/esm2015/index.js`), `export * from './src/index';`);\n-\n-  // Compile esm5 into /esm5\n-  compileFs.ensureDir(compileFs.resolve('esm5'));\n-  emit({\n-    declaration: false,\n-    emitDecoratorMetadata: true,\n-    outDir: './esm5',\n-    moduleResolution: ts.ModuleResolutionKind.NodeJs,\n-    module: ts.ModuleKind.ESNext,\n-    target: ts.ScriptTarget.ES5,\n-    lib: [],\n-  });\n-\n-  fs.ensureDir(fs.resolve(`/node_modules/${pkgName}/esm5/src`));\n-  for (const file of rootNames) {\n-    const inFileBase = file.replace(/\\.ts$/, '');\n-\n-    // Copy compiled source file into esm5/src tree\n-    const jsContents = compileFs.readFile(compileFs.resolve(`/esm5/${inFileBase}.js`));\n-    fs.writeFile(fs.resolve(`/node_modules/${pkgName}/esm5/src/${inFileBase}.js`), jsContents);\n-  }\n-  fs.writeFile(\n-      fs.resolve(`/node_modules/${pkgName}/esm5/index.js`), `export * from './src/index';`);\n-\n-  // Write a main declaration and metadata file to the root\n-  fs.writeFile(fs.resolve(`/node_modules/${pkgName}/index.d.ts`), `export * from './src/index';`);\n-  fs.writeFile(fs.resolve(`/node_modules/${pkgName}/index.metadata.json`), '{}');\n-\n-  // Write the package.json\n-  const pkgJson: unknown = {\n-    name: pkgName,\n-    version: '0.0.1',\n-    esm5: './esm5/index.js',\n-    esm2015: './esm2015/index.js',\n-    module: './esm2015/index.js',\n-    typings: './index.d.ts',\n-  };\n-\n-  fs.writeFile(\n-      fs.resolve(`/node_modules/${pkgName}/package.json`), JSON.stringify(pkgJson, null, 2));\n-}\n-\n export function loadNgccIntegrationTestFiles(): Folder {\n   const tmpFs = new MockFileSystemPosix(true);\n   const basePath = '/' as AbsoluteFsPath;\n@@ -240,68 +26,3 @@ export function loadNgccIntegrationTestFiles(): Folder {\n   loadTestDirectory(tmpFs, resolveNpmTreeArtifact('rxjs'), tmpFs.resolve('/node_modules/rxjs'));\n   return tmpFs.dump();\n }\n-\n-const stdFiles = loadNgccIntegrationTestFiles();\n-\n-/**\n- * Prepares a mock filesystem that contains all provided source files, which can be used to emit\n- * compiled code into.\n- */\n-function setupCompileFs(sources: PackageSources): {rootNames: string[], compileFs: FileSystem} {\n-  const compileFs = new MockFileSystemPosix(true);\n-  compileFs.init(stdFiles);\n-\n-  const rootNames = Object.keys(sources);\n-\n-  for (const fileName of rootNames) {\n-    compileFs.writeFile(compileFs.resolve(fileName), sources[fileName]);\n-  }\n-\n-  return {rootNames, compileFs};\n-}\n-\n-/**\n- * A simple `ts.CompilerHost` that uses a `FileSystem` instead of the real FS.\n- *\n- * TODO(alxhub): convert this into a first class `FileSystemCompilerHost` and use it as the base for\n- * the entire compiler.\n- */\n-class MockCompilerHost implements ts.CompilerHost {\n-  constructor(private fs: FileSystem) {}\n-  getSourceFile(\n-      fileName: string, languageVersion: ts.ScriptTarget,\n-      onError?: ((message: string) => void)|undefined,\n-      shouldCreateNewSourceFile?: boolean|undefined): ts.SourceFile|undefined {\n-    return ts.createSourceFile(\n-        fileName, this.fs.readFile(this.fs.resolve(fileName)), languageVersion, true,\n-        ts.ScriptKind.TS);\n-  }\n-\n-  getDefaultLibFileName(options: ts.CompilerOptions): string {\n-    return ts.getDefaultLibFileName(options);\n-  }\n-\n-  writeFile(fileName: string, data: string): void {\n-    this.fs.writeFile(this.fs.resolve(fileName), data);\n-  }\n-\n-  getCurrentDirectory(): string {\n-    return this.fs.pwd();\n-  }\n-  getCanonicalFileName(fileName: string): string {\n-    return fileName;\n-  }\n-  useCaseSensitiveFileNames(): boolean {\n-    return true;\n-  }\n-  getNewLine(): string {\n-    return '\\n';\n-  }\n-  fileExists(fileName: string): boolean {\n-    return this.fs.exists(this.fs.resolve(fileName));\n-  }\n-  readFile(fileName: string): string|undefined {\n-    const abs = this.fs.resolve(fileName);\n-    return this.fs.exists(abs) ? this.fs.readFile(abs) : undefined;\n-  }\n-}"
        }
    ],
    "stats": {
        "total": 2308,
        "additions": 1669,
        "deletions": 639
    }
}