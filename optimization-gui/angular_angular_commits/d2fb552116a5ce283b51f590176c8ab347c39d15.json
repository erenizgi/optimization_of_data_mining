{
    "author": "JoostK",
    "message": "refactor(compiler-cli): create diagnostics using `ts.DiagnosticRelatedInformation` (#37587)\n\nPreviously, an anonymous type was used for creating a diagnostic with related\ninformation. The anonymous type would then be translated into the necessary\n`ts.DiagnosticRelatedInformation` shape within `makeDiagnostic`. This commit\nswitches the `makeDiagnostic` signature over to taking `ts.DiagnosticRelatedInformation`\ndirectly and introduces `makeRelatedInformation` to easily create such objects.\nThis is done to aid in making upcoming work more readable.\n\nPR Close #37587",
    "sha": "d2fb552116a5ce283b51f590176c8ab347c39d15",
    "files": [
        {
            "sha": "5a41d313911309fe1b820e00b35df987238ccfd3",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/diagnostics.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdiagnostics.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdiagnostics.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdiagnostics.ts?ref=d2fb552116a5ce283b51f590176c8ab347c39d15",
            "patch": "@@ -8,7 +8,7 @@\n \n import * as ts from 'typescript';\n \n-import {ErrorCode, makeDiagnostic} from '../../diagnostics';\n+import {ErrorCode, makeDiagnostic, makeRelatedInformation} from '../../diagnostics';\n import {Reference} from '../../imports';\n import {InjectableClassRegistry, MetadataReader} from '../../metadata';\n import {PartialEvaluator} from '../../partial_evaluator';\n@@ -44,7 +44,7 @@ Either add the @Injectable() decorator to '${\n             provider.node.name\n                 .text}', or configure a different provider (such as a provider with 'useFactory').\n `,\n-        [{node: provider.node, messageText: `'${provider.node.name.text}' is declared here.`}]));\n+        [makeRelatedInformation(provider.node, `'${provider.node.name.text}' is declared here.`)]));\n   }\n \n   return diagnostics;"
        },
        {
            "sha": "e78aad3f73c9ecf3b026edc828fbd8a67700cd02",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/ng_module.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts?ref=d2fb552116a5ce283b51f590176c8ab347c39d15",
            "patch": "@@ -9,7 +9,7 @@\n import {compileInjector, compileNgModule, CUSTOM_ELEMENTS_SCHEMA, Expression, ExternalExpr, InvokeFunctionExpr, LiteralArrayExpr, LiteralExpr, NO_ERRORS_SCHEMA, R3Identifiers, R3InjectorMetadata, R3NgModuleMetadata, R3Reference, SchemaMetadata, Statement, STRING_TYPE, WrappedNodeExpr} from '@angular/compiler';\n import * as ts from 'typescript';\n \n-import {ErrorCode, FatalDiagnosticError, makeDiagnostic} from '../../diagnostics';\n+import {ErrorCode, FatalDiagnosticError, makeDiagnostic, makeRelatedInformation} from '../../diagnostics';\n import {DefaultImportRecorder, Reference, ReferenceEmitter} from '../../imports';\n import {InjectableClassRegistry, MetadataReader, MetadataRegistry} from '../../metadata';\n import {PartialEvaluator, ResolvedValue, ResolvedValueArray} from '../../partial_evaluator';\n@@ -133,10 +133,8 @@ export class NgModuleDecoratorHandler implements\n               `Cannot declare '${\n                   ref.node.name\n                       .text}' in an NgModule as it's not a part of the current compilation.`,\n-              [{\n-                node: ref.node.name,\n-                messageText: `'${ref.node.name.text}' is declared here.`,\n-              }]));\n+              [makeRelatedInformation(\n+                  ref.node.name, `'${ref.node.name.text}' is declared here.`)]));\n         }\n       }\n     }"
        },
        {
            "sha": "53c93fc86829b5dbcd090a29b6601f6f2eba35ae",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/util.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts?ref=d2fb552116a5ce283b51f590176c8ab347c39d15",
            "patch": "@@ -9,7 +9,7 @@\n import {Expression, ExternalExpr, LiteralExpr, ParseLocation, ParseSourceFile, ParseSourceSpan, R3DependencyMetadata, R3Reference, R3ResolvedDependencyType, ReadPropExpr, WrappedNodeExpr} from '@angular/compiler';\n import * as ts from 'typescript';\n \n-import {ErrorCode, FatalDiagnosticError, makeDiagnostic} from '../../diagnostics';\n+import {ErrorCode, FatalDiagnosticError, makeDiagnostic, makeRelatedInformation} from '../../diagnostics';\n import {DefaultImportRecorder, ImportFlags, Reference, ReferenceEmitter} from '../../imports';\n import {ForeignFunctionResolver, PartialEvaluator} from '../../partial_evaluator';\n import {ClassDeclaration, CtorParameter, Decorator, Import, isNamedClassDeclaration, ReflectionHost, TypeValueReference} from '../../reflection';\n@@ -408,19 +408,18 @@ export function wrapFunctionExpressionsInParens(expression: ts.Expression): ts.E\n  */\n export function makeDuplicateDeclarationError(\n     node: ClassDeclaration, data: DeclarationData[], kind: string): ts.Diagnostic {\n-  const context: {node: ts.Node; messageText: string;}[] = [];\n+  const context: ts.DiagnosticRelatedInformation[] = [];\n   for (const decl of data) {\n     if (decl.rawDeclarations === null) {\n       continue;\n     }\n     // Try to find the reference to the declaration within the declarations array, to hang the\n     // error there. If it can't be found, fall back on using the NgModule's name.\n     const contextNode = decl.ref.getOriginForDiagnostics(decl.rawDeclarations, decl.ngModule.name);\n-    context.push({\n-      node: contextNode,\n-      messageText: `'${node.name.text}' is listed in the declarations of the NgModule '${\n-          decl.ngModule.name.text}'.`,\n-    });\n+    context.push(makeRelatedInformation(\n+        contextNode,\n+        `'${node.name.text}' is listed in the declarations of the NgModule '${\n+            decl.ngModule.name.text}'.`));\n   }\n \n   // Finally, produce the diagnostic."
        },
        {
            "sha": "991719e867dade27054246a6daa2d38dcc6023d0",
            "filename": "packages/compiler-cli/src/ngtsc/diagnostics/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Findex.ts?ref=d2fb552116a5ce283b51f590176c8ab347c39d15",
            "patch": "@@ -6,6 +6,6 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-export {FatalDiagnosticError, isFatalDiagnosticError, makeDiagnostic} from './src/error';\n+export {FatalDiagnosticError, isFatalDiagnosticError, makeDiagnostic, makeRelatedInformation} from './src/error';\n export {ErrorCode, ngErrorCode} from './src/error_code';\n export {replaceTsWithNgInErrors} from './src/util';"
        },
        {
            "sha": "6dab84bd03cbe617fcb9a0e66c22f485ad7fe9a9",
            "filename": "packages/compiler-cli/src/ngtsc/diagnostics/src/error.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 19,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror.ts?ref=d2fb552116a5ce283b51f590176c8ab347c39d15",
            "patch": "@@ -23,33 +23,32 @@ export class FatalDiagnosticError {\n   }\n }\n \n-export function makeDiagnostic(code: ErrorCode, node: ts.Node, messageText: string, relatedInfo?: {\n-  node: ts.Node,\n-  messageText: string,\n-}[]): ts.DiagnosticWithLocation {\n+export function makeDiagnostic(\n+    code: ErrorCode, node: ts.Node, messageText: string,\n+    relatedInformation?: ts.DiagnosticRelatedInformation[]): ts.DiagnosticWithLocation {\n   node = ts.getOriginalNode(node);\n-  const diag: ts.DiagnosticWithLocation = {\n+  return {\n     category: ts.DiagnosticCategory.Error,\n     code: Number('-99' + code.valueOf()),\n     file: ts.getOriginalNode(node).getSourceFile(),\n     start: node.getStart(undefined, false),\n     length: node.getWidth(),\n     messageText,\n+    relatedInformation,\n+  };\n+}\n+\n+export function makeRelatedInformation(\n+    node: ts.Node, messageText: string): ts.DiagnosticRelatedInformation {\n+  node = ts.getOriginalNode(node);\n+  return {\n+    category: ts.DiagnosticCategory.Message,\n+    code: 0,\n+    file: node.getSourceFile(),\n+    start: node.getStart(),\n+    length: node.getWidth(),\n+    messageText,\n   };\n-  if (relatedInfo !== undefined) {\n-    diag.relatedInformation = relatedInfo.map(info => {\n-      const infoNode = ts.getOriginalNode(info.node);\n-      return {\n-        category: ts.DiagnosticCategory.Message,\n-        code: 0,\n-        file: infoNode.getSourceFile(),\n-        start: infoNode.getStart(),\n-        length: infoNode.getWidth(),\n-        messageText: info.messageText,\n-      };\n-    });\n-  }\n-  return diag;\n }\n \n export function isFatalDiagnosticError(err: any): err is FatalDiagnosticError {"
        },
        {
            "sha": "985058a157d9883d20b0a33e79f39515e1936658",
            "filename": "packages/compiler-cli/src/ngtsc/scope/src/local.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Flocal.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2fb552116a5ce283b51f590176c8ab347c39d15/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Flocal.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Flocal.ts?ref=d2fb552116a5ce283b51f590176c8ab347c39d15",
            "patch": "@@ -9,7 +9,7 @@\n import {ExternalExpr, SchemaMetadata} from '@angular/compiler';\n import * as ts from 'typescript';\n \n-import {ErrorCode, makeDiagnostic} from '../../diagnostics';\n+import {ErrorCode, makeDiagnostic, makeRelatedInformation} from '../../diagnostics';\n import {AliasingHost, Reexport, Reference, ReferenceEmitter} from '../../imports';\n import {DirectiveMeta, MetadataReader, MetadataRegistry, NgModuleMeta, PipeMeta} from '../../metadata';\n import {ClassDeclaration} from '../../reflection';\n@@ -358,7 +358,8 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n                     ngModule.ref.node.name\n                         .text}', but is not a directive, a component, or a pipe. ` +\n                 `Either remove it from the NgModule's declarations, or add an appropriate Angular decorator.`,\n-            [{node: decl.node.name, messageText: `'${decl.node.name.text}' is declared here.`}]));\n+            [makeRelatedInformation(\n+                decl.node.name, `'${decl.node.name.text}' is declared here.`)]));\n         continue;\n       }\n \n@@ -643,8 +644,8 @@ function reexportCollision(\n     To fix this problem please re-export one or both classes directly from this file.\n   `.trim(),\n       [\n-        {node: refA.node.name, messageText: childMessageText},\n-        {node: refB.node.name, messageText: childMessageText},\n+        makeRelatedInformation(refA.node.name, childMessageText),\n+        makeRelatedInformation(refB.node.name, childMessageText),\n       ]);\n }\n "
        }
    ],
    "stats": {
        "total": 73,
        "additions": 35,
        "deletions": 38
    }
}