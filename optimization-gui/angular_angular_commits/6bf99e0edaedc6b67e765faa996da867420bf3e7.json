{
    "author": "mhevery",
    "message": "fix(core): fix possible XSS attack in development through SSR (#40525)\n\nThis is a follow up fix for\nhttps://github.com/angular/angular/pull/40136/commits/894286dd0c92b5af223364237e63798e18b14f58.\n\nIt turns out that comments can be closed in several ways:\n- `<!-->`\n- `<!-- -->`\n- `<!-- --!>`\n\nAll of the above are valid ways to close comment per:\nhttps://html.spec.whatwg.org/multipage/syntax.html#comments\n\nThe new fix surrounds `<` and `>` with zero width space so that it\nrenders in the same way, but it prevents the comment to be closed eagerly.\n\nPR Close #40525",
    "sha": "6bf99e0edaedc6b67e765faa996da867420bf3e7",
    "files": [
        {
            "sha": "f55098583e12ddb5b570da46cb43f5b06b9c5db1",
            "filename": "packages/core/src/util/dom.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 11,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/6bf99e0edaedc6b67e765faa996da867420bf3e7/packages%2Fcore%2Fsrc%2Futil%2Fdom.ts",
            "raw_url": "https://github.com/angular/angular/raw/6bf99e0edaedc6b67e765faa996da867420bf3e7/packages%2Fcore%2Fsrc%2Futil%2Fdom.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Futil%2Fdom.ts?ref=6bf99e0edaedc6b67e765faa996da867420bf3e7",
            "patch": "@@ -6,15 +6,27 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-const END_COMMENT = /-->/g;\n-const END_COMMENT_ESCAPED = '-\\u200B-\\u200B>';\n+/**\n+ * Disallowed strings in the comment.\n+ *\n+ * see: https://html.spec.whatwg.org/multipage/syntax.html#comments\n+ */\n+const COMMENT_DISALLOWED = /^>|^->|<!--|-->|--!>|<!-$/g;\n+/**\n+ * Delimiter in the disallowed strings which needs to be wrapped with zero with character.\n+ */\n+const COMMENT_DELIMITER = /(<|>)/;\n+const COMMENT_DELIMITER_ESCAPED = '\\u200B$1\\u200B';\n \n /**\n- * Escape the content of the strings so that it can be safely inserted into a comment node.\n+ * Escape the content of comment strings so that it can be safely inserted into a comment node.\n  *\n  * The issue is that HTML does not specify any way to escape comment end text inside the comment.\n- * `<!-- The way you close a comment is with \"-->\". -->`. Above the `\"-->\"` is meant to be text not\n- * an end to the comment. This can be created programmatically through DOM APIs.\n+ * Consider: `<!-- The way you close a comment is with \">\", and \"->\" at the beginning or by \"-->\" or\n+ * \"--!>\" at the end. -->`. Above the `\"-->\"` is meant to be text not an end to the comment. This\n+ * can be created programmatically through DOM APIs. (`<!--` are also disallowed.)\n+ *\n+ * see: https://html.spec.whatwg.org/multipage/syntax.html#comments\n  *\n  * ```\n  * div.innerHTML = div.innerHTML\n@@ -25,13 +37,15 @@ const END_COMMENT_ESCAPED = '-\\u200B-\\u200B>';\n  * opening up the application for XSS attack. (In SSR we programmatically create comment nodes which\n  * may contain such text and expect them to be safe.)\n  *\n- * This function escapes the comment text by looking for the closing char sequence `-->` and replace\n- * it with `-_-_>` where the `_` is a zero width space `\\u200B`. The result is that if a comment\n- * contains `-->` text it will render normally but it will not cause the HTML parser to close the\n- * comment.\n+ * This function escapes the comment text by looking for comment delimiters (`<` and `>`) and\n+ * surrounding them with `_>_` where the `_` is a zero width space `\\u200B`. The result is that if a\n+ * comment contains any of the comment start/end delimiters (such as `<!--`, `-->` or `--!>`) the\n+ * text it will render normally but it will not cause the HTML parser to close/open the comment.\n  *\n- * @param value text to make safe for comment node by escaping the comment close character sequence\n+ * @param value text to make safe for comment node by escaping the comment open/close character\n+ *     sequence.\n  */\n export function escapeCommentText(value: string): string {\n-  return value.replace(END_COMMENT, END_COMMENT_ESCAPED);\n+  return value.replace(\n+      COMMENT_DISALLOWED, (text) => text.replace(COMMENT_DELIMITER, COMMENT_DELIMITER_ESCAPED));\n }\n\\ No newline at end of file"
        },
        {
            "sha": "afc8b9ccd40d7adc54c0c56fb76474741979d68d",
            "filename": "packages/core/test/acceptance/security_spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 18,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/6bf99e0edaedc6b67e765faa996da867420bf3e7/packages%2Fcore%2Ftest%2Facceptance%2Fsecurity_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6bf99e0edaedc6b67e765faa996da867420bf3e7/packages%2Fcore%2Ftest%2Facceptance%2Fsecurity_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fsecurity_spec.ts?ref=6bf99e0edaedc6b67e765faa996da867420bf3e7",
            "patch": "@@ -11,24 +11,33 @@ import {TestBed} from '@angular/core/testing';\n \n \n describe('comment node text escaping', () => {\n-  it('should not be possible to do XSS through comment reflect data', () => {\n-    @Component({template: `<div><span *ngIf=\"xssValue\"></span><div>`})\n-    class XSSComp {\n-      xssValue: string = '--> --><script>\"evil\"</script>';\n-    }\n+  // see: https://html.spec.whatwg.org/multipage/syntax.html#comments\n+  ['>',         // self closing\n+   '-->',       // standard closing\n+   '--!>',      // alternate closing\n+   '<!-- -->',  // embedded comment.\n+  ].forEach((xssValue) => {\n+    it('should not be possible to do XSS through comment reflect data when writing: ' + xssValue,\n+       () => {\n+         @Component({template: `<div><span *ngIf=\"xssValue\"></span><div>`})\n+         class XSSComp {\n+           // ngIf serializes the `xssValue` into a comment for debugging purposes.\n+           xssValue: string = xssValue + '<script>\"evil\"</script>';\n+         }\n \n-    TestBed.configureTestingModule({declarations: [XSSComp]});\n-    const fixture = TestBed.createComponent(XSSComp);\n-    fixture.detectChanges();\n-    const div = fixture.nativeElement.querySelector('div') as HTMLElement;\n-    // Serialize into a string to mimic SSR serialization.\n-    const html = div.innerHTML;\n-    // This must be escaped or we have XSS.\n-    expect(html).not.toContain('--><script');\n-    // Now parse it back into DOM (from string)\n-    div.innerHTML = html;\n-    // Verify that we did not accidentally deserialize the `<script>`\n-    const script = div.querySelector('script');\n-    expect(script).toBeFalsy();\n+         TestBed.configureTestingModule({declarations: [XSSComp]});\n+         const fixture = TestBed.createComponent(XSSComp);\n+         fixture.detectChanges();\n+         const div = fixture.nativeElement.querySelector('div') as HTMLElement;\n+         // Serialize into a string to mimic SSR serialization.\n+         const html = div.innerHTML;\n+         // This must be escaped or we have XSS.\n+         expect(html).not.toContain('--><script');\n+         // Now parse it back into DOM (from string)\n+         div.innerHTML = html;\n+         // Verify that we did not accidentally deserialize the `<script>`\n+         const script = div.querySelector('script');\n+         expect(script).toBeFalsy();\n+       });\n   });\n });\n\\ No newline at end of file"
        },
        {
            "sha": "c62618f01707a66608338496a3b8d871ad1147d2",
            "filename": "packages/core/test/util/dom_spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 2,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/6bf99e0edaedc6b67e765faa996da867420bf3e7/packages%2Fcore%2Ftest%2Futil%2Fdom_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6bf99e0edaedc6b67e765faa996da867420bf3e7/packages%2Fcore%2Ftest%2Futil%2Fdom_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Futil%2Fdom_spec.ts?ref=6bf99e0edaedc6b67e765faa996da867420bf3e7",
            "patch": "@@ -14,13 +14,35 @@ describe('comment node text escaping', () => {\n       expect(escapeCommentText('text')).toEqual('text');\n     });\n \n+    it('should escape \"<\" or \">\"', () => {\n+      expect(escapeCommentText('<!--')).toEqual('\\u200b<\\u200b!--');\n+      expect(escapeCommentText('<!--<!--')).toEqual('\\u200b<\\u200b!--\\u200b<\\u200b!--');\n+      expect(escapeCommentText('>')).toEqual('\\u200b>\\u200b');\n+      expect(escapeCommentText('>-->')).toEqual('\\u200b>\\u200b--\\u200b>\\u200b');\n+    });\n+\n     it('should escape end marker', () => {\n-      expect(escapeCommentText('before-->after')).toEqual('before-\\u200b-\\u200b>after');\n+      expect(escapeCommentText('before-->after')).toEqual('before--\\u200b>\\u200bafter');\n     });\n \n     it('should escape multiple markers', () => {\n       expect(escapeCommentText('before-->inline-->after'))\n-          .toEqual('before-\\u200b-\\u200b>inline-\\u200b-\\u200b>after');\n+          .toEqual('before--\\u200b>\\u200binline--\\u200b>\\u200bafter');\n+    });\n+\n+    it('should caver the spec', () => {\n+      // https://html.spec.whatwg.org/multipage/syntax.html#comments\n+      expect(escapeCommentText('>')).toEqual('\\u200b>\\u200b');\n+      expect(escapeCommentText('->')).toEqual('-\\u200b>\\u200b');\n+      expect(escapeCommentText('<!--')).toEqual('\\u200b<\\u200b!--');\n+      expect(escapeCommentText('-->')).toEqual('--\\u200b>\\u200b');\n+      expect(escapeCommentText('--!>')).toEqual('--!\\u200b>\\u200b');\n+      expect(escapeCommentText('<!-')).toEqual('\\u200b<\\u200b!-');\n+\n+      // Things which are OK\n+      expect(escapeCommentText('.>')).toEqual('.>');\n+      expect(escapeCommentText('.->')).toEqual('.->');\n+      expect(escapeCommentText('<!-.')).toEqual('<!-.');\n     });\n   });\n });"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 76,
        "deletions": 31
    }
}