{
    "author": "AndrewKushnir",
    "message": "feat(core): add `getNgModuleById` function to retrieve loaded NgModules by id (#43580)\n\nThis commit adds a new function called `getNgModuleById` to the public API surface of the framework. The `getNgModuleById` function allows to retrieve loaded NgModule class by id (specified via `@NgModule.id`). The function is a replacement for the `getModuleFactory` function.\n\nDEPRECATION:\n\nThe `getModuleFactory` function is deprecated in favor of the `getNgModuleById` one. With Ivy it's possible to work with NgModule classes directly, without retrieving corresponding factories, so the `getNgModuleById` should be used instead.\n\nPR Close #43580",
    "sha": "fe1f6421d2b647adb706e65f69ec2e40e604fac3",
    "files": [
        {
            "sha": "ce6e65ea2c64ca77087ff2e40de6021606660548",
            "filename": "aio/content/guide/deprecations.md",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/fe1f6421d2b647adb706e65f69ec2e40e604fac3/aio%2Fcontent%2Fguide%2Fdeprecations.md",
            "raw_url": "https://github.com/angular/angular/raw/fe1f6421d2b647adb706e65f69ec2e40e604fac3/aio%2Fcontent%2Fguide%2Fdeprecations.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fdeprecations.md?ref=fe1f6421d2b647adb706e65f69ec2e40e604fac3",
            "patch": "@@ -30,6 +30,7 @@ v9 - v12\n v10 - v13\n v11 - v14\n v12 - v15\n+v13 -> v16\n -->\n \n | Area                    | API or Feature                                                                                | May be removed in     |\n@@ -42,6 +43,7 @@ v12 - v15\n | `@angular/core`         | [`RenderComponentType`](#core)                                                                | <!--v7--> v11         |\n | `@angular/core`         | [Factory-based signature of `ApplicationRef.bootstrap`](#core)                                                                       | <!--v13--> v15        |\n | `@angular/core`         | [`PlatformRef.bootstrapModuleFactory`](#core)                                                                       | <!--v13--> v15        |\n+| `@angular/core`         | [`getModuleFactory`](#core)                                                                       | <!--v13--> v16        |\n | `@angular/forms`        | [`ngModel` with reactive forms](#ngmodel-reactive)                                            | <!--v6--> v11         |\n | `@angular/upgrade`      | [`@angular/upgrade`](#upgrade)                                                                | <!--v8--> v11         |\n | `@angular/upgrade`      | [`getAngularLib`](#upgrade-static)                                                            | <!--v8--> v11         |\n@@ -105,6 +107,7 @@ This section contains a complete list all of the currently-deprecated APIs, with\n | [`entryComponents`](api/core/NgModule#entryComponents)                             | none                                                                               | v9                    | See [`entryComponents`](#entryComponents)                                                                                                                                                                                                |\n | [`ANALYZE_FOR_ENTRY_COMPONENTS`](api/core/ANALYZE_FOR_ENTRY_COMPONENTS)            | none                                                                               | v9                    | See [`ANALYZE_FOR_ENTRY_COMPONENTS`](#entryComponents)                                                                                                                                                                                   |\n | [`async`](api/core/testing/async)                                                  | [`waitForAsync`](api/core/testing/waitForAsync)                                    | v11                   | The [`async`](api/core/testing/async) function from `@angular/core/testing` has been renamed to `waitForAsync` in order to avoid confusion with the native JavaScript <code class=\"no-auto-link\">async</code> syntax. The existing function is deprecated and will be removed in a future version. |\n+| [`getModuleFactory`](api/core/getModuleFactory)                                            | [`getNgModuleById`](api/core/getNgModuleById)                                                                               | v13                   | Ivy allows working with NgModule classes directly, without retrieving corresponding factories.                                                                                                                                                                                             |\n | `ViewChildren.emitDistinctChangesOnly` / `ContentChildren.emitDistinctChangesOnly` | none (was part of [issue #40091](https://github.com/angular/angular/issues/40091)) |                       | This is a temporary flag introduced as part of bugfix of [issue #40091](https://github.com/angular/angular/issues/40091) and will be removed.                                                                                            |\n | Factory-based signature of [`ApplicationRef.bootstrap`](api/core/ApplicationRef#bootstrap)                          | Type-based signature of [`ApplicationRef.bootstrap`](api/core/ApplicationRef#bootstrap)                                                                                 | v13                    | With Ivy, there is no need to resolve Component factory and Component Type can be provided directly.                                                                                                                                                                                                                  |\n | [`PlatformRef.bootstrapModuleFactory`](api/core/PlatformRef#bootstrapModuleFactory)                          | [`PlatformRef.bootstrapModule`](api/core/PlatformRef#bootstrapModule)                                                                                 | v13                    | With Ivy, there is no need to resolve NgModule factory and NgModule Type can be provided directly.                                                                                                                                                                                                                  |"
        },
        {
            "sha": "7c498a4abe751428920bd3f48935b0e496fa92af",
            "filename": "goldens/public-api/core/core.md",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/fe1f6421d2b647adb706e65f69ec2e40e604fac3/goldens%2Fpublic-api%2Fcore%2Fcore.md",
            "raw_url": "https://github.com/angular/angular/raw/fe1f6421d2b647adb706e65f69ec2e40e604fac3/goldens%2Fpublic-api%2Fcore%2Fcore.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcore%2Fcore.md?ref=fe1f6421d2b647adb706e65f69ec2e40e604fac3",
            "patch": "@@ -496,9 +496,12 @@ export interface ForwardRefFn {\n // @public (undocumented)\n export const getDebugNode: (nativeNode: any) => DebugNode | null;\n \n-// @public\n+// @public @deprecated\n export const getModuleFactory: (id: string) => NgModuleFactory<any>;\n \n+// @public\n+export const getNgModuleById: <T>(id: string) => Type<T>;\n+\n // @public\n export function getPlatform(): PlatformRef | null;\n "
        },
        {
            "sha": "cbdad67b2bf7d28c2d81a71e3b9363f50ae86d90",
            "filename": "packages/core/src/core_render3_private_export.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "raw_url": "https://github.com/angular/angular/raw/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts?ref=fe1f6421d2b647adb706e65f69ec2e40e604fac3",
            "patch": "@@ -44,6 +44,7 @@ export {\n   SWITCH_ELEMENT_REF_FACTORY__POST_R3__ as ɵSWITCH_ELEMENT_REF_FACTORY__POST_R3__,\n } from './linker/element_ref';\n export { getModuleFactory__POST_R3__ as ɵgetModuleFactory__POST_R3__ } from './linker/ng_module_factory_loader';\n+export { getNgModuleById__POST_R3__ as ɵgetNgModuleById__POST_R3__ } from './linker/ng_module_factory_loader';\n export { registerNgModuleType as ɵregisterNgModuleType } from './linker/ng_module_factory_registration';\n export {\n   SWITCH_TEMPLATE_REF_FACTORY__POST_R3__ as ɵSWITCH_TEMPLATE_REF_FACTORY__POST_R3__,"
        },
        {
            "sha": "8b0cd8a861aa81005f72658b821870f33147b54c",
            "filename": "packages/core/src/linker.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Fsrc%2Flinker.ts",
            "raw_url": "https://github.com/angular/angular/raw/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Fsrc%2Flinker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker.ts?ref=fe1f6421d2b647adb706e65f69ec2e40e604fac3",
            "patch": "@@ -12,7 +12,7 @@ export {ComponentFactory, ComponentRef} from './linker/component_factory';\n export {ComponentFactoryResolver} from './linker/component_factory_resolver';\n export {ElementRef} from './linker/element_ref';\n export {NgModuleFactory, NgModuleRef} from './linker/ng_module_factory';\n-export {getModuleFactory} from './linker/ng_module_factory_loader';\n+export {getModuleFactory, getNgModuleById} from './linker/ng_module_factory_loader';\n export {QueryList} from './linker/query_list';\n export {TemplateRef} from './linker/template_ref';\n export {ViewContainerRef} from './linker/view_container_ref';"
        },
        {
            "sha": "ed48139747b286eaccc72fe72507f6ce6c63c07c",
            "filename": "packages/core/src/linker/ng_module_factory_loader.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 3,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Fsrc%2Flinker%2Fng_module_factory_loader.ts",
            "raw_url": "https://github.com/angular/angular/raw/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Fsrc%2Flinker%2Fng_module_factory_loader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Fng_module_factory_loader.ts?ref=fe1f6421d2b647adb706e65f69ec2e40e604fac3",
            "patch": "@@ -6,6 +6,8 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {Type} from '../interface/type';\n+\n import {NgModuleType} from '../metadata/ng_module_def';\n import {NgModuleFactory as R3NgModuleFactory} from '../render3/ng_module_ref';\n \n@@ -24,14 +26,33 @@ export function getModuleFactory__POST_R3__(id: string): NgModuleFactory<any> {\n   return new R3NgModuleFactory(type);\n }\n \n+export function getNgModuleById__PRE_R3__(id: string): NgModuleType {\n+  throw new Error(`ViewEngine doesn't support retrieving NgModule classes by id`);\n+}\n+\n+export function getNgModuleById__POST_R3__(id: string): NgModuleType {\n+  const type = getRegisteredNgModuleType<NgModuleType>(id);\n+  if (!type) throw noModuleError(id);\n+  return type;\n+}\n+\n /**\n- * Returns the NgModuleFactory with the given id, if it exists and has been loaded.\n- * Factories for modules that do not specify an `id` cannot be retrieved. Throws if the module\n- * cannot be found.\n+ * Returns the NgModuleFactory with the given id (specified using [@NgModule.id\n+ * field](api/core/NgModule#id)), if it exists and has been loaded. Factories for NgModules that do\n+ * not specify an `id` cannot be retrieved. Throws if an NgModule cannot be found.\n  * @publicApi\n+ * @deprecated Use `getNgModuleById` instead.\n  */\n export const getModuleFactory: (id: string) => NgModuleFactory<any> = getModuleFactory__PRE_R3__;\n \n+/**\n+ * Returns the NgModule class with the given id (specified using [@NgModule.id\n+ * field](api/core/NgModule#id)), if it exists and has been loaded. Classes for NgModules that do\n+ * not specify an `id` cannot be retrieved. Throws if an NgModule cannot be found.\n+ * @publicApi\n+ */\n+export const getNgModuleById: <T>(id: string) => Type<T> = getNgModuleById__PRE_R3__;\n+\n function noModuleError(\n     id: string,\n     ): Error {"
        },
        {
            "sha": "dcfe5a38e97750f0a10172515971769c5b183f33",
            "filename": "packages/core/src/linker/ng_module_factory_registration.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Fsrc%2Flinker%2Fng_module_factory_registration.ts",
            "raw_url": "https://github.com/angular/angular/raw/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Fsrc%2Flinker%2Fng_module_factory_registration.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Fng_module_factory_registration.ts?ref=fe1f6421d2b647adb706e65f69ec2e40e604fac3",
            "patch": "@@ -68,6 +68,7 @@ export function clearModulesForTest(): void {\n   modules.clear();\n }\n \n-export function getRegisteredNgModuleType(id: string) {\n-  return modules.get(id) || autoRegisterModuleById[id];\n+export function getRegisteredNgModuleType<T extends NgModuleFactory<unknown>|NgModuleType>(\n+    id: string): T|undefined {\n+  return (modules.get(id) || autoRegisterModuleById[id]) as T | undefined;\n }"
        },
        {
            "sha": "43b4a1c0fffd9319d56c73dd755fa6f1f30afd3f",
            "filename": "packages/core/src/metadata/ng_module.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Fsrc%2Fmetadata%2Fng_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Fsrc%2Fmetadata%2Fng_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fmetadata%2Fng_module.ts?ref=fe1f6421d2b647adb706e65f69ec2e40e604fac3",
            "patch": "@@ -226,9 +226,8 @@ export interface NgModule {\n   schemas?: Array<SchemaMetadata|any[]>;\n \n   /**\n-   * A name or path that uniquely identifies this NgModule in `getModuleFactory`.\n-   * If left `undefined`, the NgModule is not registered with\n-   * `getModuleFactory`.\n+   * A name or path that uniquely identifies this NgModule in `getNgModuleById`.\n+   * If left `undefined`, the NgModule is not registered with `getNgModuleById`.\n    */\n   id?: string;\n "
        },
        {
            "sha": "0a736f60aca0d128a055dfa8bdbd74c6582a6716",
            "filename": "packages/core/test/linker/ng_module_integration_spec.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Ftest%2Flinker%2Fng_module_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/fe1f6421d2b647adb706e65f69ec2e40e604fac3/packages%2Fcore%2Ftest%2Flinker%2Fng_module_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Flinker%2Fng_module_integration_spec.ts?ref=fe1f6421d2b647adb706e65f69ec2e40e604fac3",
            "patch": "@@ -6,8 +6,9 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ANALYZE_FOR_ENTRY_COMPONENTS, Compiler, Component, ComponentFactoryResolver, CUSTOM_ELEMENTS_SCHEMA, Directive, forwardRef, getModuleFactory, HostBinding, Inject, Injectable, InjectionToken, Injector, Input, NgModule, NgModuleRef, Optional, Pipe, Provider, Self, Type, ɵivyEnabled as ivyEnabled, ɵɵdefineNgModule as defineNgModule} from '@angular/core';\n+import {ANALYZE_FOR_ENTRY_COMPONENTS, Compiler, Component, ComponentFactoryResolver, CUSTOM_ELEMENTS_SCHEMA, Directive, forwardRef, getModuleFactory, getNgModuleById, HostBinding, Inject, Injectable, InjectionToken, Injector, Input, NgModule, NgModuleRef, Optional, Pipe, Provider, Self, Type, ɵivyEnabled as ivyEnabled, ɵɵdefineNgModule as defineNgModule} from '@angular/core';\n import {ɵɵdefineInjectable} from '@angular/core/src/di/interface/defs';\n+import {NgModuleType} from '@angular/core/src/render3';\n import {getNgModuleDef} from '@angular/core/src/render3/definition';\n import {NgModuleData} from '@angular/core/src/view/types';\n import {tokenKey} from '@angular/core/src/view/util';\n@@ -329,6 +330,17 @@ function declareTests(config?: {useJit: boolean}) {\n         class SomeModule {\n         }\n         createModule(SomeModule);\n+\n+        if (ivyEnabled) {\n+          const moduleType = getNgModuleById(token);\n+          expect(moduleType).toBeTruthy();\n+          expect(moduleType).toBe(SomeModule as NgModuleType);\n+        } else {\n+          // ViewEngine doesn't support this call, expect it to throw.\n+          expect(() => getNgModuleById(token))\n+              .toThrowError(`ViewEngine doesn't support retrieving NgModule classes by id`);\n+        }\n+\n         const factory = getModuleFactory(token);\n         expect(factory).toBeTruthy();\n         expect(factory.moduleType).toBe(SomeModule);\n@@ -377,8 +389,14 @@ function declareTests(config?: {useJit: boolean}) {\n                   });\n                 }\n \n+                // Verify that we can retrieve NgModule factory by id.\n                 createModuleFactory(ChildModule);\n                 expect(getModuleFactory('child')).toBeAnInstanceOf(NgModuleFactory);\n+\n+                // Verify that we can also retrieve NgModule class by id.\n+                const moduleType = getNgModuleById('child');\n+                expect(moduleType).toBeTruthy();\n+                expect(moduleType).toBe(ChildModule as NgModuleType);\n               });\n     });\n "
        }
    ],
    "stats": {
        "total": 68,
        "additions": 57,
        "deletions": 11
    }
}