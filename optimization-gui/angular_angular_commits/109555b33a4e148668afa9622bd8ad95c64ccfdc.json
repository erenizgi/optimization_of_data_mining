{
    "author": "petebacondarwin",
    "message": "refactor(compiler): track the closing source-span of TagPlaceholders (#38645)\n\nThe `TagPlaceholder` can contain children, in which case there are two source\nspans of interest: the opening tag and the closing tag. This commit now allows\nthe closing tag source-span to be tracked, so that it can be used later in\nsource-mapping.\n\nPR Close #38645",
    "sha": "109555b33a4e148668afa9622bd8ad95c64ccfdc",
    "files": [
        {
            "sha": "0f7c412205bb0d46f757c37113229b48c52ccc5d",
            "filename": "packages/compiler/src/i18n/i18n_ast.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/109555b33a4e148668afa9622bd8ad95c64ccfdc/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/109555b33a4e148668afa9622bd8ad95c64ccfdc/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_ast.ts?ref=109555b33a4e148668afa9622bd8ad95c64ccfdc",
            "patch": "@@ -87,7 +87,7 @@ export class TagPlaceholder implements Node {\n   constructor(\n       public tag: string, public attrs: {[k: string]: string}, public startName: string,\n       public closeName: string, public children: Node[], public isVoid: boolean,\n-      public sourceSpan: ParseSourceSpan) {}\n+      public sourceSpan: ParseSourceSpan, public closeSourceSpan: ParseSourceSpan|null) {}\n \n   visit(visitor: Visitor, context?: any): any {\n     return visitor.visitTagPlaceholder(this, context);\n@@ -151,7 +151,8 @@ export class CloneVisitor implements Visitor {\n   visitTagPlaceholder(ph: TagPlaceholder, context?: any): TagPlaceholder {\n     const children = ph.children.map(n => n.visit(this, context));\n     return new TagPlaceholder(\n-        ph.tag, ph.attrs, ph.startName, ph.closeName, children, ph.isVoid, ph.sourceSpan);\n+        ph.tag, ph.attrs, ph.startName, ph.closeName, children, ph.isVoid, ph.sourceSpan,\n+        ph.closeSourceSpan);\n   }\n \n   visitPlaceholder(ph: Placeholder, context?: any): Placeholder {"
        },
        {
            "sha": "855b9b3a237fea4f36a594aa31841a4746ed47aa",
            "filename": "packages/compiler/src/i18n/i18n_parser.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/109555b33a4e148668afa9622bd8ad95c64ccfdc/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/109555b33a4e148668afa9622bd8ad95c64ccfdc/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts?ref=109555b33a4e148668afa9622bd8ad95c64ccfdc",
            "patch": "@@ -93,7 +93,8 @@ class _I18nVisitor implements html.Visitor {\n     }\n \n     const node = new i18n.TagPlaceholder(\n-        el.name, attrs, startPhName, closePhName, children, isVoid, el.sourceSpan);\n+        el.name, attrs, startPhName, closePhName, children, isVoid, el.startSourceSpan,\n+        el.endSourceSpan);\n     return context.visitNodeFn(el, node);\n   }\n \n@@ -167,22 +168,32 @@ class _I18nVisitor implements html.Visitor {\n \n       if (splitInterpolation.strings[i].length) {\n         // No need to add empty strings\n-        nodes.push(new i18n.Text(splitInterpolation.strings[i], sourceSpan));\n+        const stringSpan = getOffsetSourceSpan(sourceSpan, splitInterpolation.stringSpans[i]);\n+        nodes.push(new i18n.Text(splitInterpolation.strings[i], stringSpan));\n       }\n \n-      nodes.push(new i18n.Placeholder(expression, phName, sourceSpan));\n+      const expressionSpan =\n+          getOffsetSourceSpan(sourceSpan, splitInterpolation.expressionsSpans[i]);\n+      nodes.push(new i18n.Placeholder(expression, phName, expressionSpan));\n       context.placeholderToContent[phName] = sDelimiter + expression + eDelimiter;\n     }\n \n     // The last index contains no expression\n     const lastStringIdx = splitInterpolation.strings.length - 1;\n     if (splitInterpolation.strings[lastStringIdx].length) {\n-      nodes.push(new i18n.Text(splitInterpolation.strings[lastStringIdx], sourceSpan));\n+      const stringSpan =\n+          getOffsetSourceSpan(sourceSpan, splitInterpolation.stringSpans[lastStringIdx]);\n+      nodes.push(new i18n.Text(splitInterpolation.strings[lastStringIdx], stringSpan));\n     }\n     return container;\n   }\n }\n \n+function getOffsetSourceSpan(\n+    sourceSpan: ParseSourceSpan, {start, end}: {start: number, end: number}): ParseSourceSpan {\n+  return new ParseSourceSpan(sourceSpan.start.moveBy(start), sourceSpan.start.moveBy(end));\n+}\n+\n const _CUSTOM_PH_EXP =\n     /\\/\\/[\\s\\S]*i18n[\\s\\S]*\\([\\s\\S]*ph[\\s\\S]*=[\\s\\S]*(\"|')([\\s\\S]*?)\\1[\\s\\S]*\\)/g;\n "
        },
        {
            "sha": "036b6d45fb175f1182e13c677d6e7f0db7d79ea7",
            "filename": "packages/compiler/src/i18n/message_bundle.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/109555b33a4e148668afa9622bd8ad95c64ccfdc/packages%2Fcompiler%2Fsrc%2Fi18n%2Fmessage_bundle.ts",
            "raw_url": "https://github.com/angular/angular/raw/109555b33a4e148668afa9622bd8ad95c64ccfdc/packages%2Fcompiler%2Fsrc%2Fi18n%2Fmessage_bundle.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fmessage_bundle.ts?ref=109555b33a4e148668afa9622bd8ad95c64ccfdc",
            "patch": "@@ -94,7 +94,8 @@ class MapPlaceholderNames extends i18n.CloneVisitor {\n     const closeName = ph.closeName ? mapper.toPublicName(ph.closeName)! : ph.closeName;\n     const children = ph.children.map(n => n.visit(this, mapper));\n     return new i18n.TagPlaceholder(\n-        ph.tag, ph.attrs, startName, closeName, children, ph.isVoid, ph.sourceSpan);\n+        ph.tag, ph.attrs, startName, closeName, children, ph.isVoid, ph.sourceSpan,\n+        ph.closeSourceSpan);\n   }\n \n   visitPlaceholder(ph: i18n.Placeholder, mapper: PlaceholderMapper): i18n.Placeholder {"
        },
        {
            "sha": "910bb735334f2b885ef8c9ddd0425cb4b74b672b",
            "filename": "packages/compiler/test/i18n/serializers/i18n_ast_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/109555b33a4e148668afa9622bd8ad95c64ccfdc/packages%2Fcompiler%2Ftest%2Fi18n%2Fserializers%2Fi18n_ast_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/109555b33a4e148668afa9622bd8ad95c64ccfdc/packages%2Fcompiler%2Ftest%2Fi18n%2Fserializers%2Fi18n_ast_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fi18n%2Fserializers%2Fi18n_ast_spec.ts?ref=109555b33a4e148668afa9622bd8ad95c64ccfdc",
            "patch": "@@ -41,7 +41,7 @@ import {_extractMessages} from '../i18n_parser_spec';\n               new i18n.IcuPlaceholder(null!, '', null!),\n             ],\n             null!);\n-        const tag = new i18n.TagPlaceholder('', {}, '', '', [container], false, null!);\n+        const tag = new i18n.TagPlaceholder('', {}, '', '', [container], false, null!, null);\n         const icu = new i18n.Icu('', '', {tag}, null!);\n \n         icu.visit(visitor);"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 21,
        "deletions": 8
    }
}