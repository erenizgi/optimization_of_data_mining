{
    "author": "kyliau",
    "message": "refactor(language-service): stop tracking lastKwownProgram in CompilerFactory (#41517)\n\nWith the work done in #41291, the compiler always tracks the last known\nprogram, so there's no need to track the program in the compiler factory\nanymore.\n\nPR Close #41517",
    "sha": "25e46c1fe4dc32d8a0c2be294f35c2f881ed9878",
    "files": [
        {
            "sha": "ee990ee8bdf99e101d2d06748b8656beefb6456c",
            "filename": "packages/language-service/ivy/compiler_factory.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/25e46c1fe4dc32d8a0c2be294f35c2f881ed9878/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/25e46c1fe4dc32d8a0c2be294f35c2f881ed9878/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts?ref=25e46c1fe4dc32d8a0c2be294f35c2f881ed9878",
            "patch": "@@ -10,10 +10,8 @@ import {CompilationTicket, freshCompilationTicket, incrementalFromCompilerTicket\n import {NgCompilerOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n import {TrackedIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/incremental';\n import {ProgramDriver} from '@angular/compiler-cli/src/ngtsc/program_driver';\n-import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {LanguageServiceAdapter} from './adapters';\n-import {isExternalTemplate} from './utils';\n \n /**\n  * Manages the `NgCompiler` instance which backs the language service, updating or replacing it as\n@@ -27,7 +25,6 @@ import {isExternalTemplate} from './utils';\n export class CompilerFactory {\n   private readonly incrementalStrategy = new TrackedIncrementalBuildStrategy();\n   private compiler: NgCompiler|null = null;\n-  private lastKnownProgram: ts.Program|null = null;\n \n   constructor(\n       private readonly adapter: LanguageServiceAdapter,\n@@ -39,7 +36,7 @@ export class CompilerFactory {\n     const program = this.programStrategy.getProgram();\n     const modifiedResourceFiles = this.adapter.getModifiedResourceFiles() ?? new Set();\n \n-    if (this.compiler !== null && program === this.lastKnownProgram) {\n+    if (this.compiler !== null && program === this.compiler.getCurrentProgram()) {\n       if (modifiedResourceFiles.size > 0) {\n         // Only resource files have changed since the last NgCompiler was created.\n         const ticket = resourceChangeTicket(this.compiler, modifiedResourceFiles);\n@@ -54,7 +51,7 @@ export class CompilerFactory {\n     }\n \n     let ticket: CompilationTicket;\n-    if (this.compiler === null || this.lastKnownProgram === null) {\n+    if (this.compiler === null) {\n       ticket = freshCompilationTicket(\n           program, this.options, this.incrementalStrategy, this.programStrategy,\n           /* perfRecorder */ null, true, true);\n@@ -64,11 +61,6 @@ export class CompilerFactory {\n           modifiedResourceFiles, /* perfRecorder */ null);\n     }\n     this.compiler = NgCompiler.fromTicket(ticket, this.adapter);\n-    this.lastKnownProgram = program;\n     return this.compiler;\n   }\n-\n-  registerLastKnownProgram() {\n-    this.lastKnownProgram = this.programStrategy.getProgram();\n-  }\n }"
        },
        {
            "sha": "e1607c7f32a268a757357ccbc1ca658fa8477a28",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/25e46c1fe4dc32d8a0c2be294f35c2f881ed9878/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/25e46c1fe4dc32d8a0c2be294f35c2f881ed9878/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=25e46c1fe4dc32d8a0c2be294f35c2f881ed9878",
            "patch": "@@ -266,7 +266,6 @@ export class LanguageService {\n         return undefined;\n       }\n       const result = builder.getCompletionEntrySymbol(entryName);\n-      this.compilerFactory.registerLastKnownProgram();\n       return result;\n     });\n   }\n@@ -360,8 +359,6 @@ export class LanguageService {\n   private withCompilerAndPerfTracing<T>(phase: PerfPhase, p: (compiler: NgCompiler) => T): T {\n     const compiler = this.compilerFactory.getOrCreate();\n     const result = compiler.perfRecorder.inPhase(phase, () => p(compiler));\n-    this.compilerFactory.registerLastKnownProgram();\n-\n     const logger = this.project.projectService.logger;\n     if (logger.hasLevel(ts.server.LogLevel.verbose)) {\n       logger.perftrc(`LanguageService#${PerfPhase[phase]}: ${"
        },
        {
            "sha": "8f9cc991e9f0fa441b10b6fe9f8eff49b4be383e",
            "filename": "packages/language-service/ivy/test/legacy/language_service_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/25e46c1fe4dc32d8a0c2be294f35c2f881ed9878/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/25e46c1fe4dc32d8a0c2be294f35c2f881ed9878/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts?ref=25e46c1fe4dc32d8a0c2be294f35c2f881ed9878",
            "patch": "@@ -207,7 +207,7 @@ describe('language service adapter', () => {\n });\n \n function getLastKnownProgram(ngLS: LanguageService): ts.Program {\n-  const program = ngLS['compilerFactory']['lastKnownProgram'];\n+  const program = ngLS['compilerFactory']['compiler']?.getCurrentProgram();\n   expect(program).toBeDefined();\n   return program!;\n }"
        },
        {
            "sha": "a9821c2721c3003ec2391bda238e2eef113dfae6",
            "filename": "packages/language-service/ivy/testing/src/project.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/25e46c1fe4dc32d8a0c2be294f35c2f881ed9878/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "raw_url": "https://github.com/angular/angular/raw/25e46c1fe4dc32d8a0c2be294f35c2f881ed9878/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts?ref=25e46c1fe4dc32d8a0c2be294f35c2f881ed9878",
            "patch": "@@ -158,8 +158,6 @@ export class Project {\n       const ngDiagnostics = ngCompiler.getDiagnosticsForFile(sf, OptimizeFor.WholeProgram);\n       expect(ngDiagnostics.map(diag => diag.messageText)).toEqual([]);\n     }\n-\n-    this.ngLS.compilerFactory.registerLastKnownProgram();\n   }\n \n   expectNoTemplateDiagnostics(projectFileName: string, className: string): void {\n@@ -172,7 +170,6 @@ export class Project {\n     const component = getClassOrError(sf, className);\n \n     const diags = this.getTemplateTypeChecker().getDiagnosticsForComponent(component);\n-    this.ngLS.compilerFactory.registerLastKnownProgram();\n     expect(diags.map(diag => diag.messageText)).toEqual([]);\n   }\n "
        }
    ],
    "stats": {
        "total": 20,
        "additions": 3,
        "deletions": 17
    }
}