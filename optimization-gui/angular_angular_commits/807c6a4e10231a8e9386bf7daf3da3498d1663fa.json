{
    "author": "devversion",
    "message": "test: update acceptance core tests to work with es2015 (#44505)\n\nUpdates the acceptance core tests to work with ES2015 devmode output.\nThere were two issues surfacing:\n\n* The NodeJS test execution failed because Domino does not handle\n  destructuring syntax properly. This is because `Node.children` is not\n  an iterable.\n\n* `forwardRef` does not work with ES2015 and TypeScript's decorator\n  downlevel emit. This is a known limitation we work around in Angular\n  applications by either compiling tests with the Angular compiler, or\n  by running a custom decorator downlevel transform (like in the CLI).\n\nPR Close #44505",
    "sha": "807c6a4e10231a8e9386bf7daf3da3498d1663fa",
    "files": [
        {
            "sha": "e6e0e5a728267baa458bfadccf7088bb6f550b1c",
            "filename": "packages/core/test/acceptance/BUILD.bazel",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/807c6a4e10231a8e9386bf7daf3da3498d1663fa/packages%2Fcore%2Ftest%2Facceptance%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/807c6a4e10231a8e9386bf7daf3da3498d1663fa/packages%2Fcore%2Ftest%2Facceptance%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2FBUILD.bazel?ref=807c6a4e10231a8e9386bf7daf3da3498d1663fa",
            "patch": "@@ -1,12 +1,17 @@\n-load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"karma_web_test_suite\", \"ts_library\")\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"karma_web_test_suite\", \"ng_module\", \"ts_library\")\n \n package(default_visibility = [\"//visibility:private\"])\n \n+SPEC_FILES_WITH_FORWARD_REFS = [\n+    \"di_forward_ref_spec.ts\",\n+]\n+\n ts_library(\n     name = \"acceptance_lib\",\n     testonly = True,\n     srcs = glob(\n         [\"**/*.ts\"],\n+        exclude = SPEC_FILES_WITH_FORWARD_REFS,\n     ),\n     # Visible to //:saucelabs_unit_tests\n     visibility = [\"//:__pkg__\"],\n@@ -35,11 +40,28 @@ ts_library(\n     ],\n )\n \n+# Note: The `forward_ref` example tests are built through this `ng_module` sub-target.\n+# This is done so that DI decorator/type metadata is processed manually by the compiler\n+# ahead of time. We cannot rely on the official TypeScript decorator downlevel emit (for JIT),\n+# as the output is not compatible with `forwardRef` and ES2015+. More details here:\n+# https://github.com/angular/angular/commit/323651bd38909b0f4226bcb6c8f5abafa91cf9d9.\n+# https://github.com/microsoft/TypeScript/issues/27519.\n+ng_module(\n+    name = \"forward_ref_test_lib\",\n+    testonly = True,\n+    srcs = SPEC_FILES_WITH_FORWARD_REFS,\n+    deps = [\n+        \"//packages/core\",\n+        \"//packages/core/testing\",\n+    ],\n+)\n+\n jasmine_node_test(\n     name = \"acceptance\",\n     bootstrap = [\"//tools/testing:node_es2015\"],\n     deps = [\n         \":acceptance_lib\",\n+        \":forward_ref_test_lib\",\n         \"//packages/zone.js/lib:zone_d_ts\",\n         \"@npm//base64-js\",\n         \"@npm//source-map\",\n@@ -50,5 +72,6 @@ karma_web_test_suite(\n     name = \"acceptance_web\",\n     deps = [\n         \":acceptance_lib\",\n+        \":forward_ref_test_lib\",\n     ],\n )"
        },
        {
            "sha": "4551399ee92e26d8cba077954e7128ae21141f1c",
            "filename": "packages/core/test/acceptance/di_forward_ref_spec.ts",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/angular/angular/blob/807c6a4e10231a8e9386bf7daf3da3498d1663fa/packages%2Fcore%2Ftest%2Facceptance%2Fdi_forward_ref_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/807c6a4e10231a8e9386bf7daf3da3498d1663fa/packages%2Fcore%2Ftest%2Facceptance%2Fdi_forward_ref_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fdi_forward_ref_spec.ts?ref=807c6a4e10231a8e9386bf7daf3da3498d1663fa",
            "patch": "@@ -0,0 +1,67 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Component, Directive, forwardRef, Host, Inject, ViewChild} from '@angular/core';\n+import {TestBed} from '@angular/core/testing';\n+\n+// **NOTE**: More details on why tests relying on `forwardRef` are put into this\n+// file can be found in the `BUILD.bazel` file declaring the forward ref test target.\n+\n+describe('di with forwardRef', () => {\n+  describe('directive injection', () => {\n+    it('should throw if directives try to inject each other', () => {\n+      @Directive({selector: '[dirB]'})\n+      class DirectiveB {\n+        constructor(@Inject(forwardRef(() => DirectiveA)) siblingDir: DirectiveA) {}\n+      }\n+\n+      @Directive({selector: '[dirA]'})\n+      class DirectiveA {\n+        constructor(siblingDir: DirectiveB) {}\n+      }\n+\n+      @Component({template: '<div dirA dirB></div>'})\n+      class MyComp {\n+      }\n+\n+      TestBed.configureTestingModule({declarations: [DirectiveA, DirectiveB, MyComp]});\n+      expect(() => TestBed.createComponent(MyComp))\n+          .toThrowError(\n+              'NG0200: Circular dependency in DI detected for DirectiveA. Find more at https://angular.io/errors/NG0200');\n+    });\n+\n+    describe('flags', () => {\n+      describe('@Host', () => {\n+        it('should find host component on the host itself', () => {\n+          @Directive({selector: '[dirComp]'})\n+          class DirectiveComp {\n+            constructor(@Inject(forwardRef(() => MyComp)) @Host() public comp: MyComp) {}\n+          }\n+\n+          @Component({selector: 'my-comp', template: '<div dirComp></div>'})\n+          class MyComp {\n+            @ViewChild(DirectiveComp) dirComp!: DirectiveComp;\n+          }\n+\n+          @Component({template: '<my-comp></my-comp>', jit: true})\n+          class MyApp {\n+            @ViewChild(MyComp) myComp!: MyComp;\n+          }\n+\n+          TestBed.configureTestingModule({declarations: [DirectiveComp, MyComp, MyApp]});\n+          const fixture = TestBed.createComponent(MyApp);\n+          fixture.detectChanges();\n+\n+          const myComp = fixture.componentInstance.myComp;\n+          const dirComp = myComp.dirComp;\n+          expect(dirComp.comp).toBe(myComp);\n+        });\n+      });\n+    });\n+  });\n+});"
        },
        {
            "sha": "a348745229c2a665fc96574c4bf6904158b9a53b",
            "filename": "packages/core/test/acceptance/di_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 51,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/807c6a4e10231a8e9386bf7daf3da3498d1663fa/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/807c6a4e10231a8e9386bf7daf3da3498d1663fa/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts?ref=807c6a4e10231a8e9386bf7daf3da3498d1663fa",
            "patch": "@@ -684,27 +684,6 @@ describe('di', () => {\n          expect(cmp.componentInstance.testB.a).toBeNull();\n        });\n \n-    it('should throw if directives try to inject each other', () => {\n-      @Directive({selector: '[dirB]'})\n-      class DirectiveB {\n-        constructor(@Inject(forwardRef(() => DirectiveA)) siblingDir: DirectiveA) {}\n-      }\n-\n-      @Directive({selector: '[dirA]'})\n-      class DirectiveA {\n-        constructor(siblingDir: DirectiveB) {}\n-      }\n-\n-      @Component({template: '<div dirA dirB></div>'})\n-      class MyComp {\n-      }\n-\n-      TestBed.configureTestingModule({declarations: [DirectiveA, DirectiveB, MyComp]});\n-      expect(() => TestBed.createComponent(MyComp))\n-          .toThrowError(\n-              'NG0200: Circular dependency in DI detected for DirectiveA. Find more at https://angular.io/errors/NG0200');\n-    });\n-\n     it('should throw if directive tries to inject itself', () => {\n       @Directive({selector: '[dirA]'})\n       class DirectiveA {\n@@ -1781,31 +1760,6 @@ describe('di', () => {\n           expect(dirString.s).toBe('Foo');\n         });\n \n-        it('should find host component on the host itself', () => {\n-          @Directive({selector: '[dirComp]'})\n-          class DirectiveComp {\n-            constructor(@Inject(forwardRef(() => MyComp)) @Host() public comp: MyComp) {}\n-          }\n-\n-          @Component({selector: 'my-comp', template: '<div dirComp></div>'})\n-          class MyComp {\n-            @ViewChild(DirectiveComp) dirComp!: DirectiveComp;\n-          }\n-\n-          @Component({template: '<my-comp></my-comp>'})\n-          class MyApp {\n-            @ViewChild(MyComp) myComp!: MyComp;\n-          }\n-\n-          TestBed.configureTestingModule({declarations: [DirectiveComp, MyComp, MyApp]});\n-          const fixture = TestBed.createComponent(MyApp);\n-          fixture.detectChanges();\n-\n-          const myComp = fixture.componentInstance.myComp;\n-          const dirComp = myComp.dirComp;\n-          expect(dirComp.comp).toBe(myComp);\n-        });\n-\n         it('should not find providers on the host itself', () => {\n           @Component({\n             selector: 'my-comp',\n@@ -1882,19 +1836,19 @@ describe('di', () => {\n         });\n \n         it('should not find component above the host', () => {\n+          @Component({template: '<my-comp></my-comp>'})\n+          class MyApp {\n+          }\n+\n           @Directive({selector: '[dirComp]'})\n           class DirectiveComp {\n-            constructor(@Inject(forwardRef(() => MyApp)) @Host() public comp: MyApp) {}\n+            constructor(@Host() public comp: MyApp) {}\n           }\n \n           @Component({selector: 'my-comp', template: '<div dirComp></div>'})\n           class MyComp {\n           }\n \n-          @Component({template: '<my-comp></my-comp>'})\n-          class MyApp {\n-          }\n-\n           TestBed.configureTestingModule({declarations: [DirectiveComp, MyComp, MyApp]});\n           expect(() => TestBed.createComponent(MyApp))\n               .toThrowError("
        },
        {
            "sha": "a6cada6e8fcff816b6296f05e1f677c373ec9f55",
            "filename": "packages/core/test/acceptance/property_binding_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/807c6a4e10231a8e9386bf7daf3da3498d1663fa/packages%2Fcore%2Ftest%2Facceptance%2Fproperty_binding_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/807c6a4e10231a8e9386bf7daf3da3498d1663fa/packages%2Fcore%2Ftest%2Facceptance%2Fproperty_binding_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fproperty_binding_spec.ts?ref=807c6a4e10231a8e9386bf7daf3da3498d1663fa",
            "patch": "@@ -510,7 +510,12 @@ describe('property bindings', () => {\n       const fixture = TestBed.createComponent(App);\n       const myDir = fixture.debugElement.query(By.directive(MyDir)).injector.get(MyDir);\n       const myDirB = fixture.debugElement.query(By.directive(MyDirB)).injector.get(MyDirB);\n-      const [buttonEl, listboxEl] = fixture.nativeElement.children;\n+      const fixtureElements = fixture.nativeElement.children;\n+\n+      // TODO: Use destructuring once Domino supports native ES2015, or when jsdom is used.\n+      const buttonEl = fixtureElements[0];\n+      const listboxEl = fixtureElements[1];\n+\n       fixture.detectChanges();\n \n       expect(buttonEl.getAttribute('role')).toBe('button');\n@@ -581,7 +586,11 @@ describe('property bindings', () => {\n \n       expect(fixture.nativeElement.children.length).toBe(2);\n \n-      const [comp1, comp2] = fixture.nativeElement.children;\n+      const compElements = fixture.nativeElement.children;\n+\n+      // TODO: Use destructuring once Domino supports native ES2015, or when jsdom is used.\n+      const comp1 = compElements[0];\n+      const comp2 = compElements[1];\n \n       expect(comp1.tagName).toBe('COMP');\n       expect(comp2.tagName).toBe('COMP');"
        },
        {
            "sha": "7fecb884fbafd20ee0299925a56beccc2367a272",
            "filename": "packages/core/test/acceptance/styling_spec.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 10,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/807c6a4e10231a8e9386bf7daf3da3498d1663fa/packages%2Fcore%2Ftest%2Facceptance%2Fstyling_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/807c6a4e10231a8e9386bf7daf3da3498d1663fa/packages%2Fcore%2Ftest%2Facceptance%2Fstyling_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fstyling_spec.ts?ref=807c6a4e10231a8e9386bf7daf3da3498d1663fa",
            "patch": "@@ -60,8 +60,8 @@ describe('styling', () => {\n \n       TestBed.configureTestingModule({declarations: [Cmp]});\n       const fixture = TestBed.createComponent(Cmp);\n+      const staticDiv = fixture.nativeElement.querySelectorAll('div')[0];\n \n-      const [staticDiv] = fixture.nativeElement.querySelectorAll('div');\n       expect(getSortedClassName(staticDiv)).toEqual('STATIC');\n       expect(getSortedStyle(staticDiv)).toEqual('color: blue;');\n     });\n@@ -335,7 +335,12 @@ describe('styling', () => {\n     const fixture = TestBed.createComponent(Cmp);\n     fixture.detectChanges();\n \n-    const [div1, div2] = fixture.nativeElement.querySelectorAll('div');\n+    const divs = fixture.nativeElement.querySelectorAll('div');\n+\n+    // TODO: Use destructuring once Domino supports native ES2015, or when jsdom is used.\n+    const div1 = divs[0];\n+    const div2 = divs[1];\n+\n     // Static value `class=\"s1\"` is always written to the DOM.\n     expect(div1.className).toEqual('s1');\n     expect(div1.getAttribute('shadow-class')).toEqual('s1 d1');\n@@ -367,7 +372,12 @@ describe('styling', () => {\n     const fixture = TestBed.createComponent(Cmp);\n     fixture.detectChanges();\n \n-    const [divStatic, divBinding] = fixture.nativeElement.querySelectorAll('div');\n+    const divs = fixture.nativeElement.querySelectorAll('div');\n+\n+    // TODO: Use destructuring once Domino supports native ES2015, or when jsdom is used.\n+    const divStatic = divs[0];\n+    const divBinding = divs[1];\n+\n     expectClass(divStatic).toEqual({'DIRECTIVE': true, 's1': true});\n     expect(divStatic.getAttribute('shadow-class')).toEqual('s1');\n \n@@ -398,7 +408,12 @@ describe('styling', () => {\n     const fixture = TestBed.createComponent(Cmp);\n     fixture.detectChanges();\n \n-    const [divStatic, divBinding] = fixture.nativeElement.querySelectorAll('div');\n+    const divs = fixture.nativeElement.querySelectorAll('div');\n+\n+    // TODO: Use destructuring once Domino supports native ES2015, or when jsdom is used.\n+    const divStatic = divs[0];\n+    const divBinding = divs[1];\n+\n     expectStyle(divStatic).toEqual({'color': 'red', 'width': '1px'});\n     expect(divStatic.getAttribute('shadow-style')).toEqual('width: 1px;');\n \n@@ -2451,11 +2466,10 @@ describe('styling', () => {\n \n     const items = fixture.nativeElement.querySelectorAll('.item');\n     expect(items.length).toEqual(4);\n-    const [a, b, c, d] = items;\n-    expect(a.style.height).toEqual('0px');\n-    expect(b.style.height).toEqual('100px');\n-    expect(c.style.height).toEqual('200px');\n-    expect(d.style.height).toEqual('300px');\n+    expect(items[0].style.height).toEqual('0px');\n+    expect(items[1].style.height).toEqual('100px');\n+    expect(items[2].style.height).toEqual('200px');\n+    expect(items[3].style.height).toEqual('300px');\n \n     const section = fixture.nativeElement.querySelector('section');\n     const p = fixture.nativeElement.querySelector('p');\n@@ -3342,7 +3356,11 @@ describe('styling', () => {\n     const fixture = TestBed.createComponent(MyComp);\n     fixture.detectChanges();\n \n-    const [div1, div2] = fixture.nativeElement.querySelectorAll('div') as HTMLDivElement[];\n+    const divs = fixture.nativeElement.querySelectorAll('div') as HTMLDivElement[];\n+\n+    // TODO: Use destructuring once Domino supports native ES2015, or when jsdom is used.\n+    const div1 = divs[0];\n+    const div2 = divs[1];\n \n     expect(div1.className).toBe('');\n     expect(div2.className).toBe('');"
        }
    ],
    "stats": {
        "total": 199,
        "additions": 135,
        "deletions": 64
    }
}