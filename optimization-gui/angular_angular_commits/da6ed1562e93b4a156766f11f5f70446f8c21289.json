{
    "author": "petebacondarwin",
    "message": "fix(compiler): strip scoped selectors from `@font-face` rules (#41815)\n\n`@font-face` rules cannot contain nested selectors. Nor can they be\nnested under a selector. Normally this would be a syntax error by the\nauthor of the styles. But in some rare cases, such as importing styles\nfrom a library, and applying `:host ::ng-deep` to the imported styles,\nwe can end up with broken css if the imported styles happen to contain\n`@font-face` rules.\n\nThis commit works around this problem by sanitizing such cases (erasing\nany scoping selectors) during emulated ShadowDOM encapsulation style\nprocessing.\n\nFixes #41751\n\nPR Close #41815",
    "sha": "da6ed1562e93b4a156766f11f5f70446f8c21289",
    "files": [
        {
            "sha": "15e805c00f3c9ed0eb7e613ac885a6a8d816d176",
            "filename": "packages/compiler/src/shadow_css.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/da6ed1562e93b4a156766f11f5f70446f8c21289/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts",
            "raw_url": "https://github.com/angular/angular/raw/da6ed1562e93b4a156766f11f5f70446f8c21289/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts?ref=da6ed1562e93b4a156766f11f5f70446f8c21289",
            "patch": "@@ -374,11 +374,40 @@ export class ShadowCss {\n           rule.selector.startsWith('@media') || rule.selector.startsWith('@supports') ||\n           rule.selector.startsWith('@page') || rule.selector.startsWith('@document')) {\n         content = this._scopeSelectors(rule.content, scopeSelector, hostSelector);\n+      } else if (rule.selector.startsWith('@font-face')) {\n+        content = this._stripScopingSelectors(rule.content, scopeSelector, hostSelector);\n       }\n       return new CssRule(selector, content);\n     });\n   }\n \n+  /**\n+   * Handle a css text that is within a rule that should not contain scope selectors by simply\n+   * removing them! An example of such a rule is `@font-face`.\n+   *\n+   * `@font-face` rules cannot contain nested selectors. Nor can they be nested under a selector.\n+   * Normally this would be a syntax error by the author of the styles. But in some rare cases, such\n+   * as importing styles from a library, and applying `:host ::ng-deep` to the imported styles, we\n+   * can end up with broken css if the imported styles happen to contain @font-face rules.\n+   *\n+   * For example:\n+   *\n+   * ```\n+   * :host ::ng-deep {\n+   *   import 'some/lib/containing/font-face';\n+   * }\n+   * ```\n+   */\n+  private _stripScopingSelectors(cssText: string, scopeSelector: string, hostSelector: string):\n+      string {\n+    return processRules(cssText, rule => {\n+      const selector = rule.selector.replace(_shadowDeepSelectors, ' ')\n+                           .replace(_polyfillHostNoCombinatorRe, ' ');\n+      const content = this._scopeSelectors(rule.content, scopeSelector, hostSelector);\n+      return new CssRule(selector, content);\n+    });\n+  }\n+\n   private _scopeSelector(\n       selector: string, scopeSelector: string, hostSelector: string, strict: boolean): string {\n     return selector.split(',')"
        },
        {
            "sha": "16ddc93d0f61ae5ef8a55fd8ebbcd00c361ac2c2",
            "filename": "packages/compiler/test/shadow_css_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/da6ed1562e93b4a156766f11f5f70446f8c21289/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/da6ed1562e93b4a156766f11f5f70446f8c21289/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts?ref=da6ed1562e93b4a156766f11f5f70446f8c21289",
            "patch": "@@ -369,6 +369,18 @@ import {normalizeCSS} from '@angular/platform-browser/testing/src/browser_util';\n       expect(s(css, 'contenta', 'h')).toEqual('[h] > > .x {}');\n     });\n \n+    it('should strip ::ng-deep and :host from within @font-face', () => {\n+      expect(s('@font-face { font-family {} }', 'contenta', 'h'))\n+          .toEqual('@font-face { font-family {}}');\n+      expect(s('@font-face { ::ng-deep font-family{} }', 'contenta', 'h'))\n+          .toEqual('@font-face { font-family{}}');\n+      expect(s('@font-face { :host ::ng-deep font-family{} }', 'contenta', 'h'))\n+          .toEqual('@font-face { font-family{}}');\n+      expect(s('@supports (display: flex) { @font-face { :host ::ng-deep font-family{} } }',\n+               'contenta', 'h'))\n+          .toEqual('@supports (display:flex) { @font-face { font-family{}}}');\n+    });\n+\n     it('should pass through @import directives', () => {\n       const styleStr = '@import url(\"https://fonts.googleapis.com/css?family=Roboto\");';\n       const css = s(styleStr, 'contenta');"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 41,
        "deletions": 0
    }
}