{
    "author": "AndrewKushnir",
    "message": "fix(core): cleanup DOM elements when root view is removed (#37600)\n\nCurrently when bootstrapped component is being removed using `ComponentRef.destroy` or `NgModuleRef.destroy` methods, DOM nodes may be retained in the DOM tree. This commit fixes that problem by always attaching host element of the internal root view to the component's host view node, so the cleanup can happen correctly.\n\nResolves #36449.\n\nPR Close #37600",
    "sha": "9118f49a63140f9ac0fb8c04aec64ddadd37deae",
    "files": [
        {
            "sha": "5c8e8b1ae5eb56ed5a2ea0d8136ceda99543aaf3",
            "filename": "packages/core/src/render3/component_ref.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 14,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/9118f49a63140f9ac0fb8c04aec64ddadd37deae/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/9118f49a63140f9ac0fb8c04aec64ddadd37deae/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent_ref.ts?ref=9118f49a63140f9ac0fb8c04aec64ddadd37deae",
            "patch": "@@ -155,14 +155,6 @@ export class ComponentFactory<T> extends viewEngine_ComponentFactory<T> {\n \n     const rootFlags = this.componentDef.onPush ? LViewFlags.Dirty | LViewFlags.IsRoot :\n                                                  LViewFlags.CheckAlways | LViewFlags.IsRoot;\n-\n-    // Check whether this Component needs to be isolated from other components, i.e. whether it\n-    // should be placed into its own (empty) root context or existing root context should be used.\n-    // Note: this is internal-only convention and might change in the future, so it should not be\n-    // relied upon externally.\n-    const isIsolated = typeof rootSelectorOrNode === 'string' &&\n-        /^#root-ng-internal-isolated-\\d+/.test(rootSelectorOrNode);\n-\n     const rootContext = createRootContext();\n \n     // Create the root view. Uses empty TView and ContentTemplate.\n@@ -232,12 +224,10 @@ export class ComponentFactory<T> extends viewEngine_ComponentFactory<T> {\n         this.componentType, component,\n         createElementRef(viewEngine_ElementRef, tElementNode, rootLView), rootLView, tElementNode);\n \n-    if (!rootSelectorOrNode || isIsolated) {\n-      // The host element of the internal or isolated root view is attached to the component's host\n-      // view node.\n-      ngDevMode && assertNodeOfPossibleTypes(rootTView.node, TNodeType.View);\n-      rootTView.node!.child = tElementNode;\n-    }\n+    // The host element of the internal root view is attached to the component's host view node.\n+    ngDevMode && assertNodeOfPossibleTypes(rootTView.node, TNodeType.View);\n+    rootTView.node!.child = tElementNode;\n+\n     return componentRef;\n   }\n }"
        },
        {
            "sha": "7024c3b6c5693114170cedd1c8244579c2b549cc",
            "filename": "packages/core/test/acceptance/bootstrap_spec.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 41,
            "changes": 89,
            "blob_url": "https://github.com/angular/angular/blob/9118f49a63140f9ac0fb8c04aec64ddadd37deae/packages%2Fcore%2Ftest%2Facceptance%2Fbootstrap_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9118f49a63140f9ac0fb8c04aec64ddadd37deae/packages%2Fcore%2Ftest%2Facceptance%2Fbootstrap_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fbootstrap_spec.ts?ref=9118f49a63140f9ac0fb8c04aec64ddadd37deae",
            "patch": "@@ -40,9 +40,11 @@ describe('bootstrap', () => {\n \n   describe('options', () => {\n     function createComponentAndModule(\n-        options: {encapsulation?: ViewEncapsulation; preserveWhitespaces?: boolean} = {}) {\n+        options:\n+            {encapsulation?: ViewEncapsulation; preserveWhitespaces?: boolean;\n+             selector?: string} = {}) {\n       @Component({\n-        selector: 'my-app',\n+        selector: options.selector || 'my-app',\n         styles: [''],\n         template: '<span>a    b</span>',\n         encapsulation: options.encapsulation,\n@@ -155,100 +157,105 @@ describe('bootstrap', () => {\n       });\n \n       it('should log an error when changing defaultEncapsulation bootstrap options',\n-         withBody('<my-app></my-app>', async () => {\n-           const TestModule = createComponentAndModule();\n+         withBody('<my-app-a></my-app-a><my-app-b></my-app-b>', async () => {\n            const platformRef = platformBrowserDynamic();\n \n-           const ngModuleRef = await platformRef.bootstrapModule(\n-               TestModule, {defaultEncapsulation: ViewEncapsulation.None});\n-           ngModuleRef.destroy();\n+           const TestModuleA = createComponentAndModule({selector: 'my-app-a'});\n+           const ngModuleRefA = await platformRef.bootstrapModule(\n+               TestModuleA, {defaultEncapsulation: ViewEncapsulation.None});\n+           ngModuleRefA.destroy();\n \n-           const ngModuleRef2 = await platformRef.bootstrapModule(\n-               TestModule, {defaultEncapsulation: ViewEncapsulation.ShadowDom});\n+           const TestModuleB = createComponentAndModule({selector: 'my-app-b'});\n+           const ngModuleRefB = await platformRef.bootstrapModule(\n+               TestModuleB, {defaultEncapsulation: ViewEncapsulation.ShadowDom});\n            expect(console.error)\n                .toHaveBeenCalledWith(\n                    'Provided value for `defaultEncapsulation` can not be changed once it has been set.');\n \n            // The options should not have been changed\n            expect(document.body.innerHTML).not.toContain('_ngcontent-');\n \n-           ngModuleRef2.destroy();\n+           ngModuleRefB.destroy();\n          }));\n \n       it('should log an error when changing preserveWhitespaces bootstrap options',\n-         withBody('<my-app></my-app>', async () => {\n-           const TestModule = createComponentAndModule();\n+         withBody('<my-app-a></my-app-a><my-app-b></my-app-b>', async () => {\n            const platformRef = platformBrowserDynamic();\n \n-           const ngModuleRef =\n-               await platformRef.bootstrapModule(TestModule, {preserveWhitespaces: true});\n-           ngModuleRef.destroy();\n+           const TestModuleA = createComponentAndModule({selector: 'my-app-a'});\n+           const ngModuleRefA =\n+               await platformRef.bootstrapModule(TestModuleA, {preserveWhitespaces: true});\n+           ngModuleRefA.destroy();\n \n-           const ngModuleRef2 =\n-               await platformRef.bootstrapModule(TestModule, {preserveWhitespaces: false});\n+           const TestModuleB = createComponentAndModule({selector: 'my-app-b'});\n+           const ngModuleRefB =\n+               await platformRef.bootstrapModule(TestModuleB, {preserveWhitespaces: false});\n            expect(console.error)\n                .toHaveBeenCalledWith(\n                    'Provided value for `preserveWhitespaces` can not be changed once it has been set.');\n \n            // The options should not have been changed\n            expect(document.body.innerHTML).toContain('a    b');\n \n-           ngModuleRef2.destroy();\n+           ngModuleRefB.destroy();\n          }));\n \n       it('should log an error when changing defaultEncapsulation to its default',\n-         withBody('<my-app></my-app>', async () => {\n-           const TestModule = createComponentAndModule();\n+         withBody('<my-app-a></my-app-a><my-app-b></my-app-b>', async () => {\n            const platformRef = platformBrowserDynamic();\n \n-           const ngModuleRef = await platformRef.bootstrapModule(TestModule);\n-           ngModuleRef.destroy();\n+           const TestModuleA = createComponentAndModule({selector: 'my-app-a'});\n+           const ngModuleRefA = await platformRef.bootstrapModule(TestModuleA);\n+           ngModuleRefA.destroy();\n \n-           const ngModuleRef2 = await platformRef.bootstrapModule(\n-               TestModule, {defaultEncapsulation: ViewEncapsulation.Emulated});\n+           const TestModuleB = createComponentAndModule({selector: 'my-app-b'});\n+           const ngModuleRefB = await platformRef.bootstrapModule(\n+               TestModuleB, {defaultEncapsulation: ViewEncapsulation.Emulated});\n            // Although the configured value may be identical to the default, the provided set of\n            // options has still been changed compared to the previously provided options.\n            expect(console.error)\n                .toHaveBeenCalledWith(\n                    'Provided value for `defaultEncapsulation` can not be changed once it has been set.');\n \n-           ngModuleRef2.destroy();\n+           ngModuleRefB.destroy();\n          }));\n \n       it('should log an error when changing preserveWhitespaces to its default',\n-         withBody('<my-app></my-app>', async () => {\n-           const TestModule = createComponentAndModule();\n+         withBody('<my-app-a></my-app-a><my-app-b></my-app-b>', async () => {\n            const platformRef = platformBrowserDynamic();\n \n-           const ngModuleRef = await platformRef.bootstrapModule(TestModule);\n-           ngModuleRef.destroy();\n+           const TestModuleA = createComponentAndModule({selector: 'my-app-a'});\n+           const ngModuleRefA = await platformRef.bootstrapModule(TestModuleA);\n+           ngModuleRefA.destroy();\n \n-           const ngModuleRef2 =\n-               await platformRef.bootstrapModule(TestModule, {preserveWhitespaces: false});\n+           const TestModuleB = createComponentAndModule({selector: 'my-app-b'});\n+           const ngModuleRefB =\n+               await platformRef.bootstrapModule(TestModuleB, {preserveWhitespaces: false});\n            // Although the configured value may be identical to the default, the provided set of\n            // options has still been changed compared to the previously provided options.\n            expect(console.error)\n                .toHaveBeenCalledWith(\n                    'Provided value for `preserveWhitespaces` can not be changed once it has been set.');\n \n-           ngModuleRef2.destroy();\n+           ngModuleRefB.destroy();\n          }));\n \n       it('should not log an error when passing identical bootstrap options',\n-         withBody('<my-app></my-app>', async () => {\n-           const TestModule = createComponentAndModule();\n+         withBody('<my-app-a></my-app-a><my-app-b></my-app-b>', async () => {\n            const platformRef = platformBrowserDynamic();\n \n-           const ngModuleRef1 = await platformRef.bootstrapModule(\n-               TestModule,\n+           const TestModuleA = createComponentAndModule({selector: 'my-app-a'});\n+           const ngModuleRefA = await platformRef.bootstrapModule(\n+               TestModuleA,\n                {defaultEncapsulation: ViewEncapsulation.None, preserveWhitespaces: true});\n-           ngModuleRef1.destroy();\n+           ngModuleRefA.destroy();\n \n            // Bootstrapping multiple modules using the exact same options should be allowed.\n-           const ngModuleRef2 = await platformRef.bootstrapModule(\n-               TestModule,\n+           const TestModuleB = createComponentAndModule({selector: 'my-app-b'});\n+           const ngModuleRefB = await platformRef.bootstrapModule(\n+               TestModuleB,\n                {defaultEncapsulation: ViewEncapsulation.None, preserveWhitespaces: true});\n-           ngModuleRef2.destroy();\n+           ngModuleRefB.destroy();\n          }));\n     });\n   });\n@@ -282,4 +289,4 @@ export class MultipleSelectorsAppComponent {\n   bootstrap: [MultipleSelectorsAppComponent],\n })\n export class MultipleSelectorsAppModule {\n-}\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "ae3e605f06615bf78b917cca325011e5e6d932f5",
            "filename": "packages/core/test/acceptance/component_spec.ts",
            "status": "modified",
            "additions": 71,
            "deletions": 1,
            "changes": 72,
            "blob_url": "https://github.com/angular/angular/blob/9118f49a63140f9ac0fb8c04aec64ddadd37deae/packages%2Fcore%2Ftest%2Facceptance%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9118f49a63140f9ac0fb8c04aec64ddadd37deae/packages%2Fcore%2Ftest%2Facceptance%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fcomponent_spec.ts?ref=9118f49a63140f9ac0fb8c04aec64ddadd37deae",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {DOCUMENT} from '@angular/common';\n-import {Component, ComponentFactoryResolver, ComponentRef, ElementRef, InjectionToken, Injector, Input, NgModule, OnDestroy, Renderer2, RendererFactory2, Type, ViewChild, ViewContainerRef, ViewEncapsulation, ɵsetDocument} from '@angular/core';\n+import {ApplicationRef, Component, ComponentFactoryResolver, ComponentRef, ElementRef, InjectionToken, Injector, Input, NgModule, OnDestroy, Renderer2, RendererFactory2, Type, ViewChild, ViewContainerRef, ViewEncapsulation, ɵsetDocument} from '@angular/core';\n import {TestBed} from '@angular/core/testing';\n import {ɵDomRendererFactory2 as DomRendererFactory2} from '@angular/platform-browser';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n@@ -189,6 +189,76 @@ describe('component', () => {\n     });\n   });\n \n+  it('should clear the contents of dynamically created component when it\\'s attached to ApplicationRef',\n+     () => {\n+       let wasOnDestroyCalled = false;\n+       @Component({\n+         selector: '[comp]',\n+         template: 'comp content',\n+       })\n+       class DynamicComponent {\n+         ngOnDestroy() {\n+           wasOnDestroyCalled = true;\n+         }\n+       }\n+\n+       @NgModule({\n+         declarations: [DynamicComponent],\n+         entryComponents: [DynamicComponent],  // needed only for ViewEngine\n+       })\n+       class TestModule {\n+       }\n+\n+       @Component({\n+         selector: 'button',\n+         template: `\n+           <div class=\"wrapper\"></div>\n+           <div id=\"app-root\"></div>\n+           <div class=\"wrapper\"></div>\n+         `,\n+       })\n+       class App {\n+         componentRef!: ComponentRef<DynamicComponent>;\n+\n+         constructor(\n+             private cfr: ComponentFactoryResolver, private injector: Injector,\n+             private appRef: ApplicationRef) {}\n+\n+         create() {\n+           const factory = this.cfr.resolveComponentFactory(DynamicComponent);\n+           // Component to be bootstrapped into an element with the `app-root` id.\n+           this.componentRef = factory.create(this.injector, undefined, '#app-root');\n+           this.appRef.attachView(this.componentRef.hostView);\n+         }\n+\n+         destroy() {\n+           this.componentRef.destroy();\n+         }\n+       }\n+\n+       TestBed.configureTestingModule({imports: [TestModule], declarations: [App]});\n+       const fixture = TestBed.createComponent(App);\n+       fixture.detectChanges();\n+\n+       let appRootEl = fixture.nativeElement.querySelector('#app-root');\n+       expect(appRootEl).toBeDefined();\n+       expect(appRootEl.innerHTML).toBe('');  // app container content is empty\n+\n+       fixture.componentInstance.create();\n+\n+       appRootEl = fixture.nativeElement.querySelector('#app-root');\n+       expect(appRootEl).toBeDefined();\n+       expect(appRootEl.innerHTML).toBe('comp content');\n+\n+       fixture.componentInstance.destroy();\n+       fixture.detectChanges();\n+\n+       appRootEl = fixture.nativeElement.querySelector('#app-root');\n+       expect(appRootEl).toBeFalsy();  // host element is removed\n+       const wrapperEls = fixture.nativeElement.querySelectorAll('.wrapper');\n+       expect(wrapperEls.length).toBe(2);  // other elements are preserved\n+     });\n+\n   it('should use a new ngcontent attribute for child elements created w/ Renderer2', () => {\n     @Component({\n       selector: 'app-root',"
        },
        {
            "sha": "4adbcbcfcb94a4eb484d79c2b90088e5d7da8b96",
            "filename": "packages/core/test/acceptance/ng_module_spec.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 2,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/9118f49a63140f9ac0fb8c04aec64ddadd37deae/packages%2Fcore%2Ftest%2Facceptance%2Fng_module_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9118f49a63140f9ac0fb8c04aec64ddadd37deae/packages%2Fcore%2Ftest%2Facceptance%2Fng_module_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fng_module_spec.ts?ref=9118f49a63140f9ac0fb8c04aec64ddadd37deae",
            "patch": "@@ -7,10 +7,12 @@\n  */\n \n import {CommonModule} from '@angular/common';\n-import {Component, CUSTOM_ELEMENTS_SCHEMA, Injectable, InjectionToken, NgModule, NgModuleRef, NO_ERRORS_SCHEMA, ɵsetClassMetadata as setClassMetadata, ɵɵdefineComponent as defineComponent, ɵɵdefineInjector as defineInjector, ɵɵdefineNgModule as defineNgModule, ɵɵelement as element, ɵɵproperty as property} from '@angular/core';\n+import {Component, CUSTOM_ELEMENTS_SCHEMA, destroyPlatform, Injectable, InjectionToken, NgModule, NgModuleRef, NO_ERRORS_SCHEMA, ɵsetClassMetadata as setClassMetadata, ɵɵdefineComponent as defineComponent, ɵɵdefineInjector as defineInjector, ɵɵdefineNgModule as defineNgModule, ɵɵelement as element, ɵɵproperty as property} from '@angular/core';\n import {TestBed} from '@angular/core/testing';\n+import {BrowserModule} from '@angular/platform-browser';\n+import {platformBrowserDynamic} from '@angular/platform-browser-dynamic';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n-import {modifiedInIvy, onlyInIvy} from '@angular/private/testing';\n+import {modifiedInIvy, onlyInIvy, withBody} from '@angular/private/testing';\n \n describe('NgModule', () => {\n   @Component({template: 'hello'})\n@@ -100,6 +102,44 @@ describe('NgModule', () => {\n     expect(TestBed.inject(Service).initializations).toEqual(['RoutesModule', 'AppModule']);\n   });\n \n+  describe('destroy', () => {\n+    beforeEach(destroyPlatform);\n+    afterEach(destroyPlatform);\n+\n+    it('should clear bootstrapped component contents',\n+       withBody('<div>before</div><button></button><div>after</div>', async () => {\n+         let wasOnDestroyCalled = false;\n+         @Component({\n+           selector: 'button',\n+           template: 'button content',\n+         })\n+         class App {\n+           ngOnDestroy() {\n+             wasOnDestroyCalled = true;\n+           }\n+         }\n+\n+         @NgModule({\n+           imports: [BrowserModule],\n+           declarations: [App],\n+           bootstrap: [App],\n+         })\n+         class AppModule {\n+         }\n+         const ngModuleRef = await platformBrowserDynamic().bootstrapModule(AppModule);\n+\n+         const button = document.body.querySelector('button')!;\n+         expect(button.textContent).toEqual('button content');\n+         expect(document.body.childNodes.length).toEqual(3);\n+\n+         ngModuleRef.destroy();\n+\n+         expect(wasOnDestroyCalled).toEqual(true);\n+         expect(document.body.querySelector('button')).toBeFalsy();  // host element is removed\n+         expect(document.body.childNodes.length).toEqual(2);         // other elements are preserved\n+       }));\n+  });\n+\n   describe('schemas', () => {\n     onlyInIvy('Unknown property logs an error message instead of throwing')\n         .it('should throw on unknown props if NO_ERRORS_SCHEMA is absent', () => {"
        },
        {
            "sha": "45aeae770f20b2b637be2758f1d3dab4001ef461",
            "filename": "packages/core/testing/src/r3_test_bed.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9118f49a63140f9ac0fb8c04aec64ddadd37deae/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed.ts",
            "raw_url": "https://github.com/angular/angular/raw/9118f49a63140f9ac0fb8c04aec64ddadd37deae/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed.ts?ref=9118f49a63140f9ac0fb8c04aec64ddadd37deae",
            "patch": "@@ -332,7 +332,7 @@ export class TestBedRender3 implements TestBed {\n \n   createComponent<T>(type: Type<T>): ComponentFixture<T> {\n     const testComponentRenderer = this.inject(TestComponentRenderer);\n-    const rootElId = `root-ng-internal-isolated-${_nextRootElementId++}`;\n+    const rootElId = `root${_nextRootElementId++}`;\n     testComponentRenderer.insertRootElement(rootElId);\n \n     const componentDef = (type as any).ɵcmp;"
        }
    ],
    "stats": {
        "total": 225,
        "additions": 166,
        "deletions": 59
    }
}