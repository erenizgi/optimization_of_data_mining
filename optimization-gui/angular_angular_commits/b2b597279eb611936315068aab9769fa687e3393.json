{
    "author": "dgp1130",
    "message": "fix(compiler-cli): updates `ngc` to pass the build when only warnings are emitted (#43673)\n\nRefs #42966.\n\nPreviously, a build when emitted one warning and no errors would fail with a non-zero exit code. This is not what users would expect, but had not been an issue before since the compiler did not actually emit any warnings. With upcoming extended template diagnostics and other warnings, this is now a case that needs to be supported. Warnings are printed to `stderr` as before, but `ngc` now exits with code `0` and the build is considered successful.\n\nImplemented this by adding a new `expectedExitCode` parameter to `driveDiagnostics()` which asserts against the real exit code. Most importantly, it does not **require** the the build to pass since any exit code can be given, so it is up to the test to assert this as well as many messages printed to make sure they are acceptable. This is useful for testing warnings and ensuring the build still passes.\n\nPR Close #43673",
    "sha": "b2b597279eb611936315068aab9769fa687e3393",
    "files": [
        {
            "sha": "a93c926caa2fe94a5ac6b090a947e24293e7dd81",
            "filename": "packages/compiler-cli/src/main.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/b2b597279eb611936315068aab9769fa687e3393/packages%2Fcompiler-cli%2Fsrc%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/b2b597279eb611936315068aab9769fa687e3393/packages%2Fcompiler-cli%2Fsrc%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fmain.ts?ref=b2b597279eb611936315068aab9769fa687e3393",
            "patch": "@@ -9,7 +9,7 @@\n import ts from 'typescript';\n import type {TsickleHost} from 'tsickle';\n import yargs from 'yargs';\n-import {Diagnostics, exitCodeFromResult, filterErrorsAndWarnings, formatDiagnostics, ParsedConfiguration, performCompilation, readConfiguration} from './perform_compile';\n+import {Diagnostics, exitCodeFromResult, formatDiagnostics, ParsedConfiguration, performCompilation, readConfiguration} from './perform_compile';\n import {createPerformWatchHost, performWatchCompilation} from './perform_watch';\n import * as api from './transformers/api';\n import {GENERATED_FILES} from './transformers/util';\n@@ -55,11 +55,17 @@ export function main(\n export function mainDiagnosticsForTest(\n     args: string[], config?: NgcParsedConfiguration,\n     programReuse?: {program: api.Program|undefined}, modifiedResourceFiles?: Set<string>|null,\n-    tsickle?: TsickleModule): ReadonlyArray<ts.Diagnostic|api.Diagnostic> {\n-  let {project, rootNames, options, errors: configErrors, watch, emitFlags} =\n+    tsickle?: TsickleModule): {\n+  exitCode: number,\n+  diagnostics: ReadonlyArray<ts.Diagnostic|api.Diagnostic>,\n+} {\n+  let {rootNames, options, errors: configErrors, emitFlags} =\n       config || readNgcCommandLineAndConfiguration(args);\n   if (configErrors.length) {\n-    return configErrors;\n+    return {\n+      exitCode: exitCodeFromResult(configErrors),\n+      diagnostics: configErrors,\n+    };\n   }\n \n   let oldProgram: api.Program|undefined;\n@@ -80,7 +86,10 @@ export function mainDiagnosticsForTest(\n     programReuse.program = program;\n   }\n \n-  return compileDiags;\n+  return {\n+    exitCode: exitCodeFromResult(compileDiags),\n+    diagnostics: compileDiags,\n+  };\n }\n \n function createEmitCallback(\n@@ -216,7 +225,8 @@ function getFormatDiagnosticsHost(options?: api.CompilerOptions): ts.FormatDiagn\n function reportErrorsAndExit(\n     allDiagnostics: Diagnostics, options?: api.CompilerOptions,\n     consoleError: (s: string) => void = console.error): number {\n-  const errorsAndWarnings = filterErrorsAndWarnings(allDiagnostics);\n+  const errorsAndWarnings =\n+      allDiagnostics.filter(d => d.category !== ts.DiagnosticCategory.Message);\n   printDiagnostics(errorsAndWarnings, options, consoleError);\n   return exitCodeFromResult(allDiagnostics);\n }"
        },
        {
            "sha": "831c8b7ae8f70fe2cfaa7a07a25d754db848c9f9",
            "filename": "packages/compiler-cli/src/perform_compile.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/b2b597279eb611936315068aab9769fa687e3393/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "raw_url": "https://github.com/angular/angular/raw/b2b597279eb611936315068aab9769fa687e3393/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts?ref=b2b597279eb611936315068aab9769fa687e3393",
            "patch": "@@ -19,10 +19,6 @@ import {createMessageDiagnostic} from './transformers/util';\n \n export type Diagnostics = ReadonlyArray<ts.Diagnostic|api.Diagnostic>;\n \n-export function filterErrorsAndWarnings(diagnostics: Diagnostics): Diagnostics {\n-  return diagnostics.filter(d => d.category !== ts.DiagnosticCategory.Message);\n-}\n-\n const defaultFormatHost: ts.FormatDiagnosticsHost = {\n   getCurrentDirectory: () => ts.sys.getCurrentDirectory(),\n   getCanonicalFileName: fileName => fileName,\n@@ -274,7 +270,8 @@ export interface PerformCompilationResult {\n }\n \n export function exitCodeFromResult(diags: Diagnostics|undefined): number {\n-  if (!diags || filterErrorsAndWarnings(diags).length === 0) {\n+  if (!diags) return 0;\n+  if (diags.every((diag) => diag.category !== ts.DiagnosticCategory.Error)) {\n     // If we have a result and didn't get any errors, we succeeded.\n     return 0;\n   }"
        },
        {
            "sha": "c7fbbcf0961ecb51bda80fc156e9b3d27dc604c9",
            "filename": "packages/compiler-cli/test/ngtsc/env.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/b2b597279eb611936315068aab9769fa687e3393/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/b2b597279eb611936315068aab9769fa687e3393/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts?ref=b2b597279eb611936315068aab9769fa687e3393",
            "patch": "@@ -231,7 +231,7 @@ export class NgtscTestEnvironment {\n   /**\n    * Run the compiler to completion, and return any `ts.Diagnostic` errors that may have occurred.\n    */\n-  driveDiagnostics(): ReadonlyArray<ts.Diagnostic> {\n+  driveDiagnostics(expectedExitCode?: number): ReadonlyArray<ts.Diagnostic> {\n     // ngtsc only produces ts.Diagnostic messages.\n     let reuseProgram: {program: Program|undefined}|undefined = undefined;\n     if (this.multiCompileHostExt !== null) {\n@@ -240,16 +240,21 @@ export class NgtscTestEnvironment {\n       };\n     }\n \n-    const diags = mainDiagnosticsForTest(\n+    const {exitCode, diagnostics} = mainDiagnosticsForTest(\n         this.commandLineArgs, undefined, reuseProgram, this.changedResources, tsickle);\n-\n+    if (expectedExitCode !== undefined) {\n+      expect(exitCode)\n+          .withContext(`Expected program to exit with code ${\n+              expectedExitCode}, but it actually exited with code ${exitCode}.`)\n+          .toBe(expectedExitCode);\n+    }\n \n     if (this.multiCompileHostExt !== null) {\n       this.oldProgram = reuseProgram!.program!;\n     }\n \n     // In ngtsc, only `ts.Diagnostic`s are produced.\n-    return diags as ReadonlyArray<ts.Diagnostic>;\n+    return diagnostics as ReadonlyArray<ts.Diagnostic>;\n   }\n \n   async driveDiagnosticsAsync(): Promise<ReadonlyArray<ts.Diagnostic>> {"
        },
        {
            "sha": "08f4a0f53bb833777826f236dfb913135072dde0",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 4,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/b2b597279eb611936315068aab9769fa687e3393/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b2b597279eb611936315068aab9769fa687e3393/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=b2b597279eb611936315068aab9769fa687e3393",
            "patch": "@@ -7569,6 +7569,30 @@ export const Foo = Foo__PRE_R3__;\n          expect(diags[0].messageText)\n              .toEqual(`Could not find stylesheet file './non-existent-file.css'.`);\n        });\n+\n+    it('passes the build when only warnings are emitted', () => {\n+      env.tsconfig({\n+        strictTemplates: true,\n+        _extendedTemplateDiagnostics: true,\n+      });\n+\n+      env.write('test.ts', `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          selector: 'test-component',\n+          // Invalid banana in box (should be \\`[(foo)]=\"bar\"\\`).\n+          template: '<div ([foo])=\"bar\"></div>',\n+        })\n+        class TestComponent {\n+          bar = 'test';\n+        }\n+      `);\n+\n+      const diagnostics = env.driveDiagnostics(0 /* expectedExitCode */);\n+      const codes = diagnostics.map((diag) => diag.code);\n+      expect(codes).toEqual([ngErrorCode(ErrorCode.INVALID_BANANA_IN_BOX)]);\n+    });\n   });\n \n   function expectTokenAtPosition<T extends ts.Node>(\n@@ -7578,8 +7602,4 @@ export const Foo = Foo__PRE_R3__;\n     expect(guard(node)).toBe(true);\n     return node as T;\n   }\n-\n-  function normalize(input: string): string {\n-    return input.replace(/\\s+/g, ' ').trim();\n-  }\n }"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 51,
        "deletions": 19
    }
}