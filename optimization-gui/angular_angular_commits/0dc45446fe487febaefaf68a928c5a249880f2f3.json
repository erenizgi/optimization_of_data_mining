{
    "author": "spike-rabbit",
    "message": "feat(service-worker): expose more version update events (#43668)\n\nThis commit introduces a new `SwUpdate#versionUpdates` observalbe, which provides more granular\ninformation about Service Worker version updates than the already existing `SwUpdate#available`\nobservable.\n\nThe new events emitted by `SwUpdate#versionUpdates` basically add the possibility for application to\nget notified if a new version is available on the server (not yet downloaded) and if an installation\nof a new version failed.\n\nCloses #39840\n\nDEPRECATED: The `SwUpdate#availalbe` observable is deprecated.\n\nThe new `SwUpdate#versionUpdates` observable provides the same information and more. Therefore, it\nis possible to rebuild the same behavior as `SwUpdate#availalbe` using the events emitted by\n`SwUpdate#versionUpdates` and filtering for `VersionReadyEvent` events.\nAs a result, the `SwUpdate#availalbe` observable is now redundant.\n\nPR Close #43668",
    "sha": "0dc45446fe487febaefaf68a928c5a249880f2f3",
    "files": [
        {
            "sha": "3c58fc0daa919ac555f4c9d075ed7af3e99abaf9",
            "filename": "aio/content/guide/deprecations.md",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/0dc45446fe487febaefaf68a928c5a249880f2f3/aio%2Fcontent%2Fguide%2Fdeprecations.md",
            "raw_url": "https://github.com/angular/angular/raw/0dc45446fe487febaefaf68a928c5a249880f2f3/aio%2Fcontent%2Fguide%2Fdeprecations.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fdeprecations.md?ref=0dc45446fe487febaefaf68a928c5a249880f2f3",
            "patch": "@@ -64,6 +64,7 @@ v13 -> v16\n | `@angular/forms`          | [`FormBuilder.group` legacy options parameter](api/forms/FormBuilder#group)                   | <!--v11--> v14        |\n | `@angular/router`         | [`ActivatedRoute` params and `queryParams` properties](#activatedroute-props)                 | unspecified           |\n | `@angular/service-worker` | [`SwUpdate#activated`](api/service-worker/SwUpdate#activated)                                 | <!--v13--> v16        |\n+| `@angular/service-worker` | [`SwUpdate#available`](api/service-worker/SwUpdate#available)                                 | <!--v13--> v16        |\n | template syntax           | [`/deep/`, `>>>`, and `::ng-deep`](#deep-component-style-selector)                            | <!--v7--> unspecified |\n | template syntax         | [`bind-`, `on-`, `bindon-`, and `ref-`](#bind-syntax)                            | <!--v13--> v15 |\n \n@@ -141,6 +142,7 @@ This section contains a complete list all of the currently-deprecated APIs, with\n | API                                                           | Replacement                                                                            | Deprecation announced    | Notes\n |:---                                                           |:---                                                                                    |:---                      |:---\n | [`SwUpdate#activated`](api/service-worker/SwUpdate#activated) | [`SwUpdate#activateUpdate()` return value](api/service-worker/SwUpdate#activateUpdate) | v13                      | The return value of `SwUpdate#activateUpdate()` indicates whether an update was successfully activated. |\n+| [`SwUpdate#available`](api/service-worker/SwUpdate#available) | [`SwUpdate#versionUpdates`](api/service-worker/SwUpdate#versionUpdates)                | v13                      | The behavior of `SwUpdate#available` can be rebuilt by filtering for `VersionReadyEvent` events on [`SwUpdate#versionUpdates`](api/service-worker/SwUpdate#versionUpdates) |\n \n {@a upgrade}\n "
        },
        {
            "sha": "466d617ea192bfdcb9a043a401d1191abeec8445",
            "filename": "goldens/public-api/service-worker/service-worker.md",
            "status": "modified",
            "additions": 46,
            "deletions": 1,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/0dc45446fe487febaefaf68a928c5a249880f2f3/goldens%2Fpublic-api%2Fservice-worker%2Fservice-worker.md",
            "raw_url": "https://github.com/angular/angular/raw/0dc45446fe487febaefaf68a928c5a249880f2f3/goldens%2Fpublic-api%2Fservice-worker%2Fservice-worker.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fservice-worker%2Fservice-worker.md?ref=0dc45446fe487febaefaf68a928c5a249880f2f3",
            "patch": "@@ -54,10 +54,12 @@ export class SwUpdate {\n     // @deprecated\n     readonly activated: Observable<UpdateActivatedEvent>;\n     activateUpdate(): Promise<boolean>;\n+    // @deprecated\n     readonly available: Observable<UpdateAvailableEvent>;\n     checkForUpdate(): Promise<boolean>;\n     get isEnabled(): boolean;\n     readonly unrecoverable: Observable<UnrecoverableStateEvent>;\n+    readonly versionUpdates: Observable<VersionEvent>;\n     // (undocumented)\n     static ɵfac: i0.ɵɵFactoryDeclaration<SwUpdate, never>;\n     // (undocumented)\n@@ -88,7 +90,7 @@ export interface UpdateActivatedEvent {\n     type: 'UPDATE_ACTIVATED';\n }\n \n-// @public\n+// @public @deprecated\n export interface UpdateAvailableEvent {\n     // (undocumented)\n     available: {\n@@ -104,6 +106,49 @@ export interface UpdateAvailableEvent {\n     type: 'UPDATE_AVAILABLE';\n }\n \n+// @public\n+export interface VersionDetectedEvent {\n+    // (undocumented)\n+    type: 'VERSION_DETECTED';\n+    // (undocumented)\n+    version: {\n+        hash: string;\n+        appData?: object;\n+    };\n+}\n+\n+// @public\n+export type VersionEvent = VersionDetectedEvent | VersionInstallationFailedEvent | VersionReadyEvent;\n+\n+// @public\n+export interface VersionInstallationFailedEvent {\n+    // (undocumented)\n+    error: string;\n+    // (undocumented)\n+    type: 'VERSION_INSTALLATION_FAILED';\n+    // (undocumented)\n+    version: {\n+        hash: string;\n+        appData?: object;\n+    };\n+}\n+\n+// @public\n+export interface VersionReadyEvent {\n+    // (undocumented)\n+    currentVersion: {\n+        hash: string;\n+        appData?: object;\n+    };\n+    // (undocumented)\n+    latestVersion: {\n+        hash: string;\n+        appData?: object;\n+    };\n+    // (undocumented)\n+    type: 'VERSION_READY';\n+}\n+\n // (No @packageDocumentation comment for this package)\n \n ```"
        },
        {
            "sha": "345cdfb8245a47d018fdc202ff3a48148c2595c5",
            "filename": "packages/service-worker/src/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Fsrc%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Fsrc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fsrc%2Findex.ts?ref=0dc45446fe487febaefaf68a928c5a249880f2f3",
            "patch": "@@ -14,7 +14,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-export {UnrecoverableStateEvent, UpdateActivatedEvent, UpdateAvailableEvent} from './low_level';\n+export {UnrecoverableStateEvent, UpdateActivatedEvent, UpdateAvailableEvent, VersionDetectedEvent, VersionEvent, VersionInstallationFailedEvent, VersionReadyEvent,} from './low_level';\n export {ServiceWorkerModule, SwRegistrationOptions} from './module';\n export {SwPush} from './push';\n export {SwUpdate} from './update';"
        },
        {
            "sha": "aea4e763422e3d6ec989cfaed3ea192b07c293c2",
            "filename": "packages/service-worker/src/low_level.ts",
            "status": "modified",
            "additions": 66,
            "deletions": 3,
            "changes": 69,
            "blob_url": "https://github.com/angular/angular/blob/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Fsrc%2Flow_level.ts",
            "raw_url": "https://github.com/angular/angular/raw/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Fsrc%2Flow_level.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fsrc%2Flow_level.ts?ref=0dc45446fe487febaefaf68a928c5a249880f2f3",
            "patch": "@@ -16,6 +16,11 @@ export const ERR_SW_NOT_SUPPORTED = 'Service workers are disabled or not support\n  *\n  * @see {@link guide/service-worker-communications Service worker communication guide}\n  *\n+ * @deprecated\n+ * This event is only emitted by the deprecated {@link SwUpdate#available}.\n+ * Use the {@link VersionReadyEvent} instead, which is emitted by {@link SwUpdate#versionUpdates}.\n+ * See {@link SwUpdate#available} docs for an example.\n+ *\n  * @publicApi\n  */\n export interface UpdateAvailableEvent {\n@@ -29,6 +34,10 @@ export interface UpdateAvailableEvent {\n  *\n  * @see {@link guide/service-worker-communications Service worker communication guide}\n  *\n+ * @deprecated\n+ * This event is only emitted by the deprecated {@link SwUpdate#activated}.\n+ * Use the return value of {@link SwUpdate#activateUpdate} instead.\n+ *\n  * @publicApi\n  */\n export interface UpdateActivatedEvent {\n@@ -37,6 +46,55 @@ export interface UpdateActivatedEvent {\n   current: {hash: string, appData?: Object};\n }\n \n+/**\n+ * An event emitted when the service worker has detected a new version of the app on the server and\n+ * is about to start downloading it.\n+ *\n+ * @see {@link guide/service-worker-communications Service worker communication guide}\n+ *\n+ * @publicApi\n+ */\n+export interface VersionDetectedEvent {\n+  type: 'VERSION_DETECTED';\n+  version: {hash: string; appData?: object;};\n+}\n+\n+/**\n+ * An event emitted when the installation of a new version failed.\n+ * It may be used for logging/monitoring purposes.\n+ *\n+ * @see {@link guide/service-worker-communications Service worker communication guide}\n+ *\n+ * @publicApi\n+ */\n+export interface VersionInstallationFailedEvent {\n+  type: 'VERSION_INSTALLATION_FAILED';\n+  version: {hash: string; appData?: object;};\n+  error: string;\n+}\n+\n+/**\n+ * An event emitted when a new version of the app is available.\n+ *\n+ * @see {@link guide/service-worker-communications Service worker communication guide}\n+ *\n+ * @publicApi\n+ */\n+export interface VersionReadyEvent {\n+  type: 'VERSION_READY';\n+  currentVersion: {hash: string; appData?: object;};\n+  latestVersion: {hash: string; appData?: object;};\n+}\n+\n+\n+/**\n+ * A union of all event types that can be emitted by\n+ * {@link api/service-worker/SwUpdate#versionUpdates SwUpdate#versionUpdates}.\n+ *\n+ * @publicApi\n+ */\n+export type VersionEvent = VersionDetectedEvent|VersionInstallationFailedEvent|VersionReadyEvent;\n+\n /**\n  * An event emitted when the version of the app used by the service worker to serve this client is\n  * in a broken state that cannot be recovered from and a full page reload is required.\n@@ -63,7 +121,7 @@ export interface PushEvent {\n   data: any;\n }\n \n-export type IncomingEvent = UpdateAvailableEvent|UpdateActivatedEvent|UnrecoverableStateEvent;\n+export type IncomingEvent = UpdateActivatedEvent|UnrecoverableStateEvent|VersionEvent;\n \n export interface TypedEvent {\n   type: string;\n@@ -140,8 +198,13 @@ export class NgswCommChannel {\n     return Math.round(Math.random() * 10000000);\n   }\n \n-  eventsOfType<T extends TypedEvent>(type: T['type']): Observable<T> {\n-    const filterFn = (event: TypedEvent): event is T => event.type === type;\n+  eventsOfType<T extends TypedEvent>(type: T['type']|T['type'][]): Observable<T> {\n+    let filterFn: (event: TypedEvent) => event is T;\n+    if (typeof type === 'string') {\n+      filterFn = (event: TypedEvent): event is T => event.type === type;\n+    } else {\n+      filterFn = (event: TypedEvent): event is T => type.includes(event.type);\n+    }\n     return this.events.pipe(filter(filterFn));\n   }\n "
        },
        {
            "sha": "503cac8c8e116d8fb4a2878dc5ac5e931a456f51",
            "filename": "packages/service-worker/src/update.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 2,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Fsrc%2Fupdate.ts",
            "raw_url": "https://github.com/angular/angular/raw/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Fsrc%2Fupdate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fsrc%2Fupdate.ts?ref=0dc45446fe487febaefaf68a928c5a249880f2f3",
            "patch": "@@ -8,8 +8,9 @@\n \n import {Injectable} from '@angular/core';\n import {NEVER, Observable} from 'rxjs';\n+import {filter, map} from 'rxjs/operators';\n \n-import {ERR_SW_NOT_SUPPORTED, NgswCommChannel, UnrecoverableStateEvent, UpdateActivatedEvent, UpdateAvailableEvent} from './low_level';\n+import {ERR_SW_NOT_SUPPORTED, NgswCommChannel, UnrecoverableStateEvent, UpdateActivatedEvent, UpdateAvailableEvent, VersionEvent, VersionReadyEvent} from './low_level';\n \n \n \n@@ -23,8 +24,34 @@ import {ERR_SW_NOT_SUPPORTED, NgswCommChannel, UnrecoverableStateEvent, UpdateAc\n  */\n @Injectable()\n export class SwUpdate {\n+  /**\n+   * Emits a `VersionDetectedEvent` event whenever a new version is detected on the server.\n+   *\n+   * Emits a `VersionInstallationFailedEvent` event whenever checking for or downloading a new\n+   * version fails.\n+   *\n+   * Emits a `VersionReadyEvent` event whenever a new version has been downloaded and is ready for\n+   * activation.\n+   */\n+  readonly versionUpdates: Observable<VersionEvent>;\n+\n   /**\n    * Emits an `UpdateAvailableEvent` event whenever a new app version is available.\n+   *\n+   * @deprecated Use {@link versionUpdates} instead.\n+   *\n+   * The of behavior `available` can be rebuild by filtering for the `VersionReadyEvent`:\n+   * ```\n+   * import {filter, map} from 'rxjs/operators';\n+   * // ...\n+   * const updatesAvailable = swUpdate.versionUpdates.pipe(\n+   *   filter((evt): evt is VersionReadyEvent => evt.type === 'VERSION_READY'),\n+   *   map(evt => ({\n+   *     type: 'UPDATE_AVAILABLE',\n+   *     current: evt.currentVersion,\n+   *     available: evt.latestVersion,\n+   *   })));\n+   * ```\n    */\n   readonly available: Observable<UpdateAvailableEvent>;\n \n@@ -53,12 +80,21 @@ export class SwUpdate {\n \n   constructor(private sw: NgswCommChannel) {\n     if (!sw.isEnabled) {\n+      this.versionUpdates = NEVER;\n       this.available = NEVER;\n       this.activated = NEVER;\n       this.unrecoverable = NEVER;\n       return;\n     }\n-    this.available = this.sw.eventsOfType<UpdateAvailableEvent>('UPDATE_AVAILABLE');\n+    this.versionUpdates = this.sw.eventsOfType<VersionEvent>(\n+        ['VERSION_DETECTED', 'VERSION_INSTALLATION_FAILED', 'VERSION_READY']);\n+    this.available = this.versionUpdates.pipe(\n+        filter((evt: VersionEvent): evt is VersionReadyEvent => evt.type === 'VERSION_READY'),\n+        map(evt => ({\n+              type: 'UPDATE_AVAILABLE',\n+              current: evt.currentVersion,\n+              available: evt.latestVersion,\n+            })));\n     this.activated = this.sw.eventsOfType<UpdateActivatedEvent>('UPDATE_ACTIVATED');\n     this.unrecoverable = this.sw.eventsOfType<UnrecoverableStateEvent>('UNRECOVERABLE_STATE');\n   }"
        },
        {
            "sha": "e76914957d81dffb5d23495859ec113f3ca9f67c",
            "filename": "packages/service-worker/test/comm_spec.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Ftest%2Fcomm_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Ftest%2Fcomm_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Ftest%2Fcomm_spec.ts?ref=0dc45446fe487febaefaf68a928c5a249880f2f3",
            "patch": "@@ -8,7 +8,7 @@\n \n import {PLATFORM_ID} from '@angular/core';\n import {TestBed} from '@angular/core/testing';\n-import {NgswCommChannel} from '@angular/service-worker/src/low_level';\n+import {NgswCommChannel, VersionDetectedEvent} from '@angular/service-worker/src/low_level';\n import {ngswCommChannelFactory, SwRegistrationOptions} from '@angular/service-worker/src/module';\n import {SwPush} from '@angular/service-worker/src/push';\n import {SwUpdate} from '@angular/service-worker/src/update';\n@@ -426,11 +426,11 @@ import {MockPushManager, MockPushSubscription, MockServiceWorkerContainer, MockS\n           done();\n         });\n         mock.sendMessage({\n-          type: 'UPDATE_AVAILABLE',\n-          current: {\n+          type: 'VERSION_READY',\n+          currentVersion: {\n             hash: 'A',\n           },\n-          available: {\n+          latestVersion: {\n             hash: 'B',\n           },\n         });\n@@ -460,6 +460,19 @@ import {MockPushManager, MockPushSubscription, MockServiceWorkerContainer, MockS\n           },\n         });\n       });\n+      it('process any version update event when sent', done => {\n+        update.versionUpdates.subscribe(event => {\n+          expect(event.type).toEqual('VERSION_DETECTED');\n+          expect((event as VersionDetectedEvent).version).toEqual({hash: 'A'});\n+          done();\n+        });\n+        mock.sendMessage({\n+          type: 'VERSION_DETECTED',\n+          version: {\n+            hash: 'A',\n+          },\n+        });\n+      });\n       it('activates updates when requested', async () => {\n         mock.messages.subscribe((msg: {action: string, nonce: number}) => {\n           expect(msg.action).toEqual('ACTIVATE_UPDATE');\n@@ -503,6 +516,7 @@ import {MockPushManager, MockPushSubscription, MockServiceWorkerContainer, MockS\n           update.available.toPromise().catch(err => fail(err));\n           update.activated.toPromise().catch(err => fail(err));\n           update.unrecoverable.toPromise().catch(err => fail(err));\n+          update.versionUpdates.toPromise().catch(err => fail(err));\n         });\n         it('gives an error when checking for updates', done => {\n           update = new SwUpdate(comm);"
        },
        {
            "sha": "f126e3399d4184e29e9e4e437dd305ca08cd700a",
            "filename": "packages/service-worker/worker/src/driver.ts",
            "status": "modified",
            "additions": 71,
            "deletions": 29,
            "changes": 100,
            "blob_url": "https://github.com/angular/angular/blob/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "raw_url": "https://github.com/angular/angular/raw/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts?ref=0dc45446fe487febaefaf68a928c5a249880f2f3",
            "patch": "@@ -834,35 +834,40 @@ export class Driver implements Debuggable, UpdateSource {\n   }\n \n   private async setupUpdate(manifest: Manifest, hash: string): Promise<void> {\n-    const newVersion =\n-        new AppVersion(this.scope, this.adapter, this.db, this.idle, this.debugger, manifest, hash);\n-\n-    // Firstly, check if the manifest version is correct.\n-    if (manifest.configVersion !== SUPPORTED_CONFIG_VERSION) {\n-      await this.deleteAllCaches();\n-      await this.scope.registration.unregister();\n-      throw new Error(`Invalid config version: expected ${SUPPORTED_CONFIG_VERSION}, got ${\n-          manifest.configVersion}.`);\n-    }\n+    try {\n+      const newVersion = new AppVersion(\n+          this.scope, this.adapter, this.db, this.idle, this.debugger, manifest, hash);\n \n-    // Cause the new version to become fully initialized. If this fails, then the\n-    // version will not be available for use.\n-    await newVersion.initializeFully(this);\n+      // Firstly, check if the manifest version is correct.\n+      if (manifest.configVersion !== SUPPORTED_CONFIG_VERSION) {\n+        await this.deleteAllCaches();\n+        await this.scope.registration.unregister();\n+        throw new Error(`Invalid config version: expected ${SUPPORTED_CONFIG_VERSION}, got ${\n+            manifest.configVersion}.`);\n+      }\n \n-    // Install this as an active version of the app.\n-    this.versions.set(hash, newVersion);\n-    // Future new clients will use this hash as the latest version.\n-    this.latestHash = hash;\n+      // Cause the new version to become fully initialized. If this fails, then the\n+      // version will not be available for use.\n+      await newVersion.initializeFully(this);\n \n-    // If we are in `EXISTING_CLIENTS_ONLY` mode (meaning we didn't have a clean copy of the last\n-    // latest version), we can now recover to `NORMAL` mode and start accepting new clients.\n-    if (this.state === DriverReadyState.EXISTING_CLIENTS_ONLY) {\n-      this.state = DriverReadyState.NORMAL;\n-      this.stateMessage = '(nominal)';\n-    }\n+      // Install this as an active version of the app.\n+      this.versions.set(hash, newVersion);\n+      // Future new clients will use this hash as the latest version.\n+      this.latestHash = hash;\n \n-    await this.sync();\n-    await this.notifyClientsAboutUpdate(newVersion);\n+      // If we are in `EXISTING_CLIENTS_ONLY` mode (meaning we didn't have a clean copy of the last\n+      // latest version), we can now recover to `NORMAL` mode and start accepting new clients.\n+      if (this.state === DriverReadyState.EXISTING_CLIENTS_ONLY) {\n+        this.state = DriverReadyState.NORMAL;\n+        this.stateMessage = '(nominal)';\n+      }\n+\n+      await this.sync();\n+      await this.notifyClientsAboutVersionReady(manifest, hash);\n+    } catch (e) {\n+      await this.notifyClientsAboutVersionInstallationFailed(manifest, hash, e);\n+      throw e;\n+    }\n   }\n \n   async checkForUpdate(): Promise<boolean> {\n@@ -884,6 +889,8 @@ export class Driver implements Debuggable, UpdateSource {\n         return false;\n       }\n \n+      await this.notifyClientsAboutVersionDetected(manifest, hash);\n+\n       await this.setupUpdate(manifest, hash);\n \n       return true;\n@@ -1058,7 +1065,42 @@ export class Driver implements Debuggable, UpdateSource {\n     }));\n   }\n \n-  async notifyClientsAboutUpdate(next: AppVersion): Promise<void> {\n+  async notifyClientsAboutVersionInstallationFailed(manifest: Manifest, hash: string, error: any):\n+      Promise<void> {\n+    await this.initialized;\n+\n+    const clients = await this.scope.clients.matchAll();\n+\n+    await Promise.all(clients.map(async client => {\n+      // Send a notice.\n+      client.postMessage({\n+        type: 'VERSION_INSTALLATION_FAILED',\n+        version: this.mergeHashWithAppData(manifest, hash),\n+        error: errorToString(error),\n+      });\n+    }));\n+  }\n+\n+  async notifyClientsAboutVersionDetected(manifest: Manifest, hash: string): Promise<void> {\n+    await this.initialized;\n+\n+    const clients = await this.scope.clients.matchAll();\n+\n+    await Promise.all(clients.map(async client => {\n+      // Firstly, determine which version this client is on.\n+      const version = this.clientVersionMap.get(client.id);\n+      if (version === undefined) {\n+        // Unmapped client - assume it's the latest.\n+        return;\n+      }\n+\n+      // Send a notice.\n+      client.postMessage(\n+          {type: 'VERSION_DETECTED', version: this.mergeHashWithAppData(manifest, hash)});\n+    }));\n+  }\n+\n+  async notifyClientsAboutVersionReady(manifest: Manifest, hash: string): Promise<void> {\n     await this.initialized;\n \n     const clients = await this.scope.clients.matchAll();\n@@ -1080,9 +1122,9 @@ export class Driver implements Debuggable, UpdateSource {\n \n       // Send a notice.\n       const notice = {\n-        type: 'UPDATE_AVAILABLE',\n-        current: this.mergeHashWithAppData(current.manifest, version),\n-        available: this.mergeHashWithAppData(next.manifest, this.latestHash!),\n+        type: 'VERSION_READY',\n+        currentVersion: this.mergeHashWithAppData(current.manifest, version),\n+        latestVersion: this.mergeHashWithAppData(manifest, hash),\n       };\n \n       client.postMessage(notice);"
        },
        {
            "sha": "9b4fb1be301c7e33948abe5f0999a75a3f3a2f90",
            "filename": "packages/service-worker/worker/test/happy_spec.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 11,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0dc45446fe487febaefaf68a928c5a249880f2f3/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts?ref=0dc45446fe487febaefaf68a928c5a249880f2f3",
            "patch": "@@ -478,11 +478,17 @@ describe('Driver', () => {\n     serverUpdate.assertSawRequestFor('/redirected.txt');\n     serverUpdate.assertNoOtherRequests();\n \n-    expect(client.messages).toEqual([{\n-      type: 'UPDATE_AVAILABLE',\n-      current: {hash: manifestHash, appData: {version: 'original'}},\n-      available: {hash: manifestUpdateHash, appData: {version: 'update'}},\n-    }]);\n+    expect(client.messages).toEqual([\n+      {\n+        type: 'VERSION_DETECTED',\n+        version: {hash: manifestUpdateHash, appData: {version: 'update'}},\n+      },\n+      {\n+        type: 'VERSION_READY',\n+        currentVersion: {hash: manifestHash, appData: {version: 'original'}},\n+        latestVersion: {hash: manifestUpdateHash, appData: {version: 'update'}},\n+      },\n+    ]);\n \n     // Default client is still on the old version of the app.\n     expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n@@ -523,10 +529,11 @@ describe('Driver', () => {\n     await driver.updateClient(client as any as Client);\n \n     expect(client.messages).toEqual([\n+      {type: 'VERSION_DETECTED', version: {hash: manifestUpdateHash, appData: {version: 'update'}}},\n       {\n-        type: 'UPDATE_AVAILABLE',\n-        current: {hash: manifestHash, appData: {version: 'original'}},\n-        available: {hash: manifestUpdateHash, appData: {version: 'update'}},\n+        type: 'VERSION_READY',\n+        currentVersion: {hash: manifestHash, appData: {version: 'original'}},\n+        latestVersion: {hash: manifestUpdateHash, appData: {version: 'update'}},\n       },\n       {\n         type: 'UPDATE_ACTIVATED',\n@@ -636,9 +643,13 @@ describe('Driver', () => {\n \n     expect(client.messages).toEqual([\n       {\n-        type: 'UPDATE_AVAILABLE',\n-        current: {hash: manifestHash, appData: {version: 'original'}},\n-        available: {hash: manifestUpdateHash, appData: {version: 'update'}},\n+        type: 'VERSION_DETECTED',\n+        version: {hash: manifestUpdateHash, appData: {version: 'update'}},\n+      },\n+      {\n+        type: 'VERSION_READY',\n+        currentVersion: {hash: manifestHash, appData: {version: 'original'}},\n+        latestVersion: {hash: manifestUpdateHash, appData: {version: 'update'}},\n       },\n       {\n         type: 'UPDATE_ACTIVATED',"
        }
    ],
    "stats": {
        "total": 315,
        "additions": 264,
        "deletions": 51
    }
}