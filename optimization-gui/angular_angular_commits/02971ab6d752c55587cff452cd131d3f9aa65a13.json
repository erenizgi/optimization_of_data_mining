{
    "author": "gkalpak",
    "message": "refactor(docs-infra): make it easier to configure Firebase redirects at deployment (#43963)\n\nRefactor the `deploy-to-firebase` post-deploy actions by extracting\nlogic to separate helper functions. This makes it easier to create more\nfunctions for testing various redirect configs (in a future commit).\n\nPR Close #43963",
    "sha": "02971ab6d752c55587cff452cd131d3f9aa65a13",
    "files": [
        {
            "sha": "b71aa11c7960a65ce80c9f74bbf0c9733354da6f",
            "filename": "aio/scripts/deploy-to-firebase/post-deploy-actions.mjs",
            "status": "modified",
            "additions": 51,
            "deletions": 32,
            "changes": 83,
            "blob_url": "https://github.com/angular/angular/blob/02971ab6d752c55587cff452cd131d3f9aa65a13/aio%2Fscripts%2Fdeploy-to-firebase%2Fpost-deploy-actions.mjs",
            "raw_url": "https://github.com/angular/angular/raw/02971ab6d752c55587cff452cd131d3f9aa65a13/aio%2Fscripts%2Fdeploy-to-firebase%2Fpost-deploy-actions.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Fpost-deploy-actions.mjs?ref=02971ab6d752c55587cff452cd131d3f9aa65a13",
            "patch": "@@ -11,47 +11,66 @@ export default exp;\n \n // Helpers\n function testNoActiveRcDeployment({deployedUrl}) {\n-  u.logSectionHeader(\n-      'Verify deployed RC version redirects to stable (and disables old ServiceWorker).');\n+  const destinationOrigin = u.ORIGINS.Stable;\n \n-  const deployedOrigin = deployedUrl.replace(/\\/$/, '');\n+  u.logSectionHeader(\n+      `Verify deployed RC version redirects to '${destinationOrigin}' (and disables old ` +\n+      'ServiceWorker).');\n \n   // Ensure a request for `ngsw.json` returns 404.\n-  const ngswJsonUrl = `${deployedOrigin}/ngsw.json`;\n-  const ngswJsonScript = `https.get('${ngswJsonUrl}', res => console.log(res.statusCode))`;\n-  const ngswJsonActualStatusCode =\n-      sh.exec(`node --eval \"${ngswJsonScript}\"`, {silent: true}).trim();\n-  const ngswJsonExpectedStatusCode = '404';\n+  testUrlNotFound('ngsw.json', deployedUrl);\n+\n+  // Ensure a request for `foo/bar` is redirected to `https://angular.io/foo/bar`.\n+  testUrlRedirect('foo/bar?baz=qux', deployedUrl, destinationOrigin);\n+}\n+\n+function testPwaScore({deployedUrl, minPwaScore}) {\n+  u.logSectionHeader('Run PWA-score tests.');\n+  u.yarn(`test-pwa-score \"${deployedUrl}\" \"${minPwaScore}\"`);\n+}\n+\n+function testUrlNotFound(relativeUrl, sourceOrigin) {\n+  // Strip leading/trailing slashes.\n+  relativeUrl = relativeUrl.replace(/^\\//, '');\n+  sourceOrigin = sourceOrigin.replace(/\\/$/, '');\n+\n+  const sourceUrl = `${sourceOrigin}/${relativeUrl}`;\n+  const expectedStatusCode = '404';\n \n-  if (ngswJsonActualStatusCode !== ngswJsonExpectedStatusCode) {\n+  const testScript = `https.get('${sourceUrl}', res => console.log(res.statusCode))`;\n+  const actualStatusCode = sh.exec(`node --eval \"${testScript}\"`, {silent: true}).trim();\n+\n+  if (actualStatusCode !== expectedStatusCode) {\n     throw new Error(\n-        `Expected '${ngswJsonUrl}' to return a status code of '${ngswJsonExpectedStatusCode}', ` +\n-        `but it returned '${ngswJsonActualStatusCode}'.`);\n+        `Expected '${sourceUrl}' to return a status code of '${expectedStatusCode}', but it ` +\n+        `returned '${actualStatusCode}'.`);\n   }\n+}\n \n-  // Ensure a request for `foo/bar` is redirected to `https://angular.io/foo/bar`.\n-  const fooBarUrl = `${deployedOrigin}/foo/bar?baz=qux`;\n-  const fooBarScript =\n-      `https.get('${fooBarUrl}', res => console.log(res.statusCode, res.headers.location))`;\n-  const [fooBarActualStatusCode, fooBarActualRedirectUrl] =\n-      sh.exec(`node --eval \"${fooBarScript}\"`, {silent: true}).trim().split(' ');\n-  const fooBarExpectedStatusCode = '302';\n-  const fooBarExpectedRedirectUrl = 'https://angular.io/foo/bar?baz=qux';\n-\n-  if (fooBarActualStatusCode !== fooBarExpectedStatusCode) {\n+function testUrlRedirect(relativeUrl, sourceOrigin, destinationOrigin) {\n+  // Strip leading/trailing slashes.\n+  relativeUrl = relativeUrl.replace(/^\\//, '');\n+  sourceOrigin = sourceOrigin.replace(/\\/$/, '');\n+  destinationOrigin = destinationOrigin.replace(/\\/$/, '');\n+\n+  const sourceUrl = `${sourceOrigin}/${relativeUrl}`;\n+  const expectedStatusCode = '302';\n+  const expectedDestinationUrl = `${destinationOrigin}/${relativeUrl}`;\n+\n+  const testScript =\n+      `https.get('${sourceUrl}', res => console.log(res.statusCode, res.headers.location))`;\n+  const [actualStatusCode, actualDestinationUrl] =\n+      sh.exec(`node --eval \"${testScript}\"`, {silent: true}).trim().split(' ');\n+\n+  if (actualStatusCode !== expectedStatusCode) {\n     throw new Error(\n-        `Expected '${fooBarUrl}' to return a status code of '${fooBarExpectedStatusCode}', but ` +\n-        `it returned '${fooBarActualStatusCode}'.`);\n-  } else if (fooBarActualRedirectUrl !== fooBarExpectedRedirectUrl) {\n-    const actualBehavior = (fooBarActualRedirectUrl === 'undefined') ?\n-      'not redirected' : `redirected to '${fooBarActualRedirectUrl}'`;\n+        `Expected '${sourceUrl}' to return a status code of '${expectedStatusCode}', but it ` +\n+        `returned '${actualStatusCode}'.`);\n+  } else if (actualDestinationUrl !== expectedDestinationUrl) {\n+    const actualBehavior = (actualDestinationUrl === 'undefined') ?\n+      'not redirected' : `redirected to '${actualDestinationUrl}'`;\n     throw new Error(\n-        `Expected '${fooBarUrl}' to be redirected to '${fooBarExpectedRedirectUrl}', but it was ` +\n+        `Expected '${sourceUrl}' to be redirected to '${expectedDestinationUrl}', but it was ` +\n         `${actualBehavior}.`);\n   }\n }\n-\n-function testPwaScore({deployedUrl, minPwaScore}) {\n-  u.logSectionHeader('Run PWA-score tests.');\n-  u.yarn(`test-pwa-score \"${deployedUrl}\" \"${minPwaScore}\"`);\n-}"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 51,
        "deletions": 32
    }
}