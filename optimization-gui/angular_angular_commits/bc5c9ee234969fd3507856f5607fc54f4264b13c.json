{
    "author": "atscott",
    "message": "refactor(language-service): Migrate completions_spec to new testing API (#40966)\n\nrefactor(language-service): Migrate completions_spec to new testing API\n\nPR Close #40966",
    "sha": "bc5c9ee234969fd3507856f5607fc54f4264b13c",
    "files": [
        {
            "sha": "98e6717862bf1e542ee95fc3c7d0c325669eec44",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 151,
            "deletions": 163,
            "changes": 314,
            "blob_url": "https://github.com/angular/angular/blob/bc5c9ee234969fd3507856f5607fc54f4264b13c/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bc5c9ee234969fd3507856f5607fc54f4264b13c/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=bc5c9ee234969fd3507856f5607fc54f4264b13c",
            "patch": "@@ -6,13 +6,11 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import * as ts from 'typescript';\n import {DisplayInfoKind, unsafeCastDisplayInfoKindToScriptElementKind} from '../display_parts';\n-import {LanguageService} from '../language_service';\n \n-import {extractCursorInfo, LanguageServiceTestEnvironment} from './env';\n+import {LanguageServiceTestEnv, OpenBuffer} from '../testing';\n \n const DIR_WITH_INPUT = {\n   'Dir': `\n@@ -99,40 +97,43 @@ describe('completions', () => {\n \n   describe('in the global scope', () => {\n     it('should be able to complete an interpolation', () => {\n-      const {ngLS, fileName, cursor} = setup('{{ti¦}}', `title!: string; hero!: number;`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup('{{ti}}', `title!: string; hero!: number;`);\n+      templateFile.moveCursorToText('{{ti¦}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title', 'hero']);\n     });\n \n     it('should be able to complete an empty interpolation', () => {\n-      const {ngLS, fileName, cursor} = setup('{{ ¦ }}', `title!: string; hero!: number;`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup('{{  }}', `title!: string; hero!52: number;`);\n+      templateFile.moveCursorToText('{{ ¦ }}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title', 'hero']);\n     });\n \n     it('should be able to complete a property binding', () => {\n-      const {ngLS, fileName, cursor} =\n-          setup('<h1 [model]=\"ti¦\"></h1>', `title!: string; hero!: number;`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup('<h1 [model]=\"ti\"></h1>', `title!: string; hero!: number;`);\n+      templateFile.moveCursorToText('\"ti¦');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title', 'hero']);\n     });\n \n     it('should be able to complete an empty property binding', () => {\n-      const {ngLS, fileName, cursor} =\n-          setup('<h1 [model]=\"¦\"></h1>', `title!: string; hero!: number;`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup('<h1 [model]=\"\"></h1>', `title!: string; hero!: number;`);\n+      templateFile.moveCursorToText('[model]=\"¦\"');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title', 'hero']);\n     });\n \n     it('should be able to retrieve details for completions', () => {\n-      const {ngLS, fileName, cursor} = setup('{{ti¦}}', `\n+      const {templateFile} = setup('{{ti}}', `\n         /** This is the title of the 'AppCmp' Component. */\n         title!: string;\n         /** This comment should not appear in the output of this test. */\n         hero!: number;\n       `);\n-      const details = ngLS.getCompletionEntryDetails(\n-          fileName, cursor, 'title', /* formatOptions */ undefined,\n+      templateFile.moveCursorToText('{{ti¦}}');\n+      const details = templateFile.getCompletionEntryDetails(\n+          'title', /* formatOptions */ undefined,\n           /* preferences */ undefined)!;\n       expect(details).toBeDefined();\n       expect(toText(details.displayParts)).toEqual('(property) AppCmp.title: string');\n@@ -141,134 +142,141 @@ describe('completions', () => {\n     });\n \n     it('should return reference completions when available', () => {\n-      const {ngLS, fileName, cursor} = setup(`<div #todo></div>{{t¦}}`, `title!: string;`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`<div #todo></div>{{t}}`, `title!: string;`);\n+      templateFile.moveCursorToText('{{t¦}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title']);\n       expectContain(completions, DisplayInfoKind.REFERENCE, ['todo']);\n     });\n \n     it('should return variable completions when available', () => {\n-      const {ngLS, fileName, cursor} = setup(\n+      const {templateFile} = setup(\n           `<div *ngFor=\"let hero of heroes\">\n-            {{h¦}}\n+            {{h}}\n           </div>\n         `,\n           `heroes!: {name: string}[];`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      templateFile.moveCursorToText('{{h¦}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['heroes']);\n       expectContain(completions, DisplayInfoKind.VARIABLE, ['hero']);\n     });\n \n     it('should return completions inside an event binding', () => {\n-      const {ngLS, fileName, cursor} = setup(`<button (click)='t¦'></button>`, `title!: string;`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`<button (click)='t'></button>`, `title!: string;`);\n+      templateFile.moveCursorToText(`(click)='t¦'`);\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title']);\n     });\n \n     it('should return completions inside an empty event binding', () => {\n-      const {ngLS, fileName, cursor} = setup(`<button (click)='¦'></button>`, `title!: string;`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`<button (click)=''></button>`, `title!: string;`);\n+      templateFile.moveCursorToText(`(click)='¦'`);\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title']);\n     });\n \n     it('should return completions inside the RHS of a two-way binding', () => {\n-      const {ngLS, fileName, cursor} = setup(`<h1 [(model)]=\"t¦\"></h1>`, `title!: string;`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`<h1 [(model)]=\"t\"></h1>`, `title!: string;`);\n+      templateFile.moveCursorToText('[(model)]=\"t¦\"');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title']);\n     });\n \n     it('should return completions inside an empty RHS of a two-way binding', () => {\n-      const {ngLS, fileName, cursor} = setup(`<h1 [(model)]=\"¦\"></h1>`, `title!: string;`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`<h1 [(model)]=\"\"></h1>`, `title!: string;`);\n+      templateFile.moveCursorToText('[(model)]=\"¦\"');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title']);\n     });\n   });\n \n   describe('in an expression scope', () => {\n     it('should return completions in a property access expression', () => {\n-      const {ngLS, fileName, cursor} =\n-          setup(`{{name.f¦}}`, `name!: {first: string; last: string;};`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{name.f}}`, `name!: {first: string; last: string;};`);\n+      templateFile.moveCursorToText('{{name.f¦}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectAll(completions, {\n         first: ts.ScriptElementKind.memberVariableElement,\n         last: ts.ScriptElementKind.memberVariableElement,\n       });\n     });\n \n     it('should return completions in an empty property access expression', () => {\n-      const {ngLS, fileName, cursor} =\n-          setup(`{{name.¦}}`, `name!: {first: string; last: string;};`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{name.}}`, `name!: {first: string; last: string;};`);\n+      templateFile.moveCursorToText('{{name.¦}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectAll(completions, {\n         first: ts.ScriptElementKind.memberVariableElement,\n         last: ts.ScriptElementKind.memberVariableElement,\n       });\n     });\n \n     it('should return completions in a property write expression', () => {\n-      const {ngLS, fileName, cursor} = setup(\n-          `<button (click)=\"name.fi¦ = 'test\"></button>`, `name!: {first: string; last: string;};`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(\n+          `<button (click)=\"name.fi = 'test\"></button>`, `name!: {first: string; last: string;};`);\n+      templateFile.moveCursorToText('name.fi¦');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectAll(completions, {\n         first: ts.ScriptElementKind.memberVariableElement,\n         last: ts.ScriptElementKind.memberVariableElement,\n       });\n     });\n \n     it('should return completions in a method call expression', () => {\n-      const {ngLS, fileName, cursor} =\n-          setup(`{{name.f¦()}}`, `name!: {first: string; full(): string;};`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{name.f()}}`, `name!: {first: string; full(): string;};`);\n+      templateFile.moveCursorToText('{{name.f¦()}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectAll(completions, {\n         first: ts.ScriptElementKind.memberVariableElement,\n         full: ts.ScriptElementKind.memberFunctionElement,\n       });\n     });\n \n     it('should return completions in an empty method call expression', () => {\n-      const {ngLS, fileName, cursor} =\n-          setup(`{{name.¦()}}`, `name!: {first: string; full(): string;};`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{name.()}}`, `name!: {first: string; full(): string;};`);\n+      templateFile.moveCursorToText('{{name.¦()}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectAll(completions, {\n         first: ts.ScriptElementKind.memberVariableElement,\n         full: ts.ScriptElementKind.memberFunctionElement,\n       });\n     });\n \n     it('should return completions in a safe property navigation context', () => {\n-      const {ngLS, fileName, cursor} =\n-          setup(`{{name?.f¦}}`, `name?: {first: string; last: string;};`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{name?.f}}`, `name?: {first: string; last: string;};`);\n+      templateFile.moveCursorToText('{{name?.f¦}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectAll(completions, {\n         first: ts.ScriptElementKind.memberVariableElement,\n         last: ts.ScriptElementKind.memberVariableElement,\n       });\n     });\n \n     it('should return completions in an empty safe property navigation context', () => {\n-      const {ngLS, fileName, cursor} =\n-          setup(`{{name?.¦}}`, `name?: {first: string; last: string;};`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{name?.}}`, `name?: {first: string; last: string;};`);\n+      templateFile.moveCursorToText('{{name?.¦}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectAll(completions, {\n         first: ts.ScriptElementKind.memberVariableElement,\n         last: ts.ScriptElementKind.memberVariableElement,\n       });\n     });\n \n     it('should return completions in a safe method call context', () => {\n-      const {ngLS, fileName, cursor} =\n-          setup(`{{name?.f¦()}}`, `name!: {first: string; full(): string;};`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{name?.f()}}`, `name!: {first: string; full(): string;};`);\n+      templateFile.moveCursorToText('{{name?.f¦()}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectAll(completions, {\n         first: ts.ScriptElementKind.memberVariableElement,\n         full: ts.ScriptElementKind.memberFunctionElement,\n       });\n     });\n \n     it('should return completions in an empty safe method call context', () => {\n-      const {ngLS, fileName, cursor} =\n-          setup(`{{name?.¦()}}`, `name!: {first: string; full(): string;};`);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{name?.()}}`, `name!: {first: string; full(): string;};`);\n+      templateFile.moveCursorToText('{{name?.¦()}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectAll(completions, {\n         first: ts.ScriptElementKind.memberVariableElement,\n         full: ts.ScriptElementKind.memberFunctionElement,\n@@ -278,8 +286,9 @@ describe('completions', () => {\n \n   describe('element tag scope', () => {\n     it('should return DOM completions', () => {\n-      const {ngLS, fileName, cursor} = setup(`<div¦>`, '');\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`<div>`, '');\n+      templateFile.moveCursorToText('<div¦>');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(\n           completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ELEMENT),\n           ['div', 'span']);\n@@ -293,14 +302,14 @@ describe('completions', () => {\n             export class OtherDir {}\n           `,\n       };\n-      const {ngLS, fileName, cursor} = setup(`<div¦>`, '', OTHER_DIR);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`<div>`, '', OTHER_DIR);\n+      templateFile.moveCursorToText('<div¦>');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(\n           completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.DIRECTIVE),\n           ['other-dir']);\n \n-      const details =\n-          ngLS.getCompletionEntryDetails(fileName, cursor, 'other-dir', undefined, undefined)!;\n+      const details = templateFile.getCompletionEntryDetails('other-dir')!;\n       expect(details).toBeDefined();\n       expect(ts.displayPartsToString(details.displayParts))\n           .toEqual('(directive) AppModule.OtherDir');\n@@ -315,15 +324,15 @@ describe('completions', () => {\n             export class OtherCmp {}\n           `,\n       };\n-      const {ngLS, fileName, cursor} = setup(`<div¦>`, '', OTHER_CMP);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`<div>`, '', OTHER_CMP);\n+      templateFile.moveCursorToText('<div¦>');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(\n           completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.COMPONENT),\n           ['other-cmp']);\n \n \n-      const details =\n-          ngLS.getCompletionEntryDetails(fileName, cursor, 'other-cmp', undefined, undefined)!;\n+      const details = templateFile.getCompletionEntryDetails('other-cmp')!;\n       expect(details).toBeDefined();\n       expect(ts.displayPartsToString(details.displayParts))\n           .toEqual('(component) AppModule.OtherCmp');\n@@ -333,10 +342,10 @@ describe('completions', () => {\n     describe('element attribute scope', () => {\n       describe('dom completions', () => {\n         it('should return completions for a new element attribute', () => {\n-          const {ngLS, fileName, cursor} = setup(`<input ¦>`, '');\n+          const {templateFile} = setup(`<input >`, '');\n+          templateFile.moveCursorToText('<input ¦>');\n \n-          const completions =\n-              ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+          const completions = templateFile.getCompletionsAtPosition();\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n               ['value']);\n@@ -346,24 +355,24 @@ describe('completions', () => {\n         });\n \n         it('should return completions for a partial attribute', () => {\n-          const {ngLS, fileName, cursor, text} = setup(`<input val¦>`, '');\n+          const {templateFile} = setup(`<input val>`, '');\n+          templateFile.moveCursorToText('<input val¦>');\n \n-          const completions =\n-              ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+          const completions = templateFile.getCompletionsAtPosition();\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n               ['value']);\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n               ['[value]']);\n-          expectReplacementText(completions, text, 'val');\n+          expectReplacementText(completions, templateFile.contents, 'val');\n         });\n \n         it('should return completions for a partial property binding', () => {\n-          const {ngLS, fileName, cursor, text} = setup(`<input [val¦]>`, '');\n+          const {templateFile} = setup(`<input [val]>`, '');\n+          templateFile.moveCursorToText('[val¦]');\n \n-          const completions =\n-              ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+          const completions = templateFile.getCompletionsAtPosition();\n           expectDoesNotContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n               ['value']);\n@@ -373,16 +382,16 @@ describe('completions', () => {\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n               ['value']);\n-          expectReplacementText(completions, text, 'val');\n+          expectReplacementText(completions, templateFile.contents, 'val');\n         });\n       });\n \n       describe('directive present', () => {\n         it('should return directive input completions for a new attribute', () => {\n-          const {ngLS, fileName, cursor, text} = setup(`<input dir ¦>`, '', DIR_WITH_INPUT);\n+          const {templateFile} = setup(`<input dir >`, '', DIR_WITH_INPUT);\n+          templateFile.moveCursorToText('dir ¦>');\n \n-          const completions =\n-              ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+          const completions = templateFile.getCompletionsAtPosition();\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n               ['[myInput]']);\n@@ -392,10 +401,10 @@ describe('completions', () => {\n         });\n \n         it('should return directive input completions for a partial attribute', () => {\n-          const {ngLS, fileName, cursor, text} = setup(`<input dir my¦>`, '', DIR_WITH_INPUT);\n+          const {templateFile} = setup(`<input dir my>`, '', DIR_WITH_INPUT);\n+          templateFile.moveCursorToText('my¦>');\n \n-          const completions =\n-              ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+          const completions = templateFile.getCompletionsAtPosition();\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n               ['[myInput]']);\n@@ -405,10 +414,10 @@ describe('completions', () => {\n         });\n \n         it('should return input completions for a partial property binding', () => {\n-          const {ngLS, fileName, cursor, text} = setup(`<input dir [my¦]>`, '', DIR_WITH_INPUT);\n+          const {templateFile} = setup(`<input dir [my]>`, '', DIR_WITH_INPUT);\n+          templateFile.moveCursorToText('[my¦]');\n \n-          const completions =\n-              ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+          const completions = templateFile.getCompletionsAtPosition();\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n               ['myInput']);\n@@ -417,60 +426,60 @@ describe('completions', () => {\n \n       describe('structural directive present', () => {\n         it('should return structural directive completions for an empty attribute', () => {\n-          const {ngLS, fileName, cursor, text} = setup(`<li ¦>`, '', NG_FOR_DIR);\n+          const {templateFile} = setup(`<li >`, '', NG_FOR_DIR);\n+          templateFile.moveCursorToText('<li ¦>');\n \n-          const completions =\n-              ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+          const completions = templateFile.getCompletionsAtPosition();\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.DIRECTIVE),\n               ['*ngFor']);\n         });\n \n         it('should return structural directive completions for an existing non-structural attribute',\n            () => {\n-             const {ngLS, fileName, cursor, text} = setup(`<li ng¦>`, '', NG_FOR_DIR);\n+             const {templateFile} = setup(`<li ng>`, '', NG_FOR_DIR);\n+             templateFile.moveCursorToText('<li ng¦>');\n \n-             const completions =\n-                 ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+             const completions = templateFile.getCompletionsAtPosition();\n              expectContain(\n                  completions,\n                  unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.DIRECTIVE),\n                  ['*ngFor']);\n-             expectReplacementText(completions, text, 'ng');\n+             expectReplacementText(completions, templateFile.contents, 'ng');\n            });\n \n         it('should return structural directive completions for an existing structural attribute',\n            () => {\n-             const {ngLS, fileName, cursor, text} = setup(`<li *ng¦>`, '', NG_FOR_DIR);\n+             const {templateFile} = setup(`<li *ng>`, '', NG_FOR_DIR);\n+             templateFile.moveCursorToText('*ng¦>');\n \n-             const completions =\n-                 ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+             const completions = templateFile.getCompletionsAtPosition();\n              expectContain(\n                  completions,\n                  unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.DIRECTIVE),\n                  ['ngFor']);\n-             expectReplacementText(completions, text, 'ng');\n+             expectReplacementText(completions, templateFile.contents, 'ng');\n            });\n \n         it('should return structural directive completions for just the structural marker', () => {\n-          const {ngLS, fileName, cursor, text} = setup(`<li *¦>`, '', NG_FOR_DIR);\n+          const {templateFile} = setup(`<li *>`, '', NG_FOR_DIR);\n+          templateFile.moveCursorToText('*¦>');\n \n-          const completions =\n-              ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+          const completions = templateFile.getCompletionsAtPosition();\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.DIRECTIVE),\n               ['ngFor']);\n           // The completion should not try to overwrite the '*'.\n-          expectReplacementText(completions, text, '');\n+          expectReplacementText(completions, templateFile.contents, '');\n         });\n       });\n \n       describe('directive not present', () => {\n         it('should return input completions for a new attribute', () => {\n-          const {ngLS, fileName, cursor, text} = setup(`<input ¦>`, '', DIR_WITH_SELECTED_INPUT);\n+          const {templateFile} = setup(`<input >`, '', DIR_WITH_SELECTED_INPUT);\n+          templateFile.moveCursorToText('¦>');\n \n-          const completions =\n-              ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+          const completions = templateFile.getCompletionsAtPosition();\n           // This context should generate two completions:\n           //  * `[myInput]` as a property\n           //  * `myInput` as an attribute\n@@ -484,10 +493,10 @@ describe('completions', () => {\n       });\n \n       it('should return input completions for a partial attribute', () => {\n-        const {ngLS, fileName, cursor, text} = setup(`<input my¦>`, '', DIR_WITH_SELECTED_INPUT);\n+        const {templateFile} = setup(`<input my>`, '', DIR_WITH_SELECTED_INPUT);\n+        templateFile.moveCursorToText('my¦>');\n \n-        const completions =\n-            ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+        const completions = templateFile.getCompletionsAtPosition();\n         // This context should generate two completions:\n         //  * `[myInput]` as a property\n         //  * `myInput` as an attribute\n@@ -497,50 +506,49 @@ describe('completions', () => {\n         expectContain(\n             completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n             ['myInput']);\n-        expectReplacementText(completions, text, 'my');\n+        expectReplacementText(completions, templateFile.contents, 'my');\n       });\n \n       it('should return input completions for a partial property binding', () => {\n-        const {ngLS, fileName, cursor, text} = setup(`<input [my¦]>`, '', DIR_WITH_SELECTED_INPUT);\n+        const {templateFile} = setup(`<input [my]>`, '', DIR_WITH_SELECTED_INPUT);\n+        templateFile.moveCursorToText('[my¦');\n \n-        const completions =\n-            ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+        const completions = templateFile.getCompletionsAtPosition();\n         // This context should generate two completions:\n         //  * `[myInput]` as a property\n         //  * `myInput` as an attribute\n         expectContain(\n             completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n             ['myInput']);\n-        expectReplacementText(completions, text, 'my');\n+        expectReplacementText(completions, templateFile.contents, 'my');\n       });\n \n       it('should return output completions for an empty binding', () => {\n-        const {ngLS, fileName, cursor, text} = setup(`<input dir ¦>`, '', DIR_WITH_OUTPUT);\n+        const {templateFile} = setup(`<input dir >`, '', DIR_WITH_OUTPUT);\n+        templateFile.moveCursorToText('¦>');\n \n-        const completions =\n-            ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+        const completions = templateFile.getCompletionsAtPosition();\n         expectContain(\n             completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.EVENT),\n             ['(myOutput)']);\n       });\n \n       it('should return output completions for a partial event binding', () => {\n-        const {ngLS, fileName, cursor, text} = setup(`<input dir (my¦)>`, '', DIR_WITH_OUTPUT);\n+        const {templateFile} = setup(`<input dir (my)>`, '', DIR_WITH_OUTPUT);\n+        templateFile.moveCursorToText('(my¦)');\n \n-        const completions =\n-            ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+        const completions = templateFile.getCompletionsAtPosition();\n         expectContain(\n             completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.EVENT),\n             ['myOutput']);\n-        expectReplacementText(completions, text, 'my');\n+        expectReplacementText(completions, templateFile.contents, 'my');\n       });\n \n       it('should return completions inside an LHS of a partially complete two-way binding', () => {\n-        const {ngLS, fileName, cursor, text} =\n-            setup(`<h1 dir [(mod¦)]></h1>`, ``, DIR_WITH_TWO_WAY_BINDING);\n-        const completions =\n-            ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n-        expectReplacementText(completions, text, 'mod');\n+        const {templateFile} = setup(`<h1 dir [(mod)]></h1>`, ``, DIR_WITH_TWO_WAY_BINDING);\n+        templateFile.moveCursorToText('[(mod¦)]');\n+        const completions = templateFile.getCompletionsAtPosition();\n+        expectReplacementText(completions, templateFile.contents, 'mod');\n \n         expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['model']);\n \n@@ -560,26 +568,29 @@ describe('completions', () => {\n \n   describe('pipe scope', () => {\n     it('should complete a pipe binding', () => {\n-      const {ngLS, fileName, cursor, text} = setup(`{{ foo | some¦ }}`, '', SOME_PIPE);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{ foo | some¦ }}`, '', SOME_PIPE);\n+      templateFile.moveCursorToText('some¦');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(\n           completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PIPE),\n           ['somePipe']);\n-      expectReplacementText(completions, text, 'some');\n+      expectReplacementText(completions, templateFile.contents, 'some');\n     });\n \n     it('should complete an empty pipe binding', () => {\n-      const {ngLS, fileName, cursor, text} = setup(`{{foo | ¦}}`, '', SOME_PIPE);\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{foo | }}`, '', SOME_PIPE);\n+      templateFile.moveCursorToText('{{foo | ¦}}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expectContain(\n           completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PIPE),\n           ['somePipe']);\n-      expectReplacementText(completions, text, '');\n+      expectReplacementText(completions, templateFile.contents, '');\n     });\n \n     it('should not return extraneous completions', () => {\n-      const {ngLS, fileName, cursor, text} = setup(`{{ foo | some¦ }}`, '');\n-      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      const {templateFile} = setup(`{{ foo | some }}`, '');\n+      templateFile.moveCursorToText('{{ foo | some¦ }}');\n+      const completions = templateFile.getCompletionsAtPosition();\n       expect(completions?.entries.length).toBe(0);\n     });\n   });\n@@ -632,27 +643,16 @@ function toText(displayParts?: ts.SymbolDisplayPart[]): string {\n }\n \n function setup(\n-    templateWithCursor: string, classContents: string,\n-    otherDeclarations: {[name: string]: string} = {}): {\n-  env: LanguageServiceTestEnvironment,\n-  fileName: AbsoluteFsPath,\n-  AppCmp: ts.ClassDeclaration,\n-  ngLS: LanguageService,\n-  cursor: number,\n-  text: string,\n+    template: string, classContents: string, otherDeclarations: {[name: string]: string} = {}): {\n+  templateFile: OpenBuffer,\n } {\n-  const codePath = absoluteFrom('/test.ts');\n-  const templatePath = absoluteFrom('/test.html');\n-\n   const decls = ['AppCmp', ...Object.keys(otherDeclarations)];\n \n   const otherDirectiveClassDecls = Object.values(otherDeclarations).join('\\n\\n');\n \n-  const {cursor, text: templateWithoutCursor} = extractCursorInfo(templateWithCursor);\n-  const env = LanguageServiceTestEnvironment.setup([\n-    {\n-      name: codePath,\n-      contents: `\n+  const env = LanguageServiceTestEnv.setup();\n+  const project = env.addProject('test', {\n+    'test.ts': `\n         import {Component, Directive, NgModule, Pipe, TemplateRef} from '@angular/core';\n \n         @Component({\n@@ -670,19 +670,7 @@ function setup(\n         })\n         export class AppModule {}\n         `,\n-      isRoot: true,\n-    },\n-    {\n-      name: templatePath,\n-      contents: templateWithoutCursor,\n-    }\n-  ]);\n-  return {\n-    env,\n-    fileName: templatePath,\n-    AppCmp: env.getClass(codePath, 'AppCmp'),\n-    ngLS: env.ngLS,\n-    text: templateWithoutCursor,\n-    cursor,\n-  };\n+    'test.html': template,\n+  });\n+  return {templateFile: project.openFile('test.html')};\n }"
        },
        {
            "sha": "48a90c41cf0eec4abc973262881c6ed82832bac6",
            "filename": "packages/language-service/ivy/testing/src/buffer.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/bc5c9ee234969fd3507856f5607fc54f4264b13c/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "raw_url": "https://github.com/angular/angular/raw/bc5c9ee234969fd3507856f5607fc54f4264b13c/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts?ref=bc5c9ee234969fd3507856f5607fc54f4264b13c",
            "patch": "@@ -64,4 +64,16 @@ export class OpenBuffer {\n   getDefinitionAndBoundSpan(): ts.DefinitionInfoAndBoundSpan|undefined {\n     return this.ngLS.getDefinitionAndBoundSpan(this.scriptInfo.fileName, this._cursor);\n   }\n+\n+  getCompletionsAtPosition(options?: ts.GetCompletionsAtPositionOptions):\n+      ts.WithMetadata<ts.CompletionInfo>|undefined {\n+    return this.ngLS.getCompletionsAtPosition(this.scriptInfo.fileName, this._cursor, options);\n+  }\n+\n+  getCompletionEntryDetails(\n+      entryName: string, formatOptions?: ts.FormatCodeOptions|ts.FormatCodeSettings,\n+      preferences?: ts.UserPreferences): ts.CompletionEntryDetails|undefined {\n+    return this.ngLS.getCompletionEntryDetails(\n+        this.scriptInfo.fileName, this._cursor, entryName, formatOptions, preferences);\n+  }\n }"
        }
    ],
    "stats": {
        "total": 326,
        "additions": 163,
        "deletions": 163
    }
}