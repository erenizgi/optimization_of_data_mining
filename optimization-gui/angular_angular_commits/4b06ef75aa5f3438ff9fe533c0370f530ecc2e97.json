{
    "author": "JoostK",
    "message": "refactor(compiler): associate accurate source spans with ICU expressions (#39072)\n\nPrior to this change, expressions within ICUs would have a source span\ncorresponding with the whole ICU. This commit narrows down the source\nspans of these expressions to the exact location in the source file, as\na prerequisite for reporting type check errors within these expressions.\n\nPR Close #39072",
    "sha": "4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
    "files": [
        {
            "sha": "707f4f02a257f349a9e217d57f9f1bd96e7dbba5",
            "filename": "packages/compiler/src/expression_parser/parser.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 4,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -179,10 +179,33 @@ export class Parser {\n       expressions.push(ast);\n     }\n \n-    const span = new ParseSpan(0, input == null ? 0 : input.length);\n-    return new ASTWithSource(\n-        new Interpolation(span, span.toAbsolute(absoluteOffset), split.strings, expressions), input,\n-        location, absoluteOffset, this.errors);\n+    return this.createInterpolationAst(split.strings, expressions, input, location, absoluteOffset);\n+  }\n+\n+  /**\n+   * Similar to `parseInterpolation`, but treats the provided string as a single expression\n+   * element that would normally appear within the interpolation prefix and suffix (`{{` and `}}`).\n+   * This is used for parsing the switch expression in ICUs.\n+   */\n+  parseInterpolationExpression(expression: string, location: any, absoluteOffset: number):\n+      ASTWithSource {\n+    const sourceToLex = this._stripComments(expression);\n+    const tokens = this._lexer.tokenize(sourceToLex);\n+    const ast = new _ParseAST(\n+                    expression, location, absoluteOffset, tokens, sourceToLex.length,\n+                    /* parseAction */ false, this.errors, 0)\n+                    .parseChain();\n+    const strings = ['', ''];  // The prefix and suffix strings are both empty\n+    return this.createInterpolationAst(strings, [ast], expression, location, absoluteOffset);\n+  }\n+\n+  private createInterpolationAst(\n+      strings: string[], expressions: AST[], input: string, location: string,\n+      absoluteOffset: number): ASTWithSource {\n+    const span = new ParseSpan(0, input.length);\n+    const interpolation =\n+        new Interpolation(span, span.toAbsolute(absoluteOffset), strings, expressions);\n+    return new ASTWithSource(interpolation, input, location, absoluteOffset, this.errors);\n   }\n \n   /**"
        },
        {
            "sha": "f202ba9e067bdc1984de90837d50d1cb2ce9d635",
            "filename": "packages/compiler/src/i18n/i18n_ast.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_ast.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -8,6 +8,18 @@\n \n import {ParseSourceSpan} from '../parse_util';\n \n+/**\n+ * Describes the text contents of a placeholder as it appears in an ICU expression, including its\n+ * source span information.\n+ */\n+export interface MessagePlaceholder {\n+  /** The text contents of the placeholder */\n+  text: string;\n+\n+  /** The source span of the placeholder */\n+  sourceSpan: ParseSourceSpan;\n+}\n+\n export class Message {\n   sources: MessageSpan[];\n   id: string = this.customId;\n@@ -16,14 +28,14 @@ export class Message {\n \n   /**\n    * @param nodes message AST\n-   * @param placeholders maps placeholder names to static content\n+   * @param placeholders maps placeholder names to static content and their source spans\n    * @param placeholderToMessage maps placeholder names to messages (used for nested ICU messages)\n    * @param meaning\n    * @param description\n    * @param customId\n    */\n   constructor(\n-      public nodes: Node[], public placeholders: {[phName: string]: string},\n+      public nodes: Node[], public placeholders: {[phName: string]: MessagePlaceholder},\n       public placeholderToMessage: {[phName: string]: Message}, public meaning: string,\n       public description: string, public customId: string) {\n     if (nodes.length) {"
        },
        {
            "sha": "4fa1f55f4b5ea69325ef31649083e71bfce9dff8",
            "filename": "packages/compiler/src/i18n/i18n_parser.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -39,7 +39,7 @@ interface I18nMessageVisitorContext {\n   isIcu: boolean;\n   icuDepth: number;\n   placeholderRegistry: PlaceholderRegistry;\n-  placeholderToContent: {[phName: string]: string};\n+  placeholderToContent: {[phName: string]: i18n.MessagePlaceholder};\n   placeholderToMessage: {[phName: string]: i18n.Message};\n   visitNodeFn: VisitNodeFn;\n }\n@@ -83,13 +83,19 @@ class _I18nVisitor implements html.Visitor {\n     const isVoid: boolean = getHtmlTagDefinition(el.name).isVoid;\n     const startPhName =\n         context.placeholderRegistry.getStartTagPlaceholderName(el.name, attrs, isVoid);\n-    context.placeholderToContent[startPhName] = el.startSourceSpan.toString();\n+    context.placeholderToContent[startPhName] = {\n+      text: el.startSourceSpan.toString(),\n+      sourceSpan: el.startSourceSpan,\n+    };\n \n     let closePhName = '';\n \n     if (!isVoid) {\n       closePhName = context.placeholderRegistry.getCloseTagPlaceholderName(el.name);\n-      context.placeholderToContent[closePhName] = `</${el.name}>`;\n+      context.placeholderToContent[closePhName] = {\n+        text: `</${el.name}>`,\n+        sourceSpan: el.endSourceSpan ?? el.sourceSpan,\n+      };\n     }\n \n     const node = new i18n.TagPlaceholder(\n@@ -128,7 +134,10 @@ class _I18nVisitor implements html.Visitor {\n       // - the ICU message is nested.\n       const expPh = context.placeholderRegistry.getUniquePlaceholder(`VAR_${icu.type}`);\n       i18nIcu.expressionPlaceholder = expPh;\n-      context.placeholderToContent[expPh] = icu.switchValue;\n+      context.placeholderToContent[expPh] = {\n+        text: icu.switchValue,\n+        sourceSpan: icu.switchValueSourceSpan,\n+      };\n       return context.visitNodeFn(icu, i18nIcu);\n     }\n \n@@ -175,7 +184,10 @@ class _I18nVisitor implements html.Visitor {\n       const expressionSpan =\n           getOffsetSourceSpan(sourceSpan, splitInterpolation.expressionsSpans[i]);\n       nodes.push(new i18n.Placeholder(expression, phName, expressionSpan));\n-      context.placeholderToContent[phName] = sDelimiter + expression + eDelimiter;\n+      context.placeholderToContent[phName] = {\n+        text: sDelimiter + expression + eDelimiter,\n+        sourceSpan: expressionSpan,\n+      };\n     }\n \n     // The last index contains no expression"
        },
        {
            "sha": "79e899e2e095ba6e8b8573cb588bb7892517f97c",
            "filename": "packages/compiler/src/i18n/translation_bundle.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Fi18n%2Ftranslation_bundle.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Fi18n%2Ftranslation_bundle.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Ftranslation_bundle.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -109,7 +109,7 @@ class I18nToHtmlVisitor implements i18n.Visitor {\n     // TODO(vicb): Once all format switch to using expression placeholders\n     // we should throw when the placeholder is not in the source message\n     const exp = this._srcMsg.placeholders.hasOwnProperty(icu.expression) ?\n-        this._srcMsg.placeholders[icu.expression] :\n+        this._srcMsg.placeholders[icu.expression].text :\n         icu.expression;\n \n     return `{${exp}, ${icu.type}, ${cases.join(' ')}}`;\n@@ -118,7 +118,7 @@ class I18nToHtmlVisitor implements i18n.Visitor {\n   visitPlaceholder(ph: i18n.Placeholder, context?: any): string {\n     const phName = this._mapper(ph.name);\n     if (this._srcMsg.placeholders.hasOwnProperty(phName)) {\n-      return this._srcMsg.placeholders[phName];\n+      return this._srcMsg.placeholders[phName].text;\n     }\n \n     if (this._srcMsg.placeholderToMessage.hasOwnProperty(phName)) {"
        },
        {
            "sha": "fe29a9bc40c32d3953cbab2049cdf7ba9330ae1d",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 9,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -266,23 +266,18 @@ class HtmlAstToIvyAst implements html.Visitor {\n     Object.keys(message.placeholders).forEach(key => {\n       const value = message.placeholders[key];\n       if (key.startsWith(I18N_ICU_VAR_PREFIX)) {\n-        const config = this.bindingParser.interpolationConfig;\n-\n-        // ICU expression is a plain string, not wrapped into start\n-        // and end tags, so we wrap it before passing to binding parser\n-        const wrapped = `${config.start}${value}${config.end}`;\n-\n         // Currently when the `plural` or `select` keywords in an ICU contain trailing spaces (e.g.\n         // `{count, select , ...}`), these spaces are also included into the key names in ICU vars\n         // (e.g. \"VAR_SELECT \"). These trailing spaces are not desirable, since they will later be\n         // converted into `_` symbols while normalizing placeholder names, which might lead to\n         // mismatches at runtime (i.e. placeholder will not be replaced with the correct value).\n         const formattedKey = key.trim();\n \n-        vars[formattedKey] =\n-            this._visitTextWithInterpolation(wrapped, expansion.sourceSpan) as t.BoundText;\n+        const ast = this.bindingParser.parseInterpolationExpression(value.text, value.sourceSpan);\n+\n+        vars[formattedKey] = new t.BoundText(ast, value.sourceSpan);\n       } else {\n-        placeholders[key] = this._visitTextWithInterpolation(value, expansion.sourceSpan);\n+        placeholders[key] = this._visitTextWithInterpolation(value.text, value.sourceSpan);\n       }\n     });\n     return new t.Icu(vars, placeholders, expansion.sourceSpan, message);"
        },
        {
            "sha": "81e0b69b1d03fed1e30d78441ed582728ed1a628",
            "filename": "packages/compiler/src/template_parser/binding_parser.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -127,6 +127,26 @@ export class BindingParser {\n     }\n   }\n \n+  /**\n+   * Similar to `parseInterpolation`, but treats the provided string as a single expression\n+   * element that would normally appear within the interpolation prefix and suffix (`{{` and `}}`).\n+   * This is used for parsing the switch expression in ICUs.\n+   */\n+  parseInterpolationExpression(expression: string, sourceSpan: ParseSourceSpan): ASTWithSource {\n+    const sourceInfo = sourceSpan.start.toString();\n+\n+    try {\n+      const ast = this._exprParser.parseInterpolationExpression(\n+          expression, sourceInfo, sourceSpan.start.offset);\n+      if (ast) this._reportExpressionParserErrors(ast.errors, sourceSpan);\n+      this._checkPipes(ast, sourceSpan);\n+      return ast;\n+    } catch (e) {\n+      this._reportError(`${e}`, sourceSpan);\n+      return this._exprParser.wrapLiteralPrimitive('ERROR', sourceInfo, sourceSpan.start.offset);\n+    }\n+  }\n+\n   /**\n    * Parses the bindings in a microsyntax expression, and converts them to\n    * `ParsedProperty` or `ParsedVariable`."
        },
        {
            "sha": "96945dfb4a558dcefd08392b2d01a35d458ddae6",
            "filename": "packages/compiler/test/i18n/i18n_parser_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Ftest%2Fi18n%2Fi18n_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Ftest%2Fi18n%2Fi18n_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fi18n%2Fi18n_parser_spec.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -324,7 +324,7 @@ function _humanizePlaceholders(\n   // clang-format off\n   // https://github.com/angular/clang-format/issues/35\n   return _extractMessages(html, implicitTags, implicitAttrs).map(\n-    msg => Object.keys(msg.placeholders).map((name) => `${name}=${msg.placeholders[name]}`).join(', '));\n+    msg => Object.keys(msg.placeholders).map((name) => `${name}=${msg.placeholders[name].text}`).join(', '));\n   // clang-format on\n }\n "
        },
        {
            "sha": "b7aa2905997145d4cb5c173dbf32e31c2eb8f33c",
            "filename": "packages/compiler/test/i18n/translation_bundle_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Ftest%2Fi18n%2Ftranslation_bundle_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Ftest%2Fi18n%2Ftranslation_bundle_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fi18n%2Ftranslation_bundle_spec.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -50,7 +50,7 @@ import {_extractMessages} from './i18n_parser_spec';\n         ]\n       };\n       const phMap = {\n-        ph1: '*phContent*',\n+        ph1: createPlaceholder('*phContent*'),\n       };\n       const tb = new TranslationBundle(msgMap, null, (_) => 'foo');\n       const msg = new i18n.Message([srcNode], phMap, {}, 'm', 'd', 'i');\n@@ -160,7 +160,7 @@ import {_extractMessages} from './i18n_parser_spec';\n           ]\n         };\n         const phMap = {\n-          ph1: '</b>',\n+          ph1: createPlaceholder('</b>'),\n         };\n         const tb = new TranslationBundle(msgMap, null, (_) => 'foo');\n         const msg = new i18n.Message([srcNode], phMap, {}, 'm', 'd', 'i');\n@@ -169,3 +169,13 @@ import {_extractMessages} from './i18n_parser_spec';\n     });\n   });\n }\n+\n+function createPlaceholder(text: string): i18n.MessagePlaceholder {\n+  const file = new ParseSourceFile(text, 'file://test');\n+  const start = new ParseLocation(file, 0, 0, 0);\n+  const end = new ParseLocation(file, text.length, 0, text.length);\n+  return {\n+    text,\n+    sourceSpan: new ParseSourceSpan(start, end),\n+  };\n+}"
        },
        {
            "sha": "bb9082b2454567aa7bff17da3e48fa2ecadd08f7",
            "filename": "packages/compiler/test/render3/r3_ast_absolute_span_spec.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_absolute_span_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_absolute_span_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_absolute_span_spec.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -339,4 +339,25 @@ describe('expression AST absolute source spans', () => {\n               [['As', new AbsoluteSourceSpan(22, 24)], ['Bs', new AbsoluteSourceSpan(35, 37)]]));\n     });\n   });\n+\n+  describe('ICU expressions', () => {\n+    it('is correct for variables and placeholders', () => {\n+      const spans = humanizeExpressionSource(\n+          parse('<span i18n>{item.var, plural, other { {{item.placeholder}} items } }</span>')\n+              .nodes);\n+      expect(spans).toContain(['item.var', new AbsoluteSourceSpan(12, 20)]);\n+      expect(spans).toContain(['item.placeholder', new AbsoluteSourceSpan(40, 56)]);\n+    });\n+\n+    it('is correct for variables and placeholders', () => {\n+      const spans = humanizeExpressionSource(\n+          parse(\n+              '<span i18n>{item.var, plural, other { {{item.placeholder}} {nestedVar, plural, other { {{nestedPlaceholder}} }}} }</span>')\n+              .nodes);\n+      expect(spans).toContain(['item.var', new AbsoluteSourceSpan(12, 20)]);\n+      expect(spans).toContain(['item.placeholder', new AbsoluteSourceSpan(40, 56)]);\n+      expect(spans).toContain(['nestedVar', new AbsoluteSourceSpan(60, 69)]);\n+      expect(spans).toContain(['nestedPlaceholder', new AbsoluteSourceSpan(89, 106)]);\n+    });\n+  });\n });"
        },
        {
            "sha": "7cbfc704ad7eb7398144017bfa4ca469baac4bfb",
            "filename": "packages/compiler/test/render3/r3_ast_spans_spec.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 1,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -89,7 +89,13 @@ class R3AstSourceSpans implements t.Visitor<void> {\n   }\n \n   visitIcu(icu: t.Icu) {\n-    return null;\n+    this.result.push(['Icu', humanizeSpan(icu.sourceSpan)]);\n+    for (const key of Object.keys(icu.vars)) {\n+      this.result.push(['Icu:Var', humanizeSpan(icu.vars[key].sourceSpan)]);\n+    }\n+    for (const key of Object.keys(icu.placeholders)) {\n+      this.result.push(['Icu:Placeholder', humanizeSpan(icu.placeholders[key].sourceSpan)]);\n+    }\n   }\n \n   private visitAll(nodes: t.Node[][]) {\n@@ -420,4 +426,40 @@ describe('R3 AST source spans', () => {\n       ]);\n     });\n   });\n+\n+  describe('ICU expressions', () => {\n+    it('is correct for variables and placeholders', () => {\n+      expectFromHtml('<span i18n>{item.var, plural, other { {{item.placeholder}} items } }</span>')\n+          .toEqual([\n+            [\n+              'Element',\n+              '<span i18n>{item.var, plural, other { {{item.placeholder}} items } }</span>',\n+              '<span i18n>', '</span>'\n+            ],\n+            ['Icu', '{item.var, plural, other { {{item.placeholder}} items } }'],\n+            ['Icu:Var', 'item.var'],\n+            ['Icu:Placeholder', '{{item.placeholder}}'],\n+          ]);\n+    });\n+\n+    it('is correct for nested ICUs', () => {\n+      expectFromHtml(\n+          '<span i18n>{item.var, plural, other { {{item.placeholder}} {nestedVar, plural, other { {{nestedPlaceholder}} }}} }</span>')\n+          .toEqual([\n+            [\n+              'Element',\n+              '<span i18n>{item.var, plural, other { {{item.placeholder}} {nestedVar, plural, other { {{nestedPlaceholder}} }}} }</span>',\n+              '<span i18n>', '</span>'\n+            ],\n+            [\n+              'Icu',\n+              '{item.var, plural, other { {{item.placeholder}} {nestedVar, plural, other { {{nestedPlaceholder}} }}} }'\n+            ],\n+            ['Icu:Var', 'nestedVar'],\n+            ['Icu:Var', 'item.var'],\n+            ['Icu:Placeholder', '{{item.placeholder}}'],\n+            ['Icu:Placeholder', '{{nestedPlaceholder}}'],\n+          ]);\n+    });\n+  });\n });"
        },
        {
            "sha": "a0af48ba91e00335025100cd8816cde95ea90af3",
            "filename": "packages/compiler/test/render3/util/expression.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Ftest%2Frender3%2Futil%2Fexpression.ts",
            "raw_url": "https://github.com/angular/angular/raw/4b06ef75aa5f3438ff9fe533c0370f530ecc2e97/packages%2Fcompiler%2Ftest%2Frender3%2Futil%2Fexpression.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Futil%2Fexpression.ts?ref=4b06ef75aa5f3438ff9fe533c0370f530ecc2e97",
            "patch": "@@ -141,7 +141,14 @@ class ExpressionSourceHumanizer extends e.RecursiveAstVisitor implements t.Visit\n   }\n   visitContent(ast: t.Content) {}\n   visitText(ast: t.Text) {}\n-  visitIcu(ast: t.Icu) {}\n+  visitIcu(ast: t.Icu) {\n+    for (const key of Object.keys(ast.vars)) {\n+      ast.vars[key].visit(this);\n+    }\n+    for (const key of Object.keys(ast.placeholders)) {\n+      ast.placeholders[key].visit(this);\n+    }\n+  }\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 196,
        "additions": 169,
        "deletions": 27
    }
}