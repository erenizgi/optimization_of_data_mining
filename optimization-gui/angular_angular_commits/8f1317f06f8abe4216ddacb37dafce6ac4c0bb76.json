{
    "author": "kyliau",
    "message": "fix(language-service): [Ivy] create compiler only when program changes (#39231)\n\nThis commit fixes a bug in which a new Ivy Compiler is created every time\nlanguage service receives a new request. This is not needed if the\n`ts.Program` has not changed.\n\nA new class `CompilerFactory` is created to manage Compiler lifecycle and\nkeep track of template changes so that it knows when to override them.\nWith this change, we no longer need the method `getModifiedResourceFile()`\non the adapter. Instead, we call `overrideComponentTemplate` on the\ntemplate type checker.\n\nThis commit also changes the incremental build strategy from\n`PatchedIncrementalBuildStrategy` to `TrackedIncrementalBuildStrategy`.\n\nPR Close #39231",
    "sha": "8f1317f06f8abe4216ddacb37dafce6ac4c0bb76",
    "files": [
        {
            "sha": "8875018139da3334dd701bf83aeb8aeacb36d507",
            "filename": "packages/language-service/ivy/compiler_factory.ts",
            "status": "added",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/angular/angular/blob/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts?ref=8f1317f06f8abe4216ddacb37dafce6ac4c0bb76",
            "patch": "@@ -0,0 +1,75 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n+import {NgCompilerOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n+import {TrackedIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/incremental';\n+import {TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import * as ts from 'typescript/lib/tsserverlibrary';\n+\n+import {isExternalTemplate, LanguageServiceAdapter} from './language_service_adapter';\n+\n+export class CompilerFactory {\n+  private readonly incrementalStrategy = new TrackedIncrementalBuildStrategy();\n+  private compiler: NgCompiler|null = null;\n+  private lastKnownProgram: ts.Program|null = null;\n+\n+  constructor(\n+      private readonly adapter: LanguageServiceAdapter,\n+      private readonly programStrategy: TypeCheckingProgramStrategy,\n+  ) {}\n+\n+  /**\n+   * Create a new instance of the Ivy compiler if the program has changed since\n+   * the last time the compiler was instantiated. If the program has not changed,\n+   * return the existing instance.\n+   * @param fileName override the template if this is an external template file\n+   * @param options angular compiler options\n+   */\n+  getOrCreateWithChangedFile(fileName: string, options: NgCompilerOptions): NgCompiler {\n+    const program = this.programStrategy.getProgram();\n+    if (!this.compiler || program !== this.lastKnownProgram) {\n+      this.compiler = new NgCompiler(\n+          this.adapter,  // like compiler host\n+          options,       // angular compiler options\n+          program,\n+          this.programStrategy,\n+          this.incrementalStrategy,\n+          true,  // enableTemplateTypeChecker\n+          this.lastKnownProgram,\n+          undefined,  // perfRecorder (use default)\n+      );\n+      this.lastKnownProgram = program;\n+    }\n+    if (isExternalTemplate(fileName)) {\n+      this.overrideTemplate(fileName, this.compiler);\n+    }\n+    return this.compiler;\n+  }\n+\n+  private overrideTemplate(fileName: string, compiler: NgCompiler) {\n+    if (!this.adapter.isTemplateDirty(fileName)) {\n+      return;\n+    }\n+    // 1. Get the latest snapshot\n+    const latestTemplate = this.adapter.readResource(fileName);\n+    // 2. Find all components that use the template\n+    const ttc = compiler.getTemplateTypeChecker();\n+    const components = compiler.getComponentsWithTemplateFile(fileName);\n+    // 3. Update component template\n+    for (const component of components) {\n+      if (ts.isClassDeclaration(component)) {\n+        ttc.overrideComponentTemplate(component, latestTemplate);\n+      }\n+    }\n+  }\n+\n+  registerLastKnownProgram() {\n+    this.lastKnownProgram = this.programStrategy.getProgram();\n+  }\n+}"
        },
        {
            "sha": "7e6c6534fe2a2663d36b55033a7153263db3c60e",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 37,
            "changes": 57,
            "blob_url": "https://github.com/angular/angular/blob/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=8f1317f06f8abe4216ddacb37dafce6ac4c0bb76",
            "patch": "@@ -9,34 +9,35 @@\n import {CompilerOptions, createNgCompilerOptions} from '@angular/compiler-cli';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n-import {PatchedProgramIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/incremental';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n+import {CompilerFactory} from './compiler_factory';\n import {DefinitionBuilder} from './definitions';\n import {isExternalTemplate, isTypeScriptFile, LanguageServiceAdapter} from './language_service_adapter';\n import {QuickInfoBuilder} from './quick_info';\n \n export class LanguageService {\n   private options: CompilerOptions;\n-  private lastKnownProgram: ts.Program|null = null;\n+  private readonly compilerFactory: CompilerFactory;\n   private readonly strategy: TypeCheckingProgramStrategy;\n   private readonly adapter: LanguageServiceAdapter;\n \n   constructor(project: ts.server.Project, private readonly tsLS: ts.LanguageService) {\n     this.options = parseNgCompilerOptions(project);\n     this.strategy = createTypeCheckingProgramStrategy(project);\n     this.adapter = new LanguageServiceAdapter(project);\n+    this.compilerFactory = new CompilerFactory(this.adapter, this.strategy);\n     this.watchConfigFile(project);\n   }\n \n   getSemanticDiagnostics(fileName: string): ts.Diagnostic[] {\n-    const program = this.strategy.getProgram();\n-    const compiler = this.createCompiler(program, fileName);\n+    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n     const ttc = compiler.getTemplateTypeChecker();\n     const diagnostics: ts.Diagnostic[] = [];\n     if (isTypeScriptFile(fileName)) {\n+      const program = compiler.getNextProgram();\n       const sourceFile = program.getSourceFile(fileName);\n       if (sourceFile) {\n         diagnostics.push(...ttc.getDiagnosticsForFile(sourceFile, OptimizeFor.SingleFile));\n@@ -49,51 +50,33 @@ export class LanguageService {\n         }\n       }\n     }\n-    this.lastKnownProgram = compiler.getNextProgram();\n+    this.compilerFactory.registerLastKnownProgram();\n     return diagnostics;\n   }\n \n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n-    const program = this.strategy.getProgram();\n-    const compiler = this.createCompiler(program, fileName);\n-    return new DefinitionBuilder(this.tsLS, compiler).getDefinitionAndBoundSpan(fileName, position);\n+    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n+    const results =\n+        new DefinitionBuilder(this.tsLS, compiler).getDefinitionAndBoundSpan(fileName, position);\n+    this.compilerFactory.registerLastKnownProgram();\n+    return results;\n   }\n \n   getTypeDefinitionAtPosition(fileName: string, position: number):\n       readonly ts.DefinitionInfo[]|undefined {\n-    const program = this.strategy.getProgram();\n-    const compiler = this.createCompiler(program, fileName);\n-    return new DefinitionBuilder(this.tsLS, compiler)\n-        .getTypeDefinitionsAtPosition(fileName, position);\n+    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n+    const results =\n+        new DefinitionBuilder(this.tsLS, compiler).getTypeDefinitionsAtPosition(fileName, position);\n+    this.compilerFactory.registerLastKnownProgram();\n+    return results;\n   }\n \n   getQuickInfoAtPosition(fileName: string, position: number): ts.QuickInfo|undefined {\n-    const program = this.strategy.getProgram();\n-    const compiler = this.createCompiler(program, fileName);\n-    return new QuickInfoBuilder(this.tsLS, compiler).get(fileName, position);\n-  }\n-\n-  /**\n-   * Create a new instance of Ivy compiler.\n-   * If the specified `fileName` refers to an external template, check if it has\n-   * changed since the last time it was read. If it has changed, signal the\n-   * compiler to reload the file via the adapter.\n-   */\n-  private createCompiler(program: ts.Program, fileName: string): NgCompiler {\n-    if (isExternalTemplate(fileName)) {\n-      this.adapter.registerTemplateUpdate(fileName);\n-    }\n-    return new NgCompiler(\n-        this.adapter,\n-        this.options,\n-        program,\n-        this.strategy,\n-        new PatchedProgramIncrementalBuildStrategy(),\n-        /** enableTemplateTypeChecker */ true,\n-        this.lastKnownProgram,\n-        /** perfRecorder (use default) */ undefined,\n-    );\n+    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n+    const results = new QuickInfoBuilder(this.tsLS, compiler).get(fileName, position);\n+    this.compilerFactory.registerLastKnownProgram();\n+    return results;\n   }\n \n   private watchConfigFile(project: ts.server.Project) {"
        },
        {
            "sha": "0cff21179c93cb9844204bd2bcde4853e1a6fc2b",
            "filename": "packages/language-service/ivy/language_service_adapter.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 27,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts?ref=8f1317f06f8abe4216ddacb37dafce6ac4c0bb76",
            "patch": "@@ -19,7 +19,6 @@ export class LanguageServiceAdapter implements NgCompilerAdapter {\n   readonly unifiedModulesHost = null;  // only used in Bazel\n   readonly rootDirs: AbsoluteFsPath[];\n   private readonly templateVersion = new Map<string, string>();\n-  private readonly modifiedTemplates = new Set<string>();\n \n   constructor(private readonly project: ts.server.Project) {\n     this.rootDirs = project.getCompilationSettings().rootDirs?.map(absoluteFrom) || [];\n@@ -68,37 +67,13 @@ export class LanguageServiceAdapter implements NgCompilerAdapter {\n     }\n     const version = this.project.getScriptVersion(fileName);\n     this.templateVersion.set(fileName, version);\n-    this.modifiedTemplates.delete(fileName);\n     return snapshot.getText(0, snapshot.getLength());\n   }\n \n-  /**\n-   * getModifiedResourceFiles() is an Angular-specific method for notifying\n-   * the Angular compiler templates that have changed since it last read them.\n-   * It is a method on ExtendedTsCompilerHost, see\n-   * packages/compiler-cli/src/ngtsc/core/api/src/interfaces.ts\n-   */\n-  getModifiedResourceFiles(): Set<string> {\n-    return this.modifiedTemplates;\n-  }\n-\n-  /**\n-   * Check whether the specified `fileName` is newer than the last time it was\n-   * read. If it is newer, register it and return true, otherwise do nothing and\n-   * return false.\n-   * @param fileName path to external template\n-   */\n-  registerTemplateUpdate(fileName: string): boolean {\n-    if (!isExternalTemplate(fileName)) {\n-      return false;\n-    }\n+  isTemplateDirty(fileName: string): boolean {\n     const lastVersion = this.templateVersion.get(fileName);\n     const latestVersion = this.project.getScriptVersion(fileName);\n-    if (lastVersion !== latestVersion) {\n-      this.modifiedTemplates.add(fileName);\n-      return true;\n-    }\n-    return false;\n+    return lastVersion !== latestVersion;\n   }\n }\n "
        },
        {
            "sha": "c57abe5c00e77b3162b7153c5e4af8522c8843b2",
            "filename": "packages/language-service/ivy/test/compiler_factory_spec.ts",
            "status": "added",
            "additions": 78,
            "deletions": 0,
            "changes": 78,
            "blob_url": "https://github.com/angular/angular/blob/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_factory_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_factory_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_factory_spec.ts?ref=8f1317f06f8abe4216ddacb37dafce6ac4c0bb76",
            "patch": "@@ -0,0 +1,78 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {APP_COMPONENT, setup, TEST_TEMPLATE} from './mock_host';\n+\n+const {project, service} = setup();\n+\n+/**\n+ * The following specs do not directly test the CompilerFactory class, rather\n+ * it asserts our understanding of the project/program/template interaction\n+ * which forms the underlying assumption used in the CompilerFactory.\n+ */\n+\n+describe('tsserver', () => {\n+  beforeEach(() => {\n+    service.reset();\n+  });\n+\n+  describe('project version', () => {\n+    it('is updated after TS changes', () => {\n+      const v0 = project.getProjectVersion();\n+      service.overwriteInlineTemplate(APP_COMPONENT, `{{ foo }}`);\n+      const v1 = project.getProjectVersion();\n+      expect(v1).not.toBe(v0);\n+    });\n+\n+    it('is updated after template changes', () => {\n+      const v0 = project.getProjectVersion();\n+      service.overwrite(TEST_TEMPLATE, `{{ bar }}`);\n+      const v1 = project.getProjectVersion();\n+      expect(v1).not.toBe(v0);\n+    });\n+  });\n+\n+  describe('program', () => {\n+    it('is updated after TS changes', () => {\n+      const p0 = project.getLanguageService().getProgram();\n+      expect(p0).toBeDefined();\n+      service.overwriteInlineTemplate(APP_COMPONENT, `{{ foo }}`);\n+      const p1 = project.getLanguageService().getProgram();\n+      expect(p1).not.toBe(p0);\n+    });\n+\n+    it('is not updated after template changes', () => {\n+      const p0 = project.getLanguageService().getProgram();\n+      expect(p0).toBeDefined();\n+      service.overwrite(TEST_TEMPLATE, `{{ bar }}`);\n+      const p1 = project.getLanguageService().getProgram();\n+      expect(p1).toBe(p0);\n+    });\n+  });\n+\n+  describe('external template', () => {\n+    it('should not be part of the project root', () => {\n+      // Templates should _never_ be added to the project root, otherwise they\n+      // will be parsed as TS files.\n+      const scriptInfo = service.getScriptInfo(TEST_TEMPLATE);\n+      expect(project.isRoot(scriptInfo)).toBeFalse();\n+    });\n+\n+    it('should be attached to project', () => {\n+      const scriptInfo = service.getScriptInfo(TEST_TEMPLATE);\n+      // Script info for external template must be attached to a project because\n+      // that's the primary mechanism used in the extension to locate the right\n+      // language service instance. See\n+      // https://github.com/angular/vscode-ng-language-service/blob/b048f5f6b9996c5cf113b764c7ffe13d9eeb4285/server/src/session.ts#L192\n+      expect(scriptInfo.isAttached(project)).toBeTrue();\n+      // Attaching a script info to a project does not mean that the project\n+      // will contain the script info. Kinda like friendship on social media.\n+      expect(project.containsScriptInfo(scriptInfo)).toBeFalse();\n+    });\n+  });\n+});"
        },
        {
            "sha": "22a76cea12917b260808361ea72c05b12602bfb6",
            "filename": "packages/language-service/ivy/test/language_service_adapter_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 24,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Ftest%2Flanguage_service_adapter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Ftest%2Flanguage_service_adapter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flanguage_service_adapter_spec.ts?ref=8f1317f06f8abe4216ddacb37dafce6ac4c0bb76",
            "patch": "@@ -12,38 +12,20 @@ import {setup, TEST_TEMPLATE} from './mock_host';\n const {project, service} = setup();\n \n describe('Language service adapter', () => {\n-  it('should register update if it has not seen the template before', () => {\n+  it('should mark template dirty if it has not seen the template before', () => {\n     const adapter = new LanguageServiceAdapter(project);\n-    // Note that readResource() has never been called, so the adapter has no\n-    // knowledge of the template at all.\n-    const isRegistered = adapter.registerTemplateUpdate(TEST_TEMPLATE);\n-    expect(isRegistered).toBeTrue();\n-    expect(adapter.getModifiedResourceFiles().size).toBe(1);\n+    expect(adapter.isTemplateDirty(TEST_TEMPLATE)).toBeTrue();\n   });\n \n-  it('should not register update if template has not changed', () => {\n+  it('should not mark template dirty if template has not changed', () => {\n     const adapter = new LanguageServiceAdapter(project);\n     adapter.readResource(TEST_TEMPLATE);\n-    const isRegistered = adapter.registerTemplateUpdate(TEST_TEMPLATE);\n-    expect(isRegistered).toBeFalse();\n-    expect(adapter.getModifiedResourceFiles().size).toBe(0);\n+    expect(adapter.isTemplateDirty(TEST_TEMPLATE)).toBeFalse();\n   });\n \n-  it('should register update if template has changed', () => {\n+  it('should mark template dirty if template has changed', () => {\n     const adapter = new LanguageServiceAdapter(project);\n-    adapter.readResource(TEST_TEMPLATE);\n     service.overwrite(TEST_TEMPLATE, '<p>Hello World</p>');\n-    const isRegistered = adapter.registerTemplateUpdate(TEST_TEMPLATE);\n-    expect(isRegistered).toBe(true);\n-    expect(adapter.getModifiedResourceFiles().size).toBe(1);\n-  });\n-\n-  it('should clear template updates on read', () => {\n-    const adapter = new LanguageServiceAdapter(project);\n-    const isRegistered = adapter.registerTemplateUpdate(TEST_TEMPLATE);\n-    expect(isRegistered).toBeTrue();\n-    expect(adapter.getModifiedResourceFiles().size).toBe(1);\n-    adapter.readResource(TEST_TEMPLATE);\n-    expect(adapter.getModifiedResourceFiles().size).toBe(0);\n+    expect(adapter.isTemplateDirty(TEST_TEMPLATE)).toBeTrue();\n   });\n });"
        },
        {
            "sha": "3afb16ae799ed8b002c964dd87be3234db5eb0f8",
            "filename": "packages/language-service/ivy/test/language_service_spec.ts",
            "status": "modified",
            "additions": 91,
            "deletions": 3,
            "changes": 94,
            "blob_url": "https://github.com/angular/angular/blob/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Ftest%2Flanguage_service_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Ftest%2Flanguage_service_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flanguage_service_spec.ts?ref=8f1317f06f8abe4216ddacb37dafce6ac4c0bb76",
            "patch": "@@ -6,11 +6,11 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {parseNgCompilerOptions} from '../language_service';\n+import {LanguageService, parseNgCompilerOptions} from '../language_service';\n \n-import {setup} from './mock_host';\n+import {setup, TEST_TEMPLATE} from './mock_host';\n \n-const {project} = setup();\n+const {project, tsLS, service} = setup();\n \n describe('parseNgCompilerOptions', () => {\n   it('should read angularCompilerOptions in tsconfig.json', () => {\n@@ -22,3 +22,91 @@ describe('parseNgCompilerOptions', () => {\n     }));\n   });\n });\n+\n+describe('last known program', () => {\n+  const ngLS = new LanguageService(project, tsLS);\n+\n+  beforeEach(() => {\n+    service.reset();\n+  });\n+\n+  it('should be set after getSemanticDiagnostics()', () => {\n+    const d0 = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n+    expect(d0.length).toBe(0);\n+    const p0 = getLastKnownProgram(ngLS);\n+\n+    const d1 = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n+    expect(d1.length).toBe(0);\n+    const p1 = getLastKnownProgram(ngLS);\n+    expect(p1).toBe(p0);  // last known program should not have changed\n+\n+    service.overwrite(TEST_TEMPLATE, `<test-c¦omp></test-comp>`);\n+    const d2 = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n+    expect(d2.length).toBe(0);\n+    const p2 = getLastKnownProgram(ngLS);\n+    expect(p2).not.toBe(p1);  // last known program should have changed\n+  });\n+\n+  it('should be set after getDefinitionAndBoundSpan()', () => {\n+    const {position: pos0} = service.overwrite(TEST_TEMPLATE, `<test-c¦omp></test-comp>`);\n+\n+    const d0 = ngLS.getDefinitionAndBoundSpan(TEST_TEMPLATE, pos0);\n+    expect(d0).toBeDefined();\n+    const p0 = getLastKnownProgram(ngLS);\n+\n+    const d1 = ngLS.getDefinitionAndBoundSpan(TEST_TEMPLATE, pos0);\n+    expect(d1).toBeDefined();\n+    const p1 = getLastKnownProgram(ngLS);\n+    expect(p1).toBe(p0);  // last known program should not have changed\n+\n+    const {position: pos1} = service.overwrite(TEST_TEMPLATE, `{{ ti¦tle }}`);\n+    const d2 = ngLS.getDefinitionAndBoundSpan(TEST_TEMPLATE, pos1);\n+    expect(d2).toBeDefined();\n+    const p2 = getLastKnownProgram(ngLS);\n+    expect(p2).not.toBe(p1);  // last known program should have changed\n+  });\n+\n+  it('should be set after getQuickInfoAtPosition()', () => {\n+    const {position: pos0} = service.overwrite(TEST_TEMPLATE, `<test-c¦omp></test-comp>`);\n+\n+    const q0 = ngLS.getQuickInfoAtPosition(TEST_TEMPLATE, pos0);\n+    expect(q0).toBeDefined();\n+    const p0 = getLastKnownProgram(ngLS);\n+\n+    const q1 = ngLS.getQuickInfoAtPosition(TEST_TEMPLATE, pos0);\n+    expect(q1).toBeDefined();\n+    const p1 = getLastKnownProgram(ngLS);\n+    expect(p1).toBe(p0);  // last known program should not have changed\n+\n+    const {position: pos1} = service.overwrite(TEST_TEMPLATE, `{{ ti¦tle }}`);\n+    const q2 = ngLS.getQuickInfoAtPosition(TEST_TEMPLATE, pos1);\n+    expect(q2).toBeDefined();\n+    const p2 = getLastKnownProgram(ngLS);\n+    expect(p2).not.toBe(p1);  // last known program should have changed\n+  });\n+\n+  it('should be set after getTypeDefinitionAtPosition()', () => {\n+    const {position: pos0} = service.overwrite(TEST_TEMPLATE, `<test-c¦omp></test-comp>`);\n+\n+    const q0 = ngLS.getTypeDefinitionAtPosition(TEST_TEMPLATE, pos0);\n+    expect(q0).toBeDefined();\n+    const p0 = getLastKnownProgram(ngLS);\n+\n+    const d1 = ngLS.getTypeDefinitionAtPosition(TEST_TEMPLATE, pos0);\n+    expect(d1).toBeDefined();\n+    const p1 = getLastKnownProgram(ngLS);\n+    expect(p1).toBe(p0);  // last known program should not have changed\n+\n+    const {position: pos1} = service.overwrite(TEST_TEMPLATE, `{{ ti¦tle }}`);\n+    const d2 = ngLS.getTypeDefinitionAtPosition(TEST_TEMPLATE, pos1);\n+    expect(d2).toBeDefined();\n+    const p2 = getLastKnownProgram(ngLS);\n+    expect(p2).not.toBe(p1);  // last known program should have changed\n+  });\n+});\n+\n+function getLastKnownProgram(ngLS: LanguageService): ts.Program {\n+  const program = ngLS['compilerFactory']['lastKnownProgram'];\n+  expect(program).toBeDefined();\n+  return program!;\n+}"
        },
        {
            "sha": "f620d74d9d53d2de7217d2a2465becbd8d51dcf8",
            "filename": "packages/language-service/ivy/test/mock_host.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f1317f06f8abe4216ddacb37dafce6ac4c0bb76/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts?ref=8f1317f06f8abe4216ddacb37dafce6ac4c0bb76",
            "patch": "@@ -158,6 +158,8 @@ export class MockService {\n       }\n     }\n     this.overwritten.clear();\n+    // updateGraph() will clear the internal dirty flag.\n+    this.project.updateGraph();\n   }\n \n   getScriptInfo(fileName: string): ts.server.ScriptInfo {\n@@ -179,6 +181,7 @@ export class MockService {\n     if (!newScriptInfo) {\n       throw new Error(`Failed to create new script info for ${fileName}`);\n     }\n+    newScriptInfo.attachToProject(this.project);\n     return newScriptInfo;\n   }\n "
        }
    ],
    "stats": {
        "total": 366,
        "additions": 275,
        "deletions": 91
    }
}