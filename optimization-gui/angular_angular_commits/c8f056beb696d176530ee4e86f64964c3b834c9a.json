{
    "author": "adrianrutkowski",
    "message": "fix(core): ensure TestBed is not instantiated before override provider (#38717)\n\nThere is an inconsistency in overrideProvider behaviour. Testing documentation says\n(https://angular.io/guide/testing-components-basics#createcomponent) that all override...\nmethods throw error if TestBed is already instantiated. However overrideProvider doesn't throw any error, but (same as\nother override... methods) doesn't replace providers if TestBed is instantiated. Add TestBed instantiation check to\noverrideProvider method to make it consistent.\n\nBREAKING CHANGE:\n\nIf you call `TestBed.overrideProvider` after TestBed initialization, provider overrides are not applied. This\nbehavior is consistent with other override methods (such as `TestBed.overrideDirective`, etc) but they\nthrow an error to indicate that, when the check was missing in the `TestBed.overrideProvider` function.\nNow calling `TestBed.overrideProvider` after TestBed initialization also triggers an\nerror, thus there is a chance that some tests (where `TestBed.overrideProvider` is\ncalled after TestBed initialization) will start to fail and require updates to move `TestBed.overrideProvider` calls\nbefore TestBed initialization is completed.\n\nIssue mentioned here: https://github.com/angular/angular/issues/13460#issuecomment-636005966\nDocumentation: https://angular.io/guide/testing-components-basics#createcomponent\n\nPR Close #38717",
    "sha": "c8f056beb696d176530ee4e86f64964c3b834c9a",
    "files": [
        {
            "sha": "74804de7d68512ce2096bf8b3f30888137a98618",
            "filename": "packages/core/testing/src/r3_test_bed.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c8f056beb696d176530ee4e86f64964c3b834c9a/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed.ts",
            "raw_url": "https://github.com/angular/angular/raw/c8f056beb696d176530ee4e86f64964c3b834c9a/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed.ts?ref=c8f056beb696d176530ee4e86f64964c3b834c9a",
            "patch": "@@ -327,6 +327,7 @@ export class TestBedRender3 implements TestBed {\n    */\n   overrideProvider(token: any, provider: {useFactory?: Function, useValue?: any, deps?: any[]}):\n       void {\n+    this.assertNotInstantiated('overrideProvider', 'override provider');\n     this.compiler.overrideProvider(token, provider);\n   }\n "
        },
        {
            "sha": "5a40de6703031dc9fe469a547c8e4f6834140db6",
            "filename": "packages/core/testing/src/test_bed.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c8f056beb696d176530ee4e86f64964c3b834c9a/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed.ts",
            "raw_url": "https://github.com/angular/angular/raw/c8f056beb696d176530ee4e86f64964c3b834c9a/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed.ts?ref=c8f056beb696d176530ee4e86f64964c3b834c9a",
            "patch": "@@ -535,6 +535,7 @@ export class TestBedViewEngine implements TestBed {\n   overrideProvider(token: any, provider: {useValue: any;}): void;\n   overrideProvider(token: any, provider: {useFactory?: Function, useValue?: any, deps?: any[]}):\n       void {\n+    this._assertNotInstantiated('overrideProvider', 'override provider');\n     this.overrideProviderImpl(token, provider);\n   }\n "
        },
        {
            "sha": "bb6fa0e575ed6fe00c76403ed4b152ac32e8d593",
            "filename": "packages/platform-browser/test/testing_public_spec.ts",
            "status": "modified",
            "additions": 64,
            "deletions": 12,
            "changes": 76,
            "blob_url": "https://github.com/angular/angular/blob/c8f056beb696d176530ee4e86f64964c3b834c9a/packages%2Fplatform-browser%2Ftest%2Ftesting_public_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c8f056beb696d176530ee4e86f64964c3b834c9a/packages%2Fplatform-browser%2Ftest%2Ftesting_public_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Ftest%2Ftesting_public_spec.ts?ref=c8f056beb696d176530ee4e86f64964c3b834c9a",
            "patch": "@@ -774,18 +774,6 @@ const bTok = new InjectionToken<string>('b');\n           expect(testDir!.test).toBe('some prop');\n         });\n \n-        it('should throw if the TestBed is already created', () => {\n-          @Component({selector: 'comp', template: 'a'})\n-          class MyComponent {\n-          }\n-\n-          TestBed.inject(Injector);\n-\n-          expect(() => TestBed.overrideTemplateUsingTestingModule(MyComponent, 'b'))\n-              .toThrowError(\n-                  /Cannot override template when the test module has already been instantiated/);\n-        });\n-\n         it('should reset overrides when the testing module is resetted', () => {\n           @Component({selector: 'comp', template: 'a'})\n           class MyComponent {\n@@ -1071,5 +1059,69 @@ Did you run and wait for 'resolveComponentResources()'?` :\n            expect(componentFixture.nativeElement).toHaveText('Parent(Mock)');\n          }));\n     });\n+\n+    describe('calling override methods after TestBed initialization', () => {\n+      const getExpectedErrorMessage = (methodName: string, methodDescription: string) => `Cannot ${\n+          methodDescription} when the test module has already been instantiated. Make sure you are not using \\`inject\\` before \\`${\n+          methodName}\\`.`;\n+\n+      it('should throw if TestBed.overrideProvider is called after TestBed initialization', () => {\n+        TestBed.inject(Injector);\n+\n+        expect(() => TestBed.overrideProvider(aTok, {\n+          useValue: 'mockValue'\n+        })).toThrowError(getExpectedErrorMessage('overrideProvider', 'override provider'));\n+      });\n+\n+      it('should throw if TestBed.overrideModule is called after TestBed initialization', () => {\n+        @NgModule()\n+        class MyModule {\n+        }\n+\n+        TestBed.inject(Injector);\n+\n+        expect(() => TestBed.overrideModule(MyModule, {}))\n+            .toThrowError(getExpectedErrorMessage('overrideModule', 'override module metadata'));\n+      });\n+\n+      it('should throw if TestBed.overridePipe is called after TestBed initialization', () => {\n+        @Pipe({name: 'myPipe'})\n+        class MyPipe {\n+          transform(value: any) {\n+            return value;\n+          }\n+        }\n+\n+        TestBed.inject(Injector);\n+\n+        expect(() => TestBed.overridePipe(MyPipe, {}))\n+            .toThrowError(getExpectedErrorMessage('overridePipe', 'override pipe metadata'));\n+      });\n+\n+      it('should throw if TestBed.overrideDirective is called after TestBed initialization', () => {\n+        @Directive()\n+        class MyDirective {\n+        }\n+\n+        TestBed.inject(Injector);\n+\n+        expect(() => TestBed.overrideDirective(MyDirective, {}))\n+            .toThrowError(\n+                getExpectedErrorMessage('overrideDirective', 'override directive metadata'));\n+      });\n+\n+      it('should throw if TestBed.overrideTemplateUsingTestingModule is called after TestBed initialization',\n+         () => {\n+           @Component({selector: 'comp', template: 'a'})\n+           class MyComponent {\n+           }\n+\n+           TestBed.inject(Injector);\n+\n+           expect(() => TestBed.overrideTemplateUsingTestingModule(MyComponent, 'b'))\n+               .toThrowError(\n+                   /Cannot override template when the test module has already been instantiated/);\n+         });\n+    });\n   });\n }"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 66,
        "deletions": 12
    }
}