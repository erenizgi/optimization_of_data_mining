{
    "author": "JoostK",
    "message": "fix(compiler-cli): ensure that a declaration is available in type-to-value conversion (#38684)\n\nThe type-to-value conversion could previously crash if a symbol was\nresolved that does not have any declarations, e.g. because it's imported\nfrom a missing module. This would typically result in a semantic\nTypeScript diagnostic and halt further compilation, therefore not\nreaching the type-to-value conversion logic. In Bazel however, it turns\nout that Angular semantic diagnostics are requested even if there are\nsemantic TypeScript errors in the program, so it would then reach the\ntype-to-value conversation and crash.\n\nThis commit fixes the unsafe access and adds a test that ignores the\nTypeScript semantic error, effectively replicating the situation as\nexperienced under Bazel.\n\nFixes #38670\n\nPR Close #38684",
    "sha": "a32a317ea14f7ff9c81eb027b3d4dd36484efde5",
    "files": [
        {
            "sha": "4d52eb6b805c3fdacf64ddb1436c83bd510d4d52",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/util.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a32a317ea14f7ff9c81eb027b3d4dd36484efde5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/a32a317ea14f7ff9c81eb027b3d4dd36484efde5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts?ref=a32a317ea14f7ff9c81eb027b3d4dd36484efde5",
            "patch": "@@ -215,8 +215,10 @@ function createUnsuitableInjectionTokenError(\n         makeRelatedInformation(\n             reason.typeNode,\n             'This type does not have a value, so it cannot be used as injection token.'),\n-        makeRelatedInformation(reason.decl, 'The type is declared here.'),\n       ];\n+      if (reason.decl !== null) {\n+        hints.push(makeRelatedInformation(reason.decl, 'The type is declared here.'));\n+      }\n       break;\n     case ValueUnavailableKind.TYPE_ONLY_IMPORT:\n       chainMessage ="
        },
        {
            "sha": "8ad56ce32c75b91cdcc7a9be4ac7e65968d276c3",
            "filename": "packages/compiler-cli/src/ngtsc/reflection/src/host.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a32a317ea14f7ff9c81eb027b3d4dd36484efde5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Fhost.ts",
            "raw_url": "https://github.com/angular/angular/raw/a32a317ea14f7ff9c81eb027b3d4dd36484efde5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Fhost.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Fhost.ts?ref=a32a317ea14f7ff9c81eb027b3d4dd36484efde5",
            "patch": "@@ -336,7 +336,7 @@ export interface UnsupportedType {\n export interface NoValueDeclaration {\n   kind: ValueUnavailableKind.NO_VALUE_DECLARATION;\n   typeNode: ts.TypeNode;\n-  decl: ts.Declaration;\n+  decl: ts.Declaration|null;\n }\n \n export interface TypeOnlyImport {"
        },
        {
            "sha": "bfacb8987e6ae6fb7be8767c4789f8bb52ec112f",
            "filename": "packages/compiler-cli/src/ngtsc/reflection/src/type_to_value.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/a32a317ea14f7ff9c81eb027b3d4dd36484efde5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftype_to_value.ts",
            "raw_url": "https://github.com/angular/angular/raw/a32a317ea14f7ff9c81eb027b3d4dd36484efde5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftype_to_value.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftype_to_value.ts?ref=a32a317ea14f7ff9c81eb027b3d4dd36484efde5",
            "patch": "@@ -38,7 +38,11 @@ export function typeToValue(\n   // has a value declaration associated with it. Note that const enums are an exception,\n   // because while they do have a value declaration, they don't exist at runtime.\n   if (decl.valueDeclaration === undefined || decl.flags & ts.SymbolFlags.ConstEnum) {\n-    return noValueDeclaration(typeNode, decl.declarations[0]);\n+    let typeOnlyDecl: ts.Declaration|null = null;\n+    if (decl.declarations !== undefined && decl.declarations.length > 0) {\n+      typeOnlyDecl = decl.declarations[0];\n+    }\n+    return noValueDeclaration(typeNode, typeOnlyDecl);\n   }\n \n   // The type points to a valid value declaration. Rewrite the TypeReference into an\n@@ -140,7 +144,7 @@ function unsupportedType(typeNode: ts.TypeNode): UnavailableTypeValueReference {\n }\n \n function noValueDeclaration(\n-    typeNode: ts.TypeNode, decl: ts.Declaration): UnavailableTypeValueReference {\n+    typeNode: ts.TypeNode, decl: ts.Declaration|null): UnavailableTypeValueReference {\n   return {\n     kind: TypeValueReferenceKind.UNAVAILABLE,\n     reason: {kind: ValueUnavailableKind.NO_VALUE_DECLARATION, typeNode, decl},"
        },
        {
            "sha": "3fc856389f421aaef77dce6716924cd4581f96bf",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/a32a317ea14f7ff9c81eb027b3d4dd36484efde5/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a32a317ea14f7ff9c81eb027b3d4dd36484efde5/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=a32a317ea14f7ff9c81eb027b3d4dd36484efde5",
            "patch": "@@ -2214,6 +2214,35 @@ runInEachFileSystem(os => {\n           expect(diags[0].relatedInformation![1].messageText).toBe('The type is declared here.');\n         });\n \n+        it('should report an error when using a missing type as injection token', () => {\n+          // This test replicates the situation where a symbol does not have any declarations at\n+          // all, e.g. because it's imported from a missing module. This would result in a\n+          // semantic TypeScript diagnostic which we ignore in this test to verify that ngtsc's\n+          // analysis is able to operate in this situation.\n+          env.tsconfig({strictInjectionParameters: true});\n+          env.write(`test.ts`, `\n+             import {Injectable} from '@angular/core';\n+             // @ts-expect-error\n+             import {Interface} from 'missing';\n+\n+             @Injectable()\n+             export class MyService {\n+               constructor(param: Interface) {}\n+             }\n+          `);\n+\n+          const diags = env.driveDiagnostics();\n+          expect(diags.length).toBe(1);\n+          expect(ts.flattenDiagnosticMessageText(diags[0].messageText, '\\n'))\n+              .toBe(\n+                  `No suitable injection token for parameter 'param' of ` +\n+                  `class 'MyService'.\\n` +\n+                  `  Consider using the @Inject decorator to specify an injection token.`);\n+          expect(diags[0].relatedInformation!.length).toBe(1);\n+          expect(diags[0].relatedInformation![0].messageText)\n+              .toBe('This type does not have a value, so it cannot be used as injection token.');\n+        });\n+\n         it('should report an error when no type is present', () => {\n           env.tsconfig({strictInjectionParameters: true, noImplicitAny: false});\n           env.write(`test.ts`, `"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 39,
        "deletions": 4
    }
}