{
    "author": "waterplea",
    "message": "fix(core): fix multiple nested views removal from ViewContainerRef (#38317)\n\nWhen removal of one view causes removal of another one from the same\nViewContainerRef it triggers an error with views length calculation. This commit\nfixes this bug by removing a view from the list of available views before invoking\nactual view removal (which might be recursive and relies on the length of the list\nof available views).\n\nFixes #38201.\n\nPR Close #38317",
    "sha": "b071495f9216324783a8c4daca077acf9850292e",
    "files": [
        {
            "sha": "1e0dba6d780fb6e5f9ccdc3b06fa2887b7d00833",
            "filename": "packages/core/src/render3/node_manipulation.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/b071495f9216324783a8c4daca077acf9850292e/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "raw_url": "https://github.com/angular/angular/raw/b071495f9216324783a8c4daca077acf9850292e/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts?ref=b071495f9216324783a8c4daca077acf9850292e",
            "patch": "@@ -349,17 +349,6 @@ export function detachView(lContainer: LContainer, removeIndex: number): LView|u\n   return viewToDetach;\n }\n \n-/**\n- * Removes a view from a container, i.e. detaches it and then destroys the underlying LView.\n- *\n- * @param lContainer The container from which to remove a view\n- * @param removeIndex The index of the view to remove\n- */\n-export function removeView(lContainer: LContainer, removeIndex: number) {\n-  const detachedView = detachView(lContainer, removeIndex);\n-  detachedView && destroyLView(detachedView[TVIEW], detachedView);\n-}\n-\n /**\n  * A standalone function which destroys an LView,\n  * conducting clean up (e.g. removing listeners, calling onDestroys)."
        },
        {
            "sha": "e1958ebf431873c3612081f1771159d124670d32",
            "filename": "packages/core/src/render3/view_engine_compatibility.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/b071495f9216324783a8c4daca077acf9850292e/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "raw_url": "https://github.com/angular/angular/raw/b071495f9216324783a8c4daca077acf9850292e/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts?ref=b071495f9216324783a8c4daca077acf9850292e",
            "patch": "@@ -22,12 +22,12 @@ import {assertLContainer} from './assert';\n import {getParentInjectorLocation, NodeInjector} from './di';\n import {addToViewTree, createLContainer, createLView, renderView} from './instructions/shared';\n import {CONTAINER_HEADER_OFFSET, LContainer, VIEW_REFS} from './interfaces/container';\n-import {TContainerNode, TDirectiveHostNode, TElementContainerNode, TElementNode, TNode, TNodeType, TViewNode} from './interfaces/node';\n+import {TContainerNode, TDirectiveHostNode, TElementContainerNode, TElementNode, TNode, TNodeType} from './interfaces/node';\n import {isProceduralRenderer, RComment, RElement} from './interfaces/renderer';\n import {isComponentHost, isLContainer, isLView, isRootView} from './interfaces/type_checks';\n import {DECLARATION_COMPONENT_VIEW, DECLARATION_LCONTAINER, LView, LViewFlags, PARENT, QUERIES, RENDERER, T_HOST, TVIEW, TView} from './interfaces/view';\n import {assertNodeOfPossibleTypes} from './node_assert';\n-import {addRemoveViewFromContainer, appendChild, detachView, getBeforeNodeForView, insertView, nativeInsertBefore, nativeNextSibling, nativeParentNode, removeView} from './node_manipulation';\n+import {addRemoveViewFromContainer, appendChild, destroyLView, detachView, getBeforeNodeForView, insertView, nativeInsertBefore, nativeNextSibling, nativeParentNode} from './node_manipulation';\n import {getParentInjectorTNode} from './node_util';\n import {getLView, getPreviousOrParentTNode} from './state';\n import {getParentInjectorView, hasParentInjector} from './util/injector_utils';\n@@ -304,8 +304,18 @@ export function createContainerRef(\n       remove(index?: number): void {\n         this.allocateContainerIfNeeded();\n         const adjustedIdx = this._adjustIndex(index, -1);\n-        removeView(this._lContainer, adjustedIdx);\n-        removeFromArray(this._lContainer[VIEW_REFS]!, adjustedIdx);\n+        const detachedView = detachView(this._lContainer, adjustedIdx);\n+\n+        if (detachedView) {\n+          // Before destroying the view, remove it from the container's array of `ViewRef`s.\n+          // This ensures the view container length is updated before calling\n+          // `destroyLView`, which could recursively call view container methods that\n+          // rely on an accurate container length.\n+          // (e.g. a method on this view container being called by a child directive's OnDestroy\n+          // lifecycle hook)\n+          removeFromArray(this._lContainer[VIEW_REFS]!, adjustedIdx);\n+          destroyLView(detachedView[TVIEW], detachedView);\n+        }\n       }\n \n       detach(index?: number): viewEngine_ViewRef|null {"
        },
        {
            "sha": "bc97b91aa2495ed01d70de4a2ea4355de355729c",
            "filename": "packages/core/test/acceptance/view_container_ref_spec.ts",
            "status": "modified",
            "additions": 57,
            "deletions": 1,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/b071495f9216324783a8c4daca077acf9850292e/packages%2Fcore%2Ftest%2Facceptance%2Fview_container_ref_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b071495f9216324783a8c4daca077acf9850292e/packages%2Fcore%2Ftest%2Facceptance%2Fview_container_ref_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fview_container_ref_spec.ts?ref=b071495f9216324783a8c4daca077acf9850292e",
            "patch": "@@ -8,7 +8,7 @@\n \n import {CommonModule, DOCUMENT} from '@angular/common';\n import {computeMsgId} from '@angular/compiler';\n-import {Compiler, Component, ComponentFactoryResolver, Directive, DoCheck, ElementRef, EmbeddedViewRef, ErrorHandler, Injector, NgModule, NO_ERRORS_SCHEMA, OnInit, Pipe, PipeTransform, QueryList, RendererFactory2, RendererType2, Sanitizer, TemplateRef, ViewChild, ViewChildren, ViewContainerRef, ɵsetDocument} from '@angular/core';\n+import {Compiler, Component, ComponentFactoryResolver, Directive, DoCheck, ElementRef, EmbeddedViewRef, ErrorHandler, Injector, NgModule, NO_ERRORS_SCHEMA, OnDestroy, OnInit, Pipe, PipeTransform, QueryList, RendererFactory2, RendererType2, Sanitizer, TemplateRef, ViewChild, ViewChildren, ViewContainerRef, ɵsetDocument} from '@angular/core';\n import {Input} from '@angular/core/src/metadata';\n import {ngDevModeResetPerfCounters} from '@angular/core/src/util/ng_dev_mode';\n import {TestBed, TestComponentRenderer} from '@angular/core/testing';\n@@ -936,6 +936,62 @@ describe('ViewContainerRef', () => {\n     });\n   });\n \n+  describe('dependant views', () => {\n+    it('should not throw when view removes another view upon removal', () => {\n+      @Component({\n+        template: `\n+          <div *ngIf=\"visible\" [template]=\"parent\">I host a template</div>\n+          <ng-template #parent>\n+              <div [template]=\"child\">I host a child template</div>\n+          </ng-template>\n+          <ng-template #child>\n+              I am child template\n+          </ng-template>\n+        `\n+      })\n+      class AppComponent {\n+        visible = true;\n+\n+        constructor(private readonly vcr: ViewContainerRef) {}\n+\n+        add<C>(template: TemplateRef<C>): EmbeddedViewRef<C> {\n+          return this.vcr.createEmbeddedView(template);\n+        }\n+\n+        remove<C>(viewRef: EmbeddedViewRef<C>) {\n+          this.vcr.remove(this.vcr.indexOf(viewRef));\n+        }\n+      }\n+\n+      @Directive({selector: '[template]'})\n+      class TemplateDirective<C> implements OnInit, OnDestroy {\n+        @Input() template !: TemplateRef<C>;\n+        ref!: EmbeddedViewRef<C>;\n+\n+        constructor(private readonly host: AppComponent) {}\n+\n+        ngOnInit() {\n+          this.ref = this.host.add(this.template);\n+          this.ref.detectChanges();\n+        }\n+\n+        ngOnDestroy() {\n+          this.host.remove(this.ref);\n+        }\n+      }\n+\n+      TestBed.configureTestingModule({\n+        imports: [CommonModule],\n+        declarations: [AppComponent, TemplateDirective],\n+      });\n+\n+      const fixture = TestBed.createComponent(AppComponent);\n+      fixture.detectChanges();\n+      fixture.componentRef.instance.visible = false;\n+      fixture.detectChanges();\n+    });\n+  });\n+\n   describe('createEmbeddedView (incl. insert)', () => {\n     it('should work on elements', () => {\n       @Component({"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 71,
        "deletions": 16
    }
}