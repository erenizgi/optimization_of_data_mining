{
    "author": "petebacondarwin",
    "message": "refactor(compiler): separate `compileFactoryFunction()` from `compileInjector()` (#41022)\n\nThis commit moves the creation of the injector's factory function\nout so that it can be more easily refactored further.\n\nPR Close #41022",
    "sha": "d04515cf537b1ce67b1f4b0da91a02e07def5186",
    "files": [
        {
            "sha": "fbb181a74351bb53aefd97d051fadb91155a9d1a",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/ng_module.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 10,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/d04515cf537b1ce67b1f4b0da91a02e07def5186/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/d04515cf537b1ce67b1f4b0da91a02e07def5186/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts?ref=d04515cf537b1ce67b1f4b0da91a02e07def5186",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {compileInjector, compileNgModule, CUSTOM_ELEMENTS_SCHEMA, Expression, ExternalExpr, InvokeFunctionExpr, LiteralArrayExpr, LiteralExpr, NO_ERRORS_SCHEMA, R3Identifiers, R3InjectorMetadata, R3NgModuleMetadata, R3Reference, SchemaMetadata, Statement, STRING_TYPE, WrappedNodeExpr} from '@angular/compiler';\n+import {compileFactoryFunction, compileInjector, compileNgModule, CUSTOM_ELEMENTS_SCHEMA, Expression, ExternalExpr, Identifiers as R3, InvokeFunctionExpr, LiteralArrayExpr, LiteralExpr, NO_ERRORS_SCHEMA, R3FactoryTarget, R3Identifiers, R3InjectorMetadata, R3NgModuleMetadata, R3Reference, SchemaMetadata, Statement, STRING_TYPE, WrappedNodeExpr} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {ErrorCode, FatalDiagnosticError, makeDiagnostic, makeRelatedInformation} from '../../diagnostics';\n@@ -449,21 +449,33 @@ export class NgModuleDecoratorHandler implements\n   }\n \n   compileFull(\n-      node: ClassDeclaration, analysis: Readonly<NgModuleAnalysis>,\n+      node: ClassDeclaration, {inj, mod, metadataStmt, declarations}: Readonly<NgModuleAnalysis>,\n       resolution: Readonly<NgModuleResolution>): CompileResult[] {\n+    const factoryFn = compileFactoryFunction({\n+      name: inj.name,\n+      type: inj.type,\n+      internalType: inj.internalType,\n+      typeArgumentCount: 0,\n+      deps: inj.deps,\n+      injectFn: R3.inject,\n+      target: R3FactoryTarget.NgModule,\n+    });\n+\n     //  Merge the injector imports (which are 'exports' that were later found to be NgModules)\n     //  computed during resolution with the ones from analysis.\n-    const ngInjectorDef = compileInjector({\n-      ...analysis.inj,\n-      imports: [...analysis.inj.imports, ...resolution.injectorImports],\n-    });\n-    const ngModuleDef = compileNgModule(analysis.mod);\n+    const ngInjectorDef = compileInjector(\n+        {\n+          ...inj,\n+          imports: [...inj.imports, ...resolution.injectorImports],\n+        },\n+        factoryFn);\n+    const ngModuleDef = compileNgModule(mod);\n     const ngModuleStatements = ngModuleDef.additionalStatements;\n-    if (analysis.metadataStmt !== null) {\n-      ngModuleStatements.push(analysis.metadataStmt);\n+    if (metadataStmt !== null) {\n+      ngModuleStatements.push(metadataStmt);\n     }\n     const context = getSourceFile(node);\n-    for (const decl of analysis.declarations) {\n+    for (const decl of declarations) {\n       const remoteScope = this.scopeRegistry.getRemoteScope(decl.node);\n       if (remoteScope !== null) {\n         const directives = remoteScope.directives.map("
        },
        {
            "sha": "a37b036e7a7692b7755dfbfe0f9d6bbe18f0cf38",
            "filename": "packages/compiler/src/jit_compiler_facade.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/d04515cf537b1ce67b1f4b0da91a02e07def5186/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "raw_url": "https://github.com/angular/angular/raw/d04515cf537b1ce67b1f4b0da91a02e07def5186/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts?ref=d04515cf537b1ce67b1f4b0da91a02e07def5186",
            "patch": "@@ -88,7 +88,16 @@ export class CompilerFacadeImpl implements CompilerFacade {\n       providers: new WrappedNodeExpr(facade.providers),\n       imports: facade.imports.map(i => new WrappedNodeExpr(i)),\n     };\n-    const res = compileInjector(meta);\n+    const factoryFn = compileFactoryFunction({\n+      name: meta.name,\n+      type: meta.type,\n+      internalType: meta.internalType,\n+      typeArgumentCount: 0,\n+      deps: meta.deps,\n+      injectFn: Identifiers.inject,\n+      target: R3FactoryTarget.NgModule,\n+    });\n+    const res = compileInjector(meta, factoryFn);\n     return this.jitExpression(res.expression, angularCoreEnv, sourceMapUrl, res.statements);\n   }\n "
        },
        {
            "sha": "ebf783be09599df5077885c6f987d68aa0111a46",
            "filename": "packages/compiler/src/render3/r3_module_compiler.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 15,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/d04515cf537b1ce67b1f4b0da91a02e07def5186/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_module_compiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/d04515cf537b1ce67b1f4b0da91a02e07def5186/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_module_compiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_module_compiler.ts?ref=d04515cf537b1ce67b1f4b0da91a02e07def5186",
            "patch": "@@ -8,7 +8,7 @@\n \n import * as o from '../output/output_ast';\n \n-import {compileFactoryFunction, R3DependencyMetadata, R3FactoryTarget} from './r3_factory';\n+import {R3DependencyMetadata, R3FactoryFn} from './r3_factory';\n import {Identifiers as R3} from './r3_identifiers';\n import {jitOnlyGuardedExpression, mapToMapExpression, R3Reference} from './util';\n \n@@ -230,19 +230,9 @@ export interface R3InjectorMetadata {\n   imports: o.Expression[];\n }\n \n-export function compileInjector(meta: R3InjectorMetadata): R3InjectorDef {\n-  const result = compileFactoryFunction({\n-    name: meta.name,\n-    type: meta.type,\n-    internalType: meta.internalType,\n-    typeArgumentCount: 0,\n-    deps: meta.deps,\n-    injectFn: R3.inject,\n-    target: R3FactoryTarget.NgModule,\n-  });\n-  const definitionMap = {\n-    factory: result.factory,\n-  } as {factory: o.Expression, providers: o.Expression, imports: o.Expression};\n+export function compileInjector(\n+    meta: R3InjectorMetadata, {factory, statements}: R3FactoryFn): R3InjectorDef {\n+  const definitionMap: Record<string, o.Expression> = {factory};\n \n   if (meta.providers !== null) {\n     definitionMap.providers = meta.providers;\n@@ -256,7 +246,7 @@ export function compileInjector(meta: R3InjectorMetadata): R3InjectorDef {\n       o.importExpr(R3.defineInjector).callFn([mapToMapExpression(definitionMap)], undefined, true);\n   const type =\n       new o.ExpressionType(o.importExpr(R3.InjectorDef, [new o.ExpressionType(meta.type.type)]));\n-  return {expression, type, statements: result.statements};\n+  return {expression, type, statements};\n }\n \n function tupleTypeOf(exp: R3Reference[]): o.Type {"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 37,
        "deletions": 26
    }
}