{
    "author": "crisbeto",
    "message": "fix(core): incorrectly validating properties on ng-content and ng-container (#37773)\n\nFixes the following issues related to how we validate properties during JIT:\n- The invalid property warning was printing `null` as the node name\nfor `ng-content`. The problem is that when generating a template from\n `ng-content` we weren't capturing the node name.\n- We weren't running property validation on `ng-container` at all.\nThis used to be supported on ViewEngine and seems like an oversight.\n\nIn the process of making these changes, I found and cleaned up a\nfew places where we were passing in `LView` unnecessarily.\n\nPR Close #37773",
    "sha": "bf641e1b4b47ab4ca77332bb27d48e96c2e3572b",
    "files": [
        {
            "sha": "aeb7cca37f383d2f6e2cb636a1d47e772fbb3142",
            "filename": "packages/compiler-cli/test/compliance/r3_compiler_compliance_spec.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fr3_compiler_compliance_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fr3_compiler_compliance_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fr3_compiler_compliance_spec.ts?ref=bf641e1b4b47ab4ca77332bb27d48e96c2e3572b",
            "patch": "@@ -1551,6 +1551,43 @@ describe('compiler compliance', () => {\n         const result = compile(files, angularFiles);\n         expectEmit(result.source, SimpleComponentDefinition, 'Incorrect MyApp definition');\n       });\n+\n+      it('should capture the node name of ng-content with a structural directive', () => {\n+        const files = {\n+          app: {\n+            'spec.ts': `\n+              import {Component, Directive, NgModule, TemplateRef} from '@angular/core';\n+\n+              @Component({selector: 'simple', template: '<ng-content *ngIf=\"showContent\"></ng-content>'})\n+              export class SimpleComponent {}\n+            `\n+          }\n+        };\n+\n+        const SimpleComponentDefinition = `\n+          SimpleComponent.ɵcmp = $r3$.ɵɵdefineComponent({\n+            type: SimpleComponent,\n+            selectors: [[\"simple\"]],\n+            ngContentSelectors: $c0$,\n+            decls: 1,\n+            vars: 1,\n+            consts: [[4, \"ngIf\"]],\n+            template:  function SimpleComponent_Template(rf, ctx) {\n+              if (rf & 1) {\n+                i0.ɵɵprojectionDef();\n+                i0.ɵɵtemplate(0, SimpleComponent_ng_content_0_Template, 1, 0, \"ng-content\", 0);\n+              }\n+              if (rf & 2) {\n+                i0.ɵɵproperty(\"ngIf\", ctx.showContent);\n+              }\n+            },\n+            encapsulation: 2\n+          });`;\n+\n+        const result = compile(files, angularFiles);\n+        expectEmit(\n+            result.source, SimpleComponentDefinition, 'Incorrect SimpleComponent definition');\n+      });\n     });\n \n     describe('queries', () => {"
        },
        {
            "sha": "23ec4d6b693b102229a08fdb2dd8fa0e0e479fef",
            "filename": "packages/compiler/src/render3/r3_ast.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts?ref=bf641e1b4b47ab4ca77332bb27d48e96c2e3572b",
            "patch": "@@ -104,6 +104,8 @@ export class Template implements Node {\n }\n \n export class Content implements Node {\n+  readonly name = 'ng-content';\n+\n   constructor(\n       public selector: string, public attributes: TextAttribute[],\n       public sourceSpan: ParseSourceSpan, public i18n?: I18nMeta) {}"
        },
        {
            "sha": "52a5e514062cea6f9fc5b3ae1eb73dd746708fbc",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=bf641e1b4b47ab4ca77332bb27d48e96c2e3572b",
            "patch": "@@ -233,10 +233,10 @@ class HtmlAstToIvyAst implements html.Visitor {\n \n       // TODO(pk): test for this case\n       parsedElement = new t.Template(\n-          (parsedElement as t.Element).name, hoistedAttrs.attributes, hoistedAttrs.inputs,\n-          hoistedAttrs.outputs, templateAttrs, [parsedElement], [/* no references */],\n-          templateVariables, element.sourceSpan, element.startSourceSpan, element.endSourceSpan,\n-          i18n);\n+          (parsedElement as t.Element | t.Content).name, hoistedAttrs.attributes,\n+          hoistedAttrs.inputs, hoistedAttrs.outputs, templateAttrs, [parsedElement],\n+          [/* no references */], templateVariables, element.sourceSpan, element.startSourceSpan,\n+          element.endSourceSpan, i18n);\n     }\n     if (isI18nRootElement) {\n       this.inI18nBlock = false;"
        },
        {
            "sha": "2b9b82c73fe893d1fe1fc83d87b5cb14e45a9cc9",
            "filename": "packages/core/src/render3/instructions/element.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Felement.ts",
            "raw_url": "https://github.com/angular/angular/raw/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Felement.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Felement.ts?ref=bf641e1b4b47ab4ca77332bb27d48e96c2e3572b",
            "patch": "@@ -37,7 +37,7 @@ function elementStartFirstCreatePass(\n \n   const hasDirectives =\n       resolveDirectives(tView, lView, tNode, getConstant<string[]>(tViewConsts, localRefsIndex));\n-  ngDevMode && logUnknownElementError(tView, lView, native, tNode, hasDirectives);\n+  ngDevMode && logUnknownElementError(tView, native, tNode, hasDirectives);\n \n   if (tNode.attrs !== null) {\n     computeStaticStyling(tNode, tNode.attrs, false);\n@@ -178,7 +178,7 @@ export function ɵɵelement(\n }\n \n function logUnknownElementError(\n-    tView: TView, lView: LView, element: RElement, tNode: TNode, hasDirectives: boolean): void {\n+    tView: TView, element: RElement, tNode: TNode, hasDirectives: boolean): void {\n   const schemas = tView.schemas;\n \n   // If `schemas` is set to `null`, that's an indication that this Component was compiled in AOT\n@@ -202,7 +202,7 @@ function logUnknownElementError(\n         (typeof customElements !== 'undefined' && tagName.indexOf('-') > -1 &&\n          !customElements.get(tagName));\n \n-    if (isUnknown && !matchingSchemas(tView, lView, tagName)) {\n+    if (isUnknown && !matchingSchemas(tView, tagName)) {\n       let message = `'${tagName}' is not a known element:\\n`;\n       message += `1. If '${\n           tagName}' is an Angular component, then verify that it is part of this module.\\n`;"
        },
        {
            "sha": "bb4f211799a0831e36b718c69a7c5efec31496fe",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=bf641e1b4b47ab4ca77332bb27d48e96c2e3572b",
            "patch": "@@ -979,7 +979,7 @@ export function elementPropertyInternal<T>(\n \n     if (ngDevMode) {\n       validateAgainstEventProperties(propName);\n-      if (!validateProperty(tView, lView, element, propName, tNode)) {\n+      if (!validateProperty(tView, element, propName, tNode)) {\n         // Return here since we only log warnings for unknown properties.\n         logUnknownPropertyError(propName, tNode);\n         return;\n@@ -996,10 +996,10 @@ export function elementPropertyInternal<T>(\n       (element as RElement).setProperty ? (element as any).setProperty(propName, value) :\n                                           (element as any)[propName] = value;\n     }\n-  } else if (tNode.type === TNodeType.Container) {\n+  } else if (tNode.type === TNodeType.Container || tNode.type === TNodeType.ElementContainer) {\n     // If the node is a container and the property didn't\n     // match any of the inputs or schemas we should throw.\n-    if (ngDevMode && !matchingSchemas(tView, lView, tNode.tagName)) {\n+    if (ngDevMode && !matchingSchemas(tView, tNode.tagName)) {\n       logUnknownPropertyError(propName, tNode);\n     }\n   }\n@@ -1057,8 +1057,7 @@ export function setNgReflectProperties(\n }\n \n function validateProperty(\n-    tView: TView, lView: LView, element: RElement|RComment, propName: string,\n-    tNode: TNode): boolean {\n+    tView: TView, element: RElement|RComment, propName: string, tNode: TNode): boolean {\n   // If `schemas` is set to `null`, that's an indication that this Component was compiled in AOT\n   // mode where this check happens at compile time. In JIT mode, `schemas` is always present and\n   // defined as an array (as an empty array in case `schemas` field is not defined) and we should\n@@ -1067,8 +1066,7 @@ function validateProperty(\n \n   // The property is considered valid if the element matches the schema, it exists on the element\n   // or it is synthetic, and we are in a browser context (web worker nodes should be skipped).\n-  if (matchingSchemas(tView, lView, tNode.tagName) || propName in element ||\n-      isAnimationProp(propName)) {\n+  if (matchingSchemas(tView, tNode.tagName) || propName in element || isAnimationProp(propName)) {\n     return true;\n   }\n \n@@ -1077,7 +1075,7 @@ function validateProperty(\n   return typeof Node === 'undefined' || Node === null || !(element instanceof Node);\n }\n \n-export function matchingSchemas(tView: TView, lView: LView, tagName: string|null): boolean {\n+export function matchingSchemas(tView: TView, tagName: string|null): boolean {\n   const schemas = tView.schemas;\n \n   if (schemas !== null) {"
        },
        {
            "sha": "c65218fd193a02c3ce69212d55f31fa08726283e",
            "filename": "packages/core/test/acceptance/ng_module_spec.ts",
            "status": "modified",
            "additions": 64,
            "deletions": 0,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcore%2Ftest%2Facceptance%2Fng_module_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bf641e1b4b47ab4ca77332bb27d48e96c2e3572b/packages%2Fcore%2Ftest%2Facceptance%2Fng_module_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fng_module_spec.ts?ref=bf641e1b4b47ab4ca77332bb27d48e96c2e3572b",
            "patch": "@@ -287,6 +287,70 @@ describe('NgModule', () => {\n               }).toThrowError(/'custom' is not a known element/);\n             });\n \n+    onlyInIvy('unknown element check logs an error message rather than throwing')\n+        .it('should report unknown property bindings on ng-content', () => {\n+          @Component({template: `<ng-content *unknownProp=\"123\"></ng-content>`})\n+          class App {\n+          }\n+\n+          TestBed.configureTestingModule({declarations: [App]});\n+          const spy = spyOn(console, 'error');\n+          const fixture = TestBed.createComponent(App);\n+          fixture.detectChanges();\n+\n+          expect(spy.calls.mostRecent()?.args[0])\n+              .toMatch(\n+                  /Can't bind to 'unknownProp' since it isn't a known property of 'ng-content'/);\n+        });\n+\n+    modifiedInIvy('unknown element error thrown instead of warning')\n+        .it('should throw for unknown property bindings on ng-content', () => {\n+          @Component({template: `<ng-content *unknownProp=\"123\"></ng-content>`})\n+          class App {\n+          }\n+\n+          TestBed.configureTestingModule({declarations: [App]});\n+\n+          expect(() => {\n+            const fixture = TestBed.createComponent(App);\n+            fixture.detectChanges();\n+          })\n+              .toThrowError(\n+                  /Can't bind to 'unknownProp' since it isn't a known property of 'ng-content'/);\n+        });\n+\n+    onlyInIvy('unknown element check logs an error message rather than throwing')\n+        .it('should report unknown property bindings on ng-container', () => {\n+          @Component({template: `<ng-container [unknown-prop]=\"123\"></ng-container>`})\n+          class App {\n+          }\n+\n+          TestBed.configureTestingModule({declarations: [App]});\n+          const spy = spyOn(console, 'error');\n+          const fixture = TestBed.createComponent(App);\n+          fixture.detectChanges();\n+\n+          expect(spy.calls.mostRecent()?.args[0])\n+              .toMatch(\n+                  /Can't bind to 'unknown-prop' since it isn't a known property of 'ng-container'/);\n+        });\n+\n+    modifiedInIvy('unknown element error thrown instead of warning')\n+        .it('should throw for unknown property bindings on ng-container', () => {\n+          @Component({template: `<ng-container [unknown-prop]=\"123\"></ng-container>`})\n+          class App {\n+          }\n+\n+          TestBed.configureTestingModule({declarations: [App]});\n+\n+          expect(() => {\n+            const fixture = TestBed.createComponent(App);\n+            fixture.detectChanges();\n+          })\n+              .toThrowError(\n+                  /Can't bind to 'unknown-prop' since it isn't a known property of 'ng-container'/);\n+        });\n+\n     onlyInIvy('test relies on Ivy-specific AOT format').describe('AOT-compiled components', () => {\n       function createComponent(\n           template: (rf: any) => void, vars: number, consts?: (number|string)[][]) {"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 116,
        "deletions": 15
    }
}