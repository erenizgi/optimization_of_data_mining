{
    "author": "petebacondarwin",
    "message": "refactor(compiler): move the MessagePiece classes into output_ast.ts (#38645)\n\nThe `MessagePiece` and derived classes, `LiteralPiece` and `PlaceholderPiece`\nneed to be referenced in the `LocalizedString` output AST class, so that we\ncan render the source-spans of each piece.\n\nPR Close #38645",
    "sha": "7a6a061a9e68590e9b60554bf41ebee0c0d66068",
    "files": [
        {
            "sha": "c0e06637f05332c15587ee9d5cc14e47bac870c7",
            "filename": "packages/compiler/src/output/output_ast.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/7a6a061a9e68590e9b60554bf41ebee0c0d66068/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/7a6a061a9e68590e9b60554bf41ebee0c0d66068/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts?ref=7a6a061a9e68590e9b60554bf41ebee0c0d66068",
            "patch": "@@ -9,7 +9,6 @@\n \n import {ParseSourceSpan} from '../parse_util';\n import {I18nMeta} from '../render3/view/i18n/meta';\n-import {error} from '../util';\n \n //// Types\n export enum TypeModifier {\n@@ -516,11 +515,16 @@ export class LiteralExpr extends Expression {\n   }\n }\n \n+export abstract class MessagePiece {\n+  constructor(public text: string, public sourceSpan: ParseSourceSpan) {}\n+}\n+export class LiteralPiece extends MessagePiece {}\n+export class PlaceholderPiece extends MessagePiece {}\n \n export class LocalizedString extends Expression {\n   constructor(\n-      readonly metaBlock: I18nMeta, readonly messageParts: string[],\n-      readonly placeHolderNames: string[], readonly expressions: Expression[],\n+      readonly metaBlock: I18nMeta, readonly messageParts: LiteralPiece[],\n+      readonly placeHolderNames: PlaceholderPiece[], readonly expressions: Expression[],\n       sourceSpan?: ParseSourceSpan|null) {\n     super(STRING_TYPE, sourceSpan);\n   }\n@@ -563,7 +567,16 @@ export class LocalizedString extends Expression {\n         metaBlock = `${metaBlock}${LEGACY_ID_INDICATOR}${legacyId}`;\n       });\n     }\n-    return createCookedRawString(metaBlock, this.messageParts[0]);\n+    return createCookedRawString(metaBlock, this.messageParts[0].text);\n+  }\n+\n+  getMessagePartSourceSpan(i: number): ParseSourceSpan|null {\n+    return this.messageParts[i]?.sourceSpan ?? this.sourceSpan;\n+  }\n+\n+  getPlaceholderSourceSpan(i: number): ParseSourceSpan {\n+    return this.placeHolderNames[i]?.sourceSpan ?? this.expressions[i]?.sourceSpan ??\n+        this.sourceSpan;\n   }\n \n   /**\n@@ -574,9 +587,9 @@ export class LocalizedString extends Expression {\n    * @param messagePart The following message string after this placeholder\n    */\n   serializeI18nTemplatePart(partIndex: number): {cooked: string, raw: string} {\n-    const placeholderName = this.placeHolderNames[partIndex - 1];\n+    const placeholderName = this.placeHolderNames[partIndex - 1].text;\n     const messagePart = this.messageParts[partIndex];\n-    return createCookedRawString(placeholderName, messagePart);\n+    return createCookedRawString(placeholderName, messagePart.text);\n   }\n }\n \n@@ -1799,7 +1812,7 @@ export function literal(\n }\n \n export function localizedString(\n-    metaBlock: I18nMeta, messageParts: string[], placeholderNames: string[],\n+    metaBlock: I18nMeta, messageParts: LiteralPiece[], placeholderNames: PlaceholderPiece[],\n     expressions: Expression[], sourceSpan?: ParseSourceSpan|null): LocalizedString {\n   return new LocalizedString(metaBlock, messageParts, placeholderNames, expressions, sourceSpan);\n }"
        },
        {
            "sha": "4c4f29eff27db7b749429565a10d004a782cae71",
            "filename": "packages/compiler/src/render3/view/i18n/localize_utils.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 39,
            "changes": 77,
            "blob_url": "https://github.com/angular/angular/blob/7a6a061a9e68590e9b60554bf41ebee0c0d66068/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/7a6a061a9e68590e9b60554bf41ebee0c0d66068/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts?ref=7a6a061a9e68590e9b60554bf41ebee0c0d66068",
            "patch": "@@ -7,7 +7,7 @@\n  */\n import * as i18n from '../../../i18n/i18n_ast';\n import * as o from '../../../output/output_ast';\n-import {ParseSourceSpan} from '../../../parse_util';\n+import {ParseLocation, ParseSourceSpan} from '../../../parse_util';\n \n import {serializeIcuNode} from './icu_serializer';\n import {formatI18nPlaceholderName} from './util';\n@@ -17,60 +17,55 @@ export function createLocalizeStatements(\n     params: {[name: string]: o.Expression}): o.Statement[] {\n   const {messageParts, placeHolders} = serializeI18nMessageForLocalize(message);\n   const sourceSpan = getSourceSpan(message);\n-  const expressions = placeHolders.map(ph => params[ph]);\n+  const expressions = placeHolders.map(ph => params[ph.text]);\n   const localizedString =\n       o.localizedString(message, messageParts, placeHolders, expressions, sourceSpan);\n   const variableInitialization = variable.set(localizedString);\n   return [new o.ExpressionStatement(variableInitialization)];\n }\n \n-class MessagePiece {\n-  constructor(public text: string) {}\n-}\n-class LiteralPiece extends MessagePiece {}\n-class PlaceholderPiece extends MessagePiece {\n-  constructor(name: string) {\n-    super(formatI18nPlaceholderName(name, /* useCamelCase */ false));\n-  }\n-}\n-\n /**\n  * This visitor walks over an i18n tree, capturing literal strings and placeholders.\n  *\n  * The result can be used for generating the `$localize` tagged template literals.\n  */\n class LocalizeSerializerVisitor implements i18n.Visitor {\n-  visitText(text: i18n.Text, context: MessagePiece[]): any {\n-    if (context[context.length - 1] instanceof LiteralPiece) {\n+  visitText(text: i18n.Text, context: o.MessagePiece[]): any {\n+    if (context[context.length - 1] instanceof o.LiteralPiece) {\n       // Two literal pieces in a row means that there was some comment node in-between.\n       context[context.length - 1].text += text.value;\n     } else {\n-      context.push(new LiteralPiece(text.value));\n+      context.push(new o.LiteralPiece(text.value, text.sourceSpan));\n     }\n   }\n \n-  visitContainer(container: i18n.Container, context: MessagePiece[]): any {\n+  visitContainer(container: i18n.Container, context: o.MessagePiece[]): any {\n     container.children.forEach(child => child.visit(this, context));\n   }\n \n-  visitIcu(icu: i18n.Icu, context: MessagePiece[]): any {\n-    context.push(new LiteralPiece(serializeIcuNode(icu)));\n+  visitIcu(icu: i18n.Icu, context: o.MessagePiece[]): any {\n+    context.push(new o.LiteralPiece(serializeIcuNode(icu), icu.sourceSpan));\n   }\n \n-  visitTagPlaceholder(ph: i18n.TagPlaceholder, context: MessagePiece[]): any {\n-    context.push(new PlaceholderPiece(ph.startName));\n+  visitTagPlaceholder(ph: i18n.TagPlaceholder, context: o.MessagePiece[]): any {\n+    context.push(this.createPlaceholderPiece(ph.startName, ph.sourceSpan));\n     if (!ph.isVoid) {\n       ph.children.forEach(child => child.visit(this, context));\n-      context.push(new PlaceholderPiece(ph.closeName));\n+      context.push(this.createPlaceholderPiece(ph.closeName, ph.closeSourceSpan ?? ph.sourceSpan));\n     }\n   }\n \n-  visitPlaceholder(ph: i18n.Placeholder, context: MessagePiece[]): any {\n-    context.push(new PlaceholderPiece(ph.name));\n+  visitPlaceholder(ph: i18n.Placeholder, context: o.MessagePiece[]): any {\n+    context.push(this.createPlaceholderPiece(ph.name, ph.sourceSpan));\n   }\n \n   visitIcuPlaceholder(ph: i18n.IcuPlaceholder, context?: any): any {\n-    context.push(new PlaceholderPiece(ph.name));\n+    context.push(this.createPlaceholderPiece(ph.name, ph.sourceSpan));\n+  }\n+\n+  private createPlaceholderPiece(name: string, sourceSpan: ParseSourceSpan): o.PlaceholderPiece {\n+    return new o.PlaceholderPiece(\n+        formatI18nPlaceholderName(name, /* useCamelCase */ false), sourceSpan);\n   }\n }\n \n@@ -85,8 +80,8 @@ const serializerVisitor = new LocalizeSerializerVisitor();\n  * @returns an object containing the messageParts and placeholders.\n  */\n export function serializeI18nMessageForLocalize(message: i18n.Message):\n-    {messageParts: string[], placeHolders: string[]} {\n-  const pieces: MessagePiece[] = [];\n+    {messageParts: o.LiteralPiece[], placeHolders: o.PlaceholderPiece[]} {\n+  const pieces: o.MessagePiece[] = [];\n   message.nodes.forEach(node => node.visit(serializerVisitor, pieces));\n   return processMessagePieces(pieces);\n }\n@@ -107,31 +102,35 @@ function getSourceSpan(message: i18n.Message): ParseSourceSpan {\n  * @param pieces The pieces to process.\n  * @returns an object containing the messageParts and placeholders.\n  */\n-function processMessagePieces(pieces: MessagePiece[]):\n-    {messageParts: string[], placeHolders: string[]} {\n-  const messageParts: string[] = [];\n-  const placeHolders: string[] = [];\n+function processMessagePieces(pieces: o.MessagePiece[]):\n+    {messageParts: o.LiteralPiece[], placeHolders: o.PlaceholderPiece[]} {\n+  const messageParts: o.LiteralPiece[] = [];\n+  const placeHolders: o.PlaceholderPiece[] = [];\n \n-  if (pieces[0] instanceof PlaceholderPiece) {\n+  if (pieces[0] instanceof o.PlaceholderPiece) {\n     // The first piece was a placeholder so we need to add an initial empty message part.\n-    messageParts.push('');\n+    messageParts.push(createEmptyMessagePart(pieces[0].sourceSpan.start));\n   }\n \n   for (let i = 0; i < pieces.length; i++) {\n     const part = pieces[i];\n-    if (part instanceof LiteralPiece) {\n-      messageParts.push(part.text);\n+    if (part instanceof o.LiteralPiece) {\n+      messageParts.push(part);\n     } else {\n-      placeHolders.push(part.text);\n-      if (pieces[i - 1] instanceof PlaceholderPiece) {\n+      placeHolders.push(part);\n+      if (pieces[i - 1] instanceof o.PlaceholderPiece) {\n         // There were two placeholders in a row, so we need to add an empty message part.\n-        messageParts.push('');\n+        messageParts.push(createEmptyMessagePart(part.sourceSpan.end));\n       }\n     }\n   }\n-  if (pieces[pieces.length - 1] instanceof PlaceholderPiece) {\n+  if (pieces[pieces.length - 1] instanceof o.PlaceholderPiece) {\n     // The last piece was a placeholder so we need to add a final empty message part.\n-    messageParts.push('');\n+    messageParts.push(createEmptyMessagePart(pieces[pieces.length - 1].sourceSpan.end));\n   }\n   return {messageParts, placeHolders};\n }\n+\n+function createEmptyMessagePart(location: ParseLocation): o.LiteralPiece {\n+  return new o.LiteralPiece('', new ParseSourceSpan(location, location));\n+}"
        },
        {
            "sha": "b6ff7deab5a816b6951b18208ec0dc2d6778a7ea",
            "filename": "packages/compiler/test/output/js_emitter_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/7a6a061a9e68590e9b60554bf41ebee0c0d66068/packages%2Fcompiler%2Ftest%2Foutput%2Fjs_emitter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7a6a061a9e68590e9b60554bf41ebee0c0d66068/packages%2Fcompiler%2Ftest%2Foutput%2Fjs_emitter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Foutput%2Fjs_emitter_spec.ts?ref=7a6a061a9e68590e9b60554bf41ebee0c0d66068",
            "patch": "@@ -205,9 +205,12 @@ const externalModuleIdentifier = new o.ExternalReference(anotherModuleUrl, 'some\n     });\n \n     it('should support ES5 localized strings', () => {\n-      expect(emitStmt(new o.ExpressionStatement(o.localizedString(\n-                 {}, ['ab\\\\:c', 'd\"e\\'f'], ['ph1'],\n-                 [o.literal(7, o.NUMBER_TYPE).plus(o.literal(8, o.NUMBER_TYPE))]))))\n+      const messageParts =\n+          [new o.LiteralPiece('ab\\\\:c', {} as any), new o.LiteralPiece('d\"e\\'f', {} as any)];\n+      const placeholders = [new o.PlaceholderPiece('ph1', {} as any)];\n+      const expressions = [o.literal(7, o.NUMBER_TYPE).plus(o.literal(8, o.NUMBER_TYPE))];\n+      const localizedString = o.localizedString({}, messageParts, placeholders, expressions);\n+      expect(emitStmt(new o.ExpressionStatement(localizedString)))\n           .toEqual(\n               String.raw\n               `$localize((this&&this.__makeTemplateObject||function(e,t){return Object.defineProperty?Object.defineProperty(e,\"raw\",{value:t}):e.raw=t,e})(['ab\\\\:c', ':ph1:d\"e\\'f'], ['ab\\\\\\\\:c', ':ph1:d\"e\\'f']), (7 + 8));`);"
        },
        {
            "sha": "e20b136f38b905d75b34a8e04e31b5f052142e72",
            "filename": "packages/compiler/test/output/ts_emitter_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/7a6a061a9e68590e9b60554bf41ebee0c0d66068/packages%2Fcompiler%2Ftest%2Foutput%2Fts_emitter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7a6a061a9e68590e9b60554bf41ebee0c0d66068/packages%2Fcompiler%2Ftest%2Foutput%2Fts_emitter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Foutput%2Fts_emitter_spec.ts?ref=7a6a061a9e68590e9b60554bf41ebee0c0d66068",
            "patch": "@@ -254,9 +254,12 @@ const externalModuleIdentifier = new o.ExternalReference(anotherModuleUrl, 'some\n     });\n \n     it('should support localized strings', () => {\n-      expect(emitStmt(new o.ExpressionStatement(o.localizedString(\n-                 {}, ['ab\\\\:c', 'd\"e\\'f'], ['ph1'],\n-                 [o.literal(7, o.NUMBER_TYPE).plus(o.literal(8, o.NUMBER_TYPE))]))))\n+      const messageParts =\n+          [new o.LiteralPiece('ab\\\\:c', {} as any), new o.LiteralPiece('d\"e\\'f', {} as any)];\n+      const placeholders = [new o.PlaceholderPiece('ph1', {} as any)];\n+      const expressions = [o.literal(7, o.NUMBER_TYPE).plus(o.literal(8, o.NUMBER_TYPE))];\n+      const localizedString = o.localizedString({}, messageParts, placeholders, expressions);\n+      expect(emitStmt(new o.ExpressionStatement(localizedString)))\n           .toEqual('$localize `ab\\\\\\\\:c${(7 + 8)}:ph1:d\"e\\'f`;');\n     });\n "
        },
        {
            "sha": "50d534c64ea83812f55cf038c7e84c88dfe47b95",
            "filename": "packages/compiler/test/render3/view/i18n_spec.ts",
            "status": "modified",
            "additions": 121,
            "deletions": 43,
            "changes": 164,
            "blob_url": "https://github.com/angular/angular/blob/7a6a061a9e68590e9b60554bf41ebee0c0d66068/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7a6a061a9e68590e9b60554bf41ebee0c0d66068/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts?ref=7a6a061a9e68590e9b60554bf41ebee0c0d66068",
            "patch": "@@ -10,6 +10,7 @@ import {Lexer} from '../../../src/expression_parser/lexer';\n import {Parser} from '../../../src/expression_parser/parser';\n import * as i18n from '../../../src/i18n/i18n_ast';\n import * as o from '../../../src/output/output_ast';\n+import {ParseSourceSpan} from '../../../src/parse_util';\n import * as t from '../../../src/render3/r3_ast';\n import {I18nContext} from '../../../src/render3/view/i18n/context';\n import {serializeI18nMessageForGetMsg} from '../../../src/render3/view/i18n/get_msg_utils';\n@@ -221,64 +222,75 @@ describe('Utils', () => {\n     });\n \n     it('serializeI18nHead()', () => {\n-      expect(o.localizedString(meta(), [''], [], []).serializeI18nHead())\n+      expect(o.localizedString(meta(), [literal('')], [], []).serializeI18nHead())\n           .toEqual({cooked: '', raw: ''});\n-      expect(o.localizedString(meta('', '', 'desc'), [''], [], []).serializeI18nHead())\n+      expect(o.localizedString(meta('', '', 'desc'), [literal('')], [], []).serializeI18nHead())\n           .toEqual({cooked: ':desc:', raw: ':desc:'});\n-      expect(o.localizedString(meta('id', '', 'desc'), [''], [], []).serializeI18nHead())\n+      expect(o.localizedString(meta('id', '', 'desc'), [literal('')], [], []).serializeI18nHead())\n           .toEqual({cooked: ':desc@@id:', raw: ':desc@@id:'});\n-      expect(o.localizedString(meta('', 'meaning', 'desc'), [''], [], []).serializeI18nHead())\n+      expect(\n+          o.localizedString(meta('', 'meaning', 'desc'), [literal('')], [], []).serializeI18nHead())\n           .toEqual({cooked: ':meaning|desc:', raw: ':meaning|desc:'});\n-      expect(o.localizedString(meta('id', 'meaning', 'desc'), [''], [], []).serializeI18nHead())\n+      expect(o.localizedString(meta('id', 'meaning', 'desc'), [literal('')], [], [])\n+                 .serializeI18nHead())\n           .toEqual({cooked: ':meaning|desc@@id:', raw: ':meaning|desc@@id:'});\n-      expect(o.localizedString(meta('id', '', ''), [''], [], []).serializeI18nHead())\n+      expect(o.localizedString(meta('id', '', ''), [literal('')], [], []).serializeI18nHead())\n           .toEqual({cooked: ':@@id:', raw: ':@@id:'});\n \n       // Escaping colons (block markers)\n-      expect(\n-          o.localizedString(meta('id:sub_id', 'meaning', 'desc'), [''], [], []).serializeI18nHead())\n+      expect(o.localizedString(meta('id:sub_id', 'meaning', 'desc'), [literal('')], [], [])\n+                 .serializeI18nHead())\n           .toEqual({cooked: ':meaning|desc@@id:sub_id:', raw: ':meaning|desc@@id\\\\:sub_id:'});\n-      expect(o.localizedString(meta('id', 'meaning:sub_meaning', 'desc'), [''], [], [])\n+      expect(o.localizedString(meta('id', 'meaning:sub_meaning', 'desc'), [literal('')], [], [])\n                  .serializeI18nHead())\n           .toEqual(\n               {cooked: ':meaning:sub_meaning|desc@@id:', raw: ':meaning\\\\:sub_meaning|desc@@id:'});\n-      expect(o.localizedString(meta('id', 'meaning', 'desc:sub_desc'), [''], [], [])\n+      expect(o.localizedString(meta('id', 'meaning', 'desc:sub_desc'), [literal('')], [], [])\n                  .serializeI18nHead())\n           .toEqual({cooked: ':meaning|desc:sub_desc@@id:', raw: ':meaning|desc\\\\:sub_desc@@id:'});\n-      expect(o.localizedString(meta('id', 'meaning', 'desc'), ['message source'], [], [])\n+      expect(o.localizedString(meta('id', 'meaning', 'desc'), [literal('message source')], [], [])\n                  .serializeI18nHead())\n           .toEqual({\n             cooked: ':meaning|desc@@id:message source',\n             raw: ':meaning|desc@@id:message source'\n           });\n-      expect(o.localizedString(meta('id', 'meaning', 'desc'), [':message source'], [], [])\n+      expect(o.localizedString(meta('id', 'meaning', 'desc'), [literal(':message source')], [], [])\n                  .serializeI18nHead())\n           .toEqual({\n             cooked: ':meaning|desc@@id::message source',\n             raw: ':meaning|desc@@id::message source'\n           });\n-      expect(o.localizedString(meta('', '', ''), ['message source'], [], []).serializeI18nHead())\n+      expect(o.localizedString(meta('', '', ''), [literal('message source')], [], [])\n+                 .serializeI18nHead())\n           .toEqual({cooked: 'message source', raw: 'message source'});\n-      expect(o.localizedString(meta('', '', ''), [':message source'], [], []).serializeI18nHead())\n+      expect(o.localizedString(meta('', '', ''), [literal(':message source')], [], [])\n+                 .serializeI18nHead())\n           .toEqual({cooked: ':message source', raw: '\\\\:message source'});\n     });\n \n     it('serializeI18nPlaceholderBlock()', () => {\n-      expect(o.localizedString(meta('', '', ''), ['', ''], [''], []).serializeI18nTemplatePart(1))\n+      expect(o.localizedString(meta('', '', ''), [literal(''), literal('')], [literal('')], [])\n+                 .serializeI18nTemplatePart(1))\n           .toEqual({cooked: '', raw: ''});\n-      expect(\n-          o.localizedString(meta('', '', ''), ['', ''], ['abc'], []).serializeI18nTemplatePart(1))\n-          .toEqual({cooked: ':abc:', raw: ':abc:'});\n-      expect(o.localizedString(meta('', '', ''), ['', 'message'], [''], [])\n+      expect(o.localizedString(\n+                  meta('', '', ''), [literal(''), literal('')],\n+                  [new o.LiteralPiece('abc', {} as any)], [])\n                  .serializeI18nTemplatePart(1))\n+          .toEqual({cooked: ':abc:', raw: ':abc:'});\n+      expect(\n+          o.localizedString(meta('', '', ''), [literal(''), literal('message')], [literal('')], [])\n+              .serializeI18nTemplatePart(1))\n           .toEqual({cooked: 'message', raw: 'message'});\n-      expect(o.localizedString(meta('', '', ''), ['', 'message'], ['abc'], [])\n+      expect(o.localizedString(\n+                  meta('', '', ''), [literal(''), literal('message')], [literal('abc')], [])\n                  .serializeI18nTemplatePart(1))\n           .toEqual({cooked: ':abc:message', raw: ':abc:message'});\n-      expect(o.localizedString(meta('', '', ''), ['', ':message'], [''], [])\n-                 .serializeI18nTemplatePart(1))\n+      expect(\n+          o.localizedString(meta('', '', ''), [literal(''), literal(':message')], [literal('')], [])\n+              .serializeI18nTemplatePart(1))\n           .toEqual({cooked: ':message', raw: '\\\\:message'});\n-      expect(o.localizedString(meta('', '', ''), ['', ':message'], ['abc'], [])\n+      expect(o.localizedString(\n+                  meta('', '', ''), [literal(''), literal(':message')], [literal('abc')], [])\n                  .serializeI18nTemplatePart(1))\n           .toEqual({cooked: ':abc::message', raw: ':abc::message'});\n     });\n@@ -349,55 +361,106 @@ describe('serializeI18nMessageForLocalize', () => {\n   };\n \n   it('should serialize plain text for `$localize()`', () => {\n-    expect(serialize('Some text')).toEqual({messageParts: ['Some text'], placeHolders: []});\n+    expect(serialize('Some text'))\n+        .toEqual({messageParts: [literal('Some text')], placeHolders: []});\n   });\n \n   it('should serialize text with interpolation for `$localize()`', () => {\n     expect(serialize('Some text {{ valueA }} and {{ valueB + valueC }} done')).toEqual({\n-      messageParts: ['Some text ', ' and ', ' done'],\n-      placeHolders: ['INTERPOLATION', 'INTERPOLATION_1']\n+      messageParts: [literal('Some text '), literal(' and '), literal(' done')],\n+      placeHolders: [placeholder('INTERPOLATION'), placeholder('INTERPOLATION_1')],\n     });\n   });\n \n+  it('should compute source-spans when serializing text with interpolation for `$localize()`',\n+     () => {\n+       const {messageParts, placeHolders} =\n+           serialize('Some text {{ valueA }} and {{ valueB + valueC }} done');\n+\n+       expect(messageParts[0].text).toEqual('Some text ');\n+       expect(messageParts[0].sourceSpan.toString()).toEqual('Some text ');\n+       expect(messageParts[1].text).toEqual(' and ');\n+       expect(messageParts[1].sourceSpan.toString()).toEqual(' and ');\n+       expect(messageParts[2].text).toEqual(' done');\n+       expect(messageParts[2].sourceSpan.toString()).toEqual(' done');\n+\n+       expect(placeHolders[0].text).toEqual('INTERPOLATION');\n+       expect(placeHolders[0].sourceSpan.toString()).toEqual('{{ valueA }}');\n+       expect(placeHolders[1].text).toEqual('INTERPOLATION_1');\n+       expect(placeHolders[1].sourceSpan.toString()).toEqual('{{ valueB + valueC }}');\n+     });\n+\n   it('should serialize text with interpolation at start for `$localize()`', () => {\n     expect(serialize('{{ valueA }} and {{ valueB + valueC }} done')).toEqual({\n-      messageParts: ['', ' and ', ' done'],\n-      placeHolders: ['INTERPOLATION', 'INTERPOLATION_1']\n+      messageParts: [literal(''), literal(' and '), literal(' done')],\n+      placeHolders: [placeholder('INTERPOLATION'), placeholder('INTERPOLATION_1')],\n     });\n   });\n \n \n   it('should serialize text with interpolation at end for `$localize()`', () => {\n     expect(serialize('Some text {{ valueA }} and {{ valueB + valueC }}')).toEqual({\n-      messageParts: ['Some text ', ' and ', ''],\n-      placeHolders: ['INTERPOLATION', 'INTERPOLATION_1']\n+      messageParts: [literal('Some text '), literal(' and '), literal('')],\n+      placeHolders: [placeholder('INTERPOLATION'), placeholder('INTERPOLATION_1')],\n     });\n   });\n \n \n   it('should serialize only interpolation for `$localize()`', () => {\n-    expect(serialize('{{ valueB + valueC }}'))\n-        .toEqual({messageParts: ['', ''], placeHolders: ['INTERPOLATION']});\n+    expect(serialize('{{ valueB + valueC }}')).toEqual({\n+      messageParts: [literal(''), literal('')],\n+      placeHolders: [placeholder('INTERPOLATION')]\n+    });\n   });\n \n \n   it('should serialize interpolation with named placeholder for `$localize()`', () => {\n-    expect(serialize('{{ valueB + valueC // i18n(ph=\"PLACEHOLDER NAME\") }}'))\n-        .toEqual({messageParts: ['', ''], placeHolders: ['PLACEHOLDER_NAME']});\n+    expect(serialize('{{ valueB + valueC // i18n(ph=\"PLACEHOLDER NAME\") }}')).toEqual({\n+      messageParts: [literal(''), literal('')],\n+      placeHolders: [placeholder('PLACEHOLDER_NAME')]\n+    });\n   });\n \n \n   it('should serialize content with HTML tags for `$localize()`', () => {\n     expect(serialize('A <span>B<div>C</div></span> D')).toEqual({\n-      messageParts: ['A ', 'B', 'C', '', ' D'],\n-      placeHolders: ['START_TAG_SPAN', 'START_TAG_DIV', 'CLOSE_TAG_DIV', 'CLOSE_TAG_SPAN']\n+      messageParts: [literal('A '), literal('B'), literal('C'), literal(''), literal(' D')],\n+      placeHolders: [\n+        placeholder('START_TAG_SPAN'), placeholder('START_TAG_DIV'), placeholder('CLOSE_TAG_DIV'),\n+        placeholder('CLOSE_TAG_SPAN')\n+      ]\n     });\n   });\n \n \n+  it('should compute source-spans when serializing content with HTML tags for `$localize()`',\n+     () => {\n+       const {messageParts, placeHolders} = serialize('A <span>B<div>C</div></span> D');\n+\n+       expect(messageParts[0].text).toEqual('A ');\n+       expect(messageParts[0].sourceSpan.toString()).toEqual('A ');\n+       expect(messageParts[1].text).toEqual('B');\n+       expect(messageParts[1].sourceSpan.toString()).toEqual('B');\n+       expect(messageParts[2].text).toEqual('C');\n+       expect(messageParts[2].sourceSpan.toString()).toEqual('C');\n+       expect(messageParts[3].text).toEqual('');\n+       expect(messageParts[3].sourceSpan.toString()).toEqual('');\n+       expect(messageParts[4].text).toEqual(' D');\n+       expect(messageParts[4].sourceSpan.toString()).toEqual(' D');\n+\n+       expect(placeHolders[0].text).toEqual('START_TAG_SPAN');\n+       expect(placeHolders[0].sourceSpan.toString()).toEqual('<span>');\n+       expect(placeHolders[1].text).toEqual('START_TAG_DIV');\n+       expect(placeHolders[1].sourceSpan.toString()).toEqual('<div>');\n+       expect(placeHolders[2].text).toEqual('CLOSE_TAG_DIV');\n+       expect(placeHolders[2].sourceSpan.toString()).toEqual('</div>');\n+       expect(placeHolders[3].text).toEqual('CLOSE_TAG_SPAN');\n+       expect(placeHolders[3].sourceSpan.toString()).toEqual('</span>');\n+     });\n+\n   it('should serialize simple ICU for `$localize()`', () => {\n     expect(serialize('{age, plural, 10 {ten} other {other}}')).toEqual({\n-      messageParts: ['{VAR_PLURAL, plural, 10 {ten} other {other}}'],\n+      messageParts: [literal('{VAR_PLURAL, plural, 10 {ten} other {other}}')],\n       placeHolders: []\n     });\n   });\n@@ -408,7 +471,8 @@ describe('serializeI18nMessageForLocalize', () => {\n                '{age, plural, 10 {ten {size, select, 1 {one} 2 {two} other {2+}}} other {other}}'))\n         .toEqual({\n           messageParts: [\n-            '{VAR_PLURAL, plural, 10 {ten {VAR_SELECT, select, 1 {one} 2 {two} other {2+}}} other {other}}'\n+            literal(\n+                '{VAR_PLURAL, plural, 10 {ten {VAR_SELECT, select, 1 {one} 2 {two} other {2+}}} other {other}}')\n           ],\n           placeHolders: []\n         });\n@@ -418,7 +482,8 @@ describe('serializeI18nMessageForLocalize', () => {\n   it('should serialize ICU with embedded HTML for `$localize()`', () => {\n     expect(serialize('{age, plural, 10 {<b>ten</b>} other {<div class=\"A\">other</div>}}')).toEqual({\n       messageParts: [\n-        '{VAR_PLURAL, plural, 10 {{START_BOLD_TEXT}ten{CLOSE_BOLD_TEXT}} other {{START_TAG_DIV}other{CLOSE_TAG_DIV}}}'\n+        literal(\n+            '{VAR_PLURAL, plural, 10 {{START_BOLD_TEXT}ten{CLOSE_BOLD_TEXT}} other {{START_TAG_DIV}other{CLOSE_TAG_DIV}}}')\n       ],\n       placeHolders: []\n     });\n@@ -427,7 +492,8 @@ describe('serializeI18nMessageForLocalize', () => {\n   it('should serialize ICU with embedded interpolation for `$localize()`', () => {\n     expect(serialize('{age, plural, 10 {<b>ten</b>} other {{{age}} years old}}')).toEqual({\n       messageParts: [\n-        '{VAR_PLURAL, plural, 10 {{START_BOLD_TEXT}ten{CLOSE_BOLD_TEXT}} other {{INTERPOLATION} years old}}'\n+        literal(\n+            '{VAR_PLURAL, plural, 10 {{START_BOLD_TEXT}ten{CLOSE_BOLD_TEXT}} other {{INTERPOLATION} years old}}')\n       ],\n       placeHolders: []\n     });\n@@ -438,8 +504,11 @@ describe('serializeI18nMessageForLocalize', () => {\n         serialize(\n             '{gender, select, male {male} female {female} other {other}}<div>{gender, select, male {male} female {female} other {other}}</div>'))\n         .toEqual({\n-          messageParts: ['', '', '', '', ''],\n-          placeHolders: ['ICU', 'START_TAG_DIV', 'ICU', 'CLOSE_TAG_DIV']\n+          messageParts: [literal(''), literal(''), literal(''), literal(''), literal('')],\n+          placeHolders: [\n+            placeholder('ICU'), placeholder('START_TAG_DIV'), placeholder('ICU'),\n+            placeholder('CLOSE_TAG_DIV')\n+          ]\n         });\n   });\n \n@@ -449,7 +518,8 @@ describe('serializeI18nMessageForLocalize', () => {\n             '{age, plural, 10 {ten {size, select, 1 {{{ varOne }}} 2 {{{ varTwo }}} other {2+}}} other {other}}'))\n         .toEqual({\n           messageParts: [\n-            '{VAR_PLURAL, plural, 10 {ten {VAR_SELECT, select, 1 {{INTERPOLATION}} 2 {{INTERPOLATION_1}} other {2+}}} other {other}}'\n+            literal(\n+                '{VAR_PLURAL, plural, 10 {ten {VAR_SELECT, select, 1 {{INTERPOLATION}} 2 {{INTERPOLATION_1}} other {2+}}} other {other}}')\n           ],\n           placeHolders: []\n         });\n@@ -486,3 +556,11 @@ describe('serializeIcuNode', () => {\n         .toEqual('{VAR_SELECT, select, 10 {ten} other {{INTERPOLATION} years old}}');\n   });\n });\n+\n+function literal(text: string, span: any = jasmine.any(ParseSourceSpan)): o.LiteralPiece {\n+  return new o.LiteralPiece(text, span);\n+}\n+\n+function placeholder(name: string, span: any = jasmine.any(ParseSourceSpan)): o.PlaceholderPiece {\n+  return new o.PlaceholderPiece(name, span);\n+}"
        }
    ],
    "stats": {
        "total": 286,
        "additions": 191,
        "deletions": 95
    }
}