{
    "author": "devversion",
    "message": "refactor: setup bundling for `@angular/compiler-cli` package (#43431)\n\nAll other frameworks packages are now using APF v13 and are strict\nESM packages. The compiler-cli does not use APF and is currently shipped\nwith its devmode ES5 CommonJS sources. This is problematic as CommonJS\ncannot simply import from ECMAScript modules (like `@angular/compiler`).\n\nTo fix this we use a bundler that allows us to ship the compiler-cli as\na strict ESM package. Note: An ESM can import from an ESM without any\nproblems. This is what we need hre.\n\nUnfortunatley we need a bundler here because converting the compiler-cli\nto ESM is non-trivial as relative imports would need an explicit\n`.js` extension. This work can be simplified by using a bundler that\navoids relative imports completely.\n\nNote: This commit uses code-splitting to create multiple bundle\nentry-points for `yarn ngc, `yarn ngcc` etc. This commit removed\nthe old `ivy-ngcc` entry-point that just printed an error message\n(to reduce amount of bundles having to be configured).\n\nPR Close #43431",
    "sha": "c065f1b87a1c53d7ce731078fc1ee287eb79258b",
    "files": [
        {
            "sha": "15229811e142af424614d83ca3f15ced5f333e2e",
            "filename": "packages/compiler-cli/BUILD.bazel",
            "status": "modified",
            "additions": 54,
            "deletions": 8,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2FBUILD.bazel?ref=c065f1b87a1c53d7ce731078fc1ee287eb79258b",
            "patch": "@@ -1,11 +1,60 @@\n load(\"//tools:defaults.bzl\", \"api_golden_test\", \"pkg_npm\", \"ts_config\", \"ts_library\")\n+load(\"@npm//@bazel/esbuild:index.bzl\", \"esbuild\", \"esbuild_config\")\n \n # Load ng_perf_flag explicitly from ng_perf.bzl as it's private API, and not exposed to other\n # consumers of @angular/bazel.\n load(\"//packages/bazel/src:ng_perf.bzl\", \"ng_perf_flag\")\n \n package(default_visibility = [\"//visibility:public\"])\n \n+PUBLIC_TARGETS = [\n+    \":compiler-cli\",\n+    \"//packages/compiler-cli/ngcc\",\n+    \"//packages/compiler-cli/linker\",\n+    \"//packages/compiler-cli/linker/babel\",\n+]\n+\n+esbuild_config(\n+    name = \"esbuild_config\",\n+    config_file = \"esbuild.config.js\",\n+)\n+\n+esbuild(\n+    name = \"bundles\",\n+    config = \":esbuild_config\",\n+    entry_points = [\n+        \":index.ts\",\n+        \"//packages/compiler-cli:src/bin/ngc.ts\",\n+        \"//packages/compiler-cli/ngcc:main-ngcc.ts\",\n+        \"//packages/compiler-cli/ngcc:index.ts\",\n+        \"//packages/compiler-cli:src/bin/ng_xi18n.ts\",\n+        \"//packages/compiler-cli/linker:index.ts\",\n+        \"//packages/compiler-cli/linker/babel:index.ts\",\n+    ],\n+    external = [\n+        \"@angular/compiler\",\n+        \"typescript\",\n+        \"@babel/core\",\n+        \"@babel/types\",\n+        \"reflect-metadata\",\n+        \"minimist\",\n+        \"canonical-path\",\n+        \"chokidar\",\n+        \"convert-source-map\",\n+        \"dependency-graph\",\n+        \"magic-string\",\n+        \"semver\",\n+        \"source-map\",\n+        \"sourcemap-codec\",\n+        \"tslib\",\n+        \"yargs\",\n+    ],\n+    format = \"esm\",\n+    platform = \"node\",\n+    target = \"node14\",\n+    deps = PUBLIC_TARGETS,\n+)\n+\n ts_config(\n     name = \"tsconfig\",\n     src = \"tsconfig-build.json\",\n@@ -63,14 +112,11 @@ pkg_npm(\n         \"//integration:__pkg__\",\n         \"//packages/compiler-cli/integrationtest:__pkg__\",\n     ],\n-    deps = [\n-        \":compiler-cli\",\n-        \"//packages/compiler-cli/linker\",\n-        \"//packages/compiler-cli/linker/babel\",\n-        \"//packages/compiler-cli/ngcc\",\n-        \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n-        \"//packages/compiler-cli/src/ngtsc/logging/testing\",\n-    ],\n+    # Note: We add `PUBLIC_TARGETS` here to pull in the type definitions into\n+    # the NPM package. This also brings in the devmode ES5 sources currently.\n+    # These are not referenced anywhere but we would want to only include types.\n+    # TODO(devversion): add support for including only type definitions here.\n+    deps = [\":bundles\"] + PUBLIC_TARGETS,\n )\n \n api_golden_test("
        },
        {
            "sha": "eb62a12301cbea69796ca62a4b2ff41abc55f981",
            "filename": "packages/compiler-cli/esbuild.config.js",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fesbuild.config.js",
            "raw_url": "https://github.com/angular/angular/raw/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fesbuild.config.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fesbuild.config.js?ref=c065f1b87a1c53d7ce731078fc1ee287eb79258b",
            "patch": "@@ -0,0 +1,24 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+module.exports = {\n+  resolveExtensions: ['.mjs', '.js'],\n+  // Note: `@bazel/esbuild` has a bug and does not pass-through the format from Starlark.\n+  format: 'esm',\n+  banner: {\n+    // Workaround for: https://github.com/evanw/esbuild/issues/946\n+    // We also define `__ESM_IMPORT_META_URL__` because we cannot use `import.meta.url`\n+    // in our sources yet. The devmode CommonJS output will otherwise break.\n+    // TODO: Remove this workaround in the future once devmode is ESM as well.\n+    js: `\n+      import {createRequire as __cjsCompatRequire} from 'module';\n+      const require = __cjsCompatRequire(import.meta.url);\n+      const __ESM_IMPORT_META_URL__ = import.meta.url;\n+    `,\n+  },\n+};"
        },
        {
            "sha": "9d5a7f824a76198408f4141cca576428574663b1",
            "filename": "packages/compiler-cli/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Findex.ts?ref=c065f1b87a1c53d7ce731078fc1ee287eb79258b",
            "patch": "@@ -8,6 +8,7 @@\n import {NodeJSFileSystem, setFileSystem} from './src/ngtsc/file_system';\n \n export {AotCompilerHost, AotCompilerHost as StaticReflectorHost, StaticReflector, StaticSymbol} from '@angular/compiler';\n+\n export {VERSION} from './src/version';\n \n export * from './src/metadata';"
        },
        {
            "sha": "37c090d863203f1fcee6e9405e2bc4fdc9fdf1f6",
            "filename": "packages/compiler-cli/ngcc/main-ivy-ngcc.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/6e7ef195a5129b5fcd0076b2f478723713f9180f/packages%2Fcompiler-cli%2Fngcc%2Fmain-ivy-ngcc.ts",
            "raw_url": "https://github.com/angular/angular/raw/6e7ef195a5129b5fcd0076b2f478723713f9180f/packages%2Fcompiler-cli%2Fngcc%2Fmain-ivy-ngcc.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fmain-ivy-ngcc.ts?ref=6e7ef195a5129b5fcd0076b2f478723713f9180f",
            "patch": "@@ -1,12 +0,0 @@\n-#!/usr/bin/env node\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-console.error(\n-    new Error('The \\'ivy-ngcc\\' command was renamed to just \\'ngcc\\'. Please update your usage.'));\n-process.exit(1);"
        },
        {
            "sha": "a320fcffb63ef57e0947e1fa60b13d72f76f6268",
            "filename": "packages/compiler-cli/ngcc/main-ngcc.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 17,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fngcc%2Fmain-ngcc.ts",
            "raw_url": "https://github.com/angular/angular/raw/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fngcc%2Fmain-ngcc.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fmain-ngcc.ts?ref=c065f1b87a1c53d7ce731078fc1ee287eb79258b",
            "patch": "@@ -10,21 +10,19 @@ import {mainNgcc} from './src/main';\n import {parseCommandLineOptions} from './src/command_line_options';\n \n // CLI entry point\n-if (require.main === module) {\n-  process.title = 'ngcc';\n-  const startTime = Date.now();\n-  const options = parseCommandLineOptions(process.argv.slice(2));\n-  (async () => {\n-    try {\n-      await mainNgcc(options);\n-      if (options.logger) {\n-        const duration = Math.round((Date.now() - startTime) / 1000);\n-        options.logger.debug(`Run ngcc in ${duration}s.`);\n-      }\n-      process.exitCode = 0;\n-    } catch (e) {\n-      console.error(e.stack || e.message);\n-      process.exit(typeof e.code === 'number' ? e.code : 1);\n+process.title = 'ngcc';\n+const startTime = Date.now();\n+const options = parseCommandLineOptions(process.argv.slice(2));\n+(async () => {\n+  try {\n+    await mainNgcc(options);\n+    if (options.logger) {\n+      const duration = Math.round((Date.now() - startTime) / 1000);\n+      options.logger.debug(`Run ngcc in ${duration}s.`);\n     }\n-  })();\n-}\n+    process.exitCode = 0;\n+  } catch (e) {\n+    console.error(e.stack || e.message);\n+    process.exit(typeof e.code === 'number' ? e.code : 1);\n+  }\n+})();"
        },
        {
            "sha": "c93cafacc71425960584a0614cd9a5bbd5e2a37a",
            "filename": "packages/compiler-cli/package.json",
            "status": "modified",
            "additions": 21,
            "deletions": 5,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fpackage.json?ref=c065f1b87a1c53d7ce731078fc1ee287eb79258b",
            "patch": "@@ -2,13 +2,29 @@\n   \"name\": \"@angular/compiler-cli\",\n   \"version\": \"0.0.0-PLACEHOLDER\",\n   \"description\": \"Angular - the compiler CLI for Node.js\",\n-  \"main\": \"index.js\",\n   \"typings\": \"index.d.ts\",\n   \"bin\": {\n-    \"ivy-ngcc\": \"./ngcc/main-ivy-ngcc.js\",\n-    \"ngcc\": \"./ngcc/main-ngcc.js\",\n-    \"ngc\": \"./src/main.js\",\n-    \"ng-xi18n\": \"./src/extract_i18n.js\"\n+    \"ngcc\": \"./bundles/ngcc/main-ngcc.js\",\n+    \"ngc\": \"./bundles/src/bin/ngc.js\",\n+    \"ng-xi18n\": \"./bundles/src/bin/ng_xi18n.js\"\n+  },\n+  \"type\": \"module\",\n+  \"exports\": {\n+    \".\": {\n+      \"types\": \"./index.d.ts\",\n+      \"default\": \"./bundles/index.js\"\n+    },\n+    \"./package.json\": {\n+      \"default\": \"./package.json\"\n+    },\n+    \"./linker\": {\n+      \"types\": \"./linker/index.d.ts\",\n+      \"default\": \"./bundles/linker/index.js\"\n+    },\n+    \"./linker/babel\": {\n+      \"types\": \"./linker/babel/index.d.ts\",\n+      \"default\": \"./bundles/linker/babel/index.js\"\n+    }\n   },\n   \"dependencies\": {\n     \"@babel/core\": \"^7.8.6\","
        },
        {
            "sha": "2dd422c2e401f10bb0196261698d8a33d4f31710",
            "filename": "packages/compiler-cli/src/bin/ng_xi18n.ts",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fsrc%2Fbin%2Fng_xi18n.ts",
            "raw_url": "https://github.com/angular/angular/raw/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fsrc%2Fbin%2Fng_xi18n.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fbin%2Fng_xi18n.ts?ref=c065f1b87a1c53d7ce731078fc1ee287eb79258b",
            "patch": "@@ -0,0 +1,20 @@\n+#!/usr/bin/env node\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+// Must be imported first, because Angular decorators throw on load.\n+import 'reflect-metadata';\n+\n+import {NodeJSFileSystem, setFileSystem} from '../ngtsc/file_system';\n+import {mainXi18n} from '../extract_i18n';\n+\n+process.title = 'Angular i18n Message Extractor (ng-xi18n)';\n+const args = process.argv.slice(2);\n+// We are running the real compiler so run against the real file-system\n+setFileSystem(new NodeJSFileSystem());\n+process.exitCode = mainXi18n(args);"
        },
        {
            "sha": "103aa26509b4e4d5eeda760613205dfe39d77d9e",
            "filename": "packages/compiler-cli/src/bin/ngc.ts",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fsrc%2Fbin%2Fngc.ts",
            "raw_url": "https://github.com/angular/angular/raw/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fsrc%2Fbin%2Fngc.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fbin%2Fngc.ts?ref=c065f1b87a1c53d7ce731078fc1ee287eb79258b",
            "patch": "@@ -0,0 +1,20 @@\n+#!/usr/bin/env node\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+// Must be imported first, because Angular decorators throw on load.\n+import 'reflect-metadata';\n+\n+import {NodeJSFileSystem, setFileSystem} from '../ngtsc/file_system';\n+import {main} from '../main';\n+\n+process.title = 'Angular Compiler (ngc)';\n+const args = process.argv.slice(2);\n+// We are running the real compiler so run against the real file-system\n+setFileSystem(new NodeJSFileSystem());\n+process.exitCode = main(args);"
        },
        {
            "sha": "8e8d7f891182585b11c15d6bb1417706987c027b",
            "filename": "packages/compiler-cli/src/extract_i18n.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 13,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fsrc%2Fextract_i18n.ts",
            "raw_url": "https://github.com/angular/angular/raw/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fsrc%2Fextract_i18n.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fextract_i18n.ts?ref=c065f1b87a1c53d7ce731078fc1ee287eb79258b",
            "patch": "@@ -1,4 +1,3 @@\n-#!/usr/bin/env node\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n@@ -10,12 +9,10 @@\n /**\n  * Extract i18n messages from source code\n  */\n-// Must be imported first, because Angular decorators throw on load.\n-import 'reflect-metadata';\n+\n import * as api from './transformers/api';\n import {ParsedConfiguration} from './perform_compile';\n import {main, readCommandLineAndConfiguration} from './main';\n-import {setFileSystem, NodeJSFileSystem} from './ngtsc/file_system';\n \n export function mainXi18n(\n     args: string[], consoleError: (msg: string) => void = console.error): number {\n@@ -38,12 +35,3 @@ function readXi18nCommandLineAndConfiguration(args: string[]): ParsedConfigurati\n   // only emit the i18nBundle but nothing else.\n   return {...config, emitFlags: api.EmitFlags.I18nBundle};\n }\n-\n-// Entry point\n-if (require.main === module) {\n-  process.title = 'Angular i18n Message Extractor (ng-xi18n)';\n-  const args = process.argv.slice(2);\n-  // We are running the real compiler so run against the real file-system\n-  setFileSystem(new NodeJSFileSystem());\n-  process.exitCode = mainXi18n(args);\n-}"
        },
        {
            "sha": "872407caeb4149b1cb19a47fa375ad153c790694",
            "filename": "packages/compiler-cli/src/main.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 19,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fsrc%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/c065f1b87a1c53d7ce731078fc1ee287eb79258b/packages%2Fcompiler-cli%2Fsrc%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fmain.ts?ref=c065f1b87a1c53d7ce731078fc1ee287eb79258b",
            "patch": "@@ -1,4 +1,3 @@\n-#!/usr/bin/env node\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n@@ -7,20 +6,14 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-// Must be imported first, because Angular decorators throw on load.\n-import 'reflect-metadata';\n-\n-import * as ts from 'typescript';\n import * as tsickle from 'tsickle';\n+import * as ts from 'typescript';\n \n-import {replaceTsWithNgInErrors} from './ngtsc/diagnostics';\n+import {Diagnostics, exitCodeFromResult, filterErrorsAndWarnings, formatDiagnostics, ParsedConfiguration, performCompilation, readConfiguration} from './perform_compile';\n+import {createPerformWatchHost, performWatchCompilation} from './perform_watch';\n import * as api from './transformers/api';\n import {GENERATED_FILES} from './transformers/util';\n \n-import {exitCodeFromResult, performCompilation, readConfiguration, formatDiagnostics, Diagnostics, ParsedConfiguration, filterErrorsAndWarnings} from './perform_compile';\n-import {performWatchCompilation,Â createPerformWatchHost} from './perform_watch';\n-import {NodeJSFileSystem, setFileSystem} from './ngtsc/file_system';\n-\n export function main(\n     args: string[], consoleError: (s: string) => void = console.error,\n     config?: NgcParsedConfiguration, customTransformers?: api.CustomTransformers, programReuse?: {\n@@ -230,12 +223,3 @@ function printDiagnostics(\n   const formatHost = getFormatDiagnosticsHost(options);\n   consoleError(formatDiagnostics(diagnostics, formatHost));\n }\n-\n-// CLI entry point\n-if (require.main === module) {\n-  process.title = 'Angular Compiler (ngc)';\n-  const args = process.argv.slice(2);\n-  // We are running the real compiler so run against the real file-system\n-  setFileSystem(new NodeJSFileSystem());\n-  process.exitCode = main(args);\n-}"
        }
    ],
    "stats": {
        "total": 233,
        "additions": 159,
        "deletions": 74
    }
}