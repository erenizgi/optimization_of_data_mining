{
    "author": "arturovt",
    "message": "fix(animations): cleanup DOM elements when the root view is removed (#41059)\n\nCurrently, when importing `BrowserAnimationsModule`, Angular uses `AnimationRenderer`\nas the renderer. When the root view is removed, the `AnimationRenderer` defers the actual\nwork to the `TransitionAnimationEngine` to do this, and the `TransitionAnimationEngine`\ndoesn't actually remove the DOM node, but just calls `markElementAsRemoved()`.\n\nThe actual DOM node is not removed until `TransitionAnimationEngine` \"flushes\".\n\nUnfortunately, though, that \"flush\" will never happen, since the root view is being\ndestroyed and there will be no more flushes.\n\nThis commit adds `flush()` call when the root view is being destroyed.\n\nBREAKING CHANGE:\nDOM elements are now correctly removed when the root view is removed.\nIf you are using SSR and use the app's HTML for rendering, you will need\nto ensure that you save the HTML to a variable before destorying the\napp.\nIt is also possible that tests could be accidentally relying on the old behavior by\ntrying to find an element that was not removed in a previous test. If\nthis is the case, the failing tests should be updated to ensure they\nhave proper setup code which initializes elements they rely on.\n\nPR Close #41059",
    "sha": "c49b28013a6c017c9afc73bbc00bb4fdcf15c70e",
    "files": [
        {
            "sha": "1cb7f6e1510574f7fde85db74bc41c3abafbc050",
            "filename": "packages/platform-browser/animations/src/providers.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/c49b28013a6c017c9afc73bbc00bb4fdcf15c70e/packages%2Fplatform-browser%2Fanimations%2Fsrc%2Fproviders.ts",
            "raw_url": "https://github.com/angular/angular/raw/c49b28013a6c017c9afc73bbc00bb4fdcf15c70e/packages%2Fplatform-browser%2Fanimations%2Fsrc%2Fproviders.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Fanimations%2Fsrc%2Fproviders.ts?ref=c49b28013a6c017c9afc73bbc00bb4fdcf15c70e",
            "patch": "@@ -9,18 +9,22 @@\n import {AnimationBuilder} from '@angular/animations';\n import {AnimationDriver, ɵAnimationEngine as AnimationEngine, ɵAnimationStyleNormalizer as AnimationStyleNormalizer, ɵCssKeyframesDriver as CssKeyframesDriver, ɵNoopAnimationDriver as NoopAnimationDriver, ɵsupportsWebAnimations as supportsWebAnimations, ɵWebAnimationsDriver as WebAnimationsDriver, ɵWebAnimationsStyleNormalizer as WebAnimationsStyleNormalizer} from '@angular/animations/browser';\n import {DOCUMENT} from '@angular/common';\n-import {Inject, Injectable, InjectionToken, NgZone, Provider, RendererFactory2} from '@angular/core';\n+import {Inject, Injectable, InjectionToken, NgZone, OnDestroy, Provider, RendererFactory2} from '@angular/core';\n import {ɵDomRendererFactory2 as DomRendererFactory2} from '@angular/platform-browser';\n \n import {BrowserAnimationBuilder} from './animation_builder';\n import {AnimationRendererFactory} from './animation_renderer';\n \n @Injectable()\n-export class InjectableAnimationEngine extends AnimationEngine {\n+export class InjectableAnimationEngine extends AnimationEngine implements OnDestroy {\n   constructor(\n       @Inject(DOCUMENT) doc: any, driver: AnimationDriver, normalizer: AnimationStyleNormalizer) {\n     super(doc.body, driver, normalizer);\n   }\n+\n+  ngOnDestroy(): void {\n+    this.flush();\n+  }\n }\n \n export function instantiateSupportedAnimationDriver() {"
        },
        {
            "sha": "75bc50de601ecb9a0bafbfd5620e1d2dc8266b26",
            "filename": "packages/platform-browser/animations/test/animation_renderer_spec.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 1,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/c49b28013a6c017c9afc73bbc00bb4fdcf15c70e/packages%2Fplatform-browser%2Fanimations%2Ftest%2Fanimation_renderer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c49b28013a6c017c9afc73bbc00bb4fdcf15c70e/packages%2Fplatform-browser%2Fanimations%2Ftest%2Fanimation_renderer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Fanimations%2Ftest%2Fanimation_renderer_spec.ts?ref=c49b28013a6c017c9afc73bbc00bb4fdcf15c70e",
            "patch": "@@ -7,10 +7,12 @@\n  */\n import {animate, AnimationPlayer, AnimationTriggerMetadata, state, style, transition, trigger} from '@angular/animations';\n import {ɵAnimationEngine as AnimationEngine} from '@angular/animations/browser';\n-import {Component, Injectable, NgZone, RendererFactory2, RendererType2, ViewChild} from '@angular/core';\n+import {Component, destroyPlatform, Injectable, NgModule, NgZone, RendererFactory2, RendererType2, ViewChild} from '@angular/core';\n import {TestBed} from '@angular/core/testing';\n+import {platformBrowserDynamic} from '@angular/platform-browser-dynamic';\n import {BrowserAnimationsModule, ɵAnimationRendererFactory as AnimationRendererFactory, ɵInjectableAnimationEngine as InjectableAnimationEngine} from '@angular/platform-browser/animations';\n import {DomRendererFactory2} from '@angular/platform-browser/src/dom/dom_renderer';\n+import {onlyInIvy, withBody} from '@angular/private/testing';\n \n import {el} from '../../testing/src/browser_util';\n \n@@ -323,6 +325,37 @@ describe('AnimationRendererFactory', () => {\n     expect(renderer.log).toEqual(['begin', 'end']);\n   });\n });\n+\n+onlyInIvy('View Engine uses another mechanism of removing DOM nodes').describe('destroy', () => {\n+  beforeEach(destroyPlatform);\n+  afterEach(destroyPlatform);\n+\n+  it('should clear bootstrapped component contents',\n+     withBody('<div>before</div><app-root></app-root><div>after</div>', async () => {\n+       @Component({selector: 'app-root', template: 'app-root content'})\n+       class AppComponent {\n+       }\n+\n+       @NgModule({\n+         imports: [BrowserAnimationsModule],\n+         declarations: [AppComponent],\n+         bootstrap: [AppComponent]\n+       })\n+       class AppModule {\n+       }\n+\n+       const ngModuleRef = await platformBrowserDynamic().bootstrapModule(AppModule);\n+\n+       const root = document.body.querySelector('app-root')!;\n+       expect(root.textContent).toEqual('app-root content');\n+       expect(document.body.childNodes.length).toEqual(3);\n+\n+       ngModuleRef.destroy();\n+\n+       expect(document.body.querySelector('app-root')).toBeFalsy();  // host element is removed\n+       expect(document.body.childNodes.length).toEqual(2);           // other elements are preserved\n+     }));\n+});\n })();\n \n @Injectable()"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 40,
        "deletions": 3
    }
}