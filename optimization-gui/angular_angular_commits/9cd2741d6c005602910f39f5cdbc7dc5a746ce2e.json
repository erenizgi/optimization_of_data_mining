{
    "author": "gkalpak",
    "message": "test(elements): fix `ComponentNgElementStrategy` test for components without `ngOnChanges` (#39452)\n\n`ComponentNgElementStrategy` is supposed to call `ngOnChanges()` on the\nunderlying component instance if available, but not fail if the\ncomponent does not have an `ngOnChanges()` method. This works as\nexpected. However, the test used to verify that was invalid; i.e. the\ntest would pass even if `ComponentNgElementStrategy` would try to call\n`ngOnChanges()` on a component without such a method.\n\nThis commit replaces the invalid test with a new one that correctly\nverifies that `ComponentNgElementStrategy` does not try to call\n`ngOnChanges()`.\n\nPR Close #39452",
    "sha": "9cd2741d6c005602910f39f5cdbc7dc5a746ce2e",
    "files": [
        {
            "sha": "d2ae5d2fa928f8151feae54b4632bfc14ada3429",
            "filename": "packages/elements/test/component-factory-strategy_spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 13,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/9cd2741d6c005602910f39f5cdbc7dc5a746ce2e/packages%2Felements%2Ftest%2Fcomponent-factory-strategy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9cd2741d6c005602910f39f5cdbc7dc5a746ce2e/packages%2Felements%2Ftest%2Fcomponent-factory-strategy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Felements%2Ftest%2Fcomponent-factory-strategy_spec.ts?ref=9cd2741d6c005602910f39f5cdbc7dc5a746ce2e",
            "patch": "@@ -14,7 +14,7 @@ import {ComponentNgElementStrategy, ComponentNgElementStrategyFactory} from '../\n import {NgElementStrategyEvent} from '../src/element-strategy';\n \n describe('ComponentFactoryNgElementStrategy', () => {\n-  let factory: FakeComponentFactory;\n+  let factory: FakeComponentFactory<typeof FakeComponent>;\n   let strategy: ComponentNgElementStrategy;\n \n   let injector: any;\n@@ -25,7 +25,7 @@ describe('ComponentFactoryNgElementStrategy', () => {\n   let injectables: Map<unknown, unknown>;\n \n   beforeEach(() => {\n-    factory = new FakeComponentFactory();\n+    factory = new FakeComponentFactory(FakeComponent);\n     componentRef = factory.componentRef;\n \n     applicationRef = jasmine.createSpyObj('applicationRef', ['attachView']);\n@@ -163,13 +163,6 @@ describe('ComponentFactoryNgElementStrategy', () => {\n        }));\n   });\n \n-  it('should not call ngOnChanges if not present on the component', () => {\n-    factory.componentRef.instance = new FakeComponentWithoutNgOnChanges();\n-\n-    // Should simply succeed without problems (did not try to call ngOnChanges)\n-    strategy.connect(document.createElement('div'));\n-  });\n-\n   describe('when inputs change and not connected', () => {\n     it('should cache the value', () => {\n       strategy.setInputValue('fooFoo', 'fooFoo-1');\n@@ -252,6 +245,22 @@ describe('ComponentFactoryNgElementStrategy', () => {\n            barBar: new SimpleChange('barBar-1', 'barBar-2', false)\n          });\n        }));\n+\n+    it('should not try to call ngOnChanges if not present on the component', fakeAsync(() => {\n+         const factory2 = new FakeComponentFactory(FakeComponentWithoutNgOnChanges);\n+         const strategy2 = new ComponentNgElementStrategy(factory2, injector);\n+         const changeDetectorRef2 = factory2.componentRef.changeDetectorRef;\n+\n+         strategy2.connect(document.createElement('div'));\n+         changeDetectorRef2.detectChanges.calls.reset();\n+\n+         strategy2.setInputValue('fooFoo', 'fooFoo-1');\n+         expect(() => tick(16)).not.toThrow();  // scheduler waits 16ms if RAF is unavailable\n+\n+         // If the strategy would have tried to call `component.ngOnChanges()`, an error would have\n+         // been thrown and `changeDetectorRef2.detectChanges()` would not have been called.\n+         expect(changeDetectorRef2.detectChanges).toHaveBeenCalledTimes(1);\n+       }));\n   });\n \n   describe('disconnect', () => {\n@@ -327,7 +336,7 @@ export class FakeComponent {\n   }\n }\n \n-export class FakeComponentFactory extends ComponentFactory<any> {\n+export class FakeComponentFactory<T extends Type<any>> extends ComponentFactory<T> {\n   componentRef: any = jasmine.createSpyObj(\n       'componentRef',\n       // Method spies.\n@@ -336,14 +345,14 @@ export class FakeComponentFactory extends ComponentFactory<any> {\n       {\n         changeDetectorRef: jasmine.createSpyObj('changeDetectorRef', ['detectChanges']),\n         hostView: {},\n-        instance: new FakeComponent(),\n+        instance: new this.ComponentClass(),\n       });\n \n   get selector(): string {\n     return 'fake-component';\n   }\n   get componentType(): Type<any> {\n-    return FakeComponent;\n+    return this.ComponentClass;\n   }\n   get ngContentSelectors(): string[] {\n     return ['content-1', 'content-2'];\n@@ -359,14 +368,17 @@ export class FakeComponentFactory extends ComponentFactory<any> {\n       {propName: 'falsyZero', templateName: 'falsyZero'},\n     ];\n   }\n-\n   get outputs(): {propName: string; templateName: string}[] {\n     return [\n       {propName: 'output1', templateName: 'templateOutput1'},\n       {propName: 'output2', templateName: 'templateOutput2'},\n     ];\n   }\n \n+  constructor(private ComponentClass: T) {\n+    super();\n+  }\n+\n   create(\n       injector: Injector, projectableNodes?: any[][], rootSelectorOrNode?: string|any,\n       ngModule?: NgModuleRef<any>): ComponentRef<any> {"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 25,
        "deletions": 13
    }
}