{
    "author": "josephperrott",
    "message": "fix(dev-infra): clear cached bazel outputs before building artifacts for publishing (#41000)\n\nClearing the cached bazel outputs before building the artifacts for\npublishing prevents an intermittent error found when the version is\ncached between publishes.\n\nPR Close #41000",
    "sha": "f05715bcac4b6829e7f7ab6bf9f94609b97f9107",
    "files": [
        {
            "sha": "9c7081da263ea309113d0fae0acbb8f0f1b4c186",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/f05715bcac4b6829e7f7ab6bf9f94609b97f9107/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/f05715bcac4b6829e7f7ab6bf9f94609b97f9107/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=f05715bcac4b6829e7f7ab6bf9f94609b97f9107",
            "patch": "@@ -5392,6 +5392,25 @@ function invokeYarnInstallCommand(projectDir) {\n         }\n     });\n }\n+/**\n+ * Invokes the `yarn bazel clean` command in order to clean the output tree and ensure new artifacts\n+ * are created for builds.\n+ */\n+function invokeBazelCleanCommand(projectDir) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        try {\n+            // Note: No progress indicator needed as that is the responsibility of the command.\n+            // TODO: Consider using an Ora spinner instead to ensure minimal console output.\n+            yield spawnWithDebugOutput('yarn', ['bazel', 'clean'], { cwd: projectDir });\n+            info(green('  ✓   Cleaned bazel output tree.'));\n+        }\n+        catch (e) {\n+            error(e);\n+            error(red('  ✘   An error occurred while cleaning the bazel output tree.'));\n+            throw new FatalReleaseActionError();\n+        }\n+    });\n+}\n \n /**\n  * @license\n@@ -5931,6 +5950,7 @@ class ReleaseAction {\n             // created in the `next` branch. The new package would not be part of the patch branch,\n             // so we cannot build and publish it.\n             yield invokeYarnInstallCommand(this.projectDir);\n+            yield invokeBazelCleanCommand(this.projectDir);\n             const builtPackages = yield invokeReleaseBuildCommand();\n             // Verify the packages built are the correct version.\n             yield this._verifyPackageVersions(newVersion, builtPackages);"
        },
        {
            "sha": "56c77b4f2573352752a37c4c4ec5538c022b4793",
            "filename": "dev-infra/release/publish/actions.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/f05715bcac4b6829e7f7ab6bf9f94609b97f9107/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "raw_url": "https://github.com/angular/angular/raw/f05715bcac4b6829e7f7ab6bf9f94609b97f9107/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions.ts?ref=f05715bcac4b6829e7f7ab6bf9f94609b97f9107",
            "patch": "@@ -21,7 +21,7 @@ import {runNpmPublish} from '../versioning/npm-publish';\n import {FatalReleaseActionError, UserAbortedReleaseActionError} from './actions-error';\n import {getCommitMessageForRelease, getReleaseNoteCherryPickCommitMessage} from './commit-message';\n import {changelogPath, packageJsonPath, waitForPullRequestInterval} from './constants';\n-import {invokeReleaseBuildCommand, invokeYarnInstallCommand} from './external-commands';\n+import {invokeBazelCleanCommand, invokeReleaseBuildCommand, invokeYarnInstallCommand} from './external-commands';\n import {findOwnedForksOfRepoQuery} from './graphql-queries';\n import {getPullRequestState} from './pull-request-state';\n import {getDefaultExtractReleaseNotesPattern, getLocalChangelogFilePath} from './release-notes';\n@@ -515,6 +515,7 @@ export abstract class ReleaseAction {\n     // created in the `next` branch. The new package would not be part of the patch branch,\n     // so we cannot build and publish it.\n     await invokeYarnInstallCommand(this.projectDir);\n+    await invokeBazelCleanCommand(this.projectDir);\n     const builtPackages = await invokeReleaseBuildCommand();\n \n     // Verify the packages built are the correct version."
        },
        {
            "sha": "2892bc47daa6c84acaa9ce756945e941f907d8b9",
            "filename": "dev-infra/release/publish/external-commands.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/f05715bcac4b6829e7f7ab6bf9f94609b97f9107/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts",
            "raw_url": "https://github.com/angular/angular/raw/f05715bcac4b6829e7f7ab6bf9f94609b97f9107/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts?ref=f05715bcac4b6829e7f7ab6bf9f94609b97f9107",
            "patch": "@@ -90,3 +90,20 @@ export async function invokeYarnInstallCommand(projectDir: string): Promise<void\n     throw new FatalReleaseActionError();\n   }\n }\n+\n+/**\n+ * Invokes the `yarn bazel clean` command in order to clean the output tree and ensure new artifacts\n+ * are created for builds.\n+ */\n+export async function invokeBazelCleanCommand(projectDir: string): Promise<void> {\n+  try {\n+    // Note: No progress indicator needed as that is the responsibility of the command.\n+    // TODO: Consider using an Ora spinner instead to ensure minimal console output.\n+    await spawnWithDebugOutput('yarn', ['bazel', 'clean'], {cwd: projectDir});\n+    info(green('  ✓   Cleaned bazel output tree.'));\n+  } catch (e) {\n+    error(e);\n+    error(red('  ✘   An error occurred while cleaning the bazel output tree.'));\n+    throw new FatalReleaseActionError();\n+  }\n+}"
        },
        {
            "sha": "3b36e0f6de6d76f04705eb6177c24b08c8987862",
            "filename": "dev-infra/release/publish/test/test-utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/f05715bcac4b6829e7f7ab6bf9f94609b97f9107/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/f05715bcac4b6829e7f7ab6bf9f94609b97f9107/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts?ref=f05715bcac4b6829e7f7ab6bf9f94609b97f9107",
            "patch": "@@ -92,6 +92,7 @@ export function setupReleaseActionForTesting<T extends ReleaseAction>(\n   spyOn(npm, 'runNpmPublish').and.resolveTo();\n   spyOn(externalCommands, 'invokeSetNpmDistCommand').and.resolveTo();\n   spyOn(externalCommands, 'invokeYarnInstallCommand').and.resolveTo();\n+  spyOn(externalCommands, 'invokeBazelCleanCommand').and.resolveTo();\n   spyOn(externalCommands, 'invokeReleaseBuildCommand').and.resolveTo([\n     {name: '@angular/pkg1', outputPath: `${testTmpDir}/dist/pkg1`},\n     {name: '@angular/pkg2', outputPath: `${testTmpDir}/dist/pkg2`}"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 40,
        "deletions": 1
    }
}