{
    "author": "petebacondarwin",
    "message": "docs: fix multicasting observable example (#42258)\n\nThe example did not allow the async sequence to be cancelled\nafter the first timeout had completed.\n\nFixes #25804\n\nPR Close #42258",
    "sha": "e16778d3715436b0ecaa60cc7ad32da45b4bd22b",
    "files": [
        {
            "sha": "58f9d280e6753abfc82cc8cf60ec19ec68e67c86",
            "filename": "aio/content/examples/observables/src/multicasting.spec.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 4,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/e16778d3715436b0ecaa60cc7ad32da45b4bd22b/aio%2Fcontent%2Fexamples%2Fobservables%2Fsrc%2Fmulticasting.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e16778d3715436b0ecaa60cc7ad32da45b4bd22b/aio%2Fcontent%2Fexamples%2Fobservables%2Fsrc%2Fmulticasting.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fobservables%2Fsrc%2Fmulticasting.spec.ts?ref=e16778d3715436b0ecaa60cc7ad32da45b4bd22b",
            "patch": "@@ -1,3 +1,4 @@\n+import { Observable, Subscription } from 'rxjs';\n import { docRegionDelaySequence, docRegionMulticastSequence } from './multicasting';\n \n describe('multicasting', () => {\n@@ -26,23 +27,70 @@ describe('multicasting', () => {\n       ['1st subscribe: 3'],\n       ['1st sequence finished.'],\n       ['2nd subscribe: 3'],\n-      ['2nd sequence finished.']\n+      ['2nd sequence finished.'],\n     ]);\n   });\n \n   it('should create an observable and multicast the emissions', () => {\n     const consoleSpy = jasmine.createSpyObj<Console>('console', ['log']);\n-    docRegionMulticastSequence(consoleSpy);\n+    docRegionMulticastSequence(consoleSpy, /* runSequence */ true);\n     jasmine.clock().tick(10000);\n-    expect(consoleSpy.log).toHaveBeenCalledTimes(7);\n+    expect(consoleSpy.log).toHaveBeenCalledTimes(10);\n     expect(consoleSpy.log.calls.allArgs()).toEqual([\n+      ['Emitting 1'],\n       ['1st subscribe: 1'],\n+      ['Emitting 2'],\n       ['1st subscribe: 2'],\n       ['2nd subscribe: 2'],\n+      ['Emitting 3'],\n       ['1st subscribe: 3'],\n       ['2nd subscribe: 3'],\n       ['1st sequence finished.'],\n-      ['2nd sequence finished.']\n+      ['2nd sequence finished.'],\n     ]);\n   });\n+\n+  it('should stop the sequence emission when the last observer unsubscribes from a multicast observable',\n+    () => {\n+      const consoleSpy = jasmine.createSpyObj<Console>('console', ['log']);\n+      const multicastSequenceSubscriber =\n+        docRegionMulticastSequence(consoleSpy, /* runSequence */ false);\n+\n+      const multicastSequence = new Observable(multicastSequenceSubscriber());\n+\n+      const subscription1 = multicastSequence.subscribe({\n+        next(num) {\n+          consoleSpy.log('1st subscribe: ' + num);\n+        },\n+        complete() {\n+          consoleSpy.log('1st sequence finished.');\n+        }\n+      });\n+\n+      let subscription2: Subscription;\n+      setTimeout(() => {\n+        subscription2 = multicastSequence.subscribe({\n+          next(num) {\n+            consoleSpy.log('2nd subscribe: ' + num);\n+          },\n+          complete() {\n+            consoleSpy.log('2nd sequence finished.');\n+          }\n+        });\n+      }, 1500);\n+\n+      setTimeout(() => subscription1.unsubscribe(), 2500);\n+      setTimeout(() => subscription2.unsubscribe(), 2800);\n+\n+      jasmine.clock().tick(5000);\n+\n+      expect(consoleSpy.log).toHaveBeenCalledTimes(5);\n+      expect(consoleSpy.log.calls.allArgs()).toEqual([\n+        ['Emitting 1'],\n+        ['1st subscribe: 1'],\n+        ['Emitting 2'],\n+        ['1st subscribe: 2'],\n+        ['2nd subscribe: 2'],\n+      ]);\n+    });\n });"
        },
        {
            "sha": "2401802b08f6828603ba6c766b65766cb87d173b",
            "filename": "aio/content/examples/observables/src/multicasting.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 15,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/e16778d3715436b0ecaa60cc7ad32da45b4bd22b/aio%2Fcontent%2Fexamples%2Fobservables%2Fsrc%2Fmulticasting.ts",
            "raw_url": "https://github.com/angular/angular/raw/e16778d3715436b0ecaa60cc7ad32da45b4bd22b/aio%2Fcontent%2Fexamples%2Fobservables%2Fsrc%2Fmulticasting.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fobservables%2Fsrc%2Fmulticasting.ts?ref=e16778d3715436b0ecaa60cc7ad32da45b4bd22b",
            "patch": "@@ -76,7 +76,10 @@ export function docRegionDelaySequence(console: Console) {\n   // #enddocregion subscribe_twice\n }\n \n-export function docRegionMulticastSequence(console: Console) {\n+export function docRegionMulticastSequence(console: Console, runSequence: boolean) {\n+  if (!runSequence) {\n+    return multicastSequenceSubscriber;\n+  }\n   // #docregion multicast_sequence\n   function multicastSequenceSubscriber() {\n     const seq = [1, 2, 3];\n@@ -92,7 +95,7 @@ export function docRegionMulticastSequence(console: Console) {\n       observers.push(observer);\n       // When this is the first subscription, start the sequence\n       if (observers.length === 1) {\n-        timeoutId = doSequence({\n+        const multicastObserver: Observer<number> = {\n           next(val) {\n             // Iterate through observers and notify all subscriptions\n             observers.forEach(obs => obs.next(val));\n@@ -102,7 +105,8 @@ export function docRegionMulticastSequence(console: Console) {\n             // Notify all complete callbacks\n             observers.slice(0).forEach(obs => obs.complete());\n           }\n-        }, seq, 0);\n+        };\n+        doSequence(multicastObserver, seq, 0);\n       }\n \n       return {\n@@ -115,20 +119,21 @@ export function docRegionMulticastSequence(console: Console) {\n           }\n         }\n       };\n-    };\n-  }\n \n-  // Run through an array of numbers, emitting one value\n-  // per second until it gets to the end of the array.\n-  function doSequence(observer: Observer<number>, arr: number[], idx: number) {\n-    return setTimeout(() => {\n-      observer.next(arr[idx]);\n-      if (idx === arr.length - 1) {\n-        observer.complete();\n-      } else {\n-        doSequence(observer, arr, ++idx);\n+      // Run through an array of numbers, emitting one value\n+      // per second until it gets to the end of the array.\n+      function doSequence(sequenceObserver: Observer<number>, arr: number[], idx: number) {\n+        timeoutId = setTimeout(() => {\n+          console.log('Emitting ' + arr[idx]);\n+          sequenceObserver.next(arr[idx]);\n+          if (idx === arr.length - 1) {\n+            sequenceObserver.complete();\n+          } else {\n+            doSequence(sequenceObserver, arr, ++idx);\n+          }\n+        }, 1000);\n       }\n-    }, 1000);\n+    };\n   }\n \n   // Create a new Observable that will deliver the above sequence\n@@ -149,13 +154,18 @@ export function docRegionMulticastSequence(console: Console) {\n   }, 1500);\n \n   // Logs:\n+  // (at 1 second): Emitting 1\n   // (at 1 second): 1st subscribe: 1\n+  // (at 2 seconds): Emitting 2\n   // (at 2 seconds): 1st subscribe: 2\n   // (at 2 seconds): 2nd subscribe: 2\n+  // (at 3 seconds): Emitting 3\n   // (at 3 seconds): 1st subscribe: 3\n   // (at 3 seconds): 1st sequence finished\n   // (at 3 seconds): 2nd subscribe: 3\n   // (at 3 seconds): 2nd sequence finished\n \n   // #enddocregion multicast_sequence\n+\n+  return multicastSequenceSubscriber;\n }"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 77,
        "deletions": 19
    }
}