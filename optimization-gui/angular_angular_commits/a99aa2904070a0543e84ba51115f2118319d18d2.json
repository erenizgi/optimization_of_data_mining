{
    "author": "jeripeierSBB",
    "message": "fix(animations): allow animations on elements in the shadow DOM (#40134)\n\nWhen determining whether to run an animation, the `TransitionAnimationPlayer`\nchecks to see if a DOM element is attached to the document. This is done by\nchecking to see if the element is \"contained\" by the document body node.\n\nPreviously, if the element was inside a shadow DOM, the engine would\ndetermine that the element was not attached, even if the shadow DOM's\nhost was attached to the document. This commit updates the `containsElement()`\nmethod on `AnimationDriver` implementations to also include shadow DOM\nelements as being contained if their shadow host element is contained.\n\nFurther, when using CSS keyframes to trigger animations, the styling\nwas always added to the `head` element of the document, even for\nanimations on elements within a shadow DOM. This meant that those\nelements never receive those styles and the animation would not run.\nThis commit updates the insertion of these styles so that they are added,\nto the element's \"root node\", which is the nearest shadow DOM host, or the\n`head` of the document if the element is not in a shadow DOM.\n\nCloses #25672\n\nPR Close #40134",
    "sha": "a99aa2904070a0543e84ba51115f2118319d18d2",
    "files": [
        {
            "sha": "6ffc1a1e262fcdf4c3f17644fc463621f1acb69e",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a99aa2904070a0543e84ba51115f2118319d18d2/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/a99aa2904070a0543e84ba51115f2118319d18d2/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=a99aa2904070a0543e84ba51115f2118319d18d2",
            "patch": "@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3033,\n-        \"main-es2015\": 452892,\n+        \"main-es2015\": 453111,\n         \"polyfills-es2015\": 55230\n       }\n     }\n@@ -21,7 +21,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3153,\n-        \"main-es2015\": 438598,\n+        \"main-es2015\": 438824,\n         \"polyfills-es2015\": 55230\n       }\n     }"
        },
        {
            "sha": "3c26a431d519294d6376d1b4c79c3024b39b7569",
            "filename": "packages/animations/browser/src/render/css_keyframes/css_keyframes_driver.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Fcss_keyframes%2Fcss_keyframes_driver.ts",
            "raw_url": "https://github.com/angular/angular/raw/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Fcss_keyframes%2Fcss_keyframes_driver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Fcss_keyframes%2Fcss_keyframes_driver.ts?ref=a99aa2904070a0543e84ba51115f2118319d18d2",
            "patch": "@@ -20,7 +20,6 @@ const TAB_SPACE = ' ';\n \n export class CssKeyframesDriver implements AnimationDriver {\n   private _count = 0;\n-  private readonly _head: any = document.querySelector('head');\n \n   validateStyleProperty(prop: string): boolean {\n     return validateStyleProperty(prop);\n@@ -107,7 +106,8 @@ export class CssKeyframesDriver implements AnimationDriver {\n \n     const animationName = `${KEYFRAMES_NAME_PREFIX}${this._count++}`;\n     const kfElm = this.buildKeyframeElement(element, animationName, keyframes);\n-    document.querySelector('head')!.appendChild(kfElm);\n+    const nodeToAppendKfElm = findNodeToAppendKeyframeElement(element);\n+    nodeToAppendKfElm.appendChild(kfElm);\n \n     const specialStyles = packageNonAnimatableStyles(element, keyframes);\n     const player = new CssKeyframesPlayer(\n@@ -118,6 +118,14 @@ export class CssKeyframesDriver implements AnimationDriver {\n   }\n }\n \n+function findNodeToAppendKeyframeElement(element: any): Node {\n+  const rootNode = element.getRootNode?.();\n+  if (typeof ShadowRoot !== 'undefined' && rootNode instanceof ShadowRoot) {\n+    return rootNode;\n+  }\n+  return document.head;\n+}\n+\n function flattenKeyframesIntoStyles(keyframes: null|{[key: string]: any}|\n                                     {[key: string]: any}[]): {[key: string]: any} {\n   let flatKeyframes: {[key: string]: any} = {};"
        },
        {
            "sha": "f6356d39c143fb1fc8f8ceb502048ae4530ffb6f",
            "filename": "packages/animations/browser/src/render/shared.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Fshared.ts?ref=a99aa2904070a0543e84ba51115f2118319d18d2",
            "patch": "@@ -160,10 +160,19 @@ let _query: (element: any, selector: string, multi: boolean) => any[] =\n // and utility methods exist.\n const _isNode = isNode();\n if (_isNode || typeof Element !== 'undefined') {\n-  // this is well supported in all browsers\n-  _contains = (elm1: any, elm2: any) => {\n-    return elm1.contains(elm2) as boolean;\n-  };\n+  if (!isBrowser()) {\n+    _contains = (elm1, elm2) => elm1.contains(elm2);\n+  } else {\n+    _contains = (elm1, elm2) => {\n+      while (elm2 && elm2 !== document.documentElement) {\n+        if (elm2 === elm1) {\n+          return true;\n+        }\n+        elm2 = elm2.parentNode || elm2.host;  // consider host to support shadow DOM\n+      }\n+      return false;\n+    };\n+  }\n \n   _matches = (() => {\n     if (_isNode || Element.prototype.matches) {"
        },
        {
            "sha": "cf52e08ab4934ce09b8edc3dfa7d29a90869def4",
            "filename": "packages/animations/browser/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fanimations%2Fbrowser%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fanimations%2Fbrowser%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Ftest%2FBUILD.bazel?ref=a99aa2904070a0543e84ba51115f2118319d18d2",
            "patch": "@@ -24,6 +24,7 @@ ts_library(\n         \"//packages/animations/browser/testing\",\n         \"//packages/core\",\n         \"//packages/core/testing\",\n+        \"//packages/platform-browser/testing\",\n     ],\n )\n "
        },
        {
            "sha": "bf1f582db77c52c1106dc02e7bf2d745a979a858",
            "filename": "packages/animations/browser/test/render/css_keyframes/css_keyframes_driver_spec.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 9,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fanimations%2Fbrowser%2Ftest%2Frender%2Fcss_keyframes%2Fcss_keyframes_driver_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fanimations%2Fbrowser%2Ftest%2Frender%2Fcss_keyframes%2Fcss_keyframes_driver_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Ftest%2Frender%2Fcss_keyframes%2Fcss_keyframes_driver_spec.ts?ref=a99aa2904070a0543e84ba51115f2118319d18d2",
            "patch": "@@ -5,7 +5,9 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {fakeAsync, flushMicrotasks, TestBed} from '@angular/core/testing';\n+import {fakeAsync, flushMicrotasks} from '@angular/core/testing';\n+\n+import {browserDetection} from '@angular/platform-browser/testing/src/browser_util';\n \n import {CssKeyframesDriver} from '../../../src/render/css_keyframes/css_keyframes_driver';\n import {CssKeyframesPlayer} from '../../../src/render/css_keyframes/css_keyframes_player';\n@@ -104,7 +106,7 @@ describe('CssKeyframesDriver tests', () => {\n       expect(easing).toEqual('ease-out');\n     });\n \n-    it('should animate until the `animationend` method is emitted, but stil retain the <style> method and the element animation details',\n+    it('should animate until the `animationend` method is emitted, but still retain the <style> method and the element animation details',\n        fakeAsync(() => {\n          // IE11 cannot create an instanceof AnimationEvent\n          if (!supportsAnimationEventCreation()) return;\n@@ -144,7 +146,7 @@ describe('CssKeyframesDriver tests', () => {\n          assertElementExistsInDom(matchingStyleElm, true);\n        }));\n \n-    it('should animate until finish() is called, but stil retain the <style> method and the element animation details',\n+    it('should animate until finish() is called, but still retain the <style> method and the element animation details',\n        fakeAsync(() => {\n          const elm = createElement();\n          const animator = new CssKeyframesDriver();\n@@ -295,7 +297,7 @@ describe('CssKeyframesDriver tests', () => {\n        () => {\n          // IE cannot modify the position of an animation...\n          // note that this feature is only for testing purposes\n-         if (isIE()) return;\n+         if (browserDetection.isIE) return;\n \n          const elm = createElement();\n          elm.style.border = '1px solid black';\n@@ -369,6 +371,32 @@ describe('CssKeyframesDriver tests', () => {\n          expect(k2).toEqual({width: '400px', height: '400px', offset: 0.5});\n          expect(k3).toEqual({width: '500px', height: '500px', offset: 1});\n        });\n+\n+    if (browserDetection.supportsShadowDom) {\n+      it('should append <style> in shadow DOM root element', fakeAsync(() => {\n+           const hostElement = createElement();\n+           const shadowRoot = hostElement.attachShadow({mode: 'open'});\n+           const elementToAnimate = createElement();\n+           shadowRoot.appendChild(elementToAnimate);\n+           const animator = new CssKeyframesDriver();\n+\n+           assertExistingAnimationDuration(elementToAnimate, 0);\n+           expect(shadowRoot.querySelector('style')).toBeFalsy();\n+\n+           const player = animator.animate(\n+               elementToAnimate,\n+               [\n+                 {width: '0px', offset: 0},\n+                 {width: '200px', offset: 1},\n+               ],\n+               1234, 0, 'ease-out');\n+\n+           player.play();\n+\n+           assertExistingAnimationDuration(elementToAnimate, 1234);\n+           assertElementExistsInDom(shadowRoot.querySelector('style'), true);\n+         }));\n+    }\n   });\n });\n \n@@ -391,8 +419,3 @@ function parseElementAnimationStyle(element: any):\n   const animationName = style.animationName;\n   return {duration, delay, easing, animationName};\n }\n-\n-function isIE() {\n-  // note that this only applies to older IEs (not edge)\n-  return (window as any).document['documentMode'] ? true : false;\n-}"
        },
        {
            "sha": "a6e2b5460681bdb6e644af7a448b1bbda36f2090",
            "filename": "packages/animations/browser/test/render/web_animations/web_animations_driver_spec.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fanimations%2Fbrowser%2Ftest%2Frender%2Fweb_animations%2Fweb_animations_driver_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fanimations%2Fbrowser%2Ftest%2Frender%2Fweb_animations%2Fweb_animations_driver_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Ftest%2Frender%2Fweb_animations%2Fweb_animations_driver_spec.ts?ref=a99aa2904070a0543e84ba51115f2118319d18d2",
            "patch": "@@ -5,8 +5,9 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {browserDetection} from '@angular/platform-browser/testing/src/browser_util';\n+\n import {CssKeyframesPlayer} from '../../../src/render/css_keyframes/css_keyframes_player';\n-import {DOMAnimation} from '../../../src/render/web_animations/dom_animation';\n import {WebAnimationsDriver} from '../../../src/render/web_animations/web_animations_driver';\n import {WebAnimationsPlayer} from '../../../src/render/web_animations/web_animations_player';\n \n@@ -49,6 +50,21 @@ import {WebAnimationsPlayer} from '../../../src/render/web_animations/web_animat\n         expect(player instanceof WebAnimationsPlayer).toBeTruthy();\n       });\n     });\n+\n+    if (browserDetection.supportsShadowDom) {\n+      describe('when animation is inside a shadow DOM', () => {\n+        it('should consider an element inside the shadow DOM to be contained by the document body',\n+           (() => {\n+             const hostElement = createElement();\n+             const shadowRoot = hostElement.attachShadow({mode: 'open'});\n+             const elementToAnimate = createElement();\n+             shadowRoot.appendChild(elementToAnimate);\n+             document.body.appendChild(hostElement);\n+             const animator = new WebAnimationsDriver();\n+             expect(animator.containsElement(document.body, elementToAnimate)).toBeTrue();\n+           }));\n+      });\n+    }\n   });\n }\n "
        },
        {
            "sha": "a0c6f3544ea12df0d4d101b26f9c72b3e189aa5c",
            "filename": "packages/core/test/linker/projection_integration_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fcore%2Ftest%2Flinker%2Fprojection_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a99aa2904070a0543e84ba51115f2118319d18d2/packages%2Fcore%2Ftest%2Flinker%2Fprojection_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Flinker%2Fprojection_integration_spec.ts?ref=a99aa2904070a0543e84ba51115f2118319d18d2",
            "patch": "@@ -10,6 +10,7 @@ import {CommonModule, ÉµgetDOM as getDOM} from '@angular/common';\n import {Component, ComponentFactoryResolver, ComponentRef, Directive, ElementRef, Injector, Input, NgModule, NO_ERRORS_SCHEMA, OnInit, TemplateRef, ViewChild, ViewContainerRef, ViewEncapsulation} from '@angular/core';\n import {ComponentFixture, TestBed} from '@angular/core/testing';\n import {By} from '@angular/platform-browser/src/dom/debug/by';\n+import {browserDetection} from '@angular/platform-browser/testing/src/browser_util';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n import {modifiedInIvy} from '@angular/private/testing';\n \n@@ -490,7 +491,7 @@ describe('projection', () => {\n     expect(main.nativeElement).toHaveText('TREE(0:TREE2(1:TREE(2:)))');\n   });\n \n-  if (supportsShadowDOM()) {\n+  if (browserDetection.supportsShadowDom) {\n     it('should support shadow dom content projection and isolate styles per component', () => {\n       TestBed.configureTestingModule({declarations: [SimpleShadowDom1, SimpleShadowDom2]});\n       TestBed.overrideComponent(MainComp, {\n@@ -1042,7 +1043,3 @@ class CmpA1 {\n })\n class CmpA2 {\n }\n-\n-function supportsShadowDOM(): boolean {\n-  return typeof (<any>document.body).attachShadow !== 'undefined';\n-}"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 77,
        "deletions": 23
    }
}