{
    "author": "AndrewKushnir",
    "message": "fix(core): reset `tView` between tests in Ivy TestBed (#38659)\n\n`tView` that is stored on a component def contains information about directives and pipes\nthat are available in the scope of this component. Patching component scope causes `tView` to be\nupdated. Prior to this commit, the `tView` information was not restored/reset in case component\nclass is not declared in the `declarations` field while calling `TestBed.configureTestingModule`,\nthus causing `tView` to be reused between tests (thus preserving scopes information between tests).\nThis commit updates TestBed logic to preserve `tView` value before applying scope changes and\nreset it back to the previous state between tests.\n\nCloses #38600.\n\nPR Close #38659",
    "sha": "44bb85ade456a8223851b3b376fe7f5c8fe0864a",
    "files": [
        {
            "sha": "e1d78c0cba56b8887dc5b52b55d3178889dc1669",
            "filename": "packages/core/test/test_bed_spec.ts",
            "status": "modified",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/angular/angular/blob/44bb85ade456a8223851b3b376fe7f5c8fe0864a/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/44bb85ade456a8223851b3b376fe7f5c8fe0864a/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts?ref=44bb85ade456a8223851b3b376fe7f5c8fe0864a",
            "patch": "@@ -1126,6 +1126,63 @@ describe('TestBed', () => {\n              expect(SomePipe.hasOwnProperty('ɵpipe')).toBeTruthy();\n            });\n \n+        it('should cleanup scopes (configured via `TestBed.configureTestingModule`) between tests',\n+           () => {\n+             @Component({\n+               selector: 'child',\n+               template: 'Child comp',\n+             })\n+             class ChildCmp {\n+             }\n+\n+             @Component({\n+               selector: 'root',\n+               template: '<child></child>',\n+             })\n+             class RootCmp {\n+             }\n+\n+             // Case #1: `RootCmp` and `ChildCmp` are both included in the `declarations` field of\n+             // the testing module, so `ChildCmp` is in the scope of `RootCmp`.\n+             TestBed.configureTestingModule({\n+               declarations: [RootCmp, ChildCmp],\n+             });\n+\n+             let fixture = TestBed.createComponent(RootCmp);\n+             fixture.detectChanges();\n+\n+             let childCmpInstance = fixture.debugElement.query(By.directive(ChildCmp));\n+             expect(childCmpInstance.componentInstance).toBeAnInstanceOf(ChildCmp);\n+             expect(fixture.nativeElement.textContent).toBe('Child comp');\n+\n+             TestBed.resetTestingModule();\n+\n+             // Case #2: the `TestBed.configureTestingModule` was not invoked, thus the `ChildCmp`\n+             // should not be available in the `RootCmp` scope and no child content should be\n+             // rendered.\n+             fixture = TestBed.createComponent(RootCmp);\n+             fixture.detectChanges();\n+\n+             childCmpInstance = fixture.debugElement.query(By.directive(ChildCmp));\n+             expect(childCmpInstance).toBeNull();\n+             expect(fixture.nativeElement.textContent).toBe('');\n+\n+             TestBed.resetTestingModule();\n+\n+             // Case #3: `ChildCmp` is included in the `declarations` field, but `RootCmp` is not,\n+             // so `ChildCmp` is NOT in the scope of `RootCmp` component.\n+             TestBed.configureTestingModule({\n+               declarations: [ChildCmp],\n+             });\n+\n+             fixture = TestBed.createComponent(RootCmp);\n+             fixture.detectChanges();\n+\n+             childCmpInstance = fixture.debugElement.query(By.directive(ChildCmp));\n+             expect(childCmpInstance).toBeNull();\n+             expect(fixture.nativeElement.textContent).toBe('');\n+           });\n+\n         it('should clean up overridden providers for modules that are imported more than once',\n            () => {\n              @Injectable()"
        },
        {
            "sha": "6c0c1f6feffcefb6c011b11be05d9122860c7ade",
            "filename": "packages/core/testing/src/r3_test_bed_compiler.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/44bb85ade456a8223851b3b376fe7f5c8fe0864a/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed_compiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/44bb85ade456a8223851b3b376fe7f5c8fe0864a/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed_compiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed_compiler.ts?ref=44bb85ade456a8223851b3b376fe7f5c8fe0864a",
            "patch": "@@ -379,6 +379,11 @@ export class R3TestBedCompiler {\n       const moduleScope = getScopeOfModule(moduleType);\n       this.storeFieldOfDefOnType(componentType, NG_COMP_DEF, 'directiveDefs');\n       this.storeFieldOfDefOnType(componentType, NG_COMP_DEF, 'pipeDefs');\n+      // `tView` that is stored on component def contains information about directives and pipes\n+      // that are in the scope of this component. Patching component scope will cause `tView` to be\n+      // changed. Store original `tView` before patching scope, so the `tView` (including scope\n+      // information) is restored back to its previous/original state before running next test.\n+      this.storeFieldOfDefOnType(componentType, NG_COMP_DEF, 'tView');\n       patchComponentDefWithScope((componentType as any).ɵcmp, moduleScope);\n     });\n "
        }
    ],
    "stats": {
        "total": 62,
        "additions": 62,
        "deletions": 0
    }
}