{
    "author": "JiaLiPassion",
    "message": "fix(zone.js): zone patch rxjs should return null _unsubscribe correctly. (#37091)\n\nClose #31684.\n\nIn some rxjs operator, such as `retryWhen`, rxjs internally will set\n`Subscription._unsubscribe` method to null, and the current zone.js monkey patch\ndidn't handle this case correctly, even rxjs set _unsubscribe to null, zone.js\nstill return a function by finding the prototype chain.\n\nThis PR fix this issue and the following test will pass.\n\n```\nconst errorGenerator = () => {\n  return throwError(new Error('error emit'));\n};\n\nconst genericRetryStrategy = (finalizer: () => void) => (attempts: Observable<any>) =>\n    attempts.pipe(\n      mergeMap((error, i) => {\n        const retryAttempt = i + 1;\n        if (retryAttempt > 3) {\n          return throwError(error);\n        }\n        return timer(retryAttempt * 1);\n      }),\n      finalize(() => finalizer()));\n\nerrorGenerator()\n  .pipe(\n    retryWhen(genericRetryStrategy(() => {\n      expect(log.length).toBe(3);\n      done();\n    })),\n    catchError(error => of(error)))\n  .subscribe()\n```\n\nPR Close #37091",
    "sha": "96aa14df016d447683f13ddd4257e594e569769d",
    "files": [
        {
            "sha": "9e8fbe63067db6169feec216e6d2c3a85b37e36d",
            "filename": "packages/zone.js/lib/rxjs/rxjs.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/96aa14df016d447683f13ddd4257e594e569769d/packages%2Fzone.js%2Flib%2Frxjs%2Frxjs.ts",
            "raw_url": "https://github.com/angular/angular/raw/96aa14df016d447683f13ddd4257e594e569769d/packages%2Fzone.js%2Flib%2Frxjs%2Frxjs.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Frxjs%2Frxjs.ts?ref=96aa14df016d447683f13ddd4257e594e569769d",
            "patch": "@@ -115,7 +115,7 @@ type ZoneSubscriberContext = {\n       _zoneUnsubscribe: {value: null, writable: true, configurable: true},\n       _unsubscribe: {\n         get: function(this: Subscription) {\n-          if ((this as any)._zoneUnsubscribe) {\n+          if ((this as any)._zoneUnsubscribe || (this as any)._zoneUnsubscribeCleared) {\n             return (this as any)._zoneUnsubscribe;\n           }\n           const proto = Object.getPrototypeOf(this);\n@@ -125,7 +125,13 @@ type ZoneSubscriberContext = {\n           (this as any)._zone = Zone.current;\n           if (!unsubscribe) {\n             (this as any)._zoneUnsubscribe = unsubscribe;\n+            // In some operator such as `retryWhen`, the _unsubscribe\n+            // method will be set to null, so we need to set another flag\n+            // to tell that we should return null instead of finding\n+            // in the prototype chain.\n+            (this as any)._zoneUnsubscribeCleared = true;\n           } else {\n+            (this as any)._zoneUnsubscribeCleared = false;\n             (this as any)._zoneUnsubscribe = function() {\n               if (this._zone && this._zone !== Zone.current) {\n                 return this._zone.run(unsubscribe, this, arguments);"
        },
        {
            "sha": "28501f222def426a709ad04b1d693e09fe9b3123",
            "filename": "packages/zone.js/test/rxjs/rxjs.retry.spec.ts",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/96aa14df016d447683f13ddd4257e594e569769d/packages%2Fzone.js%2Ftest%2Frxjs%2Frxjs.retry.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/96aa14df016d447683f13ddd4257e594e569769d/packages%2Fzone.js%2Ftest%2Frxjs%2Frxjs.retry.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Frxjs%2Frxjs.retry.spec.ts?ref=96aa14df016d447683f13ddd4257e594e569769d",
            "patch": "@@ -0,0 +1,41 @@\n+/**\n+ * @license\n+ * Copyright Google Inc. All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {Observable, of, throwError, timer} from 'rxjs';\n+import {catchError, finalize, mergeMap, retryWhen} from 'rxjs/operators';\n+\n+describe('retryWhen', () => {\n+  let log: any[];\n+  const genericRetryStrategy = (finalizer: () => void) => (attempts: Observable<any>) =>\n+      attempts.pipe(\n+          mergeMap((error, i) => {\n+            const retryAttempt = i + 1;\n+            if (retryAttempt > 3) {\n+              return throwError(error);\n+            }\n+            log.push(error);\n+            return timer(retryAttempt * 1);\n+          }),\n+          finalize(() => finalizer()));\n+\n+  const errorGenerator = () => {\n+    return throwError(new Error('error emit'));\n+  };\n+  beforeEach(() => {\n+    log = [];\n+  });\n+\n+  it('should retry max 3 times',\n+     (done: DoneFn) => {errorGenerator()\n+                            .pipe(\n+                                retryWhen(genericRetryStrategy(() => {\n+                                  expect(log.length).toBe(3);\n+                                  done();\n+                                })),\n+                                catchError(error => of(error)))\n+                            .subscribe()});\n+});"
        },
        {
            "sha": "e00e3386e6661e482e4bb754c96a751f0e586ccc",
            "filename": "packages/zone.js/test/rxjs/rxjs.spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/96aa14df016d447683f13ddd4257e594e569769d/packages%2Fzone.js%2Ftest%2Frxjs%2Frxjs.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/96aa14df016d447683f13ddd4257e594e569769d/packages%2Fzone.js%2Ftest%2Frxjs%2Frxjs.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Frxjs%2Frxjs.spec.ts?ref=96aa14df016d447683f13ddd4257e594e569769d",
            "patch": "@@ -27,6 +27,7 @@ import './rxjs.merge.spec';\n import './rxjs.never.spec';\n import './rxjs.of.spec';\n import './rxjs.range.spec';\n+import './rxjs.retry.spec';\n import './rxjs.throw.spec';\n import './rxjs.timer.spec';\n import './rxjs.zip.spec';"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 49,
        "deletions": 1
    }
}