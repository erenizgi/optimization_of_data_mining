{
    "author": "devversion",
    "message": "feat(dev-infra): create shared platform for remote execution (#41767)\n\nIntroduces a shared Bazel platform for remote execution builds\nusing Google cloud. Previously we used `bazel_toolchains` for\nproviding the platform w/ additional CPP and Java toolchains\n\n`bazel_toolchains` no longer provides default toolchains with the\nlatest version, but provides a tool (linux and windows only) for\ngenerating toolchain/platforms, which then need to be checked\ninto the repository. This is quite inconvenient and cumbersome\n(especially with no macOS support), so we just provide our own\nplatform and CPP toolchain within `//dev-infra`. This is more\nsimple than all the effort we'd need to make the toolchain\ngeneration tool work (while it would also increase the amount\nof checked-in sources significantly; with more unused toolchains\nfor CPP or Java)\n\nPR Close #41767",
    "sha": "59bb24148ee8b344b5a3db823af8964a1c24f0b8",
    "files": [
        {
            "sha": "6bb4f3a008f9ab59094cf94302d83e01ec2fe55d",
            "filename": "dev-infra/bazel/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/59bb24148ee8b344b5a3db823af8964a1c24f0b8/dev-infra%2Fbazel%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/59bb24148ee8b344b5a3db823af8964a1c24f0b8/dev-infra%2Fbazel%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2FBUILD.bazel?ref=59bb24148ee8b344b5a3db823af8964a1c24f0b8",
            "patch": "@@ -5,5 +5,6 @@ filegroup(\n     srcs = [\n         \"BUILD.bazel\",\n         \"expand_template.bzl\",\n+        \"//dev-infra/bazel/remote-execution:files\",\n     ],\n )"
        },
        {
            "sha": "e68015a1bf89778a891a4fb91fb249c0d50e784d",
            "filename": "dev-infra/bazel/remote-execution/BUILD.bazel",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/59bb24148ee8b344b5a3db823af8964a1c24f0b8/dev-infra%2Fbazel%2Fremote-execution%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/59bb24148ee8b344b5a3db823af8964a1c24f0b8/dev-infra%2Fbazel%2Fremote-execution%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fremote-execution%2FBUILD.bazel?ref=59bb24148ee8b344b5a3db823af8964a1c24f0b8",
            "patch": "@@ -0,0 +1,38 @@\n+package(default_visibility = [\"//visibility:public\"])\n+\n+platform(\n+    name = \"platform\",\n+    constraint_values = [\n+        \"@bazel_tools//platforms:linux\",\n+        \"@bazel_tools//platforms:x86_64\",\n+        \"@bazel_tools//tools/cpp:clang\",\n+    ],\n+    # We use a basic docker image from the Google Cloud container registry that supports\n+    # browser tests. Note that we usually do not use any of the local browsers, but the image\n+    # guarantees that necessary dependencies for launching browsers are installed. Since we\n+    # do not rely on many binaries/tools from the image, the image doesn't need to be updated\n+    # frequently. There are rare cases where it needs to be updated. e.g. for a more recent Bash\n+    # version, or new system settings that are required for launching browsers. In order to do that,\n+    # we need to either see if the `rbe-ubuntu16-04-webtest` image can be updated, or if we need to\n+    # build and publish our own image to the Google cloud image registry. Additionally, we set th\n+    # `SYS_ADMIN` capability so that browsers can be launched with sandbox mode enabled. Related\n+    # information: https://developers.google.com/web/tools/puppeteer/troubleshooting#running_puppeteer_in_docker\n+    remote_execution_properties = \"\"\"\n+        properties: {\n+          name: \"container-image\"\n+          value:\"docker://gcr.io/cloud-marketplace/google/rbe-ubuntu16-04-webtest@sha256:886a12dc4726f5b991b46386292afa8d943b6703a5496c8a1e07cfde778d9044\"\n+        }\n+        properties: {\n+          name: \"dockerAddCapabilities\"\n+          value: \"SYS_ADMIN\"\n+        }\n+        \"\"\",\n+)\n+\n+filegroup(\n+    name = \"files\",\n+    srcs = [\n+        \"BUILD.bazel\",\n+        \"//dev-infra/bazel/remote-execution/cpp:files\",\n+    ],\n+)"
        },
        {
            "sha": "83c3fda085bfbbf45a04d68ed8f5f4c90bdc51a9",
            "filename": "dev-infra/bazel/remote-execution/cpp/BUILD.bazel",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/angular/angular/blob/59bb24148ee8b344b5a3db823af8964a1c24f0b8/dev-infra%2Fbazel%2Fremote-execution%2Fcpp%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/59bb24148ee8b344b5a3db823af8964a1c24f0b8/dev-infra%2Fbazel%2Fremote-execution%2Fcpp%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fremote-execution%2Fcpp%2FBUILD.bazel?ref=59bb24148ee8b344b5a3db823af8964a1c24f0b8",
            "patch": "@@ -0,0 +1,57 @@\n+load(\"@bazel_tools//tools/cpp:cc_toolchain_config.bzl\", \"cc_toolchain_config\")\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+filegroup(\n+    name = \"files\",\n+    srcs = [\"BUILD.bazel\"],\n+)\n+\n+cc_toolchain_suite(\n+    name = \"cc_toolchain_suite\",\n+    toolchains = {\n+        \"k8\": \":cc_compiler_k8\",\n+    },\n+)\n+\n+toolchain(\n+    name = \"cc_toolchain\",\n+    exec_compatible_with = [\n+        \"@bazel_tools//platforms:linux\",\n+        \"@bazel_tools//platforms:x86_64\",\n+        \"@bazel_tools//tools/cpp:clang\",\n+    ],\n+    target_compatible_with = [\n+        \"@bazel_tools//platforms:linux\",\n+        \"@bazel_tools//platforms:x86_64\",\n+    ],\n+    toolchain = \":cc_compiler_k8\",\n+    toolchain_type = \"@bazel_tools//tools/cpp:toolchain_type\",\n+)\n+\n+# Basic CC toolchain for k8 remote containers. Based on the default k8\n+# toolchain provided in Bazel (but unfortunately internal).\n+# https://github.com/bazelbuild/bazel/blob/c951753097b45cfb9be512c02199aa891b9646b8/tools/cpp/BUILD.tools#L298-L311\n+cc_toolchain(\n+    name = \"cc_compiler_k8\",\n+    all_files = \":empty\",\n+    ar_files = \":empty\",\n+    as_files = \":empty\",\n+    compiler_files = \":empty\",\n+    dwp_files = \":empty\",\n+    linker_files = \":empty\",\n+    objcopy_files = \":empty\",\n+    strip_files = \":empty\",\n+    supports_param_files = 1,\n+    toolchain_config = \":k8_toolchain_config\",\n+    toolchain_identifier = \"cc-k8-compiler\",\n+)\n+\n+cc_toolchain_config(\n+    name = \"k8_toolchain_config\",\n+    compiler = \"compiler\",\n+    cpu = \"local\",\n+)\n+\n+# Empty filegroup used for defining the CC toolchain.\n+filegroup(name = \"empty\")"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 96,
        "deletions": 0
    }
}