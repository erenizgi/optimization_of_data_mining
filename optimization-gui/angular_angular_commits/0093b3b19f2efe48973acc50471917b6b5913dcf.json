{
    "author": "JoostK",
    "message": "fix(ngcc): do not compile JavaScript sources if typings-only processing is repeated (#41209)\n\nThe recently introduced typings-only mode in ngcc would incorrectly\nwrite compiled JavaScript files if typings-only mode was requested, in\ncase the typings of the entry-point had already been processed in a\nprior run of ngcc. The corresponding format property for which the\nJavaScript files were written were not marked as processed, though, as\nthe typings-only mode excluded the format property itself from being\nmarked as processed. Consequently, subsequent runs of ngcc would not\nconsider the entry-point to have been processed and recompile the\nJavaScript bundle once more, resulting in duplicate ngcc imports.\n\nFixes #41198\n\nPR Close #41209",
    "sha": "0093b3b19f2efe48973acc50471917b6b5913dcf",
    "files": [
        {
            "sha": "1a876eb53dbe577dd5910db360fe41fb8b2459d7",
            "filename": "packages/compiler-cli/ngcc/src/execution/analyze_entry_points.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/0093b3b19f2efe48973acc50471917b6b5913dcf/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fanalyze_entry_points.ts",
            "raw_url": "https://github.com/angular/angular/raw/0093b3b19f2efe48973acc50471917b6b5913dcf/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fanalyze_entry_points.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fanalyze_entry_points.ts?ref=0093b3b19f2efe48973acc50471917b6b5913dcf",
            "patch": "@@ -49,11 +49,8 @@ export function getAnalyzeEntryPointsFn(\n \n     for (const entryPoint of entryPoints) {\n       const packageJson = entryPoint.packageJson;\n-      const hasProcessedTypings = hasBeenProcessed(packageJson, 'typings');\n       const {propertiesToProcess, equivalentPropertiesMap} = getPropertiesToProcess(\n           packageJson, supportedPropertiesToConsider, compileAllFormats, typingsOnly);\n-      let processDts = hasProcessedTypings ? DtsProcessing.No :\n-                                             typingsOnly ? DtsProcessing.Only : DtsProcessing.Yes;\n \n       if (propertiesToProcess.length === 0) {\n         // This entry-point is unprocessable (i.e. there is no format property that is of interest\n@@ -64,6 +61,16 @@ export function getAnalyzeEntryPointsFn(\n         continue;\n       }\n \n+      const hasProcessedTypings = hasBeenProcessed(packageJson, 'typings');\n+      if (hasProcessedTypings && typingsOnly) {\n+        // Typings for this entry-point have already been processed and we're in typings-only mode,\n+        // so no task has to be created for this entry-point.\n+        logger.debug(`Skipping ${entryPoint.name} : typings have already been processed.`);\n+        continue;\n+      }\n+      let processDts = hasProcessedTypings ? DtsProcessing.No :\n+                                             typingsOnly ? DtsProcessing.Only : DtsProcessing.Yes;\n+\n       for (const formatProperty of propertiesToProcess) {\n         if (hasBeenProcessed(entryPoint.packageJson, formatProperty)) {\n           // The format-path which the property maps to is already processed - nothing to do."
        },
        {
            "sha": "1cab9d89020364be3b631a88f00c24997633750b",
            "filename": "packages/compiler-cli/ngcc/test/integration/ngcc_spec.ts",
            "status": "modified",
            "additions": 60,
            "deletions": 0,
            "changes": 60,
            "blob_url": "https://github.com/angular/angular/blob/0093b3b19f2efe48973acc50471917b6b5913dcf/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0093b3b19f2efe48973acc50471917b6b5913dcf/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts?ref=0093b3b19f2efe48973acc50471917b6b5913dcf",
            "patch": "@@ -1358,6 +1358,66 @@ runInEachFileSystem(() => {\n         expect(fs.exists(_(`/node_modules/@angular/common/common.d.ts.__ivy_ngcc_bak`))).toBe(true);\n       });\n \n+      it('should not compile anything when typings have already been processed', () => {\n+        let logger = new MockLogger();\n+        mainNgcc({\n+          basePath: '/node_modules',\n+          propertiesToConsider: ['esm2015'],\n+          targetEntryPointPath: '@angular/core',\n+          typingsOnly: true,\n+          logger,\n+        });\n+        expect(loadPackage('@angular/core').__processed_by_ivy_ngcc__).toEqual({\n+          typings: '0.0.0-PLACEHOLDER',\n+        });\n+        expect(fs.readFile(_(`/node_modules/@angular/core/esm2015/src/application_init.js`)))\n+            .not.toMatch(ANGULAR_CORE_IMPORT_REGEX);\n+        expect(logger.logs.debug).toContain(['  Successfully compiled @angular/core : esm2015']);\n+\n+        // Try to process the typings for @angular/core again, now using a different format\n+        // property, to verify that it does not process the entry-point again and that the JS\n+        // files are still untouched.\n+        logger = new MockLogger();\n+        mainNgcc({\n+          basePath: '/node_modules',\n+          propertiesToConsider: ['main'],\n+          targetEntryPointPath: '@angular/core',\n+          typingsOnly: true,\n+          logger,\n+        });\n+        expect(loadPackage('@angular/core').__processed_by_ivy_ngcc__).toEqual({\n+          typings: '0.0.0-PLACEHOLDER',\n+        });\n+        expect(fs.readFile(_(`/node_modules/@angular/core/esm2015/src/application_init.js`)))\n+            .not.toMatch(ANGULAR_CORE_IMPORT_REGEX);\n+        expect(logger.logs.debug).toContain([\n+          'Skipping @angular/core : typings have already been processed.'\n+        ]);\n+\n+        // Now also process the typings for @angular/common to verify that its dependency on\n+        // @angular/core, which has already been processed and will therefore be skipped, is able\n+        // to succeed.\n+        logger = new MockLogger();\n+        mainNgcc({\n+          basePath: '/node_modules',\n+          propertiesToConsider: ['esm2015'],\n+          targetEntryPointPath: '@angular/common',\n+          typingsOnly: true,\n+          logger,\n+        });\n+        expect(loadPackage('@angular/core').__processed_by_ivy_ngcc__).toEqual({\n+          typings: '0.0.0-PLACEHOLDER',\n+        });\n+        expect(fs.readFile(_(`/node_modules/@angular/core/esm2015/src/application_init.js`)))\n+            .not.toMatch(ANGULAR_CORE_IMPORT_REGEX);\n+        expect(fs.readFile(_(`/node_modules/@angular/common/esm2015/src/common_module.js`)))\n+            .not.toMatch(ANGULAR_CORE_IMPORT_REGEX);\n+        expect(logger.logs.debug).toContain([\n+          'Skipping @angular/core : typings have already been processed.'\n+        ]);\n+        expect(logger.logs.debug).toContain(['  Successfully compiled @angular/common : esm2015']);\n+      });\n+\n       it('should cope with compiling the same entry-point multiple times with different formats',\n          () => {\n            mainNgcc({"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 70,
        "deletions": 3
    }
}