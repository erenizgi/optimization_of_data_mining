{
    "author": "petebacondarwin",
    "message": "fix(compiler-cli): do not drop non-Angular decorators when downleveling (#39577)\n\nThere is a compiler transform that downlevels Angular class decorators\nto static properties so that metadata is available for JIT compilation.\nThe transform was supposed to ignore non-Angular decorators but it was\nactually completely dropping decorators that did not conform to a very\nspecific syntactic shape (i.e. the decorator was a simple identifier, or\na namespaced identifier).\n\nThis commit ensures that all non-Angular decorators are kepts as-is\neven if they are built using a syntax that the Angular compiler does not\nunderstand.\n\nFixes #39574\n\nPR Close #39577",
    "sha": "b9b91784581d37dc0b3975778184eb32cffa910f",
    "files": [
        {
            "sha": "5c4cc4627c3be01c269a343025b2435cacf55a98",
            "filename": "packages/compiler-cli/src/transformers/downlevel_decorators_transform.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 7,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/b9b91784581d37dc0b3975778184eb32cffa910f/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fdownlevel_decorators_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/b9b91784581d37dc0b3975778184eb32cffa910f/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fdownlevel_decorators_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fdownlevel_decorators_transform.ts?ref=b9b91784581d37dc0b3975778184eb32cffa910f",
            "patch": "@@ -538,12 +538,17 @@ export function getDownlevelDecoratorsTransform(\n         }\n         newMembers.push(ts.visitEachChild(member, decoratorDownlevelVisitor, context));\n       }\n-      const decorators = host.getDecoratorsOfDeclaration(classDecl) || [];\n+\n+      // The `ReflectionHost.getDecoratorsOfDeclaration()` method will not return certain kinds of\n+      // decorators that will never be Angular decorators. So we cannot rely on it to capture all\n+      // the decorators that should be kept. Instead we start off with a set of the raw decorators\n+      // on the class, and only remove the ones that have been identified for downleveling.\n+      const decoratorsToKeep = new Set<ts.Decorator>(classDecl.decorators);\n+      const possibleAngularDecorators = host.getDecoratorsOfDeclaration(classDecl) || [];\n \n       let hasAngularDecorator = false;\n       const decoratorsToLower = [];\n-      const decoratorsToKeep: ts.Decorator[] = [];\n-      for (const decorator of decorators) {\n+      for (const decorator of possibleAngularDecorators) {\n         // We only deal with concrete nodes in TypeScript sources, so we don't\n         // need to handle synthetically created decorators.\n         const decoratorNode = decorator.node! as ts.Decorator;\n@@ -557,8 +562,7 @@ export function getDownlevelDecoratorsTransform(\n \n         if (isNgDecorator && !skipClassDecorators) {\n           decoratorsToLower.push(extractMetadataFromSingleDecorator(decoratorNode, diagnostics));\n-        } else {\n-          decoratorsToKeep.push(decoratorNode);\n+          decoratorsToKeep.delete(decoratorNode);\n         }\n       }\n \n@@ -581,8 +585,9 @@ export function getDownlevelDecoratorsTransform(\n           ts.createNodeArray(newMembers, classDecl.members.hasTrailingComma), classDecl.members);\n \n       return ts.updateClassDeclaration(\n-          classDecl, decoratorsToKeep.length ? decoratorsToKeep : undefined, classDecl.modifiers,\n-          classDecl.name, classDecl.typeParameters, classDecl.heritageClauses, members);\n+          classDecl, decoratorsToKeep.size ? Array.from(decoratorsToKeep) : undefined,\n+          classDecl.modifiers, classDecl.name, classDecl.typeParameters, classDecl.heritageClauses,\n+          members);\n     }\n \n     /**"
        },
        {
            "sha": "28fc1708a9ce28ca57d066c21d1e755e688970dc",
            "filename": "packages/compiler-cli/test/transformers/downlevel_decorators_transform_spec.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/b9b91784581d37dc0b3975778184eb32cffa910f/packages%2Fcompiler-cli%2Ftest%2Ftransformers%2Fdownlevel_decorators_transform_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b9b91784581d37dc0b3975778184eb32cffa910f/packages%2Fcompiler-cli%2Ftest%2Ftransformers%2Fdownlevel_decorators_transform_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Ftransformers%2Fdownlevel_decorators_transform_spec.ts?ref=b9b91784581d37dc0b3975778184eb32cffa910f",
            "patch": "@@ -189,6 +189,21 @@ describe('downlevel decorator transform', () => {\n     expect(output).not.toContain('MyClass.decorators');\n   });\n \n+  it('should not downlevel non-Angular class decorators generated by a builder', () => {\n+    const {output} = transform(`\n+      @DecoratorBuilder().customClassDecorator\n+      export class MyClass {}\n+    `);\n+\n+    expect(diagnostics.length).toBe(0);\n+    expect(output).toContain(dedent`\n+      MyClass = tslib_1.__decorate([\n+        DecoratorBuilder().customClassDecorator\n+      ], MyClass);\n+    `);\n+    expect(output).not.toContain('MyClass.decorators');\n+  });\n+\n   it('should downlevel Angular-decorated class member', () => {\n     const {output} = transform(`\n       import {Input} from '@angular/core';"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 27,
        "deletions": 7
    }
}