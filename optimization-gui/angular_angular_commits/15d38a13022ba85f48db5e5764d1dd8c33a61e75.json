{
    "author": "gkalpak",
    "message": "refactor(docs-infra): remove obsolete ViewEngine code path from `ElementsLoader` (#44293)\n\nRemove a code path that was only reached in ViewEngine mode and is now\n(with the removal of ViewEngine) obsolete.\n\nPR Close #44293",
    "sha": "15d38a13022ba85f48db5e5764d1dd8c33a61e75",
    "files": [
        {
            "sha": "601e4efe574e607959627dea9a810d64bd650547",
            "filename": "aio/src/app/custom-elements/elements-loader.spec.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 11,
            "changes": 39,
            "blob_url": "https://github.com/angular/angular/blob/15d38a13022ba85f48db5e5764d1dd8c33a61e75/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/15d38a13022ba85f48db5e5764d1dd8c33a61e75/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.spec.ts?ref=15d38a13022ba85f48db5e5764d1dd8c33a61e75",
            "patch": "@@ -25,13 +25,20 @@ describe('ElementsLoader', () => {\n       providers: [\n         ElementsLoader,\n         {\n-          provide: ELEMENT_MODULE_LOAD_CALLBACKS_TOKEN, useValue: new Map<\n-            string, () => Promise<NgModuleFactory<WithCustomElementComponent> | Type<WithCustomElementComponent>>\n-          >([\n-          ['element-a-selector', () => Promise.resolve(new FakeModuleFactory('element-a-module'))],\n-          ['element-b-selector', () => Promise.resolve(new FakeModuleFactory('element-b-module'))],\n-          ['element-c-selector', () => Promise.resolve(FakeCustomElementModule)]\n-        ])},\n+          provide: Compiler,\n+          useValue: {\n+            compileModuleAsync: jasmine.createSpy('compileModuleAsync').and.callFake(\n+                (Mod: typeof FakeCustomElementModule) => new FakeModuleFactory(Mod.modulePath)),\n+          },\n+        },\n+        {\n+          provide: ELEMENT_MODULE_LOAD_CALLBACKS_TOKEN,\n+          useValue: new Map<string, () => Promise<Type<WithCustomElementComponent>>>([\n+            ['element-a-selector', async () => createFakeCustomElementModule('element-a-module')],\n+            ['element-b-selector', async () => createFakeCustomElementModule('element-b-module')],\n+            ['element-c-selector', async () => createFakeCustomElementModule('element-c-module')],\n+          ]),\n+        },\n       ]\n     });\n \n@@ -230,24 +237,28 @@ describe('ElementsLoader', () => {\n     );\n \n     it('should be able to load and register an element after compiling its NgModule', fakeAsync(() => {\n-      const compilerSpy = spyOn(compiler, 'compileModuleAsync')\n-        .and.returnValue(Promise.resolve(new FakeModuleFactory('element-c-module')));\n+      const compilerSpy = compiler.compileModuleAsync as unknown as jasmine.Spy;\n \n       elementsLoader.loadCustomElement('element-c-selector');\n       flushMicrotasks();\n \n       expect(definedSpy).toHaveBeenCalledTimes(1);\n       expect(definedSpy).toHaveBeenCalledWith('element-c-selector', jasmine.any(Function));\n \n-      expect(compilerSpy).toHaveBeenCalledTimes(1);\n-      expect(compilerSpy).toHaveBeenCalledWith(FakeCustomElementModule);\n+      expect(compilerSpy).toHaveBeenCalledBefore(definedSpy);\n+      expect(compilerSpy).toHaveBeenCalledOnceWith(jasmine.any(Function));\n+\n+      const CompiledModuleClass: typeof FakeCustomElementModule = compilerSpy.calls.first().args[0];\n+      expect(FakeCustomElementModule.isPrototypeOf(CompiledModuleClass)).toBeTrue();\n+      expect(CompiledModuleClass.modulePath).toBe('element-c-module');\n     }));\n   });\n });\n \n // TEST CLASSES/HELPERS\n \n class FakeCustomElementModule implements WithCustomElementComponent {\n+  static readonly modulePath: string;\n   customElementComponent: Type<any>;\n }\n \n@@ -302,6 +313,12 @@ class FakeModuleFactory extends NgModuleFactory<any> {\n   }\n }\n \n+function createFakeCustomElementModule(modulePath: string): typeof FakeCustomElementModule {\n+  return class extends FakeCustomElementModule {\n+    static override readonly modulePath = modulePath;\n+  };\n+}\n+\n function returnPromisesFromSpy(spy: jasmine.Spy): Deferred[] {\n   const deferreds: Deferred[] = [];\n   spy.and.callFake(() => new Promise<void>((resolve, reject) => deferreds.push({resolve, reject})));"
        },
        {
            "sha": "773b2e25907e3f1c052cceda69b717a1ee0769af",
            "filename": "aio/src/app/custom-elements/elements-loader.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 23,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/15d38a13022ba85f48db5e5764d1dd8c33a61e75/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.ts",
            "raw_url": "https://github.com/angular/angular/raw/15d38a13022ba85f48db5e5764d1dd8c33a61e75/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.ts?ref=15d38a13022ba85f48db5e5764d1dd8c33a61e75",
            "patch": "@@ -1,11 +1,4 @@\n-import {\n-  Compiler,\n-  Inject,\n-  Injectable,\n-  NgModuleFactory,\n-  NgModuleRef,\n-  Type,\n-} from '@angular/core';\n+import { Compiler, Inject, Injectable, NgModuleRef, Type } from '@angular/core';\n import { ELEMENT_MODULE_LOAD_CALLBACKS_TOKEN, WithCustomElementComponent } from './element-registry';\n import { from, Observable, of } from 'rxjs';\n import { createCustomElement } from '@angular/elements';\n@@ -52,21 +45,8 @@ export class ElementsLoader {\n       // Load and register the custom element (for the first time).\n       const modulePathLoader = this.elementsToLoad.get(selector) as LoadChildrenCallback;\n       const loadedAndRegistered =\n-        (modulePathLoader() as Promise<NgModuleFactory<WithCustomElementComponent> | Type<WithCustomElementComponent>>)\n-          .then(elementModuleOrFactory => {\n-            /**\n-             * With View Engine, the NgModule factory is created and provided when loaded.\n-             * With Ivy, only the NgModule class is provided loaded and must be compiled.\n-             * This uses the same mechanism as the deprecated `SystemJsNgModuleLoader` in\n-             * in `packages/core/src/linker/system_js_ng_module_factory_loader.ts`\n-             * to pass on the NgModuleFactory, or compile the NgModule and return its NgModuleFactory.\n-             */\n-            if (elementModuleOrFactory instanceof NgModuleFactory) {\n-              return elementModuleOrFactory;\n-            } else {\n-              return this.compiler.compileModuleAsync(elementModuleOrFactory);\n-            }\n-          })\n+        (modulePathLoader() as Promise<Type<WithCustomElementComponent>>)\n+          .then(elementModule => this.compiler.compileModuleAsync(elementModule))\n           .then(elementModuleFactory => {\n             const elementModuleRef = elementModuleFactory.create(this.moduleRef.injector);\n             const injector = elementModuleRef.injector;"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 31,
        "deletions": 34
    }
}