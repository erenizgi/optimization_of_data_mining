{
    "author": "petebacondarwin",
    "message": "refactor(compiler-cli): remove TS bug workaround (#42000)\n\nThe TS bug at https://github.com/Microsoft/TypeScript/issues/29300 was\nfixed in TS 3.3, so the workaround is no longer required.\n\nPR Close #42000",
    "sha": "0cb68632c6b71860cf652fc95d6fec29466bbdab",
    "files": [
        {
            "sha": "d9b673bcc590c7ae4968d103864e2eeb4dec0bc3",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 13,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/0cb68632c6b71860cf652fc95d6fec29466bbdab/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/0cb68632c6b71860cf652fc95d6fec29466bbdab/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=0cb68632c6b71860cf652fc95d6fec29466bbdab",
            "patch": "@@ -23,7 +23,6 @@ import {ClassDeclaration, DeclarationNode, Decorator, ReflectionHost, reflectObj\n import {ComponentScopeReader, LocalModuleScopeRegistry, TypeCheckScopeRegistry} from '../../scope';\n import {AnalysisOutput, CompileResult, DecoratorHandler, DetectResult, HandlerFlags, HandlerPrecedence, ResolveResult} from '../../transform';\n import {TemplateSourceMapping, TypeCheckContext} from '../../typecheck/api';\n-import {tsSourceMapBug29300Fixed} from '../../util/src/ts_source_map_bug_29300';\n import {SubsetOfKeys} from '../../util/src/typescript';\n \n import {ResourceLoader} from './api';\n@@ -1231,7 +1230,7 @@ export class ComponentDecoratorHandler implements\n           templateUrl,\n           templateUrlExpression: templateUrlExpr,\n           resolvedTemplateUrl: resourceUrl,\n-          potentialSourceMapUrl: sourceMapUrl(resourceUrl),\n+          potentialSourceMapUrl: resourceUrl,\n         };\n       } catch (e) {\n         throw this.makeResourceNotFoundError(\n@@ -1342,17 +1341,6 @@ function getTemplateRange(templateExpr: ts.Expression) {\n   };\n }\n \n-function sourceMapUrl(resourceUrl: string): string {\n-  if (!tsSourceMapBug29300Fixed()) {\n-    // By removing the template URL we are telling the translator not to try to\n-    // map the external source file to the generated code, since the version\n-    // of TS that is running does not support it.\n-    return '';\n-  } else {\n-    return resourceUrl;\n-  }\n-}\n-\n /** Determines if the result of an evaluation is a string array. */\n function isStringArray(resolvedValue: ResolvedValue): resolvedValue is string[] {\n   return Array.isArray(resolvedValue) && resolvedValue.every(elem => typeof elem === 'string');"
        },
        {
            "sha": "64c3a8417c848105f318d887b9cbb75762f03f03",
            "filename": "packages/compiler-cli/src/ngtsc/util/src/ts_source_map_bug_29300.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 90,
            "changes": 90,
            "blob_url": "https://github.com/angular/angular/blob/500db42a2e55bbd8d5a09d61300af56fa7558abc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Futil%2Fsrc%2Fts_source_map_bug_29300.ts",
            "raw_url": "https://github.com/angular/angular/raw/500db42a2e55bbd8d5a09d61300af56fa7558abc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Futil%2Fsrc%2Fts_source_map_bug_29300.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Futil%2Fsrc%2Fts_source_map_bug_29300.ts?ref=500db42a2e55bbd8d5a09d61300af56fa7558abc",
            "patch": "@@ -1,90 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-import * as ts from 'typescript';\n-\n-let _tsSourceMapBug29300Fixed: boolean|undefined;\n-\n-/**\n- * Test the current version of TypeScript to see if it has fixed the external SourceMap\n- * file bug: https://github.com/Microsoft/TypeScript/issues/29300.\n- *\n- * The bug is fixed in TS 3.3+ but this check avoid us having to rely upon the version number,\n- * and allows us to gracefully fail if the TS version still has the bug.\n- *\n- * We check for the bug by compiling a very small program `a;` and transforming it to `b;`,\n- * where we map the new `b` identifier to an external source file, which has different lines to\n- * the original source file.  If the bug is fixed then the output SourceMap should contain\n- * mappings that correspond ot the correct line/col pairs for this transformed node.\n- *\n- * @returns true if the bug is fixed.\n- */\n-export function tsSourceMapBug29300Fixed() {\n-  if (_tsSourceMapBug29300Fixed === undefined) {\n-    let writtenFiles: {[filename: string]: string} = {};\n-    const sourceFile =\n-        ts.createSourceFile('test.ts', 'a;', ts.ScriptTarget.ES2015, true, ts.ScriptKind.TS);\n-    const host = {\n-      getSourceFile(): ts.SourceFile |\n-          undefined {\n-            return sourceFile;\n-          },\n-      fileExists(): boolean {\n-        return true;\n-      },\n-      readFile(): string |\n-          undefined {\n-            return '';\n-          },\n-      writeFile(fileName: string, data: string) {\n-        writtenFiles[fileName] = data;\n-      },\n-      getDefaultLibFileName(): string {\n-        return '';\n-      },\n-      getCurrentDirectory(): string {\n-        return '';\n-      },\n-      getDirectories(): string[] {\n-        return [];\n-      },\n-      getCanonicalFileName(): string {\n-        return '';\n-      },\n-      useCaseSensitiveFileNames(): boolean {\n-        return true;\n-      },\n-      getNewLine(): string {\n-        return '\\n';\n-      },\n-    };\n-\n-    const transform = (context: ts.TransformationContext) => {\n-      return (node: ts.SourceFile) => ts.visitNode(node, visitor);\n-      function visitor(node: ts.Node): ts.Node {\n-        if (ts.isIdentifier(node) && node.text === 'a') {\n-          const newNode = ts.createIdentifier('b');\n-          ts.setSourceMapRange(newNode, {\n-            pos: 16,\n-            end: 16,\n-            source: ts.createSourceMapSource('test.html', 'abc\\ndef\\nghi\\njkl\\nmno\\npqr')\n-          });\n-          return newNode;\n-        }\n-        return ts.visitEachChild(node, visitor, context);\n-      }\n-    };\n-\n-    const program = ts.createProgram(['test.ts'], {sourceMap: true}, host);\n-    program.emit(sourceFile, undefined, undefined, undefined, {after: [transform]});\n-    // The first two mappings in the source map should look like:\n-    // [0,1,4,0] col 0 => source file 1, row 4, column 0)\n-    // [1,0,0,0] col 1 => source file 1, row 4, column 0)\n-    _tsSourceMapBug29300Fixed = /ACIA,CAAA/.test(writtenFiles['test.js.map']);\n-  }\n-  return _tsSourceMapBug29300Fixed;\n-}"
        },
        {
            "sha": "4eb0e9b473f34ae4fed793b20e3fef61bedf3ea1",
            "filename": "packages/compiler-cli/test/ngtsc/template_mapping_spec.ts",
            "status": "modified",
            "additions": 76,
            "deletions": 78,
            "changes": 154,
            "blob_url": "https://github.com/angular/angular/blob/0cb68632c6b71860cf652fc95d6fec29466bbdab/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0cb68632c6b71860cf652fc95d6fec29466bbdab/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts?ref=0cb68632c6b71860cf652fc95d6fec29466bbdab",
            "patch": "@@ -11,7 +11,6 @@ import {inspect} from 'util';\n \n import {runInEachFileSystem} from '../../src/ngtsc/file_system/testing';\n import {loadStandardTestFiles} from '../../src/ngtsc/testing';\n-import {tsSourceMapBug29300Fixed} from '../../src/ngtsc/util/src/ts_source_map_bug_29300';\n \n import {NgtscTestEnvironment} from './env';\n import {getMappedSegments, SegmentMapping} from './sourcemap_utils';\n@@ -603,91 +602,90 @@ runInEachFileSystem((os) => {\n          });\n     });\n \n-    if (tsSourceMapBug29300Fixed()) {\n-      describe('External templates (where TS supports source-mapping)', () => {\n-        it('should create external template source-mapping', () => {\n-          const mappings =\n-              compileAndMap('<div>this is a test</div><div>{{ 1 + 2 }}</div>', './dir/test.html');\n+    describe('External templates (where TS supports source-mapping)', () => {\n+      it('should create external template source-mapping', () => {\n+        const mappings =\n+            compileAndMap('<div>this is a test</div><div>{{ 1 + 2 }}</div>', './dir/test.html');\n \n-          // Creation mode\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵelementStart(0, \"div\")',\n-            source: '<div>',\n-            sourceUrl: '../dir/test.html'\n-          });\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵtext(1, \"this is a test\")',\n-            source: 'this is a test',\n-            sourceUrl: '../dir/test.html'\n-          });\n-          expectMapping(\n-              mappings,\n-              {generated: 'i0.ɵɵelementEnd()', source: '</div>', sourceUrl: '../dir/test.html'});\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵelementStart(2, \"div\")',\n-            source: '<div>',\n-            sourceUrl: '../dir/test.html'\n-          });\n-          expectMapping(\n-              mappings,\n-              {generated: 'i0.ɵɵtext(3)', source: '{{ 1 + 2 }}', sourceUrl: '../dir/test.html'});\n-          expectMapping(\n-              mappings,\n-              {generated: 'i0.ɵɵelementEnd()', source: '</div>', sourceUrl: '../dir/test.html'});\n+        // Creation mode\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵelementStart(0, \"div\")',\n+          source: '<div>',\n+          sourceUrl: '../dir/test.html'\n+        });\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵtext(1, \"this is a test\")',\n+          source: 'this is a test',\n+          sourceUrl: '../dir/test.html'\n+        });\n+        expectMapping(\n+            mappings,\n+            {generated: 'i0.ɵɵelementEnd()', source: '</div>', sourceUrl: '../dir/test.html'});\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵelementStart(2, \"div\")',\n+          source: '<div>',\n+          sourceUrl: '../dir/test.html'\n+        });\n+        expectMapping(\n+            mappings,\n+            {generated: 'i0.ɵɵtext(3)', source: '{{ 1 + 2 }}', sourceUrl: '../dir/test.html'});\n+        expectMapping(\n+            mappings,\n+            {generated: 'i0.ɵɵelementEnd()', source: '</div>', sourceUrl: '../dir/test.html'});\n \n-          // Update mode\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵtextInterpolate(1 + 2)',\n-            source: '{{ 1 + 2 }}',\n-            sourceUrl: '../dir/test.html'\n-          });\n+        // Update mode\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵtextInterpolate(1 + 2)',\n+          source: '{{ 1 + 2 }}',\n+          sourceUrl: '../dir/test.html'\n         });\n+      });\n \n-        it('should create correct mappings when templateUrl is in a different rootDir', () => {\n-          const mappings = compileAndMap(\n-              '<div>this is a test</div><div>{{ 1 + 2 }}</div>', 'extraRootDir/test.html');\n+      it('should create correct mappings when templateUrl is in a different rootDir', () => {\n+        const mappings = compileAndMap(\n+            '<div>this is a test</div><div>{{ 1 + 2 }}</div>', 'extraRootDir/test.html');\n \n-          // Creation mode\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵelementStart(0, \"div\")',\n-            source: '<div>',\n-            sourceUrl: '../extraRootDir/test.html'\n-          });\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵtext(1, \"this is a test\")',\n-            source: 'this is a test',\n-            sourceUrl: '../extraRootDir/test.html'\n-          });\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵelementEnd()',\n-            source: '</div>',\n-            sourceUrl: '../extraRootDir/test.html'\n-          });\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵelementStart(2, \"div\")',\n-            source: '<div>',\n-            sourceUrl: '../extraRootDir/test.html'\n-          });\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵtext(3)',\n-            source: '{{ 1 + 2 }}',\n-            sourceUrl: '../extraRootDir/test.html'\n-          });\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵelementEnd()',\n-            source: '</div>',\n-            sourceUrl: '../extraRootDir/test.html'\n-          });\n+        // Creation mode\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵelementStart(0, \"div\")',\n+          source: '<div>',\n+          sourceUrl: '../extraRootDir/test.html'\n+        });\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵtext(1, \"this is a test\")',\n+          source: 'this is a test',\n+          sourceUrl: '../extraRootDir/test.html'\n+        });\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵelementEnd()',\n+          source: '</div>',\n+          sourceUrl: '../extraRootDir/test.html'\n+        });\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵelementStart(2, \"div\")',\n+          source: '<div>',\n+          sourceUrl: '../extraRootDir/test.html'\n+        });\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵtext(3)',\n+          source: '{{ 1 + 2 }}',\n+          sourceUrl: '../extraRootDir/test.html'\n+        });\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵelementEnd()',\n+          source: '</div>',\n+          sourceUrl: '../extraRootDir/test.html'\n+        });\n \n-          // Update mode\n-          expectMapping(mappings, {\n-            generated: 'i0.ɵɵtextInterpolate(1 + 2)',\n-            source: '{{ 1 + 2 }}',\n-            sourceUrl: '../extraRootDir/test.html'\n-          });\n+        // Update mode\n+        expectMapping(mappings, {\n+          generated: 'i0.ɵɵtextInterpolate(1 + 2)',\n+          source: '{{ 1 + 2 }}',\n+          sourceUrl: '../extraRootDir/test.html'\n         });\n       });\n-    }\n+    });\n+\n \n     function compileAndMap(template: string, templateUrl: string|null = null) {\n       const templateConfig = templateUrl ? `templateUrl: '${templateUrl}'` :"
        }
    ],
    "stats": {
        "total": 258,
        "additions": 77,
        "deletions": 181
    }
}