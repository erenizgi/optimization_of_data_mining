{
    "author": "meblum",
    "message": "fix(common): re-sort output of `KeyValuePipe` when `compareFn` changes (#42821)\n\nPreviously, if only the `compareFn` changed but the data itself did not, then\nthe `KeyValuePipe` did not re-sort the output.\n\nFixes #42819\n\nPR Close #42821",
    "sha": "e42aa6c13b9f1f8f5b2e8c27e97380bf574db873",
    "files": [
        {
            "sha": "a287bb6e5a6a42ad7ac3a5bd7a4a8faf4f33b22c",
            "filename": "packages/common/src/pipes/keyvalue_pipe.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/e42aa6c13b9f1f8f5b2e8c27e97380bf574db873/packages%2Fcommon%2Fsrc%2Fpipes%2Fkeyvalue_pipe.ts",
            "raw_url": "https://github.com/angular/angular/raw/e42aa6c13b9f1f8f5b2e8c27e97380bf574db873/packages%2Fcommon%2Fsrc%2Fpipes%2Fkeyvalue_pipe.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Fpipes%2Fkeyvalue_pipe.ts?ref=e42aa6c13b9f1f8f5b2e8c27e97380bf574db873",
            "patch": "@@ -49,6 +49,7 @@ export class KeyValuePipe implements PipeTransform {\n \n   private differ!: KeyValueDiffer<any, any>;\n   private keyValues: Array<KeyValue<any, any>> = [];\n+  private compareFn: (a: KeyValue<any, any>, b: KeyValue<any, any>) => number = defaultComparator;\n \n   /*\n    * NOTE: when the `input` value is a simple Record<K, V> object, the keys are extracted with\n@@ -91,13 +92,17 @@ export class KeyValuePipe implements PipeTransform {\n     }\n \n     const differChanges: KeyValueChanges<K, V>|null = this.differ.diff(input as any);\n+    const compareFnChanged = compareFn !== this.compareFn;\n \n     if (differChanges) {\n       this.keyValues = [];\n       differChanges.forEachItem((r: KeyValueChangeRecord<K, V>) => {\n         this.keyValues.push(makeKeyValuePair(r.key, r.currentValue!));\n       });\n+    }\n+    if (differChanges || compareFnChanged) {\n       this.keyValues.sort(compareFn);\n+      this.compareFn = compareFn;\n     }\n     return this.keyValues;\n   }"
        },
        {
            "sha": "cbbfeea89594ca20382be62cff245b7b52a1f1a9",
            "filename": "packages/common/test/pipes/keyvalue_pipe_spec.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/e42aa6c13b9f1f8f5b2e8c27e97380bf574db873/packages%2Fcommon%2Ftest%2Fpipes%2Fkeyvalue_pipe_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e42aa6c13b9f1f8f5b2e8c27e97380bf574db873/packages%2Fcommon%2Ftest%2Fpipes%2Fkeyvalue_pipe_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Ftest%2Fpipes%2Fkeyvalue_pipe_spec.ts?ref=e42aa6c13b9f1f8f5b2e8c27e97380bf574db873",
            "patch": "@@ -51,6 +51,15 @@ describe('KeyValuePipe', () => {\n         {key: 'a', value: 1}, {key: 'b', value: 1}\n       ]);\n     });\n+    it('should reorder when compareFn changes', () => {\n+      const pipe = new KeyValuePipe(defaultKeyValueDiffers);\n+      const input = {'b': 1, 'a': 2};\n+      pipe.transform<string, number>(input);\n+      expect(pipe.transform<string, number>(input, (a, b) => a.value - b.value)).toEqual([\n+        {key: 'b', value: 1},\n+        {key: 'a', value: 2},\n+      ]);\n+    });\n     it('should return the same ref if nothing changes', () => {\n       const pipe = new KeyValuePipe(defaultKeyValueDiffers);\n       const transform1 = pipe.transform({1: 2});\n@@ -114,6 +123,15 @@ describe('KeyValuePipe', () => {\n             {key: {id: 1}, value: 1},\n           ]);\n     });\n+    it('should reorder when compareFn changes', () => {\n+      const pipe = new KeyValuePipe(defaultKeyValueDiffers);\n+      const input = new Map([['b', 1], ['a', 2]]);\n+      pipe.transform<string, number>(input);\n+      expect(pipe.transform<string, number>(input, (a, b) => a.value - b.value)).toEqual([\n+        {key: 'b', value: 1},\n+        {key: 'a', value: 2},\n+      ]);\n+    });\n     it('should return the same ref if nothing changes', () => {\n       const pipe = new KeyValuePipe(defaultKeyValueDiffers);\n       const transform1 = pipe.transform(new Map([[1, 2]]));"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 23,
        "deletions": 0
    }
}