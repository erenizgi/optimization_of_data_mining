{
    "author": "alxhub",
    "message": "refactor(compiler-cli): introduce APIs to support directive autocompletion (#40032)\n\nThis commit adds two new APIs to the `TemplateTypeChecker`:\n`getPotentialDomBindings` and `getDirectiveMetadata`. Together, these will\nsupport the Language Service in performing autocompletion of directive\ninputs/outputs.\n\nPR Close #40032",
    "sha": "c0ab43f3c8fdf3815329f8333f6ee054da089e81",
    "files": [
        {
            "sha": "0e8b772a47faf7e65e5ccc0f39c512d833ba39e5",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=c0ab43f3c8fdf3815329f8333f6ee054da089e81",
            "patch": "@@ -805,7 +805,7 @@ export class NgCompiler {\n     const templateTypeChecker = new TemplateTypeCheckerImpl(\n         this.tsProgram, this.typeCheckingProgramStrategy, traitCompiler,\n         this.getTypeCheckingConfig(), refEmitter, reflector, this.adapter, this.incrementalDriver,\n-        scopeRegistry);\n+        scopeRegistry, typeCheckScopeRegistry);\n \n     return {\n       isCore,"
        },
        {
            "sha": "69dcaebb4e9307afe7eade0efd60936afe2705b2",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/checker.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts?ref=c0ab43f3c8fdf3815329f8333f6ee054da089e81",
            "patch": "@@ -6,14 +6,14 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, MethodCall, ParseError, PropertyRead, SafeMethodCall, SafePropertyRead, TmplAstNode, TmplAstTemplate} from '@angular/compiler';\n+import {AST, MethodCall, ParseError, PropertyRead, SafeMethodCall, SafePropertyRead, TmplAstElement, TmplAstNode, TmplAstTemplate} from '@angular/compiler';\n import {AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import * as ts from 'typescript';\n \n-import {FullTemplateMapping} from './api';\n+import {FullTemplateMapping, TypeCheckableDirectiveMeta} from './api';\n import {GlobalCompletion} from './completion';\n import {DirectiveInScope, PipeInScope} from './scope';\n-import {ShimLocation, Symbol} from './symbols';\n+import {DirectiveSymbol, ElementSymbol, ShimLocation, Symbol} from './symbols';\n \n /**\n  * Interface to the Angular Template Type Checker to extract diagnostics and intelligence from the\n@@ -110,6 +110,7 @@ export interface TemplateTypeChecker {\n    *\n    * @see Symbol\n    */\n+  getSymbolOfNode(node: TmplAstElement, component: ts.ClassDeclaration): ElementSymbol|null;\n   getSymbolOfNode(node: AST|TmplAstNode, component: ts.ClassDeclaration): Symbol|null;\n \n   /**\n@@ -149,6 +150,20 @@ export interface TemplateTypeChecker {\n    * the DOM schema.\n    */\n   getPotentialElementTags(component: ts.ClassDeclaration): Map<string, DirectiveInScope|null>;\n+\n+  /**\n+   * Retrieve any potential DOM bindings for the given element.\n+   *\n+   * This returns an array of objects which list both the attribute and property names of each\n+   * binding, which are usually identical but can vary if the HTML attribute name is for example a\n+   * reserved keyword in JS, like the `for` attribute which corresponds to the `htmlFor` property.\n+   */\n+  getPotentialDomBindings(tagName: string): {attribute: string, property: string}[];\n+\n+  /**\n+   * Retrieve the type checking engine's metadata for the given directive class, if available.\n+   */\n+  getDirectiveMetadata(dir: ts.ClassDeclaration): TypeCheckableDirectiveMeta|null;\n }\n \n /**"
        },
        {
            "sha": "ba92ab7e07be3a380f021ffa1266dc73e378e177",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 6,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=c0ab43f3c8fdf3815329f8333f6ee054da089e81",
            "patch": "@@ -6,17 +6,17 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, CssSelector, DomElementSchemaRegistry, MethodCall, ParseError, parseTemplate, PropertyRead, SafeMethodCall, SafePropertyRead, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstVariable} from '@angular/compiler';\n+import {AST, CssSelector, DomElementSchemaRegistry, MethodCall, ParseError, parseTemplate, PropertyRead, SafeMethodCall, SafePropertyRead, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstVariable} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath, getSourceFileOrError} from '../../file_system';\n-import {ReferenceEmitter} from '../../imports';\n+import {Reference, ReferenceEmitter} from '../../imports';\n import {IncrementalBuild} from '../../incremental/api';\n import {ClassDeclaration, isNamedClassDeclaration, ReflectionHost} from '../../reflection';\n-import {ComponentScopeReader} from '../../scope';\n+import {ComponentScopeReader, TypeCheckScopeRegistry} from '../../scope';\n import {isShim} from '../../shims';\n import {getSourceFileOrNull} from '../../util/src/typescript';\n-import {DirectiveInScope, FullTemplateMapping, GlobalCompletion, OptimizeFor, PipeInScope, ProgramTypeCheckAdapter, ShimLocation, Symbol, TemplateId, TemplateTypeChecker, TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from '../api';\n+import {DirectiveInScope, ElementSymbol, FullTemplateMapping, GlobalCompletion, OptimizeFor, PipeInScope, ProgramTypeCheckAdapter, ShimLocation, Symbol, TemplateId, TemplateTypeChecker, TypeCheckableDirectiveMeta, TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from '../api';\n import {TemplateDiagnostic} from '../diagnostics';\n \n import {CompletionEngine} from './completion';\n@@ -83,7 +83,8 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       private refEmitter: ReferenceEmitter, private reflector: ReflectionHost,\n       private compilerHost: Pick<ts.CompilerHost, 'getCanonicalFileName'>,\n       private priorBuild: IncrementalBuild<unknown, FileTypeCheckingData>,\n-      private readonly componentScopeReader: ComponentScopeReader) {}\n+      private readonly componentScopeReader: ComponentScopeReader,\n+      private readonly typeCheckScopeRegistry: TypeCheckScopeRegistry) {}\n \n   resetOverrides(): void {\n     for (const fileRecord of this.state.values()) {\n@@ -471,7 +472,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     }\n     return this.state.get(path)!;\n   }\n-\n+  getSymbolOfNode(node: TmplAstElement, component: ts.ClassDeclaration): ElementSymbol|null;\n   getSymbolOfNode(node: AST|TmplAstNode, component: ts.ClassDeclaration): Symbol|null {\n     const builder = this.getOrCreateSymbolBuilder(component);\n     if (builder === null) {\n@@ -513,6 +514,13 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     return data.pipes;\n   }\n \n+  getDirectiveMetadata(dir: ts.ClassDeclaration): TypeCheckableDirectiveMeta|null {\n+    if (!isNamedClassDeclaration(dir)) {\n+      return null;\n+    }\n+    return this.typeCheckScopeRegistry.getTypeCheckDirectiveMetadata(new Reference(dir));\n+  }\n+\n   getPotentialElementTags(component: ts.ClassDeclaration): Map<string, DirectiveInScope|null> {\n     if (this.elementTagCache.has(component)) {\n       return this.elementTagCache.get(component)!;\n@@ -543,6 +551,14 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     return tagMap;\n   }\n \n+  getPotentialDomBindings(tagName: string): {attribute: string, property: string}[] {\n+    const attributes = REGISTRY.allKnownAttributesOfElement(tagName);\n+    return attributes.map(attribute => ({\n+                            attribute,\n+                            property: REGISTRY.getMappedPropName(attribute),\n+                          }));\n+  }\n+\n   private getScopeData(component: ts.ClassDeclaration): ScopeData|null {\n     if (this.scopeCache.has(component)) {\n       return this.scopeCache.get(component)!;"
        },
        {
            "sha": "320efaf75bb60bb72eb4f8ab36f89d1e74306f80",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=c0ab43f3c8fdf3815329f8333f6ee054da089e81",
            "patch": "@@ -13,9 +13,9 @@ import {absoluteFrom, AbsoluteFsPath, getSourceFileOrError, LogicalFileSystem} f\n import {TestFile} from '../../file_system/testing';\n import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, Reexport, Reference, ReferenceEmitter} from '../../imports';\n import {NOOP_INCREMENTAL_BUILD} from '../../incremental';\n-import {ClassPropertyMapping} from '../../metadata';\n+import {ClassPropertyMapping, CompoundMetadataReader} from '../../metadata';\n import {ClassDeclaration, isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n-import {ComponentScopeReader, LocalModuleScope, ScopeData} from '../../scope';\n+import {ComponentScopeReader, LocalModuleScope, ScopeData, TypeCheckScopeRegistry} from '../../scope';\n import {makeProgram} from '../../testing';\n import {getRootDirs} from '../../util/src/typescript';\n import {ProgramTypeCheckAdapter, TemplateTypeChecker, TypeCheckContext} from '../api';\n@@ -461,9 +461,12 @@ export function setup(targets: TypeCheckingTarget[], overrides: {\n         }\n   };\n \n+  const typeCheckScopeRegistry =\n+      new TypeCheckScopeRegistry(fakeScopeReader, new CompoundMetadataReader([]));\n+\n   const templateTypeChecker = new TemplateTypeCheckerImpl(\n       program, programStrategy, checkAdapter, fullConfig, emitter, reflectionHost, host,\n-      NOOP_INCREMENTAL_BUILD, fakeScopeReader);\n+      NOOP_INCREMENTAL_BUILD, fakeScopeReader, typeCheckScopeRegistry);\n   return {\n     templateTypeChecker,\n     program,"
        },
        {
            "sha": "6d64f68774ccbff1d14a32e5c1a34f2b4b1b0fda",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker__get_symbol_of_template_node_spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 5,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts?ref=c0ab43f3c8fdf3815329f8333f6ee054da089e81",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import {ASTWithSource, Binary, BindingPipe, Conditional, Interpolation, PropertyRead, TmplAstBoundAttribute, TmplAstBoundText, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate} from '@angular/compiler';\n+import {AST, LiteralArray, LiteralMap} from '@angular/compiler/src/compiler';\n import * as ts from 'typescript';\n \n import {absoluteFrom, AbsoluteFsPath, getSourceFileOrError} from '../../file_system';\n@@ -693,15 +694,15 @@ runInEachFileSystem(() => {\n         });\n \n         it('literal array', () => {\n-          const literalArray = interpolation.expressions[0];\n+          const literalArray = interpolation.expressions[0] as LiteralArray;\n           const symbol = templateTypeChecker.getSymbolOfNode(literalArray, cmp)!;\n           assertExpressionSymbol(symbol);\n           expect(program.getTypeChecker().symbolToString(symbol.tsSymbol!)).toEqual('Array');\n           expect(program.getTypeChecker().typeToString(symbol.tsType)).toEqual('Array<number>');\n         });\n \n         it('literal map', () => {\n-          const literalMap = interpolation.expressions[1];\n+          const literalMap = interpolation.expressions[1] as LiteralMap;\n           const symbol = templateTypeChecker.getSymbolOfNode(literalMap, cmp)!;\n           assertExpressionSymbol(symbol);\n           expect(program.getTypeChecker().symbolToString(symbol.tsSymbol!)).toEqual('__object');\n@@ -762,7 +763,7 @@ runInEachFileSystem(() => {\n \n         it('should get symbol for pipe, checkTypeOfPipes: false', () => {\n           setupPipesTest(false);\n-          const pipeSymbol = templateTypeChecker.getSymbolOfNode(binding, cmp)!;\n+          const pipeSymbol = templateTypeChecker.getSymbolOfNode(binding, cmp)! as PipeSymbol;\n           assertPipeSymbol(pipeSymbol);\n           expect(pipeSymbol.tsSymbol).toBeNull();\n           expect(program.getTypeChecker().typeToString(pipeSymbol.tsType!)).toEqual('any');\n@@ -772,6 +773,24 @@ runInEachFileSystem(() => {\n               .toEqual('TestPipe');\n         });\n \n+        it('should get symbols for pipe expression and args', () => {\n+          setupPipesTest(false);\n+          const aSymbol = templateTypeChecker.getSymbolOfNode(binding.exp, cmp)!;\n+          assertExpressionSymbol(aSymbol);\n+          expect(program.getTypeChecker().symbolToString(aSymbol.tsSymbol!)).toEqual('a');\n+          expect(program.getTypeChecker().typeToString(aSymbol.tsType)).toEqual('string');\n+\n+          const bSymbol = templateTypeChecker.getSymbolOfNode(binding.args[0] as AST, cmp)!;\n+          assertExpressionSymbol(bSymbol);\n+          expect(program.getTypeChecker().symbolToString(bSymbol.tsSymbol!)).toEqual('b');\n+          expect(program.getTypeChecker().typeToString(bSymbol.tsType)).toEqual('number');\n+\n+          const cSymbol = templateTypeChecker.getSymbolOfNode(binding.args[1] as AST, cmp)!;\n+          assertExpressionSymbol(cSymbol);\n+          expect(program.getTypeChecker().symbolToString(cSymbol.tsSymbol!)).toEqual('c');\n+          expect(program.getTypeChecker().typeToString(cSymbol.tsType)).toEqual('boolean');\n+        });\n+\n         for (const checkTypeOfPipes of [true, false]) {\n           describe(`checkTypeOfPipes: ${checkTypeOfPipes}`, () => {\n             // Because the args are property reads, we still need information about them.\n@@ -782,12 +801,12 @@ runInEachFileSystem(() => {\n               expect(program.getTypeChecker().symbolToString(aSymbol.tsSymbol!)).toEqual('a');\n               expect(program.getTypeChecker().typeToString(aSymbol.tsType)).toEqual('string');\n \n-              const bSymbol = templateTypeChecker.getSymbolOfNode(binding.args[0], cmp)!;\n+              const bSymbol = templateTypeChecker.getSymbolOfNode(binding.args[0] as AST, cmp)!;\n               assertExpressionSymbol(bSymbol);\n               expect(program.getTypeChecker().symbolToString(bSymbol.tsSymbol!)).toEqual('b');\n               expect(program.getTypeChecker().typeToString(bSymbol.tsType)).toEqual('number');\n \n-              const cSymbol = templateTypeChecker.getSymbolOfNode(binding.args[1], cmp)!;\n+              const cSymbol = templateTypeChecker.getSymbolOfNode(binding.args[1] as AST, cmp)!;\n               assertExpressionSymbol(cSymbol);\n               expect(program.getTypeChecker().symbolToString(cSymbol.tsSymbol!)).toEqual('c');\n               expect(program.getTypeChecker().typeToString(cSymbol.tsType)).toEqual('boolean');"
        },
        {
            "sha": "5e11a656c43fb1e4e6342f1e0dc8fdad5a60248a",
            "filename": "packages/compiler/src/schema/dom_element_schema_registry.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler%2Fsrc%2Fschema%2Fdom_element_schema_registry.ts",
            "raw_url": "https://github.com/angular/angular/raw/c0ab43f3c8fdf3815329f8333f6ee054da089e81/packages%2Fcompiler%2Fsrc%2Fschema%2Fdom_element_schema_registry.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fschema%2Fdom_element_schema_registry.ts?ref=c0ab43f3c8fdf3815329f8333f6ee054da089e81",
            "patch": "@@ -240,6 +240,13 @@ const _ATTR_TO_PROP: {[name: string]: string} = {\n   'tabindex': 'tabIndex',\n };\n \n+// Invert _ATTR_TO_PROP.\n+const _PROP_TO_ATTR: {[name: string]: string} =\n+    Object.keys(_ATTR_TO_PROP).reduce((inverted, attr) => {\n+      inverted[_ATTR_TO_PROP[attr]] = attr;\n+      return inverted;\n+    }, {} as {[prop: string]: string});\n+\n export class DomElementSchemaRegistry extends ElementSchemaRegistry {\n   private _schema: {[element: string]: {[property: string]: string}} = {};\n \n@@ -386,6 +393,12 @@ export class DomElementSchemaRegistry extends ElementSchemaRegistry {\n     return Object.keys(this._schema);\n   }\n \n+  allKnownAttributesOfElement(tagName: string): string[] {\n+    const elementProperties = this._schema[tagName.toLowerCase()] || this._schema['unknown'];\n+    // Convert properties to attributes.\n+    return Object.keys(elementProperties).map(prop => _PROP_TO_ATTR[prop] ?? prop);\n+  }\n+\n   normalizeAnimationStyleProperty(propName: string): string {\n     return dashCaseToCamelCase(propName);\n   }"
        }
    ],
    "stats": {
        "total": 102,
        "additions": 84,
        "deletions": 18
    }
}