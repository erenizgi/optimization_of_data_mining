{
    "author": "alxhub",
    "message": "fix(compiler-cli): correct incremental behavior even with broken imports (#39923)\n\nWhen the compiler is invoked via ngc or the Angular CLI, its APIs are used\nunder the assumption that Angular analysis/diagnostics are only requested if\nthe program has no TypeScript-level errors. A result of this assumption is\nthat the incremental engine has not needed to resolve changes via its\ndependency graph when the program contained broken imports, since broken\nimports are a TypeScript error.\n\nThe Angular Language Service for Ivy is using the compiler as a backend, and\nexercising its incremental compilation APIs without enforcing this\nassumption. As a result, the Language Service has run into issues where\nbroken imports cause incremental compilation to fail and produce incorrect\nresults.\n\nThis commit introduces a mechanism within the compiler to keep track of\nfiles for which dependency analysis has failed, and to always treat such\nfiles as potentially affected by future incremental steps. This is tested\nvia the Language Service infrastructure to ensure that the compiler is doing\nthe right thing in the case of invalid imports.\n\nPR Close #39923",
    "sha": "c7c5b2fc1e1cf4960d897e2b0432769deaac96a3",
    "files": [
        {
            "sha": "82612413055da0f2d6494161851aebc900a713c9",
            "filename": "packages/compiler-cli/ngcc/src/analysis/util.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Futil.ts?ref=c7c5b2fc1e1cf4960d897e2b0432769deaac96a3",
            "patch": "@@ -18,6 +18,7 @@ class NoopDependencyTracker implements DependencyTracker {\n   addResourceDependency(): void {}\n   addTransitiveDependency(): void {}\n   addTransitiveResources(): void {}\n+  recordDependencyAnalysisFailure(): void {}\n }\n \n export const NOOP_DEPENDENCY_TRACKER: DependencyTracker = new NoopDependencyTracker();"
        },
        {
            "sha": "d2f6a635c251bf700050ca3b8093d8c8b73419ff",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/api.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fapi.ts?ref=c7c5b2fc1e1cf4960d897e2b0432769deaac96a3",
            "patch": "@@ -64,4 +64,12 @@ export interface DependencyTracker<T extends {fileName: string} = ts.SourceFile>\n    * `resourcesOf` they will not automatically be added to `from`.\n    */\n   addTransitiveResources(from: T, resourcesOf: T): void;\n+\n+  /**\n+   * Record that the given file contains unresolvable dependencies.\n+   *\n+   * In practice, this means that the dependency graph cannot provide insight into the effects of\n+   * future changes on that file.\n+   */\n+  recordDependencyAnalysisFailure(file: T): void;\n }"
        },
        {
            "sha": "97cf6cca5a2da3eeaba27caba8120e9086211a22",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/dependency_tracking.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fdependency_tracking.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fdependency_tracking.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fdependency_tracking.ts?ref=c7c5b2fc1e1cf4960d897e2b0432769deaac96a3",
            "patch": "@@ -53,6 +53,10 @@ export class FileDependencyGraph<T extends {fileName: string} = ts.SourceFile> i\n     }\n   }\n \n+  recordDependencyAnalysisFailure(file: T): void {\n+    this.nodeFor(file).failedAnalysis = true;\n+  }\n+\n   getResourceDependencies(from: T): AbsoluteFsPath[] {\n     const node = this.nodes.get(from);\n \n@@ -97,6 +101,7 @@ export class FileDependencyGraph<T extends {fileName: string} = ts.SourceFile> i\n         this.nodes.set(sf, {\n           dependsOn: new Set(node.dependsOn),\n           usesResources: new Set(node.usesResources),\n+          failedAnalysis: false,\n         });\n       }\n     }\n@@ -109,6 +114,7 @@ export class FileDependencyGraph<T extends {fileName: string} = ts.SourceFile> i\n       this.nodes.set(sf, {\n         dependsOn: new Set<string>(),\n         usesResources: new Set<AbsoluteFsPath>(),\n+        failedAnalysis: false,\n       });\n     }\n     return this.nodes.get(sf)!;\n@@ -122,6 +128,12 @@ export class FileDependencyGraph<T extends {fileName: string} = ts.SourceFile> i\n function isLogicallyChanged<T extends {fileName: string}>(\n     sf: T, node: FileNode, changedTsPaths: ReadonlySet<string>, deletedTsPaths: ReadonlySet<string>,\n     changedResources: ReadonlySet<AbsoluteFsPath>): boolean {\n+  // A file is assumed to have logically changed if its dependencies could not be determined\n+  // accurately.\n+  if (node.failedAnalysis) {\n+    return true;\n+  }\n+\n   // A file is logically changed if it has physically changed itself (including being deleted).\n   if (changedTsPaths.has(sf.fileName) || deletedTsPaths.has(sf.fileName)) {\n     return true;\n@@ -146,6 +158,7 @@ function isLogicallyChanged<T extends {fileName: string}>(\n interface FileNode {\n   dependsOn: Set<string>;\n   usesResources: Set<AbsoluteFsPath>;\n+  failedAnalysis: boolean;\n }\n \n const EMPTY_SET: ReadonlySet<any> = new Set<any>();"
        },
        {
            "sha": "5579e6ccf3946dde42a26c27b35355eca51aba28",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/src/interpreter.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts?ref=c7c5b2fc1e1cf4960d897e2b0432769deaac96a3",
            "patch": "@@ -220,6 +220,15 @@ export class StaticInterpreter {\n       if (node.originalKeywordKind === ts.SyntaxKind.UndefinedKeyword) {\n         return undefined;\n       } else {\n+        // Check if the symbol here is imported.\n+        if (this.dependencyTracker !== null && this.host.getImportOfIdentifier(node) !== null) {\n+          // It was, but no declaration for the node could be found. This means that the dependency\n+          // graph for the current file cannot be properly updated to account for this (broken)\n+          // import. Instead, the originating file is reported as failing dependency analysis,\n+          // ensuring that future compilations will always attempt to re-resolve the previously\n+          // broken identifier.\n+          this.dependencyTracker.recordDependencyAnalysisFailure(context.originatingFile);\n+        }\n         return DynamicValue.fromUnknownIdentifier(node);\n       }\n     }"
        },
        {
            "sha": "4b6ad7443c84e35f2bdf4918972b26e39817e267",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/test/evaluator_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fevaluator_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fevaluator_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fevaluator_spec.ts?ref=c7c5b2fc1e1cf4960d897e2b0432769deaac96a3",
            "patch": "@@ -991,4 +991,5 @@ const fakeDepTracker: DependencyTracker = {\n   addResourceDependency: () => undefined,\n   addTransitiveDependency: () => undefined,\n   addTransitiveResources: () => undefined,\n+  recordDependencyAnalysisFailure: () => undefined,\n };"
        },
        {
            "sha": "162502b880d2b7ffb74e2e24eac18712e8a29c8e",
            "filename": "packages/language-service/ivy/test/compiler_spec.ts",
            "status": "modified",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts?ref=c7c5b2fc1e1cf4960d897e2b0432769deaac96a3",
            "patch": "@@ -60,4 +60,72 @@ describe('language-service/compiler integration', () => {\n     expect(diags.map(diag => diag.messageText))\n         .toContain(`Type 'number' is not assignable to type 'string'.`);\n   });\n+\n+  it('should handle broken imports during incremental build steps', () => {\n+    // This test validates that the compiler's incremental APIs correctly handle a broken import\n+    // when invoked via the Language Service. Testing this via the LS is important as only the LS\n+    // requests Angular analysis in the presence of TypeScript-level errors. In the case of broken\n+    // imports this distinction is especially important: Angular's incremental analysis is\n+    // built on the the compiler's dependency graph, and this graph must be able to function even\n+    // with broken imports.\n+    //\n+    // The test works by creating a component/module pair where the module imports and declares a\n+    // component from a separate file. That component is initially not exported, meaning the\n+    // module's import is broken. Angular will correctly complain that the NgModule is declaring a\n+    // value which is not statically analyzable.\n+    //\n+    // Then, the component file is fixed to properly export the component class, and an incremental\n+    // build step is performed. The compiler should recognize that the module's previous analysis\n+    // is stale, even though it was not able to fully understand the import during the first pass.\n+\n+    const moduleFile = absoluteFrom('/mod.ts');\n+    const componentFile = absoluteFrom('/cmp.ts');\n+\n+    const componentSource = (isExported: boolean): string => `\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        selector: 'some-cmp',\n+        template: 'Not important',\n+      })\n+      ${isExported ? 'export' : ''} class Cmp {}\n+    `;\n+\n+    const env = LanguageServiceTestEnvironment.setup([\n+      {\n+        name: moduleFile,\n+        contents: `\n+          import {NgModule} from '@angular/core';\n+    \n+          import {Cmp} from './cmp';\n+    \n+          @NgModule({\n+            declarations: [Cmp],\n+          })\n+          export class Mod {}\n+        `,\n+        isRoot: true,\n+      },\n+      {\n+        name: componentFile,\n+        contents: componentSource(/* start with component not exported */ false),\n+        isRoot: true,\n+      }\n+    ]);\n+\n+    // Angular should be complaining about the module not being understandable.\n+    const programBefore = env.tsLS.getProgram()!;\n+    const moduleSfBefore = programBefore.getSourceFile(moduleFile)!;\n+    const ngDiagsBefore = env.ngLS.compilerFactory.getOrCreate().getDiagnostics(moduleSfBefore);\n+    expect(ngDiagsBefore.length).toBe(1);\n+\n+    // Fix the import.\n+    env.updateFile(componentFile, componentSource(/* properly export the component */ true));\n+\n+    // Angular should stop complaining about the NgModule.\n+    const programAfter = env.tsLS.getProgram()!;\n+    const moduleSfAfter = programAfter.getSourceFile(moduleFile)!;\n+    const ngDiagsAfter = env.ngLS.compilerFactory.getOrCreate().getDiagnostics(moduleSfAfter);\n+    expect(ngDiagsAfter.length).toBe(0);\n+  });\n });"
        },
        {
            "sha": "bfce6f1ad5b5c0ee364169aa1b7681969c33cf22",
            "filename": "packages/language-service/ivy/test/env.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7c5b2fc1e1cf4960d897e2b0432769deaac96a3/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts?ref=c7c5b2fc1e1cf4960d897e2b0432769deaac96a3",
            "patch": "@@ -55,8 +55,8 @@ export interface TemplateOverwriteResult {\n \n export class LanguageServiceTestEnvironment {\n   private constructor(\n-      private tsLS: ts.LanguageService, readonly ngLS: LanguageService,\n-      readonly host: MockServerHost) {}\n+      readonly tsLS: ts.LanguageService, readonly ngLS: LanguageService,\n+      readonly projectService: ts.server.ProjectService, readonly host: MockServerHost) {}\n \n   static setup(files: TestFile[], options: TestableOptions = {}): LanguageServiceTestEnvironment {\n     const fs = getFileSystem();\n@@ -106,7 +106,7 @@ export class LanguageServiceTestEnvironment {\n     const tsLS = project.getLanguageService();\n \n     const ngLS = new LanguageService(project, tsLS);\n-    return new LanguageServiceTestEnvironment(tsLS, ngLS, host);\n+    return new LanguageServiceTestEnvironment(tsLS, ngLS, projectService, host);\n   }\n \n   getClass(fileName: AbsoluteFsPath, className: string): ts.ClassDeclaration {\n@@ -136,6 +136,17 @@ export class LanguageServiceTestEnvironment {\n     return {cursor, nodes, component, text};\n   }\n \n+  updateFile(fileName: AbsoluteFsPath, contents: string): void {\n+    const scriptInfo = this.projectService.getScriptInfo(fileName);\n+    if (scriptInfo === undefined) {\n+      throw new Error(`Could not find a file named ${fileName}`);\n+    }\n+\n+    // Get the current contents to find the length\n+    const len = scriptInfo.getSnapshot().getLength();\n+    scriptInfo.editContent(0, len, contents);\n+  }\n+\n   expectNoSourceDiagnostics(): void {\n     const program = this.tsLS.getProgram();\n     if (program === undefined) {"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 114,
        "deletions": 3
    }
}