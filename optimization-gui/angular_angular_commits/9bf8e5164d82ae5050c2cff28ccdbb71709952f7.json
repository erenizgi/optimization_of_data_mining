{
    "author": "josephperrott",
    "message": "refactor(dev-infra): use a singleton for GitClient (#41515)\n\nCreates a singleton class for GitClient rather than relying on creating an instance to\nrequire being passed around throughout its usages.\n\nPR Close #41515",
    "sha": "9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
    "files": [
        {
            "sha": "58af0c2cf85fc2f521de657d2b18b709eb42c361",
            "filename": "dev-infra/caretaker/check/base.spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fbase.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fbase.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fbase.spec.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -5,6 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {installVirtualGitClientSpies} from '../../utils/testing';\n import {BaseModule} from './base';\n \n /** Data mocking as the \"retrieved data\". */\n@@ -23,17 +24,18 @@ describe('BaseModule', () => {\n \n   beforeEach(() => {\n     retrieveDataSpy = spyOn(ConcreteBaseModule.prototype, 'retrieveData');\n+    installVirtualGitClientSpies();\n   });\n \n   it('begins retrieving data during construction', () => {\n-    new ConcreteBaseModule({} as any, {} as any);\n+    new ConcreteBaseModule({} as any);\n \n     expect(retrieveDataSpy).toHaveBeenCalled();\n   });\n \n   it('makes the data available via the data attribute', async () => {\n     retrieveDataSpy.and.callThrough();\n-    const module = new ConcreteBaseModule({} as any, {} as any);\n+    const module = new ConcreteBaseModule({} as any);\n \n     expect(await module.data).toBe(exampleData);\n   });"
        },
        {
            "sha": "e60634b00740f3a2beb119eeb9b4f20320727bcb",
            "filename": "dev-infra/caretaker/check/base.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fbase.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fbase.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -11,11 +11,12 @@ import {CaretakerConfig} from '../config';\n \n /** The BaseModule to extend modules for caretaker checks from. */\n export abstract class BaseModule<Data> {\n+  /** The singleton instance of the GitClient. */\n+  protected git = GitClient.getAuthenticatedInstance();\n   /** The data for the module. */\n   readonly data = this.retrieveData();\n \n-  constructor(\n-      protected git: GitClient, protected config: NgDevConfig<{caretaker: CaretakerConfig}>) {}\n+  constructor(protected config: NgDevConfig<{caretaker: CaretakerConfig}>) {}\n \n   /** Asyncronously retrieve data for the module. */\n   protected abstract retrieveData(): Promise<Data>;"
        },
        {
            "sha": "c16eff89fd9934fa1cf48f21485d0547f2129e7e",
            "filename": "dev-infra/caretaker/check/check.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fcheck.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fcheck.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fcheck.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -23,15 +23,13 @@ const moduleList = [\n ];\n \n /** Check the status of services which Angular caretakers need to monitor. */\n-export async function checkServiceStatuses(githubToken: string) {\n+export async function checkServiceStatuses() {\n+  // Set the verbose logging state of the GitClient.\n+  GitClient.getAuthenticatedInstance().setVerboseLoggingState(false);\n   /** The configuration for the caretaker commands. */\n   const config = getCaretakerConfig();\n-  /** The GitClient for interacting with git and Github. */\n-  const git = new GitClient(githubToken, config);\n-  // Prevent logging of the git commands being executed during the check.\n-  GitClient.LOG_COMMANDS = false;\n   /** List of instances of Caretaker Check modules */\n-  const caretakerCheckModules = moduleList.map(module => new module(git, config));\n+  const caretakerCheckModules = moduleList.map(module => new module(config));\n \n   // Module's `data` is casted as Promise<unknown> because the data types of the `module`'s `data`\n   // promises do not match typings, however our usage here is only to determine when the promise"
        },
        {
            "sha": "4b21f0968b35e439edaf75a3a01df12d352e0a3c",
            "filename": "dev-infra/caretaker/check/ci.spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fci.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fci.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fci.spec.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -7,11 +7,11 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {SemVer} from 'semver';\n-import {ReleaseTrain} from '../../release/versioning';\n \n+import {ReleaseTrain} from '../../release/versioning';\n import * as versioning from '../../release/versioning/active-release-trains';\n import * as console from '../../utils/console';\n-import {buildVirtualGitClient, mockNgDevConfig, VirtualGitClient} from '../../utils/testing';\n+import {installVirtualGitClientSpies, mockNgDevConfig} from '../../utils/testing';\n \n import {CiModule} from './ci';\n \n@@ -20,10 +20,9 @@ describe('CiModule', () => {\n   let getBranchStatusFromCiSpy: jasmine.Spy;\n   let infoSpy: jasmine.Spy;\n   let debugSpy: jasmine.Spy;\n-  let virtualGitClient: VirtualGitClient;\n \n   beforeEach(() => {\n-    virtualGitClient = buildVirtualGitClient();\n+    installVirtualGitClientSpies();\n     fetchActiveReleaseTrainsSpy = spyOn(versioning, 'fetchActiveReleaseTrains');\n     getBranchStatusFromCiSpy = spyOn(CiModule.prototype, 'getBranchStatusFromCi' as any);\n     infoSpy = spyOn(console, 'info');\n@@ -34,7 +33,7 @@ describe('CiModule', () => {\n     it('handles active rc train', async () => {\n       const trains = buildMockActiveReleaseTrains(true);\n       fetchActiveReleaseTrainsSpy.and.resolveTo(trains);\n-      const module = new CiModule(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new CiModule({caretaker: {}, ...mockNgDevConfig});\n       await module.data;\n \n       expect(getBranchStatusFromCiSpy).toHaveBeenCalledWith(trains.releaseCandidate.branchName);\n@@ -46,7 +45,7 @@ describe('CiModule', () => {\n     it('handles an inactive rc train', async () => {\n       const trains = buildMockActiveReleaseTrains(false);\n       fetchActiveReleaseTrainsSpy.and.resolveTo(trains);\n-      const module = new CiModule(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new CiModule({caretaker: {}, ...mockNgDevConfig});\n       await module.data;\n \n       expect(getBranchStatusFromCiSpy).toHaveBeenCalledWith(trains.latest.branchName);\n@@ -58,7 +57,7 @@ describe('CiModule', () => {\n       const trains = buildMockActiveReleaseTrains(false);\n       fetchActiveReleaseTrainsSpy.and.resolveTo(trains);\n       getBranchStatusFromCiSpy.and.returnValue('success');\n-      const module = new CiModule(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new CiModule({caretaker: {}, ...mockNgDevConfig});\n       const data = await module.data;\n \n       expect(data[0]).toEqual(\n@@ -89,7 +88,7 @@ describe('CiModule', () => {\n     ]);\n     fetchActiveReleaseTrainsSpy.and.resolveTo([]);\n \n-    const module = new CiModule(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+    const module = new CiModule({caretaker: {}, ...mockNgDevConfig});\n     Object.defineProperty(module, 'data', {value: fakeData});\n \n     await module.printToTerminal();"
        },
        {
            "sha": "92343638ecb281a1ffa938a2fc204d489e1ecb5f",
            "filename": "dev-infra/caretaker/check/cli.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fcli.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Arguments, Argv, CommandModule} from 'yargs';\n+import {Argv, CommandModule} from 'yargs';\n \n import {addGithubTokenOption} from '../../utils/git/github-yargs';\n \n@@ -23,8 +23,8 @@ function builder(yargs: Argv) {\n }\n \n /** Handles the command. */\n-async function handler({githubToken}: Arguments<CaretakerCheckOptions>) {\n-  await checkServiceStatuses(githubToken);\n+async function handler() {\n+  await checkServiceStatuses();\n }\n \n /** yargs command module for checking status information for the repository  */"
        },
        {
            "sha": "3fc9bec36cf20ad4b0f3d99202cce9d9d40f55cb",
            "filename": "dev-infra/caretaker/check/g3.spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fg3.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fg3.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fg3.spec.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -9,7 +9,8 @@\n import {SpawnSyncReturns} from 'child_process';\n \n import * as console from '../../utils/console';\n-import {buildVirtualGitClient, mockNgDevConfig, VirtualGitClient} from '../../utils/testing';\n+import {GitClient} from '../../utils/git';\n+import {installVirtualGitClientSpies, mockNgDevConfig} from '../../utils/testing';\n \n import {G3Module, G3StatsData} from './g3';\n \n@@ -18,10 +19,9 @@ describe('G3Module', () => {\n   let getLatestShas: jasmine.Spy;\n   let getDiffStats: jasmine.Spy;\n   let infoSpy: jasmine.Spy;\n-  let virtualGitClient: VirtualGitClient;\n \n   beforeEach(() => {\n-    virtualGitClient = buildVirtualGitClient();\n+    installVirtualGitClientSpies();\n     getG3FileIncludeAndExcludeLists =\n         spyOn(G3Module.prototype, 'getG3FileIncludeAndExcludeLists' as any).and.returnValue(null);\n     getLatestShas = spyOn(G3Module.prototype, 'getLatestShas' as any).and.returnValue(null);\n@@ -33,7 +33,7 @@ describe('G3Module', () => {\n     it('unless the g3 merge config is not defined in the angular robot file', async () => {\n       getG3FileIncludeAndExcludeLists.and.returnValue(null);\n       getLatestShas.and.returnValue({g3: 'abc123', master: 'zxy987'});\n-      const module = new G3Module(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new G3Module({caretaker: {}, ...mockNgDevConfig});\n \n       expect(getDiffStats).not.toHaveBeenCalled();\n       expect(await module.data).toBe(undefined);\n@@ -42,7 +42,7 @@ describe('G3Module', () => {\n     it('unless the branch shas are not able to be retrieved', async () => {\n       getLatestShas.and.returnValue(null);\n       getG3FileIncludeAndExcludeLists.and.returnValue({include: ['file1'], exclude: []});\n-      const module = new G3Module(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new G3Module({caretaker: {}, ...mockNgDevConfig});\n \n       expect(getDiffStats).not.toHaveBeenCalled();\n       expect(await module.data).toBe(undefined);\n@@ -52,7 +52,7 @@ describe('G3Module', () => {\n       getLatestShas.and.returnValue({g3: 'abc123', master: 'zxy987'});\n       getG3FileIncludeAndExcludeLists.and.returnValue({include: ['project1/*'], exclude: []});\n       getDiffStats.and.callThrough();\n-      spyOn(virtualGitClient, 'run').and.callFake((args: string[]): any => {\n+      spyOn(GitClient.prototype, 'run').and.callFake((args: string[]): any => {\n         const output: Partial<SpawnSyncReturns<string>> = {};\n         if (args[0] === 'rev-list') {\n           output.stdout = '3';\n@@ -63,7 +63,7 @@ describe('G3Module', () => {\n         return output;\n       });\n \n-      const module = new G3Module(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new G3Module({caretaker: {}, ...mockNgDevConfig});\n       const {insertions, deletions, files, commits} = (await module.data) as G3StatsData;\n \n       expect(insertions).toBe(12);\n@@ -82,7 +82,7 @@ describe('G3Module', () => {\n         commits: 2,\n       });\n \n-      const module = new G3Module(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new G3Module({caretaker: {}, ...mockNgDevConfig});\n       Object.defineProperty(module, 'data', {value: fakeData});\n       await module.printToTerminal();\n \n@@ -98,7 +98,7 @@ describe('G3Module', () => {\n         commits: 25,\n       });\n \n-      const module = new G3Module(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new G3Module({caretaker: {}, ...mockNgDevConfig});\n       Object.defineProperty(module, 'data', {value: fakeData});\n       await module.printToTerminal();\n "
        },
        {
            "sha": "9dfff3997563171f03298463d943177fc72ec784",
            "filename": "dev-infra/caretaker/check/github.spec.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 17,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fgithub.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fgithub.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fgithub.spec.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -7,46 +7,44 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as console from '../../utils/console';\n-import {GithubGraphqlClient} from '../../utils/git/github';\n-import {buildVirtualGitClient, mockNgDevConfig, VirtualGitClient} from '../../utils/testing';\n+import {GithubClient} from '../../utils/git/github';\n+import {installVirtualGitClientSpies, mockNgDevConfig} from '../../utils/testing';\n \n import {GithubQueriesModule} from './github';\n \n describe('GithubQueriesModule', () => {\n   let githubApiSpy: jasmine.Spy;\n   let infoSpy: jasmine.Spy;\n   let infoGroupSpy: jasmine.Spy;\n-  let virtualGitClient: VirtualGitClient;\n \n   beforeEach(() => {\n-    githubApiSpy = spyOn(GithubGraphqlClient.prototype, 'query')\n+    githubApiSpy = spyOn(GithubClient.prototype, 'graphql')\n                        .and.throwError(\n                            'The graphql query response must always be manually defined in a test.');\n-    virtualGitClient = buildVirtualGitClient();\n+    installVirtualGitClientSpies();\n     infoGroupSpy = spyOn(console.info, 'group');\n     infoSpy = spyOn(console, 'info');\n   });\n \n   describe('gathering stats', () => {\n     it('unless githubQueries are `undefined`', async () => {\n-      const module = new GithubQueriesModule(\n-          virtualGitClient, {...mockNgDevConfig, caretaker: {githubQueries: undefined}});\n+      const module =\n+          new GithubQueriesModule({...mockNgDevConfig, caretaker: {githubQueries: undefined}});\n \n       expect(await module.data).toBe(undefined);\n     });\n \n     it('unless githubQueries are an empty array', async () => {\n-      const module = new GithubQueriesModule(\n-          virtualGitClient, {...mockNgDevConfig, caretaker: {githubQueries: []}});\n+      const module = new GithubQueriesModule({...mockNgDevConfig, caretaker: {githubQueries: []}});\n \n       expect(await module.data).toBe(undefined);\n     });\n \n-    it('for the requestd Github queries', async () => {\n+    it('for the requested Github queries', async () => {\n       githubApiSpy.and.returnValue({\n-        'keynamewithspaces': {issueCount: 1, nodes: [{url: 'http://gituhb.com/owner/name/issue/1'}]}\n+        'keynamewithspaces': {issueCount: 1, nodes: [{url: 'http://github.com/owner/name/issue/1'}]}\n       });\n-      const module = new GithubQueriesModule(virtualGitClient, {\n+      const module = new GithubQueriesModule({\n         ...mockNgDevConfig,\n         caretaker: {githubQueries: [{name: 'key name with spaces', query: 'issue: yes'}]}\n       });\n@@ -55,7 +53,7 @@ describe('GithubQueriesModule', () => {\n         queryName: 'key name with spaces',\n         count: 1,\n         queryUrl: 'https://github.com/owner/name/issues?q=issue:%20yes',\n-        matchedUrls: ['http://gituhb.com/owner/name/issue/1'],\n+        matchedUrls: ['http://github.com/owner/name/issue/1'],\n       }]);\n     });\n   });\n@@ -78,7 +76,7 @@ describe('GithubQueriesModule', () => {\n       ]);\n \n \n-      const module = new GithubQueriesModule(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new GithubQueriesModule({caretaker: {}, ...mockNgDevConfig});\n       Object.defineProperty(module, 'data', {value: fakeData});\n \n       await module.printToTerminal();\n@@ -95,7 +93,7 @@ describe('GithubQueriesModule', () => {\n           queryName: 'query1',\n           count: 1,\n           queryUrl: 'https://github.com/owner/name/issues?q=issue:%20yes',\n-          matchedUrls: ['http://gituhb.com/owner/name/issue/1'],\n+          matchedUrls: ['http://github.com/owner/name/issue/1'],\n         },\n         {\n           queryName: 'query2',\n@@ -105,7 +103,7 @@ describe('GithubQueriesModule', () => {\n         },\n       ]);\n \n-      const module = new GithubQueriesModule(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new GithubQueriesModule({caretaker: {}, ...mockNgDevConfig});\n       Object.defineProperty(module, 'data', {value: fakeData});\n \n       await module.printToTerminal();\n@@ -114,7 +112,7 @@ describe('GithubQueriesModule', () => {\n       expect(infoSpy).toHaveBeenCalledWith('query1  1');\n       expect(infoGroupSpy)\n           .toHaveBeenCalledWith('https://github.com/owner/name/issues?q=issue:%20yes');\n-      expect(infoSpy).toHaveBeenCalledWith('- http://gituhb.com/owner/name/issue/1');\n+      expect(infoSpy).toHaveBeenCalledWith('- http://github.com/owner/name/issue/1');\n       expect(infoSpy).toHaveBeenCalledWith('query2  0');\n     });\n   });"
        },
        {
            "sha": "f0178c5ec100d82a791ee9d6d55c5b4425ff42c1",
            "filename": "dev-infra/caretaker/check/github.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fgithub.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fgithub.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fgithub.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -56,7 +56,7 @@ export class GithubQueriesModule extends BaseModule<GithubQueryResults|void> {\n     }\n \n     /** The results of the generated github query. */\n-    const queryResult = await this.git.github.graphql.query(this.buildGraphqlQuery(queries));\n+    const queryResult = await this.git.github.graphql(this.buildGraphqlQuery(queries));\n     const results = Object.values(queryResult);\n \n     const {owner, name: repo} = this.git.remoteConfig;\n@@ -74,16 +74,16 @@ export class GithubQueriesModule extends BaseModule<GithubQueryResults|void> {\n   /** Build a Graphql query statement for the provided queries. */\n   private buildGraphqlQuery(queries: NonNullable<CaretakerConfig['githubQueries']>) {\n     /** The query object for graphql. */\n-    const graphQlQuery: GithubQueryResult = {};\n+    const graphqlQuery: GithubQueryResult = {};\n     const {owner, name: repo} = this.git.remoteConfig;\n     /** The Github search filter for the configured repository. */\n     const repoFilter = `repo:${owner}/${repo}`;\n \n \n     queries.forEach(({name, query}) => {\n-      /** The name of the query, with spaces removed to match GraphQL requirements. */\n+      /** The name of the query, with spaces removed to match Graphql requirements. */\n       const queryKey = alias(name.replace(/ /g, ''), 'search');\n-      graphQlQuery[queryKey] = params(\n+      graphqlQuery[queryKey] = params(\n           {\n             type: 'ISSUE',\n             first: MAX_RETURNED_ISSUES,\n@@ -92,7 +92,7 @@ export class GithubQueriesModule extends BaseModule<GithubQueryResults|void> {\n           {...GithubQueryResultFragment});\n     });\n \n-    return graphQlQuery;\n+    return graphqlQuery;\n   }\n \n   async printToTerminal() {"
        },
        {
            "sha": "6c4688fe7d8226b96c364180f7318e39727a5de4",
            "filename": "dev-infra/caretaker/check/services.spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fservices.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fcaretaker%2Fcheck%2Fservices.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fservices.spec.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -8,28 +8,27 @@\n  */\n \n import * as console from '../../utils/console';\n-import {buildVirtualGitClient, mockNgDevConfig, VirtualGitClient} from '../../utils/testing';\n+import {installVirtualGitClientSpies, mockNgDevConfig} from '../../utils/testing';\n \n import {services, ServicesModule} from './services';\n \n describe('ServicesModule', () => {\n   let getStatusFromStandardApiSpy: jasmine.Spy;\n   let infoSpy: jasmine.Spy;\n   let infoGroupSpy: jasmine.Spy;\n-  let virtualGitClient: VirtualGitClient;\n \n   services.splice(0, Infinity, {url: 'fakeStatus.com/api.json', name: 'Service Name'});\n \n   beforeEach(() => {\n     getStatusFromStandardApiSpy = spyOn(ServicesModule.prototype, 'getStatusFromStandardApi');\n-    virtualGitClient = buildVirtualGitClient();\n+    installVirtualGitClientSpies();\n     infoGroupSpy = spyOn(console.info, 'group');\n     infoSpy = spyOn(console, 'info');\n   });\n \n   describe('gathering status', () => {\n     it('for each of the services', async () => {\n-      new ServicesModule(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      new ServicesModule({caretaker: {}, ...mockNgDevConfig});\n \n       expect(getStatusFromStandardApiSpy)\n           .toHaveBeenCalledWith({url: 'fakeStatus.com/api.json', name: 'Service Name'});\n@@ -54,7 +53,7 @@ describe('ServicesModule', () => {\n       ]);\n \n \n-      const module = new ServicesModule(virtualGitClient, {caretaker: {}, ...mockNgDevConfig});\n+      const module = new ServicesModule({caretaker: {}, ...mockNgDevConfig});\n       Object.defineProperty(module, 'data', {value: fakeData});\n       await module.printToTerminal();\n "
        },
        {
            "sha": "a66620f986a4d7803bdb15b13b5fa6e4b80f5bba",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 163,
            "deletions": 116,
            "changes": 279,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -405,36 +405,6 @@ function getListCommitsInBranchUrl(_a, branchName) {\n     return \"https://github.com/\" + remoteParams.owner + \"/\" + remoteParams.repo + \"/commits/\" + branchName;\n }\n \n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-/** Sets up the `github-token` command option for the given Yargs instance. */\n-function addGithubTokenOption(yargs) {\n-    return yargs\n-        // 'github-token' is casted to 'githubToken' to properly set up typings to reflect the key in\n-        // the Argv object being camelCase rather than kebob case due to the `camel-case-expansion`\n-        // config: https://github.com/yargs/yargs-parser#camel-case-expansion\n-        .option('github-token', {\n-        type: 'string',\n-        description: 'Github token. If not set, token is retrieved from the environment variables.',\n-        coerce: function (token) {\n-            var githubToken = token || process.env.GITHUB_TOKEN || process.env.TOKEN;\n-            if (!githubToken) {\n-                error(red('No Github token set. Please set the `GITHUB_TOKEN` environment variable.'));\n-                error(red('Alternatively, pass the `--github-token` command line flag.'));\n-                error(yellow(\"You can generate a token here: \" + GITHUB_TOKEN_GENERATE_URL));\n-                process.exit(1);\n-            }\n-            return githubToken;\n-        },\n-    })\n-        .default('github-token', '', '<LOCAL TOKEN>');\n-}\n-\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n@@ -477,6 +447,14 @@ var GithubApiRequestError = /** @class */ (function (_super) {\n     }\n     return GithubApiRequestError;\n }(Error));\n+/** Error for failed Github API requests. */\n+var GithubGraphqlClientError = /** @class */ (function (_super) {\n+    tslib.__extends(GithubGraphqlClientError, _super);\n+    function GithubGraphqlClientError() {\n+        return _super !== null && _super.apply(this, arguments) || this;\n+    }\n+    return GithubGraphqlClientError;\n+}(Error));\n /**\n  * A Github client for interacting with the Github APIs.\n  *\n@@ -485,21 +463,48 @@ var GithubApiRequestError = /** @class */ (function (_super) {\n  **/\n var GithubClient = /** @class */ (function (_super) {\n     tslib.__extends(GithubClient, _super);\n+    /**\n+     * @param token The github authentication token for Github Rest and Graphql API requests.\n+     */\n     function GithubClient(token) {\n         var _this = \n         // Pass in authentication token to base Octokit class.\n         _super.call(this, { auth: token }) || this;\n+        _this.token = token;\n         /** The current user based on checking against the Github API. */\n         _this._currentUser = null;\n+        /** The graphql instance with authentication set during construction. */\n+        _this._graphql = graphql.graphql.defaults({ headers: { authorization: \"token \" + _this.token } });\n         _this.hook.error('request', function (error) {\n             // Wrap API errors in a known error class. This allows us to\n             // expect Github API errors better and in a non-ambiguous way.\n             throw new GithubApiRequestError(error.status, error.message);\n         });\n-        // Create authenticated graphql client.\n-        _this.graphql = new GithubGraphqlClient(token);\n+        // Note: The prototype must be set explictly as Github's Octokit class is a non-standard class\n+        // definition which adjusts the prototype chain.\n+        // See:\n+        //    https://github.com/Microsoft/TypeScript/wiki/FAQ#why-doesnt-extending-built-ins-like-error-array-and-map-work\n+        //    https://github.com/octokit/rest.js/blob/7b51cee4a22b6e52adcdca011f93efdffa5df998/lib/constructor.js\n+        Object.setPrototypeOf(_this, GithubClient.prototype);\n         return _this;\n     }\n+    /** Perform a query using Github's Graphql API. */\n+    GithubClient.prototype.graphql = function (queryObject, params) {\n+        if (params === void 0) { params = {}; }\n+        return tslib.__awaiter(this, void 0, void 0, function () {\n+            return tslib.__generator(this, function (_a) {\n+                switch (_a.label) {\n+                    case 0:\n+                        if (this.token === undefined) {\n+                            throw new GithubGraphqlClientError('Cannot query via graphql without an authentication token set, use the authenticated ' +\n+                                '`GitClient` by calling `GitClient.getAuthenticatedInstance()`.');\n+                        }\n+                        return [4 /*yield*/, this._graphql(typedGraphqlify.query(queryObject), params)];\n+                    case 1: return [2 /*return*/, (_a.sent())];\n+                }\n+            });\n+        });\n+    };\n     /** Retrieve the login of the current user from Github. */\n     GithubClient.prototype.getCurrentUser = function () {\n         return tslib.__awaiter(this, void 0, void 0, function () {\n@@ -511,7 +516,7 @@ var GithubClient = /** @class */ (function (_super) {\n                         if (this._currentUser !== null) {\n                             return [2 /*return*/, this._currentUser];\n                         }\n-                        return [4 /*yield*/, this.graphql.query({\n+                        return [4 /*yield*/, this.graphql({\n                                 viewer: {\n                                     login: typedGraphqlify.types.string,\n                                 }\n@@ -525,34 +530,6 @@ var GithubClient = /** @class */ (function (_super) {\n     };\n     return GithubClient;\n }(Octokit));\n-/** A client for interacting with Github's GraphQL API. */\n-var GithubGraphqlClient = /** @class */ (function () {\n-    function GithubGraphqlClient(token) {\n-        /** The Github GraphQL (v4) API. */\n-        this.graqhql = graphql.graphql;\n-        // Set the default headers to include authorization with the provided token for all\n-        // graphQL calls.\n-        if (token) {\n-            this.graqhql = this.graqhql.defaults({ headers: { authorization: \"token \" + token } });\n-        }\n-    }\n-    /** Perform a query using Github's GraphQL API. */\n-    GithubGraphqlClient.prototype.query = function (queryObject, params) {\n-        if (params === void 0) { params = {}; }\n-        return tslib.__awaiter(this, void 0, void 0, function () {\n-            var queryString;\n-            return tslib.__generator(this, function (_a) {\n-                switch (_a.label) {\n-                    case 0:\n-                        queryString = typedGraphqlify.query(queryObject);\n-                        return [4 /*yield*/, this.graqhql(queryString, params)];\n-                    case 1: return [2 /*return*/, (_a.sent())];\n-                }\n-            });\n-        });\n-    };\n-    return GithubGraphqlClient;\n-}());\n \n /**\n  * @license\n@@ -585,34 +562,71 @@ var GitCommandError = /** @class */ (function (_super) {\n  *     the dev-infra configuration is loaded with its Github configuration.\n  **/\n var GitClient = /** @class */ (function () {\n+    /**\n+     * @param githubToken The github token used for authentication, if provided.\n+     * @param _config The configuration, containing the github specific configuration.\n+     * @param _projectRoot The full path to the root of the repository base.\n+     */\n     function GitClient(githubToken, _config, _projectRoot) {\n         if (_config === void 0) { _config = getConfig(); }\n         if (_projectRoot === void 0) { _projectRoot = getRepoBaseDir(); }\n         this.githubToken = githubToken;\n         this._config = _config;\n         this._projectRoot = _projectRoot;\n-        /** Short-hand for accessing the default remote configuration. */\n-        this.remoteConfig = this._config.github;\n-        /** Octokit request parameters object for targeting the configured remote. */\n-        this.remoteParams = { owner: this.remoteConfig.owner, repo: this.remoteConfig.name };\n-        /** Git URL that resolves to the configured repository. */\n-        this.repoGitUrl = getRepositoryGitUrl(this.remoteConfig, this.githubToken);\n-        /** Instance of the authenticated Github octokit API. */\n-        this.github = new GithubClient(this.githubToken);\n+        /** Whether verbose logging of Git actions should be used. */\n+        this.verboseLogging = true;\n         /** The OAuth scopes available for the provided Github token. */\n         this._cachedOauthScopes = null;\n         /**\n          * Regular expression that matches the provided Github token. Used for\n          * sanitizing the token from Git child process output.\n          */\n         this._githubTokenRegex = null;\n+        /** Short-hand for accessing the default remote configuration. */\n+        this.remoteConfig = this._config.github;\n+        /** Octokit request parameters object for targeting the configured remote. */\n+        this.remoteParams = { owner: this.remoteConfig.owner, repo: this.remoteConfig.name };\n+        /** Instance of the authenticated Github octokit API. */\n+        this.github = new GithubClient(this.githubToken);\n         // If a token has been specified (and is not empty), pass it to the Octokit API and\n         // also create a regular expression that can be used for sanitizing Git command output\n         // so that it does not print the token accidentally.\n-        if (githubToken != null) {\n+        if (typeof githubToken === 'string') {\n             this._githubTokenRegex = new RegExp(githubToken, 'g');\n         }\n     }\n+    /**\n+     * Static method to get the singleton instance of the unauthorized GitClient, creating it if it\n+     * has not yet been created.\n+     */\n+    GitClient.getInstance = function () {\n+        if (!GitClient.unauthenticated) {\n+            GitClient.unauthenticated = new GitClient(undefined);\n+        }\n+        return GitClient.unauthenticated;\n+    };\n+    /**\n+     * Static method to get the singleton instance of the authenticated GitClient if it has been\n+     * generated.\n+     */\n+    GitClient.getAuthenticatedInstance = function () {\n+        if (!GitClient.authenticated) {\n+            throw Error('The authenticated GitClient has not yet been generated.');\n+        }\n+        return GitClient.authenticated;\n+    };\n+    /** Build the authenticated GitClient instance. */\n+    GitClient.authenticateWithToken = function (token) {\n+        if (GitClient.authenticated) {\n+            throw Error('Cannot generate new authenticated GitClient after one has already been generated.');\n+        }\n+        GitClient.authenticated = new GitClient(token);\n+    };\n+    /** Set the verbose logging state of the GitClient instance. */\n+    GitClient.prototype.setVerboseLoggingState = function (verbose) {\n+        this.verboseLogging = verbose;\n+        return this;\n+    };\n     /** Executes the given git command. Throws if the command fails. */\n     GitClient.prototype.run = function (args, options) {\n         var result = this.runGraceful(args, options);\n@@ -639,7 +653,7 @@ var GitClient = /** @class */ (function () {\n         // To improve the debugging experience in case something fails, we print all executed Git\n         // commands to better understand the git actions occuring. Depending on the command being\n         // executed, this debugging information should be logged at different logging levels.\n-        var printFn = (!GitClient.LOG_COMMANDS || options.stdio === 'ignore') ? debug : info;\n+        var printFn = (!this.verboseLogging || options.stdio === 'ignore') ? debug : info;\n         // Note that we do not want to print the token if it is contained in the command. It's common\n         // to share errors with others if the tool failed, and we do not want to leak tokens.\n         printFn('Executing: git', this.omitGithubTokenFromMessage(args.join(' ')));\n@@ -655,6 +669,10 @@ var GitClient = /** @class */ (function () {\n         }\n         return result;\n     };\n+    /** Git URL that resolves to the configured repository. */\n+    GitClient.prototype.getRepoGitUrl = function () {\n+        return getRepositoryGitUrl(this.remoteConfig, this.githubToken);\n+    };\n     /** Whether the given branch contains the specified SHA. */\n     GitClient.prototype.hasCommit = function (branchName, sha) {\n         return this.run(['branch', branchName, '--contains', sha]).stdout !== '';\n@@ -760,11 +778,40 @@ var GitClient = /** @class */ (function () {\n             return scopes.split(',').map(function (scope) { return scope.trim(); });\n         });\n     };\n-    /** Whether verbose logging of Git actions should be used. */\n-    GitClient.LOG_COMMANDS = true;\n     return GitClient;\n }());\n \n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/** Sets up the `github-token` command option for the given Yargs instance. */\n+function addGithubTokenOption(yargs) {\n+    return yargs\n+        // 'github-token' is casted to 'githubToken' to properly set up typings to reflect the key in\n+        // the Argv object being camelCase rather than kebob case due to the `camel-case-expansion`\n+        // config: https://github.com/yargs/yargs-parser#camel-case-expansion\n+        .option('github-token', {\n+        type: 'string',\n+        description: 'Github token. If not set, token is retrieved from the environment variables.',\n+        coerce: function (token) {\n+            var githubToken = token || process.env.GITHUB_TOKEN || process.env.TOKEN;\n+            if (!githubToken) {\n+                error(red('No Github token set. Please set the `GITHUB_TOKEN` environment variable.'));\n+                error(red('Alternatively, pass the `--github-token` command line flag.'));\n+                error(yellow(\"You can generate a token here: \" + GITHUB_TOKEN_GENERATE_URL));\n+                process.exit(1);\n+            }\n+            GitClient.authenticateWithToken(githubToken);\n+            return githubToken;\n+        },\n+    })\n+        .default('github-token', '', '<LOCAL TOKEN>');\n+}\n+\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n@@ -1091,9 +1138,10 @@ function getLtsNpmDistTagOfMajor(major) {\n \n /** The BaseModule to extend modules for caretaker checks from. */\n class BaseModule {\n-    constructor(git, config) {\n-        this.git = git;\n+    constructor(config) {\n         this.config = config;\n+        /** The singleton instance of the GitClient. */\n+        this.git = GitClient.getAuthenticatedInstance();\n         /** The data for the module. */\n         this.data = this.retrieveData();\n     }\n@@ -1332,7 +1380,7 @@ class GithubQueriesModule extends BaseModule {\n                 return;\n             }\n             /** The results of the generated github query. */\n-            const queryResult = yield this.git.github.graphql.query(this.buildGraphqlQuery(queries));\n+            const queryResult = yield this.git.github.graphql(this.buildGraphqlQuery(queries));\n             const results = Object.values(queryResult);\n             const { owner, name: repo } = this.git.remoteConfig;\n             return results.map((result, i) => {\n@@ -1348,20 +1396,20 @@ class GithubQueriesModule extends BaseModule {\n     /** Build a Graphql query statement for the provided queries. */\n     buildGraphqlQuery(queries) {\n         /** The query object for graphql. */\n-        const graphQlQuery = {};\n+        const graphqlQuery = {};\n         const { owner, name: repo } = this.git.remoteConfig;\n         /** The Github search filter for the configured repository. */\n         const repoFilter = `repo:${owner}/${repo}`;\n         queries.forEach(({ name, query }) => {\n-            /** The name of the query, with spaces removed to match GraphQL requirements. */\n+            /** The name of the query, with spaces removed to match Graphql requirements. */\n             const queryKey = typedGraphqlify.alias(name.replace(/ /g, ''), 'search');\n-            graphQlQuery[queryKey] = typedGraphqlify.params({\n+            graphqlQuery[queryKey] = typedGraphqlify.params({\n                 type: 'ISSUE',\n                 first: MAX_RETURNED_ISSUES,\n                 query: `\"${repoFilter} ${query.replace(/\"/g, '\\\\\"')}\"`,\n             }, Object.assign({}, GithubQueryResultFragment));\n         });\n-        return graphQlQuery;\n+        return graphqlQuery;\n     }\n     printToTerminal() {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n@@ -1470,16 +1518,14 @@ const moduleList = [\n     G3Module,\n ];\n /** Check the status of services which Angular caretakers need to monitor. */\n-function checkServiceStatuses(githubToken) {\n+function checkServiceStatuses() {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n+        // Set the verbose logging state of the GitClient.\n+        GitClient.getAuthenticatedInstance().setVerboseLoggingState(false);\n         /** The configuration for the caretaker commands. */\n         const config = getCaretakerConfig();\n-        /** The GitClient for interacting with git and Github. */\n-        const git = new GitClient(githubToken, config);\n-        // Prevent logging of the git commands being executed during the check.\n-        GitClient.LOG_COMMANDS = false;\n         /** List of instances of Caretaker Check modules */\n-        const caretakerCheckModules = moduleList.map(module => new module(git, config));\n+        const caretakerCheckModules = moduleList.map(module => new module(config));\n         // Module's `data` is casted as Promise<unknown> because the data types of the `module`'s `data`\n         // promises do not match typings, however our usage here is only to determine when the promise\n         // resolves.\n@@ -1502,9 +1548,9 @@ function builder(yargs) {\n     return addGithubTokenOption(yargs);\n }\n /** Handles the command. */\n-function handler({ githubToken }) {\n+function handler() {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n-        yield checkServiceStatuses(githubToken);\n+        yield checkServiceStatuses();\n     });\n }\n /** yargs command module for checking status information for the repository  */\n@@ -2836,8 +2882,8 @@ function getTargetBranchesForPr(prNumber) {\n         const config = getConfig();\n         /** Repo owner and name for the github repository. */\n         const { owner, name: repo } = config.github;\n-        /** The git client to get a Github API service instance. */\n-        const git = new GitClient(undefined, config);\n+        /** The singleton instance of the GitClient. */\n+        const git = GitClient.getInstance();\n         /** The validated merge config. */\n         const { config: mergeConfig, errors } = yield loadAndValidateConfig(config, git.github);\n         if (errors !== undefined) {\n@@ -2931,7 +2977,7 @@ function getPr(prSchema, prNumber, git) {\n                             pullRequest: typedGraphqlify.params({ number: '$number' }, prSchema),\n                         })\n                     });\n-                    return [4 /*yield*/, git.github.graphql.query(PR_QUERY, { number: prNumber, owner: owner, name: name })];\n+                    return [4 /*yield*/, git.github.graphql(PR_QUERY, { number: prNumber, owner: owner, name: name })];\n                 case 1:\n                     result = (_b.sent());\n                     return [2 /*return*/, result.repository.pullRequest];\n@@ -2978,7 +3024,7 @@ function getPendingPrs(prSchema, git) {\n                         owner: owner,\n                         name: name,\n                     };\n-                    return [4 /*yield*/, git.github.graphql.query(PRS_QUERY, params_1)];\n+                    return [4 /*yield*/, git.github.graphql(PRS_QUERY, params_1)];\n                 case 2:\n                     results = _b.sent();\n                     prs.push.apply(prs, tslib.__spreadArray([], tslib.__read(results.repository.pullRequests.nodes)));\n@@ -2998,7 +3044,7 @@ function getPendingPrs(prSchema, git) {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-/* GraphQL schema for the response body for a pending PR. */\n+/* Graphql schema for the response body for a pending PR. */\n const PR_SCHEMA = {\n     state: typedGraphqlify.types.string,\n     maintainerCanModify: typedGraphqlify.types.boolean,\n@@ -3037,8 +3083,8 @@ class MaintainerModifyAccessError extends Error {\n  */\n function checkOutPullRequestLocally(prNumber, githubToken, opts = {}) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n-        /** Authenticated Git client for git and Github interactions. */\n-        const git = new GitClient(githubToken);\n+        /** The singleton instance of the GitClient. */\n+        const git = GitClient.getAuthenticatedInstance();\n         // In order to preserve local changes, checkouts cannot occur if local changes are present in the\n         // git environment. Checked before retrieving the PR to fail fast.\n         if (git.hasLocalChanges()) {\n@@ -3132,7 +3178,7 @@ const CheckoutCommandModule = {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-/* GraphQL schema for the response body for each pending PR. */\n+/* Graphql schema for the response body for each pending PR. */\n const PR_SCHEMA$1 = {\n     headRef: {\n         name: typedGraphqlify.types.string,\n@@ -3160,9 +3206,10 @@ function processPr(pr) {\n /** Name of a temporary local branch that is used for checking conflicts. **/\n const tempWorkingBranch = '__NgDevRepoBaseAfterChange__';\n /** Checks if the provided PR will cause new conflicts in other pending PRs. */\n-function discoverNewConflictsForPr(newPrNumber, updatedAfter, config = getConfig()) {\n+function discoverNewConflictsForPr(newPrNumber, updatedAfter) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const git = new GitClient();\n+        /** The singleton instance of the GitClient. */\n+        const git = GitClient.getAuthenticatedInstance();\n         // If there are any local changes in the current repository state, the\n         // check cannot run as it needs to move between branches.\n         if (git.hasLocalChanges()) {\n@@ -3486,7 +3533,7 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n         });\n     });\n }\n-/* GraphQL schema for the response body the requested pull request. */\n+/* Graphql schema for the response body the requested pull request. */\n var PR_SCHEMA$2 = {\n     url: typedGraphqlify.types.string,\n     number: typedGraphqlify.types.number,\n@@ -3723,7 +3770,7 @@ var MergeStrategy = /** @class */ (function () {\n         });\n         // Fetch all target branches with a single command. We don't want to fetch them\n         // individually as that could cause an unnecessary slow-down.\n-        this.git.run(tslib.__spreadArray(tslib.__spreadArray(['fetch', '-q', '-f', this.git.repoGitUrl], tslib.__read(fetchRefspecs)), tslib.__read(extraRefspecs)));\n+        this.git.run(tslib.__spreadArray(tslib.__spreadArray(['fetch', '-q', '-f', this.git.getRepoGitUrl()], tslib.__read(fetchRefspecs)), tslib.__read(extraRefspecs)));\n     };\n     /** Pushes the given target branches upstream. */\n     MergeStrategy.prototype.pushTargetBranchesUpstream = function (names) {\n@@ -3734,7 +3781,7 @@ var MergeStrategy = /** @class */ (function () {\n         });\n         // Push all target branches with a single command if we don't run in dry-run mode.\n         // We don't want to push them individually as that could cause an unnecessary slow-down.\n-        this.git.run(tslib.__spreadArray(['push', this.git.repoGitUrl], tslib.__read(pushRefspecs)));\n+        this.git.run(tslib.__spreadArray(['push', this.git.getRepoGitUrl()], tslib.__read(pushRefspecs)));\n     };\n     return MergeStrategy;\n }());\n@@ -4206,7 +4253,7 @@ var PullRequestMergeTask = /** @class */ (function () {\n  * @param projectRoot Path to the local Git project that is used for merging.\n  * @param config Configuration for merging pull requests.\n  */\n-function mergePullRequest(prNumber, githubToken, flags) {\n+function mergePullRequest(prNumber, flags) {\n     return tslib.__awaiter(this, void 0, void 0, function () {\n         /** Performs the merge and returns whether it was successful or not. */\n         function performMerge(ignoreFatalErrors) {\n@@ -4322,7 +4369,7 @@ function mergePullRequest(prNumber, githubToken, flags) {\n                     // Set the environment variable to skip all git commit hooks triggered by husky. We are unable to\n                     // rely on `--no-verify` as some hooks still run, notably the `prepare-commit-msg` hook.\n                     process.env['HUSKY'] = '0';\n-                    return [4 /*yield*/, createPullRequestMergeTask(githubToken, flags)];\n+                    return [4 /*yield*/, createPullRequestMergeTask(flags)];\n                 case 1:\n                     api = _a.sent();\n                     return [4 /*yield*/, performMerge(false)];\n@@ -4343,15 +4390,14 @@ function mergePullRequest(prNumber, githubToken, flags) {\n  * and optional explicit configuration. An explicit configuration can be specified\n  * when the merge script is used outside of a `ng-dev` configured repository.\n  */\n-function createPullRequestMergeTask(githubToken, flags) {\n+function createPullRequestMergeTask(flags) {\n     return tslib.__awaiter(this, void 0, void 0, function () {\n-        var projectRoot, devInfraConfig, git, _a, config, errors;\n+        var devInfraConfig, git, _a, config, errors;\n         return tslib.__generator(this, function (_b) {\n             switch (_b.label) {\n                 case 0:\n-                    projectRoot = getRepoBaseDir();\n                     devInfraConfig = getConfig();\n-                    git = new GitClient(githubToken, devInfraConfig, projectRoot);\n+                    git = GitClient.getAuthenticatedInstance();\n                     return [4 /*yield*/, loadAndValidateConfig(devInfraConfig, git.github)];\n                 case 1:\n                     _a = _b.sent(), config = _a.config, errors = _a.errors;\n@@ -4396,11 +4442,11 @@ function builder$6(yargs) {\n }\n /** Handles the command. */\n function handler$6(_a) {\n-    var pr = _a.pr, githubToken = _a.githubToken, branchPrompt = _a.branchPrompt;\n+    var pr = _a.pr, branchPrompt = _a.branchPrompt;\n     return tslib.__awaiter(this, void 0, void 0, function () {\n         return tslib.__generator(this, function (_b) {\n             switch (_b.label) {\n-                case 0: return [4 /*yield*/, mergePullRequest(pr, githubToken, { branchPrompt: branchPrompt })];\n+                case 0: return [4 /*yield*/, mergePullRequest(pr, { branchPrompt: branchPrompt })];\n                 case 1:\n                     _b.sent();\n                     return [2 /*return*/];\n@@ -4423,7 +4469,7 @@ var MergeCommandModule = {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-/* GraphQL schema for the response body for each pending PR. */\n+/* Graphql schema for the response body for each pending PR. */\n const PR_SCHEMA$3 = {\n     state: typedGraphqlify.types.string,\n     maintainerCanModify: typedGraphqlify.types.boolean,\n@@ -4450,7 +4496,8 @@ const PR_SCHEMA$3 = {\n  */\n function rebasePr(prNumber, githubToken, config = getConfig()) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const git = new GitClient(githubToken);\n+        /** The singleton instance of the GitClient. */\n+        const git = GitClient.getAuthenticatedInstance();\n         // TODO: Rely on a common assertNoLocalChanges function.\n         if (git.hasLocalChanges()) {\n             error('Cannot perform rebase of PR with local changes.');\n@@ -5747,7 +5794,7 @@ class ReleaseAction {\n                 return this._cachedForkRepo;\n             }\n             const { owner, name } = this.git.remoteConfig;\n-            const result = yield this.git.github.graphql.query(findOwnedForksOfRepoQuery, { owner, name });\n+            const result = yield this.git.github.graphql(findOwnedForksOfRepoQuery, { owner, name });\n             const forks = result.repository.forks.nodes;\n             if (forks.length === 0) {\n                 error(red('     Unable to find fork for currently authenticated user.'));\n@@ -5800,7 +5847,7 @@ class ReleaseAction {\n     pushHeadToRemoteBranch(branchName) {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n             // Push the local `HEAD` to the remote branch in the configured project.\n-            this.git.run(['push', this.git.repoGitUrl, `HEAD:refs/heads/${branchName}`]);\n+            this.git.run(['push', this.git.getRepoGitUrl(), `HEAD:refs/heads/${branchName}`]);\n         });\n     }\n     /**\n@@ -5915,7 +5962,7 @@ class ReleaseAction {\n     /** Checks out an upstream branch with a detached head. */\n     checkoutUpstreamBranch(branchName) {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n-            this.git.run(['fetch', '-q', this.git.repoGitUrl, branchName]);\n+            this.git.run(['fetch', '-q', this.git.getRepoGitUrl(), branchName]);\n             this.git.run(['checkout', 'FETCH_HEAD', '--detach']);\n         });\n     }\n@@ -6551,8 +6598,8 @@ class ReleaseTool {\n         this._github = _github;\n         this._githubToken = _githubToken;\n         this._projectRoot = _projectRoot;\n-        /** Client for interacting with the Github API and the local Git command. */\n-        this._git = new GitClient(this._githubToken, { github: this._github }, this._projectRoot);\n+        /** The singleton instance of the GitClient. */\n+        this._git = GitClient.getAuthenticatedInstance();\n         /** The previous git commit to return back to after the release tool runs. */\n         this.previousGitBranchOrRevision = this._git.getCurrentBranchOrRevision();\n     }"
        },
        {
            "sha": "8b2a15cf9b2fb9b6c422614aba261cb2717330ac",
            "filename": "dev-infra/pr/check-target-branches/check-target-branches.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fcheck-target-branches%2Fcheck-target-branches.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fcheck-target-branches%2Fcheck-target-branches.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcheck-target-branches%2Fcheck-target-branches.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -17,8 +17,8 @@ export async function getTargetBranchesForPr(prNumber: number) {\n   const config = getConfig();\n   /** Repo owner and name for the github repository. */\n   const {owner, name: repo} = config.github;\n-  /** The git client to get a Github API service instance. */\n-  const git = new GitClient(undefined, config);\n+  /** The singleton instance of the GitClient. */\n+  const git = GitClient.getInstance();\n   /** The validated merge config. */\n   const {config: mergeConfig, errors} = await loadAndValidateConfig(config, git.github);\n   if (errors !== undefined) {"
        },
        {
            "sha": "c6464b7a9ff77f182b13db7476b537dd857de2c3",
            "filename": "dev-infra/pr/common/checkout-pr.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 14,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -6,31 +6,31 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {types as graphQLTypes} from 'typed-graphqlify';\n+import {types as graphqlTypes} from 'typed-graphqlify';\n \n import {info} from '../../utils/console';\n import {addTokenToGitHttpsUrl} from '../../utils/git/github-urls';\n import {GitClient} from '../../utils/git/index';\n import {getPr} from '../../utils/github';\n \n-/* GraphQL schema for the response body for a pending PR. */\n+/* Graphql schema for the response body for a pending PR. */\n const PR_SCHEMA = {\n-  state: graphQLTypes.string,\n-  maintainerCanModify: graphQLTypes.boolean,\n-  viewerDidAuthor: graphQLTypes.boolean,\n-  headRefOid: graphQLTypes.string,\n+  state: graphqlTypes.string,\n+  maintainerCanModify: graphqlTypes.boolean,\n+  viewerDidAuthor: graphqlTypes.boolean,\n+  headRefOid: graphqlTypes.string,\n   headRef: {\n-    name: graphQLTypes.string,\n+    name: graphqlTypes.string,\n     repository: {\n-      url: graphQLTypes.string,\n-      nameWithOwner: graphQLTypes.string,\n+      url: graphqlTypes.string,\n+      nameWithOwner: graphqlTypes.string,\n     },\n   },\n   baseRef: {\n-    name: graphQLTypes.string,\n+    name: graphqlTypes.string,\n     repository: {\n-      url: graphQLTypes.string,\n-      nameWithOwner: graphQLTypes.string,\n+      url: graphqlTypes.string,\n+      nameWithOwner: graphqlTypes.string,\n     },\n   },\n };\n@@ -62,8 +62,8 @@ export interface PullRequestCheckoutOptions {\n  */\n export async function checkOutPullRequestLocally(\n     prNumber: number, githubToken: string, opts: PullRequestCheckoutOptions = {}) {\n-  /** Authenticated Git client for git and Github interactions. */\n-  const git = new GitClient(githubToken);\n+  /** The singleton instance of the GitClient. */\n+  const git = GitClient.getAuthenticatedInstance();\n \n   // In order to preserve local changes, checkouts cannot occur if local changes are present in the\n   // git environment. Checked before retrieving the PR to fail fast."
        },
        {
            "sha": "be2a2cc2fd4449034cdd634dc0c44678af331b17",
            "filename": "dev-infra/pr/discover-new-conflicts/index.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 17,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -7,38 +7,37 @@\n  */\n \n import {Bar} from 'cli-progress';\n-import {types as graphQLTypes} from 'typed-graphqlify';\n+import {types as graphqlTypes} from 'typed-graphqlify';\n \n-import {getConfig, NgDevConfig} from '../../utils/config';\n import {error, info} from '../../utils/console';\n import {GitClient} from '../../utils/git/index';\n import {getPendingPrs} from '../../utils/github';\n import {exec} from '../../utils/shelljs';\n \n \n-/* GraphQL schema for the response body for each pending PR. */\n+/* Graphql schema for the response body for each pending PR. */\n const PR_SCHEMA = {\n   headRef: {\n-    name: graphQLTypes.string,\n+    name: graphqlTypes.string,\n     repository: {\n-      url: graphQLTypes.string,\n-      nameWithOwner: graphQLTypes.string,\n+      url: graphqlTypes.string,\n+      nameWithOwner: graphqlTypes.string,\n     },\n   },\n   baseRef: {\n-    name: graphQLTypes.string,\n+    name: graphqlTypes.string,\n     repository: {\n-      url: graphQLTypes.string,\n-      nameWithOwner: graphQLTypes.string,\n+      url: graphqlTypes.string,\n+      nameWithOwner: graphqlTypes.string,\n     },\n   },\n-  updatedAt: graphQLTypes.string,\n-  number: graphQLTypes.number,\n-  mergeable: graphQLTypes.string,\n-  title: graphQLTypes.string,\n+  updatedAt: graphqlTypes.string,\n+  number: graphqlTypes.number,\n+  mergeable: graphqlTypes.string,\n+  title: graphqlTypes.string,\n };\n \n-/* Pull Request response from Github GraphQL query */\n+/* Pull Request response from Github Graphql query */\n type RawPullRequest = typeof PR_SCHEMA;\n \n /** Convert raw Pull Request response from Github to usable Pull Request object. */\n@@ -53,9 +52,9 @@ type PullRequest = ReturnType<typeof processPr>;\n const tempWorkingBranch = '__NgDevRepoBaseAfterChange__';\n \n /** Checks if the provided PR will cause new conflicts in other pending PRs. */\n-export async function discoverNewConflictsForPr(\n-    newPrNumber: number, updatedAfter: number, config: Pick<NgDevConfig, 'github'> = getConfig()) {\n-  const git = new GitClient();\n+export async function discoverNewConflictsForPr(newPrNumber: number, updatedAfter: number) {\n+  /** The singleton instance of the GitClient. */\n+  const git = GitClient.getAuthenticatedInstance();\n   // If there are any local changes in the current repository state, the\n   // check cannot run as it needs to move between branches.\n   if (git.hasLocalChanges()) {"
        },
        {
            "sha": "e752422d74f0736777a9cad64387c936c718beda",
            "filename": "dev-infra/pr/merge/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fcli.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -37,8 +37,8 @@ function builder(yargs: Argv) {\n }\n \n /** Handles the command. */\n-async function handler({pr, githubToken, branchPrompt}: Arguments<MergeCommandOptions>) {\n-  await mergePullRequest(pr, githubToken, {branchPrompt});\n+async function handler({pr, branchPrompt}: Arguments<MergeCommandOptions>) {\n+  await mergePullRequest(pr, {branchPrompt});\n }\n \n /** yargs command module describing the command. */"
        },
        {
            "sha": "d67542205c7be6dd9201e52c421c6ca8a71e2890",
            "filename": "dev-infra/pr/merge/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Findex.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -29,13 +29,12 @@ import {MergeResult, MergeStatus, PullRequestMergeTask, PullRequestMergeTaskFlag\n  * @param projectRoot Path to the local Git project that is used for merging.\n  * @param config Configuration for merging pull requests.\n  */\n-export async function mergePullRequest(\n-    prNumber: number, githubToken: string, flags: PullRequestMergeTaskFlags) {\n+export async function mergePullRequest(prNumber: number, flags: PullRequestMergeTaskFlags) {\n   // Set the environment variable to skip all git commit hooks triggered by husky. We are unable to\n   // rely on `--no-verify` as some hooks still run, notably the `prepare-commit-msg` hook.\n   process.env['HUSKY'] = '0';\n \n-  const api = await createPullRequestMergeTask(githubToken, flags);\n+  const api = await createPullRequestMergeTask(flags);\n \n   // Perform the merge. Force mode can be activated through a command line flag.\n   // Alternatively, if the merge fails with non-fatal failures, the script\n@@ -127,10 +126,10 @@ export async function mergePullRequest(\n  * and optional explicit configuration. An explicit configuration can be specified\n  * when the merge script is used outside of a `ng-dev` configured repository.\n  */\n-async function createPullRequestMergeTask(githubToken: string, flags: PullRequestMergeTaskFlags) {\n-  const projectRoot = getRepoBaseDir();\n+async function createPullRequestMergeTask(flags: PullRequestMergeTaskFlags) {\n   const devInfraConfig = getConfig();\n-  const git = new GitClient(githubToken, devInfraConfig, projectRoot);\n+  /** The singleton instance of the GitClient. */\n+  const git = GitClient.getAuthenticatedInstance();\n   const {config, errors} = await loadAndValidateConfig(devInfraConfig, git.github);\n \n   if (errors) {"
        },
        {
            "sha": "ea38f4c4d0c87e06418df9b2d72645739a3936c4",
            "filename": "dev-infra/pr/merge/pull-request.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {params, types as graphQLTypes} from 'typed-graphqlify';\n+import {params, types as graphqlTypes} from 'typed-graphqlify';\n import {Commit, parseCommitMessage} from '../../commit-message/parse';\n import {red, warn} from '../../utils/console';\n \n@@ -133,28 +133,28 @@ export async function loadAndValidatePullRequest(\n   };\n }\n \n-/* GraphQL schema for the response body the requested pull request. */\n+/* Graphql schema for the response body the requested pull request. */\n const PR_SCHEMA = {\n-  url: graphQLTypes.string,\n-  number: graphQLTypes.number,\n+  url: graphqlTypes.string,\n+  number: graphqlTypes.number,\n   // Only the last 100 commits from a pull request are obtained as we likely will never see a pull\n   // requests with more than 100 commits.\n   commits: params({last: 100}, {\n-    totalCount: graphQLTypes.number,\n+    totalCount: graphqlTypes.number,\n     nodes: [{\n       commit: {\n         status: {\n-          state: graphQLTypes.oneOf(['FAILURE', 'PENDING', 'SUCCESS'] as const),\n+          state: graphqlTypes.oneOf(['FAILURE', 'PENDING', 'SUCCESS'] as const),\n         },\n-        message: graphQLTypes.string,\n+        message: graphqlTypes.string,\n       },\n     }],\n   }),\n-  baseRefName: graphQLTypes.string,\n-  title: graphQLTypes.string,\n+  baseRefName: graphqlTypes.string,\n+  title: graphqlTypes.string,\n   labels: params({first: 100}, {\n     nodes: [{\n-      name: graphQLTypes.string,\n+      name: graphqlTypes.string,\n     }]\n   }),\n };\n@@ -163,7 +163,7 @@ const PR_SCHEMA = {\n \n /** Fetches a pull request from Github. Returns null if an error occurred. */\n async function fetchPullRequestFromGithub(\n-    git: GitClient, prNumber: number): Promise<typeof PR_SCHEMA|null> {\n+    git: GitClient<true>, prNumber: number): Promise<typeof PR_SCHEMA|null> {\n   try {\n     const x = await getPr(PR_SCHEMA, prNumber, git);\n     return x;"
        },
        {
            "sha": "76b979873169909be92d8634073e4a25fa94104d",
            "filename": "dev-infra/pr/merge/strategies/api-merge.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fapi-merge.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fapi-merge.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fapi-merge.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -37,7 +37,7 @@ const COMMIT_HEADER_SEPARATOR = '\\n\\n';\n  * is properly set, but a notable downside is that PRs cannot use fixup or squash commits.\n  */\n export class GithubApiMergeStrategy extends MergeStrategy {\n-  constructor(git: GitClient, private _config: GithubApiMergeStrategyConfig) {\n+  constructor(git: GitClient<true>, private _config: GithubApiMergeStrategyConfig) {\n     super(git);\n   }\n "
        },
        {
            "sha": "c5cd98c523b3d8f0924f93f253cc785b74feb876",
            "filename": "dev-infra/pr/merge/strategies/strategy.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fstrategy.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fstrategy.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fstrategy.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -22,7 +22,7 @@ export const TEMP_PR_HEAD_BRANCH = 'merge_pr_head';\n  * merges it into the determined target branches.\n  */\n export abstract class MergeStrategy {\n-  constructor(protected git: GitClient) {}\n+  constructor(protected git: GitClient<true>) {}\n \n   /**\n    * Prepares a merge of the given pull request. The strategy by default will\n@@ -124,7 +124,8 @@ export abstract class MergeStrategy {\n     });\n     // Fetch all target branches with a single command. We don't want to fetch them\n     // individually as that could cause an unnecessary slow-down.\n-    this.git.run(['fetch', '-q', '-f', this.git.repoGitUrl, ...fetchRefspecs, ...extraRefspecs]);\n+    this.git.run(\n+        ['fetch', '-q', '-f', this.git.getRepoGitUrl(), ...fetchRefspecs, ...extraRefspecs]);\n   }\n \n   /** Pushes the given target branches upstream. */\n@@ -135,6 +136,6 @@ export abstract class MergeStrategy {\n     });\n     // Push all target branches with a single command if we don't run in dry-run mode.\n     // We don't want to push them individually as that could cause an unnecessary slow-down.\n-    this.git.run(['push', this.git.repoGitUrl, ...pushRefspecs]);\n+    this.git.run(['push', this.git.getRepoGitUrl(), ...pushRefspecs]);\n   }\n }"
        },
        {
            "sha": "9e8724b57f116885a4e9c52d4f68241792472adc",
            "filename": "dev-infra/pr/merge/task.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Ftask.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Fmerge%2Ftask.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ftask.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -51,7 +51,7 @@ export class PullRequestMergeTask {\n   private flags: PullRequestMergeTaskFlags;\n \n   constructor(\n-      public config: MergeConfigWithRemote, public git: GitClient,\n+      public config: MergeConfigWithRemote, public git: GitClient<true>,\n       flags: Partial<PullRequestMergeTaskFlags>) {\n     // Update flags property with the provided flags values as patches to the default flag values.\n     this.flags = {...defaultPullRequestMergeTaskFlags, ...flags};"
        },
        {
            "sha": "a892a7e452aa0ae5d8cea45130f5eca9d3f4695f",
            "filename": "dev-infra/pr/rebase/index.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 13,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Frebase%2Findex.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {types as graphQLTypes} from 'typed-graphqlify';\n+import {types as graphqlTypes} from 'typed-graphqlify';\n \n import {Commit} from '../../commit-message/parse';\n import {getCommitsInRange} from '../../commit-message/utils';\n@@ -16,24 +16,24 @@ import {addTokenToGitHttpsUrl} from '../../utils/git/github-urls';\n import {GitClient} from '../../utils/git/index';\n import {getPr} from '../../utils/github';\n \n-/* GraphQL schema for the response body for each pending PR. */\n+/* Graphql schema for the response body for each pending PR. */\n const PR_SCHEMA = {\n-  state: graphQLTypes.string,\n-  maintainerCanModify: graphQLTypes.boolean,\n-  viewerDidAuthor: graphQLTypes.boolean,\n-  headRefOid: graphQLTypes.string,\n+  state: graphqlTypes.string,\n+  maintainerCanModify: graphqlTypes.boolean,\n+  viewerDidAuthor: graphqlTypes.boolean,\n+  headRefOid: graphqlTypes.string,\n   headRef: {\n-    name: graphQLTypes.string,\n+    name: graphqlTypes.string,\n     repository: {\n-      url: graphQLTypes.string,\n-      nameWithOwner: graphQLTypes.string,\n+      url: graphqlTypes.string,\n+      nameWithOwner: graphqlTypes.string,\n     },\n   },\n   baseRef: {\n-    name: graphQLTypes.string,\n+    name: graphqlTypes.string,\n     repository: {\n-      url: graphQLTypes.string,\n-      nameWithOwner: graphQLTypes.string,\n+      url: graphqlTypes.string,\n+      nameWithOwner: graphqlTypes.string,\n     },\n   },\n };\n@@ -44,7 +44,8 @@ const PR_SCHEMA = {\n  */\n export async function rebasePr(\n     prNumber: number, githubToken: string, config: Pick<NgDevConfig, 'github'> = getConfig()) {\n-  const git = new GitClient(githubToken);\n+  /** The singleton instance of the GitClient. */\n+  const git = GitClient.getAuthenticatedInstance();\n   // TODO: Rely on a common assertNoLocalChanges function.\n   if (git.hasLocalChanges()) {\n     error('Cannot perform rebase of PR with local changes.');"
        },
        {
            "sha": "556c605fb56cb5a62f66885e962a1c015a8904dc",
            "filename": "dev-infra/release/publish/actions.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -49,7 +49,7 @@ export interface ReleaseActionConstructor<T extends ReleaseAction = ReleaseActio\n   /** Whether the release action is currently active. */\n   isActive(active: ActiveReleaseTrains): Promise<boolean>;\n   /** Constructs a release action. */\n-  new(...args: [ActiveReleaseTrains, GitClient, ReleaseConfig, string]): T;\n+  new(...args: [ActiveReleaseTrains, GitClient<true>, ReleaseConfig, string]): T;\n }\n \n /**\n@@ -76,7 +76,7 @@ export abstract class ReleaseAction {\n   private _cachedForkRepo: GithubRepo|null = null;\n \n   constructor(\n-      protected active: ActiveReleaseTrains, protected git: GitClient,\n+      protected active: ActiveReleaseTrains, protected git: GitClient<true>,\n       protected config: ReleaseConfig, protected projectDir: string) {}\n \n   /** Updates the version in the project top-level `package.json` file. */\n@@ -182,7 +182,7 @@ export abstract class ReleaseAction {\n     }\n \n     const {owner, name} = this.git.remoteConfig;\n-    const result = await this.git.github.graphql.query(findOwnedForksOfRepoQuery, {owner, name});\n+    const result = await this.git.github.graphql(findOwnedForksOfRepoQuery, {owner, name});\n     const forks = result.repository.forks.nodes;\n \n     if (forks.length === 0) {\n@@ -232,7 +232,7 @@ export abstract class ReleaseAction {\n   /** Pushes the current Git `HEAD` to the given remote branch in the configured project. */\n   protected async pushHeadToRemoteBranch(branchName: string) {\n     // Push the local `HEAD` to the remote branch in the configured project.\n-    this.git.run(['push', this.git.repoGitUrl, `HEAD:refs/heads/${branchName}`]);\n+    this.git.run(['push', this.git.getRepoGitUrl(), `HEAD:refs/heads/${branchName}`]);\n   }\n \n   /**\n@@ -360,7 +360,7 @@ export abstract class ReleaseAction {\n \n   /** Checks out an upstream branch with a detached head. */\n   protected async checkoutUpstreamBranch(branchName: string) {\n-    this.git.run(['fetch', '-q', this.git.repoGitUrl, branchName]);\n+    this.git.run(['fetch', '-q', this.git.getRepoGitUrl(), branchName]);\n     this.git.run(['checkout', 'FETCH_HEAD', '--detach']);\n   }\n "
        },
        {
            "sha": "63b46b75aec417c6e3fa52dfb993ba340b46ae25",
            "filename": "dev-infra/release/publish/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Findex.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -28,8 +28,8 @@ export enum CompletionState {\n }\n \n export class ReleaseTool {\n-  /** Client for interacting with the Github API and the local Git command. */\n-  private _git = new GitClient(this._githubToken, {github: this._github}, this._projectRoot);\n+  /** The singleton instance of the GitClient. */\n+  private _git = GitClient.getAuthenticatedInstance();\n   /** The previous git commit to return back to after the release tool runs. */\n   private previousGitBranchOrRevision = this._git.getCurrentBranchOrRevision();\n "
        },
        {
            "sha": "8a01def36726b31b916f6a7dca6a8f6be45cb07f",
            "filename": "dev-infra/release/publish/pull-request-state.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Frelease%2Fpublish%2Fpull-request-state.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Frelease%2Fpublish%2Fpull-request-state.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Fpull-request-state.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -16,7 +16,8 @@ const THIRTY_SECONDS_IN_MS = 30000;\n export type PullRequestState = 'merged'|'closed'|'open';\n \n /** Gets whether a given pull request has been merged. */\n-export async function getPullRequestState(api: GitClient, id: number): Promise<PullRequestState> {\n+export async function getPullRequestState(\n+    api: GitClient<boolean>, id: number): Promise<PullRequestState> {\n   const {data} = await api.github.pulls.get({...api.remoteParams, pull_number: id});\n   if (data.merged) {\n     return 'merged';\n@@ -38,7 +39,7 @@ export async function getPullRequestState(api: GitClient, id: number): Promise<P\n  * the merge is not fast-forward, Github does not consider the PR as merged and instead\n  * shows the PR as closed. See for example: https://github.com/angular/angular/pull/37918.\n  */\n-async function isPullRequestClosedWithAssociatedCommit(api: GitClient, id: number) {\n+async function isPullRequestClosedWithAssociatedCommit(api: GitClient<boolean>, id: number) {\n   const request =\n       api.github.issues.listEvents.endpoint.merge({...api.remoteParams, issue_number: id});\n   const events: Octokit.IssuesListEventsResponse = await api.github.paginate(request);\n@@ -72,7 +73,7 @@ async function isPullRequestClosedWithAssociatedCommit(api: GitClient, id: numbe\n }\n \n /** Checks whether the specified commit is closing the given pull request. */\n-async function isCommitClosingPullRequest(api: GitClient, sha: string, id: number) {\n+async function isCommitClosingPullRequest(api: GitClient<boolean>, sha: string, id: number) {\n   const {data} = await api.github.repos.getCommit({...api.remoteParams, ref: sha});\n   // Matches the closing keyword supported in commit messages. See:\n   // https://docs.github.com/en/enterprise/2.16/user/github/managing-your-work-on-github/closing-issues-using-keywords."
        },
        {
            "sha": "15f6eb03df52737bf0a68677a8f9ec75d0965092",
            "filename": "dev-infra/release/publish/release-notes/release-notes.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Frelease%2Fpublish%2Frelease-notes%2Frelease-notes.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Frelease%2Fpublish%2Frelease-notes%2Frelease-notes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Frelease-notes%2Frelease-notes.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -38,7 +38,7 @@ export function getLocalChangelogFilePath(projectDir: string): string {\n /** Release note generation. */\n export class ReleaseNotes {\n   /** An instance of GitClient. */\n-  private git = new GitClient();\n+  private git = GitClient.getInstance();\n   /** The github configuration. */\n   private readonly github = getConfig().github;\n   /** The configuration for the release notes generation. */"
        },
        {
            "sha": "76b254dd57c3f9e27bed1a1027a5025dd5445361",
            "filename": "dev-infra/release/publish/test/test-utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -33,7 +33,7 @@ export const testTmpDir: string = process.env['TEST_TMPDIR']!;\n /** Interface describing a test release action. */\n export interface TestReleaseAction<T extends ReleaseAction = ReleaseAction> {\n   instance: T;\n-  gitClient: VirtualGitClient;\n+  gitClient: VirtualGitClient<boolean>;\n   repo: GithubTestingRepo;\n   fork: GithubTestingRepo;\n   testTmpDir: string;\n@@ -44,7 +44,7 @@ export interface TestReleaseAction<T extends ReleaseAction = ReleaseAction> {\n /** Gets necessary test mocks for running a release action. */\n export function getTestingMocksForReleaseAction() {\n   const githubConfig = {owner: 'angular', name: 'dev-infra-test'};\n-  const gitClient = new VirtualGitClient(undefined, {github: githubConfig}, testTmpDir);\n+  const gitClient = VirtualGitClient.getAuthenticatedInstance({github: githubConfig});\n   const releaseConfig: ReleaseConfig = {\n     npmPackages: [\n       '@angular/pkg1',"
        },
        {
            "sha": "d6fc7bcd4f99852603f705ea29384842a4d4a21b",
            "filename": "dev-infra/utils/git/github-urls.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Fgit%2Fgithub-urls.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Fgit%2Fgithub-urls.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub-urls.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -37,6 +37,6 @@ export function getRepositoryGitUrl(config: GithubConfig, githubToken?: string):\n }\n \n /** Gets a Github URL that refers to a list of recent commits within a specified branch. */\n-export function getListCommitsInBranchUrl({remoteParams}: GitClient, branchName: string) {\n+export function getListCommitsInBranchUrl({remoteParams}: GitClient<boolean>, branchName: string) {\n   return `https://github.com/${remoteParams.owner}/${remoteParams.repo}/commits/${branchName}`;\n }"
        },
        {
            "sha": "e695bafd0a4d8d620d825c8984fc4f49f2fa6298",
            "filename": "dev-infra/utils/git/github-yargs.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Fgit%2Fgithub-yargs.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Fgit%2Fgithub-yargs.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub-yargs.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -7,8 +7,11 @@\n  */\n \n import {Argv} from 'yargs';\n+\n import {error, red, yellow} from '../console';\n+\n import {GITHUB_TOKEN_GENERATE_URL} from './github-urls';\n+import {GitClient} from './index';\n \n export type ArgvWithGithubToken = Argv<{githubToken: string}>;\n \n@@ -29,6 +32,7 @@ export function addGithubTokenOption(yargs: Argv): ArgvWithGithubToken {\n             error(yellow(`You can generate a token here: ${GITHUB_TOKEN_GENERATE_URL}`));\n             process.exit(1);\n           }\n+          GitClient.authenticateWithToken(githubToken);\n           return githubToken;\n         },\n       })"
        },
        {
            "sha": "b6326d9245d5bf9e73ae83a38d1f80c43039c3da",
            "filename": "dev-infra/utils/git/github.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 33,
            "changes": 65,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Fgit%2Fgithub.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Fgit%2Fgithub.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -11,6 +11,12 @@ import * as Octokit from '@octokit/rest';\n import {RequestParameters} from '@octokit/types';\n import {query, types} from 'typed-graphqlify';\n \n+/**\n+ * An object representation of a Graphql Query to be used as a response type and\n+ * to generate a Graphql query string.\n+ */\n+export type GraphqlQueryObject = Parameters<typeof query>[1];\n+\n /** Interface describing a Github repository. */\n export interface GithubRepo {\n   /** Owner login of the repository. */\n@@ -26,20 +32,25 @@ export class GithubApiRequestError extends Error {\n   }\n }\n \n+/** Error for failed Github API requests. */\n+export class GithubGraphqlClientError extends Error {}\n+\n /**\n  * A Github client for interacting with the Github APIs.\n  *\n  * Additionally, provides convenience methods for actions which require multiple requests, or\n  * would provide value from memoized style responses.\n  **/\n export class GithubClient extends Octokit {\n-  /** The Github GraphQL (v4) API. */\n-  graphql: GithubGraphqlClient;\n-\n   /** The current user based on checking against the Github API. */\n   private _currentUser: string|null = null;\n+  /** The graphql instance with authentication set during construction. */\n+  private _graphql = graphql.defaults({headers: {authorization: `token ${this.token}`}});\n \n-  constructor(token?: string) {\n+  /**\n+   * @param token The github authentication token for Github Rest and Graphql API requests.\n+   */\n+  constructor(private token?: string) {\n     // Pass in authentication token to base Octokit class.\n     super({auth: token});\n \n@@ -49,8 +60,22 @@ export class GithubClient extends Octokit {\n       throw new GithubApiRequestError(error.status, error.message);\n     });\n \n-    // Create authenticated graphql client.\n-    this.graphql = new GithubGraphqlClient(token);\n+    // Note: The prototype must be set explictly as Github's Octokit class is a non-standard class\n+    // definition which adjusts the prototype chain.\n+    // See:\n+    //    https://github.com/Microsoft/TypeScript/wiki/FAQ#why-doesnt-extending-built-ins-like-error-array-and-map-work\n+    //    https://github.com/octokit/rest.js/blob/7b51cee4a22b6e52adcdca011f93efdffa5df998/lib/constructor.js\n+    Object.setPrototypeOf(this, GithubClient.prototype);\n+  }\n+\n+  /** Perform a query using Github's Graphql API. */\n+  async graphql<T extends GraphqlQueryObject>(queryObject: T, params: RequestParameters = {}) {\n+    if (this.token === undefined) {\n+      throw new GithubGraphqlClientError(\n+          'Cannot query via graphql without an authentication token set, use the authenticated ' +\n+          '`GitClient` by calling `GitClient.getAuthenticatedInstance()`.');\n+    }\n+    return (await this._graphql(query(queryObject), params)) as T;\n   }\n \n   /** Retrieve the login of the current user from Github. */\n@@ -59,37 +84,11 @@ export class GithubClient extends Octokit {\n     if (this._currentUser !== null) {\n       return this._currentUser;\n     }\n-    const result = await this.graphql.query({\n+    const result = await this.graphql({\n       viewer: {\n         login: types.string,\n       }\n     });\n     return this._currentUser = result.viewer.login;\n   }\n }\n-\n-/**\n- * An object representation of a GraphQL Query to be used as a response type and\n- * to generate a GraphQL query string.\n- */\n-export type GraphQLQueryObject = Parameters<typeof query>[1];\n-\n-/** A client for interacting with Github's GraphQL API. */\n-export class GithubGraphqlClient {\n-  /** The Github GraphQL (v4) API. */\n-  private graqhql = graphql;\n-\n-  constructor(token?: string) {\n-    // Set the default headers to include authorization with the provided token for all\n-    // graphQL calls.\n-    if (token) {\n-      this.graqhql = this.graqhql.defaults({headers: {authorization: `token ${token}`}});\n-    }\n-  }\n-\n-  /** Perform a query using Github's GraphQL API. */\n-  async query<T extends GraphQLQueryObject>(queryObject: T, params: RequestParameters = {}) {\n-    const queryString = query(queryObject);\n-    return (await this.graqhql(queryString, params)) as T;\n-  }\n-}"
        },
        {
            "sha": "b1a6e5bbdb908dc4f712d7caed424ecb119e17ef",
            "filename": "dev-infra/utils/git/index.ts",
            "status": "modified",
            "additions": 71,
            "deletions": 17,
            "changes": 88,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Fgit%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Fgit%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Findex.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -10,7 +10,7 @@ import * as Octokit from '@octokit/rest';\n import {spawnSync, SpawnSyncOptions, SpawnSyncReturns} from 'child_process';\n import {Options as SemVerOptions, parse, SemVer} from 'semver';\n \n-import {getConfig, getRepoBaseDir, NgDevConfig} from '../config';\n+import {getConfig, getRepoBaseDir} from '../config';\n import {debug, info, yellow} from '../console';\n import {DryRunError, isDryRun} from '../dry-run';\n import {GithubClient} from './github';\n@@ -26,7 +26,7 @@ export type OAuthScopeTestFunction = (scopes: string[], missing: string[]) => vo\n \n /** Error for failed Git commands. */\n export class GitCommandError extends Error {\n-  constructor(client: GitClient, public args: string[]) {\n+  constructor(client: GitClient<boolean>, public args: string[]) {\n     // Errors are not guaranteed to be caught. To ensure that we don't\n     // accidentally leak the Github token that might be used in a command,\n     // we sanitize the command that will be part of the error message.\n@@ -43,37 +43,86 @@ export class GitCommandError extends Error {\n  *   `config`: The dev-infra configuration containing information about the remote. By default\n  *     the dev-infra configuration is loaded with its Github configuration.\n  **/\n-export class GitClient {\n+export class GitClient<Authenticated extends boolean> {\n+  /*************************************************\n+   * Singleton definition and configuration.       *\n+   *************************************************/\n+  /** The singleton instance of the authenticated GitClient. */\n+  private static authenticated: GitClient<true>;\n+  /** The singleton instance of the unauthenticated GitClient. */\n+  private static unauthenticated: GitClient<false>;\n+\n+  /**\n+   * Static method to get the singleton instance of the unauthorized GitClient, creating it if it\n+   * has not yet been created.\n+   */\n+  static getInstance() {\n+    if (!GitClient.unauthenticated) {\n+      GitClient.unauthenticated = new GitClient(undefined);\n+    }\n+    return GitClient.unauthenticated;\n+  }\n+\n+  /**\n+   * Static method to get the singleton instance of the authenticated GitClient if it has been\n+   * generated.\n+   */\n+  static getAuthenticatedInstance() {\n+    if (!GitClient.authenticated) {\n+      throw Error('The authenticated GitClient has not yet been generated.');\n+    }\n+    return GitClient.authenticated;\n+  }\n+\n+  /** Build the authenticated GitClient instance. */\n+  static authenticateWithToken(token: string) {\n+    if (GitClient.authenticated) {\n+      throw Error(\n+          'Cannot generate new authenticated GitClient after one has already been generated.');\n+    }\n+    GitClient.authenticated = new GitClient(token);\n+  }\n+\n+\n   /** Whether verbose logging of Git actions should be used. */\n-  static LOG_COMMANDS = true;\n+  private verboseLogging = true;\n+  /** The OAuth scopes available for the provided Github token. */\n+  private _cachedOauthScopes: Promise<string[]>|null = null;\n+  /**\n+   * Regular expression that matches the provided Github token. Used for\n+   * sanitizing the token from Git child process output.\n+   */\n+  private _githubTokenRegex: RegExp|null = null;\n   /** Short-hand for accessing the default remote configuration. */\n   remoteConfig = this._config.github;\n   /** Octokit request parameters object for targeting the configured remote. */\n   remoteParams = {owner: this.remoteConfig.owner, repo: this.remoteConfig.name};\n-  /** Git URL that resolves to the configured repository. */\n-  repoGitUrl = getRepositoryGitUrl(this.remoteConfig, this.githubToken);\n   /** Instance of the authenticated Github octokit API. */\n   github = new GithubClient(this.githubToken);\n \n-  /** The OAuth scopes available for the provided Github token. */\n-  private _cachedOauthScopes: Promise<string[]>|null = null;\n   /**\n-   * Regular expression that matches the provided Github token. Used for\n-   * sanitizing the token from Git child process output.\n+   * @param githubToken The github token used for authentication, if provided.\n+   * @param _config The configuration, containing the github specific configuration.\n+   * @param _projectRoot The full path to the root of the repository base.\n    */\n-  private _githubTokenRegex: RegExp|null = null;\n-\n-  constructor(\n-      public githubToken?: string, private _config: Pick<NgDevConfig, 'github'> = getConfig(),\n-      private _projectRoot = getRepoBaseDir()) {\n+  protected constructor(public githubToken:\n+                            Authenticated extends true? string: undefined,\n+                                                  private _config = getConfig(),\n+                                                  private _projectRoot = getRepoBaseDir()) {\n     // If a token has been specified (and is not empty), pass it to the Octokit API and\n     // also create a regular expression that can be used for sanitizing Git command output\n     // so that it does not print the token accidentally.\n-    if (githubToken != null) {\n+    if (typeof githubToken === 'string') {\n       this._githubTokenRegex = new RegExp(githubToken, 'g');\n     }\n   }\n \n+  /** Set the verbose logging state of the GitClient instance. */\n+  setVerboseLoggingState(verbose: boolean): this {\n+    this.verboseLogging = verbose;\n+    return this;\n+  }\n+\n   /** Executes the given git command. Throws if the command fails. */\n   run(args: string[], options?: SpawnSyncOptions): Omit<SpawnSyncReturns<string>, 'status'> {\n     const result = this.runGraceful(args, options);\n@@ -102,7 +151,7 @@ export class GitClient {\n     // To improve the debugging experience in case something fails, we print all executed Git\n     // commands to better understand the git actions occuring. Depending on the command being\n     // executed, this debugging information should be logged at different logging levels.\n-    const printFn = (!GitClient.LOG_COMMANDS || options.stdio === 'ignore') ? debug : info;\n+    const printFn = (!this.verboseLogging || options.stdio === 'ignore') ? debug : info;\n     // Note that we do not want to print the token if it is contained in the command. It's common\n     // to share errors with others if the tool failed, and we do not want to leak tokens.\n     printFn('Executing: git', this.omitGithubTokenFromMessage(args.join(' ')));\n@@ -126,6 +175,11 @@ export class GitClient {\n     return result;\n   }\n \n+  /** Git URL that resolves to the configured repository. */\n+  getRepoGitUrl() {\n+    return getRepositoryGitUrl(this.remoteConfig, this.githubToken);\n+  }\n+\n   /** Whether the given branch contains the specified SHA. */\n   hasCommit(branchName: string, sha: string): boolean {\n     return this.run(['branch', branchName, '--contains', sha]).stdout !== '';"
        },
        {
            "sha": "62e3580f4629619fa3f41771ace2e7724bb71fdc",
            "filename": "dev-infra/utils/github.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Fgithub.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Fgithub.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgithub.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -11,10 +11,10 @@ import {params, types} from 'typed-graphqlify';\n import {GitClient} from './git/index';\n \n /** Get a PR from github  */\n-export async function getPr<PrSchema>(prSchema: PrSchema, prNumber: number, git: GitClient) {\n+export async function getPr<PrSchema>(prSchema: PrSchema, prNumber: number, git: GitClient<true>) {\n   /** The owner and name of the repository */\n   const {owner, name} = git.remoteConfig;\n-  /** The GraphQL query object to get a the PR */\n+  /** The Graphql query object to get a the PR */\n   const PR_QUERY = params(\n       {\n         $number: 'Int!',    // The PR number\n@@ -27,15 +27,15 @@ export async function getPr<PrSchema>(prSchema: PrSchema, prNumber: number, git:\n         })\n       });\n \n-  const result = (await git.github.graphql.query(PR_QUERY, {number: prNumber, owner, name}));\n+  const result = (await git.github.graphql(PR_QUERY, {number: prNumber, owner, name}));\n   return result.repository.pullRequest;\n }\n \n /** Get all pending PRs from github  */\n-export async function getPendingPrs<PrSchema>(prSchema: PrSchema, git: GitClient) {\n+export async function getPendingPrs<PrSchema>(prSchema: PrSchema, git: GitClient<true>) {\n   /** The owner and name of the repository */\n   const {owner, name} = git.remoteConfig;\n-  /** The GraphQL query object to get a page of pending PRs */\n+  /** The Graphql query object to get a page of pending PRs */\n   const PRS_QUERY = params(\n       {\n         $first: 'Int',      // How many entries to get with each request\n@@ -75,7 +75,7 @@ export async function getPendingPrs<PrSchema>(prSchema: PrSchema, git: GitClient\n       owner,\n       name,\n     };\n-    const results = await git.github.graphql.query(PRS_QUERY, params) as typeof PRS_QUERY;\n+    const results = await git.github.graphql(PRS_QUERY, params) as typeof PRS_QUERY;\n     prs.push(...results.repository.pullRequests.nodes);\n     hasNextPage = results.repository.pullRequests.pageInfo.hasNextPage;\n     cursor = results.repository.pullRequests.pageInfo.endCursor;"
        },
        {
            "sha": "a1cbf1e2b5e81c2a01f686a23fda566172906e04",
            "filename": "dev-infra/utils/testing/virtual-git-client.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 7,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -58,7 +58,21 @@ export interface Commit {\n  * Virtual git client that mocks Git commands and keeps track of the repository state\n  * in memory. This allows for convenient test assertions with Git interactions.\n  */\n-export class VirtualGitClient extends GitClient {\n+export class VirtualGitClient<Authenticated extends boolean> extends GitClient<Authenticated> {\n+  static getInstance(config = mockNgDevConfig, tmpDir = testTmpDir): VirtualGitClient<false> {\n+    return new VirtualGitClient(undefined, config, tmpDir);\n+  }\n+\n+  static getAuthenticatedInstance(config = mockNgDevConfig, tmpDir = testTmpDir):\n+      VirtualGitClient<true> {\n+    return new VirtualGitClient('abc123', config, tmpDir);\n+  }\n+\n+  private constructor(token: Authenticated extends true? string: undefined, config: NgDevConfig,\n+                                                   tmpDir: string) {\n+    super(token, config, tmpDir);\n+  }\n+\n   /** Current Git HEAD that has been previously fetched. */\n   fetchHeadRef: RemoteRef|null = null;\n   /** List of known branches in the repository. */\n@@ -190,10 +204,10 @@ export class VirtualGitClient extends GitClient {\n }\n \n \n-/**\n- * Builds a Virtual Git Client instance with the provided config and set the temporary test\n- * directory.\n- */\n-export function buildVirtualGitClient(config = mockNgDevConfig, tmpDir = testTmpDir) {\n-  return (new VirtualGitClient(undefined, config, tmpDir));\n+export function installVirtualGitClientSpies() {\n+  const authenticatedVirtualGitClient = VirtualGitClient.getAuthenticatedInstance();\n+  spyOn(GitClient, 'getAuthenticatedInstance').and.returnValue(authenticatedVirtualGitClient);\n+\n+  const unauthenticatedVirtualGitClient = VirtualGitClient.getInstance();\n+  spyOn(GitClient, 'getInstance').and.returnValue(unauthenticatedVirtualGitClient);\n }"
        },
        {
            "sha": "6e09d76facc53d29ad13a3a5893d1d2be7601b8a",
            "filename": "dev-infra/utils/testing/virtual-git-matchers.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Ftesting%2Fvirtual-git-matchers.ts",
            "raw_url": "https://github.com/angular/angular/raw/9bf8e5164d82ae5050c2cff28ccdbb71709952f7/dev-infra%2Futils%2Ftesting%2Fvirtual-git-matchers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2Fvirtual-git-matchers.ts?ref=9bf8e5164d82ae5050c2cff28ccdbb71709952f7",
            "patch": "@@ -27,13 +27,13 @@ export function getBranchPushMatcher(options: BranchPushMatchParameters) {\n   const {targetRepo, targetBranch, baseBranch, baseRepo, expectedCommits} = options;\n   return jasmine.objectContaining({\n     remote: {\n-      repoUrl: `https://github.com/${targetRepo.owner}/${targetRepo.name}.git`,\n+      repoUrl: `https://abc123@github.com/${targetRepo.owner}/${targetRepo.name}.git`,\n       name: `refs/heads/${targetBranch}`\n     },\n     head: jasmine.objectContaining({\n       newCommits: expectedCommits,\n       ref: {\n-        repoUrl: `https://github.com/${baseRepo.owner}/${baseRepo.name}.git`,\n+        repoUrl: `https://abc123@github.com/${baseRepo.owner}/${baseRepo.name}.git`,\n         name: baseBranch,\n       },\n     })"
        }
    ],
    "stats": {
        "total": 760,
        "additions": 438,
        "deletions": 322
    }
}