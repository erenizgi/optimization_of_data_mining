{
    "author": "gkalpak",
    "message": "ci: fail CI jobs when rebasing on master fails (#40161)\n\nAs part of the `setup` CI job (which is a prerequisite for all other CI\njobs), we rebase the current code on master to make sure the PR changes\nare compatible with the latest code from master, even if the PR has not\nbeen rebased recently.\n\nWhen it is not possible to automatically rebase (i.e. when there are\nconflicts that need to be resolved manually), the job and subsequently\nthe entire workflow should fail.\n\nThis behavior has been accidentally broken in #39592, so that the job\nwould succeed even if the rebase operation failed.\n\nThis commit fixes it by ensuring the `exec()` helper used in\n`rebase-pr.js` will throw an error if the underlying command execution\nfails. Previously, the function would always return stdout output as a\nstring and attach a `code` property indicating the exit code of the\ncommand.\n\nSince the exit code isn't necessary in the `rebase-pr.js` script, this\ncommit simplifies the `exec()` helper by making it return the stdout\noutput as a plain string (without extra properties) and re-throw any\nerrors (unless the `ignoreError` argument is set to `true`).\n\n(Initially reported [here][1] by @JoostK.)\n\n[1]: https://angular-team.slack.com/archives/C042EU9T5/p1608070403128900\n\nPR Close #40161",
    "sha": "c53bae839d12cf598a2bf7ab1fa141d88eed3600",
    "files": [
        {
            "sha": "9f1e8125ed8d523e2fafe7b39d03bdff951b033d",
            "filename": ".circleci/rebase-pr.js",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/c53bae839d12cf598a2bf7ab1fa141d88eed3600/.circleci%2Frebase-pr.js",
            "raw_url": "https://github.com/angular/angular/raw/c53bae839d12cf598a2bf7ab1fa141d88eed3600/.circleci%2Frebase-pr.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Frebase-pr.js?ref=c53bae839d12cf598a2bf7ab1fa141d88eed3600",
            "patch": "@@ -152,7 +152,7 @@ function getCommonAncestorSha(sha1, sha2) {\n  */\n function addAndFetchRemote(owner, name) {\n   const remoteName = `${owner}_${name}`;\n-  exec(`git remote add ${remoteName} https://github.com/${owner}/${name}.git`, false);\n+  exec(`git remote add ${remoteName} https://github.com/${owner}/${name}.git`, true);\n   exec(`git fetch ${remoteName}`);\n   return remoteName;\n }\n@@ -194,14 +194,14 @@ function getRefsAndShasForChange() {\n  *\n  * Return the trimmed stdout as a string, with an added attribute of the exit code.\n  */\n-function exec(command, allowStderr = true) {\n-  let output = new String();\n-  output.code = 0;\n+function exec(command, ignoreError = false) {\n   try {\n-    output += execSync(command, {stdio: ['pipe', 'pipe', 'pipe']}).toString().trim();\n+    return execSync(command, {stdio: 'pipe'}).toString().trim();\n   } catch (err) {\n-    allowStderr && console.error(err.stderr.toString());\n-    output.code = err.status;\n+    if (ignoreError) {\n+      return '';\n+    }\n+\n+    throw err;\n   }\n-  return output;\n }"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 8,
        "deletions": 8
    }
}