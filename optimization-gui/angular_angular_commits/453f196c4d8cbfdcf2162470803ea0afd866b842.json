{
    "author": "mhevery",
    "message": "refactor(core): Cleanup circular dependency between ViewEngine and Ivy `TemplateRef`. (#39621)\n\n`TemplateRef` is declared in ViewEngine but it sub-classed in Ivy. This creates a circular\ndependency between ViewEngine `TemplateRef` which needs to declare `__NG_ELEMENT_ID__` and\nivy factory which needs to create it. The workaround used to be to pass the `TemplateRef`\nthrough stack but that created a very convoluted code. This refactoring simply bundles the\ntwo files together and removes the stack workaround making the code simpler to follow.\n\nPR Close #39621",
    "sha": "453f196c4d8cbfdcf2162470803ea0afd866b842",
    "files": [
        {
            "sha": "8a2bd85151232a6aac814817e756ebba3b126a65",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 66,
            "deletions": 27,
            "changes": 93,
            "blob_url": "https://github.com/angular/angular/blob/453f196c4d8cbfdcf2162470803ea0afd866b842/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/453f196c4d8cbfdcf2162470803ea0afd866b842/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=453f196c4d8cbfdcf2162470803ea0afd866b842",
            "patch": "@@ -273,7 +273,14 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/instructions/shared.ts\",\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/injectable.ts\",\n+    \"packages/core/src/di/jit/injectable.ts\",\n+    \"packages/core/src/di/jit/environment.ts\",\n+    \"packages/core/src/di/injector_compatibility.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -286,7 +293,16 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/render3/di.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/instructions/shared.ts\",\n+    \"packages/core/src/error_handler.ts\",\n+    \"packages/core/src/errors.ts\",\n+    \"packages/core/src/view/types.ts\",\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/injectable.ts\",\n+    \"packages/core/src/di/jit/injectable.ts\",\n+    \"packages/core/src/di/jit/environment.ts\",\n     \"packages/core/src/di/injector_compatibility.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n@@ -300,7 +316,12 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/render3/di.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/instructions/shared.ts\",\n+    \"packages/core/src/error_handler.ts\",\n+    \"packages/core/src/errors.ts\",\n+    \"packages/core/src/view/types.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -313,7 +334,8 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/render3/di.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/instructions/shared.ts\",\n     \"packages/core/src/render3/definition.ts\",\n     \"packages/core/src/metadata/ng_module.ts\"\n   ],\n@@ -324,12 +346,9 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n-    \"packages/core/src/di.ts\",\n-    \"packages/core/src/di/index.ts\",\n-    \"packages/core/src/di/injectable.ts\",\n-    \"packages/core/src/di/jit/injectable.ts\",\n-    \"packages/core/src/di/jit/environment.ts\",\n+    \"packages/core/src/render3/di.ts\",\n     \"packages/core/src/di/injector_compatibility.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n@@ -343,16 +362,9 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n-    \"packages/core/src/error_handler.ts\",\n-    \"packages/core/src/errors.ts\",\n-    \"packages/core/src/view/types.ts\",\n-    \"packages/core/src/di.ts\",\n-    \"packages/core/src/di/index.ts\",\n-    \"packages/core/src/di/injectable.ts\",\n-    \"packages/core/src/di/jit/injectable.ts\",\n-    \"packages/core/src/di/jit/environment.ts\",\n-    \"packages/core/src/di/injector_compatibility.ts\",\n+    \"packages/core/src/render3/di.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -365,7 +377,9 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n+    \"packages/core/src/render3/di.ts\",\n     \"packages/core/src/render3/definition.ts\",\n     \"packages/core/src/metadata/ng_module.ts\"\n   ],\n@@ -376,6 +390,7 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n     \"packages/core/src/render3/instructions/lview_debug.ts\",\n     \"packages/core/src/core.ts\",\n@@ -398,6 +413,7 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n     \"packages/core/src/render3/view_ref.ts\"\n   ],\n   [\n@@ -849,17 +865,23 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/instructions/shared.ts\",\n+    \"packages/core/src/error_handler.ts\",\n+    \"packages/core/src/errors.ts\",\n+    \"packages/core/src/view/types.ts\",\n     \"packages/core/src/linker/component_factory.ts\"\n   ],\n   [\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n     \"packages/core/src/error_handler.ts\",\n     \"packages/core/src/errors.ts\",\n     \"packages/core/src/view/types.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/linker/component_factory.ts\"\n   ],\n   [\n@@ -878,6 +900,7 @@\n   [\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n     \"packages/core/src/render3/view_ref.ts\"\n   ],\n   [\n@@ -928,6 +951,30 @@\n     \"packages/core/src/errors.ts\",\n     \"packages/core/src/view/types.ts\"\n   ],\n+  [\n+    \"packages/core/src/error_handler.ts\",\n+    \"packages/core/src/errors.ts\",\n+    \"packages/core/src/view/types.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/instructions/shared.ts\"\n+  ],\n+  [\n+    \"packages/core/src/error_handler.ts\",\n+    \"packages/core/src/errors.ts\",\n+    \"packages/core/src/view/types.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/instructions/shared.ts\"\n+  ],\n+  [\n+    \"packages/core/src/error_handler.ts\",\n+    \"packages/core/src/errors.ts\",\n+    \"packages/core/src/view/types.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/instructions/shared.ts\"\n+  ],\n   [\n     \"packages/core/src/linker/component_factory_resolver.ts\",\n     \"packages/core/src/linker/ng_module_factory.ts\"\n@@ -943,14 +990,6 @@\n     \"packages/core/src/linker/ng_module_factory_registration.ts\",\n     \"packages/core/src/render3/ng_module_ref.ts\"\n   ],\n-  [\n-    \"packages/core/src/linker/template_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\"\n-  ],\n-  [\n-    \"packages/core/src/linker/view_container_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\"\n-  ],\n   [\n     \"packages/core/src/metadata/directives.ts\",\n     \"packages/core/src/render3/jit/directive.ts\""
        },
        {
            "sha": "775815c494e1a594214e4f23420f826d2e0601a6",
            "filename": "packages/core/src/linker/template_ref.ts",
            "status": "modified",
            "additions": 68,
            "deletions": 9,
            "changes": 77,
            "blob_url": "https://github.com/angular/angular/blob/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Fsrc%2Flinker%2Ftemplate_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Fsrc%2Flinker%2Ftemplate_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Ftemplate_ref.ts?ref=453f196c4d8cbfdcf2162470803ea0afd866b842",
            "patch": "@@ -6,13 +6,23 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {injectTemplateRef as render3InjectTemplateRef} from '../render3/view_engine_compatibility';\n+import {assertLContainer} from '../render3/assert';\n+import {createLView, renderView} from '../render3/instructions/shared';\n+import {TContainerNode, TNode, TNodeType} from '../render3/interfaces/node';\n+import {DECLARATION_LCONTAINER, LView, LViewFlags, QUERIES, TView} from '../render3/interfaces/view';\n+import {getCurrentTNode, getLView} from '../render3/state';\n+import {ViewRef as R3_ViewRef} from '../render3/view_ref';\n+import {assertDefined} from '../util/assert';\n import {noop} from '../util/noop';\n-\n-import {ElementRef} from './element_ref';\n+import {createElementRef, ElementRef} from './element_ref';\n import {EmbeddedViewRef} from './view_ref';\n \n \n+\n+export const SWITCH_TEMPLATE_REF_FACTORY__POST_R3__ = injectTemplateRef;\n+const SWITCH_TEMPLATE_REF_FACTORY__PRE_R3__ = noop;\n+const SWITCH_TEMPLATE_REF_FACTORY: typeof injectTemplateRef = SWITCH_TEMPLATE_REF_FACTORY__PRE_R3__;\n+\n /**\n  * Represents an embedded template that can be used to instantiate embedded views.\n  * To instantiate embedded views based on a template, use the `ViewContainerRef`\n@@ -59,11 +69,60 @@ export abstract class TemplateRef<C> {\n    * @internal\n    * @nocollapse\n    */\n-  static __NG_ELEMENT_ID__:\n-      () => TemplateRef<any>| null = () => SWITCH_TEMPLATE_REF_FACTORY(TemplateRef)\n+  static __NG_ELEMENT_ID__: () => TemplateRef<any>| null = SWITCH_TEMPLATE_REF_FACTORY;\n }\n \n-export const SWITCH_TEMPLATE_REF_FACTORY__POST_R3__ = render3InjectTemplateRef;\n-const SWITCH_TEMPLATE_REF_FACTORY__PRE_R3__ = noop;\n-const SWITCH_TEMPLATE_REF_FACTORY: typeof render3InjectTemplateRef =\n-    SWITCH_TEMPLATE_REF_FACTORY__PRE_R3__;\n+const ViewEngineTemplateRef = TemplateRef;\n+\n+const R3TemplateRef = class TemplateRef<T> extends ViewEngineTemplateRef<T> {\n+  constructor(\n+      private _declarationLView: LView, private _declarationTContainer: TContainerNode,\n+      public elementRef: ElementRef) {\n+    super();\n+  }\n+\n+  createEmbeddedView(context: T): EmbeddedViewRef<T> {\n+    const embeddedTView = this._declarationTContainer.tViews as TView;\n+    const embeddedLView = createLView(\n+        this._declarationLView, embeddedTView, context, LViewFlags.CheckAlways, null,\n+        embeddedTView.declTNode, null, null, null, null);\n+\n+    const declarationLContainer = this._declarationLView[this._declarationTContainer.index];\n+    ngDevMode && assertLContainer(declarationLContainer);\n+    embeddedLView[DECLARATION_LCONTAINER] = declarationLContainer;\n+\n+    const declarationViewLQueries = this._declarationLView[QUERIES];\n+    if (declarationViewLQueries !== null) {\n+      embeddedLView[QUERIES] = declarationViewLQueries.createEmbeddedView(embeddedTView);\n+    }\n+\n+    renderView(embeddedTView, embeddedLView, context);\n+\n+    return new R3_ViewRef<T>(embeddedLView);\n+  }\n+};\n+\n+/**\n+ * Creates a TemplateRef given a node.\n+ *\n+ * @returns The TemplateRef instance to use\n+ */\n+export function injectTemplateRef<T>(): TemplateRef<T>|null {\n+  return createTemplateRef<T>(getCurrentTNode()!, getLView());\n+}\n+\n+/**\n+ * Creates a TemplateRef and stores it on the injector.\n+ *\n+ * @param hostTNode The node on which a TemplateRef is requested\n+ * @param hostLView The `LView` to which the node belongs\n+ * @returns The TemplateRef instance or null if we can't create a TemplateRef on a given node type\n+ */\n+export function createTemplateRef<T>(hostTNode: TNode, hostLView: LView): TemplateRef<T>|null {\n+  if (hostTNode.type & TNodeType.Container) {\n+    ngDevMode && assertDefined(hostTNode.tViews, 'TView must be allocated');\n+    return new R3TemplateRef(\n+        hostLView, hostTNode as TContainerNode, createElementRef(hostTNode, hostLView));\n+  }\n+  return null;\n+}"
        },
        {
            "sha": "1fc99726217c233b85e577b757c19c097d262c93",
            "filename": "packages/core/src/render3/query.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts",
            "raw_url": "https://github.com/angular/angular/raw/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts?ref=453f196c4d8cbfdcf2162470803ea0afd866b842",
            "patch": "@@ -13,7 +13,7 @@ import {InjectionToken} from '../di/injection_token';\n import {Type} from '../interface/type';\n import {createElementRef, ElementRef as ViewEngine_ElementRef} from '../linker/element_ref';\n import {QueryList} from '../linker/query_list';\n-import {TemplateRef as ViewEngine_TemplateRef} from '../linker/template_ref';\n+import {createTemplateRef, TemplateRef as ViewEngine_TemplateRef} from '../linker/template_ref';\n import {ViewContainerRef} from '../linker/view_container_ref';\n import {assertDefined, assertIndexInRange, throwError} from '../util/assert';\n import {stringify} from '../util/stringify';\n@@ -30,7 +30,7 @@ import {DECLARATION_LCONTAINER, LView, PARENT, QUERIES, TVIEW, TView} from './in\n import {assertTNodeType} from './node_assert';\n import {getCurrentQueryIndex, getCurrentTNode, getLView, getTView, setCurrentQueryIndex} from './state';\n import {isCreationMode} from './util/view_utils';\n-import {createContainerRef, createTemplateRef} from './view_engine_compatibility';\n+import {createContainerRef} from './view_engine_compatibility';\n \n const unusedValueToPlacateAjd = unused1 + unused2 + unused3 + unused4;\n \n@@ -302,7 +302,7 @@ function createResultByTNodeType(tNode: TNode, currentView: LView): any {\n   if (tNode.type & (TNodeType.AnyRNode | TNodeType.ElementContainer)) {\n     return createElementRef(tNode, currentView);\n   } else if (tNode.type & TNodeType.Container) {\n-    return createTemplateRef(ViewEngine_TemplateRef, tNode, currentView);\n+    return createTemplateRef(tNode, currentView);\n   }\n   return null;\n }\n@@ -325,7 +325,7 @@ function createSpecialToken(lView: LView, tNode: TNode, read: any): any {\n   if (read === ViewEngine_ElementRef) {\n     return createElementRef(tNode, lView);\n   } else if (read === ViewEngine_TemplateRef) {\n-    return createTemplateRef(ViewEngine_TemplateRef, tNode, lView);\n+    return createTemplateRef(tNode, lView);\n   } else if (read === ViewContainerRef) {\n     ngDevMode && assertTNodeType(tNode, TNodeType.AnyRNode | TNodeType.AnyContainer);\n     return createContainerRef("
        },
        {
            "sha": "0ff6730a293b92da7c14828df62176571544b8c2",
            "filename": "packages/core/src/render3/view_engine_compatibility.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 70,
            "changes": 74,
            "blob_url": "https://github.com/angular/angular/blob/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "raw_url": "https://github.com/angular/angular/raw/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts?ref=453f196c4d8cbfdcf2162470803ea0afd866b842",
            "patch": "@@ -16,17 +16,17 @@ import {ViewContainerRef as ViewEngine_ViewContainerRef} from '../linker/view_co\n import {EmbeddedViewRef as viewEngine_EmbeddedViewRef, ViewRef as viewEngine_ViewRef} from '../linker/view_ref';\n import {Renderer2} from '../render/api';\n import {addToArray, removeFromArray} from '../util/array_utils';\n-import {assertDefined, assertEqual, assertGreaterThan, assertLessThan} from '../util/assert';\n+import {assertEqual, assertGreaterThan, assertLessThan} from '../util/assert';\n \n-import {assertLContainer, assertNodeInjector} from './assert';\n+import {assertNodeInjector} from './assert';\n import {getParentInjectorLocation, NodeInjector} from './di';\n-import {addToViewTree, createLContainer, createLView, renderView} from './instructions/shared';\n+import {addToViewTree, createLContainer} from './instructions/shared';\n import {CONTAINER_HEADER_OFFSET, LContainer, NATIVE, VIEW_REFS} from './interfaces/container';\n import {NodeInjectorOffset} from './interfaces/injector';\n import {TContainerNode, TDirectiveHostNode, TElementContainerNode, TElementNode, TNode, TNodeType} from './interfaces/node';\n import {isProceduralRenderer, RComment, RElement} from './interfaces/renderer';\n import {isComponentHost, isLContainer, isLView} from './interfaces/type_checks';\n-import {DECLARATION_COMPONENT_VIEW, DECLARATION_LCONTAINER, LView, LViewFlags, PARENT, QUERIES, RENDERER, T_HOST, TVIEW, TView} from './interfaces/view';\n+import {DECLARATION_COMPONENT_VIEW, LView, PARENT, RENDERER, T_HOST, TVIEW} from './interfaces/view';\n import {assertTNodeType} from './node_assert';\n import {addViewToContainer, destroyLView, detachView, getBeforeNodeForView, insertView, nativeInsertBefore, nativeNextSibling, nativeParentNode} from './node_manipulation';\n import {getCurrentTNode, getLView} from './state';\n@@ -36,72 +36,6 @@ import {ViewRef} from './view_ref';\n \n \n \n-let R3TemplateRef: {\n-  new (_declarationParentView: LView, hostTNode: TContainerNode, elementRef: ViewEngine_ElementRef):\n-      ViewEngine_TemplateRef<any>\n-};\n-\n-/**\n- * Creates a TemplateRef given a node.\n- *\n- * @returns The TemplateRef instance to use\n- */\n-export function injectTemplateRef<T>(TemplateRefToken: typeof ViewEngine_TemplateRef):\n-    ViewEngine_TemplateRef<T>|null {\n-  return createTemplateRef<T>(TemplateRefToken, getCurrentTNode()!, getLView());\n-}\n-\n-/**\n- * Creates a TemplateRef and stores it on the injector.\n- *\n- * @param TemplateRefToken The TemplateRef type\n- * @param ElementRefToken The ElementRef type\n- * @param hostTNode The node on which a TemplateRef is requested\n- * @param hostView The view to which the node belongs\n- * @returns The TemplateRef instance or null if we can't create a TemplateRef on a given node type\n- */\n-export function createTemplateRef<T>(\n-    TemplateRefToken: typeof ViewEngine_TemplateRef, hostTNode: TNode,\n-    hostView: LView): ViewEngine_TemplateRef<T>|null {\n-  if (!R3TemplateRef) {\n-    R3TemplateRef = class TemplateRef<T> extends TemplateRefToken<T>{\n-      constructor(\n-          private _declarationView: LView, private _declarationTContainer: TContainerNode,\n-          readonly elementRef: ViewEngine_ElementRef) {\n-        super();\n-      }\n-\n-      createEmbeddedView(context: T): viewEngine_EmbeddedViewRef<T> {\n-        const embeddedTView = this._declarationTContainer.tViews as TView;\n-        const embeddedLView = createLView(\n-            this._declarationView, embeddedTView, context, LViewFlags.CheckAlways, null,\n-            embeddedTView.declTNode, null, null, null, null);\n-\n-        const declarationLContainer = this._declarationView[this._declarationTContainer.index];\n-        ngDevMode && assertLContainer(declarationLContainer);\n-        embeddedLView[DECLARATION_LCONTAINER] = declarationLContainer;\n-\n-        const declarationViewLQueries = this._declarationView[QUERIES];\n-        if (declarationViewLQueries !== null) {\n-          embeddedLView[QUERIES] = declarationViewLQueries.createEmbeddedView(embeddedTView);\n-        }\n-\n-        renderView(embeddedTView, embeddedLView, context);\n-\n-        return new ViewRef<T>(embeddedLView);\n-      }\n-    };\n-  }\n-\n-  if (hostTNode.type & TNodeType.Container) {\n-    ngDevMode && assertDefined(hostTNode.tViews, 'TView must be allocated');\n-    return new R3TemplateRef(\n-        hostView, hostTNode as TContainerNode, createElementRef(hostTNode, hostView));\n-  } else {\n-    return null;\n-  }\n-}\n-\n let R3ViewContainerRef: {\n   new (\n       lContainer: LContainer, hostTNode: TElementNode|TContainerNode|TElementContainerNode,"
        },
        {
            "sha": "a4ade3b23b24857726469cabf754ec8be7763763",
            "filename": "packages/core/src/render3/view_engine_compatibility_prebound.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility_prebound.ts",
            "raw_url": "https://github.com/angular/angular/raw/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility_prebound.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility_prebound.ts?ref=453f196c4d8cbfdcf2162470803ea0afd866b842",
            "patch": "@@ -9,11 +9,11 @@\n \n import {ChangeDetectorRef} from '../change_detection/change_detector_ref';\n import {InjectFlags} from '../di/interface/injector';\n-import {TemplateRef as ViewEngine_TemplateRef} from '../linker/template_ref';\n+import {createTemplateRef, TemplateRef} from '../linker/template_ref';\n import {throwProviderNotFoundError} from './errors';\n import {TNode} from './interfaces/node';\n import {LView} from './interfaces/view';\n-import {createTemplateRef, injectChangeDetectorRef} from './view_engine_compatibility';\n+import {injectChangeDetectorRef} from './view_engine_compatibility';\n \n \n /**\n@@ -22,8 +22,8 @@ import {createTemplateRef, injectChangeDetectorRef} from './view_engine_compatib\n  *\n  * @codeGenApi\n  */\n-export function ɵɵtemplateRefExtractor(tNode: TNode, currentView: LView) {\n-  return createTemplateRef(ViewEngine_TemplateRef, tNode, currentView);\n+export function ɵɵtemplateRefExtractor(tNode: TNode, lView: LView): TemplateRef<any>|null {\n+  return createTemplateRef(tNode, lView);\n }\n \n "
        },
        {
            "sha": "f9138b4ed23bf2de2359d1cadded0a40ee369069",
            "filename": "packages/core/test/bundling/forms/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json?ref=453f196c4d8cbfdcf2162470803ea0afd866b842",
            "patch": "@@ -467,6 +467,9 @@\n   {\n     \"name\": \"R3Injector\"\n   },\n+  {\n+    \"name\": \"R3TemplateRef\"\n+  },\n   {\n     \"name\": \"RADIO_VALUE_ACCESSOR\"\n   },\n@@ -620,6 +623,9 @@\n   {\n     \"name\": \"VERSION\"\n   },\n+  {\n+    \"name\": \"ViewEngineTemplateRef\"\n+  },\n   {\n     \"name\": \"Validators\"\n   },"
        },
        {
            "sha": "6ca51817164ed7bcdf61cee0e71a1403e89c3c12",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=453f196c4d8cbfdcf2162470803ea0afd866b842",
            "patch": "@@ -572,6 +572,9 @@\n   {\n     \"name\": \"R3Injector\"\n   },\n+  {\n+    \"name\": \"R3TemplateRef\"\n+  },\n   {\n     \"name\": \"ROUTER_CONFIGURATION\"\n   },\n@@ -839,6 +842,9 @@\n   {\n     \"name\": \"VERSION\"\n   },\n+  {\n+    \"name\": \"ViewEngineTemplateRef\"\n+  },\n   {\n     \"name\": \"Version\"\n   },"
        },
        {
            "sha": "5546c4e8ddfb8e93181fc4665a3e0c64d44b782b",
            "filename": "packages/core/test/bundling/todo/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json?ref=453f196c4d8cbfdcf2162470803ea0afd866b842",
            "patch": "@@ -86,6 +86,9 @@\n   {\n     \"name\": \"Optional\"\n   },\n+  {\n+    \"name\": \"R3TemplateRef\"\n+  },\n   {\n     \"name\": \"RecordViewTuple\"\n   },\n@@ -134,6 +137,9 @@\n   {\n     \"name\": \"TodoStore\"\n   },\n+  {\n+    \"name\": \"ViewEngineTemplateRef\"\n+  },\n   {\n     \"name\": \"ViewContainerRef\"\n   },"
        },
        {
            "sha": "4cd53bcd99c37eff4be5d709b33db35b1d656282",
            "filename": "packages/core/test/render3/perf/ng_template/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fng_template%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fng_template%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fng_template%2Findex.ts?ref=453f196c4d8cbfdcf2162470803ea0afd866b842",
            "patch": "@@ -5,23 +5,25 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {injectTemplateRef} from '@angular/core/src/linker/template_ref';\n import {TemplateRef, ViewContainerRef} from '../../../../src/linker';\n import {ɵɵdefineDirective, ɵɵdirectiveInject, ɵɵtemplate} from '../../../../src/render3/index';\n import {createLView, createTNode, createTView} from '../../../../src/render3/instructions/shared';\n import {RenderFlags} from '../../../../src/render3/interfaces/definition';\n import {TNodeType} from '../../../../src/render3/interfaces/node';\n import {LViewFlags, TViewType} from '../../../../src/render3/interfaces/view';\n-import {injectTemplateRef, injectViewContainerRef} from '../../../../src/render3/view_engine_compatibility';\n+import {injectViewContainerRef} from '../../../../src/render3/view_engine_compatibility';\n import {createBenchmark} from '../micro_bench';\n import {createAndRenderLView} from '../setup';\n \n+\n class TemplateRefToken {\n   /**\n    * @internal\n    * @nocollapse\n    */\n   static __NG_ELEMENT_ID__(): TemplateRef<any>|null {\n-    return injectTemplateRef(TemplateRef);\n+    return injectTemplateRef();\n   }\n }\n class ViewContainerRefToken {"
        },
        {
            "sha": "bf25b9d0157c5fca04607cae4290c5317210b99a",
            "filename": "packages/core/test/render3/render_util.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Ftest%2Frender3%2Frender_util.ts",
            "raw_url": "https://github.com/angular/angular/raw/453f196c4d8cbfdcf2162470803ea0afd866b842/packages%2Fcore%2Ftest%2Frender3%2Frender_util.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Frender_util.ts?ref=453f196c4d8cbfdcf2162470803ea0afd866b842",
            "patch": "@@ -453,7 +453,7 @@ export const text: RText = null as any as Text;\n  */\n export function enableIvyInjectableFactories() {\n   (ElementRef as any)[NG_ELEMENT_ID] = () => R3_ELEMENT_REF_FACTORY();\n-  (TemplateRef as any)[NG_ELEMENT_ID] = () => R3_TEMPLATE_REF_FACTORY(TemplateRef);\n+  (TemplateRef as any)[NG_ELEMENT_ID] = () => R3_TEMPLATE_REF_FACTORY();\n   (ViewContainerRef as any)[NG_ELEMENT_ID] = () => R3_VIEW_CONTAINER_REF_FACTORY(ViewContainerRef);\n   (ChangeDetectorRef as any)[NG_ELEMENT_ID] = () => R3_CHANGE_DETECTOR_REF_FACTORY();\n   (Renderer2 as any)[NG_ELEMENT_ID] = () => R3_RENDERER2_FACTORY();"
        }
    ],
    "stats": {
        "total": 286,
        "additions": 169,
        "deletions": 117
    }
}