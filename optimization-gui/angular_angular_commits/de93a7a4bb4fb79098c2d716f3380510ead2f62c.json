{
    "author": "atscott",
    "message": "fix(language-service): resolve to the pre-compiled style when compiled css url is provided (#41538)\n\nWith this commit, the language service will first try to locate a\npre-compiled style file with the same name when a `css` is provided in\nthe `styleUrls`. This prevents a missing resource diagnostic for when the\ncompiled file is not available in the language service environment and also\nallows \"go to definition\" to go to that pre-compiled file.\n\nFixes angular/vscode-ng-language-service#1263\n\nPR Close #41538",
    "sha": "de93a7a4bb4fb79098c2d716f3380510ead2f62c",
    "files": [
        {
            "sha": "f6c7d3e84bf3639a66ee9f61efd16a0129816dde",
            "filename": "packages/compiler-cli/src/ngtsc/core/api/src/interfaces.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/de93a7a4bb4fb79098c2d716f3380510ead2f62c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Finterfaces.ts",
            "raw_url": "https://github.com/angular/angular/raw/de93a7a4bb4fb79098c2d716f3380510ead2f62c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Finterfaces.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Finterfaces.ts?ref=de93a7a4bb4fb79098c2d716f3380510ead2f62c",
            "patch": "@@ -33,8 +33,13 @@ export interface ResourceHost {\n   /**\n    * Converts a file path for a resource that is used in a source file or another resource\n    * into a filepath.\n+   *\n+   * The optional `fallbackResolve` method can be used as a way to attempt a fallback resolution if\n+   * the implementation's `resourceNameToFileName` resolution fails.\n    */\n-  resourceNameToFileName(resourceName: string, containingFilePath: string): string|null;\n+  resourceNameToFileName(\n+      resourceName: string, containingFilePath: string,\n+      fallbackResolve?: (url: string, fromFile: string) => string | null): string|null;\n \n   /**\n    * Load a referenced resource either statically or asynchronously. If the host returns a"
        },
        {
            "sha": "ad18b05a6e45e5302e961609225200b8c6fc9a41",
            "filename": "packages/compiler-cli/src/ngtsc/resource/src/loader.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/de93a7a4bb4fb79098c2d716f3380510ead2f62c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fresource%2Fsrc%2Floader.ts",
            "raw_url": "https://github.com/angular/angular/raw/de93a7a4bb4fb79098c2d716f3380510ead2f62c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fresource%2Fsrc%2Floader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fresource%2Fsrc%2Floader.ts?ref=de93a7a4bb4fb79098c2d716f3380510ead2f62c",
            "patch": "@@ -46,7 +46,8 @@ export class AdapterResourceLoader implements ResourceLoader {\n   resolve(url: string, fromFile: string): string {\n     let resolvedUrl: string|null = null;\n     if (this.adapter.resourceNameToFileName) {\n-      resolvedUrl = this.adapter.resourceNameToFileName(url, fromFile);\n+      resolvedUrl = this.adapter.resourceNameToFileName(\n+          url, fromFile, (url: string, fromFile: string) => this.fallbackResolve(url, fromFile));\n     } else {\n       resolvedUrl = this.fallbackResolve(url, fromFile);\n     }"
        },
        {
            "sha": "fc40367efa79b2351f25b321f279866ddd853c18",
            "filename": "packages/language-service/ivy/adapters.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/de93a7a4bb4fb79098c2d716f3380510ead2f62c/packages%2Flanguage-service%2Fivy%2Fadapters.ts",
            "raw_url": "https://github.com/angular/angular/raw/de93a7a4bb4fb79098c2d716f3380510ead2f62c/packages%2Flanguage-service%2Fivy%2Fadapters.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fadapters.ts?ref=de93a7a4bb4fb79098c2d716f3380510ead2f62c",
            "patch": "@@ -18,6 +18,8 @@ import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {isTypeScriptFile} from './utils';\n \n+const PRE_COMPILED_STYLE_EXTENSIONS = ['.scss', '.sass', '.less', '.styl'];\n+\n export class LanguageServiceAdapter implements NgCompilerAdapter {\n   readonly entryPoint = null;\n   readonly constructionDiagnostics: ts.Diagnostic[] = [];\n@@ -37,6 +39,24 @@ export class LanguageServiceAdapter implements NgCompilerAdapter {\n     this.rootDirs = getRootDirs(this, project.getCompilationSettings());\n   }\n \n+  resourceNameToFileName(\n+      url: string, fromFile: string,\n+      fallbackResolve?: (url: string, fromFile: string) => string | null): string|null {\n+    // If we are trying to resolve a `.css` file, see if we can find a pre-compiled file with the\n+    // same name instead. That way, we can provide go-to-definition for the pre-compiled files which\n+    // would generally be the desired behavior.\n+    if (url.endsWith('.css')) {\n+      const styleUrl = p.resolve(fromFile, '..', url);\n+      for (const ext of PRE_COMPILED_STYLE_EXTENSIONS) {\n+        const precompiledFileUrl = styleUrl.replace(/\\.css$/, ext);\n+        if (this.fileExists(precompiledFileUrl)) {\n+          return precompiledFileUrl;\n+        }\n+      }\n+    }\n+    return fallbackResolve?.(url, fromFile) ?? null;\n+  }\n+\n   isShim(sf: ts.SourceFile): boolean {\n     return isShim(sf);\n   }"
        },
        {
            "sha": "818c42ac4284b2a6f576f26b4ca248dd010c640e",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/de93a7a4bb4fb79098c2d716f3380510ead2f62c/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/de93a7a4bb4fb79098c2d716f3380510ead2f62c/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=de93a7a4bb4fb79098c2d716f3380510ead2f62c",
            "patch": "@@ -152,6 +152,31 @@ describe('definitions', () => {\n     assertFileNames([def, def2], ['dir2.ts', 'dir.ts']);\n   });\n \n+  it('should go to the pre-compiled style sheet', () => {\n+    initMockFileSystem('Native');\n+    const files = {\n+      'app.ts': `\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        template: '',\n+        styleUrls: ['./style.css'],\n+      })\n+      export class AppCmp {}\n+      `,\n+      'style.scss': '',\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const appFile = project.openFile('app.ts');\n+    appFile.moveCursorToText(`['./stylÂ¦e.css']`);\n+    const {textSpan, definitions} = getDefinitionsAndAssertBoundSpan(env, appFile);\n+    expect(appFile.contents.substr(textSpan.start, textSpan.length)).toEqual('./style.css');\n+\n+    expect(definitions.length).toEqual(1);\n+    assertFileNames(definitions, ['style.scss']);\n+  });\n+\n   function getDefinitionsAndAssertBoundSpan(env: LanguageServiceTestEnv, file: OpenBuffer) {\n     env.expectNoSourceDiagnostics();\n     const definitionAndBoundSpan = file.getDefinitionAndBoundSpan();"
        },
        {
            "sha": "3d6f249c4cdf3e6239e9faf07e90514b32ee287c",
            "filename": "packages/language-service/ivy/test/diagnostic_spec.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/de93a7a4bb4fb79098c2d716f3380510ead2f62c/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/de93a7a4bb4fb79098c2d716f3380510ead2f62c/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts?ref=de93a7a4bb4fb79098c2d716f3380510ead2f62c",
            "patch": "@@ -317,6 +317,50 @@ describe('getSemanticDiagnostics', () => {\n         .toHaveBeenCalledWith(jasmine.stringMatching(\n             /LanguageService\\#LsDiagnostics\\:.*\\\"LsDiagnostics\\\":\\s*\\d+.*/g));\n   });\n+\n+  it('does not produce diagnostics when pre-compiled file is found', () => {\n+    const files = {\n+      'app.ts': `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          template: '',\n+          styleUrls: ['./one.css', './two/two.css', './three.css', '../test/four.css'],\n+        })\n+        export class MyComponent {}\n+      `,\n+      'one.scss': '',\n+      'two/two.sass': '',\n+      'three.less': '',\n+      'four.styl': '',\n+    };\n+\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const diags = project.getDiagnosticsForFile('app.ts');\n+    expect(diags.length).toBe(0);\n+  });\n+\n+  it('produces missing resource diagnostic for missing css', () => {\n+    const files = {\n+      'app.ts': `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          template: '',\n+          styleUrls: ['./missing.css'],\n+        })\n+        export class MyComponent {}\n+      `,\n+    };\n+\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const diags = project.getDiagnosticsForFile('app.ts');\n+    expect(diags.length).toBe(1);\n+    const diag = diags[0];\n+    expect(diag.code).toBe(ngErrorCode(ErrorCode.COMPONENT_RESOURCE_NOT_FOUND));\n+    expect(diag.category).toBe(ts.DiagnosticCategory.Error);\n+    expect(getTextOfDiagnostic(diag)).toBe(`'./missing.css'`);\n+  });\n });\n \n function getTextOfDiagnostic(diag: ts.Diagnostic): string {"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 97,
        "deletions": 2
    }
}