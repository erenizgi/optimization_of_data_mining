{
    "author": "alan-agius4",
    "message": "fix(compiler-cli): extend `angularCompilerOptions` in tsconfig from node (#40694)\n\nTypeScript supports non rooted extends, we should do the same\n\nhttps://github.com/microsoft/TypeScript/blob/b346f5764e4d500ebdeff7086e43690ea533a305/src/compiler/commandLineParser.ts#L2603-L2628\n\nCloses: #36715\n\nPR Close #40694",
    "sha": "5eb195416bf73f2fa59de52531724d8d19392975",
    "files": [
        {
            "sha": "5220547af9a9f656e98a55c76fb7affde69715d7",
            "filename": "packages/compiler-cli/src/perform_compile.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 21,
            "changes": 73,
            "blob_url": "https://github.com/angular/angular/blob/5eb195416bf73f2fa59de52531724d8d19392975/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "raw_url": "https://github.com/angular/angular/raw/5eb195416bf73f2fa59de52531724d8d19392975/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts?ref=5eb195416bf73f2fa59de52531724d8d19392975",
            "patch": "@@ -9,7 +9,7 @@\n import {isSyntaxError, Position} from '@angular/compiler';\n import * as ts from 'typescript';\n \n-import {absoluteFrom, AbsoluteFsPath, getFileSystem, ReadonlyFileSystem, relative, resolve} from '../src/ngtsc/file_system';\n+import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem, ReadonlyFileSystem, relative, resolve} from '../src/ngtsc/file_system';\n import {NgCompilerOptions} from './ngtsc/core/api';\n \n import {replaceTsWithNgInErrors} from './ngtsc/diagnostics';\n@@ -137,6 +137,8 @@ export function readConfiguration(\n     project: string, existingOptions?: api.CompilerOptions,\n     host: ConfigurationHost = getFileSystem()): ParsedConfiguration {\n   try {\n+    const fs = getFileSystem();\n+\n     const readConfigFile = (configFile: string) =>\n         ts.readConfigFile(configFile, file => host.readFile(host.resolve(file)));\n     const readAngularCompilerOptions =\n@@ -150,20 +152,14 @@ export function readConfiguration(\n \n           // we are only interested into merging 'angularCompilerOptions' as\n           // other options like 'compilerOptions' are merged by TS\n-          let existingNgCompilerOptions: NgCompilerOptions;\n-          if (parentOptions && config.angularCompilerOptions) {\n-            existingNgCompilerOptions = {...config.angularCompilerOptions, ...parentOptions};\n-          } else {\n-            existingNgCompilerOptions = parentOptions || config.angularCompilerOptions;\n-          }\n+          const existingNgCompilerOptions = {...config.angularCompilerOptions, ...parentOptions};\n \n-          if (config.extends) {\n-            let extendedConfigPath = host.resolve(host.dirname(configFile), config.extends);\n-            extendedConfigPath = host.extname(extendedConfigPath) ?\n-                extendedConfigPath :\n-                absoluteFrom(`${extendedConfigPath}.json`);\n+          if (config.extends && typeof config.extends === 'string') {\n+            const extendedConfigPath = getExtendedConfigPath(\n+                configFile, config.extends, host, fs,\n+            );\n \n-            if (host.exists(extendedConfigPath)) {\n+            if (extendedConfigPath !== null) {\n               // Call readAngularCompilerOptions recursively to merge NG Compiler options\n               return readAngularCompilerOptions(extendedConfigPath, existingNgCompilerOptions);\n             }\n@@ -172,13 +168,6 @@ export function readConfiguration(\n           return existingNgCompilerOptions;\n         };\n \n-    const parseConfigHost = {\n-      useCaseSensitiveFileNames: true,\n-      fileExists: host.exists.bind(host),\n-      readDirectory: ts.sys.readDirectory,\n-      readFile: ts.sys.readFile\n-    };\n-\n     const {projectFile, basePath} = calcProjectFileAndBasePath(project, host);\n     const configFileName = host.resolve(host.pwd(), projectFile);\n     const {config, error} = readConfigFile(projectFile);\n@@ -191,13 +180,14 @@ export function readConfiguration(\n         emitFlags: api.EmitFlags.Default\n       };\n     }\n-    const existingCompilerOptions = {\n+    const existingCompilerOptions: api.CompilerOptions = {\n       genDir: basePath,\n       basePath,\n       ...readAngularCompilerOptions(configFileName),\n       ...existingOptions,\n     };\n \n+    const parseConfigHost = createParseConfigHost(host, fs);\n     const {options, errors, fileNames: rootNames, projectReferences} =\n         ts.parseJsonConfigFileContent(\n             config, parseConfigHost, basePath, existingCompilerOptions, configFileName);\n@@ -227,6 +217,47 @@ export function readConfiguration(\n   }\n }\n \n+function createParseConfigHost(host: ConfigurationHost, fs = getFileSystem()): ts.ParseConfigHost {\n+  return {\n+    fileExists: host.exists.bind(host),\n+    readDirectory: ts.sys.readDirectory,\n+    readFile: host.readFile.bind(host),\n+    useCaseSensitiveFileNames: fs.isCaseSensitive(),\n+  };\n+}\n+\n+function getExtendedConfigPath(\n+    configFile: string, extendsValue: string, host: ConfigurationHost,\n+    fs: FileSystem): AbsoluteFsPath|null {\n+  let extendedConfigPath: AbsoluteFsPath|null = null;\n+\n+  if (extendsValue.startsWith('.') || fs.isRooted(extendsValue)) {\n+    extendedConfigPath = host.resolve(host.dirname(configFile), extendsValue);\n+    extendedConfigPath = host.extname(extendedConfigPath) ?\n+        extendedConfigPath :\n+        absoluteFrom(`${extendedConfigPath}.json`);\n+  } else {\n+    const parseConfigHost = createParseConfigHost(host, fs);\n+\n+    // Path isn't a rooted or relative path, resolve like a module.\n+    const {\n+      resolvedModule,\n+    } =\n+        ts.nodeModuleNameResolver(\n+            extendsValue, configFile,\n+            {moduleResolution: ts.ModuleResolutionKind.NodeJs, resolveJsonModule: true},\n+            parseConfigHost);\n+    if (resolvedModule) {\n+      extendedConfigPath = absoluteFrom(resolvedModule.resolvedFileName);\n+    }\n+  }\n+\n+  if (extendedConfigPath !== null && host.exists(extendedConfigPath)) {\n+    return extendedConfigPath;\n+  }\n+\n+  return null;\n+}\n export interface PerformCompilationResult {\n   diagnostics: Diagnostics;\n   program?: api.Program;"
        },
        {
            "sha": "c140f487e9ad6d999305f22c4aa355198e722739",
            "filename": "packages/compiler-cli/test/perform_compile_spec.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/5eb195416bf73f2fa59de52531724d8d19392975/packages%2Fcompiler-cli%2Ftest%2Fperform_compile_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5eb195416bf73f2fa59de52531724d8d19392975/packages%2Fcompiler-cli%2Ftest%2Fperform_compile_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fperform_compile_spec.ts?ref=5eb195416bf73f2fa59de52531724d8d19392975",
            "patch": "@@ -102,4 +102,38 @@ describe('perform_compile', () => {\n       annotateForClosureCompiler: false,\n     }));\n   });\n+\n+  it('should merge tsconfig \"angularCompilerOptions\" when extends point to node package', () => {\n+    support.writeFiles({\n+      'tsconfig-level-1.json': `{\n+          \"extends\": \"@angular-ru/tsconfig\",\n+          \"angularCompilerOptions\": {\n+            \"enableIvy\": false\n+          }\n+        }\n+      `,\n+      'node_modules/@angular-ru/tsconfig/tsconfig.json': `{\n+          \"compilerOptions\": {\n+            \"strict\": true\n+          },\n+          \"angularCompilerOptions\": {\n+            \"skipMetadataEmit\": true\n+          }\n+        }\n+      `,\n+      'node_modules/@angular-ru/tsconfig/package.json': `{\n+        \"name\": \"@angular-ru/tsconfig\",\n+        \"version\": \"0.0.0\",\n+        \"main\": \"./tsconfig.json\"\n+      }\n+    `,\n+    });\n+\n+    const {options} = readConfiguration(path.resolve(basePath, 'tsconfig-level-1.json'));\n+    expect(options).toEqual(jasmine.objectContaining({\n+      strict: true,\n+      skipMetadataEmit: true,\n+      enableIvy: false,\n+    }));\n+  });\n });"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 86,
        "deletions": 21
    }
}