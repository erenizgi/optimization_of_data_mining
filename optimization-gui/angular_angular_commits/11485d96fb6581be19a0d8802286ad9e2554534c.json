{
    "author": "petebacondarwin",
    "message": "fix(ngcc): map `exports` to the current module in UMD files (#38959)\n\nUMD files export values by assigning them to an `exports` variable.\nWhen evaluating expressions ngcc was failing to cope with expressions\nlike `exports.MyComponent`.\n\nThis commit fixes the `UmdReflectionHost.getDeclarationOfIdentifier()`\nmethod to map the `exports` variable to the current source file.\n\nPR Close #38959",
    "sha": "11485d96fb6581be19a0d8802286ad9e2554534c",
    "files": [
        {
            "sha": "51ae53b130361d81228826f4ec7c8990cbab4050",
            "filename": "packages/compiler-cli/ngcc/src/host/umd_host.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 2,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/11485d96fb6581be19a0d8802286ad9e2554534c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/11485d96fb6581be19a0d8802286ad9e2554534c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts?ref=11485d96fb6581be19a0d8802286ad9e2554534c",
            "patch": "@@ -44,8 +44,8 @@ export class UmdReflectionHost extends Esm5ReflectionHost {\n   }\n \n   getDeclarationOfIdentifier(id: ts.Identifier): Declaration|null {\n-    return this.getUmdModuleDeclaration(id) || this.getUmdDeclaration(id) ||\n-        super.getDeclarationOfIdentifier(id);\n+    return this.getExportsDeclaration(id) || this.getUmdModuleDeclaration(id) ||\n+        this.getUmdDeclaration(id) || super.getDeclarationOfIdentifier(id);\n   }\n \n   getExportsOfModule(module: ts.Node): Map<string, Declaration>|null {\n@@ -249,6 +249,29 @@ export class UmdReflectionHost extends Esm5ReflectionHost {\n     return {...declaration, viaModule, known: getTsHelperFnFromIdentifier(id)};\n   }\n \n+  private getExportsDeclaration(id: ts.Identifier): Declaration|null {\n+    if (!isExportIdentifier(id)) {\n+      return null;\n+    }\n+\n+    // Sadly, in the case of `exports.foo = bar`, we can't use `this.findUmdImportParameter(id)` to\n+    // check whether this `exports` is from the IIFE body arguments, because\n+    // `this.checker.getSymbolAtLocation(id)` will return the symbol for the `foo` identifier rather\n+    // than the `exports` identifier.\n+    //\n+    // Instead we search the symbols in the current local scope.\n+    const exportsSymbol = this.checker.getSymbolsInScope(id, ts.SymbolFlags.Variable)\n+                              .find(symbol => symbol.name === 'exports');\n+    if (exportsSymbol !== undefined &&\n+        !ts.isFunctionExpression(exportsSymbol.valueDeclaration.parent)) {\n+      // There is an `exports` symbol in the local scope that is not a function parameter.\n+      // So this `exports` identifier must be a local variable and does not represent the module.\n+      return {node: exportsSymbol.valueDeclaration, viaModule: null, known: null, identity: null};\n+    }\n+\n+    return {node: id.getSourceFile(), viaModule: null, known: null, identity: null};\n+  }\n+\n   private getUmdModuleDeclaration(id: ts.Identifier): Declaration|null {\n     const importPath = this.getImportPathFromParameter(id) || this.getImportPathFromRequireCall(id);\n     if (importPath === null) {\n@@ -370,3 +393,10 @@ function getRequiredModulePath(wrapperFn: ts.FunctionExpression, paramIndex: num\n     }\n   }\n }\n+\n+/**\n+ * Is the `node` an identifier with the name \"exports\"?\n+ */\n+export function isExportIdentifier(node: ts.Node): node is ts.Identifier {\n+  return ts.isIdentifier(node) && node.text === 'exports';\n+}"
        },
        {
            "sha": "7f22966d61efe05ab7c2c66a72f61225c6a09ee0",
            "filename": "packages/compiler-cli/ngcc/test/host/umd_host_spec.ts",
            "status": "modified",
            "additions": 139,
            "deletions": 0,
            "changes": 139,
            "blob_url": "https://github.com/angular/angular/blob/11485d96fb6581be19a0d8802286ad9e2554534c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/11485d96fb6581be19a0d8802286ad9e2554534c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts?ref=11485d96fb6581be19a0d8802286ad9e2554534c",
            "patch": "@@ -14,6 +14,7 @@ import {MockLogger} from '../../../src/ngtsc/logging/testing';\n import {ClassMemberKind, ConcreteDeclaration, CtorParameter, DownleveledEnum, Import, InlineDeclaration, isNamedClassDeclaration, isNamedFunctionDeclaration, isNamedVariableDeclaration, KnownDeclaration, TypeScriptReflectionHost, TypeValueReferenceKind} from '../../../src/ngtsc/reflection';\n import {getDeclaration} from '../../../src/ngtsc/testing';\n import {loadFakeCore, loadTestFiles} from '../../../test/helpers';\n+import {isExportsStatement} from '../../src/host/commonjs_umd_utils';\n import {DelegatingReflectionHost} from '../../src/host/delegating_host';\n import {getIifeBody} from '../../src/host/esm2015_host';\n import {NgccReflectionHost} from '../../src/host/ngcc_host';\n@@ -34,6 +35,7 @@ runInEachFileSystem(() => {\n     let SIMPLE_CLASS_FILE: TestFile;\n     let FOO_FUNCTION_FILE: TestFile;\n     let INLINE_EXPORT_FILE: TestFile;\n+    let EXPORTS_IDENTIFIERS_FILE: TestFile;\n     let INVALID_DECORATORS_FILE: TestFile;\n     let INVALID_DECORATOR_ARGS_FILE: TestFile;\n     let INVALID_PROP_DECORATORS_FILE: TestFile;\n@@ -238,6 +240,33 @@ runInEachFileSystem(() => {\n `,\n       };\n \n+      EXPORTS_IDENTIFIERS_FILE = {\n+        name: _('/exports_identifiers.js'),\n+        contents: `\n+(function (global, factory) {\n+  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/core')) :\n+  typeof define === 'function' && define.amd ? define('foo_function', ['exports', '@angular/core'], factory) :\n+  (factory(global.inline_export,global.ng.core));\n+}(this, (function (exports,core) { 'use strict';\n+  var x = exports;\n+  exports.foo = 42;\n+\n+  function simpleFn() {\n+    exports.foo = 42;\n+  }\n+\n+  function localVar() {\n+    var exports = {};\n+    exports.foo = 42;\n+  }\n+\n+  function exportsArg(exports) {\n+    exports.foo = 42;\n+  }\n+})));\n+`,\n+      };\n+\n       INVALID_DECORATORS_FILE = {\n         name: _('/invalid_decorators.js'),\n         contents: `\n@@ -2078,6 +2107,111 @@ runInEachFileSystem(() => {\n         expect(actualDeclaration!.viaModule).toBe('@angular/core');\n       });\n \n+      it('should return the source file as the declaration of a standalone \"exports\" identifier',\n+         () => {\n+           loadTestFiles([EXPORTS_IDENTIFIERS_FILE]);\n+           const bundle = makeTestBundleProgram(EXPORTS_IDENTIFIERS_FILE.name);\n+           const host = createHost(bundle, new UmdReflectionHost(new MockLogger(), false, bundle));\n+           const xVar = getDeclaration(\n+               bundle.program, EXPORTS_IDENTIFIERS_FILE.name, 'x', ts.isVariableDeclaration);\n+           const exportsIdentifier = xVar.initializer;\n+           if (exportsIdentifier === undefined || !ts.isIdentifier(exportsIdentifier)) {\n+             throw new Error('Bad test - unable to find `var x = exports;` statement');\n+           }\n+           const exportsDeclaration = host.getDeclarationOfIdentifier(exportsIdentifier);\n+           expect(exportsDeclaration).not.toBeNull();\n+           expect(exportsDeclaration!.node).toBe(bundle.file);\n+         });\n+\n+      it('should return the source file as the declaration of \"exports\" in the LHS of a property access',\n+         () => {\n+           loadTestFiles([EXPORTS_IDENTIFIERS_FILE]);\n+           const bundle = makeTestBundleProgram(EXPORTS_IDENTIFIERS_FILE.name);\n+           const host = createHost(bundle, new UmdReflectionHost(new MockLogger(), false, bundle));\n+           const exportsStatement = walkForNode(bundle.file, isExportsStatement);\n+           if (exportsStatement === undefined) {\n+             throw new Error('Bad test - unable to find `exports.foo = 42;` statement');\n+           }\n+           const exportsIdentifier = exportsStatement.expression.left.expression;\n+           const exportDeclaration = host.getDeclarationOfIdentifier(exportsIdentifier);\n+           expect(exportDeclaration).not.toBeNull();\n+           expect(exportDeclaration!.node).toBe(bundle.file);\n+         });\n+\n+      it('should return the source file as the declaration of \"exports\" in the LHS of a property access inside a local function',\n+         () => {\n+           loadTestFiles([EXPORTS_IDENTIFIERS_FILE]);\n+           const bundle = makeTestBundleProgram(EXPORTS_IDENTIFIERS_FILE.name);\n+           const host = createHost(bundle, new UmdReflectionHost(new MockLogger(), false, bundle));\n+           const simpleFn = getDeclaration(\n+               bundle.program, EXPORTS_IDENTIFIERS_FILE.name, 'simpleFn', ts.isFunctionDeclaration);\n+           const exportsStatement = walkForNode(simpleFn, isExportsStatement);\n+           if (exportsStatement === undefined) {\n+             throw new Error('Bad test - unable to find `exports.foo = 42;` statement');\n+           }\n+           const exportsIdentifier = exportsStatement.expression.left.expression;\n+           const exportDeclaration = host.getDeclarationOfIdentifier(exportsIdentifier);\n+           expect(exportDeclaration).not.toBeNull();\n+           expect(exportDeclaration!.node).toBe(bundle.file);\n+         });\n+\n+      it('should return the variable declaration if a standalone \"exports\" is declared locally',\n+         () => {\n+           loadTestFiles([EXPORTS_IDENTIFIERS_FILE]);\n+           const bundle = makeTestBundleProgram(EXPORTS_IDENTIFIERS_FILE.name);\n+           const host = createHost(bundle, new UmdReflectionHost(new MockLogger(), false, bundle));\n+           const localVarFn = getDeclaration(\n+               bundle.program, EXPORTS_IDENTIFIERS_FILE.name, 'localVar', ts.isFunctionDeclaration);\n+           const exportsVar = walkForNode(localVarFn, ts.isVariableDeclaration);\n+           if (exportsVar === undefined) {\n+             throw new Error('Bad test - unable to find `var exports = {}` statement');\n+           }\n+           const exportsIdentifier = exportsVar.name;\n+           if (exportsIdentifier === undefined || !ts.isIdentifier(exportsIdentifier)) {\n+             throw new Error('Bad test - unable to find `var exports = {};` statement');\n+           }\n+           const exportsDeclaration = host.getDeclarationOfIdentifier(exportsIdentifier);\n+           expect(exportsDeclaration).not.toBeNull();\n+           expect(exportsDeclaration!.node).toBe(exportsVar);\n+         });\n+\n+      it('should return the variable declaration of \"exports\" in the LHS of a property access, if it is declared locally',\n+         () => {\n+           loadTestFiles([EXPORTS_IDENTIFIERS_FILE]);\n+           const bundle = makeTestBundleProgram(EXPORTS_IDENTIFIERS_FILE.name);\n+           const host = createHost(bundle, new UmdReflectionHost(new MockLogger(), false, bundle));\n+           const localVarFn = getDeclaration(\n+               bundle.program, EXPORTS_IDENTIFIERS_FILE.name, 'localVar', ts.isFunctionDeclaration);\n+           const exportsVar = walkForNode(localVarFn, ts.isVariableDeclaration);\n+           const exportsStatement = walkForNode(localVarFn, isExportsStatement);\n+           if (exportsStatement === undefined) {\n+             throw new Error('Bad test - unable to find `exports.foo = 42;` statement');\n+           }\n+           const exportsIdentifier = exportsStatement.expression.left.expression;\n+           const exportDeclaration = host.getDeclarationOfIdentifier(exportsIdentifier);\n+           expect(exportDeclaration).not.toBeNull();\n+           expect(exportDeclaration?.node).toBe(exportsVar);\n+         });\n+\n+      it('should return the variable declaration of \"exports\" in the LHS of a property access, if it is a local function parameter',\n+         () => {\n+           loadTestFiles([EXPORTS_IDENTIFIERS_FILE]);\n+           const bundle = makeTestBundleProgram(EXPORTS_IDENTIFIERS_FILE.name);\n+           const host = createHost(bundle, new UmdReflectionHost(new MockLogger(), false, bundle));\n+           const exportsArgFn = getDeclaration(\n+               bundle.program, EXPORTS_IDENTIFIERS_FILE.name, 'exportsArg',\n+               ts.isFunctionDeclaration);\n+           const exportsVar = exportsArgFn.parameters[0];\n+           const exportsStatement = walkForNode(exportsArgFn, isExportsStatement);\n+           if (exportsStatement === undefined) {\n+             throw new Error('Bad test - unable to find `exports.foo = 42;` statement');\n+           }\n+           const exportsIdentifier = exportsStatement.expression.left.expression;\n+           const exportDeclaration = host.getDeclarationOfIdentifier(exportsIdentifier);\n+           expect(exportDeclaration).not.toBeNull();\n+           expect(exportDeclaration?.node).toBe(exportsVar);\n+         });\n+\n       it('should recognize TypeScript helpers (as function declarations)', () => {\n         const file: TestFile = {\n           name: _('/test.js'),\n@@ -3232,3 +3366,8 @@ runInEachFileSystem(() => {\n     });\n   });\n });\n+\n+type WalkerPredicate<T extends ts.Node> = (node: ts.Node) => node is T;\n+function walkForNode<T extends ts.Node>(node: ts.Node, predicate: WalkerPredicate<T>): T|undefined {\n+  return node.forEachChild(child => predicate(child) ? child : walkForNode(child, predicate));\n+}"
        }
    ],
    "stats": {
        "total": 173,
        "additions": 171,
        "deletions": 2
    }
}