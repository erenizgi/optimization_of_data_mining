{
    "author": "gkalpak",
    "message": "feat(docs-infra): add more granular support for configuring Firebase redirects at deployment (#43963)\n\nPreviously, there was a `deploy-to-firebase` pre-deploy action for\nconfiguring Firebase to redirect non-file requests to `angular.io`. This\nis used for ensuring that `rc.angular.io` is correctly redirected to\n`angular.io`, even when people have previously visited (and have a\nServiceWorker activated on) `rc.angular.io`.\n\nThis commit adds pre-deploy actions for configuring Firebase to redirect\na deployment to any of `angular.io`, `rc.angular.io` or\n`next.angular.io` and also configure whether all requests or only\nnon-file requests will be redirected.\nIn a future commit, this will allow managing redirects for the `stable`,\n`rc` and `next` deployments via the Firebase config file (without\nrequiring changes in the Firebase console or DNS).\n\nPR Close #43963",
    "sha": "ea676514e9f10a087c637680e62281220e12e3c0",
    "files": [
        {
            "sha": "156eadb68b9ac674baef528fbf9881a46af3545c",
            "filename": "aio/scripts/deploy-to-firebase/index.mjs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "raw_url": "https://github.com/angular/angular/raw/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs?ref=ea676514e9f10a087c637680e62281220e12e3c0",
            "patch": "@@ -151,7 +151,7 @@ function computeDeploymentsInfo(\n       projectId: 'angular-io',\n       siteId: 'rc-angular-io-site',\n       deployedUrl: 'https://rc.angular.io/',\n-      preDeployActions: [pre.disableServiceWorker, pre.redirectToAngularIo],\n+      preDeployActions: [pre.disableServiceWorker, pre.redirectNonFilesToStable],\n       postDeployActions: [post.testNoActiveRcDeployment],\n     },\n   };"
        },
        {
            "sha": "44c5a990e3aec5b1f7eb6742dfd2e153325e4436",
            "filename": "aio/scripts/deploy-to-firebase/index.spec.mjs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs?ref=ea676514e9f10a087c637680e62281220e12e3c0",
            "patch": "@@ -166,7 +166,7 @@ describe('deploy-to-firebase:', () => {\n         projectId: 'angular-io',\n         siteId: 'rc-angular-io-site',\n         deployedUrl: 'https://rc.angular.io/',\n-        preDeployActions: ['function:disableServiceWorker', 'function:redirectToAngularIo'],\n+        preDeployActions: ['function:disableServiceWorker', 'function:redirectNonFilesToStable'],\n         postDeployActions: ['function:testNoActiveRcDeployment'],\n       },\n     ]);"
        },
        {
            "sha": "b8486bd83a6342d0e0eb5c551e040f73f5fd0323",
            "filename": "aio/scripts/deploy-to-firebase/pre-deploy-actions.mjs",
            "status": "modified",
            "additions": 48,
            "deletions": 25,
            "changes": 73,
            "blob_url": "https://github.com/angular/angular/blob/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.mjs",
            "raw_url": "https://github.com/angular/angular/raw/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.mjs?ref=ea676514e9f10a087c637680e62281220e12e3c0",
            "patch": "@@ -14,14 +14,21 @@ const exp = {\n   build,\n   checkPayloadSize,\n   disableServiceWorker,\n-  redirectToAngularIo,\n   undo: {\n     build: undoBuild,\n     checkPayloadSize: undoCheckPayloadSize,\n     disableServiceWorker: undoDisableServiceWorker,\n-    redirectToAngularIo: undoRedirectToAngularIo,\n   },\n };\n+Object.keys(u.ORIGINS).forEach(originLabel => {\n+  [true, false].forEach(allRequests => {\n+    const redirectFn = generateFn_redirectTo(originLabel, allRequests);\n+    const undoRedirectFn = generateFn_undoRedirectTo(originLabel, allRequests);\n+\n+    exp[redirectFn.name] = redirectFn;\n+    exp.undo[redirectFn.name] = undoRedirectFn;\n+  });\n+});\n export default exp;\n \n // Helpers\n@@ -53,21 +60,49 @@ function escapeForRegex(str) {\n   return str.replace(/[.?*+\\\\|^$()[\\]{}]/g, '\\\\$&');\n }\n \n-function getFirebaseRedirectRuleTo(origin) {\n-  return `{\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"${origin}:1\"}`;\n+function generateFn_redirectTo(originLabel, allRequests) {\n+  const destinationOrigin = u.ORIGINS[originLabel];\n+  const functionName = `redirect${allRequests ? 'All' : 'NonFiles'}To${originLabel}`;\n+\n+  return u.nameFunction(functionName, function () {\n+    u.logSectionHeader(\n+        `Configure Firebase hosting to redirect ${allRequests ? 'all' : 'non-file'} requests ` +\n+        `to '${destinationOrigin}'.`);\n+\n+    // Update the Firebase hosting configuration to redirect requests to the specific origin.\n+    // If `excludeFileRequests` is `true`, only redirect non-file requests, i.e. requests that\n+    // do not contain a dot in their last path segment.\n+    // See also https://firebase.google.com/docs/hosting/full-config#redirects.\n+    const redirectRule = getFirebaseRedirectRuleTo(destinationOrigin, allRequests);\n+    const oldContent = fs.readFileSync(FIREBASE_JSON_PATH, 'utf8');\n+    const newContent = oldContent.replace(/( *)\"redirects\": \\[/, `$&\\n$1  ${redirectRule},\\n`);\n+\n+    fs.writeFileSync(FIREBASE_JSON_PATH, newContent);\n+  });\n }\n \n-function redirectToAngularIo() {\n-  u.logSectionHeader('Configure Firebase hosting to redirect to https://angular.io/.');\n+function generateFn_undoRedirectTo(originLabel, allRequests) {\n+  const destinationOrigin = u.ORIGINS[originLabel];\n+  const functionName = `undoRedirect${allRequests ? 'All' : 'NonFiles'}To${originLabel}`;\n \n-  // Update the Firebase hosting configuration to redirect all non-file requests (i.e. requests that\n-  // do not contain a dot in their last path segment) to `angular.io`.\n-  // See https://firebase.google.com/docs/hosting/full-config#redirects.\n-  const redirectRule = getFirebaseRedirectRuleTo('https://angular.io');\n-  const oldContent = fs.readFileSync(FIREBASE_JSON_PATH, 'utf8');\n-  const newContent = oldContent.replace(/( *)\"redirects\": \\[/, `$&\\n$1  ${redirectRule},\\n`);\n+  return u.nameFunction(functionName, function () {\n+    u.logSectionHeader(\n+        `Remove Firebase hosting redirect for ${allRequests ? 'all' : 'non-file'} requests to ` +\n+        `'${destinationOrigin}'.`);\n \n-  fs.writeFileSync(FIREBASE_JSON_PATH, newContent);\n+    const redirectRule = getFirebaseRedirectRuleTo(destinationOrigin, allRequests);\n+    const oldContent = fs.readFileSync(FIREBASE_JSON_PATH, 'utf8');\n+    const newContent = oldContent.replace(\n+        new RegExp(`(( *)\"redirects\": \\\\[)\\\\n\\\\2  ${escapeForRegex(redirectRule)},\\\\n`),\n+        '$1');\n+\n+    fs.writeFileSync(FIREBASE_JSON_PATH, newContent);\n+  });\n+}\n+\n+function getFirebaseRedirectRuleTo(origin, allRequests) {\n+  const re = allRequests ? '^(.*)$' : '^(.*/[^./]*)$';\n+  return `{\"type\": 302, \"regex\": \"${re}\", \"destination\": \"${origin}:1\"}`;\n }\n \n function undoBuild() {\n@@ -83,15 +118,3 @@ function undoDisableServiceWorker() {\n   u.logSectionHeader('Re-enable the ServiceWorker.');\n   sh.mv(NGSW_JSON_BAK_PATH, NGSW_JSON_PATH);\n }\n-\n-function undoRedirectToAngularIo() {\n-  u.logSectionHeader('Remove Firebase hosting redirect to https://angular.io/.');\n-\n-  const redirectRule = getFirebaseRedirectRuleTo('https://angular.io');\n-  const oldContent = fs.readFileSync(FIREBASE_JSON_PATH, 'utf8');\n-  const newContent = oldContent.replace(\n-      new RegExp(`(( *)\"redirects\": \\\\[)\\\\n\\\\2  ${escapeForRegex(redirectRule)},\\\\n`),\n-      '$1');\n-\n-  fs.writeFileSync(FIREBASE_JSON_PATH, newContent);\n-}"
        },
        {
            "sha": "cfcbfe57b644417c4aef2f9adde5d5dbefa203a4",
            "filename": "aio/scripts/deploy-to-firebase/pre-deploy-actions.spec.mjs",
            "status": "modified",
            "additions": 106,
            "deletions": 92,
            "changes": 198,
            "blob_url": "https://github.com/angular/angular/blob/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.spec.mjs?ref=ea676514e9f10a087c637680e62281220e12e3c0",
            "patch": "@@ -85,52 +85,59 @@ describe('deploy-to-firebase/pre-deploy-actions:', () => {\n     });\n   });\n \n-  describe('redirectToAngularIo()', () => {\n-    let readFileSpy;\n-    let writeFileSpy;\n-\n-    beforeEach(() => {\n-      readFileSpy = spyOn(fs, 'readFileSync').and.returnValue('Test file content.');\n-      writeFileSpy = spyOn(fs, 'writeFileSync');\n-    });\n-\n-    it('should read from and write to the Firebase config file', () => {\n-      pre.redirectToAngularIo();\n-\n-      expect(readFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'utf8');\n-      expect(writeFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'Test file content.');\n-    });\n-\n-    it('should add a redirect rule to `angular.io`', () => {\n-      readFileSpy.and.returnValue(`\n-        {\n-          \"foo\": \"bar\",\n-          \"hosting\": {\n-            \"baz\": \"qux\",\n-            \"redirects\": [\n-              {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n-              {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n-            ]\n-          }\n-        }\n-      `);\n-\n-      pre.redirectToAngularIo();\n-\n-      expect(writeFileSpy.calls.first().args[1]).toBe(`\n-        {\n-          \"foo\": \"bar\",\n-          \"hosting\": {\n-            \"baz\": \"qux\",\n-            \"redirects\": [\n-              {\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"https://angular.io:1\"},\n-\n-              {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n-              {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n-            ]\n-          }\n-        }\n-      `);\n+  Object.entries(u.ORIGINS).forEach(([originLabel, origin]) => {\n+    [true, false].forEach(allRequests => {\n+      const redirectToFnName = `redirect${allRequests ? 'All' : 'NonFiles'}To${originLabel}`;\n+\n+      describe(`${redirectToFnName}()`, () => {\n+        let readFileSpy;\n+        let writeFileSpy;\n+\n+        beforeEach(() => {\n+          readFileSpy = spyOn(fs, 'readFileSync').and.returnValue('Test file content.');\n+          writeFileSpy = spyOn(fs, 'writeFileSync');\n+        });\n+\n+        it('should read from and write to the Firebase config file', () => {\n+          pre[redirectToFnName]();\n+\n+          expect(readFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'utf8');\n+          expect(writeFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'Test file content.');\n+        });\n+\n+        it(`should add a redirect rule to '${origin}'`, () => {\n+          const re = allRequests ? '^(.*)$' : '^(.*/[^./]*)$';\n+          readFileSpy.and.returnValue(`\n+            {\n+              \"foo\": \"bar\",\n+              \"hosting\": {\n+                \"baz\": \"qux\",\n+                \"redirects\": [\n+                  {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n+                  {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n+                ]\n+              }\n+            }\n+          `);\n+\n+          pre[redirectToFnName]();\n+\n+          expect(writeFileSpy.calls.first().args[1]).toBe(`\n+            {\n+              \"foo\": \"bar\",\n+              \"hosting\": {\n+                \"baz\": \"qux\",\n+                \"redirects\": [\n+                  {\"type\": 302, \"regex\": \"${re}\", \"destination\": \"${origin}:1\"},\n+\n+                  {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n+                  {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n+                ]\n+              }\n+            }\n+          `);\n+        });\n+      });\n     });\n   });\n \n@@ -160,52 +167,59 @@ describe('deploy-to-firebase/pre-deploy-actions:', () => {\n     });\n   });\n \n-  describe('undo.redirectToAngularIo()', () => {\n-    let readFileSpy;\n-    let writeFileSpy;\n-\n-    beforeEach(() => {\n-      readFileSpy = spyOn(fs, 'readFileSync').and.returnValue('Test file content.');\n-      writeFileSpy = spyOn(fs, 'writeFileSync');\n-    });\n-\n-    it('should read from and write to the Firebase config file', () => {\n-      pre.undo.redirectToAngularIo();\n-\n-      expect(readFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'utf8');\n-      expect(writeFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'Test file content.');\n-    });\n-\n-    it('should remove a redirect rule to `angular.io`', () => {\n-      readFileSpy.and.returnValue(`\n-        {\n-          \"foo\": \"bar\",\n-          \"hosting\": {\n-            \"baz\": \"qux\",\n-            \"redirects\": [\n-              {\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"https://angular.io:1\"},\n-\n-              {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n-              {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n-            ]\n-          }\n-        }\n-      `);\n-\n-      pre.undo.redirectToAngularIo();\n-\n-      expect(writeFileSpy.calls.first().args[1]).toBe(`\n-        {\n-          \"foo\": \"bar\",\n-          \"hosting\": {\n-            \"baz\": \"qux\",\n-            \"redirects\": [\n-              {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n-              {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n-            ]\n-          }\n-        }\n-      `);\n+  Object.entries(u.ORIGINS).forEach(([originLabel, origin]) => {\n+    [true, false].forEach(allRequests => {\n+      const redirectToFnName = `redirect${allRequests ? 'All' : 'NonFiles'}To${originLabel}`;\n+\n+      describe(`undo.${redirectToFnName}()`, () => {\n+        let readFileSpy;\n+        let writeFileSpy;\n+\n+        beforeEach(() => {\n+          readFileSpy = spyOn(fs, 'readFileSync').and.returnValue('Test file content.');\n+          writeFileSpy = spyOn(fs, 'writeFileSync');\n+        });\n+\n+        it('should read from and write to the Firebase config file', () => {\n+          pre.undo[redirectToFnName]();\n+\n+          expect(readFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'utf8');\n+          expect(writeFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'Test file content.');\n+        });\n+\n+        it('should remove a redirect rule to `angular.io`', () => {\n+          const re = allRequests ? '^(.*)$' : '^(.*/[^./]*)$';\n+          readFileSpy.and.returnValue(`\n+            {\n+              \"foo\": \"bar\",\n+              \"hosting\": {\n+                \"baz\": \"qux\",\n+                \"redirects\": [\n+                  {\"type\": 302, \"regex\": \"${re}\", \"destination\": \"${origin}:1\"},\n+\n+                  {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n+                  {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n+                ]\n+              }\n+            }\n+          `);\n+\n+          pre.undo[redirectToFnName]();\n+\n+          expect(writeFileSpy.calls.first().args[1]).toBe(`\n+            {\n+              \"foo\": \"bar\",\n+              \"hosting\": {\n+                \"baz\": \"qux\",\n+                \"redirects\": [\n+                  {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n+                  {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n+                ]\n+              }\n+            }\n+          `);\n+        });\n+      });\n     });\n   });\n });"
        },
        {
            "sha": "c1df41cf38aadb9a9122e8d1706e7b2812daf6d8",
            "filename": "aio/scripts/deploy-to-firebase/utils.mjs",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.mjs",
            "raw_url": "https://github.com/angular/angular/raw/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.mjs?ref=ea676514e9f10a087c637680e62281220e12e3c0",
            "patch": "@@ -6,12 +6,18 @@ import {fileURLToPath} from 'url';\n // Constants\n const REPO_SLUG = 'angular/angular';\n const NG_REMOTE_URL = `https://github.com/${REPO_SLUG}.git`;\n+const ORIGINS = {\n+  Next: 'https://next.angular.io',\n+  Rc: 'https://rc.angular.io',\n+  Stable: 'https://angular.io',\n+};\n const _GIT_REMOTE_REFS_CACHE = new Map();\n \n // Exports\n const exp = {\n   _GIT_REMOTE_REFS_CACHE,\n   NG_REMOTE_URL,\n+  ORIGINS,\n   REPO_SLUG,\n \n   computeMajorVersion,\n@@ -20,6 +26,7 @@ const exp = {\n   getMostRecentMinorBranch,\n   getRemoteRefs,\n   logSectionHeader,\n+  nameFunction,\n   yarn,\n };\n export default exp;\n@@ -79,6 +86,12 @@ function logSectionHeader(message) {\n   console.log(`\\n\\n\\n==== ${message} ====\\n`);\n }\n \n+function nameFunction(name, fn) {\n+  // Overwrite the function's `name` property to make debugging easier (and allow tests that relied\n+  // on `Function#name` to continue to work for dynamically generated functions).\n+  return Object.defineProperty(fn, 'name', {value: name});\n+}\n+\n function yarn(cmd) {\n   // Using `--silent` to ensure no secret env variables are printed.\n   //"
        },
        {
            "sha": "e19ed35cf33bdb79ab877a745a078008c9e94008",
            "filename": "aio/scripts/deploy-to-firebase/utils.spec.mjs",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/ea676514e9f10a087c637680e62281220e12e3c0/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.spec.mjs?ref=ea676514e9f10a087c637680e62281220e12e3c0",
            "patch": "@@ -237,6 +237,36 @@ describe('deploy-to-firebase/utils:', () => {\n     });\n   });\n \n+  describe('nameFunction()', () => {\n+    it('should overwrite a function\\'s name', () => {\n+      function foo() {}\n+      const bar = () => {};\n+      const baz = ({baz() {}}).baz;\n+\n+      expect(foo.name).toBe('foo');\n+      expect(bar.name).toBe('bar');\n+      expect(baz.name).toBe('baz');\n+\n+      u.nameFunction('foo2', foo);\n+      u.nameFunction('bar2', bar);\n+      u.nameFunction('baz2', baz);\n+\n+      expect(foo.name).toBe('foo2');\n+      expect(bar.name).toBe('bar2');\n+      expect(baz.name).toBe('baz2');\n+    });\n+\n+    it('should return the function', () => {\n+      function foo() {}\n+      const bar = () => {};\n+      const baz = ({baz() {}}).baz;\n+\n+      expect(u.nameFunction('foo2', foo)).toBe(foo);\n+      expect(u.nameFunction('bar2', bar)).toBe(bar);\n+      expect(u.nameFunction('baz2', baz)).toBe(baz);\n+    });\n+  });\n+\n   describe('yarn()', () => {\n     let execSpy;\n "
        }
    ],
    "stats": {
        "total": 318,
        "additions": 199,
        "deletions": 119
    }
}