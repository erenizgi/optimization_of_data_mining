{
    "author": "JoostK",
    "message": "test(compiler-cli): run the linker transform in the compliance test's prelink target (#39518)\n\nIn PR #38938 an additional Bazel target was introduced for the compliance\ntests, as preparation to run the compliance tests in partial compilation\nmode and then apply the linker transform. The linker plugin itself was\nnot available at the time but has since been implemented, so this commit\nupdates the prelink target of the compliance tests to apply the linker\ntransform using the Babel plugin.\n\nActually emitting partial compilations to be transformed will be done in\nfollow-up work.\n\nPR Close #39518",
    "sha": "ded7beed3241714373536ae7d76450d0b3ee2a5f",
    "files": [
        {
            "sha": "95c50391ead619b431becae6d9c8120f59daf79c",
            "filename": "packages/compiler-cli/test/compliance/mock_compile/index.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/ded7beed3241714373536ae7d76450d0b3ee2a5f/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fmock_compile%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/ded7beed3241714373536ae7d76450d0b3ee2a5f/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fmock_compile%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fmock_compile%2Findex.ts?ref=ded7beed3241714373536ae7d76450d0b3ee2a5f",
            "patch": "@@ -196,10 +196,10 @@ function buildMatcher(pieces: (string|RegExp)[]): {regexp: RegExp, groups: Map<s\n   };\n }\n \n-export function doCompile(\n+export function compileFiles(\n     data: MockDirectory, angularFiles: MockData, options: NgCompilerOptions = {}): {\n-  source: string,\n-} {\n+  fileName: string; source: string,\n+}[] {\n   setFileSystem(new NodeJSFileSystem());\n   const testFiles = toMockFileArray(data);\n   const scripts = testFiles.map(entry => entry.fileName);\n@@ -217,8 +217,18 @@ export function doCompile(\n       },\n       mockCompilerHost);\n   program.emit();\n-  const source =\n-      scripts.map(script => mockCompilerHost.readFile(script.replace(/\\.ts$/, '.js'))).join('\\n');\n+  return scripts.map(script => {\n+    const fileName = script.replace(/\\.ts$/, '.js');\n+    const source = mockCompilerHost.readFile(fileName);\n+    return {fileName, source};\n+  });\n+}\n+\n+function doCompile(data: MockDirectory, angularFiles: MockData, options: NgCompilerOptions = {}): {\n+  source: string,\n+} {\n+  const scripts = compileFiles(data, angularFiles, options);\n+  const source = scripts.map(script => script.source).join('\\n');\n \n   return {source};\n }"
        },
        {
            "sha": "d4a988f8e8312562069598e5cd57af80d99d69d4",
            "filename": "packages/compiler-cli/test/compliance/prelink/BUILD.bazel",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/ded7beed3241714373536ae7d76450d0b3ee2a5f/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/ded7beed3241714373536ae7d76450d0b3ee2a5f/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2FBUILD.bazel?ref=ded7beed3241714373536ae7d76450d0b3ee2a5f",
            "patch": "@@ -6,7 +6,15 @@ ts_library(\n     srcs = [\"bootstrap.ts\"],\n     deps = [\n         \"//packages:types\",\n+        \"//packages/compiler-cli/linker/babel\",\n         \"//packages/compiler-cli/test/compliance/mock_compile\",\n+        \"@npm//@babel/core\",\n+        \"@npm//@babel/generator\",\n+        \"@npm//@babel/template\",\n+        \"@npm//@babel/types\",\n+        \"@npm//@types/babel__core\",\n+        \"@npm//@types/babel__generator\",\n+        \"@npm//@types/babel__template\",\n     ],\n )\n "
        },
        {
            "sha": "527d6e881f2f27379d739b04cedb3dc646653e43",
            "filename": "packages/compiler-cli/test/compliance/prelink/bootstrap.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 4,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/ded7beed3241714373536ae7d76450d0b3ee2a5f/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2Fbootstrap.ts",
            "raw_url": "https://github.com/angular/angular/raw/ded7beed3241714373536ae7d76450d0b3ee2a5f/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2Fbootstrap.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2Fbootstrap.ts?ref=ded7beed3241714373536ae7d76450d0b3ee2a5f",
            "patch": "@@ -5,7 +5,10 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {CompileFn, doCompile, setCompileFn} from '../mock_compile';\n+import {PluginObj, transformSync} from '@babel/core';\n+\n+import {createEs2015LinkerPlugin} from '../../../linker/babel';\n+import {compileFiles, CompileFn, setCompileFn} from '../mock_compile';\n \n /**\n  * A function to compile the given code in two steps:\n@@ -16,11 +19,43 @@ import {CompileFn, doCompile, setCompileFn} from '../mock_compile';\n  * This should produce the same output as the full AOT compilation\n  */\n const linkedCompile: CompileFn = (data, angularFiles, options) => {\n-  const result = doCompile(data, angularFiles, {...options, compilationMode: 'partial'});\n-  // TODO: additional post linking\n-  return result;\n+  const compiledFiles = compileFiles(data, angularFiles, {...options, compilationMode: 'partial'});\n+\n+  const linkerPlugin = createEs2015LinkerPlugin({\n+    enableI18nLegacyMessageIdFormat: options?.enableI18nLegacyMessageIdFormat,\n+    i18nNormalizeLineEndingsInICUs: options?.i18nNormalizeLineEndingsInICUs,\n+  });\n+\n+  const source = compiledFiles.map(file => applyLinker(file, linkerPlugin)).join('\\n');\n+\n+  return {source};\n };\n \n+/**\n+ * Runs the provided code through the Babel linker plugin, if the file has the .js extension.\n+ *\n+ * @param file The file name and its source to be transformed using the linker.\n+ * @param linkerPlugin The linker plugin to apply.\n+ * @returns The file's source content, which has been transformed using the linker if necessary.\n+ */\n+function applyLinker(file: {fileName: string; source: string}, linkerPlugin: PluginObj): string {\n+  if (!file.fileName.endsWith('.js')) {\n+    return file.source;\n+  }\n+  const result = transformSync(file.source, {\n+    filename: file.fileName,\n+    plugins: [linkerPlugin],\n+    parserOpts: {sourceType: 'unambiguous'},\n+  });\n+  if (result === null) {\n+    throw fail('Babel transform did not have output');\n+  }\n+  if (result.code == null) {\n+    throw fail('Babel transform result does not have any code');\n+  }\n+  return result.code;\n+}\n+\n // Update the function that will do the compiling with this specialised version that\n // runs the prelink and postlink parts of AOT compilation, to check it produces the\n // same result as a normal full AOT compile."
        }
    ],
    "stats": {
        "total": 71,
        "additions": 62,
        "deletions": 9
    }
}