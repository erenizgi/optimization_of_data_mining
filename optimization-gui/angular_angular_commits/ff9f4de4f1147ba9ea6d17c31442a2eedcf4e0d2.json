{
    "author": "josephperrott",
    "message": "fix(compiler): update unparsable character reference entity error messages (#38319)\n\nWithin an angular template, when a character entity is unable to be parsed, previously a generic\nunexpected character error was thrown.  This does not properly express the issue that was discovered\nas the issue is actually caused by the discovered character making the whole of the entity unparsable.\nThe compiler will now instead inform via the error message what string was attempted to be parsed\nand what it was attempted to be parsed as.\n\nExample, for this template:\n```\n<p>\n  &#x123p\n</p>\n```\nBefore this change:\n`Unexpected character \"p\"`\n\nAfter this change:\n`Unable to parse entity \"&#x123p\" - hexadecimal character reference entities must end with \";\"`\n\nFixes #26067\n\nPR Close #38319",
    "sha": "ff9f4de4f1147ba9ea6d17c31442a2eedcf4e0d2",
    "files": [
        {
            "sha": "38a82a7d23f6a3d3015aa06b0a30bb3ed22955bf",
            "filename": "packages/compiler/src/ml_parser/lexer.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/ff9f4de4f1147ba9ea6d17c31442a2eedcf4e0d2/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff9f4de4f1147ba9ea6d17c31442a2eedcf4e0d2/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts?ref=ff9f4de4f1147ba9ea6d17c31442a2eedcf4e0d2",
            "patch": "@@ -138,6 +138,16 @@ function _unknownEntityErrorMsg(entitySrc: string): string {\n   return `Unknown entity \"${entitySrc}\" - use the \"&#<decimal>;\" or  \"&#x<hex>;\" syntax`;\n }\n \n+function _unparsableEntityErrorMsg(type: CharacterReferenceType, entityStr: string): string {\n+  return `Unable to parse entity \"${entityStr}\" - ${\n+      type} character reference entities must end with \";\"`;\n+}\n+\n+enum CharacterReferenceType {\n+  HEX = 'hexadecimal',\n+  DEC = 'decimal',\n+}\n+\n class _ControlFlowError {\n   constructor(public error: TokenError) {}\n }\n@@ -400,8 +410,13 @@ class _Tokenizer {\n       const codeStart = this._cursor.clone();\n       this._attemptCharCodeUntilFn(isDigitEntityEnd);\n       if (this._cursor.peek() != chars.$SEMICOLON) {\n+        // Advance cursor to include the peeked character in the string provided to the error\n+        // message.\n+        this._cursor.advance();\n+        const entityType = isHex ? CharacterReferenceType.HEX : CharacterReferenceType.DEC;\n         throw this._createError(\n-            _unexpectedCharacterErrorMsg(this._cursor.peek()), this._cursor.getSpan());\n+            _unparsableEntityErrorMsg(entityType, this._cursor.getChars(start)),\n+            this._cursor.getSpan());\n       }\n       const strNum = this._cursor.getChars(codeStart);\n       this._cursor.advance();"
        },
        {
            "sha": "32895b12eabd1f208628b94100c919424f22b219",
            "filename": "packages/compiler/test/ml_parser/lexer_spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/ff9f4de4f1147ba9ea6d17c31442a2eedcf4e0d2/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff9f4de4f1147ba9ea6d17c31442a2eedcf4e0d2/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts?ref=ff9f4de4f1147ba9ea6d17c31442a2eedcf4e0d2",
            "patch": "@@ -477,12 +477,16 @@ import {ParseLocation, ParseSourceFile, ParseSourceSpan} from '../../src/parse_u\n           lex.TokenType.TEXT,\n           'Unknown entity \"tbo\" - use the \"&#<decimal>;\" or  \"&#x<hex>;\" syntax', '0:0'\n         ]]);\n-        expect(tokenizeAndHumanizeErrors('&#3sdf;')).toEqual([\n-          [lex.TokenType.TEXT, 'Unexpected character \"s\"', '0:3']\n-        ]);\n-        expect(tokenizeAndHumanizeErrors('&#xasdf;')).toEqual([\n-          [lex.TokenType.TEXT, 'Unexpected character \"s\"', '0:4']\n-        ]);\n+        expect(tokenizeAndHumanizeErrors('&#3sdf;')).toEqual([[\n+          lex.TokenType.TEXT,\n+          'Unable to parse entity \"&#3s\" - decimal character reference entities must end with \";\"',\n+          '0:4'\n+        ]]);\n+        expect(tokenizeAndHumanizeErrors('&#xasdf;')).toEqual([[\n+          lex.TokenType.TEXT,\n+          'Unable to parse entity \"&#xas\" - hexadecimal character reference entities must end with \";\"',\n+          '0:5'\n+        ]]);\n \n         expect(tokenizeAndHumanizeErrors('&#xABC')).toEqual([\n           [lex.TokenType.TEXT, 'Unexpected character \"EOF\"', '0:6']"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 26,
        "deletions": 7
    }
}