{
    "author": "alxhub",
    "message": "build: emit performance JSON file for each ng_module() (#41125)\n\nA previous commit implemented a streamlined performance metric reporting\nsystem for the compiler-cli, controlled via the compiler option\n`tracePerformance`.\n\nThis commit adds a custom Bazel flag rule //packages/compiler-cli:ng_perf\nto the repository, and wires it through to the `ng_module` implementation\nsuch that if the flag is set, `ng_module` will produce perf results as part\nof the build. The underlying mechanism of `//:ng_perf` is not exported from\n`@angular/bazel` as a public rule that consumers can use, so there is little\nrisk of accidental dependency on the contents of these perf traces.\n\nAn alias is added so that `--ng_perf` is a Bazel flag which works in our\nrepository.\n\nPR Close #41125",
    "sha": "b61c009c5479812b061c6837e1fdbf645deea4f1",
    "files": [
        {
            "sha": "6f7a24ff894287b63bfd0dae8963263571edb9fe",
            "filename": ".bazelrc",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/b61c009c5479812b061c6837e1fdbf645deea4f1/.bazelrc",
            "raw_url": "https://github.com/angular/angular/raw/b61c009c5479812b061c6837e1fdbf645deea4f1/.bazelrc",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.bazelrc?ref=b61c009c5479812b061c6837e1fdbf645deea4f1",
            "patch": "@@ -140,6 +140,13 @@ build:remote --remote_executor=remotebuildexecution.googleapis.com\n # retry mechanism and we do not want to retry unnecessarily if Karma already tried multiple times.\n test:saucelabs --flaky_test_attempts=1\n \n+################\n+# Flag Aliases #\n+################\n+\n+# --ng_perf will ask the Ivy compiler to produce performance results for each build.\n+build --flag_alias=ng_perf=//packages/compiler-cli:ng_perf\n+\n ####################################################\n # User bazel configuration\n # NOTE: This needs to be the *last* entry in the config."
        },
        {
            "sha": "3c43d9f1cc6d757cfbbf03d9abdcb30b2289ea67",
            "filename": "packages/bazel/index.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/b61c009c5479812b061c6837e1fdbf645deea4f1/packages%2Fbazel%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/b61c009c5479812b061c6837e1fdbf645deea4f1/packages%2Fbazel%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Findex.bzl?ref=b61c009c5479812b061c6837e1fdbf645deea4f1",
            "patch": "@@ -12,5 +12,6 @@ load(\"//packages/bazel/src:ng_module.bzl\", _ng_module = \"ng_module_macro\")\n \n ng_module = _ng_module\n ng_package = _ng_package\n+\n # DO NOT ADD PUBLIC API without including in the documentation generation\n # Run `yarn bazel build //packages/bazel/docs` to verify"
        },
        {
            "sha": "d8ad4635bdde25b7f2237d55710b326097fa0ff7",
            "filename": "packages/bazel/src/ng_module.bzl",
            "status": "modified",
            "additions": 44,
            "deletions": 3,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/b61c009c5479812b061c6837e1fdbf645deea4f1/packages%2Fbazel%2Fsrc%2Fng_module.bzl",
            "raw_url": "https://github.com/angular/angular/raw/b61c009c5479812b061c6837e1fdbf645deea4f1/packages%2Fbazel%2Fsrc%2Fng_module.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module.bzl?ref=b61c009c5479812b061c6837e1fdbf645deea4f1",
            "patch": "@@ -26,9 +26,19 @@ load(\n     \"tsc_wrapped_tsconfig\",\n )\n \n+# enable_perf_logging controls whether Ivy's performance tracing system will be enabled for any\n+# compilation which includes this provider.\n+NgPerfInfo = provider(fields = [\"enable_perf_logging\"])\n+\n _FLAT_DTS_FILE_SUFFIX = \".bundle.d.ts\"\n _R3_SYMBOLS_DTS_FILE = \"src/r3_symbols.d.ts\"\n \n+def is_perf_requested(ctx):\n+    enable_perf_logging = ctx.attr.perf_flag != None and ctx.attr.perf_flag[NgPerfInfo].enable_perf_logging == True\n+    if enable_perf_logging and not is_ivy_enabled(ctx):\n+        fail(\"Angular View Engine does not support performance tracing\")\n+    return enable_perf_logging\n+\n def is_ivy_enabled(ctx):\n     \"\"\"Determine if the ivy compiler should be used to by the ng_module.\n \n@@ -278,6 +288,15 @@ def _expected_outs(ctx):\n     else:\n         i18n_messages_files = []\n \n+    dev_perf_files = []\n+    prod_perf_files = []\n+\n+    # In Ivy mode, dev and prod builds both produce a .json output containing performance metrics\n+    # from the compiler for that build.\n+    if is_perf_requested(ctx):\n+        dev_perf_files = [ctx.actions.declare_file(ctx.label.name + \"_perf_dev.json\")]\n+        prod_perf_files = [ctx.actions.declare_file(ctx.label.name + \"_perf_prod.json\")]\n+\n     return struct(\n         closure_js = closure_js_files,\n         devmode_js = devmode_js_files,\n@@ -288,6 +307,8 @@ def _expected_outs(ctx):\n         dts_bundles = dts_bundles,\n         bundle_index_typings = bundle_index_typings,\n         i18n_messages = i18n_messages_files,\n+        dev_perf_files = dev_perf_files,\n+        prod_perf_files = prod_perf_files,\n     )\n \n # Determines if we need to generate View Engine shims (.ngfactory and .ngsummary files)\n@@ -336,6 +357,15 @@ def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n         \"_useManifestPathsAsModuleName\": (not _is_bazel()),\n     }\n \n+    if is_perf_requested(ctx):\n+        # In Ivy mode, set the `tracePerformance` Angular compiler option to enable performance\n+        # metric output.\n+        if \"devmode_manifest\" in kwargs:\n+            perf_path = outs.dev_perf_files[0].path\n+        else:\n+            perf_path = outs.prod_perf_files[0].path\n+        angular_compiler_options[\"tracePerformance\"] = perf_path\n+\n     if _should_produce_flat_module_outs(ctx):\n         angular_compiler_options[\"flatModuleId\"] = ctx.attr.module_name\n         angular_compiler_options[\"flatModuleOutFile\"] = _flat_module_out_file(ctx)\n@@ -519,6 +549,7 @@ def _compile_action(\n         outputs,\n         dts_bundles_out,\n         messages_out,\n+        perf_out,\n         tsconfig_file,\n         node_opts,\n         compile_mode):\n@@ -563,12 +594,12 @@ def _compile_action(\n \n def _prodmode_compile_action(ctx, inputs, outputs, tsconfig_file, node_opts):\n     outs = _expected_outs(ctx)\n-    return _compile_action(ctx, inputs, outputs + outs.closure_js, None, outs.i18n_messages, tsconfig_file, node_opts, \"prodmode\")\n+    return _compile_action(ctx, inputs, outputs + outs.closure_js + outs.prod_perf_files, None, outs.i18n_messages, outs.prod_perf_files, tsconfig_file, node_opts, \"prodmode\")\n \n def _devmode_compile_action(ctx, inputs, outputs, tsconfig_file, node_opts):\n     outs = _expected_outs(ctx)\n-    compile_action_outputs = outputs + outs.devmode_js + outs.declarations + outs.summaries + outs.metadata\n-    _compile_action(ctx, inputs, compile_action_outputs, outs.dts_bundles, None, tsconfig_file, node_opts, \"devmode\")\n+    compile_action_outputs = outputs + outs.devmode_js + outs.declarations + outs.summaries + outs.metadata + outs.dev_perf_files\n+    _compile_action(ctx, inputs, compile_action_outputs, outs.dts_bundles, None, outs.dev_perf_files, tsconfig_file, node_opts, \"devmode\")\n \n def _ts_expected_outs(ctx, label, srcs_files = []):\n     # rules_typescript expects a function with two or more arguments, but our\n@@ -711,6 +742,16 @@ NG_MODULE_ATTRIBUTES = {\n         executable = True,\n         cfg = \"host\",\n     ),\n+    # In the angular/angular monorepo, //tools:defaults.bzl wraps the ng_module rule in a macro\n+    # which sets this attribute to the //packages/compiler-cli:ng_perf flag.\n+    # This is done to avoid exposing the flag to user projects, which would require:\n+    # * defining the flag within @angular/bazel and referencing it correctly here, and\n+    # * committing to the flag and its semantics (including the format of perf JSON files)\n+    #   as something users can depend upon.\n+    \"perf_flag\": attr.label(\n+        providers = [NgPerfInfo],\n+        doc = \"Private API to control production of performance metric JSON files\",\n+    ),\n     \"_supports_workers\": attr.bool(default = True),\n }\n "
        },
        {
            "sha": "9fb0cc2343b03aec4e3e036a33bb2381edbd0608",
            "filename": "packages/bazel/src/ng_perf.bzl",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/b61c009c5479812b061c6837e1fdbf645deea4f1/packages%2Fbazel%2Fsrc%2Fng_perf.bzl",
            "raw_url": "https://github.com/angular/angular/raw/b61c009c5479812b061c6837e1fdbf645deea4f1/packages%2Fbazel%2Fsrc%2Fng_perf.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_perf.bzl?ref=b61c009c5479812b061c6837e1fdbf645deea4f1",
            "patch": "@@ -0,0 +1,20 @@\n+# Copyright Google LLC All Rights Reserved.\n+#\n+# Use of this source code is governed by an MIT-style license that can be\n+# found in the LICENSE file at https://angular.io/license\n+\n+load(\":ng_module.bzl\", \"NgPerfInfo\")\n+\n+def _ng_perf_flag_impl(ctx):\n+    return NgPerfInfo(enable_perf_logging = ctx.build_setting_value)\n+\n+# `ng_perf_flag` is a special `build_setting` rule which ultimately enables a command-line boolean\n+# flag to control whether the `ng_module` rule produces performance tracing JSON files (in Ivy mode)\n+# as declared outputs.\n+#\n+# It does this via the `NgPerfInfo` provider and the `perf_flag` attriubute on `ng_module`. For more\n+# details, see: https://docs.bazel.build/versions/master/skylark/config.html\n+ng_perf_flag = rule(\n+    implementation = _ng_perf_flag_impl,\n+    build_setting = config.bool(flag = True),\n+)"
        },
        {
            "sha": "fe4758ee91fab4d373a316ed791feb3800f00e1a",
            "filename": "packages/compiler-cli/BUILD.bazel",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/b61c009c5479812b061c6837e1fdbf645deea4f1/packages%2Fcompiler-cli%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b61c009c5479812b061c6837e1fdbf645deea4f1/packages%2Fcompiler-cli%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2FBUILD.bazel?ref=b61c009c5479812b061c6837e1fdbf645deea4f1",
            "patch": "@@ -2,6 +2,10 @@ package(default_visibility = [\"//visibility:public\"])\n \n load(\"//tools:defaults.bzl\", \"pkg_npm\", \"ts_api_guardian_test\", \"ts_config\", \"ts_library\")\n \n+# Load ng_perf_flag explicitly from ng_perf.bzl as it's private API, and not exposed to other\n+# consumers of @angular/bazel.\n+load(\"//packages/bazel/src:ng_perf.bzl\", \"ng_perf_flag\")\n+\n ts_config(\n     name = \"tsconfig\",\n     src = \"tsconfig-build.json\",\n@@ -88,3 +92,9 @@ ts_api_guardian_test(\n     ],\n     golden = \"angular/goldens/public-api/compiler-cli/compiler_options.d.ts\",\n )\n+\n+# Controls whether the Ivy compiler produces performance traces as part of each build\n+ng_perf_flag(\n+    name = \"ng_perf\",\n+    build_setting_default = False,\n+)"
        },
        {
            "sha": "9d7a2bed56a7d78b449a7ea69aa6cc5bcf8eb641",
            "filename": "tools/defaults.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/b61c009c5479812b061c6837e1fdbf645deea4f1/tools%2Fdefaults.bzl",
            "raw_url": "https://github.com/angular/angular/raw/b61c009c5479812b061c6837e1fdbf645deea4f1/tools%2Fdefaults.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fdefaults.bzl?ref=b61c009c5479812b061c6837e1fdbf645deea4f1",
            "patch": "@@ -156,6 +156,7 @@ def ng_module(name, tsconfig = None, entry_point = None, testonly = False, deps\n         api_extractor = _INTERNAL_NG_MODULE_API_EXTRACTOR,\n         ng_xi18n = _INTERNAL_NG_MODULE_XI18N,\n         module_name = module_name,\n+        perf_flag = \"//packages/compiler-cli:ng_perf\",\n         **kwargs\n     )\n "
        }
    ],
    "stats": {
        "total": 86,
        "additions": 83,
        "deletions": 3
    }
}