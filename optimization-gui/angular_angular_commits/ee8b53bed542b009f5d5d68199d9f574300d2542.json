{
    "author": "mgechev",
    "message": "refactor(devtools): use framework debugging APIs to extract render tree",
    "sha": "ee8b53bed542b009f5d5d68199d9f574300d2542",
    "files": [
        {
            "sha": "0d0370968709e996b232f94164f6e3694778571e",
            "filename": "projects/ng-devtools-backend/src/lib/directive-forest/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/ee8b53bed542b009f5d5d68199d9f574300d2542/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/ee8b53bed542b009f5d5d68199d9f574300d2542/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Findex.ts?ref=ee8b53bed542b009f5d5d68199d9f574300d2542",
            "patch": "@@ -1,11 +1,12 @@\n-import { LViewBuilder } from './lview';\n-import { DebugNodeTreeBuilder } from './lview-debug';\n+import { LTreeStrategy } from './ltree';\n+import { RTreeStrategy } from './render-tree';\n \n-export { getLViewFromDirectiveOrElementInstance, getDirectiveHostElement, METADATA_PROPERTY_NAME } from './lview';\n+export { getLViewFromDirectiveOrElementInstance, getDirectiveHostElement, METADATA_PROPERTY_NAME } from './ltree';\n \n-const builders = [new DebugNodeTreeBuilder(), new LViewBuilder()];\n+// The order of the strategies matters. Lower indices have higher priority.\n+const builders = [new RTreeStrategy(), new LTreeStrategy()];\n \n-let strategy: null | DebugNodeTreeBuilder | LViewBuilder = null;\n+let strategy: null | RTreeStrategy | LTreeStrategy = null;\n \n const selectStrategy = (lView: any) => {\n   for (const builder of builders) {\n@@ -24,8 +25,5 @@ export const buildDirectiveTree = (element: Element) => {\n     console.error('Unable to parse the component tree');\n     return [];\n   }\n-  console.time('tree-start');\n-  const result = strategy.build(element);\n-  console.timeEnd('tree-start');\n-  return result;\n+  return strategy.build(element);\n };"
        },
        {
            "sha": "f820178767901ff57c682ca1ac98f09674f625f5",
            "filename": "projects/ng-devtools-backend/src/lib/directive-forest/ltree.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ee8b53bed542b009f5d5d68199d9f574300d2542/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Fltree.ts",
            "raw_url": "https://github.com/angular/angular/raw/ee8b53bed542b009f5d5d68199d9f574300d2542/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Fltree.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Fltree.ts?ref=ee8b53bed542b009f5d5d68199d9f574300d2542",
            "patch": "@@ -57,7 +57,7 @@ export const getDirectiveHostElement = (dir: any) => {\n   return ctx[components[0]][0];\n };\n \n-export class LViewBuilder {\n+export class LTreeStrategy {\n   supports(element: Element) {\n     return (element as any).__ngContext__;\n   }",
            "previous_filename": "projects/ng-devtools-backend/src/lib/directive-forest/lview.ts"
        },
        {
            "sha": "ddcbe91199a7b028272a3d759bc71e7eecb407f2",
            "filename": "projects/ng-devtools-backend/src/lib/directive-forest/lview-debug.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 59,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Flview-debug.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Flview-debug.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Flview-debug.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -1,59 +0,0 @@\n-import { DebugNode as ngDebugNode, DebugElement as ngDebugElement } from '@angular/core';\n-import { ComponentInstanceType, DirectiveInstanceType, ComponentTreeNode } from '../component-tree';\n-import { getDirectiveName } from '../highlighter';\n-import { isCustomElement } from '../utils';\n-\n-interface DebugNode extends ngDebugNode {\n-  isHost: boolean;\n-  directives: any[];\n-}\n-interface DebugElement extends ngDebugElement, DebugNode {}\n-\n-const extractViewTree = (element: DebugElement | DebugNode, result: ComponentTreeNode[] = []): ComponentTreeNode[] => {\n-  const { isHost, directives } = element;\n-  if (!isHost && !directives.length) {\n-    ((element as any).childNodes || []).forEach((node) => extractViewTree(node, result));\n-    return result;\n-  }\n-  const node: ComponentTreeNode = {\n-    children: [],\n-    component: null,\n-    directives: [],\n-    element: element.nativeNode.nodeName.toLowerCase(),\n-    nativeElement: element.nativeNode,\n-  };\n-  if (isHost) {\n-    node.component = {\n-      instance: element.componentInstance,\n-      isElement: isCustomElement(element.nativeNode),\n-      name: element?.componentInstance?.constructor?.name,\n-    };\n-  }\n-  if (directives.length) {\n-    node.directives = element.directives.map((dir) => {\n-      return {\n-        instance: dir,\n-        name: dir.constructor.name,\n-      };\n-    });\n-  }\n-  if (node.component || node.directives.length) {\n-    result.push(node);\n-    ((element as any).childNodes || []).forEach((n) => extractViewTree(n, node.children));\n-  } else {\n-    ((element as any).childNodes || []).forEach((n) => extractViewTree(n, result));\n-  }\n-  return result;\n-};\n-\n-export class DebugNodeTreeBuilder {\n-  supports(_: any) {\n-    const { asDebugNode, getDirectiveMetadata } = (window as any).ng;\n-    return typeof asDebugNode === 'function' && typeof getDirectiveMetadata === 'function';\n-  }\n-\n-  build(element: Element): ComponentTreeNode[] {\n-    const result = extractViewTree((window as any).ng.asDebugNode(element));\n-    return result;\n-  }\n-}"
        },
        {
            "sha": "4da7f5dcfc9cb4a14f7794ee0a7bc58eadc62ced",
            "filename": "projects/ng-devtools-backend/src/lib/directive-forest/render-tree.ts",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/ee8b53bed542b009f5d5d68199d9f574300d2542/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Frender-tree.ts",
            "raw_url": "https://github.com/angular/angular/raw/ee8b53bed542b009f5d5d68199d9f574300d2542/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Frender-tree.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Frender-tree.ts?ref=ee8b53bed542b009f5d5d68199d9f574300d2542",
            "patch": "@@ -0,0 +1,58 @@\n+import { ComponentTreeNode } from '../component-tree';\n+import { isCustomElement } from '../utils';\n+\n+const extractViewTree = (node: Node | Element, result: ComponentTreeNode[] = []): ComponentTreeNode[] => {\n+  const getComponent = (window as any).ng.getComponent as (element: Element) => {};\n+  const getDirectives = (window as any).ng.getDirectives as (node: Node) => {}[];\n+\n+  const directives = getDirectives(node);\n+  if (!directives.length && !(node instanceof Element)) {\n+    return result;\n+  }\n+  const componentTreeNode: ComponentTreeNode = {\n+    children: [],\n+    component: null,\n+    directives: directives.map((dir) => {\n+      return {\n+        instance: dir,\n+        name: dir.constructor.name,\n+      };\n+    }),\n+    element: node.nodeName.toLowerCase(),\n+    nativeElement: node,\n+  };\n+  if (!(node instanceof Element)) {\n+    result.push(componentTreeNode);\n+    return result;\n+  }\n+  const component = getComponent(node);\n+  if (component) {\n+    componentTreeNode.component = {\n+      instance: component,\n+      isElement: isCustomElement(node),\n+      name: node.nodeName.toLowerCase(),\n+    };\n+  }\n+  if (component || componentTreeNode.directives.length) {\n+    result.push(componentTreeNode);\n+  }\n+  if (componentTreeNode.component || componentTreeNode.directives.length) {\n+    node.childNodes.forEach((node) => extractViewTree(node, componentTreeNode.children));\n+  } else {\n+    node.childNodes.forEach((node) => extractViewTree(node, result));\n+  }\n+  return result;\n+};\n+\n+export class RTreeStrategy {\n+  supports(_: any) {\n+    return ['getDirectiveMetadata', 'getComponent', 'getDirectives'].every(\n+      (method) => typeof (window as any).ng[method] === 'function'\n+    );\n+  }\n+\n+  build(element: Element): ComponentTreeNode[] {\n+    const result = extractViewTree(element);\n+    return result;\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 135,
        "additions": 66,
        "deletions": 69
    }
}