{
    "author": "kyliau",
    "message": "fix(language-service): include compilerOptions.rootDir in rootDirs (#40243)\n\nWhen resolving references, the Ivy compiler has a few strategies it could use.\n\nFor relative path, one of strategies is [`RelativePathStrategy`](\nhttps://github.com/angular/angular/blob/master/packages/compiler-cli/src/\nngtsc/imports/README.md#relativepathstrategy). This strategy\nrelies on `compilerOptions.rootDir` and `compilerOptions.rootDirs` to perform\nthe resolution, but language service only passes `rootDirs` to the compiler,\nand not `rootDir`.\n\nIn reality, `rootDir` is very different from `rootDirs` even though they\nsound the same.\nAccording to the official [TS documentation][1],\n> `rootDir` specifies the root directory of input files. Only use to control\n> the output directory structure with --outDir.\n\n> `rootDirs` is a list of root folders whose combined content represent the\n> structure of the project at runtime. See [Module Resolution documentation](\n> https://www.typescriptlang.org/docs/handbook/\n> module-resolution.html#virtual-directories-with-rootdirs)\n> for more details.\n\nFor now, we keep the behavior between compiler and language service consistent,\nbut we will revisit the notion of `rootDir` and how it is used later.\n\nFix angular/vscode-ng-language-service#1039\n\n[1]: https://www.typescriptlang.org/docs/handbook/compiler-options.html\n\nPR Close #40243",
    "sha": "a62416c6e48d3501d41ab18a54c5c430fec26d4a",
    "files": [
        {
            "sha": "63af2e8206efa279d1b89751d313781240e4ed61",
            "filename": "packages/compiler-cli/src/ngtsc/util/src/typescript.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a62416c6e48d3501d41ab18a54c5c430fec26d4a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Futil%2Fsrc%2Ftypescript.ts",
            "raw_url": "https://github.com/angular/angular/raw/a62416c6e48d3501d41ab18a54c5c430fec26d4a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Futil%2Fsrc%2Ftypescript.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Futil%2Fsrc%2Ftypescript.ts?ref=a62416c6e48d3501d41ab18a54c5c430fec26d4a",
            "patch": "@@ -92,7 +92,9 @@ export function isExported(node: DeclarationNode): boolean {\n       topLevel.modifiers.some(modifier => modifier.kind === ts.SyntaxKind.ExportKeyword);\n }\n \n-export function getRootDirs(host: ts.CompilerHost, options: ts.CompilerOptions): AbsoluteFsPath[] {\n+export function getRootDirs(\n+    host: Pick<ts.CompilerHost, 'getCurrentDirectory'|'getCanonicalFileName'>,\n+    options: ts.CompilerOptions): AbsoluteFsPath[] {\n   const rootDirs: string[] = [];\n   if (options.rootDirs !== undefined) {\n     rootDirs.push(...options.rootDirs);"
        },
        {
            "sha": "37b67f6c395a5eb03aad7062301a82298a1ab90d",
            "filename": "packages/language-service/ivy/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a62416c6e48d3501d41ab18a54c5c430fec26d4a/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/a62416c6e48d3501d41ab18a54c5c430fec26d4a/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2FBUILD.bazel?ref=a62416c6e48d3501d41ab18a54c5c430fec26d4a",
            "patch": "@@ -18,6 +18,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n+        \"//packages/compiler-cli/src/ngtsc/util\",\n         \"@npm//@types/node\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "bd02eaa562055196aac5df343249ec7a277a331a",
            "filename": "packages/language-service/ivy/adapters.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/a62416c6e48d3501d41ab18a54c5c430fec26d4a/packages%2Flanguage-service%2Fivy%2Fadapters.ts",
            "raw_url": "https://github.com/angular/angular/raw/a62416c6e48d3501d41ab18a54c5c430fec26d4a/packages%2Flanguage-service%2Fivy%2Fadapters.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fadapters.ts?ref=a62416c6e48d3501d41ab18a54c5c430fec26d4a",
            "patch": "@@ -10,8 +10,9 @@\n \n import {ConfigurationHost} from '@angular/compiler-cli';\n import {NgCompilerAdapter} from '@angular/compiler-cli/src/ngtsc/core/api';\n-import {absoluteFrom, AbsoluteFsPath, FileStats, PathSegment, PathString} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {AbsoluteFsPath, FileStats, PathSegment, PathString} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {isShim} from '@angular/compiler-cli/src/ngtsc/shims';\n+import {getRootDirs} from '@angular/compiler-cli/src/ngtsc/util/src/typescript';\n import * as p from 'path';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n@@ -27,7 +28,7 @@ export class LanguageServiceAdapter implements NgCompilerAdapter {\n   private readonly templateVersion = new Map<string, string>();\n \n   constructor(private readonly project: ts.server.Project) {\n-    this.rootDirs = project.getCompilationSettings().rootDirs?.map(absoluteFrom) || [];\n+    this.rootDirs = getRootDirs(this, project.getCompilationSettings());\n   }\n \n   isShim(sf: ts.SourceFile): boolean {"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 7,
        "deletions": 3
    }
}