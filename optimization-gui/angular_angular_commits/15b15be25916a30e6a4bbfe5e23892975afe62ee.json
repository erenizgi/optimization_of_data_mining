{
    "author": "ivanwonder",
    "message": "fix(compiler): recover event parse when animation event name is empty (#39925)\n\nNow when the animation trigger output event is missing its phase value name, the `BoundEvent` will be ignored,\nbut it's useful for completion in language service.\n\nPR Close #39925",
    "sha": "15b15be25916a30e6a4bbfe5e23892975afe62ee",
    "files": [
        {
            "sha": "ec709ad94cd4d683c83291be4005d282a718b661",
            "filename": "packages/compiler/src/template_parser/binding_parser.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/15b15be25916a30e6a4bbfe5e23892975afe62ee/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/15b15be25916a30e6a4bbfe5e23892975afe62ee/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts?ref=15b15be25916a30e6a4bbfe5e23892975afe62ee",
            "patch": "@@ -443,21 +443,19 @@ export class BindingParser {\n     const matches = splitAtPeriod(name, [name, '']);\n     const eventName = matches[0];\n     const phase = matches[1].toLowerCase();\n+    const ast = this._parseAction(expression, handlerSpan);\n+    targetEvents.push(new ParsedEvent(\n+        eventName, phase, ParsedEventType.Animation, ast, sourceSpan, handlerSpan, keySpan));\n+\n+    if (eventName.length === 0) {\n+      this._reportError(`Animation event name is missing in binding`, sourceSpan);\n+    }\n     if (phase) {\n-      switch (phase) {\n-        case 'start':\n-        case 'done':\n-          const ast = this._parseAction(expression, handlerSpan);\n-          targetEvents.push(new ParsedEvent(\n-              eventName, phase, ParsedEventType.Animation, ast, sourceSpan, handlerSpan, keySpan));\n-          break;\n-\n-        default:\n-          this._reportError(\n-              `The provided animation output phase value \"${phase}\" for \"@${\n-                  eventName}\" is not supported (use start or done)`,\n-              sourceSpan);\n-          break;\n+      if (phase !== 'start' && phase !== 'done') {\n+        this._reportError(\n+            `The provided animation output phase value \"${phase}\" for \"@${\n+                eventName}\" is not supported (use start or done)`,\n+            sourceSpan);\n       }\n     } else {\n       this._reportError("
        },
        {
            "sha": "c2594850730d80bf0cb6c004e2eb44da6e13c3ce",
            "filename": "packages/compiler/test/render3/r3_template_transform_spec.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 2,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/15b15be25916a30e6a4bbfe5e23892975afe62ee/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_template_transform_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/15b15be25916a30e6a4bbfe5e23892975afe62ee/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_template_transform_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_template_transform_spec.ts?ref=15b15be25916a30e6a4bbfe5e23892975afe62ee",
            "patch": "@@ -92,8 +92,8 @@ class R3AstHumanizer implements t.Visitor<void> {\n   }\n }\n \n-function expectFromHtml(html: string) {\n-  const res = parse(html);\n+function expectFromHtml(html: string, ignoreError = false) {\n+  const res = parse(html, {ignoreError});\n   return expectFromR3Nodes(res.nodes);\n }\n \n@@ -399,6 +399,27 @@ describe('R3 template transform', () => {\n       expect(() => parse('<div (event)=\"\">')).toThrowError(/Empty expressions are not allowed/);\n       expect(() => parse('<div (event)=\"   \">')).toThrowError(/Empty expressions are not allowed/);\n     });\n+\n+    it('should parse bound animation events when event name is empty', () => {\n+      expectFromHtml('<div (@)=\"onAnimationEvent($event)\"></div>', true).toEqual([\n+        ['Element', 'div'],\n+        ['BoundEvent', '', null, 'onAnimationEvent($event)'],\n+      ]);\n+      expect(() => parse('<div (@)></div>'))\n+          .toThrowError(/Animation event name is missing in binding/);\n+    });\n+\n+    it('should report invalid phase value of animation event', () => {\n+      expect(() => parse('<div (@event.invalidPhase)></div>'))\n+          .toThrowError(\n+              /The provided animation output phase value \"invalidphase\" for \"@event\" is not supported \\(use start or done\\)/);\n+      expect(() => parse('<div (@event.)></div>'))\n+          .toThrowError(\n+              /The animation trigger output event \\(@event\\) is missing its phase value name \\(start or done are currently supported\\)/);\n+      expect(() => parse('<div (@event)></div>'))\n+          .toThrowError(\n+              /The animation trigger output event \\(@event\\) is missing its phase value name \\(start or done are currently supported\\)/);\n+    });\n   });\n \n   describe('variables', () => {"
        },
        {
            "sha": "dd3f47125cd249ffd8f6f72744a0e9399fb8aab0",
            "filename": "packages/compiler/test/render3/view/util.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/15b15be25916a30e6a4bbfe5e23892975afe62ee/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/15b15be25916a30e6a4bbfe5e23892975afe62ee/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Futil.ts?ref=15b15be25916a30e6a4bbfe5e23892975afe62ee",
            "patch": "@@ -78,15 +78,17 @@ export function toStringExpression(expr: e.AST): string {\n \n // Parse an html string to IVY specific info\n export function parseR3(\n-    input: string, options: {preserveWhitespaces?: boolean, leadingTriviaChars?: string[]} = {}):\n-    Render3ParseResult {\n+    input: string,\n+    options: {preserveWhitespaces?: boolean,\n+              leadingTriviaChars?: string[],\n+              ignoreError?: boolean} = {}): Render3ParseResult {\n   const htmlParser = new HtmlParser();\n \n   const parseResult = htmlParser.parse(\n       input, 'path:://to/template',\n       {tokenizeExpansionForms: true, leadingTriviaChars: options.leadingTriviaChars});\n \n-  if (parseResult.errors.length > 0) {\n+  if (parseResult.errors.length > 0 && !options.ignoreError) {\n     const msg = parseResult.errors.map(e => e.toString()).join('\\n');\n     throw new Error(msg);\n   }\n@@ -105,7 +107,7 @@ export function parseR3(\n       new BindingParser(expressionParser, DEFAULT_INTERPOLATION_CONFIG, schemaRegistry, null, []);\n   const r3Result = htmlAstToRender3Ast(htmlNodes, bindingParser);\n \n-  if (r3Result.errors.length > 0) {\n+  if (r3Result.errors.length > 0 && !options.ignoreError) {\n     const msg = r3Result.errors.map(e => e.toString()).join('\\n');\n     throw new Error(msg);\n   }"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 41,
        "deletions": 20
    }
}