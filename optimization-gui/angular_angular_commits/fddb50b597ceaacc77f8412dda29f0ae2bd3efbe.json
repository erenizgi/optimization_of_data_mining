{
    "author": "gkalpak",
    "message": "fix(service-worker): make `ngsw.json` generation deterministic and correct (#43679)\n\nPreviously, all asset-groups from `ngsw-config.json` were processed in\nparallel. For each asset-group, we retrieved all files for the current\nbuild, filtered out files that were already matched by other\nasset-groups, determined which of the remaining files belonged to the\ncurrent asset-group and generated entries for the `ngsw.json` manifest.\nThis process was susceptible to race conditions when there were files\nthat would be matched by multiple asset-groups. This made the generation\nof the `ngsw.json` manifest non-deterministic and violated the rule that\neach file would belong to the first asset-group that matched it (based\non the asset-groups' order of appearance in `ngsw-config.json`), thus\nleading to broken ServiceWorker behavior.\n\nThis commit fixes it by ensuring that the generation process is\ndeterministic and that asset-groups are processed in the proper order.\n\nNOTE 1:\nThe generation process has been broken since the beginning, but we have\nonly noticed this recently. This is possibly related to the CLI's\nswitching from a virtual file system host (which has more consistent\ntiming characteristics) to the Node.js built-in `fs.promises` in\nangular/angular-cli@d3bc530c103849ca83742ab63eea7709d9af613d.\n\nNOTE 2:\nThis commit also ensures that files in the `ngsw.json` hash-table are in\nalphabetic order. Previously, the files were added to the hash-table in\nblocks corresponding to each asset-group.\nThis change is not necessary (i.e. the order of keys in the hash-table\nmakes no difference in behavior), but it makes it easier to scan for a\nfile (for example, for debugging purposes).\n\nPR Close #43679",
    "sha": "fddb50b597ceaacc77f8412dda29f0ae2bd3efbe",
    "files": [
        {
            "sha": "99feba49d5395d39a382631860995700bc48b34e",
            "filename": "packages/service-worker/config/src/generator.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 19,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/fddb50b597ceaacc77f8412dda29f0ae2bd3efbe/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fgenerator.ts",
            "raw_url": "https://github.com/angular/angular/raw/fddb50b597ceaacc77f8412dda29f0ae2bd3efbe/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fgenerator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fgenerator.ts?ref=fddb50b597ceaacc77f8412dda29f0ae2bd3efbe",
            "patch": "@@ -9,7 +9,7 @@\n import {parseDurationToMs} from './duration';\n import {Filesystem} from './filesystem';\n import {globToRegex} from './glob';\n-import {Config} from './in';\n+import {AssetGroup, Config} from './in';\n \n const DEFAULT_NAVIGATION_URLS = [\n   '/**',           // Include all URLs.\n@@ -45,36 +45,44 @@ export class Generator {\n \n   private async processAssetGroups(config: Config, hashTable: {[file: string]: string|undefined}):\n       Promise<Object[]> {\n+    // Retrieve all files of the build.\n+    const allFiles = await this.fs.list('/');\n     const seenMap = new Set<string>();\n-    return Promise.all((config.assetGroups || []).map(async (group) => {\n+    const filesPerGroup = new Map<AssetGroup, string[]>();\n+\n+    // Computed which files belong to each asset-group.\n+    for (const group of (config.assetGroups || [])) {\n       if ((group.resources as any).versionedFiles) {\n         throw new Error(\n             `Asset-group '${group.name}' in 'ngsw-config.json' uses the 'versionedFiles' option, ` +\n             'which is no longer supported. Use \\'files\\' instead.');\n       }\n \n       const fileMatcher = globListToMatcher(group.resources.files || []);\n-      const allFiles = await this.fs.list('/');\n-\n       const matchedFiles = allFiles.filter(fileMatcher).filter(file => !seenMap.has(file)).sort();\n+\n       matchedFiles.forEach(file => seenMap.add(file));\n+      filesPerGroup.set(group, matchedFiles);\n+    }\n \n-      // Add the hashes.\n-      await matchedFiles.reduce(async (previous, file) => {\n-        await previous;\n-        const hash = await this.fs.hash(file);\n-        hashTable[joinUrls(this.baseHref, file)] = hash;\n-      }, Promise.resolve());\n+    // Compute hashes for all matched files and add them to the hash-table.\n+    const allMatchedFiles = ([] as string[]).concat(...Array.from(filesPerGroup.values())).sort();\n+    const allMatchedHashes = await Promise.all(allMatchedFiles.map(file => this.fs.hash(file)));\n+    allMatchedFiles.forEach((file, idx) => {\n+      hashTable[joinUrls(this.baseHref, file)] = allMatchedHashes[idx];\n+    });\n \n-      return {\n-        name: group.name,\n-        installMode: group.installMode || 'prefetch',\n-        updateMode: group.updateMode || group.installMode || 'prefetch',\n-        cacheQueryOptions: buildCacheQueryOptions(group.cacheQueryOptions),\n-        urls: matchedFiles.map(url => joinUrls(this.baseHref, url)),\n-        patterns: (group.resources.urls || []).map(url => urlToRegex(url, this.baseHref, true)),\n-      };\n-    }));\n+    // Generate and return the processed asset-groups.\n+    return Array.from(filesPerGroup.entries())\n+        .map(([group, matchedFiles]) => ({\n+               name: group.name,\n+               installMode: group.installMode || 'prefetch',\n+               updateMode: group.updateMode || group.installMode || 'prefetch',\n+               cacheQueryOptions: buildCacheQueryOptions(group.cacheQueryOptions),\n+               urls: matchedFiles.map(url => joinUrls(this.baseHref, url)),\n+               patterns:\n+                   (group.resources.urls || []).map(url => urlToRegex(url, this.baseHref, true)),\n+             }));\n   }\n \n   private processDataGroups(config: Config): Object[] {"
        },
        {
            "sha": "085b64d794e66a70c713134b8242efe24e501882",
            "filename": "packages/service-worker/config/test/generator_spec.ts",
            "status": "modified",
            "additions": 96,
            "deletions": 0,
            "changes": 96,
            "blob_url": "https://github.com/angular/angular/blob/fddb50b597ceaacc77f8412dda29f0ae2bd3efbe/packages%2Fservice-worker%2Fconfig%2Ftest%2Fgenerator_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/fddb50b597ceaacc77f8412dda29f0ae2bd3efbe/packages%2Fservice-worker%2Fconfig%2Ftest%2Fgenerator_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fconfig%2Ftest%2Fgenerator_spec.ts?ref=fddb50b597ceaacc77f8412dda29f0ae2bd3efbe",
            "patch": "@@ -128,6 +128,102 @@ describe('Generator', () => {\n     });\n   });\n \n+  it('assigns files to the first matching asset-group (unaffected by file-system access delays)',\n+     async () => {\n+       const fs = new MockFilesystem({\n+         '/index.html': 'This is a test',\n+         '/foo/script-1.js': 'This is script 1',\n+         '/foo/script-2.js': 'This is script 2',\n+         '/bar/script-3.js': 'This is script 3',\n+         '/bar/script-4.js': 'This is script 4',\n+         '/qux/script-5.js': 'This is script 5',\n+       });\n+\n+       // Simulate fluctuating file-system access delays.\n+       const allFiles = await fs.list('/');\n+       spyOn(fs, 'list')\n+           .and.returnValues(\n+               new Promise(resolve => setTimeout(resolve, 2000, allFiles.slice())),\n+               new Promise(resolve => setTimeout(resolve, 3000, allFiles.slice())),\n+               new Promise(resolve => setTimeout(resolve, 1000, allFiles.slice())),\n+           );\n+\n+       const gen = new Generator(fs, '');\n+       const config = await gen.process({\n+         index: '/index.html',\n+         assetGroups: [\n+           {\n+             name: 'group-foo',\n+             resources: {files: ['/foo/**/*.js']},\n+           },\n+           {\n+             name: 'group-bar',\n+             resources: {files: ['/bar/**/*.js']},\n+           },\n+           {\n+             name: 'group-fallback',\n+             resources: {files: ['/**/*.js']},\n+           },\n+         ],\n+       });\n+\n+       expect(config).toEqual({\n+         configVersion: 1,\n+         timestamp: 1234567890123,\n+         appData: undefined,\n+         index: '/index.html',\n+         assetGroups: [\n+           {\n+             name: 'group-foo',\n+             installMode: 'prefetch',\n+             updateMode: 'prefetch',\n+             cacheQueryOptions: {ignoreVary: true},\n+             urls: [\n+               '/foo/script-1.js',\n+               '/foo/script-2.js',\n+             ],\n+             patterns: [],\n+           },\n+           {\n+             name: 'group-bar',\n+             installMode: 'prefetch',\n+             updateMode: 'prefetch',\n+             cacheQueryOptions: {ignoreVary: true},\n+             urls: [\n+               '/bar/script-3.js',\n+               '/bar/script-4.js',\n+             ],\n+             patterns: [],\n+           },\n+           {\n+             name: 'group-fallback',\n+             installMode: 'prefetch',\n+             updateMode: 'prefetch',\n+             cacheQueryOptions: {ignoreVary: true},\n+             urls: [\n+               '/qux/script-5.js',\n+             ],\n+             patterns: [],\n+           },\n+         ],\n+         dataGroups: [],\n+         hashTable: {\n+           '/bar/script-3.js': 'bc0a9b488b5707757c491ddac66f56304310b6b1',\n+           '/bar/script-4.js': 'b7782e97a285f1f6e62feca842384babaa209040',\n+           '/foo/script-1.js': '3cf257d7ef7e991898f8506fd408cab4f0c2de91',\n+           '/foo/script-2.js': '9de2ba54065bb9d610bce51beec62e35bea870a7',\n+           '/qux/script-5.js': '3dceafdc0a1b429718e45fbf8e3005dd767892de'\n+         },\n+         navigationUrls: [\n+           {positive: true, regex: '^\\\\/.*$'},\n+           {positive: false, regex: '^\\\\/(?:.+\\\\/)?[^/]*\\\\.[^/]*$'},\n+           {positive: false, regex: '^\\\\/(?:.+\\\\/)?[^/]*__[^/]*$'},\n+           {positive: false, regex: '^\\\\/(?:.+\\\\/)?[^/]*__[^/]*\\\\/.*$'},\n+         ],\n+         navigationRequestStrategy: 'performance',\n+       });\n+     });\n+\n   it('uses default `navigationUrls` if not provided', async () => {\n     const fs = new MockFilesystem({\n       '/index.html': 'This is a test',"
        }
    ],
    "stats": {
        "total": 142,
        "additions": 123,
        "deletions": 19
    }
}