{
    "author": "atscott",
    "message": "refactor(compiler-cli): wrap RHS of property write in parens (#39143)\n\nThe right needs to be wrapped in parens or we cannot accurately match its\nspan to just the RHS. For example, the span in `e = $event /*0,10*/` is ambiguous.\nIt could refer to either the whole binary expression or just the RHS.\nWe should instead generate `e = ($event /*0,10*/)` so we know the span 0,10 matches RHS.\nThis is specifically needed for the TemplateTypeChecker/Language Service\nwhen mapping template positions to items in the TCB.\n\nPR Close #39143",
    "sha": "4ede190571595c4a74abe2b320f5a4dc3c61a967",
    "files": [
        {
            "sha": "f462987f84c833a72488467f9614e0c446d3285b",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/expression.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/4ede190571595c4a74abe2b320f5a4dc3c61a967/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "raw_url": "https://github.com/angular/angular/raw/4ede190571595c4a74abe2b320f5a4dc3c61a967/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts?ref=4ede190571595c4a74abe2b320f5a4dc3c61a967",
            "patch": "@@ -251,7 +251,14 @@ class AstTranslator implements AstVisitor {\n     //     ^     nameSpan\n     const leftWithPath = wrapForDiagnostics(left);\n     addParseSpanInfo(leftWithPath, ast.sourceSpan);\n-    const right = this.translate(ast.value);\n+    let right = this.translate(ast.value);\n+    // The right needs to be wrapped in parens as well or we cannot accurately match its\n+    // span to just the RHS. For example, the span in `e = $event /*0,10*/` is ambiguous.\n+    // It could refer to either the whole binary expression or just the RHS.\n+    // We should instead generate `e = ($event /*0,10*/)` so we know the span 0,10 matches RHS.\n+    if (!ts.isParenthesizedExpression(right)) {\n+      right = wrapForTypeChecker(right);\n+    }\n     const node =\n         wrapForDiagnostics(ts.createBinary(leftWithPath, ts.SyntaxKind.EqualsToken, right));\n     addParseSpanInfo(node, ast.sourceSpan);"
        },
        {
            "sha": "84087895475b3d73c8ed81dce8f48baa99769908",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/span_comments_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/4ede190571595c4a74abe2b320f5a4dc3c61a967/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4ede190571595c4a74abe2b320f5a4dc3c61a967/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts?ref=4ede190571595c4a74abe2b320f5a4dc3c61a967",
            "patch": "@@ -94,6 +94,12 @@ describe('type check blocks diagnostics', () => {\n               '(((((((ctx).a /*14,15*/) /*14,15*/).b /*16,17*/) /*14,17*/).c /*18,19*/) /*14,23*/ = ((ctx).d /*22,23*/) /*22,23*/) /*14,23*/');\n     });\n \n+    it('should $event property writes', () => {\n+      const TEMPLATE = `<div (click)='a = $event'></div>`;\n+      expect(tcbWithSpans(TEMPLATE))\n+          .toContain('(((ctx).a /*14,15*/) /*14,24*/ = ($event /*18,24*/)) /*14,24*/;');\n+    });\n+\n     it('should annotate keyed property access', () => {\n       const TEMPLATE = `{{ a[b] }}`;\n       expect(tcbWithSpans(TEMPLATE))"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 14,
        "deletions": 1
    }
}