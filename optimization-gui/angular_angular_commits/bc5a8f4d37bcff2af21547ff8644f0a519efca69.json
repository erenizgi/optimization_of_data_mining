{
    "author": "devversion",
    "message": "feat(dev-infra): validate deprecation notes in commit messages (#42436)\n\nCurrently the commit message validation tool from `ng-dev` validates\nthe `BREAKING CHANGE:` commit message notes. This commit adds a similar\ncheck for `DEPRECATED:` commit message notes.\n\nAdditionally, the check for breaking changes is reworked slightly to\nbe more tolerant (i.e. if there is only a single line break after the\nsummary; this is acceptable as per the parser and commonly done in the\nCOMP repo). The checks have been updated to capture wrong keywords that\nare commonly used instead of the correct one. e.g. if a commit message\nuses `DEPRECATIONS:` instead of `DEPRECATED:`, the validation will fail.\n\nThis prevents changelog generation issues where breaking change notes,\nor deprecations are missing. This happened in the COMP repo where\nthe `DEPRECATED:` keyword was used incorrectly. See:\n\nhttps://github.com/angular/components/commit/99391e79391d20c6ef2f95a3ea4fd6901dcb631d\n\nPR Close #42436",
    "sha": "bc5a8f4d37bcff2af21547ff8644f0a519efca69",
    "files": [
        {
            "sha": "1892121a0e36811ebf47016df74c3524560f6cfa",
            "filename": "dev-infra/commit-message/parse.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/bc5a8f4d37bcff2af21547ff8644f0a519efca69/dev-infra%2Fcommit-message%2Fparse.ts",
            "raw_url": "https://github.com/angular/angular/raw/bc5a8f4d37bcff2af21547ff8644f0a519efca69/dev-infra%2Fcommit-message%2Fparse.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fparse.ts?ref=bc5a8f4d37bcff2af21547ff8644f0a519efca69",
            "patch": "@@ -111,7 +111,7 @@ const parseOptions: Options&{notesPattern: (keywords: string) => RegExp} = {\n   headerPattern,\n   headerCorrespondence,\n   noteKeywords: [NoteSections.BREAKING_CHANGE, NoteSections.DEPRECATED],\n-  notesPattern: (keywords: string) => new RegExp(`(${keywords})(?:: ?)(.*)`),\n+  notesPattern: (keywords: string) => new RegExp(`(${keywords}): ?(.*)`),\n };\n \n /** Parse a commit message into its composite parts. */"
        },
        {
            "sha": "0c0b534ea5ddd3d0e22cb6c9941fde502e946d89",
            "filename": "dev-infra/commit-message/validate.spec.ts",
            "status": "modified",
            "additions": 130,
            "deletions": 9,
            "changes": 139,
            "blob_url": "https://github.com/angular/angular/blob/bc5a8f4d37bcff2af21547ff8644f0a519efca69/dev-infra%2Fcommit-message%2Fvalidate.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bc5a8f4d37bcff2af21547ff8644f0a519efca69/dev-infra%2Fcommit-message%2Fvalidate.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate.spec.ts?ref=bc5a8f4d37bcff2af21547ff8644f0a519efca69",
            "patch": "@@ -8,6 +8,7 @@\n \n // Imports\n import * as validateConfig from './config';\n+import {parseCommitMessage} from './parse';\n import {validateCommitMessage, ValidateCommitMessageResult} from './validate';\n \n type CommitMessageConfig = validateConfig.CommitMessageConfig;\n@@ -278,20 +279,110 @@ describe('validate-commit-message.js', () => {\n          });\n     });\n \n+    describe('deprecations', () => {\n+      it('should allow valid deprecation notes in commit messages', () => {\n+        const msgWithListOfDeprecations =\n+            'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'DEPRECATED:\\n' +\n+            ' * A to be removed\\n' +\n+            ' * B to be removed';\n+        expectValidationResult(validateCommitMessage(msgWithListOfDeprecations), VALID);\n+        expect(parseCommitMessage(msgWithListOfDeprecations).deprecations.length).toBe(1);\n+\n+        const msgWithSummary = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'DEPRECATED: All methods in X to be removed in v12.';\n+\n+        expectValidationResult(validateCommitMessage(msgWithSummary), VALID);\n+        expect(parseCommitMessage(msgWithSummary).deprecations.length).toBe(1);\n+\n+        const msgWithSummaryAndDescription =\n+            'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'DEPRECATED: All methods in X to be removed in v12.\\n' +\n+            '' +\n+            'This is the more detailed description about the deprecation of X.';\n+\n+        expectValidationResult(validateCommitMessage(msgWithSummaryAndDescription), VALID);\n+        expect(parseCommitMessage(msgWithSummaryAndDescription).deprecations.length).toBe(1);\n+\n+        const msgWithNoDeprecation =\n+            'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is not a\\n' +\n+            'deprecation commit.';\n+        expectValidationResult(validateCommitMessage(msgWithNoDeprecation), VALID);\n+        expect(parseCommitMessage(msgWithNoDeprecation).deprecations.length).toBe(0);\n+      });\n+\n+      it('should fail for non-valid deprecation notes in commit messages', () => {\n+        const incorrectKeyword1 = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'DEPRECATE:\\n' +\n+            ' * A to be removed\\n' +\n+            ' * B to be removed';\n+        expectValidationResult(\n+            validateCommitMessage(incorrectKeyword1), INVALID,\n+            ['The commit message body contains an invalid deprecation note.']);\n+\n+        const incorrectKeyword2 = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'DEPRECATES:\\n' +\n+            ' * A to be removed\\n' +\n+            ' * B to be removed';\n+        expectValidationResult(\n+            validateCommitMessage(incorrectKeyword2), INVALID,\n+            ['The commit message body contains an invalid deprecation note.']);\n+\n+        const incorrectKeyword3 = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'DEPRECATIONS:\\n' +\n+            ' * A to be removed\\n' +\n+            ' * B to be removed';\n+        expectValidationResult(\n+            validateCommitMessage(incorrectKeyword3), INVALID,\n+            ['The commit message body contains an invalid deprecation note.']);\n+      });\n+    });\n+\n     describe('breaking change', () => {\n       it('should allow valid breaking change commit descriptions', () => {\n         const msgWithSummary = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n             'This is a normal commit message body which does not exceed the max length\\n' +\n             'limit. For more details see the following super long URL:\\n\\n' +\n             'BREAKING CHANGE: This is a summary of a breaking change.';\n         expectValidationResult(validateCommitMessage(msgWithSummary), VALID);\n+        expect(parseCommitMessage(msgWithSummary).breakingChanges.length).toBe(1);\n \n-        const msgWithDescription = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n+        const msgWithDescriptionDoubleLineBreakSeparator =\n+            'feat(compiler): this is just a usual commit message title\\n\\n' +\n             'This is a normal commit message body which does not exceed the max length\\n' +\n             'limit. For more details see the following super long URL:\\n\\n' +\n             'BREAKING CHANGE:\\n\\n' +\n             'This is a full description of the breaking change.';\n-        expectValidationResult(validateCommitMessage(msgWithDescription), VALID);\n+        expectValidationResult(\n+            validateCommitMessage(msgWithDescriptionDoubleLineBreakSeparator), VALID);\n+        expect(\n+            parseCommitMessage(msgWithDescriptionDoubleLineBreakSeparator).breakingChanges.length)\n+            .toBe(1);\n+\n+        const msgWithDescriptionSingleLineBreakSeparator =\n+            'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING CHANGE:\\n' +\n+            'This is a full description of the breaking change.';\n+        expectValidationResult(\n+            validateCommitMessage(msgWithDescriptionSingleLineBreakSeparator), VALID);\n+        expect(\n+            parseCommitMessage(msgWithDescriptionSingleLineBreakSeparator).breakingChanges.length)\n+            .toBe(1);\n \n         const msgWithSummaryAndDescription =\n             'feat(compiler): this is just a usual commit message title\\n\\n' +\n@@ -300,11 +391,13 @@ describe('validate-commit-message.js', () => {\n             'BREAKING CHANGE: This is a summary of a breaking change.\\n\\n' +\n             'This is a full description of the breaking change.';\n         expectValidationResult(validateCommitMessage(msgWithSummaryAndDescription), VALID);\n+        expect(parseCommitMessage(msgWithSummaryAndDescription).breakingChanges.length).toBe(1);\n \n         const msgWithNonBreaking = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n             'This is not a\\n' +\n             'breaking change commit.';\n         expectValidationResult(validateCommitMessage(msgWithNonBreaking), VALID);\n+        expect(parseCommitMessage(msgWithNonBreaking).breakingChanges.length).toBe(0);\n       });\n \n       it('should fail for non-valid breaking change commit descriptions', () => {\n@@ -314,24 +407,25 @@ describe('validate-commit-message.js', () => {\n             'BREAKING CHANGE This is a summary of a breaking change.';\n         expectValidationResult(\n             validateCommitMessage(msgWithSummary), INVALID,\n-            [`The commit message body contains an invalid breaking change description.`]);\n+            [`The commit message body contains an invalid breaking change note.`]);\n \n         const msgWithPlural = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n             'This is a normal commit message body which does not exceed the max length\\n' +\n             'limit. For more details see the following super long URL:\\n\\n' +\n             'BREAKING CHANGES: This is a summary of a breaking change.';\n         expectValidationResult(\n             validateCommitMessage(msgWithPlural), INVALID,\n-            [`The commit message body contains an invalid breaking change description.`]);\n+            [`The commit message body contains an invalid breaking change note.`]);\n \n-        const msgWithDescription = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n+        const msgWithWithDashedKeyword =\n+            'feat(compiler): this is just a usual commit message title\\n\\n' +\n             'This is a normal commit message body which does not exceed the max length\\n' +\n             'limit. For more details see the following super long URL:\\n\\n' +\n-            'BREAKING CHANGE:\\n' +\n+            'BREAKING-CHANGE:' +\n             'This is a full description of the breaking change.';\n         expectValidationResult(\n-            validateCommitMessage(msgWithDescription), INVALID,\n-            [`The commit message body contains an invalid breaking change description.`]);\n+            validateCommitMessage(msgWithWithDashedKeyword), INVALID,\n+            [`The commit message body contains an invalid breaking change note.`]);\n \n         const msgWithSummaryAndDescription =\n             'feat(compiler): this is just a usual commit message title\\n\\n' +\n@@ -341,7 +435,34 @@ describe('validate-commit-message.js', () => {\n             'This is a full description of the breaking change.';\n         expectValidationResult(\n             validateCommitMessage(msgWithSummaryAndDescription), INVALID,\n-            [`The commit message body contains an invalid breaking change description.`]);\n+            [`The commit message body contains an invalid breaking change note.`]);\n+\n+        const incorrectKeyword1 = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING CHANGES:\\n' +\n+            ' * A has been removed\\n';\n+        expectValidationResult(\n+            validateCommitMessage(incorrectKeyword1), INVALID,\n+            ['The commit message body contains an invalid breaking change note.']);\n+\n+        const incorrectKeyword2 = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING-CHANGE:\\n' +\n+            ' * A has been removed\\n';\n+        expectValidationResult(\n+            validateCommitMessage(incorrectKeyword2), INVALID,\n+            ['The commit message body contains an invalid breaking change note.']);\n+\n+        const incorrectKeyword3 = 'feat(compiler): this is just a usual commit message title\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING-CHANGES:\\n' +\n+            ' * A has been removed\\n';\n+        expectValidationResult(\n+            validateCommitMessage(incorrectKeyword3), INVALID,\n+            ['The commit message body contains an invalid breaking change note.']);\n       });\n     });\n   });"
        },
        {
            "sha": "4a9215d602fec48d152f954dd62275e387d79822",
            "filename": "dev-infra/commit-message/validate.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 14,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/bc5a8f4d37bcff2af21547ff8644f0a519efca69/dev-infra%2Fcommit-message%2Fvalidate.ts",
            "raw_url": "https://github.com/angular/angular/raw/bc5a8f4d37bcff2af21547ff8644f0a519efca69/dev-infra%2Fcommit-message%2Fvalidate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate.ts?ref=bc5a8f4d37bcff2af21547ff8644f0a519efca69",
            "patch": "@@ -26,16 +26,29 @@ export interface ValidateCommitMessageResult {\n \n /** Regex matching a URL for an entire commit body line. */\n const COMMIT_BODY_URL_LINE_RE = /^https?:\\/\\/.*$/;\n+\n /**\n- * Regex matching a breaking change.\n+ * Regular expression matching potential misuse of the `BREAKING CHANGE:` marker in a\n+ * commit message. Commit messages containing one of the following snippets will fail:\n  *\n- * - Starts with BREAKING CHANGE\n- * - Followed by a colon\n- * - Followed by a single space or two consecutive new lines\n+ *   - `BREAKING CHANGE <some-content>` | Here we assume the colon is missing by accident.\n+ *   - `BREAKING-CHANGE: <some-content>` | The wrong keyword is used here.\n+ *   - `BREAKING CHANGES: <some-content>` | The wrong keyword is used here.\n+ *   - `BREAKING-CHANGES: <some-content>` | The wrong keyword is used here.\n+ */\n+const INCORRECT_BREAKING_CHANGE_BODY_RE =\n+    /^(BREAKING CHANGE[^:]|BREAKING-CHANGE|BREAKING[ -]CHANGES)/m;\n+\n+/**\n+ * Regular expression matching potential misuse of the `DEPRECATED:` marker in a commit\n+ * message. Commit messages containing one of the following snippets will fail:\n  *\n- * NB: Anything after `BREAKING CHANGE` is optional to facilitate the validation.\n+ *   - `DEPRECATED <some-content>` | Here we assume the colon is missing by accident.\n+ *   - `DEPRECATIONS: <some-content>` | The wrong keyword is used here.\n+ *   - `DEPRECATE: <some-content>` | The wrong keyword is used here.\n+ *   - `DEPRECATES: <some-content>` | The wrong keyword is used here.\n  */\n-const COMMIT_BODY_BREAKING_CHANGE_RE = /^BREAKING CHANGE(:( |\\n{2}))?/m;\n+const INCORRECT_DEPRECATION_BODY_RE = /^(DEPRECATED[^:]|DEPRECATIONS|DEPRECATE:|DEPRECATES)/m;\n \n /** Validate a commit message against using the local repo's config. */\n export function validateCommitMessage(\n@@ -161,14 +174,14 @@ export function validateCommitMessage(\n     // Breaking change\n     // Check if the commit message contains a valid break change description.\n     // https://github.com/angular/angular/blob/88fbc066775ab1a2f6a8c75f933375b46d8fa9a4/CONTRIBUTING.md#commit-message-footer\n-    const hasBreakingChange = COMMIT_BODY_BREAKING_CHANGE_RE.exec(commit.fullText);\n-    if (hasBreakingChange !== null) {\n-      const [, breakingChangeDescription] = hasBreakingChange;\n-      if (!breakingChangeDescription) {\n-        // Not followed by :, space or two consecutive new lines,\n-        errors.push(`The commit message body contains an invalid breaking change description.`);\n-        return false;\n-      }\n+    if (INCORRECT_BREAKING_CHANGE_BODY_RE.test(commit.fullText)) {\n+      errors.push(`The commit message body contains an invalid breaking change note.`);\n+      return false;\n+    }\n+\n+    if (INCORRECT_DEPRECATION_BODY_RE.test(commit.fullText)) {\n+      errors.push(`The commit message body contains an invalid deprecation note.`);\n+      return false;\n     }\n \n     return true;"
        },
        {
            "sha": "0d27dd2800f86ac8ac0f4a7922c450d6d4d0aa80",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 24,
            "deletions": 15,
            "changes": 39,
            "blob_url": "https://github.com/angular/angular/blob/bc5a8f4d37bcff2af21547ff8644f0a519efca69/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/bc5a8f4d37bcff2af21547ff8644f0a519efca69/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=bc5a8f4d37bcff2af21547ff8644f0a519efca69",
            "patch": "@@ -1843,7 +1843,7 @@ const parseOptions = {\n     headerPattern,\n     headerCorrespondence,\n     noteKeywords: [NoteSections.BREAKING_CHANGE, NoteSections.DEPRECATED],\n-    notesPattern: (keywords) => new RegExp(`(${keywords})(?:: ?)(.*)`),\n+    notesPattern: (keywords) => new RegExp(`(${keywords}): ?(.*)`),\n };\n /** Parse a commit message into its composite parts. */\n const parseCommitMessage = parseInternal;\n@@ -1902,15 +1902,25 @@ function parseInternal(fullText) {\n /** Regex matching a URL for an entire commit body line. */\n const COMMIT_BODY_URL_LINE_RE = /^https?:\\/\\/.*$/;\n /**\n- * Regex matching a breaking change.\n+ * Regular expression matching potential misuse of the `BREAKING CHANGE:` marker in a\n+ * commit message. Commit messages containing one of the following snippets will fail:\n  *\n- * - Starts with BREAKING CHANGE\n- * - Followed by a colon\n- * - Followed by a single space or two consecutive new lines\n+ *   - `BREAKING CHANGE <some-content>` | Here we assume the colon is missing by accident.\n+ *   - `BREAKING-CHANGE: <some-content>` | The wrong keyword is used here.\n+ *   - `BREAKING CHANGES: <some-content>` | The wrong keyword is used here.\n+ *   - `BREAKING-CHANGES: <some-content>` | The wrong keyword is used here.\n+ */\n+const INCORRECT_BREAKING_CHANGE_BODY_RE = /^(BREAKING CHANGE[^:]|BREAKING-CHANGE|BREAKING[ -]CHANGES)/m;\n+/**\n+ * Regular expression matching potential misuse of the `DEPRECATED:` marker in a commit\n+ * message. Commit messages containing one of the following snippets will fail:\n  *\n- * NB: Anything after `BREAKING CHANGE` is optional to facilitate the validation.\n+ *   - `DEPRECATED <some-content>` | Here we assume the colon is missing by accident.\n+ *   - `DEPRECATIONS: <some-content>` | The wrong keyword is used here.\n+ *   - `DEPRECATE: <some-content>` | The wrong keyword is used here.\n+ *   - `DEPRECATES: <some-content>` | The wrong keyword is used here.\n  */\n-const COMMIT_BODY_BREAKING_CHANGE_RE = /^BREAKING CHANGE(:( |\\n{2}))?/m;\n+const INCORRECT_DEPRECATION_BODY_RE = /^(DEPRECATED[^:]|DEPRECATIONS|DEPRECATE:|DEPRECATES)/m;\n /** Validate a commit message against using the local repo's config. */\n function validateCommitMessage(commitMsg, options = {}) {\n     const config = getCommitMessageConfig().commitMessage;\n@@ -2008,14 +2018,13 @@ function validateCommitMessage(commitMsg, options = {}) {\n         // Breaking change\n         // Check if the commit message contains a valid break change description.\n         // https://github.com/angular/angular/blob/88fbc066775ab1a2f6a8c75f933375b46d8fa9a4/CONTRIBUTING.md#commit-message-footer\n-        const hasBreakingChange = COMMIT_BODY_BREAKING_CHANGE_RE.exec(commit.fullText);\n-        if (hasBreakingChange !== null) {\n-            const [, breakingChangeDescription] = hasBreakingChange;\n-            if (!breakingChangeDescription) {\n-                // Not followed by :, space or two consecutive new lines,\n-                errors.push(`The commit message body contains an invalid breaking change description.`);\n-                return false;\n-            }\n+        if (INCORRECT_BREAKING_CHANGE_BODY_RE.test(commit.fullText)) {\n+            errors.push(`The commit message body contains an invalid breaking change note.`);\n+            return false;\n+        }\n+        if (INCORRECT_DEPRECATION_BODY_RE.test(commit.fullText)) {\n+            errors.push(`The commit message body contains an invalid deprecation note.`);\n+            return false;\n         }\n         return true;\n     }"
        }
    ],
    "stats": {
        "total": 221,
        "additions": 182,
        "deletions": 39
    }
}