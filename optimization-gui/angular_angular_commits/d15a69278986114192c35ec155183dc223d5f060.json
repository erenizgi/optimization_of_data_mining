{
    "author": "devversion",
    "message": "build: enable `esModuleInterop` in TypeScript compilations (#43431)\n\nEnables the `esModuleInterop` for all TypeScript compilations in the\nproject. This allows us to emit proper ESM-compatible code. e.g.\nconsider the following import:\n\n```ts\nimport * as ts from 'typescript';\n```\n\nThis import currently will break at runtime in NodeJS because the\n`typescript` package is not shipping ESM. It's still a CommonJS module.\nES modules are able to import from `typescript` though, using an import\nstatement as above, but everything in `module.exports` is being exposed\nas the `default` named export. TypeScript at runtime does not have any\nother named exports, so for actual ESM compatibility, all of our imports\nneed to be switched to:\n\n```\nimport ts from 'typescript';\n```\n\nThe `esModuleInterop` option allows this to work even though the\n`d.ts` file of TS currently suggests that there are _only_ named exports.\nThe TypeScript language service will now suggest the correct import form as\nshown above. It doesn't enforce that unfortunately, but this commit also\nadds a lint rule that enforces certain patterns so that we emit imports\nthat are compatible with both ESM and CJS output (CJS still needed here\nsince tests run with CJS devmode output still; this is a future project\nto switch that over to ESM!)\n\nPR Close #43431",
    "sha": "d15a69278986114192c35ec155183dc223d5f060",
    "files": [
        {
            "sha": "90e4dab8d9183e4e27005eefaa85975f4f8b9faf",
            "filename": "packages/bazel/src/ngc-wrapped/tsconfig.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d15a69278986114192c35ec155183dc223d5f060/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2Ftsconfig.json",
            "raw_url": "https://github.com/angular/angular/raw/d15a69278986114192c35ec155183dc223d5f060/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2Ftsconfig.json?ref=d15a69278986114192c35ec155183dc223d5f060",
            "patch": "@@ -2,6 +2,7 @@\n   \"compilerOptions\": {\n     \"lib\": [\"es5\", \"es2015.collection\", \"es2015.core\"],\n     \"types\": [\"node\"],\n+    \"esModuleInterop\": true,\n     \"downlevelIteration\": true\n   }\n }"
        },
        {
            "sha": "27305ea3303bd2975940d0c48e9d1d1ccfb55ae6",
            "filename": "packages/bazel/test/ngc-wrapped/tsconfig.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/d15a69278986114192c35ec155183dc223d5f060/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Ftsconfig.json",
            "raw_url": "https://github.com/angular/angular/raw/d15a69278986114192c35ec155183dc223d5f060/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Ftsconfig.json?ref=d15a69278986114192c35ec155183dc223d5f060",
            "patch": "@@ -1,6 +1,7 @@\n {\n   \"compilerOptions\": {\n     \"lib\": [\"es5\", \"es2015.collection\", \"es2015.core\"],\n-    \"types\": [\"node\", \"jasmine\"]\n+    \"types\": [\"node\", \"jasmine\"],\n+    \"esModuleInterop\": true\n   }\n }"
        },
        {
            "sha": "19f7b0654d7ca0f8127af1e5d3ffeb7f8dbc02e4",
            "filename": "packages/core/schematics/tsconfig.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/d15a69278986114192c35ec155183dc223d5f060/packages%2Fcore%2Fschematics%2Ftsconfig.json",
            "raw_url": "https://github.com/angular/angular/raw/d15a69278986114192c35ec155183dc223d5f060/packages%2Fcore%2Fschematics%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftsconfig.json?ref=d15a69278986114192c35ec155183dc223d5f060",
            "patch": "@@ -4,6 +4,7 @@\n     \"noImplicitOverride\": true,\n     \"useUnknownInCatchVariables\": false,\n     \"noFallthroughCasesInSwitch\": true,\n+    \"esModuleInterop\": true,\n     \"strict\": true,\n     \"moduleResolution\": \"node\",\n     \"target\": \"es2019\",\n@@ -14,7 +15,7 @@\n       \"@angular/core\": [\"../\"],\n       \"@angular/compiler\": [\"../../compiler\"],\n       \"@angular/compiler-cli\": [\"../../compiler-cli\"],\n-      \"@angular/compiler-cli/private/*\": [\"../../compiler-cli/private/*\"],\n+      \"@angular/compiler-cli/private/*\": [\"../../compiler-cli/private/*\"]\n     }\n   },\n   \"bazelOptions\": {"
        },
        {
            "sha": "8a6d7437985dddaf4f55df294a0c2db91d89b521",
            "filename": "packages/tsconfig-build.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d15a69278986114192c35ec155183dc223d5f060/packages%2Ftsconfig-build.json",
            "raw_url": "https://github.com/angular/angular/raw/d15a69278986114192c35ec155183dc223d5f060/packages%2Ftsconfig-build.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Ftsconfig-build.json?ref=d15a69278986114192c35ec155183dc223d5f060",
            "patch": "@@ -10,6 +10,7 @@\n     \"noImplicitAny\": true,\n     \"noImplicitOverride\": true,\n     \"strictNullChecks\": true,\n+    \"esModuleInterop\": true,\n     \"useUnknownInCatchVariables\": false,\n     \"strict\": true,\n     \"strictPropertyInitialization\": true,"
        },
        {
            "sha": "3a6a986968b77ecaf1e7efecb16897188d91f732",
            "filename": "packages/tsconfig.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d15a69278986114192c35ec155183dc223d5f060/packages%2Ftsconfig.json",
            "raw_url": "https://github.com/angular/angular/raw/d15a69278986114192c35ec155183dc223d5f060/packages%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Ftsconfig.json?ref=d15a69278986114192c35ec155183dc223d5f060",
            "patch": "@@ -10,6 +10,7 @@\n     \"module\": \"es2020\",\n     \"strict\": true,\n     \"moduleResolution\": \"node\",\n+    \"esModuleInterop\": true,\n     \"strictNullChecks\": true,\n     \"strictPropertyInitialization\": true,\n     \"outDir\": \"../dist/all/@angular\","
        },
        {
            "sha": "4da6132edaf1a522facc09e69c147470b752bb08",
            "filename": "tools/tsconfig.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d15a69278986114192c35ec155183dc223d5f060/tools%2Ftsconfig.json",
            "raw_url": "https://github.com/angular/angular/raw/d15a69278986114192c35ec155183dc223d5f060/tools%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Ftsconfig.json?ref=d15a69278986114192c35ec155183dc223d5f060",
            "patch": "@@ -5,6 +5,7 @@\n     \"emitDecoratorMetadata\": true,\n     \"experimentalDecorators\": true,\n     \"module\": \"commonjs\",\n+    \"esModuleInterop\": true,\n     \"moduleResolution\": \"node\",\n     \"outDir\": \"../dist/tools/\",\n     \"noImplicitAny\": true,"
        },
        {
            "sha": "ab14b11f68d9005b0ef16d492f10972cfe39443c",
            "filename": "tools/tslint/validateImportForEsmCjsInteropRule.ts",
            "status": "added",
            "additions": 103,
            "deletions": 0,
            "changes": 103,
            "blob_url": "https://github.com/angular/angular/blob/d15a69278986114192c35ec155183dc223d5f060/tools%2Ftslint%2FvalidateImportForEsmCjsInteropRule.ts",
            "raw_url": "https://github.com/angular/angular/raw/d15a69278986114192c35ec155183dc223d5f060/tools%2Ftslint%2FvalidateImportForEsmCjsInteropRule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Ftslint%2FvalidateImportForEsmCjsInteropRule.ts?ref=d15a69278986114192c35ec155183dc223d5f060",
            "patch": "@@ -0,0 +1,103 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {RuleFailure, WalkContext} from 'tslint/lib';\n+import {AbstractRule} from 'tslint/lib/rules';\n+import ts from 'typescript';\n+\n+// TODO(devversion): move this rule into dev-infra.\n+\n+const noNamedExportsError =\n+    'Named import is not allowed. The module does not expose named exports when ' +\n+    'imported in an ES module. Use a default import instead.';\n+\n+const noDefaultExportError =\n+    'Default import is not allowed. The module does not expose a default export at ' +\n+    'runtime. Use a named import instead.';\n+\n+interface RuleOptions {\n+  /**\n+   * List of modules without any named exports that NodeJS can statically detect when the\n+   * CommonJS module is imported from ESM. Node only exposes named exports which are\n+   * statically discoverable: https://nodejs.org/api/esm.html#esm_import_statements.\n+   */\n+  noNamedExports?: string[];\n+  /**\n+   * List of modules which appear to have named exports in the typings but do\n+   * not have any at runtime due to NodeJS not being able to discover these\n+   * through static analysis: https://nodejs.org/api/esm.html#esm_import_statements.\n+   * */\n+  noDefaultExport?: string[];\n+  /**\n+   * List of modules which are always incompatible. The rule allows for a custom\n+   * message to be provided when it discovers an import to such a module.\n+   */\n+  incompatibleModules?: Record<string, string>;\n+}\n+\n+/**\n+ * Rule that blocks named imports from being used for certain configured module\n+ * specifiers. This is helpful for enforcing an ESM-compatible interop with CommonJS\n+ * modules which do not expose named bindings at runtime.\n+ *\n+ * For example, consider the `typescript` module. It does not statically expose named\n+ * exports even though the type definition suggests it. An import like the following\n+ * will break at runtime when the `typescript` CommonJS module is imported inside an ESM.\n+ *\n+ * ```\n+ * import * as ts from 'typescript';\n+ * console.log(ts.SyntaxKind.CallExpression); // `SyntaxKind is undefined`.\n+ * ```\n+ *\n+ * More details here: https://nodejs.org/api/esm.html#esm_import_statements.\n+ */\n+export class Rule extends AbstractRule {\n+  override apply(sourceFile: ts.SourceFile): RuleFailure[] {\n+    const options = this.getOptions().ruleArguments[0];\n+    return this.applyWithFunction(sourceFile, (ctx) => visitNode(sourceFile, ctx, options));\n+  }\n+}\n+\n+function visitNode(node: ts.Node, ctx: WalkContext, options: RuleOptions) {\n+  if (options.incompatibleModules && ts.isImportDeclaration(node)) {\n+    const specifier = node.moduleSpecifier as ts.StringLiteral;\n+    const failureMsg = options.incompatibleModules[specifier.text];\n+\n+    if (failureMsg !== undefined) {\n+      ctx.addFailureAtNode(node, failureMsg);\n+      return;\n+    }\n+  }\n+\n+  if (options.noNamedExports && isNamedImportToDisallowedModule(node, options.noNamedExports)) {\n+    ctx.addFailureAtNode(node, noNamedExportsError);\n+  }\n+\n+  if (options.noDefaultExport && isDefaultImportToDisallowedModule(node, options.noDefaultExport)) {\n+    ctx.addFailureAtNode(node, noDefaultExportError);\n+  }\n+\n+  ts.forEachChild(node, (node) => visitNode(node, ctx, options));\n+}\n+\n+function isNamedImportToDisallowedModule(node: ts.Node, disallowed: string[]): boolean {\n+  if (!ts.isImportDeclaration(node) || node.importClause === undefined) {\n+    return false;\n+  }\n+  const specifier = node.moduleSpecifier as ts.StringLiteral;\n+  return !!node.importClause.namedBindings && disallowed.includes(specifier.text);\n+}\n+\n+function isDefaultImportToDisallowedModule(node: ts.Node, disallowed: string[]) {\n+  if (!ts.isImportDeclaration(node) || node.importClause === undefined) {\n+    return false;\n+  }\n+  const specifier = node.moduleSpecifier as ts.StringLiteral;\n+\n+  return node.importClause.name !== undefined && disallowed.includes(specifier.text);\n+}"
        },
        {
            "sha": "cdac3ee7b0d0931927c09f8cc00c8a3bdf433bbe",
            "filename": "tslint.json",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/d15a69278986114192c35ec155183dc223d5f060/tslint.json",
            "raw_url": "https://github.com/angular/angular/raw/d15a69278986114192c35ec155183dc223d5f060/tslint.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tslint.json?ref=d15a69278986114192c35ec155183dc223d5f060",
            "patch": "@@ -13,7 +13,26 @@\n     // Custom rules written in TypeScript.\n     \"require-internal-with-underscore\": true,\n     \"no-implicit-override-abstract\": true,\n-\n+    \"validate-import-for-esm-cjs-interop\": [true, {\n+      // The following CommonJS modules have type definitions that suggest the existence of\n+      // named exports. This is not true at runtime when imported from an ES module (because\n+      // the ESM interop only exposes statically-discoverable named exports). Instead\n+      // default imports should be used to ensure compatibility with both ESM or CommonJS.\n+      \"noNamedExports\": [\"typescript\", \"minimist\", \"magic-string\", \"semver\", \"yargs\", \"glob\", \"cluster\", \"convert-source-map\"],\n+      // The following CommonJS modules appear to have a default export available (due to the `esModuleInterop` flag),\n+      // but at runtime with CJS (e.g. for devmode output/tests) there is no default export as these modules set\n+      // `__esModule`. This does not match with what happens in ESM NodeJS runtime where NodeJS exposes\n+      // `module.exports` as `export default`. Instead, named exports should be used for compat with CJS/ESM.\n+      \"noDefaultExport\": [],\n+      // List of modules which are incompatible and should never be imported at all.\n+      \"incompatibleModules\": {\n+        // `@babel/core` and `@babel/types` suggest named exports which do not exist at runtime within ESM\n+        // (as these named exports are not statically discoverable by NodeJS). At the same time, these modules\n+        // set `__esModule` and the default import does not exist for CJS at runtime (e.g. breaking tests).\n+        \"@babel/core\": \"This module is incompatible with the ESM/CJS interop. Use the custom interop file.\",\n+        \"@babel/types\": \"This module is incompatible with the ESM/CJS interop. Use the custom interop file and import the `types` namespace.\"\n+      }\n+    }],\n     \"eofline\": true,\n     \"file-header\": [\n       true,"
        }
    ],
    "stats": {
        "total": 134,
        "additions": 131,
        "deletions": 3
    }
}