{
    "author": "kapunahelewong",
    "message": "docs: add metadata documentation to httpClient (#41706)\n\nPR Close #41706",
    "sha": "09abee359dcde4922684627fbb4bc52fe6ee462d",
    "files": [
        {
            "sha": "2eb562625df56ba67ad85bd229b430e44ac9dd67",
            "filename": "aio/content/examples/http/src/app/http-interceptors/retry-interceptor.ts",
            "status": "added",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/09abee359dcde4922684627fbb4bc52fe6ee462d/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fhttp-interceptors%2Fretry-interceptor.ts",
            "raw_url": "https://github.com/angular/angular/raw/09abee359dcde4922684627fbb4bc52fe6ee462d/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fhttp-interceptors%2Fretry-interceptor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fhttp-interceptors%2Fretry-interceptor.ts?ref=09abee359dcde4922684627fbb4bc52fe6ee462d",
            "patch": "@@ -0,0 +1,50 @@\n+// #docplaster\n+import {HttpClient, HttpContext, HttpContextToken, HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\n+import {Observable} from 'rxjs';\n+/*\n+// #docregion reading-context\n+import {retry} from 'rxjs';\n+// #enddocregion reading-context\n+*/\n+// #docregion mutable-context\n+import {retry, tap} from 'rxjs/operators';\n+// #enddocregion mutable-context\n+\n+// #docregion context-token, mutable-context\n+export const RETRY_COUNT = new HttpContextToken(() => 3);\n+// #enddocregion context-token\n+export const ERROR_COUNT = new HttpContextToken(() => 0);\n+// #enddocregion mutable-context\n+\n+export class FakeService {\n+  constructor(private httpClient: HttpClient) {\n+    // #docregion set-context\n+    this.httpClient\n+        .get('/data/feed', {\n+          context: new HttpContext().set(RETRY_COUNT, 5),\n+        })\n+        .subscribe(results => {/* ... */});\n+    // #enddocregion set-context\n+  }\n+}\n+\n+// #docregion reading-context, mutable-context\n+\n+export class RetryInterceptor implements HttpInterceptor {\n+  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n+    const retryCount = req.context.get(RETRY_COUNT);\n+\n+    return next.handle(req).pipe(\n+        // #enddocregion reading-context\n+        tap(null,\n+            () => {\n+              // An error has occurred, so increment this request's ERROR_COUNT.\n+              req.set(ERROR_COUNT, req.get(ERROR_COUNT) + 1);\n+            }),\n+        // #docregion reading-context\n+        // Retry the request a configurable number of times.\n+        retry(retryCount),\n+    );\n+  }\n+}\n+// #enddocregion reading-context, mutable-context"
        },
        {
            "sha": "70bd85f10f1e537aeb1c5777271e8d932dab67c6",
            "filename": "aio/content/guide/http.md",
            "status": "modified",
            "additions": 48,
            "deletions": 1,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/09abee359dcde4922684627fbb4bc52fe6ee462d/aio%2Fcontent%2Fguide%2Fhttp.md",
            "raw_url": "https://github.com/angular/angular/raw/09abee359dcde4922684627fbb4bc52fe6ee462d/aio%2Fcontent%2Fguide%2Fhttp.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fhttp.md?ref=09abee359dcde4922684627fbb4bc52fe6ee462d",
            "patch": "@@ -812,7 +812,7 @@ Neither `tap` nor `finalize` touch the values of the observable stream returned\n Interceptors can be used to replace the built-in JSON parsing with a custom implementation.\n \n The `CustomJsonInterceptor` in the following example demonstrates how to achieve this.\n-If the intercepted request expects a `'json'` response, the `reponseType` is changed to `'text'`\n+If the intercepted request expects a `'json'` response, the `responseType` is changed to `'text'`\n to disable the built-in JSON parsing. Then the response is parsed via the injected `JsonParser`.\n \n <code-example\n@@ -1197,3 +1197,50 @@ Alternatively, you can call `request.error()` with an `ErrorEvent`.\n   path=\"http/src/testing/http-client.spec.ts\"\n   region=\"network-error\">\n </code-example>\n+\n+\n+## Passing metadata to interceptors\n+\n+Many interceptors require or benefit from configuration. Consider an interceptor that retries failed requests.\n+By default, the interceptor might retry a request three times, but you might want to override this retry count for particularly error-prone or sensitive requests.\n+\n+`HttpClient` requests contain a _context_ that can carry metadata about the request.\n+This context is available for interceptors to read or modify, though it is not transmitted to the backend server when the request is sent.\n+This allows applications or other interceptors to tag requests with configuration parameters, such as how many times to retry a request.\n+\n+### Creating a context token\n+\n+Angular stores and retrieves a value in the context using an `HttpContextToken`.\n+You can create a context token using the `new` operator, as in the following example:\n+\n+<code-example path=\"http/src/app/http-interceptors/retry-interceptor.ts\" region=\"context-token\" header=\"creating a context token\"></code-example>\n+\n+The lambda function `() => 3` passed during the creation of the `HttpContextToken` serves two purposes:\n+\n+1. It allows TypeScript to infer the type of this token: `HttpContextToken<number>`.\n+  The request context is type-safe&mdash;reading a token from a request's context returns a value of the appropriate type.\n+\n+1. It sets the default value for the token.\n+  This is the value that the request context returns if no other value has been set for this token.\n+  Using a default value avoids the need to check if a particular value is set.\n+\n+### Setting context values when making a request\n+\n+When making a request, you can provide an `HttpContext` instance, in which you have already set the context values.\n+\n+<code-example path=\"http/src/app/http-interceptors/retry-interceptor.ts\" region=\"set-context\" header=\"setting context values\"></code-example>\n+\n+### Reading context values in an interceptor\n+\n+Within an interceptor, you can read the value of a token in a given request's context with `HttpContext.get()`.\n+If you have not explicitly set a value for the token, Angular returns the default value specified in the token.\n+\n+<code-example path=\"http/src/app/http-interceptors/retry-interceptor.ts\" region=\"reading-context\" header=\"reading context values in an interceptor\"></code-example>\n+\n+### Contexts are mutable\n+\n+Unlike most other aspects of `HttpRequest` instances, the request context is mutable and persists across other immutable transformations of the request.\n+This allows interceptors to coordinate operations through the context.\n+For instance, the `RetryInterceptor` example could use a second context token to track how many errors occur during the execution of a given request:\n+\n+<code-example path=\"http/src/app/http-interceptors/retry-interceptor.ts\" region=\"mutable-context\" header=\"coordinating operations through the context\"></code-example>"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 98,
        "deletions": 1
    }
}