{
    "author": "petebacondarwin",
    "message": "fix(localize): install `@angular/localize` in `devDependencies` by default (#38680)\n\nPreviously this package was installed in the default `dependencies` section\nof `package.json`, but this meant that its own dependencies are treated as\ndependencies of the main project: Babel, for example.\n\nGenerally, $localize` is not used at runtime - it is compiled out by the\ntranslation tooling, so there is no need for it to be a full dependency.\nIn fact, even if it is used at runtime, the package itself is only used\nat dev-time since the runtime bits will be bundled into a distributable.\nSo putting this package in `devDependencies` would only prevent libraries\nfrom bringing the package into application projects that used them. This\nis probably good in itself, since it should be up to the downstream project\nto decide if it wants to include `@angular/localize` at runtime.\n\nThis commit changes the default location of the package to be the\n`devDependencies` section, but gives an option `useAtRuntime` to choose\notherwise.\n\nFixes #38329\n\nPR Close #38680",
    "sha": "50f4d8a1ce9e154e1c030ad1f172bdf18516d07a",
    "files": [
        {
            "sha": "318f3b51a32da3a992b03392d63ce3d5c2608375",
            "filename": "packages/localize/package.json",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fpackage.json?ref=50f4d8a1ce9e154e1c030ad1f172bdf18516d07a",
            "patch": "@@ -16,6 +16,9 @@\n   \"ng-update\": {\n     \"packageGroup\": \"NG_UPDATE_PACKAGE_GROUP\"\n   },\n+  \"ng-add\": {\n+    \"save\": \"devDependencies\"\n+  },\n   \"sideEffects\": [\n     \"**/init/index.js\",\n     \"**/init.js\",\n@@ -36,4 +39,4 @@\n   \"publishConfig\": {\n     \"registry\": \"https://wombat-dressing-room.appspot.com\"\n   }\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "394ff4ef8a59d8ad45f1c48197a12ea8bb2caf8f",
            "filename": "packages/localize/schematics/ng-add/README.md",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fschematics%2Fng-add%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fschematics%2Fng-add%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fschematics%2Fng-add%2FREADME.md?ref=50f4d8a1ce9e154e1c030ad1f172bdf18516d07a",
            "patch": "@@ -3,4 +3,8 @@\n This schematic will be executed when an Angular CLI user runs `ng add @angular/localize`.\n \n It will search their `angular.json` file, and find polyfills and main files for server builders.\n-Then it will add the `@angular/localize/init` polyfill that `@angular/localize` needs to work.\n\\ No newline at end of file\n+Then it will add the `@angular/localize/init` polyfill that `@angular/localize` needs to work.\n+\n+If the user specifies that they want to use `$localize` at runtime then the dependency will be\n+added to the `depdendencies` section of `package.json` rather than in the `devDependencies` which\n+is the default.\n\\ No newline at end of file"
        },
        {
            "sha": "91c14dea2dd4eeff0ce4387b691bb5d107c44c38",
            "filename": "packages/localize/schematics/ng-add/index.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fschematics%2Fng-add%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fschematics%2Fng-add%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fschematics%2Fng-add%2Findex.ts?ref=50f4d8a1ce9e154e1c030ad1f172bdf18516d07a",
            "patch": "@@ -9,7 +9,9 @@\n  */\n \n import {virtualFs, workspaces} from '@angular-devkit/core';\n-import {chain, Rule, SchematicsException, Tree} from '@angular-devkit/schematics';\n+import {chain, noop, Rule, SchematicContext, SchematicsException, Tree} from '@angular-devkit/schematics';\n+import {NodePackageInstallTask} from '@angular-devkit/schematics/tasks';\n+import {addPackageJsonDependency, NodeDependencyType, removePackageJsonDependency} from '@schematics/angular/utility/dependencies';\n import {getWorkspace} from '@schematics/angular/utility/workspace';\n import {Builders} from '@schematics/angular/utility/workspace-models';\n \n@@ -95,6 +97,22 @@ function prependToTargetFiles(\n   };\n }\n \n+function moveToDependencies(host: Tree, context: SchematicContext) {\n+  if (host.exists('package.json')) {\n+    // Remove the previous dependency and add in a new one under the desired type.\n+    removePackageJsonDependency(host, '@angular/localize');\n+    addPackageJsonDependency(host, {\n+      name: '@angular/localize',\n+      type: NodeDependencyType.Default,\n+      version: `~0.0.0-PLACEHOLDER`\n+    });\n+\n+    // Add a task to run the package manager. This is necessary because we updated\n+    // \"package.json\" and we want lock files to reflect this.\n+    context.addTask(new NodePackageInstallTask());\n+  }\n+}\n+\n export default function(options: Schema): Rule {\n   return async (host: Tree) => {\n     if (!options.name) {\n@@ -117,6 +135,9 @@ ${localizePolyfill}\n     return chain([\n       prependToTargetFiles(project, Builders.Browser, 'polyfills', localizeStr),\n       prependToTargetFiles(project, Builders.Server, 'main', localizeStr),\n+      // If `$localize` will be used at runtime then must install `@angular/localize`\n+      // into `dependencies`, rather than the default of `devDependencies`.\n+      options.useAtRuntime ? moveToDependencies : noop()\n     ]);\n   };\n }"
        },
        {
            "sha": "fabd645919a8ce3946fba23e5cdc80a4554f4c88",
            "filename": "packages/localize/schematics/ng-add/index_spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fschematics%2Fng-add%2Findex_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fschematics%2Fng-add%2Findex_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fschematics%2Fng-add%2Findex_spec.ts?ref=50f4d8a1ce9e154e1c030ad1f172bdf18516d07a",
            "patch": "@@ -33,6 +33,13 @@ export { renderModule, renderModuleFactory } from '@angular/platform-server';`;\n \n   beforeEach(() => {\n     host = new UnitTestTree(new HostTree());\n+    host.create('package.json', JSON.stringify({\n+      'devDependencies': {\n+        // The default (according to `ng-add` in its package.json) is for `@angular/localize` to be\n+        // saved to `devDependencies`.\n+        '@angular/localize': '~0.0.0-PLACEHOLDER',\n+      }\n+    }));\n     host.create('src/polyfills.ts', polyfillsContent);\n     host.create('src/another-polyfills.ts', polyfillsContent);\n     host.create('src/unrelated-polyfills.ts', polyfillsContent);\n@@ -166,4 +173,22 @@ export { renderModule, renderModuleFactory } from '@angular/platform-server';`;\n     }));\n     await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n   });\n+\n+  it('should add package to `devDependencies` by default', async () => {\n+    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n+    const packageJsonText = host.readContent('/package.json');\n+    expect(JSON.parse(packageJsonText).devDependencies?.['@angular/localize'])\n+        .toBe('~0.0.0-PLACEHOLDER');\n+    expect(JSON.parse(packageJsonText).dependencies?.['@angular/localize']).toBeUndefined();\n+  });\n+\n+  it('should add package to `dependencies` if `useAtRuntime` is `true`', async () => {\n+    host = await schematicRunner\n+               .runSchematicAsync('ng-add', {...defaultOptions, useAtRuntime: true}, host)\n+               .toPromise();\n+    const packageJsonText = host.readContent('/package.json');\n+    expect(JSON.parse(packageJsonText).dependencies?.['@angular/localize'])\n+        .toBe('~0.0.0-PLACEHOLDER');\n+    expect(JSON.parse(packageJsonText).devDependencies?.['@angular/localize']).toBeUndefined();\n+  });\n });"
        },
        {
            "sha": "a96090d97e1e58ac6531513db4865a8cb8a33d73",
            "filename": "packages/localize/schematics/ng-add/schema.d.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fschematics%2Fng-add%2Fschema.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fschematics%2Fng-add%2Fschema.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fschematics%2Fng-add%2Fschema.d.ts?ref=50f4d8a1ce9e154e1c030ad1f172bdf18516d07a",
            "patch": "@@ -11,4 +11,11 @@ export interface Schema {\n    * The name of the project.\n    */\n   name?: string;\n+  /**\n+   * Will this project use $localize at runtime?\n+   *\n+   * If true then the dependency is included in the `dependencies` section of packge.json, rather\n+   * than `devDependencies`.\n+   */\n+  useAtRuntime?: boolean;\n }"
        },
        {
            "sha": "1c255911ce87b616e792ec473255e8ecd03228f3",
            "filename": "packages/localize/schematics/ng-add/schema.json",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fschematics%2Fng-add%2Fschema.json",
            "raw_url": "https://github.com/angular/angular/raw/50f4d8a1ce9e154e1c030ad1f172bdf18516d07a/packages%2Flocalize%2Fschematics%2Fng-add%2Fschema.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fschematics%2Fng-add%2Fschema.json?ref=50f4d8a1ce9e154e1c030ad1f172bdf18516d07a",
            "patch": "@@ -10,8 +10,12 @@\n       \"$default\": {\n         \"$source\": \"projectName\"\n       }\n+    },\n+    \"useAtRuntime\": {\n+      \"type\": \"boolean\",\n+      \"description\": \"If set then `@angular/localize` is included in the `dependencies` section of `package.json`, rather than `devDependencies`, which is the default.\",\n+      \"default\": false\n     }\n   },\n-  \"required\": [\n-  ]\n+  \"required\": []\n }"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 69,
        "deletions": 5
    }
}