{
    "author": "crisbeto",
    "message": "perf(compiler): reduce amount of generated code for safe accesses and nullish coalescing (#41563)\n\nThis is follow-up from #41437 and it reduces the amount of code we generate for safe property accesses (`a?.b`) and nullish coalescing (`a ?? b`) by:\n1. Reusing variables in nested nullish coalescing expressions.\n2. Not initializing temporary variables to `null`. The way our code is generated means that the value will always be overwritten before we compare against it so the initializer didn't really matter.\n\nFixes #41491.\n\nPR Close #41563",
    "sha": "dde81ba0cdb55834dfc5633c89f7912042013252",
    "files": [
        {
            "sha": "0205b73b788999d8d7c52ed4453ac1215e262f67",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/nullish_coalescing/nullish_coalescing_host_bindings.js",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fnullish_coalescing%2Fnullish_coalescing_host_bindings.js",
            "raw_url": "https://github.com/angular/angular/raw/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fnullish_coalescing%2Fnullish_coalescing_host_bindings.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fnullish_coalescing%2Fnullish_coalescing_host_bindings.js?ref=dde81ba0cdb55834dfc5633c89f7912042013252",
            "patch": "@@ -1,13 +1,12 @@\n hostBindings: function MyApp_HostBindings(rf, ctx) {\n   if (rf & 1) {\n     i0.ɵɵlistener(\"click\", function MyApp_click_HostBindingHandler() {\n-      let tmp_b_0 = null;\n-      let tmp_b_1 = null;\n-      return ctx.logLastName((tmp_b_0 = (tmp_b_1 = ctx.lastName) !== null && tmp_b_1 !== undefined ? tmp_b_1 : ctx.lastNameFallback) !== null && tmp_b_0 !== undefined ? tmp_b_0 : \"unknown\");\n+      let $tmp$;\n+      return ctx.logLastName(($tmp$ = ($tmp$ = ctx.lastName) !== null && $tmp$ !== undefined ? $tmp$ : ctx.lastNameFallback) !== null && $tmp$ !== undefined ? $tmp$ : \"unknown\");\n     });\n   }\n   if (rf & 2) {\n-    let tmp_b_0 = null;\n-    i0.ɵɵattribute(\"first-name\", \"Hello, \" + ((tmp_b_0 = ctx.firstName) !== null && tmp_b_0 !== undefined ? tmp_b_0 : \"Frodo\") + \"!\");\n+    let $tmp$;\n+    i0.ɵɵattribute(\"first-name\", \"Hello, \" + (($tmp$ = ctx.firstName) !== null && $tmp$ !== undefined ? $tmp$ : \"Frodo\") + \"!\");\n   }\n }"
        },
        {
            "sha": "f49392a339d13c51145e50b1214da78b96d190bc",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/nullish_coalescing/nullish_coalescing_interpolation_template.js",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fnullish_coalescing%2Fnullish_coalescing_interpolation_template.js",
            "raw_url": "https://github.com/angular/angular/raw/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fnullish_coalescing%2Fnullish_coalescing_interpolation_template.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fnullish_coalescing%2Fnullish_coalescing_interpolation_template.js?ref=dde81ba0cdb55834dfc5633c89f7912042013252",
            "patch": "@@ -8,12 +8,11 @@ template: function MyApp_Template(rf, ctx) {\n     i0.ɵɵelementEnd();\n   }\n   if (rf & 2) {\n-    let tmp_0_0 = null;\n-    let tmp_1_0 = null;\n-    let tmp_1_1 = null;\n+    let $tmp_0_0$;\n+    let $tmp_1_0$;\n     i0.ɵɵadvance(1);\n-    i0.ɵɵtextInterpolate1(\"Hello, \", (tmp_0_0 = ctx.firstName) !== null && tmp_0_0 !== undefined ? tmp_0_0 : \"Frodo\", \"!\");\n+    i0.ɵɵtextInterpolate1(\"Hello, \", ($tmp_0_0$ = ctx.firstName) !== null && $tmp_0_0$ !== undefined ? $tmp_0_0$ : \"Frodo\", \"!\");\n     i0.ɵɵadvance(2);\n-    i0.ɵɵtextInterpolate1(\"Your last name is \", (tmp_1_0 = (tmp_1_1 = ctx.lastName) !== null && tmp_1_1 !== undefined ? tmp_1_1 : ctx.lastNameFallback) !== null && tmp_1_0 !== undefined ? tmp_1_0 : \"unknown\", \"\");\n+    i0.ɵɵtextInterpolate1(\"Your last name is \", ($tmp_1_0$ = ($tmp_1_0$ = ctx.lastName) !== null && $tmp_1_0$ !== undefined ? $tmp_1_0$ : ctx.lastNameFallback) !== null && $tmp_1_0$ !== undefined ? $tmp_1_0$ : \"unknown\", \"\");\n   }\n }"
        },
        {
            "sha": "fbd91fb0614d2b066e7e1603ff15be451a4090e2",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/nullish_coalescing/nullish_coalescing_property_template.js",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fnullish_coalescing%2Fnullish_coalescing_property_template.js",
            "raw_url": "https://github.com/angular/angular/raw/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fnullish_coalescing%2Fnullish_coalescing_property_template.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fnullish_coalescing%2Fnullish_coalescing_property_template.js?ref=dde81ba0cdb55834dfc5633c89f7912042013252",
            "patch": "@@ -4,11 +4,10 @@ template: function MyApp_Template(rf, ctx) {\n     i0.ɵɵelement(1, \"span\", 0);\n   }\n   if (rf & 2) {\n-    let tmp_0_0 = null;\n-    let tmp_1_0 = null;\n-    let tmp_1_1 = null;\n-    i0.ɵɵproperty(\"title\", \"Hello, \" + ((tmp_0_0 = ctx.firstName) !== null && tmp_0_0 !== undefined ? tmp_0_0 : \"Frodo\") + \"!\");\n+    let $tmp_0_0$;\n+    let $tmp_1_0$;\n+    i0.ɵɵproperty(\"title\", \"Hello, \" + (($tmp_0_0$ = ctx.firstName) !== null && $tmp_0_0$ !== undefined ? $tmp_0_0$ : \"Frodo\") + \"!\");\n     i0.ɵɵadvance(1);\n-    i0.ɵɵproperty(\"title\", (tmp_1_0 = (tmp_1_1 = \"Your last name is \" + ctx.lastName) !== null && tmp_1_1 !== undefined ? tmp_1_1 : ctx.lastNameFallback) !== null && tmp_1_0 !== undefined ? tmp_1_0 : \"unknown\");\n+    i0.ɵɵproperty(\"title\", ($tmp_1_0$ = ($tmp_1_0$ = \"Your last name is \" + ctx.lastName) !== null && $tmp_1_0$ !== undefined ? $tmp_1_0$ : ctx.lastNameFallback) !== null && $tmp_1_0$ !== undefined ? $tmp_1_0$ : \"unknown\");\n   }\n }"
        },
        {
            "sha": "0ae9700180488644a60d9d523deb59cbfedfb1ee",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_bindings/host_bindings/host_bindings_with_temporaries.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fhost_bindings%2Fhost_bindings_with_temporaries.js",
            "raw_url": "https://github.com/angular/angular/raw/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fhost_bindings%2Fhost_bindings_with_temporaries.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fhost_bindings%2Fhost_bindings_with_temporaries.js?ref=dde81ba0cdb55834dfc5633c89f7912042013252",
            "patch": "@@ -5,7 +5,7 @@ HostBindingDir.ɵdir = /*@__PURE__*/ $r3$.ɵɵdefineDirective({\n     hostVars: 1,\n     hostBindings: function HostBindingDir_HostBindings(rf, ctx) {\n       if (rf & 2) {\n-        let $tmp0$ = null;\n+        let $tmp0$;\n         $r3$.ɵɵhostProperty(\"id\", ($tmp0$ = ctx.getData()) == null ? null : $tmp0$.id);\n       }\n     }"
        },
        {
            "sha": "b7dc723c1cc55de2166d51552ae70b8160ee866e",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_bindings/property_bindings/temporary_variables.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fproperty_bindings%2Ftemporary_variables.js",
            "raw_url": "https://github.com/angular/angular/raw/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fproperty_bindings%2Ftemporary_variables.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fproperty_bindings%2Ftemporary_variables.js?ref=dde81ba0cdb55834dfc5633c89f7912042013252",
            "patch": "@@ -1,7 +1,7 @@\n template: function MyComponent_Template(rf, ctx) {\n   …\n   if (rf & 2) {\n-    let $tmp0$ = null;\n-    $r3$.ɵɵproperty(\"title\", ctx.myTitle)(\"id\", (tmp_1_0 = i0.ɵɵpipeBind1(1, 3, ctx.auth().identity())) == null ? null : tmp_1_0.id)(\"tabindex\", 1);\n+    let $tmp0$;\n+    $r3$.ɵɵproperty(\"title\", ctx.myTitle)(\"id\", ($tmp0$ = i0.ɵɵpipeBind1(1, 3, ctx.auth().identity())) == null ? null : $tmp0$.id)(\"tabindex\", 1);\n   }\n }"
        },
        {
            "sha": "e7d37015f33f5a8fce00ec71559d5d1a98f59fda",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/interpolation_complex_expressions.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Finterpolation_complex_expressions.js",
            "raw_url": "https://github.com/angular/angular/raw/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Finterpolation_complex_expressions.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Finterpolation_complex_expressions.js?ref=dde81ba0cdb55834dfc5633c89f7912042013252",
            "patch": "@@ -14,7 +14,7 @@ template: function MyComponent_Template(rf, ctx) {\n     $r3$.ɵɵelementEnd();\n   }\n   if (rf & 2) {\n-    let $tmp_0_0$ = null;\n+    let $tmp_0_0$;\n     $r3$.ɵɵi18nExp(($tmp_0_0$ = ctx.valueA.getRawValue()) == null ? null : $tmp_0_0$.getTitle());\n     $r3$.ɵɵi18nApply(1);\n   }"
        },
        {
            "sha": "be5a9ef843280c0d94f4f323251f7f54dbcf8a3b",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/nested_nodes/interpolation_complex_expressions.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fnested_nodes%2Finterpolation_complex_expressions.js",
            "raw_url": "https://github.com/angular/angular/raw/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fnested_nodes%2Finterpolation_complex_expressions.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fnested_nodes%2Finterpolation_complex_expressions.js?ref=dde81ba0cdb55834dfc5633c89f7912042013252",
            "patch": "@@ -12,11 +12,11 @@ template: function MyComponent_Template(rf, ctx) {\n     $r3$.ɵɵelementEnd();\n   }\n   if (rf & 2) {\n-    let $tmp_2_0$ = null;\n+    let $tmp_2_0$;\n     $r3$.ɵɵadvance(2);\n     $r3$.ɵɵi18nExp($r3$.ɵɵpipeBind1(2, 3, ctx.valueA))\n                   (ctx.valueA == null ? null : ctx.valueA.a == null ? null : ctx.valueA.a.b)\n                   (($tmp_2_0$ = ctx.valueA.getRawValue()) == null ? null : $tmp_2_0$.getTitle());\n     $r3$.ɵɵi18nApply(1);\n   }\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "eb650f791cb8d10f919863b4c09b592d3d669cd5",
            "filename": "packages/compiler/src/compiler_util/expression_converter.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "raw_url": "https://github.com/angular/angular/raw/dde81ba0cdb55834dfc5633c89f7912042013252/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts?ref=dde81ba0cdb55834dfc5633c89f7912042013252",
            "patch": "@@ -259,8 +259,8 @@ function temporaryName(bindingId: string, temporaryNumber: number): string {\n   return `tmp_${bindingId}_${temporaryNumber}`;\n }\n \n-export function temporaryDeclaration(bindingId: string, temporaryNumber: number): o.Statement {\n-  return new o.DeclareVarStmt(temporaryName(bindingId, temporaryNumber), o.NULL_EXPR);\n+function temporaryDeclaration(bindingId: string, temporaryNumber: number): o.Statement {\n+  return new o.DeclareVarStmt(temporaryName(bindingId, temporaryNumber));\n }\n \n function prependTemporaryDecls(\n@@ -728,15 +728,13 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n     }\n \n     // Produce the conditional\n-    return convertToStatementIfNeeded(mode, condition.conditional(o.literal(null), access));\n+    return convertToStatementIfNeeded(mode, condition.conditional(o.NULL_EXPR, access));\n   }\n \n   private convertNullishCoalesce(ast: cdAst.Binary, mode: _Mode): any {\n-    // Allocate the temporary variable before visiting the LHS and RHS, because they\n-    // may allocate temporary variables too and we don't want them to be reused.\n-    const temporary = this.allocateTemporary();\n     const left: o.Expression = this._visit(ast.left, _Mode.Expression);\n     const right: o.Expression = this._visit(ast.right, _Mode.Expression);\n+    const temporary = this.allocateTemporary();\n     this.releaseTemporary(temporary);\n \n     // Generate the following expression. It is identical to how TS"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 22,
        "deletions": 27
    }
}