{
    "author": "dgp1130",
    "message": "fix(compiler-cli): skip `ExtendedTemplateCheckerImpl` construction if there were configuration errors (#44778)\n\nPreviously, if a bad extended diagnostic category was given, it would fail with the expected error as well as an unexpected assertion error:\n\n```\n$ ng build -c development\nâœ” Browser application bundle generation complete.\n\n./src/main.ts - Error: Module build failed (from ./node_modules/@ngtools/webpack/src/ivy/index.js):\nError: Unexpected call to 'assertNever()' with value:\ntest\n    at /home/douglasparker/Source/ng-new/node_modules/@ngtools/webpack/src/ivy/loader.js:77:18\n    at processTicksAndRejections (internal/process/task_queues.js:95:5)\n\n./src/polyfills.ts - Error: Module build failed (from ./node_modules/@ngtools/webpack/src/ivy/index.js):\nError: Unexpected call to 'assertNever()' with value:\ntest\n    at /home/douglasparker/Source/ng-new/node_modules/@ngtools/webpack/src/ivy/loader.js:77:18\n    at processTicksAndRejections (internal/process/task_queues.js:95:5)\n\nError: error NG4004: Angular compiler option \"extendedDiagnostics.checks['invalidBananaInBox']\" has an unknown diagnostic category: \"test\".\n\nAllowed diagnostic categories are:\nwarning\nerror\nsuppress\n```\n\nThe assertion comes from `ExtendedTemplateCheckerImpl`, which expects a well-formed configuration, yet the compiler would construct it even when errors were found. This commit skips constructing and running extended diagnostics if the configuration had errors, which should avoid triggering these assertion errors.\n\nI'm unfortunately not able to actually test this change. The test passes even before the fix because the `ngc` binary and end-to-end tests [don't request diagnostics unless the configuration is considered valid](https://github.com/angular/angular/blob/ed21f5c75378e1ce717ee3d76d28c8c994209de1/packages/compiler-cli/src/perform_compile.ts#L292-L293). See [Slack](https://angular-team.slack.com/archives/C4WHZQMRA/p1642641305003800) for more details.\n\nPR Close #44778",
    "sha": "d8bff1a1b3b6a289ba461b83bcafd1dd45efede0",
    "files": [
        {
            "sha": "308a17783abc98cbe3bf7ea047de25e6b93ac88d",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/d8bff1a1b3b6a289ba461b83bcafd1dd45efede0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8bff1a1b3b6a289ba461b83bcafd1dd45efede0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=d8bff1a1b3b6a289ba461b83bcafd1dd45efede0",
            "patch": "@@ -51,7 +51,7 @@ interface LazyCompilationState {\n   refEmitter: ReferenceEmitter;\n   templateTypeChecker: TemplateTypeChecker;\n   resourceRegistry: ResourceRegistry;\n-  extendedTemplateChecker: ExtendedTemplateChecker;\n+  extendedTemplateChecker: ExtendedTemplateChecker|null;\n }\n \n \n@@ -460,8 +460,9 @@ export class NgCompiler {\n     const ttc = compilation.templateTypeChecker;\n     const diagnostics: ts.Diagnostic[] = [];\n     diagnostics.push(...ttc.getDiagnosticsForComponent(component));\n-    if (this.options.strictTemplates) {\n-      const extendedTemplateChecker = compilation.extendedTemplateChecker;\n+\n+    const extendedTemplateChecker = compilation.extendedTemplateChecker;\n+    if (this.options.strictTemplates && extendedTemplateChecker) {\n       diagnostics.push(...extendedTemplateChecker.getDiagnosticsForComponent(component));\n     }\n     return this.addMessageTextDetails(diagnostics);\n@@ -886,6 +887,10 @@ export class NgCompiler {\n     const diagnostics: ts.Diagnostic[] = [];\n     const compilation = this.ensureAnalyzed();\n     const extendedTemplateChecker = compilation.extendedTemplateChecker;\n+    if (!extendedTemplateChecker) {\n+      return [];\n+    }\n+\n     if (sf !== undefined) {\n       return compilation.traitCompiler.extendedTemplateCheck(sf, extendedTemplateChecker);\n     }\n@@ -1062,8 +1067,11 @@ export class NgCompiler {\n         reflector, this.adapter, this.incrementalCompilation, scopeRegistry, typeCheckScopeRegistry,\n         this.delegatingPerfRecorder);\n \n-    const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n-        templateTypeChecker, checker, ALL_DIAGNOSTIC_FACTORIES, this.options);\n+    // Only construct the extended template checker if the configuration is valid and usable.\n+    const extendedTemplateChecker = this.constructionDiagnostics.length === 0 ?\n+        new ExtendedTemplateCheckerImpl(\n+            templateTypeChecker, checker, ALL_DIAGNOSTIC_FACTORIES, this.options) :\n+        null;\n \n     return {\n       isCore,"
        },
        {
            "sha": "763715db3ebac4774d4ed7a3f62ad7e946ee2970",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/src/extended_template_checker.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d8bff1a1b3b6a289ba461b83bcafd1dd45efede0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8bff1a1b3b6a289ba461b83bcafd1dd45efede0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts?ref=d8bff1a1b3b6a289ba461b83bcafd1dd45efede0",
            "patch": "@@ -86,7 +86,7 @@ export class ExtendedTemplateCheckerImpl implements ExtendedTemplateChecker {\n }\n \n /**\n- * Converts a `DiagnosticCategoryLabel` to its equivalent `ts.DiagnosticCategory` or `undefined` if\n+ * Converts a `DiagnosticCategoryLabel` to its equivalent `ts.DiagnosticCategory` or `null` if\n  * the label is `DiagnosticCategoryLabel.Suppress`.\n  */\n function diagnosticLabelToCategory(label: DiagnosticCategoryLabel): ts.DiagnosticCategory|null {"
        },
        {
            "sha": "a0972ae09b311457c8d982e4319a4671dcb9466a",
            "filename": "packages/compiler-cli/test/ngtsc/extended_template_diagnostics_spec.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/d8bff1a1b3b6a289ba461b83bcafd1dd45efede0/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fextended_template_diagnostics_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8bff1a1b3b6a289ba461b83bcafd1dd45efede0/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fextended_template_diagnostics_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fextended_template_diagnostics_spec.ts?ref=d8bff1a1b3b6a289ba461b83bcafd1dd45efede0",
            "patch": "@@ -233,6 +233,24 @@ runInEachFileSystem(() => {\n         const diagnostics = env.driveDiagnostics(0 /* expectedExitCode */);\n         expect(diagnostics).toEqual([]);\n       });\n+\n+      it('by throwing an error when given a bad category', () => {\n+        env.tsconfig({\n+          strictTemplates: true,\n+          extendedDiagnostics: {\n+            defaultCategory: 'not-a-category',\n+          },\n+        });\n+\n+        env.write('test.ts', warningComponent);\n+\n+        const diagnostics = env.driveDiagnostics(1 /* expectedExitCode */);\n+        expect(diagnostics.length).toBe(1);\n+        expect(diagnostics[0]).toEqual(jasmine.objectContaining({\n+          code: ngErrorCode(ErrorCode.CONFIG_EXTENDED_DIAGNOSTICS_UNKNOWN_CATEGORY_LABEL),\n+          category: ts.DiagnosticCategory.Error,\n+        }));\n+      });\n     });\n   });\n });"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 32,
        "deletions": 6
    }
}