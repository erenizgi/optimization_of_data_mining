{
    "author": "gkalpak",
    "message": "test(service-worker): better align mock global scope implementation with actual implementation (#42736)\n\nThis commit better aligns the mock `ServiceWorkerGlobalScope`\nimplementation used in ServiceWorker tests (and the associated typings)\nwith the actual implementation (and the official TypeScript typings).\nThis allows verifying the ServiceWorker behavior in a slightly more\nrealistic environment.\n\nThis is in preparation of switching from our custom typings to the\nofficial TypeScript typings (`lib.webworker.d.ts`).\n\nPR Close #42736",
    "sha": "a47aaabf70bd8b76a182c9a74fe2361148e07317",
    "files": [
        {
            "sha": "1bee5c20a429a1d2ff0dbce1763f8ebc0bb96049",
            "filename": "packages/service-worker/worker/src/adapter.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a47aaabf70bd8b76a182c9a74fe2361148e07317/packages%2Fservice-worker%2Fworker%2Fsrc%2Fadapter.ts",
            "raw_url": "https://github.com/angular/angular/raw/a47aaabf70bd8b76a182c9a74fe2361148e07317/packages%2Fservice-worker%2Fworker%2Fsrc%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fadapter.ts?ref=a47aaabf70bd8b76a182c9a74fe2361148e07317",
            "patch": "@@ -18,7 +18,7 @@ import {NamedCacheStorage} from './named-cache-storage';\n  */\n export class Adapter<T extends CacheStorage = CacheStorage> {\n   readonly caches: NamedCacheStorage<T>;\n-  private readonly origin: string;\n+  readonly origin: string;\n \n   constructor(protected readonly scopeUrl: string, caches: T) {\n     const parsedScopeUrl = this.parseUrl(this.scopeUrl);"
        },
        {
            "sha": "69171abe3decf69f1cbc0ec1c44d956e5398d5af",
            "filename": "packages/service-worker/worker/src/service-worker.d.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 16,
            "changes": 63,
            "blob_url": "https://github.com/angular/angular/blob/a47aaabf70bd8b76a182c9a74fe2361148e07317/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/a47aaabf70bd8b76a182c9a74fe2361148e07317/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts?ref=a47aaabf70bd8b76a182c9a74fe2361148e07317",
            "patch": "@@ -106,23 +106,54 @@ interface ExtendableMessageEvent extends ExtendableEvent {\n   readonly source: Client|ServiceWorker|MessagePort|null;\n }\n \n+// WorkerGlobalScope\n+\n+// Explicitly omit the `caches` property to disallow accessing `CacheStorage` APIs directly. All\n+// interactions with `CacheStorage` should go through a `NamedCacheStorage` instance (exposed by the\n+// `Adapter`).\n+interface WorkerGlobalScope extends EventTarget, Omit<WindowOrWorkerGlobalScope, 'caches'> {\n+  readonly location: WorkerLocation;\n+  readonly navigator: WorkerNavigator;\n+  readonly self: WorkerGlobalScope & typeof globalThis;\n+\n+  importScripts(...urls: string[]): void;\n+  addEventListener<K extends keyof WorkerGlobalScopeEventMap>(type: K, listener: (this: WorkerGlobalScope, ev: WorkerGlobalScopeEventMap[K]) => any, options?: boolean | AddEventListenerOptions): void;\n+  addEventListener(type: string, listener: EventListenerOrEventListenerObject, options?: boolean | AddEventListenerOptions): void;\n+  removeEventListener<K extends keyof WorkerGlobalScopeEventMap>(type: K, listener: (this: WorkerGlobalScope, ev: WorkerGlobalScopeEventMap[K]) => any, options?: boolean | EventListenerOptions): void;\n+  removeEventListener(type: string, listener: EventListenerOrEventListenerObject, options?: boolean | EventListenerOptions): void;\n+}\n+\n+interface WorkerGlobalScopeEventMap {\n+  error: ErrorEvent;\n+  languagechange: Event;\n+  offline: Event;\n+  online: Event;\n+  rejectionhandled: PromiseRejectionEvent;\n+  unhandledrejection: PromiseRejectionEvent;\n+}\n+\n // ServiceWorkerGlobalScope\n \n-interface ServiceWorkerGlobalScope {\n-  // Intentionally does not include a `caches` property to disallow accessing `CacheStorage` APIs\n-  // directly. All interactions with `CacheStorage` should go through a `NamedCacheStorage` instance\n-  // (exposed by the `Adapter`).\n-  clients: Clients;\n-  registration: ServiceWorkerRegistration;\n-\n-  addEventListener(event: 'activate', fn: (event?: ExtendableEvent) => any): void;\n-  addEventListener(event: 'message', fn: (event?: ExtendableMessageEvent) => any): void;\n-  addEventListener(event: 'fetch', fn: (event?: FetchEvent) => any): void;\n-  addEventListener(event: 'install', fn: (event?: ExtendableEvent) => any): void;\n-  addEventListener(event: 'push', fn: (event?: PushEvent) => any): void;\n-  addEventListener(event: 'notificationclick', fn: (event?: NotificationEvent) => any): void;\n-  addEventListener(event: 'sync', fn: (event?: SyncEvent) => any): void;\n-\n-  fetch(request: Request|string): Promise<Response>;\n+interface ServiceWorkerGlobalScope extends WorkerGlobalScope {\n+  readonly clients: Clients;\n+  readonly registration: ServiceWorkerRegistration;\n+  readonly serviceWorker: ServiceWorker;\n+\n   skipWaiting(): Promise<void>;\n+  addEventListener<K extends keyof ServiceWorkerGlobalScopeEventMap>(type: K, listener: (this: ServiceWorkerGlobalScope, ev: ServiceWorkerGlobalScopeEventMap[K]) => any, options?: boolean | AddEventListenerOptions): void;\n+  addEventListener(type: string, listener: EventListenerOrEventListenerObject, options?: boolean | AddEventListenerOptions): void;\n+  removeEventListener<K extends keyof ServiceWorkerGlobalScopeEventMap>(type: K, listener: (this: ServiceWorkerGlobalScope, ev: ServiceWorkerGlobalScopeEventMap[K]) => any, options?: boolean | EventListenerOptions): void;\n+  removeEventListener(type: string, listener: EventListenerOrEventListenerObject, options?: boolean | EventListenerOptions): void;\n+}\n+\n+interface ServiceWorkerGlobalScopeEventMap extends WorkerGlobalScopeEventMap {\n+  activate: ExtendableEvent;\n+  fetch: FetchEvent;\n+  install: ExtendableEvent;\n+  message: ExtendableMessageEvent;\n+  messageerror: MessageEvent;\n+  notificationclick: NotificationEvent;\n+  notificationclose: NotificationEvent;\n+  push: PushEvent;\n+  sync: SyncEvent;\n }"
        },
        {
            "sha": "f635e69034b63ac813d6082061c7f02563c9c741",
            "filename": "packages/service-worker/worker/testing/scope.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 7,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/a47aaabf70bd8b76a182c9a74fe2361148e07317/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "raw_url": "https://github.com/angular/angular/raw/a47aaabf70bd8b76a182c9a74fe2361148e07317/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts?ref=a47aaabf70bd8b76a182c9a74fe2361148e07317",
            "patch": "@@ -37,13 +37,16 @@ export class SwTestHarnessBuilder {\n   }\n \n   build(): SwTestHarness {\n-    return new SwTestHarness(this.server, this.caches, this.scopeUrl);\n+    return new SwTestHarnessImpl(this.server, this.caches, this.scopeUrl) as SwTestHarness;\n   }\n }\n \n-export class SwTestHarness extends Adapter<MockCacheStorage> implements ServiceWorkerGlobalScope {\n+export type SwTestHarness = SwTestHarnessImpl&ServiceWorkerGlobalScope;\n+\n+export class SwTestHarnessImpl extends Adapter<MockCacheStorage> implements\n+    Partial<ServiceWorkerGlobalScope> {\n   readonly clients = new MockClients();\n-  private eventHandlers = new Map<string, Function>();\n+  private eventHandlers = new Map<string, EventListener>();\n   private skippedWaiting = false;\n \n   private selfMessageQueue: any[] = [];\n@@ -131,12 +134,26 @@ export class SwTestHarness extends Adapter<MockCacheStorage> implements ServiceW\n     }\n   }\n \n-  addEventListener(event: string, handler: Function): void {\n-    this.eventHandlers.set(event, handler);\n+  addEventListener(\n+      type: string, listener: EventListenerOrEventListenerObject,\n+      options?: boolean|AddEventListenerOptions): void {\n+    if (options !== undefined) {\n+      throw new Error('Mock `addEventListener()` does not support `options`.');\n+    }\n+\n+    const handler: EventListener =\n+        (typeof listener === 'function') ? listener : evt => listener.handleEvent(evt);\n+    this.eventHandlers.set(type, handler);\n   }\n \n-  removeEventListener(event: string, handler?: Function): void {\n-    this.eventHandlers.delete(event);\n+  removeEventListener(\n+      type: string, listener: EventListenerOrEventListenerObject,\n+      options?: boolean|AddEventListenerOptions): void {\n+    if (options !== undefined) {\n+      throw new Error('Mock `removeEventListener()` does not support `options`.');\n+    }\n+\n+    this.eventHandlers.delete(type);\n   }\n \n   newRequest(url: string, init: Object = {}): Request {"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 72,
        "deletions": 24
    }
}