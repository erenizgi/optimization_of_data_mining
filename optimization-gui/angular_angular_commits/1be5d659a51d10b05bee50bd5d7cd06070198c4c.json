{
    "author": "atscott",
    "message": "fix(language-service): fully de-duplicate reference and rename results (#40523)\n\nRather than de-duplicating results as we build them, a final de-duplication can be done at the end.\nThis way, there's no forgetting to de-duplicate results at some level.\n\nPrior to this commit, results from template locations that mapped to\nmultiple different typescript locations would not be de-duplicated (e.g.\nan input binding that is bound to two separate directives).\n\nPR Close #40523",
    "sha": "1be5d659a51d10b05bee50bd5d7cd06070198c4c",
    "files": [
        {
            "sha": "320c98e7a54b87e16c7416dbc06897b5eec8cc39",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/1be5d659a51d10b05bee50bd5d7cd06070198c4c/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/1be5d659a51d10b05bee50bd5d7cd06070198c4c/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=1be5d659a51d10b05bee50bd5d7cd06070198c4c",
            "patch": "@@ -27,6 +27,7 @@ import {CompletionBuilder, CompletionNodeContext} from './completions';\n import {DefinitionBuilder} from './definitions';\n import {QuickInfoBuilder} from './quick_info';\n import {ReferencesBuilder, RenameBuilder} from './references_and_rename';\n+import {createLocationKey} from './references_and_rename_utils';\n import {getSignatureHelp} from './signature_help';\n import {getTargetAtPosition, TargetContext, TargetNodeKind} from './template_target';\n import {findTightestNode, getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n@@ -168,8 +169,9 @@ export class LanguageService {\n \n   getReferencesAtPosition(fileName: string, position: number): ts.ReferenceEntry[]|undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsReferencesAndRenames, (compiler) => {\n-      return new ReferencesBuilder(this.programDriver, this.tsLS, compiler)\n-          .getReferencesAtPosition(fileName, position);\n+      const results = new ReferencesBuilder(this.programDriver, this.tsLS, compiler)\n+                          .getReferencesAtPosition(fileName, position);\n+      return results === undefined ? undefined : getUniqueLocations(results);\n     });\n   }\n \n@@ -191,9 +193,9 @@ export class LanguageService {\n \n   findRenameLocations(fileName: string, position: number): readonly ts.RenameLocation[]|undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsReferencesAndRenames, (compiler) => {\n-      return new RenameBuilder(this.programDriver, this.tsLS, compiler)\n-                 .findRenameLocations(fileName, position) ??\n-          undefined;\n+      const results = new RenameBuilder(this.programDriver, this.tsLS, compiler)\n+                          .findRenameLocations(fileName, position);\n+      return results === null ? undefined : getUniqueLocations(results);\n     });\n   }\n \n@@ -565,3 +567,11 @@ function findTightestNodeAtPosition(program: ts.Program, fileName: string, posit\n \n   return findTightestNode(sourceFile, position);\n }\n+\n+function getUniqueLocations<T extends ts.DocumentSpan>(locations: readonly T[]): T[] {\n+  const uniqueLocations: Map<string, T> = new Map();\n+  for (const location of locations) {\n+    uniqueLocations.set(createLocationKey(location), location);\n+  }\n+  return Array.from(uniqueLocations.values());\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "d4e16baa2c2f790a20a39c058548fa776c5ff38b",
            "filename": "packages/language-service/ivy/references_and_rename.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/1be5d659a51d10b05bee50bd5d7cd06070198c4c/packages%2Flanguage-service%2Fivy%2Freferences_and_rename.ts",
            "raw_url": "https://github.com/angular/angular/raw/1be5d659a51d10b05bee50bd5d7cd06070198c4c/packages%2Flanguage-service%2Fivy%2Freferences_and_rename.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences_and_rename.ts?ref=1be5d659a51d10b05bee50bd5d7cd06070198c4c",
            "patch": "@@ -59,18 +59,18 @@ export class ReferencesBuilder {\n       return undefined;\n     }\n \n-    const entries: Map<string, ts.ReferenceEntry> = new Map();\n+    const entries: ts.ReferenceEntry[] = [];\n     for (const ref of refs) {\n       if (this.ttc.isTrackedTypeCheckFile(absoluteFrom(ref.fileName))) {\n         const entry = convertToTemplateDocumentSpan(ref, this.ttc, this.driver.getProgram());\n         if (entry !== null) {\n-          entries.set(createLocationKey(entry), entry);\n+          entries.push(entry);\n         }\n       } else {\n-        entries.set(createLocationKey(ref), ref);\n+        entries.push(ref);\n       }\n     }\n-    return Array.from(entries.values());\n+    return entries;\n   }\n }\n \n@@ -249,7 +249,7 @@ export class RenameBuilder {\n           if (entry === null) {\n             return null;\n           }\n-          entries.set(createLocationKey(entry), entry);\n+          entries.push(entry);\n         } else {\n           if (!isDirectRenameContext(renameRequest)) {\n             // Discard any non-template results for non-direct renames. We should only rename\n@@ -263,10 +263,10 @@ export class RenameBuilder {\n           if (refNode === null || refNode.getText() !== expectedRenameText) {\n             return null;\n           }\n-          entries.set(createLocationKey(location), location);\n+          entries.push(location);\n         }\n       }\n-      return Array.from(entries.values());\n+      return entries;\n     });\n   }\n \n@@ -351,9 +351,9 @@ export class RenameBuilder {\n  * required for the rename operation, but cannot be found by the native TS LS).\n  */\n function getExpectedRenameTextAndInitalRenameEntries(renameRequest: RenameRequest):\n-    {expectedRenameText: string, entries: Map<string, ts.RenameLocation>}|null {\n+    {expectedRenameText: string, entries: ts.RenameLocation[]}|null {\n   let expectedRenameText: string;\n-  const entries = new Map<string, ts.RenameLocation>();\n+  const entries: ts.RenameLocation[] = [];\n   if (renameRequest.type === RequestKind.DirectFromTypeScript) {\n     expectedRenameText = renameRequest.requestNode.getText();\n   } else if (renameRequest.type === RequestKind.DirectFromTemplate) {\n@@ -370,7 +370,7 @@ function getExpectedRenameTextAndInitalRenameEntries(renameRequest: RenameReques\n       fileName: renameRequest.pipeNameExpr.getSourceFile().fileName,\n       textSpan: {start: pipeNameExpr.getStart() + 1, length: pipeNameExpr.getText().length - 2},\n     };\n-    entries.set(createLocationKey(entry), entry);\n+    entries.push(entry);\n   } else {\n     // TODO(atscott): Implement other types of special renames\n     return null;"
        },
        {
            "sha": "64f4d2be2220a722b26e85e1fc014428cb2f8267",
            "filename": "packages/language-service/ivy/test/references_and_rename_spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/1be5d659a51d10b05bee50bd5d7cd06070198c4c/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_and_rename_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1be5d659a51d10b05bee50bd5d7cd06070198c4c/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_and_rename_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_and_rename_spec.ts?ref=1be5d659a51d10b05bee50bd5d7cd06070198c4c",
            "patch": "@@ -967,8 +967,7 @@ describe('find references and rename locations', () => {\n         file.moveCursorToText('[mod¦el]');\n       });\n \n-      // TODO(atscott): Does not work because we don't fully de-duplicate\n-      xit('should find references', () => {\n+      it('should find references', () => {\n         const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toEqual(3);\n         assertFileNames(refs, ['string-model.ts', 'app.ts', 'other-dir.ts']);\n@@ -1257,10 +1256,7 @@ describe('find references and rename locations', () => {\n     file.moveCursorToText('[(mod¦el)]');\n \n     const refs = getReferencesAtPosition(file)!;\n-    // Note that this includes the 'model` twice from the template. As with other potential\n-    // duplicates (like if another plugin returns the same span), we expect the LS clients to filter\n-    // these out themselves.\n-    expect(refs.length).toEqual(4);\n+    expect(refs.length).toEqual(3);\n     assertFileNames(refs, ['dir.ts', 'app.ts']);\n     assertTextSpans(refs, ['model', 'modelChange']);\n   });\n@@ -1347,7 +1343,7 @@ describe('find references and rename locations', () => {\n \n       it('gets references to all matching directives', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toBe(8);\n+        expect(refs.length).toBe(7);\n         assertTextSpans(refs, ['<div dir>', 'Dir', 'Dir2']);\n         assertFileNames(refs, ['app.ts', 'dir.ts', 'dir2.ts']);\n       });"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 28,
        "deletions": 22
    }
}