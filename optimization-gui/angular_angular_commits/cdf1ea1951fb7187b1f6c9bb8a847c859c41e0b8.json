{
    "author": "crisbeto",
    "message": "refactor(compiler): retrieve variables from context inside nested template listener (#40833)\n\nThis is a pre-requisite for #40360. Given the following template which has a listener\nthat references a variable from a parent template (`name`):\n\n```\n<ng-template let-name=\"name\">\n  <button (click)=\"hello(name)\"></button>\n</ng-template>\n```\n\nWe generate code that looks that looks like. Note how we access `name` through `ctx`:\n\n```js\nfunction template(rf, ctx) {\n  if (rf & 1) {\n    const r0 = ɵɵgetCurrentView();\n    ɵɵelementStart(0, \"button\", 2);\n    ɵɵlistener(\"click\", function() {\n      ɵɵrestoreView(r0);\n      const name_r0 = ctx.name; // Note the `ctx.name` access here.\n      const ctx_r1 = ɵɵnextContext();\n      return ctx_r1.log(name_r0);\n    });\n    ɵɵelementEnd();\n  }\n}\n```\n\nThis works fine at the moment, because the template context object can't be changed after creation.\nThe changes in #40360 allow for the object to be changed, which means that the `ctx` reference\ninside the listener will be out of date, because it was bound during creation mode.\n\nThis PR aims to address the issue by accessing the context inside listeners through the saved\nview reference. With the new code, the generated code from above will look as follows:\n\n```js\nfunction template(rf, ctx) {\n  if (rf & 1) {\n    const r0 = ɵɵgetCurrentView();\n    ɵɵelementStart(0, \"button\", 2);\n    ɵɵlistener(\"click\", function() {\n      const restoredCtx = ɵɵrestoreView(r0);\n      const name_r0 = restoredCtx.name;\n      const ctx_r1 = ɵɵnextContext();\n      return ctx_r1.log(name_r0);\n    });\n    ɵɵelementEnd();\n  }\n}\n```\n\nPR Close #40833",
    "sha": "cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8",
    "files": [
        {
            "sha": "84bc2ae9d97a0b25b00e87532596f456e4013716",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_template/nested_template_context_many_bindings_template.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_template%2Fnested_template_context_many_bindings_template.js",
            "raw_url": "https://github.com/angular/angular/raw/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_template%2Fnested_template_context_many_bindings_template.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_template%2Fnested_template_context_many_bindings_template.js?ref=cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8",
            "patch": "@@ -3,9 +3,9 @@ function MyComponent_div_0_Template(rf, ctx) {\n     const $s$ = $r3$.ɵɵgetCurrentView();\n     $r3$.ɵɵelementStart(0, \"div\", 1);\n     $r3$.ɵɵlistener(\"click\", function MyComponent_div_0_Template_div_click_0_listener() {\n-      $r3$.ɵɵrestoreView($s$);\n-      const $d$ = ctx.$implicit;\n-      const $i$ = ctx.index;\n+      const $sr$ = $r3$.ɵɵrestoreView($s$);\n+      const $d$ = $sr$.$implicit;\n+      const $i$ = $sr$.index;\n       const $comp$ = $r3$.ɵɵnextContext();\n       return $comp$._handleClick($d$, $i$);\n     });"
        },
        {
            "sha": "aba3ec7d15a578cb1f28193dc2f33e60679be65d",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_template/nested_template_context_template.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_template%2Fnested_template_context_template.js",
            "raw_url": "https://github.com/angular/angular/raw/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_template%2Fnested_template_context_template.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_template%2Fnested_template_context_template.js?ref=cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8",
            "patch": "@@ -3,8 +3,8 @@ function MyComponent_ul_0_li_1_div_1_Template(rf, ctx) {\n     const $s$ = $i0$.ɵɵgetCurrentView();\n     $i0$.ɵɵelementStart(0, \"div\", 2);\n     $i0$.ɵɵlistener(\"click\", function MyComponent_ul_0_li_1_div_1_Template_div_click_0_listener(){\n-      $i0$.ɵɵrestoreView($s$);\n-      const $inner$ = ctx.$implicit;\n+      const $sr$ = $i0$.ɵɵrestoreView($s$);\n+      const $inner$ = $sr$.$implicit;\n       const $middle$ = $i0$.ɵɵnextContext().$implicit;\n       const $outer$ = $i0$.ɵɵnextContext().$implicit;\n       const $myComp$ = $i0$.ɵɵnextContext();"
        },
        {
            "sha": "26fd0703e4b542632dca123c320cb9c141861ad5",
            "filename": "packages/compiler-cli/test/compliance_old/r3_view_compiler_template_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fr3_view_compiler_template_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fr3_view_compiler_template_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fr3_view_compiler_template_spec.ts?ref=cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8",
            "patch": "@@ -55,8 +55,8 @@ describe('compiler compliance: template', () => {\n           const $s$ = $i0$.ɵɵgetCurrentView();\n           $i0$.ɵɵelementStart(0, \"div\", 2);\n           $i0$.ɵɵlistener(\"click\", function MyComponent_ul_0_li_1_div_1_Template_div_click_0_listener(){\n-            $i0$.ɵɵrestoreView($s$);\n-            const $inner$ = ctx.$implicit;\n+            const $sr$ = $i0$.ɵɵrestoreView($s$);\n+            const $inner$ = $sr$.$implicit;\n             const $middle$ = $i0$.ɵɵnextContext().$implicit;\n             const $outer$ = $i0$.ɵɵnextContext().$implicit;\n             const $myComp$ = $i0$.ɵɵnextContext();\n@@ -150,9 +150,9 @@ describe('compiler compliance: template', () => {\n             const $s$ = $r3$.ɵɵgetCurrentView();\n             $r3$.ɵɵelementStart(0, \"div\", 1);\n             $r3$.ɵɵlistener(\"click\", function MyComponent_div_0_Template_div_click_0_listener() {\n-              $r3$.ɵɵrestoreView($s$);\n-              const $d$ = ctx.$implicit;\n-              const $i$ = ctx.index;\n+              const $sr$ = $r3$.ɵɵrestoreView($s$);\n+              const $d$ = $sr$.$implicit;\n+              const $i$ = $sr$.index;\n               const $comp$ = $r3$.ɵɵnextContext();\n               return $comp$._handleClick($d$, $i$);\n             });"
        },
        {
            "sha": "88ad3593640467368255ecd3b421653d23013eaf",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 10,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8",
            "patch": "@@ -39,7 +39,7 @@ import {createLocalizeStatements} from './i18n/localize_utils';\n import {I18nMetaVisitor} from './i18n/meta';\n import {assembleBoundTextPlaceholders, assembleI18nBoundString, declareI18nVariable, getTranslationConstPrefix, hasI18nMeta, I18N_ICU_MAPPING_PREFIX, i18nFormatPlaceholderNames, icuFromI18nMessage, isI18nRootNode, isSingleI18nIcu, placeholdersToParams, TRANSLATION_VAR_PREFIX, wrapI18nPlaceholder} from './i18n/util';\n import {StylingBuilder, StylingInstruction} from './styling_builder';\n-import {asLiteral, chainedInstruction, CONTEXT_NAME, getAttrsForDirectiveMatching, getInterpolationArgsLength, IMPLICIT_REFERENCE, invalid, NON_BINDABLE_ATTR, REFERENCE_PREFIX, RENDER_FLAGS, trimTrailingNulls, unsupported} from './util';\n+import {asLiteral, chainedInstruction, CONTEXT_NAME, getAttrsForDirectiveMatching, getInterpolationArgsLength, IMPLICIT_REFERENCE, invalid, NON_BINDABLE_ATTR, REFERENCE_PREFIX, RENDER_FLAGS, RESTORED_VIEW_CONTEXT_NAME, trimTrailingNulls, unsupported} from './util';\n \n \n \n@@ -83,8 +83,10 @@ export function prepareEventListenerParameters(\n       eventAst.handlerSpan, implicitReceiverAccesses, EVENT_BINDING_SCOPE_GLOBALS);\n   const statements = [];\n   if (scope) {\n-    statements.push(...scope.restoreViewStatement());\n+    // `variableDeclarations` needs to run first, because\n+    // `restoreViewStatement` depends on the result.\n     statements.push(...scope.variableDeclarations());\n+    statements.unshift(...scope.restoreViewStatement());\n   }\n   statements.push(...bindingExpr.render3Stmts);\n \n@@ -358,8 +360,17 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n         (scope: BindingScope, relativeLevel: number) => {\n           let rhs: o.Expression;\n           if (scope.bindingLevel === retrievalLevel) {\n-            // e.g. ctx\n-            rhs = o.variable(CONTEXT_NAME);\n+            if (scope.isListenerScope() && scope.hasRestoreViewVariable()) {\n+              // e.g. restoredCtx.\n+              // We have to get the context from a view reference, if one is available, because\n+              // the context that was passed in during creation may not be correct anymore.\n+              // For more information see: https://github.com/angular/angular/pull/40360.\n+              rhs = o.variable(RESTORED_VIEW_CONTEXT_NAME);\n+              scope.notifyRestoredViewContextUse();\n+            } else {\n+              // e.g. ctx\n+              rhs = o.variable(CONTEXT_NAME);\n+            }\n           } else {\n             const sharedCtxVar = scope.getSharedContextName(retrievalLevel);\n             // e.g. ctx_r0   OR  x(2);\n@@ -1658,6 +1669,7 @@ export class BindingScope implements LocalResolver {\n   private map = new Map<string, BindingData>();\n   private referenceNameIndex = 0;\n   private restoreViewVariable: o.ReadVarExpr|null = null;\n+  private usesRestoredViewContext = false;\n   static createRootScope(): BindingScope {\n     return new BindingScope();\n   }\n@@ -1833,17 +1845,23 @@ export class BindingScope implements LocalResolver {\n   }\n \n   restoreViewStatement(): o.Statement[] {\n-    // restoreView($state$);\n-    return this.restoreViewVariable ?\n-        [instruction(null, R3.restoreView, [this.restoreViewVariable]).toStmt()] :\n-        [];\n+    const statements: o.Statement[] = [];\n+    if (this.restoreViewVariable) {\n+      const restoreCall = instruction(null, R3.restoreView, [this.restoreViewVariable]);\n+      // Either `const restoredCtx = restoreView($state$);` or `restoreView($state$);`\n+      // depending on whether it is being used.\n+      statements.push(\n+          this.usesRestoredViewContext ?\n+              o.variable(RESTORED_VIEW_CONTEXT_NAME).set(restoreCall).toConstDecl() :\n+              restoreCall.toStmt());\n+    }\n+    return statements;\n   }\n \n   viewSnapshotStatements(): o.Statement[] {\n     // const $state$ = getCurrentView();\n-    const getCurrentViewInstruction = instruction(null, R3.getCurrentView, []);\n     return this.restoreViewVariable ?\n-        [this.restoreViewVariable.set(getCurrentViewInstruction).toConstDecl()] :\n+        [this.restoreViewVariable.set(instruction(null, R3.getCurrentView, [])).toConstDecl()] :\n         [];\n   }\n \n@@ -1873,6 +1891,14 @@ export class BindingScope implements LocalResolver {\n     const ref = `${REFERENCE_PREFIX}${current.referenceNameIndex++}`;\n     return ref;\n   }\n+\n+  hasRestoreViewVariable(): boolean {\n+    return !!this.restoreViewVariable;\n+  }\n+\n+  notifyRestoredViewContextUse(): void {\n+    this.usesRestoredViewContext = true;\n+  }\n }\n \n /**"
        },
        {
            "sha": "e237933a9822ad483d599a5776eafd47d526d0e7",
            "filename": "packages/compiler/src/render3/view/util.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Futil.ts?ref=cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8",
            "patch": "@@ -45,6 +45,9 @@ export const IMPLICIT_REFERENCE = '$implicit';\n /** Non bindable attribute name **/\n export const NON_BINDABLE_ATTR = 'ngNonBindable';\n \n+/** Name for the variable keeping track of the context returned by `ɵɵrestoreView`. */\n+export const RESTORED_VIEW_CONTEXT_NAME = 'restoredCtx';\n+\n /**\n  * Creates an allocator for a temporary variable.\n  *"
        },
        {
            "sha": "5d1e02f1067bb26612e8b649c3fb39ae6312b14f",
            "filename": "packages/core/src/render3/state.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcore%2Fsrc%2Frender3%2Fstate.ts",
            "raw_url": "https://github.com/angular/angular/raw/cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8/packages%2Fcore%2Fsrc%2Frender3%2Fstate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fstate.ts?ref=cdf1ea1951fb7187b1f6c9bb8a847c859c41e0b8",
            "patch": "@@ -284,11 +284,13 @@ export function getTView(): TView {\n  * walking the declaration view tree in listeners to get vars from parent views.\n  *\n  * @param viewToRestore The OpaqueViewState instance to restore.\n+ * @returns Context of the restored OpaqueViewState instance.\n  *\n  * @codeGenApi\n  */\n-export function ɵɵrestoreView(viewToRestore: OpaqueViewState) {\n+export function ɵɵrestoreView<T = any>(viewToRestore: OpaqueViewState): T {\n   instructionState.lFrame.contextLView = viewToRestore as any as LView;\n+  return (viewToRestore as any as LView)[CONTEXT] as T;\n }\n \n "
        }
    ],
    "stats": {
        "total": 73,
        "additions": 52,
        "deletions": 21
    }
}