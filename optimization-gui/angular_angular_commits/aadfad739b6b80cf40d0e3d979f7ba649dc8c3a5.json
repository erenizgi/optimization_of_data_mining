{
    "author": "alxhub",
    "message": "build: remove view engine build infrastructure (#43884)\n\nThis commit removes --config=viewengine and makes Ivy the default for\nbuilding Angular.\n\nPR Close #43884",
    "sha": "aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
    "files": [
        {
            "sha": "63e1d56d86ca31545e91c3ac3189461d182d9cbc",
            "filename": ".bazelrc",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/.bazelrc",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/.bazelrc",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.bazelrc?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -81,15 +81,6 @@ test --test_output=errors\n build --deleted_packages=integration/bazel,integration/bazel/src,integration/bazel/src/hello-world,integration/bazel/test,integration/bazel/tools,integration/bazel/test/e2e\n query --deleted_packages=integration/bazel,integration/bazel/src,integration/bazel/src/hello-world,integration/bazel/test,integration/bazel/tools,integration/bazel/test/e2e\n \n-################################\n-# Temporary Settings for Ivy   #\n-################################\n-# Set the default compiler used for bazel builds to be Ivy.\n-build --define=angular_ivy_enabled=True\n-\n-build:view-engine --define=angular_ivy_enabled=False\n-build:ivy --define=angular_ivy_enabled=True\n-\n ##################################\n # Remote Build Execution support #\n # Turn on these settings with    #"
        },
        {
            "sha": "7bccf4e1f525c02ee9b126276903be9fae400f03",
            "filename": "docs/BAZEL.md",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/docs%2FBAZEL.md",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/docs%2FBAZEL.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/docs%2FBAZEL.md?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -59,11 +59,8 @@ keeps the outputs up-to-date as you save sources.\n \n If you're experiencing problems with seemingly unrelated tests failing, it may be because you're not using the proper flags with your Bazel test runs in Angular.\n \n-See also: [`//.bazelrc`](https://github.com/angular/angular/blob/master/.bazelrc) where `--define=angular_ivy_enabled=False` is defined as default.\n-\n - `--config=debug`: build and launch in debug mode (see [debugging](#debugging) instructions below)\n - `--test_arg=--node_options=--inspect=9228`: change the inspector port.\n-- `--config=view-engine` Enables ViewEngine mode if present, otherwise Ivy is used. This switches which compiler is used (ngc or ngtsc)\n - `--test_tag_filters=<tag>`: filter tests down to tags defined in the `tag` config of your rules in any given `BUILD.bazel`.\n \n \n@@ -81,7 +78,7 @@ For additional info and testing options, see the\n [nodejs_test documentation](https://bazelbuild.github.io/rules_nodejs/Built-ins.html#nodejs_test).\n \n - Click on \"Resume script execution\" to let the code run until the first `debugger` statement or a previously set breakpoint.\n-- If you're debugging an ivy test and you want to inspect the generated template instructions, find the template of your component in the call stack and click on `(source mapped from [CompName].js)` at the bottom of the code. You can also disable sourcemaps in the options or go to sources and look into ng:// namespace to see all the generated code.\n+- If you're debugging a test and you want to inspect the generated template instructions, find the template of your component in the call stack and click on `(source mapped from [CompName].js)` at the bottom of the code. You can also disable sourcemaps in the options or go to sources and look into ng:// namespace to see all the generated code.\n \n ### Debugging a Node Test in VSCode\n "
        },
        {
            "sha": "d5b933bccdc69892c274bda5f36c2c404ecef8f5",
            "filename": "integration/bazel/.bazelrc",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/integration%2Fbazel%2F.bazelrc",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/integration%2Fbazel%2F.bazelrc",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fbazel%2F.bazelrc?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -12,10 +12,6 @@ test --test_output=errors\n build --local_ram_resources=14336\n build --local_cpu_resources=8\n \n-# Use the Angular Ivy compiler\n-# See https://github.com/angular/angular/blob/master/docs/BAZEL.md#various-flags-used-for-tests\n-build --define=angular_ivy_enabled=True\n-\n # Temporary define while angular depends on the legacy rollup_bundle rule.\n # TODO: remove this setting after https://github.com/angular/angular/pull/33201 lands.\n build --define=enable_legacy_rollup_rule=1"
        },
        {
            "sha": "0a6fd43b2340c5febb2618542214623c59520d96",
            "filename": "packages/bazel/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/packages%2Fbazel%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/packages%2Fbazel%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fpackage.json?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -17,7 +17,6 @@\n   \"bazelBin\": {\n     \"ngc-wrapped\": {\n       \"additionalAttributes\": {\n-        \"configuration_env_vars\": \"[\\\"angular_ivy_enabled\\\"]\",\n         \"templated_args\": \"[\\\"--bazel_patch_module_resolver\\\"]\"\n       }\n     }\n@@ -51,4 +50,4 @@\n   \"ng-update\": {\n     \"packageGroup\": \"NG_UPDATE_PACKAGE_GROUP\"\n   }\n-}\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "bf9b33222570254b18a64f982f9a6c78f78e02de",
            "filename": "packages/bazel/src/ng_module/ng_module.bzl",
            "status": "modified",
            "additions": 12,
            "deletions": 203,
            "changes": 215,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -8,7 +8,6 @@\n load(\"//packages/bazel/src/ng_module:partial_compilation.bzl\", \"NgPartialCompilationInfo\")\n load(\n     \"//packages/bazel/src:external.bzl\",\n-    \"BuildSettingInfo\",\n     \"COMMON_ATTRIBUTES\",\n     \"COMMON_OUTPUTS\",\n     \"DEFAULT_API_EXTRACTOR\",\n@@ -34,82 +33,16 @@ NgPerfInfo = provider(fields = [\"enable_perf_logging\"])\n _FLAT_DTS_FILE_SUFFIX = \".bundle.d.ts\"\n \n def is_perf_requested(ctx):\n-    enable_perf_logging = ctx.attr.perf_flag != None and ctx.attr.perf_flag[NgPerfInfo].enable_perf_logging == True\n-    if enable_perf_logging and not is_ivy_enabled(ctx):\n-        fail(\"Angular View Engine does not support performance tracing\")\n-    return enable_perf_logging\n+    return ctx.attr.perf_flag != None and ctx.attr.perf_flag[NgPerfInfo].enable_perf_logging == True\n \n def _is_partial_compilation_enabled(ctx):\n     \"\"\"Whether partial compilation is enabled for this target.\"\"\"\n     return ctx.attr._partial_compilation_flag[NgPartialCompilationInfo].enabled\n \n-def is_ivy_enabled(ctx):\n-    \"\"\"Determine if the ivy compiler should be used to by the ng_module.\n-\n-    Args:\n-      ctx: skylark rule execution context\n-\n-    Returns:\n-      Boolean, Whether the ivy compiler should be used.\n-    \"\"\"\n-\n-    # If partial compilation is enabled through a build setting, always enable Ivy.\n-    if _is_partial_compilation_enabled(ctx):\n-        return True\n-\n-    # Check the renderer flag to see if Ivy is enabled.\n-    # This is intended to support a transition use case for google3 migration.\n-    # The `_renderer` attribute will never be set externally, but will always be\n-    # set internally as a `string_flag()` with the allowed values of:\n-    # \"view_engine\" or \"ivy\".\n-    if ((hasattr(ctx.attr, \"_renderer\") and\n-         ctx.attr._renderer[BuildSettingInfo].value == \"ivy\")):\n-        return True\n-\n-    # This attribute is only defined in google's private ng_module rule and not\n-    # available externally. For external users, this is effectively a no-op.\n-    if hasattr(ctx.attr, \"ivy\") and ctx.attr.ivy == True:\n-        return True\n-\n-    if ctx.var.get(\"angular_ivy_enabled\", None) == \"True\":\n-        return True\n-\n-    # Enable Angular targets extracted by Kythe Angular indexer to be compiled with the Ivy compiler architecture.\n-    # TODO(ayazhafiz): remove once Ivy has landed as the default in g3.\n-    if ctx.var.get(\"GROK_ELLIPSIS_BUILD\", None) != None:\n-        return True\n-\n-    # Return false to default to ViewEngine compiler\n-    return False\n-\n-def _compiler_name(ctx):\n-    \"\"\"Selects a user-visible name depending on the current compilation strategy.\n-\n-    Args:\n-      ctx: skylark rule execution context\n-\n-    Returns:\n-      The name of the current compiler to be displayed in build output\n-    \"\"\"\n-    return \"Ivy\" if is_ivy_enabled(ctx) else \"ViewEngine\"\n-\n def _get_ivy_compilation_mode(ctx):\n     \"\"\"Gets the Ivy compilation mode based on the current build settings.\"\"\"\n     return \"partial\" if _is_partial_compilation_enabled(ctx) else \"full\"\n \n-def _is_view_engine_enabled(ctx):\n-    \"\"\"Determines whether Angular outputs will be produced by the current compilation strategy.\n-\n-    Args:\n-      ctx: skylark rule execution context\n-\n-    Returns:\n-      true iff the current compilation strategy will produce View Engine compilation outputs (such as\n-      factory files), false otherwise\n-    \"\"\"\n-\n-    return not is_ivy_enabled(ctx)\n-\n def _basename_of(ctx, file):\n     ext_len = len(\".ts\")\n     if file.short_path.endswith(\".ng.html\"):\n@@ -171,14 +104,10 @@ def _should_produce_flat_module_outs(ctx):\n # in the library. Most of these will be produced as empty files but it is\n # unknown, without parsing, which will be empty.\n def _expected_outs(ctx):\n-    is_legacy_ngc = _is_view_engine_enabled(ctx)\n-\n     devmode_js_files = []\n     closure_js_files = []\n     declaration_files = []\n     transpilation_infos = []\n-    summary_files = []\n-    metadata_files = []\n     flat_module_out_prodmode_file = None\n \n     factory_basename_set = depset([_basename_of(ctx, src) for src in ctx.files.factories])\n@@ -203,26 +132,10 @@ def _expected_outs(ctx):\n                     devmode_js = [\".js\"]\n \n                 # Only ngc produces .json files, they're not needed in Ivy.\n-                if is_legacy_ngc:\n-                    summaries = [\".ngsummary.json\"]\n-                    metadata = [\".metadata.json\"]\n-                else:\n-                    summaries = []\n-                    metadata = []\n             else:\n                 devmode_js = [\".js\"]\n                 if not _is_bazel():\n                     devmode_js += [\".ngfactory.js\"]\n-                summaries = []\n-                metadata = []\n-        elif is_legacy_ngc and short_path.endswith(\".css\"):\n-            basename = short_path[len(package_prefix):-len(\".css\")]\n-            devmode_js = [\n-                \".css.shim.ngstyle.js\",\n-                \".css.ngstyle.js\",\n-            ]\n-            summaries = []\n-            metadata = []\n         else:\n             continue\n \n@@ -240,9 +153,6 @@ def _expected_outs(ctx):\n                 transpilation_infos.append(struct(closure = closure_js_file, devmode = devmode_js_file))\n \n         declaration_files += [ctx.actions.declare_file(basename + ext) for ext in declarations]\n-        summary_files += [ctx.actions.declare_file(basename + ext) for ext in summaries]\n-        if not _is_bazel():\n-            metadata_files += [ctx.actions.declare_file(basename + ext) for ext in metadata]\n \n     dts_bundle = None\n     if _should_produce_dts_bundle(ctx):\n@@ -266,21 +176,9 @@ def _expected_outs(ctx):\n         devmode_js_files.append(ctx.actions.declare_file(\"%s.js\" % flat_module_out_name))\n         bundle_index_typings = ctx.actions.declare_file(\"%s.d.ts\" % flat_module_out_name)\n         declaration_files.append(bundle_index_typings)\n-        if is_legacy_ngc:\n-            metadata_files.append(ctx.actions.declare_file(\"%s.metadata.json\" % flat_module_out_name))\n     else:\n         bundle_index_typings = None\n \n-    # TODO(alxhub): i18n is only produced by the legacy compiler currently. This should be re-enabled\n-    # when ngtsc can extract messages\n-    if is_legacy_ngc and _is_bazel():\n-        i18n_messages_files = [ctx.actions.declare_file(ctx.label.name + \"_ngc_messages.xmb\")]\n-    elif is_legacy_ngc:\n-        # write the xmb file to blaze-genfiles since that path appears in the translation console keys\n-        i18n_messages_files = [ctx.new_file(ctx.genfiles_dir, ctx.label.name + \"_ngc_messages.xmb\")]\n-    else:\n-        i18n_messages_files = []\n-\n     dev_perf_files = []\n     prod_perf_files = []\n \n@@ -295,46 +193,30 @@ def _expected_outs(ctx):\n         devmode_js = devmode_js_files,\n         declarations = declaration_files,\n         transpilation_infos = transpilation_infos,\n-        summaries = summary_files,\n-        metadata = metadata_files,\n         dts_bundle = dts_bundle,\n         bundle_index_typings = bundle_index_typings,\n-        i18n_messages = i18n_messages_files,\n         dev_perf_files = dev_perf_files,\n         prod_perf_files = prod_perf_files,\n         flat_module_out_prodmode_file = flat_module_out_prodmode_file,\n     )\n \n # Determines if we need to generate View Engine shims (.ngfactory and .ngsummary files)\n def _generate_ve_shims(ctx):\n-    return _is_bazel() and _is_view_engine_enabled(ctx) or (\n-        getattr(ctx.attr, \"generate_ve_shims\", False) == True\n-    )\n+    return _is_bazel() and getattr(ctx.attr, \"generate_ve_shims\", False) == True\n \n def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n     generate_ve_shims = _generate_ve_shims(ctx)\n     compilation_mode = _get_ivy_compilation_mode(ctx)\n     is_devmode = \"devmode_manifest\" in kwargs\n     outs = _expected_outs(ctx)\n-    is_legacy_ngc = _is_view_engine_enabled(ctx)\n     if is_devmode:\n-        expected_outs = outs.devmode_js + outs.declarations + outs.summaries + outs.metadata\n+        expected_outs = outs.devmode_js + outs.declarations\n     else:\n         expected_outs = outs.closure_js\n \n     if not ctx.attr.type_check and ctx.attr.strict_templates:\n         fail(\"Cannot set type_check = False and strict_templates = True for ng_module()\")\n \n-    # Targets that set strict_templates should only be built with Ivy. If we allowed\n-    # View Engine builds, then later attempts to migrate such targets to Ivy may fail\n-    # due to new template errors that only the Ivy compiler produces.\n-    #\n-    # Note that during i18n message extraction, Ivy targets are still built with\n-    # View Engine, so we specifically exempt xi18n compilations from this error.\n-    # See b/187342177 for context.\n-    if is_legacy_ngc and ctx.attr.strict_templates:\n-        fail(\"strict_templates is not available for legacy View Engine compilations. See go/angular/ivy for details on how to opt in.\")\n-\n     if ctx.attr.experimental_extended_template_diagnostics and not ctx.attr.strict_templates:\n         fail(\"Cannot set `experimental_extended_template_diagnostics = True` **and** `strict_templates = False` for `ng_module()`\")\n \n@@ -344,9 +226,6 @@ def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n         \"allowEmptyCodegenFiles\": True,\n         \"generateNgFactoryShims\": True if generate_ve_shims else False,\n         \"generateNgSummaryShims\": True if generate_ve_shims else False,\n-        # Summaries are only enabled if Angular outputs are to be produced.\n-        \"enableSummariesForJit\": is_legacy_ngc,\n-        \"enableIvy\": is_ivy_enabled(ctx),\n         \"fullTemplateTypeCheck\": ctx.attr.type_check,\n         \"strictTemplates\": ctx.attr.strict_templates,\n         \"_extendedTemplateDiagnostics\": ctx.attr.experimental_extended_template_diagnostics,\n@@ -399,28 +278,6 @@ def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n \n     return tsconfig\n \n-def _has_target_angular_summaries(target):\n-    return hasattr(target, \"angular\") and hasattr(target.angular, \"summaries\")\n-\n-def _collect_summaries_aspect_impl(target, ctx):\n-    results = depset(target.angular.summaries if _has_target_angular_summaries(target) else [])\n-\n-    # If we are visiting empty-srcs ts_library, this is a re-export\n-    srcs = ctx.rule.attr.srcs if hasattr(ctx.rule.attr, \"srcs\") else []\n-\n-    # \"re-export\" rules should expose all the files of their deps\n-    if not srcs and hasattr(ctx.rule.attr, \"deps\"):\n-        for dep in ctx.rule.attr.deps:\n-            if (_has_target_angular_summaries(dep)):\n-                results = depset(dep.angular.summaries, transitive = [results])\n-\n-    return struct(collect_summaries_aspect_result = results)\n-\n-_collect_summaries_aspect = aspect(\n-    implementation = _collect_summaries_aspect_impl,\n-    attr_aspects = [\"deps\"],\n-)\n-\n # Extra options passed to Node when running ngc.\n _EXTRA_NODE_OPTIONS_FLAGS = [\n     # Expose the v8 garbage collection API to JS.\n@@ -436,7 +293,6 @@ def ngc_compile_action(\n         label,\n         inputs,\n         outputs,\n-        messages_out,\n         tsconfig_file,\n         node_opts,\n         locale = None,\n@@ -453,7 +309,6 @@ def ngc_compile_action(\n       label: the label of the ng_module being compiled\n       inputs: passed to the ngc action's inputs\n       outputs: passed to the ngc action's outputs\n-      messages_out: produced xmb files\n       tsconfig_file: tsconfig file with settings used for the compilation\n       node_opts: list of strings, extra nodejs options.\n       locale: i18n locale, or None\n@@ -465,16 +320,10 @@ def ngc_compile_action(\n       the parameters of the compilation which will be used to replay the ngc action for i18N.\n     \"\"\"\n \n-    is_legacy_ngc = _is_view_engine_enabled(ctx)\n-\n-    if is_legacy_ngc:\n-        ngc_compilation_mode = target_flavor\n-    else:\n-        ngc_compilation_mode = \"%s %s\" % (_get_ivy_compilation_mode(ctx), target_flavor)\n+    ngc_compilation_mode = \"%s %s\" % (_get_ivy_compilation_mode(ctx), target_flavor)\n \n     mnemonic = \"AngularTemplateCompile\"\n-    progress_message = \"Compiling Angular templates (%s - %s) %s\" % (\n-        _compiler_name(ctx),\n+    progress_message = \"Compiling Angular templates (%s) %s\" % (\n         ngc_compilation_mode,\n         label,\n     )\n@@ -512,24 +361,6 @@ def ngc_compile_action(\n         },\n     )\n \n-    if is_legacy_ngc and messages_out != None:\n-        # The base path is bin_dir because of the way the ngc\n-        # compiler host is configured. Under Blaze, we need to explicitly\n-        # point to genfiles/ to redirect the output.\n-        # See _expected_outs above, where the output path for the message file\n-        # is conditional on whether we are in Bazel.\n-        message_file_path = messages_out[0].short_path if _is_bazel() else \"../genfiles/\" + messages_out[0].short_path\n-        ctx.actions.run(\n-            inputs = inputs,\n-            outputs = messages_out,\n-            executable = ctx.executable.ng_xi18n,\n-            arguments = (_EXTRA_NODE_OPTIONS_FLAGS +\n-                         [tsconfig_file.path] +\n-                         [message_file_path]),\n-            progress_message = \"Extracting Angular 2 messages (ng_xi18n)\",\n-            mnemonic = \"Angular2MessageExtractor\",\n-        )\n-\n     if dts_bundle_out != None:\n         # combine the inputs and outputs and filter .d.ts and json files\n         filter_inputs = [f for f in inputs.to_list() + outputs if f.path.endswith(\".d.ts\") or f.path.endswith(\".json\")]\n@@ -565,7 +396,7 @@ def ngc_compile_action(\n \n def _filter_ts_inputs(all_inputs):\n     # The compiler only needs to see TypeScript sources from the npm dependencies,\n-    # but may need to look at package.json and ngsummary.json files as well.\n+    # but may need to look at package.json files as well.\n     return [\n         f\n         for f in all_inputs\n@@ -577,7 +408,6 @@ def _compile_action(\n         inputs,\n         outputs,\n         dts_bundle_out,\n-        messages_out,\n         perf_out,\n         tsconfig_file,\n         node_opts,\n@@ -610,25 +440,18 @@ def _compile_action(\n             file_inputs.extend(_filter_ts_inputs(d[NpmPackageInfo].sources.to_list()))\n \n     # Collect the inputs and summary files from our deps\n-    action_inputs = depset(\n-        file_inputs,\n-        transitive = [\n-            dep.collect_summaries_aspect_result\n-            for dep in ctx.attr.deps\n-            if hasattr(dep, \"collect_summaries_aspect_result\")\n-        ],\n-    )\n+    action_inputs = depset(file_inputs)\n \n-    return ngc_compile_action(ctx, ctx.label, action_inputs, outputs, messages_out, tsconfig_file, node_opts, None, [], dts_bundle_out, target_flavor)\n+    return ngc_compile_action(ctx, ctx.label, action_inputs, outputs, tsconfig_file, node_opts, None, [], dts_bundle_out, target_flavor)\n \n def _prodmode_compile_action(ctx, inputs, outputs, tsconfig_file, node_opts):\n     outs = _expected_outs(ctx)\n-    return _compile_action(ctx, inputs, outputs + outs.closure_js + outs.prod_perf_files, None, outs.i18n_messages, outs.prod_perf_files, tsconfig_file, node_opts, \"prodmode\")\n+    return _compile_action(ctx, inputs, outputs + outs.closure_js + outs.prod_perf_files, None, outs.prod_perf_files, tsconfig_file, node_opts, \"prodmode\")\n \n def _devmode_compile_action(ctx, inputs, outputs, tsconfig_file, node_opts):\n     outs = _expected_outs(ctx)\n-    compile_action_outputs = outputs + outs.devmode_js + outs.declarations + outs.summaries + outs.metadata + outs.dev_perf_files\n-    _compile_action(ctx, inputs, compile_action_outputs, outs.dts_bundle, None, outs.dev_perf_files, tsconfig_file, node_opts, \"devmode\")\n+    compile_action_outputs = outputs + outs.devmode_js + outs.declarations + outs.dev_perf_files\n+    _compile_action(ctx, inputs, compile_action_outputs, outs.dts_bundle, outs.dev_perf_files, tsconfig_file, node_opts, \"devmode\")\n \n def _ts_expected_outs(ctx, label, srcs_files = []):\n     # rules_typescript expects a function with two or more arguments, but our\n@@ -651,8 +474,6 @@ def ng_module_impl(ctx, ts_compile_actions):\n       conversion by ts_providers_dict_to_struct\n     \"\"\"\n \n-    is_legacy_ngc = _is_view_engine_enabled(ctx)\n-\n     providers = ts_compile_actions(\n         ctx,\n         is_library = True,\n@@ -666,21 +487,9 @@ def ng_module_impl(ctx, ts_compile_actions):\n \n     providers[\"angular\"] = {}\n \n-    if is_legacy_ngc:\n-        providers[\"angular\"][\"summaries\"] = outs.summaries\n-        providers[\"angular\"][\"metadata\"] = outs.metadata\n-        providers[\"ngc_messages\"] = outs.i18n_messages\n-\n     if _should_produce_flat_module_outs(ctx):\n-        # Sanity error if more than one metadata file has been created in the\n-        # legacy ngc compiler while a flat module should be produced.\n-        if is_legacy_ngc and len(outs.metadata) > 1:\n-            fail(\"expecting exactly one metadata output for \" + str(ctx.label))\n-\n         providers[\"angular\"][\"flat_module_metadata\"] = struct(\n             module_name = ctx.attr.module_name,\n-            # Metadata files are only generated in the legacy ngc compiler.\n-            metadata_file = outs.metadata[0] if is_legacy_ngc else None,\n             typings_file = outs.bundle_index_typings,\n             flat_module_out_prodmode_file = outs.flat_module_out_prodmode_file,\n         )\n@@ -729,7 +538,7 @@ NG_MODULE_ATTRIBUTES = {\n     \"srcs\": attr.label_list(allow_files = [\".ts\"]),\n     \"deps\": attr.label_list(\n         doc = \"Targets that are imported by this target\",\n-        aspects = [node_modules_aspect, _collect_summaries_aspect] + DEPS_ASPECTS,\n+        aspects = [node_modules_aspect] + DEPS_ASPECTS,\n     ),\n     \"assets\": attr.label_list(\n         doc = \".html and .css files needed by the Angular compiler\","
        },
        {
            "sha": "50326b2d0da53fd8b9bb7043b0740e3921be9b26",
            "filename": "packages/bazel/src/ng_package/ng_package.bzl",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/packages%2Fbazel%2Fsrc%2Fng_package%2Fng_package.bzl",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/packages%2Fbazel%2Fsrc%2Fng_package%2Fng_package.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_package%2Fng_package.bzl?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -370,7 +370,6 @@ def _ng_package_impl(ctx):\n             module_name = ng_module_metadata.module_name\n             es2020_entry_point = ng_module_metadata.flat_module_out_prodmode_file\n             typings_file = ng_module_metadata.typings_file\n-            metadata_file = ng_module_metadata.metadata_file\n             guessed_paths = False\n \n             _debug(\n@@ -390,7 +389,6 @@ def _ng_package_impl(ctx):\n             # typings entry-point through the most reasonable defaults (i.e. \"package/index\").\n             es2020_entry_point = _find_matching_file(unscoped_esm2020, \"%s/index.mjs\" % entry_point_package)\n             typings_file = _find_matching_file(unscoped_type_definitions, \"%s/index.d.ts\" % entry_point_package)\n-            metadata_file = None\n             guessed_paths = True\n \n         bundle_name = \"%s.mjs\" % (primary_bundle_name if is_primary_entry_point else entry_point)\n@@ -405,7 +403,6 @@ def _ng_package_impl(ctx):\n             fesm2020_file = fesm2020_file,\n             fesm2015_file = fesm2015_file,\n             typings_file = typings_file,\n-            metadata_file = metadata_file,\n             guessed_paths = guessed_paths,\n         ))\n \n@@ -473,9 +470,6 @@ def _ng_package_impl(ctx):\n     # in the TypeScript program easily.\n     metadata_arg = {}\n     for m in collected_entry_points:\n-        if m.metadata_file:\n-            packager_inputs.extend([m.metadata_file])\n-\n         # The captured properties need to match the `EntryPointInfo` interface\n         # in the packager executable tool.\n         metadata_arg[m.module_name] = {"
        },
        {
            "sha": "18f780d16709858cafe3ae0c4721d70585a89cb0",
            "filename": "packages/bazel/src/ngc-wrapped/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2FBUILD.bazel?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -27,7 +27,6 @@ ts_library(\n \n nodejs_binary(\n     name = \"ngc-wrapped\",\n-    configuration_env_vars = [\"angular_ivy_enabled\"],\n     data = [\n         \":ngc_lib\",\n         \"//packages/bazel/third_party/github.com/bazelbuild/bazel/src/main/protobuf:worker_protocol.proto\","
        },
        {
            "sha": "5cf16e6ecbe24bb3679b250594e3cae675873f68",
            "filename": "packages/core/test/bundling/core_all/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/packages%2Fcore%2Ftest%2Fbundling%2Fcore_all%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/packages%2Fcore%2Ftest%2Fbundling%2Fcore_all%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fcore_all%2FBUILD.bazel?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -25,7 +25,6 @@ ng_rollup_bundle(\n js_size_tracking_test(\n     name = \"size_test\",\n     src = \"angular/packages/core/test/bundling/core_all/bundle.min.js\",\n-    angular_ivy_enabled = \"True\",\n     data = [\n         \"bundle.golden_size_map.json\",\n         \":bundle\","
        },
        {
            "sha": "70d03ccfb7182726f6df8ad8d8f1e032831b2902",
            "filename": "tools/defaults.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/tools%2Fdefaults.bzl",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/tools%2Fdefaults.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fdefaults.bzl?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -390,7 +390,6 @@ def ng_benchmark(**kwargs):\n def nodejs_binary(data = [], **kwargs):\n     \"\"\"Default values for nodejs_binary\"\"\"\n     _nodejs_binary(\n-        configuration_env_vars = [\"angular_ivy_enabled\"],\n         data = data + [\"@npm//source-map-support\"],\n         **kwargs\n     )\n@@ -431,9 +430,7 @@ def jasmine_node_test(bootstrap = [], **kwargs):\n         \"@npm//tslib\",\n         \"@npm//xhr2\",\n     ]\n-    configuration_env_vars = kwargs.pop(\"configuration_env_vars\", []) + [\n-        \"angular_ivy_enabled\",\n-    ]\n+    configuration_env_vars = kwargs.pop(\"configuration_env_vars\", [])\n \n     # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n     # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324"
        },
        {
            "sha": "68add8f4fd9051b04cb10d0f40a0135f68b89399",
            "filename": "tools/size-tracking/index.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/tools%2Fsize-tracking%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/tools%2Fsize-tracking%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsize-tracking%2Findex.bzl?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -18,7 +18,6 @@ def js_size_tracking_test(\n         golden_file,\n         max_percentage_diff,\n         max_byte_diff,\n-        angular_ivy_enabled = \"False\",\n         data = [],\n         **kwargs):\n     all_data = data + [\n@@ -32,15 +31,13 @@ def js_size_tracking_test(\n         name = name,\n         data = all_data,\n         entry_point = entry_point,\n-        configuration_env_vars = [\"angular_ivy_enabled\"],\n         templated_args = [\n             src,\n             source_map,\n             golden_file,\n             \"%d\" % max_percentage_diff,\n             \"%d\" % max_byte_diff,\n             \"false\",\n-            angular_ivy_enabled,\n         ],\n         **kwargs\n     )\n@@ -50,7 +47,6 @@ def js_size_tracking_test(\n         testonly = True,\n         data = all_data,\n         entry_point = entry_point,\n-        configuration_env_vars = [\"angular_ivy_enabled\"],\n-        templated_args = [src, source_map, golden_file, \"0\", \"0\", \"true\", angular_ivy_enabled],\n+        templated_args = [src, source_map, golden_file, \"0\", \"0\", \"true\"],\n         **kwargs\n     )"
        },
        {
            "sha": "b20ea17977721332e7fc8cff7603b150f500bfc1",
            "filename": "tools/size-tracking/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 14,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/tools%2Fsize-tracking%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/tools%2Fsize-tracking%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsize-tracking%2Findex.ts?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -14,28 +14,19 @@ import {FileSizeData} from './file_size_data';\n import {SizeTracker} from './size_tracker';\n \n if (require.main === module) {\n-  const [filePath, sourceMapPath, goldenPath, maxPercentageDiffArg, maxSizeDiffArg, writeGoldenArg, requiredCompileMode] =\n+  const [filePath, sourceMapPath, goldenPath, maxPercentageDiffArg, maxSizeDiffArg, writeGoldenArg] =\n       process.argv.slice(2);\n   const status = main(\n       require.resolve(filePath), require.resolve(sourceMapPath), require.resolve(goldenPath),\n-      writeGoldenArg === 'true', parseInt(maxPercentageDiffArg), parseInt(maxSizeDiffArg),\n-      requiredCompileMode);\n+      writeGoldenArg === 'true', parseInt(maxPercentageDiffArg), parseInt(maxSizeDiffArg));\n \n   process.exit(status ? 0 : 1);\n }\n \n export function main(\n     filePath: string, sourceMapPath: string, goldenSizeMapPath: string, writeGolden: boolean,\n-    maxPercentageDiff: number, maxByteDiff: number, requiresIvy: string): boolean {\n+    maxPercentageDiff: number, maxByteDiff: number): boolean {\n   const {sizeResult} = new SizeTracker(filePath, sourceMapPath);\n-  const ivyEnabled = process.env['angular_ivy_enabled'] == 'True';\n-\n-  if (requiresIvy && ivyEnabled) {\n-    console.error(chalk.red(\n-        `Expected the size-tracking tool to be run with: ` +\n-        `--config=${requiresIvy ? 'ivy' : 'view-engine'}`));\n-    return false;\n-  }\n \n   if (writeGolden) {\n     writeFileSync(goldenSizeMapPath, JSON.stringify(sizeResult, null, 2));\n@@ -62,7 +53,6 @@ export function main(\n   const bazelTargetName = process.env['TEST_TARGET'];\n \n   console.error(`\\nThe golden file can be updated with the following command:`);\n-  console.error(`    yarn bazel run --config=${ivyEnabled ? 'ivy' : 'view-engine'} ${\n-      bazelTargetName}.accept`);\n+  console.error(`    yarn bazel run ${bazelTargetName}.accept`);\n   return false;\n }"
        },
        {
            "sha": "336eecabd96c5faefc3d2d76ecdc10e20b85b3ae",
            "filename": "tools/symbol-extractor/cli.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/tools%2Fsymbol-extractor%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/tools%2Fsymbol-extractor%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fcli.ts?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -41,11 +41,9 @@ function main(argv: [string, string, string]|[string, string]): boolean {\n   } else {\n     passed = symbolExtractor.compareAndPrintError(goldenFilePath, goldenContent);\n     if (!passed) {\n-      const ivyEnabled = process.env['angular_ivy_enabled'] == 'True';\n       console.error(`TEST FAILED!`);\n       console.error(`  To update the golden file run: `);\n-      console.error(`    yarn bazel run --config=${ivyEnabled ? 'ivy' : 'view-engine'} ${\n-          process.env['TEST_TARGET']}.accept`);\n+      console.error(`    yarn bazel run ${process.env['TEST_TARGET']}.accept`);\n     }\n   }\n   return passed;"
        },
        {
            "sha": "3a9ed69af5a9027b3618af4d22555199992cef61",
            "filename": "tools/symbol-extractor/index.bzl",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/tools%2Fsymbol-extractor%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5/tools%2Fsymbol-extractor%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Findex.bzl?ref=aadfad739b6b80cf40d0e3d979f7ba649dc8c3a5",
            "patch": "@@ -28,7 +28,6 @@ def js_expected_symbol_test(name, src, golden, data = [], **kwargs):\n         # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n         # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n         templated_args = [\"--bazel_patch_module_resolver\", \"$(rootpath %s)\" % src, \"$(rootpath %s)\" % golden],\n-        configuration_env_vars = [\"angular_ivy_enabled\"],\n         **kwargs\n     )\n \n@@ -37,7 +36,6 @@ def js_expected_symbol_test(name, src, golden, data = [], **kwargs):\n         testonly = True,\n         data = all_data,\n         entry_point = entry_point,\n-        configuration_env_vars = [\"angular_ivy_enabled\"],\n         # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n         # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n         templated_args = [\"--bazel_patch_module_resolver\", \"$(rootpath %s)\" % src, \"$(rootpath %s)\" % golden, \"--accept\"],"
        }
    ],
    "stats": {
        "total": 279,
        "additions": 21,
        "deletions": 258
    }
}