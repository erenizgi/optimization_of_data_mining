{
    "author": "josephperrott",
    "message": "feat(dev-infra): allow local ng-dev configuration to error on invalid commit messages (#38784)\n\nAs part of the commit message conformance check, local commit message checks are\nmade to be warnings rather than failures. An additional local option is also in\nplace to allow for the commit message validation failures to be considered errors\ninstead.\n\nPR Close #38784",
    "sha": "78e1ecb16134ba62abeba48624ae056909cbb220",
    "files": [
        {
            "sha": "fb1581ef084209c87473a860543dc2d4b32018b0",
            "filename": "dev-infra/commit-message/cli.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/78e1ecb16134ba62abeba48624ae056909cbb220/dev-infra%2Fcommit-message%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/78e1ecb16134ba62abeba48624ae056909cbb220/dev-infra%2Fcommit-message%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fcli.ts?ref=78e1ecb16134ba62abeba48624ae056909cbb220",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as yargs from 'yargs';\n+import {getUserConfig} from '../utils/config';\n \n import {info} from '../utils/console';\n \n@@ -78,11 +79,17 @@ export function buildCommitMessageParser(localYargs: yargs.Argv) {\n                 }\n                 return file;\n               },\n+            },\n+            'error': {\n+              type: 'boolean',\n+              description:\n+                  'Whether invalid commit messages should be treated as failures rather than a warning',\n+              default: !!getUserConfig().commitMessage?.errorOnInvalidMessage || !!process.env['CI']\n             }\n           },\n           args => {\n             const file = args.file || args['file-env-variable'] || '.git/COMMIT_EDITMSG';\n-            validateFile(file);\n+            validateFile(file, args.error);\n           })\n       .command(\n           'validate-range', 'Validate a range of commit messages', {"
        },
        {
            "sha": "87973835ca332a94328da8d572198a66d892795e",
            "filename": "dev-infra/commit-message/validate-file.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 8,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/78e1ecb16134ba62abeba48624ae056909cbb220/dev-infra%2Fcommit-message%2Fvalidate-file.ts",
            "raw_url": "https://github.com/angular/angular/raw/78e1ecb16134ba62abeba48624ae056909cbb220/dev-infra%2Fcommit-message%2Fvalidate-file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate-file.ts?ref=78e1ecb16134ba62abeba48624ae056909cbb220",
            "patch": "@@ -8,29 +8,40 @@\n import {readFileSync} from 'fs';\n import {resolve} from 'path';\n \n-import {getRepoBaseDir} from '../utils/config';\n-import {error, green, info, red} from '../utils/console';\n+import {getRepoBaseDir, getUserConfig} from '../utils/config';\n+import {error, green, info, log, red, yellow} from '../utils/console';\n \n import {deleteCommitMessageDraft, saveCommitMessageDraft} from './commit-message-draft';\n import {printValidationErrors, validateCommitMessage} from './validate';\n \n /** Validate commit message at the provided file path. */\n-export function validateFile(filePath: string) {\n+export function validateFile(filePath: string, isErrorMode: boolean) {\n   const commitMessage = readFileSync(resolve(getRepoBaseDir(), filePath), 'utf8');\n   const {valid, errors} = validateCommitMessage(commitMessage);\n   if (valid) {\n     info(`${green('√')}  Valid commit message`);\n     deleteCommitMessageDraft(filePath);\n+    process.exitCode = 0;\n     return;\n   }\n \n-  error(`${red('✘')}  Invalid commit message`);\n-  printValidationErrors(errors);\n-  error('Aborting commit attempt due to invalid commit message.');\n+  /** Function used to print to the console log. */\n+  let printFn = isErrorMode ? error : log;\n+\n+  printFn(`${isErrorMode ? red('✘') : yellow('!')}  Invalid commit message`);\n+  printValidationErrors(errors, printFn);\n+  if (isErrorMode) {\n+    printFn(red('Aborting commit attempt due to invalid commit message.'));\n+    printFn(\n+        red('Commit message aborted as failure rather than warning due to local configuration.'));\n+  } else {\n+    printFn(yellow('Before this commit can be merged into the upstream repository, it must be'));\n+    printFn(yellow('amended to follow commit message guidelines.'));\n+  }\n \n   // On all invalid commit messages, the commit message should be saved as a draft to be\n   // restored on the next commit attempt.\n   saveCommitMessageDraft(filePath, commitMessage);\n-  // If the validation did not return true, exit as a failure.\n-  process.exit(1);\n+  // Set the correct exit code based on if invalid commit message is an error.\n+  process.exitCode = isErrorMode ? 1 : 0;\n }"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 27,
        "deletions": 9
    }
}