{
    "author": "mhevery",
    "message": "refactor(core): Improve tree shakability of i18n code. (#39301)\n\n`TNode.insertBeforeIndex` is only populated when i18n is present. This\nchange puts all code which reads `insertBeforeIndex` behind a\ndynamically loaded functions which are set only when i18n code executes.\n\nPR Close #39301",
    "sha": "d939b5f5983d7aacf59f00145ea1db9f76712792",
    "files": [
        {
            "sha": "0fb0d216ee1c93daf09a10cfae7fbeb8ef287d26",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/d939b5f5983d7aacf59f00145ea1db9f76712792/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/d939b5f5983d7aacf59f00145ea1db9f76712792/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=d939b5f5983d7aacf59f00145ea1db9f76712792",
            "patch": "@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 1485,\n-        \"main-es2015\": 17092,\n+        \"main-es2015\": 17049,\n         \"polyfills-es2015\": 36657\n       }\n     }\n@@ -49,7 +49,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 2289,\n-        \"main-es2015\": 218527,\n+        \"main-es2015\": 217879,\n         \"polyfills-es2015\": 36723,\n         \"5-es2015\": 781\n       }"
        },
        {
            "sha": "9efb2cbc7351472e1912c1f48b6986c83ea7d852",
            "filename": "packages/core/src/render3/i18n/i18n_insert_before_index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_insert_before_index.ts",
            "raw_url": "https://github.com/angular/angular/raw/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_insert_before_index.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_insert_before_index.ts?ref=d939b5f5983d7aacf59f00145ea1db9f76712792",
            "patch": "@@ -8,6 +8,8 @@\n \n import {assertEqual} from '../../util/assert';\n import {TNode, TNodeType} from '../interfaces/node';\n+import {setI18nHandling} from '../node_manipulation';\n+import {getInsertInFrontOfRNodeWithI18n, processI18nInsertBefore} from '../node_manipulation_i18n';\n \n /**\n  * Add `tNode` to `previousTNodes` list and update relevant `TNode`s in `previousTNodes` list\n@@ -81,6 +83,7 @@ function setInsertBeforeIndex(tNode: TNode, value: number): void {\n     // Array is stored if we have to insert child nodes. See `TNode.insertBeforeIndex`\n     index[0] = value;\n   } else {\n+    setI18nHandling(getInsertInFrontOfRNodeWithI18n, processI18nInsertBefore);\n     tNode.insertBeforeIndex = value;\n   }\n }"
        },
        {
            "sha": "5952589415360b18f4f86f361cebd4ad1323a8ae",
            "filename": "packages/core/src/render3/i18n/i18n_parse.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_parse.ts",
            "raw_url": "https://github.com/angular/angular/raw/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_parse.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_parse.ts?ref=d939b5f5983d7aacf59f00145ea1db9f76712792",
            "patch": "@@ -117,7 +117,7 @@ export function i18nStartFirstCreatePass(\n       }\n     } else {\n       // Odd indexes are placeholders (elements and sub-templates)\n-      // At this point value is something like: '/#1:2' (orginally coming from '�/#1:2�')\n+      // At this point value is something like: '/#1:2' (originally coming from '�/#1:2�')\n       const isClosing = value.charCodeAt(0) === CharCode.SLASH;\n       const type = value.charCodeAt(isClosing ? 1 : 0);\n       ngDevMode && assertOneOf(type, CharCode.STAR, CharCode.HASH, CharCode.EXCLAMATION);"
        },
        {
            "sha": "df3e2b5cc0b5941cee16d6b9379ed2e481b2cebe",
            "filename": "packages/core/src/render3/i18n/i18n_util.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_util.ts",
            "raw_url": "https://github.com/angular/angular/raw/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_util.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_util.ts?ref=d939b5f5983d7aacf59f00145ea1db9f76712792",
            "patch": "@@ -13,6 +13,8 @@ import {IcuCreateOpCode, TIcu} from '../interfaces/i18n';\n import {TIcuContainerNode, TNode, TNodeType} from '../interfaces/node';\n import {LView, TView} from '../interfaces/view';\n import {assertTNodeType} from '../node_assert';\n+import {setI18nHandling} from '../node_manipulation';\n+import {getInsertInFrontOfRNodeWithI18n, processI18nInsertBefore} from '../node_manipulation_i18n';\n import {addTNodeAndUpdateInsertBeforeIndex} from './i18n_insert_before_index';\n \n \n@@ -83,6 +85,7 @@ export function setTNodeInsertBeforeIndex(tNode: TNode, index: number) {\n   ngDevMode && assertTNode(tNode);\n   let insertBeforeIndex = tNode.insertBeforeIndex;\n   if (insertBeforeIndex === null) {\n+    setI18nHandling(getInsertInFrontOfRNodeWithI18n, processI18nInsertBefore);\n     insertBeforeIndex = tNode.insertBeforeIndex =\n         [null!/* may be updated to number later */, index];\n   } else {"
        },
        {
            "sha": "c4128984333544bf3ff420500efa9b06d751ff5c",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=d939b5f5983d7aacf59f00145ea1db9f76712792",
            "patch": "@@ -12,7 +12,7 @@ import {CUSTOM_ELEMENTS_SCHEMA, NO_ERRORS_SCHEMA, SchemaMetadata} from '../../me\n import {ViewEncapsulation} from '../../metadata/view';\n import {validateAgainstEventAttributes, validateAgainstEventProperties} from '../../sanitization/sanitization';\n import {Sanitizer} from '../../sanitization/sanitizer';\n-import {assertDefined, assertDomNode, assertEqual, assertGreaterThan, assertGreaterThanOrEqual, assertIndexInRange, assertNotEqual, assertNotSame, assertSame, assertString} from '../../util/assert';\n+import {assertDefined, assertDomNode, assertEqual, assertGreaterThanOrEqual, assertIndexInRange, assertNotEqual, assertNotSame, assertSame, assertString} from '../../util/assert';\n import {createNamedArrayType} from '../../util/named_array_type';\n import {initNgDevMode} from '../../util/ng_dev_mode';\n import {normalizeDebugBindingName, normalizeDebugBindingValue} from '../../util/ng_reflect';"
        },
        {
            "sha": "26dac17c43044893347394e753296bf380a9b61f",
            "filename": "packages/core/src/render3/node_manipulation.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 55,
            "changes": 104,
            "blob_url": "https://github.com/angular/angular/blob/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "raw_url": "https://github.com/angular/angular/raw/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts?ref=d939b5f5983d7aacf59f00145ea1db9f76712792",
            "patch": "@@ -639,28 +639,64 @@ export function nativeNextSibling(renderer: Renderer3, node: RNode): RNode|null\n  * Find a node in front of which `currentTNode` should be inserted.\n  *\n  * This method determines the `RNode` in front of which we should insert the `currentRNode`. This\n- * takes `TNode.insertBeforeIndex` into account.\n+ * takes `TNode.insertBeforeIndex` into account if i18n code has been invoked.\n  *\n  * @param parentTNode parent `TNode`\n  * @param currentTNode current `TNode` (The node which we would like to insert into the DOM)\n  * @param lView current `LView`\n  */\n function getInsertInFrontOfRNode(parentTNode: TNode, currentTNode: TNode, lView: LView): RNode|\n     null {\n-  const tNodeInsertBeforeIndex = currentTNode.insertBeforeIndex;\n-  const insertBeforeIndex =\n-      Array.isArray(tNodeInsertBeforeIndex) ? tNodeInsertBeforeIndex[0] : tNodeInsertBeforeIndex;\n-  if (insertBeforeIndex === null) {\n-    if (parentTNode.type & (TNodeType.ElementContainer | TNodeType.Icu)) {\n-      return getNativeByTNode(parentTNode, lView);\n-    }\n-  } else {\n-    ngDevMode && assertIndexInRange(lView, insertBeforeIndex);\n-    return unwrapRNode(lView[insertBeforeIndex]);\n+  return _getInsertInFrontOfRNodeWithI18n(parentTNode, currentTNode, lView);\n+}\n+\n+\n+/**\n+ * Find a node in front of which `currentTNode` should be inserted. (Does not take i18n into\n+ * account)\n+ *\n+ * This method determines the `RNode` in front of which we should insert the `currentRNode`. This\n+ * does not take `TNode.insertBeforeIndex` into account.\n+ *\n+ * @param parentTNode parent `TNode`\n+ * @param currentTNode current `TNode` (The node which we would like to insert into the DOM)\n+ * @param lView current `LView`\n+ */\n+export function getInsertInFrontOfRNodeWithNoI18n(\n+    parentTNode: TNode, currentTNode: TNode, lView: LView): RNode|null {\n+  if (parentTNode.type & (TNodeType.ElementContainer | TNodeType.Icu)) {\n+    return getNativeByTNode(parentTNode, lView);\n   }\n   return null;\n }\n \n+/**\n+ * Tree shakable boundary for `getInsertInFrontOfRNodeWithI18n` function.\n+ *\n+ * This function will only be set if i18n code runs.\n+ */\n+let _getInsertInFrontOfRNodeWithI18n: (parentTNode: TNode, currentTNode: TNode, lView: LView) =>\n+    RNode | null = getInsertInFrontOfRNodeWithNoI18n;\n+\n+/**\n+ * Tree shakable boundary for `processI18nInsertBefore` function.\n+ *\n+ * This function will only be set if i18n code runs.\n+ */\n+let _processI18nInsertBefore: (\n+    renderer: Renderer3, childTNode: TNode, lView: LView, childRNode: RNode|RNode[],\n+    parentRElement: RElement|null) => void;\n+\n+export function setI18nHandling(\n+    getInsertInFrontOfRNodeWithI18n: (parentTNode: TNode, currentTNode: TNode, lView: LView) =>\n+        RNode | null,\n+    processI18nInsertBefore: (\n+        renderer: Renderer3, childTNode: TNode, lView: LView, childRNode: RNode|RNode[],\n+        parentRElement: RElement|null) => void) {\n+  _getInsertInFrontOfRNodeWithI18n = getInsertInFrontOfRNodeWithI18n;\n+  _processI18nInsertBefore = processI18nInsertBefore;\n+}\n+\n /**\n  * Appends the `child` native node (or a collection of nodes) to the `parent`.\n  *\n@@ -685,50 +721,8 @@ export function appendChild(\n     }\n   }\n \n-  const tNodeInsertBeforeIndex = childTNode.insertBeforeIndex;\n-  if (Array.isArray(tNodeInsertBeforeIndex) &&\n-      (childTNode.flags & TNodeFlags.isComponentHost) === 0) {\n-    // An array indicates that there are i18n nodes that need to be added as children of this\n-    // `rChildNode`. These i18n nodes were created before this `rChildNode` was available and so\n-    // only now can be added. The first element of the array is the normal index where we should\n-    // insert the `rChildNode`. Additional elements are the extra nodes to be added as children of\n-    // `rChildNode`.\n-    processI18nText(renderer, childTNode, lView, childRNode, parentRNode, tNodeInsertBeforeIndex);\n-  }\n-}\n-\n-/**\n- * Process `TNode.insertBeforeIndex` by adding i18n text nodes.\n- *\n- * See `TNode.insertBeforeIndex`\n- *\n- * @param renderer\n- * @param childTNode\n- * @param lView\n- * @param childRNode\n- * @param parentRElement\n- * @param i18nChildren\n- */\n-function processI18nText(\n-    renderer: Renderer3, childTNode: TNode, lView: LView, childRNode: RNode|RNode[],\n-    parentRElement: RElement|null, i18nChildren: number[]): void {\n-  ngDevMode && assertDomNode(childRNode);\n-  const isProcedural = isProceduralRenderer(renderer);\n-  let i18nParent: RElement|null = childRNode as RElement;\n-  let anchorRNode: RNode|null = null;\n-  if (!(childTNode.type & TNodeType.AnyRNode)) {\n-    anchorRNode = i18nParent;\n-    i18nParent = parentRElement;\n-  }\n-  const isViewRoot = childTNode.parent === null;\n-  if (i18nParent !== null) {\n-    for (let i = 1; i < i18nChildren.length; i++) {\n-      // No need to `unwrapRNode` because all of the indexes point to i18n text nodes.\n-      // see `assertDomNode` below.\n-      const i18nChild = lView[i18nChildren[i]];\n-      nativeInsertBefore(renderer, i18nParent, i18nChild, anchorRNode, false);\n-    }\n-  }\n+  _processI18nInsertBefore !== undefined &&\n+      _processI18nInsertBefore(renderer, childTNode, lView, childRNode, parentRNode);\n }\n \n /**"
        },
        {
            "sha": "97bac79ffcb8f75db50ff87418f2ebb082f0c9a7",
            "filename": "packages/core/src/render3/node_manipulation_i18n.ts",
            "status": "added",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/angular/angular/blob/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation_i18n.ts",
            "raw_url": "https://github.com/angular/angular/raw/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation_i18n.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation_i18n.ts?ref=d939b5f5983d7aacf59f00145ea1db9f76712792",
            "patch": "@@ -0,0 +1,72 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {assertDomNode, assertIndexInRange} from '../util/assert';\n+import {TNode, TNodeFlags, TNodeType} from './interfaces/node';\n+import {RElement, Renderer3, RNode} from './interfaces/renderer';\n+import {LView} from './interfaces/view';\n+import {getInsertInFrontOfRNodeWithNoI18n, nativeInsertBefore} from './node_manipulation';\n+import {unwrapRNode} from './util/view_utils';\n+\n+\n+/**\n+ * Find a node in front of which `currentTNode` should be inserted (takes i18n into account).\n+ *\n+ * This method determines the `RNode` in front of which we should insert the `currentRNode`. This\n+ * takes `TNode.insertBeforeIndex` into account.\n+ *\n+ * @param parentTNode parent `TNode`\n+ * @param currentTNode current `TNode` (The node which we would like to insert into the DOM)\n+ * @param lView current `LView`\n+ */\n+export function getInsertInFrontOfRNodeWithI18n(\n+    parentTNode: TNode, currentTNode: TNode, lView: LView): RNode|null {\n+  const tNodeInsertBeforeIndex = currentTNode.insertBeforeIndex;\n+  const insertBeforeIndex =\n+      Array.isArray(tNodeInsertBeforeIndex) ? tNodeInsertBeforeIndex[0] : tNodeInsertBeforeIndex;\n+  if (insertBeforeIndex === null) {\n+    return getInsertInFrontOfRNodeWithNoI18n(parentTNode, currentTNode, lView);\n+  } else {\n+    ngDevMode && assertIndexInRange(lView, insertBeforeIndex);\n+    return unwrapRNode(lView[insertBeforeIndex]);\n+  }\n+}\n+\n+\n+/**\n+ * Process `TNode.insertBeforeIndex` by adding i18n text nodes.\n+ *\n+ * See `TNode.insertBeforeIndex`\n+ */\n+export function processI18nInsertBefore(\n+    renderer: Renderer3, childTNode: TNode, lView: LView, childRNode: RNode|RNode[],\n+    parentRElement: RElement|null): void {\n+  const tNodeInsertBeforeIndex = childTNode.insertBeforeIndex;\n+  if (Array.isArray(tNodeInsertBeforeIndex)) {\n+    // An array indicates that there are i18n nodes that need to be added as children of this\n+    // `childRNode`. These i18n nodes were created before this `childRNode` was available and so\n+    // only now can be added. The first element of the array is the normal index where we should\n+    // insert the `childRNode`. Additional elements are the extra nodes to be added as children of\n+    // `childRNode`.\n+    ngDevMode && assertDomNode(childRNode);\n+    let i18nParent: RElement|null = childRNode as RElement;\n+    let anchorRNode: RNode|null = null;\n+    if (!(childTNode.type & TNodeType.AnyRNode)) {\n+      anchorRNode = i18nParent;\n+      i18nParent = parentRElement;\n+    }\n+    if (i18nParent !== null && (childTNode.flags & TNodeFlags.isComponentHost) === 0) {\n+      for (let i = 1; i < tNodeInsertBeforeIndex.length; i++) {\n+        // No need to `unwrapRNode` because all of the indexes point to i18n text nodes.\n+        // see `assertDomNode` below.\n+        const i18nChild = lView[tNodeInsertBeforeIndex[i]];\n+        nativeInsertBefore(renderer, i18nParent, i18nChild, anchorRNode, false);\n+      }\n+    }\n+  }\n+}"
        },
        {
            "sha": "93d584fe534d4dac3c5dd658dedf7bfe321718aa",
            "filename": "packages/core/test/bundling/hello_world/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Ftest%2Fbundling%2Fhello_world%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/d939b5f5983d7aacf59f00145ea1db9f76712792/packages%2Fcore%2Ftest%2Fbundling%2Fhello_world%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fhello_world%2Fbundle.golden_symbols.json?ref=d939b5f5983d7aacf59f00145ea1db9f76712792",
            "patch": "@@ -232,5 +232,8 @@\n   },\n   {\n     \"name\": \"viewAttachedToChangeDetector\"\n+  },\n+  {\n+    \"name\": \"ɵɵtext\"\n   }\n ]\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 193,
        "additions": 134,
        "deletions": 59
    }
}