{
    "author": "wszgrcy",
    "message": "fix(compiler-cli): correctly interpret token arrays in @Injectable `deps` (#43226)\n\nWhen specifying the `deps` array in the `@Injectable` decorator to\ninject dependencies into the injectable's factory function, it should\nbe possible to use an array literal to configure how the dependency\nshould be resolved by the DI system.\n\nFor example, the following example is allowed:\n\n```ts\n@Injectable({\n  providedIn: 'root',\n  useFactory: a => new AppService(a),\n  deps: [[new Optional(), 'a']],\n})\nexport class AppService {\n  constructor(a) {}\n}\n```\n\nHere, the `'a'` string token should be injected as optional. However,\nthe AOT compiler incorrectly used the array literal itself as injection\ntoken, resulting in a failure at runtime. Only if the token were to be\nprovided using `[new Optional(), new Inject('a')]` would it work\ncorrectly.\n\nThis commit fixes the issue by using the last non-decorator in the\narray literal as the token value, instead of the array literal itself.\n\nNote that this is a loose interpretation of array literals: if a token\nis omitted from the array literal then the array literal itself is used\nas token, but any decorator such as `new Optional()` would still have\nbeen applied. When there's multiple tokens in the list then only the\nlast one will be used as actual token, any prior tokens are silently\nignored. This behavior mirrors the JIT interpretation so is kept as is\nfor now, but may benefit from some stricter checking and better error\nreporting in the future.\n\nFixes #42987\n\nPR Close #43226",
    "sha": "8d2b6affcd8c4592ca939109f4f51e65da977652",
    "files": [
        {
            "sha": "63b88bfd805ee6452ed790e18d4219ad155671ee",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/injectable.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/8d2b6affcd8c4592ca939109f4f51e65da977652/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d2b6affcd8c4592ca939109f4f51e65da977652/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts?ref=8d2b6affcd8c4592ca939109f4f51e65da977652",
            "patch": "@@ -280,10 +280,10 @@ function getDep(dep: ts.Expression, reflector: ReflectionHost): R3DependencyMeta\n   };\n \n   function maybeUpdateDecorator(\n-      dec: ts.Identifier, reflector: ReflectionHost, token?: ts.Expression): void {\n+      dec: ts.Identifier, reflector: ReflectionHost, token?: ts.Expression): boolean {\n     const source = reflector.getImportOfIdentifier(dec);\n     if (source === null || source.from !== '@angular/core') {\n-      return;\n+      return false;\n     }\n     switch (source.name) {\n       case 'Inject':\n@@ -300,16 +300,23 @@ function getDep(dep: ts.Expression, reflector: ReflectionHost): R3DependencyMeta\n       case 'Self':\n         meta.self = true;\n         break;\n+      default:\n+        return false;\n     }\n+    return true;\n   }\n \n   if (ts.isArrayLiteralExpression(dep)) {\n     dep.elements.forEach(el => {\n+      let isDecorator = false;\n       if (ts.isIdentifier(el)) {\n-        maybeUpdateDecorator(el, reflector);\n+        isDecorator = maybeUpdateDecorator(el, reflector);\n       } else if (ts.isNewExpression(el) && ts.isIdentifier(el.expression)) {\n         const token = el.arguments && el.arguments.length > 0 && el.arguments[0] || undefined;\n-        maybeUpdateDecorator(el.expression, reflector, token);\n+        isDecorator = maybeUpdateDecorator(el.expression, reflector, token);\n+      }\n+      if (!isDecorator) {\n+        meta.token = new WrappedNodeExpr(el);\n       }\n     });\n   }"
        },
        {
            "sha": "2ba9b1d8fda9980af7584194e2379d383b67ac24",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_di/di/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/8d2b6affcd8c4592ca939109f4f51e65da977652/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/8d2b6affcd8c4592ca939109f4f51e65da977652/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2FGOLDEN_PARTIAL.js?ref=8d2b6affcd8c4592ca939109f4f51e65da977652",
            "patch": "@@ -162,19 +162,24 @@ export declare class MyService {\n /****************************************************************************************************\n  * PARTIAL FILE: usefactory_with_deps.js\n  ****************************************************************************************************/\n-import { Injectable } from '@angular/core';\n+import { Injectable, Optional } from '@angular/core';\n import * as i0 from \"@angular/core\";\n class SomeDep {\n }\n class MyAlternateService {\n+    constructor(dep, optional) { }\n }\n export class MyService {\n }\n MyService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-MyService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, providedIn: 'root', useFactory: () => new MyAlternateService(), deps: [{ token: SomeDep }] });\n+MyService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, providedIn: 'root', useFactory: (dep, optional) => new MyAlternateService(dep, optional), deps: [{ token: SomeDep }, { token: SomeDep, optional: true }] });\n i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, decorators: [{\n             type: Injectable,\n-            args: [{ providedIn: 'root', useFactory: () => new MyAlternateService(), deps: [SomeDep] }]\n+            args: [{\n+                    providedIn: 'root',\n+                    useFactory: (dep, optional) => new MyAlternateService(dep, optional),\n+                    deps: [SomeDep, [new Optional(), SomeDep]]\n+                }]\n         }] });\n \n /****************************************************************************************************"
        },
        {
            "sha": "938a0b8013c7c29b450e0c5f3283cd2ae7f8e7aa",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_di/di/usefactory_with_deps.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8d2b6affcd8c4592ca939109f4f51e65da977652/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fusefactory_with_deps.js",
            "raw_url": "https://github.com/angular/angular/raw/8d2b6affcd8c4592ca939109f4f51e65da977652/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fusefactory_with_deps.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fusefactory_with_deps.js?ref=8d2b6affcd8c4592ca939109f4f51e65da977652",
            "patch": "@@ -5,7 +5,7 @@ MyService.ɵprov = /*@__PURE__*/ $r3$.ɵɵdefineInjectable({\n     if (t) {\n       r = new t();\n     } else {\n-      r = (() => new MyAlternateService())($r3$.ɵɵinject(SomeDep));\n+      r = ((dep, optional) => new MyAlternateService(dep, optional))($r3$.ɵɵinject(SomeDep), $r3$.ɵɵinject(SomeDep, 8));\n     }\n     return r;\n   },"
        },
        {
            "sha": "06dc8d1dd6b448fa0b47e042c911c6fb841d3a81",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_di/di/usefactory_with_deps.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/8d2b6affcd8c4592ca939109f4f51e65da977652/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fusefactory_with_deps.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d2b6affcd8c4592ca939109f4f51e65da977652/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fusefactory_with_deps.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fusefactory_with_deps.ts?ref=8d2b6affcd8c4592ca939109f4f51e65da977652",
            "patch": "@@ -1,8 +1,14 @@\n-import {Injectable} from '@angular/core';\n+import {Injectable, Optional} from '@angular/core';\n \n class SomeDep {}\n-class MyAlternateService {}\n+class MyAlternateService {\n+  constructor(dep: SomeDep, optional: SomeDep|null) {}\n+}\n \n-@Injectable({providedIn: 'root', useFactory: () => new MyAlternateService(), deps: [SomeDep]})\n+@Injectable({\n+  providedIn: 'root',\n+  useFactory: (dep: SomeDep, optional: SomeDep|null) => new MyAlternateService(dep, optional),\n+  deps: [SomeDep, [new Optional(), SomeDep]]\n+})\n export class MyService {\n }"
        },
        {
            "sha": "48fdac383576db04f600dcb2bafad2b246089c71",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/8d2b6affcd8c4592ca939109f4f51e65da977652/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d2b6affcd8c4592ca939109f4f51e65da977652/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=8d2b6affcd8c4592ca939109f4f51e65da977652",
            "patch": "@@ -202,6 +202,40 @@ function allTests(os: string) {\n       expect(dtsContents).toContain('static ɵfac: i0.ɵɵFactoryDeclaration<Service, never>;');\n     });\n \n+    it('should compile Injectables with providedIn and factory with deps with array literal tokens',\n+       () => {\n+         env.write('test.ts', `\n+        import {Injectable, Optional, Self} from '@angular/core';\n+\n+        @Injectable()\n+        export class Dep {}\n+\n+        @Injectable({\n+          providedIn: 'root',\n+          useFactory: (dep: Dep) => new Service(dep),\n+          deps: [[new Optional(), new Self(), Dep]],\n+        })\n+        export class Service {\n+          constructor(dep: Dep) {}\n+        }\n+    `);\n+\n+         env.driveMain();\n+\n+         const jsContents = env.getContents('test.js');\n+         expect(jsContents).toContain('Service.ɵprov =');\n+         expect(jsContents)\n+             .toContain('factory: function Service_Factory(t) { var r = null; if (t) {');\n+         expect(jsContents).toContain('return new (t || Service)(i0.ɵɵinject(Dep));');\n+         expect(jsContents)\n+             .toContain('r = (function (dep) { return new Service(dep); })(i0.ɵɵinject(Dep, 10));');\n+         expect(jsContents).toContain(`return r; }, providedIn: 'root' });`);\n+         expect(jsContents).not.toContain('__decorate');\n+         const dtsContents = env.getContents('test.d.ts');\n+         expect(dtsContents).toContain('static ɵprov: i0.ɵɵInjectableDeclaration<Service>;');\n+         expect(dtsContents).toContain('static ɵfac: i0.ɵɵFactoryDeclaration<Service, never>;');\n+       });\n+\n     it('should compile Injectables with providedIn using forwardRef without errors', () => {\n       env.write('test.ts', `\n         import {Injectable, NgModule, forwardRef} from '@angular/core';"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 63,
        "deletions": 11
    }
}