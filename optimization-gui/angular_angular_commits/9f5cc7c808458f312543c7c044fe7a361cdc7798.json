{
    "author": "crisbeto",
    "message": "feat(compiler): support number separators in templates (#42672)\n\nAs of ES2021, JavaScript allows using underscores as separators inside numbers, in order to make them more readable (e.g. `1_000_000` vs `1000000`). TypeScript has had support for separators for a while so these changes expand the template parser to handle them as well.\n\nPR Close #42672",
    "sha": "9f5cc7c808458f312543c7c044fe7a361cdc7798",
    "files": [
        {
            "sha": "82763e7fc1a1d6b0c31d332dda8320bae77fb1f5",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/value_composition/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2FGOLDEN_PARTIAL.js?ref=9f5cc7c808458f312543c7c044fe7a361cdc7798",
            "patch": "@@ -631,3 +631,53 @@ export declare class MyModule {\n     static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: number_separator.js\n+ ****************************************************************************************************/\n+import { Component, NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class MyApp {\n+    constructor() {\n+        this.multiplier = 5;\n+    }\n+}\n+MyApp.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: `\n+    <div>Total: \\${{ 1_000_000 * multiplier }}</div>\n+    <span>Remaining: \\${{ 123_456.78_9 / 2 }}</span>\n+  `, isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, decorators: [{\n+            type: Component,\n+            args: [{\n+                    selector: 'my-app',\n+                    template: `\n+    <div>Total: \\${{ 1_000_000 * multiplier }}</div>\n+    <span>Remaining: \\${{ 123_456.78_9 / 2 }}</span>\n+  `\n+                }]\n+        }] });\n+export class MyModule {\n+}\n+MyModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\n+MyModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, declarations: [MyApp] });\n+MyModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{ declarations: [MyApp] }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: number_separator.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class MyApp {\n+    multiplier: number;\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyApp, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<MyApp, \"my-app\", never, {}, {}, never, never>;\n+}\n+export declare class MyModule {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyModule, never>;\n+    static ɵmod: i0.ɵɵNgModuleDeclaration<MyModule, [typeof MyApp], never, never>;\n+    static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n+}\n+"
        },
        {
            "sha": "e12c8c9116ceaabfdd516dfb4e2f37b090e6112d",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/value_composition/TEST_CASES.json",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2FTEST_CASES.json?ref=9f5cc7c808458f312543c7c044fe7a361cdc7798",
            "patch": "@@ -272,6 +272,20 @@\n           ]\n         }\n       ]\n+    },\n+    {\n+      \"description\": \"should support number literals with separators\",\n+      \"inputFiles\": [\n+        \"number_separator.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"failureMessage\": \"Invalid number literal\",\n+          \"files\": [\n+            \"number_separator.js\"\n+          ]\n+        }\n+      ]\n     }\n   ]\n }"
        },
        {
            "sha": "4ca574216f754f37a98b8d838824866457a346f5",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/value_composition/number_separator.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2Fnumber_separator.js",
            "raw_url": "https://github.com/angular/angular/raw/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2Fnumber_separator.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2Fnumber_separator.js?ref=9f5cc7c808458f312543c7c044fe7a361cdc7798",
            "patch": "@@ -0,0 +1,9 @@\n+template:  function MyApp_Template(rf, ctx) {\n+  // ...\n+  if (rf & 2) {\n+    $r3$.ɵɵadvance(1);\n+    $r3$.ɵɵtextInterpolate1(\"Total: $\", 1000000 * ctx.multiplier, \"\");\n+    $r3$.ɵɵadvance(2);\n+    $r3$.ɵɵtextInterpolate1(\"Remaining: $\", 123456.789 / 2, \"\");\n+  }\n+}"
        },
        {
            "sha": "26b7ba7c7593d09b31cdd95061126dd72726367d",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/value_composition/number_separator.ts",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2Fnumber_separator.ts",
            "raw_url": "https://github.com/angular/angular/raw/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2Fnumber_separator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2Fnumber_separator.ts?ref=9f5cc7c808458f312543c7c044fe7a361cdc7798",
            "patch": "@@ -0,0 +1,16 @@\n+import {Component, NgModule} from '@angular/core';\n+\n+@Component({\n+  selector: 'my-app',\n+  template: `\n+    <div>Total: \\${{ 1_000_000 * multiplier }}</div>\n+    <span>Remaining: \\${{ 123_456.78_9 / 2 }}</span>\n+  `\n+})\n+export class MyApp {\n+  multiplier = 5;\n+}\n+\n+@NgModule({declarations: [MyApp]})\n+export class MyModule {\n+}"
        },
        {
            "sha": "39372a4b073d07b678bec3ba89f865c3aa1ba723",
            "filename": "packages/compiler/src/expression_parser/lexer.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 4,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Flexer.ts",
            "raw_url": "https://github.com/angular/angular/raw/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Flexer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Flexer.ts?ref=9f5cc7c808458f312543c7c044fe7a361cdc7798",
            "patch": "@@ -303,12 +303,24 @@ class _Scanner {\n   }\n \n   scanNumber(start: number): Token {\n-    let simple: boolean = (this.index === start);\n+    let simple = (this.index === start);\n+    let hasSeparators = false;\n     this.advance();  // Skip initial digit.\n     while (true) {\n       if (chars.isDigit(this.peek)) {\n         // Do nothing.\n-      } else if (this.peek == chars.$PERIOD) {\n+      } else if (this.peek === chars.$_) {\n+        // Separators are only valid when they're surrounded by digits. E.g. `1_0_1` is\n+        // valid while `_101` and `101_` are not. The separator can't be next to the decimal\n+        // point or another separator either. Note that it's unlikely that we'll hit a case where\n+        // the underscore is at the start, because that's a valid identifier and it will be picked\n+        // up earlier in the parsing. We validate for it anyway just in case.\n+        if (!chars.isDigit(this.input.charCodeAt(this.index - 1)) ||\n+            !chars.isDigit(this.input.charCodeAt(this.index + 1))) {\n+          return this.error('Invalid numeric separator', 0);\n+        }\n+        hasSeparators = true;\n+      } else if (this.peek === chars.$PERIOD) {\n         simple = false;\n       } else if (isExponentStart(this.peek)) {\n         this.advance();\n@@ -320,8 +332,12 @@ class _Scanner {\n       }\n       this.advance();\n     }\n-    const str: string = this.input.substring(start, this.index);\n-    const value: number = simple ? parseIntAutoRadix(str) : parseFloat(str);\n+\n+    let str = this.input.substring(start, this.index);\n+    if (hasSeparators) {\n+      str = str.replace(/_/g, '');\n+    }\n+    const value = simple ? parseIntAutoRadix(str) : parseFloat(str);\n     return newNumberToken(start, this.index, value);\n   }\n "
        },
        {
            "sha": "068cfdeb52543e02b0e42e06ac04a781cac322df",
            "filename": "packages/compiler/test/expression_parser/lexer_spec.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts?ref=9f5cc7c808458f312543c7c044fe7a361cdc7798",
            "patch": "@@ -295,6 +295,36 @@ function expectErrorToken(token: Token, index: any, end: number, message: string\n       it('should tokenize ?? as operator', () => {\n         expectOperatorToken(lex('??')[0], 0, 2, '??');\n       });\n+\n+      it('should tokenize number with separator', () => {\n+        expectNumberToken(lex('123_456')[0], 0, 7, 123_456);\n+        expectNumberToken(lex('1_000_000_000')[0], 0, 13, 1_000_000_000);\n+        expectNumberToken(lex('123_456.78')[0], 0, 10, 123_456.78);\n+        expectNumberToken(lex('123_456_789.123_456_789')[0], 0, 23, 123_456_789.123_456_789);\n+        expectNumberToken(lex('1_2_3_4')[0], 0, 7, 1_2_3_4);\n+        expectNumberToken(lex('1_2_3_4.5_6_7_8')[0], 0, 15, 1_2_3_4.5_6_7_8);\n+      });\n+\n+      it('should tokenize number starting with an underscore as an identifier', () => {\n+        expectIdentifierToken(lex('_123')[0], 0, 4, '_123');\n+        expectIdentifierToken(lex('_123_')[0], 0, 5, '_123_');\n+        expectIdentifierToken(lex('_1_2_3_')[0], 0, 7, '_1_2_3_');\n+      });\n+\n+      it('should throw error for invalid number separators', () => {\n+        expectErrorToken(\n+            lex('123_')[0], 3, 3,\n+            'Lexer Error: Invalid numeric separator at column 3 in expression [123_]');\n+        expectErrorToken(\n+            lex('12__3')[0], 2, 2,\n+            'Lexer Error: Invalid numeric separator at column 2 in expression [12__3]');\n+        expectErrorToken(\n+            lex('1_2_3_.456')[0], 5, 5,\n+            'Lexer Error: Invalid numeric separator at column 5 in expression [1_2_3_.456]');\n+        expectErrorToken(\n+            lex('1_2_3._456')[0], 6, 6,\n+            'Lexer Error: Invalid numeric separator at column 6 in expression [1_2_3._456]');\n+      });\n     });\n   });\n }"
        },
        {
            "sha": "93bf1405d882d23483aabd25e89252d7e992c31d",
            "filename": "packages/core/test/acceptance/integration_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9f5cc7c808458f312543c7c044fe7a361cdc7798/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts?ref=9f5cc7c808458f312543c7c044fe7a361cdc7798",
            "patch": "@@ -2061,6 +2061,19 @@ describe('acceptance integration tests', () => {\n     expect(fixture.componentInstance.directive.value).toEqual({a: 1, b: 2, someProp: 3});\n   });\n \n+  it('should handle numeric separators in templates', () => {\n+    @Component({template: 'Balance: ${{ 1_000_000 * multiplier }}'})\n+    class App {\n+      multiplier = 5;\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [App]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+\n+    expect(fixture.nativeElement.textContent).toBe('Balance: $5000000');\n+  });\n+\n   describe('tView.firstUpdatePass', () => {\n     function isFirstUpdatePass() {\n       const lView = getLView();"
        }
    ],
    "stats": {
        "total": 156,
        "additions": 152,
        "deletions": 4
    }
}