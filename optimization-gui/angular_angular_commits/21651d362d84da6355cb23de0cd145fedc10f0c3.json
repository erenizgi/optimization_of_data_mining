{
    "author": "atscott",
    "message": "refactor(compiler-cli): add keySpan to text attributes (#39613)\n\nSimilar to #39609 and #38898, though we currently have the knowledge of where the key for an\nattribute appears during parsing, we do not propagate this\ninformation to the output AST. This means that once we produce the\ntemplate AST, we have no way of mapping a template position to the key\nspan alone. The best we can currently do is map back to the\nsourceSpan. This presents problems downstream, specifically for the\nlanguage service, where we cannot provide correct information about a\nposition in a template because the AST is not granular enough.\n\nPR Close #39613",
    "sha": "21651d362d84da6355cb23de0cd145fedc10f0c3",
    "files": [
        {
            "sha": "b0da1c372bb9d34c9eac8b5a2fac838af897eef4",
            "filename": "packages/compiler/src/i18n/extractor_merger.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Fi18n%2Fextractor_merger.ts",
            "raw_url": "https://github.com/angular/angular/raw/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Fi18n%2Fextractor_merger.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fextractor_merger.ts?ref=21651d362d84da6355cb23de0cd145fedc10f0c3",
            "patch": "@@ -394,10 +394,14 @@ class _Visitor implements html.Visitor {\n         const nodes = this._translations.get(message);\n         if (nodes) {\n           if (nodes.length == 0) {\n-            translatedAttributes.push(new html.Attribute(attr.name, '', attr.sourceSpan));\n+            translatedAttributes.push(new html.Attribute(\n+                attr.name, '', attr.sourceSpan, undefined /* keySpan */, undefined /* valueSpan */,\n+                undefined /* i18n */));\n           } else if (nodes[0] instanceof html.Text) {\n             const value = (nodes[0] as html.Text).value;\n-            translatedAttributes.push(new html.Attribute(attr.name, value, attr.sourceSpan));\n+            translatedAttributes.push(new html.Attribute(\n+                attr.name, value, attr.sourceSpan, undefined /* keySpan */,\n+                undefined /* valueSpan */, undefined /* i18n */));\n           } else {\n             this._reportError(\n                 el,"
        },
        {
            "sha": "c962e04a9d7fbd6623f857633a9cbe8e7dbbcbe8",
            "filename": "packages/compiler/src/ml_parser/ast.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fast.ts",
            "raw_url": "https://github.com/angular/angular/raw/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fast.ts?ref=21651d362d84da6355cb23de0cd145fedc10f0c3",
            "patch": "@@ -53,7 +53,8 @@ export class ExpansionCase implements Node {\n export class Attribute extends NodeWithI18n {\n   constructor(\n       public name: string, public value: string, sourceSpan: ParseSourceSpan,\n-      public valueSpan?: ParseSourceSpan, i18n?: I18nMeta) {\n+      readonly keySpan: ParseSourceSpan|undefined, public valueSpan?: ParseSourceSpan,\n+      i18n?: I18nMeta) {\n     super(sourceSpan, i18n);\n   }\n   visit(visitor: Visitor, context: any): any {"
        },
        {
            "sha": "9e08c954ddea6387697898fb46324d1395593ab1",
            "filename": "packages/compiler/src/ml_parser/icu_ast_expander.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Fml_parser%2Ficu_ast_expander.ts",
            "raw_url": "https://github.com/angular/angular/raw/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Fml_parser%2Ficu_ast_expander.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Ficu_ast_expander.ts?ref=21651d362d84da6355cb23de0cd145fedc10f0c3",
            "patch": "@@ -102,10 +102,14 @@ function _expandPluralForm(ast: html.Expansion, errors: ParseError[]): html.Elem\n     errors.push(...expansionResult.errors);\n \n     return new html.Element(\n-        `ng-template`, [new html.Attribute('ngPluralCase', `${c.value}`, c.valueSourceSpan)],\n+        `ng-template`, [new html.Attribute(\n+                           'ngPluralCase', `${c.value}`, c.valueSourceSpan, undefined /* keySpan */,\n+                           undefined /* valueSpan */, undefined /* i18n */)],\n         expansionResult.nodes, c.sourceSpan, c.sourceSpan, c.sourceSpan);\n   });\n-  const switchAttr = new html.Attribute('[ngPlural]', ast.switchValue, ast.switchValueSourceSpan);\n+  const switchAttr = new html.Attribute(\n+      '[ngPlural]', ast.switchValue, ast.switchValueSourceSpan, undefined /* keySpan */,\n+      undefined /* valueSpan */, undefined /* i18n */);\n   return new html.Element(\n       'ng-container', [switchAttr], children, ast.sourceSpan, ast.sourceSpan, ast.sourceSpan);\n }\n@@ -119,15 +123,21 @@ function _expandDefaultForm(ast: html.Expansion, errors: ParseError[]): html.Ele\n     if (c.value === 'other') {\n       // other is the default case when no values match\n       return new html.Element(\n-          `ng-template`, [new html.Attribute('ngSwitchDefault', '', c.valueSourceSpan)],\n+          `ng-template`, [new html.Attribute(\n+                             'ngSwitchDefault', '', c.valueSourceSpan, undefined /* keySpan */,\n+                             undefined /* valueSpan */, undefined /* i18n */)],\n           expansionResult.nodes, c.sourceSpan, c.sourceSpan, c.sourceSpan);\n     }\n \n     return new html.Element(\n-        `ng-template`, [new html.Attribute('ngSwitchCase', `${c.value}`, c.valueSourceSpan)],\n+        `ng-template`, [new html.Attribute(\n+                           'ngSwitchCase', `${c.value}`, c.valueSourceSpan, undefined /* keySpan */,\n+                           undefined /* valueSpan */, undefined /* i18n */)],\n         expansionResult.nodes, c.sourceSpan, c.sourceSpan, c.sourceSpan);\n   });\n-  const switchAttr = new html.Attribute('[ngSwitch]', ast.switchValue, ast.switchValueSourceSpan);\n+  const switchAttr = new html.Attribute(\n+      '[ngSwitch]', ast.switchValue, ast.switchValueSourceSpan, undefined /* keySpan */,\n+      undefined /* valueSpan */, undefined /* i18n */);\n   return new html.Element(\n       'ng-container', [switchAttr], children, ast.sourceSpan, ast.sourceSpan, ast.sourceSpan);\n }"
        },
        {
            "sha": "df73b9b6ac7f48c44db9112eb7ed1cfe618be083",
            "filename": "packages/compiler/src/ml_parser/parser.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fparser.ts?ref=21651d362d84da6355cb23de0cd145fedc10f0c3",
            "patch": "@@ -351,9 +351,10 @@ class _TreeBuilder {\n       const quoteToken = this._advance();\n       end = quoteToken.sourceSpan.end;\n     }\n+    const keySpan = new ParseSourceSpan(attrName.sourceSpan.start, attrName.sourceSpan.end);\n     return new html.Attribute(\n         fullName, value,\n-        new ParseSourceSpan(attrName.sourceSpan.start, end, attrName.sourceSpan.fullStart),\n+        new ParseSourceSpan(attrName.sourceSpan.start, end, attrName.sourceSpan.fullStart), keySpan,\n         valueSpan);\n   }\n "
        },
        {
            "sha": "0d408651bb38d5c936e5f8de41da1e6ddd6b1819",
            "filename": "packages/compiler/src/render3/r3_ast.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts?ref=21651d362d84da6355cb23de0cd145fedc10f0c3",
            "patch": "@@ -30,10 +30,17 @@ export class BoundText implements Node {\n   }\n }\n \n+/**\n+ * Represents a text attribute in the template.\n+ *\n+ * `valueSpan` may not be present in cases where there is no value `<div a></div>`.\n+ * `keySpan` may also not be present for synthetic attributes from ICU expansions.\n+ */\n export class TextAttribute implements Node {\n   constructor(\n       public name: string, public value: string, public sourceSpan: ParseSourceSpan,\n-      public valueSpan?: ParseSourceSpan, public i18n?: I18nMeta) {}\n+      readonly keySpan: ParseSourceSpan|undefined, public valueSpan?: ParseSourceSpan,\n+      public i18n?: I18nMeta) {}\n   visit<Result>(visitor: Visitor<Result>): Result {\n     return visitor.visitTextAttribute(this);\n   }"
        },
        {
            "sha": "a30a3c67d34a00c56de11a537286e64f1956547b",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=21651d362d84da6355cb23de0cd145fedc10f0c3",
            "patch": "@@ -166,7 +166,7 @@ class HtmlAstToIvyAst implements html.Visitor {\n \n       if (!hasBinding && !isTemplateBinding) {\n         // don't include the bindings as attributes as well in the AST\n-        attributes.push(this.visitAttribute(attribute) as t.TextAttribute);\n+        attributes.push(this.visitAttribute(attribute));\n       }\n     }\n \n@@ -238,7 +238,8 @@ class HtmlAstToIvyAst implements html.Visitor {\n \n   visitAttribute(attribute: html.Attribute): t.TextAttribute {\n     return new t.TextAttribute(\n-        attribute.name, attribute.value, attribute.sourceSpan, attribute.valueSpan, attribute.i18n);\n+        attribute.name, attribute.value, attribute.sourceSpan, attribute.keySpan,\n+        attribute.valueSpan, attribute.i18n);\n   }\n \n   visitText(text: html.Text): t.Node {\n@@ -301,7 +302,8 @@ class HtmlAstToIvyAst implements html.Visitor {\n       const i18n = i18nPropsMeta[prop.name];\n       if (prop.isLiteral) {\n         literal.push(new t.TextAttribute(\n-            prop.name, prop.expression.source || '', prop.sourceSpan, undefined, i18n));\n+            prop.name, prop.expression.source || '', prop.sourceSpan, prop.keySpan, prop.valueSpan,\n+            i18n));\n       } else {\n         // Note that validation is skipped and property mapping is disabled\n         // due to the fact that we need to make sure a given prop is not an\n@@ -501,7 +503,8 @@ class NonBindableVisitor implements html.Visitor {\n \n   visitAttribute(attribute: html.Attribute): t.TextAttribute {\n     return new t.TextAttribute(\n-        attribute.name, attribute.value, attribute.sourceSpan, undefined, attribute.i18n);\n+        attribute.name, attribute.value, attribute.sourceSpan, attribute.keySpan,\n+        attribute.valueSpan, attribute.i18n);\n   }\n \n   visitText(text: html.Text): t.Text {"
        },
        {
            "sha": "e7e34c07ff2f37e5321a6ad6c9c43b72340235ad",
            "filename": "packages/compiler/test/render3/r3_ast_spans_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts?ref=21651d362d84da6355cb23de0cd145fedc10f0c3",
            "patch": "@@ -64,8 +64,10 @@ class R3AstSourceSpans implements t.Visitor<void> {\n   }\n \n   visitTextAttribute(attribute: t.TextAttribute) {\n-    this.result.push(\n-        ['TextAttribute', humanizeSpan(attribute.sourceSpan), humanizeSpan(attribute.valueSpan)]);\n+    this.result.push([\n+      'TextAttribute', humanizeSpan(attribute.sourceSpan), humanizeSpan(attribute.keySpan),\n+      humanizeSpan(attribute.valueSpan)\n+    ]);\n   }\n \n   visitBoundAttribute(attribute: t.BoundAttribute) {\n@@ -132,14 +134,14 @@ describe('R3 AST source spans', () => {\n     it('is correct for elements with attributes', () => {\n       expectFromHtml('<div a=\"b\"></div>').toEqual([\n         ['Element', '<div a=\"b\"></div>', '<div a=\"b\">', '</div>'],\n-        ['TextAttribute', 'a=\"b\"', 'b'],\n+        ['TextAttribute', 'a=\"b\"', 'a', 'b'],\n       ]);\n     });\n \n     it('is correct for elements with attributes without value', () => {\n       expectFromHtml('<div a></div>').toEqual([\n         ['Element', '<div a></div>', '<div a>', '</div>'],\n-        ['TextAttribute', 'a', '<empty>'],\n+        ['TextAttribute', 'a', 'a', '<empty>'],\n       ]);\n     });\n   });\n@@ -193,7 +195,7 @@ describe('R3 AST source spans', () => {\n     it('is correct for * directives', () => {\n       expectFromHtml('<div *ngIf></div>').toEqual([\n         ['Template', '<div *ngIf></div>', '<div *ngIf>', '</div>'],\n-        ['TextAttribute', 'ngIf', '<empty>'],\n+        ['TextAttribute', 'ngIf', 'ngIf', '<empty>'],\n         ['Element', '<div *ngIf></div>', '<div *ngIf>', '</div>'],\n       ]);\n     });\n@@ -263,7 +265,7 @@ describe('R3 AST source spans', () => {\n           'Template', '<ng-template k1=\"v1\"></ng-template>', '<ng-template k1=\"v1\">',\n           '</ng-template>'\n         ],\n-        ['TextAttribute', 'k1=\"v1\"', 'v1'],\n+        ['TextAttribute', 'k1=\"v1\"', 'k1', 'v1'],\n       ]);\n     });\n \n@@ -290,7 +292,7 @@ describe('R3 AST source spans', () => {\n           'Template', '<div *ngFor=\"let item of items\"></div>', '<div *ngFor=\"let item of items\">',\n           '</div>'\n         ],\n-        ['TextAttribute', 'ngFor', '<empty>'],\n+        ['TextAttribute', 'ngFor', 'ngFor', '<empty>'],\n         ['BoundAttribute', 'of items', 'of', 'items'],\n         ['Variable', 'let item ', 'item', '<empty>'],\n         [\n@@ -319,7 +321,7 @@ describe('R3 AST source spans', () => {\n           'Template', '<div *ngFor=\"let item of items; trackBy: trackByFn\"></div>',\n           '<div *ngFor=\"let item of items; trackBy: trackByFn\">', '</div>'\n         ],\n-        ['TextAttribute', 'ngFor', '<empty>'],\n+        ['TextAttribute', 'ngFor', 'ngFor', '<empty>'],\n         ['BoundAttribute', 'of items; ', 'of', 'items'],\n         ['BoundAttribute', 'trackBy: trackByFn', 'trackBy', 'trackByFn'],\n         ['Variable', 'let item ', 'item', '<empty>'],\n@@ -334,7 +336,7 @@ describe('R3 AST source spans', () => {\n     it('is correct for variables via let ...', () => {\n       expectFromHtml('<div *ngIf=\"let a=b\"></div>').toEqual([\n         ['Template', '<div *ngIf=\"let a=b\"></div>', '<div *ngIf=\"let a=b\">', '</div>'],\n-        ['TextAttribute', 'ngIf', '<empty>'],\n+        ['TextAttribute', 'ngIf', 'ngIf', '<empty>'],\n         ['Variable', 'let a=b', 'a', 'b'],\n         ['Element', '<div *ngIf=\"let a=b\"></div>', '<div *ngIf=\"let a=b\">', '</div>'],\n       ]);"
        },
        {
            "sha": "50f0dc59ed106f4b81baabbe7ef69f9238e8fa24",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=21651d362d84da6355cb23de0cd145fedc10f0c3",
            "patch": "@@ -135,7 +135,7 @@ describe('definitions', () => {\n       it('should work for text inputs', () => {\n         const definitions = getDefinitionsAndAssertBoundSpan({\n           templateOverride: `<test-comp tcN¦ame=\"name\"></test-comp>`,\n-          expectedSpanText: 'tcName=\"name\"',\n+          expectedSpanText: 'tcName',\n         });\n         expect(definitions!.length).toEqual(1);\n "
        },
        {
            "sha": "75963e389ea793de0d2738c365cc496a54a821ce",
            "filename": "packages/language-service/ivy/test/quick_info_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/21651d362d84da6355cb23de0cd145fedc10f0c3/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts?ref=21651d362d84da6355cb23de0cd145fedc10f0c3",
            "patch": "@@ -295,7 +295,7 @@ describe('quick info', () => {\n     it('should find input binding on text attribute', () => {\n       expectQuickInfo({\n         templateOverride: `<test-comp tcN¦ame=\"title\"></test-comp>`,\n-        expectedSpanText: 'tcName=\"title\"',\n+        expectedSpanText: 'tcName',\n         expectedDisplayString: '(property) TestComponent.name: string'\n       });\n     });"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 53,
        "deletions": 25
    }
}