{
    "author": "crisbeto",
    "message": "fix(forms): error if control is removed as a result of another one being reset (#40462)\n\nWhen a form is reset, it goes through `_forEachChild` to call `reset` on each of its children.\nThe problem is that if a control is removed while the loop is running (e.g. by a subscription),\nthe form will throw an error, because it built up the list of available control before the loop\nstarted.\n\nThese changes fix the issue by adding a null check before invoing the callback.\n\nFixes #33401.\n\nPR Close #40462",
    "sha": "1d1304c70c2f968068f15bd156b611e6e88b7e4a",
    "files": [
        {
            "sha": "d6392dcb94270bbe20ddfa8820f9d1d2f8621f12",
            "filename": "packages/forms/src/model.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/1d1304c70c2f968068f15bd156b611e6e88b7e4a/packages%2Fforms%2Fsrc%2Fmodel.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d1304c70c2f968068f15bd156b611e6e88b7e4a/packages%2Fforms%2Fsrc%2Fmodel.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fmodel.ts?ref=1d1304c70c2f968068f15bd156b611e6e88b7e4a",
            "patch": "@@ -1690,7 +1690,13 @@ export class FormGroup extends AbstractControl {\n \n   /** @internal */\n   _forEachChild(cb: (v: any, k: string) => void): void {\n-    Object.keys(this.controls).forEach(k => cb(this.controls[k], k));\n+    Object.keys(this.controls).forEach(key => {\n+      // The list of controls can change (for ex. controls might be removed) while the loop\n+      // is running (as a result of invoking Forms API in `valueChanges` subscription), so we\n+      // have to null check before invoking the callback.\n+      const control = this.controls[key];\n+      control && cb(control, key);\n+    });\n   }\n \n   /** @internal */"
        },
        {
            "sha": "379ef229b9fe032fee9809780acec5a9bb8ce52d",
            "filename": "packages/forms/test/reactive_integration_spec.ts",
            "status": "modified",
            "additions": 45,
            "deletions": 3,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/1d1304c70c2f968068f15bd156b611e6e88b7e4a/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d1304c70c2f968068f15bd156b611e6e88b7e4a/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts?ref=1d1304c70c2f968068f15bd156b611e6e88b7e4a",
            "patch": "@@ -7,13 +7,13 @@\n  */\n \n import {ÉµgetDOM as getDOM} from '@angular/common';\n-import {Component, Directive, forwardRef, Input, Type} from '@angular/core';\n+import {Component, Directive, forwardRef, Input, OnDestroy, Type} from '@angular/core';\n import {ComponentFixture, fakeAsync, TestBed, tick} from '@angular/core/testing';\n import {expect} from '@angular/core/testing/src/testing_internal';\n import {AbstractControl, AsyncValidator, AsyncValidatorFn, COMPOSITION_BUFFER_MODE, ControlValueAccessor, DefaultValueAccessor, FormArray, FormControl, FormControlDirective, FormControlName, FormGroup, FormGroupDirective, FormsModule, NG_ASYNC_VALIDATORS, NG_VALIDATORS, NG_VALUE_ACCESSOR, ReactiveFormsModule, Validator, Validators} from '@angular/forms';\n import {By} from '@angular/platform-browser/src/dom/debug/by';\n import {dispatchEvent, sortedClassList} from '@angular/platform-browser/testing/src/browser_util';\n-import {merge, NEVER, of, timer} from 'rxjs';\n+import {merge, NEVER, of, Subscription, timer} from 'rxjs';\n import {map, tap} from 'rxjs/operators';\n \n import {MyInput, MyInputForm} from './value_accessor_integration_spec';\n@@ -1129,6 +1129,48 @@ const ValueAccessorB = createControlValueAccessor('[cva-b]');\n           expect(control.dirty).toBe(false, 'Expected pending dirty value to reset.');\n         });\n \n+        it('should be able to remove a control as a result of another control being reset', () => {\n+          @Component({\n+            template: `\n+              <form [formGroup]=\"form\">\n+                <input formControlName=\"name\">\n+                <input formControlName=\"surname\">\n+              </form>\n+            `\n+          })\n+          class App implements OnDestroy {\n+            private _subscription: Subscription;\n+\n+            form = new FormGroup({\n+              name: new FormControl('Frodo'),\n+              surname: new FormControl('Baggins'),\n+            });\n+\n+            constructor() {\n+              this._subscription = this.form.controls.name.valueChanges.subscribe(value => {\n+                if (!value) {\n+                  this.form.removeControl('surname');\n+                }\n+              });\n+            }\n+\n+            ngOnDestroy() {\n+              this._subscription.unsubscribe();\n+            }\n+          }\n+\n+          const fixture = initTest(App);\n+          fixture.detectChanges();\n+          expect(fixture.componentInstance.form.value).toEqual({name: 'Frodo', surname: 'Baggins'});\n+\n+          expect(() => {\n+            fixture.componentInstance.form.reset();\n+            fixture.detectChanges();\n+          }).not.toThrow();\n+\n+          expect(fixture.componentInstance.form.value).toEqual({name: null});\n+        });\n+\n         it('should not emit valueChanges or statusChanges until blur', () => {\n           const fixture = initTest(FormControlComp);\n           const control = new FormControl('', {validators: Validators.required, updateOn: 'blur'});\n@@ -4392,4 +4434,4 @@ class MultipleFormControls {\n class NgForFormControlWithValidators {\n   form = new FormGroup({login: new FormControl('a')});\n   logins = ['a', 'b', 'c'];\n-}\n\\ No newline at end of file\n+}"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 52,
        "deletions": 4
    }
}