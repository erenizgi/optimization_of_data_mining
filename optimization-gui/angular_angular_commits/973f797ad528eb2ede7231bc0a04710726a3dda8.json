{
    "author": "atscott",
    "message": "feat(language-service): enable get references for directive and component from template (#40054)\n\nThis commit adds the ability to find references for a directive or component\nfrom within a component template. That is, you can find component references\nfrom the element tag `<my-c|omp></my-comp>` (where `|` is the cursor position)\nas well as find references for directives that match a given attribute\n`<div d|ir></div>`.\n\nPR Close #40054",
    "sha": "973f797ad528eb2ede7231bc0a04710726a3dda8",
    "files": [
        {
            "sha": "934b693ece2dc13bc14a7d1a384916da64882974",
            "filename": "packages/language-service/.build.sh.swp",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/angular/angular/blob/973f797ad528eb2ede7231bc0a04710726a3dda8/packages%2Flanguage-service%2F.build.sh.swp",
            "raw_url": "https://github.com/angular/angular/raw/973f797ad528eb2ede7231bc0a04710726a3dda8/packages%2Flanguage-service%2F.build.sh.swp",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2F.build.sh.swp?ref=973f797ad528eb2ede7231bc0a04710726a3dda8"
        },
        {
            "sha": "cf72980e1716e4f53f579690ec937f8d2ab2c3d0",
            "filename": "packages/language-service/ivy/references.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 11,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/973f797ad528eb2ede7231bc0a04710726a3dda8/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "raw_url": "https://github.com/angular/angular/raw/973f797ad528eb2ede7231bc0a04710726a3dda8/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences.ts?ref=973f797ad528eb2ede7231bc0a04710726a3dda8",
            "patch": "@@ -5,14 +5,14 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {TmplAstVariable} from '@angular/compiler';\n+import {TmplAstBoundAttribute, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n-import {SymbolKind, TemplateTypeChecker, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import {DirectiveSymbol, SymbolKind, TemplateTypeChecker, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript';\n \n import {getTargetAtPosition} from './template_target';\n-import {getTemplateInfoAtPosition, isWithin, TemplateInfo, toTextSpan} from './utils';\n+import {getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getTemplateInfoAtPosition, isWithin, TemplateInfo, toTextSpan} from './utils';\n \n export class ReferenceBuilder {\n   private readonly ttc = this.compiler.getTemplateTypeChecker();\n@@ -43,19 +43,27 @@ export class ReferenceBuilder {\n       return undefined;\n     }\n     switch (symbol.kind) {\n-      case SymbolKind.Element:\n       case SymbolKind.Directive:\n       case SymbolKind.Template:\n-      case SymbolKind.DomBinding:\n         // References to elements, templates, and directives will be through template references\n         // (#ref). They shouldn't be used directly for a Language Service reference request.\n-        //\n-        // Dom bindings aren't currently type-checked (see `checkTypeOfDomBindings`) so they don't\n-        // have a shim location and so we cannot find references for them.\n-        //\n-        // TODO(atscott): Consider finding references for elements that are components as well as\n-        // when the position is on an element attribute that directly maps to a directive.\n         return undefined;\n+      case SymbolKind.Element: {\n+        const matches = getDirectiveMatchesForElementTag(symbol.templateNode, symbol.directives);\n+        return this.getReferencesForDirectives(matches);\n+      }\n+      case SymbolKind.DomBinding: {\n+        // Dom bindings aren't currently type-checked (see `checkTypeOfDomBindings`) so they don't\n+        // have a shim location. This means we can't match dom bindings to their lib.dom reference,\n+        // but we can still see if they match to a directive.\n+        if (!(positionDetails.node instanceof TmplAstTextAttribute) &&\n+            !(positionDetails.node instanceof TmplAstBoundAttribute)) {\n+          return undefined;\n+        }\n+        const directives = getDirectiveMatchesForAttribute(\n+            positionDetails.node.name, symbol.host.templateNode, symbol.host.directives);\n+        return this.getReferencesForDirectives(directives);\n+      }\n       case SymbolKind.Reference: {\n         const {shimPath, positionInShimFile} = symbol.referenceVarLocation;\n         return this.getReferencesAtTypescriptPosition(shimPath, positionInShimFile);\n@@ -94,6 +102,27 @@ export class ReferenceBuilder {\n     }\n   }\n \n+  private getReferencesForDirectives(directives: Set<DirectiveSymbol>):\n+      ts.ReferenceEntry[]|undefined {\n+    const allDirectiveRefs: ts.ReferenceEntry[] = [];\n+    for (const dir of directives.values()) {\n+      const dirClass = dir.tsSymbol.valueDeclaration;\n+      if (dirClass === undefined || !ts.isClassDeclaration(dirClass) ||\n+          dirClass.name === undefined) {\n+        continue;\n+      }\n+\n+      const dirFile = dirClass.getSourceFile().fileName;\n+      const dirPosition = dirClass.name.getStart();\n+      const directiveRefs = this.getReferencesAtTypescriptPosition(dirFile, dirPosition);\n+      if (directiveRefs !== undefined) {\n+        allDirectiveRefs.push(...directiveRefs);\n+      }\n+    }\n+\n+    return allDirectiveRefs.length > 0 ? allDirectiveRefs : undefined;\n+  }\n+\n   private getReferencesAtTypescriptPosition(fileName: string, position: number):\n       ts.ReferenceEntry[]|undefined {\n     const refs = this.tsLS.getReferencesAtPosition(fileName, position);"
        },
        {
            "sha": "ecc56b1e4c66f10fee9b2bf8f53627d3acc49f1b",
            "filename": "packages/language-service/ivy/test/references_spec.ts",
            "status": "modified",
            "additions": 94,
            "deletions": 0,
            "changes": 94,
            "blob_url": "https://github.com/angular/angular/blob/973f797ad528eb2ede7231bc0a04710726a3dda8/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/973f797ad528eb2ede7231bc0a04710726a3dda8/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts?ref=973f797ad528eb2ede7231bc0a04710726a3dda8",
            "patch": "@@ -679,6 +679,100 @@ describe('find references', () => {\n       assertTextSpans(refs, ['<div dir>', 'Dir']);\n       assertFileNames(refs, ['app.ts', 'dir.ts']);\n     });\n+\n+    it('gets references to all matching directives when cursor is on an attribute', () => {\n+      const dirFile = `\n+      import {Directive} from '@angular/core';\n+\n+      @Directive({selector: '[dir]'})\n+      export class Dir {}`;\n+      const dirFile2 = `\n+      import {Directive} from '@angular/core';\n+\n+      @Directive({selector: '[dir]'})\n+      export class Dir2 {}`;\n+      const {text, cursor} = extractCursorInfo(`\n+        import {Component, NgModule} from '@angular/core';\n+        import {Dir} from './dir';\n+        import {Dir2} from './dir2';\n+\n+        @Component({template: '<div di¦r></div>'})\n+        export class AppCmp {\n+        }\n+\n+        @NgModule({declarations: [AppCmp, Dir, Dir2]})\n+        export class AppModule {}\n+      `);\n+      env = LanguageServiceTestEnvironment.setup([\n+        {name: _('/app.ts'), contents: text, isRoot: true},\n+        {name: _('/dir.ts'), contents: dirFile},\n+        {name: _('/dir2.ts'), contents: dirFile2},\n+      ]);\n+      const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+      expect(refs.length).toBe(8);\n+      assertTextSpans(refs, ['<div dir>', 'Dir', 'Dir2']);\n+      assertFileNames(refs, ['app.ts', 'dir.ts', 'dir2.ts']);\n+    });\n+  });\n+\n+  describe('components', () => {\n+    it('works for component classes', () => {\n+      const {text, cursor} = extractCursorInfo(`\n+      import {Component} from '@angular/core';\n+\n+      @Component({selector: 'my-comp', template: ''})\n+      export class MyCo¦mp {}`);\n+      const appFile = `\n+        import {Component, NgModule} from '@angular/core';\n+        import {MyComp} from './comp';\n+\n+        @Component({template: '<my-comp></my-comp>'})\n+        export class AppCmp {\n+        }\n+\n+        @NgModule({declarations: [AppCmp, MyComp]})\n+        export class AppModule {}\n+      `;\n+      env = LanguageServiceTestEnvironment.setup([\n+        {name: _('/app.ts'), contents: appFile, isRoot: true},\n+        {name: _('/comp.ts'), contents: text},\n+      ]);\n+      const refs = getReferencesAtPosition(_('/comp.ts'), cursor)!;\n+      // 4 references are:  class declaration, template usage, app import and use in declarations\n+      // list.\n+      expect(refs.length).toBe(4);\n+      assertTextSpans(refs, ['<my-comp>', 'MyComp']);\n+      assertFileNames(refs, ['app.ts', 'comp.ts']);\n+    });\n+\n+    it('gets works when cursor is on element tag', () => {\n+      const compFile = `\n+      import {Component} from '@angular/core';\n+\n+      @Component({selector: 'my-comp', template: ''})\n+      export class MyComp {}`;\n+      const {text, cursor} = extractCursorInfo(`\n+        import {Component, NgModule} from '@angular/core';\n+        import {MyComp} from './comp';\n+\n+        @Component({template: '<my-c¦omp></my-comp>'})\n+        export class AppCmp {\n+        }\n+\n+        @NgModule({declarations: [AppCmp, MyComp]})\n+        export class AppModule {}\n+      `);\n+      env = LanguageServiceTestEnvironment.setup([\n+        {name: _('/app.ts'), contents: text, isRoot: true},\n+        {name: _('/comp.ts'), contents: compFile},\n+      ]);\n+      const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+      // 4 references are:  class declaration, template usage, app import and use in declarations\n+      // list.\n+      expect(refs.length).toBe(4);\n+      assertTextSpans(refs, ['<my-comp>', 'MyComp']);\n+      assertFileNames(refs, ['app.ts', 'comp.ts']);\n+    });\n   });\n \n   function getReferencesAtPosition(fileName: string, position: number) {"
        }
    ],
    "stats": {
        "total": 145,
        "additions": 134,
        "deletions": 11
    }
}