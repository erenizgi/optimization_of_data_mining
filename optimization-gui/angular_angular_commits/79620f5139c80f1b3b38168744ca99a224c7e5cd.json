{
    "author": "petebacondarwin",
    "message": "refactor(localize): avoid free-standing `FileSystem` functions (#39006)\n\nThese free standing functions rely upon the \"current\" `FileSystem`,\nbut it is safer to explicitly pass the `FileSystem` into functions or\nclasses that need it.\n\nFixes #38711\n\nPR Close #39006",
    "sha": "79620f5139c80f1b3b38168744ca99a224c7e5cd",
    "files": [
        {
            "sha": "ae1644e31a5a6eef8fbe72abbbccec37e46b8d63",
            "filename": "packages/localize/src/tools/src/extract/extraction.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fextraction.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fextraction.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fextraction.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -52,8 +52,8 @@ export class MessageExtractor {\n         sourceRoot: this.basePath,\n         filename,\n         plugins: [\n-          makeEs2015ExtractPlugin(messages, this.localizeName),\n-          makeEs5ExtractPlugin(messages, this.localizeName),\n+          makeEs2015ExtractPlugin(this.fs, messages, this.localizeName),\n+          makeEs5ExtractPlugin(this.fs, messages, this.localizeName),\n         ],\n         code: false,\n         ast: false"
        },
        {
            "sha": "899a994a42ce7ba1e4ce9549fb20b19ddfb863c7",
            "filename": "packages/localize/src/tools/src/extract/main.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 10,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -6,13 +6,13 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {getFileSystem, setFileSystem, NodeJSFileSystem, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {setFileSystem, NodeJSFileSystem, AbsoluteFsPath, FileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ConsoleLogger, Logger, LogLevel} from '@angular/compiler-cli/src/ngtsc/logging';\n import {ɵParsedMessage} from '@angular/localize';\n import * as glob from 'glob';\n import * as yargs from 'yargs';\n \n-import {DiagnosticHandlingStrategy, Diagnostics} from '../diagnostics';\n+import {DiagnosticHandlingStrategy} from '../diagnostics';\n \n import {checkDuplicateMessages} from './duplicates';\n import {MessageExtractor} from './extraction';\n@@ -97,8 +97,8 @@ if (require.main === module) {\n           .help()\n           .parse(args);\n \n-  const fs = new NodeJSFileSystem();\n-  setFileSystem(fs);\n+  const fileSystem = new NodeJSFileSystem();\n+  setFileSystem(fileSystem);\n \n   const rootPath = options.r;\n   const sourceFilePaths = glob.sync(options.s, {cwd: rootPath, nodir: true});\n@@ -119,6 +119,7 @@ if (require.main === module) {\n     useLegacyIds: options.useLegacyIds,\n     duplicateMessageHandling,\n     formatOptions,\n+    fileSystem,\n   });\n }\n \n@@ -166,6 +167,10 @@ export interface ExtractTranslationsOptions {\n    * A collection of formatting options to pass to the translation file serializer.\n    */\n   formatOptions?: FormatOptions;\n+  /**\n+   * The file-system abstraction to use.\n+   */\n+  fileSystem: FileSystem;\n }\n \n export function extractTranslations({\n@@ -179,8 +184,8 @@ export function extractTranslations({\n   useLegacyIds,\n   duplicateMessageHandling,\n   formatOptions = {},\n+  fileSystem: fs,\n }: ExtractTranslationsOptions) {\n-  const fs = getFileSystem();\n   const basePath = fs.resolve(rootPath);\n   const extractor = new MessageExtractor(fs, logger, {basePath, useSourceMaps});\n \n@@ -196,7 +201,7 @@ export function extractTranslations({\n \n   const outputPath = fs.resolve(rootPath, output);\n   const serializer =\n-      getSerializer(format, sourceLocale, fs.dirname(outputPath), useLegacyIds, formatOptions);\n+      getSerializer(format, sourceLocale, fs.dirname(outputPath), useLegacyIds, formatOptions, fs);\n   const translationFile = serializer.serialize(messages);\n   fs.ensureDir(fs.dirname(outputPath));\n   fs.writeFile(outputPath, translationFile);\n@@ -208,18 +213,20 @@ export function extractTranslations({\n \n export function getSerializer(\n     format: string, sourceLocale: string, rootPath: AbsoluteFsPath, useLegacyIds: boolean,\n-    formatOptions: FormatOptions = {}): TranslationSerializer {\n+    formatOptions: FormatOptions = {}, fs: FileSystem): TranslationSerializer {\n   switch (format) {\n     case 'xlf':\n     case 'xlif':\n     case 'xliff':\n-      return new Xliff1TranslationSerializer(sourceLocale, rootPath, useLegacyIds, formatOptions);\n+      return new Xliff1TranslationSerializer(\n+          sourceLocale, rootPath, useLegacyIds, formatOptions, fs);\n     case 'xlf2':\n     case 'xlif2':\n     case 'xliff2':\n-      return new Xliff2TranslationSerializer(sourceLocale, rootPath, useLegacyIds, formatOptions);\n+      return new Xliff2TranslationSerializer(\n+          sourceLocale, rootPath, useLegacyIds, formatOptions, fs);\n     case 'xmb':\n-      return new XmbTranslationSerializer(rootPath, useLegacyIds);\n+      return new XmbTranslationSerializer(rootPath, useLegacyIds, fs);\n     case 'json':\n       return new SimpleJsonTranslationSerializer(sourceLocale);\n   }"
        },
        {
            "sha": "646a77b285a77008f0d36a5ee9a73c13c3fdd80b",
            "filename": "packages/localize/src/tools/src/extract/source_files/es2015_extract_plugin.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fsource_files%2Fes2015_extract_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fsource_files%2Fes2015_extract_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fsource_files%2Fes2015_extract_plugin.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,25 +5,26 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {FileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage, ɵparseMessage} from '@angular/localize';\n import {NodePath, PluginObj} from '@babel/core';\n import {TaggedTemplateExpression} from '@babel/types';\n \n import {getLocation, isGlobalIdentifier, isNamedIdentifier, unwrapExpressionsFromTemplateLiteral, unwrapMessagePartsFromTemplateLiteral} from '../../source_file_utils';\n \n export function makeEs2015ExtractPlugin(\n-    messages: ɵParsedMessage[], localizeName = '$localize'): PluginObj {\n+    fs: FileSystem, messages: ɵParsedMessage[], localizeName = '$localize'): PluginObj {\n   return {\n     visitor: {\n       TaggedTemplateExpression(path: NodePath<TaggedTemplateExpression>) {\n         const tag = path.get('tag');\n         if (isNamedIdentifier(tag, localizeName) && isGlobalIdentifier(tag)) {\n           const quasiPath = path.get('quasi');\n           const [messageParts, messagePartLocations] =\n-              unwrapMessagePartsFromTemplateLiteral(quasiPath.get('quasis'));\n+              unwrapMessagePartsFromTemplateLiteral(quasiPath.get('quasis'), fs);\n           const [expressions, expressionLocations] =\n-              unwrapExpressionsFromTemplateLiteral(quasiPath);\n-          const location = getLocation(quasiPath);\n+              unwrapExpressionsFromTemplateLiteral(quasiPath, fs);\n+          const location = getLocation(fs, quasiPath);\n           const message = ɵparseMessage(\n               messageParts, expressions, location, messagePartLocations, expressionLocations);\n           messages.push(message);"
        },
        {
            "sha": "fc83d4ca40400924133afe4a2594e2661fb6c6b7",
            "filename": "packages/localize/src/tools/src/extract/source_files/es5_extract_plugin.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fsource_files%2Fes5_extract_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fsource_files%2Fes5_extract_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fsource_files%2Fes5_extract_plugin.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,23 +5,26 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {FileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage, ɵparseMessage} from '@angular/localize';\n import {NodePath, PluginObj} from '@babel/core';\n import {CallExpression} from '@babel/types';\n \n import {getLocation, isGlobalIdentifier, isNamedIdentifier, unwrapMessagePartsFromLocalizeCall, unwrapSubstitutionsFromLocalizeCall} from '../../source_file_utils';\n \n export function makeEs5ExtractPlugin(\n-    messages: ɵParsedMessage[], localizeName = '$localize'): PluginObj {\n+    fs: FileSystem, messages: ɵParsedMessage[], localizeName = '$localize'): PluginObj {\n   return {\n     visitor: {\n       CallExpression(callPath: NodePath<CallExpression>) {\n         const calleePath = callPath.get('callee');\n         if (isNamedIdentifier(calleePath, localizeName) && isGlobalIdentifier(calleePath)) {\n-          const [messageParts, messagePartLocations] = unwrapMessagePartsFromLocalizeCall(callPath);\n-          const [expressions, expressionLocations] = unwrapSubstitutionsFromLocalizeCall(callPath);\n+          const [messageParts, messagePartLocations] =\n+              unwrapMessagePartsFromLocalizeCall(callPath, fs);\n+          const [expressions, expressionLocations] =\n+              unwrapSubstitutionsFromLocalizeCall(callPath, fs);\n           const [messagePartsArg, expressionsArg] = callPath.get('arguments');\n-          const location = getLocation(messagePartsArg, expressionsArg);\n+          const location = getLocation(fs, messagePartsArg, expressionsArg);\n           const message = ɵparseMessage(\n               messageParts, expressions, location, messagePartLocations, expressionLocations);\n           messages.push(message);"
        },
        {
            "sha": "363000a557e59aa231ab16371fa224f98a0be1a7",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff1_translation_serializer.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {AbsoluteFsPath, relative} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n import {FormatOptions, validateOptions} from './format_options';\n@@ -28,7 +28,7 @@ const LEGACY_XLIFF_MESSAGE_LENGTH = 40;\n export class Xliff1TranslationSerializer implements TranslationSerializer {\n   constructor(\n       private sourceLocale: string, private basePath: AbsoluteFsPath, private useLegacyIds: boolean,\n-      private formatOptions: FormatOptions = {}) {\n+      private formatOptions: FormatOptions = {}, private fs: FileSystem = getFileSystem()) {\n     validateOptions('Xliff1TranslationSerializer', [['xml:space', ['preserve']]], formatOptions);\n   }\n \n@@ -115,7 +115,7 @@ export class Xliff1TranslationSerializer implements TranslationSerializer {\n \n   private serializeLocation(xml: XmlFile, location: ɵSourceLocation): void {\n     xml.startTag('context-group', {purpose: 'location'});\n-    this.renderContext(xml, 'sourcefile', relative(this.basePath, location.file));\n+    this.renderContext(xml, 'sourcefile', this.fs.relative(this.basePath, location.file));\n     const endLineString = location.end !== undefined && location.end.line !== location.start.line ?\n         `,${location.end.line + 1}` :\n         '';"
        },
        {
            "sha": "177ea75e69f4c208b92f5ec3206e36f39643b7bf",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff2_translation_serializer.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {AbsoluteFsPath, relative} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n import {FormatOptions, validateOptions} from './format_options';\n@@ -28,7 +28,7 @@ export class Xliff2TranslationSerializer implements TranslationSerializer {\n   private currentPlaceholderId = 0;\n   constructor(\n       private sourceLocale: string, private basePath: AbsoluteFsPath, private useLegacyIds: boolean,\n-      private formatOptions: FormatOptions = {}) {\n+      private formatOptions: FormatOptions = {}, private fs: FileSystem = getFileSystem()) {\n     validateOptions('Xliff1TranslationSerializer', [['xml:space', ['preserve']]], formatOptions);\n   }\n \n@@ -64,7 +64,7 @@ export class Xliff2TranslationSerializer implements TranslationSerializer {\n               end !== undefined && end.line !== start.line ? `,${end.line + 1}` : '';\n           this.serializeNote(\n               xml, 'location',\n-              `${relative(this.basePath, file)}:${start.line + 1}${endLineString}`);\n+              `${this.fs.relative(this.basePath, file)}:${start.line + 1}${endLineString}`);\n         }\n         if (message.description) {\n           this.serializeNote(xml, 'description', message.description);"
        },
        {
            "sha": "04d2d6556c643a1265132700c9fe6641cdb0f700",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xmb_translation_serializer.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {AbsoluteFsPath, relative} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n import {extractIcuPlaceholders} from './icu_parsing';\n@@ -21,7 +21,9 @@ import {XmlFile} from './xml_file';\n  * @publicApi used by CLI\n  */\n export class XmbTranslationSerializer implements TranslationSerializer {\n-  constructor(private basePath: AbsoluteFsPath, private useLegacyIds: boolean) {}\n+  constructor(\n+      private basePath: AbsoluteFsPath, private useLegacyIds: boolean,\n+      private fs: FileSystem = getFileSystem()) {}\n \n   serialize(messages: ɵParsedMessage[]): string {\n     const ids = new Set<string>();\n@@ -74,7 +76,8 @@ export class XmbTranslationSerializer implements TranslationSerializer {\n     const endLineString = location.end !== undefined && location.end.line !== location.start.line ?\n         `,${location.end.line + 1}` :\n         '';\n-    xml.text(`${relative(this.basePath, location.file)}:${location.start.line}${endLineString}`);\n+    xml.text(\n+        `${this.fs.relative(this.basePath, location.file)}:${location.start.line}${endLineString}`);\n     xml.endTag('source');\n   }\n "
        },
        {
            "sha": "9ba2b85837d1217d69efa60868cf525e32ea1063",
            "filename": "packages/localize/src/tools/src/source_file_utils.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 15,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {AbsoluteFsPath, relative, resolve} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵisMissingTranslationError, ɵmakeTemplateObject, ɵParsedTranslation, ɵSourceLocation, ɵtranslate} from '@angular/localize';\n import {NodePath} from '@babel/traverse';\n import * as t from '@babel/types';\n@@ -68,10 +68,14 @@ export function buildLocalizeReplacement(\n  * to a helper function like `__makeTemplateObject`.\n  *\n  * @param call The AST node of the call to process.\n+ * @param fs The file system to use when computing source-map paths. If not provided then it uses\n+ *     the \"current\" FileSystem.\n  * @publicApi used by CLI\n  */\n-export function unwrapMessagePartsFromLocalizeCall(call: NodePath<t.CallExpression>):\n-    [TemplateStringsArray, (ɵSourceLocation | undefined)[]] {\n+export function unwrapMessagePartsFromLocalizeCall(\n+    call: NodePath<t.CallExpression>,\n+    fs: FileSystem = getFileSystem(),\n+    ): [TemplateStringsArray, (ɵSourceLocation | undefined)[]] {\n   let cooked = call.get('arguments')[0];\n \n   if (cooked === undefined) {\n@@ -141,16 +145,22 @@ export function unwrapMessagePartsFromLocalizeCall(call: NodePath<t.CallExpressi\n     raw = arg2 !== undefined ? arg2 : cooked;\n   }\n \n-  const [cookedStrings] = unwrapStringLiteralArray(cooked);\n-  const [rawStrings, rawLocations] = unwrapStringLiteralArray(raw);\n+  const [cookedStrings] = unwrapStringLiteralArray(cooked, fs);\n+  const [rawStrings, rawLocations] = unwrapStringLiteralArray(raw, fs);\n   return [ɵmakeTemplateObject(cookedStrings, rawStrings), rawLocations];\n }\n \n /**\n  * Parse the localize call expression to extract the arguments that hold the substition expressions.\n  *\n+ * @param call The AST node of the call to process.\n+ * @param fs The file system to use when computing source-map paths. If not provided then it uses\n+ *     the \"current\" FileSystem.\n  * @publicApi used by CLI\n  */\n+export function unwrapSubstitutionsFromLocalizeCall(\n+    call: NodePath<t.CallExpression>,\n+    fs: FileSystem = getFileSystem()): [t.Expression[], (ɵSourceLocation | undefined)[]] {\n   const expressions = call.get('arguments').splice(1);\n   if (!isArrayOfExpressions(expressions)) {\n     const badExpression = expressions.find(expression => !expression.isExpression())!;\n@@ -159,15 +169,21 @@ export function unwrapMessagePartsFromLocalizeCall(call: NodePath<t.CallExpressi\n         'Invalid substitutions for `$localize` (expected all substitution arguments to be expressions).');\n   }\n   return [\n-    expressions.map(path => path.node), expressions.map(expression => getLocation(expression))\n+    expressions.map(path => path.node), expressions.map(expression => getLocation(fs, expression))\n   ];\n }\n \n /**\n  * Parse the tagged template literal to extract the message parts.\n  *\n+ * @param elements The elements of the template literal to process.\n+ * @param fs The file system to use when computing source-map paths. If not provided then it uses\n+ *     the \"current\" FileSystem.\n  * @publicApi used by CLI\n  */\n+export function unwrapMessagePartsFromTemplateLiteral(\n+    elements: NodePath<t.TemplateElement>[],\n+    fs: FileSystem = getFileSystem()): [TemplateStringsArray, (ɵSourceLocation | undefined)[]] {\n   const cooked = elements.map(q => {\n     if (q.node.value.cooked === undefined) {\n       throw new BabelParseError(\n@@ -177,15 +193,22 @@ export function unwrapMessagePartsFromLocalizeCall(call: NodePath<t.CallExpressi\n     return q.node.value.cooked;\n   });\n   const raw = elements.map(q => q.node.value.raw);\n-  const locations = elements.map(q => getLocation(q));\n+  const locations = elements.map(q => getLocation(fs, q));\n   return [ɵmakeTemplateObject(cooked, raw), locations];\n }\n \n /**\n  * Parse the tagged template literal to extract the interpolation expressions.\n  *\n+ * @param quasi The AST node of the template literal to process.\n+ * @param fs The file system to use when computing source-map paths. If not provided then it uses\n+ *     the \"current\" FileSystem.\n  * @publicApi used by CLI\n  */\n+export function unwrapExpressionsFromTemplateLiteral(\n+    quasi: NodePath<t.TemplateLiteral>,\n+    fs: FileSystem = getFileSystem()): [t.Expression[], (ɵSourceLocation | undefined)[]] {\n+  return [quasi.node.expressions, quasi.get('expressions').map(e => getLocation(fs, e))];\n }\n \n /**\n@@ -205,16 +228,20 @@ export function wrapInParensIfNecessary(expression: t.Expression): t.Expression\n \n /**\n  * Extract the string values from an `array` of string literals.\n+ *\n  * @param array The array to unwrap.\n+ * @param fs The file system to use when computing source-map paths. If not provided then it uses\n+ *     the \"current\" FileSystem.\n  */\n-export function unwrapStringLiteralArray(array: NodePath<t.Expression>):\n-    [string[], (ɵSourceLocation | undefined)[]] {\n+export function unwrapStringLiteralArray(\n+    array: NodePath<t.Expression>,\n+    fs: FileSystem = getFileSystem()): [string[], (ɵSourceLocation | undefined)[]] {\n   if (!isStringLiteralArray(array.node)) {\n     throw new BabelParseError(\n         array.node, 'Unexpected messageParts for `$localize` (expected an array of strings).');\n   }\n   const elements = array.get('elements') as NodePath<t.StringLiteral>[];\n-  return [elements.map(str => str.node.value), elements.map(str => getLocation(str))];\n+  return [elements.map(str => str.node.value), elements.map(str => getLocation(fs, str))];\n }\n \n /**\n@@ -372,15 +399,16 @@ export function buildCodeFrameError(path: NodePath, e: BabelParseError): string\n   return `${filename}: ${message}`;\n }\n \n-export function getLocation(startPath: NodePath, endPath?: NodePath): ɵSourceLocation|undefined {\n+export function getLocation(\n+    fs: FileSystem, startPath: NodePath, endPath?: NodePath): ɵSourceLocation|undefined {\n   const startLocation = startPath.node.loc;\n-  const file = getFileFromPath(startPath);\n+  const file = getFileFromPath(fs, startPath);\n   if (!startLocation || !file) {\n     return undefined;\n   }\n \n   const endLocation =\n-      endPath && getFileFromPath(endPath) === file && endPath.node.loc || startLocation;\n+      endPath && getFileFromPath(fs, endPath) === file && endPath.node.loc || startLocation;\n \n   return {\n     start: getLineAndColumn(startLocation.start),\n@@ -397,10 +425,10 @@ export function serializeLocationPosition(location: ɵSourceLocation): string {\n   return `${location.start.line + 1}${endLineString}`;\n }\n \n-function getFileFromPath(path: NodePath|undefined): AbsoluteFsPath|null {\n+function getFileFromPath(fs: FileSystem, path: NodePath|undefined): AbsoluteFsPath|null {\n   const opts = path?.hub.file.opts;\n   return opts?.filename ?\n-      resolve(opts.generatorOpts.sourceRoot ?? opts.cwd, relative(opts.cwd, opts.filename)) :\n+      fs.resolve(opts.generatorOpts.sourceRoot ?? opts.cwd, fs.relative(opts.cwd, opts.filename)) :\n       null;\n }\n "
        },
        {
            "sha": "f2b351f88c8de29aec911f937802b439f414809e",
            "filename": "packages/localize/src/tools/src/translate/source_files/es2015_translate_plugin.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fes2015_translate_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fes2015_translate_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fes2015_translate_plugin.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,6 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedTranslation} from '@angular/localize';\n import {NodePath, PluginObj} from '@babel/core';\n import {TaggedTemplateExpression} from '@babel/types';\n@@ -21,16 +22,16 @@ import {buildCodeFrameError, buildLocalizeReplacement, isBabelParseError, isLoca\n  */\n export function makeEs2015TranslatePlugin(\n     diagnostics: Diagnostics, translations: Record<string, ɵParsedTranslation>,\n-    {missingTranslation = 'error', localizeName = '$localize'}: TranslatePluginOptions = {}):\n-    PluginObj {\n+    {missingTranslation = 'error', localizeName = '$localize'}: TranslatePluginOptions = {},\n+    fs: FileSystem = getFileSystem()): PluginObj {\n   return {\n     visitor: {\n       TaggedTemplateExpression(path: NodePath<TaggedTemplateExpression>) {\n         try {\n           const tag = path.get('tag');\n           if (isLocalize(tag, localizeName)) {\n             const [messageParts] =\n-                unwrapMessagePartsFromTemplateLiteral(path.get('quasi').get('quasis'));\n+                unwrapMessagePartsFromTemplateLiteral(path.get('quasi').get('quasis'), fs);\n             const translated = translate(\n                 diagnostics, translations, messageParts, path.node.quasi.expressions,\n                 missingTranslation);"
        },
        {
            "sha": "33a7066192fc5b713ae2ae415356297ab829b1c8",
            "filename": "packages/localize/src/tools/src/translate/source_files/es5_translate_plugin.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fes5_translate_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fes5_translate_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fes5_translate_plugin.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,6 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedTranslation} from '@angular/localize';\n import {NodePath, PluginObj} from '@babel/core';\n import {CallExpression} from '@babel/types';\n@@ -21,16 +22,16 @@ import {buildCodeFrameError, buildLocalizeReplacement, isBabelParseError, isLoca\n  */\n export function makeEs5TranslatePlugin(\n     diagnostics: Diagnostics, translations: Record<string, ɵParsedTranslation>,\n-    {missingTranslation = 'error', localizeName = '$localize'}: TranslatePluginOptions = {}):\n-    PluginObj {\n+    {missingTranslation = 'error', localizeName = '$localize'}: TranslatePluginOptions = {},\n+    fs: FileSystem = getFileSystem()): PluginObj {\n   return {\n     visitor: {\n       CallExpression(callPath: NodePath<CallExpression>) {\n         try {\n           const calleePath = callPath.get('callee');\n           if (isLocalize(calleePath, localizeName)) {\n-            const [messageParts] = unwrapMessagePartsFromLocalizeCall(callPath);\n-            const [expressions] = unwrapSubstitutionsFromLocalizeCall(callPath);\n+            const [messageParts] = unwrapMessagePartsFromLocalizeCall(callPath, fs);\n+            const [expressions] = unwrapSubstitutionsFromLocalizeCall(callPath, fs);\n             const translated =\n                 translate(diagnostics, translations, messageParts, expressions, missingTranslation);\n             callPath.replaceWith(buildLocalizeReplacement(translated[0], translated[1]));"
        },
        {
            "sha": "c3d69b420673f25d620f880a37bc21c1edae0540",
            "filename": "packages/localize/src/tools/src/translate/source_files/source_file_translation_handler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fsource_file_translation_handler.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fsource_file_translation_handler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fsource_file_translation_handler.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -78,8 +78,8 @@ export class SourceFileTranslationHandler implements TranslationHandler {\n       generatorOpts: {minified: true},\n       plugins: [\n         makeLocalePlugin(translationBundle.locale),\n-        makeEs2015TranslatePlugin(diagnostics, translationBundle.translations, options),\n-        makeEs5TranslatePlugin(diagnostics, translationBundle.translations, options),\n+        makeEs2015TranslatePlugin(diagnostics, translationBundle.translations, options, this.fs),\n+        makeEs5TranslatePlugin(diagnostics, translationBundle.translations, options, this.fs),\n       ],\n       filename,\n     });"
        },
        {
            "sha": "797b45581810258019ae4b5302c0ca15a9df97e9",
            "filename": "packages/localize/src/tools/test/extract/integration/main_spec.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,7 +5,8 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem, setFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {InvalidFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/src/invalid_file_system';\n import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {MockLogger} from '@angular/compiler-cli/src/ngtsc/logging/testing';\n import {loadTestDirectory} from '@angular/compiler-cli/test/helpers';\n@@ -34,6 +35,7 @@ runInEachFileSystem(() => {\n \n     fs.ensureDir(fs.dirname(sourceFilePath));\n     loadTestDirectory(fs, __dirname + '/test_files', absoluteFrom('/project/test_files'));\n+    setFileSystem(new InvalidFileSystem());\n   });\n \n   describe('extractTranslations()', () => {\n@@ -48,6 +50,7 @@ runInEachFileSystem(() => {\n         useSourceMaps: false,\n         useLegacyIds: false,\n         duplicateMessageHandling: 'ignore',\n+        fileSystem: fs,\n       });\n       expect(fs.readFile(outputPath)).toEqual([\n         `{`,\n@@ -70,6 +73,7 @@ runInEachFileSystem(() => {\n             useSourceMaps: false,\n             useLegacyIds,\n             duplicateMessageHandling: 'ignore',\n+            fileSystem: fs,\n           });\n           expect(fs.readFile(outputPath)).toEqual([\n             `{`,\n@@ -97,6 +101,7 @@ runInEachFileSystem(() => {\n             useSourceMaps: false,\n             useLegacyIds,\n             duplicateMessageHandling: 'ignore',\n+            fileSystem: fs,\n           });\n           expect(fs.readFile(outputPath)).toEqual([\n             `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n@@ -151,6 +156,7 @@ runInEachFileSystem(() => {\n                  useLegacyIds,\n                  duplicateMessageHandling: 'ignore',\n                  formatOptions,\n+                 fileSystem: fs,\n                });\n                expect(fs.readFile(outputPath)).toEqual([\n                  `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n@@ -222,6 +228,7 @@ runInEachFileSystem(() => {\n               useLegacyIds,\n               duplicateMessageHandling: 'ignore',\n               formatOptions,\n+              fileSystem: fs,\n             });\n             expect(fs.readFile(outputPath)).toEqual([\n               `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n@@ -299,6 +306,7 @@ runInEachFileSystem(() => {\n              useSourceMaps: true,\n              useLegacyIds: false,\n              duplicateMessageHandling: 'ignore',\n+             fileSystem: fs,\n            });\n            expect(fs.readFile(outputPath)).toEqual([\n              `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n@@ -308,7 +316,8 @@ runInEachFileSystem(() => {\n              `      <trans-unit id=\"157258427077572998\" datatype=\"html\">`,\n              `        <source>Message in <x id=\"a-file\" equiv-text=\"file\"/>!</source>`,\n              `        <context-group purpose=\"location\">`,\n-             // These source file paths are due to how Bazel TypeScript compilation source-maps work\n+             // These source file paths are due to how Bazel TypeScript compilation source-maps\n+             // work\n              `          <context context-type=\"sourcefile\">../packages/localize/src/tools/test/extract/integration/test_files/src/a.ts</context>`,\n              `          <context context-type=\"linenumber\">3</context>`,\n              `        </context-group>`,\n@@ -339,6 +348,7 @@ runInEachFileSystem(() => {\n                  useSourceMaps: false,\n                  useLegacyIds: false,\n                  duplicateMessageHandling: 'error',\n+                 fileSystem: fs,\n                }))\n             .toThrowError(\n                 `Failed to extract messages\\n` +\n@@ -360,6 +370,7 @@ runInEachFileSystem(() => {\n           useSourceMaps: false,\n           useLegacyIds: false,\n           duplicateMessageHandling: 'warning',\n+          fileSystem: fs,\n         });\n         expect(logger.logs.warn).toEqual([\n           ['Messages extracted with warnings\\n' +\n@@ -390,6 +401,7 @@ runInEachFileSystem(() => {\n           useSourceMaps: false,\n           useLegacyIds: false,\n           duplicateMessageHandling: 'ignore',\n+          fileSystem: fs,\n         });\n         expect(logger.logs.warn).toEqual([]);\n         expect(fs.readFile(outputPath)).toEqual(["
        },
        {
            "sha": "89907aa0943aebdb9380dbf166715e415c141476",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xmb_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer_spec.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {absoluteFrom, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n@@ -14,6 +14,8 @@ import {XmbTranslationSerializer} from '../../../src/extract/translation_files/x\n import {mockMessage} from './mock_message';\n \n runInEachFileSystem(() => {\n+  let fs: FileSystem;\n+  beforeEach(() => fs = getFileSystem());\n   describe('XmbTranslationSerializer', () => {\n     [false, true].forEach(useLegacyIds => {\n       describe(`renderFile() [using ${useLegacyIds ? 'legacy' : 'canonical'} ids]`, () => {\n@@ -61,7 +63,8 @@ runInEachFileSystem(() => {\n                 ],\n                 [], {}),\n           ];\n-          const serializer = new XmbTranslationSerializer(absoluteFrom('/project'), useLegacyIds);\n+          const serializer =\n+              new XmbTranslationSerializer(absoluteFrom('/project'), useLegacyIds, fs);\n           const output = serializer.serialize(messages);\n           expect(output).toContain([\n             `<messagebundle>`,"
        },
        {
            "sha": "df3db7ede3bc9eb9802ea43fd608be7f2fc7d502",
            "filename": "packages/localize/src/tools/test/source_file_utils_spec.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 12,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fsource_file_utils_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fsource_file_utils_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fsource_file_utils_spec.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {absoluteFrom, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {ɵmakeTemplateObject} from '@angular/localize';\n import {NodePath, TransformOptions, transformSync} from '@babel/core';\n@@ -16,6 +16,8 @@ import {Expression, Identifier, TaggedTemplateExpression, ExpressionStatement, C\n import {isGlobalIdentifier, isNamedIdentifier, isStringLiteralArray, isArrayOfExpressions, unwrapStringLiteralArray, unwrapMessagePartsFromLocalizeCall, wrapInParensIfNecessary, buildLocalizeReplacement, unwrapSubstitutionsFromLocalizeCall, unwrapMessagePartsFromTemplateLiteral, getLocation} from '../src/source_file_utils';\n \n runInEachFileSystem(() => {\n+  let fs: FileSystem;\n+  beforeEach(() => fs = getFileSystem());\n   describe('utils', () => {\n     describe('isNamedIdentifier()', () => {\n       it('should return true if the expression is an identifier with name `$localize`', () => {\n@@ -77,7 +79,7 @@ runInEachFileSystem(() => {\n       it('should return an array of string literals and locations from a direct call to a tag function',\n          () => {\n            const localizeCall = getLocalizeCall(`$localize(['a', 'b\\\\t', 'c'], 1, 2)`);\n-           const [parts, locations] = unwrapMessagePartsFromLocalizeCall(localizeCall);\n+           const [parts, locations] = unwrapMessagePartsFromLocalizeCall(localizeCall, fs);\n            expect(parts).toEqual(['a', 'b\\t', 'c']);\n            expect(locations).toEqual([\n              {\n@@ -105,7 +107,7 @@ runInEachFileSystem(() => {\n          () => {\n            let localizeCall = getLocalizeCall(\n                `$localize(__makeTemplateObject(['a', 'b\\\\t', 'c'], ['a', 'b\\\\\\\\t', 'c']), 1, 2)`);\n-           const [parts, locations] = unwrapMessagePartsFromLocalizeCall(localizeCall);\n+           const [parts, locations] = unwrapMessagePartsFromLocalizeCall(localizeCall, fs);\n            expect(parts).toEqual(['a', 'b\\t', 'c']);\n            expect(parts.raw).toEqual(['a', 'b\\\\t', 'c']);\n            expect(locations).toEqual([\n@@ -138,7 +140,7 @@ runInEachFileSystem(() => {\n           return _templateObject = function() { return e }, e\n         }\n         $localize(_templateObject(), 1, 2)`);\n-           const [parts, locations] = unwrapMessagePartsFromLocalizeCall(localizeCall);\n+           const [parts, locations] = unwrapMessagePartsFromLocalizeCall(localizeCall, fs);\n            expect(parts).toEqual(['a', 'b\\t', 'c']);\n            expect(parts.raw).toEqual(['a', 'b\\\\t', 'c']);\n            expect(locations).toEqual([\n@@ -173,7 +175,7 @@ runInEachFileSystem(() => {\n         const localizeStatement = localizeCall.parentPath as NodePath<ExpressionStatement>;\n         const statements = localizeStatement.container as object[];\n         expect(statements.length).toEqual(2);\n-        unwrapMessagePartsFromLocalizeCall(localizeCall);\n+        unwrapMessagePartsFromLocalizeCall(localizeCall, fs);\n         expect(statements.length).toEqual(1);\n         expect(statements[0]).toBe(localizeStatement.node);\n       });\n@@ -183,7 +185,7 @@ runInEachFileSystem(() => {\n       it('should return the substitutions and locations from a direct call to a tag function',\n          () => {\n            const call = getLocalizeCall(`$localize(['a', 'b\\t', 'c'], 1, 2)`);\n-           const [substitutions, locations] = unwrapSubstitutionsFromLocalizeCall(call);\n+           const [substitutions, locations] = unwrapSubstitutionsFromLocalizeCall(call, fs);\n            expect((substitutions as NumericLiteral[]).map(s => s.value)).toEqual([1, 2]);\n            expect(locations).toEqual([\n              {\n@@ -204,7 +206,7 @@ runInEachFileSystem(() => {\n       it('should return the substitutions and locations from a downleveled tagged template', () => {\n         const call = getLocalizeCall(\n             `$localize(__makeTemplateObject(['a', 'b', 'c'], ['a', 'b', 'c']), 1, 2)`);\n-        const [substitutions, locations] = unwrapSubstitutionsFromLocalizeCall(call);\n+        const [substitutions, locations] = unwrapSubstitutionsFromLocalizeCall(call, fs);\n         expect((substitutions as NumericLiteral[]).map(s => s.value)).toEqual([1, 2]);\n         expect(locations).toEqual([\n           {\n@@ -226,7 +228,8 @@ runInEachFileSystem(() => {\n     describe('unwrapMessagePartsFromTemplateLiteral', () => {\n       it('should return a TemplateStringsArray built from the template literal elements', () => {\n         const taggedTemplate = getTaggedTemplate('$localize `a${1}b\\\\t${2}c`;');\n-        expect(unwrapMessagePartsFromTemplateLiteral(taggedTemplate.get('quasi').get('quasis'))[0])\n+        expect(\n+            unwrapMessagePartsFromTemplateLiteral(taggedTemplate.get('quasi').get('quasis'), fs)[0])\n             .toEqual(ɵmakeTemplateObject(['a', 'b\\t', 'c'], ['a', 'b\\\\t', 'c']));\n       });\n     });\n@@ -248,7 +251,7 @@ runInEachFileSystem(() => {\n     describe('unwrapStringLiteralArray', () => {\n       it('should return an array of string from an array expression', () => {\n         const array = getFirstExpression(`['a', 'b', 'c']`);\n-        const [expressions, locations] = unwrapStringLiteralArray(array);\n+        const [expressions, locations] = unwrapStringLiteralArray(array, fs);\n         expect(expressions).toEqual(['a', 'b', 'c']);\n         expect(locations).toEqual([\n           {\n@@ -274,7 +277,7 @@ runInEachFileSystem(() => {\n \n       it('should throw an error if any elements of the array are not literal strings', () => {\n         const array = getFirstExpression(`['a', 2, 'c']`);\n-        expect(() => unwrapStringLiteralArray(array))\n+        expect(() => unwrapStringLiteralArray(array, fs))\n             .toThrowError(\n                 'Unexpected messageParts for `$localize` (expected an array of strings).');\n       });\n@@ -315,7 +318,7 @@ runInEachFileSystem(() => {\n           filename: 'src/test.js',\n           sourceRoot: '/root',\n         });\n-        const location = getLocation(taggedTemplate)!;\n+        const location = getLocation(fs, taggedTemplate)!;\n         expect(location).toBeDefined();\n         expect(location.start).toEqual({line: 0, column: 10});\n         expect(location.start.constructor.name).toEqual('Object');\n@@ -327,7 +330,7 @@ runInEachFileSystem(() => {\n       it('should return `undefined` if the NodePath has no filename', () => {\n         const taggedTemplate = getTaggedTemplate(\n             'const x = $localize ``;', {sourceRoot: '/root', filename: undefined});\n-        const location = getLocation(taggedTemplate);\n+        const location = getLocation(fs, taggedTemplate);\n         expect(location).toBeUndefined();\n       });\n     });"
        },
        {
            "sha": "23a5ed343b72ad2a797747842e8add7366764291",
            "filename": "packages/localize/src/tools/test/translate/source_files/es2015_translate_plugin_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 9,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes2015_translate_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes2015_translate_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes2015_translate_plugin_spec.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,6 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {ɵcomputeMsgId, ɵparseTranslation} from '@angular/localize';\n import {ɵParsedTranslation} from '@angular/localize/private';\n@@ -15,6 +16,8 @@ import {TranslatePluginOptions} from '../../../src/source_file_utils';\n import {makeEs2015TranslatePlugin} from '../../../src/translate/source_files/es2015_translate_plugin';\n \n runInEachFileSystem(() => {\n+  let fs: FileSystem;\n+  beforeEach(() => fs = getFileSystem());\n   describe('makeEs2015Plugin', () => {\n     describe('(no translations)', () => {\n       it('should transform `$localize` tags with binary expression', () => {\n@@ -168,13 +171,13 @@ runInEachFileSystem(() => {\n       });\n     });\n   });\n-});\n \n-function transformCode(\n-    input: string, translations: Record<string, ɵParsedTranslation> = {},\n-    pluginOptions?: TranslatePluginOptions, diagnostics = new Diagnostics()): string {\n-  return transformSync(input, {\n-           plugins: [makeEs2015TranslatePlugin(diagnostics, translations, pluginOptions)],\n-           filename: '/app/dist/test.js'\n-         })!.code!;\n-}\n+  function transformCode(\n+      input: string, translations: Record<string, ɵParsedTranslation> = {},\n+      pluginOptions?: TranslatePluginOptions, diagnostics = new Diagnostics()): string {\n+    return transformSync(input, {\n+             plugins: [makeEs2015TranslatePlugin(diagnostics, translations, pluginOptions)],\n+             filename: '/app/dist/test.js'\n+           })!.code!;\n+  }\n+});"
        },
        {
            "sha": "088113f405e4f64364982036ac154d89df4c47a1",
            "filename": "packages/localize/src/tools/test/translate/source_files/es5_translate_plugin_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 9,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes5_translate_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/79620f5139c80f1b3b38168744ca99a224c7e5cd/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes5_translate_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes5_translate_plugin_spec.ts?ref=79620f5139c80f1b3b38168744ca99a224c7e5cd",
            "patch": "@@ -5,6 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {ɵcomputeMsgId, ɵparseTranslation} from '@angular/localize';\n import {ɵParsedTranslation} from '@angular/localize/private';\n@@ -15,6 +16,8 @@ import {TranslatePluginOptions} from '../../../src/source_file_utils';\n import {makeEs5TranslatePlugin} from '../../../src/translate/source_files/es5_translate_plugin';\n \n runInEachFileSystem(() => {\n+  let fs: FileSystem;\n+  beforeEach(() => fs = getFileSystem());\n   describe('makeEs5Plugin', () => {\n     describe('(no translations)', () => {\n       it('should transform `$localize` calls with binary expression', () => {\n@@ -357,13 +360,13 @@ runInEachFileSystem(() => {\n       expect(output).toEqual('\"abc\" + (1 + 2 + 3) + \" - Hello, \" + getName() + \"!\";');\n     });\n   });\n-});\n \n-function transformCode(\n-    input: string, translations: Record<string, ɵParsedTranslation> = {},\n-    pluginOptions?: TranslatePluginOptions, diagnostics = new Diagnostics()): string {\n-  return transformSync(input, {\n-           plugins: [makeEs5TranslatePlugin(diagnostics, translations, pluginOptions)],\n-           filename: '/app/dist/test.js'\n-         })!.code!;\n-}\n+  function transformCode(\n+      input: string, translations: Record<string, ɵParsedTranslation> = {},\n+      pluginOptions?: TranslatePluginOptions, diagnostics = new Diagnostics()): string {\n+    return transformSync(input, {\n+             plugins: [makeEs5TranslatePlugin(diagnostics, translations, pluginOptions)],\n+             filename: '/app/dist/test.js'\n+           })!.code!;\n+  }\n+});"
        }
    ],
    "stats": {
        "total": 242,
        "additions": 155,
        "deletions": 87
    }
}