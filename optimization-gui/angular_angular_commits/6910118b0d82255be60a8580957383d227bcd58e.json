{
    "author": "JiaLiPassion",
    "message": "test(zone.js): should invoke XHR task even onload handler throw error. (#41562)\n\nClose #41520.\n\nThis case related to the issue #41522.\n\n```\nZone.root\n  .fork({\n    name: 'xhr',\n    onHasTask(delegate, currentZone, zone, taskState) {\n      console.log('hasMacrotask', taskState.macroTask);\n      return delegate.hasTask(zone, taskState);\n    },\n  })\n  .run(() => {\n    const xhr = new XMLHttpRequest();\n    xhr.open('GET', 'https://cdnjs.cloudflare.com/ajax/libs/zone.js/0.11.4/zone.min.js');\n    xhr.addEventListener('load', () => {\n      throw new Error();\n    });\n    xhr.send();\n  });\n```\n\nzone.js invoke all `onload` event handlers before change the XHR task's state from\n`scheduled` to `notscheduled`, so if any `onload` listener throw error, the XHR task\nwlll be hang to `scheduled`, and leave the macroTask status in the zone wrongly.\n\nThis has been fixed in the previous commit, this commit add test to verify the case.\n\nPR Close #41562",
    "sha": "6910118b0d82255be60a8580957383d227bcd58e",
    "files": [
        {
            "sha": "37fb6f842769e32f1bc105929f78df4d45f68009",
            "filename": "packages/zone.js/test/browser/XMLHttpRequest.spec.ts",
            "status": "modified",
            "additions": 71,
            "deletions": 0,
            "changes": 71,
            "blob_url": "https://github.com/angular/angular/blob/6910118b0d82255be60a8580957383d227bcd58e/packages%2Fzone.js%2Ftest%2Fbrowser%2FXMLHttpRequest.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6910118b0d82255be60a8580957383d227bcd58e/packages%2Fzone.js%2Ftest%2Fbrowser%2FXMLHttpRequest.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fbrowser%2FXMLHttpRequest.spec.ts?ref=6910118b0d82255be60a8580957383d227bcd58e",
            "patch": "@@ -103,6 +103,77 @@ describe('XMLHttpRequest', function() {\n     req!.send();\n   });\n \n+  it('should run onload listeners before internal readystatechange', function(done) {\n+    const logs: string[] = [];\n+    const xhrZone = Zone.current.fork({\n+      name: 'xhr',\n+      onInvokeTask: (delegate, curr, target, task, applyThis, applyArgs) => {\n+        logs.push('invokeTask ' + task.source);\n+        return delegate.invokeTask(target, task, applyThis, applyArgs);\n+      }\n+    });\n+\n+    xhrZone.run(function() {\n+      const req = new XMLHttpRequest();\n+      req.onload = function() {\n+        logs.push('onload');\n+        (window as any)[Zone.__symbol__('setTimeout')](() => {\n+          expect(logs).toEqual([\n+            'invokeTask XMLHttpRequest.addEventListener:load', 'onload',\n+            'invokeTask XMLHttpRequest.send'\n+          ])\n+          done();\n+        });\n+      };\n+      req.open('get', '/', true);\n+      req.send();\n+    });\n+  });\n+\n+  it('should invoke xhr task even onload listener throw error', function(done) {\n+    const logs: string[] = [];\n+    const xhrZone = Zone.current.fork({\n+      name: 'xhr',\n+      onInvokeTask: (delegate, curr, target, task, applyThis, applyArgs) => {\n+        logs.push('invokeTask ' + task.source);\n+        return delegate.invokeTask(target, task, applyThis, applyArgs);\n+      },\n+      onHasTask: (delegate, curr, target, hasTaskState) => {\n+        if (hasTaskState.change === 'macroTask') {\n+          logs.push('hasTask ' + hasTaskState.macroTask);\n+        }\n+        return delegate.hasTask(target, hasTaskState);\n+      }\n+    });\n+\n+    xhrZone.run(function() {\n+      const req = new XMLHttpRequest();\n+      req.onload = function() {\n+        logs.push('onload');\n+        throw new Error('test');\n+      };\n+      const unhandledRejection = (e: PromiseRejectionEvent) => {\n+        logs.push(e.reason.message);\n+      };\n+      window.addEventListener('unhandledrejection', unhandledRejection);\n+      req.addEventListener('load', () => {\n+        logs.push('onload1');\n+        (window as any)[Zone.__symbol__('setTimeout')](() => {\n+          expect(logs).toEqual([\n+            'hasTask true', 'invokeTask XMLHttpRequest.addEventListener:load', 'onload',\n+            'invokeTask XMLHttpRequest.addEventListener:load', 'onload1',\n+            'invokeTask XMLHttpRequest.send', 'hasTask false',\n+            'invokeTask Window.addEventListener:unhandledrejection', 'test'\n+          ]);\n+          window.removeEventListener('unhandledrejection', unhandledRejection);\n+          done();\n+        });\n+      });\n+      req.open('get', '/', true);\n+      req.send();\n+    });\n+  });\n+\n   it('should return null when access ontimeout first time without error', function() {\n     let req: XMLHttpRequest = new XMLHttpRequest();\n     expect(req.ontimeout).toBe(null);"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 71,
        "deletions": 0
    }
}