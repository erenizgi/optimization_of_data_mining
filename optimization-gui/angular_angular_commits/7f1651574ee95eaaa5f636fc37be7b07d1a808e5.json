{
    "author": "JoostK",
    "message": "fix(compiler-cli): prevent eliding default imports in incremental recompilations (#41557)\n\nThe Angular compiler has to actively keep default import statements\nalive if they were only used in type-only positions, but have been\nemitted as value expressions for DI purposes. A problem occurred in\nincremental recompilations, where the relationship between an identifier\nusage and its corresponding default import would not be considered. This\ncould result in the removal of the default import statement and caused\na `ReferenceError` at runtime.\n\nThis commit fixes the issue by storing the association from an\nidentifier to its default import declaration on the source file itself,\ninstead of within the `DefaultImportTracker` instance. The\n`DefaultImportTracker` instance is only valid for a single compilation,\nwhereas the association from an identifier to a default import\ndeclaration is valid as long as the `ts.SourceFile` is the same\ninstance.\n\nA subsequent commit refactor the `DefaultImportTracker` to no longer\nbe responsible for registering the association, as its lifetime is\nconceptually too short to do so.\n\nFixes #41377\n\nPR Close #41557",
    "sha": "7f1651574ee95eaaa5f636fc37be7b07d1a808e5",
    "files": [
        {
            "sha": "23ff5be7710c4ceb0143916c1d812c1fbcd3f519",
            "filename": "packages/compiler-cli/src/ngtsc/imports/src/default.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 17,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/7f1651574ee95eaaa5f636fc37be7b07d1a808e5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fimports%2Fsrc%2Fdefault.ts",
            "raw_url": "https://github.com/angular/angular/raw/7f1651574ee95eaaa5f636fc37be7b07d1a808e5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fimports%2Fsrc%2Fdefault.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fimports%2Fsrc%2Fdefault.ts?ref=7f1651574ee95eaaa5f636fc37be7b07d1a808e5",
            "patch": "@@ -48,6 +48,12 @@ export const NOOP_DEFAULT_IMPORT_RECORDER: DefaultImportRecorder = {\n   recordUsedIdentifier: (id: ts.Identifier) => void{},\n };\n \n+const ImportDeclarationMapping = Symbol('ImportDeclarationMapping');\n+\n+interface SourceFileWithImportDeclarationMapping extends ts.SourceFile {\n+  [ImportDeclarationMapping]?: Map<ts.Identifier, ts.ImportDeclaration>;\n+}\n+\n /**\n  * TypeScript has trouble with generating default imports inside of transformers for some module\n  * formats. The issue is that for the statement:\n@@ -79,38 +85,31 @@ export const NOOP_DEFAULT_IMPORT_RECORDER: DefaultImportRecorder = {\n  * \"import * as X\" style imports for those, and the \"X\" identifier survives transformation.\n  */\n export class DefaultImportTracker implements DefaultImportRecorder {\n-  /**\n-   * A `Map` which tracks the `Map` of default import `ts.Identifier`s to their\n-   * `ts.ImportDeclaration`s. These declarations are not guaranteed to be used.\n-   */\n-  private sourceFileToImportMap =\n-      new Map<ts.SourceFile, Map<ts.Identifier, ts.ImportDeclaration>>();\n-\n   /**\n    * A `Map` which tracks the `Set` of `ts.ImportDeclaration`s for default imports that were used in\n    * a given `ts.SourceFile` and need to be preserved.\n    */\n   private sourceFileToUsedImports = new Map<ts.SourceFile, Set<ts.ImportDeclaration>>();\n   recordImportedIdentifier(id: ts.Identifier, decl: ts.ImportDeclaration): void {\n-    const sf = getSourceFile(id);\n-    if (!this.sourceFileToImportMap.has(sf)) {\n-      this.sourceFileToImportMap.set(sf, new Map<ts.Identifier, ts.ImportDeclaration>());\n+    const sf = getSourceFile(id) as SourceFileWithImportDeclarationMapping;\n+    if (sf[ImportDeclarationMapping] === undefined) {\n+      sf[ImportDeclarationMapping] = new Map<ts.Identifier, ts.ImportDeclaration>();\n     }\n-    this.sourceFileToImportMap.get(sf)!.set(id, decl);\n+    sf[ImportDeclarationMapping]!.set(id, decl);\n   }\n \n   recordUsedIdentifier(id: ts.Identifier): void {\n-    const sf = getSourceFile(id);\n-    if (!this.sourceFileToImportMap.has(sf)) {\n+    const sf = getSourceFile(id) as SourceFileWithImportDeclarationMapping;\n+    const identifierToDeclaration = sf[ImportDeclarationMapping];\n+    if (identifierToDeclaration === undefined) {\n       // The identifier's source file has no registered default imports at all.\n       return;\n     }\n-    const identiferToDeclaration = this.sourceFileToImportMap.get(sf)!;\n-    if (!identiferToDeclaration.has(id)) {\n+    if (!identifierToDeclaration.has(id)) {\n       // The identifier isn't from a registered default import.\n       return;\n     }\n-    const decl = identiferToDeclaration.get(id)!;\n+    const decl = identifierToDeclaration.get(id)!;\n \n     // Add the default import declaration to the set of used import declarations for the file.\n     if (!this.sourceFileToUsedImports.has(sf)) {\n@@ -182,7 +181,6 @@ export class DefaultImportTracker implements DefaultImportRecorder {\n \n     // Save memory - there's no need to keep these around once the transform has run for the given\n     // file.\n-    this.sourceFileToImportMap.delete(originalSf);\n     this.sourceFileToUsedImports.delete(originalSf);\n \n     return ts.updateSourceFileNode(sf, statements);"
        },
        {
            "sha": "5b94f8ccc896b43f5e05c6a18884e82a225439bd",
            "filename": "packages/compiler-cli/test/ngtsc/incremental_spec.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/angular/angular/blob/7f1651574ee95eaaa5f636fc37be7b07d1a808e5/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fincremental_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7f1651574ee95eaaa5f636fc37be7b07d1a808e5/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fincremental_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fincremental_spec.ts?ref=7f1651574ee95eaaa5f636fc37be7b07d1a808e5",
            "patch": "@@ -605,6 +605,67 @@ runInEachFileSystem(() => {\n         expect(env.driveDiagnostics().length).toBe(1);\n       });\n \n+      it('should retain default imports that have been converted into a value expression', () => {\n+        // This test defines the component `TestCmp` that has a default-imported class as\n+        // constructor parameter, and uses `TestDir` in its template. An incremental compilation\n+        // updates `TestDir` and changes its inputs, thereby triggering re-emit of `TestCmp` without\n+        // performing re-analysis of `TestCmp`. The output of the re-emitted file for `TestCmp`\n+        // should continue to have retained the default import.\n+        env.write('service.ts', `\n+          import {Injectable} from '@angular/core';\n+\n+          @Injectable({ providedIn: 'root' })\n+          export default class DefaultService {}\n+        `);\n+        env.write('cmp.ts', `\n+          import {Component, Directive} from '@angular/core';\n+          import DefaultService from './service';\n+\n+          @Component({\n+            template: '<div dir></div>',\n+          })\n+          export class TestCmp {\n+            constructor(service: DefaultService) {}\n+          }\n+        `);\n+        env.write('dir.ts', `\n+          import {Directive} from '@angular/core';\n+\n+          @Directive({ selector: '[dir]' })\n+          export class TestDir {}\n+        `);\n+        env.write('mod.ts', `\n+          import {NgModule} from '@angular/core';\n+          import {TestDir} from './dir';\n+          import {TestCmp} from './cmp';\n+\n+          @NgModule({ declarations: [TestDir, TestCmp] })\n+          export class TestMod {}\n+        `);\n+\n+        env.driveMain();\n+        env.flushWrittenFileTracking();\n+\n+        // Update `TestDir` to change its inputs, triggering a re-emit of `TestCmp` that uses\n+        // `TestDir`.\n+        env.write('dir.ts', `\n+          import {Directive} from '@angular/core';\n+\n+          @Directive({ selector: '[dir]', inputs: ['added'] })\n+          export class TestDir {}\n+        `);\n+        env.driveMain();\n+\n+        // Verify that `TestCmp` was indeed re-emitted.\n+        const written = env.getFilesWrittenSinceLastFlush();\n+        expect(written).toContain('/dir.js');\n+        expect(written).toContain('/cmp.js');\n+\n+        // Verify that the default import is still present.\n+        const content = env.getContents('cmp.js');\n+        expect(content).toContain(`import DefaultService from './service';`);\n+      });\n+\n       it('should recompile when a remote change happens to a scope', () => {\n         // The premise of this test is that the component Cmp has a template error (a binding to an\n         // unknown property). Cmp is in ModuleA, which imports ModuleB, which declares Dir that has"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 76,
        "deletions": 17
    }
}