{
    "author": "JoostK",
    "message": "perf(compiler-cli): reduce filesystem hits during resource resolution (#39604)\n\nThe resource loader uses TypeScript's module resolution system to\ndetermine at which locations it needs to look for a resource file. A\nmarker string is used to force the module resolution to fail, such that\nall failed lookup locations can then be considered for actual resource\nresolution. Any filesystem requests targeting files/directories that\ncontain the marker are known not to exist, so no filesystem request\nneeds to be done at all.\n\nPR Close #39604",
    "sha": "ade6da95e4540838d8596700b85f615863601b32",
    "files": [
        {
            "sha": "62e89ef784f15bc8e0101a22b6be1b58aed65bdf",
            "filename": "packages/compiler-cli/src/ngtsc/resource/src/loader.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 3,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/ade6da95e4540838d8596700b85f615863601b32/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fresource%2Fsrc%2Floader.ts",
            "raw_url": "https://github.com/angular/angular/raw/ade6da95e4540838d8596700b85f615863601b32/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fresource%2Fsrc%2Floader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fresource%2Fsrc%2Floader.ts?ref=ade6da95e4540838d8596700b85f615863601b32",
            "patch": "@@ -11,15 +11,20 @@ import * as ts from 'typescript';\n import {ResourceLoader} from '../../annotations';\n import {NgCompilerAdapter} from '../../core/api';\n import {AbsoluteFsPath, join, PathSegment} from '../../file_system';\n+import {RequiredDelegations} from '../../util/src/typescript';\n \n const CSS_PREPROCESSOR_EXT = /(\\.scss|\\.sass|\\.less|\\.styl)$/;\n \n+const RESOURCE_MARKER = '.$ngresource$';\n+const RESOURCE_MARKER_TS = RESOURCE_MARKER + '.ts';\n+\n /**\n  * `ResourceLoader` which delegates to an `NgCompilerAdapter`'s resource loading methods.\n  */\n export class AdapterResourceLoader implements ResourceLoader {\n   private cache = new Map<string, string>();\n   private fetching = new Map<string, Promise<void>>();\n+  private lookupResolutionHost = createLookupResolutionHost(this.adapter);\n \n   canPreload = !!this.adapter.readResource;\n \n@@ -167,7 +172,7 @@ export class AdapterResourceLoader implements ResourceLoader {\n         ts.ResolvedModuleWithFailedLookupLocations&{failedLookupLocations: ReadonlyArray<string>};\n \n     // clang-format off\n-    const failedLookup = ts.resolveModuleName(url + '.$ngresource$', fromFile, this.options, this.adapter) as ResolvedModuleWithFailedLookupLocations;\n+    const failedLookup = ts.resolveModuleName(url + RESOURCE_MARKER, fromFile, this.options, this.lookupResolutionHost) as ResolvedModuleWithFailedLookupLocations;\n     // clang-format on\n     if (failedLookup.failedLookupLocations === undefined) {\n       throw new Error(\n@@ -176,7 +181,40 @@ export class AdapterResourceLoader implements ResourceLoader {\n     }\n \n     return failedLookup.failedLookupLocations\n-        .filter(candidate => candidate.endsWith('.$ngresource$.ts'))\n-        .map(candidate => candidate.replace(/\\.\\$ngresource\\$\\.ts$/, ''));\n+        .filter(candidate => candidate.endsWith(RESOURCE_MARKER_TS))\n+        .map(candidate => candidate.slice(0, -RESOURCE_MARKER_TS.length));\n   }\n }\n+\n+/**\n+ * Derives a `ts.ModuleResolutionHost` from a compiler adapter that recognizes the special resource\n+ * marker and does not go to the filesystem for these requests, as they are known not to exist.\n+ */\n+function createLookupResolutionHost(adapter: NgCompilerAdapter):\n+    RequiredDelegations<ts.ModuleResolutionHost> {\n+  return {\n+    directoryExists(directoryName: string): boolean {\n+      if (directoryName.includes(RESOURCE_MARKER)) {\n+        return false;\n+      } else if (adapter.directoryExists !== undefined) {\n+        return adapter.directoryExists(directoryName);\n+      } else {\n+        // TypeScript's module resolution logic assumes that the directory exists when no host\n+        // implementation is available.\n+        return true;\n+      }\n+    },\n+    fileExists(fileName: string): boolean {\n+      if (fileName.includes(RESOURCE_MARKER)) {\n+        return false;\n+      } else {\n+        return adapter.fileExists(fileName);\n+      }\n+    },\n+    readFile: adapter.readFile.bind(adapter),\n+    getCurrentDirectory: adapter.getCurrentDirectory.bind(adapter),\n+    getDirectories: adapter.getDirectories?.bind(adapter),\n+    realpath: adapter.realpath?.bind(adapter),\n+    trace: adapter.trace?.bind(adapter),\n+  };\n+}"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 41,
        "deletions": 3
    }
}