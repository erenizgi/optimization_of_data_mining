{
    "author": "josephperrott",
    "message": "fix(dev-infra): delay checking if a closed pr has been merged by 30 seconds (#40181)\n\nDelaying the check if a closed PR was closed by a merge or just closed by 30 seconds\nallows for Github to have time to update the PR to be associated to the commit which\nclosed the PR.  Without this delay, a race condition can exist in which we check for\nhow a PR was closed before this association is made.\n\nPR Close #40181",
    "sha": "7a819caef6a3445274e8fcf35b3e0d785beb797d",
    "files": [
        {
            "sha": "617acc5822eafe74425b752399e7b1c3c1791b30",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/7a819caef6a3445274e8fcf35b3e0d785beb797d/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/7a819caef6a3445274e8fcf35b3e0d785beb797d/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=7a819caef6a3445274e8fcf35b3e0d785beb797d",
            "patch": "@@ -5327,19 +5327,24 @@ const findOwnedForksOfRepoQuery = typedGraphqlify.params({\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+/** Thirty seconds in milliseconds. */\n+const THIRTY_SECONDS_IN_MS = 30000;\n /** Gets whether a given pull request has been merged. */\n function getPullRequestState(api, id) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n         const { data } = yield api.github.pulls.get(Object.assign(Object.assign({}, api.remoteParams), { pull_number: id }));\n         if (data.merged) {\n             return 'merged';\n         }\n-        else if (data.closed_at !== null) {\n+        // Check if the PR was closed more than 30 seconds ago, this extra time gives Github time to\n+        // update the closed pull request to be associated with the closing commit.\n+        // Note: a Date constructed with `null` creates an object at 0 time, which will never be greater\n+        // than the current date time.\n+        if (data.closed_at !== null &&\n+            (new Date(data.closed_at).getTime() < Date.now() - THIRTY_SECONDS_IN_MS)) {\n             return (yield isPullRequestClosedWithAssociatedCommit(api, id)) ? 'merged' : 'closed';\n         }\n-        else {\n-            return 'open';\n-        }\n+        return 'open';\n     });\n }\n /**"
        },
        {
            "sha": "129ef2dba5a13ede9c8ee69269c39eef4ec4624a",
            "filename": "dev-infra/release/publish/pull-request-state.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/7a819caef6a3445274e8fcf35b3e0d785beb797d/dev-infra%2Frelease%2Fpublish%2Fpull-request-state.ts",
            "raw_url": "https://github.com/angular/angular/raw/7a819caef6a3445274e8fcf35b3e0d785beb797d/dev-infra%2Frelease%2Fpublish%2Fpull-request-state.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Fpull-request-state.ts?ref=7a819caef6a3445274e8fcf35b3e0d785beb797d",
            "patch": "@@ -9,6 +9,9 @@\n import * as Octokit from '@octokit/rest';\n import {GitClient} from '../../utils/git/index';\n \n+/** Thirty seconds in milliseconds. */\n+const THIRTY_SECONDS_IN_MS = 30000;\n+\n /** State of a pull request in Github. */\n export type PullRequestState = 'merged'|'closed'|'open';\n \n@@ -17,11 +20,16 @@ export async function getPullRequestState(api: GitClient, id: number): Promise<P\n   const {data} = await api.github.pulls.get({...api.remoteParams, pull_number: id});\n   if (data.merged) {\n     return 'merged';\n-  } else if (data.closed_at !== null) {\n+  }\n+  // Check if the PR was closed more than 30 seconds ago, this extra time gives Github time to\n+  // update the closed pull request to be associated with the closing commit.\n+  // Note: a Date constructed with `null` creates an object at 0 time, which will never be greater\n+  // than the current date time.\n+  if (data.closed_at !== null &&\n+      (new Date(data.closed_at).getTime() < Date.now() - THIRTY_SECONDS_IN_MS)) {\n     return await isPullRequestClosedWithAssociatedCommit(api, id) ? 'merged' : 'closed';\n-  } else {\n-    return 'open';\n   }\n+  return 'open';\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 20,
        "deletions": 7
    }
}