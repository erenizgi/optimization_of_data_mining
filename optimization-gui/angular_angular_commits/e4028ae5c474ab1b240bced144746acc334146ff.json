{
    "author": "petebacondarwin",
    "message": "build(docs-infra): compute previous version list (#39689)\n\nPreviously we hand coded the list of previous major versions\nthat are displayed in the left navigation.\n\nNow these are generated from the tags in GitHub.\n\nCloses #39688\n\nPR Close #39689",
    "sha": "e4028ae5c474ab1b240bced144746acc334146ff",
    "files": [
        {
            "sha": "a082b064c7cf00396bec12af43e30d0620286ec5",
            "filename": "aio/content/navigation.json",
            "status": "modified",
            "additions": 0,
            "deletions": 30,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/e4028ae5c474ab1b240bced144746acc334146ff/aio%2Fcontent%2Fnavigation.json",
            "raw_url": "https://github.com/angular/angular/raw/e4028ae5c474ab1b240bced144746acc334146ff/aio%2Fcontent%2Fnavigation.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fnavigation.json?ref=e4028ae5c474ab1b240bced144746acc334146ff",
            "patch": "@@ -1060,35 +1060,5 @@\n         }\n       ]\n     }\n-  ],\n-  \"docVersions\": [\n-    {\n-      \"title\": \"v9\",\n-      \"url\": \"https://v9.angular.io/\"\n-    },\n-    {\n-      \"title\": \"v8\",\n-      \"url\": \"https://v8.angular.io/\"\n-    },\n-    {\n-      \"title\": \"v7\",\n-      \"url\": \"https://v7.angular.io/\"\n-    },\n-    {\n-      \"title\": \"v6\",\n-      \"url\": \"https://v6.angular.io/\"\n-    },\n-    {\n-      \"title\": \"v5\",\n-      \"url\": \"https://v5.angular.io/\"\n-    },\n-    {\n-      \"title\": \"v4\",\n-      \"url\": \"https://v4.angular.io/\"\n-    },\n-    {\n-      \"title\": \"v2\",\n-      \"url\": \"https://v2.angular.io/\"\n-    }\n   ]\n }"
        },
        {
            "sha": "5f1f6e5fc8401e0586f76d349450f4c3664067d8",
            "filename": "aio/tools/transforms/angular-base-package/index.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/e4028ae5c474ab1b240bced144746acc334146ff/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js",
            "raw_url": "https://github.com/angular/angular/raw/e4028ae5c474ab1b240bced144746acc334146ff/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js?ref=e4028ae5c474ab1b240bced144746acc334146ff",
            "patch": "@@ -8,6 +8,7 @@\n const path = require('path');\n const Package = require('dgeni').Package;\n \n+const gitPackage = require('dgeni-packages/git');\n const jsdocPackage = require('dgeni-packages/jsdoc');\n const nunjucksPackage = require('dgeni-packages/nunjucks');\n const linksPackage = require('../links-package');\n@@ -19,7 +20,7 @@ const postProcessPackage = require('dgeni-packages/post-process-html');\n const { PROJECT_ROOT, CONTENTS_PATH, OUTPUT_PATH, DOCS_OUTPUT_PATH, TEMPLATES_PATH, AIO_PATH, requireFolder } = require('../config');\n \n module.exports = new Package('angular-base', [\n-  jsdocPackage, nunjucksPackage, linksPackage, examplesPackage, targetPackage, remarkPackage, postProcessPackage\n+  gitPackage, jsdocPackage, nunjucksPackage, linksPackage, examplesPackage, targetPackage, remarkPackage, postProcessPackage\n ])\n \n   // Register the processors\n@@ -37,6 +38,7 @@ module.exports = new Package('angular-base', [\n   .factory(require('./readers/json'))\n   .factory(require('./services/copyFolder'))\n   .factory(require('./services/getImageDimensions'))\n+  .factory(require('./services/getPreviousMajorVersions'))\n   .factory(require('./services/auto-link-filters/filterPipes'))\n   .factory(require('./services/auto-link-filters/filterAmbiguousDirectiveAliases'))\n   .factory(require('./services/auto-link-filters/ignoreHttpInUrls'))"
        },
        {
            "sha": "1632ab9aa0b8408738e8f4bdb4d69e44d0e7556f",
            "filename": "aio/tools/transforms/angular-base-package/services/getPreviousMajorVersions.js",
            "status": "added",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/angular/angular/blob/e4028ae5c474ab1b240bced144746acc334146ff/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fservices%2FgetPreviousMajorVersions.js",
            "raw_url": "https://github.com/angular/angular/raw/e4028ae5c474ab1b240bced144746acc334146ff/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fservices%2FgetPreviousMajorVersions.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fservices%2FgetPreviousMajorVersions.js?ref=e4028ae5c474ab1b240bced144746acc334146ff",
            "patch": "@@ -0,0 +1,54 @@\n+'use strict';\n+\n+const child = require('child_process');\n+const semver = require('semver');\n+const versionMatcher = /refs\\/tags\\/(\\d+.+)$/mg;\n+\n+/**\n+ * Get a collection of all the previous \"last major\" versions sorted by semantic version.\n+ *\n+ * @param packageInfo injected from dgeni-packages/git\n+ * @param versionInfo injected from dgeni-packages/git\n+ * @returns an array of SemVer objects\n+ */\n+module.exports = function getPreviousMajorVersions(packageInfo, versionInfo) {\n+  return () => {\n+    // always use the remote tags as the local clone might not contain all commits when cloned with\n+    // `git clone --depth=...`\n+    const repoUrl = packageInfo.repository.url;\n+    const tagResults = child.spawnSync('git', ['ls-remote', '--tags', repoUrl], {encoding: 'utf8'});\n+\n+    if (tagResults.status !== 0) {\n+      return [];\n+    }\n+\n+    const majorVersions = {};\n+    tagResults.stdout.replace(versionMatcher, (_, tag) => {\n+      const version = semver.parse(tag);\n+\n+      // Not interested in tags that do not match semver format.\n+      if (version === null) {\n+        return;\n+      }\n+\n+      // Not interested in pre-release versions.\n+      if (version.prerelease !== null && version.prerelease.length > 0) {\n+        return;\n+      }\n+\n+      // Only interested in versions that are earlier than the current major.\n+      if (version.major >= versionInfo.currentVersion.major) {\n+        return;\n+      }\n+\n+      const currentMajor = majorVersions[version.major];\n+      if (currentMajor === undefined || semver.compare(version, currentMajor) === 1) {\n+        // This version is newer than the currently captured version for this major.\n+        majorVersions[version.major] = version;\n+      }\n+    });\n+\n+    // Sort them in descending order\n+    return semver.sort(Object.values(majorVersions)).reverse();\n+  };\n+};"
        },
        {
            "sha": "577f69d7f106c10f890f2d734426c4ef2fd593b8",
            "filename": "aio/tools/transforms/angular-base-package/services/getPreviousMajorVersions.spec.js",
            "status": "added",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/angular/angular/blob/e4028ae5c474ab1b240bced144746acc334146ff/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fservices%2FgetPreviousMajorVersions.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/e4028ae5c474ab1b240bced144746acc334146ff/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fservices%2FgetPreviousMajorVersions.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fservices%2FgetPreviousMajorVersions.spec.js?ref=e4028ae5c474ab1b240bced144746acc334146ff",
            "patch": "@@ -0,0 +1,63 @@\n+const child = require('child_process');\n+const Dgeni = require('dgeni');\n+const semver = require('semver');\n+\n+const basePackage = require('../index');\n+\n+describe('getPreviousMajorVersions', () => {\n+  let getPreviousMajorVersions;\n+\n+  beforeEach(() => {\n+    const mockPackage = new Dgeni.Package('mock-package', [basePackage])\n+                            .factory('versionInfo', mockVersionInfo)\n+                            .factory('packageInfo', mockPackageInfo);\n+    const dgeni = new Dgeni([mockPackage]);\n+    const injector = dgeni.configureInjector();\n+    getPreviousMajorVersions = injector.get('getPreviousMajorVersions');\n+  });\n+\n+  it('should spawn a child process to git', () => {\n+    spyOn(child, 'spawnSync').and.returnValue({status: 0, stdout: ''});\n+    getPreviousMajorVersions();\n+    expect(child.spawnSync).toHaveBeenCalledWith('git', ['ls-remote', '--tags', 'SOME_GIT_URL'], {\n+      encoding: 'utf8'\n+    });\n+  });\n+\n+  it('should return an empty list for a failed git command', () => {\n+    spyOn(child, 'spawnSync').and.returnValue({status: 1});\n+    expect(getPreviousMajorVersions()).toEqual([]);\n+  });\n+\n+  it('should return an empty list for no tags', () => {\n+    spyOn(child, 'spawnSync').and.returnValue({status: 0, stdout: ''});\n+    expect(getPreviousMajorVersions()).toEqual([]);\n+  });\n+\n+  it('should return an array of latest major versions with major greater than current', () => {\n+    spyOn(child, 'spawnSync').and.returnValue({\n+      status: 0,\n+      stdout: `\n+    refs/pull/655\n+    refs/tags/some-tag\n+    refs/tags/3.8.1\n+    refs/tags/4.2.9\n+    refs/tags/4.2.10\n+    refs/tags/5.6.1\n+    refs/tags/6.1.1\n+    `\n+    });\n+    expect(getPreviousMajorVersions()).toEqual([\n+      semver('4.2.10'),\n+      semver('3.8.1'),\n+    ]);\n+  });\n+});\n+\n+function mockVersionInfo() {\n+  return {currentVersion: new semver('5.1.0')};\n+}\n+\n+function mockPackageInfo() {\n+  return {repository: {url: 'SOME_GIT_URL'}};\n+}"
        },
        {
            "sha": "41877db20976c1461cdbb8ad61ccfd04cb50f938",
            "filename": "aio/tools/transforms/angular.io-package/processors/processNavigationMap.js",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/e4028ae5c474ab1b240bced144746acc334146ff/aio%2Ftools%2Ftransforms%2Fangular.io-package%2Fprocessors%2FprocessNavigationMap.js",
            "raw_url": "https://github.com/angular/angular/raw/e4028ae5c474ab1b240bced144746acc334146ff/aio%2Ftools%2Ftransforms%2Fangular.io-package%2Fprocessors%2FprocessNavigationMap.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular.io-package%2Fprocessors%2FprocessNavigationMap.js?ref=e4028ae5c474ab1b240bced144746acc334146ff",
            "patch": "@@ -1,15 +1,14 @@\n-module.exports = function processNavigationMap(versionInfo, log) {\n+module.exports = function processNavigationMap(versionInfo, getPreviousMajorVersions, log) {\n   return {\n     $runAfter: ['paths-computed'],\n     $runBefore: ['rendering-docs'],\n     $process: function(docs) {\n-\n       const navigationDoc = docs.find(doc => doc.docType === 'navigation-json');\n \n       if (!navigationDoc) {\n         throw new Error(\n-          'Missing navigation map document (docType=\"navigation-json\").' +\n-          'Did you forget to add it to the readFileProcessor?');\n+            'Missing navigation map document (docType=\"navigation-json\").' +\n+            'Did you forget to add it to the readFileProcessor?');\n       }\n \n       // Verify that all the navigation paths are to valid docs\n@@ -24,6 +23,9 @@ module.exports = function processNavigationMap(versionInfo, log) {\n         throw new Error('processNavigationMap failed');\n       }\n \n+      navigationDoc.data['docVersions'] = getPreviousMajorVersions().map(\n+          v => ({title: `v${v.major}`, url: `https://v${v.major}.angular.io/`}));\n+\n       // Add in the version data in a \"secret\" field to be extracted in the docs app\n       navigationDoc.data['__versionInfo'] = versionInfo.currentVersion;\n     }\n@@ -32,13 +34,13 @@ module.exports = function processNavigationMap(versionInfo, log) {\n \n function walk(node, map, path) {\n   let errors = [];\n-  for(const key in node) {\n+  for (const key in node) {\n     const child = node[key];\n-    if (child !== null) { // null is allowed\n+    if (child !== null) {  // null is allowed\n       if (key === 'url') {\n-        const url = child.replace(/#.*$/, ''); // strip hash\n+        const url = child.replace(/#.*$/, '');  // strip hash\n         if (isRelative(url) && !map[url]) {\n-          errors.push({ path: path.join('.'), url });\n+          errors.push({path: path.join('.'), url});\n         }\n       } else if (typeof child !== 'string') {\n         errors = errors.concat(walk(child, map, path.concat([key])));"
        }
    ],
    "stats": {
        "total": 169,
        "additions": 130,
        "deletions": 39
    }
}