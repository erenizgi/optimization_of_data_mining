{
    "author": "alan-agius4",
    "message": "feat(core): add migration for  `XhrFactory` import (#41313)\n\nAutomatically migrates `XhrFactory` from `@angular/common/http` to `@angular/common`.\n\nPR Close #41313",
    "sha": "95ff5ecb239d55a239113b0a2e1f7620f6e34676",
    "files": [
        {
            "sha": "cfd2d6912580c3114378687cc8fd6607d1c6bf90",
            "filename": "packages/core/schematics/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2FBUILD.bazel?ref=95ff5ecb239d55a239113b0a2e1f7620f6e34676",
            "patch": "@@ -28,5 +28,6 @@ pkg_npm(\n         \"//packages/core/schematics/migrations/undecorated-classes-with-decorated-fields\",\n         \"//packages/core/schematics/migrations/undecorated-classes-with-di\",\n         \"//packages/core/schematics/migrations/wait-for-async\",\n+        \"//packages/core/schematics/migrations/xhr-factory\",\n     ],\n )"
        },
        {
            "sha": "66bcf0ec9647ee4d8aaaa0b5e9baa68222375da9",
            "filename": "packages/core/schematics/migrations.json",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "raw_url": "https://github.com/angular/angular/raw/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations.json?ref=95ff5ecb239d55a239113b0a2e1f7620f6e34676",
            "patch": "@@ -89,6 +89,11 @@\n       \"version\": \"12.0.0-beta\",\n       \"description\": \"In Angular version 12, the type of ActivatedRouteSnapshot.fragment is nullable. This migration automatically adds non-null assertions to it.\",\n       \"factory\": \"./migrations/activated-route-snapshot-fragment/index\"\n+    },\n+    \"migration-v12-xhr-factory\": {\n+      \"version\": \"12.0.0-next.6\",\n+      \"description\": \"`XhrFactory` has been moved from `@angular/common/http` to `@angular/common`.\",\n+      \"factory\": \"./migrations/xhr-factory/index\"\n     }\n   }\n }"
        },
        {
            "sha": "570ee390560ed9cd6bfba001464b7ab01f802048",
            "filename": "packages/core/schematics/migrations/xhr-factory/BUILD.bazel",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Fmigrations%2Fxhr-factory%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Fmigrations%2Fxhr-factory%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fxhr-factory%2FBUILD.bazel?ref=95ff5ecb239d55a239113b0a2e1f7620f6e34676",
            "patch": "@@ -0,0 +1,17 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"xhr-factory\",\n+    srcs = glob([\"**/*.ts\"]),\n+    tsconfig = \"//packages/core/schematics:tsconfig.json\",\n+    visibility = [\n+        \"//packages/core/schematics:__pkg__\",\n+        \"//packages/core/schematics/test:__pkg__\",\n+    ],\n+    deps = [\n+        \"//packages/core/schematics/utils\",\n+        \"@npm//@angular-devkit/schematics\",\n+        \"@npm//@types/node\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "968e76e94d358207c3d0eba258558ffd070dde7a",
            "filename": "packages/core/schematics/migrations/xhr-factory/README.md",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Fmigrations%2Fxhr-factory%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Fmigrations%2Fxhr-factory%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fxhr-factory%2FREADME.md?ref=95ff5ecb239d55a239113b0a2e1f7620f6e34676",
            "patch": "@@ -0,0 +1,13 @@\n+## XhrFactory migration\n+\n+Automatically migrates `XhrFactory` from `@angular/common/http` to `@angular/common`.\n+\n+#### Before\n+```ts\n+import { XhrFactory } from '@angular/common/http';\n+```\n+\n+#### After\n+```ts\n+import { XhrFactory } from '@angular/common';\n+```"
        },
        {
            "sha": "db04963e6f21889681d2ef700e42437702c6c0da",
            "filename": "packages/core/schematics/migrations/xhr-factory/index.ts",
            "status": "added",
            "additions": 132,
            "deletions": 0,
            "changes": 132,
            "blob_url": "https://github.com/angular/angular/blob/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Fmigrations%2Fxhr-factory%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Fmigrations%2Fxhr-factory%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fxhr-factory%2Findex.ts?ref=95ff5ecb239d55a239113b0a2e1f7620f6e34676",
            "patch": "@@ -0,0 +1,132 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {DirEntry, Rule, UpdateRecorder} from '@angular-devkit/schematics';\n+import * as ts from 'typescript';\n+import {findImportSpecifier} from '../../utils/typescript/imports';\n+\n+function* visit(directory: DirEntry): IterableIterator<ts.SourceFile> {\n+  for (const path of directory.subfiles) {\n+    if (path.endsWith('.ts') && !path.endsWith('.d.ts')) {\n+      const entry = directory.file(path);\n+      if (entry) {\n+        const content = entry.content;\n+        if (content.includes('XhrFactory')) {\n+          const source = ts.createSourceFile(\n+              entry.path,\n+              content.toString().replace(/^\\uFEFF/, ''),\n+              ts.ScriptTarget.Latest,\n+              true,\n+          );\n+\n+          yield source;\n+        }\n+      }\n+    }\n+  }\n+\n+  for (const path of directory.subdirs) {\n+    if (path === 'node_modules' || path.startsWith('.')) {\n+      continue;\n+    }\n+\n+    yield* visit(directory.dir(path));\n+  }\n+}\n+\n+export default function(): Rule {\n+  return tree => {\n+    const printer = ts.createPrinter({newLine: ts.NewLineKind.LineFeed});\n+\n+    for (const sourceFile of visit(tree.root)) {\n+      let recorder: UpdateRecorder|undefined;\n+\n+      const allImportDeclarations =\n+          sourceFile.statements.filter(n => ts.isImportDeclaration(n)) as ts.ImportDeclaration[];\n+      if (allImportDeclarations.length === 0) {\n+        continue;\n+      }\n+\n+      const httpCommonImport = findImportDeclaration('@angular/common/http', allImportDeclarations);\n+      if (!httpCommonImport) {\n+        continue;\n+      }\n+\n+      const commonHttpNamedBinding = getNamedImports(httpCommonImport);\n+      if (commonHttpNamedBinding) {\n+        const commonHttpNamedImports = commonHttpNamedBinding.elements;\n+        const xhrFactorySpecifier = findImportSpecifier(commonHttpNamedImports, 'XhrFactory');\n+\n+        if (!xhrFactorySpecifier) {\n+          continue;\n+        }\n+\n+        recorder = tree.beginUpdate(sourceFile.fileName);\n+\n+        // Remove 'XhrFactory' from '@angular/common/http'\n+        if (commonHttpNamedImports.length > 1) {\n+          // Remove 'XhrFactory' named import\n+          const index = commonHttpNamedBinding.getStart();\n+          const length = commonHttpNamedBinding.getWidth();\n+\n+          const newImports = printer.printNode(\n+              ts.EmitHint.Unspecified,\n+              ts.factory.updateNamedImports(\n+                  commonHttpNamedBinding,\n+                  commonHttpNamedBinding.elements.filter(e => e !== xhrFactorySpecifier)),\n+              sourceFile);\n+          recorder.remove(index, length).insertLeft(index, newImports);\n+        } else {\n+          // Remove '@angular/common/http' import\n+          const index = httpCommonImport.getFullStart();\n+          const length = httpCommonImport.getFullWidth();\n+          recorder.remove(index, length);\n+        }\n+\n+        // Import XhrFactory from @angular/common\n+        const commonImport = findImportDeclaration('@angular/common', allImportDeclarations);\n+        const commonNamedBinding = getNamedImports(commonImport);\n+        if (commonNamedBinding) {\n+          // Already has an import for '@angular/common', just add the named import.\n+          const index = commonNamedBinding.getStart();\n+          const length = commonNamedBinding.getWidth();\n+          const newImports = printer.printNode(\n+              ts.EmitHint.Unspecified,\n+              ts.factory.updateNamedImports(\n+                  commonNamedBinding, [...commonNamedBinding.elements, xhrFactorySpecifier]),\n+              sourceFile);\n+\n+          recorder.remove(index, length).insertLeft(index, newImports);\n+        } else {\n+          // Add import to '@angular/common'\n+          const index = httpCommonImport.getFullStart();\n+          recorder.insertLeft(index, `\\nimport { XhrFactory } from '@angular/common';`);\n+        }\n+      }\n+\n+      if (recorder) {\n+        tree.commitUpdate(recorder);\n+      }\n+    }\n+  };\n+}\n+\n+function findImportDeclaration(moduleSpecifier: string, importDeclarations: ts.ImportDeclaration[]):\n+    ts.ImportDeclaration|undefined {\n+  return importDeclarations.find(\n+      n => ts.isStringLiteral(n.moduleSpecifier) && n.moduleSpecifier.text === moduleSpecifier);\n+}\n+\n+function getNamedImports(importDeclaration: ts.ImportDeclaration|undefined): ts.NamedImports|\n+    undefined {\n+  const namedBindings = importDeclaration?.importClause?.namedBindings;\n+  if (namedBindings && ts.isNamedImports(namedBindings)) {\n+    return namedBindings;\n+  }\n+\n+  return undefined;\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "135467711d1587ebef52611f39d1ac1ee64fa0d5",
            "filename": "packages/core/schematics/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel?ref=95ff5ecb239d55a239113b0a2e1f7620f6e34676",
            "patch": "@@ -26,6 +26,7 @@ ts_library(\n         \"//packages/core/schematics/migrations/undecorated-classes-with-decorated-fields\",\n         \"//packages/core/schematics/migrations/undecorated-classes-with-di\",\n         \"//packages/core/schematics/migrations/wait-for-async\",\n+        \"//packages/core/schematics/migrations/xhr-factory\",\n         \"//packages/core/schematics/utils\",\n         \"@npm//@angular-devkit/core\",\n         \"@npm//@angular-devkit/schematics\","
        },
        {
            "sha": "ced959648a1e6f751e0763f1cd8520cc358e42f4",
            "filename": "packages/core/schematics/test/xhr_factory_spec.ts",
            "status": "added",
            "additions": 79,
            "deletions": 0,
            "changes": 79,
            "blob_url": "https://github.com/angular/angular/blob/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Ftest%2Fxhr_factory_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Ftest%2Fxhr_factory_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Fxhr_factory_spec.ts?ref=95ff5ecb239d55a239113b0a2e1f7620f6e34676",
            "patch": "@@ -0,0 +1,79 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {tags} from '@angular-devkit/core';\n+import {EmptyTree} from '@angular-devkit/schematics';\n+import {SchematicTestRunner, UnitTestTree} from '@angular-devkit/schematics/testing';\n+\n+describe('XhrFactory migration', () => {\n+  let tree: UnitTestTree;\n+  const runner = new SchematicTestRunner('test', require.resolve('../migrations.json'));\n+\n+  beforeEach(() => {\n+    tree = new UnitTestTree(new EmptyTree());\n+  });\n+\n+  it(`should replace 'XhrFactory' from '@angular/common/http' to '@angular/common'`, async () => {\n+    tree.create('/index.ts', tags.stripIndents`\n+      import { HttpClient } from '@angular/common';\n+      import { HttpErrorResponse, HttpResponse, XhrFactory } from '@angular/common/http';\n+    `);\n+\n+    await runMigration();\n+    expect(tree.readContent('/index.ts')).toBe(tags.stripIndents`\n+      import { HttpClient, XhrFactory } from '@angular/common';\n+      import { HttpErrorResponse, HttpResponse } from '@angular/common/http';\n+    `);\n+  });\n+\n+  it(`should replace import for 'XhrFactory' to '@angular/common'`, async () => {\n+    tree.create('/index.ts', tags.stripIndents`\n+      import { Injecable } from '@angular/core';\n+      import { XhrFactory } from '@angular/common/http';\n+      import { BrowserModule } from '@angular/platform-browser';\n+    `);\n+\n+    await runMigration();\n+    expect(tree.readContent('/index.ts')).toBe(tags.stripIndents`\n+      import { Injecable } from '@angular/core';\n+      import { XhrFactory } from '@angular/common';\n+      import { BrowserModule } from '@angular/platform-browser';\n+    `);\n+  });\n+\n+  it(`should remove http import when 'XhrFactory' is the only imported symbol`, async () => {\n+    tree.create('/index.ts', tags.stripIndents`\n+      import { HttpClient } from '@angular/common';\n+      import { XhrFactory as XhrFactory2 } from '@angular/common/http';\n+      import { Injecable } from '@angular/core';\n+    `);\n+\n+    await runMigration();\n+    expect(tree.readContent('/index.ts')).toBe(tags.stripIndents`\n+      import { HttpClient, XhrFactory as XhrFactory2 } from '@angular/common';\n+      import { Injecable } from '@angular/core';\n+    `);\n+  });\n+\n+  it(`should add named import when '@angular/common' is a namespace import`, async () => {\n+    tree.create('/index.ts', tags.stripIndents`\n+      import * as common from '@angular/common';\n+      import { XhrFactory } from '@angular/common/http';\n+    `);\n+\n+    await runMigration();\n+    expect(tree.readContent('/index.ts')).toBe(tags.stripIndents`\n+      import * as common from '@angular/common';\n+      import { XhrFactory } from '@angular/common';\n+    `);\n+  });\n+\n+  async function runMigration(): Promise<void> {\n+    await runner.runSchematicAsync('migration-v12-xhr-factory', {}, tree).toPromise();\n+  }\n+});"
        },
        {
            "sha": "53930ff133ce93aac63bfd1889538baf543b7516",
            "filename": "packages/core/schematics/tsconfig.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Ftsconfig.json",
            "raw_url": "https://github.com/angular/angular/raw/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftsconfig.json?ref=95ff5ecb239d55a239113b0a2e1f7620f6e34676",
            "patch": "@@ -3,7 +3,9 @@\n     \"noImplicitReturns\": true,\n     \"noFallthroughCasesInSwitch\": true,\n     \"strict\": true,\n-    \"lib\": [\"es2015\"],\n+    \"moduleResolution\": \"node\",\n+    \"target\": \"es2019\",\n+    \"lib\": [\"es2019\"],\n     \"types\": [\"jasmine\"],\n     \"baseUrl\": \".\",\n     \"paths\": {"
        },
        {
            "sha": "bf33f0a2585d6618c79db344fd8f9ee6a3cf89bc",
            "filename": "packages/core/schematics/utils/typescript/imports.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Futils%2Ftypescript%2Fimports.ts",
            "raw_url": "https://github.com/angular/angular/raw/95ff5ecb239d55a239113b0a2e1f7620f6e34676/packages%2Fcore%2Fschematics%2Futils%2Ftypescript%2Fimports.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Futils%2Ftypescript%2Fimports.ts?ref=95ff5ecb239d55a239113b0a2e1f7620f6e34676",
            "patch": "@@ -110,7 +110,7 @@ export function replaceImport(\n \n \n /** Finds an import specifier with a particular name. */\n-function findImportSpecifier(\n+export function findImportSpecifier(\n     nodes: ts.NodeArray<ts.ImportSpecifier>, specifierName: string): ts.ImportSpecifier|undefined {\n   return nodes.find(element => {\n     const {name, propertyName} = element;"
        }
    ],
    "stats": {
        "total": 254,
        "additions": 252,
        "deletions": 2
    }
}