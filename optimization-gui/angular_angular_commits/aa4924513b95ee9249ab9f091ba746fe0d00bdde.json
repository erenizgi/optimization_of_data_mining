{
    "author": "mhevery",
    "message": "refactor(core): Cleanup circular dependency between ViewEngine and Ivy `ElementRef`. (#39621)\n\n`ElementRef` is declared in ViewEngine but it sub-classed in Ivy. This creates a circular\ndependency between ViewEngine `ElementRef` which needs to declare `__NG_ELEMENT_ID__` and\nivy factory which needs to create it. The workaround used to be to pass the `ElementRef`\nthrough stack but that created a very convoluted code. This refactoring simply bundles the\ntwo files together and removes the stack workaround making the code simpler to follow.\n\nPR Close #39621",
    "sha": "aa4924513b95ee9249ab9f091ba746fe0d00bdde",
    "files": [
        {
            "sha": "2998cb1943ba9de94f76decbd25042a94b509b2d",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 45,
            "deletions": 37,
            "changes": 82,
            "blob_url": "https://github.com/angular/angular/blob/aa4924513b95ee9249ab9f091ba746fe0d00bdde/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/aa4924513b95ee9249ab9f091ba746fe0d00bdde/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=aa4924513b95ee9249ab9f091ba746fe0d00bdde",
            "patch": "@@ -159,7 +159,9 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/ng_module_factory.ts\",\n+    \"packages/core/src/linker/element_ref.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -172,8 +174,16 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/ng_module_factory.ts\",\n-    \"packages/core/src/linker/component_factory_resolver.ts\",\n+    \"packages/core/src/linker/element_ref.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\",\n+    \"packages/core/src/metadata.ts\",\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/injectable.ts\",\n+    \"packages/core/src/di/jit/injectable.ts\",\n+    \"packages/core/src/di/jit/environment.ts\",\n+    \"packages/core/src/di/injector_compatibility.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -186,7 +196,10 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/linker/element_ref.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\",\n+    \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/linker/view_ref.ts\"\n   ],\n   [\n@@ -196,7 +209,18 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/linker/element_ref.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\",\n+    \"packages/core/src/render3/interfaces/definition.ts\",\n+    \"packages/core/src/core.ts\",\n+    \"packages/core/src/metadata.ts\",\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/injectable.ts\",\n+    \"packages/core/src/di/jit/injectable.ts\",\n+    \"packages/core/src/di/jit/environment.ts\",\n+    \"packages/core/src/di/injector_compatibility.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -209,6 +233,8 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/linker/element_ref.ts\",\n+    \"packages/core/src/render3/state.ts\",\n     \"packages/core/src/render3/assert.ts\",\n     \"packages/core/src/render3/definition.ts\",\n     \"packages/core/src/metadata/ng_module.ts\"\n@@ -220,10 +246,7 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/render3/assert.ts\",\n-    \"packages/core/src/render3/interfaces/container.ts\",\n-    \"packages/core/src/render3/interfaces/node.ts\",\n-    \"packages/core/src/render3/interfaces/view.ts\",\n+    \"packages/core/src/linker/ng_module_factory.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -236,17 +259,8 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/render3/assert.ts\",\n-    \"packages/core/src/render3/interfaces/container.ts\",\n-    \"packages/core/src/render3/interfaces/node.ts\",\n-    \"packages/core/src/render3/interfaces/view.ts\",\n-    \"packages/core/src/metadata.ts\",\n-    \"packages/core/src/di.ts\",\n-    \"packages/core/src/di/index.ts\",\n-    \"packages/core/src/di/injectable.ts\",\n-    \"packages/core/src/di/jit/injectable.ts\",\n-    \"packages/core/src/di/jit/environment.ts\",\n-    \"packages/core/src/di/injector_compatibility.ts\",\n+    \"packages/core/src/linker/ng_module_factory.ts\",\n+    \"packages/core/src/linker/component_factory_resolver.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -259,19 +273,7 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/render3/assert.ts\",\n-    \"packages/core/src/render3/interfaces/container.ts\",\n-    \"packages/core/src/render3/interfaces/node.ts\",\n-    \"packages/core/src/render3/interfaces/view.ts\",\n-    \"packages/core/src/render3/interfaces/definition.ts\",\n-    \"packages/core/src/core.ts\",\n-    \"packages/core/src/metadata.ts\",\n-    \"packages/core/src/di.ts\",\n-    \"packages/core/src/di/index.ts\",\n-    \"packages/core/src/di/injectable.ts\",\n-    \"packages/core/src/di/jit/injectable.ts\",\n-    \"packages/core/src/di/jit/environment.ts\",\n-    \"packages/core/src/di/injector_compatibility.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -867,7 +869,10 @@\n   [\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/linker/element_ref.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\",\n+    \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/linker/view_ref.ts\"\n   ],\n   [\n@@ -929,6 +934,9 @@\n   ],\n   [\n     \"packages/core/src/linker/element_ref.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\",\n+    \"packages/core/src/render/api.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\"\n   ],\n   [\n@@ -962,12 +970,12 @@\n     \"packages/core/src/render3/jit/pipe.ts\"\n   ],\n   [\n-    \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\"\n+    \"packages/core/src/render3/interfaces/container.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\"\n   ],\n   [\n     \"packages/core/src/render3/interfaces/container.ts\",\n-    \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\"\n   ],\n   ["
        },
        {
            "sha": "eb10908a09a229435aff41d1d935f5343e9e003b",
            "filename": "packages/core/src/linker/element_ref.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 7,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Flinker%2Felement_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Flinker%2Felement_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Felement_ref.ts?ref=aa4924513b95ee9249ab9f091ba746fe0d00bdde",
            "patch": "@@ -6,9 +6,37 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {injectElementRef as render3InjectElementRef} from '../render3/view_engine_compatibility';\n+import {TNode} from '../render3/interfaces/node';\n+import {RElement} from '../render3/interfaces/renderer';\n+import {LView} from '../render3/interfaces/view';\n+import {getCurrentTNode, getLView} from '../render3/state';\n+import {getNativeByTNode} from '../render3/util/view_utils';\n import {noop} from '../util/noop';\n \n+/**\n+ * Creates an ElementRef from the most recent node.\n+ *\n+ * @returns The ElementRef instance to use\n+ */\n+export function injectElementRef(): ElementRef {\n+  return createElementRef(getCurrentTNode()!, getLView());\n+}\n+\n+/**\n+ * Creates an ElementRef given a node.\n+ *\n+ * @param tNode The node for which you'd like an ElementRef\n+ * @param lView The view to which the node belongs\n+ * @returns The ElementRef instance to use\n+ */\n+export function createElementRef(tNode: TNode, lView: LView): ElementRef {\n+  return new ElementRef(getNativeByTNode(tNode, lView) as RElement);\n+}\n+\n+export const SWITCH_ELEMENT_REF_FACTORY__POST_R3__ = injectElementRef;\n+const SWITCH_ELEMENT_REF_FACTORY__PRE_R3__ = noop;\n+const SWITCH_ELEMENT_REF_FACTORY: typeof injectElementRef = SWITCH_ELEMENT_REF_FACTORY__PRE_R3__;\n+\n /**\n  * A wrapper around a native element inside of a View.\n  *\n@@ -56,10 +84,5 @@ export class ElementRef<T = any> {\n    * @internal\n    * @nocollapse\n    */\n-  static __NG_ELEMENT_ID__: () => ElementRef = () => SWITCH_ELEMENT_REF_FACTORY(ElementRef);\n+  static __NG_ELEMENT_ID__: () => ElementRef = SWITCH_ELEMENT_REF_FACTORY;\n }\n-\n-export const SWITCH_ELEMENT_REF_FACTORY__POST_R3__ = render3InjectElementRef;\n-const SWITCH_ELEMENT_REF_FACTORY__PRE_R3__ = noop;\n-const SWITCH_ELEMENT_REF_FACTORY: typeof render3InjectElementRef =\n-    SWITCH_ELEMENT_REF_FACTORY__PRE_R3__;"
        },
        {
            "sha": "d1b99d202795fe9dfc36c62e749d0ddd37bf884c",
            "filename": "packages/core/src/linker/template_ref.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Flinker%2Ftemplate_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Flinker%2Ftemplate_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Ftemplate_ref.ts?ref=aa4924513b95ee9249ab9f091ba746fe0d00bdde",
            "patch": "@@ -60,7 +60,7 @@ export abstract class TemplateRef<C> {\n    * @nocollapse\n    */\n   static __NG_ELEMENT_ID__:\n-      () => TemplateRef<any>| null = () => SWITCH_TEMPLATE_REF_FACTORY(TemplateRef, ElementRef)\n+      () => TemplateRef<any>| null = () => SWITCH_TEMPLATE_REF_FACTORY(TemplateRef)\n }\n \n export const SWITCH_TEMPLATE_REF_FACTORY__POST_R3__ = render3InjectTemplateRef;"
        },
        {
            "sha": "2985353abcff1a48309716ebc8934f1e90756903",
            "filename": "packages/core/src/linker/view_container_ref.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts?ref=aa4924513b95ee9249ab9f091ba746fe0d00bdde",
            "patch": "@@ -149,7 +149,7 @@ export abstract class ViewContainerRef {\n    * @nocollapse\n    */\n   static __NG_ELEMENT_ID__:\n-      () => ViewContainerRef = () => SWITCH_VIEW_CONTAINER_REF_FACTORY(ViewContainerRef, ElementRef)\n+      () => ViewContainerRef = () => SWITCH_VIEW_CONTAINER_REF_FACTORY(ViewContainerRef)\n }\n \n export const SWITCH_VIEW_CONTAINER_REF_FACTORY__POST_R3__ = render3InjectViewContainerRef;"
        },
        {
            "sha": "473a3e83cc483b9d384341504c51d23a445d1585",
            "filename": "packages/core/src/render3/component_ref.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent_ref.ts?ref=aa4924513b95ee9249ab9f091ba746fe0d00bdde",
            "patch": "@@ -13,7 +13,7 @@ import {InjectFlags} from '../di/interface/injector';\n import {Type} from '../interface/type';\n import {ComponentFactory as viewEngine_ComponentFactory, ComponentRef as viewEngine_ComponentRef} from '../linker/component_factory';\n import {ComponentFactoryResolver as viewEngine_ComponentFactoryResolver} from '../linker/component_factory_resolver';\n-import {ElementRef as viewEngine_ElementRef} from '../linker/element_ref';\n+import {createElementRef, ElementRef as viewEngine_ElementRef} from '../linker/element_ref';\n import {NgModuleRef as viewEngine_NgModuleRef} from '../linker/ng_module_factory';\n import {RendererFactory2} from '../render/api';\n import {Sanitizer} from '../sanitization/sanitizer';\n@@ -35,7 +35,6 @@ import {enterView, leaveView} from './state';\n import {setUpAttributes} from './util/attrs_utils';\n import {defaultScheduler} from './util/misc_utils';\n import {getTNode} from './util/view_utils';\n-import {createElementRef} from './view_engine_compatibility';\n import {RootViewRef, ViewRef} from './view_ref';\n \n export class ComponentFactoryResolver extends viewEngine_ComponentFactoryResolver {\n@@ -219,8 +218,8 @@ export class ComponentFactory<T> extends viewEngine_ComponentFactory<T> {\n     }\n \n     return new ComponentRef(\n-        this.componentType, component,\n-        createElementRef(viewEngine_ElementRef, tElementNode, rootLView), rootLView, tElementNode);\n+        this.componentType, component, createElementRef(tElementNode, rootLView), rootLView,\n+        tElementNode);\n   }\n }\n "
        },
        {
            "sha": "695da9ff7b4fbd8efd331616131a91c6cfb2de30",
            "filename": "packages/core/src/render3/query.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts?ref=aa4924513b95ee9249ab9f091ba746fe0d00bdde",
            "patch": "@@ -11,7 +11,7 @@\n \n import {InjectionToken} from '../di/injection_token';\n import {Type} from '../interface/type';\n-import {ElementRef as ViewEngine_ElementRef} from '../linker/element_ref';\n+import {createElementRef, ElementRef as ViewEngine_ElementRef} from '../linker/element_ref';\n import {QueryList} from '../linker/query_list';\n import {TemplateRef as ViewEngine_TemplateRef} from '../linker/template_ref';\n import {ViewContainerRef} from '../linker/view_container_ref';\n@@ -30,7 +30,7 @@ import {DECLARATION_LCONTAINER, LView, PARENT, QUERIES, TVIEW, TView} from './in\n import {assertTNodeType} from './node_assert';\n import {getCurrentQueryIndex, getCurrentTNode, getLView, getTView, setCurrentQueryIndex} from './state';\n import {isCreationMode} from './util/view_utils';\n-import {createContainerRef, createElementRef, createTemplateRef} from './view_engine_compatibility';\n+import {createContainerRef, createTemplateRef} from './view_engine_compatibility';\n \n const unusedValueToPlacateAjd = unused1 + unused2 + unused3 + unused4;\n \n@@ -300,9 +300,9 @@ function getIdxOfMatchingSelector(tNode: TNode, selector: string): number|null {\n \n function createResultByTNodeType(tNode: TNode, currentView: LView): any {\n   if (tNode.type & (TNodeType.AnyRNode | TNodeType.ElementContainer)) {\n-    return createElementRef(ViewEngine_ElementRef, tNode, currentView);\n+    return createElementRef(tNode, currentView);\n   } else if (tNode.type & TNodeType.Container) {\n-    return createTemplateRef(ViewEngine_TemplateRef, ViewEngine_ElementRef, tNode, currentView);\n+    return createTemplateRef(ViewEngine_TemplateRef, tNode, currentView);\n   }\n   return null;\n }\n@@ -323,14 +323,13 @@ function createResultForNode(lView: LView, tNode: TNode, matchingIdx: number, re\n \n function createSpecialToken(lView: LView, tNode: TNode, read: any): any {\n   if (read === ViewEngine_ElementRef) {\n-    return createElementRef(ViewEngine_ElementRef, tNode, lView);\n+    return createElementRef(tNode, lView);\n   } else if (read === ViewEngine_TemplateRef) {\n-    return createTemplateRef(ViewEngine_TemplateRef, ViewEngine_ElementRef, tNode, lView);\n+    return createTemplateRef(ViewEngine_TemplateRef, tNode, lView);\n   } else if (read === ViewContainerRef) {\n     ngDevMode && assertTNodeType(tNode, TNodeType.AnyRNode | TNodeType.AnyContainer);\n     return createContainerRef(\n-        ViewContainerRef, ViewEngine_ElementRef,\n-        tNode as TElementNode | TContainerNode | TElementContainerNode, lView);\n+        ViewContainerRef, tNode as TElementNode | TContainerNode | TElementContainerNode, lView);\n   } else {\n     ngDevMode &&\n         throwError("
        },
        {
            "sha": "e4c9a60fd93852edb32d071176dea342eb403c77",
            "filename": "packages/core/src/render3/view_engine_compatibility.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 44,
            "changes": 55,
            "blob_url": "https://github.com/angular/angular/blob/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts?ref=aa4924513b95ee9249ab9f091ba746fe0d00bdde",
            "patch": "@@ -9,7 +9,7 @@\n import {ChangeDetectorRef as ViewEngine_ChangeDetectorRef} from '../change_detection/change_detector_ref';\n import {Injector} from '../di/injector';\n import {ComponentFactory as viewEngine_ComponentFactory, ComponentRef as viewEngine_ComponentRef} from '../linker/component_factory';\n-import {ElementRef as ViewEngine_ElementRef} from '../linker/element_ref';\n+import {createElementRef, ElementRef as ViewEngine_ElementRef} from '../linker/element_ref';\n import {NgModuleRef as viewEngine_NgModuleRef} from '../linker/ng_module_factory';\n import {TemplateRef as ViewEngine_TemplateRef} from '../linker/template_ref';\n import {ViewContainerRef as ViewEngine_ViewContainerRef} from '../linker/view_container_ref';\n@@ -36,35 +36,6 @@ import {ViewRef} from './view_ref';\n \n \n \n-/**\n- * Creates an ElementRef from the most recent node.\n- *\n- * @returns The ElementRef instance to use\n- */\n-export function injectElementRef(ElementRefToken: typeof ViewEngine_ElementRef):\n-    ViewEngine_ElementRef {\n-  return createElementRef(ElementRefToken, getCurrentTNode()!, getLView());\n-}\n-\n-let R3ElementRef: {new (native: RElement|RComment): ViewEngine_ElementRef};\n-\n-/**\n- * Creates an ElementRef given a node.\n- *\n- * @param ElementRefToken The ElementRef type\n- * @param tNode The node for which you'd like an ElementRef\n- * @param view The view to which the node belongs\n- * @returns The ElementRef instance to use\n- */\n-export function createElementRef(\n-    ElementRefToken: typeof ViewEngine_ElementRef, tNode: TNode,\n-    view: LView): ViewEngine_ElementRef {\n-  if (!R3ElementRef) {\n-    R3ElementRef = class ElementRef extends ElementRefToken {};\n-  }\n-  return new R3ElementRef(getNativeByTNode(tNode, view) as RElement);\n-}\n-\n let R3TemplateRef: {\n   new (_declarationParentView: LView, hostTNode: TContainerNode, elementRef: ViewEngine_ElementRef):\n       ViewEngine_TemplateRef<any>\n@@ -75,10 +46,9 @@ let R3TemplateRef: {\n  *\n  * @returns The TemplateRef instance to use\n  */\n-export function injectTemplateRef<T>(\n-    TemplateRefToken: typeof ViewEngine_TemplateRef,\n-    ElementRefToken: typeof ViewEngine_ElementRef): ViewEngine_TemplateRef<T>|null {\n-  return createTemplateRef<T>(TemplateRefToken, ElementRefToken, getCurrentTNode()!, getLView());\n+export function injectTemplateRef<T>(TemplateRefToken: typeof ViewEngine_TemplateRef):\n+    ViewEngine_TemplateRef<T>|null {\n+  return createTemplateRef<T>(TemplateRefToken, getCurrentTNode()!, getLView());\n }\n \n /**\n@@ -91,8 +61,8 @@ export function injectTemplateRef<T>(\n  * @returns The TemplateRef instance or null if we can't create a TemplateRef on a given node type\n  */\n export function createTemplateRef<T>(\n-    TemplateRefToken: typeof ViewEngine_TemplateRef, ElementRefToken: typeof ViewEngine_ElementRef,\n-    hostTNode: TNode, hostView: LView): ViewEngine_TemplateRef<T>|null {\n+    TemplateRefToken: typeof ViewEngine_TemplateRef, hostTNode: TNode,\n+    hostView: LView): ViewEngine_TemplateRef<T>|null {\n   if (!R3TemplateRef) {\n     R3TemplateRef = class TemplateRef<T> extends TemplateRefToken<T>{\n       constructor(\n@@ -126,8 +96,7 @@ export function createTemplateRef<T>(\n   if (hostTNode.type & TNodeType.Container) {\n     ngDevMode && assertDefined(hostTNode.tViews, 'TView must be allocated');\n     return new R3TemplateRef(\n-        hostView, hostTNode as TContainerNode,\n-        createElementRef(ElementRefToken, hostTNode, hostView));\n+        hostView, hostTNode as TContainerNode, createElementRef(hostTNode, hostView));\n   } else {\n     return null;\n   }\n@@ -145,11 +114,10 @@ let R3ViewContainerRef: {\n  *\n  * @returns The ViewContainerRef instance to use\n  */\n-export function injectViewContainerRef(\n-    ViewContainerRefToken: typeof ViewEngine_ViewContainerRef,\n-    ElementRefToken: typeof ViewEngine_ElementRef): ViewEngine_ViewContainerRef {\n+export function injectViewContainerRef(ViewContainerRefToken: typeof ViewEngine_ViewContainerRef):\n+    ViewEngine_ViewContainerRef {\n   const previousTNode = getCurrentTNode() as TElementNode | TElementContainerNode | TContainerNode;\n-  return createContainerRef(ViewContainerRefToken, ElementRefToken, previousTNode, getLView());\n+  return createContainerRef(ViewContainerRefToken, previousTNode, getLView());\n }\n \n /**\n@@ -163,7 +131,6 @@ export function injectViewContainerRef(\n  */\n export function createContainerRef(\n     ViewContainerRefToken: typeof ViewEngine_ViewContainerRef,\n-    ElementRefToken: typeof ViewEngine_ElementRef,\n     hostTNode: TElementNode|TContainerNode|TElementContainerNode,\n     hostView: LView): ViewEngine_ViewContainerRef {\n   if (!R3ViewContainerRef) {\n@@ -176,7 +143,7 @@ export function createContainerRef(\n       }\n \n       get element(): ViewEngine_ElementRef {\n-        return createElementRef(ElementRefToken, this._hostTNode, this._hostView);\n+        return createElementRef(this._hostTNode, this._hostView);\n       }\n \n       get injector(): Injector {"
        },
        {
            "sha": "1234835af9a60dd7bed1d827e2b0cfa104c2c8a7",
            "filename": "packages/core/src/render3/view_engine_compatibility_prebound.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility_prebound.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility_prebound.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility_prebound.ts?ref=aa4924513b95ee9249ab9f091ba746fe0d00bdde",
            "patch": "@@ -9,24 +9,21 @@\n \n import {ChangeDetectorRef} from '../change_detection/change_detector_ref';\n import {InjectFlags} from '../di/interface/injector';\n-import {ElementRef as ViewEngine_ElementRef} from '../linker/element_ref';\n import {TemplateRef as ViewEngine_TemplateRef} from '../linker/template_ref';\n import {throwProviderNotFoundError} from './errors';\n-\n import {TNode} from './interfaces/node';\n import {LView} from './interfaces/view';\n import {createTemplateRef, injectChangeDetectorRef} from './view_engine_compatibility';\n \n \n-\n /**\n  * Retrieves `TemplateRef` instance from `Injector` when a local reference is placed on the\n  * `<ng-template>` element.\n  *\n  * @codeGenApi\n  */\n export function ɵɵtemplateRefExtractor(tNode: TNode, currentView: LView) {\n-  return createTemplateRef(ViewEngine_TemplateRef, ViewEngine_ElementRef, tNode, currentView);\n+  return createTemplateRef(ViewEngine_TemplateRef, tNode, currentView);\n }\n \n "
        },
        {
            "sha": "eaedacf8a71fd94b7fcc17f2ab75f185fd8443bf",
            "filename": "packages/core/test/render3/perf/ng_template/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fng_template%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fng_template%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fng_template%2Findex.ts?ref=aa4924513b95ee9249ab9f091ba746fe0d00bdde",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {ElementRef, TemplateRef, ViewContainerRef} from '../../../../src/linker';\n+import {TemplateRef, ViewContainerRef} from '../../../../src/linker';\n import {ɵɵdefineDirective, ɵɵdirectiveInject, ɵɵtemplate} from '../../../../src/render3/index';\n import {createLView, createTNode, createTView} from '../../../../src/render3/instructions/shared';\n import {RenderFlags} from '../../../../src/render3/interfaces/definition';\n@@ -21,7 +21,7 @@ class TemplateRefToken {\n    * @nocollapse\n    */\n   static __NG_ELEMENT_ID__(): TemplateRef<any>|null {\n-    return injectTemplateRef(TemplateRef, ElementRef);\n+    return injectTemplateRef(TemplateRef);\n   }\n }\n class ViewContainerRefToken {\n@@ -30,7 +30,7 @@ class ViewContainerRefToken {\n    * @nocollapse\n    */\n   static __NG_ELEMENT_ID__(): ViewContainerRef {\n-    return injectViewContainerRef(ViewContainerRef, ElementRef);\n+    return injectViewContainerRef(ViewContainerRef);\n   }\n }\n "
        },
        {
            "sha": "bb6c0f0533cf46660b0cf45b551c3b9aa6766e6d",
            "filename": "packages/core/test/render3/render_util.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Ftest%2Frender3%2Frender_util.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa4924513b95ee9249ab9f091ba746fe0d00bdde/packages%2Fcore%2Ftest%2Frender3%2Frender_util.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Frender_util.ts?ref=aa4924513b95ee9249ab9f091ba746fe0d00bdde",
            "patch": "@@ -32,7 +32,7 @@ import {ComponentDef, ComponentTemplate, ComponentType, DirectiveDef, DirectiveT\n import {DirectiveDefList, DirectiveDefListOrFactory, DirectiveTypesOrFactory, HostBindingsFunction, PipeDef, PipeDefList, PipeDefListOrFactory, PipeTypesOrFactory} from '../../src/render3/interfaces/definition';\n import {PlayerHandler} from '../../src/render3/interfaces/player';\n import {domRendererFactory3, ProceduralRenderer3, RComment, RElement, Renderer3, RendererFactory3, RendererStyleFlags3, RNode, RText} from '../../src/render3/interfaces/renderer';\n-import {HEADER_OFFSET, LView, LViewFlags, TVIEW, TViewType} from '../../src/render3/interfaces/view';\n+import {LView, LViewFlags, TVIEW, TViewType} from '../../src/render3/interfaces/view';\n import {destroyLView} from '../../src/render3/node_manipulation';\n import {getRootView} from '../../src/render3/util/view_traversal_utils';\n import {Sanitizer} from '../../src/sanitization/sanitizer';\n@@ -452,10 +452,9 @@ export const text: RText = null as any as Text;\n  *  like injectElementRef() prematurely.\n  */\n export function enableIvyInjectableFactories() {\n-  (ElementRef as any)[NG_ELEMENT_ID] = () => R3_ELEMENT_REF_FACTORY(ElementRef);\n-  (TemplateRef as any)[NG_ELEMENT_ID] = () => R3_TEMPLATE_REF_FACTORY(TemplateRef, ElementRef);\n-  (ViewContainerRef as any)[NG_ELEMENT_ID] = () =>\n-      R3_VIEW_CONTAINER_REF_FACTORY(ViewContainerRef, ElementRef);\n+  (ElementRef as any)[NG_ELEMENT_ID] = () => R3_ELEMENT_REF_FACTORY();\n+  (TemplateRef as any)[NG_ELEMENT_ID] = () => R3_TEMPLATE_REF_FACTORY(TemplateRef);\n+  (ViewContainerRef as any)[NG_ELEMENT_ID] = () => R3_VIEW_CONTAINER_REF_FACTORY(ViewContainerRef);\n   (ChangeDetectorRef as any)[NG_ELEMENT_ID] = () => R3_CHANGE_DETECTOR_REF_FACTORY();\n   (Renderer2 as any)[NG_ELEMENT_ID] = () => R3_RENDERER2_FACTORY();\n }"
        }
    ],
    "stats": {
        "total": 220,
        "additions": 106,
        "deletions": 114
    }
}