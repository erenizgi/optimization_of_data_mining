{
    "author": "atscott",
    "message": "fix(language-service): provide element completions after open tag < (#41068)\n\nAn opening tag `<` without any characters after it is interperted as a\ntext node (just a \"less than\" character) rather than the start of an\nelement in the template AST. This commit adjusts the autocomplete engine\nto provide element autocompletions when the nearest character to the\nleft of the cursor is `<`.\n\nPart of the fix for angular/vscode-ng-language-service#1140\n\nPR Close #41068",
    "sha": "1e3c870ee6028b312955fc908807e82a47111a04",
    "files": [
        {
            "sha": "069348950f9b49e1d2b38e49f2885b91ba582398",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 60,
            "deletions": 17,
            "changes": 77,
            "blob_url": "https://github.com/angular/angular/blob/1e3c870ee6028b312955fc908807e82a47111a04/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/1e3c870ee6028b312955fc908807e82a47111a04/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=1e3c870ee6028b312955fc908807e82a47111a04",
            "patch": "@@ -6,14 +6,15 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, BindingPipe, EmptyExpr, ImplicitReceiver, LiteralPrimitive, MethodCall, ParseSourceSpan, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n+import {AST, BindingPipe, EmptyExpr, ImplicitReceiver, LiteralPrimitive, MethodCall, ParseSourceSpan, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstText, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {CompletionKind, DirectiveInScope, TemplateDeclarationSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import {BoundEvent} from '@angular/compiler/src/render3/r3_ast';\n import * as ts from 'typescript';\n \n import {addAttributeCompletionEntries, AttributeCompletionKind, buildAttributeCompletionTable, getAttributeCompletionSymbol} from './attribute_completions';\n import {DisplayInfo, DisplayInfoKind, getDirectiveDisplayInfo, getSymbolDisplayInfo, getTsSymbolDisplayInfo, unsafeCastDisplayInfoKindToScriptElementKind} from './display_parts';\n+import {TargetContext, TargetNodeKind, TemplateTarget} from './template_target';\n import {filterAliasImports} from './utils';\n \n type PropertyExpressionCompletionBuilder =\n@@ -48,13 +49,15 @@ export enum CompletionNodeContext {\n export class CompletionBuilder<N extends TmplAstNode|AST> {\n   private readonly typeChecker = this.compiler.getNextProgram().getTypeChecker();\n   private readonly templateTypeChecker = this.compiler.getTemplateTypeChecker();\n+  private readonly nodeParent = this.targetDetails.parent;\n+  private readonly nodeContext = nodeContextFromTarget(this.targetDetails.context);\n+  private readonly template = this.targetDetails.template;\n+  private readonly position = this.targetDetails.position;\n \n   constructor(\n       private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler,\n       private readonly component: ts.ClassDeclaration, private readonly node: N,\n-      private readonly nodeContext: CompletionNodeContext,\n-      private readonly nodeParent: TmplAstNode|AST|null,\n-      private readonly template: TmplAstTemplate|null) {}\n+      private readonly targetDetails: TemplateTarget) {}\n \n   /**\n    * Analogue for `ts.LanguageService.getCompletionsAtPosition`.\n@@ -335,20 +338,37 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     }\n   }\n \n-  private isElementTagCompletion(): this is CompletionBuilder<TmplAstElement> {\n-    return this.node instanceof TmplAstElement &&\n-        this.nodeContext === CompletionNodeContext.ElementTag;\n+  private isElementTagCompletion(): this is CompletionBuilder<TmplAstElement|TmplAstText> {\n+    if (this.node instanceof TmplAstText) {\n+      const positionInTextNode = this.position - this.node.sourceSpan.start.offset;\n+      // We only provide element completions in a text node when there is an open tag immediately to\n+      // the left of the position.\n+      return this.node.value.substring(0, positionInTextNode).endsWith('<');\n+    } else if (this.node instanceof TmplAstElement) {\n+      return this.nodeContext === CompletionNodeContext.ElementTag;\n+    }\n+    return false;\n   }\n \n-  private getElementTagCompletion(this: CompletionBuilder<TmplAstElement>):\n+  private getElementTagCompletion(this: CompletionBuilder<TmplAstElement|TmplAstText>):\n       ts.WithMetadata<ts.CompletionInfo>|undefined {\n     const templateTypeChecker = this.compiler.getTemplateTypeChecker();\n \n-    // The replacementSpan is the tag name.\n-    const replacementSpan: ts.TextSpan = {\n-      start: this.node.sourceSpan.start.offset + 1,  // account for leading '<'\n-      length: this.node.name.length,\n-    };\n+    let start: number;\n+    let length: number;\n+    if (this.node instanceof TmplAstElement) {\n+      // The replacementSpan is the tag name.\n+      start = this.node.sourceSpan.start.offset + 1;  // account for leading '<'\n+      length = this.node.name.length;\n+    } else {\n+      const positionInTextNode = this.position - this.node.sourceSpan.start.offset;\n+      const textToLeftOfPosition = this.node.value.substring(0, positionInTextNode);\n+      start = this.node.sourceSpan.start.offset + textToLeftOfPosition.lastIndexOf('<') + 1;\n+      // We only autocomplete immediately after the < so we don't replace any existing text\n+      length = 0;\n+    }\n+\n+    const replacementSpan: ts.TextSpan = {start, length};\n \n     const entries: ts.CompletionEntry[] =\n         Array.from(templateTypeChecker.getPotentialElementTags(this.component))\n@@ -368,8 +388,8 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n   }\n \n   private getElementTagCompletionDetails(\n-      this: CompletionBuilder<TmplAstElement>, entryName: string): ts.CompletionEntryDetails\n-      |undefined {\n+      this: CompletionBuilder<TmplAstElement|TmplAstText>,\n+      entryName: string): ts.CompletionEntryDetails|undefined {\n     const templateTypeChecker = this.compiler.getTemplateTypeChecker();\n \n     const tagMap = templateTypeChecker.getPotentialElementTags(this.component);\n@@ -397,8 +417,8 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     };\n   }\n \n-  private getElementTagCompletionSymbol(this: CompletionBuilder<TmplAstElement>, entryName: string):\n-      ts.Symbol|undefined {\n+  private getElementTagCompletionSymbol(\n+      this: CompletionBuilder<TmplAstElement|TmplAstText>, entryName: string): ts.Symbol|undefined {\n     const templateTypeChecker = this.compiler.getTemplateTypeChecker();\n \n     const tagMap = templateTypeChecker.getPotentialElementTags(this.component);\n@@ -664,3 +684,26 @@ function stripBindingSugar(binding: string): {name: string, kind: DisplayInfoKin\n     return {name, kind: DisplayInfoKind.ATTRIBUTE};\n   }\n }\n+\n+function nodeContextFromTarget(target: TargetContext): CompletionNodeContext {\n+  switch (target.kind) {\n+    case TargetNodeKind.ElementInTagContext:\n+      return CompletionNodeContext.ElementTag;\n+    case TargetNodeKind.ElementInBodyContext:\n+      // Completions in element bodies are for new attributes.\n+      return CompletionNodeContext.ElementAttributeKey;\n+    case TargetNodeKind.TwoWayBindingContext:\n+      return CompletionNodeContext.TwoWayBinding;\n+    case TargetNodeKind.AttributeInKeyContext:\n+      return CompletionNodeContext.ElementAttributeKey;\n+    case TargetNodeKind.AttributeInValueContext:\n+      if (target.node instanceof TmplAstBoundEvent) {\n+        return CompletionNodeContext.EventValue;\n+      } else {\n+        return CompletionNodeContext.None;\n+      }\n+    default:\n+      // No special context is available.\n+      return CompletionNodeContext.None;\n+  }\n+}"
        },
        {
            "sha": "9c367c48227bc3df6a394153f79843274bf088f2",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 26,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/1e3c870ee6028b312955fc908807e82a47111a04/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/1e3c870ee6028b312955fc908807e82a47111a04/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=1e3c870ee6028b312955fc908807e82a47111a04",
            "patch": "@@ -180,9 +180,7 @@ export class LanguageService {\n         positionDetails.context.nodes[0] :\n         positionDetails.context.node;\n     return new CompletionBuilder(\n-        this.tsLS, compiler, templateInfo.component, node,\n-        nodeContextFromTarget(positionDetails.context), positionDetails.parent,\n-        positionDetails.template);\n+        this.tsLS, compiler, templateInfo.component, node, positionDetails);\n   }\n \n   getCompletionsAtPosition(\n@@ -450,29 +448,6 @@ function getOrCreateTypeCheckScriptInfo(\n   return scriptInfo;\n }\n \n-function nodeContextFromTarget(target: TargetContext): CompletionNodeContext {\n-  switch (target.kind) {\n-    case TargetNodeKind.ElementInTagContext:\n-      return CompletionNodeContext.ElementTag;\n-    case TargetNodeKind.ElementInBodyContext:\n-      // Completions in element bodies are for new attributes.\n-      return CompletionNodeContext.ElementAttributeKey;\n-    case TargetNodeKind.TwoWayBindingContext:\n-      return CompletionNodeContext.TwoWayBinding;\n-    case TargetNodeKind.AttributeInKeyContext:\n-      return CompletionNodeContext.ElementAttributeKey;\n-    case TargetNodeKind.AttributeInValueContext:\n-      if (target.node instanceof TmplAstBoundEvent) {\n-        return CompletionNodeContext.EventValue;\n-      } else {\n-        return CompletionNodeContext.None;\n-      }\n-    default:\n-      // No special context is available.\n-      return CompletionNodeContext.None;\n-  }\n-}\n-\n function isTemplateContext(program: ts.Program, fileName: string, position: number): boolean {\n   if (!isTypeScriptFile(fileName)) {\n     // If we aren't in a TS file, we must be in an HTML file, which we treat as template context"
        },
        {
            "sha": "eac4d9816eb113f9d82cdc4752131a724b7b36f2",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/1e3c870ee6028b312955fc908807e82a47111a04/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1e3c870ee6028b312955fc908807e82a47111a04/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=1e3c870ee6028b312955fc908807e82a47111a04",
            "patch": "@@ -353,6 +353,52 @@ describe('completions', () => {\n       expect(ts.displayPartsToString(details.documentation!)).toEqual('This is another component.');\n     });\n \n+    it('should return completions with a blank open tag', () => {\n+      const OTHER_CMP = {\n+        'OtherCmp': `\n+            @Component({selector: 'other-cmp', template: 'unimportant'})\n+            export class OtherCmp {}\n+          `,\n+      };\n+      const {templateFile} = setup(`<`, '', OTHER_CMP);\n+      templateFile.moveCursorToText('<¦');\n+\n+      const completions = templateFile.getCompletionsAtPosition();\n+      expectContain(\n+          completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.COMPONENT),\n+          ['other-cmp']);\n+    });\n+\n+    it('should return completions with a blank open tag a character before', () => {\n+      const OTHER_CMP = {\n+        'OtherCmp': `\n+            @Component({selector: 'other-cmp', template: 'unimportant'})\n+            export class OtherCmp {}\n+          `,\n+      };\n+      const {templateFile} = setup(`a <`, '', OTHER_CMP);\n+      templateFile.moveCursorToText('a <¦');\n+\n+      const completions = templateFile.getCompletionsAtPosition();\n+      expectContain(\n+          completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.COMPONENT),\n+          ['other-cmp']);\n+    });\n+\n+    it('should not return completions when cursor is not after the open tag', () => {\n+      const OTHER_CMP = {\n+        'OtherCmp': `\n+            @Component({selector: 'other-cmp', template: 'unimportant'})\n+            export class OtherCmp {}\n+          `,\n+      };\n+      const {templateFile} = setup(`\\n\\n<         `, '', OTHER_CMP);\n+      templateFile.moveCursorToText('< ¦');\n+\n+      const completions = templateFile.getCompletionsAtPosition();\n+      expect(completions).toBeUndefined();\n+    });\n+\n     describe('element attribute scope', () => {\n       describe('dom completions', () => {\n         it('should return completions for a new element attribute', () => {"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 107,
        "deletions": 43
    }
}