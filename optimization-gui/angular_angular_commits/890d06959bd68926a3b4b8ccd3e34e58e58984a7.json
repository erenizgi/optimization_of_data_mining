{
    "author": "devversion",
    "message": "test: update ngtsc specs to work with es2015 output (#44505)\n\nUpdates the ngtsc specs to work with ES2015 output.\n\nPR Close #44505",
    "sha": "890d06959bd68926a3b4b8ccd3e34e58e58984a7",
    "files": [
        {
            "sha": "6a68184dfb4897a46bdde930e3ec7f2ceb3659de",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 29,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/890d06959bd68926a3b4b8ccd3e34e58e58984a7/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/890d06959bd68926a3b4b8ccd3e34e58e58984a7/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=890d06959bd68926a3b4b8ccd3e34e58e58984a7",
            "patch": "@@ -19,7 +19,7 @@ import {NgtscTestEnvironment} from './env';\n \n const trim = (input: string): string => input.replace(/\\s+/g, ' ').trim();\n \n-const varRegExp = (name: string): RegExp => new RegExp(`var \\\\w+ = \\\\[\\\"${name}\\\"\\\\];`);\n+const varRegExp = (name: string): RegExp => new RegExp(`const \\\\w+ = \\\\[\\\"${name}\\\"\\\\];`);\n \n const viewQueryRegExp = (predicate: string, flags: number, ref?: string): RegExp => {\n   const maybeRef = ref ? `, ${ref}` : ``;\n@@ -162,8 +162,7 @@ function allTests(os: string) {\n \n       const jsContents = env.getContents('test.js');\n       expect(jsContents).toContain('Service.ɵprov =');\n-      expect(jsContents)\n-          .toContain('factory: function () { return (function () { return new Service(); })(); }');\n+      expect(jsContents).toContain('factory: function () { return (() => new Service())(); }');\n       expect(jsContents).toContain('Service_Factory(t) { return new (t || Service)(); }');\n       expect(jsContents).toContain(', providedIn: \\'root\\' });');\n       expect(jsContents).not.toContain('__decorate');\n@@ -190,10 +189,9 @@ function allTests(os: string) {\n \n       const jsContents = env.getContents('test.js');\n       expect(jsContents).toContain('Service.ɵprov =');\n-      expect(jsContents).toContain('factory: function Service_Factory(t) { var r = null; if (t) {');\n+      expect(jsContents).toContain('factory: function Service_Factory(t) { let r = null; if (t) {');\n       expect(jsContents).toContain('return new (t || Service)(i0.ɵɵinject(Dep));');\n-      expect(jsContents)\n-          .toContain('r = (function (dep) { return new Service(dep); })(i0.ɵɵinject(Dep));');\n+      expect(jsContents).toContain('r = ((dep) => new Service(dep))(i0.ɵɵinject(Dep));');\n       expect(jsContents).toContain('return r; }, providedIn: \\'root\\' });');\n       expect(jsContents).not.toContain('__decorate');\n       const dtsContents = env.getContents('test.d.ts');\n@@ -224,10 +222,9 @@ function allTests(os: string) {\n          const jsContents = env.getContents('test.js');\n          expect(jsContents).toContain('Service.ɵprov =');\n          expect(jsContents)\n-             .toContain('factory: function Service_Factory(t) { var r = null; if (t) {');\n+             .toContain('factory: function Service_Factory(t) { let r = null; if (t) {');\n          expect(jsContents).toContain('return new (t || Service)(i0.ɵɵinject(Dep));');\n-         expect(jsContents)\n-             .toContain('r = (function (dep) { return new Service(dep); })(i0.ɵɵinject(Dep, 10));');\n+         expect(jsContents).toContain('r = ((dep) => new Service(dep))(i0.ɵɵinject(Dep, 10));');\n          expect(jsContents).toContain(`return r; }, providedIn: 'root' });`);\n          expect(jsContents).not.toContain('__decorate');\n          const dtsContents = env.getContents('test.d.ts');\n@@ -612,21 +609,19 @@ function allTests(os: string) {\n             expect(trim(jsContents)).toContain(trim(`\n               [{\n                   provide: 'token-a',\n-                  useFactory: (function (service) {\n+                  useFactory: ((service) => {\n                       return (/**\n                       * @return {?}\n                       */\n-                      function () { return service.id; });\n+                      () => service.id);\n                   })\n               }, {\n                   provide: 'token-b',\n                   useFactory: (function (service) {\n                       return (/**\n                       * @return {?}\n                       */\n-                      function () {\n-                          return service.id;\n-                      });\n+                      function () { return service.id; });\n                   })\n               }]\n             `));\n@@ -1392,7 +1387,7 @@ function allTests(os: string) {\n       expect(jsContents)\n           .toContain(\n               `TestModule.ɵinj = /*@__PURE__*/ i0.ɵɵdefineInjector({ ` +\n-              `providers: [{ provide: Token, useFactory: function () { return new Token(); } }], ` +\n+              `providers: [{ provide: Token, useFactory: () => new Token() }], ` +\n               `imports: [[OtherModule]] });`);\n \n       const dtsContents = env.getContents('test.d.ts');\n@@ -1439,7 +1434,7 @@ function allTests(os: string) {\n       expect(jsContents)\n           .toContain(\n               `TestModule.ɵinj = /*@__PURE__*/ i0.ɵɵdefineInjector({ ` +\n-              `providers: [{ provide: Token, useFactory: function (dep) { return new Token(dep); }, deps: [Dep] }], ` +\n+              `providers: [{ provide: Token, useFactory: (dep) => new Token(dep), deps: [Dep] }], ` +\n               `imports: [[OtherModule]] });`);\n \n       const dtsContents = env.getContents('test.d.ts');\n@@ -3783,7 +3778,7 @@ function allTests(os: string) {\n       const jsContents = env.getContents('test.js');\n       expect(jsContents)\n           .toContain(\n-              '\":\\\\u241F5dbba0a3da8dff890e20cf76eb075d58900fbcd3\\\\u241F8321000940098097247:Some text\"');\n+              '`:\\u241F5dbba0a3da8dff890e20cf76eb075d58900fbcd3\\u241F8321000940098097247:Some text`');\n     });\n \n     it('should render custom id and legacy ids if `enableI18nLegacyMessageIdFormat` is not false',\n@@ -3800,7 +3795,7 @@ function allTests(os: string) {\n          const jsContents = env.getContents('test.js');\n          expect(jsContents)\n              .toContain(\n-                 ':@@custom\\\\u241F5dbba0a3da8dff890e20cf76eb075d58900fbcd3\\\\u241F8321000940098097247:Some text');\n+                 ':@@custom\\u241F5dbba0a3da8dff890e20cf76eb075d58900fbcd3\\u241F8321000940098097247:Some text');\n        });\n \n     it('should not render legacy ids when `enableI18nLegacyMessageIdFormat` is set to false',\n@@ -3835,10 +3830,10 @@ function allTests(os: string) {\n       const jsContents = env.getContents('test.js');\n       expect(jsContents)\n           .toContain(\n-              ':\\\\u241F720ba589d043a0497ac721ff972f41db0c919efb\\\\u241F3221232817843005870:{VAR_PLURAL, plural, 10 {ten} other {other}}');\n+              ':\\u241F720ba589d043a0497ac721ff972f41db0c919efb\\u241F3221232817843005870:{VAR_PLURAL, plural, 10 {ten} other {other}}');\n       expect(jsContents)\n           .toContain(\n-              ':@@custom\\\\u241Fdcb6170595f5d548a3d00937e87d11858f51ad04\\\\u241F7419139165339437596:Some text');\n+              ':@@custom\\u241Fdcb6170595f5d548a3d00937e87d11858f51ad04\\u241F7419139165339437596:Some text');\n     });\n \n     it('@Component\\'s `interpolation` should override default interpolation config', () => {\n@@ -4034,14 +4029,14 @@ function allTests(os: string) {\n       expect(factoryContents).toContain(`import { NotAModule, TestModule } from './test';`);\n       expect(factoryContents)\n           .toContain(\n-              'export var TestModuleNgFactory = i0.\\u0275noSideEffects(function () { ' +\n+              'export const TestModuleNgFactory = i0.\\u0275noSideEffects(function () { ' +\n               'return new i0.\\u0275NgModuleFactory(TestModule); });');\n       expect(factoryContents).not.toContain(`NotAModuleNgFactory`);\n       expect(factoryContents).not.toContain('\\u0275NonEmptyModule');\n \n       const emptyFactory = env.getContents('empty.ngfactory.js');\n       expect(emptyFactory).toContain(`import * as i0 from '@angular/core';`);\n-      expect(emptyFactory).toContain(`export var \\u0275NonEmptyModule = true;`);\n+      expect(emptyFactory).toContain(`export const \\u0275NonEmptyModule = true;`);\n     });\n \n     describe('ngfactory shims', () => {\n@@ -4179,7 +4174,7 @@ function allTests(os: string) {\n             .toBe(\n                 'import * as i0 from \"./r3_symbols\";\\n' +\n                 'import { TestModule } from \\'./test\\';\\n' +\n-                'export var TestModuleNgFactory = i0.\\u0275noSideEffects(function () {' +\n+                'export const TestModuleNgFactory = i0.\\u0275noSideEffects(function () {' +\n                 ' return new i0.NgModuleFactory(TestModule); });\\n');\n       });\n \n@@ -4200,7 +4195,7 @@ function allTests(os: string) {\n         // Should **not** contain noSideEffects(), because the module is lazy loaded.\n         const factoryContents = env.getContents('test.ngfactory.js');\n         expect(factoryContents)\n-            .toContain('export var TestModuleNgFactory = new i0.ɵNgModuleFactory(TestModule);');\n+            .toContain('export const TestModuleNgFactory = new i0.ɵNgModuleFactory(TestModule);');\n       });\n \n       describe('file-level comments', () => {\n@@ -4265,7 +4260,7 @@ function allTests(os: string) {\n         env.driveMain();\n \n         const summaryContents = env.getContents('test.ngsummary.js');\n-        expect(summaryContents).toEqual(`export var TestModuleNgSummary = null;\\n`);\n+        expect(summaryContents).toEqual(`export const TestModuleNgSummary = null;\\n`);\n       });\n \n       it('should generate a summary stub for classes exported via exports', () => {\n@@ -4281,7 +4276,7 @@ function allTests(os: string) {\n         env.driveMain();\n \n         const summaryContents = env.getContents('test.ngsummary.js');\n-        expect(summaryContents).toEqual(`export var NotDirectlyExportedNgSummary = null;\\n`);\n+        expect(summaryContents).toEqual(`export const NotDirectlyExportedNgSummary = null;\\n`);\n       });\n \n       it('it should generate empty export when there are no other summary symbols, to ensure the output is a valid ES module',\n@@ -4294,7 +4289,7 @@ function allTests(os: string) {\n \n            const emptySummary = env.getContents('empty.ngsummary.js');\n            // The empty export ensures this js file is still an ES module.\n-           expect(emptySummary).toEqual(`export var \\u0275empty = null;\\n`);\n+           expect(emptySummary).toEqual(`export const \\u0275empty = null;\\n`);\n          });\n     });\n \n@@ -4343,7 +4338,7 @@ function allTests(os: string) {\n           .toContain('function Base_Factory(t) { return new (t || Base)(i0.ɵɵinject(Dep)); }');\n       expect(jsContents)\n           .toContain(\n-              'function () { var ɵChild_BaseFactory; return function Child_Factory(t) { return (ɵChild_BaseFactory || (ɵChild_BaseFactory = i0.ɵɵgetInheritedFactory(Child)))(t || Child); }; }();');\n+              'function () { let ɵChild_BaseFactory; return function Child_Factory(t) { return (ɵChild_BaseFactory || (ɵChild_BaseFactory = i0.ɵɵgetInheritedFactory(Child)))(t || Child); }; }();');\n       expect(jsContents)\n           .toContain('function GrandChild_Factory(t) { return new (t || GrandChild)(); }');\n     });\n@@ -4369,7 +4364,7 @@ function allTests(os: string) {\n       const jsContents = env.getContents('test.js');\n       expect(jsContents)\n           .toContain(\n-              '/*@__PURE__*/ function () { var ɵDir_BaseFactory; return function Dir_Factory(t) { return (ɵDir_BaseFactory || (ɵDir_BaseFactory = i0.ɵɵgetInheritedFactory(Dir)))(t || Dir); }; }();');\n+              '/*@__PURE__*/ function () { let ɵDir_BaseFactory; return function Dir_Factory(t) { return (ɵDir_BaseFactory || (ɵDir_BaseFactory = i0.ɵɵgetInheritedFactory(Dir)))(t || Dir); }; }();');\n     });\n \n     it('should wrap \"directives\" in component metadata in a closure when forward references are present',"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 24,
        "deletions": 29
    }
}