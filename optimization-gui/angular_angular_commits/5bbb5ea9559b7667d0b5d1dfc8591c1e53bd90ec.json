{
    "author": "atscott",
    "message": "refactor(language-service): do not mutate the original template node span (#40484)\n\nRather than mutating the span on the template when renaming literal strings,\nthis commit updates the logic to mutate the `TextSpan` equivalent that\nis used by the Language Service.\n\nPR Close #40484",
    "sha": "5bbb5ea9559b7667d0b5d1dfc8591c1e53bd90ec",
    "files": [
        {
            "sha": "204d4185cc02475ff4010762b2f15408479fd963",
            "filename": "packages/language-service/ivy/references.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/5bbb5ea9559b7667d0b5d1dfc8591c1e53bd90ec/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "raw_url": "https://github.com/angular/angular/raw/5bbb5ea9559b7667d0b5d1dfc8591c1e53bd90ec/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences.ts?ref=5bbb5ea9559b7667d0b5d1dfc8591c1e53bd90ec",
            "patch": "@@ -87,7 +87,7 @@ export class ReferencesAndRenameBuilder {\n       canRename: true,\n       displayName: text,\n       fullDisplayName: text,\n-      triggerSpan: toTextSpan(span),\n+      triggerSpan: span,\n     };\n   }\n \n@@ -396,19 +396,19 @@ export class ReferencesAndRenameBuilder {\n   }\n }\n \n-function getRenameTextAndSpanAtPosition(node: TmplAstNode|AST, position: number):\n-    {text: string, span: ParseSourceSpan|AbsoluteSourceSpan}|null {\n+function getRenameTextAndSpanAtPosition(\n+    node: TmplAstNode|AST, position: number): {text: string, span: ts.TextSpan}|null {\n   if (node instanceof TmplAstBoundAttribute || node instanceof TmplAstTextAttribute ||\n       node instanceof TmplAstBoundEvent) {\n     if (node.keySpan === undefined) {\n       return null;\n     }\n-    return {text: node.name, span: node.keySpan};\n+    return {text: node.name, span: toTextSpan(node.keySpan)};\n   } else if (node instanceof TmplAstVariable || node instanceof TmplAstReference) {\n     if (isWithin(position, node.keySpan)) {\n-      return {text: node.keySpan.toString(), span: node.keySpan};\n+      return {text: node.keySpan.toString(), span: toTextSpan(node.keySpan)};\n     } else if (node.valueSpan && isWithin(position, node.valueSpan)) {\n-      return {text: node.valueSpan.toString(), span: node.valueSpan};\n+      return {text: node.valueSpan.toString(), span: toTextSpan(node.valueSpan)};\n     }\n   }\n \n@@ -418,14 +418,14 @@ function getRenameTextAndSpanAtPosition(node: TmplAstNode|AST, position: number)\n   }\n   if (node instanceof PropertyRead || node instanceof MethodCall || node instanceof PropertyWrite ||\n       node instanceof SafePropertyRead || node instanceof SafeMethodCall) {\n-    return {text: node.name, span: node.nameSpan};\n+    return {text: node.name, span: toTextSpan(node.nameSpan)};\n   } else if (node instanceof LiteralPrimitive) {\n-    const span = node.span;\n+    const span = toTextSpan(node.sourceSpan);\n     const text = node.value;\n     if (typeof text === 'string') {\n       // The span of a string literal includes the quotes but they should be removed for renaming.\n       span.start += 1;\n-      span.end -= 1;\n+      span.length -= 2;\n     }\n     return {text, span};\n   }"
        },
        {
            "sha": "d2f08df74eae02b614851da330cab687f258bdac",
            "filename": "packages/language-service/ivy/test/references_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/5bbb5ea9559b7667d0b5d1dfc8591c1e53bd90ec/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5bbb5ea9559b7667d0b5d1dfc8591c1e53bd90ec/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts?ref=5bbb5ea9559b7667d0b5d1dfc8591c1e53bd90ec",
            "patch": "@@ -1425,7 +1425,15 @@ describe('find references and rename locations', () => {\n       expect(result.canRename).toEqual(true);\n       expect(result.displayName).toEqual('myProp');\n       expect(result.kind).toEqual('property');\n-      expect(result.triggerSpan.length).toEqual('myProp'.length);\n+      expect(text.substring(\n+                 result.triggerSpan.start, result.triggerSpan.start + result.triggerSpan.length))\n+          .toBe('myProp');\n+      // re-queries also work\n+      const {triggerSpan, displayName} =\n+          env.ngLS.getRenameInfo(_('/my-comp.ts'), cursor) as ts.RenameInfoSuccess;\n+      expect(displayName).toEqual('myProp');\n+      expect(text.substring(triggerSpan.start, triggerSpan.start + triggerSpan.length))\n+          .toBe('myProp');\n     });\n \n     it('gets rename info when cursor is on a directive input in a template', () => {"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 18,
        "deletions": 10
    }
}