{
    "author": "josephperrott",
    "message": "fix(dev-infra): allow build-worker to be used in forked process (#40012)\n\nGenerates a local copy of the build-worker file to allow it to be loaded\nat runtime in a forked process.\n\nPR Close #40012",
    "sha": "c043ecf3178f20178d8d5609034f62dfba727e70",
    "files": [
        {
            "sha": "c753f2abfb43cc2e91d208bf854e1153c21e0461",
            "filename": "dev-infra/BUILD.bazel",
            "status": "modified",
            "additions": 33,
            "deletions": 26,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/c043ecf3178f20178d8d5609034f62dfba727e70/dev-infra%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/c043ecf3178f20178d8d5609034f62dfba727e70/dev-infra%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2FBUILD.bazel?ref=c043ecf3178f20178d8d5609034f62dfba727e70",
            "patch": "@@ -1,6 +1,6 @@\n-load(\"@build_bazel_rules_nodejs//:index.bzl\", \"generated_file_test\", \"pkg_npm\")\n+load(\"@build_bazel_rules_nodejs//:index.bzl\", \"pkg_npm\")\n load(\"@npm//@bazel/typescript:index.bzl\", \"ts_library\")\n-load(\"@npm//@bazel/rollup:index.bzl\", \"rollup_bundle\")\n+load(\"//dev-infra:index.bzl\", \"ng_dev_rolled_up_generated_file\")\n \n ts_library(\n     name = \"cli\",\n@@ -24,30 +24,6 @@ ts_library(\n     ],\n )\n \n-rollup_bundle(\n-    name = \"cli_rollup\",\n-    args = [\n-        \"--plugin\",\n-        \"rollup-plugin-hashbang\",\n-    ],\n-    entry_point = \":cli.ts\",\n-    format = \"cjs\",\n-    silent = True,\n-    sourcemap = \"false\",\n-    deps = [\n-        \":cli\",\n-        # TODO(josephperrott): Determine if this plugin is the best method for ensuring the hashbang\n-        # in both local and published use case.\n-        \"@npm//rollup-plugin-hashbang\",\n-    ],\n-)\n-\n-generated_file_test(\n-    name = \"local_ng_dev\",\n-    src = \"ng-dev.js\",\n-    generated = \"cli_rollup\",\n-)\n-\n genrule(\n     name = \"package-json\",\n     srcs = [\n@@ -93,3 +69,34 @@ pkg_npm(\n         \"//dev-infra/ts-circular-dependencies\",\n     ],\n )\n+\n+# Because the angular/angular repository relies on the local repository for running ng-dev commands,\n+# the rollup generated javascript files are committed into the repository to be used as node\n+# scripts. To ensure they stay up to date, they are created using a generated file test.\n+#\n+# Currently there are two generated files which are needed\n+#  ng-dev.js       -  The main script representing ng-dev\n+#  build-worker.js -  The worker script for the `ng-dev release build` command, allowing it to run\n+#                     in a forked process.\n+ng_dev_rolled_up_generated_file(\n+    name = \"ng-dev\",\n+    entry_point = \":cli.ts\",\n+    rollup_args = [\n+        \"--plugin\",\n+        \"rollup-plugin-hashbang\",\n+    ],\n+    deps = [\n+        \":cli\",\n+        # TODO(josephperrott): Determine if this plugin is the best method for ensuring the hashbang\n+        # in both local and published use case.\n+        \"@npm//rollup-plugin-hashbang\",\n+    ],\n+)\n+\n+ng_dev_rolled_up_generated_file(\n+    name = \"build-worker\",\n+    entry_point = \"//dev-infra/release/build:build-worker.ts\",\n+    deps = [\n+        \"//dev-infra/release/build\",\n+    ],\n+)"
        },
        {
            "sha": "df9afa07ab8072d2f91039437b76ae7b23ad677a",
            "filename": "dev-infra/build-worker.js",
            "status": "added",
            "additions": 316,
            "deletions": 0,
            "changes": 316,
            "blob_url": "https://github.com/angular/angular/blob/c043ecf3178f20178d8d5609034f62dfba727e70/dev-infra%2Fbuild-worker.js",
            "raw_url": "https://github.com/angular/angular/raw/c043ecf3178f20178d8d5609034f62dfba727e70/dev-infra%2Fbuild-worker.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbuild-worker.js?ref=c043ecf3178f20178d8d5609034f62dfba727e70",
            "patch": "@@ -0,0 +1,316 @@\n+'use strict';\n+\n+function _interopDefault (ex) { return (ex && (typeof ex === 'object') && 'default' in ex) ? ex['default'] : ex; }\n+\n+var tslib = require('tslib');\n+var fs = require('fs');\n+var path = require('path');\n+var chalk = _interopDefault(require('chalk'));\n+require('inquirer');\n+require('inquirer-autocomplete-prompt');\n+var shelljs = require('shelljs');\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/** Reexport of chalk colors for convenient access. */\n+var red = chalk.red;\n+var green = chalk.green;\n+var yellow = chalk.yellow;\n+var bold = chalk.bold;\n+var blue = chalk.blue;\n+/**\n+ * Supported levels for logging functions.\n+ *\n+ * Levels are mapped to numbers to represent a hierarchy of logging levels.\n+ */\n+var LOG_LEVELS;\n+(function (LOG_LEVELS) {\n+    LOG_LEVELS[LOG_LEVELS[\"SILENT\"] = 0] = \"SILENT\";\n+    LOG_LEVELS[LOG_LEVELS[\"ERROR\"] = 1] = \"ERROR\";\n+    LOG_LEVELS[LOG_LEVELS[\"WARN\"] = 2] = \"WARN\";\n+    LOG_LEVELS[LOG_LEVELS[\"LOG\"] = 3] = \"LOG\";\n+    LOG_LEVELS[LOG_LEVELS[\"INFO\"] = 4] = \"INFO\";\n+    LOG_LEVELS[LOG_LEVELS[\"DEBUG\"] = 5] = \"DEBUG\";\n+})(LOG_LEVELS || (LOG_LEVELS = {}));\n+/** Default log level for the tool. */\n+var DEFAULT_LOG_LEVEL = LOG_LEVELS.INFO;\n+/** Write to the console for at INFO logging level */\n+var info = buildLogLevelFunction(function () { return console.info; }, LOG_LEVELS.INFO);\n+/** Write to the console for at ERROR logging level */\n+var error = buildLogLevelFunction(function () { return console.error; }, LOG_LEVELS.ERROR);\n+/** Write to the console for at DEBUG logging level */\n+var debug = buildLogLevelFunction(function () { return console.debug; }, LOG_LEVELS.DEBUG);\n+/** Write to the console for at LOG logging level */\n+// tslint:disable-next-line: no-console\n+var log = buildLogLevelFunction(function () { return console.log; }, LOG_LEVELS.LOG);\n+/** Write to the console for at WARN logging level */\n+var warn = buildLogLevelFunction(function () { return console.warn; }, LOG_LEVELS.WARN);\n+/** Build an instance of a logging function for the provided level. */\n+function buildLogLevelFunction(loadCommand, level) {\n+    /** Write to stdout for the LOG_LEVEL. */\n+    var loggingFunction = function () {\n+        var text = [];\n+        for (var _i = 0; _i < arguments.length; _i++) {\n+            text[_i] = arguments[_i];\n+        }\n+        runConsoleCommand.apply(void 0, tslib.__spread([loadCommand, level], text));\n+    };\n+    /** Start a group at the LOG_LEVEL, optionally starting it as collapsed. */\n+    loggingFunction.group = function (text, collapsed) {\n+        if (collapsed === void 0) { collapsed = false; }\n+        var command = collapsed ? console.groupCollapsed : console.group;\n+        runConsoleCommand(function () { return command; }, level, text);\n+    };\n+    /** End the group at the LOG_LEVEL. */\n+    loggingFunction.groupEnd = function () {\n+        runConsoleCommand(function () { return console.groupEnd; }, level);\n+    };\n+    return loggingFunction;\n+}\n+/**\n+ * Run the console command provided, if the environments logging level greater than the\n+ * provided logging level.\n+ *\n+ * The loadCommand takes in a function which is called to retrieve the console.* function\n+ * to allow for jasmine spies to still work in testing.  Without this method of retrieval\n+ * the console.* function, the function is saved into the closure of the created logging\n+ * function before jasmine can spy.\n+ */\n+function runConsoleCommand(loadCommand, logLevel) {\n+    var text = [];\n+    for (var _i = 2; _i < arguments.length; _i++) {\n+        text[_i - 2] = arguments[_i];\n+    }\n+    if (getLogLevel() >= logLevel) {\n+        loadCommand().apply(void 0, tslib.__spread(text));\n+    }\n+    printToLogFile.apply(void 0, tslib.__spread([logLevel], text));\n+}\n+/**\n+ * Retrieve the log level from environment variables, if the value found\n+ * based on the LOG_LEVEL environment variable is undefined, return the default\n+ * logging level.\n+ */\n+function getLogLevel() {\n+    var logLevelEnvValue = (process.env[\"LOG_LEVEL\"] || '').toUpperCase();\n+    var logLevel = LOG_LEVELS[logLevelEnvValue];\n+    if (logLevel === undefined) {\n+        return DEFAULT_LOG_LEVEL;\n+    }\n+    return logLevel;\n+}\n+/**\n+ * The number of columns used in the prepended log level information on each line of the logging\n+ * output file.\n+ */\n+var LOG_LEVEL_COLUMNS = 7;\n+/** Write the provided text to the log file, prepending each line with the log level.  */\n+function printToLogFile(logLevel) {\n+    var text = [];\n+    for (var _i = 1; _i < arguments.length; _i++) {\n+        text[_i - 1] = arguments[_i];\n+    }\n+    var logLevelText = (LOG_LEVELS[logLevel] + \":\").padEnd(LOG_LEVEL_COLUMNS);\n+}\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/**\n+ * Runs an given command as child process. By default, child process\n+ * output will not be printed.\n+ */\n+function exec(cmd, opts) {\n+    return shelljs.exec(cmd, tslib.__assign(tslib.__assign({ silent: true }, opts), { async: false }));\n+}\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/** Whether ts-node has been installed and is available to ng-dev. */\n+function isTsNodeAvailable() {\n+    try {\n+        require.resolve('ts-node');\n+        return true;\n+    }\n+    catch (_a) {\n+        return false;\n+    }\n+}\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/**\n+ * The filename expected for creating the ng-dev config, without the file\n+ * extension to allow either a typescript or javascript file to be used.\n+ */\n+var CONFIG_FILE_PATH = '.ng-dev/config';\n+/** The configuration for ng-dev. */\n+var cachedConfig = null;\n+/**\n+ * Get the configuration from the file system, returning the already loaded\n+ * copy if it is defined.\n+ */\n+function getConfig() {\n+    // If the global config is not defined, load it from the file system.\n+    if (cachedConfig === null) {\n+        // The full path to the configuration file.\n+        var configPath = path.join(getRepoBaseDir(), CONFIG_FILE_PATH);\n+        // Read the configuration and validate it before caching it for the future.\n+        cachedConfig = validateCommonConfig(readConfigFile(configPath));\n+    }\n+    // Return a clone of the cached global config to ensure that a new instance of the config\n+    // is returned each time, preventing unexpected effects of modifications to the config object.\n+    return tslib.__assign({}, cachedConfig);\n+}\n+/** Validate the common configuration has been met for the ng-dev command. */\n+function validateCommonConfig(config) {\n+    var errors = [];\n+    // Validate the github configuration.\n+    if (config.github === undefined) {\n+        errors.push(\"Github repository not configured. Set the \\\"github\\\" option.\");\n+    }\n+    else {\n+        if (config.github.name === undefined) {\n+            errors.push(\"\\\"github.name\\\" is not defined\");\n+        }\n+        if (config.github.owner === undefined) {\n+            errors.push(\"\\\"github.owner\\\" is not defined\");\n+        }\n+    }\n+    assertNoErrors(errors);\n+    return config;\n+}\n+/**\n+ * Resolves and reads the specified configuration file, optionally returning an empty object if the\n+ * configuration file cannot be read.\n+ */\n+function readConfigFile(configPath, returnEmptyObjectOnError) {\n+    if (returnEmptyObjectOnError === void 0) { returnEmptyObjectOnError = false; }\n+    // If the the `.ts` extension has not been set up already, and a TypeScript based\n+    // version of the given configuration seems to exist, set up `ts-node` if available.\n+    if (require.extensions['.ts'] === undefined && fs.existsSync(configPath + \".ts\") &&\n+        isTsNodeAvailable()) {\n+        // Ensure the module target is set to `commonjs`. This is necessary because the\n+        // dev-infra tool runs in NodeJS which does not support ES modules by default.\n+        // Additionally, set the `dir` option to the directory that contains the configuration\n+        // file. This allows for custom compiler options (such as `--strict`).\n+        require('ts-node').register({ dir: path.dirname(configPath), transpileOnly: true, compilerOptions: { module: 'commonjs' } });\n+    }\n+    try {\n+        return require(configPath);\n+    }\n+    catch (e) {\n+        if (returnEmptyObjectOnError) {\n+            debug(\"Could not read configuration file at \" + configPath + \", returning empty object instead.\");\n+            debug(e);\n+            return {};\n+        }\n+        error(\"Could not read configuration file at \" + configPath + \".\");\n+        error(e);\n+        process.exit(1);\n+    }\n+}\n+/**\n+ * Asserts the provided array of error messages is empty. If any errors are in the array,\n+ * logs the errors and exit the process as a failure.\n+ */\n+function assertNoErrors(errors) {\n+    var e_1, _a;\n+    if (errors.length == 0) {\n+        return;\n+    }\n+    error(\"Errors discovered while loading configuration file:\");\n+    try {\n+        for (var errors_1 = tslib.__values(errors), errors_1_1 = errors_1.next(); !errors_1_1.done; errors_1_1 = errors_1.next()) {\n+            var err = errors_1_1.value;\n+            error(\"  - \" + err);\n+        }\n+    }\n+    catch (e_1_1) { e_1 = { error: e_1_1 }; }\n+    finally {\n+        try {\n+            if (errors_1_1 && !errors_1_1.done && (_a = errors_1.return)) _a.call(errors_1);\n+        }\n+        finally { if (e_1) throw e_1.error; }\n+    }\n+    process.exit(1);\n+}\n+/** Gets the path of the directory for the repository base. */\n+function getRepoBaseDir() {\n+    var baseRepoDir = exec(\"git rev-parse --show-toplevel\");\n+    if (baseRepoDir.code) {\n+        throw Error(\"Unable to find the path to the base directory of the repository.\\n\" +\n+            \"Was the command run from inside of the repo?\\n\\n\" +\n+            (\"ERROR:\\n \" + baseRepoDir.stderr));\n+    }\n+    return baseRepoDir.trim();\n+}\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/** Retrieve and validate the config as `ReleaseConfig`. */\n+function getReleaseConfig(config = getConfig()) {\n+    var _a, _b, _c;\n+    // List of errors encountered validating the config.\n+    const errors = [];\n+    if (config.release === undefined) {\n+        errors.push(`No configuration defined for \"release\"`);\n+    }\n+    if (((_a = config.release) === null || _a === void 0 ? void 0 : _a.npmPackages) === undefined) {\n+        errors.push(`No \"npmPackages\" configured for releasing.`);\n+    }\n+    if (((_b = config.release) === null || _b === void 0 ? void 0 : _b.buildPackages) === undefined) {\n+        errors.push(`No \"buildPackages\" function configured for releasing.`);\n+    }\n+    if (((_c = config.release) === null || _c === void 0 ? void 0 : _c.generateReleaseNotesForHead) === undefined) {\n+        errors.push(`No \"generateReleaseNotesForHead\" function configured for releasing.`);\n+    }\n+    assertNoErrors(errors);\n+    return config.release;\n+}\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+// Start the release package building.\n+main();\n+/** Main function for building the release packages. */\n+function main() {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        if (process.send === undefined) {\n+            throw Error('This script needs to be invoked as a NodeJS worker.');\n+        }\n+        const config = getReleaseConfig();\n+        const builtPackages = yield config.buildPackages();\n+        // Transfer the built packages back to the parent process.\n+        process.send(builtPackages);\n+    });\n+}"
        },
        {
            "sha": "34867f0994509bcb028fc0e7ab9ab25a6ab8d11a",
            "filename": "dev-infra/index.bzl",
            "status": "modified",
            "additions": 28,
            "deletions": 3,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/c043ecf3178f20178d8d5609034f62dfba727e70/dev-infra%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/c043ecf3178f20178d8d5609034f62dfba727e70/dev-infra%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Findex.bzl?ref=c043ecf3178f20178d8d5609034f62dfba727e70",
            "patch": "@@ -3,7 +3,32 @@\n # Use of this source code is governed by an MIT-style license that can be\n # found in the LICENSE file at https://angular.io/license\n \n-# File is currently empty but serves as indicator for `rules_nodejs` and instructs it to\n-# preserve the content output in the NPM install workspace. This allows consumers to use\n-# rules and targets from within Bazel. e.g. by using `@npm//@angular/dev-infra-private/<..>`.\n+load(\"@build_bazel_rules_nodejs//:index.bzl\", \"generated_file_test\")\n+load(\"@npm//@bazel/rollup:index.bzl\", \"rollup_bundle\")\n+\n+# This file continues to serve as indicator for `rules_nodejs` and instructs it  preserve the\n+# content output in the NPM install workspace. This allows consumers to use rules and targets from\n+# within Bazel. e.g. by using `@npm//@angular/dev-infra-private/<..>`.\n # See: https://github.com/bazelbuild/rules_nodejs/commit/4f508b1a0be1f5444e9c13b0439e649449792fef.\n+\n+def ng_dev_rolled_up_generated_file(name, entry_point, deps = [], rollup_args = []):\n+    \"\"\"Rollup and generated file test macro.\n+\n+    This provides a single macro to create a rollup bundled script and a generated file test for the\n+    created script to ensure it stays up to date in the repository.\n+    \"\"\"\n+    rollup_bundle(\n+        name = \"%s_bundle\" % name,\n+        args = rollup_args,\n+        entry_point = entry_point,\n+        format = \"cjs\",\n+        silent = True,\n+        sourcemap = \"false\",\n+        deps = deps,\n+    )\n+\n+    generated_file_test(\n+        name = name,\n+        src = \"%s.js\" % name,\n+        generated = \"%s_bundle\" % name,\n+    )"
        },
        {
            "sha": "75136639abd1d10a2a8ff15f82a8a1c193bbc1e4",
            "filename": "dev-infra/release/build/BUILD.bazel",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c043ecf3178f20178d8d5609034f62dfba727e70/dev-infra%2Frelease%2Fbuild%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/c043ecf3178f20178d8d5609034f62dfba727e70/dev-infra%2Frelease%2Fbuild%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2FBUILD.bazel?ref=c043ecf3178f20178d8d5609034f62dfba727e70",
            "patch": "@@ -1,6 +1,10 @@\n load(\"@npm//@bazel/typescript:index.bzl\", \"ts_library\")\n load(\"//tools:defaults.bzl\", \"jasmine_node_test\")\n \n+exports_files([\n+    \"build-worker.ts\",\n+])\n+\n ts_library(\n     name = \"build\",\n     srcs = glob("
        }
    ],
    "stats": {
        "total": 410,
        "additions": 381,
        "deletions": 29
    }
}