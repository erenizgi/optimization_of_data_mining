{
    "author": "petebacondarwin",
    "message": "fix(compiler): support multiple selectors in `:host-context()` (#40494)\n\nThe previous commits refactored the `ShadowCss` emulator to support\ndesirable use-cases of `:host-context()`, but it dropped support\nfor passing a comma separated list of selectors to the `:host-context()` .\n\nThis commit rectifies that omission, despite the use-case not being\nvalid according to the ShadowDOM spec, to ensure backward compatibility\nwith the previous implementation.\n\nPR Close #40494",
    "sha": "645c2ef97331c09827cc3bd86863956762be4ff8",
    "files": [
        {
            "sha": "fc0a295186fa18f7a812f1f65cf5ffad1cfb7b79",
            "filename": "packages/compiler/src/shadow_css.ts",
            "status": "modified",
            "additions": 65,
            "deletions": 9,
            "changes": 74,
            "blob_url": "https://github.com/angular/angular/blob/645c2ef97331c09827cc3bd86863956762be4ff8/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts",
            "raw_url": "https://github.com/angular/angular/raw/645c2ef97331c09827cc3bd86863956762be4ff8/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts?ref=645c2ef97331c09827cc3bd86863956762be4ff8",
            "patch": "@@ -295,26 +295,62 @@ export class ShadowCss {\n   private _convertColonHostContext(cssText: string): string {\n     return cssText.replace(_cssColonHostContextReGlobal, selectorText => {\n       // We have captured a selector that contains a `:host-context` rule.\n-      // There may be more than one so `selectorText` could look like:\n-      // `:host-context(.one):host-context(.two)`.\n \n-      const contextSelectors: string[] = [];\n-      let match: RegExpMatchArray|null;\n+      // For backward compatibility `:host-context` may contain a comma separated list of selectors.\n+      // Each context selector group will contain a list of host-context selectors that must match\n+      // an ancestor of the host.\n+      // (Normally `contextSelectorGroups` will only contain a single array of context selectors.)\n+      const contextSelectorGroups: string[][] = [[]];\n \n+      // There may be more than `:host-context` in this selector so `selectorText` could look like:\n+      // `:host-context(.one):host-context(.two)`.\n       // Execute `_cssColonHostContextRe` over and over until we have extracted all the\n       // `:host-context` selectors from this selector.\n+      let match: RegExpMatchArray|null;\n       while (match = _cssColonHostContextRe.exec(selectorText)) {\n         // `match` = [':host-context(<selectors>)<rest>', <selectors>, <rest>]\n-        const contextSelector = (match[1] ?? '').trim();\n-        if (contextSelector !== '') {\n-          contextSelectors.push(contextSelector);\n+\n+        // The `<selectors>` could actually be a comma separated list: `:host-context(.one, .two)`.\n+        const newContextSelectors =\n+            (match[1] ?? '').trim().split(',').map(m => m.trim()).filter(m => m !== '');\n+\n+        // We must duplicate the current selector group for each of these new selectors.\n+        // For example if the current groups are:\n+        // ```\n+        // [\n+        //   ['a', 'b', 'c'],\n+        //   ['x', 'y', 'z'],\n+        // ]\n+        // ```\n+        // And we have a new set of comma separated selectors: `:host-context(m,n)` then the new\n+        // groups are:\n+        // ```\n+        // [\n+        //   ['a', 'b', 'c', 'm'],\n+        //   ['x', 'y', 'z', 'm'],\n+        //   ['a', 'b', 'c', 'n'],\n+        //   ['x', 'y', 'z', 'n'],\n+        // ]\n+        // ```\n+        const contextSelectorGroupsLength = contextSelectorGroups.length;\n+        repeatGroups(contextSelectorGroups, newContextSelectors.length);\n+        for (let i = 0; i < newContextSelectors.length; i++) {\n+          for (let j = 0; j < contextSelectorGroupsLength; j++) {\n+            contextSelectorGroups[j + (i * contextSelectorGroupsLength)].push(\n+                newContextSelectors[i]);\n+          }\n         }\n+\n+        // Update the `selectorText` and see repeat to see if there are more `:host-context`s.\n         selectorText = match[2];\n       }\n \n       // The context selectors now must be combined with each other to capture all the possible\n-      // selectors that `:host-context` can match.\n-      return combineHostContextSelectors(contextSelectors, selectorText);\n+      // selectors that `:host-context` can match. See `combineHostContextSelectors()` for more\n+      // info about how this is done.\n+      return contextSelectorGroups\n+          .map(contextSelectors => combineHostContextSelectors(contextSelectors, selectorText))\n+          .join(', ');\n     });\n   }\n \n@@ -714,3 +750,23 @@ function combineHostContextSelectors(contextSelectors: string[], otherSelectors:\n               `${s}${hostMarker}${otherSelectors}, ${s} ${hostMarker}${otherSelectors}`)\n       .join(',');\n }\n+\n+/**\n+ * Mutate the given `groups` array so that there are `multiples` clones of the original array\n+ * stored.\n+ *\n+ * For example `repeatGroups([a, b], 3)` will result in `[a, b, a, b, a, b]` - but importantly the\n+ * newly added groups will be clones of the original.\n+ *\n+ * @param groups An array of groups of strings that will be repeated. This array is mutated\n+ *     in-place.\n+ * @param multiples The number of times the current groups should appear.\n+ */\n+export function repeatGroups<T>(groups: string[][], multiples: number): void {\n+  const length = groups.length;\n+  for (let i = 1; i < multiples; i++) {\n+    for (let j = 0; j < length; j++) {\n+      groups[j + (i * length)] = groups[j].slice(0);\n+    }\n+  }\n+}"
        },
        {
            "sha": "62642667b6be8238da9e1d78259afa28dcfd9aaa",
            "filename": "packages/compiler/test/shadow_css_spec.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 8,
            "changes": 57,
            "blob_url": "https://github.com/angular/angular/blob/645c2ef97331c09827cc3bd86863956762be4ff8/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/645c2ef97331c09827cc3bd86863956762be4ff8/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts?ref=645c2ef97331c09827cc3bd86863956762be4ff8",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {CssRule, processRules, ShadowCss} from '@angular/compiler/src/shadow_css';\n+import {CssRule, processRules, repeatGroups, ShadowCss} from '@angular/compiler/src/shadow_css';\n import {normalizeCSS} from '@angular/platform-browser/testing/src/browser_util';\n \n {\n@@ -249,14 +249,27 @@ import {normalizeCSS} from '@angular/platform-browser/testing/src/browser_util';\n             ]);\n       });\n \n-      // This test is checking backward compatibility.\n-      // It is not clear what the behaviour should be for a `:host-context` with no selectors.\n-      // Arguably it is actually an error that should be reported.\n+      // It is not clear what the behavior should be for a `:host-context` with no selectors.\n+      // This test is checking that the result is backward compatible with previous behavior.\n+      // Arguably it should actually be an error that should be reported.\n       it('should handle :host-context with no ancestor selectors', () => {\n-        expect(s('.outer :host-context .inner {}', 'contenta', 'a-host'))\n-            .toEqual('.outer [a-host] .inner[contenta] {}');\n-        expect(s('.outer :host-context() .inner {}', 'contenta', 'a-host'))\n-            .toEqual('.outer [a-host] .inner[contenta] {}');\n+        expect(s(':host-context .inner {}', 'contenta', 'a-host'))\n+            .toEqual('[a-host] .inner[contenta] {}');\n+        expect(s(':host-context() .inner {}', 'contenta', 'a-host'))\n+            .toEqual('[a-host] .inner[contenta] {}');\n+      });\n+\n+      // More than one selector such as this is not valid as part of the :host-context spec.\n+      // This test is checking that the result is backward compatible with previous behavior.\n+      // Arguably it should actually be an error that should be reported.\n+      it('should handle selectors', () => {\n+        expect(s(':host-context(.one,.two) .inner {}', 'contenta', 'a-host'))\n+            .toEqual(\n+                '.one[a-host] .inner[contenta], ' +\n+                '.one [a-host] .inner[contenta], ' +\n+                '.two[a-host] .inner[contenta], ' +\n+                '.two [a-host] .inner[contenta] ' +\n+                '{}');\n       });\n     });\n \n@@ -482,4 +495,32 @@ import {normalizeCSS} from '@angular/platform-browser/testing/src/browser_util';\n       });\n     });\n   });\n+\n+  describe('repeatGroups()', () => {\n+    it('should do nothing if `multiples` is 0', () => {\n+      const groups = [['a1', 'b1', 'c1'], ['a2', 'b2', 'c2']];\n+      repeatGroups(groups, 0);\n+      expect(groups).toEqual([['a1', 'b1', 'c1'], ['a2', 'b2', 'c2']]);\n+    });\n+\n+    it('should do nothing if `multiples` is 1', () => {\n+      const groups = [['a1', 'b1', 'c1'], ['a2', 'b2', 'c2']];\n+      repeatGroups(groups, 1);\n+      expect(groups).toEqual([['a1', 'b1', 'c1'], ['a2', 'b2', 'c2']]);\n+    });\n+\n+    it('should add clones of the original groups if `multiples` is greater than 1', () => {\n+      const group1 = ['a1', 'b1', 'c1'];\n+      const group2 = ['a2', 'b2', 'c2'];\n+      const groups = [group1, group2];\n+      repeatGroups(groups, 3);\n+      expect(groups).toEqual([group1, group2, group1, group2, group1, group2]);\n+      expect(groups[0]).toBe(group1);\n+      expect(groups[1]).toBe(group2);\n+      expect(groups[2]).not.toBe(group1);\n+      expect(groups[3]).not.toBe(group2);\n+      expect(groups[4]).not.toBe(group1);\n+      expect(groups[5]).not.toBe(group2);\n+    });\n+  });\n }"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 114,
        "deletions": 17
    }
}