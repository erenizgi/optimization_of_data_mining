{
    "author": "petebacondarwin",
    "message": "fix(ngcc): ensure lockfile is removed when analyzeFn fails (#37739)\n\nPreviously an error thrown in the `analyzeFn` would cause\nthe ngcc process to exit immediately without removing the\nlockfile, and potentially before the unlocker process had been\nsuccessfully spawned resulting in the lockfile being orphaned\nand left behind.\n\nNow we catch these errors and remove the lockfile as needed.\n\nPR Close #37739",
    "sha": "78a44768e0bc5038ac5d813641ca6287ce2f22ea",
    "files": [
        {
            "sha": "23155c3ad3a8a5eb9f48000bb419a950591f2d7e",
            "filename": "packages/compiler-cli/ngcc/src/execution/cluster/executor.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/78a44768e0bc5038ac5d813641ca6287ce2f22ea/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fexecutor.ts",
            "raw_url": "https://github.com/angular/angular/raw/78a44768e0bc5038ac5d813641ca6287ce2f22ea/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fexecutor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fexecutor.ts?ref=78a44768e0bc5038ac5d813641ca6287ce2f22ea",
            "patch": "@@ -28,13 +28,13 @@ export class ClusterExecutor implements Executor {\n \n   async execute(analyzeEntryPoints: AnalyzeEntryPointsFn, _createCompileFn: CreateCompileFn):\n       Promise<void> {\n-    return this.lockFile.lock(() => {\n+    return this.lockFile.lock(async () => {\n       this.logger.debug(\n           `Running ngcc on ${this.constructor.name} (using ${this.workerCount} worker processes).`);\n       const master = new ClusterMaster(\n           this.workerCount, this.fileSystem, this.logger, this.fileWriter, this.pkgJsonUpdater,\n           analyzeEntryPoints, this.createTaskCompletedCallback);\n-      return master.run();\n+      return await master.run();\n     });\n   }\n }"
        },
        {
            "sha": "f0ea1cebadbdf4a078a72c6473012a631a4cdf30",
            "filename": "packages/compiler-cli/ngcc/src/locking/async_locker.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/78a44768e0bc5038ac5d813641ca6287ce2f22ea/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Fasync_locker.ts",
            "raw_url": "https://github.com/angular/angular/raw/78a44768e0bc5038ac5d813641ca6287ce2f22ea/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Fasync_locker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Fasync_locker.ts?ref=78a44768e0bc5038ac5d813641ca6287ce2f22ea",
            "patch": "@@ -37,7 +37,11 @@ export class AsyncLocker {\n    */\n   async lock<T>(fn: () => Promise<T>): Promise<T> {\n     await this.create();\n-    return fn().finally(() => this.lockFile.remove());\n+    try {\n+      return await fn();\n+    } finally {\n+      this.lockFile.remove();\n+    }\n   }\n \n   protected async create() {"
        },
        {
            "sha": "ce79c66dcd1da5a01ff3a7d043e35843fe58bd8f",
            "filename": "packages/compiler-cli/ngcc/test/execution/cluster/executor_spec.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/78a44768e0bc5038ac5d813641ca6287ce2f22ea/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fexecution%2Fcluster%2Fexecutor_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/78a44768e0bc5038ac5d813641ca6287ce2f22ea/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fexecution%2Fcluster%2Fexecutor_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fexecution%2Fcluster%2Fexecutor_spec.ts?ref=78a44768e0bc5038ac5d813641ca6287ce2f22ea",
            "patch": "@@ -34,7 +34,7 @@ runInEachFileSystem(() => {\n \n     beforeEach(() => {\n       masterRunSpy = spyOn(ClusterMaster.prototype, 'run')\n-                         .and.returnValue(Promise.resolve('CusterMaster#run()' as any));\n+                         .and.returnValue(Promise.resolve('ClusterMaster#run()' as any));\n       createTaskCompletedCallback = jasmine.createSpy('createTaskCompletedCallback');\n \n       mockLogger = new MockLogger();\n@@ -63,7 +63,7 @@ runInEachFileSystem(() => {\n         const createCompilerFnSpy = jasmine.createSpy('createCompilerFn');\n \n         expect(await executor.execute(analyzeEntryPointsSpy, createCompilerFnSpy))\n-            .toBe('CusterMaster#run()' as any);\n+            .toBe('ClusterMaster#run()' as any);\n \n         expect(masterRunSpy).toHaveBeenCalledWith();\n \n@@ -78,6 +78,22 @@ runInEachFileSystem(() => {\n            expect(lockFileLog).toEqual(['write()', 'remove()']);\n          });\n \n+      it('should call LockFile.write() and LockFile.remove() if analyzeFn fails', async () => {\n+        const analyzeEntryPointsSpy =\n+            jasmine.createSpy('analyzeEntryPoints').and.throwError('analyze error');\n+        const createCompilerFnSpy = jasmine.createSpy('createCompilerFn');\n+        let error = '';\n+        try {\n+          await executor.execute(analyzeEntryPointsSpy, createCompilerFnSpy);\n+        } catch (e) {\n+          error = e.message;\n+        }\n+        expect(analyzeEntryPointsSpy).toHaveBeenCalledWith();\n+        expect(createCompilerFnSpy).not.toHaveBeenCalled();\n+        expect(error).toEqual('analyze error');\n+        expect(lockFileLog).toEqual(['write()', 'remove()']);\n+      });\n+\n       it('should call LockFile.write() and LockFile.remove() if master runner fails', async () => {\n         const anyFn: () => any = () => undefined;\n         masterRunSpy.and.returnValue(Promise.reject(new Error('master runner error')));"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 25,
        "deletions": 5
    }
}