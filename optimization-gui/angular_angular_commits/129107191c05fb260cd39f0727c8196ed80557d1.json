{
    "author": "atscott",
    "message": "refactor(compiler): always return a mutable clone from `Scope#resolve` (#38857)\n\nThis change prevents comments from a resolved node from appearing at\neach location the resolved expression is used and also prevents callers\nof `Scope#resolve` from accidentally modifying / adding comments to the\ndeclaration site.\n\nPR Close #38857",
    "sha": "129107191c05fb260cd39f0727c8196ed80557d1",
    "files": [
        {
            "sha": "dbe40a09258049fd69e16859616bca0fabb864f4",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 6,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/129107191c05fb260cd39f0727c8196ed80557d1/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/129107191c05fb260cd39f0727c8196ed80557d1/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=129107191c05fb260cd39f0727c8196ed80557d1",
            "patch": "@@ -418,10 +418,10 @@ class TcbReferenceOp extends TcbOp {\n \n   execute(): ts.Identifier {\n     const id = this.tcb.allocateId();\n-    let initializer = ts.getMutableClone(\n+    let initializer =\n         this.target instanceof TmplAstTemplate || this.target instanceof TmplAstElement ?\n-            this.scope.resolve(this.target) :\n-            this.scope.resolve(this.host, this.target));\n+        this.scope.resolve(this.target) :\n+        this.scope.resolve(this.host, this.target);\n \n     // The reference is either to an element, an <ng-template> node, or to a directive on an\n     // element or template.\n@@ -1121,7 +1121,8 @@ class Scope {\n \n   /**\n    * Look up a `ts.Expression` representing the value of some operation in the current `Scope`,\n-   * including any parent scope(s).\n+   * including any parent scope(s). This method always returns a mutable clone of the\n+   * `ts.Expression` with the comments cleared.\n    *\n    * @param node a `TmplAstNode` of the operation in question. The lookup performed will depend on\n    * the type of this node:\n@@ -1142,7 +1143,18 @@ class Scope {\n     // Attempt to resolve the operation locally.\n     const res = this.resolveLocal(node, directive);\n     if (res !== null) {\n-      return res;\n+      // We want to get a clone of the resolved expression and clear the trailing comments\n+      // so they don't continue to appear in every place the expression is used.\n+      // As an example, this would otherwise produce:\n+      // var _t1 /**T:DIR*/ /*1,2*/ = _ctor1();\n+      // _t1 /**T:DIR*/ /*1,2*/.input = 'value';\n+      //\n+      // In addition, returning a clone prevents the consumer of `Scope#resolve` from\n+      // attaching comments at the declaration site.\n+\n+      const clone = ts.getMutableClone(res);\n+      ts.setSyntheticTrailingComments(clone, []);\n+      return clone;\n     } else if (this.parent !== null) {\n       // Check with the parent.\n       return this.parent.resolve(node, directive);\n@@ -1547,7 +1559,7 @@ class TcbExpressionTranslator {\n       return null;\n     }\n \n-    const expr = ts.getMutableClone(this.scope.resolve(binding));\n+    const expr = this.scope.resolve(binding);\n     addParseSpanInfo(expr, ast.sourceSpan);\n     return expr;\n   }"
        },
        {
            "sha": "ef4465cca23a6e8631c21bd0d08c165610cd4a96",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/span_comments_spec.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/129107191c05fb260cd39f0727c8196ed80557d1/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/129107191c05fb260cd39f0727c8196ed80557d1/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts?ref=129107191c05fb260cd39f0727c8196ed80557d1",
            "patch": "@@ -165,6 +165,22 @@ describe('type check blocks diagnostics', () => {\n             .toContain('((_t1 /*23,24*/) || (_t1 /*28,29*/) /*23,29*/);');\n       });\n     });\n+\n+    describe('attaching comments for generic directive inputs', () => {\n+      it('should be correct for directive refs', () => {\n+        const DIRECTIVES: TestDeclaration[] = [{\n+          type: 'directive',\n+          name: 'MyComponent',\n+          selector: 'my-cmp',\n+          isComponent: true,\n+          isGeneric: true,\n+          inputs: {'inputA': 'inputA'},\n+        }];\n+        const TEMPLATE = `<my-cmp [inputA]=\"''\"></my-cmp>`;\n+        expect(tcbWithSpans(TEMPLATE, DIRECTIVES))\n+            .toContain('_t1.inputA = (\"\" /*18,20*/) /*8,21*/;');\n+      });\n+    });\n   });\n });\n "
        }
    ],
    "stats": {
        "total": 40,
        "additions": 34,
        "deletions": 6
    }
}