{
    "author": "crisbeto",
    "message": "fix(common): avoid mutating context object in NgTemplateOutlet (#40360)\n\nCurrently `NgTemplateOutlet` recreates its view if its template is swapped out or a context\nobject with a different shape is passed in. If an object with the same shape is passed in,\nwe preserve the old view and we mutate the previous object. This mutation of the original\nobject can be undesirable if two objects with the same shape are swapped between two\ndifferent template outlets.\n\nThe current behavior is a result of a limitation in `core` where the `context` of an embedded\nview is read-only, however a previous commit made it writeable.\n\nThese changes resolve the context mutation issue and clean up a bunch of unnecessary\nlogic from `NgTemplateOutlet` by taking advantage of the earlier change.\n\nFixes #24515.\n\nPR Close #40360",
    "sha": "d3705b3284113f752ee05e9f0d2f6e75c723ea5b",
    "files": [
        {
            "sha": "fea778e1394d5d1f81d7c876f7ee8759c2fcb3ba",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d3705b3284113f752ee05e9f0d2f6e75c723ea5b/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/d3705b3284113f752ee05e9f0d2f6e75c723ea5b/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=d3705b3284113f752ee05e9f0d2f6e75c723ea5b",
            "patch": "@@ -26,4 +26,4 @@\n       }\n     }\n   }\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "4ddb84391b119bf8cc96544e44a4cd6d884bee39",
            "filename": "packages/common/src/directives/ng_template_outlet.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 41,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/d3705b3284113f752ee05e9f0d2f6e75c723ea5b/packages%2Fcommon%2Fsrc%2Fdirectives%2Fng_template_outlet.ts",
            "raw_url": "https://github.com/angular/angular/raw/d3705b3284113f752ee05e9f0d2f6e75c723ea5b/packages%2Fcommon%2Fsrc%2Fdirectives%2Fng_template_outlet.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Fdirectives%2Fng_template_outlet.ts?ref=d3705b3284113f752ee05e9f0d2f6e75c723ea5b",
            "patch": "@@ -52,9 +52,7 @@ export class NgTemplateOutlet implements OnChanges {\n   constructor(private _viewContainerRef: ViewContainerRef) {}\n \n   ngOnChanges(changes: SimpleChanges) {\n-    const recreateView = this._shouldRecreateView(changes);\n-\n-    if (recreateView) {\n+    if (changes['ngTemplateOutlet']) {\n       const viewContainerRef = this._viewContainerRef;\n \n       if (this._viewRef) {\n@@ -64,44 +62,9 @@ export class NgTemplateOutlet implements OnChanges {\n       this._viewRef = this.ngTemplateOutlet ?\n           viewContainerRef.createEmbeddedView(this.ngTemplateOutlet, this.ngTemplateOutletContext) :\n           null;\n-    } else if (this._viewRef && this.ngTemplateOutletContext) {\n-      this._updateExistingContext(this.ngTemplateOutletContext);\n-    }\n-  }\n-\n-  /**\n-   * We need to re-create existing embedded view if:\n-   * - templateRef has changed\n-   * - context has changes\n-   *\n-   * We mark context object as changed when the corresponding object\n-   * shape changes (new properties are added or existing properties are removed).\n-   * In other words we consider context with the same properties as \"the same\" even\n-   * if object reference changes (see https://github.com/angular/angular/issues/13407).\n-   */\n-  private _shouldRecreateView(changes: SimpleChanges): boolean {\n-    const ctxChange = changes['ngTemplateOutletContext'];\n-    return !!changes['ngTemplateOutlet'] || (ctxChange && this._hasContextShapeChanged(ctxChange));\n-  }\n-\n-  private _hasContextShapeChanged(ctxChange: SimpleChange): boolean {\n-    const prevCtxKeys = Object.keys(ctxChange.previousValue || {});\n-    const currCtxKeys = Object.keys(ctxChange.currentValue || {});\n-\n-    if (prevCtxKeys.length === currCtxKeys.length) {\n-      for (let propName of currCtxKeys) {\n-        if (prevCtxKeys.indexOf(propName) === -1) {\n-          return true;\n-        }\n-      }\n-      return false;\n-    }\n-    return true;\n-  }\n-\n-  private _updateExistingContext(ctx: Object): void {\n-    for (let propName of Object.keys(ctx)) {\n-      (<any>this._viewRef!.context)[propName] = (<any>this.ngTemplateOutletContext)[propName];\n+    } else if (\n+        this._viewRef && changes['ngTemplateOutletContext'] && this.ngTemplateOutletContext) {\n+      this._viewRef.context = this.ngTemplateOutletContext;\n     }\n   }\n }"
        },
        {
            "sha": "ee3132180ebbabe4fe18fccdc238cf4ff5a22457",
            "filename": "packages/common/test/directives/ng_template_outlet_spec.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 3,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/d3705b3284113f752ee05e9f0d2f6e75c723ea5b/packages%2Fcommon%2Ftest%2Fdirectives%2Fng_template_outlet_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d3705b3284113f752ee05e9f0d2f6e75c723ea5b/packages%2Fcommon%2Ftest%2Fdirectives%2Fng_template_outlet_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Ftest%2Fdirectives%2Fng_template_outlet_spec.ts?ref=d3705b3284113f752ee05e9f0d2f6e75c723ea5b",
            "patch": "@@ -29,7 +29,7 @@ describe('NgTemplateOutlet', () => {\n \n   beforeEach(() => {\n     TestBed.configureTestingModule({\n-      declarations: [TestComponent, CaptureTplRefs, DestroyableCmpt],\n+      declarations: [TestComponent, CaptureTplRefs, DestroyableCmpt, MultiContextComponent],\n       imports: [CommonModule],\n       providers: [DestroyedSpyService]\n     });\n@@ -142,7 +142,7 @@ describe('NgTemplateOutlet', () => {\n     expect(spyService.destroyed).toBeFalsy();\n   });\n \n-  it('should recreate embedded view when context shape changes', () => {\n+  it('should update but not destroy embedded view when context shape changes', () => {\n     const template =\n         `<ng-template let-foo=\"foo\" #tpl><destroyable-cmpt></destroyable-cmpt>:{{foo}}</ng-template>` +\n         `<ng-template [ngTemplateOutlet]=\"tpl\" [ngTemplateOutletContext]=\"context\"></ng-template>`;\n@@ -155,7 +155,7 @@ describe('NgTemplateOutlet', () => {\n \n     fixture.componentInstance.context = {foo: 'baz', other: true};\n     detectChangesAndExpectText('Content to destroy:baz');\n-    expect(spyService.destroyed).toBeTruthy();\n+    expect(spyService.destroyed).toBeFalsy();\n   });\n \n   it('should destroy embedded view when context value changes and templateRef becomes undefined', () => {\n@@ -241,6 +241,27 @@ describe('NgTemplateOutlet', () => {\n          detectChangesAndExpectText('foo');\n        }).not.toThrow();\n      }));\n+\n+  it('should not mutate context object if two contexts with an identical shape are swapped', () => {\n+    fixture = TestBed.createComponent(MultiContextComponent);\n+    const {componentInstance, nativeElement} = fixture;\n+    componentInstance.context1 = {name: 'one'};\n+    componentInstance.context2 = {name: 'two'};\n+    fixture.detectChanges();\n+\n+    expect(nativeElement.textContent.trim()).toBe('one | two');\n+    expect(componentInstance.context1).toEqual({name: 'one'});\n+    expect(componentInstance.context2).toEqual({name: 'two'});\n+\n+    const temp = componentInstance.context1;\n+    componentInstance.context1 = componentInstance.context2;\n+    componentInstance.context2 = temp;\n+    fixture.detectChanges();\n+\n+    expect(nativeElement.textContent.trim()).toBe('two | one');\n+    expect(componentInstance.context1).toEqual({name: 'two'});\n+    expect(componentInstance.context2).toEqual({name: 'one'});\n+  });\n });\n \n @Injectable()\n@@ -271,6 +292,19 @@ class TestComponent {\n   value = 'bar';\n }\n \n+@Component({\n+  template: `\n+  <ng-template #template let-name=\"name\">{{name}}</ng-template>\n+  <ng-template [ngTemplateOutlet]=\"template\" [ngTemplateOutletContext]=\"context1\"></ng-template>\n+  |\n+  <ng-template [ngTemplateOutlet]=\"template\" [ngTemplateOutletContext]=\"context2\"></ng-template>\n+  `\n+})\n+class MultiContextComponent {\n+  context1: {name: string}|undefined;\n+  context2: {name: string}|undefined;\n+}\n+\n function createTestComponent(template: string): ComponentFixture<TestComponent> {\n   return TestBed.overrideComponent(TestComponent, {set: {template: template}})\n       .configureTestingModule({schemas: [NO_ERRORS_SCHEMA]})"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 42,
        "deletions": 45
    }
}