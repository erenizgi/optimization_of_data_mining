{
    "author": "JamesHenry",
    "message": "refactor(compiler): option to include html comments in `ParsedTemplate` (#41251)\n\nAdds a `collectCommentNodes` option on `ParseTemplateOptions` which will cause the returned `ParsedTemplate` to include an array of all html comments found in the template.\n\nPR Close #41251",
    "sha": "5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f",
    "files": [
        {
            "sha": "dc7e452a11ef41190e185eed17e361aecba09447",
            "filename": "packages/compiler/src/render3/r3_ast.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts?ref=5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f",
            "patch": "@@ -16,6 +16,19 @@ export interface Node {\n   visit<Result>(visitor: Visitor<Result>): Result;\n }\n \n+/**\n+ * This is an R3 `Node`-like wrapper for a raw `html.Comment` node. We do not currently\n+ * require the implementation of a visitor for Comments as they are only collected at\n+ * the top-level of the R3 AST, and only if `Render3ParseOptions['collectCommentNodes']`\n+ * is true.\n+ */\n+export class Comment implements Node {\n+  constructor(public value: string, public sourceSpan: ParseSourceSpan) {}\n+  visit<Result>(_visitor: Visitor<Result>): Result {\n+    throw new Error('visit() not implemented for Comment');\n+  }\n+}\n+\n export class Text implements Node {\n   constructor(public value: string, public sourceSpan: ParseSourceSpan) {}\n   visit<Result>(visitor: Visitor<Result>): Result {"
        },
        {
            "sha": "a09a4e0aae9e2662b42cd2ad336315a57fc6bcf6",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 5,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f",
            "patch": "@@ -51,33 +51,46 @@ export interface Render3ParseResult {\n   styles: string[];\n   styleUrls: string[];\n   ngContentSelectors: string[];\n+  // Will be defined if `Render3ParseOptions['collectCommentNodes']` is true\n+  commentNodes?: t.Comment[];\n+}\n+\n+interface Render3ParseOptions {\n+  collectCommentNodes: boolean;\n }\n \n export function htmlAstToRender3Ast(\n-    htmlNodes: html.Node[], bindingParser: BindingParser): Render3ParseResult {\n-  const transformer = new HtmlAstToIvyAst(bindingParser);\n+    htmlNodes: html.Node[], bindingParser: BindingParser,\n+    options: Render3ParseOptions): Render3ParseResult {\n+  const transformer = new HtmlAstToIvyAst(bindingParser, options);\n   const ivyNodes = html.visitAll(transformer, htmlNodes);\n \n   // Errors might originate in either the binding parser or the html to ivy transformer\n   const allErrors = bindingParser.errors.concat(transformer.errors);\n \n-  return {\n+  const result: Render3ParseResult = {\n     nodes: ivyNodes,\n     errors: allErrors,\n     styleUrls: transformer.styleUrls,\n     styles: transformer.styles,\n-    ngContentSelectors: transformer.ngContentSelectors,\n+    ngContentSelectors: transformer.ngContentSelectors\n   };\n+  if (options.collectCommentNodes) {\n+    result.commentNodes = transformer.commentNodes;\n+  }\n+  return result;\n }\n \n class HtmlAstToIvyAst implements html.Visitor {\n   errors: ParseError[] = [];\n   styles: string[] = [];\n   styleUrls: string[] = [];\n   ngContentSelectors: string[] = [];\n+  // This array will be populated if `Render3ParseOptions['collectCommentNodes']` is true\n+  commentNodes: t.Comment[] = [];\n   private inI18nBlock: boolean = false;\n \n-  constructor(private bindingParser: BindingParser) {}\n+  constructor(private bindingParser: BindingParser, private options: Render3ParseOptions) {}\n \n   // HTML visitor\n   visitElement(element: html.Element): t.Node|null {\n@@ -287,6 +300,9 @@ class HtmlAstToIvyAst implements html.Visitor {\n   }\n \n   visitComment(comment: html.Comment): null {\n+    if (this.options.collectCommentNodes) {\n+      this.commentNodes.push(new t.Comment(comment.value || '', comment.sourceSpan));\n+    }\n     return null;\n   }\n "
        },
        {
            "sha": "e75f7885a44acc503f1fc9ef69a855534b6cf8eb",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 5,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f",
            "patch": "@@ -2112,6 +2112,16 @@ export interface ParseTemplateOptions {\n    * output, but this is done after converting the HTML AST to R3 AST.\n    */\n   alwaysAttemptHtmlToR3AstConversion?: boolean;\n+\n+  /**\n+   * Include HTML Comment nodes in a top-level comments array on the returned R3 AST.\n+   *\n+   * This option is required by tooling that needs to know the location of comment nodes within the\n+   * AST. A concrete example is @angular-eslint which requires this in order to enable\n+   * \"eslint-disable\" comments within HTML templates, which then allows users to turn off specific\n+   * rules on a case by case basis, instead of for their whole project within a configuration file.\n+   */\n+  collectCommentNodes?: boolean;\n }\n \n /**\n@@ -2133,7 +2143,7 @@ export function parseTemplate(\n \n   if (!options.alwaysAttemptHtmlToR3AstConversion && parseResult.errors &&\n       parseResult.errors.length > 0) {\n-    return {\n+    const parsedTemplate: ParsedTemplate = {\n       interpolationConfig,\n       preserveWhitespaces,\n       template,\n@@ -2145,6 +2155,10 @@ export function parseTemplate(\n       styles: [],\n       ngContentSelectors: []\n     };\n+    if (options.collectCommentNodes) {\n+      parsedTemplate.commentNodes = [];\n+    }\n+    return parsedTemplate;\n   }\n \n   let rootNodes: html.Node[] = parseResult.rootNodes;\n@@ -2160,7 +2174,7 @@ export function parseTemplate(\n \n   if (!options.alwaysAttemptHtmlToR3AstConversion && i18nMetaResult.errors &&\n       i18nMetaResult.errors.length > 0) {\n-    return {\n+    const parsedTemplate: ParsedTemplate = {\n       interpolationConfig,\n       preserveWhitespaces,\n       template,\n@@ -2172,6 +2186,10 @@ export function parseTemplate(\n       styles: [],\n       ngContentSelectors: []\n     };\n+    if (options.collectCommentNodes) {\n+      parsedTemplate.commentNodes = [];\n+    }\n+    return parsedTemplate;\n   }\n \n   rootNodes = i18nMetaResult.rootNodes;\n@@ -2189,11 +2207,11 @@ export function parseTemplate(\n     }\n   }\n \n-  const {nodes, errors, styleUrls, styles, ngContentSelectors} =\n-      htmlAstToRender3Ast(rootNodes, bindingParser);\n+  const {nodes, errors, styleUrls, styles, ngContentSelectors, commentNodes} = htmlAstToRender3Ast(\n+      rootNodes, bindingParser, {collectCommentNodes: !!options.collectCommentNodes});\n   errors.push(...parseResult.errors, ...i18nMetaResult.errors);\n \n-  return {\n+  const parsedTemplate: ParsedTemplate = {\n     interpolationConfig,\n     preserveWhitespaces,\n     errors: errors.length > 0 ? errors : null,\n@@ -2205,6 +2223,10 @@ export function parseTemplate(\n     styles,\n     ngContentSelectors\n   };\n+  if (options.collectCommentNodes) {\n+    parsedTemplate.commentNodes = commentNodes;\n+  }\n+  return parsedTemplate;\n }\n \n const elementRegistry = new DomElementSchemaRegistry();\n@@ -2410,4 +2432,10 @@ export interface ParsedTemplate {\n    * Any ng-content selectors extracted from the template.\n    */\n   ngContentSelectors: string[];\n+\n+  /**\n+   * Any R3 Comment Nodes extracted from the template when the `collectCommentNodes` parse template\n+   * option is enabled.\n+   */\n+  commentNodes?: t.Comment[];\n }"
        },
        {
            "sha": "d795b055faf42a0c1efde476ae915ce0629e4001",
            "filename": "packages/compiler/test/render3/view/parse_template_options_spec.ts",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fparse_template_options_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fparse_template_options_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fparse_template_options_spec.ts?ref=5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f",
            "patch": "@@ -0,0 +1,47 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {ParseSourceSpan} from '../../../src/parse_util';\n+import {Comment} from '../../../src/render3/r3_ast';\n+import {parseTemplate} from '../../../src/render3/view/template';\n+\n+describe('collectCommentNodes', () => {\n+  it('should include an array of HTML comment nodes on the returned R3 AST', () => {\n+    const html = `\n+      <!-- eslint-disable-next-line -->\n+      <div *ngFor=\"let item of items\">\n+        {{item.name}}\n+      </div>\n+\n+      <div>\n+        <p>\n+          <!-- some nested comment -->\n+          <span>Text</span>\n+        </p>\n+      </div>\n+    `;\n+\n+    const templateNoCommentsOption = parseTemplate(html, '', {});\n+    expect(templateNoCommentsOption.commentNodes).toBeUndefined();\n+\n+    const templateCommentsOptionDisabled = parseTemplate(html, '', {collectCommentNodes: false});\n+    expect(templateCommentsOptionDisabled.commentNodes).toBeUndefined();\n+\n+    const templateCommentsOptionEnabled = parseTemplate(html, '', {collectCommentNodes: true});\n+    expect(templateCommentsOptionEnabled.commentNodes!.length).toEqual(2);\n+    expect(templateCommentsOptionEnabled.commentNodes![0]).toBeInstanceOf(Comment);\n+    expect(templateCommentsOptionEnabled.commentNodes![0].value)\n+        .toEqual('eslint-disable-next-line');\n+    expect(templateCommentsOptionEnabled.commentNodes![0].sourceSpan)\n+        .toBeInstanceOf(ParseSourceSpan);\n+    expect(templateCommentsOptionEnabled.commentNodes![1]).toBeInstanceOf(Comment);\n+    expect(templateCommentsOptionEnabled.commentNodes![1].value).toEqual('some nested comment');\n+    expect(templateCommentsOptionEnabled.commentNodes![1].sourceSpan)\n+        .toBeInstanceOf(ParseSourceSpan);\n+  });\n+});"
        },
        {
            "sha": "cf99f7f34c4b7e1f1aa985b360f77833c7e598e3",
            "filename": "packages/compiler/test/render3/view/util.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Futil.ts?ref=5e46901ffcaecfef42ad0bae8eb2ff1b84371c0f",
            "patch": "@@ -107,7 +107,7 @@ export function parseR3(\n       ['onEvent'], ['onEvent']);\n   const bindingParser =\n       new BindingParser(expressionParser, DEFAULT_INTERPOLATION_CONFIG, schemaRegistry, null, []);\n-  const r3Result = htmlAstToRender3Ast(htmlNodes, bindingParser);\n+  const r3Result = htmlAstToRender3Ast(htmlNodes, bindingParser, {collectCommentNodes: false});\n \n   if (r3Result.errors.length > 0 && !options.ignoreError) {\n     const msg = r3Result.errors.map(e => e.toString()).join('\\n');"
        }
    ],
    "stats": {
        "total": 126,
        "additions": 115,
        "deletions": 11
    }
}