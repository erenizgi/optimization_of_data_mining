{
    "author": "petebacondarwin",
    "message": "fix(ngcc): report a warning if ngcc tries to use a solution-style tsconfig (#38003)\n\nIn CLI v10 there was a move to use the new solution-style tsconfig\nwhich became available in TS 3.9.\n\nThe result of this is that the standard tsconfig.json no longer contains\nimportant information such as \"paths\" mappings, which ngcc might need to\ncorrectly compute dependencies.\n\nngcc (and ngc and tsc) infer the path to tsconfig.json if not given an\nexplicit tsconfig file-path. But now that means it infers the solution\ntsconfig rather than one that contains the useful information it used to\nget.\n\nThis commit logs a warning in this case to inform the developer\nthat they might not have meant to load this tsconfig and offer\nalternative options.\n\nFixes #36386\n\nPR Close #38003",
    "sha": "b358495a6c46dedae3a5edd2dcbcc80fc73739e8",
    "files": [
        {
            "sha": "7ef38ec650f803c400f5b6fa3cec1cf8c2da87d1",
            "filename": "packages/compiler-cli/ngcc/src/ngcc_options.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/b358495a6c46dedae3a5edd2dcbcc80fc73739e8/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fngcc_options.ts",
            "raw_url": "https://github.com/angular/angular/raw/b358495a6c46dedae3a5edd2dcbcc80fc73739e8/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fngcc_options.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fngcc_options.ts?ref=b358495a6c46dedae3a5edd2dcbcc80fc73739e8",
            "patch": "@@ -186,6 +186,8 @@ export function getSharedSetup(options: NgccOptions): SharedSetup&RequiredNgccOp\n     errorOnFailedEntryPoint = true;\n   }\n \n+  checkForSolutionStyleTsConfig(fileSystem, logger, projectPath, options.tsConfigPath, tsConfig);\n+\n   return {\n     basePath,\n     targetEntryPointPath,\n@@ -233,3 +235,22 @@ export function clearTsConfigCache() {\n   tsConfigPathCache = null;\n   tsConfigCache = null;\n }\n+\n+function checkForSolutionStyleTsConfig(\n+    fileSystem: FileSystem, logger: Logger, projectPath: AbsoluteFsPath,\n+    tsConfigPath: string|null|undefined, tsConfig: ParsedConfiguration|null): void {\n+  if (tsConfigPath !== null && !tsConfigPath && tsConfig !== null &&\n+      tsConfig.rootNames.length === 0 && tsConfig.projectReferences !== undefined &&\n+      tsConfig.projectReferences.length > 0) {\n+    logger.warn(\n+        `The inferred tsconfig file \"${tsConfig.project}\" appears to be \"solution-style\" ` +\n+        `since it contains no root files but does contain project references.\\n` +\n+        `This is probably not wanted, since ngcc is unable to infer settings like \"paths\" mappings from such a file.\\n` +\n+        `Perhaps you should have explicitly specified one of the referenced projects using the --tsconfig option. For example:\\n\\n` +\n+        tsConfig.projectReferences.map(ref => `  ngcc ... --tsconfig \"${ref.originalPath}\"\\n`)\n+            .join('') +\n+        `\\nFind out more about solution-style tsconfig at https://devblogs.microsoft.com/typescript/announcing-typescript-3-9/#solution-style-tsconfig.\\n` +\n+        `If you did intend to use this file, then you can hide this warning by providing it explicitly:\\n\\n` +\n+        `  ngcc ... --tsconfig \"${fileSystem.relative(projectPath, tsConfig.project)}\"`);\n+  }\n+}"
        },
        {
            "sha": "56fa85b7eb3a74b73e0e8b1a7127f463732f8628",
            "filename": "packages/compiler-cli/ngcc/test/ngcc_options_spec.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/b358495a6c46dedae3a5edd2dcbcc80fc73739e8/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fngcc_options_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b358495a6c46dedae3a5edd2dcbcc80fc73739e8/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fngcc_options_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fngcc_options_spec.ts?ref=b358495a6c46dedae3a5edd2dcbcc80fc73739e8",
            "patch": "@@ -56,6 +56,48 @@ runInEachFileSystem(() => {\n       expect(setup.tsConfigPath).toBe(null);\n       expect(setup.tsConfig).toBe(null);\n     });\n+\n+    it('should warn about a solution-style tsconfig if the tsConfigPath is inferred', () => {\n+      fs.writeFile(fs.resolve(projectPath, 'tsconfig.app.json'), '{\"files\": [\"src/index.ts\"]}');\n+      fs.writeFile(fs.resolve(projectPath, 'tsconfig.test.json'), '{\"files\": [\"src/test.ts\"]}');\n+      fs.writeFile(pathToProjectTsConfig, JSON.stringify({\n+        'files': [],\n+        'references': [\n+          {'path': 'tsconfig.app.json'},\n+          {'path': 'tsconfig.test.json'},\n+        ]\n+      }));\n+      const setup = getSharedSetup({...createOptions()});\n+      expect(setup.tsConfigPath).toBeUndefined();\n+      expect(setup.tsConfig?.rootNames).toEqual([]);\n+      expect((setup.logger as MockLogger).logs.warn).toEqual([[\n+        `The inferred tsconfig file \"${\n+            pathToProjectTsConfig}\" appears to be \"solution-style\" since it contains no root files but does contain project references.\\n` +\n+        `This is probably not wanted, since ngcc is unable to infer settings like \"paths\" mappings from such a file.\\n` +\n+        `Perhaps you should have explicitly specified one of the referenced projects using the --tsconfig option. For example:\\n\\n` +\n+        `  ngcc ... --tsconfig \"tsconfig.app.json\"\\n` +\n+        `  ngcc ... --tsconfig \"tsconfig.test.json\"\\n` +\n+        `\\nFind out more about solution-style tsconfig at https://devblogs.microsoft.com/typescript/announcing-typescript-3-9/#solution-style-tsconfig.\\n` +\n+        `If you did intend to use this file, then you can hide this warning by providing it explicitly:\\n\\n` +\n+        `  ngcc ... --tsconfig \"tsconfig.json\"`\n+      ]]);\n+    });\n+\n+    it('should not warn about a solution-style tsconfig if the tsConfigPath is explicit', () => {\n+      fs.writeFile(fs.resolve(projectPath, 'tsconfig.app.json'), '{\"files\": [\"src/index.ts\"]}');\n+      fs.writeFile(fs.resolve(projectPath, 'tsconfig.test.json'), '{\"files\": [\"src/test.ts\"]}');\n+      fs.writeFile(pathToProjectTsConfig, JSON.stringify({\n+        'files': [],\n+        'references': [\n+          {'path': 'tsconfig.app.json'},\n+          {'path': 'tsconfig.test.json'},\n+        ]\n+      }));\n+      const setup = getSharedSetup({...createOptions(), tsConfigPath: pathToProjectTsConfig});\n+      expect(setup.tsConfigPath).toEqual(pathToProjectTsConfig);\n+      expect(setup.tsConfig?.rootNames).toEqual([]);\n+      expect((setup.logger as MockLogger).logs.warn).toEqual([]);\n+    });\n   });\n \n   /**"
        },
        {
            "sha": "1fc1a42c970d110540b838102db4f7f668e0e21d",
            "filename": "packages/compiler-cli/src/perform_compile.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/b358495a6c46dedae3a5edd2dcbcc80fc73739e8/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "raw_url": "https://github.com/angular/angular/raw/b358495a6c46dedae3a5edd2dcbcc80fc73739e8/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts?ref=b358495a6c46dedae3a5edd2dcbcc80fc73739e8",
            "patch": "@@ -112,6 +112,7 @@ export interface ParsedConfiguration {\n   project: string;\n   options: api.CompilerOptions;\n   rootNames: string[];\n+  projectReferences?: readonly ts.ProjectReference[]|undefined;\n   emitFlags: api.EmitFlags;\n   errors: Diagnostics;\n }\n@@ -197,6 +198,7 @@ export function readConfiguration(\n     const parsed = ts.parseJsonConfigFileContent(\n         config, parseConfigHost, basePath, existingOptions, configFileName);\n     const rootNames = parsed.fileNames;\n+    const projectReferences = parsed.projectReferences;\n \n     const options = createNgCompilerOptions(basePath, config, parsed.options);\n     let emitFlags = api.EmitFlags.Default;\n@@ -206,7 +208,14 @@ export function readConfiguration(\n     if (options.skipTemplateCodegen) {\n       emitFlags = emitFlags & ~api.EmitFlags.Codegen;\n     }\n-    return {project: projectFile, rootNames, options, errors: parsed.errors, emitFlags};\n+    return {\n+      project: projectFile,\n+      rootNames,\n+      projectReferences,\n+      options,\n+      errors: parsed.errors,\n+      emitFlags\n+    };\n   } catch (e) {\n     const errors: Diagnostics = [{\n       category: ts.DiagnosticCategory.Error,"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 73,
        "deletions": 1
    }
}