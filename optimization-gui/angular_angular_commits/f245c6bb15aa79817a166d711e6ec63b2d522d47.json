{
    "author": "bjarkler",
    "message": "fix(core): remove closing body tag from inert DOM builder (#38454)\n\nFix a bug in the HTML sanitizer where an unclosed iframe tag would\nresult in an escaped closing body tag as the output:\n\n_sanitizeHtml(document, '<iframe>') => '&lt;/body&gt;'\n\nThis closing body tag comes from the DOMParserHelper where the HTML to be\nsanitized is wrapped with surrounding body tags. When an opening iframe\ntag is parsed by DOMParser, which DOMParserHelper uses, everything up\nuntil its matching closing tag is consumed as a text node. In the above\nexample this includes the appended closing body tag.\n\nBy removing the explicit closing body tag from the DOMParserHelper and\nrelying on the body tag being closed implicitly at the end, the above\nexample is sanitized as expected:\n\n_sanitizeHtml(document, '<iframe>') => ''\n\nPR Close #38454",
    "sha": "f245c6bb15aa79817a166d711e6ec63b2d522d47",
    "files": [
        {
            "sha": "0d7173f01a52ac0527d0c5f1031f90d8a62cba8f",
            "filename": "packages/core/src/sanitization/inert_body.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/f245c6bb15aa79817a166d711e6ec63b2d522d47/packages%2Fcore%2Fsrc%2Fsanitization%2Finert_body.ts",
            "raw_url": "https://github.com/angular/angular/raw/f245c6bb15aa79817a166d711e6ec63b2d522d47/packages%2Fcore%2Fsrc%2Fsanitization%2Finert_body.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fsanitization%2Finert_body.ts?ref=f245c6bb15aa79817a166d711e6ec63b2d522d47",
            "patch": "@@ -32,8 +32,9 @@ class DOMParserHelper implements InertBodyHelper {\n   getInertBodyElement(html: string): HTMLElement|null {\n     // We add these extra elements to ensure that the rest of the content is parsed as expected\n     // e.g. leading whitespace is maintained and tags like `<meta>` do not get hoisted to the\n-    // `<head>` tag.\n-    html = '<body><remove></remove>' + html + '</body>';\n+    // `<head>` tag. Note that the `<body>` tag is closed implicitly to prevent unclosed tags\n+    // in `html` from consuming the otherwise explicit `</body>` tag.\n+    html = '<body><remove></remove>' + html;\n     try {\n       const body = new (window as any).DOMParser().parseFromString(html, 'text/html').body as\n           HTMLBodyElement;"
        },
        {
            "sha": "d577ce2c4dc7d7f2588d238e43452f47ebe75261",
            "filename": "packages/core/test/sanitization/html_sanitizer_spec.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/f245c6bb15aa79817a166d711e6ec63b2d522d47/packages%2Fcore%2Ftest%2Fsanitization%2Fhtml_sanitizer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f245c6bb15aa79817a166d711e6ec63b2d522d47/packages%2Fcore%2Ftest%2Fsanitization%2Fhtml_sanitizer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fsanitization%2Fhtml_sanitizer_spec.ts?ref=f245c6bb15aa79817a166d711e6ec63b2d522d47",
            "patch": "@@ -173,6 +173,27 @@ import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n       expect(logMsgs.join('\\n')).toMatch(/sanitizing HTML stripped some content/);\n     });\n \n+    it('should strip unclosed iframe tag', () => {\n+      expect(_sanitizeHtml(defaultDoc, '<iframe>')).toEqual('');\n+      expect([\n+        '&lt;iframe&gt;',\n+        // Double-escaped on IE\n+        '&amp;lt;iframe&amp;gt;'\n+      ]).toContain(_sanitizeHtml(defaultDoc, '<iframe><iframe>'));\n+      expect([\n+        '&lt;script&gt;evil();&lt;/script&gt;',\n+        // Double-escaped on IE\n+        '&amp;lt;script&amp;gt;evil();&amp;lt;/script&amp;gt;'\n+      ]).toContain(_sanitizeHtml(defaultDoc, '<iframe><script>evil();</script>'));\n+    });\n+\n+    it('should ignore extraneous body tags', () => {\n+      expect(_sanitizeHtml(defaultDoc, '</body>')).toEqual('');\n+      expect(_sanitizeHtml(defaultDoc, 'foo</body>bar')).toEqual('foobar');\n+      expect(_sanitizeHtml(defaultDoc, 'foo<body>bar')).toEqual('foobar');\n+      expect(_sanitizeHtml(defaultDoc, 'fo<body>ob</body>ar')).toEqual('foobar');\n+    });\n+\n     it('should not enter an infinite loop on clobbered elements', () => {\n       // Some browsers are vulnerable to clobbered elements and will throw an expected exception\n       // IE and EDGE does not seems to be affected by those cases"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 24,
        "deletions": 2
    }
}