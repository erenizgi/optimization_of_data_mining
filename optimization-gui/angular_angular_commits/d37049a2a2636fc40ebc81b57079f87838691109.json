{
    "author": "CaerusKaru",
    "message": "feat(platform-server): add option for absolute URL HTTP support (#37539)\n\nIn version 10.0.0-next.8, we introduced absolute URL support for\nserver-based HTTP requests, so long as the fully-resolved URL was\nprovided in the initial config. However, doing so represents a\nbreaking change for users who already have their own interceptors\nto model this functionality, since our logic executes before all\ninterceptors fire on a request. See original PR #37071.\n\nTherefore, we introduce a flag to make this change consistent with\nv9 behavior, allowing users to opt in to this new behavior. This\ncommit also fixes two issues with the previous implementation:\n1. if the server was initiated with a relative URL, the absolute\nURL construction would fail because needed components were empty\n2. if the user's absolute URL was on a port, the port would not\nbe included\n\nPR Close #37539",
    "sha": "d37049a2a2636fc40ebc81b57079f87838691109",
    "files": [
        {
            "sha": "7db0b77e9777fc2d96ddf8f70a1271301a604c9d",
            "filename": "goldens/public-api/platform-server/platform-server.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d37049a2a2636fc40ebc81b57079f87838691109/goldens%2Fpublic-api%2Fplatform-server%2Fplatform-server.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/d37049a2a2636fc40ebc81b57079f87838691109/goldens%2Fpublic-api%2Fplatform-server%2Fplatform-server.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fplatform-server%2Fplatform-server.d.ts?ref=d37049a2a2636fc40ebc81b57079f87838691109",
            "patch": "@@ -5,6 +5,7 @@ export declare const INITIAL_CONFIG: InjectionToken<PlatformConfig>;\n export declare interface PlatformConfig {\n     document?: string;\n     url?: string;\n+    useAbsoluteUrl?: boolean;\n }\n \n export declare const platformDynamicServer: (extraProviders?: StaticProvider[] | undefined) => PlatformRef;"
        },
        {
            "sha": "be178f3765978d4b036283bd1d0fdce2664c563c",
            "filename": "packages/platform-server/src/http.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 7,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/d37049a2a2636fc40ebc81b57079f87838691109/packages%2Fplatform-server%2Fsrc%2Fhttp.ts",
            "raw_url": "https://github.com/angular/angular/raw/d37049a2a2636fc40ebc81b57079f87838691109/packages%2Fplatform-server%2Fsrc%2Fhttp.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-server%2Fsrc%2Fhttp.ts?ref=d37049a2a2636fc40ebc81b57079f87838691109",
            "patch": "@@ -5,6 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {INITIAL_CONFIG, PlatformConfig} from './tokens';\n \n \n const xhr2: any = require('xhr2');\n@@ -104,15 +105,18 @@ export abstract class ZoneMacroTaskWrapper<S, R> {\n \n export class ZoneClientBackend extends\n     ZoneMacroTaskWrapper<HttpRequest<any>, HttpEvent<any>> implements HttpBackend {\n-  constructor(private backend: HttpBackend, private platformLocation: PlatformLocation) {\n+  constructor(\n+      private backend: HttpBackend, private platformLocation: PlatformLocation,\n+      private config: PlatformConfig) {\n     super();\n   }\n \n   handle(request: HttpRequest<any>): Observable<HttpEvent<any>> {\n-    const {href, protocol, hostname} = this.platformLocation;\n-    if (!isAbsoluteUrl.test(request.url) && href !== '/') {\n+    const {href, protocol, hostname, port} = this.platformLocation;\n+    if (this.config.useAbsoluteUrl && !isAbsoluteUrl.test(request.url) &&\n+        isAbsoluteUrl.test(href)) {\n       const baseHref = this.platformLocation.getBaseHrefFromDOM() || href;\n-      const urlPrefix = `${protocol}//${hostname}`;\n+      const urlPrefix = `${protocol}//${hostname}` + (port ? `:${port}` : '');\n       const baseUrl = new URL(baseHref, urlPrefix);\n       const url = new URL(request.url, baseUrl);\n       return this.wrap(request.clone({url: url.toString()}));\n@@ -126,15 +130,16 @@ export class ZoneClientBackend extends\n }\n \n export function zoneWrappedInterceptingHandler(\n-    backend: HttpBackend, injector: Injector, platformLocation: PlatformLocation) {\n+    backend: HttpBackend, injector: Injector, platformLocation: PlatformLocation,\n+    config: PlatformConfig) {\n   const realBackend: HttpBackend = new HttpInterceptingHandler(backend, injector);\n-  return new ZoneClientBackend(realBackend, platformLocation);\n+  return new ZoneClientBackend(realBackend, platformLocation, config);\n }\n \n export const SERVER_HTTP_PROVIDERS: Provider[] = [\n   {provide: XhrFactory, useClass: ServerXhr}, {\n     provide: HttpHandler,\n     useFactory: zoneWrappedInterceptingHandler,\n-    deps: [HttpBackend, Injector, PlatformLocation]\n+    deps: [HttpBackend, Injector, PlatformLocation, INITIAL_CONFIG]\n   }\n ];"
        },
        {
            "sha": "b5942985d142e2f221c5a78389f5db0955ea2a2a",
            "filename": "packages/platform-server/src/tokens.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/d37049a2a2636fc40ebc81b57079f87838691109/packages%2Fplatform-server%2Fsrc%2Ftokens.ts",
            "raw_url": "https://github.com/angular/angular/raw/d37049a2a2636fc40ebc81b57079f87838691109/packages%2Fplatform-server%2Fsrc%2Ftokens.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-server%2Fsrc%2Ftokens.ts?ref=d37049a2a2636fc40ebc81b57079f87838691109",
            "patch": "@@ -14,8 +14,25 @@ import {InjectionToken} from '@angular/core';\n  * @publicApi\n  */\n export interface PlatformConfig {\n+  /**\n+   * The initial DOM to use to bootstrap the server application.\n+   * @default create a new DOM using Domino\n+   */\n   document?: string;\n+  /**\n+   * The URL for the current application state. This is\n+   * used for initializing the platform's location and\n+   * for setting absolute URL resolution for HTTP requests.\n+   * @default none\n+   */\n   url?: string;\n+  /**\n+   * Whether to append the absolute URL to any relative HTTP\n+   * requests. If set to true, this logic executes prior to\n+   * any HTTP interceptors that may run later on in the request.\n+   * @default false\n+   */\n+  useAbsoluteUrl?: boolean;\n }\n \n /**"
        },
        {
            "sha": "5703c00885b7c02fc6127e07bdbc00407d518133",
            "filename": "packages/platform-server/test/integration_spec.ts",
            "status": "modified",
            "additions": 126,
            "deletions": 81,
            "changes": 207,
            "blob_url": "https://github.com/angular/angular/blob/d37049a2a2636fc40ebc81b57079f87838691109/packages%2Fplatform-server%2Ftest%2Fintegration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d37049a2a2636fc40ebc81b57079f87838691109/packages%2Fplatform-server%2Ftest%2Fintegration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-server%2Ftest%2Fintegration_spec.ts?ref=d37049a2a2636fc40ebc81b57079f87838691109",
            "patch": "@@ -793,104 +793,149 @@ describe('platform-server integration', () => {\n          });\n        }));\n \n-    it('can make relative HttpClient requests', async () => {\n-      const platform = platformDynamicServer([\n-        {provide: INITIAL_CONFIG, useValue: {document: '<app></app>', url: 'http://localhost'}}\n-      ]);\n-      const ref = await platform.bootstrapModule(HttpClientExampleModule);\n-      const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n-      const http = ref.injector.get(HttpClient);\n-      ref.injector.get(NgZone).run(() => {\n-        http.get<string>('/testing').subscribe((body: string) => {\n-          NgZone.assertInAngularZone();\n-          expect(body).toEqual('success!');\n+    describe('relative requests', () => {\n+      it('correctly maps to absolute URL request with base config', async () => {\n+        const platform = platformDynamicServer([{\n+          provide: INITIAL_CONFIG,\n+          useValue: {document: '<app></app>', url: 'http://localhost', useAbsoluteUrl: true}\n+        }]);\n+        const ref = await platform.bootstrapModule(HttpClientExampleModule);\n+        const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n+        const http = ref.injector.get(HttpClient);\n+        ref.injector.get(NgZone).run(() => {\n+          http.get<string>('/testing').subscribe((body: string) => {\n+            NgZone.assertInAngularZone();\n+            expect(body).toEqual('success!');\n+          });\n+          mock.expectOne('http://localhost/testing').flush('success!');\n         });\n-        mock.expectOne('http://localhost/testing').flush('success!');\n       });\n-    });\n \n-    it('can make relative HttpClient requests two slashes', async () => {\n-      const platform = platformDynamicServer([\n-        {provide: INITIAL_CONFIG, useValue: {document: '<app></app>', url: 'http://localhost/'}}\n-      ]);\n-      const ref = await platform.bootstrapModule(HttpClientExampleModule);\n-      const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n-      const http = ref.injector.get(HttpClient);\n-      ref.injector.get(NgZone).run(() => {\n-        http.get<string>('/testing').subscribe((body: string) => {\n-          NgZone.assertInAngularZone();\n-          expect(body).toEqual('success!');\n+      it('uses default URL behavior when not enabled', async () => {\n+        const platform = platformDynamicServer([{\n+          provide: INITIAL_CONFIG,\n+          useValue: {document: '<app></app>', url: 'http://localhost', useAbsoluteUrl: false}\n+        }]);\n+        const ref = await platform.bootstrapModule(HttpClientExampleModule);\n+        const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n+        const http = ref.injector.get(HttpClient);\n+        ref.injector.get(NgZone).run(() => {\n+          http.get<string>('/testing').subscribe(() => {}, (body: string) => {\n+            NgZone.assertInAngularZone();\n+            expect(body).toEqual('error');\n+          });\n+          mock.expectOne('/testing').flush('error');\n         });\n-        mock.expectOne('http://localhost/testing').flush('success!');\n       });\n-    });\n \n-    it('can make relative HttpClient requests no slashes', async () => {\n-      const platform = platformDynamicServer([\n-        {provide: INITIAL_CONFIG, useValue: {document: '<app></app>', url: 'http://localhost'}}\n-      ]);\n-      const ref = await platform.bootstrapModule(HttpClientExampleModule);\n-      const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n-      const http = ref.injector.get(HttpClient);\n-      ref.injector.get(NgZone).run(() => {\n-        http.get<string>('testing').subscribe((body: string) => {\n-          NgZone.assertInAngularZone();\n-          expect(body).toEqual('success!');\n+      it('correctly maps to absolute URL request with port', async () => {\n+        const platform = platformDynamicServer([{\n+          provide: INITIAL_CONFIG,\n+          useValue: {document: '<app></app>', url: 'http://localhost:5000', useAbsoluteUrl: true}\n+        }]);\n+        const ref = await platform.bootstrapModule(HttpClientExampleModule);\n+        const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n+        const http = ref.injector.get(HttpClient);\n+        ref.injector.get(NgZone).run(() => {\n+          http.get<string>('/testing').subscribe((body: string) => {\n+            NgZone.assertInAngularZone();\n+            expect(body).toEqual('success!');\n+          });\n+          mock.expectOne('http://localhost:5000/testing').flush('success!');\n         });\n-        mock.expectOne('http://localhost/testing').flush('success!');\n       });\n-    });\n \n-    it('can make relative HttpClient requests no slashes longer url', async () => {\n-      const platform = platformDynamicServer([{\n-        provide: INITIAL_CONFIG,\n-        useValue: {document: '<app></app>', url: 'http://localhost/path/page'}\n-      }]);\n-      const ref = await platform.bootstrapModule(HttpClientExampleModule);\n-      const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n-      const http = ref.injector.get(HttpClient);\n-      ref.injector.get(NgZone).run(() => {\n-        http.get<string>('testing').subscribe((body: string) => {\n-          NgZone.assertInAngularZone();\n-          expect(body).toEqual('success!');\n+      it('correctly maps to absolute URL request with two slashes', async () => {\n+        const platform = platformDynamicServer([{\n+          provide: INITIAL_CONFIG,\n+          useValue: {document: '<app></app>', url: 'http://localhost/', useAbsoluteUrl: true}\n+        }]);\n+        const ref = await platform.bootstrapModule(HttpClientExampleModule);\n+        const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n+        const http = ref.injector.get(HttpClient);\n+        ref.injector.get(NgZone).run(() => {\n+          http.get<string>('/testing').subscribe((body: string) => {\n+            NgZone.assertInAngularZone();\n+            expect(body).toEqual('success!');\n+          });\n+          mock.expectOne('http://localhost/testing').flush('success!');\n         });\n-        mock.expectOne('http://localhost/path/testing').flush('success!');\n       });\n-    });\n \n-    it('can make relative HttpClient requests slashes longer url', async () => {\n-      const platform = platformDynamicServer([{\n-        provide: INITIAL_CONFIG,\n-        useValue: {document: '<app></app>', url: 'http://localhost/path/page'}\n-      }]);\n-      const ref = await platform.bootstrapModule(HttpClientExampleModule);\n-      const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n-      const http = ref.injector.get(HttpClient);\n-      ref.injector.get(NgZone).run(() => {\n-        http.get<string>('/testing').subscribe((body: string) => {\n-          NgZone.assertInAngularZone();\n-          expect(body).toEqual('success!');\n+      it('correctly maps to absolute URL request with no slashes', async () => {\n+        const platform = platformDynamicServer([{\n+          provide: INITIAL_CONFIG,\n+          useValue: {document: '<app></app>', url: 'http://localhost', useAbsoluteUrl: true}\n+        }]);\n+        const ref = await platform.bootstrapModule(HttpClientExampleModule);\n+        const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n+        const http = ref.injector.get(HttpClient);\n+        ref.injector.get(NgZone).run(() => {\n+          http.get<string>('testing').subscribe((body: string) => {\n+            NgZone.assertInAngularZone();\n+            expect(body).toEqual('success!');\n+          });\n+          mock.expectOne('http://localhost/testing').flush('success!');\n         });\n-        mock.expectOne('http://localhost/testing').flush('success!');\n       });\n-    });\n \n-    it('can make relative HttpClient requests slashes longer url with base href', async () => {\n-      const platform = platformDynamicServer([{\n-        provide: INITIAL_CONFIG,\n-        useValue:\n-            {document: '<base href=\"http://other\"><app></app>', url: 'http://localhost/path/page'}\n-      }]);\n-      const ref = await platform.bootstrapModule(HttpClientExampleModule);\n-      const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n-      const http = ref.injector.get(HttpClient);\n-      ref.injector.get(NgZone).run(() => {\n-        http.get<string>('/testing').subscribe((body: string) => {\n-          NgZone.assertInAngularZone();\n-          expect(body).toEqual('success!');\n+      it('correctly maps to absolute URL request with longer url and no slashes', async () => {\n+        const platform = platformDynamicServer([{\n+          provide: INITIAL_CONFIG,\n+          useValue:\n+              {document: '<app></app>', url: 'http://localhost/path/page', useAbsoluteUrl: true}\n+        }]);\n+        const ref = await platform.bootstrapModule(HttpClientExampleModule);\n+        const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n+        const http = ref.injector.get(HttpClient);\n+        ref.injector.get(NgZone).run(() => {\n+          http.get<string>('testing').subscribe((body: string) => {\n+            NgZone.assertInAngularZone();\n+            expect(body).toEqual('success!');\n+          });\n+          mock.expectOne('http://localhost/path/testing').flush('success!');\n+        });\n+      });\n+\n+      it('correctly maps to absolute URL request with longer url and slashes', async () => {\n+        const platform = platformDynamicServer([{\n+          provide: INITIAL_CONFIG,\n+          useValue:\n+              {document: '<app></app>', url: 'http://localhost/path/page', useAbsoluteUrl: true}\n+        }]);\n+        const ref = await platform.bootstrapModule(HttpClientExampleModule);\n+        const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n+        const http = ref.injector.get(HttpClient);\n+        ref.injector.get(NgZone).run(() => {\n+          http.get<string>('/testing').subscribe((body: string) => {\n+            NgZone.assertInAngularZone();\n+            expect(body).toEqual('success!');\n+          });\n+          mock.expectOne('http://localhost/testing').flush('success!');\n         });\n-        mock.expectOne('http://other/testing').flush('success!');\n       });\n+\n+      it('correctly maps to absolute URL request with longer url, slashes, and base href',\n+         async () => {\n+           const platform = platformDynamicServer([{\n+             provide: INITIAL_CONFIG,\n+             useValue: {\n+               document: '<base href=\"http://other\"><app></app>',\n+               url: 'http://localhost/path/page',\n+               useAbsoluteUrl: true\n+             }\n+           }]);\n+           const ref = await platform.bootstrapModule(HttpClientExampleModule);\n+           const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n+           const http = ref.injector.get(HttpClient);\n+           ref.injector.get(NgZone).run(() => {\n+             http.get<string>('/testing').subscribe((body: string) => {\n+               NgZone.assertInAngularZone();\n+               expect(body).toEqual('success!');\n+             });\n+             mock.expectOne('http://other/testing').flush('success!');\n+           });\n+         });\n     });\n \n     it('requests are macrotasks', async(() => {"
        }
    ],
    "stats": {
        "total": 244,
        "additions": 156,
        "deletions": 88
    }
}