{
    "author": "crisbeto",
    "message": "fix(core): error when invoking callbacks registered via ViewRef.onDestroy (#37543)\n\nInvoking a callback registered through `ViewRef.onDestroy` throws an error, because we weren't registering it correctly in the internal data structure. These changes also remove the `storeCleanupFn` function, because it was mostly identical to `storeCleanupWithContext` and was only used in one place.\n\nFixes #36213.\n\nPR Close #37543",
    "sha": "543b6797629aa25b725abcaf8f148296265715a4",
    "files": [
        {
            "sha": "0afae0d5e613550fb3e026402a4cf00e05c5b87f",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 16,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/543b6797629aa25b725abcaf8f148296265715a4/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/543b6797629aa25b725abcaf8f148296265715a4/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=543b6797629aa25b725abcaf8f148296265715a4",
            "patch": "@@ -795,22 +795,6 @@ export function storeCleanupWithContext(\n   }\n }\n \n-/**\n- * Saves the cleanup function itself in LView.cleanupInstances.\n- *\n- * This is necessary for functions that are wrapped with their contexts, like in renderer2\n- * listeners.\n- *\n- * On the first template pass, the index of the cleanup function is saved in TView.\n- */\n-export function storeCleanupFn(tView: TView, lView: LView, cleanupFn: Function): void {\n-  getLCleanup(lView).push(cleanupFn);\n-\n-  if (tView.firstCreatePass) {\n-    getTViewCleanup(tView).push(lView[CLEANUP]!.length - 1, null);\n-  }\n-}\n-\n /**\n  * Constructs a TNode object from the arguments.\n  *"
        },
        {
            "sha": "f4df71d91dc920ae9a20bcc44c6a068465a1a28c",
            "filename": "packages/core/src/render3/view_ref.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/543b6797629aa25b725abcaf8f148296265715a4/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/543b6797629aa25b725abcaf8f148296265715a4/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts?ref=543b6797629aa25b725abcaf8f148296265715a4",
            "patch": "@@ -11,7 +11,7 @@ import {ChangeDetectorRef as viewEngine_ChangeDetectorRef} from '../change_detec\n import {ViewContainerRef as viewEngine_ViewContainerRef} from '../linker/view_container_ref';\n import {EmbeddedViewRef as viewEngine_EmbeddedViewRef, InternalViewRef as viewEngine_InternalViewRef} from '../linker/view_ref';\n import {assertDefined} from '../util/assert';\n-import {checkNoChangesInRootView, checkNoChangesInternal, detectChangesInRootView, detectChangesInternal, markViewDirty, storeCleanupFn} from './instructions/shared';\n+import {checkNoChangesInRootView, checkNoChangesInternal, detectChangesInRootView, detectChangesInternal, markViewDirty, storeCleanupWithContext} from './instructions/shared';\n import {CONTAINER_HEADER_OFFSET} from './interfaces/container';\n import {TElementNode, TNode, TNodeType, TViewNode} from './interfaces/node';\n import {isLContainer} from './interfaces/type_checks';\n@@ -88,7 +88,7 @@ export class ViewRef<T> implements viewEngine_EmbeddedViewRef<T>, viewEngine_Int\n   }\n \n   onDestroy(callback: Function) {\n-    storeCleanupFn(this._lView[TVIEW], this._lView, callback);\n+    storeCleanupWithContext(this._lView[TVIEW], this._lView, null, callback);\n   }\n \n   /**"
        },
        {
            "sha": "21b82a17fb797a79e43c4c98cb81add8fa0544d2",
            "filename": "packages/core/test/acceptance/view_ref_spec.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/543b6797629aa25b725abcaf8f148296265715a4/packages%2Fcore%2Ftest%2Facceptance%2Fview_ref_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/543b6797629aa25b725abcaf8f148296265715a4/packages%2Fcore%2Ftest%2Facceptance%2Fview_ref_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fview_ref_spec.ts?ref=543b6797629aa25b725abcaf8f148296265715a4",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ApplicationRef, Component, ComponentFactoryResolver, ComponentRef, ElementRef, Injector, NgModule} from '@angular/core';\n+import {ApplicationRef, ChangeDetectorRef, Component, ComponentFactoryResolver, ComponentRef, ElementRef, Injector, NgModule} from '@angular/core';\n import {InternalViewRef} from '@angular/core/src/linker/view_ref';\n import {TestBed} from '@angular/core/testing';\n \n@@ -54,4 +54,22 @@ describe('ViewRef', () => {\n     fixture.detectChanges();\n     expect(document.body.querySelector('dynamic-cpt')).toBeFalsy();\n   });\n+\n+  it('should invoke the onDestroy callback of a view ref', () => {\n+    let called = false;\n+\n+    @Component({template: ''})\n+    class App {\n+      constructor(changeDetectorRef: ChangeDetectorRef) {\n+        (changeDetectorRef as InternalViewRef).onDestroy(() => called = true);\n+      }\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [App]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+    fixture.destroy();\n+\n+    expect(called).toBe(true);\n+  });\n });"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 21,
        "deletions": 19
    }
}