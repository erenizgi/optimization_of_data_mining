{
    "author": "petebacondarwin",
    "message": "fix(compiler): ensure that i18n message-parts have the correct source-span (#39486)\n\nIn an i18n message, two placeholders next to each other must have\nan \"empty\" message-part to separate them. Previously, the source-span\nfor this message-part was pointing to the wrong original location.\nThis caused problems in the generated source-maps and lead to extracted\ni18n messages from being rendered incorrectly.\n\nPR Close #39486",
    "sha": "3f4fe452777395f737a6568df6782a54ff05f818",
    "files": [
        {
            "sha": "b57593e4d85549ae03c13bb95d1178afd80a1bdb",
            "filename": "packages/compiler/src/render3/view/i18n/localize_utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/3f4fe452777395f737a6568df6782a54ff05f818/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/3f4fe452777395f737a6568df6782a54ff05f818/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts?ref=3f4fe452777395f737a6568df6782a54ff05f818",
            "patch": "@@ -120,7 +120,7 @@ function processMessagePieces(pieces: o.MessagePiece[]):\n       placeHolders.push(part);\n       if (pieces[i - 1] instanceof o.PlaceholderPiece) {\n         // There were two placeholders in a row, so we need to add an empty message part.\n-        messageParts.push(createEmptyMessagePart(part.sourceSpan.end));\n+        messageParts.push(createEmptyMessagePart(pieces[i - 1].sourceSpan.end));\n       }\n     }\n   }"
        },
        {
            "sha": "2e8ca157b6dd377269647b0d3da3c72c59da4f27",
            "filename": "packages/compiler/test/render3/view/i18n_spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 3,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/3f4fe452777395f737a6568df6782a54ff05f818/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3f4fe452777395f737a6568df6782a54ff05f818/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts?ref=3f4fe452777395f737a6568df6782a54ff05f818",
            "patch": "@@ -489,14 +489,33 @@ describe('serializeI18nMessageForLocalize', () => {\n        expect(placeHolders[3].sourceSpan.toString()).toEqual('</span>');\n      });\n \n+  it('should create the correct source-spans when there are two placeholders next to each other',\n+     () => {\n+       const {messageParts, placeHolders} = serialize('<b>{{value}}</b>');\n+       expect(messageParts[0].text).toEqual('');\n+       expect(humanizeSourceSpan(messageParts[0].sourceSpan)).toEqual('\"\" (10-10)');\n+       expect(messageParts[1].text).toEqual('');\n+       expect(humanizeSourceSpan(messageParts[1].sourceSpan)).toEqual('\"\" (13-13)');\n+       expect(messageParts[2].text).toEqual('');\n+       expect(humanizeSourceSpan(messageParts[2].sourceSpan)).toEqual('\"\" (22-22)');\n+       expect(messageParts[3].text).toEqual('');\n+       expect(humanizeSourceSpan(messageParts[3].sourceSpan)).toEqual('\"\" (26-26)');\n+\n+       expect(placeHolders[0].text).toEqual('START_BOLD_TEXT');\n+       expect(humanizeSourceSpan(placeHolders[0].sourceSpan)).toEqual('\"<b>\" (10-13)');\n+       expect(placeHolders[1].text).toEqual('INTERPOLATION');\n+       expect(humanizeSourceSpan(placeHolders[1].sourceSpan)).toEqual('\"{{value}}\" (13-22)');\n+       expect(placeHolders[2].text).toEqual('CLOSE_BOLD_TEXT');\n+       expect(humanizeSourceSpan(placeHolders[2].sourceSpan)).toEqual('\"</b>\" (22-26)');\n+     });\n+\n   it('should serialize simple ICU for `$localize()`', () => {\n     expect(serialize('{age, plural, 10 {ten} other {other}}')).toEqual({\n       messageParts: [literal('{VAR_PLURAL, plural, 10 {ten} other {other}}')],\n       placeHolders: []\n     });\n   });\n \n-\n   it('should serialize nested ICUs for `$localize()`', () => {\n     expect(serialize(\n                '{age, plural, 10 {ten {size, select, 1 {one} 2 {two} other {2+}}} other {other}}'))\n@@ -509,7 +528,6 @@ describe('serializeI18nMessageForLocalize', () => {\n         });\n   });\n \n-\n   it('should serialize ICU with embedded HTML for `$localize()`', () => {\n     expect(serialize('{age, plural, 10 {<b>ten</b>} other {<div class=\"A\">other</div>}}')).toEqual({\n       messageParts: [\n@@ -594,4 +612,8 @@ function literal(text: string, span: any = jasmine.any(ParseSourceSpan)): o.Lite\n \n function placeholder(name: string, span: any = jasmine.any(ParseSourceSpan)): o.PlaceholderPiece {\n   return new o.PlaceholderPiece(name, span);\n-}\n\\ No newline at end of file\n+}\n+\n+function humanizeSourceSpan(span: ParseSourceSpan): string {\n+  return `\"${span.toString()}\" (${span.start.offset}-${span.end.offset})`;\n+}"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 26,
        "deletions": 4
    }
}