{
    "author": "crisbeto",
    "message": "feat(core): add opt-in test module teardown configuration (#42566)\n\nWe currently have two long-standing issues related to how `TestBed` tests are torn down:\n1. The dynamically-created test module isn't going to be destroyed, preventing the `ngOnDestroy` hooks on providers from running and keeping the component `style` nodes in the DOM.\n2. The test root elements aren't going to be removed from the DOM. Instead, they will be removed whenever another test component is created.\n\nBy themselves, these issues are easy to resolve, but given how long they've been around, there are a lot of unit tests out there that depend on the broken behavior.\n\nThese changes address the issues by introducing APIs that allow users to opt into the correct test teardown behavior either at the application level via `TestBed.initTestEnvironment` or the test suite level via `TestBed.configureTestingModule`.\n\nAt the moment, the new teardown behavior is opt-in, but the idea is that we'll eventually make it opt-out before removing the configuration altogether.\n\nFixes #18831.\n\nPR Close #42566",
    "sha": "873229f24be292ac9e909993e28c2ae2cef4033a",
    "files": [
        {
            "sha": "350814d6c50ce0f1bf66ad67c4b73c84b808cfdc",
            "filename": "goldens/public-api/core/testing/testing.d.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/873229f24be292ac9e909993e28c2ae2cef4033a/goldens%2Fpublic-api%2Fcore%2Ftesting%2Ftesting.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/873229f24be292ac9e909993e28c2ae2cef4033a/goldens%2Fpublic-api%2Fcore%2Ftesting%2Ftesting.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcore%2Ftesting%2Ftesting.d.ts?ref=873229f24be292ac9e909993e28c2ae2cef4033a",
            "patch": "@@ -49,6 +49,11 @@ export declare type MetadataOverride<T> = {\n     set?: Partial<T>;\n };\n \n+export declare interface ModuleTeardownOptions {\n+    destroyAfterEach: boolean;\n+    rethrowErrors?: boolean;\n+}\n+\n export declare function resetFakeAsyncZone(): void;\n \n export declare interface TestBed {\n@@ -64,6 +69,7 @@ export declare interface TestBed {\n     execute(tokens: any[], fn: Function, context?: any): any;\n     /** @deprecated */ get<T>(token: ProviderToken<T>, notFoundValue?: T, flags?: InjectFlags): any;\n     /** @deprecated */ get(token: any, notFoundValue?: any): any;\n+    initTestEnvironment(ngModule: Type<any> | Type<any>[], platform: PlatformRef, options?: TestEnvironmentOptions): void;\n     initTestEnvironment(ngModule: Type<any> | Type<any>[], platform: PlatformRef, aotSummaries?: () => any[]): void;\n     inject<T>(token: ProviderToken<T>, notFoundValue?: T, flags?: InjectFlags): T;\n     inject<T>(token: ProviderToken<T>, notFoundValue: null, flags?: InjectFlags): T | null;\n@@ -101,6 +107,9 @@ export declare interface TestBedStatic {\n     createComponent<T>(component: Type<T>): ComponentFixture<T>;\n     /** @deprecated */ get<T>(token: ProviderToken<T>, notFoundValue?: T, flags?: InjectFlags): any;\n     /** @deprecated */ get(token: any, notFoundValue?: any): any;\n+    initTestEnvironment(ngModule: Type<any> | Type<any>[], platform: PlatformRef, options?: {\n+        teardown?: ModuleTeardownOptions;\n+    }): TestBed;\n     initTestEnvironment(ngModule: Type<any> | Type<any>[], platform: PlatformRef, aotSummaries?: () => any[]): TestBed;\n     inject<T>(token: ProviderToken<T>, notFoundValue?: T, flags?: InjectFlags): T;\n     inject<T>(token: ProviderToken<T>, notFoundValue: null, flags?: InjectFlags): T | null;\n@@ -128,6 +137,12 @@ export declare interface TestBedStatic {\n \n export declare class TestComponentRenderer {\n     insertRootElement(rootElementId: string): void;\n+    removeAllRootElements?(): void;\n+}\n+\n+export declare interface TestEnvironmentOptions {\n+    aotSummaries?: () => any[];\n+    teardown?: ModuleTeardownOptions;\n }\n \n export declare type TestModuleMetadata = {\n@@ -136,6 +151,7 @@ export declare type TestModuleMetadata = {\n     imports?: any[];\n     schemas?: Array<SchemaMetadata | any[]>;\n     aotSummaries?: () => any[];\n+    teardown?: ModuleTeardownOptions;\n };\n \n export declare function tick(millis?: number, tickOptions?: {"
        },
        {
            "sha": "16b1940b6b6cdbb470b1e58329d481ebdc80ebfd",
            "filename": "packages/core/test/acceptance/view_container_ref_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftest%2Facceptance%2Fview_container_ref_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftest%2Facceptance%2Fview_container_ref_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fview_container_ref_spec.ts?ref=873229f24be292ac9e909993e28c2ae2cef4033a",
            "patch": "@@ -2278,6 +2278,11 @@ describe('ViewContainerRef', () => {\n           containerEl = document.createElement('div');\n           document.body.appendChild(containerEl);\n           containerEl!.appendChild(rootEl);\n+        },\n+        removeAllRootElements() {\n+          if (containerEl) {\n+            containerEl.parentNode?.removeChild(containerEl);\n+          }\n         }\n       };\n     }"
        },
        {
            "sha": "6d360229a034da45143d5d0c7500a74732c9548d",
            "filename": "packages/core/test/test_bed_spec.ts",
            "status": "modified",
            "additions": 198,
            "deletions": 1,
            "changes": 199,
            "blob_url": "https://github.com/angular/angular/blob/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts?ref=873229f24be292ac9e909993e28c2ae2cef4033a",
            "patch": "@@ -7,10 +7,11 @@\n  */\n \n import {APP_INITIALIZER, ChangeDetectorRef, Compiler, Component, Directive, ErrorHandler, Inject, Injectable, InjectionToken, Injector, Input, LOCALE_ID, ModuleWithProviders, NgModule, Optional, Pipe, Type, ViewChild, ɵsetClassMetadata as setClassMetadata, ɵɵdefineComponent as defineComponent, ɵɵdefineInjector as defineInjector, ɵɵdefineNgModule as defineNgModule, ɵɵsetNgModuleScope as setNgModuleScope, ɵɵtext as text} from '@angular/core';\n-import {getTestBed, TestBed} from '@angular/core/testing/src/test_bed';\n+import {getTestBed, TestBed, TestBedViewEngine} from '@angular/core/testing/src/test_bed';\n import {By} from '@angular/platform-browser';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n import {onlyInIvy} from '@angular/private/testing';\n+import {TestBedRender3} from '../testing/src/r3_test_bed';\n \n const NAME = new InjectionToken<string>('name');\n \n@@ -1284,3 +1285,199 @@ describe('TestBed', () => {\n         expect(fixture!.nativeElement.textContent).toContain('changed');\n       });\n });\n+\n+\n+describe('TestBed module teardown', () => {\n+  // Cast the `TestBed` to the internal data type since we're testing private APIs.\n+  let TestBed: TestBedRender3|TestBedViewEngine;\n+\n+  beforeEach(() => {\n+    TestBed = getTestBed() as unknown as (TestBedRender3 | TestBedViewEngine);\n+    TestBed.resetTestingModule();\n+  });\n+\n+  it('should not tear down the test module by default', () => {\n+    expect(TestBed.shouldTearDownTestingModule()).toBe(false);\n+  });\n+\n+  it('should be able to configure the teardown behavior', () => {\n+    TestBed.configureTestingModule({teardown: {destroyAfterEach: true}});\n+    expect(TestBed.shouldTearDownTestingModule()).toBe(true);\n+  });\n+\n+  it('should reset the teardown behavior back to the default when TestBed is reset', () => {\n+    TestBed.configureTestingModule({teardown: {destroyAfterEach: true}});\n+    expect(TestBed.shouldTearDownTestingModule()).toBe(true);\n+    TestBed.resetTestingModule();\n+    expect(TestBed.shouldTearDownTestingModule()).toBe(false);\n+  });\n+\n+  it('should destroy test module providers when test module teardown is enabled', () => {\n+    SimpleService.ngOnDestroyCalls = 0;\n+    TestBed.configureTestingModule({\n+      providers: [SimpleService],\n+      declarations: [GreetingCmp],\n+      teardown: {destroyAfterEach: true}\n+    });\n+    TestBed.createComponent(GreetingCmp);\n+\n+    expect(SimpleService.ngOnDestroyCalls).toBe(0);\n+    TestBed.resetTestingModule();\n+    expect(SimpleService.ngOnDestroyCalls).toBe(1);\n+  });\n+\n+  it('should remove the fixture root element from the DOM when module teardown is enabled', () => {\n+    TestBed.configureTestingModule({\n+      declarations: [SimpleCmp],\n+      teardown: {destroyAfterEach: true},\n+    });\n+    const fixture = TestBed.createComponent(SimpleCmp);\n+    const fixtureDocument = fixture.nativeElement.ownerDocument;\n+\n+    expect(fixtureDocument.body.contains(fixture.nativeElement)).toBe(true);\n+    TestBed.resetTestingModule();\n+    expect(fixtureDocument.body.contains(fixture.nativeElement)).toBe(false);\n+  });\n+\n+  it('should re-throw errors that were thrown during fixture cleanup', () => {\n+    @Component({template: ''})\n+    class ThrowsOnDestroy {\n+      ngOnDestroy() {\n+        throw Error('oh no');\n+      }\n+    }\n+\n+    TestBed.configureTestingModule({\n+      declarations: [ThrowsOnDestroy],\n+      teardown: {destroyAfterEach: true},\n+    });\n+    TestBed.createComponent(ThrowsOnDestroy);\n+\n+    const spy = spyOn(console, 'error');\n+    expect(() => TestBed.resetTestingModule())\n+        .toThrowError('1 component threw errors during cleanup');\n+    expect(spy).toHaveBeenCalledTimes(1);\n+  });\n+\n+  it('should not interrupt fixture destruction if an error is thrown', () => {\n+    @Component({template: ''})\n+    class ThrowsOnDestroy {\n+      ngOnDestroy() {\n+        throw Error('oh no');\n+      }\n+    }\n+\n+    TestBed.configureTestingModule({\n+      declarations: [ThrowsOnDestroy],\n+      teardown: {destroyAfterEach: true},\n+    });\n+\n+    for (let i = 0; i < 3; i++) {\n+      TestBed.createComponent(ThrowsOnDestroy);\n+    }\n+\n+    const spy = spyOn(console, 'error');\n+    expect(() => TestBed.resetTestingModule())\n+        .toThrowError('3 components threw errors during cleanup');\n+    expect(spy).toHaveBeenCalledTimes(3);\n+  });\n+\n+  it('should re-throw errors that were thrown during module teardown by default', () => {\n+    @Injectable()\n+    class ThrowsOnDestroy {\n+      ngOnDestroy() {\n+        throw Error('oh no');\n+      }\n+    }\n+\n+    @Component({template: ''})\n+    class App {\n+      constructor(_service: ThrowsOnDestroy) {}\n+    }\n+\n+    TestBed.configureTestingModule({\n+      providers: [ThrowsOnDestroy],\n+      declarations: [App],\n+      teardown: {destroyAfterEach: true},\n+    });\n+    TestBed.createComponent(App);\n+\n+    expect(() => TestBed.resetTestingModule()).toThrowError('oh no');\n+  });\n+\n+  it('should be able to opt out of rethrowing of errors coming from module teardown', () => {\n+    @Injectable()\n+    class ThrowsOnDestroy {\n+      ngOnDestroy() {\n+        throw Error('oh no');\n+      }\n+    }\n+\n+    @Component({template: ''})\n+    class App {\n+      constructor(_service: ThrowsOnDestroy) {}\n+    }\n+\n+    TestBed.configureTestingModule({\n+      providers: [ThrowsOnDestroy],\n+      declarations: [App],\n+      teardown: {destroyAfterEach: true, rethrowErrors: false},\n+    });\n+    TestBed.createComponent(App);\n+\n+    const spy = spyOn(console, 'error');\n+    expect(() => TestBed.resetTestingModule()).not.toThrow();\n+    expect(spy).toHaveBeenCalledTimes(1);\n+  });\n+\n+  it('should remove the styles associated with a test component when the test module is torn down',\n+     () => {\n+       @Component({\n+         template: '<span>Hello</span>',\n+         styles: [`span {color: hotpink;}`],\n+       })\n+       class StyledComp1 {\n+       }\n+\n+       @Component({\n+         template: '<div>Hello</div>',\n+         styles: [`div {color: red;}`],\n+       })\n+       class StyledComp2 {\n+       }\n+\n+       TestBed.configureTestingModule({\n+         declarations: [StyledComp1, StyledComp2],\n+         teardown: {destroyAfterEach: true},\n+       });\n+\n+       const fixtures = [\n+         TestBed.createComponent(StyledComp1),\n+         TestBed.createComponent(StyledComp2),\n+       ];\n+       const fixtureDocument = fixtures[0].nativeElement.ownerDocument;\n+       const styleCountBefore = fixtureDocument.querySelectorAll('style').length;\n+\n+       // Note that we can only assert that the behavior works as expected by checking that the\n+       // number of stylesheets has decreased. We can't expect that they'll be zero, because there\n+       // may by stylesheets leaking in from other tests that don't use the module teardown\n+       // behavior.\n+       expect(styleCountBefore).toBeGreaterThan(0);\n+       TestBed.resetTestingModule();\n+       expect(fixtureDocument.querySelectorAll('style').length).toBeLessThan(styleCountBefore);\n+     });\n+\n+\n+  it('should remove the fixture root element from the DOM when module teardown is enabled', () => {\n+    TestBed.configureTestingModule({\n+      declarations: [SimpleCmp],\n+      teardown: {destroyAfterEach: true},\n+    });\n+    const fixture = TestBed.createComponent(SimpleCmp);\n+    const fixtureDocument = fixture.nativeElement.ownerDocument;\n+\n+    expect(fixtureDocument.body.contains(fixture.nativeElement)).toBe(true);\n+    TestBed.resetTestingModule();\n+    expect(fixtureDocument.body.contains(fixture.nativeElement)).toBe(false);\n+  });\n+});"
        },
        {
            "sha": "8cc09a541a1ac54b36cbdfe4d62fa82ec32f9a4c",
            "filename": "packages/core/testing/src/r3_test_bed.ts",
            "status": "modified",
            "additions": 104,
            "deletions": 7,
            "changes": 111,
            "blob_url": "https://github.com/angular/angular/blob/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed.ts",
            "raw_url": "https://github.com/angular/angular/raw/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed.ts?ref=873229f24be292ac9e909993e28c2ae2cef4033a",
            "patch": "@@ -36,7 +36,7 @@ import {ComponentFixture} from './component_fixture';\n import {MetadataOverride} from './metadata_override';\n import {R3TestBedCompiler} from './r3_test_bed_compiler';\n import {TestBed} from './test_bed';\n-import {ComponentFixtureAutoDetect, ComponentFixtureNoNgZone, TestBedStatic, TestComponentRenderer, TestModuleMetadata} from './test_bed_common';\n+import {ComponentFixtureAutoDetect, ComponentFixtureNoNgZone, ModuleTeardownOptions, TEARDOWN_TESTING_MODULE_ON_DESTROY_DEFAULT, TestBedStatic, TestComponentRenderer, TestEnvironmentOptions, TestModuleMetadata} from './test_bed_common';\n \n let _nextRootElementId = 0;\n \n@@ -52,6 +52,18 @@ let _nextRootElementId = 0;\n  * according to the compiler used.\n  */\n export class TestBedRender3 implements TestBed {\n+  /**\n+   * Teardown options that have been configured at the environment level.\n+   * Used as a fallback if no instance-level options have been provided.\n+   */\n+  private static _environmentTeardownOptions: ModuleTeardownOptions|undefined;\n+\n+  /**\n+   * Teardown options that have been configured at the `TestBed` instance level.\n+   * These options take precedence over the environemnt-level ones.\n+   */\n+  private _instanceTeardownOptions: ModuleTeardownOptions|undefined;\n+\n   /**\n    * Initialize the environment for testing with a compiler factory, a PlatformRef, and an\n    * angular module. These are common to every test in the suite.\n@@ -66,9 +78,10 @@ export class TestBedRender3 implements TestBed {\n    * @publicApi\n    */\n   static initTestEnvironment(\n-      ngModule: Type<any>|Type<any>[], platform: PlatformRef, aotSummaries?: () => any[]): TestBed {\n+      ngModule: Type<any>|Type<any>[], platform: PlatformRef,\n+      summariesOrOptions?: TestEnvironmentOptions|(() => any[])): TestBed {\n     const testBed = _getTestBedRender3();\n-    testBed.initTestEnvironment(ngModule, platform, aotSummaries);\n+    testBed.initTestEnvironment(ngModule, platform, summariesOrOptions);\n     return testBed;\n   }\n \n@@ -182,6 +195,14 @@ export class TestBedRender3 implements TestBed {\n     return TestBedRender3 as any as TestBedStatic;\n   }\n \n+  static shouldTearDownTestingModule(): boolean {\n+    return _getTestBedRender3().shouldTearDownTestingModule();\n+  }\n+\n+  static tearDownTestingModule(): void {\n+    _getTestBedRender3().tearDownTestingModule();\n+  }\n+\n   // Properties\n \n   platform: PlatformRef = null!;\n@@ -206,11 +227,18 @@ export class TestBedRender3 implements TestBed {\n    *\n    * @publicApi\n    */\n-  initTestEnvironment(\n-      ngModule: Type<any>|Type<any>[], platform: PlatformRef, aotSummaries?: () => any[]): void {\n+  initTestEnvironment(ngModule: Type<any>|Type<any>[], platform: PlatformRef, summariesOrOptions?: {\n+    teardown?: ModuleTeardownOptions\n+  }|(() => any[])): void {\n     if (this.platform || this.ngModule) {\n       throw new Error('Cannot set base providers because it has already been called');\n     }\n+\n+    // If `summariesOrOptions` is a function, it means that it's\n+    // an AOT summaries factory which Ivy doesn't support.\n+    TestBedRender3._environmentTeardownOptions =\n+        typeof summariesOrOptions === 'function' ? undefined : summariesOrOptions?.teardown;\n+\n     this.platform = platform;\n     this.ngModule = ngModule;\n     this._compiler = new R3TestBedCompiler(this.platform, this.ngModule);\n@@ -226,6 +254,7 @@ export class TestBedRender3 implements TestBed {\n     this._compiler = null;\n     this.platform = null!;\n     this.ngModule = null!;\n+    TestBedRender3._environmentTeardownOptions = undefined;\n   }\n \n   resetTestingModule(): void {\n@@ -235,8 +264,22 @@ export class TestBedRender3 implements TestBed {\n       this.compiler.restoreOriginalState();\n     }\n     this._compiler = new R3TestBedCompiler(this.platform, this.ngModule);\n-    this._testModuleRef = null;\n-    this.destroyActiveFixtures();\n+\n+    // We have to chain a couple of try/finally blocks, because each step can\n+    // throw errors and we don't want it to interrupt the next step and we also\n+    // want an error to be thrown at the end.\n+    try {\n+      this.destroyActiveFixtures();\n+    } finally {\n+      try {\n+        if (this.shouldTearDownTestingModule()) {\n+          this.tearDownTestingModule();\n+        }\n+      } finally {\n+        this._testModuleRef = null;\n+        this._instanceTeardownOptions = undefined;\n+      }\n+    }\n   }\n \n   configureCompiler(config: {providers?: any[]; useJit?: boolean;}): void {\n@@ -251,6 +294,9 @@ export class TestBedRender3 implements TestBed {\n \n   configureTestingModule(moduleDef: TestModuleMetadata): void {\n     this.assertNotInstantiated('R3TestBed.configureTestingModule', 'configure the test module');\n+    // Always re-assign the teardown options, even if they're undefined.\n+    // This ensures that we don't carry the options between tests.\n+    this._instanceTeardownOptions = moduleDef.teardown;\n     this.compiler.configureTestingModule(moduleDef);\n   }\n \n@@ -402,17 +448,68 @@ export class TestBedRender3 implements TestBed {\n   }\n \n   private destroyActiveFixtures(): void {\n+    let errorCount = 0;\n     this._activeFixtures.forEach((fixture) => {\n       try {\n         fixture.destroy();\n       } catch (e) {\n+        errorCount++;\n         console.error('Error during cleanup of component', {\n           component: fixture.componentInstance,\n           stacktrace: e,\n         });\n       }\n     });\n     this._activeFixtures = [];\n+\n+    if (errorCount > 0 && this.shouldRethrowTeardownErrors()) {\n+      throw Error(\n+          `${errorCount} ${(errorCount === 1 ? 'component' : 'components')} ` +\n+          `threw errors during cleanup`);\n+    }\n+  }\n+\n+  private shouldRethrowTeardownErrors() {\n+    const instanceOptions = this._instanceTeardownOptions;\n+    const environmentOptions = TestBedRender3._environmentTeardownOptions;\n+\n+    // If the new teardown behavior hasn't been configured, preserve the old behavior.\n+    if (!instanceOptions && !environmentOptions) {\n+      return false;\n+    }\n+\n+    // Otherwise use the configured behavior or default to rethrowing.\n+    return instanceOptions?.rethrowErrors ?? environmentOptions?.rethrowErrors ?? true;\n+  }\n+\n+  shouldTearDownTestingModule(): boolean {\n+    return this._instanceTeardownOptions?.destroyAfterEach ??\n+        TestBedRender3._environmentTeardownOptions?.destroyAfterEach ??\n+        TEARDOWN_TESTING_MODULE_ON_DESTROY_DEFAULT;\n+  }\n+\n+  tearDownTestingModule() {\n+    // If the module ref has already been destroyed, we won't be able to get a test renderer.\n+    if (this._testModuleRef === null) {\n+      return;\n+    }\n+    // Resolve the renderer ahead of time, because we want to remove the root elements as the very\n+    // last step, but the injector will be destroyed as a part of the module ref destruction.\n+    const testRenderer = this.inject(TestComponentRenderer);\n+    try {\n+      this._testModuleRef.destroy();\n+    } catch (e) {\n+      if (this.shouldRethrowTeardownErrors()) {\n+        throw e;\n+      } else {\n+        console.error('Error during cleanup of a testing module', {\n+          component: this._testModuleRef.instance,\n+          stacktrace: e,\n+        });\n+      }\n+    } finally {\n+      testRenderer.removeAllRootElements?.();\n+    }\n   }\n }\n "
        },
        {
            "sha": "627489c3e099c1adf3994a8356121a2c4880868a",
            "filename": "packages/core/testing/src/test_bed.ts",
            "status": "modified",
            "additions": 123,
            "deletions": 20,
            "changes": 143,
            "blob_url": "https://github.com/angular/angular/blob/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed.ts",
            "raw_url": "https://github.com/angular/angular/raw/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed.ts?ref=873229f24be292ac9e909993e28c2ae2cef4033a",
            "patch": "@@ -11,7 +11,7 @@ import {ApplicationInitStatus, CompilerOptions, Component, Directive, InjectFlag\n import {ComponentFixture} from './component_fixture';\n import {MetadataOverride} from './metadata_override';\n import {_getTestBedRender3, TestBedRender3} from './r3_test_bed';\n-import {ComponentFixtureAutoDetect, ComponentFixtureNoNgZone, TestBedStatic, TestComponentRenderer, TestModuleMetadata} from './test_bed_common';\n+import {ComponentFixtureAutoDetect, ComponentFixtureNoNgZone, ModuleTeardownOptions, TEARDOWN_TESTING_MODULE_ON_DESTROY_DEFAULT, TestBedStatic, TestComponentRenderer, TestEnvironmentOptions, TestModuleMetadata} from './test_bed_common';\n import {TestingCompiler, TestingCompilerFactory} from './test_compiler';\n \n \n@@ -36,6 +36,9 @@ export interface TestBed {\n    * Test modules and platforms for individual platforms are available from\n    * '@angular/<platform_name>/testing'.\n    */\n+  initTestEnvironment(\n+      ngModule: Type<any>|Type<any>[], platform: PlatformRef,\n+      options?: TestEnvironmentOptions): void;\n   initTestEnvironment(\n       ngModule: Type<any>|Type<any>[], platform: PlatformRef, aotSummaries?: () => any[]): void;\n \n@@ -97,6 +100,18 @@ export interface TestBed {\n  * according to the compiler used.\n  */\n export class TestBedViewEngine implements TestBed {\n+  /**\n+   * Teardown options that have been configured at the environment level.\n+   * Used as a fallback if no instance-level options have been provided.\n+   */\n+  private static _environmentTeardownOptions: ModuleTeardownOptions|undefined;\n+\n+  /**\n+   * Teardown options that have been configured at the `TestBed` instance level.\n+   * These options take precedence over the environemnt-level ones.\n+   */\n+  private _instanceTeardownOptions: ModuleTeardownOptions|undefined;\n+\n   /**\n    * Initialize the environment for testing with a compiler factory, a PlatformRef, and an\n    * angular module. These are common to every test in the suite.\n@@ -110,9 +125,9 @@ export class TestBedViewEngine implements TestBed {\n    */\n   static initTestEnvironment(\n       ngModule: Type<any>|Type<any>[], platform: PlatformRef,\n-      aotSummaries?: () => any[]): TestBedViewEngine {\n+      summariesOrOptions?: TestEnvironmentOptions|(() => any[])): TestBedViewEngine {\n     const testBed = _getTestBedViewEngine();\n-    testBed.initTestEnvironment(ngModule, platform, aotSummaries);\n+    testBed.initTestEnvironment(ngModule, platform, summariesOrOptions);\n     return testBed;\n   }\n \n@@ -236,10 +251,18 @@ export class TestBedViewEngine implements TestBed {\n     return _getTestBedViewEngine().createComponent(component);\n   }\n \n+  static shouldTearDownTestingModule(): boolean {\n+    return _getTestBedViewEngine().shouldTearDownTestingModule();\n+  }\n+\n+  static tearDownTestingModule(): void {\n+    _getTestBedViewEngine().tearDownTestingModule();\n+  }\n+\n   private _instantiated: boolean = false;\n \n   private _compiler: TestingCompiler = null!;\n-  private _moduleRef: NgModuleRef<any> = null!;\n+  private _moduleRef: NgModuleRef<any>|null = null;\n   private _moduleFactory: NgModuleFactory<any> = null!;\n \n   private _compilerOptions: CompilerOptions[] = [];\n@@ -278,14 +301,19 @@ export class TestBedViewEngine implements TestBed {\n    * '@angular/<platform_name>/testing'.\n    */\n   initTestEnvironment(\n-      ngModule: Type<any>|Type<any>[], platform: PlatformRef, aotSummaries?: () => any[]): void {\n+      ngModule: Type<any>|Type<any>[], platform: PlatformRef,\n+      summariesOrOptions?: TestEnvironmentOptions|(() => any[])): void {\n     if (this.platform || this.ngModule) {\n       throw new Error('Cannot set base providers because it has already been called');\n     }\n     this.platform = platform;\n     this.ngModule = ngModule;\n-    if (aotSummaries) {\n-      this._testEnvAotSummaries = aotSummaries;\n+    if (typeof summariesOrOptions === 'function') {\n+      this._testEnvAotSummaries = summariesOrOptions;\n+      TestBedViewEngine._environmentTeardownOptions = undefined;\n+    } else {\n+      this._testEnvAotSummaries = (summariesOrOptions?.aotSummaries) || (() => []);\n+      TestBedViewEngine._environmentTeardownOptions = summariesOrOptions?.teardown;\n     }\n   }\n \n@@ -297,6 +325,7 @@ export class TestBedViewEngine implements TestBed {\n     this.platform = null!;\n     this.ngModule = null!;\n     this._testEnvAotSummaries = () => [];\n+    TestBedViewEngine._environmentTeardownOptions = undefined;\n   }\n \n   resetTestingModule(): void {\n@@ -312,25 +341,29 @@ export class TestBedViewEngine implements TestBed {\n     this._isRoot = true;\n     this._rootProviderOverrides = [];\n \n-    this._moduleRef = null!;\n     this._moduleFactory = null!;\n     this._compilerOptions = [];\n     this._providers = [];\n     this._declarations = [];\n     this._imports = [];\n     this._schemas = [];\n-    this._instantiated = false;\n-    this._activeFixtures.forEach((fixture) => {\n+\n+    // We have to chain a couple of try/finally blocks, because each step can\n+    // throw errors and we don't want it to interrupt the next step and we also\n+    // want an error to be thrown at the end.\n+    try {\n+      this.destroyActiveFixtures();\n+    } finally {\n       try {\n-        fixture.destroy();\n-      } catch (e) {\n-        console.error('Error during cleanup of component', {\n-          component: fixture.componentInstance,\n-          stacktrace: e,\n-        });\n+        if (this.shouldTearDownTestingModule()) {\n+          this.tearDownTestingModule();\n+        }\n+      } finally {\n+        this._moduleRef = null;\n+        this._instanceTeardownOptions = undefined;\n+        this._instantiated = false;\n       }\n-    });\n-    this._activeFixtures = [];\n+    }\n   }\n \n   configureCompiler(config: {providers?: any[], useJit?: boolean}): void {\n@@ -355,6 +388,9 @@ export class TestBedViewEngine implements TestBed {\n     if (moduleDef.aotSummaries) {\n       this._aotSummaries.push(moduleDef.aotSummaries);\n     }\n+    // Always re-assign the teardown options, even if they're undefined.\n+    // This ensures that we don't carry the options between tests.\n+    this._instanceTeardownOptions = moduleDef.teardown;\n   }\n \n   compileComponents(): Promise<any> {\n@@ -470,7 +506,7 @@ export class TestBedViewEngine implements TestBed {\n     // Tests can inject things from the ng module and from the compiler,\n     // but the ng module can't inject things from the compiler and vice versa.\n     const UNDEFINED = {};\n-    const result = this._moduleRef.injector.get(token, UNDEFINED, flags);\n+    const result = this._moduleRef!.injector.get(token, UNDEFINED, flags);\n     return result === UNDEFINED ? this._compiler.injector.get(token, notFoundValue, flags) as any :\n                                   result;\n   }\n@@ -602,14 +638,81 @@ export class TestBedViewEngine implements TestBed {\n \n     const initComponent = () => {\n       const componentRef =\n-          componentFactory.create(Injector.NULL, [], `#${rootElId}`, this._moduleRef);\n+          componentFactory.create(Injector.NULL, [], `#${rootElId}`, this._moduleRef!);\n       return new ComponentFixture<T>(componentRef, ngZone, autoDetect);\n     };\n \n     const fixture = !ngZone ? initComponent() : ngZone.run(initComponent);\n     this._activeFixtures.push(fixture);\n     return fixture;\n   }\n+\n+  private destroyActiveFixtures(): void {\n+    let errorCount = 0;\n+    this._activeFixtures.forEach((fixture) => {\n+      try {\n+        fixture.destroy();\n+      } catch (e) {\n+        errorCount++;\n+        console.error('Error during cleanup of component', {\n+          component: fixture.componentInstance,\n+          stacktrace: e,\n+        });\n+      }\n+    });\n+    this._activeFixtures = [];\n+\n+    if (errorCount > 0 && this.shouldRethrowTeardownErrors()) {\n+      throw Error(\n+          `${errorCount} ${(errorCount === 1 ? 'component' : 'components')} ` +\n+          `threw errors during cleanup`);\n+    }\n+  }\n+\n+  private shouldRethrowTeardownErrors() {\n+    const instanceOptions = this._instanceTeardownOptions;\n+    const environmentOptions = TestBedViewEngine._environmentTeardownOptions;\n+\n+    // If the new teardown behavior hasn't been configured, preserve the old behavior.\n+    if (!instanceOptions && !environmentOptions) {\n+      return false;\n+    }\n+\n+    // Otherwise use the configured behavior or default to rethrowing.\n+    return instanceOptions?.rethrowErrors ?? environmentOptions?.rethrowErrors ?? true;\n+  }\n+\n+  shouldTearDownTestingModule(): boolean {\n+    return this._instanceTeardownOptions?.destroyAfterEach ??\n+        TestBedViewEngine._environmentTeardownOptions?.destroyAfterEach ??\n+        TEARDOWN_TESTING_MODULE_ON_DESTROY_DEFAULT;\n+  }\n+\n+  tearDownTestingModule() {\n+    // If the module ref has already been destroyed, we won't be able to get a test renderer.\n+    if (this._moduleRef === null) {\n+      return;\n+    }\n+\n+    // Resolve the renderer ahead of time, because we want to remove the root elements as the very\n+    // last step, but the injector will be destroyed as a part of the module ref destruction.\n+    const testRenderer = this.inject(TestComponentRenderer);\n+    try {\n+      this._moduleRef.destroy();\n+    } catch (e) {\n+      if (this._instanceTeardownOptions?.rethrowErrors ??\n+          TestBedViewEngine._environmentTeardownOptions?.rethrowErrors ?? true) {\n+        throw e;\n+      } else {\n+        console.error('Error during cleanup of a testing module', {\n+          component: this._moduleRef.instance,\n+          stacktrace: e,\n+        });\n+      }\n+    } finally {\n+      testRenderer?.removeAllRootElements?.();\n+    }\n+  }\n }\n \n /**"
        },
        {
            "sha": "46ff0be28d6575183628f71f81e49cbb93345b7e",
            "filename": "packages/core/testing/src/test_bed_common.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed_common.ts",
            "raw_url": "https://github.com/angular/angular/raw/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed_common.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed_common.ts?ref=873229f24be292ac9e909993e28c2ae2cef4033a",
            "patch": "@@ -12,13 +12,20 @@ import {ComponentFixture} from './component_fixture';\n import {MetadataOverride} from './metadata_override';\n import {TestBed} from './test_bed';\n \n+/**\n+ * Whether test modules should be torn down by default.\n+ * Currently disabled for backwards-compatibility reasons.\n+ */\n+export const TEARDOWN_TESTING_MODULE_ON_DESTROY_DEFAULT = false;\n+\n /**\n  * An abstract class for inserting the root test component element in a platform independent way.\n  *\n  * @publicApi\n  */\n export class TestComponentRenderer {\n   insertRootElement(rootElementId: string) {}\n+  removeAllRootElements?() {}\n }\n \n /**\n@@ -41,8 +48,29 @@ export type TestModuleMetadata = {\n   imports?: any[],\n   schemas?: Array<SchemaMetadata|any[]>,\n   aotSummaries?: () => any[],\n+  teardown?: ModuleTeardownOptions;\n };\n \n+/**\n+ * @publicApi\n+ */\n+export interface TestEnvironmentOptions {\n+  aotSummaries?: () => any[];\n+  teardown?: ModuleTeardownOptions;\n+}\n+\n+/**\n+ * Object used to configure the test module teardown behavior in `TestBed`.\n+ * @publicApi\n+ */\n+export interface ModuleTeardownOptions {\n+  /** Whether the test module should be destroyed after every test. */\n+  destroyAfterEach: boolean;\n+\n+  /** Whether errors during test module destruction should be re-thrown. Defaults to `true`. */\n+  rethrowErrors?: boolean;\n+}\n+\n /**\n  * Static methods implemented by the `TestBedViewEngine` and `TestBedRender3`\n  *\n@@ -51,6 +79,9 @@ export type TestModuleMetadata = {\n export interface TestBedStatic {\n   new(...args: any[]): TestBed;\n \n+  initTestEnvironment(ngModule: Type<any>|Type<any>[], platform: PlatformRef, options?: {\n+    teardown?: ModuleTeardownOptions\n+  }): TestBed;\n   initTestEnvironment(\n       ngModule: Type<any>|Type<any>[], platform: PlatformRef, aotSummaries?: () => any[]): TestBed;\n "
        },
        {
            "sha": "c76c17e3854dd07f21916a7445540e91ec7e9264",
            "filename": "packages/core/testing/src/test_hooks.ts",
            "status": "renamed",
            "additions": 19,
            "deletions": 5,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_hooks.ts",
            "raw_url": "https://github.com/angular/angular/raw/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_hooks.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_hooks.ts?ref=873229f24be292ac9e909993e28c2ae2cef4033a",
            "patch": "@@ -13,18 +13,32 @@\n  */\n \n import {resetFakeAsyncZone} from './fake_async';\n-import {TestBed} from './test_bed';\n+import {TestBed, TestBedViewEngine as TestBedInternal} from './test_bed';\n \n declare var global: any;\n \n const _global = <any>(typeof window === 'undefined' ? global : window);\n \n // Reset the test providers and the fake async zone before each test.\n if (_global.beforeEach) {\n-  _global.beforeEach(() => {\n-    TestBed.resetTestingModule();\n-    resetFakeAsyncZone();\n-  });\n+  _global.beforeEach(getCleanupHook(false));\n+}\n+\n+// We provide both a `beforeEach` and `afterEach`, because the updated behavior for\n+// tearing down the module is supposed to run after the test so that we can associate\n+// teardown errors with the correct test.\n+if (_global.afterEach) {\n+  _global.afterEach(getCleanupHook(true));\n+}\n+\n+function getCleanupHook(expectedTeardownValue: boolean) {\n+  return () => {\n+    if ((TestBed as unknown as TestBedInternal).shouldTearDownTestingModule() ===\n+        expectedTeardownValue) {\n+      TestBed.resetTestingModule();\n+      resetFakeAsyncZone();\n+    }\n+  };\n }\n \n /**",
            "previous_filename": "packages/core/testing/src/before_each.ts"
        },
        {
            "sha": "c8ec6baae9a180a6a66c7ead26fb1bdb75503038",
            "filename": "packages/core/testing/src/testing.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftesting%2Fsrc%2Ftesting.ts",
            "raw_url": "https://github.com/angular/angular/raw/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fcore%2Ftesting%2Fsrc%2Ftesting.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Ftesting.ts?ref=873229f24be292ac9e909993e28c2ae2cef4033a",
            "patch": "@@ -16,8 +16,8 @@ export * from './async';\n export * from './component_fixture';\n export * from './fake_async';\n export {TestBed, getTestBed, inject, InjectSetupWrapper, withModule} from './test_bed';\n-export * from './test_bed_common';\n-export * from './before_each';\n+export {TestComponentRenderer, ComponentFixtureAutoDetect, ComponentFixtureNoNgZone, TestModuleMetadata, TestEnvironmentOptions, ModuleTeardownOptions, TestBedStatic} from './test_bed_common';\n+export * from './test_hooks';\n export * from './metadata_override';\n export {MetadataOverrider as ɵMetadataOverrider} from './metadata_overrider';\n export * from './private_export_testing';"
        },
        {
            "sha": "6f321b7d902b6a349f771395ad1781f45e40bccc",
            "filename": "packages/platform-browser-dynamic/testing/src/dom_test_component_renderer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fplatform-browser-dynamic%2Ftesting%2Fsrc%2Fdom_test_component_renderer.ts",
            "raw_url": "https://github.com/angular/angular/raw/873229f24be292ac9e909993e28c2ae2cef4033a/packages%2Fplatform-browser-dynamic%2Ftesting%2Fsrc%2Fdom_test_component_renderer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser-dynamic%2Ftesting%2Fsrc%2Fdom_test_component_renderer.ts?ref=873229f24be292ac9e909993e28c2ae2cef4033a",
            "patch": "@@ -20,14 +20,17 @@ export class DOMTestComponentRenderer extends TestComponentRenderer {\n   }\n \n   insertRootElement(rootElId: string) {\n+    this.removeAllRootElements();\n     const rootElement = getDOM().getDefaultDocument().createElement('div');\n     rootElement.setAttribute('id', rootElId);\n+    this._doc.body.appendChild(rootElement);\n+  }\n \n+  removeAllRootElements() {\n     // TODO(juliemr): can/should this be optional?\n     const oldRoots = this._doc.querySelectorAll('[id^=root]');\n     for (let i = 0; i < oldRoots.length; i++) {\n       getDOM().remove(oldRoots[i]);\n     }\n-    this._doc.body.appendChild(rootElement);\n   }\n }"
        }
    ],
    "stats": {
        "total": 538,
        "additions": 502,
        "deletions": 36
    }
}