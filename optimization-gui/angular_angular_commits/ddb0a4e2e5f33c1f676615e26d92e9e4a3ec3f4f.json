{
    "author": "petebacondarwin",
    "message": "refactor(localize): handle location endings correctly (#32912)\n\nPreviously source locations required an ending position but this was not\nbeing computed effectively. Now ending position is optional and it is\ncomputed from an `endPath` passed to `getLocation()`.\n\nPR Close #32912",
    "sha": "ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f",
    "files": [
        {
            "sha": "0a5f58ba0bb7b39c42fe66b4d32834427bf10661",
            "filename": "packages/localize/src/tools/src/source_file_utils.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 8,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts?ref=ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f",
            "patch": "@@ -5,6 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {AbsoluteFsPath, relative, resolve} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵisMissingTranslationError, ɵmakeTemplateObject, ɵParsedTranslation, ɵSourceLocation, ɵtranslate} from '@angular/localize';\n import {NodePath} from '@babel/traverse';\n import * as t from '@babel/types';\n@@ -347,15 +348,31 @@ export function buildCodeFrameError(path: NodePath, e: BabelParseError): string\n   return `${filename}: ${message}`;\n }\n \n-export function getLocation(path: NodePath): ɵSourceLocation|undefined {\n-  const location = path.node.loc;\n-  const file = path.hub.file.opts.filename;\n-\n-  if (!location || !file) {\n+export function getLocation(startPath: NodePath, endPath?: NodePath): ɵSourceLocation|undefined {\n+  const startLocation = startPath.node.loc;\n+  const file = getFileFromPath(startPath);\n+  if (!startLocation || !file) {\n     return undefined;\n   }\n \n-  // Note we clone the `start` and `end` objects so that their prototype chains,\n-  // from Babel, do not leak into our code.\n-  return {start: {...location.start}, end: {...location.end}, file};\n+  const endLocation =\n+      endPath && getFileFromPath(endPath) === file && endPath.node.loc || startLocation;\n+\n+  return {\n+    start: getLineAndColumn(startLocation.start),\n+    end: getLineAndColumn(endLocation.end),\n+    file\n+  };\n+}\n+\n+function getFileFromPath(path: NodePath|undefined): AbsoluteFsPath|null {\n+  const opts = path?.hub.file.opts;\n+  return opts?.filename ?\n+      resolve(opts.generatorOpts.sourceRoot, relative(opts.cwd, opts.filename)) :\n+      null;\n+}\n+\n+function getLineAndColumn(loc: {line: number, column: number}): {line: number, column: number} {\n+  // Note we want 0-based line numbers but Babel returns 1-based.\n+  return {line: loc.line - 1, column: loc.column};\n }"
        },
        {
            "sha": "b245d8c8cd5d8f05221326cbcc332cdcaf1423d0",
            "filename": "packages/localize/src/tools/test/source_file_utils_spec.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 17,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fsource_file_utils_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fsource_file_utils_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fsource_file_utils_spec.ts?ref=ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f",
            "patch": "@@ -5,6 +5,8 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {ɵmakeTemplateObject} from '@angular/localize';\n import {NodePath, TransformOptions, transformSync} from '@babel/core';\n import generate from '@babel/generator';\n@@ -195,23 +197,27 @@ describe('utils', () => {\n     });\n   });\n \n-  describe('getLocation()', () => {\n-    it('should return a plain object containing the start, end and file of a NodePath', () => {\n-      const taggedTemplate =\n-          getTaggedTemplate('const x = $localize ``;', {filename: 'src/test.js'});\n-      const location = getLocation(taggedTemplate)!;\n-      expect(location).toBeDefined();\n-      expect(location.start).toEqual({line: 1, column: 10});\n-      expect(location.start.constructor.name).toEqual('Object');\n-      expect(location.end).toEqual({line: 1, column: 22});\n-      expect(location.end.constructor.name).toEqual('Object');\n-      expect(location.file).toContain('src/test.js');\n-    });\n-\n-    it('should return undefined if the NodePath has no filename', () => {\n-      const taggedTemplate = getTaggedTemplate('const x = $localize ``;');\n-      const location = getLocation(taggedTemplate)!;\n-      expect(location).toBeUndefined();\n+  runInEachFileSystem(() => {\n+    describe('getLocation()', () => {\n+      it('should return a plain object containing the start, end and file of a NodePath', () => {\n+        const taggedTemplate = getTaggedTemplate('const x = $localize `message`;', {\n+          filename: 'src/test.js',\n+          sourceRoot: '/root',\n+        });\n+        const location = getLocation(taggedTemplate)!;\n+        expect(location).toBeDefined();\n+        expect(location.start).toEqual({line: 0, column: 10});\n+        expect(location.start.constructor.name).toEqual('Object');\n+        expect(location.end).toEqual({line: 0, column: 29});\n+        expect(location.end?.constructor.name).toEqual('Object');\n+        expect(location.file).toEqual(absoluteFrom('/root/src/test.js'));\n+      });\n+\n+      it('should return `undefined` if the NodePath has no filename', () => {\n+        const taggedTemplate = getTaggedTemplate('const x = $localize ``;', {sourceRoot: '/root'});\n+        const location = getLocation(taggedTemplate);\n+        expect(location).toBeUndefined();\n+      });\n     });\n   });\n });"
        },
        {
            "sha": "6a77fcf703a6ce4ff026cc3dcd2b57f559bc8c7a",
            "filename": "packages/localize/src/utils/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f/packages%2Flocalize%2Fsrc%2Futils%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f/packages%2Flocalize%2Fsrc%2Futils%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Futils%2FBUILD.bazel?ref=ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f",
            "patch": "@@ -13,5 +13,6 @@ ts_library(\n     module_name = \"@angular/localize/src/utils\",\n     deps = [\n         \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n     ],\n )"
        },
        {
            "sha": "b735841bef2a1b26abf04e7275c6c55d5c589d98",
            "filename": "packages/localize/src/utils/src/messages.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f/packages%2Flocalize%2Fsrc%2Futils%2Fsrc%2Fmessages.ts",
            "raw_url": "https://github.com/angular/angular/raw/ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f/packages%2Flocalize%2Fsrc%2Futils%2Fsrc%2Fmessages.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Futils%2Fsrc%2Fmessages.ts?ref=ddb0a4e2e5f33c1f676615e26d92e9e4a3ec3f4f",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {computeMsgId} from '@angular/compiler';\n+import {AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n \n import {BLOCK_MARKER, ID_SEPARATOR, LEGACY_ID_INDICATOR, MEANING_SEPARATOR} from './constants';\n \n@@ -39,12 +40,14 @@ export type TargetMessage = string;\n export type MessageId = string;\n \n /**\n- * The location of the message\n+ * The location of the message in the source file.\n+ *\n+ * The `line` and `column` values for the `start` and `end` properties are zero-based.\n  */\n export interface SourceLocation {\n   start: {line: number, column: number};\n   end: {line: number, column: number};\n-  file: string;\n+  file: AbsoluteFsPath;\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 54,
        "deletions": 27
    }
}