{
    "author": "JoostK",
    "message": "build: switch ViewEngine ngc tests over to use NPM packages (#43431)\n\nThe View Engine ngc tests currently rely on the `npm_package` output\nthat is built locally. This becomes problematic with the new Angular\nPackage Format v13 where no metadata files are shipped. To continue\nbeing able to test View Engine compilation, we will use the v12.x\nframework packages for running the View Engine test.\n\nNote: This means that we no longer test metadata extraction directly\nfor our framework packages, but given that any change to View Engine\nwill still land in patch, where the VE packaging still occurs, we should\nbe covered here.\n\nPR Close #43431",
    "sha": "427beff0ec16f141a5f87b4f3dd5ae8297db5aec",
    "files": [
        {
            "sha": "c2a8dd13acba3b32b5c4100dfb611f2534afecb5",
            "filename": "packages/compiler-cli/test/BUILD.bazel",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/427beff0ec16f141a5f87b4f3dd5ae8297db5aec/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/427beff0ec16f141a5f87b4f3dd5ae8297db5aec/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel?ref=427beff0ec16f141a5f87b4f3dd5ae8297db5aec",
            "patch": "@@ -42,7 +42,7 @@ jasmine_node_test(\n     name = \"extract_i18n\",\n     bootstrap = [\"//tools/testing:node_es5\"],\n     data = [\n-        \"//packages/core:npm_package\",\n+        \"@npm//@angular/core-12\",\n     ],\n     tags = [\n         # Disabled as the tests pertain to the old extraction tool only, whereas the Ivy extraction\n@@ -51,8 +51,8 @@ jasmine_node_test(\n     ],\n     deps = [\n         \":extract_i18n_lib\",\n-        \"//packages/common:npm_package\",\n         \"//packages/core\",\n+        \"@npm//@angular/common-12\",\n         \"@npm//minimist\",\n     ],\n )\n@@ -77,10 +77,10 @@ jasmine_node_test(\n     timeout = \"long\",  # 900 seconds\n     bootstrap = [\"//tools/testing:node_es5\"],\n     data = [\n-        \"//packages/common:npm_package\",\n-        \"//packages/core:npm_package\",\n-        \"//packages/platform-browser:npm_package\",\n-        \"//packages/router:npm_package\",\n+        \"@npm//@angular/common-12\",\n+        \"@npm//@angular/core-12\",\n+        \"@npm//@angular/platform-browser-12\",\n+        \"@npm//@angular/router-12\",\n     ],\n     tags = [\n         # Disabled as these tests are specific to the old ngc compiler, and not ngtsc which has its\n@@ -116,7 +116,7 @@ jasmine_node_test(\n     name = \"perform_watch\",\n     bootstrap = [\"//tools/testing:node_es5\"],\n     data = [\n-        \"//packages/core:npm_package\",\n+        \"@npm//@angular/core-12\",\n     ],\n     deps = [\n         \":perform_watch_lib\",\n@@ -143,7 +143,7 @@ jasmine_node_test(\n     name = \"perform_compile\",\n     bootstrap = [\"//tools/testing:node_es5\"],\n     data = [\n-        \"//packages/core:npm_package\",\n+        \"@npm//@angular/core-12\",\n     ],\n     deps = [\n         \":perform_compile_lib\","
        },
        {
            "sha": "322961a923cf82870e5c5cc344fe3f63454101a5",
            "filename": "packages/compiler-cli/test/diagnostics/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/427beff0ec16f141a5f87b4f3dd5ae8297db5aec/packages%2Fcompiler-cli%2Ftest%2Fdiagnostics%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/427beff0ec16f141a5f87b4f3dd5ae8297db5aec/packages%2Fcompiler-cli%2Ftest%2Fdiagnostics%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fdiagnostics%2FBUILD.bazel?ref=427beff0ec16f141a5f87b4f3dd5ae8297db5aec",
            "patch": "@@ -17,8 +17,8 @@ jasmine_node_test(\n     timeout = \"long\",  # 900 seconds\n     bootstrap = [\"//tools/testing:node_es5\"],\n     data = [\n-        \"//packages/common:npm_package\",\n-        \"//packages/core:npm_package\",\n+        \"@npm//@angular/common-12\",\n+        \"@npm//@angular/core-12\",\n     ],\n     tags = [\n         # Disabled as these tests pertain to typechecking in the old ngc compiler. The Ivy ngtsc"
        },
        {
            "sha": "1bc7fe7d0d6a04093328678a9f623fc32a425a4a",
            "filename": "packages/compiler-cli/test/test_support.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 6,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/427beff0ec16f141a5f87b4f3dd5ae8297db5aec/packages%2Fcompiler-cli%2Ftest%2Ftest_support.ts",
            "raw_url": "https://github.com/angular/angular/raw/427beff0ec16f141a5f87b4f3dd5ae8297db5aec/packages%2Fcompiler-cli%2Ftest%2Ftest_support.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Ftest_support.ts?ref=427beff0ec16f141a5f87b4f3dd5ae8297db5aec",
            "patch": "@@ -128,14 +128,29 @@ export function setupBazelTo(tmpDirPath: string) {\n   fs.mkdirSync(nodeModulesPath);\n   fs.mkdirSync(angularDirectory);\n \n-  getAngularPackagesFromRunfiles().forEach(({pkgPath, name}) => {\n-    fs.symlinkSync(pkgPath, path.join(angularDirectory, name), 'junction');\n-  });\n+  function linkNpmArtifact(artifact: string, target: string = artifact) {\n+    try {\n+      const source = resolveNpmTreeArtifact(`npm/node_modules/${artifact}`);\n+      const dest = path.join(nodeModulesPath, target);\n+      fs.symlinkSync(source, dest, 'junction');\n+    } catch (e) {\n+      // Allow a module to be missing as some Bazel targets do not need all artifacts.\n+      if (e.code !== 'MODULE_NOT_FOUND') throw e;\n+    }\n+  }\n+\n+  // Link @angular packages. These reference the v12 packages from NPM as the ViewEngine tests\n+  // can no longer depend on `npm_package` Bazel targets, given that the `ng_module` to produce\n+  // them is no longer capable of producing ViewEngine packages. As a result, the `npm_package`\n+  // outputs end up being compiled using Ivy partial compilation format which is not suitable to be\n+  // used in ViewEngine ngc tests.\n+  linkNpmArtifact('@angular/core-12', '@angular/core');\n+  linkNpmArtifact('@angular/common-12', '@angular/common');\n+  linkNpmArtifact('@angular/router-12', '@angular/router');\n+  linkNpmArtifact('@angular/platform-browser-12', '@angular/platform-browser');\n \n   // Link typescript\n-  const typeScriptSource = resolveNpmTreeArtifact('npm/node_modules/typescript');\n-  const typescriptDest = path.join(nodeModulesPath, 'typescript');\n-  fs.symlinkSync(typeScriptSource, typescriptDest, 'junction');\n+  linkNpmArtifact('typescript');\n \n   // Link \"rxjs\" if it has been set up as a runfile. \"rxjs\" is linked optionally because\n   // not all compiler-cli tests need \"rxjs\" set up."
        },
        {
            "sha": "32b7b78e5299c0c4095da74b6c7a9369900cc474",
            "filename": "packages/compiler-cli/test/transformers/BUILD.bazel",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/427beff0ec16f141a5f87b4f3dd5ae8297db5aec/packages%2Fcompiler-cli%2Ftest%2Ftransformers%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/427beff0ec16f141a5f87b4f3dd5ae8297db5aec/packages%2Fcompiler-cli%2Ftest%2Ftransformers%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Ftransformers%2FBUILD.bazel?ref=427beff0ec16f141a5f87b4f3dd5ae8297db5aec",
            "patch": "@@ -22,9 +22,9 @@ jasmine_node_test(\n     timeout = \"long\",  # 900 seconds\n     bootstrap = [\"//tools/testing:node_es5\"],\n     data = [\n-        \"//packages/common:npm_package\",\n-        \"//packages/core:npm_package\",\n-        \"//packages/router:npm_package\",\n+        \"@npm//@angular/common-12\",\n+        \"@npm//@angular/core-12\",\n+        \"@npm//@angular/router-12\",\n     ],\n     tags = [\n         # Disabled as these tests pertain to the old compiler and not ngtsc, which doesn't use any"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 34,
        "deletions": 19
    }
}