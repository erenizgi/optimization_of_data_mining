{
    "author": "gkalpak",
    "message": "test(ngcc): run more tests against more supported UMD formats (#44245)\n\nThis commit utilizes the infrastructure added in the previous commit to\nrun more tests against more of the supported UMD formats. This shall\ngive us more confidence that all aspects of UMD processing work\ncorrectly with the various formats.\n\nPR Close #44245",
    "sha": "707bf41fa6f41eb8dc972a219bda248891d27860",
    "files": [
        {
            "sha": "0be544b503a186122d1dc1c1aca4502a68992a67",
            "filename": "packages/compiler-cli/ngcc/test/dependencies/umd_dependency_host_spec.ts",
            "status": "modified",
            "additions": 254,
            "deletions": 236,
            "changes": 490,
            "blob_url": "https://github.com/angular/angular/blob/707bf41fa6f41eb8dc972a219bda248891d27860/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/707bf41fa6f41eb8dc972a219bda248891d27860/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts?ref=707bf41fa6f41eb8dc972a219bda248891d27860",
            "patch": "@@ -13,258 +13,276 @@ import {loadTestFiles} from '../../../src/ngtsc/testing';\n import {createDependencyInfo} from '../../src/dependencies/dependency_host';\n import {ModuleResolver} from '../../src/dependencies/module_resolver';\n import {UmdDependencyHost} from '../../src/dependencies/umd_dependency_host';\n-import {createUmdModuleFactory, WrapperFunctionFormat} from '../helpers/umd_utils';\n+import {testForEachUmdFormat} from '../helpers/umd_utils';\n \n runInEachFileSystem(() => {\n-  describe('UmdDependencyHost', () => {\n-    const createUmdModule = createUmdModuleFactory(WrapperFunctionFormat.Rollup);\n-    let _: typeof absoluteFrom;\n-    let host: UmdDependencyHost;\n+  describe(\n+      'UmdDependencyHost', testForEachUmdFormat(({createUmdModule}) => {\n+        let _: typeof absoluteFrom;\n+        let host: UmdDependencyHost;\n \n-    beforeEach(() => {\n-      _ = absoluteFrom;\n-      setupMockFileSystem();\n-      const fs = getFileSystem();\n-      host = new UmdDependencyHost(fs, new ModuleResolver(fs));\n-    });\n+        beforeEach(() => {\n+          _ = absoluteFrom;\n+          setupMockFileSystem();\n+          const fs = getFileSystem();\n+          host = new UmdDependencyHost(fs, new ModuleResolver(fs));\n+        });\n \n-    describe('collectDependencies()', () => {\n-      it('should not generate a TS AST if the source does not contain any require calls', () => {\n-        spyOn(ts, 'createSourceFile');\n-        host.collectDependencies(_('/no/imports/or/re-exports/index.js'), createDependencyInfo());\n-        expect(ts.createSourceFile).not.toHaveBeenCalled();\n-      });\n+        describe('collectDependencies()', () => {\n+          it('should not generate a TS AST if the source does not contain any require calls',\n+             () => {\n+               spyOn(ts, 'createSourceFile');\n+               host.collectDependencies(\n+                   _('/no/imports/or/re-exports/index.js'), createDependencyInfo());\n+               expect(ts.createSourceFile).not.toHaveBeenCalled();\n+             });\n \n-      it('should correctly process files with no imports', () => {\n-        const {dependencies, missing, deepImports} = createDependencyInfo();\n-        host.collectDependencies(\n-            _('/no/imports/but/cannot/skip/index.js'), {dependencies, missing, deepImports});\n-        expect(dependencies.size).toBe(0);\n-        expect(missing.size).toBe(0);\n-        expect(deepImports.size).toBe(0);\n-      });\n+          it('should correctly process files with no imports', () => {\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+            host.collectDependencies(\n+                _('/no/imports/but/cannot/skip/index.js'), {dependencies, missing, deepImports});\n+            expect(dependencies.size).toBe(0);\n+            expect(missing.size).toBe(0);\n+            expect(deepImports.size).toBe(0);\n+          });\n \n-      it('should resolve all the external imports of the source file', () => {\n-        const {dependencies, missing, deepImports} = createDependencyInfo();\n-        host.collectDependencies(\n-            _('/external/imports/index.js'), {dependencies, missing, deepImports});\n-        expect(dependencies.size).toBe(2);\n-        expect(missing.size).toBe(0);\n-        expect(deepImports.size).toBe(0);\n-        expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n-        expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n-      });\n+          it('should resolve all the external imports of the source file', () => {\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+            host.collectDependencies(\n+                _('/external/imports/index.js'), {dependencies, missing, deepImports});\n+            expect(dependencies.size).toBe(2);\n+            expect(missing.size).toBe(0);\n+            expect(deepImports.size).toBe(0);\n+            expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n+            expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n+          });\n \n-      it('should resolve all the external re-exports of the source file', () => {\n-        const {dependencies, missing, deepImports} = createDependencyInfo();\n-        host.collectDependencies(\n-            _('/external/re-exports/index.js'), {dependencies, missing, deepImports});\n-        expect(dependencies.size).toBe(2);\n-        expect(missing.size).toBe(0);\n-        expect(deepImports.size).toBe(0);\n-        expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n-        expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n-      });\n+          it('should resolve all the external re-exports of the source file', () => {\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+            host.collectDependencies(\n+                _('/external/re-exports/index.js'), {dependencies, missing, deepImports});\n+            expect(dependencies.size).toBe(2);\n+            expect(missing.size).toBe(0);\n+            expect(deepImports.size).toBe(0);\n+            expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n+            expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n+          });\n \n-      it('should capture missing external imports', () => {\n-        const {dependencies, missing, deepImports} = createDependencyInfo();\n-        host.collectDependencies(\n-            _('/external/imports-missing/index.js'), {dependencies, missing, deepImports});\n+          it('should capture missing external imports', () => {\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+            host.collectDependencies(\n+                _('/external/imports-missing/index.js'), {dependencies, missing, deepImports});\n \n-        expect(dependencies.size).toBe(1);\n-        expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n-        expect(missing.size).toBe(1);\n-        expect(missing.has(relativeFrom('missing'))).toBe(true);\n-        expect(deepImports.size).toBe(0);\n-      });\n+            expect(dependencies.size).toBe(1);\n+            expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n+            expect(missing.size).toBe(1);\n+            expect(missing.has(relativeFrom('missing'))).toBe(true);\n+            expect(deepImports.size).toBe(0);\n+          });\n \n-      it('should not register deep imports as missing', () => {\n-        // This scenario verifies the behavior of the dependency analysis when an external import\n-        // is found that does not map to an entry-point but still exists on disk, i.e. a deep\n-        // import. Such deep imports are captured for diagnostics purposes.\n-        const {dependencies, missing, deepImports} = createDependencyInfo();\n-        host.collectDependencies(\n-            _('/external/deep-import/index.js'), {dependencies, missing, deepImports});\n+          it('should not register deep imports as missing', () => {\n+            // This scenario verifies the behavior of the dependency analysis when an external\n+            // import is found that does not map to an entry-point but still exists on disk, i.e. a\n+            // deep import. Such deep imports are captured for diagnostics purposes.\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+            host.collectDependencies(\n+                _('/external/deep-import/index.js'), {dependencies, missing, deepImports});\n \n-        expect(dependencies.size).toBe(0);\n-        expect(missing.size).toBe(0);\n-        expect(deepImports.size).toBe(1);\n-        expect(deepImports.has(_('/node_modules/lib_1/deep/import'))).toBe(true);\n-      });\n+            expect(dependencies.size).toBe(0);\n+            expect(missing.size).toBe(0);\n+            expect(deepImports.size).toBe(1);\n+            expect(deepImports.has(_('/node_modules/lib_1/deep/import'))).toBe(true);\n+          });\n \n-      it('should recurse into internal dependencies', () => {\n-        const {dependencies, missing, deepImports} = createDependencyInfo();\n-        host.collectDependencies(\n-            _('/internal/outer/index.js'), {dependencies, missing, deepImports});\n+          it('should recurse into internal dependencies', () => {\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+            host.collectDependencies(\n+                _('/internal/outer/index.js'), {dependencies, missing, deepImports});\n \n-        expect(dependencies.size).toBe(1);\n-        expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n-        expect(missing.size).toBe(0);\n-        expect(deepImports.size).toBe(0);\n-      });\n+            expect(dependencies.size).toBe(1);\n+            expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n+            expect(missing.size).toBe(0);\n+            expect(deepImports.size).toBe(0);\n+          });\n \n-      it('should handle circular internal dependencies', () => {\n-        const {dependencies, missing, deepImports} = createDependencyInfo();\n-        host.collectDependencies(\n-            _('/internal/circular_a/index.js'), {dependencies, missing, deepImports});\n-        expect(dependencies.size).toBe(2);\n-        expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n-        expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n-        expect(missing.size).toBe(0);\n-        expect(deepImports.size).toBe(0);\n-      });\n+          it('should handle circular internal dependencies', () => {\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+            host.collectDependencies(\n+                _('/internal/circular_a/index.js'), {dependencies, missing, deepImports});\n+            expect(dependencies.size).toBe(2);\n+            expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n+            expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n+            expect(missing.size).toBe(0);\n+            expect(deepImports.size).toBe(0);\n+          });\n \n-      it('should support `paths` alias mappings when resolving modules', () => {\n-        const fs = getFileSystem();\n-        host = new UmdDependencyHost(fs, new ModuleResolver(fs, {\n-                                       baseUrl: '/dist',\n-                                       paths: {\n-                                         '@app/*': ['*'],\n-                                         '@lib/*/test': ['lib/*/test'],\n-                                       }\n-                                     }));\n-        const {dependencies, missing, deepImports} = createDependencyInfo();\n-        host.collectDependencies(_('/path-alias/index.js'), {dependencies, missing, deepImports});\n-        expect(dependencies.size).toBe(4);\n-        expect(dependencies.has(_('/dist/components'))).toBe(true);\n-        expect(dependencies.has(_('/dist/shared'))).toBe(true);\n-        expect(dependencies.has(_('/dist/lib/shared/test'))).toBe(true);\n-        expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n-        expect(missing.size).toBe(0);\n-        expect(deepImports.size).toBe(0);\n-      });\n+          it('should support `paths` alias mappings when resolving modules', () => {\n+            const fs = getFileSystem();\n+            host = new UmdDependencyHost(fs, new ModuleResolver(fs, {\n+                                           baseUrl: '/dist',\n+                                           paths: {\n+                                             '@app/*': ['*'],\n+                                             '@lib/*/test': ['lib/*/test'],\n+                                           }\n+                                         }));\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+            host.collectDependencies(\n+                _('/path-alias/index.js'), {dependencies, missing, deepImports});\n+            expect(dependencies.size).toBe(4);\n+            expect(dependencies.has(_('/dist/components'))).toBe(true);\n+            expect(dependencies.has(_('/dist/shared'))).toBe(true);\n+            expect(dependencies.has(_('/dist/lib/shared/test'))).toBe(true);\n+            expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n+            expect(missing.size).toBe(0);\n+            expect(deepImports.size).toBe(0);\n+          });\n \n-      it('should handle entry-point paths with no extension', () => {\n-        const {dependencies, missing, deepImports} = createDependencyInfo();\n-        host.collectDependencies(\n-            _('/external/imports/index'), {dependencies, missing, deepImports});\n-        expect(dependencies.size).toBe(2);\n-        expect(missing.size).toBe(0);\n-        expect(deepImports.size).toBe(0);\n-        expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n-        expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n-      });\n-    });\n+          it('should handle entry-point paths with no extension', () => {\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+            host.collectDependencies(\n+                _('/external/imports/index'), {dependencies, missing, deepImports});\n+            expect(dependencies.size).toBe(2);\n+            expect(missing.size).toBe(0);\n+            expect(deepImports.size).toBe(0);\n+            expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n+            expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n+          });\n+        });\n \n-    function setupMockFileSystem(): void {\n-      loadTestFiles([\n-        {\n-          name: _('/no/imports/or/re-exports/index.js'),\n-          contents: '// some text but no import-like statements'\n-        },\n-        {name: _('/no/imports/or/re-exports/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n-        {name: _('/no/imports/or/re-exports/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {\n-          name: _('/no/imports/but/cannot/skip/index.js'),\n-          contents:\n-              '// A file containing text that looks like a `require(\"call\")` to trick the host\\n' +\n-              '// into processing it even if it has no actual dependencies.\\n' +\n-              umd('no_imports_but_cannot_skip', []),\n-        },\n-        {\n-          name: _('/no/imports/but/cannot/skip/package.json'),\n-          contents: '{\"esm2015\": \"./index.js\"}'\n-        },\n-        {name: _('/no/imports/but/cannot/skip/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {\n-          name: _('/external/imports/index.js'),\n-          contents: umd('imports_index', ['lib_1', 'lib_1/sub_1'])\n-        },\n-        {name: _('/external/imports/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n-        {name: _('/external/imports/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {\n-          name: _('/external/re-exports/index.js'),\n-          contents: umd('imports_index', ['lib_1', 'lib_1/sub_1'], ['lib_1.X', 'lib_1sub_1.Y'])\n-        },\n-        {name: _('/external/re-exports/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n-        {name: _('/external/re-exports/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {\n-          name: _('/external/imports-missing/index.js'),\n-          contents: umd('imports_missing', ['lib_1', 'missing'])\n-        },\n-        {name: _('/external/imports-missing/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n-        {name: _('/external/imports-missing/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {\n-          name: _('/external/deep-import/index.js'),\n-          contents: umd('deep_import', ['lib_1/deep/import'])\n-        },\n-        {name: _('/external/deep-import/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n-        {name: _('/external/deep-import/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {name: _('/internal/outer/index.js'), contents: umd('outer', ['../inner'])},\n-        {name: _('/internal/outer/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n-        {name: _('/internal/outer/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {name: _('/internal/inner/index.js'), contents: umd('inner', ['lib_1/sub_1'], ['X'])},\n-        {\n-          name: _('/internal/circular_a/index.js'),\n-          contents: umd('circular_a', ['../circular_b', 'lib_1/sub_1'], ['Y'])\n-        },\n-        {\n-          name: _('/internal/circular_b/index.js'),\n-          contents: umd('circular_b', ['../circular_a', 'lib_1'], ['X'])\n-        },\n-        {name: _('/internal/circular_a/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n-        {name: _('/internal/circular_a/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {name: _('/re-directed/index.js'), contents: umd('re_directed', ['lib_1/sub_2'])},\n-        {name: _('/re-directed/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n-        {name: _('/re-directed/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {\n-          name: _('/path-alias/index.js'),\n-          contents:\n-              umd('path_alias', ['@app/components', '@app/shared', '@lib/shared/test', 'lib_1'])\n-        },\n-        {name: _('/path-alias/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n-        {name: _('/path-alias/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {name: _('/node_modules/lib_1/index.d.ts'), contents: 'export declare class X {}'},\n-        {\n-          name: _('/node_modules/lib_1/package.json'),\n-          contents: '{\"esm2015\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n-        },\n-        {name: _('/node_modules/lib_1/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {\n-          name: _('/node_modules/lib_1/deep/import/index.js'),\n-          contents: 'export class DeepImport {}'\n-        },\n-        {name: _('/node_modules/lib_1/sub_1/index.d.ts'), contents: 'export declare class Y {}'},\n-        {\n-          name: _('/node_modules/lib_1/sub_1/package.json'),\n-          contents: '{\"esm2015\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n-        },\n-        {name: _('/node_modules/lib_1/sub_1/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {name: _('/node_modules/lib_1/sub_2.d.ts'), contents: `export * from './sub_2/sub_2';`},\n-        {name: _('/node_modules/lib_1/sub_2/sub_2.d.ts'), contents: `export declare class Z {}';`},\n-        {\n-          name: _('/node_modules/lib_1/sub_2/package.json'),\n-          contents: '{\"esm2015\": \"./sub_2.js\", \"typings\": \"./sub_2.d.ts\"}'\n-        },\n-        {name: _('/node_modules/lib_1/sub_2/sub_2.metadata.json'), contents: 'MOCK METADATA'},\n-        {name: _('/dist/components/index.d.ts'), contents: `export declare class MyComponent {};`},\n-        {\n-          name: _('/dist/components/package.json'),\n-          contents: '{\"esm2015\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n-        },\n-        {name: _('/dist/components/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {\n-          name: _('/dist/shared/index.d.ts'),\n-          contents: `import {X} from 'lib_1';\\nexport declare class Service {}`\n-        },\n-        {\n-          name: _('/dist/shared/package.json'),\n-          contents: '{\"esm2015\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n-        },\n-        {name: _('/dist/shared/index.metadata.json'), contents: 'MOCK METADATA'},\n-        {name: _('/dist/lib/shared/test/index.d.ts'), contents: `export class TestHelper {}`},\n-        {\n-          name: _('/dist/lib/shared/test/package.json'),\n-          contents: '{\"esm2015\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n-        },\n-        {name: _('/dist/lib/shared/test/index.metadata.json'), contents: 'MOCK METADATA'},\n-      ]);\n-    }\n+        function setupMockFileSystem(): void {\n+          loadTestFiles([\n+            {\n+              name: _('/no/imports/or/re-exports/index.js'),\n+              contents: '// some text but no import-like statements'\n+            },\n+            {\n+              name: _('/no/imports/or/re-exports/package.json'),\n+              contents: '{\"esm2015\": \"./index.js\"}'\n+            },\n+            {name: _('/no/imports/or/re-exports/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/no/imports/but/cannot/skip/index.js'),\n+              contents:\n+                  '// A file containing text that looks like a `require(\"call\")` to trick the host\\n' +\n+                  '// into processing it even if it has no actual dependencies.\\n' +\n+                  umd('no_imports_but_cannot_skip', []),\n+            },\n+            {\n+              name: _('/no/imports/but/cannot/skip/package.json'),\n+              contents: '{\"esm2015\": \"./index.js\"}'\n+            },\n+            {name: _('/no/imports/but/cannot/skip/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/external/imports/index.js'),\n+              contents: umd('imports_index', ['lib_1', 'lib_1/sub_1'])\n+            },\n+            {name: _('/external/imports/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n+            {name: _('/external/imports/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/external/re-exports/index.js'),\n+              contents: umd('imports_index', ['lib_1', 'lib_1/sub_1'], ['lib_1.X', 'lib_1sub_1.Y'])\n+            },\n+            {name: _('/external/re-exports/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n+            {name: _('/external/re-exports/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/external/imports-missing/index.js'),\n+              contents: umd('imports_missing', ['lib_1', 'missing'])\n+            },\n+            {\n+              name: _('/external/imports-missing/package.json'),\n+              contents: '{\"esm2015\": \"./index.js\"}'\n+            },\n+            {name: _('/external/imports-missing/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/external/deep-import/index.js'),\n+              contents: umd('deep_import', ['lib_1/deep/import'])\n+            },\n+            {name: _('/external/deep-import/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n+            {name: _('/external/deep-import/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {name: _('/internal/outer/index.js'), contents: umd('outer', ['../inner'])},\n+            {name: _('/internal/outer/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n+            {name: _('/internal/outer/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {name: _('/internal/inner/index.js'), contents: umd('inner', ['lib_1/sub_1'], ['X'])},\n+            {\n+              name: _('/internal/circular_a/index.js'),\n+              contents: umd('circular_a', ['../circular_b', 'lib_1/sub_1'], ['Y'])\n+            },\n+            {\n+              name: _('/internal/circular_b/index.js'),\n+              contents: umd('circular_b', ['../circular_a', 'lib_1'], ['X'])\n+            },\n+            {name: _('/internal/circular_a/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n+            {name: _('/internal/circular_a/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {name: _('/re-directed/index.js'), contents: umd('re_directed', ['lib_1/sub_2'])},\n+            {name: _('/re-directed/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n+            {name: _('/re-directed/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/path-alias/index.js'),\n+              contents:\n+                  umd('path_alias', ['@app/components', '@app/shared', '@lib/shared/test', 'lib_1'])\n+            },\n+            {name: _('/path-alias/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n+            {name: _('/path-alias/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {name: _('/node_modules/lib_1/index.d.ts'), contents: 'export declare class X {}'},\n+            {\n+              name: _('/node_modules/lib_1/package.json'),\n+              contents: '{\"esm2015\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n+            },\n+            {name: _('/node_modules/lib_1/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/node_modules/lib_1/deep/import/index.js'),\n+              contents: 'export class DeepImport {}'\n+            },\n+            {\n+              name: _('/node_modules/lib_1/sub_1/index.d.ts'),\n+              contents: 'export declare class Y {}'\n+            },\n+            {\n+              name: _('/node_modules/lib_1/sub_1/package.json'),\n+              contents: '{\"esm2015\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n+            },\n+            {name: _('/node_modules/lib_1/sub_1/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {name: _('/node_modules/lib_1/sub_2.d.ts'), contents: `export * from './sub_2/sub_2';`},\n+            {\n+              name: _('/node_modules/lib_1/sub_2/sub_2.d.ts'),\n+              contents: `export declare class Z {}';`\n+            },\n+            {\n+              name: _('/node_modules/lib_1/sub_2/package.json'),\n+              contents: '{\"esm2015\": \"./sub_2.js\", \"typings\": \"./sub_2.d.ts\"}'\n+            },\n+            {name: _('/node_modules/lib_1/sub_2/sub_2.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/dist/components/index.d.ts'),\n+              contents: `export declare class MyComponent {};`\n+            },\n+            {\n+              name: _('/dist/components/package.json'),\n+              contents: '{\"esm2015\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n+            },\n+            {name: _('/dist/components/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/dist/shared/index.d.ts'),\n+              contents: `import {X} from 'lib_1';\\nexport declare class Service {}`\n+            },\n+            {\n+              name: _('/dist/shared/package.json'),\n+              contents: '{\"esm2015\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n+            },\n+            {name: _('/dist/shared/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {name: _('/dist/lib/shared/test/index.d.ts'), contents: `export class TestHelper {}`},\n+            {\n+              name: _('/dist/lib/shared/test/package.json'),\n+              contents: '{\"esm2015\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n+            },\n+            {name: _('/dist/lib/shared/test/index.metadata.json'), contents: 'MOCK METADATA'},\n+          ]);\n+        }\n \n-    function umd(moduleName: string, importPaths: string[], exportNames: string[] = []) {\n-      const exportStatements =\n-          exportNames.map(e => `  exports.${e.replace(/.+\\./, '')} = ${e};`).join('\\n');\n-      return createUmdModule(moduleName, importPaths, exportStatements);\n-    }\n-  });\n+        function umd(moduleName: string, importPaths: string[], exportNames: string[] = []) {\n+          const exportStatements =\n+              exportNames.map(e => `  exports.${e.replace(/.+\\./, '')} = ${e};`).join('\\n');\n+          return createUmdModule(moduleName, importPaths, exportStatements);\n+        }\n+      }));\n });"
        },
        {
            "sha": "a2c310a90b7c1fc0349fe39ea181ad01a6b6dc41",
            "filename": "packages/compiler-cli/ngcc/test/helpers/umd_utils.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/707bf41fa6f41eb8dc972a219bda248891d27860/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Fumd_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/707bf41fa6f41eb8dc972a219bda248891d27860/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Fumd_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Fumd_utils.ts?ref=707bf41fa6f41eb8dc972a219bda248891d27860",
            "patch": "@@ -118,6 +118,25 @@ export function createUmdModuleFactory(\n   };\n }\n \n+export function testForEachUmdFormat(testSuite: (data: {\n+                                       createUmdModule: ReturnType<typeof createUmdModuleFactory>,\n+                                       wrapperFunctionFormat: WrapperFunctionFormat,\n+                                       parenthesisFormat: ParenthesisFormat\n+                                     }) => void) {\n+  return () => {\n+    for (const wrapperFunctionFormat\n+             of [WrapperFunctionFormat.Rollup, WrapperFunctionFormat.Webpack]) {\n+      for (const parenthesisFormat\n+               of [ParenthesisFormat.AroundFunction, ParenthesisFormat.AroundIife]) {\n+        const createUmdModule = createUmdModuleFactory(wrapperFunctionFormat, parenthesisFormat);\n+        describe(`(with ${wrapperFunctionFormat} and ${parenthesisFormat})`, () => {\n+          testSuite({createUmdModule, wrapperFunctionFormat, parenthesisFormat});\n+        });\n+      }\n+    }\n+  };\n+}\n+\n function stripIndentation(text: string): string {\n   const lines = text.replace(/^ *\\r?\\n/, '').replace(/\\r?\\n *$/, '').split('\\n');\n   const minIndentation ="
        },
        {
            "sha": "eef012a77783cbaee77e21e7b032a42f5ce97e53",
            "filename": "packages/compiler-cli/ngcc/test/host/umd_host_spec.ts",
            "status": "modified",
            "additions": 3113,
            "deletions": 3036,
            "changes": 6149,
            "blob_url": "https://github.com/angular/angular/blob/707bf41fa6f41eb8dc972a219bda248891d27860/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/707bf41fa6f41eb8dc972a219bda248891d27860/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts?ref=707bf41fa6f41eb8dc972a219bda248891d27860"
        },
        {
            "sha": "ce83a63131b82cdb73928c28d774663730a2fb3c",
            "filename": "packages/compiler-cli/ngcc/test/rendering/umd_rendering_formatter_spec.ts",
            "status": "modified",
            "additions": 164,
            "deletions": 114,
            "changes": 278,
            "blob_url": "https://github.com/angular/angular/blob/707bf41fa6f41eb8dc972a219bda248891d27860/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/707bf41fa6f41eb8dc972a219bda248891d27860/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts?ref=707bf41fa6f41eb8dc972a219bda248891d27860",
            "patch": "@@ -19,10 +19,11 @@ import {DecorationAnalyzer} from '../../src/analysis/decoration_analyzer';\n import {NgccReferencesRegistry} from '../../src/analysis/ngcc_references_registry';\n import {UmdReflectionHost} from '../../src/host/umd_host';\n import {UmdRenderingFormatter} from '../../src/rendering/umd_rendering_formatter';\n-import {AdditionalFormatOptions, createUmdModuleFactory, ParenthesisFormat, WrapperFunctionFormat} from '../helpers/umd_utils';\n+import {AdditionalFormatOptions, testForEachUmdFormat, WrapperFunctionFormat} from '../helpers/umd_utils';\n import {makeTestEntryPointBundle} from '../helpers/utils';\n \n-interface TestFileSpec extends Omit<TestFile, 'contents'> {\n+interface TestFileSpec extends Omit<TestFile, 'name'|'contents'> {\n+  name: string;\n   contents: {\n     preamble?: string; moduleName: string; dependencies: string[]; factoryBody: string;\n     additionalOptions?: AdditionalFormatOptions;\n@@ -52,32 +53,32 @@ function setup(file: TestFile) {\n }\n \n runInEachFileSystem(() => {\n-  describe('UmdRenderingFormatter', () => {\n-    let _: typeof absoluteFrom;\n-    let PROGRAM_FILE_SPEC: TestFileSpec;\n-    let PROGRAM_DECORATE_HELPER_FILE_SPEC: TestFileSpec;\n-    let PROGRAM_WITH_GLOBAL_INITIALIZER_FILE_SPEC: TestFileSpec;\n-\n-    beforeEach(() => {\n-      _ = absoluteFrom;\n-\n-      PROGRAM_WITH_GLOBAL_INITIALIZER_FILE_SPEC = {\n-        name: _('/node_modules/test-package/some/file.js'),\n-        contents: {\n-          moduleName: 'file',\n-          dependencies: ['some-side-effect', '/local-dep', '@angular/core'],\n-          factoryBody: '',\n-          additionalOptions: {hasGlobalInitializer: true},\n-        },\n-      };\n-\n-      PROGRAM_FILE_SPEC = {\n-        name: _('/node_modules/test-package/some/file.js'),\n-        contents: {\n-          preamble: '/* A copyright notice */',\n-          moduleName: 'file',\n-          dependencies: ['some-side-effect', '/local-dep', '@angular/core'],\n-          factoryBody: `\n+  describe(\n+      'UmdRenderingFormatter', testForEachUmdFormat(({createUmdModule, wrapperFunctionFormat}) => {\n+        let _: typeof absoluteFrom;\n+        let PROGRAM: TestFile;\n+        let PROGRAM_DECORATE_HELPER: TestFile;\n+        let PROGRAM_WITH_GLOBAL_INITIALIZER: TestFile;\n+\n+        const formatFactory = (spec: TestFileSpec): TestFile => ({\n+          ...spec,\n+          name: _(spec.name),\n+          contents: `${spec.contents.preamble ?? ''}\\n` +\n+              createUmdModule(\n+                        spec.contents.moduleName, spec.contents.dependencies,\n+                        spec.contents.factoryBody, spec.contents.additionalOptions),\n+        });\n+\n+        beforeEach(() => {\n+          _ = absoluteFrom;\n+\n+          PROGRAM = formatFactory({\n+            name: '/node_modules/test-package/some/file.js',\n+            contents: {\n+              preamble: '/* A copyright notice */',\n+              moduleName: 'file',\n+              dependencies: ['some-side-effect', '/local-dep', '@angular/core'],\n+              factoryBody: `\n var A = (function() {\n   function A() {}\n   A.decorators = [\n@@ -123,17 +124,15 @@ exports.C = C;\n exports.NoIife = NoIife;\n exports.BadIife = BadIife;\n `,\n-        },\n-      };\n-\n-\n-      PROGRAM_DECORATE_HELPER_FILE_SPEC = {\n-        name: _('/node_modules/test-package/some/file.js'),\n-        contents: {\n-          preamble: '/* A copyright notice */',\n-          moduleName: 'file',\n-          dependencies: ['/tslib', '@angular/core'],\n-          factoryBody: `\n+            },\n+          });\n+          PROGRAM_DECORATE_HELPER = formatFactory({\n+            name: '/node_modules/test-package/some/file.js',\n+            contents: {\n+              preamble: '/* A copyright notice */',\n+              moduleName: 'file',\n+              dependencies: ['/tslib', '@angular/core'],\n+              factoryBody: `\n   var OtherA = function () { return function (node) { }; };\n   var OtherB = function () { return function (node) { }; };\n   var A = /** @class */ (function () {\n@@ -178,34 +177,21 @@ exports.BadIife = BadIife;\n   exports.D = D;\n   // Some other content\n `,\n-        },\n-      };\n-    });\n-\n-    [ParenthesisFormat.AroundFunction, ParenthesisFormat.AroundIife].forEach(parenFormat => {\n-      const createUmdModule = createUmdModuleFactory(WrapperFunctionFormat.Rollup, parenFormat);\n-      const formatFactory = (spec: TestFileSpec): TestFile => ({\n-        ...spec,\n-        contents: `${spec.contents.preamble ?? ''}\\n` +\n-            createUmdModule(\n-                      spec.contents.moduleName, spec.contents.dependencies,\n-                      spec.contents.factoryBody, spec.contents.additionalOptions),\n-      });\n-\n-      describe(`(when dealing with ${parenFormat})`, () => {\n-        let PROGRAM: TestFile;\n-        let PROGRAM_DECORATE_HELPER: TestFile;\n-        let PROGRAM_WITH_GLOBAL_INITIALIZER: TestFile;\n-\n-        beforeEach(() => {\n-          PROGRAM = formatFactory(PROGRAM_FILE_SPEC);\n-          PROGRAM_DECORATE_HELPER = formatFactory(PROGRAM_DECORATE_HELPER_FILE_SPEC);\n-          PROGRAM_WITH_GLOBAL_INITIALIZER =\n-              formatFactory(PROGRAM_WITH_GLOBAL_INITIALIZER_FILE_SPEC);\n+            },\n+          });\n+          PROGRAM_WITH_GLOBAL_INITIALIZER = formatFactory({\n+            name: '/node_modules/test-package/some/file.js',\n+            contents: {\n+              moduleName: 'file',\n+              dependencies: ['some-side-effect', '/local-dep', '@angular/core'],\n+              factoryBody: '',\n+              additionalOptions: {hasGlobalInitializer: true},\n+            },\n+          });\n         });\n \n         describe('addImports', () => {\n-          it('should append the given imports into the CommonJS factory call', () => {\n+          it('should append the given imports into the CommonJS2 factory call', () => {\n             const {renderer, program} = setup(PROGRAM);\n             const file =\n                 getSourceFileOrError(program, _('/node_modules/test-package/some/file.js'));\n@@ -219,10 +205,34 @@ exports.BadIife = BadIife;\n                 file);\n             expect(output.toString())\n                 .toContain(\n-                    `typeof exports === 'object' && typeof module !== 'undefined' ?\\n` +\n-                    `    factory(require('@angular/core'),require('@angular/common'),exports, require('some-side-effect'), require('/local-dep'), require('@angular/core')) :`);\n+                    wrapperFunctionFormat === WrapperFunctionFormat.Rollup ?\n+                        `typeof exports === 'object' && typeof module !== 'undefined' ?\\n` +\n+                            `    factory(require('@angular/core'),require('@angular/common'),exports, require('some-side-effect'), require('/local-dep'), require('@angular/core')) :` :\n+                        `if (typeof exports === 'object' && typeof module === 'object')\\n` +\n+                            `    module.exports = factory(require('@angular/core'),require('@angular/common'),require('some-side-effect'), require('/local-dep'), require('@angular/core'));`);\n           });\n \n+          if (wrapperFunctionFormat === WrapperFunctionFormat.Webpack) {\n+            // The CommonJS (vs CommonJS2) format only applies to the Webpack format.\n+            it('should append the given imports into the CommonJS factory call', () => {\n+              const {renderer, program} = setup(PROGRAM);\n+              const file =\n+                  getSourceFileOrError(program, _('/node_modules/test-package/some/file.js'));\n+              const output = new MagicString(PROGRAM.contents);\n+              renderer.addImports(\n+                  output,\n+                  [\n+                    {specifier: '@angular/core', qualifier: ts.createIdentifier('i0')},\n+                    {specifier: '@angular/common', qualifier: ts.createIdentifier('i1')}\n+                  ],\n+                  file);\n+              expect(output.toString())\n+                  .toContain(\n+                      `if (typeof exports === 'object')\\n` +\n+                      `    exports['file'] = factory(require('@angular/core'),require('@angular/common'),require('some-side-effect'), require('/local-dep'), require('@angular/core'));`);\n+            });\n+          }\n+\n           it('should append the given imports into the AMD initialization', () => {\n             const {renderer, program} = setup(PROGRAM);\n             const file =\n@@ -237,8 +247,11 @@ exports.BadIife = BadIife;\n                 file);\n             expect(output.toString())\n                 .toContain(\n-                    `typeof define === 'function' && define.amd ?\\n` +\n-                    `    define('file', ['@angular/core','@angular/common','exports', 'some-side-effect', '/local-dep', '@angular/core'], factory) :`);\n+                    wrapperFunctionFormat === WrapperFunctionFormat.Rollup ?\n+                        `typeof define === 'function' && define.amd ?\\n` +\n+                            `    define('file', ['@angular/core','@angular/common','exports', 'some-side-effect', '/local-dep', '@angular/core'], factory) :` :\n+                        `if (typeof define === 'function' && define.amd)\\n` +\n+                            `    define(['@angular/core','@angular/common','some-side-effect', '/local-dep', '@angular/core'], factory);`);\n           });\n \n           it('should append the given imports into the global initialization', () => {\n@@ -255,7 +268,9 @@ exports.BadIife = BadIife;\n                 file);\n             expect(output.toString())\n                 .toContain(\n-                    `(factory(global.ng.core,global.ng.common,global.file, global.someSideEffect, global.localDep, global.ng.core));`);\n+                    wrapperFunctionFormat === WrapperFunctionFormat.Rollup ?\n+                        `(factory(global.ng.core,global.ng.common,global.file, global.someSideEffect, global.localDep, global.ng.core));` :\n+                        `root['file'] = factory(global.ng.core,global.ng.common,root['someSideEffect'], root['localDep'], root['ng']['core']);`);\n           });\n \n           it('should remap import identifiers to valid global properties', () => {\n@@ -276,28 +291,35 @@ exports.BadIife = BadIife;\n                 file);\n             expect(output.toString())\n                 .toContain(\n-                    `(factory(` +\n-                    `global.ngrx.store,global.ng.platformBrowserDynamic,global.ng.common.testing,global.angularFoo.package,` +\n-                    `global.file, global.someSideEffect, global.localDep, global.ng.core));`);\n+                    wrapperFunctionFormat === WrapperFunctionFormat.Rollup ?\n+                        `(factory(` +\n+                            `global.ngrx.store,global.ng.platformBrowserDynamic,global.ng.common.testing,global.angularFoo.package,` +\n+                            `global.file, global.someSideEffect, global.localDep, global.ng.core));` :\n+                        `root['file'] = factory(` +\n+                            `global.ngrx.store,global.ng.platformBrowserDynamic,global.ng.common.testing,global.angularFoo.package,` +\n+                            `root['someSideEffect'], root['localDep'], root['ng']['core']);`);\n           });\n \n-          it('should append the given imports into the global initialization, if it has a global/self initializer',\n-             () => {\n-               const {renderer, program} = setup(PROGRAM_WITH_GLOBAL_INITIALIZER);\n-               const file =\n-                   getSourceFileOrError(program, _('/node_modules/test-package/some/file.js'));\n-               const output = new MagicString(file.text);\n-               renderer.addImports(\n-                   output,\n-                   [\n-                     {specifier: '@angular/core', qualifier: ts.createIdentifier('i0')},\n-                     {specifier: '@angular/common', qualifier: ts.createIdentifier('i1')}\n-                   ],\n-                   file);\n-               expect(output.toString())\n-                   .toContain(\n-                       `(global = global || self, factory(global.ng.core,global.ng.common,global.file, global.someSideEffect, global.localDep, global.ng.core))`);\n-             });\n+          if (wrapperFunctionFormat === WrapperFunctionFormat.Rollup) {\n+            // Global initializer only applies to the Rollup format.\n+            it('should append the given imports into the global initialization, if it has a global/self initializer',\n+               () => {\n+                 const {renderer, program} = setup(PROGRAM_WITH_GLOBAL_INITIALIZER);\n+                 const file =\n+                     getSourceFileOrError(program, _('/node_modules/test-package/some/file.js'));\n+                 const output = new MagicString(file.text);\n+                 renderer.addImports(\n+                     output,\n+                     [\n+                       {specifier: '@angular/core', qualifier: ts.createIdentifier('i0')},\n+                       {specifier: '@angular/common', qualifier: ts.createIdentifier('i1')}\n+                     ],\n+                     file);\n+                 expect(output.toString())\n+                     .toContain(\n+                         `(global = global || self, factory(global.ng.core,global.ng.common,global.file, global.someSideEffect, global.localDep, global.ng.core))`);\n+               });\n+          }\n \n           it('should append the given imports as parameters into the factory function definition',\n              () => {\n@@ -314,7 +336,9 @@ exports.BadIife = BadIife;\n                    file);\n                expect(output.toString())\n                    .toContain(\n-                       `(function (i0,i1,exports, someSideEffect, localDep, core) {\\n  'use strict';`);\n+                       wrapperFunctionFormat === WrapperFunctionFormat.Rollup ?\n+                           `(function (i0,i1,exports, someSideEffect, localDep, core) {\\n  'use strict';` :\n+                           `function (i0,i1,someSideEffect, localDep, core) {\\n  'use strict';`);\n              });\n \n           it('should handle the case where there were no prior imports nor exports', () => {\n@@ -343,14 +367,28 @@ exports.BadIife = BadIife;\n                 file);\n             const outputSrc = output.toString();\n \n-            expect(outputSrc).toContain(\n-                `typeof exports === 'object' && typeof module !== 'undefined' ?\\n` +\n-                `    factory(require('@angular/core'),require('@angular/common')) :`);\n-            expect(outputSrc).toContain(\n-                `typeof define === 'function' && define.amd ?\\n` +\n-                `    define('file',['@angular/core','@angular/common'], factory) :`);\n-            expect(outputSrc).toContain(`(factory(global.ng.core,global.ng.common));`);\n-            expect(outputSrc).toContain(`(function (i0,i1) {\\n  'use strict';`);\n+            if (wrapperFunctionFormat === WrapperFunctionFormat.Rollup) {\n+              expect(outputSrc).toContain(\n+                  `typeof exports === 'object' && typeof module !== 'undefined' ?\\n` +\n+                  `    factory(require('@angular/core'),require('@angular/common')) :`);\n+              expect(outputSrc).toContain(\n+                  `typeof define === 'function' && define.amd ?\\n` +\n+                  `    define('file',['@angular/core','@angular/common'], factory) :`);\n+              expect(outputSrc).toContain(`(factory(global.ng.core,global.ng.common));`);\n+              expect(outputSrc).toContain(`(function (i0,i1) {\\n  'use strict';`);\n+            } else {\n+              expect(outputSrc).toContain(\n+                  `if (typeof exports === 'object' && typeof module === 'object')\\n` +\n+                  `    module.exports = factory(require('@angular/core'),require('@angular/common'));`);\n+              expect(outputSrc).toContain(\n+                  `if (typeof define === 'function' && define.amd)\\n` +\n+                  `    define(['@angular/core','@angular/common'], factory);`);\n+              expect(outputSrc).toContain(\n+                  `if (typeof exports === 'object')\\n` +\n+                  `    exports['file'] = factory(require('@angular/core'),require('@angular/common'));`);\n+              expect(outputSrc).toContain(`factory(global.ng.core,global.ng.common);`);\n+              expect(outputSrc).toContain(`function (i0,i1) {\\n  'use strict';`);\n+            }\n           });\n \n           it('should leave the file unchanged if there are no imports to add', () => {\n@@ -393,16 +431,31 @@ exports.BadIife = BadIife;\n                 file);\n             const outputSrc = output.toString();\n \n-            expect(outputSrc).toContain(\n-                `typeof exports === 'object' && typeof module !== 'undefined' ?\\n` +\n-                `    factory(require('@angular/core'),require('@angular/common'),exports, require('/local-dep'), require('@angular/core'), require('some-side-effect')) :`);\n-            expect(outputSrc).toContain(\n-                `typeof define === 'function' && define.amd ?\\n` +\n-                `    define('file', ['@angular/core','@angular/common','exports', '/local-dep', '@angular/core', 'some-side-effect'], factory) :`);\n-            expect(outputSrc).toContain(\n-                `(factory(global.ng.core,global.ng.common,global.file, global.localDep, global.ng.core, global.someSideEffect));`);\n-            expect(outputSrc).toContain(\n-                `(function (i0,i1,exports, localDep, core) {\\n  'use strict';`);\n+            if (wrapperFunctionFormat === WrapperFunctionFormat.Rollup) {\n+              expect(outputSrc).toContain(\n+                  `typeof exports === 'object' && typeof module !== 'undefined' ?\\n` +\n+                  `    factory(require('@angular/core'),require('@angular/common'),exports, require('/local-dep'), require('@angular/core'), require('some-side-effect')) :`);\n+              expect(outputSrc).toContain(\n+                  `typeof define === 'function' && define.amd ?\\n` +\n+                  `    define('file', ['@angular/core','@angular/common','exports', '/local-dep', '@angular/core', 'some-side-effect'], factory) :`);\n+              expect(outputSrc).toContain(\n+                  `(factory(global.ng.core,global.ng.common,global.file, global.localDep, global.ng.core, global.someSideEffect));`);\n+              expect(outputSrc).toContain(\n+                  `(function (i0,i1,exports, localDep, core) {\\n  'use strict';`);\n+            } else {\n+              expect(outputSrc).toContain(\n+                  `if (typeof exports === 'object' && typeof module === 'object')\\n` +\n+                  `    module.exports = factory(require('@angular/core'),require('@angular/common'),require('/local-dep'), require('@angular/core'), require('some-side-effect'));`);\n+              expect(outputSrc).toContain(\n+                  `if (typeof define === 'function' && define.amd)\\n` +\n+                  `    define(['@angular/core','@angular/common','/local-dep', '@angular/core', 'some-side-effect'], factory);`);\n+              expect(outputSrc).toContain(\n+                  `if (typeof exports === 'object')\\n` +\n+                  `    exports['file'] = factory(require('@angular/core'),require('@angular/common'),require('/local-dep'), require('@angular/core'), require('some-side-effect'));`);\n+              expect(outputSrc).toContain(\n+                  `root['file'] = factory(global.ng.core,global.ng.common,root['localDep'], root['ng']['core'], root['someSideEffect']);`);\n+              expect(outputSrc).toContain(`function (i0,i1,localDep, core) {\\n  'use strict';`);\n+            }\n           });\n         });\n \n@@ -433,7 +486,7 @@ exports.ComponentA2 = i0.ComponentA2;\n exports.ComponentB = i1.ComponentB;\n exports.TopLevelComponent = TopLevelComponent;\n \n-}))`);\n+})`);\n \n             expect(generateNamedImportSpy).toHaveBeenCalledWith('./a', 'ComponentA1');\n             expect(generateNamedImportSpy).toHaveBeenCalledWith('./a', 'ComponentA2');\n@@ -448,8 +501,7 @@ exports.TopLevelComponent = TopLevelComponent;\n                 getSourceFileOrError(program, _('/node_modules/test-package/some/file.js'));\n             const output = new MagicString(PROGRAM.contents);\n             renderer.addConstants(output, 'var x = 3;', file);\n-            expect(output.toString())\n-                .toContain(`(this, (function (exports, someSideEffect, localDep, core) {\n+            expect(output.toString()).toContain(`someSideEffect, localDep, core) {\n ${'  '}\n var x = 3;\n 'use strict';\n@@ -697,7 +749,5 @@ SOME DEFINITION TEXT\n                 .toBe('var baz = \"qux\";');\n           });\n         });\n-      });\n-    });\n-  });\n+      }));\n });"
        }
    ],
    "stats": {
        "total": 6936,
        "additions": 3550,
        "deletions": 3386
    }
}