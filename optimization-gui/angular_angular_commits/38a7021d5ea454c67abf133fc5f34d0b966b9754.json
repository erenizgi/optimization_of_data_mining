{
    "author": "crisbeto",
    "message": "fix(core): error due to integer overflow when there are too many host bindings (#38014)\n\nWe currently use 16 bits to store information about nodes in a view.\nThe 16 bits give us 65536 entries in the array, but the problem is that while\nthe number is large, it can be reached by ~4300 directive instances with host\nbindings which could realistically happen is a very large view, as seen in #37876.\nOnce we hit the limit, we end up overflowing which eventually leads to a runtime error.\n\nThese changes bump to using 20 bits which gives us around 1048576 entries in\nthe array or 16 times more than the current amount which could still technically\nbe reached, but is much less likely and the user may start hitting browser limitations\nby that point.\n\nI picked the 20 bit number since it gives us enough buffer over the 16 bit one,\nwhile not being as massive as a 24 bit or 32 bit.\n\nI've also added a dev mode assertion so it's easier to track down if it happens\nagain in the future.\n\nFixes #37876.\n\nPR Close #38014",
    "sha": "38a7021d5ea454c67abf133fc5f34d0b966b9754",
    "files": [
        {
            "sha": "ff8b4f04886982a7dfa92093c5837ed3ec9a4e58",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/38a7021d5ea454c67abf133fc5f34d0b966b9754/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/38a7021d5ea454c67abf133fc5f34d0b966b9754/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=38a7021d5ea454c67abf133fc5f34d0b966b9754",
            "patch": "@@ -12,7 +12,7 @@ import {CUSTOM_ELEMENTS_SCHEMA, NO_ERRORS_SCHEMA, SchemaMetadata} from '../../me\n import {ViewEncapsulation} from '../../metadata/view';\n import {validateAgainstEventAttributes, validateAgainstEventProperties} from '../../sanitization/sanitization';\n import {Sanitizer} from '../../sanitization/sanitizer';\n-import {assertDataInRange, assertDefined, assertDomNode, assertEqual, assertGreaterThan, assertNotEqual, assertNotSame, assertSame} from '../../util/assert';\n+import {assertDataInRange, assertDefined, assertDomNode, assertEqual, assertGreaterThan, assertLessThan, assertNotEqual, assertNotSame, assertSame} from '../../util/assert';\n import {createNamedArrayType} from '../../util/named_array_type';\n import {initNgDevMode} from '../../util/ng_dev_mode';\n import {normalizeDebugBindingName, normalizeDebugBindingValue} from '../../util/ng_reflect';\n@@ -100,6 +100,10 @@ export function setHostBindingsByExecutingExpandoInstructions(tView: TView, lVie\n         } else {\n           // If it's not a number, it's a host binding function that needs to be executed.\n           if (instruction !== null) {\n+            ngDevMode &&\n+                assertLessThan(\n+                    currentDirectiveIndex, TNodeProviderIndexes.CptViewProvidersCountShifter,\n+                    'Reached the max number of host bindings');\n             setBindingRootForHostBindings(bindingRootIndex, currentDirectiveIndex);\n             const hostCtx = lView[currentDirectiveIndex];\n             instruction(RenderFlags.Update, hostCtx);"
        },
        {
            "sha": "58284f4c11ba5ae7db11f9617d57f7c75df4b8de",
            "filename": "packages/core/src/render3/interfaces/node.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/38a7021d5ea454c67abf133fc5f34d0b966b9754/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fnode.ts",
            "raw_url": "https://github.com/angular/angular/raw/38a7021d5ea454c67abf133fc5f34d0b966b9754/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fnode.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fnode.ts?ref=38a7021d5ea454c67abf133fc5f34d0b966b9754",
            "patch": "@@ -87,16 +87,17 @@ export const enum TNodeFlags {\n  * Corresponds to the TNode.providerIndexes property.\n  */\n export const enum TNodeProviderIndexes {\n-  /** The index of the first provider on this node is encoded on the least significant bits */\n-  ProvidersStartIndexMask = 0b00000000000000001111111111111111,\n+  /** The index of the first provider on this node is encoded on the least significant bits. */\n+  ProvidersStartIndexMask = 0b00000000000011111111111111111111,\n \n   /**\n-     The count of view providers from the component on this node is encoded on the 16 most\n-     significant bits\n+   * The count of view providers from the component on this node is\n+   * encoded on the 20 most significant bits.\n    */\n-  CptViewProvidersCountShift = 16,\n-  CptViewProvidersCountShifter = 0b00000000000000010000000000000000,\n+  CptViewProvidersCountShift = 20,\n+  CptViewProvidersCountShifter = 0b00000000000100000000000000000000,\n }\n+\n /**\n  * A set of marker values to be used in the attributes arrays. These markers indicate that some\n  * items are not regular attributes and the processing should be adapted accordingly."
        }
    ],
    "stats": {
        "total": 19,
        "additions": 12,
        "deletions": 7
    }
}