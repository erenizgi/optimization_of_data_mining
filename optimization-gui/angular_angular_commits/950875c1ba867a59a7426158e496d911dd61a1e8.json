{
    "author": "ayazhafiz",
    "message": "refactor(language-service): pull out interfaces on package toplevel (#40621)\n\nTwo motivations behind this change:\n\n1. We would like to expose the types of the Language Service to external\n   users (like the VSCode extension) via the npm package, on the top\n   level of the package\n2. We would like the View Engine and Ivy LS to share a common interface\n   (notably after the inclusion of `getTcb`, the Ivy LS upholds a\n   strict superset of `ts.LanguageService`; previously both VE and Ivy\n   LS were aligned on `ts.LanguageService`.)\n\nTo this end, this commit refactors the exports on the toplevel of the\n`language-service/` package to just be types common to both the VE and\nIvy language services. The VE and Ivy build targets then import and use\nthese types accordingly, and the expectation is that an external user\nwill just import the relevant typings from the toplevel package without\ndiving into either the VE or Ivy sources.\n\nFollow up on #40607\n\nPR Close #40621",
    "sha": "950875c1ba867a59a7426158e496d911dd61a1e8",
    "files": [
        {
            "sha": "cae92bc9715827af78d153b22df68f614a019032",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/950875c1ba867a59a7426158e496d911dd61a1e8/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/950875c1ba867a59a7426158e496d911dd61a1e8/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=950875c1ba867a59a7426158e496d911dd61a1e8",
            "patch": "@@ -382,12 +382,6 @@\n     \"packages/forms/src/directives/validators.ts\",\n     \"packages/forms/src/validators.ts\"\n   ],\n-  [\n-    \"packages/language-service/src/completions.ts\",\n-    \"packages/language-service/src/template.ts\",\n-    \"packages/language-service/src/typescript_host.ts\",\n-    \"packages/language-service/src/language_service.ts\"\n-  ],\n   [\n     \"packages/language-service/src/template.ts\",\n     \"packages/language-service/src/typescript_host.ts\""
        },
        {
            "sha": "4a741ba60c29d808cf33308b94ea50fec3f10001",
            "filename": "packages/language-service/BUILD.bazel",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2FBUILD.bazel?ref=950875c1ba867a59a7426158e496d911dd61a1e8",
            "patch": "@@ -2,18 +2,28 @@ load(\"//tools:defaults.bzl\", \"pkg_npm\", \"ts_library\")\n \n package(default_visibility = [\"//visibility:public\"])\n \n+ts_library(\n+    name = \"api\",\n+    srcs = [\n+        \"api.ts\",\n+    ],\n+    deps = [\n+        \"@npm//typescript\",\n+    ],\n+)\n+\n ts_library(\n     name = \"language-service\",\n-    srcs = glob(\n+    srcs = [\"index.ts\"] + glob(\n         [\n-            \"*.ts\",\n             \"src/**/*.ts\",\n         ],\n         exclude = [\n             \"src/ts_utils.ts\",\n         ],\n     ),\n     deps = [\n+        \":api\",\n         \":ts_utils\",\n         \"//packages:types\",\n         \"//packages/compiler\","
        },
        {
            "sha": "b74bc200d2c98738c056ea128594934189d8e19e",
            "filename": "packages/language-service/api.ts",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fapi.ts?ref=950875c1ba867a59a7426158e496d911dd61a1e8",
            "patch": "@@ -0,0 +1,42 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * @module\n+ * @description\n+ * Entry point for all public APIs of the language service package.\n+ */\n+\n+import * as ts from 'typescript';\n+\n+export type GetTcbResponse = {\n+  /**\n+   * The filename of the SourceFile this typecheck block belongs to.\n+   * The filename is entirely opaque and unstable, useful only for debugging\n+   * purposes.\n+   */\n+  fileName: string,\n+  /** The content of the SourceFile this typecheck block belongs to. */\n+  content: string,\n+  /**\n+   * Spans over node(s) in the typecheck block corresponding to the\n+   * TS code generated for template node under the current cursor position.\n+   *\n+   * When the cursor position is over a source for which there is no generated\n+   * code, `selections` is empty.\n+   */\n+  selections: ts.TextSpan[],\n+}|undefined;\n+\n+/**\n+ * `NgLanguageService` describes an instance of an Angular language service,\n+ * whose API surface is a strict superset of TypeScript's language service.\n+ */\n+export interface NgLanguageService extends ts.LanguageService {\n+  getTcb(fileName: string, position: number): GetTcbResponse;\n+}"
        },
        {
            "sha": "0ed58aaa34a2d049c7fa87eeb34b815aced89a2b",
            "filename": "packages/language-service/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Findex.ts?ref=950875c1ba867a59a7426158e496d911dd61a1e8",
            "patch": "@@ -6,4 +6,5 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-export * from './language-service';\n+export * from './api';\n+export {create, getExternalFiles} from './src/ts_plugin';"
        },
        {
            "sha": "e87b920172a012ad76cac43d7f9cf7239da352e0",
            "filename": "packages/language-service/ivy/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2FBUILD.bazel?ref=950875c1ba867a59a7426158e496d911dd61a1e8",
            "patch": "@@ -20,6 +20,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n+        \"//packages/language-service:api\",\n         \"@npm//@types/node\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "a69135b3f24ce9bea557f168e4a28ed3e4aa890c",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 19,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=950875c1ba867a59a7426158e496d911dd61a1e8",
            "patch": "@@ -15,6 +15,7 @@ import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck'\n import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import {findFirstMatchingNode} from '@angular/compiler-cli/src/ngtsc/typecheck/src/comments';\n import * as ts from 'typescript/lib/tsserverlibrary';\n+import {GetTcbResponse} from '../api';\n \n import {LanguageServiceAdapter, LSParseConfigHost} from './adapters';\n import {CompilerFactory} from './compiler_factory';\n@@ -25,25 +26,6 @@ import {ReferencesAndRenameBuilder} from './references';\n import {getTargetAtPosition, TargetContext, TargetNodeKind} from './template_target';\n import {getTemplateInfoAtPosition, isTypeScriptFile} from './utils';\n \n-export type GetTcbResponse = {\n-  /**\n-   * The filename of the SourceFile this typecheck block belongs to.\n-   * The filename is entirely opaque and unstable, useful only for debugging\n-   * purposes.\n-   */\n-  fileName: string,\n-  /** The content of the SourceFile this typecheck block belongs to. */\n-  content: string,\n-  /**\n-   * Spans over node(s) in the typecheck block corresponding to the\n-   * TS code generated for template node under the current cursor position.\n-   *\n-   * When the cursor position is over a source for which there is no generated\n-   * code, `selections` is empty.\n-   */\n-  selections: ts.TextSpan[],\n-}|undefined;\n-\n export class LanguageService {\n   private options: CompilerOptions;\n   readonly compilerFactory: CompilerFactory;"
        },
        {
            "sha": "a4c9b08e5e3ebbe651ce555464a023aa7620a223",
            "filename": "packages/language-service/ivy/ts_plugin.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts?ref=950875c1ba867a59a7426158e496d911dd61a1e8",
            "patch": "@@ -7,11 +7,8 @@\n  */\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n-import {GetTcbResponse, LanguageService} from './language_service';\n-\n-export interface NgLanguageService extends ts.LanguageService {\n-  getTcb(fileName: string, position: number): GetTcbResponse;\n-}\n+import {GetTcbResponse, NgLanguageService} from '../api';\n+import {LanguageService} from './language_service';\n \n export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n   const {project, languageService: tsLS, config} = info;"
        },
        {
            "sha": "4b37605cf522b6167b326da33241100d4c3e7c02",
            "filename": "packages/language-service/language-service.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/6ad057d28cf432ff0c67d3fcf9fc9a51aa5c43a5/packages%2Flanguage-service%2Flanguage-service.ts",
            "raw_url": "https://github.com/angular/angular/raw/6ad057d28cf432ff0c67d3fcf9fc9a51aa5c43a5/packages%2Flanguage-service%2Flanguage-service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Flanguage-service.ts?ref=6ad057d28cf432ff0c67d3fcf9fc9a51aa5c43a5",
            "patch": "@@ -1,19 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-/// <reference types=\"node\" />\n-\n-/**\n- * @module\n- * @description\n- * Entry point for all public APIs of the language service package.\n- */\n-export {createLanguageService} from './src/language_service';\n-export * from './src/ts_plugin';\n-export {Declaration, Definition, Diagnostic, LanguageService, LanguageServiceHost, Span, TemplateSource} from './src/types';\n-export {TypeScriptServiceHost, createLanguageServiceFromTypescript} from './src/typescript_host';"
        },
        {
            "sha": "b26f4994715d7e4b15b59871061ba05413f1d9f4",
            "filename": "packages/language-service/src/language_service.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fsrc%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fsrc%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Flanguage_service.ts?ref=950875c1ba867a59a7426158e496d911dd61a1e8",
            "patch": "@@ -6,7 +6,6 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import * as path from 'path';\n import * as tss from 'typescript/lib/tsserverlibrary';\n \n import {getTemplateCompletions} from './completions';"
        },
        {
            "sha": "fea31a3e2822c340aefa0a5782238f1ddafcdae0",
            "filename": "packages/language-service/src/ts_plugin.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts?ref=950875c1ba867a59a7426158e496d911dd61a1e8",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import * as tss from 'typescript/lib/tsserverlibrary';\n+import {NgLanguageService} from '../api';\n \n import {createLanguageService} from './language_service';\n import {TypeScriptServiceHost} from './typescript_host';\n@@ -41,7 +42,7 @@ export function getExternalFiles(project: tss.server.Project): string[] {\n   });\n }\n \n-export function create(info: tss.server.PluginCreateInfo): tss.LanguageService {\n+export function create(info: tss.server.PluginCreateInfo): NgLanguageService {\n   const {languageService: tsLS, languageServiceHost: tsLSHost, config, project} = info;\n   // This plugin could operate under two different modes:\n   // 1. TS + Angular\n@@ -135,6 +136,11 @@ export function create(info: tss.server.PluginCreateInfo): tss.LanguageService {\n     return undefined;\n   }\n \n+  function getTcb(fileName: string, position: number) {\n+    // Not implemented in VE Language Service\n+    return undefined;\n+  }\n+\n   return {\n     // First clone the original TS language service\n     ...tsLS,\n@@ -147,5 +153,6 @@ export function create(info: tss.server.PluginCreateInfo): tss.LanguageService {\n     getTypeDefinitionAtPosition,\n     getReferencesAtPosition,\n     findRenameLocations,\n+    getTcb,\n   };\n }"
        },
        {
            "sha": "f3d24ca88a972bebda8b72249c09c7fb9b2ec1ca",
            "filename": "packages/language-service/src/typescript_host.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 12,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/950875c1ba867a59a7426158e496d911dd61a1e8/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts?ref=950875c1ba867a59a7426158e496d911dd61a1e8",
            "patch": "@@ -11,21 +11,10 @@ import {SchemaMetadata, ViewEncapsulation, ÉµConsole as Console} from '@angular/\n import * as path from 'path';\n import * as tss from 'typescript/lib/tsserverlibrary';\n \n-import {createLanguageService} from './language_service';\n import {ReflectorHost} from './reflector_host';\n import {ExternalTemplate, InlineTemplate} from './template';\n import {findTightestNode, getClassDeclFromDecoratorProp, getDirectiveClassLike, getPropertyAssignmentFromValue} from './ts_utils';\n-import {AstResult, Declaration, DeclarationError, DiagnosticMessageChain, LanguageService, LanguageServiceHost, Span, TemplateSource} from './types';\n-\n-/**\n- * Create a `LanguageServiceHost`\n- */\n-export function createLanguageServiceFromTypescript(\n-    host: tss.LanguageServiceHost, service: tss.LanguageService): LanguageService {\n-  const ngHost = new TypeScriptServiceHost(host, service);\n-  const ngServer = createLanguageService(ngHost);\n-  return ngServer;\n-}\n+import {AstResult, Declaration, DeclarationError, DiagnosticMessageChain, LanguageServiceHost, Span, TemplateSource} from './types';\n \n /**\n  * The language service never needs the normalized versions of the metadata. To avoid parsing"
        }
    ],
    "stats": {
        "total": 135,
        "additions": 69,
        "deletions": 66
    }
}