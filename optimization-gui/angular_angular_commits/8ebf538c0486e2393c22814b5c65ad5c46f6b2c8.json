{
    "author": "petebacondarwin",
    "message": "refactor(compiler-cli): add file to Babel locations (#40237)\n\nThe filename of the source-span is now added to the Babel location\nwhen setting the source-map range in the `BabelAstHost`.\n\nNote that the filename is only added if it is different to the main file\nbeing processed. Otherwise Babel will generate two entries in its\ngenerated source-map.\n\nPR Close #40237",
    "sha": "8ebf538c0486e2393c22814b5c65ad5c46f6b2c8",
    "files": [
        {
            "sha": "70f4b408af0ffb467db05db24f767d8193915275",
            "filename": "packages/compiler-cli/linker/babel/src/ast/babel_ast_factory.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/8ebf538c0486e2393c22814b5c65ad5c46f6b2c8/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fast%2Fbabel_ast_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/8ebf538c0486e2393c22814b5c65ad5c46f6b2c8/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fast%2Fbabel_ast_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fast%2Fbabel_ast_factory.ts?ref=8ebf538c0486e2393c22814b5c65ad5c46f6b2c8",
            "patch": "@@ -14,6 +14,10 @@ import {AstFactory, BinaryOperator, LeadingComment, ObjectLiteralProperty, Sourc\n  * A Babel flavored implementation of the AstFactory.\n  */\n export class BabelAstFactory implements AstFactory<t.Statement, t.Expression> {\n+  constructor(\n+      /** The absolute path to the source file being compiled. */\n+      private sourceUrl: string) {}\n+\n   attachComments(statement: t.Statement, leadingComments: LeadingComment[]): void {\n     // We must process the comments in reverse because `t.addComment()` will add new ones in front.\n     for (let i = leadingComments.length - 1; i >= 0; i--) {\n@@ -138,9 +142,11 @@ export class BabelAstFactory implements AstFactory<t.Statement, t.Expression> {\n     if (sourceMapRange === null) {\n       return node;\n     }\n-    // Note that the linker only works on a single file at a time, so there is no need to track the\n-    // filename. Babel will just use the current filename in the source-map.\n     node.loc = {\n+      // Add in the filename so that we can map to external template files.\n+      // Note that Babel gets confused if you specify a filename when it is the original source\n+      // file. This happens when the template is inline, in which case just use `undefined`.\n+      filename: sourceMapRange.url !== this.sourceUrl ? sourceMapRange.url : undefined,\n       start: {\n         line: sourceMapRange.start.line + 1,  // lines are 1-based in Babel.\n         column: sourceMapRange.start.column,\n@@ -149,7 +155,7 @@ export class BabelAstFactory implements AstFactory<t.Statement, t.Expression> {\n         line: sourceMapRange.end.line + 1,  // lines are 1-based in Babel.\n         column: sourceMapRange.end.column,\n       },\n-    };\n+    } as any;  // Needed because the Babel typings for `loc` don't include `filename`.\n     node.start = sourceMapRange.start.offset;\n     node.end = sourceMapRange.end.offset;\n "
        },
        {
            "sha": "950eafc40c1f5ac132be1c1332adccc9611a9393",
            "filename": "packages/compiler-cli/linker/babel/test/ast/babel_ast_factory_spec.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 3,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/8ebf538c0486e2393c22814b5c65ad5c46f6b2c8/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fast%2Fbabel_ast_factory_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8ebf538c0486e2393c22814b5c65ad5c46f6b2c8/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fast%2Fbabel_ast_factory_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fast%2Fbabel_ast_factory_spec.ts?ref=8ebf538c0486e2393c22814b5c65ad5c46f6b2c8",
            "patch": "@@ -14,7 +14,7 @@ import {BabelAstFactory} from '../../src/ast/babel_ast_factory';\n \n describe('BabelAstFactory', () => {\n   let factory: BabelAstFactory;\n-  beforeEach(() => factory = new BabelAstFactory());\n+  beforeEach(() => factory = new BabelAstFactory('/original.ts'));\n \n   describe('attachComments()', () => {\n     it('should add the comments to the given statement', () => {\n@@ -367,16 +367,34 @@ describe('BabelAstFactory', () => {\n         start: {line: 0, column: 1, offset: 1},\n         end: {line: 2, column: 3, offset: 15},\n         content: '-****\\n*****\\n****',\n-        url: 'original.ts'\n+        url: 'other.ts'\n       });\n \n       // Lines are 1-based in Babel.\n       expect(expr.loc).toEqual({\n+        filename: 'other.ts',\n         start: {line: 1, column: 1},\n         end: {line: 3, column: 3},\n-      });\n+      } as any);  // The typings for `loc` do not include `filename`.\n       expect(expr.start).toEqual(1);\n       expect(expr.end).toEqual(15);\n     });\n+\n+    it('should use undefined if the url is the same as the one passed to the constructor', () => {\n+      const expr = expression.ast`42`;\n+      factory.setSourceMapRange(expr, {\n+        start: {line: 0, column: 1, offset: 1},\n+        end: {line: 2, column: 3, offset: 15},\n+        content: '-****\\n*****\\n****',\n+        url: '/original.ts'\n+      });\n+\n+      // Lines are 1-based in Babel.\n+      expect(expr.loc).toEqual({\n+        filename: undefined,\n+        start: {line: 1, column: 1},\n+        end: {line: 3, column: 3},\n+      } as any);  // The typings for `loc` do not include `filename`.\n+    });\n   });\n });"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 30,
        "deletions": 6
    }
}