{
    "author": "josephperrott",
    "message": "refactor(dev-infra): add spawnSync to child process utils, normalize naming of child-process utils (#42911)\n\nCreate a `spawnSync` command for common usage, additionally update naming to use `spawn` instead of\n`spawnWithDebugOutput`\n\nPR Close #42911",
    "sha": "d3b0d1e3fb410372a8c69dff1b945f14873511b9",
    "files": [
        {
            "sha": "eb05917793733bc9b15370b93c55ba287ed241c1",
            "filename": "dev-infra/build-worker.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Fbuild-worker.js",
            "raw_url": "https://github.com/angular/angular/raw/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Fbuild-worker.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbuild-worker.js?ref=d3b0d1e3fb410372a8c69dff1b945f14873511b9",
            "patch": "@@ -145,6 +145,7 @@ var GitCommandError = /** @class */ (function (_super) {\n         // we sanitize the command that will be part of the error message.\n         _super.call(this, \"Command failed: git \" + client.sanitizeConsoleOutput(args.join(' '))) || this;\n         _this.args = args;\n+        Object.setPrototypeOf(_this, GitCommandError.prototype);\n         return _this;\n     }\n     return GitCommandError;"
        },
        {
            "sha": "ee84e306584e1d029d340d4e9b0885ab1c54a685",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 46,
            "deletions": 30,
            "changes": 76,
            "blob_url": "https://github.com/angular/angular/blob/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=d3b0d1e3fb410372a8c69dff1b945f14873511b9",
            "patch": "@@ -317,6 +317,7 @@ var GitCommandError = /** @class */ (function (_super) {\n         // we sanitize the command that will be part of the error message.\n         _super.call(this, \"Command failed: git \" + client.sanitizeConsoleOutput(args.join(' '))) || this;\n         _this.args = args;\n+        Object.setPrototypeOf(_this, GitCommandError.prototype);\n         return _this;\n     }\n     return GitCommandError;\n@@ -3463,30 +3464,40 @@ function discoverNewConflictsForPr(newPrNumber, updatedAfter) {\n         info(`Retrieved ${allPendingPRs.length} total pending PRs`);\n         info(`Checking ${pendingPrs.length} PRs for conflicts after a merge of #${newPrNumber}`);\n         // Fetch and checkout the PR being checked.\n-        exec(`git fetch ${requestedPr.headRef.repository.url} ${requestedPr.headRef.name}`);\n-        exec(`git checkout -B ${tempWorkingBranch} FETCH_HEAD`);\n+        git.run(['fetch', '-q', requestedPr.headRef.repository.url, requestedPr.headRef.name]);\n+        git.run(['checkout', '-q', '-B', tempWorkingBranch, 'FETCH_HEAD']);\n         // Rebase the PR against the PRs target branch.\n-        exec(`git fetch ${requestedPr.baseRef.repository.url} ${requestedPr.baseRef.name}`);\n-        const result = exec(`git rebase FETCH_HEAD`);\n-        if (result.code) {\n-            error('The requested PR currently has conflicts');\n-            cleanUpGitState(previousBranchOrRevision);\n-            process.exit(1);\n+        git.run(['fetch', '-q', requestedPr.baseRef.repository.url, requestedPr.baseRef.name]);\n+        try {\n+            git.run(['rebase', 'FETCH_HEAD'], { stdio: 'ignore' });\n+        }\n+        catch (err) {\n+            if (err instanceof GitCommandError) {\n+                error('The requested PR currently has conflicts');\n+                git.checkout(previousBranchOrRevision, true);\n+                process.exit(1);\n+            }\n+            throw err;\n         }\n         // Start the progress bar\n         progressBar.start(pendingPrs.length, 0);\n         // Check each PR to determine if it can merge cleanly into the repo after the target PR.\n         for (const pr of pendingPrs) {\n             // Fetch and checkout the next PR\n-            exec(`git fetch ${pr.headRef.repository.url} ${pr.headRef.name}`);\n-            exec(`git checkout --detach FETCH_HEAD`);\n+            git.run(['fetch', '-q', pr.headRef.repository.url, pr.headRef.name]);\n+            git.run(['checkout', '-q', '--detach', 'FETCH_HEAD']);\n             // Check if the PR cleanly rebases into the repo after the target PR.\n-            const result = exec(`git rebase ${tempWorkingBranch}`);\n-            if (result.code !== 0) {\n-                conflicts.push(pr);\n+            try {\n+                git.run(['rebase', tempWorkingBranch], { stdio: 'ignore' });\n+            }\n+            catch (err) {\n+                if (err instanceof GitCommandError) {\n+                    conflicts.push(pr);\n+                }\n+                throw err;\n             }\n             // Abort any outstanding rebase attempt.\n-            exec(`git rebase --abort`);\n+            git.runGraceful(['rebase', '--abort'], { stdio: 'ignore' });\n             progressBar.increment(1);\n         }\n         // End the progress bar as all PRs have been processed.\n@@ -5978,7 +5989,7 @@ const ReleaseNotesCommandModule = {\n  *\n  * @returns a Promise resolving on success, and rejecting on command failure with the status code.\n  */\n-function spawnInteractiveCommand(command, args, options) {\n+function spawnInteractive(command, args, options) {\n     if (options === void 0) { options = {}; }\n     return new Promise(function (resolve, reject) {\n         var commandText = command + \" \" + args.join(' ');\n@@ -5993,9 +6004,9 @@ function spawnInteractiveCommand(command, args, options) {\n  * output mode, stdout/stderr output is also printed to the console, or only on error.\n  *\n  * @returns a Promise resolving with captured stdout and stderr on success. The promise\n- *   rejects on command failure.\n+ *   rejects on command failure\n  */\n-function spawnWithDebugOutput(command, args, options) {\n+function spawn(command, args, options) {\n     if (options === void 0) { options = {}; }\n     return new Promise(function (resolve, reject) {\n         var commandText = command + \" \" + args.join(' ');\n@@ -6025,22 +6036,27 @@ function spawnWithDebugOutput(command, args, options) {\n                 process.stderr.write(message);\n             }\n         });\n-        childProcess.on('exit', function (status, signal) {\n-            var exitDescription = status !== null ? \"exit code \\\"\" + status + \"\\\"\" : \"signal \\\"\" + signal + \"\\\"\";\n+        childProcess.on('exit', function (exitCode, signal) {\n+            var exitDescription = exitCode !== null ? \"exit code \\\"\" + exitCode + \"\\\"\" : \"signal \\\"\" + signal + \"\\\"\";\n             var printFn = outputMode === 'on-error' ? error : debug;\n+            var status = statusFromExitCodeAndSignal(exitCode, signal);\n             printFn(\"Command \\\"\" + commandText + \"\\\" completed with \" + exitDescription + \".\");\n             printFn(\"Process output: \\n\" + logOutput);\n             // On success, resolve the promise. Otherwise reject with the captured stderr\n             // and stdout log output if the output mode was set to `silent`.\n-            if (status === 0) {\n-                resolve({ stdout: stdout, stderr: stderr });\n+            if (status === 0 || options.suppressErrorOnFailingExitCode) {\n+                resolve({ stdout: stdout, stderr: stderr, status: status });\n             }\n             else {\n                 reject(outputMode === 'silent' ? logOutput : undefined);\n             }\n         });\n     });\n }\n+/** Convert the provided exitCode and signal to a single status code. */\n+function statusFromExitCodeAndSignal(exitCode, signal) {\n+    return exitCode !== null ? exitCode : signal !== null ? signal : -1;\n+}\n \n /**\n  * @license\n@@ -6060,7 +6076,7 @@ function runNpmPublish(packagePath, distTag, registryUrl) {\n         if (registryUrl !== undefined) {\n             args.push('--registry', registryUrl);\n         }\n-        yield spawnWithDebugOutput('npm', args, { cwd: packagePath, mode: 'silent' });\n+        yield spawn('npm', args, { cwd: packagePath, mode: 'silent' });\n     });\n }\n /**\n@@ -6074,7 +6090,7 @@ function setNpmTagForPackage(packageName, distTag, version, registryUrl) {\n         if (registryUrl !== undefined) {\n             args.push('--registry', registryUrl);\n         }\n-        yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n+        yield spawn('npm', args, { mode: 'silent' });\n     });\n }\n /**\n@@ -6089,7 +6105,7 @@ function npmIsLoggedIn(registryUrl) {\n             args.push('--registry', registryUrl);\n         }\n         try {\n-            yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n+            yield spawn('npm', args, { mode: 'silent' });\n         }\n         catch (e) {\n             return false;\n@@ -6112,7 +6128,7 @@ function npmLogin(registryUrl) {\n         }\n         // The login command prompts for username, password and other profile information. Hence\n         // the process needs to be interactive (i.e. respecting current TTYs stdin).\n-        yield spawnInteractiveCommand('npm', args);\n+        yield spawnInteractive('npm', args);\n     });\n }\n /**\n@@ -6129,7 +6145,7 @@ function npmLogout(registryUrl) {\n             args.splice(1, 0, '--registry', registryUrl);\n         }\n         try {\n-            yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n+            yield spawn('npm', args, { mode: 'silent' });\n         }\n         finally {\n             return npmIsLoggedIn(registryUrl);\n@@ -6251,7 +6267,7 @@ function invokeSetNpmDistCommand(npmDistTag, version) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n         try {\n             // Note: No progress indicator needed as that is the responsibility of the command.\n-            yield spawnWithDebugOutput('yarn', ['--silent', 'ng-dev', 'release', 'set-dist-tag', npmDistTag, version.format()]);\n+            yield spawn('yarn', ['--silent', 'ng-dev', 'release', 'set-dist-tag', npmDistTag, version.format()]);\n             info(green(`  ✓   Set \"${npmDistTag}\" NPM dist tag for all packages to v${version}.`));\n         }\n         catch (e) {\n@@ -6271,7 +6287,7 @@ function invokeReleaseBuildCommand() {\n         try {\n             // Since we expect JSON to be printed from the `ng-dev release build` command,\n             // we spawn the process in silent mode. We have set up an Ora progress spinner.\n-            const { stdout } = yield spawnWithDebugOutput('yarn', ['--silent', 'ng-dev', 'release', 'build', '--json'], { mode: 'silent' });\n+            const { stdout } = yield spawn('yarn', ['--silent', 'ng-dev', 'release', 'build', '--json'], { mode: 'silent' });\n             spinner.stop();\n             info(green('  ✓   Built release output for all packages.'));\n             // The `ng-dev release build` command prints a JSON array to stdout\n@@ -6295,7 +6311,7 @@ function invokeYarnInstallCommand(projectDir) {\n         try {\n             // Note: No progress indicator needed as that is the responsibility of the command.\n             // TODO: Consider using an Ora spinner instead to ensure minimal console output.\n-            yield spawnWithDebugOutput('yarn', ['install', '--frozen-lockfile', '--non-interactive'], { cwd: projectDir });\n+            yield spawn('yarn', ['install', '--frozen-lockfile', '--non-interactive'], { cwd: projectDir });\n             info(green('  ✓   Installed project dependencies.'));\n         }\n         catch (e) {\n@@ -7450,7 +7466,7 @@ class ReleaseTool {\n             try {\n                 // Note: We do not rely on `/usr/bin/env` but rather access the `env` binary directly as it\n                 // should be part of the shell's `$PATH`. This is necessary for compatibility with Windows.\n-                const pyVersion = yield spawnWithDebugOutput('env', ['python', '--version'], { mode: 'silent' });\n+                const pyVersion = yield spawn('env', ['python', '--version'], { mode: 'silent' });\n                 const version = pyVersion.stdout.trim() || pyVersion.stderr.trim();\n                 if (version.startsWith('Python 3.')) {\n                     debug(`Local python version: ${version}`);"
        },
        {
            "sha": "32138da31076040ce40def7006671b70662d01c7",
            "filename": "dev-infra/pr/discover-new-conflicts/index.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 15,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts?ref=d3b0d1e3fb410372a8c69dff1b945f14873511b9",
            "patch": "@@ -11,7 +11,7 @@ import {types as graphqlTypes} from 'typed-graphqlify';\n \n import {error, info} from '../../utils/console';\n import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n-import {GitClient} from '../../utils/git/git-client';\n+import {GitCommandError} from '../../utils/git/git-client';\n import {getPendingPrs} from '../../utils/github';\n import {exec} from '../../utils/shelljs';\n \n@@ -95,16 +95,20 @@ export async function discoverNewConflictsForPr(newPrNumber: number, updatedAfte\n   info(`Checking ${pendingPrs.length} PRs for conflicts after a merge of #${newPrNumber}`);\n \n   // Fetch and checkout the PR being checked.\n-  exec(`git fetch ${requestedPr.headRef.repository.url} ${requestedPr.headRef.name}`);\n-  exec(`git checkout -B ${tempWorkingBranch} FETCH_HEAD`);\n+  git.run(['fetch', '-q', requestedPr.headRef.repository.url, requestedPr.headRef.name]);\n+  git.run(['checkout', '-q', '-B', tempWorkingBranch, 'FETCH_HEAD']);\n \n   // Rebase the PR against the PRs target branch.\n-  exec(`git fetch ${requestedPr.baseRef.repository.url} ${requestedPr.baseRef.name}`);\n-  const result = exec(`git rebase FETCH_HEAD`);\n-  if (result.code) {\n-    error('The requested PR currently has conflicts');\n-    cleanUpGitState(previousBranchOrRevision);\n-    process.exit(1);\n+  git.run(['fetch', '-q', requestedPr.baseRef.repository.url, requestedPr.baseRef.name]);\n+  try {\n+    git.run(['rebase', 'FETCH_HEAD'], {stdio: 'ignore'});\n+  } catch (err) {\n+    if (err instanceof GitCommandError) {\n+      error('The requested PR currently has conflicts');\n+      git.checkout(previousBranchOrRevision, true);\n+      process.exit(1);\n+    }\n+    throw err;\n   }\n \n   // Start the progress bar\n@@ -113,15 +117,19 @@ export async function discoverNewConflictsForPr(newPrNumber: number, updatedAfte\n   // Check each PR to determine if it can merge cleanly into the repo after the target PR.\n   for (const pr of pendingPrs) {\n     // Fetch and checkout the next PR\n-    exec(`git fetch ${pr.headRef.repository.url} ${pr.headRef.name}`);\n-    exec(`git checkout --detach FETCH_HEAD`);\n+    git.run(['fetch', '-q', pr.headRef.repository.url, pr.headRef.name]);\n+    git.run(['checkout', '-q', '--detach', 'FETCH_HEAD']);\n     // Check if the PR cleanly rebases into the repo after the target PR.\n-    const result = exec(`git rebase ${tempWorkingBranch}`);\n-    if (result.code !== 0) {\n-      conflicts.push(pr);\n+    try {\n+      git.run(['rebase', tempWorkingBranch], {stdio: 'ignore'});\n+    } catch (err) {\n+      if (err instanceof GitCommandError) {\n+        conflicts.push(pr);\n+      }\n+      throw err;\n     }\n     // Abort any outstanding rebase attempt.\n-    exec(`git rebase --abort`);\n+    git.runGraceful(['rebase', '--abort'], {stdio: 'ignore'});\n \n     progressBar.increment(1);\n   }"
        },
        {
            "sha": "f0b9edf3665035febb3753068f831c90ded4e317",
            "filename": "dev-infra/release/publish/external-commands.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts",
            "raw_url": "https://github.com/angular/angular/raw/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts?ref=d3b0d1e3fb410372a8c69dff1b945f14873511b9",
            "patch": "@@ -9,7 +9,7 @@\n import * as ora from 'ora';\n import * as semver from 'semver';\n \n-import {spawnWithDebugOutput} from '../../utils/child-process';\n+import {spawn} from '../../utils/child-process';\n import {error, green, info, red} from '../../utils/console';\n import {BuiltPackage} from '../config/index';\n import {NpmDistTag} from '../versioning';\n@@ -40,7 +40,7 @@ import {FatalReleaseActionError} from './actions-error';\n export async function invokeSetNpmDistCommand(npmDistTag: NpmDistTag, version: semver.SemVer) {\n   try {\n     // Note: No progress indicator needed as that is the responsibility of the command.\n-    await spawnWithDebugOutput(\n+    await spawn(\n         'yarn', ['--silent', 'ng-dev', 'release', 'set-dist-tag', npmDistTag, version.format()]);\n     info(green(`  ✓   Set \"${npmDistTag}\" NPM dist tag for all packages to v${version}.`));\n   } catch (e) {\n@@ -59,8 +59,8 @@ export async function invokeReleaseBuildCommand(): Promise<BuiltPackage[]> {\n   try {\n     // Since we expect JSON to be printed from the `ng-dev release build` command,\n     // we spawn the process in silent mode. We have set up an Ora progress spinner.\n-    const {stdout} = await spawnWithDebugOutput(\n-        'yarn', ['--silent', 'ng-dev', 'release', 'build', '--json'], {mode: 'silent'});\n+    const {stdout} =\n+        await spawn('yarn', ['--silent', 'ng-dev', 'release', 'build', '--json'], {mode: 'silent'});\n     spinner.stop();\n     info(green('  ✓   Built release output for all packages.'));\n     // The `ng-dev release build` command prints a JSON array to stdout\n@@ -82,8 +82,7 @@ export async function invokeYarnInstallCommand(projectDir: string): Promise<void\n   try {\n     // Note: No progress indicator needed as that is the responsibility of the command.\n     // TODO: Consider using an Ora spinner instead to ensure minimal console output.\n-    await spawnWithDebugOutput(\n-        'yarn', ['install', '--frozen-lockfile', '--non-interactive'], {cwd: projectDir});\n+    await spawn('yarn', ['install', '--frozen-lockfile', '--non-interactive'], {cwd: projectDir});\n     info(green('  ✓   Installed project dependencies.'));\n   } catch (e) {\n     error(e);"
        },
        {
            "sha": "830bd38f357a69a00c572816ff824b566c172ff0",
            "filename": "dev-infra/release/publish/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Findex.ts?ref=d3b0d1e3fb410372a8c69dff1b945f14873511b9",
            "patch": "@@ -8,7 +8,7 @@\n \n import {ListChoiceOptions, prompt} from 'inquirer';\n \n-import {spawnWithDebugOutput} from '../../utils/child-process';\n+import {spawn} from '../../utils/child-process';\n import {GithubConfig} from '../../utils/config';\n import {debug, error, info, log, promptConfirm, red, yellow} from '../../utils/console';\n import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n@@ -138,8 +138,7 @@ export class ReleaseTool {\n     try {\n       // Note: We do not rely on `/usr/bin/env` but rather access the `env` binary directly as it\n       // should be part of the shell's `$PATH`. This is necessary for compatibility with Windows.\n-      const pyVersion =\n-          await spawnWithDebugOutput('env', ['python', '--version'], {mode: 'silent'});\n+      const pyVersion = await spawn('env', ['python', '--version'], {mode: 'silent'});\n       const version = pyVersion.stdout.trim() || pyVersion.stderr.trim();\n       if (version.startsWith('Python 3.')) {\n         debug(`Local python version: ${version}`);"
        },
        {
            "sha": "248bef824d32b9fc057bff7a86710f5005416235",
            "filename": "dev-infra/release/versioning/npm-publish.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts",
            "raw_url": "https://github.com/angular/angular/raw/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts?ref=d3b0d1e3fb410372a8c69dff1b945f14873511b9",
            "patch": "@@ -7,7 +7,9 @@\n  */\n \n import * as semver from 'semver';\n-import {spawnInteractiveCommand, spawnWithDebugOutput} from '../../utils/child-process';\n+\n+import {spawn, spawnInteractive} from '../../utils/child-process';\n+\n import {NpmDistTag} from './npm-registry';\n \n /**\n@@ -21,7 +23,7 @@ export async function runNpmPublish(\n   if (registryUrl !== undefined) {\n     args.push('--registry', registryUrl);\n   }\n-  await spawnWithDebugOutput('npm', args, {cwd: packagePath, mode: 'silent'});\n+  await spawn('npm', args, {cwd: packagePath, mode: 'silent'});\n }\n \n /**\n@@ -35,7 +37,7 @@ export async function setNpmTagForPackage(\n   if (registryUrl !== undefined) {\n     args.push('--registry', registryUrl);\n   }\n-  await spawnWithDebugOutput('npm', args, {mode: 'silent'});\n+  await spawn('npm', args, {mode: 'silent'});\n }\n \n /**\n@@ -49,7 +51,7 @@ export async function npmIsLoggedIn(registryUrl: string|undefined): Promise<bool\n     args.push('--registry', registryUrl);\n   }\n   try {\n-    await spawnWithDebugOutput('npm', args, {mode: 'silent'});\n+    await spawn('npm', args, {mode: 'silent'});\n   } catch (e) {\n     return false;\n   }\n@@ -70,7 +72,7 @@ export async function npmLogin(registryUrl: string|undefined) {\n   }\n   // The login command prompts for username, password and other profile information. Hence\n   // the process needs to be interactive (i.e. respecting current TTYs stdin).\n-  await spawnInteractiveCommand('npm', args);\n+  await spawnInteractive('npm', args);\n }\n \n /**\n@@ -86,7 +88,7 @@ export async function npmLogout(registryUrl: string|undefined): Promise<boolean>\n     args.splice(1, 0, '--registry', registryUrl);\n   }\n   try {\n-    await spawnWithDebugOutput('npm', args, {mode: 'silent'});\n+    await spawn('npm', args, {mode: 'silent'});\n   } finally {\n     return npmIsLoggedIn(registryUrl);\n   }"
        },
        {
            "sha": "64fcdcb6345b919759c211a861fa44e95c0ee3dc",
            "filename": "dev-infra/utils/child-process.ts",
            "status": "modified",
            "additions": 58,
            "deletions": 15,
            "changes": 73,
            "blob_url": "https://github.com/angular/angular/blob/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Futils%2Fchild-process.ts",
            "raw_url": "https://github.com/angular/angular/raw/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Futils%2Fchild-process.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fchild-process.ts?ref=d3b0d1e3fb410372a8c69dff1b945f14873511b9",
            "patch": "@@ -6,21 +6,34 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {spawn, SpawnOptions} from 'child_process';\n+import {spawn as _spawn, SpawnOptions as _SpawnOptions, spawnSync as _spawnSync, SpawnSyncOptions as _SpawnSyncOptions} from 'child_process';\n import {debug, error} from './console';\n \n+\n+export interface SpawnSyncOptions extends Omit<_SpawnSyncOptions, 'shell'|'stdio'> {\n+  /** Whether to prevent exit codes being treated as failures. */\n+  suppressErrorOnFailingExitCode?: boolean;\n+}\n+\n /** Interface describing the options for spawning a process. */\n-export interface SpawnedProcessOptions extends Omit<SpawnOptions, 'stdio'> {\n+export interface SpawnOptions extends Omit<_SpawnOptions, 'shell'|'stdio'> {\n   /** Console output mode. Defaults to \"enabled\". */\n   mode?: 'enabled'|'silent'|'on-error';\n+  /** Whether to prevent exit codes being treated as failures. */\n+  suppressErrorOnFailingExitCode?: boolean;\n }\n \n+/** Interface describing the options for spawning an interactive process. */\n+export type SpawnInteractiveCommandOptions = Omit<_SpawnOptions, 'shell'|'stdio'>;\n+\n /** Interface describing the result of a spawned process. */\n-export interface SpawnedProcessResult {\n+export interface SpawnResult {\n   /** Captured stdout in string format. */\n   stdout: string;\n   /** Captured stderr in string format. */\n   stderr: string;\n+  /** The exit code or signal of the process. */\n+  status: number|NodeJS.Signals;\n }\n \n /**\n@@ -29,12 +42,12 @@ export interface SpawnedProcessResult {\n  *\n  * @returns a Promise resolving on success, and rejecting on command failure with the status code.\n  */\n-export function spawnInteractiveCommand(\n-    command: string, args: string[], options: Omit<SpawnOptions, 'stdio'> = {}) {\n+export function spawnInteractive(\n+    command: string, args: string[], options: SpawnInteractiveCommandOptions = {}) {\n   return new Promise<void>((resolve, reject) => {\n     const commandText = `${command} ${args.join(' ')}`;\n     debug(`Executing command: ${commandText}`);\n-    const childProcess = spawn(command, args, {...options, shell: true, stdio: 'inherit'});\n+    const childProcess = _spawn(command, args, {...options, shell: true, stdio: 'inherit'});\n     childProcess.on('exit', status => status === 0 ? resolve() : reject(status));\n   });\n }\n@@ -45,18 +58,17 @@ export function spawnInteractiveCommand(\n  * output mode, stdout/stderr output is also printed to the console, or only on error.\n  *\n  * @returns a Promise resolving with captured stdout and stderr on success. The promise\n- *   rejects on command failure.\n+ *   rejects on command failure\n  */\n-export function spawnWithDebugOutput(\n-    command: string, args: string[],\n-    options: SpawnedProcessOptions = {}): Promise<SpawnedProcessResult> {\n+export function spawn(\n+    command: string, args: string[], options: SpawnOptions = {}): Promise<SpawnResult> {\n   return new Promise((resolve, reject) => {\n     const commandText = `${command} ${args.join(' ')}`;\n     const outputMode = options.mode;\n \n     debug(`Executing command: ${commandText}`);\n \n-    const childProcess = spawn(command, args, {...options, shell: true, stdio: 'pipe'});\n+    const childProcess = _spawn(command, args, {...options, shell: true, stdio: 'pipe'});\n     let logOutput = '';\n     let stdout = '';\n     let stderr = '';\n@@ -83,20 +95,51 @@ export function spawnWithDebugOutput(\n       }\n     });\n \n-    childProcess.on('exit', (status, signal) => {\n-      const exitDescription = status !== null ? `exit code \"${status}\"` : `signal \"${signal}\"`;\n+    childProcess.on('exit', (exitCode, signal) => {\n+      const exitDescription = exitCode !== null ? `exit code \"${exitCode}\"` : `signal \"${signal}\"`;\n       const printFn = outputMode === 'on-error' ? error : debug;\n+      const status = statusFromExitCodeAndSignal(exitCode, signal);\n \n       printFn(`Command \"${commandText}\" completed with ${exitDescription}.`);\n       printFn(`Process output: \\n${logOutput}`);\n \n       // On success, resolve the promise. Otherwise reject with the captured stderr\n       // and stdout log output if the output mode was set to `silent`.\n-      if (status === 0) {\n-        resolve({stdout, stderr});\n+      if (status === 0 || options.suppressErrorOnFailingExitCode) {\n+        resolve({stdout, stderr, status});\n       } else {\n         reject(outputMode === 'silent' ? logOutput : undefined);\n       }\n     });\n   });\n }\n+\n+/**\n+ * Spawns a given command with the specified arguments inside a shell syncronously.\n+ *\n+ * @returns The command's stdout and stderr.\n+ */\n+export function spawnSync(\n+    command: string, args: string[], options: SpawnOptions = {}): SpawnResult {\n+  const commandText = `${command} ${args.join(' ')}`;\n+  debug(`Executing command: ${commandText}`);\n+\n+  const {status: exitCode, signal, stdout, stderr} =\n+      _spawnSync(command, args, {...options, encoding: 'utf8', shell: true, stdio: 'pipe'});\n+\n+  /** The status of the spawn result. */\n+  const status = statusFromExitCodeAndSignal(exitCode, signal);\n+\n+  if (status === 0 || options.suppressErrorOnFailingExitCode) {\n+    return {status, stdout, stderr};\n+  }\n+\n+  throw new Error(stderr);\n+}\n+\n+\n+\n+/** Convert the provided exitCode and signal to a single status code. */\n+function statusFromExitCodeAndSignal(exitCode: number|null, signal: NodeJS.Signals|null) {\n+  return exitCode !== null ? exitCode : signal !== null ? signal : -1;\n+}"
        },
        {
            "sha": "52e803b9a5b769277b9b80bae08c56b39d02a757",
            "filename": "dev-infra/utils/git/git-client.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Futils%2Fgit%2Fgit-client.ts",
            "raw_url": "https://github.com/angular/angular/raw/d3b0d1e3fb410372a8c69dff1b945f14873511b9/dev-infra%2Futils%2Fgit%2Fgit-client.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgit-client.ts?ref=d3b0d1e3fb410372a8c69dff1b945f14873511b9",
            "patch": "@@ -9,7 +9,6 @@\n import {spawnSync, SpawnSyncOptions, SpawnSyncReturns} from 'child_process';\n import {Options as SemVerOptions, parse, SemVer} from 'semver';\n \n-import {spawnWithDebugOutput} from '../child-process';\n import {getConfig, GithubConfig, NgDevConfig} from '../config';\n import {debug, info} from '../console';\n import {DryRunError, isDryRun} from '../dry-run';\n@@ -24,6 +23,7 @@ export class GitCommandError extends Error {\n     // accidentally leak the Github token that might be used in a command,\n     // we sanitize the command that will be part of the error message.\n     super(`Command failed: git ${client.sanitizeConsoleOutput(args.join(' '))}`);\n+    Object.setPrototypeOf(this, GitCommandError.prototype);\n   }\n }\n "
        }
    ],
    "stats": {
        "total": 220,
        "additions": 144,
        "deletions": 76
    }
}