{
    "author": "gkalpak",
    "message": "fix(docs-infra): correctly serve `index.html` with a query string (#42547)\n\nPreviously, due to a bug in Firebase hosting, requests to\n`/index.html?<query>` would lead to an infinite redirect and eventually\na failure. This affected, for example, cache-busting requests from the\nServiceWorker, which look like: `/index.html?ngsw-cache-bust=...`\nFor more details see\nhttps://github.com/angular/angular/issues/42518#issuecomment-858545483\n\nThis commit temporarily works around the bug by explicitly redirecting\n`/index.html?<query>` to `/?<query>`.\n\nFixes #42518\n\nPR Close #42547",
    "sha": "56a0582d79dbb4a8922951bb881b1887464f4527",
    "files": [
        {
            "sha": "5e3775a2e90c0f9de706e244191ec72ac80f1d91",
            "filename": "aio/firebase.json",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/56a0582d79dbb4a8922951bb881b1887464f4527/aio%2Ffirebase.json",
            "raw_url": "https://github.com/angular/angular/raw/56a0582d79dbb4a8922951bb881b1887464f4527/aio%2Ffirebase.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ffirebase.json?ref=56a0582d79dbb4a8922951bb881b1887464f4527",
            "patch": "@@ -124,6 +124,10 @@\n       {\"type\": 301, \"source\": \"/testing\", \"destination\": \"/guide/testing\"},\n       {\"type\": 301, \"source\": \"/testing/**\", \"destination\": \"/guide/testing\"},\n \n+      // Work around Firebase hosting bug with `/index.html?<query>` leading to infinite redirects.\n+      // See https://github.com/angular/angular/issues/42518#issuecomment-858545483 for details.\n+      {\"type\": 301, \"source\": \"/index.html:query*\", \"destination\": \"/:query*\"},\n+\n       // Strip off the `.html` extension, because Firebase will not do this automatically any more\n       // (unless the new URL points to an existing file, which is not necessarily the case here).\n       {\"type\": 301, \"source\": \"/:somePath*/:file.html\", \"destination\": \"/:somePath*/:file\"},"
        },
        {
            "sha": "de503ed0bf73a3555153a365c519667409aca781",
            "filename": "aio/tests/deployment/shared/URLS_TO_REDIRECT.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/56a0582d79dbb4a8922951bb881b1887464f4527/aio%2Ftests%2Fdeployment%2Fshared%2FURLS_TO_REDIRECT.txt",
            "raw_url": "https://github.com/angular/angular/raw/56a0582d79dbb4a8922951bb881b1887464f4527/aio%2Ftests%2Fdeployment%2Fshared%2FURLS_TO_REDIRECT.txt",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftests%2Fdeployment%2Fshared%2FURLS_TO_REDIRECT.txt?ref=56a0582d79dbb4a8922951bb881b1887464f4527",
            "patch": "@@ -188,6 +188,7 @@\n /guide/updating-to-version-10 --> https://v10.angular.io/guide/updating-to-version-10\n /guide/updating-to-version-11 --> https://v11.angular.io/guide/updating-to-version-11\n /guide/webpack --> https://v5.angular.io/guide/webpack\n+/index.html?foo=bar --> /?foo=bar\n /news --> https://blog.angular.io/\n /news.html --> https://blog.angular.io/\n /start/data --> /start/start-data"
        },
        {
            "sha": "eeb2d6375a55dda73b11604492aebd3fc02b0d69",
            "filename": "aio/tools/firebase-test-utils/FirebaseRedirectSource.spec.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/56a0582d79dbb4a8922951bb881b1887464f4527/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/56a0582d79dbb4a8922951bb881b1887464f4527/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.spec.ts?ref=56a0582d79dbb4a8922951bb881b1887464f4527",
            "patch": "@@ -137,6 +137,21 @@ describe('FirebaseRedirectSource', () => {\n         });\n       });\n \n+      it('should capture a named param not preceded by a slash', () => {\n+        testGlobMatch('/a/b:x', {\n+          named: ['x']\n+        }, {\n+          '/a/bc': {x: 'c'},\n+          '/a/bcd': {x: 'cd'},\n+          '/a/b-c': {x: '-c'},\n+          '/a': undefined,\n+          '/a/': undefined,\n+          '/a/b/': undefined,\n+          '/a/cd': undefined,\n+          '/a/b/c': undefined,\n+        });\n+      });\n+\n       it('should capture multiple named params', () => {\n         testGlobMatch('/a/:b/:c', {\n           named: ['b', 'c']\n@@ -187,6 +202,35 @@ describe('FirebaseRedirectSource', () => {\n         });\n       });\n \n+      it('should capture a rest param not preceded by a slash', () => {\n+        testGlobMatch('/a:bc*', {\n+          rest: ['bc']\n+        }, {\n+          '/ab': {bc: 'b'},\n+          '/a/b': {bc: '/b'},\n+          '/a/bcd': {bc: '/bcd'},\n+          '/a/b/c': {bc: '/b/c'},\n+          '/a//': {bc: '//'},\n+          '/ab/c': {bc: 'b/c'},\n+          '/ab/c/': {bc: 'b/c/'},\n+          '/a': {bc: undefined},\n+          '/bc': undefined,\n+        });\n+\n+        testGlobMatch('/a/b:c*', {\n+          rest: ['c']\n+        }, {\n+          '/a/bc': {c: 'c'},\n+          '/a/bcd': {c: 'cd'},\n+          '/a/b/': {c: '/'},\n+          '/a/b/c/': {c: '/c/'},\n+          '/a/ba/c': {c: 'a/c'},\n+          '/a/ba/c/': {c: 'a/c/'},\n+          '/a/b': {c: undefined},\n+          '/a/': undefined,\n+        });\n+      });\n+\n       it('should capture a rest param mixed with a named param', () => {\n         testGlobMatch('/:abc/:rest*', {\n           named: ['abc'],"
        },
        {
            "sha": "fe579271150394d3efa317ed14b23c69d26c6dec",
            "filename": "aio/tools/firebase-test-utils/FirebaseRedirectSource.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/56a0582d79dbb4a8922951bb881b1887464f4527/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.ts",
            "raw_url": "https://github.com/angular/angular/raw/56a0582d79dbb4a8922951bb881b1887464f4527/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.ts?ref=56a0582d79dbb4a8922951bb881b1887464f4527",
            "patch": "@@ -24,8 +24,8 @@ export class FirebaseRedirectSource {\n     const star = /\\*/g;\n     const doubleStar = /(^|\\/)\\*\\*($|\\/)/g;           // e.g. a/**/b or **/b or a/** but not a**b\n     const modifiedPatterns = /(.)\\(([^)]+)\\)/g;       // e.g. `@(a|b)\n-    const restParam = /\\/:([A-Za-z]+)\\*/g;            // e.g. `:rest*`\n-    const namedParam = /\\/:([A-Za-z]+)/g;             // e.g. `:api`\n+    const restParam = /(\\/?):([A-Za-z]+)\\*/g;            // e.g. `:rest*`\n+    const namedParam = /(\\/?):([A-Za-z]+)/g;             // e.g. `:api`\n     const possiblyEmptyInitialSegments = /^\\.游냥\\//g;  // e.g. `**/a` can also match `a`\n     const possiblyEmptySegments = /\\/\\.游냥\\//g;        // e.g. `a/**/b` can also match `a/b`\n     const willBeStar = /游냥/g;                         // e.g. `a**b` not matched by previous rule\n@@ -35,12 +35,12 @@ export class FirebaseRedirectSource {\n       const pattern = glob\n           .replace(dot, '\\\\.')\n           .replace(modifiedPatterns, replaceModifiedPattern)\n-          .replace(restParam, (_, param) => {\n+          .replace(restParam, (_, leadingSlash, groupName) => {\n             // capture the rest of the string\n-            restNamedGroups.push(param);\n-            return `(?:/(?<${param}>.游냥))?`;\n+            restNamedGroups.push(groupName);\n+            return `(?:${leadingSlash}(?<${groupName}>.游냥))?`;\n           })\n-          .replace(namedParam, `/(?<$1>[^/]+)`)\n+          .replace(namedParam, `$1(?<$2>[^/]+)`)\n           .replace(doubleStar, '$1.游냥$2')                 // use the pig to avoid replacing ** in next rule\n           .replace(star, '[^/]*')                         // match a single segment\n           .replace(possiblyEmptyInitialSegments, '(?:.*)')// deal with **/ special cases"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 55,
        "deletions": 6
    }
}