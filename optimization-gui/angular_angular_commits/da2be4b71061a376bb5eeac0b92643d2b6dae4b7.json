{
    "author": "atscott",
    "message": "refactor(compiler-cli): Return symbols for all matching inputs (#40144)\n\nThis commit ensures that the template type checker returns symbols for\nall inputs if an attribute binds to more than one.\n\nPR Close #40144",
    "sha": "da2be4b71061a376bb5eeac0b92643d2b6dae4b7",
    "files": [
        {
            "sha": "9dc4a15c1e709c1e57f0ef614dfae1bbe3d6fc7b",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/template_symbol_builder.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 19,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/da2be4b71061a376bb5eeac0b92643d2b6dae4b7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "raw_url": "https://github.com/angular/angular/raw/da2be4b71061a376bb5eeac0b92643d2b6dae4b7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts?ref=da2be4b71061a376bb5eeac0b92643d2b6dae4b7",
            "patch": "@@ -13,7 +13,7 @@ import {AbsoluteFsPath} from '../../file_system';\n import {ClassDeclaration} from '../../reflection';\n import {ComponentScopeReader} from '../../scope';\n import {isAssignment} from '../../util/src/typescript';\n-import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ExpressionSymbol, InputBindingSymbol, OutputBindingSymbol, PipeSymbol, ReferenceSymbol, ShimLocation, Symbol, SymbolKind, TemplateSymbol, TsNodeSymbolInfo, TypeCheckableDirectiveMeta, VariableSymbol} from '../api';\n+import {BindingSymbol, DirectiveSymbol, DomBindingSymbol, ElementSymbol, ExpressionSymbol, InputBindingSymbol, OutputBindingSymbol, PipeSymbol, ReferenceSymbol, ShimLocation, Symbol, SymbolKind, TemplateSymbol, TsNodeSymbolInfo, TypeCheckableDirectiveMeta, VariableSymbol} from '../api';\n \n import {ExpressionIdentifier, findAllMatchingNodes, findFirstMatchingNode, hasExpressionIdentifier} from './comments';\n import {TemplateData} from './context';\n@@ -253,31 +253,35 @@ export class SymbolBuilder {\n       return host !== null ? {kind: SymbolKind.DomBinding, host} : null;\n     }\n \n-    const node = findFirstMatchingNode(\n+    const nodes = findAllMatchingNodes(\n         this.typeCheckBlock, {withSpan: binding.sourceSpan, filter: isAssignment});\n-    if (node === null || !isAccessExpression(node.left)) {\n-      return null;\n-    }\n-\n-    const symbolInfo = this.getSymbolOfTsNode(node.left);\n-    if (symbolInfo === null || symbolInfo.tsSymbol === null) {\n-      return null;\n-    }\n+    const bindings: BindingSymbol[] = [];\n+    for (const node of nodes) {\n+      if (!isAccessExpression(node.left)) {\n+        continue;\n+      }\n \n-    const target = this.getDirectiveSymbolForAccessExpression(node.left, consumer);\n-    if (target === null) {\n-      return null;\n-    }\n+      const symbolInfo = this.getSymbolOfTsNode(node.left);\n+      if (symbolInfo === null || symbolInfo.tsSymbol === null) {\n+        continue;\n+      }\n \n-    return {\n-      kind: SymbolKind.Input,\n-      bindings: [{\n+      const target = this.getDirectiveSymbolForAccessExpression(node.left, consumer);\n+      if (target === null) {\n+        continue;\n+      }\n+      bindings.push({\n         ...symbolInfo,\n         tsSymbol: symbolInfo.tsSymbol,\n         kind: SymbolKind.Binding,\n         target,\n-      }],\n-    };\n+      });\n+    }\n+    if (bindings.length === 0) {\n+      return null;\n+    }\n+\n+    return {kind: SymbolKind.Input, bindings};\n   }\n \n   private getDirectiveSymbolForAccessExpression("
        },
        {
            "sha": "850b3494b957b359bf92e3ef03fdf3326124e6e4",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker__get_symbol_of_template_node_spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/da2be4b71061a376bb5eeac0b92643d2b6dae4b7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/da2be4b71061a376bb5eeac0b92643d2b6dae4b7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts?ref=da2be4b71061a376bb5eeac0b92643d2b6dae4b7",
            "patch": "@@ -1136,7 +1136,7 @@ runInEachFileSystem(() => {\n             .toEqual('TestDir');\n       });\n \n-      it('returns the first directive match when two directives have the same input', () => {\n+      it('returns the all inputs when two directives have the same input', () => {\n         const fileName = absoluteFrom('/main.ts');\n         const dirFile = absoluteFrom('/dir.ts');\n         const templateString = `<div dir otherDir [inputA]=\"'my input A'\"></div>`;\n@@ -1178,12 +1178,12 @@ runInEachFileSystem(() => {\n         const inputAbinding = (nodes[0] as TmplAstElement).inputs[0];\n         const symbol = templateTypeChecker.getSymbolOfNode(inputAbinding, cmp)!;\n         assertInputBindingSymbol(symbol);\n-        expect(\n-            (symbol.bindings[0].tsSymbol!.declarations[0] as ts.PropertyDeclaration).name.getText())\n-            .toEqual('inputA');\n-        expect((symbol.bindings[0].tsSymbol!.declarations[0] as ts.PropertyDeclaration)\n-                   .parent.name?.text)\n-            .toEqual('TestDir');\n+        expect(new Set(symbol.bindings.map(\n+                   b => (b.tsSymbol!.declarations[0] as ts.PropertyDeclaration).name.getText())))\n+            .toEqual(new Set(['inputA', 'otherDirInputA']));\n+        expect(new Set(symbol.bindings.map(\n+                   b => (b.tsSymbol!.declarations[0] as ts.PropertyDeclaration).parent.name?.text)))\n+            .toEqual(new Set(['TestDir', 'OtherDir']));\n       });\n     });\n "
        },
        {
            "sha": "9700e161242d3bd2e7b0887a536807daf2e9e05b",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "modified",
            "additions": 66,
            "deletions": 36,
            "changes": 102,
            "blob_url": "https://github.com/angular/angular/blob/da2be4b71061a376bb5eeac0b92643d2b6dae4b7/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/da2be4b71061a376bb5eeac0b92643d2b6dae4b7/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=da2be4b71061a376bb5eeac0b92643d2b6dae4b7",
            "patch": "@@ -6,63 +6,93 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n-import {initMockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {absoluteFrom, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n \n-import {LanguageServiceTestEnvironment} from './env';\n-import {humanizeDefinitionInfo} from './test_utils';\n+import {extractCursorInfo, LanguageServiceTestEnvironment} from './env';\n+import {assertFileNames, createModuleWithDeclarations, humanizeDefinitionInfo} from './test_utils';\n \n describe('definitions', () => {\n-  let env: LanguageServiceTestEnvironment;\n-\n   it('returns the pipe class as definition when checkTypeOfPipes is false', () => {\n     initMockFileSystem('Native');\n-    const testFiles: TestFile[] = [\n-      {\n-        name: absoluteFrom('/app.ts'),\n-        contents: `\n+    const {cursor, text} = extractCursorInfo('{{\"1/1/2020\" | dat¦e}}');\n+    const templateFile = {contents: text, name: absoluteFrom('/app.html')};\n+    const appFile = {\n+      name: absoluteFrom('/app.ts'),\n+      contents: `\n         import {Component, NgModule} from '@angular/core';\n         import {CommonModule} from '@angular/common';\n \n         @Component({templateUrl: 'app.html'})\n         export class AppCmp {}\n-\n-        @NgModule({declarations: [AppCmp], imports: [CommonModule]})\n-        export class AppModule {}\n       `,\n-        isRoot: true\n-      },\n-      {\n-        name: absoluteFrom('/app.html'),\n-        contents: `Will be overridden`,\n-      }\n-    ];\n+    };\n+    const env = createModuleWithDeclarations([appFile], [templateFile]);\n     // checkTypeOfPipes is set to false when strict templates is false\n-    env = LanguageServiceTestEnvironment.setup(testFiles, {strictTemplates: false});\n-    const definitions = getDefinitionsAndAssertBoundSpan(\n-        {templateOverride: '{{\"1/1/2020\" | dat¦e}}', expectedSpanText: 'date'});\n-    expect(definitions!.length).toEqual(1);\n+    const {textSpan, definitions} =\n+        getDefinitionsAndAssertBoundSpan(env, absoluteFrom('/app.html'), cursor);\n+    expect(text.substr(textSpan.start, textSpan.length)).toEqual('date');\n \n+    expect(definitions.length).toEqual(1);\n     const [def] = definitions;\n     expect(def.textSpan).toContain('DatePipe');\n     expect(def.contextSpan).toContain('DatePipe');\n   });\n \n+  it('gets definitions for all inputs when attribute matches more than one', () => {\n+    initMockFileSystem('Native');\n+    const {cursor, text} = extractCursorInfo('<div dir inpu¦tA=\"abc\"></div>');\n+    const templateFile = {contents: text, name: absoluteFrom('/app.html')};\n+    const dirFile = {\n+      name: absoluteFrom('/dir.ts'),\n+      contents: `\n+      import {Directive, Input} from '@angular/core';\n+\n+      @Directive({selector: '[dir]'})\n+      export class MyDir {\n+        @Input() inputA!: any;\n+      }`,\n+    };\n+    const dirFile2 = {\n+      name: absoluteFrom('/dir2.ts'),\n+      contents: `\n+      import {Directive, Input} from '@angular/core';\n+\n+      @Directive({selector: '[dir]'})\n+      export class MyDir2 {\n+        @Input() inputA!: any;\n+      }`,\n+    };\n+    const appFile = {\n+      name: absoluteFrom('/app.ts'),\n+      contents: `\n+        import {Component, NgModule} from '@angular/core';\n+        import {CommonModule} from '@angular/common';\n+\n+        @Component({templateUrl: 'app.html'})\n+        export class AppCmp {}\n+      `\n+    };\n+    const env = createModuleWithDeclarations([appFile, dirFile, dirFile2], [templateFile]);\n+    const {textSpan, definitions} =\n+        getDefinitionsAndAssertBoundSpan(env, absoluteFrom('/app.html'), cursor);\n+    expect(text.substr(textSpan.start, textSpan.length)).toEqual('inputA');\n+\n+    expect(definitions.length).toEqual(2);\n+    const [def, def2] = definitions;\n+    expect(def.textSpan).toContain('inputA');\n+    expect(def2.textSpan).toContain('inputA');\n+    // TODO(atscott): investigate why the text span includes more than just 'inputA'\n+    // assertTextSpans([def, def2], ['inputA']);\n+    assertFileNames([def, def2], ['dir2.ts', 'dir.ts']);\n+  });\n+\n   function getDefinitionsAndAssertBoundSpan(\n-      {templateOverride, expectedSpanText}: {templateOverride: string, expectedSpanText: string}):\n-      Array<{textSpan: string, contextSpan: string | undefined, fileName: string}> {\n-    const {cursor, text} =\n-        env.overrideTemplateWithCursor(absoluteFrom('/app.ts'), 'AppCmp', templateOverride);\n+      env: LanguageServiceTestEnvironment, fileName: AbsoluteFsPath, cursor: number) {\n     env.expectNoSourceDiagnostics();\n-    env.expectNoTemplateDiagnostics(absoluteFrom('/app.ts'), 'AppCmp');\n-    const definitionAndBoundSpan =\n-        env.ngLS.getDefinitionAndBoundSpan(absoluteFrom('/app.html'), cursor);\n+    const definitionAndBoundSpan = env.ngLS.getDefinitionAndBoundSpan(fileName, cursor);\n     const {textSpan, definitions} = definitionAndBoundSpan!;\n-    expect(text.substring(textSpan.start, textSpan.start + textSpan.length))\n-        .toEqual(expectedSpanText);\n     expect(definitions).toBeTruthy();\n-    const overrides = new Map<string, string>();\n-    overrides.set(absoluteFrom('/app.ts'), text);\n-    return definitions!.map(d => humanizeDefinitionInfo(d, env.host, overrides));\n+    return {textSpan, definitions: definitions!.map(d => humanizeDefinitionInfo(d, env.host))};\n   }\n });"
        },
        {
            "sha": "2908260168ca024796e816d1f9d3c075beb5e32e",
            "filename": "packages/language-service/ivy/test/references_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 16,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/da2be4b71061a376bb5eeac0b92643d2b6dae4b7/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/da2be4b71061a376bb5eeac0b92643d2b6dae4b7/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts?ref=da2be4b71061a376bb5eeac0b92643d2b6dae4b7",
            "patch": "@@ -11,7 +11,7 @@ import {initMockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {extractCursorInfo, LanguageServiceTestEnvironment} from './env';\n-import {createModuleWithDeclarations, getText} from './test_utils';\n+import {assertFileNames, assertTextSpans, createModuleWithDeclarations, getText} from './test_utils';\n \n describe('find references', () => {\n   let env: LanguageServiceTestEnvironment;\n@@ -832,21 +832,6 @@ describe('find references', () => {\n   }\n });\n \n-function assertFileNames(refs: Array<{fileName: string}>, expectedFileNames: string[]) {\n-  const actualPaths = refs.map(r => r.fileName);\n-  const actualFileNames = actualPaths.map(p => last(p.split('/')));\n-  expect(new Set(actualFileNames)).toEqual(new Set(expectedFileNames));\n-}\n-\n-function assertTextSpans(refs: Array<{textSpan: string}>, expectedTextSpans: string[]) {\n-  const actualSpans = refs.map(ref => ref.textSpan);\n-  expect(new Set(actualSpans)).toEqual(new Set(expectedTextSpans));\n-}\n-\n-function last<T>(array: T[]): T {\n-  return array[array.length - 1];\n-}\n-\n type Stringy<T> = {\n   [P in keyof T]: string;\n };"
        },
        {
            "sha": "371fbd2bbb3d9837f9c4f00073822c40f617c283",
            "filename": "packages/language-service/ivy/test/test_utils.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/da2be4b71061a376bb5eeac0b92643d2b6dae4b7/packages%2Flanguage-service%2Fivy%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/da2be4b71061a376bb5eeac0b92643d2b6dae4b7/packages%2Flanguage-service%2Fivy%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Ftest_utils.ts?ref=da2be4b71061a376bb5eeac0b92643d2b6dae4b7",
            "patch": "@@ -75,3 +75,14 @@ export function humanizeDefinitionInfo(\n         undefined,\n   };\n }\n+\n+export function assertFileNames(refs: Array<{fileName: string}>, expectedFileNames: string[]) {\n+  const actualPaths = refs.map(r => r.fileName);\n+  const actualFileNames = actualPaths.map(p => last(p.split('/')));\n+  expect(new Set(actualFileNames)).toEqual(new Set(expectedFileNames));\n+}\n+\n+export function assertTextSpans(items: Array<{textSpan: string}>, expectedTextSpans: string[]) {\n+  const actualSpans = items.map(item => item.textSpan);\n+  expect(new Set(actualSpans)).toEqual(new Set(expectedTextSpans));\n+}\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 186,
        "additions": 108,
        "deletions": 78
    }
}