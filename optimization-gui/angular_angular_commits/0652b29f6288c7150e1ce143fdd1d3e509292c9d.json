{
    "author": "JiaLiPassion",
    "message": "fix(zone.js): setTimeout patch should clean tasksByHandleId cache. (#40586)\n\nClose #40387\n\nCurrently zone.js patches `setTimeout` and keeps a `tasksByHandleId` map to keep `timerId` <-> `ZoneTask`\nrelationship. This is needed so that when `clearTimeout(timerId)` is called, zone.js can find the associated\n`ZoneTask`. Now zone.js set the `tasksByHandleId` map in the `scheduleTask` function, but if the `setTimeout`\nis running in the `FakeAsyncZoneSpec` or any other `ZoneSpec` with `onScheduleTask` hooks. The `scheduleTask`\nin `timer` patch may not be invoked.\n\nFor example:\n\n```\nfakeAsync(() => {\n  setTimeout(() => {});\n  tick();\n});\n```\n\nIn this case, the `timerId` kept in the `tasksByHandleId` map is not cleared.\nThis is because the `FakeAsyncZoneSpec` in the `onScheduleTask` hook looks like this.\n\n```\nonScheduleTask(delegate, ..., task) {\n  fakeAsyncScheduler.setTimeout(task);\n  return task;\n}\n```\n\nBecause `FakeAsyncZoneSpec` handles the task itself and it doesn't call `parentDelegate.onScheduleTask`,\ntherefore the default `scheduleTask` in the `timer` patch is not invoked.\n\nIn this commit, the cleanup logic is moved from `scheduleTask` to `setTimeout` patch entry to\navoid the memory leak.\n\nPR Close #40586",
    "sha": "0652b29f6288c7150e1ce143fdd1d3e509292c9d",
    "files": [
        {
            "sha": "2e8a6d7b795c39b9914548d7f82a1c8d3ab1e718",
            "filename": "packages/zone.js/lib/common/timers.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 21,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/0652b29f6288c7150e1ce143fdd1d3e509292c9d/packages%2Fzone.js%2Flib%2Fcommon%2Ftimers.ts",
            "raw_url": "https://github.com/angular/angular/raw/0652b29f6288c7150e1ce143fdd1d3e509292c9d/packages%2Fzone.js%2Flib%2Fcommon%2Ftimers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fcommon%2Ftimers.ts?ref=0652b29f6288c7150e1ce143fdd1d3e509292c9d",
            "patch": "@@ -29,27 +29,9 @@ export function patchTimer(window: any, setName: string, cancelName: string, nam\n \n   function scheduleTask(task: Task) {\n     const data = <TimerOptions>task.data;\n-    function timer(this: unknown) {\n-      try {\n-        task.invoke.apply(this, arguments);\n-      } finally {\n-        // issue-934, task will be cancelled\n-        // even it is a periodic task such as\n-        // setInterval\n-        if (!(task.data && task.data.isPeriodic)) {\n-          if (typeof data.handleId === 'number') {\n-            // in non-nodejs env, we remove timerId\n-            // from local cache\n-            delete tasksByHandleId[data.handleId];\n-          } else if (data.handleId) {\n-            // Node returns complex objects as handleIds\n-            // we remove task reference from timer object\n-            (data.handleId as any)[taskSymbol] = null;\n-          }\n-        }\n-      }\n-    }\n-    data.args[0] = timer;\n+    data.args[0] = function() {\n+      return task.invoke.apply(this, arguments);\n+    };\n     data.handleId = setNative!.apply(window, data.args);\n     return task;\n   }\n@@ -67,6 +49,32 @@ export function patchTimer(window: any, setName: string, cancelName: string, nam\n                                                                              undefined,\n             args: args\n           };\n+          const callback = args[0];\n+          args[0] = function timer(this: unknown) {\n+            try {\n+              return callback.apply(this, arguments);\n+            } finally {\n+              // issue-934, task will be cancelled\n+              // even it is a periodic task such as\n+              // setInterval\n+\n+              // https://github.com/angular/angular/issues/40387\n+              // Cleanup tasksByHandleId should be handled before scheduleTask\n+              // Since some zoneSpec may intercept and doesn't trigger\n+              // scheduleFn(scheduleTask) provided here.\n+              if (!(options.isPeriodic)) {\n+                if (typeof options.handleId === 'number') {\n+                  // in non-nodejs env, we remove timerId\n+                  // from local cache\n+                  delete tasksByHandleId[options.handleId];\n+                } else if (options.handleId) {\n+                  // Node returns complex objects as handleIds\n+                  // we remove task reference from timer object\n+                  (options.handleId as any)[taskSymbol] = null;\n+                }\n+              }\n+            }\n+          };\n           const task =\n               scheduleMacroTaskWithCurrentZone(setName, args[0], options, scheduleTask, clearTask);\n           if (!task) {"
        },
        {
            "sha": "249b871f8ef2e67c24497bc5d7a9ad2f03a1dd07",
            "filename": "packages/zone.js/test/zone-spec/fake-async-test.spec.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/0652b29f6288c7150e1ce143fdd1d3e509292c9d/packages%2Fzone.js%2Ftest%2Fzone-spec%2Ffake-async-test.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0652b29f6288c7150e1ce143fdd1d3e509292c9d/packages%2Fzone.js%2Ftest%2Fzone-spec%2Ffake-async-test.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fzone-spec%2Ffake-async-test.spec.ts?ref=0652b29f6288c7150e1ce143fdd1d3e509292c9d",
            "patch": "@@ -289,6 +289,40 @@ describe('FakeAsyncTestZoneSpec', () => {\n       });\n     });\n \n+    it('should clear internal timerId cache', () => {\n+      let taskSpy: jasmine.Spy = jasmine.createSpy('taskGetState');\n+      fakeAsyncTestZone\n+          .fork({\n+            name: 'scheduleZone',\n+            onScheduleTask: (delegate: ZoneDelegate, curr: Zone, target: Zone, task: Task) => {\n+              (task as any)._state = task.state;\n+              Object.defineProperty(task, 'state', {\n+                configurable: true,\n+                enumerable: true,\n+                get: () => {\n+                  taskSpy();\n+                  return (task as any)._state;\n+                },\n+                set: (newState: string) => {\n+                  (task as any)._state = newState;\n+                }\n+              });\n+              return delegate.scheduleTask(target, task);\n+            }\n+          })\n+          .run(() => {\n+            const id = setTimeout(() => {}, 0);\n+            testZoneSpec.tick();\n+            clearTimeout(id);\n+            // This is a hack way to test the timerId cache is cleaned or not\n+            // since the tasksByHandleId cache is an internal variable held by\n+            // zone.js timer patch, if the cache is not cleared, the code in `timer.ts`\n+            // will call `task.state` one more time to check whether to clear the\n+            // task or not, so here we use this count to check the issue is fixed or not\n+            // For details, please refer to https://github.com/angular/angular/issues/40387\n+            expect(taskSpy.calls.count()).toEqual(5);\n+          });\n+    });\n     it('should pass arguments to setImmediate', ifEnvSupports('setImmediate', () => {\n          fakeAsyncTestZone.run(() => {\n            let value = 'genuine value';"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 63,
        "deletions": 21
    }
}