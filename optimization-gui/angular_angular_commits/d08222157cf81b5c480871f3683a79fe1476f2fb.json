{
    "author": "gkalpak",
    "message": "refactor(upgrade): create a helper for cleaning jqLite/jQuery data (#40045)\n\nThis commit moves the code for cleaning jqLite/jQuery data on an element\nto a re-usable helper function. This way it is easier to keep the code\nconsistent across all places where we need to clean data (now and in the\nfuture).\n\nPR Close #40045",
    "sha": "d08222157cf81b5c480871f3683a79fe1476f2fb",
    "files": [
        {
            "sha": "8711624f3bad57c0ecd93c3debab9590acaabc77",
            "filename": "packages/upgrade/src/common/src/downgrade_component_adapter.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/d08222157cf81b5c480871f3683a79fe1476f2fb/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Fdowngrade_component_adapter.ts",
            "raw_url": "https://github.com/angular/angular/raw/d08222157cf81b5c480871f3683a79fe1476f2fb/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Fdowngrade_component_adapter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Fdowngrade_component_adapter.ts?ref=d08222157cf81b5c480871f3683a79fe1476f2fb",
            "patch": "@@ -8,10 +8,10 @@\n \n import {ApplicationRef, ChangeDetectorRef, ComponentFactory, ComponentRef, EventEmitter, Injector, OnChanges, SimpleChange, SimpleChanges, StaticProvider, Testability, TestabilityRegistry, Type} from '@angular/core';\n \n-import {element as angularElement, IAttributes, IAugmentedJQuery, ICompileService, INgModelController, IParseService, IScope} from './angular1';\n+import {IAttributes, IAugmentedJQuery, ICompileService, INgModelController, IParseService, IScope} from './angular1';\n import {PropertyBinding} from './component_info';\n import {$SCOPE} from './constants';\n-import {getTypeName, hookupNgModel, strictEquals} from './util';\n+import {cleanData, getTypeName, hookupNgModel, strictEquals} from './util';\n \n const INITIAL_VALUE = {\n   __UNINITIALIZED__: true\n@@ -241,12 +241,7 @@ export class DowngradeComponentAdapter {\n         //\n         // To ensure the element is always properly cleaned up, we manually call `cleanData()` on\n         // this element and its descendants before destroying the `ComponentRef`.\n-        //\n-        // NOTE:\n-        // `cleanData()` also will invoke the AngularJS `$destroy` event on the element:\n-        //   https://github.com/angular/angular.js/blob/2e72ea13fa98bebf6ed4b5e3c45eaf5f990ed16f/src/Angular.js#L1932-L1945\n-        angularElement.cleanData(this.element);\n-        angularElement.cleanData((this.element[0] as Element).querySelectorAll('*'));\n+        cleanData(this.element[0]);\n \n         destroyComponentRef();\n       }"
        },
        {
            "sha": "71a0c56f9233ccb2ce9938d02ad413131e722373",
            "filename": "packages/upgrade/src/common/src/upgrade_helper.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/d08222157cf81b5c480871f3683a79fe1476f2fb/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Fupgrade_helper.ts",
            "raw_url": "https://github.com/angular/angular/raw/d08222157cf81b5c480871f3683a79fe1476f2fb/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Fupgrade_helper.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Fupgrade_helper.ts?ref=d08222157cf81b5c480871f3683a79fe1476f2fb",
            "patch": "@@ -10,7 +10,7 @@ import {ElementRef, Injector, SimpleChanges} from '@angular/core';\n \n import {DirectiveRequireProperty, element as angularElement, IAugmentedJQuery, ICloneAttachFunction, ICompileService, IController, IControllerService, IDirective, IHttpBackendService, IInjectorService, ILinkFn, IScope, ITemplateCacheService, SingleOrListOrMap} from './angular1';\n import {$COMPILE, $CONTROLLER, $HTTP_BACKEND, $INJECTOR, $TEMPLATE_CACHE} from './constants';\n-import {controllerKey, directiveNormalize, isFunction} from './util';\n+import {cleanData, controllerKey, directiveNormalize, isFunction} from './util';\n \n \n \n@@ -125,15 +125,7 @@ export class UpgradeHelper {\n       controllerInstance.$onDestroy();\n     }\n     $scope.$destroy();\n-\n-    // Clean the jQuery/jqLite data on the component+child elements.\n-    // Equivelent to how jQuery/jqLite invoke `cleanData` on an Element (this.element)\n-    //  https://github.com/jquery/jquery/blob/e743cbd28553267f955f71ea7248377915613fd9/src/manipulation.js#L223\n-    //  https://github.com/angular/angular.js/blob/26ddc5f830f902a3d22f4b2aab70d86d4d688c82/src/jqLite.js#L306-L312\n-    // `cleanData` will invoke the AngularJS `$destroy` DOM event\n-    //  https://github.com/angular/angular.js/blob/26ddc5f830f902a3d22f4b2aab70d86d4d688c82/src/Angular.js#L1911-L1924\n-    angularElement.cleanData([this.element]);\n-    angularElement.cleanData(this.element.querySelectorAll('*'));\n+    cleanData(this.element);\n   }\n \n   prepareTransclusion(): ILinkFn|undefined {"
        },
        {
            "sha": "bb93e23a637ffe56db38a6c4d063c3853c9f535e",
            "filename": "packages/upgrade/src/common/src/util.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/d08222157cf81b5c480871f3683a79fe1476f2fb/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/d08222157cf81b5c480871f3683a79fe1476f2fb/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Futil.ts?ref=d08222157cf81b5c480871f3683a79fe1476f2fb",
            "patch": "@@ -8,7 +8,7 @@\n \n import {Injector, Type} from '@angular/core';\n \n-import {IInjectorService, INgModelController} from './angular1';\n+import {element as angularElement, IInjectorService, INgModelController} from './angular1';\n import {DOWNGRADED_MODULE_COUNT_KEY, UPGRADE_APP_TYPE_KEY} from './constants';\n \n const DIRECTIVE_PREFIX_REGEXP = /^(?:x|data)[:\\-_]/i;\n@@ -25,6 +25,25 @@ export function onError(e: any) {\n   throw e;\n }\n \n+/**\n+ * Clean the jqLite/jQuery data on the element and all its descendants.\n+ * Equivalent to how jqLite/jQuery invoke `cleanData()` on an Element when removed:\n+ *   https://github.com/angular/angular.js/blob/2e72ea13fa98bebf6ed4b5e3c45eaf5f990ed16f/src/jqLite.js#L349-L355\n+ *   https://github.com/jquery/jquery/blob/6984d1747623dbc5e87fd6c261a5b6b1628c107c/src/manipulation.js#L182\n+ *\n+ * NOTE:\n+ * `cleanData()` will also invoke the AngularJS `$destroy` DOM event on the element:\n+ *   https://github.com/angular/angular.js/blob/2e72ea13fa98bebf6ed4b5e3c45eaf5f990ed16f/src/Angular.js#L1932-L1945\n+ *\n+ * @param node The DOM node whose data needs to be cleaned.\n+ */\n+export function cleanData(node: Node): void {\n+  angularElement.cleanData([node]);\n+  if (isParentNode(node)) {\n+    angularElement.cleanData(node.querySelectorAll('*'));\n+  }\n+}\n+\n export function controllerKey(name: string): string {\n   return '$' + name + 'Controller';\n }\n@@ -53,6 +72,10 @@ export function isFunction(value: any): value is Function {\n   return typeof value === 'function';\n }\n \n+function isParentNode(node: Node|ParentNode): node is ParentNode {\n+  return isFunction((node as unknown as ParentNode).querySelectorAll);\n+}\n+\n export function validateInjectionKey(\n     $injector: IInjectorService, downgradedModule: string, injectionKey: string,\n     attemptedAction: string): void {"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 29,
        "deletions": 19
    }
}