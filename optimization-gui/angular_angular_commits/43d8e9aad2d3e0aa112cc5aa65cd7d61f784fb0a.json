{
    "author": "petebacondarwin",
    "message": "refactor(compiler): capture `fullStart` locations when tokenizing (#39486)\n\nThis commit ensures that when leading whitespace is skipped by\nthe tokenizer, the original start location (before skipping) is captured\nin the `fullStart` property of the token's source-span.\n\nPR Close #39486",
    "sha": "43d8e9aad2d3e0aa112cc5aa65cd7d61f784fb0a",
    "files": [
        {
            "sha": "8d0bf73eda951cd9b845cc47680adc863672556a",
            "filename": "packages/compiler/src/ml_parser/lexer.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/43d8e9aad2d3e0aa112cc5aa65cd7d61f784fb0a/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts",
            "raw_url": "https://github.com/angular/angular/raw/43d8e9aad2d3e0aa112cc5aa65cd7d61f784fb0a/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts?ref=43d8e9aad2d3e0aa112cc5aa65cd7d61f784fb0a",
            "patch": "@@ -917,19 +917,20 @@ class PlainCharacterCursor implements CharacterCursor {\n \n   getSpan(start?: this, leadingTriviaCodePoints?: number[]): ParseSourceSpan {\n     start = start || this;\n-    let cloned = false;\n+    let fullStart = start;\n     if (leadingTriviaCodePoints) {\n       while (this.diff(start) > 0 && leadingTriviaCodePoints.indexOf(start.peek()) !== -1) {\n-        if (!cloned) {\n+        if (fullStart === start) {\n           start = start.clone() as this;\n-          cloned = true;\n         }\n         start.advance();\n       }\n     }\n-    return new ParseSourceSpan(\n-        new ParseLocation(start.file, start.state.offset, start.state.line, start.state.column),\n-        new ParseLocation(this.file, this.state.offset, this.state.line, this.state.column));\n+    const startLocation = this.locationFromCursor(start);\n+    const endLocation = this.locationFromCursor(this);\n+    const fullStartLocation =\n+        fullStart !== start ? this.locationFromCursor(fullStart) : startLocation;\n+    return new ParseSourceSpan(startLocation, endLocation, fullStartLocation);\n   }\n \n   getChars(start: this): string {\n@@ -959,6 +960,11 @@ class PlainCharacterCursor implements CharacterCursor {\n   protected updatePeek(state: CursorState): void {\n     state.peek = state.offset >= this.end ? chars.$EOF : this.charAt(state.offset);\n   }\n+\n+  private locationFromCursor(cursor: this): ParseLocation {\n+    return new ParseLocation(\n+        cursor.file, cursor.state.offset, cursor.state.line, cursor.state.column);\n+  }\n }\n \n class EscapedCharacterCursor extends PlainCharacterCursor {"
        },
        {
            "sha": "886e1e30a481ae2e9407af235f79872b8bd2875e",
            "filename": "packages/compiler/test/ml_parser/lexer_spec.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/43d8e9aad2d3e0aa112cc5aa65cd7d61f784fb0a/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/43d8e9aad2d3e0aa112cc5aa65cd7d61f784fb0a/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts?ref=43d8e9aad2d3e0aa112cc5aa65cd7d61f784fb0a",
            "patch": "@@ -54,14 +54,14 @@ import {ParseLocation, ParseSourceFile, ParseSourceSpan} from '../../src/parse_u\n       });\n \n       it('should skip over leading trivia for source-span start', () => {\n-        expect(tokenizeAndHumanizeLineColumn(\n-                   '<t>\\n \\t a</t>', {leadingTriviaChars: ['\\n', ' ', '\\t']}))\n+        expect(\n+            tokenizeAndHumanizeFullStart('<t>\\n \\t a</t>', {leadingTriviaChars: ['\\n', ' ', '\\t']}))\n             .toEqual([\n-              [lex.TokenType.TAG_OPEN_START, '0:0'],\n-              [lex.TokenType.TAG_OPEN_END, '0:2'],\n-              [lex.TokenType.TEXT, '1:3'],\n-              [lex.TokenType.TAG_CLOSE, '1:4'],\n-              [lex.TokenType.EOF, '1:8'],\n+              [lex.TokenType.TAG_OPEN_START, '0:0', '0:0'],\n+              [lex.TokenType.TAG_OPEN_END, '0:2', '0:2'],\n+              [lex.TokenType.TEXT, '1:3', '0:3'],\n+              [lex.TokenType.TAG_CLOSE, '1:4', '1:4'],\n+              [lex.TokenType.EOF, '1:8', '1:8'],\n             ]);\n       });\n     });\n@@ -1560,6 +1560,14 @@ function tokenizeAndHumanizeLineColumn(input: string, options?: lex.TokenizeOpti\n       .tokens.map(token => [<any>token.type, humanizeLineColumn(token.sourceSpan.start)]);\n }\n \n+function tokenizeAndHumanizeFullStart(input: string, options?: lex.TokenizeOptions): any[] {\n+  return tokenizeWithoutErrors(input, options)\n+      .tokens.map(\n+          token =>\n+              [<any>token.type, humanizeLineColumn(token.sourceSpan.start),\n+               humanizeLineColumn(token.sourceSpan.fullStart)]);\n+}\n+\n function tokenizeAndHumanizeErrors(input: string, options?: lex.TokenizeOptions): any[] {\n   return lex.tokenize(input, 'someUrl', getHtmlTagDefinition, options)\n       .errors.map(e => [<any>e.tokenType, e.msg, humanizeLineColumn(e.span.start)]);"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 27,
        "deletions": 13
    }
}