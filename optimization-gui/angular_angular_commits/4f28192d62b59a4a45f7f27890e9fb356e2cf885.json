{
    "author": "josephperrott",
    "message": "refactor(dev-infra): use a mixin to require a `github-token` for an ng-dev command (#38630)\n\nCreates a mixin for requiring a github token to be provided to a command.  This mixin\nallows for a centralized management of the requirement and handling of the github-token.\n\nPR Close #38630",
    "sha": "4f28192d62b59a4a45f7f27890e9fb356e2cf885",
    "files": [
        {
            "sha": "0aabc8f5c634b816546b7c2bf1fa084339b78690",
            "filename": "dev-infra/pr/checkout/cli.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 18,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/4f28192d62b59a4a45f7f27890e9fb356e2cf885/dev-infra%2Fpr%2Fcheckout%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f28192d62b59a4a45f7f27890e9fb356e2cf885/dev-infra%2Fpr%2Fcheckout%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcheckout%2Fcli.ts?ref=4f28192d62b59a4a45f7f27890e9fb356e2cf885",
            "patch": "@@ -8,35 +8,21 @@\n \n import {Arguments, Argv, CommandModule} from 'yargs';\n \n-import {error} from '../../utils/console';\n+import {addGithubTokenFlag} from '../../utils/yargs';\n import {checkOutPullRequestLocally} from '../common/checkout-pr';\n \n export interface CheckoutOptions {\n   prNumber: number;\n-  'github-token'?: string;\n+  githubToken: string;\n }\n \n-/** URL to the Github page where personal access tokens can be generated. */\n-export const GITHUB_TOKEN_GENERATE_URL = `https://github.com/settings/tokens`;\n-\n /** Builds the checkout pull request command. */\n function builder(yargs: Argv) {\n-  return yargs.positional('prNumber', {type: 'number', demandOption: true}).option('github-token', {\n-    type: 'string',\n-    description: 'Github token. If not set, token is retrieved from the environment variables.'\n-  });\n+  return addGithubTokenFlag(yargs).positional('prNumber', {type: 'number', demandOption: true});\n }\n \n /** Handles the checkout pull request command. */\n-async function handler({prNumber, 'github-token': token}: Arguments<CheckoutOptions>) {\n-  const githubToken = token || process.env.GITHUB_TOKEN || process.env.TOKEN;\n-  if (!githubToken) {\n-    error('No Github token set. Please set the `GITHUB_TOKEN` environment variable.');\n-    error('Alternatively, pass the `--github-token` command line flag.');\n-    error(`You can generate a token here: ${GITHUB_TOKEN_GENERATE_URL}`);\n-    process.exitCode = 1;\n-    return;\n-  }\n+async function handler({prNumber, githubToken}: Arguments<CheckoutOptions>) {\n   const prCheckoutOptions = {allowIfMaintainerCannotModify: true, branchName: `pr-${prNumber}`};\n   await checkOutPullRequestLocally(prNumber, githubToken, prCheckoutOptions);\n }"
        },
        {
            "sha": "d5b6ac4f466d18e7f235f5f8af188a64459bb23a",
            "filename": "dev-infra/pr/merge/cli.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 20,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/4f28192d62b59a4a45f7f27890e9fb356e2cf885/dev-infra%2Fpr%2Fmerge%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f28192d62b59a4a45f7f27890e9fb356e2cf885/dev-infra%2Fpr%2Fmerge%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fcli.ts?ref=4f28192d62b59a4a45f7f27890e9fb356e2cf885",
            "patch": "@@ -8,36 +8,24 @@\n \n import {Arguments, Argv} from 'yargs';\n \n-import {error, red, yellow} from '../../utils/console';\n+import {addGithubTokenFlag} from '../../utils/yargs';\n \n-import {GITHUB_TOKEN_GENERATE_URL, mergePullRequest} from './index';\n+import {mergePullRequest} from './index';\n \n /** The options available to the merge command via CLI. */\n export interface MergeCommandOptions {\n-  'github-token'?: string;\n+  githubToken: string;\n   'pr-number': number;\n }\n \n /** Builds the options for the merge command. */\n export function buildMergeCommand(yargs: Argv): Argv<MergeCommandOptions> {\n-  return yargs.help()\n-      .strict()\n-      .positional('pr-number', {demandOption: true, type: 'number'})\n-      .option('github-token', {\n-        type: 'string',\n-        description: 'Github token. If not set, token is retrieved from the environment variables.'\n-      });\n+  return addGithubTokenFlag(yargs).help().strict().positional(\n+      'pr-number', {demandOption: true, type: 'number'});\n }\n \n /** Handles the merge command. i.e. performs the merge of a specified pull request. */\n-export async function handleMergeCommand(args: Arguments<MergeCommandOptions>) {\n-  const githubToken = args['github-token'] || process.env.GITHUB_TOKEN || process.env.TOKEN;\n-  if (!githubToken) {\n-    error(red('No Github token set. Please set the `GITHUB_TOKEN` environment variable.'));\n-    error(red('Alternatively, pass the `--github-token` command line flag.'));\n-    error(yellow(`You can generate a token here: ${GITHUB_TOKEN_GENERATE_URL}`));\n-    process.exit(1);\n-  }\n-\n-  await mergePullRequest(args['pr-number'], githubToken);\n+export async function handleMergeCommand(\n+    {'pr-number': pr, githubToken}: Arguments<MergeCommandOptions>) {\n+  await mergePullRequest(pr, githubToken);\n }"
        },
        {
            "sha": "4a6f5a5fd52eade079bea229047f1a045edef662",
            "filename": "dev-infra/pr/merge/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/4f28192d62b59a4a45f7f27890e9fb356e2cf885/dev-infra%2Fpr%2Fmerge%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f28192d62b59a4a45f7f27890e9fb356e2cf885/dev-infra%2Fpr%2Fmerge%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Findex.ts?ref=4f28192d62b59a4a45f7f27890e9fb356e2cf885",
            "patch": "@@ -11,13 +11,11 @@ import {getConfig, getRepoBaseDir} from '../../utils/config';\n import {error, green, info, promptConfirm, red, yellow} from '../../utils/console';\n import {GitClient} from '../../utils/git';\n import {GithubApiRequestError} from '../../utils/git/github';\n+import {GITHUB_TOKEN_GENERATE_URL} from '../../utils/yargs';\n \n-import {loadAndValidateConfig, MergeConfig, MergeConfigWithRemote} from './config';\n+import {loadAndValidateConfig, MergeConfigWithRemote} from './config';\n import {MergeResult, MergeStatus, PullRequestMergeTask} from './task';\n \n-/** URL to the Github page where personal access tokens can be generated. */\n-export const GITHUB_TOKEN_GENERATE_URL = `https://github.com/settings/tokens`;\n-\n \n /**\n  * Merges a given pull request based on labels configured in the given merge configuration."
        },
        {
            "sha": "98c44bf7f5f06a446db4d0fe924e55a146869a90",
            "filename": "dev-infra/pr/rebase/cli.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 22,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/4f28192d62b59a4a45f7f27890e9fb356e2cf885/dev-infra%2Fpr%2Frebase%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f28192d62b59a4a45f7f27890e9fb356e2cf885/dev-infra%2Fpr%2Frebase%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Frebase%2Fcli.ts?ref=4f28192d62b59a4a45f7f27890e9fb356e2cf885",
            "patch": "@@ -8,39 +8,23 @@\n \n import {Arguments, Argv} from 'yargs';\n \n-import {error} from '../../utils/console';\n+import {addGithubTokenFlag} from '../../utils/yargs';\n \n import {rebasePr} from './index';\n \n-/** URL to the Github page where personal access tokens can be generated. */\n-export const GITHUB_TOKEN_GENERATE_URL = `https://github.com/settings/tokens`;\n-\n /** The options available to the rebase command via CLI. */\n export interface RebaseCommandOptions {\n-  'github-token'?: string;\n+  githubToken: string;\n   prNumber: number;\n }\n \n /** Builds the rebase pull request command. */\n export function buildRebaseCommand(yargs: Argv): Argv<RebaseCommandOptions> {\n-  return yargs\n-      .option('github-token', {\n-        type: 'string',\n-        description: 'Github token. If not set, token is retrieved from the environment variables.'\n-      })\n-      .positional('prNumber', {type: 'number', demandOption: true});\n+  return addGithubTokenFlag(yargs).positional('prNumber', {type: 'number', demandOption: true});\n }\n \n-\n /** Handles the rebase pull request command. */\n-export async function handleRebaseCommand(args: Arguments<RebaseCommandOptions>) {\n-  const githubToken = args['github-token'] || process.env.GITHUB_TOKEN || process.env.TOKEN;\n-  if (!githubToken) {\n-    error('No Github token set. Please set the `GITHUB_TOKEN` environment variable.');\n-    error('Alternatively, pass the `--github-token` command line flag.');\n-    error(`You can generate a token here: ${GITHUB_TOKEN_GENERATE_URL}`);\n-    process.exit(1);\n-  }\n-\n-  await rebasePr(args.prNumber, githubToken);\n+export async function handleRebaseCommand(\n+    {prNumber, githubToken}: Arguments<RebaseCommandOptions>) {\n+  await rebasePr(prNumber, githubToken);\n }"
        },
        {
            "sha": "bc42985aea8283a51d46777631d168a8722f2a4e",
            "filename": "dev-infra/utils/yargs.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/4f28192d62b59a4a45f7f27890e9fb356e2cf885/dev-infra%2Futils%2Fyargs.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f28192d62b59a4a45f7f27890e9fb356e2cf885/dev-infra%2Futils%2Fyargs.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fyargs.ts?ref=4f28192d62b59a4a45f7f27890e9fb356e2cf885",
            "patch": "@@ -0,0 +1,37 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Argv} from 'yargs';\n+import {error, red, yellow} from './console';\n+\n+export type ArgvWithGithubToken = Argv<{githubToken: string}>;\n+\n+export function addGithubTokenFlag(yargs: Argv): ArgvWithGithubToken {\n+  return yargs\n+      // 'github-token' is casted to 'githubToken' to properly set up typings to reflect the key in\n+      // the Argv object being camelCase rather than kebob case due to the `camel-case-expansion`\n+      // config: https://github.com/yargs/yargs-parser#camel-case-expansion\n+      .option('github-token' as 'githubToken', {\n+        type: 'string',\n+        description: 'Github token. If not set, token is retrieved from the environment variables.',\n+        coerce: (token: string) => {\n+          const githubToken = token || process.env.GITHUB_TOKEN || process.env.TOKEN;\n+          if (!githubToken) {\n+            error(red('No Github token set. Please set the `GITHUB_TOKEN` environment variable.'));\n+            error(red('Alternatively, pass the `--github-token` command line flag.'));\n+            error(yellow(`You can generate a token here: ${GITHUB_TOKEN_GENERATE_URL}`));\n+            process.exit(1);\n+          }\n+          return githubToken;\n+        },\n+      })\n+      .default('github-token' as 'githubToken', '', '<LOCAL TOKEN>');\n+}\n+\n+/** URL to the Github page where personal access tokens can be generated. */\n+export const GITHUB_TOKEN_GENERATE_URL = 'https://github.com/settings/tokens/new';"
        }
    ],
    "stats": {
        "total": 121,
        "additions": 57,
        "deletions": 64
    }
}