{
    "author": "bjarkler",
    "message": "fix(compiler): disallow i18n of security-sensitive attributes (#39554)\n\nTo minimize security risk (XSS in particular) in the i18n pipeline,\ndisallow i18n translation of attributes that are Trusted Types sinks.\nAdd integration tests to ensure that such sinks cannot be translated.\n\nPR Close #39554",
    "sha": "c8a99ef4588ee6f3ca14c8c8909d1c4f2062b36b",
    "files": [
        {
            "sha": "ebc8681aa9cbb77322ab2563cda1874af494a92b",
            "filename": "packages/compiler/src/render3/view/i18n/meta.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/c8a99ef4588ee6f3ca14c8c8909d1c4f2062b36b/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts",
            "raw_url": "https://github.com/angular/angular/raw/c8a99ef4588ee6f3ca14c8c8909d1c4f2062b36b/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts?ref=c8a99ef4588ee6f3ca14c8c8909d1c4f2062b36b",
            "patch": "@@ -14,6 +14,7 @@ import * as html from '../../../ml_parser/ast';\n import {DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig} from '../../../ml_parser/interpolation_config';\n import {ParseTreeResult} from '../../../ml_parser/parser';\n import * as o from '../../../output/output_ast';\n+import {isTrustedTypesSink} from '../../../schema/trusted_types_sinks';\n \n import {hasI18nAttrs, I18N_ATTR, I18N_ATTR_PREFIX, icuFromI18nMessage} from './util';\n \n@@ -90,9 +91,13 @@ export class I18nMetaVisitor implements html.Visitor {\n \n         } else if (attr.name.startsWith(I18N_ATTR_PREFIX)) {\n           // 'i18n-*' attributes\n-          const key = attr.name.slice(I18N_ATTR_PREFIX.length);\n-          attrsMeta[key] = attr.value;\n-\n+          const name = attr.name.slice(I18N_ATTR_PREFIX.length);\n+          if (isTrustedTypesSink(element.name, name)) {\n+            this._reportError(\n+                attr, `Translating attribute '${name}' is disallowed for security reasons.`);\n+          } else {\n+            attrsMeta[name] = attr.value;\n+          }\n         } else {\n           // non-i18n attributes\n           attrs.push(attr);"
        },
        {
            "sha": "65fb81296a72fd83c170065e1063c637a724c322",
            "filename": "packages/core/test/linker/security_integration_spec.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/c8a99ef4588ee6f3ca14c8c8909d1c4f2062b36b/packages%2Fcore%2Ftest%2Flinker%2Fsecurity_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c8a99ef4588ee6f3ca14c8c8909d1c4f2062b36b/packages%2Fcore%2Ftest%2Flinker%2Fsecurity_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Flinker%2Fsecurity_integration_spec.ts?ref=c8a99ef4588ee6f3ca14c8c8909d1c4f2062b36b",
            "patch": "@@ -283,5 +283,31 @@ function declareTests(config?: {useJit: boolean}) {\n         expect(e.innerHTML).toEqual('also  evil');\n       });\n     });\n+\n+    onlyInIvy('Trusted Types are only supported in Ivy').describe('translation', () => {\n+      it('should throw error on security-sensitive attributes with constant values', () => {\n+        const template = `<iframe srcdoc=\"foo\" i18n-srcdoc></iframe>`;\n+        TestBed.overrideComponent(SecuredComponent, {set: {template}});\n+\n+        expect(() => TestBed.createComponent(SecuredComponent))\n+            .toThrowError(/Translating attribute 'srcdoc' is disallowed for security reasons./);\n+      });\n+\n+      it('should throw error on security-sensitive attributes with interpolated values', () => {\n+        const template = `<object i18n-data data=\"foo{{bar}}baz\"></object>`;\n+        TestBed.overrideComponent(SecuredComponent, {set: {template}});\n+\n+        expect(() => TestBed.createComponent(SecuredComponent))\n+            .toThrowError(/Translating attribute 'data' is disallowed for security reasons./);\n+      });\n+\n+      it('should throw error on security-sensitive attributes with bound values', () => {\n+        const template = `<div [innerHTML]=\"foo\" i18n-innerHTML></div>`;\n+        TestBed.overrideComponent(SecuredComponent, {set: {template}});\n+\n+        expect(() => TestBed.createComponent(SecuredComponent))\n+            .toThrowError(/Translating attribute 'innerHTML' is disallowed for security reasons./);\n+      });\n+    });\n   });\n }"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 34,
        "deletions": 3
    }
}