{
    "author": "gkalpak",
    "message": "refactor(service-worker): minor refactorings to improve readability/maintainability (#42622)\n\nThis commit makes some minor refactorings to improve the code\nreadability and maintainability, including:\n- Avoiding code duplication.\n- Using more descriptive variable names.\n- Using `async/await` instead of `Promise#then()`.\n- Accessing variables directly instead of via `this` when possible.\n\nPR Close #42622",
    "sha": "4962ef533093abaae57a341f4dbef984e34cc5e4",
    "files": [
        {
            "sha": "a94dcff8690b5dd280801c1d744ea43fbb29e476",
            "filename": "packages/service-worker/worker/src/app-version.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 16,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts",
            "raw_url": "https://github.com/angular/angular/raw/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts?ref=4962ef533093abaae57a341f4dbef984e34cc5e4",
            "patch": "@@ -68,38 +68,34 @@ export class AppVersion implements UpdateSource {\n \n   constructor(\n       private scope: ServiceWorkerGlobalScope, private adapter: Adapter, private database: Database,\n-      private idle: IdleScheduler, private debugHandler: DebugHandler, readonly manifest: Manifest,\n+      idle: IdleScheduler, private debugHandler: DebugHandler, readonly manifest: Manifest,\n       readonly manifestHash: string) {\n     // The hashTable within the manifest is an Object - convert it to a Map for easier lookups.\n-    Object.keys(this.manifest.hashTable).forEach(url => {\n-      this.hashTable.set(adapter.normalizeUrl(url), this.manifest.hashTable[url]);\n+    Object.keys(manifest.hashTable).forEach(url => {\n+      this.hashTable.set(adapter.normalizeUrl(url), manifest.hashTable[url]);\n     });\n \n     // Process each `AssetGroup` declared in the manifest. Each declared group gets an `AssetGroup`\n-    // instance\n-    // created for it, of a type that depends on the configuration mode.\n+    // instance created for it, of a type that depends on the configuration mode.\n+    const assetCacheNamePrefix = `${adapter.cacheNamePrefix}:${manifestHash}:assets`;\n     this.assetGroups = (manifest.assetGroups || []).map(config => {\n-      // Every asset group has a cache that's prefixed by the manifest hash and the name of the\n-      // group.\n-      const prefix = `${adapter.cacheNamePrefix}:${this.manifestHash}:assets`;\n       // Check the caching mode, which determines when resources will be fetched/updated.\n       switch (config.installMode) {\n         case 'prefetch':\n           return new PrefetchAssetGroup(\n-              this.scope, this.adapter, this.idle, config, this.hashTable, this.database, prefix);\n+              scope, adapter, idle, config, this.hashTable, database, assetCacheNamePrefix);\n         case 'lazy':\n           return new LazyAssetGroup(\n-              this.scope, this.adapter, this.idle, config, this.hashTable, this.database, prefix);\n+              scope, adapter, idle, config, this.hashTable, database, assetCacheNamePrefix);\n       }\n     });\n \n     // Process each `DataGroup` declared in the manifest.\n-    this.dataGroups =\n-        (manifest.dataGroups || [])\n-            .map(\n-                config => new DataGroup(\n-                    this.scope, this.adapter, config, this.database, this.debugHandler,\n-                    `${adapter.cacheNamePrefix}:${config.version}:data`));\n+    this.dataGroups = (manifest.dataGroups || [])\n+                          .map(\n+                              config => new DataGroup(\n+                                  scope, adapter, config, database, debugHandler,\n+                                  `${adapter.cacheNamePrefix}:${config.version}:data`));\n \n     // This keeps backwards compatibility with app versions without navigation urls.\n     // Fix: https://github.com/angular/angular/issues/27209"
        },
        {
            "sha": "2c2e69988b0d882a893e6f966eea06900b8313cd",
            "filename": "packages/service-worker/worker/src/assets.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts",
            "raw_url": "https://github.com/angular/angular/raw/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts?ref=4962ef533093abaae57a341f4dbef984e34cc5e4",
            "patch": "@@ -38,7 +38,7 @@ export abstract class AssetGroup {\n \n   /**\n    * A Promise which resolves to the `Cache` used to back this asset group. This\n-   * is openedfrom the constructor.\n+   * is opened from the constructor.\n    */\n   protected cache: Promise<Cache>;\n \n@@ -55,7 +55,8 @@ export abstract class AssetGroup {\n   constructor(\n       protected scope: ServiceWorkerGlobalScope, protected adapter: Adapter,\n       protected idle: IdleScheduler, protected config: AssetGroupConfig,\n-      protected hashes: Map<string, string>, protected db: Database, protected prefix: string) {\n+      protected hashes: Map<string, string>, protected db: Database,\n+      protected cacheNamePrefix: string) {\n     this.name = config.name;\n \n     // Normalize the config's URLs to take the ServiceWorker's scope into account.\n@@ -65,13 +66,13 @@ export abstract class AssetGroup {\n     this.patterns = config.patterns.map(pattern => new RegExp(pattern));\n \n     // This is the primary cache, which holds all of the cached requests for this group. If a\n-    // resource\n-    // isn't in this cache, it hasn't been fetched yet.\n-    this.cache = scope.caches.open(`${this.prefix}:${config.name}:cache`);\n+    // resource isn't in this cache, it hasn't been fetched yet.\n+    this.cache = scope.caches.open(`${cacheNamePrefix}:${config.name}:cache`);\n \n     // This is the metadata table, which holds specific information for each cached URL, such as\n     // the timestamp of when it was added to the cache.\n-    this.metadata = this.db.open(`${this.prefix}:${config.name}:meta`, config.cacheQueryOptions);\n+    this.metadata =\n+        this.db.open(`${cacheNamePrefix}:${config.name}:meta`, config.cacheQueryOptions);\n   }\n \n   async cacheStatus(url: string): Promise<UpdateCacheStatus> {\n@@ -102,8 +103,8 @@ export abstract class AssetGroup {\n    * Clean up all the cached data for this group.\n    */\n   async cleanup(): Promise<void> {\n-    await this.scope.caches.delete(`${this.prefix}:${this.config.name}:cache`);\n-    await this.db.delete(`${this.prefix}:${this.config.name}:meta`);\n+    await this.scope.caches.delete(`${this.cacheNamePrefix}:${this.config.name}:cache`);\n+    await this.db.delete(`${this.cacheNamePrefix}:${this.config.name}:meta`);\n   }\n \n   /**\n@@ -136,7 +137,8 @@ export abstract class AssetGroup {\n           // to make sure it's still usable.\n           if (await this.needToRevalidate(req, cachedResponse)) {\n             this.idle.schedule(\n-                `revalidate(${this.prefix}, ${this.config.name}): ${req.url}`, async () => {\n+                `revalidate(${this.cacheNamePrefix}, ${this.config.name}): ${req.url}`,\n+                async () => {\n                   await this.fetchAndCacheOnce(req);\n                 });\n           }\n@@ -314,7 +316,7 @@ export abstract class AssetGroup {\n       try {\n         // This response is safe to cache (as long as it's cloned). Wait until the cache operation\n         // is complete.\n-        const cache = await this.scope.caches.open(`${this.prefix}:${this.config.name}:cache`);\n+        const cache = await this.cache;\n         await cache.put(req, res.clone());\n \n         // If the request is not hashed, update its metadata, especially the timestamp. This is"
        },
        {
            "sha": "2515b1ba6e4b311ae9339e44cfe300251208f656",
            "filename": "packages/service-worker/worker/src/data.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts",
            "raw_url": "https://github.com/angular/angular/raw/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts?ref=4962ef533093abaae57a341f4dbef984e34cc5e4",
            "patch": "@@ -247,13 +247,13 @@ export class DataGroup {\n   constructor(\n       private scope: ServiceWorkerGlobalScope, private adapter: Adapter,\n       private config: DataGroupConfig, private db: Database, private debugHandler: DebugHandler,\n-      private prefix: string) {\n-    this.patterns = this.config.patterns.map(pattern => new RegExp(pattern));\n-    this.cache = this.scope.caches.open(`${this.prefix}:dynamic:${this.config.name}:cache`);\n-    this.lruTable = this.db.open(\n-        `${this.prefix}:dynamic:${this.config.name}:lru`, this.config.cacheQueryOptions);\n-    this.ageTable = this.db.open(\n-        `${this.prefix}:dynamic:${this.config.name}:age`, this.config.cacheQueryOptions);\n+      private cacheNamePrefix: string) {\n+    this.patterns = config.patterns.map(pattern => new RegExp(pattern));\n+    this.cache = scope.caches.open(`${cacheNamePrefix}:dynamic:${config.name}:cache`);\n+    this.lruTable =\n+        this.db.open(`${cacheNamePrefix}:dynamic:${config.name}:lru`, config.cacheQueryOptions);\n+    this.ageTable =\n+        this.db.open(`${cacheNamePrefix}:dynamic:${config.name}:age`, config.cacheQueryOptions);\n   }\n \n   /**\n@@ -550,9 +550,9 @@ export class DataGroup {\n   async cleanup(): Promise<void> {\n     // Remove both the cache and the database entries which track LRU stats.\n     await Promise.all([\n-      this.scope.caches.delete(`${this.prefix}:dynamic:${this.config.name}:cache`),\n-      this.db.delete(`${this.prefix}:dynamic:${this.config.name}:age`),\n-      this.db.delete(`${this.prefix}:dynamic:${this.config.name}:lru`),\n+      this.scope.caches.delete(`${this.cacheNamePrefix}:dynamic:${this.config.name}:cache`),\n+      this.db.delete(`${this.cacheNamePrefix}:dynamic:${this.config.name}:age`),\n+      this.db.delete(`${this.cacheNamePrefix}:dynamic:${this.config.name}:lru`),\n     ]);\n   }\n "
        },
        {
            "sha": "ca21c267a930ab266b22548b7e7bb233a56717b4",
            "filename": "packages/service-worker/worker/src/db-cache.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdb-cache.ts",
            "raw_url": "https://github.com/angular/angular/raw/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdb-cache.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdb-cache.ts?ref=4962ef533093abaae57a341f4dbef984e34cc5e4",
            "patch": "@@ -15,27 +15,29 @@ import {Database, NotFound, Table} from './database';\n  * state within mock `Response` objects.\n  */\n export class CacheDatabase implements Database {\n-  private tables = new Map<string, Promise<CacheTable>>();\n+  private cacheNamePrefix = `${this.adapter.cacheNamePrefix}:db`;\n+  private tables = new Map<string, CacheTable>();\n \n   constructor(private scope: ServiceWorkerGlobalScope, private adapter: Adapter) {}\n \n   'delete'(name: string): Promise<boolean> {\n     if (this.tables.has(name)) {\n       this.tables.delete(name);\n     }\n-    return this.scope.caches.delete(`${this.adapter.cacheNamePrefix}:db:${name}`);\n+    return this.scope.caches.delete(`${this.cacheNamePrefix}:${name}`);\n   }\n \n-  list(): Promise<string[]> {\n-    return this.scope.caches.keys().then(\n-        keys => keys.filter(key => key.startsWith(`${this.adapter.cacheNamePrefix}:db:`)));\n+  async list(): Promise<string[]> {\n+    const prefix = `${this.cacheNamePrefix}:`;\n+    const allCacheNames = await this.scope.caches.keys();\n+    const dbCacheNames = allCacheNames.filter(name => name.startsWith(prefix));\n+    return dbCacheNames;\n   }\n \n-  open(name: string, cacheQueryOptions?: CacheQueryOptions): Promise<Table> {\n+  async open(name: string, cacheQueryOptions?: CacheQueryOptions): Promise<Table> {\n     if (!this.tables.has(name)) {\n-      const table =\n-          this.scope.caches.open(`${this.adapter.cacheNamePrefix}:db:${name}`)\n-              .then(cache => new CacheTable(name, cache, this.adapter, cacheQueryOptions));\n+      const cache = await this.scope.caches.open(`${this.cacheNamePrefix}:${name}`);\n+      const table = new CacheTable(name, cache, this.adapter, cacheQueryOptions);\n       this.tables.set(name, table);\n     }\n     return this.tables.get(name)!;"
        },
        {
            "sha": "401f1d3d6611b588687d129915f6518bbebc7987",
            "filename": "packages/service-worker/worker/src/driver.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "raw_url": "https://github.com/angular/angular/raw/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts?ref=4962ef533093abaae57a341f4dbef984e34cc5e4",
            "patch": "@@ -556,8 +556,7 @@ export class Driver implements Debuggable, UpdateSource {\n       // server and building up an empty initial state.\n       const manifest = await this.fetchLatestManifest();\n       const hash = hashManifest(manifest);\n-      manifests = {};\n-      manifests[hash] = manifest;\n+      manifests = {[hash]: manifest};\n       assignments = {};\n       latest = {latest: hash};\n "
        },
        {
            "sha": "64f35ae45c3d4018c93bb942cdb1ebcc55c4b1a9",
            "filename": "packages/service-worker/worker/testing/scope.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "raw_url": "https://github.com/angular/angular/raw/4962ef533093abaae57a341f4dbef984e34cc5e4/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts?ref=4962ef533093abaae57a341f4dbef984e34cc5e4",
            "patch": "@@ -108,7 +108,7 @@ export class MockClients implements Clients {\n export class SwTestHarness extends Adapter implements ServiceWorkerGlobalScope, Context {\n   readonly clients = new MockClients();\n   private eventHandlers = new Map<string, Function>();\n-  private skippedWaiting = true;\n+  private skippedWaiting = false;\n \n   private selfMessageQueue: any[] = [];\n   autoAdvanceTime = false;"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 47,
        "deletions": 48
    }
}