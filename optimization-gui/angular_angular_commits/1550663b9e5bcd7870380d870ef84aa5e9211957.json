{
    "author": "devversion",
    "message": "fix(bazel): ng_module rule does not expose flat module information in Ivy (#36971)\n\nThe `ng_module` rule supports the generation of flat module bundles. In\nView Engine, information about this flat module bundle is exposed\nas a Bazel provider. This is helpful as other rules like `ng_package`\ncould rely on this information to determine entry-points for the APF.\n\nWith Ivy this currently does not work because the flat module\ninformation is not exposed in the provider. The reason for this is\nunclear. We should also provide this information in Ivy so that rules\nlike `ng_package` can also determine the correct entry-points when a\npackage is built specifically with `--config=ivy`.\n\nPR Close #36971",
    "sha": "1550663b9e5bcd7870380d870ef84aa5e9211957",
    "files": [
        {
            "sha": "fc67d737669bb64571ad303b16a078c352834262",
            "filename": "packages/bazel/src/ng_module.bzl",
            "status": "modified",
            "additions": 15,
            "deletions": 9,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/1550663b9e5bcd7870380d870ef84aa5e9211957/packages%2Fbazel%2Fsrc%2Fng_module.bzl",
            "raw_url": "https://github.com/angular/angular/raw/1550663b9e5bcd7870380d870ef84aa5e9211957/packages%2Fbazel%2Fsrc%2Fng_module.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module.bzl?ref=1550663b9e5bcd7870380d870ef84aa5e9211957",
            "patch": "@@ -354,16 +354,19 @@ def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n         \"angularCompilerOptions\": angular_compiler_options,\n     })\n \n+def _has_target_angular_summaries(target):\n+    return hasattr(target, \"angular\") and hasattr(target.angular, \"summaries\")\n+\n def _collect_summaries_aspect_impl(target, ctx):\n-    results = depset(target.angular.summaries if hasattr(target, \"angular\") else [])\n+    results = depset(target.angular.summaries if _has_target_angular_summaries(target) else [])\n \n     # If we are visiting empty-srcs ts_library, this is a re-export\n     srcs = ctx.rule.attr.srcs if hasattr(ctx.rule.attr, \"srcs\") else []\n \n     # \"re-export\" rules should expose all the files of their deps\n     if not srcs and hasattr(ctx.rule.attr, \"deps\"):\n         for dep in ctx.rule.attr.deps:\n-            if (hasattr(dep, \"angular\")):\n+            if (_has_target_angular_summaries(dep)):\n                 results = depset(dep.angular.summaries, transitive = [results])\n \n     return struct(collect_summaries_aspect_result = results)\n@@ -608,20 +611,23 @@ def ng_module_impl(ctx, ts_compile_actions):\n \n     outs = _expected_outs(ctx)\n \n+    providers[\"angular\"] = {}\n+\n     if is_legacy_ngc:\n-        providers[\"angular\"] = {\n-            \"summaries\": outs.summaries,\n-            \"metadata\": outs.metadata,\n-        }\n+        providers[\"angular\"][\"summaries\"] = outs.summaries\n+        providers[\"angular\"][\"metadata\"] = outs.metadata\n         providers[\"ngc_messages\"] = outs.i18n_messages\n \n-    if is_legacy_ngc and _should_produce_flat_module_outs(ctx):\n-        if len(outs.metadata) > 1:\n+    if _should_produce_flat_module_outs(ctx):\n+        # Sanity error if more than one metadata file has been created in the\n+        # legacy ngc compiler while a flat module should be produced.\n+        if is_legacy_ngc and len(outs.metadata) > 1:\n             fail(\"expecting exactly one metadata output for \" + str(ctx.label))\n \n         providers[\"angular\"][\"flat_module_metadata\"] = struct(\n             module_name = ctx.attr.module_name,\n-            metadata_file = outs.metadata[0],\n+            # Metadata files are only generated in the legacy ngc compiler.\n+            metadata_file = outs.metadata[0] if is_legacy_ngc else None,\n             typings_file = outs.bundle_index_typings,\n             flat_module_out_file = _flat_module_out_file(ctx),\n         )"
        },
        {
            "sha": "7f08ca943b4474cb8c3e3cf81b0e04ab9c31093b",
            "filename": "packages/bazel/src/ng_package/packager.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/1550663b9e5bcd7870380d870ef84aa5e9211957/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts",
            "raw_url": "https://github.com/angular/angular/raw/1550663b9e5bcd7870380d870ef84aa5e9211957/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts?ref=1550663b9e5bcd7870380d870ef84aa5e9211957",
            "patch": "@@ -180,8 +180,8 @@ function main(args: string[]): number {\n \n     moduleFiles['esm2015_index'] = path.join(binDir, 'esm2015', relative);\n \n-    // Metadata file is optional as entry-points can be also built\n-    // with the \"ts_library\" rule.\n+    // Metadata file is optional as entry-points can be built with the `ts_library`\n+    // rule or `ng_module` rule in Ivy mode.\n     const metadataFile = moduleFiles['metadata'];\n     if (!metadataFile) {\n       return;"
        },
        {
            "sha": "0b2d2adb4a45af355b121a43b5efc6e0cd89178e",
            "filename": "packages/bazel/test/ng_package/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/1550663b9e5bcd7870380d870ef84aa5e9211957/packages%2Fbazel%2Ftest%2Fng_package%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/1550663b9e5bcd7870380d870ef84aa5e9211957/packages%2Fbazel%2Ftest%2Fng_package%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2FBUILD.bazel?ref=1550663b9e5bcd7870380d870ef84aa5e9211957",
            "patch": "@@ -25,10 +25,6 @@ jasmine_node_test(\n         \"@npm//@types/shelljs\",\n         \"@npm//shelljs\",\n     ],\n-    # The \"ng_package\" rule currently does not properly handle flat module\n-    # bundles which the common package tests rely on. We temporarily disable\n-    # this test until we fix `ng_package` for Ivy. Tracked with: FW-2144.\n-    tags = [\"fixme-ivy-aot\"],\n )\n \n ts_library(\n@@ -49,10 +45,6 @@ jasmine_node_test(\n         \"//packages/common:npm_package\",\n         \"@npm//shelljs\",\n     ],\n-    # The \"ng_package\" rule currently does not properly handle flat module\n-    # bundles which the common package tests rely on. We temporarily disable\n-    # this test until we fix `ng_package` for Ivy. Tracked with: FW-2144.\n-    tags = [\"fixme-ivy-aot\"],\n )\n \n ts_library("
        },
        {
            "sha": "0da1caa2ca036a32feefd27668dd6c669c729bf8",
            "filename": "packages/compiler-cli/integrationtest/bazel/ng_module/extract_flat_module_index.bzl",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/1550663b9e5bcd7870380d870ef84aa5e9211957/packages%2Fcompiler-cli%2Fintegrationtest%2Fbazel%2Fng_module%2Fextract_flat_module_index.bzl",
            "raw_url": "https://github.com/angular/angular/raw/1550663b9e5bcd7870380d870ef84aa5e9211957/packages%2Fcompiler-cli%2Fintegrationtest%2Fbazel%2Fng_module%2Fextract_flat_module_index.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fintegrationtest%2Fbazel%2Fng_module%2Fextract_flat_module_index.bzl?ref=1550663b9e5bcd7870380d870ef84aa5e9211957",
            "patch": "@@ -8,9 +8,14 @@\n def _extract_flat_module_index(ctx):\n     files = []\n     for dep in ctx.attr.deps:\n-        if hasattr(dep, \"angular\"):\n-            metadata = dep.angular.flat_module_metadata\n-            files.extend([metadata.metadata_file, metadata.typings_file])\n+        if hasattr(dep, \"angular\") and hasattr(dep.angular, \"flat_module_metadata\"):\n+            flat_module = dep.angular.flat_module_metadata\n+            files.append(flat_module.typings_file)\n+\n+            # The flat module metadata file could be `None` for targets\n+            # built with Ivy. No metadata files are generated in ngtsc.\n+            if flat_module.metadata_file != None:\n+                files.append(flat_module.metadata_file)\n     return [DefaultInfo(files = depset(files))]\n \n extract_flat_module_index = rule("
        }
    ],
    "stats": {
        "total": 47,
        "additions": 25,
        "deletions": 22
    }
}