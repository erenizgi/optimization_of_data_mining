{
    "author": "ranma42",
    "message": "fix(common): narrow `NgIf` context variables in template type checker (#36627)\n\nWhen the `NgIf` directive is used in a template, its context variables\ncan be used to capture the bound value. This is sometimes used in\ncomplex expressions, where the resulting value is captured in a\ncontext variable. There's two syntax forms available:\n\n1. Binding to `NgIfContext.ngIf` using the `as` syntax:\n```html\n<span *ngIf=\"enabled && user as u\">{{u.name}}</span>\n```\n\n2. Binding to `NgIfContext.$implicit` using the `let` syntax:\n```html\n<span *ngIf=\"enabled && user; let u\">{{u.name}}</span>\n```\n\nBecause of the semantics of `ngIf`, it is known that the captured\ncontext variable is truthy, however the template type checker\nwould not consider them as such and still report errors when\n`strict` is enabled.\n\nThis commit updates `NgIf`'s context guard to make the types of the\ncontext variables truthy, avoiding the issue.\n\nBased on https://github.com/angular/angular/pull/35125\n\nPR Close #36627",
    "sha": "9c8bc4a2392b538b525352623458a541c7970a89",
    "files": [
        {
            "sha": "339f0b753d87dd9d665abea3a492ba243ec01127",
            "filename": "goldens/public-api/common/common.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9c8bc4a2392b538b525352623458a541c7970a89/goldens%2Fpublic-api%2Fcommon%2Fcommon.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/9c8bc4a2392b538b525352623458a541c7970a89/goldens%2Fpublic-api%2Fcommon%2Fcommon.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcommon%2Fcommon.d.ts?ref=9c8bc4a2392b538b525352623458a541c7970a89",
            "patch": "@@ -243,7 +243,7 @@ export declare class NgIf<T = unknown> {\n     set ngIfThen(templateRef: TemplateRef<NgIfContext<T>> | null);\n     constructor(_viewContainer: ViewContainerRef, templateRef: TemplateRef<NgIfContext<T>>);\n     static ngTemplateGuard_ngIf: 'binding';\n-    static ngTemplateContextGuard<T>(dir: NgIf<T>, ctx: any): ctx is NgIfContext<NonNullable<T>>;\n+    static ngTemplateContextGuard<T>(dir: NgIf<T>, ctx: any): ctx is NgIfContext<Exclude<T, false | 0 | '' | null | undefined>>;\n }\n \n export declare class NgIfContext<T = unknown> {"
        },
        {
            "sha": "26704b85928ec07c84d3ca4717642d50cb067a6a",
            "filename": "packages/common/src/directives/ng_if.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/9c8bc4a2392b538b525352623458a541c7970a89/packages%2Fcommon%2Fsrc%2Fdirectives%2Fng_if.ts",
            "raw_url": "https://github.com/angular/angular/raw/9c8bc4a2392b538b525352623458a541c7970a89/packages%2Fcommon%2Fsrc%2Fdirectives%2Fng_if.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Fdirectives%2Fng_if.ts?ref=9c8bc4a2392b538b525352623458a541c7970a89",
            "patch": "@@ -232,7 +232,8 @@ export class NgIf<T = unknown> {\n    * The presence of this method is a signal to the Ivy template type-check compiler that the\n    * `NgIf` structural directive renders its template with a specific context type.\n    */\n-  static ngTemplateContextGuard<T>(dir: NgIf<T>, ctx: any): ctx is NgIfContext<NonNullable<T>> {\n+  static ngTemplateContextGuard<T>(dir: NgIf<T>, ctx: any):\n+      ctx is NgIfContext<Exclude<T, false|0|''|null|undefined>> {\n     return true;\n   }\n }"
        },
        {
            "sha": "377179e736793a32153daeedac586004c1f079b5",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/9c8bc4a2392b538b525352623458a541c7970a89/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9c8bc4a2392b538b525352623458a541c7970a89/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=9c8bc4a2392b538b525352623458a541c7970a89",
            "patch": "@@ -72,7 +72,7 @@ export declare class NgIf<T = unknown> {\n   ngIfThen: TemplateRef<NgIfContext<T>> | null;\n   constructor(_viewContainer: ViewContainerRef, templateRef: TemplateRef<NgIfContext<T>>);\n   static ngTemplateGuard_ngIf: 'binding';\n-  static ngTemplateContextGuard<T>(dir: NgIf<T>, ctx: any): ctx is NgIfContext<NonNullable<T>>;\n+  static ngTemplateContextGuard<T>(dir: NgIf<T>, ctx: any): ctx is NgIfContext<Exclude<T, false | 0 | \"\" | null | undefined>>;\n   static ɵdir: i0.ɵɵDirectiveDefWithMeta<NgIf<any>, '[ngIf]', never, {'ngIf': 'ngIf'}, {}, never>;\n }\n \n@@ -818,7 +818,7 @@ export declare class AnimationEvent {\n       template: '<div *ngIf=\"user; let u\">{{u.name}}</div>',\n     })\n     class TestCmp {\n-      user: {name: string}|null;\n+      user: {name: string}|null|false;\n     }\n \n     @NgModule({\n@@ -842,7 +842,7 @@ export declare class AnimationEvent {\n       template: '<div *ngIf=\"user as u\">{{u.name}}</div>',\n     })\n     class TestCmp {\n-      user: {name: string}|null;\n+      user: {name: string}|null|false;\n     }\n \n     @NgModule({"
        }
    ],
    "stats": {
        "total": 11,
        "additions": 6,
        "deletions": 5
    }
}