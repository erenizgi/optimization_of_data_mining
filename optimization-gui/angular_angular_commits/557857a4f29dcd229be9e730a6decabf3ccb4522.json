{
    "author": "gkalpak",
    "message": "test(ngcc): use helper function for generating UMD modules for tests (#44245)\n\nPreviously, several ngcc test suites used their own helper to generate\ntest UMD modules.\n\nThis commit switches to using the same helper for generating UMD modules\nacross test suites. This improves DRYness (ensuring changes/fixes to the\nUMD format need only be applied once) and makes it easier to test\ndifferent UMD formats in all test suites.\n\nPR Close #44245",
    "sha": "557857a4f29dcd229be9e730a6decabf3ccb4522",
    "files": [
        {
            "sha": "9c9d5434012d1c2fff6d368ae161e5e64a6f4cbf",
            "filename": "packages/compiler-cli/ngcc/test/dependencies/umd_dependency_host_spec.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 23,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/557857a4f29dcd229be9e730a6decabf3ccb4522/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/557857a4f29dcd229be9e730a6decabf3ccb4522/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts?ref=557857a4f29dcd229be9e730a6decabf3ccb4522",
            "patch": "@@ -13,9 +13,11 @@ import {loadTestFiles} from '../../../src/ngtsc/testing';\n import {createDependencyInfo} from '../../src/dependencies/dependency_host';\n import {ModuleResolver} from '../../src/dependencies/module_resolver';\n import {UmdDependencyHost} from '../../src/dependencies/umd_dependency_host';\n+import {createUmdModuleFactory, WrapperFunctionFormat} from '../helpers/umd_utils';\n \n runInEachFileSystem(() => {\n   describe('UmdDependencyHost', () => {\n+    const createUmdModule = createUmdModuleFactory(WrapperFunctionFormat.Rollup);\n     let _: typeof absoluteFrom;\n     let host: UmdDependencyHost;\n \n@@ -258,28 +260,11 @@ runInEachFileSystem(() => {\n         {name: _('/dist/lib/shared/test/index.metadata.json'), contents: 'MOCK METADATA'},\n       ]);\n     }\n-  });\n \n-  function umd(moduleName: string, importPaths: string[], exportNames: string[] = []) {\n-    const commonJsRequires = importPaths.map(p => `,require('${p}')`).join('');\n-    const amdDeps = importPaths.map(p => `,'${p}'`).join('');\n-    const globalParams =\n-        importPaths.map(p => `,global.${p.replace('@angular/', 'ng.').replace(/\\//g, '')}`)\n-            .join('');\n-    const params =\n-        importPaths.map(p => `,${p.replace('@angular/', '').replace(/\\.?\\.?\\//g, '')}`).join('');\n-    const exportStatements =\n-        exportNames.map(e => `  exports.${e.replace(/.+\\./, '')} = ${e};`).join('\\n');\n-    return `\n-(function (global, factory) {\n-  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports${\n-        commonJsRequires}) :\n-  typeof define === 'function' && define.amd ? define('${moduleName}', ['exports'${\n-        amdDeps}], factory) :\n-  (factory(global.${moduleName}${globalParams}));\n-}(this, (function (exports${params}) { 'use strict';\n-${exportStatements}\n-})));\n-  `;\n-  }\n+    function umd(moduleName: string, importPaths: string[], exportNames: string[] = []) {\n+      const exportStatements =\n+          exportNames.map(e => `  exports.${e.replace(/.+\\./, '')} = ${e};`).join('\\n');\n+      return createUmdModule(moduleName, importPaths, exportStatements);\n+    }\n+  });\n });"
        },
        {
            "sha": "d9d796e1b2929addee888a011f2ccbaa8fe2b527",
            "filename": "packages/compiler-cli/ngcc/test/helpers/umd_utils.ts",
            "status": "added",
            "additions": 127,
            "deletions": 0,
            "changes": 127,
            "blob_url": "https://github.com/angular/angular/blob/557857a4f29dcd229be9e730a6decabf3ccb4522/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Fumd_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/557857a4f29dcd229be9e730a6decabf3ccb4522/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Fumd_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Fumd_utils.ts?ref=557857a4f29dcd229be9e730a6decabf3ccb4522",
            "patch": "@@ -0,0 +1,127 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export interface AdditionalFormatOptions {\n+  hasGlobalInitializer?: boolean;\n+  omitExports?: boolean;\n+  unusedDependencies?: Set<String>;\n+}\n+\n+export enum ParenthesisFormat {\n+  AroundFunction = 'parenthesis around function declaration',\n+  AroundIife = 'parenthesis around IIFE',\n+}\n+\n+export enum WrapperFunctionFormat {\n+  Rollup = 'wrapper function as emitted by Rollup',\n+  Webpack = 'wrapper function as emitted by Webpack',\n+}\n+\n+export function createUmdModuleFactory(\n+    wrapperFunctionFormat: WrapperFunctionFormat,\n+    parenthesisFormat: ParenthesisFormat = ParenthesisFormat.AroundIife) {\n+  return function createUmdModule(\n+      moduleName: string, dependencies: string[], factoryBody: string,\n+      {hasGlobalInitializer = false, omitExports = false, unusedDependencies = new Set()}:\n+          AdditionalFormatOptions = {}) {\n+    // Ensure that any unused dependencies are at the end.\n+    const firstUnusedDepIndex = dependencies.findIndex(dep => unusedDependencies.has(dep));\n+    const subsequentUsedDepIndex =\n+        dependencies.slice(firstUnusedDepIndex + 1).findIndex(dep => !unusedDependencies.has(dep));\n+    if (firstUnusedDepIndex !== -1 && subsequentUsedDepIndex !== -1) {\n+      throw new Error(\n+          `Used dependencies cannot follow unused ones (dependencies: ${dependencies.join(', ')} ` +\n+          `| unused: ${[...unusedDependencies].join(', ')}).`);\n+    }\n+\n+    let wrapperFunctionDeclaration: string = '';\n+    let wrapperFunctionCall: string = '';\n+\n+    const depsIdentifiers = dependencies.map(\n+        dep => dep.replace(/^@angular\\//, 'ng.')\n+                   .replace(/^\\.?\\//, '')\n+                   .replace(/[-/](.?)/g, (_, g1) => g1.toUpperCase()));\n+    const depsParamNames = dependencies.filter(dep => !unusedDependencies.has(dep))\n+                               .map((dep, i) => depsIdentifiers[i].replace(/^.*\\./, ''));\n+    const maybePrepend = (item: string, arr: string[]) => omitExports ? arr : [item, ...arr];\n+\n+    switch (wrapperFunctionFormat) {\n+      case WrapperFunctionFormat.Rollup:\n+        const cjsArgs = maybePrepend('exports', dependencies.map(d => `require('${d}')`));\n+        const amdArgs = maybePrepend('exports', dependencies).map(d => `'${d}'`);\n+        const globalArgs = maybePrepend(moduleName, depsIdentifiers).map(id => `global.${id}`);\n+        const factoryParams = maybePrepend('exports', depsParamNames);\n+\n+        wrapperFunctionDeclaration = stripIndentation(`\n+          function (global, factory) {\n+            typeof exports === 'object' && typeof module !== 'undefined' ?\n+              factory(${cjsArgs.join(', ')}) :\n+            typeof define === 'function' && define.amd ?\n+              define('${moduleName}', ${amdArgs.length ? `[${amdArgs.join(', ')}], ` : ''}factory) :\n+              (${hasGlobalInitializer ? 'global = global || self, ' : ''}factory(${\n+            globalArgs.join(', ')}));\n+          }\n+        `);\n+        wrapperFunctionCall = stripIndentation(`\n+          (this, (function (${factoryParams.join(', ')}) {\n+            'use strict';\n+          <BODY_PLACEHOLDER>\n+          }))\n+        `);\n+        break;\n+      case WrapperFunctionFormat.Webpack:\n+        wrapperFunctionDeclaration = stripIndentation(`\n+          function (root, factory) {\n+            if (typeof exports === 'object' && typeof module === 'object')\n+              module.exports = factory(${dependencies.map(d => `require('${d}')`).join(', ')});\n+            else if (typeof define === 'function' && define.amd)\n+              define([${dependencies.map(d => `'${d}'`).join(', ')}], factory);\n+            else if (typeof exports === 'object')\n+              exports['${moduleName}'] = factory(${\n+            dependencies.map(d => `require('${d}')`).join(', ')});\n+            else\n+              root['${moduleName}'] = factory(${\n+            depsIdentifiers.map(id => `root${id.split('.').map(x => `['${x}']`).join('')}`)\n+                .join(', ')});\n+          }\n+        `);\n+        wrapperFunctionCall = stripIndentation(`\n+          (global, function (${depsParamNames.join(', ')}) {\n+            'use strict';\n+          <BODY_PLACEHOLDER>\n+          })\n+        `);\n+        break;\n+      default:\n+        throw new Error(`Unknown UMD wrapper function format: ${wrapperFunctionFormat}`);\n+    }\n+\n+    // Replace the placeholder with the actual function body outside a `stripIndentation()` call to\n+    // avoid altering the original function body indentation.\n+    // (This keeps the tests more predictable in case the original indentation is taken into account\n+    // in test assertions.)\n+    wrapperFunctionCall = wrapperFunctionCall.replace('<BODY_PLACEHOLDER>', factoryBody);\n+\n+    switch (parenthesisFormat) {\n+      case ParenthesisFormat.AroundFunction:\n+        return `(${wrapperFunctionDeclaration})${wrapperFunctionCall};`;\n+      case ParenthesisFormat.AroundIife:\n+        return `(${wrapperFunctionDeclaration}${wrapperFunctionCall});`;\n+      default:\n+        throw new Error(`Unknown UMD parenthesis format: ${wrapperFunctionFormat}`);\n+    }\n+  };\n+}\n+\n+function stripIndentation(text: string): string {\n+  const lines = text.replace(/^ *\\r?\\n/, '').replace(/\\r?\\n *$/, '').split('\\n');\n+  const minIndentation =\n+      Math.min(...lines.filter(l => !/^ *\\r?$/.test(l)).map(l => /^ */.exec(l)![0].length));\n+\n+  return lines.map(l => l.substring(minIndentation)).join('\\n');\n+}"
        },
        {
            "sha": "b1e69b488b4999dc9339ec99229f0ea05ae25eac",
            "filename": "packages/compiler-cli/ngcc/test/host/umd_host_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 45,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/557857a4f29dcd229be9e730a6decabf3ccb4522/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/557857a4f29dcd229be9e730a6decabf3ccb4522/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts?ref=557857a4f29dcd229be9e730a6decabf3ccb4522",
            "patch": "@@ -19,14 +19,15 @@ import {NgccReflectionHost} from '../../src/host/ngcc_host';\n import {parseStatementForUmdModule, UmdReflectionHost} from '../../src/host/umd_host';\n import {BundleProgram} from '../../src/packages/bundle_program';\n import {hasNameIdentifier} from '../../src/utils';\n+import {createUmdModuleFactory, WrapperFunctionFormat} from '../helpers/umd_utils';\n import {getRootFiles, makeTestBundleProgram} from '../helpers/utils';\n \n import {expectTypeValueReferencesForParameters} from './util';\n \n runInEachFileSystem(() => {\n-  for (const wrapperFormat of ['rollup', 'webpack']) {\n+  for (const wrapperFormat of [WrapperFunctionFormat.Rollup, WrapperFunctionFormat.Webpack]) {\n     for (const mode of ['inline exports', 'exported vars']) {\n-      describe(`UmdReflectionHost [with ${mode}][with wrapper format: ${wrapperFormat}]`, () => {\n+      describe(`UmdReflectionHost [with ${mode}][with ${wrapperFormat}]`, () => {\n         let _: typeof absoluteFrom;\n \n         let SOME_DIRECTIVE_FILE: TestFile;\n@@ -103,49 +104,7 @@ runInEachFileSystem(() => {\n         /**\n          * Create the code for a UMD module depending on the current wrapper function format.\n          */\n-        const createUmdModule = (moduleName: string, deps: string[], factoryBody: string) => {\n-          const depsIdentifiers = deps.map(\n-              dep => dep.replace(/^@angular\\//, 'ng.').replace(/^\\.\\//, '').replace(/-/g, '_'));\n-          const depsParamNames = deps.map((dep, i) => depsIdentifiers[i].replace(/^.*\\./, ''));\n-\n-          switch (wrapperFormat) {\n-            case 'rollup':\n-              return `\n-                (function (global, factory) {\n-                  typeof exports === 'object' && typeof module !== 'undefined' ?\n-                    factory(${['exports', ...deps.map(d => `require('${d}')`)].join(', ')}) :\n-                  typeof define === 'function' && define.amd ?\n-                    define('${moduleName}', [${\n-                      ['exports', ...deps].map(d => `'${d}'`).join(', ')}], factory) :\n-                    (factory(${\n-                      [moduleName, ...depsIdentifiers].map(id => `global.${id}`).join(', ')}));\n-                }(this, (function (${['exports', ...depsParamNames].join(', ')}) {\n-                  'use strict';\n-                  ${factoryBody}\n-                })));\n-              `;\n-            case 'webpack':\n-              return `\n-                (function (root, factory) {\n-                  if (typeof exports === 'object' && typeof module === 'object')\n-                    module.exports = factory(${deps.map(d => `require('${d}')`).join(', ')});\n-                  else if (typeof define === 'function' && define.amd)\n-                    define([${deps.map(d => `'${d}'`).join(', ')}], factory);\n-                  else if (typeof exports === 'object')\n-                    exports['${moduleName}'] = factory(${\n-                  deps.map(d => `require('${d}')`).join(', ')});\n-                  else\n-                    root['${moduleName}'] = factory(${\n-                  depsIdentifiers.map(id => `root['${id}']`).join(', ')});\n-                }(global, function (${depsParamNames.join(', ')}) {\n-                  'use strict';\n-                  ${factoryBody}\n-                }));\n-              `;\n-            default:\n-              throw new Error(`Unsupported wrapper format: ${wrapperFormat}`);\n-          }\n-        };\n+        const createUmdModule = createUmdModuleFactory(wrapperFormat);\n \n         /**\n          * Select a predicate for matching an exported declaration based on whether the code"
        },
        {
            "sha": "20e84da0d9a01618bb0a3921ee3436a5085e8cd7",
            "filename": "packages/compiler-cli/ngcc/test/rendering/umd_rendering_formatter_spec.ts",
            "status": "modified",
            "additions": 69,
            "deletions": 90,
            "changes": 159,
            "blob_url": "https://github.com/angular/angular/blob/557857a4f29dcd229be9e730a6decabf3ccb4522/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/557857a4f29dcd229be9e730a6decabf3ccb4522/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts?ref=557857a4f29dcd229be9e730a6decabf3ccb4522",
            "patch": "@@ -19,10 +19,14 @@ import {DecorationAnalyzer} from '../../src/analysis/decoration_analyzer';\n import {NgccReferencesRegistry} from '../../src/analysis/ngcc_references_registry';\n import {UmdReflectionHost} from '../../src/host/umd_host';\n import {UmdRenderingFormatter} from '../../src/rendering/umd_rendering_formatter';\n+import {AdditionalFormatOptions, createUmdModuleFactory, ParenthesisFormat, WrapperFunctionFormat} from '../helpers/umd_utils';\n import {makeTestEntryPointBundle} from '../helpers/utils';\n \n interface TestFileSpec extends Omit<TestFile, 'contents'> {\n-  contents: {preamble?: string; wrapperFunction: string; wrapperCallArguments: string;};\n+  contents: {\n+    preamble?: string; moduleName: string; dependencies: string[]; factoryBody: string;\n+    additionalOptions?: AdditionalFormatOptions;\n+  };\n }\n \n function setup(file: TestFile) {\n@@ -54,51 +58,26 @@ runInEachFileSystem(() => {\n     let PROGRAM_DECORATE_HELPER_FILE_SPEC: TestFileSpec;\n     let PROGRAM_WITH_GLOBAL_INITIALIZER_FILE_SPEC: TestFileSpec;\n \n-    // Factories for creating a `TestFile` from a `TestFileSpec` for different UMD formats.\n-    const umdFormatFactories: Record<string, (spec: TestFileSpec) => TestFile> = {\n-      // Old format (parenthesis around call expression): `(function (...) { ... }(...))`\n-      'old format': spec => ({\n-        ...spec,\n-        contents: `${spec.contents.preamble ?? ''}\\n` +\n-            `(${spec.contents.wrapperFunction}(${spec.contents.wrapperCallArguments}));`,\n-      }),\n-\n-      // New format (parenthesis around function expression): `(function (...) { ... })(...)`\n-      'new format': spec => ({\n-        ...spec,\n-        contents: `${spec.contents.preamble ?? ''}\\n` +\n-            `(${spec.contents.wrapperFunction})(${spec.contents.wrapperCallArguments});`,\n-      }),\n-    };\n-\n     beforeEach(() => {\n       _ = absoluteFrom;\n \n       PROGRAM_WITH_GLOBAL_INITIALIZER_FILE_SPEC = {\n         name: _('/node_modules/test-package/some/file.js'),\n         contents: {\n-          wrapperFunction: `function (global, factory) {\n-  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports,require('some-side-effect'),require('/local-dep'),require('@angular/core')) :\n-  typeof define === 'function' && define.amd ? define('file', ['exports','some-side-effect','/local-dep','@angular/core'], factory) :\n-  (global = global || self, factory(global.file,global.someSideEffect,global.localDep,global.ng.core));\n-  }`,\n-          wrapperCallArguments:\n-              `this, (function (exports,someSideEffect,localDep,core) {'use strict'; })`,\n+          moduleName: 'file',\n+          dependencies: ['some-side-effect', '/local-dep', '@angular/core'],\n+          factoryBody: '',\n+          additionalOptions: {hasGlobalInitializer: true},\n         },\n       };\n \n       PROGRAM_FILE_SPEC = {\n         name: _('/node_modules/test-package/some/file.js'),\n         contents: {\n-          preamble: `\n-/* A copyright notice */`,\n-          wrapperFunction: `function (global, factory) {\n-typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports,require('some-side-effect'),require('/local-dep'),require('@angular/core')) :\n-typeof define === 'function' && define.amd ? define('file', ['exports','some-side-effect','/local-dep','@angular/core'], factory) :\n-(factory(global.file,global.someSideEffect,global.localDep,global.ng.core));\n-}`,\n-          wrapperCallArguments:\n-              `this, (function (exports,someSideEffect,localDep,core) {'use strict';\n+          preamble: '/* A copyright notice */',\n+          moduleName: 'file',\n+          dependencies: ['some-side-effect', '/local-dep', '@angular/core'],\n+          factoryBody: `\n var A = (function() {\n   function A() {}\n   A.decorators = [\n@@ -143,22 +122,18 @@ exports.B = B;\n exports.C = C;\n exports.NoIife = NoIife;\n exports.BadIife = BadIife;\n-})`,\n+`,\n         },\n       };\n \n \n       PROGRAM_DECORATE_HELPER_FILE_SPEC = {\n         name: _('/node_modules/test-package/some/file.js'),\n         contents: {\n-          preamble: `\n-/* A copyright notice */`,\n-          wrapperFunction: `function (global, factory) {\n-typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports,require('tslib'),require('@angular/core')) :\n-typeof define === 'function' && define.amd ? define('file', ['exports','/tslib','@angular/core'], factory) :\n-(factory(global.file,global.tslib,global.ng.core));\n-}`,\n-          wrapperCallArguments: `this, (function (exports,tslib,core) {'use strict';\n+          preamble: '/* A copyright notice */',\n+          moduleName: 'file',\n+          dependencies: ['/tslib', '@angular/core'],\n+          factoryBody: `\n   var OtherA = function () { return function (node) { }; };\n   var OtherB = function () { return function (node) { }; };\n   var A = /** @class */ (function () {\n@@ -202,13 +177,22 @@ typeof define === 'function' && define.amd ? define('file', ['exports','/tslib',\n   }());\n   exports.D = D;\n   // Some other content\n-})`,\n+`,\n         },\n       };\n     });\n \n-    Object.entries(umdFormatFactories).forEach(([formatLabel, formatFactory]) => {\n-      describe(`(when dealing with ${formatLabel})`, () => {\n+    [ParenthesisFormat.AroundFunction, ParenthesisFormat.AroundIife].forEach(parenFormat => {\n+      const createUmdModule = createUmdModuleFactory(WrapperFunctionFormat.Rollup, parenFormat);\n+      const formatFactory = (spec: TestFileSpec): TestFile => ({\n+        ...spec,\n+        contents: `${spec.contents.preamble ?? ''}\\n` +\n+            createUmdModule(\n+                      spec.contents.moduleName, spec.contents.dependencies,\n+                      spec.contents.factoryBody, spec.contents.additionalOptions),\n+      });\n+\n+      describe(`(when dealing with ${parenFormat})`, () => {\n         let PROGRAM: TestFile;\n         let PROGRAM_DECORATE_HELPER: TestFile;\n         let PROGRAM_WITH_GLOBAL_INITIALIZER: TestFile;\n@@ -235,8 +219,8 @@ typeof define === 'function' && define.amd ? define('file', ['exports','/tslib',\n                 file);\n             expect(output.toString())\n                 .toContain(\n-                    `typeof exports === 'object' && typeof module !== 'undefined' ? ` +\n-                    `factory(require('@angular/core'),require('@angular/common'),exports,require('some-side-effect'),require('/local-dep'),require('@angular/core')) :`);\n+                    `typeof exports === 'object' && typeof module !== 'undefined' ?\\n` +\n+                    `    factory(require('@angular/core'),require('@angular/common'),exports, require('some-side-effect'), require('/local-dep'), require('@angular/core')) :`);\n           });\n \n           it('should append the given imports into the AMD initialization', () => {\n@@ -253,7 +237,8 @@ typeof define === 'function' && define.amd ? define('file', ['exports','/tslib',\n                 file);\n             expect(output.toString())\n                 .toContain(\n-                    `typeof define === 'function' && define.amd ? define('file', ['@angular/core','@angular/common','exports','some-side-effect','/local-dep','@angular/core'], factory) :`);\n+                    `typeof define === 'function' && define.amd ?\\n` +\n+                    `    define('file', ['@angular/core','@angular/common','exports', 'some-side-effect', '/local-dep', '@angular/core'], factory) :`);\n           });\n \n           it('should append the given imports into the global initialization', () => {\n@@ -270,7 +255,7 @@ typeof define === 'function' && define.amd ? define('file', ['exports','/tslib',\n                 file);\n             expect(output.toString())\n                 .toContain(\n-                    `(factory(global.ng.core,global.ng.common,global.file,global.someSideEffect,global.localDep,global.ng.core));`);\n+                    `(factory(global.ng.core,global.ng.common,global.file, global.someSideEffect, global.localDep, global.ng.core));`);\n           });\n \n           it('should remap import identifiers to valid global properties', () => {\n@@ -293,7 +278,7 @@ typeof define === 'function' && define.amd ? define('file', ['exports','/tslib',\n                 .toContain(\n                     `(factory(` +\n                     `global.ngrx.store,global.ng.platformBrowserDynamic,global.ng.common.testing,global.angularFoo.package,` +\n-                    `global.file,global.someSideEffect,global.localDep,global.ng.core));`);\n+                    `global.file, global.someSideEffect, global.localDep, global.ng.core));`);\n           });\n \n           it('should append the given imports into the global initialization, if it has a global/self initializer',\n@@ -311,7 +296,7 @@ typeof define === 'function' && define.amd ? define('file', ['exports','/tslib',\n                    file);\n                expect(output.toString())\n                    .toContain(\n-                       `(global = global || self, factory(global.ng.core,global.ng.common,global.file,global.someSideEffect,global.localDep,global.ng.core));`);\n+                       `(global = global || self, factory(global.ng.core,global.ng.common,global.file, global.someSideEffect, global.localDep, global.ng.core))`);\n              });\n \n           it('should append the given imports as parameters into the factory function definition',\n@@ -329,24 +314,20 @@ typeof define === 'function' && define.amd ? define('file', ['exports','/tslib',\n                    file);\n                expect(output.toString())\n                    .toContain(\n-                       `(function (i0,i1,exports,someSideEffect,localDep,core) {'use strict';`);\n+                       `(function (i0,i1,exports, someSideEffect, localDep, core) {\\n  'use strict';`);\n              });\n \n           it('should handle the case where there were no prior imports nor exports', () => {\n             const PROGRAM = formatFactory({\n               name: _('/node_modules/test-package/some/file.js'),\n               contents: {\n-                preamble: `\n-                  /* A copyright notice */`,\n-                wrapperFunction: `function (global, factory) {\n-                    typeof exports === 'object' && typeof module !== 'undefined' ? factory() :\n-                    typeof define === 'function' && define.amd ? define('file', factory) :\n-                    (factory());\n-                  }`,\n-                wrapperCallArguments: `this, (function () {'use strict';\n+                preamble: '/* A copyright notice */',\n+                moduleName: 'file',\n+                dependencies: [],\n+                factoryBody: `\n                     var index = '';\n-                    return index;\n-                  })`,\n+                    return index;`,\n+                additionalOptions: {omitExports: true},\n               },\n             });\n             const {renderer, program} = setup(PROGRAM);\n@@ -363,11 +344,13 @@ typeof define === 'function' && define.amd ? define('file', ['exports','/tslib',\n             const outputSrc = output.toString();\n \n             expect(outputSrc).toContain(\n-                `typeof exports === 'object' && typeof module !== 'undefined' ? factory(require('@angular/core'),require('@angular/common')) :`);\n+                `typeof exports === 'object' && typeof module !== 'undefined' ?\\n` +\n+                `    factory(require('@angular/core'),require('@angular/common')) :`);\n             expect(outputSrc).toContain(\n-                `typeof define === 'function' && define.amd ? define('file',['@angular/core','@angular/common'], factory) :`);\n+                `typeof define === 'function' && define.amd ?\\n` +\n+                `    define('file',['@angular/core','@angular/common'], factory) :`);\n             expect(outputSrc).toContain(`(factory(global.ng.core,global.ng.common));`);\n-            expect(outputSrc).toContain(`(function (i0,i1) {'use strict';`);\n+            expect(outputSrc).toContain(`(function (i0,i1) {\\n  'use strict';`);\n           });\n \n           it('should leave the file unchanged if there are no imports to add', () => {\n@@ -390,14 +373,11 @@ typeof define === 'function' && define.amd ? define('file', ['exports','/tslib',\n                 preamble: `\n                   /* A copyright notice */\n                   /* A copyright notice */`,\n-                wrapperFunction: `function (global, factory) {\n-                    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports,require('/local-dep'),require('@angular/core'),require('some-side-effect')) :\n-                    typeof define === 'function' && define.amd ? define('file', ['exports','/local-dep','@angular/core','some-side-effect'], factory) :\n-                    (factory(global.file,global.localDep,global.ng.core,global.someSideEffect));\n-                  }`,\n-                wrapperCallArguments: `this, (function (exports,localDep,core) {'use strict';\n-                    // Note that someSideEffect is not in the factory function parameter list\n-                  })`,\n+                moduleName: 'file',\n+                dependencies: ['/local-dep', '@angular/core', 'some-side-effect'],\n+                factoryBody: `\n+                    // Note that someSideEffect is not in the factory function parameter list`,\n+                additionalOptions: {unusedDependencies: new Set(['some-side-effect'])},\n               },\n             });\n             const {renderer, program} = setup(PROGRAM);\n@@ -414,14 +394,15 @@ typeof define === 'function' && define.amd ? define('file', ['exports','/tslib',\n             const outputSrc = output.toString();\n \n             expect(outputSrc).toContain(\n-                `typeof exports === 'object' && typeof module !== 'undefined' ? ` +\n-                `factory(require('@angular/core'),require('@angular/common'),exports,require('/local-dep'),require('@angular/core'),require('some-side-effect')) :`);\n+                `typeof exports === 'object' && typeof module !== 'undefined' ?\\n` +\n+                `    factory(require('@angular/core'),require('@angular/common'),exports, require('/local-dep'), require('@angular/core'), require('some-side-effect')) :`);\n+            expect(outputSrc).toContain(\n+                `typeof define === 'function' && define.amd ?\\n` +\n+                `    define('file', ['@angular/core','@angular/common','exports', '/local-dep', '@angular/core', 'some-side-effect'], factory) :`);\n             expect(outputSrc).toContain(\n-                `typeof define === 'function' && define.amd ? define('file', ` +\n-                `['@angular/core','@angular/common','exports','/local-dep','@angular/core','some-side-effect'], factory) :`);\n+                `(factory(global.ng.core,global.ng.common,global.file, global.localDep, global.ng.core, global.someSideEffect));`);\n             expect(outputSrc).toContain(\n-                `(factory(global.ng.core,global.ng.common,global.file,global.localDep,global.ng.core,global.someSideEffect));`);\n-            expect(outputSrc).toContain(`(function (i0,i1,exports,localDep,core) {'use strict';`);\n+                `(function (i0,i1,exports, localDep, core) {\\n  'use strict';`);\n           });\n         });\n \n@@ -451,6 +432,7 @@ exports.ComponentA1 = i0.ComponentA1;\n exports.ComponentA2 = i0.ComponentA2;\n exports.ComponentB = i1.ComponentB;\n exports.TopLevelComponent = TopLevelComponent;\n+\n }))`);\n \n             expect(generateNamedImportSpy).toHaveBeenCalledWith('./a', 'ComponentA1');\n@@ -467,9 +449,11 @@ exports.TopLevelComponent = TopLevelComponent;\n             const output = new MagicString(PROGRAM.contents);\n             renderer.addConstants(output, 'var x = 3;', file);\n             expect(output.toString())\n-                .toContain(`(this, (function (exports,someSideEffect,localDep,core) {\n+                .toContain(`(this, (function (exports, someSideEffect, localDep, core) {\n+${'  '}\n var x = 3;\n 'use strict';\n+\n var A = (function() {`);\n           });\n \n@@ -523,13 +507,9 @@ SOME DEFINITION TEXT\n \n         describe('addAdjacentStatements', () => {\n           const contents: TestFileSpec['contents'] = {\n-            wrapperFunction: `function (global, factory) {\\n` +\n-                `  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports,require('tslib'),require('@angular/core')) :\\n` +\n-                `  typeof define === 'function' && define.amd ? define('file', ['exports','/tslib','@angular/core'], factory) :\\n` +\n-                `  (factory(global.file,global.tslib,global.ng.core));\\n` +\n-                `  }`,\n-            wrapperCallArguments: `this, (function (exports,tslib,core) {'use strict';\\n` +\n-                `\\n` +\n+            moduleName: 'file',\n+            dependencies: ['/tslib', '@angular/core'],\n+            factoryBody: `\\n` +\n                 `  var SomeDirective = /** @class **/ (function () {\\n` +\n                 `    function SomeDirective(zone, cons) {}\\n` +\n                 `    SomeDirective.prototype.method = function() {}\\n` +\n@@ -543,8 +523,7 @@ SOME DEFINITION TEXT\n                 `    ]; };\\n` +\n                 `    return SomeDirective;\\n` +\n                 `  }());\\n` +\n-                `  exports.SomeDirective = SomeDirective;\\n` +\n-                `})`,\n+                `  exports.SomeDirective = SomeDirective;\\n`,\n           };\n \n           it('should insert the statements after all the static methods of the class', () => {"
        }
    ],
    "stats": {
        "total": 366,
        "additions": 208,
        "deletions": 158
    }
}