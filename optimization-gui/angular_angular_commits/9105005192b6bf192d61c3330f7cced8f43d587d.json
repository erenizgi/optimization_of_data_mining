{
    "author": "martinsik",
    "message": "refactor(router): refactor and simplify router RxJS chains (#40290)\n\nRefactor and simplifiy RxJS usage in the router package\nin order to reduce its size and increase performance.\n\nPR Close #40290",
    "sha": "9105005192b6bf192d61c3330f7cced8f43d587d",
    "files": [
        {
            "sha": "46a2dcb8e0dd6d47bc279d6c4bddb0a436f87cac",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -66,4 +66,4 @@\n       }\n     }\n   }\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "fb4ba73571dbfdf72d5541ccf5749175c9925241",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -1238,12 +1238,6 @@\n   {\n     \"name\": \"findPath\"\n   },\n-  {\n-    \"name\": \"fireActivationStart\"\n-  },\n-  {\n-    \"name\": \"fireChildActivationStart\"\n-  },\n   {\n     \"name\": \"first\"\n   },\n@@ -1832,12 +1826,6 @@\n   {\n     \"name\": \"routerNgProbeToken\"\n   },\n-  {\n-    \"name\": \"runCanActivate\"\n-  },\n-  {\n-    \"name\": \"runCanActivateChild\"\n-  },\n   {\n     \"name\": \"rxSubscriber\"\n   },"
        },
        {
            "sha": "0d4d06bfbb3c79d22cfb26bbb34bf401f792f0dc",
            "filename": "packages/router/src/directives/router_link_active.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -105,12 +105,10 @@ export class RouterLinkActive implements OnChanges, OnDestroy, AfterContentInit\n   /** @nodoc */\n   ngAfterContentInit(): void {\n     // `of(null)` is used to force subscribe body to execute once immediately (like `startWith`).\n-    from([this.links.changes, this.linksWithHrefs.changes, of(null)])\n-        .pipe(mergeAll())\n-        .subscribe(_ => {\n-          this.update();\n-          this.subscribeToEachLinkOnChanges();\n-        });\n+    of(this.links.changes, this.linksWithHrefs.changes, of(null)).pipe(mergeAll()).subscribe(_ => {\n+      this.update();\n+      this.subscribeToEachLinkOnChanges();\n+    });\n   }\n \n   private subscribeToEachLinkOnChanges() {"
        },
        {
            "sha": "6600abdfb45f73aee2c16c0a01fc3185fc66b7f0",
            "filename": "packages/router/src/operators/apply_redirects.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Fapply_redirects.ts",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Fapply_redirects.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Foperators%2Fapply_redirects.ts?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {Injector} from '@angular/core';\n-import {MonoTypeOperatorFunction, Observable} from 'rxjs';\n+import {MonoTypeOperatorFunction} from 'rxjs';\n import {map, switchMap} from 'rxjs/operators';\n \n import {applyRedirects as applyRedirectsFn} from '../apply_redirects';\n@@ -19,9 +19,7 @@ import {UrlSerializer} from '../url_tree';\n export function applyRedirects(\n     moduleInjector: Injector, configLoader: RouterConfigLoader, urlSerializer: UrlSerializer,\n     config: Routes): MonoTypeOperatorFunction<NavigationTransition> {\n-  return function(source: Observable<NavigationTransition>) {\n-    return source.pipe(switchMap(\n-        t => applyRedirectsFn(moduleInjector, configLoader, urlSerializer, t.extractedUrl, config)\n-                 .pipe(map(urlAfterRedirects => ({...t, urlAfterRedirects})))));\n-  };\n+  return switchMap(\n+      t => applyRedirectsFn(moduleInjector, configLoader, urlSerializer, t.extractedUrl, config)\n+               .pipe(map(urlAfterRedirects => ({...t, urlAfterRedirects}))));\n }"
        },
        {
            "sha": "adee8059054f87876a5abef1785709b943e8dd45",
            "filename": "packages/router/src/operators/check_guards.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 29,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Fcheck_guards.ts",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Fcheck_guards.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Foperators%2Fcheck_guards.ts?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -7,8 +7,8 @@\n  */\n \n import {Injector} from '@angular/core';\n-import {defer, from, MonoTypeOperatorFunction, Observable, of} from 'rxjs';\n-import {concatAll, concatMap, first, map, mergeMap} from 'rxjs/operators';\n+import {concat, defer, from, MonoTypeOperatorFunction, Observable, of} from 'rxjs';\n+import {concatMap, first, map, mergeMap} from 'rxjs/operators';\n \n import {ActivationStart, ChildActivationStart, Event} from '../events';\n import {CanActivateChildFn, CanActivateFn, CanDeactivateFn} from '../interfaces';\n@@ -23,25 +23,23 @@ import {prioritizedGuardValue} from './prioritized_guard_value';\n \n export function checkGuards(moduleInjector: Injector, forwardEvent?: (evt: Event) => void):\n     MonoTypeOperatorFunction<NavigationTransition> {\n-  return function(source: Observable<NavigationTransition>) {\n-    return source.pipe(mergeMap(t => {\n-      const {targetSnapshot, currentSnapshot, guards: {canActivateChecks, canDeactivateChecks}} = t;\n-      if (canDeactivateChecks.length === 0 && canActivateChecks.length === 0) {\n-        return of({...t, guardsResult: true});\n-      }\n+  return mergeMap(t => {\n+    const {targetSnapshot, currentSnapshot, guards: {canActivateChecks, canDeactivateChecks}} = t;\n+    if (canDeactivateChecks.length === 0 && canActivateChecks.length === 0) {\n+      return of({...t, guardsResult: true});\n+    }\n \n-      return runCanDeactivateChecks(\n-                 canDeactivateChecks, targetSnapshot!, currentSnapshot, moduleInjector)\n-          .pipe(\n-              mergeMap(canDeactivate => {\n-                return canDeactivate && isBoolean(canDeactivate) ?\n-                    runCanActivateChecks(\n-                        targetSnapshot!, canActivateChecks, moduleInjector, forwardEvent) :\n-                    of(canDeactivate);\n-              }),\n-              map(guardsResult => ({...t, guardsResult})));\n-    }));\n-  };\n+    return runCanDeactivateChecks(\n+               canDeactivateChecks, targetSnapshot!, currentSnapshot, moduleInjector)\n+        .pipe(\n+            mergeMap(canDeactivate => {\n+              return canDeactivate && isBoolean(canDeactivate) ?\n+                  runCanActivateChecks(\n+                      targetSnapshot!, canActivateChecks, moduleInjector, forwardEvent) :\n+                  of(canDeactivate);\n+            }),\n+            map(guardsResult => ({...t, guardsResult})));\n+  });\n }\n \n function runCanDeactivateChecks(\n@@ -61,15 +59,11 @@ function runCanActivateChecks(\n     forwardEvent?: (evt: Event) => void) {\n   return from(checks).pipe(\n       concatMap((check: CanActivate) => {\n-        return from([\n-                 fireChildActivationStart(check.route.parent, forwardEvent),\n-                 fireActivationStart(check.route, forwardEvent),\n-                 runCanActivateChild(futureSnapshot, check.path, moduleInjector),\n-                 runCanActivate(futureSnapshot, check.route, moduleInjector)\n-               ])\n-            .pipe(concatAll(), first(result => {\n-                    return result !== true;\n-                  }, true as boolean | UrlTree));\n+        return concat(\n+            fireChildActivationStart(check.route.parent, forwardEvent),\n+            fireActivationStart(check.route, forwardEvent),\n+            runCanActivateChild(futureSnapshot, check.path, moduleInjector),\n+            runCanActivate(futureSnapshot, check.route, moduleInjector));\n       }),\n       first(result => {\n         return result !== true;"
        },
        {
            "sha": "2334841c1196e32e7d9c6ea75c8c9620d2c34960",
            "filename": "packages/router/src/operators/prioritized_guard_value.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Fprioritized_guard_value.ts",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Fprioritized_guard_value.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Foperators%2Fprioritized_guard_value.ts?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -18,8 +18,7 @@ declare type INTERIM_VALUES = typeof INITIAL_VALUE | boolean | UrlTree;\n export function prioritizedGuardValue():\n     OperatorFunction<Observable<boolean|UrlTree>[], boolean|UrlTree> {\n   return switchMap(obs => {\n-    return combineLatest(\n-               ...obs.map(o => o.pipe(take(1), startWith(INITIAL_VALUE as INTERIM_VALUES))))\n+    return combineLatest(obs.map(o => o.pipe(take(1), startWith(INITIAL_VALUE as INTERIM_VALUES))))\n                .pipe(\n                    scan(\n                        (acc: INTERIM_VALUES, list: INTERIM_VALUES[]) => {"
        },
        {
            "sha": "1a82f3921f35ea8475f26712fc2e8d8483ade980",
            "filename": "packages/router/src/operators/recognize.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Frecognize.ts",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Frecognize.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Foperators%2Frecognize.ts?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {Type} from '@angular/core';\n-import {MonoTypeOperatorFunction, Observable} from 'rxjs';\n+import {MonoTypeOperatorFunction} from 'rxjs';\n import {map, mergeMap} from 'rxjs/operators';\n \n import {Route} from '../config';\n@@ -19,11 +19,9 @@ export function recognize(\n     rootComponentType: Type<any>|null, config: Route[], serializer: (url: UrlTree) => string,\n     paramsInheritanceStrategy: 'emptyOnly'|'always',\n     relativeLinkResolution: 'legacy'|'corrected'): MonoTypeOperatorFunction<NavigationTransition> {\n-  return function(source: Observable<NavigationTransition>) {\n-    return source.pipe(mergeMap(\n-        t => recognizeFn(\n-                 rootComponentType, config, t.urlAfterRedirects, serializer(t.urlAfterRedirects),\n-                 paramsInheritanceStrategy, relativeLinkResolution)\n-                 .pipe(map(targetSnapshot => ({...t, targetSnapshot})))));\n-  };\n+  return mergeMap(\n+      t => recognizeFn(\n+               rootComponentType, config, t.urlAfterRedirects, serializer(t.urlAfterRedirects),\n+               paramsInheritanceStrategy, relativeLinkResolution)\n+               .pipe(map(targetSnapshot => ({...t, targetSnapshot}))));\n }"
        },
        {
            "sha": "9fcc9f7c378c4b58cd467575ccbe866098a7badd",
            "filename": "packages/router/src/operators/resolve_data.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 18,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Fresolve_data.ts",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Fresolve_data.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Foperators%2Fresolve_data.ts?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -19,25 +19,23 @@ import {getToken} from '../utils/preactivation';\n export function resolveData(\n     paramsInheritanceStrategy: 'emptyOnly'|'always',\n     moduleInjector: Injector): MonoTypeOperatorFunction<NavigationTransition> {\n-  return function(source: Observable<NavigationTransition>) {\n-    return source.pipe(mergeMap(t => {\n-      const {targetSnapshot, guards: {canActivateChecks}} = t;\n+  return mergeMap(t => {\n+    const {targetSnapshot, guards: {canActivateChecks}} = t;\n \n-      if (!canActivateChecks.length) {\n-        return of(t);\n-      }\n-      let canActivateChecksResolved = 0;\n-      return from(canActivateChecks)\n-          .pipe(\n-              concatMap(\n-                  check => runResolve(\n-                      check.route, targetSnapshot!, paramsInheritanceStrategy, moduleInjector)),\n-              tap(() => canActivateChecksResolved++),\n-              takeLast(1),\n-              mergeMap(_ => canActivateChecksResolved === canActivateChecks.length ? of(t) : EMPTY),\n-          );\n-    }));\n-  };\n+    if (!canActivateChecks.length) {\n+      return of(t);\n+    }\n+    let canActivateChecksResolved = 0;\n+    return from(canActivateChecks)\n+        .pipe(\n+            concatMap(\n+                check => runResolve(\n+                    check.route, targetSnapshot!, paramsInheritanceStrategy, moduleInjector)),\n+            tap(() => canActivateChecksResolved++),\n+            takeLast(1),\n+            mergeMap(_ => canActivateChecksResolved === canActivateChecks.length ? of(t) : EMPTY),\n+        );\n+  });\n }\n \n function runResolve("
        },
        {
            "sha": "cd53a02e5532a03a896090be9f556aba687c27be",
            "filename": "packages/router/src/operators/switch_tap.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 10,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Fswitch_tap.ts",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Foperators%2Fswitch_tap.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Foperators%2Fswitch_tap.ts?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {from, MonoTypeOperatorFunction, ObservableInput} from 'rxjs';\n+import {from, MonoTypeOperatorFunction, ObservableInput, of} from 'rxjs';\n import {map, switchMap} from 'rxjs/operators';\n \n /**\n@@ -17,13 +17,11 @@ import {map, switchMap} from 'rxjs/operators';\n  */\n export function switchTap<T>(next: (x: T) => void|ObservableInput<any>):\n     MonoTypeOperatorFunction<T> {\n-  return function(source) {\n-    return source.pipe(switchMap(v => {\n-      const nextResult = next(v);\n-      if (nextResult) {\n-        return from(nextResult).pipe(map(() => v));\n-      }\n-      return from([v]);\n-    }));\n-  };\n+  return switchMap(v => {\n+    const nextResult = next(v);\n+    if (nextResult) {\n+      return from(nextResult).pipe(map(() => v));\n+    }\n+    return of(v);\n+  });\n }"
        },
        {
            "sha": "da374c3f6eb3015fbcb6adbd0542748e5fad953c",
            "filename": "packages/router/src/router.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 11,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Frouter.ts",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter.ts?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -573,12 +573,11 @@ export class Router {\n                                if (transition !== this.transitions.getValue()) {\n                                  return EMPTY;\n                                }\n-                               return [t];\n-                             }),\n \n-                             // This delay is required to match old behavior that forced navigation\n-                             // to always be async\n-                             switchMap(t => Promise.resolve(t)),\n+                               // This delay is required to match old behavior that forced\n+                               // navigation to always be async\n+                               return Promise.resolve(t);\n+                             }),\n \n                              // ApplyRedirects\n                              applyRedirects(\n@@ -609,10 +608,8 @@ export class Router {\n                                  }\n                                  this.browserUrlTree = t.urlAfterRedirects;\n                                }\n-                             }),\n \n-                             // Fire RoutesRecognized\n-                             tap(t => {\n+                               // Fire RoutesRecognized\n                                const routesRecognized = new RoutesRecognized(\n                                    t.id, this.serializeUrl(t.extractedUrl),\n                                    this.serializeUrl(t.urlAfterRedirects), t.targetSnapshot!);\n@@ -692,9 +689,7 @@ export class Router {\n                          error.url = t.guardsResult;\n                          throw error;\n                        }\n-                     }),\n \n-                     tap(t => {\n                        const guardsEnd = new GuardsCheckEnd(\n                            t.id, this.serializeUrl(t.extractedUrl),\n                            this.serializeUrl(t.urlAfterRedirects), t.targetSnapshot!,\n@@ -875,7 +870,7 @@ export class Router {\n                                replaceUrl: this.urlUpdateStrategy === 'eager'\n                              };\n \n-                             return this.scheduleNavigation(\n+                             this.scheduleNavigation(\n                                  mergedTree, 'imperative', null, extras,\n                                  {resolve: t.resolve, reject: t.reject, promise: t.promise});\n                            }, 0);"
        },
        {
            "sha": "768a0f19a4a09ab368aa42428171554559894ab1",
            "filename": "packages/router/src/utils/collection.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Futils%2Fcollection.ts",
            "raw_url": "https://github.com/angular/angular/raw/9105005192b6bf192d61c3330f7cced8f43d587d/packages%2Frouter%2Fsrc%2Futils%2Fcollection.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Futils%2Fcollection.ts?ref=9105005192b6bf192d61c3330f7cced8f43d587d",
            "patch": "@@ -8,9 +8,8 @@\n \n import {ɵisObservable as isObservable, ɵisPromise as isPromise} from '@angular/core';\n import {from, Observable, of} from 'rxjs';\n-import {concatAll, last as lastValue, map} from 'rxjs/operators';\n \n-import {Params, PRIMARY_OUTLET} from '../shared';\n+import {Params} from '../shared';\n \n export function shallowEqualArrays(a: any[], b: any[]): boolean {\n   if (a.length !== b.length) return false;"
        }
    ],
    "stats": {
        "total": 175,
        "additions": 70,
        "deletions": 105
    }
}