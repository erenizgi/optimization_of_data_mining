{
    "author": "petebacondarwin",
    "message": "fix(ngcc): handle aliases in UMD export declarations (#38959)\n\nSometimes UMD exports appear in the following form:\n\n```\nexports.MyClass = alias1 = alias2 = <<declaration>>\n```\n\nPreviously the declaration of the export would have been captured\nas `alias1 = alias2 = <<declaration>>`, which the `PartialInterpreter`\nwould have failed on, since it cannot handle assignments.\n\nNow we skip over these aliases capturing only the `<<declaration>>`\nexpression.\n\nFixes #38947\n\nPR Close #38959",
    "sha": "5038e5741bf154dd7e86d4c665f878bd9e5ed78b",
    "files": [
        {
            "sha": "704114cae250a180e682f4e66414965cc323040c",
            "filename": "packages/compiler-cli/ngcc/src/host/esm2015_host.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/5038e5741bf154dd7e86d4c665f878bd9e5ed78b/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/5038e5741bf154dd7e86d4c665f878bd9e5ed78b/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts?ref=5038e5741bf154dd7e86d4c665f878bd9e5ed78b",
            "patch": "@@ -2311,7 +2311,7 @@ function isInitializedVariableClassDeclaration(node: ts.Node):\n  * var MyClass = alias1 = alias2 = <<declaration>>\n  * ```\n  *\n- * @node the LHS of a variable declaration.\n+ * @param node the LHS of a variable declaration.\n  * @returns the original AST node or the RHS of a series of assignments in a variable\n  *     declaration.\n  */"
        },
        {
            "sha": "e3a0965c9e8310d770e938f4354b9d038dd8c718",
            "filename": "packages/compiler-cli/ngcc/src/host/umd_host.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/5038e5741bf154dd7e86d4c665f878bd9e5ed78b/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/5038e5741bf154dd7e86d4c665f878bd9e5ed78b/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts?ref=5038e5741bf154dd7e86d4c665f878bd9e5ed78b",
            "patch": "@@ -15,6 +15,7 @@ import {BundleProgram} from '../packages/bundle_program';\n import {FactoryMap, getTsHelperFnFromIdentifier, stripExtension} from '../utils';\n \n import {DefinePropertyReexportStatement, ExportDeclaration, ExportsStatement, extractGetterFnExpression, findNamespaceOfIdentifier, findRequireCallReference, isDefinePropertyReexportStatement, isExportsStatement, isExternalImport, isRequireCall, isWildcardReexportStatement, WildcardReexportStatement} from './commonjs_umd_utils';\n+import {isAssignment} from './esm2015_host';\n import {Esm5ReflectionHost} from './esm5_host';\n import {stripParentheses} from './utils';\n \n@@ -134,7 +135,7 @@ export class UmdReflectionHost extends Esm5ReflectionHost {\n \n   private extractBasicUmdExportDeclaration(statement: ExportsStatement): ExportDeclaration {\n     const name = statement.expression.left.name.text;\n-    const exportExpression = statement.expression.right;\n+    const exportExpression = skipAliases(statement.expression.right);\n     return this.extractUmdExportDeclaration(name, exportExpression);\n   }\n \n@@ -400,3 +401,20 @@ function getRequiredModulePath(wrapperFn: ts.FunctionExpression, paramIndex: num\n export function isExportIdentifier(node: ts.Node): node is ts.Identifier {\n   return ts.isIdentifier(node) && node.text === 'exports';\n }\n+\n+/**\n+ * Find the far right hand side of a sequence of aliased assignements of the form\n+ *\n+ * ```\n+ * exports.MyClass = alias1 = alias2 = <<declaration>>\n+ * ```\n+ *\n+ * @param node the expression to parse\n+ * @returns the original `node` or the far right expression of a series of assignments.\n+ */\n+export function skipAliases(node: ts.Expression): ts.Expression {\n+  while (isAssignment(node)) {\n+    node = node.right;\n+  }\n+  return node;\n+}"
        },
        {
            "sha": "78a0fffd5e06194946e758dc99cf27c9c1b2076a",
            "filename": "packages/compiler-cli/ngcc/test/host/umd_host_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/5038e5741bf154dd7e86d4c665f878bd9e5ed78b/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5038e5741bf154dd7e86d4c665f878bd9e5ed78b/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts?ref=5038e5741bf154dd7e86d4c665f878bd9e5ed78b",
            "patch": "@@ -638,7 +638,8 @@ runInEachFileSystem(() => {\n               `  exports.d = b;\\n` +\n               `  exports.e = e;\\n` +\n               `  exports.DirectiveX = core.Directive;\\n` +\n-              `  exports.SomeClass = SomeClass;\\n` +\n+              `  var SomeClass_1;\\n` +\n+              `  exports.SomeClass = SomeClass_1 = SomeClass;\\n` +\n               `})));\\n`,\n         },\n         {"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 22,
        "deletions": 3
    }
}