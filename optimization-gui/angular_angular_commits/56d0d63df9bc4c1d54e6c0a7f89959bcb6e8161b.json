{
    "author": "devversion",
    "message": "refactor(bazel): only deal with a single `dts` bundle per `ng_module` target (#43431)\n\nPreviously, `ng_module` generated a second `d.ts` bundle in case the\nbuilt target was the Angular core target. This was done so that the\npackager later on can ship the `r3_symbols.d.ts` file along with the\nAPF v13 output. Ngcc relied on this file when it processed the Angular\ncore package. This is no longer needed for Angular Core v13 since it\nwill come as partially-compiled without the need for ngcc.\n\nThe major benefit of no longer generating multiple dts files here is\nthat we can reasonably pass the bundle through a provider to the packager\nwhich can then use this for determining the `d.ts` file it should link\nin the `package.json`.\n\nThis is beneficial and needed for using a transition since the packager\ninput files are no longer in the default `bazel-out`, so it's important\nto keep an reference to the actual Bazel `<File>` instance, allowing\nus to determine the path properly in the packager (without any\nassumptions on the `bazel-out` path..).\n\nPR Close #43431",
    "sha": "56d0d63df9bc4c1d54e6c0a7f89959bcb6e8161b",
    "files": [
        {
            "sha": "0c72291100f11f1e3f54fbb72cbbdcd7e80c4913",
            "filename": "packages/bazel/src/ng_module/ng_module.bzl",
            "status": "modified",
            "additions": 15,
            "deletions": 42,
            "changes": 57,
            "blob_url": "https://github.com/angular/angular/blob/56d0d63df9bc4c1d54e6c0a7f89959bcb6e8161b/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl",
            "raw_url": "https://github.com/angular/angular/raw/56d0d63df9bc4c1d54e6c0a7f89959bcb6e8161b/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl?ref=56d0d63df9bc4c1d54e6c0a7f89959bcb6e8161b",
            "patch": "@@ -32,7 +32,6 @@ load(\n NgPerfInfo = provider(fields = [\"enable_perf_logging\"])\n \n _FLAT_DTS_FILE_SUFFIX = \".bundle.d.ts\"\n-_R3_SYMBOLS_DTS_FILE = \"src/r3_symbols.d.ts\"\n \n def is_perf_requested(ctx):\n     enable_perf_logging = ctx.attr.perf_flag != None and ctx.attr.perf_flag[NgPerfInfo].enable_perf_logging == True\n@@ -92,7 +91,6 @@ def _compiler_name(ctx):\n     Returns:\n       The name of the current compiler to be displayed in build output\n     \"\"\"\n-\n     return \"Ivy\" if is_ivy_enabled(ctx) else \"ViewEngine\"\n \n def _get_ivy_compilation_mode(ctx):\n@@ -155,25 +153,6 @@ def _should_produce_dts_bundle(ctx):\n     \"\"\"\n     return getattr(ctx.attr, \"bundle_dts\", False)\n \n-def _should_produce_r3_symbols_bundle(ctx):\n-    \"\"\"Should we produce r3_symbols bundle.\n-\n-    NGCC relies on having r3_symbols file. This file is located in @angular/core\n-    And should only be included when bundling core in legacy mode.\n-\n-    Args:\n-      ctx: skylark rule execution context\n-\n-    Returns:\n-      true when we should produce r3_symbols dts.\n-    \"\"\"\n-\n-    # iif we are compiling @angular/core with ngc we should add this addition dts bundle\n-    # because ngcc relies on having this file.\n-    # see: https://github.com/angular/angular/blob/84406e4d6d93b28b23efbb1701bc5ae1084da67b/packages/compiler-cli/src/ngcc/src/packages/entry_point_bundle.ts#L56\n-    # todo: alan-agius4: remove when ngcc doesn't need this anymore\n-    return _is_view_engine_enabled(ctx) and ctx.attr.module_name == \"@angular/core\"\n-\n def _should_produce_flat_module_outs(ctx):\n     \"\"\"Should we produce flat module outputs.\n \n@@ -264,16 +243,13 @@ def _expected_outs(ctx):\n         if not _is_bazel():\n             metadata_files += [ctx.actions.declare_file(basename + ext) for ext in metadata]\n \n-    dts_bundles = None\n+    dts_bundle = None\n     if _should_produce_dts_bundle(ctx):\n         # We need to add a suffix to bundle as it might collide with the flat module dts.\n         # The flat module dts out contains several other exports\n         # https://github.com/angular/angular/blob/84406e4d6d93b28b23efbb1701bc5ae1084da67b/packages/compiler-cli/src/metadata/index_writer.ts#L18\n         # the file name will be like 'core.bundle.d.ts'\n-        dts_bundles = [ctx.actions.declare_file(ctx.label.name + _FLAT_DTS_FILE_SUFFIX)]\n-\n-        if _should_produce_r3_symbols_bundle(ctx):\n-            dts_bundles.append(ctx.actions.declare_file(_R3_SYMBOLS_DTS_FILE.replace(\".d.ts\", _FLAT_DTS_FILE_SUFFIX)))\n+        dts_bundle = ctx.actions.declare_file(ctx.label.name + _FLAT_DTS_FILE_SUFFIX)\n \n     # We do this just when producing a flat module index for a publishable ng_module\n     if _should_produce_flat_module_outs(ctx):\n@@ -313,7 +289,7 @@ def _expected_outs(ctx):\n         transpilation_infos = transpilation_infos,\n         summaries = summary_files,\n         metadata = metadata_files,\n-        dts_bundles = dts_bundles,\n+        dts_bundle = dts_bundle,\n         bundle_index_typings = bundle_index_typings,\n         i18n_messages = i18n_messages_files,\n         dev_perf_files = dev_perf_files,\n@@ -454,7 +430,7 @@ def ngc_compile_action(\n         node_opts,\n         locale = None,\n         i18n_args = [],\n-        dts_bundles_out = None,\n+        dts_bundle_out = None,\n         target_flavor = \"prodmode\"):\n     \"\"\"Helper function to create the ngc action.\n \n@@ -471,7 +447,7 @@ def ngc_compile_action(\n       node_opts: list of strings, extra nodejs options.\n       locale: i18n locale, or None\n       i18n_args: additional command-line arguments to ngc\n-      dts_bundles_out: produced flattened dts file\n+      dts_bundle_out: produced flattened dts file\n       target_flavor: Whether prodmode or devmode output is being built.\n \n     Returns:\n@@ -543,28 +519,25 @@ def ngc_compile_action(\n             mnemonic = \"Angular2MessageExtractor\",\n         )\n \n-    if dts_bundles_out != None:\n+    if dts_bundle_out != None:\n         # combine the inputs and outputs and filter .d.ts and json files\n         filter_inputs = [f for f in inputs.to_list() + outputs if f.path.endswith(\".d.ts\") or f.path.endswith(\".json\")]\n \n         if _should_produce_flat_module_outs(ctx):\n-            dts_entry_points = [\"%s.d.ts\" % _flat_module_out_file(ctx)]\n+            dts_entry_point = \"%s.d.ts\" % _flat_module_out_file(ctx)\n         else:\n-            dts_entry_points = [ctx.attr.entry_point.label.name.replace(\".ts\", \".d.ts\")]\n-\n-        if _should_produce_r3_symbols_bundle(ctx):\n-            dts_entry_points.append(_R3_SYMBOLS_DTS_FILE)\n+            dts_entry_point = ctx.attr.entry_point.label.name.replace(\".ts\", \".d.ts\")\n \n         ctx.actions.run(\n-            progress_message = \"Bundling DTS (%s) %s\" % (compile_mode, str(ctx.label)),\n+            progress_message = \"Bundling DTS (%s) %s\" % (target_flavor, str(ctx.label)),\n             mnemonic = \"APIExtractor\",\n             executable = ctx.executable.api_extractor,\n             inputs = filter_inputs,\n-            outputs = dts_bundles_out,\n+            outputs = [dts_bundle_out],\n             arguments = [\n                 tsconfig_file.path,\n-                \",\".join([\"/\".join([ctx.bin_dir.path, ctx.label.package, f]) for f in dts_entry_points]),\n-                \",\".join([f.path for f in dts_bundles_out]),\n+                \"/\".join([ctx.bin_dir.path, ctx.label.package, dts_entry_point]),\n+                dts_bundle_out.path,\n             ],\n         )\n \n@@ -592,7 +565,7 @@ def _compile_action(\n         ctx,\n         inputs,\n         outputs,\n-        dts_bundles_out,\n+        dts_bundle_out,\n         messages_out,\n         perf_out,\n         tsconfig_file,\n@@ -701,8 +674,8 @@ def ng_module_impl(ctx, ts_compile_actions):\n             flat_module_out_file = _flat_module_out_file(ctx),\n         )\n \n-    if outs.dts_bundles != None:\n-        providers[\"dts_bundles\"] = outs.dts_bundles\n+    if outs.dts_bundle != None:\n+        providers[\"dts_bundle\"] = outs.dts_bundle\n \n     return providers\n "
        }
    ],
    "stats": {
        "total": 57,
        "additions": 15,
        "deletions": 42
    }
}