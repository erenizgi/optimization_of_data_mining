{
    "author": "petebacondarwin",
    "message": "test(compiler-cli): improve compliance test compile mode filtering (#39939)\n\nPreviously one could set a flag in a `TEST_CASES.json` file to exclude\nthe test-cases from being run if the input files were being compiled\npartially and then linked.\n\nThere are also scenarios where one might want to exclude test-cases\nfrom \"full compile\" mode test runs.\n\nThis commit changes the compliance test tooling to support a new\nproperty `compilationModeFilter`, which is an array containing one or\nmore of `\"full compile\"` and `\"linked compile\"`. Only the tests\nwhose `compilationModeFilter` array contains the current compilation\nmode will be run.\n\nPR Close #39939",
    "sha": "09ba30ef2960f2b4394e13d776ca3921e670f457",
    "files": [
        {
            "sha": "f7124d851aa1ce14efc09e5fc74d44cd6946f842",
            "filename": "packages/compiler-cli/test/compliance/README.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2FREADME.md?ref=09ba30ef2960f2b4394e13d776ca3921e670f457",
            "patch": "@@ -38,7 +38,7 @@ Each test-case can specify:\n * A `description` of the test.\n * The `inputFiles` that will be compiled.\n * Additional `compilerOptions` and `angularCompilerOptions` that are passed to the compiler.\n-* Whether to exclude this test-case from partial compilation tests (`excludeFromPartialTests`).\n+* Whether to exclude this test-case from certain tests running under certain compilation modes (`compilationModeFilter`).\n * A collection of `expectations` definitions that will be checked against the generated files.\n \n Note that there is a JSON schema for the `TEST_CASES.json` file stored at `test_cases/test_case_schema.json`."
        },
        {
            "sha": "d5cdbb80cf6738197843cd8646be3baa61e5c4cf",
            "filename": "packages/compiler-cli/test/compliance/linked/linked_compile_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts?ref=09ba30ef2960f2b4394e13d776ca3921e670f457",
            "patch": "@@ -14,7 +14,7 @@ import {ComplianceTest} from '../test_helpers/get_compliance_tests';\n import {parseGoldenPartial} from '../test_helpers/golden_partials';\n import {runTests} from '../test_helpers/test_runner';\n \n-runTests('partial compile + link', linkPartials);\n+runTests('linked compile', linkPartials);\n \n /**\n  * Link all the partials specified in the given `test`."
        },
        {
            "sha": "e21aaad044dffe3969199b4ea82bde7aeb79da73",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/TEST_CASES.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FTEST_CASES.json?ref=09ba30ef2960f2b4394e13d776ca3921e670f457",
            "patch": "@@ -135,7 +135,9 @@\n       \"compilerOptions\": {\n         \"target\": \"ES5\"\n       },\n-      \"excludeFromPartialTests\": true,\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n       \"expectations\": [\n         {\n           \"failureMessage\": \"Incorrect setClassMetadata call\","
        },
        {
            "sha": "ef9628442d7d29ff782d2e5eca32066ce0f917ce",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/errors/TEST_CASES.json",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2FTEST_CASES.json?ref=09ba30ef2960f2b4394e13d776ca3921e670f457",
            "patch": "@@ -6,7 +6,9 @@\n       \"inputFiles\": [\n         \"nested_i18n_msg.ts\"\n       ],\n-      \"excludeFromPartialTests\": true,\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n       \"expectations\": [\n         {\n           \"expectedErrors\": [\n@@ -23,7 +25,9 @@\n       \"inputFiles\": [\n         \"nested_i18n_msg_with_tags.ts\"\n       ],\n-      \"excludeFromPartialTests\": true,\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n       \"expectations\": [\n         {\n           \"expectedErrors\": [\n@@ -40,7 +44,9 @@\n       \"inputFiles\": [\n         \"nested_i18n_msg_with_ng-containers.ts\"\n       ],\n-      \"excludeFromPartialTests\": true,\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n       \"expectations\": [\n         {\n           \"expectedErrors\": ["
        },
        {
            "sha": "b55b5610880c6bc704f8b648a4b0b47dc4797dde",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/es5_support/TEST_CASES.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fes5_support%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fes5_support%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fes5_support%2FTEST_CASES.json?ref=09ba30ef2960f2b4394e13d776ca3921e670f457",
            "patch": "@@ -6,7 +6,9 @@\n       \"compilerOptions\": {\n         \"target\": \"ES5\"\n       },\n-      \"excludeFromPartialTests\": true,\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n       \"expectations\": [\n         {\n           \"extraChecks\": ["
        },
        {
            "sha": "60b2540ba39c4eb7776e2c8c87578ead9d97819d",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_styling/invalid/TEST_CASES.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_styling%2Finvalid%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_styling%2Finvalid%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_styling%2Finvalid%2FTEST_CASES.json?ref=09ba30ef2960f2b4394e13d776ca3921e670f457",
            "patch": "@@ -15,7 +15,9 @@\n           ]\n         }\n       ],\n-      \"excludeFromPartialTests\": true\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ]\n     }\n   ]\n }"
        },
        {
            "sha": "f6f30e1ffeec77a83f8df195f174fe4d0a0470f3",
            "filename": "packages/compiler-cli/test/compliance/test_cases/test_case_schema.json",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Ftest_case_schema.json",
            "raw_url": "https://github.com/angular/angular/raw/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Ftest_case_schema.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Ftest_case_schema.json?ref=09ba30ef2960f2b4394e13d776ca3921e670f457",
            "patch": "@@ -20,10 +20,20 @@\n             \"description\": \"This will be used as the message in an `it()` clause.\",\n             \"type\": \"string\"\n           },\n-          \"excludeFromPartialTests\": {\n-            \"title\": \"If set to true then do not check this test-case expectations in partial tests.\",\n-            \"type\": \"boolean\",\n-            \"default\": false\n+          \"compilationModeFilter\": {\n+            \"title\": \"An array of compilation modes under which this test-case should be run.\",\n+            \"type\": \"array\",\n+            \"items\": {\n+              \"type\": \"string\",\n+              \"enum\": [\n+                \"full compile\",\n+                \"linked compile\"\n+              ]\n+            },\n+            \"default\": [\n+              \"full compile\",\n+              \"linked compile\"\n+            ]\n           },\n           \"inputFiles\": {\n             \"title\": \"A collection of source files to compile\","
        },
        {
            "sha": "ae20cb9ad6498026eda3b30bc02b984b73be400e",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/get_compliance_tests.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fget_compliance_tests.ts",
            "raw_url": "https://github.com/angular/angular/raw/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fget_compliance_tests.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fget_compliance_tests.ts?ref=09ba30ef2960f2b4394e13d776ca3921e670f457",
            "patch": "@@ -35,13 +35,16 @@ export function* getComplianceTests(testConfigPath: string): Generator<Complianc\n   const testConfig = Array.isArray(testConfigJSON) ? testConfigJSON : [testConfigJSON];\n   for (const test of testConfig) {\n     const inputFiles = getStringArrayOrDefault(test, 'inputFiles', realTestPath, ['test.ts']);\n+    const compilationModeFilter = getStringArrayOrDefault(\n+                                      test, 'compilationModeFilter', realTestPath,\n+                                      ['linked compile', 'full compile']) as CompilationMode[];\n+\n     yield {\n       relativePath: fs.relative(basePath, realTestPath),\n       realTestPath,\n       description: getStringOrFail(test, 'description', realTestPath),\n       inputFiles,\n-      excludeFromPartialTests:\n-          getBooleanOrDefault(test, 'excludeFromPartialTests', realTestPath, false),\n+      compilationModeFilter,\n       expectations: parseExpectations(test.expectations, realTestPath, inputFiles),\n       compilerOptions: getConfigOptions(test, 'compilerOptions', realTestPath),\n       angularCompilerOptions: getConfigOptions(test, 'angularCompilerOptions', realTestPath),\n@@ -243,8 +246,11 @@ export interface ComplianceTest {\n   angularCompilerOptions?: ConfigOptions;\n   /** A list of paths to source files that should be compiled for this test case. */\n   inputFiles: string[];\n-  /** If set to true then do not check expectations for this test-case in partial tests. */\n-  excludeFromPartialTests: boolean;\n+  /**\n+   * Only run this test when the input files are compiled using the given compilation\n+   * modes. The default is to run for all modes.\n+   */\n+  compilationModeFilter: CompilationMode[];\n   /** A list of expectations to check for this test case. */\n   expectations: Expectation[];\n   /** If set to `true`, then focus on this test (equivalent to jasmine's 'fit()`). */\n@@ -253,6 +259,8 @@ export interface ComplianceTest {\n   excludeTest?: boolean;\n }\n \n+export type CompilationMode = 'linked compile'|'full compile';\n+\n export interface Expectation {\n   /** The message to display if this expectation fails. */\n   failureMessage: string;"
        },
        {
            "sha": "c61405dc05b481a35fcf8954362fd18681b164db",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/test_runner.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 8,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Ftest_runner.ts",
            "raw_url": "https://github.com/angular/angular/raw/09ba30ef2960f2b4394e13d776ca3921e670f457/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Ftest_runner.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Ftest_runner.ts?ref=09ba30ef2960f2b4394e13d776ca3921e670f457",
            "patch": "@@ -8,7 +8,7 @@\n import {FileSystem} from '../../../src/ngtsc/file_system';\n import {checkExpectations} from '../test_helpers/check_expectations';\n import {CompileResult, initMockTestFileSystem} from '../test_helpers/compile_test';\n-import {ComplianceTest, getAllComplianceTests} from '../test_helpers/get_compliance_tests';\n+import {CompilationMode, ComplianceTest, getAllComplianceTests} from '../test_helpers/get_compliance_tests';\n import {checkErrors, checkNoUnexpectedErrors} from './check_errors';\n \n /**\n@@ -18,23 +18,20 @@ import {checkErrors, checkNoUnexpectedErrors} from './check_errors';\n  * @param compileFn The function that will do the compilation of the source files\n  */\n export function runTests(\n-    type: 'partial compile + link'|'full compile',\n-    compileFn: (fs: FileSystem, test: ComplianceTest) => CompileResult) {\n-  const isPartial = type === 'partial compile + link';\n-\n+    type: CompilationMode, compileFn: (fs: FileSystem, test: ComplianceTest) => CompileResult) {\n   describe(`compliance tests (${type})`, () => {\n     for (const test of getAllComplianceTests()) {\n-      if (isPartial && test.excludeFromPartialTests) {\n+      if (!test.compilationModeFilter.includes(type)) {\n         continue;\n       }\n \n       describe(`[${test.relativePath}]`, () => {\n         const itFn = test.focusTest ? fit : test.excludeTest ? xit : it;\n         itFn(test.description, () => {\n-          if (isPartial && test.compilerOptions?.target === 'ES5') {\n+          if (type === 'linked compile' && test.compilerOptions?.target === 'ES5') {\n             throw new Error(\n                 `The \"${type}\" scenario does not support ES5 output.\\n` +\n-                `Did you mean to set \\`\"excludeFromPartialTests\": true\\` in \"${\n+                `Did you mean to set \\`\"compilationModeFilter\": [\"full compile\"]\\` in \"${\n                     test.relativePath}\"?`);\n           }\n "
        }
    ],
    "stats": {
        "total": 75,
        "additions": 51,
        "deletions": 24
    }
}