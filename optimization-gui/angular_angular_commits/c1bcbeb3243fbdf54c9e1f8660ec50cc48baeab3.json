{
    "author": "atscott",
    "message": "refactor(language-service): Separate reference and rename capabilities (#40523)\n\nThis commit separates the reference and rename functions into separate builders so it's easier\nto locate functions specific to each\n\nPR Close #40523",
    "sha": "c1bcbeb3243fbdf54c9e1f8660ec50cc48baeab3",
    "files": [
        {
            "sha": "26fa98292009b69480b62a39277d2339f6f381a3",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/c1bcbeb3243fbdf54c9e1f8660ec50cc48baeab3/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/c1bcbeb3243fbdf54c9e1f8660ec50cc48baeab3/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=c1bcbeb3243fbdf54c9e1f8660ec50cc48baeab3",
            "patch": "@@ -26,7 +26,7 @@ import {CompilerFactory} from './compiler_factory';\n import {CompletionBuilder, CompletionNodeContext} from './completions';\n import {DefinitionBuilder} from './definitions';\n import {QuickInfoBuilder} from './quick_info';\n-import {ReferencesAndRenameBuilder} from './references_and_rename';\n+import {ReferencesBuilder, RenameBuilder} from './references_and_rename';\n import {getSignatureHelp} from './signature_help';\n import {getTargetAtPosition, TargetContext, TargetNodeKind} from './template_target';\n import {findTightestNode, getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n@@ -168,14 +168,14 @@ export class LanguageService {\n \n   getReferencesAtPosition(fileName: string, position: number): ts.ReferenceEntry[]|undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsReferencesAndRenames, (compiler) => {\n-      return new ReferencesAndRenameBuilder(this.programDriver, this.tsLS, compiler)\n+      return new ReferencesBuilder(this.programDriver, this.tsLS, compiler)\n           .getReferencesAtPosition(fileName, position);\n     });\n   }\n \n   getRenameInfo(fileName: string, position: number): ts.RenameInfo {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsReferencesAndRenames, (compiler) => {\n-      const renameInfo = new ReferencesAndRenameBuilder(this.programDriver, this.tsLS, compiler)\n+      const renameInfo = new RenameBuilder(this.programDriver, this.tsLS, compiler)\n                              .getRenameInfo(absoluteFrom(fileName), position);\n       if (!renameInfo.canRename) {\n         return renameInfo;\n@@ -191,7 +191,7 @@ export class LanguageService {\n \n   findRenameLocations(fileName: string, position: number): readonly ts.RenameLocation[]|undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsReferencesAndRenames, (compiler) => {\n-      return new ReferencesAndRenameBuilder(this.programDriver, this.tsLS, compiler)\n+      return new RenameBuilder(this.programDriver, this.tsLS, compiler)\n           .findRenameLocations(fileName, position);\n     });\n   }"
        },
        {
            "sha": "4ad85509fef1d935a62c6659057410c416fbfb10",
            "filename": "packages/language-service/ivy/references_and_rename.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 57,
            "changes": 119,
            "blob_url": "https://github.com/angular/angular/blob/c1bcbeb3243fbdf54c9e1f8660ec50cc48baeab3/packages%2Flanguage-service%2Fivy%2Freferences_and_rename.ts",
            "raw_url": "https://github.com/angular/angular/raw/c1bcbeb3243fbdf54c9e1f8660ec50cc48baeab3/packages%2Flanguage-service%2Fivy%2Freferences_and_rename.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences_and_rename.ts?ref=c1bcbeb3243fbdf54c9e1f8660ec50cc48baeab3",
            "patch": "@@ -16,6 +16,61 @@ import {convertToTemplateDocumentSpan, createLocationKey, getRenameTextAndSpanAt\n import {findTightestNode} from './ts_utils';\n import {getTemplateInfoAtPosition, TemplateInfo} from './utils';\n \n+export class ReferencesBuilder {\n+  private readonly ttc = this.compiler.getTemplateTypeChecker();\n+\n+  constructor(\n+      private readonly driver: ProgramDriver, private readonly tsLS: ts.LanguageService,\n+      private readonly compiler: NgCompiler) {}\n+\n+  getReferencesAtPosition(filePath: string, position: number): ts.ReferenceEntry[]|undefined {\n+    this.ttc.generateAllTypeCheckBlocks();\n+    const templateInfo = getTemplateInfoAtPosition(filePath, position, this.compiler);\n+    if (templateInfo === undefined) {\n+      return this.getReferencesAtTypescriptPosition(filePath, position);\n+    }\n+    return this.getReferencesAtTemplatePosition(templateInfo, position);\n+  }\n+\n+  private getReferencesAtTemplatePosition(templateInfo: TemplateInfo, position: number):\n+      ts.ReferenceEntry[]|undefined {\n+    const allTargetDetails = getTargetDetailsAtTemplatePosition(templateInfo, position, this.ttc);\n+    if (allTargetDetails === null) {\n+      return undefined;\n+    }\n+    const allReferences: ts.ReferenceEntry[] = [];\n+    for (const targetDetails of allTargetDetails) {\n+      for (const location of targetDetails.typescriptLocations) {\n+        const refs = this.getReferencesAtTypescriptPosition(location.fileName, location.position);\n+        if (refs !== undefined) {\n+          allReferences.push(...refs);\n+        }\n+      }\n+    }\n+    return allReferences.length > 0 ? allReferences : undefined;\n+  }\n+\n+  private getReferencesAtTypescriptPosition(fileName: string, position: number):\n+      ts.ReferenceEntry[]|undefined {\n+    const refs = this.tsLS.getReferencesAtPosition(fileName, position);\n+    if (refs === undefined) {\n+      return undefined;\n+    }\n+\n+    const entries: Map<string, ts.ReferenceEntry> = new Map();\n+    for (const ref of refs) {\n+      if (this.ttc.isTrackedTypeCheckFile(absoluteFrom(ref.fileName))) {\n+        const entry = convertToTemplateDocumentSpan(ref, this.ttc, this.driver.getProgram());\n+        if (entry !== null) {\n+          entries.set(createLocationKey(entry), entry);\n+        }\n+      } else {\n+        entries.set(createLocationKey(ref), ref);\n+      }\n+    }\n+    return Array.from(entries.values());\n+  }\n+}\n \n enum RequestKind {\n   Template,\n@@ -35,7 +90,8 @@ interface TypeScriptRequest {\n \n type RequestOrigin = TemplateRequest|TypeScriptRequest;\n \n-export class ReferencesAndRenameBuilder {\n+\n+export class RenameBuilder {\n   private readonly ttc = this.compiler.getTemplateTypeChecker();\n \n   constructor(\n@@ -125,14 +181,6 @@ export class ReferencesAndRenameBuilder {\n     return allRenameLocations.length > 0 ? allRenameLocations : undefined;\n   }\n \n-  private getTsNodeAtPosition(filePath: string, position: number): ts.Node|null {\n-    const sf = this.driver.getProgram().getSourceFile(filePath);\n-    if (!sf) {\n-      return null;\n-    }\n-    return findTightestNode(sf, position) ?? null;\n-  }\n-\n   findRenameLocationsAtTypescriptPosition(\n       filePath: string, position: number,\n       requestOrigin: RequestOrigin): readonly ts.RenameLocation[]|undefined {\n@@ -181,54 +229,11 @@ export class ReferencesAndRenameBuilder {\n     });\n   }\n \n-  getReferencesAtPosition(filePath: string, position: number): ts.ReferenceEntry[]|undefined {\n-    this.ttc.generateAllTypeCheckBlocks();\n-\n-    return this.compiler.perfRecorder.inPhase(PerfPhase.LsReferencesAndRenames, () => {\n-      const templateInfo = getTemplateInfoAtPosition(filePath, position, this.compiler);\n-      if (templateInfo === undefined) {\n-        return this.getReferencesAtTypescriptPosition(filePath, position);\n-      }\n-      return this.getReferencesAtTemplatePosition(templateInfo, position);\n-    });\n-  }\n-\n-  private getReferencesAtTemplatePosition(templateInfo: TemplateInfo, position: number):\n-      ts.ReferenceEntry[]|undefined {\n-    const allTargetDetails = getTargetDetailsAtTemplatePosition(templateInfo, position, this.ttc);\n-    if (allTargetDetails === null) {\n-      return undefined;\n-    }\n-    const allReferences: ts.ReferenceEntry[] = [];\n-    for (const targetDetails of allTargetDetails) {\n-      for (const location of targetDetails.typescriptLocations) {\n-        const refs = this.getReferencesAtTypescriptPosition(location.fileName, location.position);\n-        if (refs !== undefined) {\n-          allReferences.push(...refs);\n-        }\n-      }\n-    }\n-    return allReferences.length > 0 ? allReferences : undefined;\n-  }\n-\n-  private getReferencesAtTypescriptPosition(fileName: string, position: number):\n-      ts.ReferenceEntry[]|undefined {\n-    const refs = this.tsLS.getReferencesAtPosition(fileName, position);\n-    if (refs === undefined) {\n-      return undefined;\n-    }\n-\n-    const entries: Map<string, ts.ReferenceEntry> = new Map();\n-    for (const ref of refs) {\n-      if (this.ttc.isTrackedTypeCheckFile(absoluteFrom(ref.fileName))) {\n-        const entry = convertToTemplateDocumentSpan(ref, this.ttc, this.driver.getProgram());\n-        if (entry !== null) {\n-          entries.set(createLocationKey(entry), entry);\n-        }\n-      } else {\n-        entries.set(createLocationKey(ref), ref);\n-      }\n+  private getTsNodeAtPosition(filePath: string, position: number): ts.Node|null {\n+    const sf = this.driver.getProgram().getSourceFile(filePath);\n+    if (!sf) {\n+      return null;\n     }\n-    return Array.from(entries.values());\n+    return findTightestNode(sf, position) ?? null;\n   }\n }\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 66,
        "deletions": 61
    }
}