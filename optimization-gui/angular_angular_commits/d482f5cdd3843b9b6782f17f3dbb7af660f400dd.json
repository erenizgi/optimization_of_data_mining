{
    "author": "ayazhafiz",
    "message": "feat(language-service): view template typecheck block (#39974)\n\nThis patch adds an API to retrieve the template typecheck block for a\ntemplate (if any) at a file location, and a selection of the TS node\nin the TCB corresponding to the template node at which the request for\na TCB was made (if any).\n\nProbably not something we want to land soon, but a useful debugging tool\nfor folks working with TCBs.\n\nPR Close #39974",
    "sha": "d482f5cdd3843b9b6782f17f3dbb7af660f400dd",
    "files": [
        {
            "sha": "5ff0c40fedebf87b55c8ca3db0bad2c84c7317bd",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 74,
            "deletions": 1,
            "changes": 75,
            "blob_url": "https://github.com/angular/angular/blob/d482f5cdd3843b9b6782f17f3dbb7af660f400dd/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/d482f5cdd3843b9b6782f17f3dbb7af660f400dd/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=d482f5cdd3843b9b6782f17f3dbb7af660f400dd",
            "patch": "@@ -6,11 +6,13 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, TmplAstBoundEvent, TmplAstNode} from '@angular/compiler';\n+import {AbsoluteSourceSpan, AST, ParseSourceSpan, TmplAstBoundEvent, TmplAstNode} from '@angular/compiler';\n import {CompilerOptions, ConfigurationHost, readConfiguration} from '@angular/compiler-cli';\n+import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import {findFirstMatchingNode} from '@angular/compiler-cli/src/ngtsc/typecheck/src/comments';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {LanguageServiceAdapter, LSParseConfigHost} from './adapters';\n@@ -22,6 +24,25 @@ import {ReferencesAndRenameBuilder} from './references';\n import {getTargetAtPosition, TargetContext, TargetNodeKind} from './template_target';\n import {getTemplateInfoAtPosition, isTypeScriptFile} from './utils';\n \n+export type GetTcbResponse = {\n+  /**\n+   * The filename of the SourceFile this typecheck block belongs to.\n+   * The filename is entirely opaque and unstable, useful only for debugging\n+   * purposes.\n+   */\n+  fileName: string,\n+  /** The content of the SourceFile this typecheck block belongs to. */\n+  content: string,\n+  /**\n+   * Spans over node(s) in the typecheck block corresponding to the\n+   * TS code generated for template node under the current cursor position.\n+   *\n+   * When the cursor position is over a source for which there is no generated\n+   * code, `selections` is empty.\n+   */\n+  selections: ts.TextSpan[],\n+}|undefined;\n+\n export class LanguageService {\n   private options: CompilerOptions;\n   readonly compilerFactory: CompilerFactory;\n@@ -195,6 +216,58 @@ export class LanguageService {\n     return result;\n   }\n \n+  getTcb(fileName: string, position: number): GetTcbResponse {\n+    return this.withCompiler<GetTcbResponse>(fileName, compiler => {\n+      const templateInfo = getTemplateInfoAtPosition(fileName, position, compiler);\n+      if (templateInfo === undefined) {\n+        return undefined;\n+      }\n+      const tcb = compiler.getTemplateTypeChecker().getTypeCheckBlock(templateInfo.component);\n+      if (tcb === null) {\n+        return undefined;\n+      }\n+      const sf = tcb.getSourceFile();\n+\n+      let selections: ts.TextSpan[] = [];\n+      const target = getTargetAtPosition(templateInfo.template, position);\n+      if (target !== null) {\n+        let selectionSpans: Array<ParseSourceSpan|AbsoluteSourceSpan>;\n+        if ('nodes' in target.context) {\n+          selectionSpans = target.context.nodes.map(n => n.sourceSpan);\n+        } else {\n+          selectionSpans = [target.context.node.sourceSpan];\n+        }\n+        const selectionNodes: ts.Node[] =\n+            selectionSpans\n+                .map(s => findFirstMatchingNode(tcb, {\n+                       withSpan: s,\n+                       filter: (node: ts.Node): node is ts.Node => true,\n+                     }))\n+                .filter((n): n is ts.Node => n !== null);\n+\n+        selections = selectionNodes.map(n => {\n+          return {\n+            start: n.getStart(sf),\n+            length: n.getEnd() - n.getStart(sf),\n+          };\n+        });\n+      }\n+\n+      return {\n+        fileName: sf.fileName,\n+        content: sf.getFullText(),\n+        selections,\n+      };\n+    });\n+  }\n+\n+  private withCompiler<T>(fileName: string, p: (compiler: NgCompiler) => T): T {\n+    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+    const result = p(compiler);\n+    this.compilerFactory.registerLastKnownProgram();\n+    return result;\n+  }\n+\n   private watchConfigFile(project: ts.server.Project) {\n     // TODO: Check the case when the project is disposed. An InferredProject\n     // could be disposed when a tsconfig.json is added to the workspace,"
        },
        {
            "sha": "697432be9fac1861bd53853079c69ebfe055ba50",
            "filename": "packages/language-service/ivy/test/env.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/d482f5cdd3843b9b6782f17f3dbb7af660f400dd/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/d482f5cdd3843b9b6782f17f3dbb7af660f400dd/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts?ref=d482f5cdd3843b9b6782f17f3dbb7af660f400dd",
            "patch": "@@ -230,8 +230,8 @@ function getClassOrError(sf: ts.SourceFile, name: string): ts.ClassDeclaration {\n \n export function extractCursorInfo(textWithCursor: string): {cursor: number, text: string} {\n   const cursor = textWithCursor.indexOf('¦');\n-  if (cursor === -1) {\n-    throw new Error(`Expected to find cursor symbol '¦'`);\n+  if (cursor === -1 || textWithCursor.indexOf('¦', cursor + 1) !== -1) {\n+    throw new Error(`Expected to find exactly one cursor symbol '¦'`);\n   }\n \n   return {"
        },
        {
            "sha": "dec439941ccc265dc4e5b5c9fc838876eb60e6bb",
            "filename": "packages/language-service/ivy/test/gettcb_spec.ts",
            "status": "added",
            "additions": 92,
            "deletions": 0,
            "changes": 92,
            "blob_url": "https://github.com/angular/angular/blob/d482f5cdd3843b9b6782f17f3dbb7af660f400dd/packages%2Flanguage-service%2Fivy%2Ftest%2Fgettcb_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d482f5cdd3843b9b6782f17f3dbb7af660f400dd/packages%2Flanguage-service%2Fivy%2Ftest%2Fgettcb_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fgettcb_spec.ts?ref=d482f5cdd3843b9b6782f17f3dbb7af660f400dd",
            "patch": "@@ -0,0 +1,92 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+\n+import {extractCursorInfo} from './env';\n+import {createModuleWithDeclarations} from './test_utils';\n+\n+describe('get typecheck block', () => {\n+  beforeEach(() => {\n+    initMockFileSystem('Native');\n+  });\n+\n+  it('should find the typecheck block for an inline template', () => {\n+    const {text, cursor} = extractCursorInfo(`\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        template: '<div>{{ my¦Prop }}</div>',\n+      })\n+      export class AppCmp {\n+        myProp!: string;\n+      }`);\n+    const appFi = absoluteFrom('/app.ts');\n+    const env = createModuleWithDeclarations([{name: appFi, contents: text}]);\n+\n+    env.expectNoSourceDiagnostics();\n+    const result = env.ngLS.getTcb(appFi, cursor);\n+    if (result === undefined) {\n+      fail('Expected a valid TCB response');\n+      return;\n+    }\n+    const {content, selections} = result;\n+    expect(selections.length).toBe(1);\n+    const {start, length} = selections[0];\n+    expect(content.substring(start, start + length)).toContain('myProp');\n+  });\n+\n+  it('should find the typecheck block for an external template', () => {\n+    const {text, cursor} = extractCursorInfo(`<div>{{ my¦Prop }}</div>`);\n+    const templateFi = absoluteFrom('/app.html');\n+    const env = createModuleWithDeclarations(\n+        [{\n+          name: absoluteFrom('/app.ts'),\n+          contents: `\n+            import {Component} from '@angular/core';\n+\n+            @Component({\n+              templateUrl: './app.html',\n+            })\n+            export class AppCmp {\n+              myProp!: string;\n+            }`,\n+        }],\n+        [{name: templateFi, contents: text}]);\n+\n+    env.expectNoSourceDiagnostics();\n+    const result = env.ngLS.getTcb(templateFi, cursor);\n+    if (result === undefined) {\n+      fail('Expected a valid TCB response');\n+      return;\n+    }\n+    const {content, selections} = result;\n+    expect(selections.length).toBe(1);\n+    const {start, length} = selections[0];\n+    expect(content.substring(start, start + length)).toContain('myProp');\n+  });\n+\n+  it('should not find typecheck blocks outside a template', () => {\n+    const {text, cursor} = extractCursorInfo(`\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        template: '<div>{{ myProp }}</div>',\n+      })\n+      export class AppCmp {\n+        my¦Prop!: string;\n+      }`);\n+    const appFi = absoluteFrom('/app.ts');\n+    const env = createModuleWithDeclarations([{name: appFi, contents: text}]);\n+\n+    env.expectNoSourceDiagnostics();\n+    const result = env.ngLS.getTcb(appFi, cursor);\n+    expect(result).toBeUndefined();\n+  });\n+});"
        },
        {
            "sha": "6fae7246735448fb088fe0fc2726934cc8f770a2",
            "filename": "packages/language-service/ivy/ts_plugin.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/d482f5cdd3843b9b6782f17f3dbb7af660f400dd/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/d482f5cdd3843b9b6782f17f3dbb7af660f400dd/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts?ref=d482f5cdd3843b9b6782f17f3dbb7af660f400dd",
            "patch": "@@ -7,9 +7,13 @@\n  */\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n-import {LanguageService} from './language_service';\n+import {GetTcbResponse, LanguageService} from './language_service';\n \n-export function create(info: ts.server.PluginCreateInfo): ts.LanguageService {\n+export interface NgLanguageService extends ts.LanguageService {\n+  getTcb(fileName: string, position: number): GetTcbResponse;\n+}\n+\n+export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n   const {project, languageService: tsLS, config} = info;\n   const angularOnly = config?.angularOnly === true;\n \n@@ -116,6 +120,10 @@ export function create(info: ts.server.PluginCreateInfo): ts.LanguageService {\n     }\n   }\n \n+  function getTcb(fileName: string, position: number): GetTcbResponse {\n+    return ngLS.getTcb(fileName, position);\n+  }\n+\n   return {\n     ...tsLS,\n     getSemanticDiagnostics,\n@@ -128,6 +136,7 @@ export function create(info: ts.server.PluginCreateInfo): ts.LanguageService {\n     getCompletionsAtPosition,\n     getCompletionEntryDetails,\n     getCompletionEntrySymbol,\n+    getTcb,\n   };\n }\n "
        }
    ],
    "stats": {
        "total": 184,
        "additions": 179,
        "deletions": 5
    }
}