{
    "author": "gkalpak",
    "message": "fix(upgrade): fix HMR for hybrid applications (#40045)\n\nPreviously, trying to apply a change via Hot Module Replacement (HMR) in\na hybrid app would result in an error. This was caused by not having the\nAngularJS app destroyed and thus trying to bootstrap an AngularJS app on\nthe same element twice.\n\nThis commit fixes HMR for hybrid apps by ensuring the AngularJS app is\ndestroyed when the Angular `PlatformRef` is [destroyed][1] in the\n[`module.hot.dispose()` callback][2].\n\nNOTE:\nFor \"ngUpgradeLite\" apps (i.e. those using `downgradeModule()`), HMR\nwill only work if the downgraded module has been bootstrapped and there\nis at least one Angular component present on the page. The is due to a\ncombination of two facts:\n- The logic for setting up the listener that destroys the AngularJS app\n  depends on the downgraded module's `NgModuleRef`, which is only\n  available after the module has been bootstrapped.\n- The [HMR dispose logic][3] depends on having an Angular element\n  (identified by the auto-geenrated `ng-version` attribute) present in\n  the DOM in order to retrieve the Angular `PlatformRef`.\n\n[1]:\nhttps://github.com/angular/angular-cli/blob/205ea2b638f154291993bfd9e065cd66ff20503/packages/angular_devkit/build_angular/src/webpack/plugins/hmr/hmr-accept.ts#L75\n[2]:\nhttps://github.com/angular/angular-cli/blob/205ea2b638f154291993bfd9e065cd66ff205033/packages/angular_devkit/build_angular/src/webpack/plugins/hmr/hmr-accept.ts#L31\n[3]:\nhttps://github.com/angular/angular-cli/blob/205ea2b638f154291993bfd9e065cd66ff205033/packages/angular_devkit/build_angular/src/webpack/plugins/hmr/hmr-accept.ts#L116\n\nFixes #39935\n\nPR Close #40045",
    "sha": "b4b21bdff4b07fe9968c8d61fb9f5a2caa662331",
    "files": [
        {
            "sha": "d21bc57848499d2dcb957b536f1a6cfb6753da1f",
            "filename": "goldens/public-api/upgrade/static/static.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/goldens%2Fpublic-api%2Fupgrade%2Fstatic%2Fstatic.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/goldens%2Fpublic-api%2Fupgrade%2Fstatic%2Fstatic.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fupgrade%2Fstatic%2Fstatic.d.ts?ref=b4b21bdff4b07fe9968c8d61fb9f5a2caa662331",
            "patch": "@@ -35,7 +35,8 @@ export declare class UpgradeModule {\n     ngZone: NgZone;\n     constructor(\n     injector: Injector,\n-    ngZone: NgZone);\n+    ngZone: NgZone,\n+    platformRef: PlatformRef);\n     bootstrap(element: Element, modules?: string[], config?: any): void;\n }\n "
        },
        {
            "sha": "640d23adf0ea06b7435432d70375f34ef874f348",
            "filename": "packages/upgrade/src/common/src/constants.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Fconstants.ts",
            "raw_url": "https://github.com/angular/angular/raw/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Fconstants.ts?ref=b4b21bdff4b07fe9968c8d61fb9f5a2caa662331",
            "patch": "@@ -15,6 +15,7 @@ export const $INJECTOR = '$injector';\n export const $INTERVAL = '$interval';\n export const $PARSE = '$parse';\n export const $PROVIDE = '$provide';\n+export const $ROOT_ELEMENT = '$rootElement';\n export const $ROOT_SCOPE = '$rootScope';\n export const $SCOPE = '$scope';\n export const $TEMPLATE_CACHE = '$templateCache';"
        },
        {
            "sha": "1ac7ecb573d85d2d827e720ccbff008ed23d717c",
            "filename": "packages/upgrade/src/common/src/util.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 2,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Futil.ts?ref=b4b21bdff4b07fe9968c8d61fb9f5a2caa662331",
            "patch": "@@ -8,8 +8,8 @@\n \n import {Injector, Type} from '@angular/core';\n \n-import {element as angularElement, IInjectorService, INgModelController} from './angular1';\n-import {DOWNGRADED_MODULE_COUNT_KEY, UPGRADE_APP_TYPE_KEY} from './constants';\n+import {element as angularElement, IAugmentedJQuery, IInjectorService, INgModelController, IRootScopeService} from './angular1';\n+import {$ROOT_ELEMENT, $ROOT_SCOPE, DOWNGRADED_MODULE_COUNT_KEY, UPGRADE_APP_TYPE_KEY} from './constants';\n \n const DIRECTIVE_PREFIX_REGEXP = /^(?:x|data)[:\\-_]/i;\n const DIRECTIVE_SPECIAL_CHARS_REGEXP = /[:\\-_]+(.)/g;\n@@ -48,6 +48,23 @@ export function controllerKey(name: string): string {\n   return '$' + name + 'Controller';\n }\n \n+/**\n+ * Destroy an AngularJS app given the app `$injector`.\n+ *\n+ * NOTE: Destroying an app is not officially supported by AngularJS, but try to do our best by\n+ *       destroying `$rootScope` and clean the jqLite/jQuery data on `$rootElement` and all\n+ *       descendants.\n+ *\n+ * @param $injector The `$injector` of the AngularJS app to destroy.\n+ */\n+export function destroyApp($injector: IInjectorService): void {\n+  const $rootElement: IAugmentedJQuery = $injector.get($ROOT_ELEMENT);\n+  const $rootScope: IRootScopeService = $injector.get($ROOT_SCOPE);\n+\n+  $rootScope.$destroy();\n+  cleanData($rootElement[0]);\n+}\n+\n export function directiveNormalize(name: string): string {\n   return name.replace(DIRECTIVE_PREFIX_REGEXP, '')\n       .replace(DIRECTIVE_SPECIAL_CHARS_REGEXP, (_, letter) => letter.toUpperCase());"
        },
        {
            "sha": "beb411505fe35e628670a88362fee26fec4c4b91",
            "filename": "packages/upgrade/src/dynamic/src/upgrade_adapter.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fsrc%2Fdynamic%2Fsrc%2Fupgrade_adapter.ts",
            "raw_url": "https://github.com/angular/angular/raw/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fsrc%2Fdynamic%2Fsrc%2Fupgrade_adapter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fsrc%2Fdynamic%2Fsrc%2Fupgrade_adapter.ts?ref=b4b21bdff4b07fe9968c8d61fb9f5a2caa662331",
            "patch": "@@ -13,7 +13,7 @@ import {bootstrap, element as angularElement, IAngularBootstrapConfig, IAugmente\n import {$$TESTABILITY, $COMPILE, $INJECTOR, $ROOT_SCOPE, COMPILER_KEY, INJECTOR_KEY, LAZY_MODULE_REF, NG_ZONE_KEY, UPGRADE_APP_TYPE_KEY} from '../../common/src/constants';\n import {downgradeComponent} from '../../common/src/downgrade_component';\n import {downgradeInjectable} from '../../common/src/downgrade_injectable';\n-import {controllerKey, Deferred, LazyModuleRef, onError, UpgradeAppType} from '../../common/src/util';\n+import {controllerKey, Deferred, destroyApp, LazyModuleRef, onError, UpgradeAppType} from '../../common/src/util';\n \n import {UpgradeNg1ComponentAdapterBuilder} from './upgrade_ng1_adapter';\n \n@@ -619,6 +619,13 @@ export class UpgradeAdapter {\n                     rootScope.$on('$destroy', () => {\n                       subscription.unsubscribe();\n                     });\n+\n+                    // Destroy the AngularJS app once the Angular `PlatformRef` is destroyed.\n+                    // This does not happen in a typical SPA scenario, but it might be useful for\n+                    // other use-cases where disposing of an Angular/AngularJS app is necessary\n+                    // (such as Hot Module Replacement (HMR)).\n+                    // See https://github.com/angular/angular/issues/39935.\n+                    platformRef.onDestroy(() => destroyApp(ng1Injector));\n                   });\n             })\n             .catch((e) => this.ng2BootstrapDeferred.reject(e));"
        },
        {
            "sha": "70bbbc66e38f903c6f504e2c2f15e0644c3d544e",
            "filename": "packages/upgrade/src/dynamic/test/upgrade_spec.ts",
            "status": "modified",
            "additions": 59,
            "deletions": 1,
            "changes": 60,
            "blob_url": "https://github.com/angular/angular/blob/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fsrc%2Fdynamic%2Ftest%2Fupgrade_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fsrc%2Fdynamic%2Ftest%2Fupgrade_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fsrc%2Fdynamic%2Ftest%2Fupgrade_spec.ts?ref=b4b21bdff4b07fe9968c8d61fb9f5a2caa662331",
            "patch": "@@ -86,7 +86,7 @@ withEachNg1Version(() => {\n            });\n          }));\n \n-      it('supports the compilerOptions argument', waitForAsync(() => {\n+      it('should support the compilerOptions argument', waitForAsync(() => {\n            const platformRef = platformBrowserDynamic();\n            spyOn(platformRef, 'bootstrapModule').and.callThrough();\n            spyOn(platformRef, 'bootstrapModuleFactory').and.callThrough();\n@@ -120,6 +120,64 @@ withEachNg1Version(() => {\n              ref.dispose();\n            });\n          }));\n+\n+      it('should destroy the AngularJS app when `PlatformRef` is destroyed', waitForAsync(() => {\n+           const platformRef = platformBrowserDynamic();\n+           const adapter = new UpgradeAdapter(forwardRef(() => Ng2Module));\n+           const ng1Module = angular.module_('ng1', []);\n+\n+           @Component({selector: 'ng2', template: '<span>NG2</span>'})\n+           class Ng2Component {\n+           }\n+\n+           @NgModule({\n+             declarations: [Ng2Component],\n+             imports: [BrowserModule],\n+           })\n+           class Ng2Module {\n+             ngDoBootstrap() {}\n+           }\n+\n+           ng1Module.component('ng1', {template: '<ng2></ng2>'});\n+           ng1Module.directive('ng2', adapter.downgradeNg2Component(Ng2Component));\n+\n+           const element = html('<div><ng1></ng1></div>');\n+\n+           adapter.bootstrap(element, [ng1Module.name]).ready(ref => {\n+             const $rootScope: angular.IRootScopeService = ref.ng1Injector.get($ROOT_SCOPE);\n+             const rootScopeDestroySpy = spyOn($rootScope, '$destroy');\n+\n+             const appElem = angular.element(element);\n+             const ng1Elem = angular.element(element.querySelector('ng1') as Element);\n+             const ng2Elem = angular.element(element.querySelector('ng2') as Element);\n+             const ng2ChildElem = angular.element(element.querySelector('ng2 span') as Element);\n+\n+             // Attach data to all elements.\n+             appElem.data!('testData', 1);\n+             ng1Elem.data!('testData', 2);\n+             ng2Elem.data!('testData', 3);\n+             ng2ChildElem.data!('testData', 4);\n+\n+             // Verify data can be retrieved.\n+             expect(appElem.data!('testData')).toBe(1);\n+             expect(ng1Elem.data!('testData')).toBe(2);\n+             expect(ng2Elem.data!('testData')).toBe(3);\n+             expect(ng2ChildElem.data!('testData')).toBe(4);\n+\n+             expect(rootScopeDestroySpy).not.toHaveBeenCalled();\n+\n+             // Destroy `PlatformRef`.\n+             platformRef.destroy();\n+\n+             // Verify `$rootScope` has been destroyed and data has been cleaned up.\n+             expect(rootScopeDestroySpy).toHaveBeenCalled();\n+\n+             expect(appElem.data!('testData')).toBeUndefined();\n+             expect(ng1Elem.data!('testData')).toBeUndefined();\n+             expect(ng2Elem.data!('testData')).toBeUndefined();\n+             expect(ng2ChildElem.data!('testData')).toBeUndefined();\n+           });\n+         }));\n     });\n \n     describe('bootstrap errors', () => {"
        },
        {
            "sha": "cfec3e94d0208f5ab7078df88a443a7318846609",
            "filename": "packages/upgrade/static/src/downgrade_module.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fstatic%2Fsrc%2Fdowngrade_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fstatic%2Fsrc%2Fdowngrade_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fstatic%2Fsrc%2Fdowngrade_module.ts?ref=b4b21bdff4b07fe9968c8d61fb9f5a2caa662331",
            "patch": "@@ -6,12 +6,12 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Injector, NgModuleFactory, NgModuleRef, StaticProvider} from '@angular/core';\n+import {Injector, NgModuleFactory, NgModuleRef, PlatformRef, StaticProvider} from '@angular/core';\n import {platformBrowser} from '@angular/platform-browser';\n \n import {IInjectorService, IProvideService, module_ as angularModule} from '../../src/common/src/angular1';\n import {$INJECTOR, $PROVIDE, DOWNGRADED_MODULE_COUNT_KEY, INJECTOR_KEY, LAZY_MODULE_REF, UPGRADE_APP_TYPE_KEY, UPGRADE_MODULE_NAME} from '../../src/common/src/constants';\n-import {getDowngradedModuleCount, isFunction, LazyModuleRef, UpgradeAppType} from '../../src/common/src/util';\n+import {destroyApp, getDowngradedModuleCount, isFunction, LazyModuleRef, UpgradeAppType} from '../../src/common/src/util';\n \n import {angular1Providers, setTempInjectorRef} from './angular1_providers';\n import {NgAdapterInjector} from './util';\n@@ -167,6 +167,13 @@ export function downgradeModule<T>(moduleFactoryOrBootstrapFn: NgModuleFactory<T\n                   injector = result.injector = new NgAdapterInjector(ref.injector);\n                   injector.get($INJECTOR);\n \n+                  // Destroy the AngularJS app once the Angular `PlatformRef` is destroyed.\n+                  // This does not happen in a typical SPA scenario, but it might be useful for\n+                  // other use-cases where disposing of an Angular/AngularJS app is necessary\n+                  // (such as Hot Module Replacement (HMR)).\n+                  // See https://github.com/angular/angular/issues/39935.\n+                  injector.get(PlatformRef).onDestroy(() => destroyApp($injector));\n+\n                   return injector;\n                 })\n               };"
        },
        {
            "sha": "1e54a7834a8c132db02b3f10c7047fd7ee9998d6",
            "filename": "packages/upgrade/static/src/upgrade_module.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fstatic%2Fsrc%2Fupgrade_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fstatic%2Fsrc%2Fupgrade_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fstatic%2Fsrc%2Fupgrade_module.ts?ref=b4b21bdff4b07fe9968c8d61fb9f5a2caa662331",
            "patch": "@@ -6,11 +6,11 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Injector, isDevMode, NgModule, NgZone, Testability} from '@angular/core';\n+import {Injector, isDevMode, NgModule, NgZone, PlatformRef, Testability} from '@angular/core';\n \n import {bootstrap, element as angularElement, IInjectorService, IIntervalService, IProvideService, ITestabilityService, module_ as angularModule} from '../../src/common/src/angular1';\n import {$$TESTABILITY, $DELEGATE, $INJECTOR, $INTERVAL, $PROVIDE, INJECTOR_KEY, LAZY_MODULE_REF, UPGRADE_APP_TYPE_KEY, UPGRADE_MODULE_NAME} from '../../src/common/src/constants';\n-import {controllerKey, LazyModuleRef, UpgradeAppType} from '../../src/common/src/util';\n+import {controllerKey, destroyApp, LazyModuleRef, UpgradeAppType} from '../../src/common/src/util';\n \n import {angular1Providers, setTempInjectorRef} from './angular1_providers';\n import {NgAdapterInjector} from './util';\n@@ -155,7 +155,13 @@ export class UpgradeModule {\n       /** The root `Injector` for the upgrade application. */\n       injector: Injector,\n       /** The bootstrap zone for the upgrade application */\n-      public ngZone: NgZone) {\n+      public ngZone: NgZone,\n+      /**\n+       * The owning `NgModuleRef`s `PlatformRef` instance.\n+       * This is used to tie the lifecycle of the bootstrapped AngularJS apps to that of the Angular\n+       * `PlatformRef`.\n+       */\n+      private platformRef: PlatformRef) {\n     this.injector = new NgAdapterInjector(injector);\n   }\n \n@@ -242,6 +248,7 @@ export class UpgradeModule {\n           $INJECTOR,\n           ($injector: IInjectorService) => {\n             this.$injector = $injector;\n+            const $rootScope = $injector.get('$rootScope');\n \n             // Initialize the ng1 $injector provider\n             setTempInjectorRef($injector);\n@@ -250,10 +257,16 @@ export class UpgradeModule {\n             // Put the injector on the DOM, so that it can be \"required\"\n             angularElement(element).data!(controllerKey(INJECTOR_KEY), this.injector);\n \n+            // Destroy the AngularJS app once the Angular `PlatformRef` is destroyed.\n+            // This does not happen in a typical SPA scenario, but it might be useful for\n+            // other use-cases where disposing of an Angular/AngularJS app is necessary\n+            // (such as Hot Module Replacement (HMR)).\n+            // See https://github.com/angular/angular/issues/39935.\n+            this.platformRef.onDestroy(() => destroyApp($injector));\n+\n             // Wire up the ng1 rootScope to run a digest cycle whenever the zone settles\n             // We need to do this in the next tick so that we don't prevent the bootup stabilizing\n             setTimeout(() => {\n-              const $rootScope = $injector.get('$rootScope');\n               const subscription = this.ngZone.onMicrotaskEmpty.subscribe(() => {\n                 if ($rootScope.$$phase) {\n                   if (isDevMode()) {"
        },
        {
            "sha": "5076831f8f9b67bcea8d4c0447a312474536965e",
            "filename": "packages/upgrade/static/test/integration/downgrade_component_spec.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/angular/angular/blob/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fstatic%2Ftest%2Fintegration%2Fdowngrade_component_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fstatic%2Ftest%2Fintegration%2Fdowngrade_component_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fstatic%2Ftest%2Fintegration%2Fdowngrade_component_spec.ts?ref=b4b21bdff4b07fe9968c8d61fb9f5a2caa662331",
            "patch": "@@ -13,6 +13,7 @@ import {platformBrowserDynamic} from '@angular/platform-browser-dynamic';\n import {downgradeComponent, UpgradeComponent, UpgradeModule} from '@angular/upgrade/static';\n \n import * as angular from '../../../src/common/src/angular1';\n+import {$ROOT_SCOPE} from '../../../src/common/src/constants';\n import {html, multiTrim, withEachNg1Version} from '../../../src/common/test/helpers/common_test_helpers';\n \n import {$apply, bootstrap} from './static_test_helpers';\n@@ -648,6 +649,66 @@ withEachNg1Version(() => {\n          });\n        }));\n \n+    it('should destroy the AngularJS app when `PlatformRef` is destroyed', waitForAsync(() => {\n+         @Component({selector: 'ng2', template: '<span>NG2</span>'})\n+         class Ng2Component {\n+         }\n+\n+         @NgModule({\n+           declarations: [Ng2Component],\n+           entryComponents: [Ng2Component],\n+           imports: [BrowserModule, UpgradeModule],\n+         })\n+         class Ng2Module {\n+           ngDoBootstrap() {}\n+         }\n+\n+         const ng1Module = angular.module_('ng1', [])\n+                               .component('ng1', {template: '<ng2></ng2>'})\n+                               .directive('ng2', downgradeComponent({component: Ng2Component}));\n+\n+         const element = html('<div><ng1></ng1></div>');\n+         const platformRef = platformBrowserDynamic();\n+\n+         platformRef.bootstrapModule(Ng2Module).then(ref => {\n+           const upgrade = ref.injector.get(UpgradeModule);\n+           upgrade.bootstrap(element, [ng1Module.name]);\n+\n+           const $rootScope: angular.IRootScopeService = upgrade.$injector.get($ROOT_SCOPE);\n+           const rootScopeDestroySpy = spyOn($rootScope, '$destroy');\n+\n+           const appElem = angular.element(element);\n+           const ng1Elem = angular.element(element.querySelector('ng1') as Element);\n+           const ng2Elem = angular.element(element.querySelector('ng2') as Element);\n+           const ng2ChildElem = angular.element(element.querySelector('ng2 span') as Element);\n+\n+           // Attach data to all elements.\n+           appElem.data!('testData', 1);\n+           ng1Elem.data!('testData', 2);\n+           ng2Elem.data!('testData', 3);\n+           ng2ChildElem.data!('testData', 4);\n+\n+           // Verify data can be retrieved.\n+           expect(appElem.data!('testData')).toBe(1);\n+           expect(ng1Elem.data!('testData')).toBe(2);\n+           expect(ng2Elem.data!('testData')).toBe(3);\n+           expect(ng2ChildElem.data!('testData')).toBe(4);\n+\n+           expect(rootScopeDestroySpy).not.toHaveBeenCalled();\n+\n+           // Destroy `PlatformRef`.\n+           platformRef.destroy();\n+\n+           // Verify `$rootScope` has been destroyed and data has been cleaned up.\n+           expect(rootScopeDestroySpy).toHaveBeenCalled();\n+\n+           expect(appElem.data!('testData')).toBeUndefined();\n+           expect(ng1Elem.data!('testData')).toBeUndefined();\n+           expect(ng2Elem.data!('testData')).toBeUndefined();\n+           expect(ng2ChildElem.data!('testData')).toBeUndefined();\n+         });\n+       }));\n+\n     it('should work when compiled outside the dom (by fallback to the root ng2.injector)',\n        waitForAsync(() => {\n          @Component({selector: 'ng2', template: 'test'})"
        },
        {
            "sha": "1b2f4b9f4f0dd585f2711e51659766d47a7d9e1f",
            "filename": "packages/upgrade/static/test/integration/downgrade_module_spec.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fstatic%2Ftest%2Fintegration%2Fdowngrade_module_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b4b21bdff4b07fe9968c8d61fb9f5a2caa662331/packages%2Fupgrade%2Fstatic%2Ftest%2Fintegration%2Fdowngrade_module_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fstatic%2Ftest%2Fintegration%2Fdowngrade_module_spec.ts?ref=b4b21bdff4b07fe9968c8d61fb9f5a2caa662331",
            "patch": "@@ -1353,6 +1353,68 @@ withEachNg1Version(() => {\n            setTimeout(() => expect($injectorFromNg2).toBe($injectorFromNg1));\n          }));\n \n+      it('should destroy the AngularJS app when `PlatformRef` is destroyed', waitForAsync(() => {\n+           @Component({selector: 'ng2', template: '<span>NG2</span>'})\n+           class Ng2Component {\n+           }\n+\n+           @NgModule({\n+             declarations: [Ng2Component],\n+             entryComponents: [Ng2Component],\n+             imports: [BrowserModule],\n+           })\n+           class Ng2Module {\n+             ngDoBootstrap() {}\n+           }\n+\n+           const bootstrapFn = (extraProviders: StaticProvider[]) =>\n+               platformBrowserDynamic(extraProviders).bootstrapModule(Ng2Module);\n+           const lazyModuleName = downgradeModule<Ng2Module>(bootstrapFn);\n+           const ng1Module =\n+               angular.module_('ng1', [lazyModuleName])\n+                   .component('ng1', {template: '<ng2></ng2>'})\n+                   .directive(\n+                       'ng2', downgradeComponent({component: Ng2Component, propagateDigest}));\n+\n+           const element = html('<div><ng1></ng1></div>');\n+           const $injector = angular.bootstrap(element, [ng1Module.name]);\n+\n+           setTimeout(() => {  // Wait for the module to be bootstrapped.\n+             const $rootScope: angular.IRootScopeService = $injector.get($ROOT_SCOPE);\n+             const rootScopeDestroySpy = spyOn($rootScope, '$destroy');\n+\n+             const appElem = angular.element(element);\n+             const ng1Elem = angular.element(element.querySelector('ng1') as Element);\n+             const ng2Elem = angular.element(element.querySelector('ng2') as Element);\n+             const ng2ChildElem = angular.element(element.querySelector('ng2 span') as Element);\n+\n+             // Attach data to all elements.\n+             appElem.data!('testData', 1);\n+             ng1Elem.data!('testData', 2);\n+             ng2Elem.data!('testData', 3);\n+             ng2ChildElem.data!('testData', 4);\n+\n+             // Verify data can be retrieved.\n+             expect(appElem.data!('testData')).toBe(1);\n+             expect(ng1Elem.data!('testData')).toBe(2);\n+             expect(ng2Elem.data!('testData')).toBe(3);\n+             expect(ng2ChildElem.data!('testData')).toBe(4);\n+\n+             expect(rootScopeDestroySpy).not.toHaveBeenCalled();\n+\n+             // Destroy `PlatformRef`.\n+             getPlatform()?.destroy();\n+\n+             // Verify `$rootScope` has been destroyed and data has been cleaned up.\n+             expect(rootScopeDestroySpy).toHaveBeenCalled();\n+\n+             expect(appElem.data!('testData')).toBeUndefined();\n+             expect(ng1Elem.data!('testData')).toBeUndefined();\n+             expect(ng2Elem.data!('testData')).toBeUndefined();\n+             expect(ng2ChildElem.data!('testData')).toBeUndefined();\n+           });\n+         }));\n+\n       describe('(common error)', () => {\n         let Ng2CompA: Type<any>;\n         let Ng2CompB: Type<any>;"
        }
    ],
    "stats": {
        "total": 249,
        "additions": 238,
        "deletions": 11
    }
}