{
    "author": "alxhub",
    "message": "refactor(compiler-cli): introduce CompilationTicket system for NgCompiler (#40561)\n\nPreviously, the incremental flow for NgCompiler was simple: when creating a\nnew NgCompiler instance, the consumer could pass state from a previous\ncompilation, which would cause the new compilation to be performed\nincrementally. \"Local\" information about TypeScript files which had not\nchanged would be passed from the old compilation to the new and reused,\nwhile \"global\" information would always be recalculated.\n\nHowever, this flow could be made more efficient in certain cases, such as\nwhen no TypeScript files are changed in a new compilation. In this case,\n_all_ information extracted during the first compilation is reusable. Doing\nthis involves reusing the previous `NgCompiler` instance (the container for\nsuch global information) and updating it, instead of creating a new one for\nthe next compilation. This approach works cleanly, but complicates the\nlifecycle of `NgCompiler`.\n\nTo prevent consumers from having to deal with the mechanics of reuse vs\nincremental steps of `NgCompiler`, a new `CompilationTicket` mechanism is\nadded in this commit. Consumers obtain a `CompilationTicket` via one of\nseveral code paths depending on the nature of the incoming compilation, and\nuse the `CompilationTicket` to obtain an `NgCompiler` instance. This\ninstance may be a fresh compilation, a new `NgCompiler` for an incremental\ncompilation, or an existing `NgCompiler` that's been updated to optimally\nprocess a resource-only change. Consumers can use the new `NgCompiler`\nwithout knowledge of its provenance.\n\nPR Close #40561",
    "sha": "21e24d14746a6923ac715c97ebfc90324f7264fc",
    "files": [
        {
            "sha": "b21d4f44b91fae3021d3326184eb035ce1edcbc9",
            "filename": "packages/compiler-cli/src/ngtsc/core/README.md",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FREADME.md?ref=21e24d14746a6923ac715c97ebfc90324f7264fc",
            "patch": "@@ -22,11 +22,22 @@ A compiler which integrates Angular compilation into this process follows a very\n 1. A `ts.CompilerHost` is created.\n 2. That `ts.CompilerHost` is wrapped in an `NgCompilerHost`, which adds Angular specific files to the compilation.\n 3. A `ts.Program` is created from the `NgCompilerHost` and its augmented set of root files.\n-4. An `NgCompiler` is created using the `ts.Program`.\n+4. A `CompilationTicket` is created, optionally incorporating any state from a previous compilation run.\n+4. An `NgCompiler` is created using the `CompilationTicket`.\n 5. Diagnostics can be gathered from the `ts.Program` as normal, as well as from the `NgCompiler`.\n 6. Prior to `emit`, `NgCompiler.prepareEmit` is called to retrieve the Angular transformers which need to be fed to `ts.Program.emit`.\n 7. `emit` is called on the `ts.Program` with the Angular transformers from above, which produces JavaScript code with Angular extensions.\n \n+# `NgCompiler` and incremental compilation\n+\n+The Angular compiler is capable of incremental compilation, where information from a previous compilation is used to accelerate the next compilation. During compilation, the compiler produces two major kinds of information: local information (such as component and directive metadata) and global information (such as reified NgModule scopes). Incremental compilation is managed in two ways:\n+\n+1. For most changes, a new `NgCompiler` can selectively inherit local information from a previous instance, and only needs to recompute it where an underlying TypeScript file has change. Global information is always recomputed from scratch in this case.\n+\n+2. For specific changes, such as those in component resources, an `NgCompiler` can be reused in its entirety, and updated to incorporate the effects of such changes without needing to recompute any other information.\n+\n+Note that these two modes differ in terms of whether a new `NgCompiler` instance is needed or whether a previous one can reused. To prevent leaking this implementation complexity and shield consumers from having to manage the lifecycle of `NgCompiler` so specifically, this process is abstracted via `CompilationTicket`s. Consumers first obtain a `CompilationTicket` (depending on the nature of the incoming change), and then use this ticket to retrieve an `NgCompiler` instance. In creating the `CompilationTicket`, the compiler can decide whether to reuse an old `NgCompiler` instance or to create a new one.\n+\n ## Asynchronous compilation\n \n In some compilation environments (such as the Webpack-driven compilation inside the Angular CLI), various inputs to the compilation are only producible in an asynchronous fashion. For example, SASS compilation of `styleUrls` that link to SASS files requires spawning a child Webpack compilation. To support this, Angular has an asynchronous interface for loading such resources."
        },
        {
            "sha": "a9eba8a03228dfaa4ae337969a804614fa9ce643",
            "filename": "packages/compiler-cli/src/ngtsc/core/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Findex.ts?ref=21e24d14746a6923ac715c97ebfc90324f7264fc",
            "patch": "@@ -6,5 +6,5 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-export {NgCompiler} from './src/compiler';\n-export {NgCompilerHost} from './src/host';\n+export * from './src/compiler';\n+export {NgCompilerHost} from './src/host';\n\\ No newline at end of file"
        },
        {
            "sha": "687872955d0b6d3c0a7435cb985bea8b9a776b1a",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 171,
            "deletions": 29,
            "changes": 200,
            "blob_url": "https://github.com/angular/angular/blob/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=21e24d14746a6923ac715c97ebfc90324f7264fc",
            "patch": "@@ -55,6 +55,132 @@ interface LazyCompilationState {\n   resourceRegistry: ResourceRegistry;\n }\n \n+\n+\n+/**\n+ * Discriminant type for a `CompilationTicket`.\n+ */\n+export enum CompilationTicketKind {\n+  Fresh,\n+  IncrementalTypeScript,\n+}\n+\n+/**\n+ * Begin an Angular compilation operation from scratch.\n+ */\n+export interface FreshCompilationTicket {\n+  kind: CompilationTicketKind.Fresh;\n+  options: NgCompilerOptions;\n+  incrementalBuildStrategy: IncrementalBuildStrategy;\n+  typeCheckingProgramStrategy: TypeCheckingProgramStrategy;\n+  enableTemplateTypeChecker: boolean;\n+  usePoisonedData: boolean;\n+  tsProgram: ts.Program;\n+}\n+\n+/**\n+ * Begin an Angular compilation operation that incorporates changes to TypeScript code.\n+ */\n+export interface IncrementalTypeScriptCompilationTicket {\n+  kind: CompilationTicketKind.IncrementalTypeScript;\n+  options: NgCompilerOptions;\n+  oldProgram: ts.Program;\n+  newProgram: ts.Program;\n+  incrementalBuildStrategy: IncrementalBuildStrategy;\n+  typeCheckingProgramStrategy: TypeCheckingProgramStrategy;\n+  newDriver: IncrementalDriver;\n+  enableTemplateTypeChecker: boolean;\n+  usePoisonedData: boolean;\n+}\n+\n+/**\n+ * A request to begin Angular compilation, either starting from scratch or from a known prior state.\n+ *\n+ * `CompilationTicket`s are used to initialize (or update) an `NgCompiler` instance, the core of the\n+ * Angular compiler. They abstract the starting state of compilation and allow `NgCompiler` to be\n+ * managed independently of any incremental compilation lifecycle.\n+ */\n+export type CompilationTicket = FreshCompilationTicket|IncrementalTypeScriptCompilationTicket;\n+\n+/**\n+ * Create a `CompilationTicket` for a brand new compilation, using no prior state.\n+ */\n+export function freshCompilationTicket(\n+    tsProgram: ts.Program, options: NgCompilerOptions,\n+    incrementalBuildStrategy: IncrementalBuildStrategy,\n+    typeCheckingProgramStrategy: TypeCheckingProgramStrategy, enableTemplateTypeChecker: boolean,\n+    usePoisonedData: boolean): CompilationTicket {\n+  return {\n+    kind: CompilationTicketKind.Fresh,\n+    tsProgram,\n+    options,\n+    incrementalBuildStrategy,\n+    typeCheckingProgramStrategy,\n+    enableTemplateTypeChecker,\n+    usePoisonedData,\n+  };\n+}\n+\n+/**\n+ * Create a `CompilationTicket` as efficiently as possible, based on a previous `NgCompiler`\n+ * instance and a new `ts.Program`.\n+ */\n+export function incrementalFromCompilerTicket(\n+    oldCompiler: NgCompiler, newProgram: ts.Program,\n+    incrementalBuildStrategy: IncrementalBuildStrategy,\n+    typeCheckingProgramStrategy: TypeCheckingProgramStrategy,\n+    modifiedResourceFiles: Set<string>): CompilationTicket {\n+  const oldProgram = oldCompiler.getNextProgram();\n+  const oldDriver = oldCompiler.incrementalStrategy.getIncrementalDriver(oldProgram);\n+  if (oldDriver === null) {\n+    // No incremental step is possible here, since no IncrementalDriver was found for the old\n+    // program.\n+    return freshCompilationTicket(\n+        newProgram, oldCompiler.options, incrementalBuildStrategy, typeCheckingProgramStrategy,\n+        oldCompiler.enableTemplateTypeChecker, oldCompiler.usePoisonedData);\n+  }\n+\n+  const newDriver =\n+      IncrementalDriver.reconcile(oldProgram, oldDriver, newProgram, modifiedResourceFiles);\n+\n+  return {\n+    kind: CompilationTicketKind.IncrementalTypeScript,\n+    enableTemplateTypeChecker: oldCompiler.enableTemplateTypeChecker,\n+    usePoisonedData: oldCompiler.usePoisonedData,\n+    options: oldCompiler.options,\n+    incrementalBuildStrategy,\n+    typeCheckingProgramStrategy,\n+    newDriver,\n+    oldProgram,\n+    newProgram,\n+  };\n+}\n+\n+/**\n+ * Create a `CompilationTicket` directly from an old `ts.Program` and associated Angular compilation\n+ * state, along with a new `ts.Program`.\n+ */\n+export function incrementalFromDriverTicket(\n+    oldProgram: ts.Program, oldDriver: IncrementalDriver, newProgram: ts.Program,\n+    options: NgCompilerOptions, incrementalBuildStrategy: IncrementalBuildStrategy,\n+    typeCheckingProgramStrategy: TypeCheckingProgramStrategy, modifiedResourceFiles: Set<string>,\n+    enableTemplateTypeChecker: boolean, usePoisonedData: boolean): CompilationTicket {\n+  const newDriver =\n+      IncrementalDriver.reconcile(oldProgram, oldDriver, newProgram, modifiedResourceFiles);\n+  return {\n+    kind: CompilationTicketKind.IncrementalTypeScript,\n+    oldProgram,\n+    newProgram,\n+    options,\n+    incrementalBuildStrategy,\n+    newDriver,\n+    typeCheckingProgramStrategy,\n+    enableTemplateTypeChecker,\n+    usePoisonedData,\n+  };\n+}\n+\n+\n /**\n  * The heart of the Angular Ivy compiler.\n  *\n@@ -96,19 +222,56 @@ export class NgCompiler {\n   private moduleResolver: ModuleResolver;\n   private resourceManager: AdapterResourceLoader;\n   private cycleAnalyzer: CycleAnalyzer;\n-  readonly incrementalDriver: IncrementalDriver;\n   readonly ignoreForDiagnostics: Set<ts.SourceFile>;\n   readonly ignoreForEmit: Set<ts.SourceFile>;\n \n-  constructor(\n+  /**\n+   * Convert a `CompilationTicket` into an `NgCompiler` instance for the requested compilation.\n+   *\n+   * Depending on the nature of the compilation request, the `NgCompiler` instance may be reused\n+   * from a previous compilation and updated with any changes, it may be a new instance which\n+   * incrementally reuses state from a previous compilation, or it may represent a fresh compilation\n+   * entirely.\n+   */\n+  static fromTicket(\n+      ticket: CompilationTicket, adapter: NgCompilerAdapter, perfRecorder?: PerfRecorder) {\n+    switch (ticket.kind) {\n+      case CompilationTicketKind.Fresh:\n+        return new NgCompiler(\n+            adapter,\n+            ticket.options,\n+            ticket.tsProgram,\n+            ticket.typeCheckingProgramStrategy,\n+            ticket.incrementalBuildStrategy,\n+            IncrementalDriver.fresh(ticket.tsProgram),\n+            ticket.enableTemplateTypeChecker,\n+            ticket.usePoisonedData,\n+            perfRecorder,\n+        );\n+      case CompilationTicketKind.IncrementalTypeScript:\n+        return new NgCompiler(\n+            adapter,\n+            ticket.options,\n+            ticket.newProgram,\n+            ticket.typeCheckingProgramStrategy,\n+            ticket.incrementalBuildStrategy,\n+            ticket.newDriver,\n+            ticket.enableTemplateTypeChecker,\n+            ticket.usePoisonedData,\n+            perfRecorder,\n+        );\n+    }\n+  }\n+\n+  private constructor(\n       private adapter: NgCompilerAdapter,\n-      private options: NgCompilerOptions,\n+      readonly options: NgCompilerOptions,\n       private tsProgram: ts.Program,\n-      private typeCheckingProgramStrategy: TypeCheckingProgramStrategy,\n-      private incrementalStrategy: IncrementalBuildStrategy,\n-      private enableTemplateTypeChecker: boolean,\n-      private usePoisonedData: boolean,\n-      oldProgram: ts.Program|null = null,\n+      readonly typeCheckingProgramStrategy: TypeCheckingProgramStrategy,\n+      readonly incrementalStrategy: IncrementalBuildStrategy,\n+      readonly incrementalDriver: IncrementalDriver,\n+      readonly enableTemplateTypeChecker: boolean,\n+      readonly usePoisonedData: boolean,\n       private perfRecorder: PerfRecorder = NOOP_PERF_RECORDER,\n   ) {\n     this.constructionDiagnostics.push(...this.adapter.constructionDiagnostics);\n@@ -136,31 +299,10 @@ export class NgCompiler {\n         new ModuleResolver(tsProgram, this.options, this.adapter, moduleResolutionCache);\n     this.resourceManager = new AdapterResourceLoader(adapter, this.options);\n     this.cycleAnalyzer = new CycleAnalyzer(new ImportGraph(this.moduleResolver));\n-\n-    let modifiedResourceFiles: Set<string>|null = null;\n-    if (this.adapter.getModifiedResourceFiles !== undefined) {\n-      modifiedResourceFiles = this.adapter.getModifiedResourceFiles() || null;\n-    }\n-\n-    if (oldProgram === null) {\n-      this.incrementalDriver = IncrementalDriver.fresh(tsProgram);\n-    } else {\n-      const oldDriver = this.incrementalStrategy.getIncrementalDriver(oldProgram);\n-      if (oldDriver !== null) {\n-        this.incrementalDriver =\n-            IncrementalDriver.reconcile(oldProgram, oldDriver, tsProgram, modifiedResourceFiles);\n-      } else {\n-        // A previous ts.Program was used to create the current one, but it wasn't from an\n-        // `NgCompiler`. That doesn't hurt anything, but the Angular analysis will have to start\n-        // from a fresh state.\n-        this.incrementalDriver = IncrementalDriver.fresh(tsProgram);\n-      }\n-    }\n     this.incrementalStrategy.setIncrementalDriver(this.incrementalDriver, tsProgram);\n \n     this.ignoreForDiagnostics =\n         new Set(tsProgram.getSourceFiles().filter(sf => this.adapter.isShim(sf)));\n-\n     this.ignoreForEmit = this.adapter.ignoreForEmit;\n   }\n "
        },
        {
            "sha": "f71982ed2fc227bf0854b6cae447a871ed2c74e3",
            "filename": "packages/compiler-cli/src/ngtsc/core/test/compiler_test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 9,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "raw_url": "https://github.com/angular/angular/raw/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts?ref=21e24d14746a6923ac715c97ebfc90324f7264fc",
            "patch": "@@ -10,16 +10,26 @@ import * as ts from 'typescript';\n \n import {absoluteFrom as _, FileSystem, getFileSystem, getSourceFileOrError, NgtscCompilerHost, setFileSystem} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n-import {NoopIncrementalBuildStrategy} from '../../incremental';\n+import {IncrementalBuildStrategy, NoopIncrementalBuildStrategy} from '../../incremental';\n import {ClassDeclaration, isNamedClassDeclaration} from '../../reflection';\n import {ReusedProgramStrategy} from '../../typecheck';\n-import {OptimizeFor} from '../../typecheck/api';\n+import {OptimizeFor, TypeCheckingProgramStrategy} from '../../typecheck/api';\n \n import {NgCompilerOptions} from '../api';\n \n-import {NgCompiler} from '../src/compiler';\n+import {freshCompilationTicket, NgCompiler} from '../src/compiler';\n import {NgCompilerHost} from '../src/host';\n \n+function makeFreshCompiler(\n+    host: NgCompilerHost, options: NgCompilerOptions, program: ts.Program,\n+    programStrategy: TypeCheckingProgramStrategy, incrementalStrategy: IncrementalBuildStrategy,\n+    enableTemplateTypeChecker: boolean, usePoisonedData: boolean): NgCompiler {\n+  const ticket = freshCompilationTicket(\n+      program, options, incrementalStrategy, programStrategy, enableTemplateTypeChecker,\n+      usePoisonedData);\n+  return NgCompiler.fromTicket(ticket, host);\n+}\n+\n runInEachFileSystem(() => {\n   describe('NgCompiler', () => {\n     let fs: FileSystem;\n@@ -50,7 +60,7 @@ runInEachFileSystem(() => {\n       const baseHost = new NgtscCompilerHost(getFileSystem(), options);\n       const host = NgCompilerHost.wrap(baseHost, [COMPONENT], options, /* oldProgram */ null);\n       const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n-      const compiler = new NgCompiler(\n+      const compiler = makeFreshCompiler(\n           host, options, program, new ReusedProgramStrategy(program, host, options, []),\n           new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n           /* usePoisonedData */ false);\n@@ -101,7 +111,7 @@ runInEachFileSystem(() => {\n         const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n         const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n         const CmpC = getClass(getSourceFileOrError(program, cmpCFile), 'CmpC');\n-        const compiler = new NgCompiler(\n+        const compiler = makeFreshCompiler(\n             host, options, program, new ReusedProgramStrategy(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);\n@@ -153,7 +163,7 @@ runInEachFileSystem(() => {\n         const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n         const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n         const CmpC = getClass(getSourceFileOrError(program, cmpCFile), 'CmpC');\n-        const compiler = new NgCompiler(\n+        const compiler = makeFreshCompiler(\n             host, options, program, new ReusedProgramStrategy(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);\n@@ -187,7 +197,7 @@ runInEachFileSystem(() => {\n         const host = NgCompilerHost.wrap(baseHost, [cmpAFile], options, /* oldProgram */ null);\n         const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n         const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n-        const compiler = new NgCompiler(\n+        const compiler = makeFreshCompiler(\n             host, options, program, new ReusedProgramStrategy(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);\n@@ -223,7 +233,7 @@ runInEachFileSystem(() => {\n         const host = NgCompilerHost.wrap(baseHost, [cmpAFile], options, /* oldProgram */ null);\n         const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n         const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n-        const compiler = new NgCompiler(\n+        const compiler = makeFreshCompiler(\n             host, options, program, new ReusedProgramStrategy(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);\n@@ -255,7 +265,7 @@ runInEachFileSystem(() => {\n         const baseHost = new NgtscCompilerHost(getFileSystem(), options);\n         const host = NgCompilerHost.wrap(baseHost, [COMPONENT], options, /* oldProgram */ null);\n         const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n-        const compiler = new NgCompiler(\n+        const compiler = makeFreshCompiler(\n             host, options, program, new ReusedProgramStrategy(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);"
        },
        {
            "sha": "9eacb262c72f14abf4ae3a56f84d2861db827607",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/strategy.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstrategy.ts",
            "raw_url": "https://github.com/angular/angular/raw/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstrategy.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstrategy.ts?ref=21e24d14746a6923ac715c97ebfc90324f7264fc",
            "patch": "@@ -24,6 +24,12 @@ export interface IncrementalBuildStrategy {\n    * future compilations.\n    */\n   setIncrementalDriver(driver: IncrementalDriver, program: ts.Program): void;\n+\n+  /**\n+   * Convert this `IncrementalBuildStrategy` into a possibly new instance to be used in the next\n+   * incremental compilation (may be a no-op if the strategy is not stateful).\n+   */\n+  toNextBuildStrategy(): IncrementalBuildStrategy;\n }\n \n /**\n@@ -36,6 +42,10 @@ export class NoopIncrementalBuildStrategy implements IncrementalBuildStrategy {\n   }\n \n   setIncrementalDriver(): void {}\n+\n+  toNextBuildStrategy(): IncrementalBuildStrategy {\n+    return this;\n+  }\n }\n \n /**\n@@ -78,6 +88,10 @@ export class PatchedProgramIncrementalBuildStrategy implements IncrementalBuildS\n   setIncrementalDriver(driver: IncrementalDriver, program: ts.Program): void {\n     (program as any)[SYM_INCREMENTAL_DRIVER] = driver;\n   }\n+\n+  toNextBuildStrategy(): IncrementalBuildStrategy {\n+    return this;\n+  }\n }\n \n "
        },
        {
            "sha": "28345f581042f6a178625f8a8e6435ee80c4a59d",
            "filename": "packages/compiler-cli/src/ngtsc/program.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 5,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "raw_url": "https://github.com/angular/angular/raw/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts?ref=21e24d14746a6923ac715c97ebfc90324f7264fc",
            "patch": "@@ -12,8 +12,9 @@ import * as ts from 'typescript';\n import * as api from '../transformers/api';\n import {verifySupportedTypeScriptVersion} from '../typescript_support';\n \n-import {NgCompiler, NgCompilerHost} from './core';\n+import {CompilationTicket, freshCompilationTicket, incrementalFromCompilerTicket, NgCompiler, NgCompilerHost} from './core';\n import {NgCompilerOptions} from './core/api';\n+import {absoluteFrom, AbsoluteFsPath} from './file_system';\n import {TrackedIncrementalBuildStrategy} from './incremental';\n import {IndexedComponent} from './indexer';\n import {NOOP_PERF_RECORDER, PerfRecorder, PerfTracker} from './perf';\n@@ -97,12 +98,34 @@ export class NgtscProgram implements api.Program {\n     this.incrementalStrategy = oldProgram !== undefined ?\n         oldProgram.incrementalStrategy.toNextBuildStrategy() :\n         new TrackedIncrementalBuildStrategy();\n+    const modifiedResourceFiles = new Set<AbsoluteFsPath>();\n+    if (this.host.getModifiedResourceFiles !== undefined) {\n+      const strings = this.host.getModifiedResourceFiles();\n+      if (strings !== undefined) {\n+        for (const fileString of strings) {\n+          modifiedResourceFiles.add(absoluteFrom(fileString));\n+        }\n+      }\n+    }\n+\n+    let ticket: CompilationTicket;\n+    if (oldProgram === undefined) {\n+      ticket = freshCompilationTicket(\n+          this.tsProgram, options, this.incrementalStrategy, reusedProgramStrategy,\n+          /* enableTemplateTypeChecker */ false, /* usePoisonedData */ false);\n+    } else {\n+      ticket = incrementalFromCompilerTicket(\n+          oldProgram.compiler,\n+          this.tsProgram,\n+          this.incrementalStrategy,\n+          reusedProgramStrategy,\n+          modifiedResourceFiles,\n+      );\n+    }\n+\n \n     // Create the NgCompiler which will drive the rest of the compilation.\n-    this.compiler = new NgCompiler(\n-        this.host, options, this.tsProgram, reusedProgramStrategy, this.incrementalStrategy,\n-        /** enableTemplateTypeChecker */ false, /* usePoisonedData */ false, reuseProgram,\n-        this.perfRecorder);\n+    this.compiler = NgCompiler.fromTicket(ticket, this.host, this.perfRecorder);\n   }\n \n   getTsProgram(): ts.Program {"
        },
        {
            "sha": "e6ae2920caf680dd7e671c8cc571b539b1519657",
            "filename": "packages/compiler-cli/src/ngtsc/tsc_plugin.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 5,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftsc_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftsc_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftsc_plugin.ts?ref=21e24d14746a6923ac715c97ebfc90324f7264fc",
            "patch": "@@ -8,7 +8,7 @@\n \n import * as ts from 'typescript';\n \n-import {NgCompiler, NgCompilerHost} from './core';\n+import {CompilationTicket, freshCompilationTicket, incrementalFromDriverTicket, NgCompiler, NgCompilerHost} from './core';\n import {NgCompilerOptions, UnifiedModulesHost} from './core/api';\n import {NodeJSFileSystem, setFileSystem} from './file_system';\n import {PatchedProgramIncrementalBuildStrategy} from './incremental';\n@@ -101,10 +101,29 @@ export class NgTscPlugin implements TscPlugin {\n     untagAllTsFiles(program);\n     const typeCheckStrategy = new ReusedProgramStrategy(\n         program, this.host, this.options, this.host.shimExtensionPrefixes);\n-    this._compiler = new NgCompiler(\n-        this.host, this.options, program, typeCheckStrategy,\n-        new PatchedProgramIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n-        /* usePoisonedData */ false, oldProgram, NOOP_PERF_RECORDER);\n+    const strategy = new PatchedProgramIncrementalBuildStrategy();\n+    const oldDriver = oldProgram !== undefined ? strategy.getIncrementalDriver(oldProgram) : null;\n+    let ticket: CompilationTicket;\n+\n+    let modifiedResourceFiles: Set<string>|undefined = undefined;\n+    if (this.host.getModifiedResourceFiles !== undefined) {\n+      modifiedResourceFiles = this.host.getModifiedResourceFiles();\n+    }\n+    if (modifiedResourceFiles === undefined) {\n+      modifiedResourceFiles = new Set<string>();\n+    }\n+\n+    if (oldProgram === undefined || oldDriver === null) {\n+      ticket = freshCompilationTicket(\n+          program, this.options, strategy, typeCheckStrategy,\n+          /* enableTemplateTypeChecker */ false, /* usePoisonedData */ false);\n+    } else {\n+      strategy.toNextBuildStrategy().getIncrementalDriver(oldProgram);\n+      ticket = incrementalFromDriverTicket(\n+          oldProgram, oldDriver, program, this.options, strategy, typeCheckStrategy,\n+          modifiedResourceFiles, false, false);\n+    }\n+    this._compiler = NgCompiler.fromTicket(ticket, this.host, NOOP_PERF_RECORDER);\n     return {\n       ignoreForDiagnostics: this._compiler.ignoreForDiagnostics,\n       ignoreForEmit: this._compiler.ignoreForEmit,"
        },
        {
            "sha": "fed921d8573b867114c9a17670ed4691a6aeb48a",
            "filename": "packages/language-service/ivy/compiler_factory.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 12,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/21e24d14746a6923ac715c97ebfc90324f7264fc/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts?ref=21e24d14746a6923ac715c97ebfc90324f7264fc",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n+import {CompilationTicket, freshCompilationTicket, incrementalFromCompilerTicket, NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {NgCompilerOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n import {TrackedIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/incremental';\n import {TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n@@ -38,17 +38,15 @@ export class CompilerFactory {\n   getOrCreate(): NgCompiler {\n     const program = this.programStrategy.getProgram();\n     if (this.compiler === null || program !== this.lastKnownProgram) {\n-      this.compiler = new NgCompiler(\n-          this.adapter,  // like compiler host\n-          this.options,  // angular compiler options\n-          program,\n-          this.programStrategy,\n-          this.incrementalStrategy,\n-          true,  // enableTemplateTypeChecker\n-          true,  // usePoisonedData\n-          this.lastKnownProgram,\n-          undefined,  // perfRecorder (use default)\n-      );\n+      let ticket: CompilationTicket;\n+      if (this.compiler === null || this.lastKnownProgram === null) {\n+        ticket = freshCompilationTicket(\n+            program, this.options, this.incrementalStrategy, this.programStrategy, true, true);\n+      } else {\n+        ticket = incrementalFromCompilerTicket(\n+            this.compiler, program, this.incrementalStrategy, this.programStrategy, new Set());\n+      }\n+      this.compiler = NgCompiler.fromTicket(ticket, this.adapter);\n       this.lastKnownProgram = program;\n     }\n     return this.compiler;"
        }
    ],
    "stats": {
        "total": 343,
        "additions": 280,
        "deletions": 63
    }
}