{
    "author": "crisbeto",
    "message": "fix(compiler): incorrectly inferring namespace for HTML nodes inside SVG (#38477)\n\nThe HTML parser gets an element's namespace either from the tag name\n(e.g. `<svg:rect>`) or from its parent element `<svg><rect></svg>`) which\nbreaks down when an element is inside of an SVG `foreignElement`,\nbecause foreign elements allow nodes from a different namespace to be\ninserted into an SVG.\n\nThese changes add another flag to the tag definitions which tells child\nnodes whether to try to inherit their namespaces from their parents.\nIt also adds a definition for `foreignObject` with the new flag,\nallowing elements placed inside it to infer their namespaces instead.\n\nFixes #37218.\n\nPR Close #38477",
    "sha": "f5a148b1b74a0dc44b8ad2759648addedfb4d4e5",
    "files": [
        {
            "sha": "26212e3bc1e641c32d2d40704e99fd2bbd920384",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/f5a148b1b74a0dc44b8ad2759648addedfb4d4e5/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f5a148b1b74a0dc44b8ad2759648addedfb4d4e5/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=f5a148b1b74a0dc44b8ad2759648addedfb4d4e5",
            "patch": "@@ -2017,6 +2017,28 @@ export declare class AnimationEvent {\n         expect(diags.length).toBe(0);\n       });\n \n+      it('should allow HTML elements without explicit namespace inside SVG foreignObject', () => {\n+        env.write('test.ts', `\n+        import {Component, NgModule} from '@angular/core';\n+        @Component({\n+          template: \\`\n+            <svg>\n+              <foreignObject>\n+                <div>Hello</div>\n+              </foreignObject>\n+            </svg>\n+          \\`,\n+        })\n+        export class FooCmp {}\n+        @NgModule({\n+          declarations: [FooCmp],\n+        })\n+        export class FooModule {}\n+      `);\n+        const diags = env.driveDiagnostics();\n+        expect(diags.length).toBe(0);\n+      });\n+\n       it('should check for unknown elements inside an SVG foreignObject', () => {\n         env.write('test.ts', `\n         import {Component, NgModule} from '@angular/core';\n@@ -2042,6 +2064,33 @@ export declare class AnimationEvent {\n 1. If 'foo' is an Angular component, then verify that it is part of this module.\n 2. To allow any element add 'NO_ERRORS_SCHEMA' to the '@NgModule.schemas' of this component.`);\n       });\n+\n+      it('should check for unknown elements without explicit namespace inside an SVG foreignObject',\n+         () => {\n+           env.write('test.ts', `\n+        import {Component, NgModule} from '@angular/core';\n+        @Component({\n+          selector: 'blah',\n+          template: \\`\n+            <svg>\n+              <foreignObject>\n+                <foo>Hello</foo>\n+              </foreignObject>\n+            </svg>\n+          \\`,\n+        })\n+        export class FooCmp {}\n+        @NgModule({\n+          declarations: [FooCmp],\n+        })\n+        export class FooModule {}\n+      `);\n+           const diags = env.driveDiagnostics();\n+           expect(diags.length).toBe(1);\n+           expect(diags[0].messageText).toBe(`'foo' is not a known element:\n+1. If 'foo' is an Angular component, then verify that it is part of this module.\n+2. To allow any element add 'NO_ERRORS_SCHEMA' to the '@NgModule.schemas' of this component.`);\n+         });\n     });\n \n     // Test both sync and async compilations, see https://github.com/angular/angular/issues/32538"
        },
        {
            "sha": "e83d7aa670ab4518c85102c630a9fa795895fdcf",
            "filename": "packages/compiler/src/ml_parser/html_tags.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 3,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/f5a148b1b74a0dc44b8ad2759648addedfb4d4e5/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fhtml_tags.ts",
            "raw_url": "https://github.com/angular/angular/raw/f5a148b1b74a0dc44b8ad2759648addedfb4d4e5/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fhtml_tags.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fhtml_tags.ts?ref=f5a148b1b74a0dc44b8ad2759648addedfb4d4e5",
            "patch": "@@ -17,21 +17,24 @@ export class HtmlTagDefinition implements TagDefinition {\n   isVoid: boolean;\n   ignoreFirstLf: boolean;\n   canSelfClose: boolean = false;\n+  preventNamespaceInheritance: boolean;\n \n   constructor({\n     closedByChildren,\n     implicitNamespacePrefix,\n     contentType = TagContentType.PARSABLE_DATA,\n     closedByParent = false,\n     isVoid = false,\n-    ignoreFirstLf = false\n+    ignoreFirstLf = false,\n+    preventNamespaceInheritance = false\n   }: {\n     closedByChildren?: string[],\n     closedByParent?: boolean,\n     implicitNamespacePrefix?: string,\n     contentType?: TagContentType,\n     isVoid?: boolean,\n-    ignoreFirstLf?: boolean\n+    ignoreFirstLf?: boolean,\n+    preventNamespaceInheritance?: boolean\n   } = {}) {\n     if (closedByChildren && closedByChildren.length > 0) {\n       closedByChildren.forEach(tagName => this.closedByChildren[tagName] = true);\n@@ -41,6 +44,7 @@ export class HtmlTagDefinition implements TagDefinition {\n     this.implicitNamespacePrefix = implicitNamespacePrefix || null;\n     this.contentType = contentType;\n     this.ignoreFirstLf = ignoreFirstLf;\n+    this.preventNamespaceInheritance = preventNamespaceInheritance;\n   }\n \n   isClosedByChild(name: string): boolean {\n@@ -88,6 +92,17 @@ export function getHtmlTagDefinition(tagName: string): HtmlTagDefinition {\n       'th': new HtmlTagDefinition({closedByChildren: ['td', 'th'], closedByParent: true}),\n       'col': new HtmlTagDefinition({isVoid: true}),\n       'svg': new HtmlTagDefinition({implicitNamespacePrefix: 'svg'}),\n+      'foreignObject': new HtmlTagDefinition({\n+        // Usually the implicit namespace here would be redundant since it will be inherited from\n+        // the parent `svg`, but we have to do it for `foreignObject`, because the way the parser\n+        // works is that the parent node of an end tag is its own start tag which means that\n+        // the `preventNamespaceInheritance` on `foreignObject` would have it default to the\n+        // implicit namespace which is `html`, unless specified otherwise.\n+        implicitNamespacePrefix: 'svg',\n+        // We want to prevent children of foreignObject from inheriting its namespace, because\n+        // the point of the element is to allow nodes from other namespaces to be inserted.\n+        preventNamespaceInheritance: true,\n+      }),\n       'math': new HtmlTagDefinition({implicitNamespacePrefix: 'math'}),\n       'li': new HtmlTagDefinition({closedByChildren: ['li'], closedByParent: true}),\n       'dt': new HtmlTagDefinition({closedByChildren: ['dt', 'dd']}),\n@@ -111,5 +126,8 @@ export function getHtmlTagDefinition(tagName: string): HtmlTagDefinition {\n           {contentType: TagContentType.ESCAPABLE_RAW_TEXT, ignoreFirstLf: true}),\n     };\n   }\n-  return TAG_DEFINITIONS[tagName.toLowerCase()] || _DEFAULT_TAG_DEFINITION;\n+  // We have to make both a case-sensitive and a case-insesitive lookup, because\n+  // HTML tag names are case insensitive, whereas some SVG tags are case sensitive.\n+  return TAG_DEFINITIONS[tagName] ?? TAG_DEFINITIONS[tagName.toLowerCase()] ??\n+      _DEFAULT_TAG_DEFINITION;\n }"
        },
        {
            "sha": "3d3131989cdc72e8ae0fc61581188c62d9e43e40",
            "filename": "packages/compiler/src/ml_parser/parser.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/f5a148b1b74a0dc44b8ad2759648addedfb4d4e5/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/f5a148b1b74a0dc44b8ad2759648addedfb4d4e5/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fparser.ts?ref=f5a148b1b74a0dc44b8ad2759648addedfb4d4e5",
            "patch": "@@ -10,7 +10,7 @@ import {ParseError, ParseSourceSpan} from '../parse_util';\n \n import * as html from './ast';\n import * as lex from './lexer';\n-import {getNsPrefix, isNgContainer, mergeNsAndName, TagDefinition} from './tags';\n+import {getNsPrefix, mergeNsAndName, splitNsName, TagDefinition} from './tags';\n \n export class TreeError extends ParseError {\n   static create(elementName: string|null, span: ParseSourceSpan, msg: string): TreeError {\n@@ -353,7 +353,11 @@ class _TreeBuilder {\n     if (prefix === '') {\n       prefix = this.getTagDefinition(localName).implicitNamespacePrefix || '';\n       if (prefix === '' && parentElement != null) {\n-        prefix = getNsPrefix(parentElement.name);\n+        const parentTagName = splitNsName(parentElement.name)[1];\n+        const parentTagDefinition = this.getTagDefinition(parentTagName);\n+        if (!parentTagDefinition.preventNamespaceInheritance) {\n+          prefix = getNsPrefix(parentElement.name);\n+        }\n       }\n     }\n "
        },
        {
            "sha": "32b3aab2af62471044b60b6aec4979edf6777836",
            "filename": "packages/compiler/src/ml_parser/tags.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/f5a148b1b74a0dc44b8ad2759648addedfb4d4e5/packages%2Fcompiler%2Fsrc%2Fml_parser%2Ftags.ts",
            "raw_url": "https://github.com/angular/angular/raw/f5a148b1b74a0dc44b8ad2759648addedfb4d4e5/packages%2Fcompiler%2Fsrc%2Fml_parser%2Ftags.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Ftags.ts?ref=f5a148b1b74a0dc44b8ad2759648addedfb4d4e5",
            "patch": "@@ -19,6 +19,7 @@ export interface TagDefinition {\n   isVoid: boolean;\n   ignoreFirstLf: boolean;\n   canSelfClose: boolean;\n+  preventNamespaceInheritance: boolean;\n \n   isClosedByChild(name: string): boolean;\n }"
        },
        {
            "sha": "e4a76ed2456b072157ed0169d2130408073ba118",
            "filename": "packages/compiler/src/ml_parser/xml_tags.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/f5a148b1b74a0dc44b8ad2759648addedfb4d4e5/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fxml_tags.ts",
            "raw_url": "https://github.com/angular/angular/raw/f5a148b1b74a0dc44b8ad2759648addedfb4d4e5/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fxml_tags.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fxml_tags.ts?ref=f5a148b1b74a0dc44b8ad2759648addedfb4d4e5",
            "patch": "@@ -20,6 +20,7 @@ export class XmlTagDefinition implements TagDefinition {\n   isVoid: boolean = false;\n   ignoreFirstLf: boolean = false;\n   canSelfClose: boolean = true;\n+  preventNamespaceInheritance: boolean = false;\n \n   requireExtraParent(currentParent: string): boolean {\n     return false;"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 78,
        "deletions": 5
    }
}