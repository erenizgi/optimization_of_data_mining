{
    "author": "gkalpak",
    "message": "ci: use the local Angular packages when testing AIO/docs examples with RxJS v7 (#43683)\n\nThe `test_aio_local` and `test_docs_examples` CI jobs, test the AIO app\nand the docs examples using the locally built Angular packages. They\nalso include steps that install RxJS v7 and test the examples against\nthat as well, to avoid regressions with RxJS v7.\n\nHowever, it turns out that the `yarn add` command used to install\nRxJS v7 caused yarn to overwrite the local Agular packages in\n`node_modules/` with the ones from NPM.\n\nThis commit ensures that the local Angular packages are restored in\n`node_modules/` after adding RxJS v7. It also adds a check to ensure\nthat the restoration of local Angular packages did not affect the\nversion of RxJS.\n\nPR Close #43683",
    "sha": "99e18a07f69b6dad9cf6e5afa999687cb51a4b7b",
    "files": [
        {
            "sha": "40082e17d2e27cce0677419542a0d54b84c133ce",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 24,
            "deletions": 4,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/99e18a07f69b6dad9cf6e5afa999687cb51a4b7b/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/99e18a07f69b6dad9cf6e5afa999687cb51a4b7b/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=99e18a07f69b6dad9cf6e5afa999687cb51a4b7b",
            "patch": "@@ -431,6 +431,8 @@ jobs:\n \n   test_aio_local:\n     executor: default-executor\n+    environment:\n+      RXJS_VERSION_7: '7.1.0'\n     steps:\n       - custom_attach_workspace\n       - init_environment\n@@ -446,7 +448,15 @@ jobs:\n         # Check the bundle sizes.\n       - run: yarn --cwd aio payload-size aio-local\n         # Run tests with RxJS v7.\n-      - run: yarn --cwd aio add rxjs@7.1.0\n+      - run: yarn --cwd aio add rxjs@$RXJS_VERSION_7 && yarn --cwd aio aio-use-local\n+      - run:\n+          name: Ensure we use RxJS v7\n+          command: >-\n+            node --eval \"\n+              const expected = process.env.RXJS_VERSION_7;\n+              const actual = require('./aio/node_modules/rxjs/package.json').version;\n+              assert(actual === expected, 'Expected RxJS v' + expected + ', but found v' + actual + '.');\n+            \"\n       - run: yarn --cwd aio test --progress=false --watch=false\n \n   test_aio_tools:\n@@ -466,6 +476,8 @@ jobs:\n       name: default-executor\n       resource_class: xlarge\n     parallelism: 5\n+    environment:\n+      RXJS_VERSION_7: '7.1.0'\n     steps:\n       - custom_attach_workspace\n       - init_environment\n@@ -477,8 +489,16 @@ jobs:\n         # with either \"0\", \"1\", etc as node index. This can be passed to the \"--shard\" argument.\n       - run: yarn --cwd aio example-e2e --setup --local --cliSpecsConcurrency=5 --shard=${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}\n         # Run tests with RxJS v7.\n-        # (Exclude some examples that are not yet compatible with v7.)\n-      - run: yarn --cwd aio/tools/examples/shared add rxjs@7.1.0 && yarn --cwd aio boilerplate:add\n+      - run: yarn --cwd aio/tools/examples/shared add rxjs@$RXJS_VERSION_7 && yarn --cwd aio example-use-local && yarn --cwd aio boilerplate:add\n+      - run:\n+          name: Ensure we use RxJS v7\n+          command: >-\n+            node --eval \"\n+              const expected = process.env.RXJS_VERSION_7;\n+              const actual = require('./aio/tools/examples/shared/node_modules/rxjs/package.json').version;\n+              assert(actual === expected, 'Expected RxJS v' + expected + ', but found v' + actual + '.');\n+            \"\n+        # Exclude some examples that are not yet compatible with v7.\n       - run: yarn --cwd aio example-e2e --cliSpecsConcurrency=5 --shard=${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL} --exclude=practical-observable-usage --exclude=upgrade-module --exclude=upgrade-phonecat\n \n   # This job should only be run on PR builds, where `CI_PULL_REQUEST` is not `false`.\n@@ -492,7 +512,7 @@ jobs:\n       - run: ./aio/scripts/build-artifacts.sh $AIO_SNAPSHOT_ARTIFACT_PATH $CI_PULL_REQUEST $CI_COMMIT\n       - store_artifacts:\n           path: *aio_preview_artifact_path\n-          # The `destination` needs to be kept in synch with the value of\n+          # The `destination` needs to be kept in sync with the value of\n           # `AIO_ARTIFACT_PATH` in `aio/aio-builds-setup/Dockerfile`\n           destination: aio/dist/aio-snapshot.tgz\n       - run: node ./aio/scripts/create-preview $CIRCLE_BUILD_NUM"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 24,
        "deletions": 4
    }
}