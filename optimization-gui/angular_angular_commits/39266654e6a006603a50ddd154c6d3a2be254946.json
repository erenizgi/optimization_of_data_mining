{
    "author": "sebastianhaeni",
    "message": "fix(http): queue jsonp <script> tag onLoad event handler in microtask (#39512)\n\nBefore this change, when trying to load a JSONP script that calls the JSONP callback inside a\nmicrotask, it will fail in Internet Explorer 11 and EdgeHTML. This commit changes the onLoad cleanup\nto be queued after the loaded endpoint executed any potential microtask itself. This ensures that\nthe aforementioned browsers will first evaluate the loaded script calling the JSONP callback and\nonly then run the cleanup inside onLoad.\n\nFixes #39496\n\nPR Close #39512",
    "sha": "39266654e6a006603a50ddd154c6d3a2be254946",
    "files": [
        {
            "sha": "aefedf20c0470a3ca57e9de68f1b87f1455d0001",
            "filename": "packages/common/http/src/jsonp.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 24,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/39266654e6a006603a50ddd154c6d3a2be254946/packages%2Fcommon%2Fhttp%2Fsrc%2Fjsonp.ts",
            "raw_url": "https://github.com/angular/angular/raw/39266654e6a006603a50ddd154c6d3a2be254946/packages%2Fcommon%2Fhttp%2Fsrc%2Fjsonp.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fhttp%2Fsrc%2Fjsonp.ts?ref=39266654e6a006603a50ddd154c6d3a2be254946",
            "patch": "@@ -50,6 +50,11 @@ export abstract class JsonpCallbackContext {\n  */\n @Injectable()\n export class JsonpClientBackend implements HttpBackend {\n+  /**\n+   * A resolved promise that can be used to schedule microtasks in the event handlers.\n+   */\n+  private readonly resolvedPromise = Promise.resolve();\n+\n   constructor(private callbackMap: JsonpCallbackContext, @Inject(DOCUMENT) private document: any) {}\n \n   /**\n@@ -140,33 +145,38 @@ export class JsonpClientBackend implements HttpBackend {\n           return;\n         }\n \n-        // Cleanup the page.\n-        cleanup();\n-\n-        // Check whether the response callback has run.\n-        if (!finished) {\n-          // It hasn't, something went wrong with the request. Return an error via\n-          // the Observable error path. All JSONP errors have status 0.\n-          observer.error(new HttpErrorResponse({\n+        // We wrap it in an extra Promise, to ensure the microtask\n+        // is scheduled after the loaded endpoint has executed any potential microtask itself,\n+        // which is not guaranteed in Internet Explorer and EdgeHTML. See issue #39496\n+        this.resolvedPromise.then(() => {\n+          // Cleanup the page.\n+          cleanup();\n+\n+          // Check whether the response callback has run.\n+          if (!finished) {\n+            // It hasn't, something went wrong with the request. Return an error via\n+            // the Observable error path. All JSONP errors have status 0.\n+            observer.error(new HttpErrorResponse({\n+              url,\n+              status: 0,\n+              statusText: 'JSONP Error',\n+              error: new Error(JSONP_ERR_NO_CALLBACK),\n+            }));\n+            return;\n+          }\n+\n+          // Success. body either contains the response body or null if none was\n+          // returned.\n+          observer.next(new HttpResponse({\n+            body,\n+            status: 200,\n+            statusText: 'OK',\n             url,\n-            status: 0,\n-            statusText: 'JSONP Error',\n-            error: new Error(JSONP_ERR_NO_CALLBACK),\n           }));\n-          return;\n-        }\n-\n-        // Success. body either contains the response body or null if none was\n-        // returned.\n-        observer.next(new HttpResponse({\n-          body,\n-          status: 200,\n-          statusText: 'OK',\n-          url,\n-        }));\n \n-        // Complete the stream, the response is over.\n-        observer.complete();\n+          // Complete the stream, the response is over.\n+          observer.complete();\n+        });\n       };\n \n       // onError() is the error callback, which runs if the script returned generates"
        },
        {
            "sha": "10b0e6574d4dc6084c3120e3b28afba0fee9cec7",
            "filename": "packages/common/http/test/jsonp_spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/39266654e6a006603a50ddd154c6d3a2be254946/packages%2Fcommon%2Fhttp%2Ftest%2Fjsonp_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/39266654e6a006603a50ddd154c6d3a2be254946/packages%2Fcommon%2Fhttp%2Ftest%2Fjsonp_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fhttp%2Ftest%2Fjsonp_spec.ts?ref=39266654e6a006603a50ddd154c6d3a2be254946",
            "patch": "@@ -45,6 +45,16 @@ const SAMPLE_REQ = new HttpRequest<never>('JSONP', '/test');\n       runOnlyCallback(home, {data: 'This is a test'});\n       document.mockLoad();\n     });\n+    // Issue #39496\n+    it('handles a request with callback call wrapped in promise', done => {\n+      backend.handle(SAMPLE_REQ).subscribe(() => {\n+        done();\n+      });\n+      Promise.resolve().then(() => {\n+        runOnlyCallback(home, {data: 'This is a test'});\n+      });\n+      document.mockLoad();\n+    });\n     it('handles an error response properly', done => {\n       const error = new Error('This is a test error');\n       backend.handle(SAMPLE_REQ).pipe(toArray()).subscribe(undefined, (err: HttpErrorResponse) => {"
        }
    ],
    "stats": {
        "total": 68,
        "additions": 44,
        "deletions": 24
    }
}