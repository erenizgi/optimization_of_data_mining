{
    "author": "gkalpak",
    "message": "fix(ngcc): support the UMD wrapper function format emitted by Webpack (#44245)\n\nPreviously, ngcc could only handle UMD modules whose wrapper function\nwas implemented as a `ts.ConditionalExpression` (i.e. using a ternary\noperator). This is the format emitted by popular bundlers, such as\nRollup.\n\nThis commit adds support for a different format, that uses `if/else`\nstatements, which is what is [emitted by Webpack][1].\n\n[1]: https://webpack.js.org/configuration/output/#type-umd\n\nFixes #44019\n\nPR Close #44245",
    "sha": "3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77",
    "files": [
        {
            "sha": "645cd87ad5551b17dafacf920d0b6150c27995b7",
            "filename": "packages/compiler-cli/ngcc/src/host/umd_host.ts",
            "status": "modified",
            "additions": 134,
            "deletions": 27,
            "changes": 161,
            "blob_url": "https://github.com/angular/angular/blob/3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts?ref=3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77",
            "patch": "@@ -567,10 +567,15 @@ function getUmdWrapper(statement: ts.Statement):\n \n /**\n  * Parse the wrapper function of a UMD module and extract info about the factory function calls for\n- * the various formats (CommonJS, AMD, global).\n+ * the various formats (CommonJS, CommonJS2, AMD, global).\n  *\n- * The supported format for the UMD wrapper function body is a single statement which is a\n- * `ts.ConditionalExpression` (i.e. using a ternary operator). For example:\n+ * NOTE:\n+ * For more info on the distinction between CommonJS and CommonJS2 see\n+ * https://github.com/webpack/webpack/issues/1114.\n+ *\n+ * The supported format for the UMD wrapper function body is a single statement which is either a\n+ * `ts.ConditionalExpression` (i.e. using a ternary operator) (typically emitted by Rollup) or a\n+ * `ts.IfStatement` (typically emitted by Webpack). For example:\n  *\n  * ```js\n  * // Using a conditional expression:\n@@ -587,32 +592,56 @@ function getUmdWrapper(statement: ts.Statement):\n  *   // ...\n  * }));\n  * ```\n+ *\n+ * or\n+ *\n+ * ```js\n+ * // Using an `if` statement:\n+ * (function (root, factory) {\n+ *   if (typeof exports === 'object' && typeof module === 'object')\n+ *     // CommonJS2 factory call.\n+ *     module.exports = factory(require('foo'), require('bar'));\n+ *   else if (typeof define === 'function' && define.amd)\n+ *     // AMD factory call.\n+ *     define(['foo', 'bar'], factory);\n+ *   else if (typeof exports === 'object')\n+ *     // CommonJS factory call.\n+ *     exports['my-lib'] = factory(require('foo'), require('bar'));\n+ *   else\n+ *     // Global factory call.\n+ *     root['my-lib'] = factory(root['foo'], root['bar']);\n+ * })(global, function (foo, bar) {\n+ *   // ...\n+ * });\n+ * ```\n  */\n function parseUmdWrapperFunction(wrapperFn: ts.FunctionExpression): UmdModule['factoryCalls'] {\n   const stmt = wrapperFn.body.statements[0];\n   let conditionalFactoryCalls: UmdConditionalFactoryCall[];\n \n   if (ts.isExpressionStatement(stmt) && ts.isConditionalExpression(stmt.expression)) {\n     conditionalFactoryCalls = extractFactoryCallsFromConditionalExpression(stmt.expression);\n+  } else if (ts.isIfStatement(stmt)) {\n+    conditionalFactoryCalls = extractFactoryCallsFromIfStatement(stmt);\n   } else {\n     throw new Error(\n-        'UMD wrapper body is not in a supported format (expected a conditional expression):\\n' +\n-        wrapperFn.body.getText());\n+        'UMD wrapper body is not in a supported format (expected a conditional expression or if ' +\n+        'statement):\\n' + wrapperFn.body.getText());\n   }\n \n-  const factoryCalls = {\n-    amdDefine: getAmdDefineCall(conditionalFactoryCalls),\n-    commonJs: getCommonJsFactoryCall(conditionalFactoryCalls),\n-    global: getGlobalFactoryCall(conditionalFactoryCalls),\n-  };\n+  const amdDefine = getAmdDefineCall(conditionalFactoryCalls);\n+  const commonJs = getCommonJsFactoryCall(conditionalFactoryCalls);\n+  const commonJs2 = getCommonJs2FactoryCall(conditionalFactoryCalls);\n+  const global = getGlobalFactoryCall(conditionalFactoryCalls);\n+  const cjsCallForImports = commonJs2 || commonJs;\n \n-  if (factoryCalls.commonJs === null) {\n+  if (cjsCallForImports === null) {\n     throw new Error(\n-        'Unable to find a CommonJS factory call inside the UMD wrapper function:\\n' +\n+        'Unable to find a CommonJS or CommonJS2 factory call inside the UMD wrapper function:\\n' +\n         stmt.getText());\n   }\n \n-  return factoryCalls as (typeof factoryCalls&{commonJs: ts.CallExpression});\n+  return {amdDefine, commonJs, commonJs2, global, cjsCallForImports};\n }\n \n /**\n@@ -657,6 +686,64 @@ function extractFactoryCallsFromConditionalExpression(node: ts.ConditionalExpres\n   return factoryCalls;\n }\n \n+/**\n+ * Extract `UmdConditionalFactoryCall`s from a `ts.IfStatement` of the form:\n+ *\n+ * ```js\n+ * if (typeof exports === 'object' && typeof module === 'object')\n+ *   // CommonJS2 factory call.\n+ *   module.exports = factory(require('foo'), require('bar'));\n+ * else if (typeof define === 'function' && define.amd)\n+ *   // AMD factory call.\n+ *   define(['foo', 'bar'], factory);\n+ * else if (typeof exports === 'object')\n+ *   // CommonJS factory call.\n+ *   exports['my-lib'] = factory(require('foo'), require('bar'));\n+ * else\n+ *   // Global factory call.\n+ *   root['my-lib'] = factory(root['foo'], root['bar']);\n+ * ```\n+ */\n+function extractFactoryCallsFromIfStatement(node: ts.IfStatement): UmdConditionalFactoryCall[] {\n+  const factoryCalls: UmdConditionalFactoryCall[] = [];\n+  let currentNode: ts.Statement|undefined = node;\n+\n+  while (currentNode && ts.isIfStatement(currentNode)) {\n+    if (!ts.isBinaryExpression(currentNode.expression)) {\n+      throw new Error(\n+          'Condition inside UMD wrapper is not a binary expression:\\n' +\n+          currentNode.expression.getText());\n+    }\n+    if (!ts.isExpressionStatement(currentNode.thenStatement)) {\n+      throw new Error(\n+          'Then-statement inside UMD wrapper is not an expression statement:\\n' +\n+          currentNode.thenStatement.getText());\n+    }\n+\n+    factoryCalls.push({\n+      condition: currentNode.expression,\n+      factoryCall: getFunctionCallFromExpression(currentNode.thenStatement.expression),\n+    });\n+\n+    currentNode = currentNode.elseStatement;\n+  }\n+\n+  if (currentNode) {\n+    if (!ts.isExpressionStatement(currentNode)) {\n+      throw new Error(\n+          'Else-statement inside UMD wrapper is not an expression statement:\\n' +\n+          currentNode.getText());\n+    }\n+\n+    factoryCalls.push({\n+      condition: null,\n+      factoryCall: getFunctionCallFromExpression(currentNode.expression),\n+    });\n+  }\n+\n+  return factoryCalls;\n+}\n+\n function getFunctionCallFromExpression(node: ts.Expression): ts.CallExpression {\n   // Be resilient to `node` being inside parenthesis.\n   if (ts.isParenthesizedExpression(node)) {\n@@ -665,8 +752,9 @@ function getFunctionCallFromExpression(node: ts.Expression): ts.CallExpression {\n     return getFunctionCallFromExpression(node.expression);\n   }\n \n-  // Be resilient to `node` being part of a comma expression.\n-  if (ts.isBinaryExpression(node) && node.operatorToken.kind === ts.SyntaxKind.CommaToken) {\n+  // Be resilient to `node` being part of an assignment or comma expression.\n+  if (ts.isBinaryExpression(node) &&\n+      [ts.SyntaxKind.CommaToken, ts.SyntaxKind.EqualsToken].includes(node.operatorToken.kind)) {\n     // NOTE:\n     // Since we are going further down the AST, there is no risk of infinite recursion.\n     return getFunctionCallFromExpression(node.right);\n@@ -698,15 +786,29 @@ function getAmdDefineCall(calls: UmdConditionalFactoryCall[]): ts.CallExpression\n  * Get the factory call for setting up the CommonJS dependencies in the UMD wrapper.\n  */\n function getCommonJsFactoryCall(calls: UmdConditionalFactoryCall[]): ts.CallExpression|null {\n-  // The factory call for CommonJS dependencies is the one that is guarded with a `&&` expression\n-  // whose one side is a `typeof exports` or `typeof module` condition.\n+  // The factory call for CommonJS dependencies is the one that is guarded with a `typeof exports`\n+  // condition.\n   const cjsConditionalCall = calls.find(\n+      call => call.condition?.operatorToken.kind === ts.SyntaxKind.EqualsEqualsEqualsToken &&\n+          isTypeOf(call.condition, 'exports') && ts.isIdentifier(call.factoryCall.expression) &&\n+          call.factoryCall.expression.text === 'factory');\n+\n+  return cjsConditionalCall?.factoryCall ?? null;\n+}\n+\n+/**\n+ * Get the factory call for setting up the CommonJS2 dependencies in the UMD wrapper.\n+ */\n+function getCommonJs2FactoryCall(calls: UmdConditionalFactoryCall[]): ts.CallExpression|null {\n+  // The factory call for CommonJS2 dependencies is the one that is guarded with a `&&` expression\n+  // whose one side is a `typeof exports` or `typeof module` condition.\n+  const cjs2ConditionalCall = calls.find(\n       call => call.condition?.operatorToken.kind === ts.SyntaxKind.AmpersandAmpersandToken &&\n           oneOfBinaryConditions(call.condition, exp => isTypeOf(exp, 'exports', 'module')) &&\n           ts.isIdentifier(call.factoryCall.expression) &&\n           call.factoryCall.expression.text === 'factory');\n \n-  return cjsConditionalCall?.factoryCall ?? null;\n+  return cjs2ConditionalCall?.factoryCall ?? null;\n }\n \n /**\n@@ -733,13 +835,19 @@ function isTypeOf(node: ts.Expression, ...types: string[]): boolean {\n export function getImportsOfUmdModule(umdModule: UmdModule):\n     {parameter: ts.ParameterDeclaration, path: string}[] {\n   const imports: {parameter: ts.ParameterDeclaration, path: string}[] = [];\n-  const cjsFactoryCall = umdModule.factoryCalls.commonJs;\n+  const cjsFactoryCall = umdModule.factoryCalls.cjsCallForImports;\n \n-  for (let i = 1; i < umdModule.factoryFn.parameters.length; i++) {\n-    imports.push({\n-      parameter: umdModule.factoryFn.parameters[i],\n-      path: getRequiredModulePath(cjsFactoryCall, i),\n-    });\n+  // Some UMD formats pass `exports` as the first argument to the factory call, while others don't.\n+  // Compute the index at which the dependencies start (i.e. the index of the first `require` call).\n+  const depStartIndex = cjsFactoryCall.arguments.findIndex(arg => isRequireCall(arg));\n+\n+  if (depStartIndex !== -1) {\n+    for (let i = depStartIndex; i < umdModule.factoryFn.parameters.length; i++) {\n+      imports.push({\n+        parameter: umdModule.factoryFn.parameters[i],\n+        path: getRequiredModulePath(cjsFactoryCall, i),\n+      });\n+    }\n   }\n \n   return imports;\n@@ -748,9 +856,8 @@ export function getImportsOfUmdModule(umdModule: UmdModule):\n interface UmdModule {\n   wrapperFn: ts.FunctionExpression;\n   factoryFn: ts.FunctionExpression;\n-  factoryCalls: {\n-    commonJs: ts.CallExpression; amdDefine: ts.CallExpression | null;\n-    global: ts.CallExpression | null;\n+  factoryCalls: Record<'amdDefine'|'commonJs'|'commonJs2'|'global', ts.CallExpression|null>&{\n+    cjsCallForImports: ts.CallExpression;\n   };\n }\n "
        },
        {
            "sha": "d2b88eeabef6cf099c0ddc9934650d63d8b34b48",
            "filename": "packages/compiler-cli/ngcc/src/rendering/umd_rendering_formatter.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fumd_rendering_formatter.ts",
            "raw_url": "https://github.com/angular/angular/raw/3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fumd_rendering_formatter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fumd_rendering_formatter.ts?ref=3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77",
            "patch": "@@ -62,6 +62,7 @@ export class UmdRenderingFormatter extends Esm5RenderingFormatter {\n \n     // We need to add new `require()` calls for each import in the CommonJS initializer\n     renderCommonJsDependencies(output, factoryCalls.commonJs, imports);\n+    renderCommonJsDependencies(output, factoryCalls.commonJs2, imports);\n     renderAmdDependencies(output, factoryCalls.amdDefine, imports);\n     renderGlobalDependencies(output, factoryCalls.global, imports);\n     renderFactoryParameters(output, factoryFn, imports);\n@@ -134,7 +135,7 @@ export class UmdRenderingFormatter extends Esm5RenderingFormatter {\n }\n \n /**\n- * Add dependencies to the CommonJS part of the UMD wrapper function.\n+ * Add dependencies to the CommonJS/CommonJS2 part of the UMD wrapper function.\n  */\n function renderCommonJsDependencies(\n     output: MagicString, factoryCall: ts.CallExpression|null, imports: Import[]) {"
        },
        {
            "sha": "839eefd600517eef5d14e7b7ec5454c8ddb414ac",
            "filename": "packages/compiler-cli/ngcc/test/dependencies/umd_dependency_host_spec.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts?ref=3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77",
            "patch": "@@ -33,6 +33,15 @@ runInEachFileSystem(() => {\n         expect(ts.createSourceFile).not.toHaveBeenCalled();\n       });\n \n+      it('should correctly process files with no imports', () => {\n+        const {dependencies, missing, deepImports} = createDependencyInfo();\n+        host.collectDependencies(\n+            _('/no/imports/but/cannot/skip/index.js'), {dependencies, missing, deepImports});\n+        expect(dependencies.size).toBe(0);\n+        expect(missing.size).toBe(0);\n+        expect(deepImports.size).toBe(0);\n+      });\n+\n       it('should resolve all the external imports of the source file', () => {\n         const {dependencies, missing, deepImports} = createDependencyInfo();\n         host.collectDependencies(\n@@ -143,6 +152,18 @@ runInEachFileSystem(() => {\n         },\n         {name: _('/no/imports/or/re-exports/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n         {name: _('/no/imports/or/re-exports/index.metadata.json'), contents: 'MOCK METADATA'},\n+        {\n+          name: _('/no/imports/but/cannot/skip/index.js'),\n+          contents:\n+              '// A file containing text that looks like a `require(\"call\")` to trick the host\\n' +\n+              '// into processing it even if it has no actual dependencies.\\n' +\n+              umd('no_imports_but_cannot_skip', []),\n+        },\n+        {\n+          name: _('/no/imports/but/cannot/skip/package.json'),\n+          contents: '{\"esm2015\": \"./index.js\"}'\n+        },\n+        {name: _('/no/imports/but/cannot/skip/index.metadata.json'), contents: 'MOCK METADATA'},\n         {\n           name: _('/external/imports/index.js'),\n           contents: umd('imports_index', ['lib_1', 'lib_1/sub_1'])"
        },
        {
            "sha": "5982b1226e9e053c4b6ef1aa1151520eaeed0022",
            "filename": "packages/compiler-cli/ngcc/test/host/umd_host_spec.ts",
            "status": "modified",
            "additions": 2679,
            "deletions": 2766,
            "changes": 5445,
            "blob_url": "https://github.com/angular/angular/blob/3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts?ref=3c8a5d1c706fe0ebff621f76eb9e98e0f5ec0f77"
        }
    ],
    "stats": {
        "total": 5630,
        "additions": 2836,
        "deletions": 2794
    }
}