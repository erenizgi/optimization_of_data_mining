{
    "author": "JoostK",
    "message": "perf(compiler-cli): skip analysis in incremental builds for files without Angular behavior (#42562)\n\nIn an incremental rebuild, the compiler attempts to reuse as much\nanalysis data from a prior compilation as possible to avoid doing the\nanalysis work again. For source files without Angular behavior however,\nno analysis data would be recorded such that the source file had to be\nreanalyzed each rebuild, even if it has not changed.\n\nThis commit avoids the analysis of such source files by registering\nthese files as not containing any Angular behavior; allowing subsequent\nrebuilds to avoid the analysis work.\n\nPR Close #42562",
    "sha": "5fb23ecceaccf0629308dd50210b65f67d51f024",
    "files": [
        {
            "sha": "87186fbb2bb259ed788df320a4cb0c446e1c2fb1",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/compilation.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 5,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/5fb23ecceaccf0629308dd50210b65f67d51f024/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "raw_url": "https://github.com/angular/angular/raw/5fb23ecceaccf0629308dd50210b65f67d51f024/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts?ref=5fb23ecceaccf0629308dd50210b65f67d51f024",
            "patch": "@@ -82,6 +82,12 @@ export class TraitCompiler implements ProgramTypeCheckAdapter {\n    */\n   protected fileToClasses = new Map<ts.SourceFile, Set<ClassDeclaration>>();\n \n+  /**\n+   * Tracks which source files have been analyzed but did not contain any traits. This set allows\n+   * the compiler to skip analyzing these files in an incremental rebuild.\n+   */\n+  protected filesWithoutTraits = new Set<ts.SourceFile>();\n+\n   private reexportMap = new Map<string, Map<string, [string, string]>>();\n \n   private handlersByName =\n@@ -121,12 +127,17 @@ export class TraitCompiler implements ProgramTypeCheckAdapter {\n \n     const priorWork = this.incrementalBuild.priorAnalysisFor(sf);\n     if (priorWork !== null) {\n-      for (const priorRecord of priorWork) {\n-        this.adopt(priorRecord);\n-      }\n-\n       this.perf.eventCount(PerfEvent.SourceFileReuseAnalysis);\n-      this.perf.eventCount(PerfEvent.TraitReuseAnalysis, priorWork.length);\n+\n+      if (priorWork.length > 0) {\n+        for (const priorRecord of priorWork) {\n+          this.adopt(priorRecord);\n+        }\n+\n+        this.perf.eventCount(PerfEvent.TraitReuseAnalysis, priorWork.length);\n+      } else {\n+        this.filesWithoutTraits.add(sf);\n+      }\n \n       // Skip the rest of analysis, as this file's prior traits are being reused.\n       return;\n@@ -176,6 +187,9 @@ export class TraitCompiler implements ProgramTypeCheckAdapter {\n       }\n       result.set(sf, records);\n     }\n+    for (const sf of this.filesWithoutTraits) {\n+      result.set(sf, []);\n+    }\n     return result;\n   }\n "
        }
    ],
    "stats": {
        "total": 24,
        "additions": 19,
        "deletions": 5
    }
}