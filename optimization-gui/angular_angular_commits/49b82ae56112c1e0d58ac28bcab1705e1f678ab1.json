{
    "author": "devversion",
    "message": "feat(bazel): implement partial compilation APF v13 for `ng_package` rule (#43431)\n\nThis commit implements partial compilation APF v13 for the\n`ng_package` rule. The changes involve the following things:\n\n1. Requesting the partial compilation output for all targets (and\n   its transitives) in the `deps` or `srcs` attributes.\n\n2. Downleveling of ES2020 prodmode output to a FESM2015 file.\n\n3. Cleanup of file resolution. Previusly, execroot file paths (which are\n   passed to the packager tool) were composed manually. This is prone to\n   mistakes and breaks with transitions.\n\n   A lot of this code can be simplified by passing the necessary Bazel\n   `File` information as JSON. This also simplifies the packager tool\n   significantly (and makes it more readable..)\n\n4. Remoal of UMD bundles. This also allows us remove the `globals` rule\n   attribute with `externals` (we do not need any UMD global identifier\n   names anymore).\n\n5. The `package.json` will set the `exports` field and use subpath\n   exports to make module resolution work for ESM consumers.\n\n6. TSLib is also always set as `external` now. Previously it had to be\n   added as `dep` to the `ng_package` rule as UMD files bundled `tslib`.\n\n7. The `include_devmode_srcs` option has been removed. This option was\n   an addition to APF that allowed the `@angular/compiler` to ship\n   non-flattened ES5 CommonJS sources. We want to keep APF consistent\n   and not allow such exceptions. Compiler is now a strict APF package\n   as well, and the compiler-cli just needs to go through the primary\n   entry-point for things it needs (or it bundles the necessary parts\n   into the CLI.)\n\nOverall, these are all changes. A lot of changes to make the packager\nrule and tool more readable and Bazel-idiomatic were made as well. This\nallows us to easier make packaging changes in the future, and it's more\nfuture-proof if we ever change how inputs (like `ng_module` targets) are\ngenerated (e.g. consider a case where we'd use the `ts_project` rule).\n\nPR Close #43431",
    "sha": "49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
    "files": [
        {
            "sha": "b143e7737205dde5203baa1e3891b5fa561c5d74",
            "filename": "packages/bazel/package.json",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fpackage.json?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -30,12 +30,12 @@\n   \"peerDependencies\": {\n     \"@angular/compiler-cli\": \"0.0.0-PLACEHOLDER\",\n     \"@bazel/typescript\": \">=1.0.0\",\n-    \"terser\": \"^4.3.1\",\n-    \"typescript\": \">=4.2.3 <4.5\",\n-    \"rollup\": \">=1.20.0\",\n-    \"rollup-plugin-commonjs\": \">=9.0.0\",\n-    \"rollup-plugin-node-resolve\": \">=4.2.0\",\n-    \"rollup-plugin-sourcemaps\": \">=0.4.0\"\n+    \"@rollup/plugin-commonjs\": \"^20.0.0\",\n+    \"@rollup/plugin-node-resolve\": \"^13.0.4\",\n+    \"rollup\": \"^2.56.3\",\n+    \"rollup-plugin-sourcemaps\": \"^0.6.3\",\n+    \"terser\": \"^5.9.0\",\n+    \"typescript\": \">=4.2.3 <4.5\"\n   },\n   \"peerDependenciesMeta\": {\n     \"terser\": {"
        },
        {
            "sha": "fb90d50b7e86cfb5b15df3315740ea638b8bc5d3",
            "filename": "packages/bazel/src/ng_package/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Fsrc%2Fng_package%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Fsrc%2Fng_package%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_package%2FBUILD.bazel?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -16,11 +16,11 @@ nodejs_binary(\n         # BEGIN-DEV-ONLY\n         \"@npm\" +\n         # END-DEV-ONLY\n-        \"//rollup-plugin-commonjs\",\n+        \"//@rollup/plugin-commonjs\",\n         # BEGIN-DEV-ONLY\n         \"@npm\" +\n         # END-DEV-ONLY\n-        \"//rollup-plugin-node-resolve\",\n+        \"//@rollup/plugin-node-resolve\",\n         # BEGIN-DEV-ONLY\n         \"@npm\" +\n         # END-DEV-ONLY"
        },
        {
            "sha": "e47d649613bd114a3b1790cd192adf4de4a106ee",
            "filename": "packages/bazel/src/ng_package/collect-type-definitions.bzl",
            "status": "removed",
            "additions": 0,
            "deletions": 43,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/fcd958dd9fb6ee0de71903beec67a966d0141d3c/packages%2Fbazel%2Fsrc%2Fng_package%2Fcollect-type-definitions.bzl",
            "raw_url": "https://github.com/angular/angular/raw/fcd958dd9fb6ee0de71903beec67a966d0141d3c/packages%2Fbazel%2Fsrc%2Fng_package%2Fcollect-type-definitions.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_package%2Fcollect-type-definitions.bzl?ref=fcd958dd9fb6ee0de71903beec67a966d0141d3c",
            "patch": "@@ -1,43 +0,0 @@\n-# Copyright Google LLC. All Rights Reserved.\n-#\n-# Use of this source code is governed by an MIT-style license that can be\n-# found in the LICENSE file at https://angular.io/license\n-\n-\"\"\"Collect TypeScript definition files from a rule context.\n-\n-This is used to find all files that will be copied into a \"ng_package\".\n-\"\"\"\n-\n-load(\"@build_bazel_rules_nodejs//:providers.bzl\", \"DeclarationInfo\")\n-\n-def _filter_typing_files(files):\n-    return [file for file in files if file.path.endswith(\".d.ts\")]\n-\n-def collect_type_definitions(ctx):\n-    \"\"\"Returns a file tree containing only TypeScript definition files.\n-\n-    This is useful when packaging a \"ng_package\" where we only want to package specified\n-    definition files.\n-\n-    Args:\n-      ctx: ctx.\n-\n-    Returns:\n-      A file tree containing only TypeScript definition files.\n-    \"\"\"\n-\n-    # Add all source files and filter for TypeScript definition files\n-    # See: https://docs.bazel.build/versions/master/skylark/lib/File.html#is_source\n-    collected_files = _filter_typing_files([d for d in ctx.files.deps if d.is_source])\n-\n-    # In case source files have been explicitly specified in the attributes, just collect\n-    # them and filter for definition files.\n-    if hasattr(ctx.attr, \"srcs\"):\n-        collected_files += _filter_typing_files(ctx.files.srcs)\n-\n-    # Collect all TypeScript definition files from the specified dependencies.\n-    for dep in ctx.attr.deps:\n-        if DeclarationInfo in dep:\n-            collected_files += dep[DeclarationInfo].transitive_declarations.to_list()\n-\n-    return collected_files"
        },
        {
            "sha": "b93c263b1be7d0a4f51784f54900846490012571",
            "filename": "packages/bazel/src/ng_package/ng_package.bzl",
            "status": "modified",
            "additions": 233,
            "deletions": 348,
            "changes": 581,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Fsrc%2Fng_package%2Fng_package.bzl",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Fsrc%2Fng_package%2Fng_package.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_package%2Fng_package.bzl?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -13,15 +13,16 @@ It packages your library following the Angular Package Format, see the\n specification of this format at https://goo.gl/jB3GVv\n \"\"\"\n \n-load(\"@build_bazel_rules_nodejs//:providers.bzl\", \"JSEcmaScriptModuleInfo\", \"JSNamedModuleInfo\", \"NodeContextInfo\", \"NpmPackageInfo\", \"node_modules_aspect\")\n+load(\"@build_bazel_rules_nodejs//:providers.bzl\", \"DeclarationInfo\", \"JSEcmaScriptModuleInfo\", \"NodeContextInfo\", \"NpmPackageInfo\", \"node_modules_aspect\")\n+load(\"@build_bazel_rules_nodejs//internal/linker:link_node_modules.bzl\", \"LinkerPackageMappingInfo\")\n load(\n     \"@build_bazel_rules_nodejs//internal/pkg_npm:pkg_npm.bzl\",\n     \"PKG_NPM_ATTRS\",\n     \"PKG_NPM_OUTPUTS\",\n     \"create_package\",\n )\n load(\"//packages/bazel/src:external.bzl\", \"FLAT_DTS_FILE_SUFFIX\")\n-load(\"//packages/bazel/src/ng_package:collect-type-definitions.bzl\", \"collect_type_definitions\")\n+load(\"//packages/bazel/src/ng_module:partial_compilation.bzl\", \"partial_compilation_transition\")\n \n # Prints a debug message if \"--define=VERBOSE_LOGS=true\" is specified.\n def _debug(vars, *args):\n@@ -69,61 +70,42 @@ ng_package_module_mappings_aspect = aspect(\n     attr_aspects = [\"deps\"],\n )\n \n-# Convert from some-dash-case to someCamelCase\n-def _convert_dash_case_to_camel_case(s):\n-    parts = s.split(\"-\")\n-\n-    # First letter in the result is always unchanged\n-    return s[0] + \"\".join([p.capitalize() for p in parts])[1:]\n-\n-# Convert from a package name on npm to an identifier that's a legal global symbol\n-#  @angular/core -> ng.core\n-#  @angular/platform-browser-dynamic/testing -> ng.platformBrowserDynamic.testing\n-def _global_name(package_name):\n-    # strip npm scoped package qualifier\n-    start = 1 if package_name.startswith(\"@\") else 0\n-    parts = package_name[start:].split(\"/\")\n-    result_parts = []\n-    for p in parts:\n-        # Special case for angular's short name\n-        if p == \"angular\":\n-            result_parts.append(\"ng\")\n-        else:\n-            result_parts.append(_convert_dash_case_to_camel_case(p))\n-    return \".\".join(result_parts)\n-\n-WELL_KNOWN_GLOBALS = {p: _global_name(p) for p in [\n-    \"@angular/upgrade\",\n-    \"@angular/upgrade/static\",\n-    \"@angular/forms\",\n-    \"@angular/core/testing\",\n-    \"@angular/core\",\n-    \"@angular/platform-server/init\",\n-    \"@angular/platform-server/testing\",\n-    \"@angular/platform-server\",\n-    \"@angular/common/testing\",\n+WELL_KNOWN_EXTERNALS = [\n+    \"@angular/animations\",\n+    \"@angular/animations/browser\",\n+    \"@angular/animations/browser/testing\",\n     \"@angular/common\",\n-    \"@angular/common/http/testing\",\n     \"@angular/common/http\",\n-    \"@angular/elements\",\n-    \"@angular/platform-browser-dynamic/testing\",\n-    \"@angular/platform-browser-dynamic\",\n-    \"@angular/compiler/testing\",\n+    \"@angular/common/http/testing\",\n+    \"@angular/common/testing\",\n+    \"@angular/common/upgrade\",\n     \"@angular/compiler\",\n-    \"@angular/animations\",\n-    \"@angular/animations/browser/testing\",\n-    \"@angular/animations/browser\",\n-    \"@angular/service-worker/config\",\n-    \"@angular/service-worker\",\n-    \"@angular/platform-browser/testing\",\n+    \"@angular/compiler/testing\",\n+    \"@angular/core\",\n+    \"@angular/core/testing\",\n+    \"@angular/elements\",\n+    \"@angular/forms\",\n+    \"@angular/localize\",\n+    \"@angular/localize/init\",\n     \"@angular/platform-browser\",\n     \"@angular/platform-browser/animations\",\n-    \"@angular/router/upgrade\",\n-    \"@angular/router/testing\",\n+    \"@angular/platform-browser/testing\",\n+    \"@angular/platform-browser-dynamic\",\n+    \"@angular/platform-browser-dynamic/testing\",\n+    \"@angular/platform-server\",\n+    \"@angular/platform-server/init\",\n+    \"@angular/platform-server/testing\",\n     \"@angular/router\",\n+    \"@angular/router/testing\",\n+    \"@angular/router/upgrade\",\n+    \"@angular/service-worker\",\n+    \"@angular/service-worker/config\",\n+    \"@angular/upgrade\",\n+    \"@angular/upgrade/static\",\n     \"rxjs\",\n     \"rxjs/operators\",\n-]}\n+    \"tslib\",\n+]\n \n def _compute_node_modules_root(ctx):\n     \"\"\"Computes the node_modules root from the node_modules and deps attributes.\n@@ -151,8 +133,7 @@ def _write_rollup_config(\n         ctx,\n         root_dir,\n         filename = \"_%s.rollup.conf.js\",\n-        include_tslib = False,\n-        downlevel_to_es5 = False):\n+        downlevel_to_es2015 = False):\n     \"\"\"Generate a rollup config file.\n \n     Args:\n@@ -175,10 +156,7 @@ def _write_rollup_config(\n                           (dep.label, k, mappings[k], v)), \"deps\")\n                 mappings[k] = v\n \n-    globals = dict(WELL_KNOWN_GLOBALS, **ctx.attr.globals)\n-    external = globals.keys()\n-    if not include_tslib:\n-        external.append(\"tslib\")\n+    externals = WELL_KNOWN_EXTERNALS + ctx.attr.externals\n \n     # Whether the --stamp flag is applied in the context of the action's execution.\n     stamp = ctx.attr.node_context_data[NodeContextInfo].stamp\n@@ -197,30 +175,21 @@ def _write_rollup_config(\n             \"TMPL_root_dir\": root_dir,\n             \"TMPL_stamp_data\": \"\\\"%s\\\"\" % ctx.version_file.path if (stamp and ctx.version_file) else \"undefined\",\n             \"TMPL_workspace_name\": ctx.workspace_name,\n-            \"TMPL_external\": \", \".join([\"'%s'\" % e for e in external]),\n-            \"TMPL_globals\": \", \".join([\"'%s': '%s'\" % g for g in globals.items()]),\n-            \"TMPL_downlevel_to_es5\": \"true\" if downlevel_to_es5 else \"false\",\n+            \"TMPL_external\": \", \".join([\"'%s'\" % e for e in externals]),\n+            \"TMPL_downlevel_to_es2015\": \"true\" if downlevel_to_es2015 else \"false\",\n         },\n     )\n \n     return config\n \n-def _run_rollup(ctx, bundle_name, rollup_config, entry_point, inputs, js_output, format, module_name = \"\"):\n+def _run_rollup(ctx, bundle_name, rollup_config, entry_point, inputs, js_output, format):\n     map_output = ctx.actions.declare_file(js_output.basename + \".map\", sibling = js_output)\n \n     args = ctx.actions.args()\n-    args.add(\"--input\", entry_point)\n+    args.add(\"--input\", entry_point.path)\n     args.add(\"--config\", rollup_config)\n     args.add(\"--output.file\", js_output)\n     args.add(\"--output.format\", format)\n-    if module_name:\n-        args.add(\"--output.name\", _global_name(module_name))\n-        args.add(\"--amd.id\", module_name)\n-    elif format == \"umd\" or format == \"iife\":\n-        # If we're generating UMD or IIFE we need a global name.\n-        # See https://risanb.com/posts/bundling-your-javascript-library-with-rollup/#umd-output and\n-        # https://risanb.com/posts/bundling-your-javascript-library-with-rollup/#umd-output.\n-        args.add(\"--output.name\", ctx.label.name)\n \n     # After updating to build_bazel_rules_nodejs 0.27.0+, rollup has been updated to v1.3.1\n     # which tree shakes @__PURE__ annotations and const variables which are later amended by NGCC.\n@@ -259,231 +228,238 @@ def _run_rollup(ctx, bundle_name, rollup_config, entry_point, inputs, js_output,\n         tools = [ctx.executable.rollup],\n         arguments = [args],\n     )\n-    return struct(\n-        js = js_output,\n-        map = map_output,\n-    )\n+    return [js_output, map_output]\n \n-# convert from [{js: js_file1, map: map_file1}, ...] to\n-# [js_filepath1, map_filepath1, ...]\n-def _flatten_paths(directory):\n+# Serializes a file into a struct that matches the `BazelFileInfo` type in the\n+# packager implementation. Useful for transmission of such information.\n+def _serialize_file(file):\n+    return struct(path = file.path, shortPath = file.short_path)\n+\n+# Serializes a list of files into a JSON string that can be passed as CLI argument\n+# for the packager, matching the `BazelFileInfo[]` type in the packager implementation.\n+def _serialize_files_for_arg(files):\n     result = []\n-    for f in directory:\n-        result.append(f.js.path)\n-        if f.map:\n-            result.append(f.map.path)\n-    return result\n+    for file in files:\n+        result.append(_serialize_file(file))\n+    return json.encode(result)\n+\n+def _filter_js_inputs(all_inputs):\n+    return [f for f in all_inputs if f.path.endswith(\".js\") or f.path.endswith(\".json\")]\n+\n+def _find_matching_file(files, search_short_path):\n+    for file in files:\n+        if file.short_path == search_short_path:\n+            return file\n+    fail(\"Could not find file that is expected to exist: %s\" % search_short_path)\n+\n+def _is_part_of_package(file, owning_package):\n+    return file.short_path.startswith(owning_package)\n \n-# Takes a depset of files and returns a depset that doesn't contain any generated files by NGC.\n-# Optionally can filter out files that do not belong to a specified package path.\n-def _filter_out_generated_files(files, extension, package_path = None):\n+def _filter_esm_files_to_include(files, owning_package):\n     result = []\n \n-    # If `files` is a depset, convert it to a list. Note that we do not compare the type\n-    # of files against a literal as per best practices within Bazel Starlark.\n-    # https://docs.bazel.build/versions/main/skylark/lib/globals.html#type.\n-    files_list = files.to_list() if type(files) == type(depset()) else files\n-    for file in files_list:\n-        # If the \"package_path\" parameter has been specified, filter out files\n-        # that do not start with the specified package path.\n-        if package_path and not file.short_path.startswith(package_path):\n+    for file in files:\n+        # We skip all `.externs.js` files as those should not be shipped as part of\n+        # the ESM2020 output. The externs are empty because `ngc-wrapped` disables\n+        # externs generation in prodmode for workspaces other than `google3`.\n+        if file.path.endswith(\"externs.js\"):\n             continue\n \n-        # Filter out files that are generated by the Angular Compiler CLI.\n-        if (not (file.path.endswith(\".ngfactory.%s\" % extension) or\n-                 file.path.endswith(\".ngsummary.%s\" % extension) or\n-                 file.path.endswith(\".ngstyle.%s\" % extension))):\n+        # We omit all non-JavaScript files. These are not required for the FESM bundle\n+        # generation and are not expected to be put into the `esm2020` output.\n+        if not file.path.endswith(\".js\") and not file.path.endswith(\".mjs\"):\n+            continue\n+\n+        if _is_part_of_package(file, owning_package):\n             result.append(file)\n \n-    return depset(result)\n+    return result\n \n-def _filter_js_inputs(all_inputs):\n-    all_inputs_list = all_inputs.to_list() if type(all_inputs) == type(depset()) else all_inputs\n-    return [\n-        f\n-        for f in all_inputs_list\n-        if f.path.endswith(\".js\") or f.path.endswith(\".json\")\n-    ]\n+def _filter_typings_to_include(files, owning_package):\n+    return [f for f in files if _is_part_of_package(f, owning_package)]\n \n # ng_package produces package that is npm-ready.\n def _ng_package_impl(ctx):\n     npm_package_directory = ctx.actions.declare_directory(\"%s.ng_pkg\" % ctx.label.name)\n+    owning_package = ctx.label.package\n \n-    esm_2015_files_depsets = []\n-    for dep in ctx.attr.deps:\n-        if JSEcmaScriptModuleInfo in dep:\n-            esm_2015_files_depsets.append(dep[JSEcmaScriptModuleInfo].sources)\n+    # The name of the primary entry-point FESM bundles. If not explicitly provided through\n+    # the entry-point name attribute, we compute the name from the owning package\n+    # e.g. if defined in `packages/core:npm_package`, the name is resolved to be `core`.\n+    primary_bundle_name = \\\n+        ctx.attr.primary_bundle_name if ctx.attr.primary_bundle_name else owning_package.split(\"/\")[-1]\n \n-    esm_2015_files = _filter_out_generated_files(depset(transitive = esm_2015_files_depsets), \"mjs\")\n+    # Disallow generated files in the \"srcs\" attribute.\n+    for src in ctx.files.srcs:\n+        if not src.is_source:\n+            fail(\"Unexpected generated files in the `srcs` attribute of `ng_package`.\")\n \n     # These accumulators match the directory names where the files live in the\n     # Angular package format.\n+    fesm2020 = []\n     fesm2015 = []\n-    esm2015 = []\n-    bundles = []\n     bundled_type_definitions = []\n-    type_definitions = []\n \n-    # Collect all prodmode esm2015 source files which should be copied into the\n-    # `esm2015` folder according to Angular Package Format v10.\n-    for f in esm_2015_files.to_list():\n-        # tsickle generated `{module}.externs.js` file will be added to JSEcmaScriptModuleInfo sources\n-        # by ng_module so we include both .js and .mjs sources from the JSEcmaScriptModuleInfo provider\n-        if f.path.endswith(\".js\") or f.path.endswith(\".mjs\"):\n-            esm2015.append(struct(js = f, map = None))\n+    # We collect all ESM2020 source\n+    unscoped_esm2020_depsets = []\n+    unscoped_type_definition_depsets = []\n \n     # We infer the entry points to be:\n     # - ng_module rules in the deps (they have an \"angular\" provider)\n     # - in this package or a subpackage\n     # - those that have a module_name attribute (they produce flat module metadata)\n     collected_entry_points = []\n \n-    deps_in_package = [d for d in ctx.attr.deps if d.label.package.startswith(ctx.label.package)]\n-    for dep in deps_in_package:\n+    # Name of the NPM package. The name is computed as we iterate through all\n+    # dependencies of the `ng_package`.\n+    npm_package_name = None\n+\n+    for dep in ctx.attr.deps:\n+        if not dep.label.package.startswith(owning_package):\n+            fail(\"Unexpected dependency. %s is defined outside of %s.\" % (dep, owning_package))\n+\n+        # Collect ESM2020 source files from the dependency, including transitive sources which\n+        # are not directly defined in the entry-point. This is necessary to allow for\n+        # entry-points to rely on sub-targets (which can be done for incrementality).\n+        if JSEcmaScriptModuleInfo in dep:\n+            unscoped_esm2020_depsets.append(dep[JSEcmaScriptModuleInfo].sources)\n+\n+        # Collect the type definitions files for the entry-point.\n+        if hasattr(dep, \"dts_bundle\"):\n+            bundled_type_definitions.append(dep.dts_bundle)\n+        elif DeclarationInfo in dep:\n+            unscoped_type_definition_depsets.append(dep[DeclarationInfo].transitive_declarations)\n+\n+        if len(unscoped_type_definition_depsets) > 0 and len(bundled_type_definitions) > 0:\n+            # bundle_dts needs to be enabled/disabled for all entry points.\n+            fail(\"Expected all or none of the entry points to have 'bundle_dts' enabled.\")\n+\n+    # Note: Using `to_list()` is expensive but we cannot get around this here as\n+    # we need to filter out generated files and need to be able to iterate through\n+    # JavaScript and typing files in order to detect entry-point index and typing files.\n+    unscoped_esm2020 = depset(transitive = unscoped_esm2020_depsets).to_list()\n+    unscoped_type_definitions = depset(transitive = unscoped_type_definition_depsets).to_list()\n+\n+    for dep in ctx.attr.deps:\n         # Module name of the current entry-point. eg. @angular/core/testing\n         module_name = \"\"\n \n+        # Packsge name where this entry-point is defined in,\n+        entry_point_package = dep.label.package\n+\n         # Intentionally evaluates to empty string for the main entry point\n-        entry_point = dep.label.package[len(ctx.label.package) + 1:]\n+        entry_point = entry_point_package[len(owning_package) + 1:]\n+\n+        # Whether this dependency is for the primary entry-point of the package.\n+        is_primary_entry_point = entry_point == \"\"\n \n         # Extract the \"module_name\" from either \"ts_library\" or \"ng_module\". Both\n         # set the \"module_name\" in the provider struct.\n         if hasattr(dep, \"module_name\"):\n             module_name = dep.module_name\n \n+        if is_primary_entry_point:\n+            npm_package_name = module_name\n+\n         if hasattr(dep, \"angular\") and hasattr(dep.angular, \"flat_module_metadata\"):\n             # For dependencies which are built using the \"ng_module\" with flat module bundles\n             # enabled, we determine the module name, the flat module index file, the metadata\n             # file and the typings entry point from the flat module metadata which is set by\n             # the \"ng_module\" rule.\n             ng_module_metadata = dep.angular.flat_module_metadata\n             module_name = ng_module_metadata.module_name\n-            index_file = ng_module_metadata.flat_module_out_file + \".js\"\n-            typings_path = ng_module_metadata.typings_file.path\n+            es2020_entry_point = ng_module_metadata.flat_module_out_prodmode_file\n+            typings_file = ng_module_metadata.typings_file\n             metadata_file = ng_module_metadata.metadata_file\n             guessed_paths = False\n+\n             _debug(\n                 ctx.var,\n                 \"entry-point %s is built using a flat module bundle.\" % dep,\n-                \"using %s as main file of the entry-point\" % index_file,\n+                \"using %s as main file of the entry-point\" % es2020_entry_point,\n             )\n         else:\n+            _debug(\n+                ctx.var,\n+                \"entry-point %s does not have flat module metadata.\" % dep,\n+                \"guessing `index.mjs` as main file of the entry-point\",\n+            )\n+\n             # In case the dependency is built through the \"ts_library\" rule, or the \"ng_module\"\n             # rule does not generate a flat module bundle, we determine the index file and\n             # typings entry-point through the most reasonable defaults (i.e. \"package/index\").\n-            output_dir = \"/\".join([\n-                p\n-                for p in [\n-                    ctx.bin_dir.path,\n-                    ctx.label.package,\n-                    entry_point,\n-                ]\n-                if p\n-            ])\n-\n-            # fallback to a reasonable default\n-            index_file = \"index.js\"\n-            typings_path = \"%s/index.d.ts\" % output_dir\n+            es2020_entry_point = _find_matching_file(unscoped_esm2020, \"%s/index.mjs\" % entry_point_package)\n+            typings_file = _find_matching_file(unscoped_type_definitions, \"%s/index.d.ts\" % entry_point_package)\n             metadata_file = None\n             guessed_paths = True\n-            _debug(\n-                ctx.var,\n-                \"entry-point %s does not have flat module metadata.\" % dep,\n-                \"guessing %s as main file of the entry-point\" % index_file,\n-            )\n+\n+        bundle_name = \"%s.mjs\" % (primary_bundle_name if is_primary_entry_point else entry_point)\n+        fesm2020_file = ctx.actions.declare_file(\"fesm2020/%s\" % bundle_name)\n+        fesm2015_file = ctx.actions.declare_file(\"fesm2015/%s\" % bundle_name)\n \n         # Store the collected entry point in a list of all entry-points. This\n         # can be later passed to the packager as a manifest.\n         collected_entry_points.append(struct(\n             module_name = module_name,\n-            typings_path = typings_path,\n+            es2020_entry_point = es2020_entry_point,\n+            fesm2020_file = fesm2020_file,\n+            fesm2015_file = fesm2015_file,\n+            typings_file = typings_file,\n             metadata_file = metadata_file,\n             guessed_paths = guessed_paths,\n         ))\n \n-        if hasattr(dep, \"dts_bundles\"):\n-            bundled_type_definitions += dep.dts_bundles\n-        elif len(type_definitions) == 0:\n-            # Filter out all TypeScript definitions generated by NGC as well as definition files\n-            # that do not belong to the current package. We only want to package types that belong\n-            # to the current package.\n-            type_definitions = _filter_out_generated_files(\n-                collect_type_definitions(ctx),\n-                \"d.ts\",\n-                ctx.label.package,\n-            ).to_list()\n-\n-        if len(type_definitions) > 0 and len(bundled_type_definitions) > 0:\n-            # bundle_dts needs to be enabled/disabled for all entry points.\n-            fail(\"Expected all or none of the entry points to have 'bundle_dts' enabled.\")\n-\n-        es2015_entry_point = \"/\".join([p for p in [\n-            ctx.bin_dir.path,\n-            ctx.label.package,\n-            entry_point,\n-            index_file.replace(\".js\", \".mjs\"),\n-        ] if p])\n-\n-        if entry_point:\n-            # TODO jasonaden says there is no particular reason these filenames differ\n-            prefix = primary_entry_point_name(ctx.attr.name, ctx.attr.entry_point, ctx.attr.entry_point_name)\n-            umd_output_filename = \"-\".join([prefix] + entry_point.split(\"/\"))\n-            fesm_output_filename = entry_point.replace(\"/\", \"__\")\n-            fesm2015_output = ctx.actions.declare_file(\"fesm2015/%s.js\" % fesm_output_filename)\n-            umd_output = ctx.actions.declare_file(\"%s.umd.js\" % umd_output_filename)\n-        else:\n-            fesm2015_output = ctx.outputs.fesm2015\n-            umd_output = ctx.outputs.umd\n-\n         # Also include files from npm fine grained deps as inputs.\n         # These deps are identified by the NpmPackageInfo provider.\n         node_modules_files = []\n-        for d in ctx.attr.deps:\n-            if NpmPackageInfo in d:\n-                node_modules_files += _filter_js_inputs(d.files)\n-\n-        esm2015_rollup_inputs = depset(node_modules_files, transitive = [esm_2015_files])\n-        esm2015_config = _write_rollup_config(ctx, ctx.bin_dir.path, filename = \"_%s.rollup_esm2015.conf.js\")\n-        umd_config = _write_rollup_config(\n-            ctx,\n-            ctx.bin_dir.path,\n-            filename = \"_%s.rollup_umd.conf.js\",\n-            include_tslib = True,\n-            downlevel_to_es5 = True,\n-        )\n-\n-        fesm2015.append(\n+        for dep in ctx.attr.deps:\n+            if NpmPackageInfo in dep:\n+                # Note: `to_list` is expensive but we want to filter out non-JS files\n+                # as these would result in a larger set of runfiles.\n+                node_modules_files += _filter_js_inputs(dep.files.to_list())\n+\n+        # Note: For creating the bundles, we use all the ESM2020 sources that have been\n+        # collected from the dependencies. This allows for bundling of code that is not\n+        # necessarily part of the owning package (using the `externals` attribute)\n+        rollup_inputs = depset(node_modules_files + unscoped_esm2020)\n+        esm2020_config = _write_rollup_config(ctx, ctx.bin_dir.path, filename = \"_%s.rollup_esm2020.conf.js\")\n+        esm2015_config = _write_rollup_config(ctx, ctx.bin_dir.path, filename = \"_%s.rollup_esm2015.conf.js\", downlevel_to_es2015 = True)\n+\n+        fesm2020.extend(\n             _run_rollup(\n                 ctx,\n-                \"fesm2015\",\n-                esm2015_config,\n-                es2015_entry_point,\n-                esm2015_rollup_inputs,\n-                fesm2015_output,\n+                \"fesm2020\",\n+                esm2020_config,\n+                es2020_entry_point,\n+                rollup_inputs,\n+                fesm2020_file,\n                 format = \"esm\",\n             ),\n         )\n \n-        bundles.append(\n+        fesm2015.extend(\n             _run_rollup(\n                 ctx,\n-                \"umd\",\n-                umd_config,\n-                es2015_entry_point,\n-                esm2015_rollup_inputs,\n-                umd_output,\n-                module_name = module_name,\n-                format = \"umd\",\n+                \"fesm2015\",\n+                esm2015_config,\n+                es2020_entry_point,\n+                rollup_inputs,\n+                fesm2015_file,\n+                format = \"esm\",\n             ),\n         )\n \n+    # Filter ESM2020 JavaScript and type declaration files to files which are part of the\n+    # owning package. The packager should not copy external files into the package.\n+    esm2020 = _filter_esm_files_to_include(unscoped_esm2020, owning_package)\n+    type_definitions = _filter_typings_to_include(unscoped_type_definitions, owning_package)\n+\n     packager_inputs = (\n         ctx.files.srcs +\n         ctx.files.data +\n         type_definitions +\n         bundled_type_definitions +\n-        [f.js for f in fesm2015 + esm2015 + bundles] +\n-        [f.map for f in fesm2015 + esm2015 + bundles if f.map]\n+        fesm2020 + esm2020 + fesm2015\n     )\n \n     packager_args = ctx.actions.args()\n@@ -492,25 +468,33 @@ def _ng_package_impl(ctx):\n     # The order of arguments matters here, as they are read in order in packager.ts.\n     packager_args.add(npm_package_directory.path)\n     packager_args.add(ctx.label.package)\n-    packager_args.add_joined([ctx.bin_dir.path, ctx.label.package], join_with = \"/\")\n-    packager_args.add_joined([ctx.genfiles_dir.path, ctx.label.package], join_with = \"/\")\n \n     # Marshal the metadata into a JSON string so we can parse the data structure\n     # in the TypeScript program easily.\n     metadata_arg = {}\n     for m in collected_entry_points:\n         if m.metadata_file:\n             packager_inputs.extend([m.metadata_file])\n+\n+        # The captured properties need to match the `EntryPointInfo` interface\n+        # in the packager executable tool.\n         metadata_arg[m.module_name] = {\n-            \"index\": m.typings_path.replace(\".d.ts\", \".js\"),\n-            \"typings\": m.typings_path,\n-            # Metadata can be undefined if entry point is built with \"ts_library\".\n-            \"metadata\": m.metadata_file.path if m.metadata_file else \"\",\n+            \"index\": _serialize_file(m.es2020_entry_point),\n+            \"fesm2020Bundle\": _serialize_file(m.fesm2020_file),\n+            \"fesm2015Bundle\": _serialize_file(m.fesm2015_file),\n+            \"typings\": _serialize_file(m.typings_file),\n             # If the paths for that entry-point were guessed (e.g. \"ts_library\" rule or\n             # \"ng_module\" without flat module bundle), we pass this information to the packager.\n-            \"guessedPaths\": \"true\" if m.guessed_paths else \"\",\n+            \"guessedPaths\": m.guessed_paths,\n         }\n-    packager_args.add(str(metadata_arg))\n+\n+    # Encodes the package metadata with all its entry-points into JSON so that\n+    # it can be deserialized by the packager tool. The struct needs to match with\n+    # the `PackageMetadata` interface in the packager tool.\n+    packager_args.add(json.encode(struct(\n+        npmPackageName = npm_package_name,\n+        entryPoints = metadata_arg,\n+    )))\n \n     if ctx.file.readme_md:\n         packager_inputs.append(ctx.file.readme_md)\n@@ -519,14 +503,14 @@ def _ng_package_impl(ctx):\n         # placeholder\n         packager_args.add(\"\")\n \n-    packager_args.add_joined(_flatten_paths(fesm2015), join_with = \",\", omit_if_empty = False)\n-    packager_args.add_joined(_flatten_paths(esm2015), join_with = \",\", omit_if_empty = False)\n-    packager_args.add_joined(_flatten_paths(bundles), join_with = \",\", omit_if_empty = False)\n-    packager_args.add_joined([s.path for s in ctx.files.srcs], join_with = \",\", omit_if_empty = False)\n-    packager_args.add_joined([s.path for s in type_definitions], join_with = \",\", omit_if_empty = False)\n+    packager_args.add(_serialize_files_for_arg(fesm2020))\n+    packager_args.add(_serialize_files_for_arg(esm2020))\n+    packager_args.add(_serialize_files_for_arg(fesm2015))\n+    packager_args.add(_serialize_files_for_arg(ctx.files.srcs))\n+    packager_args.add(_serialize_files_for_arg(type_definitions))\n \n     # TODO: figure out a better way to gather runfiles providers from the transitive closure.\n-    packager_args.add_joined([d.path for d in ctx.files.data], join_with = \",\", omit_if_empty = False)\n+    packager_args.add(_serialize_files_for_arg(ctx.files.data))\n \n     if ctx.file.license_banner:\n         packager_inputs.append(ctx.file.license_banner)\n@@ -535,7 +519,7 @@ def _ng_package_impl(ctx):\n         # placeholder\n         packager_args.add(\"\")\n \n-    packager_args.add_joined([d.path for d in bundled_type_definitions], join_with = \",\", omit_if_empty = False)\n+    packager_args.add(_serialize_files_for_arg(bundled_type_definitions))\n     packager_args.add(FLAT_DTS_FILE_SUFFIX)\n \n     ctx.actions.run(\n@@ -547,87 +531,35 @@ def _ng_package_impl(ctx):\n         arguments = [packager_args],\n     )\n \n-    devfiles = depset()\n-    if ctx.attr.include_devmode_srcs:\n-        for dep in ctx.attr.deps:\n-            if JSNamedModuleInfo in dep:\n-                devfiles = depset(transitive = [devfiles, dep[JSNamedModuleInfo].sources])\n-\n     # Re-use the create_package function from the nodejs npm_package rule.\n     package_dir = create_package(\n         ctx,\n-        devfiles.to_list(),\n+        [],\n         [npm_package_directory] + ctx.files.nested_packages,\n     )\n-    return [DefaultInfo(\n-        files = depset([package_dir]),\n-    )]\n+    return [\n+        DefaultInfo(files = depset([package_dir])),\n+        # We disable propagation of the `link_node_modules` aspect. We do not want\n+        # mappings from dependencies for the `ng_package` to leak to consumers relying\n+        # on the NPM package target. Since we use an outgoing transition for dependencies\n+        # the mapping paths would be different for the dependency targets and cause mapping\n+        # conflicts if tests rely on both a `ng_package` and a transitive dep target of it.\n+        # More details: https://github.com/bazelbuild/rules_nodejs/issues/2941.\n+        # TODO(devversion): Consider supporting the `package_name` attribute.\n+        LinkerPackageMappingInfo(mappings = {}),\n+    ]\n \n _NG_PACKAGE_DEPS_ASPECTS = [ng_package_module_mappings_aspect, node_modules_aspect]\n \n _NG_PACKAGE_ATTRS = dict(PKG_NPM_ATTRS, **{\n     \"srcs\": attr.label_list(\n         doc = \"\"\"JavaScript source files from the workspace.\n-        These can use ES2015 syntax and ES Modules (import/export)\"\"\",\n+        These can use ES2020 syntax and ES Modules (import/export)\"\"\",\n         allow_files = True,\n     ),\n-    \"entry_point\": attr.label(\n-        doc = \"\"\"The starting point of the application, passed as the `--input` flag to rollup.\n-\n-        If the entry JavaScript file belongs to the same package (as the BUILD file),\n-        you can simply reference it by its relative name to the package directory:\n-\n-        ```\n-        ng_package(\n-            name = \"bundle\",\n-            entry_point = \":main.js\",\n-        )\n-        ```\n-\n-        You can specify the entry point as a typescript file so long as you also include\n-        the ts_library target in deps:\n-\n-        ```\n-        ts_library(\n-            name = \"main\",\n-            srcs = [\"main.ts\"],\n-        )\n-\n-        ng_package(\n-            name = \"bundle\",\n-            deps = [\":main\"]\n-            entry_point = \":main.ts\",\n-        )\n-        ```\n-\n-        The rule will use the corresponding `.js` output of the ts_library rule as the entry point.\n-\n-        If the entry point target is a rule, it should produce a single JavaScript entry file that will be passed to the nodejs_binary rule.\n-        For example:\n-\n-        ```\n-        filegroup(\n-            name = \"entry_file\",\n-            srcs = [\"main.js\"],\n-        )\n-\n-        ng_package(\n-            name = \"bundle\",\n-            entry_point = \":entry_file\",\n-        )\n-        ```\n-        \"\"\",\n-        mandatory = True,\n-        allow_single_file = True,\n-    ),\n-    \"globals\": attr.string_dict(\n-        doc = \"\"\"A dict of symbols that reference external scripts.\n-        The keys are variable names that appear in the program,\n-        and the values are the symbol to reference at runtime in a global context (UMD bundles).\n-        For example, a program referencing @angular/core should use ng.core\n-        as the global reference, so Angular users should include the mapping\n-        `\"@angular/core\":\"ng.core\"` in the globals.\"\"\",\n-        default = {},\n+    \"externals\": attr.string_list(\n+        doc = \"\"\"List of external module that should not be bundled into the flat ESM bundles.\"\"\",\n+        default = [],\n     ),\n     \"license_banner\": attr.label(\n         doc = \"\"\"A .txt file passed to the `banner` config option of rollup.\n@@ -639,14 +571,15 @@ _NG_PACKAGE_ATTRS = dict(PKG_NPM_ATTRS, **{\n     \"deps\": attr.label_list(\n         doc = \"\"\"Other rules that produce JavaScript outputs, such as `ts_library`.\"\"\",\n         aspects = _NG_PACKAGE_DEPS_ASPECTS,\n+        cfg = partial_compilation_transition,\n     ),\n     \"data\": attr.label_list(\n         doc = \"Additional, non-Angular files to be added to the package, e.g. global CSS assets.\",\n         allow_files = True,\n+        cfg = partial_compilation_transition,\n     ),\n-    \"include_devmode_srcs\": attr.bool(default = False),\n     \"readme_md\": attr.label(allow_single_file = [\".md\"]),\n-    \"entry_point_name\": attr.string(\n+    \"primary_bundle_name\": attr.string(\n         doc = \"Name to use when generating bundle files for the primary entry-point.\",\n     ),\n     \"ng_packager\": attr.label(\n@@ -663,64 +596,16 @@ _NG_PACKAGE_ATTRS = dict(PKG_NPM_ATTRS, **{\n         default = Label(_DEFAULT_ROLLUP_CONFIG_TMPL),\n         allow_single_file = True,\n     ),\n+    # Needed in order to allow for the outgoing transition on the `deps` attribute.\n+    # https://docs.bazel.build/versions/main/skylark/config.html#user-defined-transitions.\n+    \"_allowlist_function_transition\": attr.label(\n+        default = \"@bazel_tools//tools/allowlists/function_transition_allowlist\",\n+    ),\n })\n \n-# Angular wants these named after the entry_point,\n-# eg. for //packages/core it looks like \"packages/core/index.js\", we want\n-# core.js produced by this rule.\n-# Currently we just borrow the entry point for this, if it looks like\n-# some/path/to/my/package/index.js\n-# we assume the files should be named \"package.*.js\"\n-def primary_entry_point_name(name, entry_point, entry_point_name):\n-    \"\"\"This is not a public API.\n-\n-    Compute the name of the primary entry point in the library.\n-\n-    Args:\n-      name: the name of the `ng_package` rule, as a fallback.\n-      entry_point: The starting point of the application, see rollup_bundle.\n-      entry_point_name: if set, this is the returned value.\n-\n-    Returns:\n-      name of the entry point, which will appear in the name of generated bundles\n-    \"\"\"\n-    if (type(entry_point) == \"Target\"):\n-        ep = entry_point.label\n-    elif (type(entry_point) == \"Label\"):\n-        ep = entry_point\n-    else:\n-        fail(\"entry_point should be a Target or Label but got %s\" % type(entry_point))\n-\n-    if entry_point_name:\n-        # If an explicit entry_point_name is given, use that.\n-        return entry_point_name\n-    elif ep.package.find(\"/\") >= 0:\n-        # If the entry_point package has multiple path segments, use the last one.\n-        # E.g., for \"//packages/angular/cdk:a11y\", use \"cdk\".\n-        return ep.package.split(\"/\")[-1]\n-    else:\n-        # Fall back to the name of the ng_package rule.\n-        return name\n-\n-def _ng_package_outputs(name, entry_point, entry_point_name):\n-    \"\"\"This is not a public API.\n-\n-    This function computes the named outputs for an ng_package rule.\n-\n-    Args:\n-      name: value of the name attribute\n-      entry_point: value of the entry_point attribute\n-      entry_point_name: value of the entry_point_name attribute\n-\n-    Returns:\n-      dict of named outputs of the rule\n-    \"\"\"\n-\n-    basename = primary_entry_point_name(name, entry_point, entry_point_name)\n-    outputs = {\n-        \"fesm2015\": \"fesm2015/%s.js\" % basename,\n-        \"umd\": \"%s.umd.js\" % basename,\n-    }\n+def _ng_package_outputs(name):\n+    \"\"\"This function computes the named outputs for an ng_package rule.\"\"\"\n+    outputs = {}\n     for key in PKG_NPM_OUTPUTS:\n         # PKG_NPM_OUTPUTS is a \"normal\" dict-valued outputs so it looks like\n         #  \"pack\": \"%{name}.pack\","
        },
        {
            "sha": "cf3215393c12a906c3a4c0fd14523e5c52232043",
            "filename": "packages/bazel/src/ng_package/packager.ts",
            "status": "modified",
            "additions": 342,
            "deletions": 307,
            "changes": 649,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -10,13 +10,77 @@ import * as fs from 'fs';\n import * as path from 'path';\n import * as shx from 'shelljs';\n \n-function main(args: string[]): number {\n+/**\n+ * Interface describing a file captured in the Bazel action.\n+ * https://docs.bazel.build/versions/main/skylark/lib/File.html.\n+ */\n+interface BazelFileInfo {\n+  /** Execroot-relative path pointing to the file. */\n+  path: string;\n+  /** The path of this file relative to its root. e.g. omitting `bazel-out/<..>/bin`. */\n+  shortPath: string;\n+}\n+\n+/** Interface describing an entry-point. */\n+interface EntryPointInfo {\n+  /** ES2020 index file for the APF entry-point. */\n+  index: BazelFileInfo;\n+  /** Flat ES2020 ES module bundle file. */\n+  fesm2020Bundle: BazelFileInfo;\n+  /** Flat ES2015 ES module bundle file. */\n+  fesm2015Bundle: BazelFileInfo;\n+  /** Index type definition file for the APF entry-point. */\n+  typings: BazelFileInfo;\n+  /**\n+   * Whether the index or typing paths have been guessed. For entry-points built\n+   * through `ts_library`, there is no explicit setting that declares the entry-point\n+   * so the index file is guessed.\n+   */\n+  guessedPaths: boolean;\n+}\n+\n+/** Interface capturing relevant metadata for packaging. */\n+interface PackageMetadata {\n+  /** NPM package name of the output. */\n+  npmPackageName: string;\n+  /** Record of entry-points (including the primary one) and their info. */\n+  entryPoints: Record<string, EntryPointInfo>;\n+}\n+\n+/**\n+ * List of known `package.json` fields which provide information about\n+ * supported package formats and their associated entry paths.\n+ */\n+const knownFormatPackageJsonFormatFields =\n+    ['main', 'fesm2020', 'esm2020', 'es2020', 'typings', 'module', 'fesm2015'] as const;\n+\n+/** Union type matching known `package.json` format fields. */\n+type KnownPackageJsonFormatFields = typeof knownFormatPackageJsonFormatFields[number];\n+\n+/**\n+ * Type describing the conditional exports descriptor for an entry-point.\n+ * https://nodejs.org/api/packages.html#packages_conditional_exports\n+ */\n+type ConditionalExport = {\n+  default?: string,\n+  types?: string,\n+  node?: string;\n+  es2015?: string;\n+};\n+\n+/** Type describing a `package.json` the packager deals with. */\n+type PackageJson = {\n+  [key in KnownPackageJsonFormatFields]?: string\n+}&{\n+  name: string;\n+  type?: string;\n+  exports?: Record<string, ConditionalExport>;\n+};\n+\n+function main(args: string[]): void {\n   // Exit immediately when encountering an error.\n   shx.set('-e');\n \n-  // Keep track of whether an error has occured so that we can return an appropriate exit code.\n-  let errorHasOccured = false;\n-\n   // This utility expects all of its arguments to be specified in a params file generated by\n   // bazel (see https://docs.bazel.build/versions/master/skylark/lib/Args.html#use_param_file).\n   const paramFilePath = args[0];\n@@ -31,42 +95,27 @@ function main(args: string[]): number {\n \n   const [\n       // Output directory for the npm package.\n-      out,\n+      outputDirExecPath,\n \n       // The package segment of the ng_package rule's label (e.g. 'package/common').\n-      srcDir,\n-\n-      // The bazel-bin dir joined with the srcDir (e.g. 'bazel-bin/package.common').\n-      // This is the intended output location for package artifacts.\n-      binDir,\n-\n-      // The bazel-genfiles dir joined with the srcDir (e.g. 'bazel-bin/package.common').\n-      genfilesDir,\n-\n-      // JSON data mapping each entry point to the generated bundle index and\n-      // flat module metadata, for example\n-      // {\"@angular/core\": {\n-      //     \"index\": \"bazel-bin/packages/core/core.js\",\n-      //     \"typings\": \"bazel-bin/packages/core/core.d.ts\",\n-      //     \"metadata\": \"bazel-bin/packages/core/core.metadata.json\"\n-      //  },\n-      // ...\n-      // }\n-      modulesManifestArg,\n+      owningPackageName,\n+\n+      // JSON data capturing metadata of the package being built. See `PackageMetadata`.\n+      metadataArg,\n \n       // Path to the package's README.md.\n       readmeMd,\n \n-      // List of rolled-up flat ES2015 modules\n-      fesm2015Arg,\n+      // List of rolled-up flat ES2020 modules\n+      fesm2020Arg,\n \n-      // List of individual ES2015 modules\n-      esm2015Arg,\n+      // List of individual ES2020 modules\n+      esm2020Arg,\n \n-      // List of all UMD bundles generated by rollup.\n-      bundlesArg,\n+      // List of rolled-up flat ES2015 modules\n+      fesm2015Arg,\n \n-      // List of all files in the ng_package rule's srcs.\n+      // List of all files in the ng_package rule's `srcs` attribute.\n       srcsArg,\n \n       // List of all type definitions that need to packaged into the ng_package.\n@@ -85,239 +134,230 @@ function main(args: string[]): number {\n       dtsBundleFileSuffix,\n   ] = params;\n \n-  const fesm2015 = fesm2015Arg.split(',').filter(s => !!s);\n-  const esm2015 = esm2015Arg.split(',').filter(s => !!s);\n-  const bundles = bundlesArg.split(',').filter(s => !!s);\n-  const typeDefinitions = typeDefinitionsArg.split(',').filter(s => !!s);\n-  const srcs = srcsArg.split(',').filter(s => !!s);\n-  const dataFiles: string[] = dataArg.split(',').filter(s => !!s);\n-  const modulesManifest = JSON.parse(modulesManifestArg) as Record<string, any>;\n-  const dtsBundles: string[] = dtsBundleArg.split(',').filter(s => !!s);\n-\n-  /**\n-   * List of known `package.json` fields which provide information about\n-   * supported package formats and their associated entry paths.\n-   */\n-  const knownFormatPackageJsonFields =\n-      ['main', 'fesm2015', 'esm2015', 'typings', 'module', 'es2015'];\n+  const fesm2020 = JSON.parse(fesm2020Arg) as BazelFileInfo[];\n+  const esm2020 = JSON.parse(esm2020Arg) as BazelFileInfo[];\n+  const fesm2015 = JSON.parse(fesm2015Arg) as BazelFileInfo[];\n+  const typeDefinitions = JSON.parse(typeDefinitionsArg) as BazelFileInfo[];\n+  const srcs = JSON.parse(srcsArg) as BazelFileInfo[];\n+  const dataFiles = JSON.parse(dataArg) as BazelFileInfo[];\n+  const metadata = JSON.parse(metadataArg) as PackageMetadata;\n+  const dtsBundles = JSON.parse(dtsBundleArg) as BazelFileInfo[];\n \n   if (readmeMd) {\n-    copyFile(readmeMd, out);\n+    copyFile(readmeMd, 'README.md');\n   }\n \n   /**\n-   * Writes a file into the package based on its input path, relativizing to the package path.\n-   * @param inputPath Path to the file in the input tree.\n+   * Writes a file with the specified content into the package output.\n+   * @param outputRelativePath Relative path in the output directory where the\n+   *   file is written to.\n    * @param fileContent Content of the file.\n    */\n-  function writeFileFromInputPath(inputPath: string, fileContent: string|Buffer) {\n-    // We want the relative path from the given file to its ancestor \"root\" directory.\n-    // This root depends on whether the file lives in the source tree (srcDir) as a basic file\n-    // input to ng_package, the bin output tree (binDir) as the output of another rule, or\n-    // the genfiles output tree (genfilesDir) as the output of a genrule.\n-    let rootDir: string;\n-    if (inputPath.includes(binDir)) {\n-      rootDir = binDir;\n-    } else if (inputPath.includes(genfilesDir)) {\n-      rootDir = genfilesDir;\n-    } else {\n-      rootDir = srcDir;\n-    }\n-\n-    const outputPath = path.join(out, path.relative(rootDir, inputPath));\n+  function writeFile(outputRelativePath: string, fileContent: string|Buffer) {\n+    const outputPath = path.join(outputDirExecPath, outputRelativePath);\n \n     // Always ensure that the target directory exists.\n     shx.mkdir('-p', path.dirname(outputPath));\n     fs.writeFileSync(outputPath, fileContent);\n   }\n \n   /**\n-   * Copies a file into the package based on its input path, relativizing to the package path.\n-   * @param inputPath a path relative to the binDir, typically from a file in the deps[]\n+   * Copies a file into the package output to the specified location.\n+   * @param inputPath File that should be copied.\n+   * @param outputRelativePath Relative path in the output directory where the\n+   *   file is written to.\n    */\n-  function copyFileFromInputPath(inputPath: string) {\n-    writeFileFromInputPath(inputPath, fs.readFileSync(inputPath));\n+  function copyFile(inputPath: string, outputRelativePath: string) {\n+    const fileContent = fs.readFileSync(inputPath, 'utf8');\n+    writeFile(outputRelativePath, fileContent);\n   }\n \n   /**\n-   * Relativize the path where a file is written.\n-   * @param file a path containing a re-rooted segment like `.esm2015`\n-   * @param outDir path where we copy the file, relative to the out\n+   * Gets the relative path for the given file within the owning package. This\n+   * assumes the file is contained in the owning package.\n+   *\n+   * e.g. consider the owning package is `packages/core` and the input file\n+   * is `packages/core/testing/index.d.ts`. This function would return the\n+   * relative path as followed: `testing/index.d.ts`.\n    */\n-  function writeEsmFile(file: string, outDir: string) {\n-    // Path computed relative to the current package in bazel-bin. e.g. a ES2015 output file\n-    // in `bazel-out/<..>/packages/core/src/di.js` should be stored in `{out_dir}/src/di.js`\n-    // if the package target has been declared in `<..>/packages/core`.\n-    const packageRelativePath = path.dirname(path.relative(binDir, file));\n+  function getOwningPackageRelativePath(file: BazelFileInfo): string {\n+    return path.relative(owningPackageName, file.shortPath);\n+  }\n+\n+  /** Writes an ESM file into the `esm2020` output directory. */\n+  function writeEsm2020File(file: BazelFileInfo) {\n+    // Note: files which do not belong to the owning package of this `ng_package` are omitted.\n+    // this prevents us from accidentally bringing in transitive node module dependencies.\n+    const packageRelativePath = getOwningPackageRelativePath(file);\n     if (!packageRelativePath.startsWith('..')) {\n-      copyFile(file, path.join(out, outDir), packageRelativePath);\n+      copyFile(file.path, getEsm2020OutputRelativePath(file));\n     }\n   }\n \n-  esm2015.forEach(file => writeEsmFile(file, 'esm2015'));\n-\n-  bundles.forEach(bundle => {\n-    copyFile(bundle, out, 'bundles');\n-  });\n-  fesm2015.forEach(file => {\n-    copyFile(file, out, 'fesm2015');\n-  });\n-\n-  // Copy all type definitions into the package. This is necessary so that developers can use\n-  // the package with type definitions.\n-  typeDefinitions.forEach(f => writeFileFromInputPath(f, readTypingsAndStripAmdModule(f)));\n-\n-  // Copy all `data` files into the package. These are files that aren't built by the ng_package\n-  // rule, but instead are just straight copied into the package, e.g. global CSS assets.\n-  dataFiles.forEach(f => copyFileFromInputPath(f));\n-\n-  // Iterate through the entry point modules\n-  // We do this first because we also record new paths for the esm5 and esm2015 copies\n-  // of the index JS file, which we need to amend the package.json.\n-  Object.keys(modulesManifest).forEach(moduleName => {\n-    const moduleFiles = modulesManifest[moduleName];\n-    const relative = path.relative(binDir, moduleFiles['index']);\n+  /** Gets the output-relative path where the given flat ESM file should be written to. */\n+  function getFlatEsmOutputRelativePath(file: BazelFileInfo) {\n+    // Flat ESM files should be put into their owning package relative sub-path. e.g. if\n+    // there is a bundle in `packages/animations/fesm2020/browser/testing.mjs` then we\n+    // want the bundle to be stored in `fesm2020/browser/testing.mjs`. Same thing applies\n+    // for the `fesm2015` bundles. The directory name for `fesm` is already declared as\n+    // part of the Bazel action generating these files. See `ng_package.bzl`.\n+    return getOwningPackageRelativePath(file);\n+  }\n \n-    moduleFiles['esm2015_index'] = path.join(binDir, 'esm2015', relative);\n+  /** Gets the output-relative path where a non-flat ESM2020 file should be written to. */\n+  function getEsm2020OutputRelativePath(file: BazelFileInfo) {\n+    // Path computed relative to the current package in bazel-bin. e.g. a ES2020 output file\n+    // in `bazel-out/<..>/packages/core/src/di.mjs` should be stored in `esm2020/src/di.mjs`.\n+    return path.join('esm2020', getOwningPackageRelativePath(file));\n+  }\n \n-    // Metadata file is optional as entry-points can be built with the `ts_library`\n-    // rule or `ng_module` rule in Ivy mode.\n-    const metadataFile = moduleFiles['metadata'];\n-    if (!metadataFile) {\n-      return;\n-    }\n+  /** Gets the output-relative path where the typing file is being written to. */\n+  function getTypingOutputRelativePath(file: BazelFileInfo) {\n+    // Type definitions are intended to be copied into the package output while preserving the\n+    // sub-path from the owning package. e.g. a file like `packages/animations/browser/index.d.ts`\n+    // will end up being written to `<pkg-out>/browser/index.d.ts`\n+    return getOwningPackageRelativePath(file);\n+  }\n \n-    const typingsOutFile = moduleFiles['typings'];\n-    // We only support all modules within a package to be dts bundled\n-    // ie: if @angular/common/http has flat dts, so should @angular/common\n-    if (dtsBundles.length) {\n-      const metadataContent = rewireMetadata(metadataFile, typingsOutFile);\n-      writeFileFromInputPath(metadataFile, metadataContent);\n-    } else {\n-      copyFileFromInputPath(metadataFile);\n-    }\n-  });\n+  /**\n+   * Gets the entry-point sub-path from the package root. e.g. if the package name\n+   * is `@angular/cdk`, then for `@angular/cdk/a11y` just `a11y` would be returned.\n+   */\n+  function getEntryPointSubpath(moduleName: string): string {\n+    return moduleName.substr(`${metadata.npmPackageName}/`.length);\n+  }\n \n-  const licenseBanner = licenseFile ? fs.readFileSync(licenseFile, 'utf-8') : '';\n+  /**\n+   * Gets whether the given module name resolves to a secondary entry-point.\n+   * e.g. if the package name is `@angular/cdk`, then for `@angular/cdk/a11y`\n+   * this would return `true`.\n+   */\n+  function isSecondaryEntryPoint(moduleName: string): boolean {\n+    return getEntryPointSubpath(moduleName) !== '';\n+  }\n \n-  dtsBundles.forEach(bundleFile => {\n-    const cleanDistPath = bundleFile.replace(dtsBundleFileSuffix, '.d.ts');\n+  esm2020.forEach(file => writeEsm2020File(file));\n+\n+  // Copy all FESM files into the package output.\n+  fesm2020.forEach(f => copyFile(f.path, getFlatEsmOutputRelativePath(f)));\n+  fesm2015.forEach(f => copyFile(f.path, getFlatEsmOutputRelativePath(f)));\n+\n+  // Copy all type definitions into the package, preserving the sub-path from the\n+  // owning package. e.g. a file like `packages/animations/browser/index.d.ts` will\n+  // end up in `browser/index.d.ts`\n+  typeDefinitions.forEach(\n+      f => writeFile(getTypingOutputRelativePath(f), readTypingsAndStripAmdModule(f.path)));\n+\n+  // Copy all `data` files into the package, preserving the sub-path from the owning\n+  // package. These are files that aren't built by the ng_package rule, but instead are\n+  // just straight copied into the package, e.g. global CSS assets or migration JSON file.\n+  dataFiles.forEach(f => copyFile(f.path, getOwningPackageRelativePath(f)));\n+\n+  const licenseBanner = licenseFile ? fs.readFileSync(licenseFile, 'utf8') : '';\n+\n+  dtsBundles.forEach(bundleDtsFile => {\n+    // We copy the `d.ts` bundles while preserving the sub-path from the owning\n+    // package. e.g. `packages/animations/animations.bundle.d.ts` will end up being\n+    // copied into `<pkg-out>/animations.d.ts`. Notice how the `.bundle` suffix\n+    // has been removed. The `ng_module` appends this to avoid conflicts with the\n+    // actual typings files being generated by the TS/Angular compilation.\n+    const outputRelativePath =\n+        getTypingOutputRelativePath(bundleDtsFile).replace(dtsBundleFileSuffix, '.d.ts');\n     // API extractor will not dedupe license comments from various files\n     // this will remove all the license comments and append the license banner.\n     const content = licenseBanner + '\\n' +\n-        readTypingsAndStripAmdModule(bundleFile)\n+        readTypingsAndStripAmdModule(bundleDtsFile.path)\n             .replace(/(\\/\\*\\*\\s+\\*\\s\\@license(((?!\\*\\/).|\\s)*)\\*\\/)/gm, '');\n \n-    writeFileFromInputPath(cleanDistPath, content);\n+    writeFile(outputRelativePath, content);\n   });\n \n-  // Root package name (e.g. '@angular/common'), captures as we iterate through sources below.\n-  let rootPackageName = '';\n-  const packagesWithExistingPackageJson = new Set<string>();\n+  const modulesWithExistingPackageJson = new Set<string>();\n \n-  for (const src of srcs) {\n-    if (src.includes(binDir) || src.includes(genfilesDir)) {\n-      errorHasOccured = true;\n-      console.error(\n-          'The \"srcs\" for ng_package should not include output of other rules. Found:\\n' +\n-          `  ${src}`);\n-    }\n+  for (const srcFile of srcs) {\n+    // We copy all source files into the package output while preserving the sub-path from\n+    // the owning package. e.g. `packages/core/package.json` ends up `<pkg-out>/package.json`.\n+    const outputRelativePath = getOwningPackageRelativePath(srcFile);\n+    let content = fs.readFileSync(srcFile.path, 'utf8');\n \n-    let content = fs.readFileSync(src, 'utf-8');\n     // Modify package.json files as necessary for publishing\n-    if (path.basename(src) === 'package.json') {\n-      const packageJson = JSON.parse(content) as {[key: string]: string};\n-      content = amendPackageJson(src, packageJson, false);\n-\n-      const packageName = packageJson['name'];\n-      packagesWithExistingPackageJson.add(packageName);\n-\n-      // Keep track of the root package name, e.g. \"@angular/common\". We assume that the\n-      // root name will be shortest because secondary entry-points will append to it\n-      // (e.g. \"@angular/common/http\").\n-      if (!rootPackageName || packageName.length < rootPackageName.length) {\n-        rootPackageName = packageJson['name'];\n+    if (path.basename(srcFile.path) === 'package.json') {\n+      const isPrimaryPackageJson = outputRelativePath === 'package.json';\n+      const sourcePackageJson = JSON.parse(content) as PackageJson;\n+      const packageName = sourcePackageJson['name'];\n+\n+      // Check if the `name` field of the `package.json` files are matching with\n+      // name of the NPM package. This is an additional safety check.\n+      if (isPrimaryPackageJson && packageName !== metadata.npmPackageName) {\n+        throw Error(\n+            `Primary \"package.json\" has mismatching package name. Expected the ` +\n+            `package to be named \"${metadata.npmPackageName}\", but is set to: ${packageName}.`);\n       }\n-    }\n-    writeFileFromInputPath(src, content);\n-  }\n \n-  // Generate extra files for secondary entry-points.\n-  Object.keys(modulesManifest).forEach(entryPointPackageName => {\n-    const entryPointName = entryPointPackageName.substr(rootPackageName.length + 1);\n-    if (!entryPointName) return;\n-\n-    const metadataFilePath = modulesManifest[entryPointPackageName]['metadata'];\n-    if (metadataFilePath) {\n-      createMetadataReexportFile(\n-          entryPointName, modulesManifest[entryPointPackageName]['metadata'],\n-          entryPointPackageName);\n-    }\n+      if (!isPrimaryPackageJson && !packageName.startsWith(`${metadata.npmPackageName}/`)) {\n+        throw Error(\n+            `Found a \"package.json\" which does not start with the name of the primary ` +\n+            `entry-point. Secondary entry-points need to start with \"${\n+                metadata.npmPackageName}/\", ` +\n+            `but is set to: ${packageName}.`);\n+      }\n \n-    createTypingsReexportFile(\n-        entryPointName, licenseBanner, modulesManifest[entryPointPackageName]['typings']);\n+      let newPackageJson =\n+          insertFormatFieldsIntoPackageJson(outputRelativePath, sourcePackageJson, false);\n \n-    if (!packagesWithExistingPackageJson.has(entryPointPackageName)) {\n-      createEntryPointPackageJson(entryPointName, entryPointPackageName);\n-    }\n-  });\n+      if (isPrimaryPackageJson) {\n+        newPackageJson = updatePrimaryPackageJson(newPackageJson);\n+      }\n \n-  return errorHasOccured ? 1 : 0;\n+      // Keep track of the modules we have `package.json` files provided as part of\n+      // the sources. We use this later to skip generation of `package.json` files\n+      // for the modules the consumer already created a file.\n+      modulesWithExistingPackageJson.add(packageName);\n \n-  /**\n-   * Convert a binDir-relative path to srcDir-relative\n-   * @param from path to a file under the srcDir, like packages/core/testing/package.json\n-   * @param file path to a file under the binDir, like bazel-bin/core/testing/generated.js\n-   */\n-  function srcDirRelative(from: string, file: string) {\n-    const result = normalizeSeparators(\n-        path.relative(path.dirname(from), path.join(srcDir, path.relative(binDir, file))));\n-    if (result.startsWith('..')) return result;\n-    return `./${result}`;\n+      // Update the content with the new `package.json` file content.\n+      content = JSON.stringify(newPackageJson, null, 2);\n+    }\n+\n+    writeFile(outputRelativePath, content);\n   }\n \n-  function copyFile(file: string, baseDir: string, relative = '.') {\n-    const dir = path.join(baseDir, relative);\n-    // output file is .js if the input file is .mjs\n-    const outFile = path.posix.join(\n-        dir, path.basename(file.endsWith('.mjs') ? file.replace(/\\.mjs$/, '.js') : file));\n-    shx.mkdir('-p', dir);\n-    shx.cp(file, outFile);\n-    // Double-underscore is used to escape forward slash in FESM filenames.\n-    // See ng_package.bzl:\n-    //   fesm_output_filename = entry_point.replace(\"/\", \"__\")\n-    // We need to unescape these.\n-    if (outFile.indexOf('__') >= 0) {\n-      const outputPath = path.join(dir, ...path.basename(outFile).split('__'));\n-      shx.mkdir('-p', path.dirname(outputPath));\n-      shx.mv(path.join(dir, path.basename(file)), outputPath);\n-\n-      // if we are renaming the .js file, we'll also need to update the sourceMappingURL in the file\n-      if (outFile.endsWith('.js')) {\n-        shx.chmod('+w', outputPath);\n-        shx.sed('-i', `${path.basename(file)}.map`, `${path.basename(outputPath)}.map`, outputPath);\n-      }\n+  // Generate extra files for secondary entry-points.\n+  Object.keys(metadata.entryPoints).forEach(moduleName => {\n+    if (!isSecondaryEntryPoint(moduleName)) {\n+      return;\n     }\n-  }\n+\n+    // If there is a `package.json` already defined as part of the sources,\n+    // skip generation of the secondary `package.json` file.\n+    if (modulesWithExistingPackageJson.has(moduleName)) {\n+      return;\n+    }\n+\n+    const packageJsonDir = getEntryPointSubpath(moduleName);\n+    createSecondaryEntryPointPackageJson(packageJsonDir, moduleName);\n+  });\n \n   /**\n    * Inserts or edits properties into the package.json file(s) in the package so that\n    * they point to all the right generated artifacts.\n    *\n-   * @param packageJson The path to the package.json file.\n+   * @param packageJsonOutRelativePath Path where the `package.json` is stored in\n+   *   the package output.\n    * @param parsedPackage Parsed package.json content\n    * @param isGeneratedPackageJson Whether the passed package.json has been generated.\n    */\n-  function amendPackageJson(\n-      packageJson: string, parsedPackage: {[key: string]: string},\n-      isGeneratedPackageJson: boolean) {\n-    const packageName = parsedPackage['name'];\n-    const moduleData = modulesManifest[packageName];\n+  function insertFormatFieldsIntoPackageJson(\n+      packageJsonOutRelativePath: string, parsedPackage: Readonly<PackageJson>,\n+      isGeneratedPackageJson: boolean): PackageJson {\n+    const packageJson: PackageJson = {...parsedPackage};\n+    const packageName = packageJson['name'];\n+    const entryPointInfo = metadata.entryPoints[packageName];\n+    const packageJsonContainingDir = path.dirname(packageJsonOutRelativePath);\n \n     // If a package json file has been discovered that does not match any\n-    // module in the manifest, we report a warning as most likely the target\n+    // entry-point in the metadata, we report a warning as most likely the target\n     // is configured incorrectly (e.g. missing `module_name` attribute).\n-    if (!moduleData) {\n+    if (!entryPointInfo) {\n       // Ideally we should throw here, as we got an entry point that doesn't\n       // have flat module metadata / bundle index, so it may have been an\n       // ng_module that's missing a module_name attribute.\n@@ -328,88 +368,119 @@ function main(args: string[]): number {\n       console.error('   Not updating the package.json file to point to it');\n       console.error(\n           '   The ng_module for this package is possibly missing the module_name attribute ');\n-      return JSON.stringify(parsedPackage, null, 2);\n+      return packageJson;\n     }\n \n     // If we guessed the index paths for a module, and it contains an explicit `package.json`\n     // file that already sets format properties, we skip automatic insertion of format\n     // properties but report a warning in case properties have been set by accident.\n-    if (moduleData.guessedPaths && !isGeneratedPackageJson &&\n-        hasExplicitFormatProperties(parsedPackage)) {\n+    if (entryPointInfo.guessedPaths && !isGeneratedPackageJson &&\n+        hasExplicitFormatProperties(packageJson)) {\n       console.error('WARNING: `package.json` explicitly sets format properties (like `main`).');\n       console.error(\n           '    Skipping automatic insertion of format properties as explicit ' +\n           'format properties are set.');\n       console.error('    Ignore this warning if explicit properties are set intentionally.');\n-      return JSON.stringify(parsedPackage, null, 2);\n+      return packageJson;\n     }\n \n-    // Derive the paths to the files from the hard-coded names we gave them.\n-    // TODO(alexeagle): it would be better to transfer this information from the place\n-    // where we created the filenames, via the modulesManifestArg\n-    parsedPackage['main'] = getBundleName(packageName, 'bundles');\n-    parsedPackage['fesm2015'] = getBundleName(packageName, 'fesm2015');\n+    const fesm2020RelativeOutPath = getFlatEsmOutputRelativePath(entryPointInfo.fesm2020Bundle);\n+    const fesm2015RelativeOutPath = getFlatEsmOutputRelativePath(entryPointInfo.fesm2015Bundle);\n+    const esm2020RelativeOutPath = getEsm2020OutputRelativePath(entryPointInfo.index);\n+    const typingsRelativeOutPath = getTypingOutputRelativePath(entryPointInfo.typings);\n \n-    parsedPackage['esm2015'] = srcDirRelative(packageJson, moduleData['esm2015_index']);\n-    parsedPackage['typings'] = srcDirRelative(packageJson, moduleData['typings']);\n+    packageJson.fesm2020 =\n+        normalizePath(path.relative(packageJsonContainingDir, fesm2020RelativeOutPath));\n+    packageJson.fesm2015 =\n+        normalizePath(path.relative(packageJsonContainingDir, fesm2015RelativeOutPath));\n+    packageJson.esm2020 =\n+        normalizePath(path.relative(packageJsonContainingDir, esm2020RelativeOutPath));\n+    packageJson.typings =\n+        normalizePath(path.relative(packageJsonContainingDir, typingsRelativeOutPath));\n \n     // For now, we point the primary entry points at the fesm files, because of Webpack\n     // performance issues with a large number of individual files.\n-    parsedPackage['module'] = parsedPackage['fesm2015'];\n-    parsedPackage['es2015'] = parsedPackage['fesm2015'];\n+    packageJson.module = packageJson.fesm2015;\n+    packageJson.es2020 = packageJson.fesm2020;\n \n-    return JSON.stringify(parsedPackage, null, 2);\n+    return packageJson;\n   }\n \n-  // e.g. @angular/common/http/testing -> ../../bundles/common-http-testing.umd.js\n-  // or   @angular/common/http/testing -> ../../fesm2015/http/testing.js\n-  function getBundleName(packageName: string, dir: string) {\n-    const parts = packageName.split('/');\n-    // Remove the scoped package part, like @angular if present\n-    const nameParts = packageName.startsWith('@') ? parts.splice(1) : parts;\n-    const relativePath = newArray(nameParts.length - 1, '..').join('/') || '.';\n-    let basename: string;\n-    if (dir === 'bundles') {\n-      basename = nameParts.join('-') + '.umd';\n-    } else if (nameParts.length === 1) {\n-      basename = nameParts[0];\n-    } else {\n-      basename = nameParts.slice(1).join('/');\n+  /**\n+   * Updates the primary `package.json` file of the NPM package to specify\n+   * the module conditional exports and the ESM module type.\n+   */\n+  function updatePrimaryPackageJson(packageJson: Readonly<PackageJson>): PackageJson {\n+    if (packageJson.type !== undefined) {\n+      throw Error(\n+          'The primary \"package.json\" file of the package sets the \"type\" field ' +\n+          'that is controlled by the packager. Please unset it.');\n     }\n-    return [relativePath, dir, basename + '.js'].join('/');\n-  }\n \n-  /** Whether the package explicitly sets any of the format properties (like `main`). */\n-  function hasExplicitFormatProperties(parsedPackage: {[key: string]: string}): boolean {\n-    return Object.keys(parsedPackage)\n-        .some(propertyName => knownFormatPackageJsonFields.includes(propertyName));\n-  }\n+    const newPackageJson: PackageJson = {...packageJson};\n+\n+    newPackageJson.type = 'module';\n+\n+    // The `package.json` file is made publicly accessible for tools that\n+    // might want to query information from the Angular NPM package.\n+    insertExportMappingOrError(newPackageJson, './package.json', {default: './package.json'});\n+\n+    // Capture all entry-points in the `exports` field using the subpath export declarations:\n+    // https://nodejs.org/api/packages.html#packages_subpath_exports.\n+    for (const [moduleName, entryPoint] of Object.entries(metadata.entryPoints)) {\n+      const subpath =\n+          isSecondaryEntryPoint(moduleName) ? `./${getEntryPointSubpath(moduleName)}` : '.';\n+      const fesm2020OutRelativePath = getFlatEsmOutputRelativePath(entryPoint.fesm2020Bundle);\n+      const fesm2015OutRelativePath = getFlatEsmOutputRelativePath(entryPoint.fesm2015Bundle);\n+      const typesOutRelativePath = getTypingOutputRelativePath(entryPoint.typings);\n+\n+      // Insert the export mapping for the entry-point. We set `default` to the FESM 2020\n+      // output, and also set the `types` condition which will be respected by TS 4.5.\n+      // https://github.com/microsoft/TypeScript/pull/45884.\n+      insertExportMappingOrError(newPackageJson, subpath, {\n+        types: normalizePath(typesOutRelativePath),\n+        // We also expose a non-standard condition that would allow consumers to resolve\n+        // to the `ES2015` output outside of NodeJS, if desired.\n+        // TODO(devversion): remove/replace this if NodeJS v12 is no longer supported.\n+        es2015: normalizePath(fesm2015OutRelativePath),\n+        // We declare the `node` condition and point to the ES2015 output as we currently still\n+        // support NodeJS v12 which does not fully support ES2020 output. We chose ES2015 over\n+        // ES2029 because we wan async/await downleveled as this allows for patching withZoneJS.\n+        // TODO(devversion): remove/replace this if NodeJS v12 is no longer supported.\n+        node: normalizePath(fesm2015OutRelativePath),\n+        // Note: The default conditions needs to be the last one.\n+        default: normalizePath(fesm2020OutRelativePath),\n+      });\n+    }\n \n-  /** Creates metadata re-export file for a secondary entry-point. */\n-  function createMetadataReexportFile(\n-      entryPointName: string, metadataFile: string, packageName: string) {\n-    const inputPath = path.join(srcDir, `${entryPointName}.metadata.json`);\n-    writeFileFromInputPath(inputPath, JSON.stringify({\n-      '__symbolic': 'module',\n-      'version': 3,\n-      'metadata': {},\n-      'exports':\n-          [{'from': `${srcDirRelative(inputPath, metadataFile.replace(/.metadata.json$/, ''))}`}],\n-      'flatModuleIndexRedirect': true,\n-      'importAs': packageName\n-    }) + '\\n');\n+    return newPackageJson;\n   }\n \n   /**\n-   * Creates a typings (d.ts) re-export file for a secondary-entry point,\n-   * e.g., `export * from './common/common'`\n+   * Inserts a subpath export mapping into the specified `package.json` object.\n+   * @throws An error if the mapping is already defined and would conflict.\n    */\n-  function createTypingsReexportFile(entryPointName: string, license: string, typingsFile: string) {\n-    const inputPath = path.join(srcDir, `${entryPointName}.d.ts`);\n-    const content = `${license}\n-export * from '${srcDirRelative(inputPath, typingsFile.replace(/\\.d\\.tsx?$/, ''))}';\n-`;\n-    writeFileFromInputPath(inputPath, content);\n+  function insertExportMappingOrError(\n+      packageJson: PackageJson, subpath: string, mapping: ConditionalExport) {\n+    if (packageJson.exports?.[subpath] !== undefined) {\n+      throw Error(\n+          'Found a conflicting subpath export in the `package.json` file that would be overridden by the ' +\n+          `packager. Please unset the mapping for: \"${subpath}\".`);\n+    }\n+\n+    if (packageJson.exports === undefined) {\n+      packageJson.exports = {};\n+    }\n+\n+    packageJson.exports[subpath] = mapping;\n+  }\n+\n+  /** Whether the package explicitly sets any of the format properties (like `main`). */\n+  function hasExplicitFormatProperties(parsedPackage: Readonly<PackageJson>): boolean {\n+    return Object.keys(parsedPackage)\n+        .some(\n+            (fieldName: KnownPackageJsonFormatFields) =>\n+                knownFormatPackageJsonFormatFields.includes(fieldName));\n   }\n \n   /**\n@@ -418,46 +489,20 @@ export * from '${srcDirRelative(inputPath, typingsFile.replace(/\\.d\\.tsx?$/, '')\n    * @param entryPointPackageName The full package name for the entry point,\n    *     e.g. '@angular/common/http'.\n    */\n-  function createEntryPointPackageJson(dir: string, entryPointPackageName: string) {\n-    const pkgJson = path.join(srcDir, dir, 'package.json');\n-    const content = amendPackageJson(pkgJson, {name: entryPointPackageName}, true);\n-    writeFileFromInputPath(pkgJson, content);\n+  function createSecondaryEntryPointPackageJson(dir: string, entryPointPackageName: string) {\n+    const relativeOutPath = path.join(dir, 'package.json');\n+    const content =\n+        insertFormatFieldsIntoPackageJson(relativeOutPath, {name: entryPointPackageName}, true);\n+    writeFile(relativeOutPath, JSON.stringify(content, null, 2));\n   }\n \n   /**\n    * Normalizes the specified path by replacing backslash separators with Posix\n    * forward slash separators.\n    */\n-  function normalizeSeparators(path: string): string {\n-    return path.replace(/\\\\/g, '/');\n-  }\n-\n-  /**\n-   * Rewires metadata to point to the flattened dts file.\n-   *\n-   * @param metadataPath the metadata file path\n-   * @param typingsPath the typings bundle entrypoint\n-   */\n-  function rewireMetadata(metadataPath: string, typingsPath: string): string {\n-    const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf-8')) as {[key: string]: any};\n-\n-    let typingsRelativePath =\n-        normalizeSeparators(path.relative(path.dirname(metadataPath), typingsPath));\n-    if (!typingsRelativePath.startsWith('..')) {\n-      typingsRelativePath = `./${typingsRelativePath}`;\n-    }\n-\n-    typingsRelativePath = typingsRelativePath.replace('.d.ts', '');\n-\n-    // the regexp here catches all relative paths such as:\n-    // ./src/core/foo.d.ts and ../src/core/foo.d.ts\n-    const relativePathRegex = /\\.?\\.\\/[\\w\\.\\-_\\/]+/g;\n-    if (metadata.exports) {\n-      // Strip re-exports which are now self-references\n-      metadata.exports =\n-          metadata.exports.filter((e: {from: string}) => !e.from.match(relativePathRegex));\n-    }\n-    return JSON.stringify(metadata).replace(relativePathRegex, typingsRelativePath);\n+  function normalizePath(path: string): string {\n+    const result = path.replace(/\\\\/g, '/');\n+    return result.startsWith('.') ? result : `./${result}`;\n   }\n \n   /**\n@@ -473,15 +518,5 @@ export * from '${srcDirRelative(inputPath, typingsFile.replace(/\\.d\\.tsx?$/, '')\n }\n \n if (require.main === module) {\n-  process.exitCode = main(process.argv.slice(2));\n-}\n-\n-export function newArray<T = any>(size: number): T[];\n-export function newArray<T>(size: number, value: T): T[];\n-export function newArray<T>(size: number, value?: T): T[] {\n-  const list: T[] = [];\n-  for (let i = 0; i < size; i++) {\n-    list.push(value!);\n-  }\n-  return list;\n+  main(process.argv.slice(2));\n }"
        },
        {
            "sha": "f61dfc7067adeba5f7c5401997c2f052134f91be",
            "filename": "packages/bazel/src/ng_package/rollup.config.js",
            "status": "modified",
            "additions": 12,
            "deletions": 13,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Fsrc%2Fng_package%2Frollup.config.js",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Fsrc%2Fng_package%2Frollup.config.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_package%2Frollup.config.js?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -9,9 +9,9 @@\n // Rollup configuration\n // GENERATED BY Bazel\n \n-const nodeResolve = require('rollup-plugin-node-resolve');\n+const {nodeResolve} = require('@rollup/plugin-node-resolve');\n+const commonjs = require('@rollup/plugin-commonjs');\n const sourcemaps = require('rollup-plugin-sourcemaps');\n-const commonjs = require('rollup-plugin-commonjs');\n const path = require('path');\n const fs = require('fs');\n const ts = require('typescript');\n@@ -26,7 +26,7 @@ const rootDir = 'TMPL_root_dir';\n const bannerFile = TMPL_banner_file;\n const stampData = TMPL_stamp_data;\n const moduleMappings = TMPL_module_mappings;\n-const downlevelToEs5 = TMPL_downlevel_to_es5;\n+const downlevelToES2015 = TMPL_downlevel_to_es2015;\n const nodeModulesRoot = 'TMPL_node_modules_root';\n \n log_verbose(`running with\n@@ -147,13 +147,13 @@ if (bannerFile) {\n   }\n }\n \n-// Transform that is enabled for UMD bundle processing. It transforms existing ES2015\n-// prodmode output to ESM5 so that the resulting UMD bundles are using ES5 format.\n-const downlevelToEs5Plugin = {\n-  name: 'downlevel-to-es5',\n+// Transform that is enabled for ES2015 FESM generation. It transforms existing ES2020\n+// prodmode output to ES2015 so that we can generate the ES2015 flat ESM bundle.\n+const downlevelToES2015Plugin = {\n+  name: 'downlevel-to-es2015',\n   transform: (code, filePath) => {\n     const compilerOptions = {\n-      target: ts.ScriptTarget.ES5,\n+      target: ts.ScriptTarget.ES2015,\n       module: ts.ModuleKind.ES2015,\n       allowJs: true,\n       sourceMap: true,\n@@ -175,24 +175,23 @@ const plugins = [\n     resolveId: resolveBazel,\n   },\n   nodeResolve({\n-    mainFields: ['browser', 'es2015', 'module', 'jsnext:main', 'main'],\n+    mainFields: ['es2020', 'es2015', 'module', 'browser'],\n     jail: process.cwd(),\n     customResolveOptions: {moduleDirectory: nodeModulesRoot}\n   }),\n   commonjs({ignoreGlobal: true}),\n   sourcemaps(),\n ];\n \n-// If downleveling to ES5 is enabled, set up the downlevel rollup plugin.\n-if (downlevelToEs5) {\n-  plugins.push(downlevelToEs5Plugin);\n+// If downleveling to ES2015 is enabled, set up the downlevel rollup plugin.\n+if (downlevelToES2015) {\n+  plugins.push(downlevelToES2015Plugin);\n }\n \n const config = {\n   plugins,\n   external: [TMPL_external],\n   output: {\n-    globals: {TMPL_globals},\n     banner,\n   }\n };"
        },
        {
            "sha": "1f573ab2f8950fbe760da4d4e5243ed2122b2943",
            "filename": "packages/bazel/test/ng_package/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2FBUILD.bazel?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -12,7 +12,6 @@ ts_library(\n     srcs = [\"core_package.spec.ts\"],\n     deps = [\n         \"//packages:types\",\n-        \"//packages/private/testing\",\n         \"@npm//@bazel/runfiles\",\n         \"@npm//@types/shelljs\",\n     ],\n@@ -34,7 +33,6 @@ ts_library(\n     srcs = [\"common_package.spec.ts\"],\n     deps = [\n         \"//packages:types\",\n-        \"//packages/private/testing\",\n         \"@npm//@bazel/runfiles\",\n         \"@npm//@types/shelljs\",\n     ],"
        },
        {
            "sha": "19d653e394adedaad0f954eff80f0e04e2f16725",
            "filename": "packages/bazel/test/ng_package/common_package.spec.ts",
            "status": "modified",
            "additions": 81,
            "deletions": 61,
            "changes": 142,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fcommon_package.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fcommon_package.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fcommon_package.spec.ts?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -6,7 +6,6 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {obsoleteInIvy} from '@angular/private/testing';\n import {runfiles} from '@bazel/runfiles';\n import * as fs from 'fs';\n import * as path from 'path';\n@@ -36,110 +35,131 @@ describe('@angular/common ng_package', () => {\n     });\n   });\n \n-  it('should have right bundle files', () => {\n-    expect(shx.ls('-R', 'bundles').stdout.split('\\n').filter(n => !!n).sort()).toEqual([\n-      'common-http-testing.umd.js',\n-      'common-http-testing.umd.js.map',\n-      'common-http.umd.js',\n-      'common-http.umd.js.map',\n-      'common-testing.umd.js',\n-      'common-testing.umd.js.map',\n-      'common-upgrade.umd.js',\n-      'common-upgrade.umd.js.map',\n-      'common.umd.js',\n-      'common.umd.js.map',\n-    ]);\n-  });\n-\n-  it('should reference core using global symbol in umd', () => {\n-    expect(shx.cat('bundles/common.umd.js')).toContain('global.ng.core');\n-  });\n-\n   it('should have right fesm files', () => {\n     const expected = [\n-      'common.js',\n-      'common.js.map',\n+      'common.mjs',\n+      'common.mjs.map',\n       'http',\n-      'http.js',\n-      'http.js.map',\n-      'http/testing.js',\n-      'http/testing.js.map',\n-      'testing.js',\n-      'testing.js.map',\n-      'upgrade.js',\n-      'upgrade.js.map',\n+      'http.mjs',\n+      'http.mjs.map',\n+      'http/testing.mjs',\n+      'http/testing.mjs.map',\n+      'testing.mjs',\n+      'testing.mjs.map',\n+      'upgrade.mjs',\n+      'upgrade.mjs.map',\n     ];\n     expect(shx.ls('-R', 'fesm2015').stdout.split('\\n').filter(n => !!n).sort()).toEqual(expected);\n+    expect(shx.ls('-R', 'fesm2020').stdout.split('\\n').filter(n => !!n).sort()).toEqual(expected);\n   });\n \n   it('should have the correct source map paths', () => {\n-    expect(shx.grep('sourceMappingURL', 'fesm2015/common.js'))\n-        .toMatch('//# sourceMappingURL=common.js.map');\n-    expect(shx.grep('sourceMappingURL', 'fesm2015/http.js'))\n-        .toMatch('//# sourceMappingURL=http.js.map');\n-    expect(shx.grep('sourceMappingURL', 'fesm2015/http/testing.js'))\n-        .toMatch('//# sourceMappingURL=testing.js.map');\n-    expect(shx.grep('sourceMappingURL', 'fesm2015/testing.js'))\n-        .toMatch('//# sourceMappingURL=testing.js.map');\n-    expect(shx.grep('sourceMappingURL', 'fesm2015/upgrade.js'))\n-        .toMatch('//# sourceMappingURL=upgrade.js.map');\n+    expect(shx.grep('sourceMappingURL', 'fesm2020/common.mjs'))\n+        .toMatch('//# sourceMappingURL=common.mjs.map');\n+    expect(shx.grep('sourceMappingURL', 'fesm2020/http.mjs'))\n+        .toMatch('//# sourceMappingURL=http.mjs.map');\n+    expect(shx.grep('sourceMappingURL', 'fesm2020/http/testing.mjs'))\n+        .toMatch('//# sourceMappingURL=testing.mjs.map');\n+    expect(shx.grep('sourceMappingURL', 'fesm2020/testing.mjs'))\n+        .toMatch('//# sourceMappingURL=testing.mjs.map');\n+    expect(shx.grep('sourceMappingURL', 'fesm2020/upgrade.mjs'))\n+        .toMatch('//# sourceMappingURL=upgrade.mjs.map');\n   });\n \n-  describe('secondary entry-point', () => {\n-    obsoleteInIvy(\n-        `now that we don't need metadata files, we don't need these redirects to help resolve paths to them`)\n-        .it('should contain a root type definition re-export', () => {\n-          expect(shx.cat('./testing.d.ts')).toContain(`export * from './testing/testing';`);\n-        });\n-  });\n-\n-\n   describe('should have module resolution properties in the package.json file for', () => {\n     interface PackageJson {\n       main: string;\n-      es2015: string;\n+      fesm2015: string;\n+      es2020: string;\n       module: string;\n       typings: string;\n+      exports: object;\n     }\n     // https://github.com/angular/common-builds/blob/master/package.json\n     it('/', () => {\n       const actual =\n           JSON.parse(fs.readFileSync('package.json', {encoding: 'utf-8'})) as PackageJson;\n-      expect(actual['main']).toEqual('./bundles/common.umd.js');\n+\n+      expect(actual).toEqual(jasmine.objectContaining({\n+        module: `./fesm2015/common.mjs`,\n+        es2020: `./fesm2020/common.mjs`,\n+        esm2020: `./esm2020/common.mjs`,\n+        fesm2020: `./fesm2020/common.mjs`,\n+        fesm2015: `./fesm2015/common.mjs`,\n+        typings: `./common.d.ts`,\n+        exports: {\n+          '.': {\n+            types: './common.d.ts',\n+            es2015: './fesm2015/common.mjs',\n+            node: './fesm2015/common.mjs',\n+            default: './fesm2020/common.mjs',\n+          },\n+          './package.json': {default: './package.json'},\n+          './http': {\n+            types: './http/http.d.ts',\n+            es2015: './fesm2015/http.mjs',\n+            node: './fesm2015/http.mjs',\n+            default: './fesm2020/http.mjs',\n+          },\n+          './http/testing': {\n+            types: './http/testing/testing.d.ts',\n+            es2015: './fesm2015/http/testing.mjs',\n+            node: './fesm2015/http/testing.mjs',\n+            default: './fesm2020/http/testing.mjs',\n+          },\n+          './testing': {\n+            types: './testing/testing.d.ts',\n+            es2015: './fesm2015/testing.mjs',\n+            node: './fesm2015/testing.mjs',\n+            default: './fesm2020/testing.mjs',\n+          },\n+          './upgrade': {\n+            types: './upgrade/upgrade.d.ts',\n+            es2015: './fesm2015/upgrade.mjs',\n+            node: './fesm2015/upgrade.mjs',\n+            default: './fesm2020/upgrade.mjs',\n+          },\n+        }\n+      }));\n     });\n     // https://github.com/angular/common-builds/blob/master/http/package.json\n     it('/http', () => {\n       const actual =\n           JSON.parse(fs.readFileSync('http/package.json', {encoding: 'utf-8'})) as PackageJson;\n-      expect(actual['main']).toEqual('../bundles/common-http.umd.js');\n-      expect(actual['es2015']).toEqual('../fesm2015/http.js');\n-      expect(actual['module']).toEqual('../fesm2015/http.js');\n+      expect(actual['fesm2015']).toEqual('../fesm2015/http.mjs');\n+      expect(actual['es2020']).toEqual('../fesm2020/http.mjs');\n+      expect(actual['module']).toEqual('../fesm2015/http.mjs');\n       expect(actual['typings']).toEqual('./http.d.ts');\n+      expect(actual['exports']).toBeUndefined();\n     });\n     // https://github.com/angular/common-builds/blob/master/testing/package.json\n     it('/testing', () => {\n       const actual =\n           JSON.parse(fs.readFileSync('testing/package.json', {encoding: 'utf-8'})) as PackageJson;\n-      expect(actual['main']).toEqual('../bundles/common-testing.umd.js');\n+      expect(actual['fesm2015']).toEqual('../fesm2015/testing.mjs');\n+      expect(actual['es2020']).toEqual('../fesm2020/testing.mjs');\n+      expect(actual['exports']).toBeUndefined();\n     });\n     // https://github.com/angular/common-builds/blob/master/http/testing/package.json\n     it('/http/testing', () => {\n       const actual =\n           JSON.parse(fs.readFileSync('http/testing/package.json', {encoding: 'utf-8'})) as\n           PackageJson;\n-      expect(actual['main']).toEqual('../../bundles/common-http-testing.umd.js');\n-      expect(actual['es2015']).toEqual('../../fesm2015/http/testing.js');\n-      expect(actual['module']).toEqual('../../fesm2015/http/testing.js');\n+      expect(actual['fesm2015']).toEqual('../../fesm2015/http/testing.mjs');\n+      expect(actual['es2020']).toEqual('../../fesm2020/http/testing.mjs');\n+      expect(actual['module']).toEqual('../../fesm2015/http/testing.mjs');\n       expect(actual['typings']).toEqual('./testing.d.ts');\n+      expect(actual['exports']).toBeUndefined();\n     });\n     // https://github.com/angular/common-builds/blob/master/upgrade/package.json\n     it('/upgrade', () => {\n       const actual =\n           JSON.parse(fs.readFileSync('upgrade/package.json', {encoding: 'utf-8'})) as PackageJson;\n-      expect(actual['main']).toEqual('../bundles/common-upgrade.umd.js');\n-      expect(actual['es2015']).toEqual('../fesm2015/upgrade.js');\n-      expect(actual['module']).toEqual('../fesm2015/upgrade.js');\n+      expect(actual['fesm2015']).toEqual('../fesm2015/upgrade.mjs');\n+      expect(actual['es2020']).toEqual('../fesm2020/upgrade.mjs');\n+      expect(actual['module']).toEqual('../fesm2015/upgrade.mjs');\n       expect(actual['typings']).toEqual('./upgrade.d.ts');\n+      expect(actual['exports']).toBeUndefined();\n     });\n   });\n });"
        },
        {
            "sha": "71200f553342d3dc15f15df5a32d4465767d74a0",
            "filename": "packages/bazel/test/ng_package/core_package.spec.ts",
            "status": "modified",
            "additions": 77,
            "deletions": 93,
            "changes": 170,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fcore_package.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fcore_package.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fcore_package.spec.ts?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -6,7 +6,6 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {obsoleteInIvy} from '@angular/private/testing';\n import {runfiles} from '@bazel/runfiles';\n import * as path from 'path';\n import * as shx from 'shelljs';\n@@ -51,17 +50,37 @@ describe('@angular/core ng_package', () => {\n       });\n \n       it('should contain module resolution mappings', () => {\n-        expect(shx.grep('\"main\":', packageJson)).toContain(`./bundles/core.umd.js`);\n-        expect(shx.grep('\"module\":', packageJson)).toContain(`./fesm2015/core.js`);\n-        expect(shx.grep('\"es2015\":', packageJson)).toContain(`./fesm2015/core.js`);\n-        expect(shx.grep('\"esm2015\":', packageJson)).toContain(`./esm2015/core.js`);\n-        expect(shx.grep('\"typings\":', packageJson)).toContain(`./core.d.ts`);\n+        const data = JSON.parse(shx.cat(packageJson)) as any;\n+        expect(data).toEqual(jasmine.objectContaining({\n+          module: `./fesm2015/core.mjs`,\n+          es2020: `./fesm2020/core.mjs`,\n+          esm2020: `./esm2020/core.mjs`,\n+          fesm2020: `./fesm2020/core.mjs`,\n+          fesm2015: `./fesm2015/core.mjs`,\n+          typings: `./core.d.ts`,\n+          exports: {\n+            '.': {\n+              types: './core.d.ts',\n+              es2015: './fesm2015/core.mjs',\n+              node: './fesm2015/core.mjs',\n+              default: './fesm2020/core.mjs'\n+            },\n+            './package.json': {default: './package.json'},\n+            './testing': {\n+              types: './testing/testing.d.ts',\n+              es2015: './fesm2015/testing.mjs',\n+              node: './fesm2015/testing.mjs',\n+              default: './fesm2020/testing.mjs',\n+            },\n+          }\n+        }));\n       });\n \n       it('should contain metadata for ng update', () => {\n         interface PackageJson {\n           'ng-update': {packageGroup: string[];};\n         }\n+\n         expect(shx.cat(packageJson)).not.toContain('NG_UPDATE_PACKAGE_GROUP');\n         expect((JSON.parse(shx.cat(packageJson)) as PackageJson)['ng-update'].packageGroup)\n             .toContain('@angular/core');\n@@ -75,76 +94,53 @@ describe('@angular/core ng_package', () => {\n       it('should have an index d.ts file', () => {\n         expect(shx.cat('core.d.ts')).toContain('export declare');\n       });\n-      obsoleteInIvy('we no longer need to export r3_symbols')\n-          .it('should have an r3_symbols d.ts file', () => {\n-            expect(shx.cat('src/r3_symbols.d.ts')).toContain('export declare');\n-          });\n-    });\n \n-    obsoleteInIvy('metadata files are no longer needed or produced in Ivy')\n-        .describe('angular metadata', () => {\n-          it('should have metadata.json files', () => {\n-            expect(shx.cat('core.metadata.json')).toContain(`\"__symbolic\":\"module\"`);\n-          });\n-          it('should not have self-references in metadata.json', () => {\n-            expect(shx.cat('core.metadata.json')).not.toContain(`\"from\":\"./core\"`);\n-          });\n-        });\n+      // The `r3_symbols` file was needed for View Engine ngcc processing.\n+      // This test ensures we no longer ship it by accident.\n+      it('should not have an r3_symbols d.ts file', () => {\n+        expect(shx.test('-e', 'src/r3_symbols.d.ts')).toBe(false);\n+      });\n+    });\n \n-    describe('fesm2015', () => {\n-      it('should have a fesm15 file in the /fesm2015 directory', () => {\n-        expect(shx.cat('fesm2015/core.js')).toContain(`export {`);\n+    describe('fesm2020', () => {\n+      it('should have a fesm2020 file in the /fesm2020 directory', () => {\n+        expect(shx.cat('fesm2020/core.mjs')).toContain(`export {`);\n       });\n \n       it('should have a source map', () => {\n-        expect(shx.cat('fesm2015/core.js.map'))\n-            .toContain(`{\"version\":3,\"file\":\"core.js\",\"sources\":`);\n+        expect(shx.cat('fesm2020/core.mjs.map'))\n+            .toContain(`{\"version\":3,\"file\":\"core.mjs\",\"sources\":`);\n       });\n \n       it('should have the version info in the header', () => {\n-        expect(shx.cat('fesm2015/core.js'))\n+        expect(shx.cat('fesm2020/core.mjs'))\n             .toMatch(/@license Angular v\\d+\\.\\d+\\.\\d+(?!-PLACEHOLDER)/);\n       });\n-\n-      obsoleteInIvy('we no longer need to export private symbols')\n-          .it('should have been built from the generated bundle index', () => {\n-            expect(shx.cat('fesm2015/core.js')).toMatch('export {.*makeParamDecorator');\n-          });\n     });\n \n-    describe('esm2015', () => {\n-      it('should not contain any *.ngfactory.js files', () => {\n-        expect(shx.find('esm2015').filter(f => f.endsWith('.ngfactory.js'))).toEqual([]);\n-      });\n-\n-      it('should not contain any *.ngsummary.js files', () => {\n-        expect(shx.find('esm2015').filter(f => f.endsWith('.ngsummary.js'))).toEqual([]);\n-      });\n-    });\n-\n-    describe('umd', () => {\n-      it('should have a umd file in the /bundles directory', () => {\n-        expect(shx.ls('bundles/core.umd.js').length).toBe(1, 'File not found');\n+    describe('fesm2015', () => {\n+      it('should have a fesm2015 file in the /fesm2015 directory', () => {\n+        expect(shx.cat('fesm2015/core.mjs')).toContain(`export {`);\n       });\n \n-      it('should have a source map next to the umd file', () => {\n-        expect(shx.ls('bundles/core.umd.js.map').length).toBe(1, 'File not found');\n+      it('should have a source map', () => {\n+        expect(shx.cat('fesm2015/core.mjs.map'))\n+            .toContain(`{\"version\":3,\"file\":\"core.mjs\",\"sources\":`);\n       });\n \n       it('should have the version info in the header', () => {\n-        expect(shx.cat('bundles/core.umd.js'))\n+        expect(shx.cat('fesm2015/core.mjs'))\n             .toMatch(/@license Angular v\\d+\\.\\d+\\.\\d+(?!-PLACEHOLDER)/);\n       });\n+    });\n \n-      it('should have tslib helpers', () => {\n-        expect(shx.cat('bundles/core.umd.js')).toContain('function __extends');\n-        expect(shx.cat('bundles/core.umd.js')).not.toContain('undefined.__extends');\n-      });\n-      it('should have an AMD name', () => {\n-        expect(shx.cat('bundles/core.umd.js')).toContain('define(\\'@angular/core\\'');\n+    describe('esm2020', () => {\n+      it('should not contain any *.ngfactory.js files', () => {\n+        expect(shx.find('esm2020').filter(f => f.includes('.ngfactory'))).toEqual([]);\n       });\n-      it('should define ng global symbols', () => {\n-        expect(shx.cat('bundles/core.umd.js')).toContain('global.ng.core = {}');\n+\n+      it('should not contain any *.ngsummary.js files', () => {\n+        expect(shx.find('esm2020').filter(f => f.includes('.ngsummary'))).toEqual([]);\n       });\n     });\n   });\n@@ -159,11 +155,17 @@ describe('@angular/core ng_package', () => {\n \n       it('should have its module resolution mappings defined in the nested package.json', () => {\n         const packageJson = p`testing/package.json`;\n-        expect(shx.grep('\"main\":', packageJson)).toContain(`../bundles/core-testing.umd.js`);\n-        expect(shx.grep('\"module\":', packageJson)).toContain(`../fesm2015/testing.js`);\n-        expect(shx.grep('\"es2015\":', packageJson)).toContain(`../fesm2015/testing.js`);\n-        expect(shx.grep('\"esm2015\":', packageJson)).toContain(`../esm2015/testing/testing.js`);\n-        expect(shx.grep('\"typings\":', packageJson)).toContain(`./testing.d.ts`);\n+        const data = JSON.parse(shx.cat(packageJson)) as any;\n+\n+        expect(data).toEqual(jasmine.objectContaining({\n+          module: `../fesm2015/testing.mjs`,\n+          es2020: `../fesm2020/testing.mjs`,\n+          esm2020: `../esm2020/testing/testing.mjs`,\n+          fesm2020: `../fesm2020/testing.mjs`,\n+          fesm2015: `../fesm2015/testing.mjs`,\n+          typings: `./testing.d.ts`,\n+        }));\n+        expect(data.exports).toBeUndefined();\n       });\n     });\n \n@@ -172,55 +174,37 @@ describe('@angular/core ng_package', () => {\n       it('should have a typings file', () => {\n         expect(shx.cat(typingsFile)).toContain('export declare');\n       });\n-\n-      obsoleteInIvy(\n-          'now that we don\\'t need metadata files, we don\\'t need these redirects to help resolve paths to them')\n-          .it('should have an \\'redirect\\' d.ts file in the parent dir', () => {\n-            expect(shx.cat('testing.d.ts')).toContain(`export * from './testing/testing';`);\n-          });\n     });\n \n-    obsoleteInIvy('metadata files are no longer needed or produced in Ivy')\n-        .describe('angular metadata file', () => {\n-          it('should have a \\'redirect\\' metadata.json file next to the d.ts file', () => {\n-            expect(shx.cat('testing.metadata.json'))\n-                .toContain(\n-                    `\"exports\":[{\"from\":\"./testing/testing\"}],\"flatModuleIndexRedirect\":true`);\n-          });\n-        });\n-\n-    describe('fesm2015', () => {\n-      it('should have a fesm15 file in the /fesm2015 directory', () => {\n-        expect(shx.cat('fesm2015/testing.js')).toContain(`export {`);\n+    describe('fesm2020', () => {\n+      it('should have a fesm2020 file in the /fesm2020 directory', () => {\n+        expect(shx.cat('fesm2020/testing.mjs')).toContain(`export {`);\n       });\n \n       it('should have a source map', () => {\n-        expect(shx.cat('fesm2015/testing.js.map'))\n-            .toContain(`{\"version\":3,\"file\":\"testing.js\",\"sources\":`);\n+        expect(shx.cat('fesm2020/testing.mjs.map'))\n+            .toContain(`{\"version\":3,\"file\":\"testing.mjs\",\"sources\":`);\n       });\n \n       it('should have the version info in the header', () => {\n-        expect(shx.cat('fesm2015/testing.js'))\n+        expect(shx.cat('fesm2020/testing.mjs'))\n             .toMatch(/@license Angular v\\d+\\.\\d+\\.\\d+(?!-PLACEHOLDER)/);\n       });\n     });\n \n-    describe('umd', () => {\n-      it('should have a umd file in the /bundles directory', () => {\n-        expect(shx.ls('bundles/core-testing.umd.js').length).toBe(1, 'File not found');\n-      });\n-\n-      it('should have a source map next to the umd file', () => {\n-        expect(shx.ls('bundles/core-testing.umd.js.map').length).toBe(1, 'File not found');\n+    describe('fesm2015', () => {\n+      it('should have a fesm105 file in the /fesm2015 directory', () => {\n+        expect(shx.cat('fesm2015/testing.mjs')).toContain(`export {`);\n       });\n \n-      it('should have an AMD name', () => {\n-        expect(shx.cat('bundles/core-testing.umd.js'))\n-            .toContain('define(\\'@angular/core/testing\\'');\n+      it('should have a source map', () => {\n+        expect(shx.cat('fesm2015/testing.mjs.map'))\n+            .toContain(`{\"version\":3,\"file\":\"testing.mjs\",\"sources\":`);\n       });\n \n-      it('should define ng global symbols', () => {\n-        expect(shx.cat('bundles/core-testing.umd.js')).toContain('global.ng.core.testing = {}');\n+      it('should have the version info in the header', () => {\n+        expect(shx.cat('fesm2015/testing.mjs'))\n+            .toMatch(/@license Angular v\\d+\\.\\d+\\.\\d+(?!-PLACEHOLDER)/);\n       });\n     });\n   });"
        },
        {
            "sha": "683167f8ba4fcc2dcee984f6dce49da03a4dd94e",
            "filename": "packages/bazel/test/ng_package/example-with-ts-library/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fexample-with-ts-library%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fexample-with-ts-library%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fexample-with-ts-library%2FBUILD.bazel?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -14,7 +14,6 @@ ng_package(\n     srcs = [\n         \"package.json\",\n     ],\n-    entry_point = \":index.ts\",\n     deps = [\n         \":example\",\n         \"//packages/bazel/test/ng_package/example-with-ts-library/portal\","
        },
        {
            "sha": "caf980ec46063559c65b49d4779971c54475005e",
            "filename": "packages/bazel/test/ng_package/example/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2FBUILD.bazel?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -24,11 +24,10 @@ ng_package(\n         \":extra-styles.css\",\n         \":logo.png\",\n     ],\n-    entry_point = \":index.ts\",\n-    entry_point_name = \"waffels\",\n     nested_packages = [\n         \":arbitrary_npm_package\",\n     ],\n+    primary_bundle_name = \"waffels\",\n     deps = [\n         \":example\",\n         \"//packages/bazel/test/ng_package/example/a11y\","
        },
        {
            "sha": "5628d1413517126d1422fb4491a0867fc5a0df5e",
            "filename": "packages/bazel/test/ng_package/example_package.golden",
            "status": "modified",
            "additions": 396,
            "deletions": 465,
            "changes": 861,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_package.golden",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_package.golden",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_package.golden?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -1,69 +1,55 @@\n README.md\n a11y\n   a11y/a11y.d.ts\n-  a11y/a11y.metadata.json\n   a11y/package.json\n-a11y.d.ts\n-a11y.metadata.json\n arbitrary-npm-package-main.js\n arbitrary_bin.txt\n arbitrary_genfiles.txt\n-bundles\n-  bundles/waffels-a11y.umd.js\n-  bundles/waffels-a11y.umd.js.map\n-  bundles/waffels-imports.umd.js\n-  bundles/waffels-imports.umd.js.map\n-  bundles/waffels-secondary.umd.js\n-  bundles/waffels-secondary.umd.js.map\n-  bundles/waffels.umd.js\n-  bundles/waffels.umd.js.map\n-esm2015\n-  esm2015/a11y\n-    esm2015/a11y/a11y.externs.js\n-    esm2015/a11y/a11y.js\n-    esm2015/a11y/index.js\n-    esm2015/a11y/public-api.js\n-  esm2015/example.externs.js\n-  esm2015/example.js\n-  esm2015/imports\n-    esm2015/imports/imports.externs.js\n-    esm2015/imports/imports.js\n-    esm2015/imports/index.js\n-    esm2015/imports/public-api.js\n-    esm2015/imports/second.js\n-  esm2015/index.js\n-  esm2015/mymodule.js\n-  esm2015/secondary\n-    esm2015/secondary/index.js\n-    esm2015/secondary/secondary.externs.js\n-    esm2015/secondary/secondary.js\n-    esm2015/secondary/secondarymodule.js\n+esm2020\n+  esm2020/a11y\n+    esm2020/a11y/a11y.mjs\n+    esm2020/a11y/index.mjs\n+    esm2020/a11y/public-api.mjs\n+  esm2020/example.mjs\n+  esm2020/imports\n+    esm2020/imports/imports.mjs\n+    esm2020/imports/index.mjs\n+    esm2020/imports/public-api.mjs\n+    esm2020/imports/second.mjs\n+  esm2020/index.mjs\n+  esm2020/mymodule.mjs\n+  esm2020/secondary\n+    esm2020/secondary/index.mjs\n+    esm2020/secondary/secondary.mjs\n+    esm2020/secondary/secondarymodule.mjs\n example.d.ts\n-example.metadata.json\n extra-styles.css\n fesm2015\n-  fesm2015/a11y.js\n-  fesm2015/a11y.js.map\n-  fesm2015/imports.js\n-  fesm2015/imports.js.map\n-  fesm2015/secondary.js\n-  fesm2015/secondary.js.map\n-  fesm2015/waffels.js\n-  fesm2015/waffels.js.map\n+  fesm2015/a11y.mjs\n+  fesm2015/a11y.mjs.map\n+  fesm2015/imports.mjs\n+  fesm2015/imports.mjs.map\n+  fesm2015/secondary.mjs\n+  fesm2015/secondary.mjs.map\n+  fesm2015/waffels.mjs\n+  fesm2015/waffels.mjs.map\n+fesm2020\n+  fesm2020/a11y.mjs\n+  fesm2020/a11y.mjs.map\n+  fesm2020/imports.mjs\n+  fesm2020/imports.mjs.map\n+  fesm2020/secondary.mjs\n+  fesm2020/secondary.mjs.map\n+  fesm2020/waffels.mjs\n+  fesm2020/waffels.mjs.map\n imports\n   imports/imports.d.ts\n-  imports/imports.metadata.json\n   imports/package.json\n-imports.d.ts\n-imports.metadata.json\n logo.png\n package.json\n secondary\n   secondary/package.json\n   secondary/secondary.d.ts\n-  secondary/secondary.metadata.json\n-secondary.d.ts\n-secondary.metadata.json\n some-file.txt\n --- README.md ---\n \n@@ -85,45 +71,29 @@ License: MIT\n  * License: MIT\n  */\n \n+import * as i0 from '@angular/core';\n \n export declare class A11yModule {\n+    static fac: i0.FactoryDeclaration<A11yModule, never>;\n+    static mod: i0.NgModuleDeclaration<A11yModule, never, never, never>;\n+    static inj: i0.InjectorDeclaration<A11yModule>;\n }\n \n export { }\n \n \n---- a11y/a11y.metadata.json ---\n-\n-{\"__symbolic\":\"module\",\"version\":4,\"metadata\":{\"A11yModule\":{\"__symbolic\":\"class\",\"decorators\":[{\"__symbolic\":\"call\",\"expression\":{\"__symbolic\":\"reference\",\"module\":\"@angular/core\",\"name\":\"NgModule\",\"line\":10,\"character\":1},\"arguments\":[{}]}],\"members\":{}}},\"origins\":{\"A11yModule\":\"./a11y\"},\"importAs\":\"example/a11y\"}\n-\n --- a11y/package.json ---\n \n {\n   \"name\": \"example/a11y\",\n-  \"main\": \"../bundles/example-a11y.umd.js\",\n-  \"fesm2015\": \"../fesm2015/a11y.js\",\n-  \"esm2015\": \"../esm2015/a11y/a11y.js\",\n+  \"fesm2020\": \"../fesm2020/a11y.mjs\",\n+  \"fesm2015\": \"../fesm2015/a11y.mjs\",\n+  \"esm2020\": \"../esm2020/a11y/a11y.mjs\",\n   \"typings\": \"./a11y.d.ts\",\n-  \"module\": \"../fesm2015/a11y.js\",\n-  \"es2015\": \"../fesm2015/a11y.js\"\n+  \"module\": \"../fesm2015/a11y.mjs\",\n+  \"es2020\": \"../fesm2020/a11y.mjs\"\n }\n \n---- a11y.d.ts ---\n-\n-/**\n- * @license Angular v0.0.0\n- * (c) 2010-2021 Google LLC. https://angular.io/\n- * License: MIT\n- */\n-\n-export * from './a11y/a11y';\n-\n-\n---- a11y.metadata.json ---\n-\n-{\"__symbolic\":\"module\",\"version\":3,\"metadata\":{},\"exports\":[{\"from\":\"./a11y/a11y\"}],\"flatModuleIndexRedirect\":true,\"importAs\":\"example/a11y\"}\n-\n-\n --- arbitrary-npm-package-main.js ---\n \n /**\n@@ -147,250 +117,15 @@ World\n Hello\n \n \n---- bundles/waffels-a11y.umd.js ---\n-\n-/**\n- * @license Angular v0.0.0\n- * (c) 2010-2021 Google LLC. https://angular.io/\n- * License: MIT\n- */\n-\n-(function (global, factory) {\n-    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/core')) :\n-    typeof define === 'function' && define.amd ? define('example/a11y', ['exports', '@angular/core'], factory) :\n-    (global = global || self, factory((global.example = global.example || {}, global.example.a11y = {}), global.ng.core));\n-}(this, (function (exports, core) { 'use strict';\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-    var A11yModule = /** @class */ (function () {\n-        function A11yModule() {\n-        }\n-        return A11yModule;\n-    }());\n-    A11yModule.decorators = [\n-        { type: core.NgModule, args: [{},] }\n-    ];\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-\n-    /**\n-     * Generated bundle index. Do not edit.\n-     */\n-\n-    exports.A11yModule = A11yModule;\n-\n-    Object.defineProperty(exports, '__esModule', { value: true });\n-\n-})));\n-//# sourceMappingURL=waffels-a11y.umd.js.map\n-\n-\n---- bundles/waffels-imports.umd.js ---\n-\n-/**\n- * @license Angular v0.0.0\n- * (c) 2010-2021 Google LLC. https://angular.io/\n- * License: MIT\n- */\n-\n-(function (global, factory) {\n-    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/core')) :\n-    typeof define === 'function' && define.amd ? define('example/imports', ['exports', '@angular/core'], factory) :\n-    (global = global || self, factory((global.example = global.example || {}, global.example.imports = {}), global.ng.core));\n-}(this, (function (exports, i0) { 'use strict';\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-    var MySecondService = /** @class */ (function () {\n-        function MySecondService() {\n-        }\n-        return MySecondService;\n-    }());\n-    MySecondService.prov = i0.defineInjectable({ factory: function MySecondService_Factory() { return new MySecondService(); }, token: MySecondService, providedIn: \"root\" });\n-    MySecondService.decorators = [\n-        { type: i0.Injectable, args: [{ providedIn: 'root' },] }\n-    ];\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-    var MyService = /** @class */ (function () {\n-        function MyService(secondService) {\n-            this.secondService = secondService;\n-        }\n-        return MyService;\n-    }());\n-    MyService.prov = i0.defineInjectable({ factory: function MyService_Factory() { return new MyService(i0.inject(MySecondService)); }, token: MyService, providedIn: \"root\" });\n-    MyService.decorators = [\n-        { type: i0.Injectable, args: [{ providedIn: 'root' },] }\n-    ];\n-    MyService.ctorParameters = function () { return [\n-        { type: MySecondService }\n-    ]; };\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-\n-    /**\n-     * Generated bundle index. Do not edit.\n-     */\n-\n-    exports.MyService = MyService;\n-    exports.angular_packages_bazel_test_ng_package_example_imports_imports_a = MySecondService;\n-\n-    Object.defineProperty(exports, '__esModule', { value: true });\n-\n-})));\n-//# sourceMappingURL=waffels-imports.umd.js.map\n-\n-\n---- bundles/waffels-secondary.umd.js ---\n-\n-/**\n- * @license Angular v0.0.0\n- * (c) 2010-2021 Google LLC. https://angular.io/\n- * License: MIT\n- */\n-\n-(function (global, factory) {\n-    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/core')) :\n-    typeof define === 'function' && define.amd ? define('example/secondary', ['exports', '@angular/core'], factory) :\n-    (global = global || self, factory((global.example = global.example || {}, global.example.secondary = {}), global.ng.core));\n-}(this, (function (exports, core) { 'use strict';\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-    var SecondaryModule = /** @class */ (function () {\n-        function SecondaryModule() {\n-        }\n-        return SecondaryModule;\n-    }());\n-    SecondaryModule.decorators = [\n-        { type: core.NgModule, args: [{},] }\n-    ];\n-    var a = 1;\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-\n-    /**\n-     * Generated bundle index. Do not edit.\n-     */\n-\n-    exports.SecondaryModule = SecondaryModule;\n-    exports.a = a;\n-\n-    Object.defineProperty(exports, '__esModule', { value: true });\n-\n-})));\n-//# sourceMappingURL=waffels-secondary.umd.js.map\n-\n-\n---- bundles/waffels.umd.js ---\n-\n-/**\n- * @license Angular v0.0.0\n- * (c) 2010-2021 Google LLC. https://angular.io/\n- * License: MIT\n- */\n-\n-(function (global, factory) {\n-    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/core')) :\n-    typeof define === 'function' && define.amd ? define('example', ['exports', '@angular/core'], factory) :\n-    (global = global || self, factory(global.example = {}, global.ng.core));\n-}(this, (function (exports, core) { 'use strict';\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-    var MyModule = /** @class */ (function () {\n-        function MyModule() {\n-        }\n-        return MyModule;\n-    }());\n-    MyModule.decorators = [\n-        { type: core.NgModule, args: [{},] }\n-    ];\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-\n-    /**\n-     * Generated bundle index. Do not edit.\n-     */\n-\n-    exports.MyModule = MyModule;\n-\n-    Object.defineProperty(exports, '__esModule', { value: true });\n-\n-})));\n-//# sourceMappingURL=waffels.umd.js.map\n-\n-\n---- esm2015/a11y/a11y.externs.js ---\n-\n-/** @externs */\n-/**\n- * @externs\n- * @suppress {duplicate,checkTypes}\n- */\n-// NOTE: generated by tsickle, do not edit.\n-\n-\n---- esm2015/a11y/a11y.js ---\n+--- esm2020/a11y/a11y.mjs ---\n \n /**\n  * Generated bundle index. Do not edit.\n  */\n export * from './index';\n //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYTExeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlL2ExMXkvYTExeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUVILGNBQWMsU0FBUyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBHZW5lcmF0ZWQgYnVuZGxlIGluZGV4LiBEbyBub3QgZWRpdC5cbiAqL1xuXG5leHBvcnQgKiBmcm9tICcuL2luZGV4JztcbiJdfQ==\n \n---- esm2015/a11y/index.js ---\n+--- esm2020/a11y/index.mjs ---\n \n /**\n  * @license\n@@ -402,7 +137,7 @@ export * from './index';\n export * from './public-api';\n //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS9hMTF5L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILGNBQWMsY0FBYyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmV4cG9ydCAqIGZyb20gJy4vcHVibGljLWFwaSc7XG4iXX0=\n \n---- esm2015/a11y/public-api.js ---\n+--- esm2020/a11y/public-api.mjs ---\n \n /**\n  * @license\n@@ -412,51 +147,35 @@ export * from './public-api';\n  * found in the LICENSE file at https://angular.io/license\n  */\n import { NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n export class A11yModule {\n }\n-A11yModule.decorators = [\n-    { type: NgModule, args: [{},] }\n-];\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVibGljLWFwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlL2ExMXkvcHVibGljLWFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBR3ZDLE1BQU0sT0FBTyxVQUFVOzs7WUFEdEIsUUFBUSxTQUFDLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0IHtOZ01vZHVsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbkBOZ01vZHVsZSh7fSlcbmV4cG9ydCBjbGFzcyBBMTF5TW9kdWxlIHtcbn1cbiJdfQ==\n-\n---- esm2015/example.externs.js ---\n+A11yModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule, deps: [], target: i0.FactoryTarget.NgModule });\n+A11yModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule });\n+A11yModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVibGljLWFwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlL2ExMXkvcHVibGljLWFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDOztBQUd2QyxNQUFNLE9BQU8sVUFBVTs7a0hBQVYsVUFBVTttSEFBVixVQUFVO21IQUFWLFVBQVU7c0dBQVYsVUFBVTtrQkFEdEIsUUFBUTttQkFBQyxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7TmdNb2R1bGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5ATmdNb2R1bGUoe30pXG5leHBvcnQgY2xhc3MgQTExeU1vZHVsZSB7XG59XG4iXX0=\n \n-/** @externs */\n-/**\n- * @externs\n- * @suppress {duplicate,checkTypes}\n- */\n-// NOTE: generated by tsickle, do not edit.\n-\n-\n---- esm2015/example.js ---\n+--- esm2020/example.mjs ---\n \n /**\n  * Generated bundle index. Do not edit.\n  */\n export * from './index';\n //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhhbXBsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlL2V4YW1wbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0dBRUc7QUFFSCxjQUFjLFNBQVMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR2VuZXJhdGVkIGJ1bmRsZSBpbmRleC4gRG8gbm90IGVkaXQuXG4gKi9cblxuZXhwb3J0ICogZnJvbSAnLi9pbmRleCc7XG4iXX0=\n \n---- esm2015/imports/imports.externs.js ---\n-\n-/** @externs */\n-/**\n- * @externs\n- * @suppress {duplicate,checkTypes}\n- */\n-// NOTE: generated by tsickle, do not edit.\n-\n-\n---- esm2015/imports/imports.js ---\n+--- esm2020/imports/imports.mjs ---\n \n /**\n  * Generated bundle index. Do not edit.\n  */\n export * from './index';\n-export { MySecondService as angular_packages_bazel_test_ng_package_example_imports_imports_a } from './second';\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlL2ltcG9ydHMvaW1wb3J0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUVILGNBQWMsU0FBUyxDQUFDO0FBRXhCLE9BQU8sRUFBQyxlQUFlLElBQUksaUVBQWlFLEVBQUMsTUFBTSxVQUFVLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEdlbmVyYXRlZCBidW5kbGUgaW5kZXguIERvIG5vdCBlZGl0LlxuICovXG5cbmV4cG9ydCAqIGZyb20gJy4vaW5kZXgnO1xuXG5leHBvcnQge015U2Vjb25kU2VydmljZSBhcyDJtWFuZ3VsYXJfcGFja2FnZXNfYmF6ZWxfdGVzdF9uZ19wYWNrYWdlX2V4YW1wbGVfaW1wb3J0c19pbXBvcnRzX2F9IGZyb20gJy4vc2Vjb25kJzsiXX0=\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlL2ltcG9ydHMvaW1wb3J0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUVILGNBQWMsU0FBUyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBHZW5lcmF0ZWQgYnVuZGxlIGluZGV4LiBEbyBub3QgZWRpdC5cbiAqL1xuXG5leHBvcnQgKiBmcm9tICcuL2luZGV4JztcbiJdfQ==\n \n---- esm2015/imports/index.js ---\n+--- esm2020/imports/index.mjs ---\n \n /**\n  * @license\n@@ -468,7 +187,7 @@ export { MySecondService as angular_packages_bazel_test_ng_package_example_imp\n export * from './public-api';\n //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS9pbXBvcnRzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILGNBQWMsY0FBYyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmV4cG9ydCAqIGZyb20gJy4vcHVibGljLWFwaSc7XG4iXX0=\n \n---- esm2015/imports/public-api.js ---\n+--- esm2020/imports/public-api.mjs ---\n \n /**\n  * @license\n@@ -486,16 +205,15 @@ export class MyService {\n         this.secondService = secondService;\n     }\n }\n-MyService.prov = i0.defineInjectable({ factory: function MyService_Factory() { return new MyService(i0.inject(i1.MySecondService)); }, token: MyService, providedIn: \"root\" });\n-MyService.decorators = [\n-    { type: Injectable, args: [{ providedIn: 'root' },] }\n-];\n-MyService.ctorParameters = () => [\n-    { type: MySecondService }\n-];\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVibGljLWFwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlL2ltcG9ydHMvcHVibGljLWFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxVQUFVLENBQUM7OztBQUd6QyxNQUFNLE9BQU8sU0FBUztJQUNwQixZQUFtQixhQUE4QjtRQUE5QixrQkFBYSxHQUFiLGFBQWEsQ0FBaUI7SUFBRyxDQUFDOzs7O1lBRnRELFVBQVUsU0FBQyxFQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUM7OztZQUZ4QixlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge015U2Vjb25kU2VydmljZX0gZnJvbSAnLi9zZWNvbmQnO1xuXG5ASW5qZWN0YWJsZSh7cHJvdmlkZWRJbjogJ3Jvb3QnfSlcbmV4cG9ydCBjbGFzcyBNeVNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgc2Vjb25kU2VydmljZTogTXlTZWNvbmRTZXJ2aWNlKSB7fVxufVxuIl19\n+MyService.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyService, deps: [{ token: i1.MySecondService }], target: i0.FactoryTarget.Injectable });\n+MyService.prov = i0.ngDeclareInjectable({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyService, providedIn: 'root' });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyService, decorators: [{\n+            type: Injectable,\n+            args: [{ providedIn: 'root' }]\n+        }], ctorParameters: function () { return [{ type: i1.MySecondService }]; } });\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVibGljLWFwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlL2ltcG9ydHMvcHVibGljLWFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxVQUFVLENBQUM7OztBQUd6QyxNQUFNLE9BQU8sU0FBUztJQUNwQixZQUFtQixhQUE4QjtRQUE5QixrQkFBYSxHQUFiLGFBQWEsQ0FBaUI7SUFBRyxDQUFDOztpSEFEMUMsU0FBUztxSEFBVCxTQUFTLGNBREcsTUFBTTtzR0FDbEIsU0FBUztrQkFEckIsVUFBVTttQkFBQyxFQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7TXlTZWNvbmRTZXJ2aWNlfSBmcm9tICcuL3NlY29uZCc7XG5cbkBJbmplY3RhYmxlKHtwcm92aWRlZEluOiAncm9vdCd9KVxuZXhwb3J0IGNsYXNzIE15U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBzZWNvbmRTZXJ2aWNlOiBNeVNlY29uZFNlcnZpY2UpIHt9XG59XG4iXX0=\n \n---- esm2015/imports/second.js ---\n+--- esm2020/imports/second.mjs ---\n \n /**\n  * @license\n@@ -508,13 +226,15 @@ import { Injectable } from '@angular/core';\n import * as i0 from \"@angular/core\";\n export class MySecondService {\n }\n-MySecondService.prov = i0.defineInjectable({ factory: function MySecondService_Factory() { return new MySecondService(); }, token: MySecondService, providedIn: \"root\" });\n-MySecondService.decorators = [\n-    { type: Injectable, args: [{ providedIn: 'root' },] }\n-];\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vjb25kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYmF6ZWwvdGVzdC9uZ19wYWNrYWdlL2V4YW1wbGUvaW1wb3J0cy9zZWNvbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQzs7QUFHekMsTUFBTSxPQUFPLGVBQWU7Ozs7WUFEM0IsVUFBVSxTQUFDLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5ASW5qZWN0YWJsZSh7cHJvdmlkZWRJbjogJ3Jvb3QnfSlcbmV4cG9ydCBjbGFzcyBNeVNlY29uZFNlcnZpY2Uge1xufVxuIl19\n+MySecondService.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MySecondService, deps: [], target: i0.FactoryTarget.Injectable });\n+MySecondService.prov = i0.ngDeclareInjectable({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MySecondService, providedIn: 'root' });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MySecondService, decorators: [{\n+            type: Injectable,\n+            args: [{ providedIn: 'root' }]\n+        }] });\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vjb25kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYmF6ZWwvdGVzdC9uZ19wYWNrYWdlL2V4YW1wbGUvaW1wb3J0cy9zZWNvbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQzs7QUFHekMsTUFBTSxPQUFPLGVBQWU7O3VIQUFmLGVBQWU7MkhBQWYsZUFBZSxjQURILE1BQU07c0dBQ2xCLGVBQWU7a0JBRDNCLFVBQVU7bUJBQUMsRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbkBJbmplY3RhYmxlKHtwcm92aWRlZEluOiAncm9vdCd9KVxuZXhwb3J0IGNsYXNzIE15U2Vjb25kU2VydmljZSB7XG59XG4iXX0=\n \n---- esm2015/index.js ---\n+--- esm2020/index.mjs ---\n \n /**\n  * @license\n@@ -526,7 +246,7 @@ MySecondService.decorators = [\n export * from './mymodule';\n //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxjQUFjLFlBQVksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5leHBvcnQgKiBmcm9tICcuL215bW9kdWxlJztcbiJdfQ==\n \n---- esm2015/mymodule.js ---\n+--- esm2020/mymodule.mjs ---\n \n /**\n  * @license\n@@ -536,14 +256,19 @@ export * from './mymodule';\n  * found in the LICENSE file at https://angular.io/license\n  */\n import { NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n export class MyModule {\n }\n-MyModule.decorators = [\n-    { type: NgModule, args: [{},] }\n-];\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXltb2R1bGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS9teW1vZHVsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBSXZDLE1BQU0sT0FBTyxRQUFROzs7WUFEcEIsUUFBUSxTQUFDLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0IHtOZ01vZHVsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge2F9IGZyb20gJy4vc2Vjb25kYXJ5L3NlY29uZGFyeW1vZHVsZSc7XG5cbkBOZ01vZHVsZSh7fSlcbmV4cG9ydCBjbGFzcyBNeU1vZHVsZSB7XG59XG4iXX0=\n+MyModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule, deps: [], target: i0.FactoryTarget.NgModule });\n+MyModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule });\n+MyModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXltb2R1bGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS9teW1vZHVsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDOztBQUl2QyxNQUFNLE9BQU8sUUFBUTs7Z0hBQVIsUUFBUTtpSEFBUixRQUFRO2lIQUFSLFFBQVE7c0dBQVIsUUFBUTtrQkFEcEIsUUFBUTttQkFBQyxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7TmdNb2R1bGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHthfSBmcm9tICcuL3NlY29uZGFyeS9zZWNvbmRhcnltb2R1bGUnO1xuXG5ATmdNb2R1bGUoe30pXG5leHBvcnQgY2xhc3MgTXlNb2R1bGUge1xufVxuIl19\n \n---- esm2015/secondary/index.js ---\n+--- esm2020/secondary/index.mjs ---\n \n /**\n  * @license\n@@ -555,25 +280,15 @@ MyModule.decorators = [\n export * from './secondarymodule';\n //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS9zZWNvbmRhcnkvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsY0FBYyxtQkFBbUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5leHBvcnQgKiBmcm9tICcuL3NlY29uZGFyeW1vZHVsZSc7XG4iXX0=\n \n---- esm2015/secondary/secondary.externs.js ---\n-\n-/** @externs */\n-/**\n- * @externs\n- * @suppress {duplicate,checkTypes}\n- */\n-// NOTE: generated by tsickle, do not edit.\n-\n-\n---- esm2015/secondary/secondary.js ---\n+--- esm2020/secondary/secondary.mjs ---\n \n /**\n  * Generated bundle index. Do not edit.\n  */\n export * from './index';\n //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vjb25kYXJ5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYmF6ZWwvdGVzdC9uZ19wYWNrYWdlL2V4YW1wbGUvc2Vjb25kYXJ5L3NlY29uZGFyeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUVILGNBQWMsU0FBUyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBHZW5lcmF0ZWQgYnVuZGxlIGluZGV4LiBEbyBub3QgZWRpdC5cbiAqL1xuXG5leHBvcnQgKiBmcm9tICcuL2luZGV4JztcbiJdfQ==\n \n---- esm2015/secondary/secondarymodule.js ---\n+--- esm2020/secondary/secondarymodule.mjs ---\n \n /**\n  * @license\n@@ -583,13 +298,18 @@ export * from './index';\n  * found in the LICENSE file at https://angular.io/license\n  */\n import { NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n export class SecondaryModule {\n }\n-SecondaryModule.decorators = [\n-    { type: NgModule, args: [{},] }\n-];\n+SecondaryModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule, deps: [], target: i0.FactoryTarget.NgModule });\n+SecondaryModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule });\n+SecondaryModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n export const a = 1;\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vjb25kYXJ5bW9kdWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYmF6ZWwvdGVzdC9uZ19wYWNrYWdlL2V4YW1wbGUvc2Vjb25kYXJ5L3NlY29uZGFyeW1vZHVsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBR3ZDLE1BQU0sT0FBTyxlQUFlOzs7WUFEM0IsUUFBUSxTQUFDLEVBQUU7O0FBSVosTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge05nTW9kdWxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuQE5nTW9kdWxlKHt9KVxuZXhwb3J0IGNsYXNzIFNlY29uZGFyeU1vZHVsZSB7XG59XG5cbmV4cG9ydCBjb25zdCBhID0gMTtcbiJdfQ==\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vjb25kYXJ5bW9kdWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYmF6ZWwvdGVzdC9uZ19wYWNrYWdlL2V4YW1wbGUvc2Vjb25kYXJ5L3NlY29uZGFyeW1vZHVsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDOztBQUd2QyxNQUFNLE9BQU8sZUFBZTs7dUhBQWYsZUFBZTt3SEFBZixlQUFlO3dIQUFmLGVBQWU7c0dBQWYsZUFBZTtrQkFEM0IsUUFBUTttQkFBQyxFQUFFOztBQUlaLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0IHtOZ01vZHVsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbkBOZ01vZHVsZSh7fSlcbmV4cG9ydCBjbGFzcyBTZWNvbmRhcnlNb2R1bGUge1xufVxuXG5leHBvcnQgY29uc3QgYSA9IDE7XG4iXX0=\n \n --- example.d.ts ---\n \n@@ -599,32 +319,33 @@ export const a = 1;\n  * License: MIT\n  */\n \n+import * as i0 from '@angular/core';\n \n export declare class MyModule {\n+    static fac: i0.FactoryDeclaration<MyModule, never>;\n+    static mod: i0.NgModuleDeclaration<MyModule, never, never, never>;\n+    static inj: i0.InjectorDeclaration<MyModule>;\n }\n \n export { }\n \n \n---- example.metadata.json ---\n-\n-{\"__symbolic\":\"module\",\"version\":4,\"metadata\":{\"MyModule\":{\"__symbolic\":\"class\",\"decorators\":[{\"__symbolic\":\"call\",\"expression\":{\"__symbolic\":\"reference\",\"module\":\"@angular/core\",\"name\":\"NgModule\",\"line\":11,\"character\":1},\"arguments\":[{}]}],\"members\":{}}},\"origins\":{\"MyModule\":\"./example\"},\"importAs\":\"example\"}\n-\n --- extra-styles.css ---\n \n .special {\n   color: goldenrod;\n }\n \n \n---- fesm2015/a11y.js ---\n+--- fesm2015/a11y.mjs ---\n \n /**\n  * @license Angular v0.0.0\n  * (c) 2010-2021 Google LLC. https://angular.io/\n  * License: MIT\n  */\n \n+import * as i0 from '@angular/core';\n import { NgModule } from '@angular/core';\n \n /**\n@@ -636,9 +357,13 @@ import { NgModule } from '@angular/core';\n  */\n class A11yModule {\n }\n-A11yModule.decorators = [\n-    { type: NgModule, args: [{},] }\n-];\n+A11yModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule, deps: [], target: i0.FactoryTarget.NgModule });\n+A11yModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule });\n+A11yModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n \n /**\n  * @license\n@@ -653,18 +378,19 @@ A11yModule.decorators = [\n  */\n \n export { A11yModule };\n-//# sourceMappingURL=a11y.js.map\n+//# sourceMappingURL=a11y.mjs.map\n \n \n---- fesm2015/imports.js ---\n+--- fesm2015/imports.mjs ---\n \n /**\n  * @license Angular v0.0.0\n  * (c) 2010-2021 Google LLC. https://angular.io/\n  * License: MIT\n  */\n \n-import { defineInjectable, Injectable, inject } from '@angular/core';\n+import * as i0 from '@angular/core';\n+import { Injectable } from '@angular/core';\n \n /**\n  * @license\n@@ -675,10 +401,12 @@ import { defineInjectable, Injectable, inject } from '@angular/core';\n  */\n class MySecondService {\n }\n-MySecondService.prov = defineInjectable({ factory: function MySecondService_Factory() { return new MySecondService(); }, token: MySecondService, providedIn: \"root\" });\n-MySecondService.decorators = [\n-    { type: Injectable, args: [{ providedIn: 'root' },] }\n-];\n+MySecondService.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MySecondService, deps: [], target: i0.FactoryTarget.Injectable });\n+MySecondService.prov = i0.ngDeclareInjectable({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MySecondService, providedIn: 'root' });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MySecondService, decorators: [{\n+            type: Injectable,\n+            args: [{ providedIn: 'root' }]\n+        }] });\n \n /**\n  * @license\n@@ -692,13 +420,12 @@ class MyService {\n         this.secondService = secondService;\n     }\n }\n-MyService.prov = defineInjectable({ factory: function MyService_Factory() { return new MyService(inject(MySecondService)); }, token: MyService, providedIn: \"root\" });\n-MyService.decorators = [\n-    { type: Injectable, args: [{ providedIn: 'root' },] }\n-];\n-MyService.ctorParameters = () => [\n-    { type: MySecondService }\n-];\n+MyService.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyService, deps: [{ token: MySecondService }], target: i0.FactoryTarget.Injectable });\n+MyService.prov = i0.ngDeclareInjectable({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyService, providedIn: 'root' });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyService, decorators: [{\n+            type: Injectable,\n+            args: [{ providedIn: 'root' }]\n+        }], ctorParameters: function () { return [{ type: MySecondService }]; } });\n \n /**\n  * @license\n@@ -712,18 +439,19 @@ MyService.ctorParameters = () => [\n  * Generated bundle index. Do not edit.\n  */\n \n-export { MyService, MySecondService as angular_packages_bazel_test_ng_package_example_imports_imports_a };\n-//# sourceMappingURL=imports.js.map\n+export { MyService };\n+//# sourceMappingURL=imports.mjs.map\n \n \n---- fesm2015/secondary.js ---\n+--- fesm2015/secondary.mjs ---\n \n /**\n  * @license Angular v0.0.0\n  * (c) 2010-2021 Google LLC. https://angular.io/\n  * License: MIT\n  */\n \n+import * as i0 from '@angular/core';\n import { NgModule } from '@angular/core';\n \n /**\n@@ -735,9 +463,13 @@ import { NgModule } from '@angular/core';\n  */\n class SecondaryModule {\n }\n-SecondaryModule.decorators = [\n-    { type: NgModule, args: [{},] }\n-];\n+SecondaryModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule, deps: [], target: i0.FactoryTarget.NgModule });\n+SecondaryModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule });\n+SecondaryModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n const a = 1;\n \n /**\n@@ -753,17 +485,18 @@ const a = 1;\n  */\n \n export { SecondaryModule, a };\n-//# sourceMappingURL=secondary.js.map\n+//# sourceMappingURL=secondary.mjs.map\n \n \n---- fesm2015/waffels.js ---\n+--- fesm2015/waffels.mjs ---\n \n /**\n  * @license Angular v0.0.0\n  * (c) 2010-2021 Google LLC. https://angular.io/\n  * License: MIT\n  */\n \n+import * as i0 from '@angular/core';\n import { NgModule } from '@angular/core';\n \n /**\n@@ -775,9 +508,13 @@ import { NgModule } from '@angular/core';\n  */\n class MyModule {\n }\n-MyModule.decorators = [\n-    { type: NgModule, args: [{},] }\n-];\n+MyModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule, deps: [], target: i0.FactoryTarget.NgModule });\n+MyModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule });\n+MyModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n \n /**\n  * @license\n@@ -792,125 +529,319 @@ MyModule.decorators = [\n  */\n \n export { MyModule };\n-//# sourceMappingURL=waffels.js.map\n+//# sourceMappingURL=waffels.mjs.map\n \n \n---- imports/imports.d.ts ---\n+--- fesm2020/a11y.mjs ---\n \n /**\n  * @license Angular v0.0.0\n  * (c) 2010-2021 Google LLC. https://angular.io/\n  * License: MIT\n  */\n \n-export declare class MyService {\n-    secondService: angular_packages_bazel_test_ng_package_example_imports_imports_a;\n-    constructor(secondService: angular_packages_bazel_test_ng_package_example_imports_imports_a);\n+import * as i0 from '@angular/core';\n+import { NgModule } from '@angular/core';\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+class A11yModule {\n }\n+A11yModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule, deps: [], target: i0.FactoryTarget.NgModule });\n+A11yModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule });\n+A11yModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: A11yModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n \n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n \n-export declare class angular_packages_bazel_test_ng_package_example_imports_imports_a {\n-}\n+/**\n+ * Generated bundle index. Do not edit.\n+ */\n \n-export { }\n+export { A11yModule };\n+//# sourceMappingURL=a11y.mjs.map\n \n \n---- imports/imports.metadata.json ---\n+--- fesm2020/imports.mjs ---\n \n-{\"__symbolic\":\"module\",\"version\":4,\"metadata\":{\"MyService\":{\"__symbolic\":\"class\",\"decorators\":[{\"__symbolic\":\"call\",\"expression\":{\"__symbolic\":\"reference\",\"module\":\"@angular/core\",\"name\":\"Injectable\",\"line\":11,\"character\":1},\"arguments\":[{\"providedIn\":\"root\"}]}],\"members\":{\"__ctor__\":[{\"__symbolic\":\"constructor\",\"parameters\":[{\"__symbolic\":\"reference\",\"name\":\"angular_packages_bazel_test_ng_package_example_imports_imports_a\"}]}]},\"statics\":{\"prov\":{}}},\"angular_packages_bazel_test_ng_package_example_imports_imports_a\":{\"__symbolic\":\"class\",\"decorators\":[{\"__symbolic\":\"call\",\"expression\":{\"__symbolic\":\"reference\",\"module\":\"@angular/core\",\"name\":\"Injectable\",\"line\":10,\"character\":1},\"arguments\":[{\"providedIn\":\"root\"}]}],\"members\":{},\"statics\":{\"prov\":{}}}},\"origins\":{\"MyService\":\"./imports\",\"angular_packages_bazel_test_ng_package_example_imports_imports_a\":\"./imports\"},\"importAs\":\"example/imports\"}\n+/**\n+ * @license Angular v0.0.0\n+ * (c) 2010-2021 Google LLC. https://angular.io/\n+ * License: MIT\n+ */\n \n---- imports/package.json ---\n+import * as i0 from '@angular/core';\n+import { Injectable } from '@angular/core';\n \n-{\n-  \"name\": \"example/imports\",\n-  \"main\": \"../bundles/example-imports.umd.js\",\n-  \"fesm2015\": \"../fesm2015/imports.js\",\n-  \"esm2015\": \"../esm2015/imports/imports.js\",\n-  \"typings\": \"./imports.d.ts\",\n-  \"module\": \"../fesm2015/imports.js\",\n-  \"es2015\": \"../fesm2015/imports.js\"\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+class MySecondService {\n }\n+MySecondService.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MySecondService, deps: [], target: i0.FactoryTarget.Injectable });\n+MySecondService.prov = i0.ngDeclareInjectable({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MySecondService, providedIn: 'root' });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MySecondService, decorators: [{\n+            type: Injectable,\n+            args: [{ providedIn: 'root' }]\n+        }] });\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+class MyService {\n+    constructor(secondService) {\n+        this.secondService = secondService;\n+    }\n+}\n+MyService.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyService, deps: [{ token: MySecondService }], target: i0.FactoryTarget.Injectable });\n+MyService.prov = i0.ngDeclareInjectable({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyService, providedIn: 'root' });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyService, decorators: [{\n+            type: Injectable,\n+            args: [{ providedIn: 'root' }]\n+        }], ctorParameters: function () { return [{ type: MySecondService }]; } });\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * Generated bundle index. Do not edit.\n+ */\n+\n+export { MyService };\n+//# sourceMappingURL=imports.mjs.map\n+\n \n---- imports.d.ts ---\n+--- fesm2020/secondary.mjs ---\n \n /**\n  * @license Angular v0.0.0\n  * (c) 2010-2021 Google LLC. https://angular.io/\n  * License: MIT\n  */\n \n-export * from './imports/imports';\n+import * as i0 from '@angular/core';\n+import { NgModule } from '@angular/core';\n \n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+class SecondaryModule {\n+}\n+SecondaryModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule, deps: [], target: i0.FactoryTarget.NgModule });\n+SecondaryModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule });\n+SecondaryModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: SecondaryModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n+const a = 1;\n \n---- imports.metadata.json ---\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n \n-{\"__symbolic\":\"module\",\"version\":3,\"metadata\":{},\"exports\":[{\"from\":\"./imports/imports\"}],\"flatModuleIndexRedirect\":true,\"importAs\":\"example/imports\"}\n+/**\n+ * Generated bundle index. Do not edit.\n+ */\n \n+export { SecondaryModule, a };\n+//# sourceMappingURL=secondary.mjs.map\n \n---- logo.png ---\n \n-9db278d630f5fabd8e7ba16c2e329a3a\n+--- fesm2020/waffels.mjs ---\n \n---- package.json ---\n+/**\n+ * @license Angular v0.0.0\n+ * (c) 2010-2021 Google LLC. https://angular.io/\n+ * License: MIT\n+ */\n \n-{\n-  \"name\": \"example\",\n-  \"version\": \"0.0.0\",\n-  \"main\": \"./bundles/example.umd.js\",\n-  \"fesm2015\": \"./fesm2015/example.js\",\n-  \"esm2015\": \"./esm2015/example.js\",\n-  \"typings\": \"./example.d.ts\",\n-  \"module\": \"./fesm2015/example.js\",\n-  \"es2015\": \"./fesm2015/example.js\"\n+import * as i0 from '@angular/core';\n+import { NgModule } from '@angular/core';\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+class MyModule {\n }\n+MyModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule, deps: [], target: i0.FactoryTarget.NgModule });\n+MyModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule });\n+MyModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n \n---- secondary/package.json ---\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n \n-{\n-  \"name\": \"example/secondary\",\n-  \"main\": \"../bundles/example-secondary.umd.js\",\n-  \"fesm2015\": \"../fesm2015/secondary.js\",\n-  \"esm2015\": \"../esm2015/secondary/secondary.js\",\n-  \"typings\": \"./secondary.d.ts\",\n-  \"module\": \"../fesm2015/secondary.js\",\n-  \"es2015\": \"../fesm2015/secondary.js\"\n-}\n+/**\n+ * Generated bundle index. Do not edit.\n+ */\n \n---- secondary/secondary.d.ts ---\n+export { MyModule };\n+//# sourceMappingURL=waffels.mjs.map\n+\n+\n+--- imports/imports.d.ts ---\n \n /**\n  * @license Angular v0.0.0\n  * (c) 2010-2021 Google LLC. https://angular.io/\n  * License: MIT\n  */\n \n-export declare const a = 1;\n+import * as i0 from '@angular/core';\n \n+declare class MySecondService {\n+    static fac: i0.FactoryDeclaration<MySecondService, never>;\n+    static prov: i0.InjectableDeclaration<MySecondService>;\n+}\n \n-export declare class SecondaryModule {\n+export declare class MyService {\n+    secondService: MySecondService;\n+    constructor(secondService: MySecondService);\n+    static fac: i0.FactoryDeclaration<MyService, never>;\n+    static prov: i0.InjectableDeclaration<MyService>;\n }\n \n export { }\n \n \n---- secondary/secondary.metadata.json ---\n+--- imports/package.json ---\n+\n+{\n+  \"name\": \"example/imports\",\n+  \"fesm2020\": \"../fesm2020/imports.mjs\",\n+  \"fesm2015\": \"../fesm2015/imports.mjs\",\n+  \"esm2020\": \"../esm2020/imports/imports.mjs\",\n+  \"typings\": \"./imports.d.ts\",\n+  \"module\": \"../fesm2015/imports.mjs\",\n+  \"es2020\": \"../fesm2020/imports.mjs\"\n+}\n+\n+--- logo.png ---\n+\n+611871c1f492a69a8a5f57e01096b145\n+\n+--- package.json ---\n+\n+{\n+  \"name\": \"example\",\n+  \"version\": \"0.0.0\",\n+  \"fesm2020\": \"./fesm2020/waffels.mjs\",\n+  \"fesm2015\": \"./fesm2015/waffels.mjs\",\n+  \"esm2020\": \"./esm2020/example.mjs\",\n+  \"typings\": \"./example.d.ts\",\n+  \"module\": \"./fesm2015/waffels.mjs\",\n+  \"es2020\": \"./fesm2020/waffels.mjs\",\n+  \"type\": \"module\",\n+  \"exports\": {\n+    \"./package.json\": {\n+      \"default\": \"./package.json\"\n+    },\n+    \".\": {\n+      \"types\": \"./example.d.ts\",\n+      \"es2015\": \"./fesm2015/waffels.mjs\",\n+      \"node\": \"./fesm2015/waffels.mjs\",\n+      \"default\": \"./fesm2020/waffels.mjs\"\n+    },\n+    \"./a11y\": {\n+      \"types\": \"./a11y/a11y.d.ts\",\n+      \"es2015\": \"./fesm2015/a11y.mjs\",\n+      \"node\": \"./fesm2015/a11y.mjs\",\n+      \"default\": \"./fesm2020/a11y.mjs\"\n+    },\n+    \"./imports\": {\n+      \"types\": \"./imports/imports.d.ts\",\n+      \"es2015\": \"./fesm2015/imports.mjs\",\n+      \"node\": \"./fesm2015/imports.mjs\",\n+      \"default\": \"./fesm2020/imports.mjs\"\n+    },\n+    \"./secondary\": {\n+      \"types\": \"./secondary/secondary.d.ts\",\n+      \"es2015\": \"./fesm2015/secondary.mjs\",\n+      \"node\": \"./fesm2015/secondary.mjs\",\n+      \"default\": \"./fesm2020/secondary.mjs\"\n+    }\n+  }\n+}\n+\n+--- secondary/package.json ---\n \n-{\"__symbolic\":\"module\",\"version\":4,\"metadata\":{\"SecondaryModule\":{\"__symbolic\":\"class\",\"decorators\":[{\"__symbolic\":\"call\",\"expression\":{\"__symbolic\":\"reference\",\"module\":\"@angular/core\",\"name\":\"NgModule\",\"line\":10,\"character\":1},\"arguments\":[{}]}],\"members\":{}},\"a\":1},\"origins\":{\"SecondaryModule\":\"./secondary\",\"a\":\"./secondary\"},\"importAs\":\"example/secondary\"}\n+{\n+  \"name\": \"example/secondary\",\n+  \"fesm2020\": \"../fesm2020/secondary.mjs\",\n+  \"fesm2015\": \"../fesm2015/secondary.mjs\",\n+  \"esm2020\": \"../esm2020/secondary/secondary.mjs\",\n+  \"typings\": \"./secondary.d.ts\",\n+  \"module\": \"../fesm2015/secondary.mjs\",\n+  \"es2020\": \"../fesm2020/secondary.mjs\"\n+}\n \n---- secondary.d.ts ---\n+--- secondary/secondary.d.ts ---\n \n /**\n  * @license Angular v0.0.0\n  * (c) 2010-2021 Google LLC. https://angular.io/\n  * License: MIT\n  */\n \n-export * from './secondary/secondary';\n+import * as i0 from '@angular/core';\n \n+export declare const a = 1;\n \n---- secondary.metadata.json ---\n+export declare class SecondaryModule {\n+    static fac: i0.FactoryDeclaration<SecondaryModule, never>;\n+    static mod: i0.NgModuleDeclaration<SecondaryModule, never, never, never>;\n+    static inj: i0.InjectorDeclaration<SecondaryModule>;\n+}\n \n-{\"__symbolic\":\"module\",\"version\":3,\"metadata\":{},\"exports\":[{\"from\":\"./secondary/secondary\"}],\"flatModuleIndexRedirect\":true,\"importAs\":\"example/secondary\"}\n+export { }\n \n \n --- some-file.txt ---"
        },
        {
            "sha": "a74d97b9c1c1484a0b51a17f974c601144822b0d",
            "filename": "packages/bazel/test/ng_package/example_with_ts_library_package.golden",
            "status": "modified",
            "additions": 185,
            "deletions": 237,
            "changes": 422,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_with_ts_library_package.golden",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_with_ts_library_package.golden",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_with_ts_library_package.golden?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -1,45 +1,38 @@\n README.md\n-bundles\n-  bundles/example-with-ts-library-portal.umd.js\n-  bundles/example-with-ts-library-portal.umd.js.map\n-  bundles/example-with-ts-library-utils.umd.js\n-  bundles/example-with-ts-library-utils.umd.js.map\n-  bundles/example-with-ts-library.umd.js\n-  bundles/example-with-ts-library.umd.js.map\n-esm2015\n-  esm2015/example.externs.js\n-  esm2015/index.js\n-  esm2015/portal\n-    esm2015/portal/index.js\n-    esm2015/portal/portal-module.js\n-    esm2015/portal/portal.externs.js\n-    esm2015/portal/portal.js\n-  esm2015/utils\n-    esm2015/utils/index.js\n-    esm2015/utils/testing.js\n-    esm2015/utils/utils.externs.js\n+esm2020\n+  esm2020/index.mjs\n+  esm2020/portal\n+    esm2020/portal/index.mjs\n+    esm2020/portal/portal-module.mjs\n+    esm2020/portal/portal.mjs\n+  esm2020/utils\n+    esm2020/utils/index.mjs\n+    esm2020/utils/testing.mjs\n fesm2015\n-  fesm2015/example-with-ts-library.js\n-  fesm2015/example-with-ts-library.js.map\n-  fesm2015/portal.js\n-  fesm2015/portal.js.map\n-  fesm2015/utils.js\n-  fesm2015/utils.js.map\n+  fesm2015/example-with-ts-library.mjs\n+  fesm2015/example-with-ts-library.mjs.map\n+  fesm2015/portal.mjs\n+  fesm2015/portal.mjs.map\n+  fesm2015/utils.mjs\n+  fesm2015/utils.mjs.map\n+fesm2020\n+  fesm2020/example-with-ts-library.mjs\n+  fesm2020/example-with-ts-library.mjs.map\n+  fesm2020/portal.mjs\n+  fesm2020/portal.mjs.map\n+  fesm2020/utils.mjs\n+  fesm2020/utils.mjs.map\n index.d.ts\n package.json\n portal\n   portal/index.d.ts\n   portal/package.json\n   portal/portal-module.d.ts\n   portal/portal.d.ts\n-  portal/portal.metadata.json\n-portal.d.ts\n-portal.metadata.json\n utils\n   utils/index.d.ts\n   utils/package.json\n   utils/testing.d.ts\n-utils.d.ts\n --- README.md ---\n \n Angular\n@@ -52,147 +45,118 @@ Usage information and reference details can be found in [Angular documentation](\n License: MIT\n \n \n---- bundles/example-with-ts-library-portal.umd.js ---\n+--- esm2020/index.mjs ---\n \n /**\n- * @license Angular v0.0.0\n- * (c) 2010-2021 Google LLC. https://angular.io/\n- * License: MIT\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n  */\n+export const VERSION = '0.0.0';\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS13aXRoLXRzLWxpYnJhcnkvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5leHBvcnQgY29uc3QgVkVSU0lPTiA9ICcwLjAuMCc7XG4iXX0=\n \n-(function (global, factory) {\n-    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/core')) :\n-    typeof define === 'function' && define.amd ? define('example-with-ts-library/portal', ['exports', '@angular/core'], factory) :\n-    (global = global || self, factory((global.exampleWithTsLibrary = global.exampleWithTsLibrary || {}, global.exampleWithTsLibrary.portal = {}), global.ng.core));\n-}(this, (function (exports, core) { 'use strict';\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-    var PortalModule = /** @class */ (function () {\n-        function PortalModule() {\n-        }\n-        return PortalModule;\n-    }());\n-    PortalModule.decorators = [\n-        { type: core.NgModule, args: [{},] }\n-    ];\n-    var a = 1;\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-\n-    /**\n-     * Generated bundle index. Do not edit.\n-     */\n-\n-    exports.PortalModule = PortalModule;\n-    exports.a = a;\n-\n-    Object.defineProperty(exports, '__esModule', { value: true });\n-\n-})));\n-//# sourceMappingURL=example-with-ts-library-portal.umd.js.map\n-\n-\n---- bundles/example-with-ts-library-utils.umd.js ---\n+--- esm2020/portal/index.mjs ---\n \n /**\n- * @license Angular v0.0.0\n- * (c) 2010-2021 Google LLC. https://angular.io/\n- * License: MIT\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n  */\n+export * from './portal-module';\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS13aXRoLXRzLWxpYnJhcnkvcG9ydGFsL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILGNBQWMsaUJBQWlCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuZXhwb3J0ICogZnJvbSAnLi9wb3J0YWwtbW9kdWxlJztcbiJdfQ==\n \n-(function (global, factory) {\n-    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\n-    typeof define === 'function' && define.amd ? define('example-with-ts-library/utils', ['exports'], factory) :\n-    (global = global || self, factory((global.exampleWithTsLibrary = global.exampleWithTsLibrary || {}, global.exampleWithTsLibrary.utils = {})));\n-}(this, (function (exports) { 'use strict';\n-\n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n-    function dispatchFakeEvent(el, ev) {\n-        el.dispatchEvent(ev);\n-    }\n+--- esm2020/portal/portal-module.mjs ---\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import { NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class PortalModule {\n+}\n+PortalModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule, deps: [], target: i0.FactoryTarget.NgModule });\n+PortalModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule });\n+PortalModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n+export const a = 1;\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9ydGFsLW1vZHVsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlLXdpdGgtdHMtbGlicmFyeS9wb3J0YWwvcG9ydGFsLW1vZHVsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDOztBQUd2QyxNQUFNLE9BQU8sWUFBWTs7b0hBQVosWUFBWTtxSEFBWixZQUFZO3FIQUFaLFlBQVk7c0dBQVosWUFBWTtrQkFEeEIsUUFBUTttQkFBQyxFQUFFOztBQUlaLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0IHtOZ01vZHVsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbkBOZ01vZHVsZSh7fSlcbmV4cG9ydCBjbGFzcyBQb3J0YWxNb2R1bGUge1xufVxuXG5leHBvcnQgY29uc3QgYSA9IDE7XG4iXX0=\n \n-    /**\n-     * @license\n-     * Copyright Google LLC All Rights Reserved.\n-     *\n-     * Use of this source code is governed by an MIT-style license that can be\n-     * found in the LICENSE file at https://angular.io/license\n-     */\n+--- esm2020/portal/portal.mjs ---\n+\n+/**\n+ * Generated bundle index. Do not edit.\n+ */\n+export * from './index';\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9ydGFsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYmF6ZWwvdGVzdC9uZ19wYWNrYWdlL2V4YW1wbGUtd2l0aC10cy1saWJyYXJ5L3BvcnRhbC9wb3J0YWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0dBRUc7QUFFSCxjQUFjLFNBQVMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR2VuZXJhdGVkIGJ1bmRsZSBpbmRleC4gRG8gbm90IGVkaXQuXG4gKi9cblxuZXhwb3J0ICogZnJvbSAnLi9pbmRleCc7XG4iXX0=\n \n-    exports.dispatchFakeEvent = dispatchFakeEvent;\n+--- esm2020/utils/index.mjs ---\n \n-    Object.defineProperty(exports, '__esModule', { value: true });\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+export * from './testing';\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS13aXRoLXRzLWxpYnJhcnkvdXRpbHMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsY0FBYyxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuZXhwb3J0ICogZnJvbSAnLi90ZXN0aW5nJztcbiJdfQ==\n \n-})));\n-//# sourceMappingURL=example-with-ts-library-utils.umd.js.map\n+--- esm2020/utils/testing.mjs ---\n \n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+export function dispatchFakeEvent(el, ev) {\n+    el.dispatchEvent(ev);\n+}\n+//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlLXdpdGgtdHMtbGlicmFyeS91dGlscy90ZXN0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxFQUFlLEVBQUUsRUFBUztJQUMxRCxFQUFFLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuZXhwb3J0IGZ1bmN0aW9uIGRpc3BhdGNoRmFrZUV2ZW50KGVsOiBIVE1MRWxlbWVudCwgZXY6IEV2ZW50KSB7XG4gIGVsLmRpc3BhdGNoRXZlbnQoZXYpO1xufVxuIl19\n \n---- bundles/example-with-ts-library.umd.js ---\n+--- fesm2015/example-with-ts-library.mjs ---\n \n /**\n  * @license Angular v0.0.0\n  * (c) 2010-2021 Google LLC. https://angular.io/\n  * License: MIT\n  */\n \n-(function (global, factory) {\n-\ttypeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\n-\ttypeof define === 'function' && define.amd ? define('example-with-ts-library', ['exports'], factory) :\n-\t(global = global || self, factory(global.exampleWithTsLibrary = {}));\n-}(this, (function (exports) { 'use strict';\n-\n-\t/**\n-\t * @license\n-\t * Copyright Google LLC All Rights Reserved.\n-\t *\n-\t * Use of this source code is governed by an MIT-style license that can be\n-\t * found in the LICENSE file at https://angular.io/license\n-\t */\n-\tvar VERSION = '0.0.0';\n-\n-\texports.VERSION = VERSION;\n-\n-\tObject.defineProperty(exports, '__esModule', { value: true });\n-\n-})));\n-//# sourceMappingURL=example-with-ts-library.umd.js.map\n-\n-\n---- esm2015/example.externs.js ---\n-\n-\n-\n---- esm2015/index.js ---\n-\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n  *\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-export const VERSION = '0.0.0';\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS13aXRoLXRzLWxpYnJhcnkvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5leHBvcnQgY29uc3QgVkVSU0lPTiA9ICcwLjAuMCc7XG4iXX0=\n+const VERSION = '0.0.0';\n+\n+export { VERSION };\n+//# sourceMappingURL=example-with-ts-library.mjs.map\n \n---- esm2015/portal/index.js ---\n+\n+--- fesm2015/portal.mjs ---\n+\n+/**\n+ * @license Angular v0.0.0\n+ * (c) 2010-2021 Google LLC. https://angular.io/\n+ * License: MIT\n+ */\n+\n+import * as i0 from '@angular/core';\n+import { NgModule } from '@angular/core';\n \n /**\n  * @license\n@@ -201,10 +165,16 @@ export const VERSION = '0.0.0';\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-export * from './portal-module';\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS13aXRoLXRzLWxpYnJhcnkvcG9ydGFsL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILGNBQWMsaUJBQWlCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuZXhwb3J0ICogZnJvbSAnLi9wb3J0YWwtbW9kdWxlJztcbiJdfQ==\n-\n---- esm2015/portal/portal-module.js ---\n+class PortalModule {\n+}\n+PortalModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule, deps: [], target: i0.FactoryTarget.NgModule });\n+PortalModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule });\n+PortalModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n+const a = 1;\n \n /**\n  * @license\n@@ -213,34 +183,22 @@ export * from './portal-module';\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import { NgModule } from '@angular/core';\n-export class PortalModule {\n-}\n-PortalModule.decorators = [\n-    { type: NgModule, args: [{},] }\n-];\n-export const a = 1;\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9ydGFsLW1vZHVsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlLXdpdGgtdHMtbGlicmFyeS9wb3J0YWwvcG9ydGFsLW1vZHVsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBR3ZDLE1BQU0sT0FBTyxZQUFZOzs7WUFEeEIsUUFBUSxTQUFDLEVBQUU7O0FBSVosTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge05nTW9kdWxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuQE5nTW9kdWxlKHt9KVxuZXhwb3J0IGNsYXNzIFBvcnRhbE1vZHVsZSB7XG59XG5cbmV4cG9ydCBjb25zdCBhID0gMTtcbiJdfQ==\n \n---- esm2015/portal/portal.externs.js ---\n-\n-/** @externs */\n /**\n- * @externs\n- * @suppress {duplicate,checkTypes}\n+ * Generated bundle index. Do not edit.\n  */\n-// NOTE: generated by tsickle, do not edit.\n \n+export { PortalModule, a };\n+//# sourceMappingURL=portal.mjs.map\n \n---- esm2015/portal/portal.js ---\n+\n+--- fesm2015/utils.mjs ---\n \n /**\n- * Generated bundle index. Do not edit.\n+ * @license Angular v0.0.0\n+ * (c) 2010-2021 Google LLC. https://angular.io/\n+ * License: MIT\n  */\n-export * from './index';\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9ydGFsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYmF6ZWwvdGVzdC9uZ19wYWNrYWdlL2V4YW1wbGUtd2l0aC10cy1saWJyYXJ5L3BvcnRhbC9wb3J0YWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0dBRUc7QUFFSCxjQUFjLFNBQVMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR2VuZXJhdGVkIGJ1bmRsZSBpbmRleC4gRG8gbm90IGVkaXQuXG4gKi9cblxuZXhwb3J0ICogZnJvbSAnLi9pbmRleCc7XG4iXX0=\n-\n---- esm2015/utils/index.js ---\n \n /**\n  * @license\n@@ -249,10 +207,9 @@ export * from './index';\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-export * from './testing';\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC90ZXN0L25nX3BhY2thZ2UvZXhhbXBsZS13aXRoLXRzLWxpYnJhcnkvdXRpbHMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsY0FBYyxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuZXhwb3J0ICogZnJvbSAnLi90ZXN0aW5nJztcbiJdfQ==\n-\n---- esm2015/utils/testing.js ---\n+function dispatchFakeEvent(el, ev) {\n+    el.dispatchEvent(ev);\n+}\n \n /**\n  * @license\n@@ -261,16 +218,12 @@ export * from './testing';\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-export function dispatchFakeEvent(el, ev) {\n-    el.dispatchEvent(ev);\n-}\n-//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2JhemVsL3Rlc3QvbmdfcGFja2FnZS9leGFtcGxlLXdpdGgtdHMtbGlicmFyeS91dGlscy90ZXN0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxFQUFlLEVBQUUsRUFBUztJQUMxRCxFQUFFLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuZXhwb3J0IGZ1bmN0aW9uIGRpc3BhdGNoRmFrZUV2ZW50KGVsOiBIVE1MRWxlbWVudCwgZXY6IEV2ZW50KSB7XG4gIGVsLmRpc3BhdGNoRXZlbnQoZXYpO1xufVxuIl19\n-\n---- esm2015/utils/utils.externs.js ---\n \n+export { dispatchFakeEvent };\n+//# sourceMappingURL=utils.mjs.map\n \n \n---- fesm2015/example-with-ts-library.js ---\n+--- fesm2020/example-with-ts-library.mjs ---\n \n /**\n  * @license Angular v0.0.0\n@@ -288,17 +241,18 @@ export function dispatchFakeEvent(el, ev) {\n const VERSION = '0.0.0';\n \n export { VERSION };\n-//# sourceMappingURL=example-with-ts-library.js.map\n+//# sourceMappingURL=example-with-ts-library.mjs.map\n \n \n---- fesm2015/portal.js ---\n+--- fesm2020/portal.mjs ---\n \n /**\n  * @license Angular v0.0.0\n  * (c) 2010-2021 Google LLC. https://angular.io/\n  * License: MIT\n  */\n \n+import * as i0 from '@angular/core';\n import { NgModule } from '@angular/core';\n \n /**\n@@ -310,9 +264,13 @@ import { NgModule } from '@angular/core';\n  */\n class PortalModule {\n }\n-PortalModule.decorators = [\n-    { type: NgModule, args: [{},] }\n-];\n+PortalModule.fac = i0.ngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule, deps: [], target: i0.FactoryTarget.NgModule });\n+PortalModule.mod = i0.ngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule });\n+PortalModule.inj = i0.ngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule });\n+i0.ngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0\", ngImport: i0, type: PortalModule, decorators: [{\n+            type: NgModule,\n+            args: [{}]\n+        }] });\n const a = 1;\n \n /**\n@@ -328,10 +286,10 @@ const a = 1;\n  */\n \n export { PortalModule, a };\n-//# sourceMappingURL=portal.js.map\n+//# sourceMappingURL=portal.mjs.map\n \n \n---- fesm2015/utils.js ---\n+--- fesm2020/utils.mjs ---\n \n /**\n  * @license Angular v0.0.0\n@@ -359,7 +317,7 @@ function dispatchFakeEvent(el, ev) {\n  */\n \n export { dispatchFakeEvent };\n-//# sourceMappingURL=utils.js.map\n+//# sourceMappingURL=utils.mjs.map\n \n \n --- index.d.ts ---\n@@ -380,12 +338,36 @@ export declare const VERSION = \"0.0.0\";\n   \"name\": \"example-with-ts-library\",\n   \"version\": \"0.0.0\",\n   \"schematics\": \"Custom property that should be preserved.\",\n-  \"main\": \"./bundles/example-with-ts-library.umd.js\",\n-  \"fesm2015\": \"./fesm2015/example-with-ts-library.js\",\n-  \"esm2015\": \"./esm2015/index.js\",\n+  \"fesm2020\": \"./fesm2020/example-with-ts-library.mjs\",\n+  \"fesm2015\": \"./fesm2015/example-with-ts-library.mjs\",\n+  \"esm2020\": \"./esm2020/index.mjs\",\n   \"typings\": \"./index.d.ts\",\n-  \"module\": \"./fesm2015/example-with-ts-library.js\",\n-  \"es2015\": \"./fesm2015/example-with-ts-library.js\"\n+  \"module\": \"./fesm2015/example-with-ts-library.mjs\",\n+  \"es2020\": \"./fesm2020/example-with-ts-library.mjs\",\n+  \"type\": \"module\",\n+  \"exports\": {\n+    \"./package.json\": {\n+      \"default\": \"./package.json\"\n+    },\n+    \".\": {\n+      \"types\": \"./index.d.ts\",\n+      \"es2015\": \"./fesm2015/example-with-ts-library.mjs\",\n+      \"node\": \"./fesm2015/example-with-ts-library.mjs\",\n+      \"default\": \"./fesm2020/example-with-ts-library.mjs\"\n+    },\n+    \"./portal\": {\n+      \"types\": \"./portal/portal.d.ts\",\n+      \"es2015\": \"./fesm2015/portal.mjs\",\n+      \"node\": \"./fesm2015/portal.mjs\",\n+      \"default\": \"./fesm2020/portal.mjs\"\n+    },\n+    \"./utils\": {\n+      \"types\": \"./utils/index.d.ts\",\n+      \"es2015\": \"./fesm2015/utils.mjs\",\n+      \"node\": \"./fesm2015/utils.mjs\",\n+      \"default\": \"./fesm2020/utils.mjs\"\n+    }\n+  }\n }\n \n --- portal/index.d.ts ---\n@@ -404,24 +386,21 @@ export * from './portal-module';\n \n {\n   \"name\": \"example-with-ts-library/portal\",\n-  \"main\": \"../bundles/example-with-ts-library-portal.umd.js\",\n-  \"fesm2015\": \"../fesm2015/portal.js\",\n-  \"esm2015\": \"../esm2015/portal/portal.js\",\n+  \"fesm2020\": \"../fesm2020/portal.mjs\",\n+  \"fesm2015\": \"../fesm2015/portal.mjs\",\n+  \"esm2020\": \"../esm2020/portal/portal.mjs\",\n   \"typings\": \"./portal.d.ts\",\n-  \"module\": \"../fesm2015/portal.js\",\n-  \"es2015\": \"../fesm2015/portal.js\"\n+  \"module\": \"../fesm2015/portal.mjs\",\n+  \"es2020\": \"../fesm2020/portal.mjs\"\n }\n \n --- portal/portal-module.d.ts ---\n \n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n+import * as i0 from \"@angular/core\";\n export declare class PortalModule {\n+    static fac: i0.FactoryDeclaration<PortalModule, never>;\n+    static mod: i0.NgModuleDeclaration<PortalModule, never, never, never>;\n+    static inj: i0.InjectorDeclaration<PortalModule>;\n }\n export declare const a = 1;\n \n@@ -434,26 +413,6 @@ export declare const a = 1;\n export * from './index';\n \n \n---- portal/portal.metadata.json ---\n-\n-{\"__symbolic\":\"module\",\"version\":4,\"metadata\":{\"PortalModule\":{\"__symbolic\":\"class\",\"decorators\":[{\"__symbolic\":\"call\",\"expression\":{\"__symbolic\":\"reference\",\"module\":\"@angular/core\",\"name\":\"NgModule\",\"line\":10,\"character\":1},\"arguments\":[{}]}],\"members\":{}},\"a\":1},\"origins\":{\"PortalModule\":\"./portal-module\",\"a\":\"./portal-module\"},\"importAs\":\"example-with-ts-library/portal\"}\n-\n---- portal.d.ts ---\n-\n-/**\n- * @license Angular v0.0.0\n- * (c) 2010-2021 Google LLC. https://angular.io/\n- * License: MIT\n- */\n-\n-export * from './portal/portal';\n-\n-\n---- portal.metadata.json ---\n-\n-{\"__symbolic\":\"module\",\"version\":3,\"metadata\":{},\"exports\":[{\"from\":\"./portal/portal\"}],\"flatModuleIndexRedirect\":true,\"importAs\":\"example-with-ts-library/portal\"}\n-\n-\n --- utils/index.d.ts ---\n \n /**\n@@ -470,12 +429,12 @@ export * from './testing';\n \n {\n   \"name\": \"example-with-ts-library/utils\",\n-  \"main\": \"../bundles/example-with-ts-library-utils.umd.js\",\n-  \"fesm2015\": \"../fesm2015/utils.js\",\n-  \"esm2015\": \"../esm2015/utils/index.js\",\n+  \"fesm2020\": \"../fesm2020/utils.mjs\",\n+  \"fesm2015\": \"../fesm2015/utils.mjs\",\n+  \"esm2020\": \"../esm2020/utils/index.mjs\",\n   \"typings\": \"./index.d.ts\",\n-  \"module\": \"../fesm2015/utils.js\",\n-  \"es2015\": \"../fesm2015/utils.js\"\n+  \"module\": \"../fesm2015/utils.mjs\",\n+  \"es2020\": \"../fesm2020/utils.mjs\"\n }\n \n --- utils/testing.d.ts ---\n@@ -489,14 +448,3 @@ export * from './testing';\n  */\n export declare function dispatchFakeEvent(el: HTMLElement, ev: Event): void;\n \n-\n---- utils.d.ts ---\n-\n-/**\n- * @license Angular v0.0.0\n- * (c) 2010-2021 Google LLC. https://angular.io/\n- * License: MIT\n- */\n-\n-export * from './utils/index';\n-"
        },
        {
            "sha": "35fd3f0694f4f7d445a3e35ea90137ec51725955",
            "filename": "tools/defaults.bzl",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/tools%2Fdefaults.bzl",
            "raw_url": "https://github.com/angular/angular/raw/49b82ae56112c1e0d58ac28bcab1705e1f678ab1/tools%2Fdefaults.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fdefaults.bzl?ref=49b82ae56112c1e0d58ac28bcab1705e1f678ab1",
            "patch": "@@ -191,9 +191,6 @@ def ng_package(name, readme_md = None, license_banner = None, deps = [], **kwarg\n         readme_md = \"//packages:README.md\"\n     if not license_banner:\n         license_banner = \"//packages:license-banner.txt\"\n-    deps = deps + [\n-        \"@npm//tslib\",\n-    ]\n     visibility = kwargs.pop(\"visibility\", None)\n \n     common_substitutions = dict(kwargs.pop(\"substitutions\", {}), **PKG_GROUP_REPLACEMENTS)\n@@ -260,8 +257,11 @@ def pkg_npm(name, **kwargs):\n     deps = kwargs.pop(\"deps\", [])\n \n     # The `pkg_npm` rule brings in devmode (`JSModuleInfo`) and prodmode (`JSEcmaScriptModuleInfo`)\n-    # output into the the NPM package. We do not plan to ship prodmode ECMAScript `.mjs` files yet,\n-    # so we only extract the `JSModuleInfo` outputs (which correspond to ES5 output) from the deps.\n+    # output into the the NPM package We do not intend to ship the prodmode ECMAScript `.mjs`\n+    # files, but the `JSModuleInfo` outputs (which correspond to devmode output). We cannot\n+    # ship prodmode ECMAScript output was our output is not fully ESM-compatible due to relative\n+    # imports not specifying an explicit extension.\n+    # TODO: Clean this up in the future if we have combined devmode and prodmode output.\n     # https://github.com/bazelbuild/rules_nodejs/commit/911529fd364eb3ee1b8ecdc568a9fcf38a8b55ca.\n     # https://github.com/bazelbuild/rules_nodejs/blob/stable/packages/typescript/internal/build_defs.bzl#L334-L337.\n     extract_js_module_output(\n@@ -465,6 +465,12 @@ def ng_rollup_bundle(deps = [], **kwargs):\n         **kwargs\n     )\n \n+# TODO: Consider removing this rule in favor of `ng_rollup_bundle`. Most of the tests use\n+# the benchmarking rule from dev-infra, but there are cases where we have a bad mix of\n+# the rollup bundle rules here. i.e.\n+#   - `@angular/language-service` uses the benchmarking rule for shipping to NPM.\n+#   - `@angular/service-worker` uses the benchmarking rule for shipping the worker minified.\n+#   - `zone.js` uses this rule (as the only consumer) for creating NPM package bundles.\n def rollup_bundle(name, testonly = False, sourcemap = \"true\", **kwargs):\n     \"\"\"A drop in replacement for the rules nodejs [legacy rollup_bundle].\n "
        }
    ],
    "stats": {
        "total": 2931,
        "additions": 1346,
        "deletions": 1585
    }
}