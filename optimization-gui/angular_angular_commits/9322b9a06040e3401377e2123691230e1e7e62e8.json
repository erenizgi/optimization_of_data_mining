{
    "author": "crisbeto",
    "message": "fix(compiler): check more cases for pipe usage inside host bindings (#37883)\n\nBuilds on top of #34655 to support more cases that could be using a pipe inside host bindings (e.g. ternary expressions or function calls).\n\nFixes #37610.\n\nPR Close #37883",
    "sha": "9322b9a06040e3401377e2123691230e1e7e62e8",
    "files": [
        {
            "sha": "9ad1a3a6786cd6badf9197dbaf6001f5a83b4027",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 38,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/9322b9a06040e3401377e2123691230e1e7e62e8/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9322b9a06040e3401377e2123691230e1e7e62e8/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=9322b9a06040e3401377e2123691230e1e7e62e8",
            "patch": "@@ -3071,44 +3071,6 @@ runInEachFileSystem(os => {\n           .toContain('Host binding expression cannot contain pipes');\n     });\n \n-    it('should throw in case pipes are used in host bindings (defined as `!(value | pipe)`)',\n-       () => {\n-         env.write(`test.ts`, `\n-            import {Component} from '@angular/core';\n-\n-            @Component({\n-              selector: 'test',\n-              template: '...',\n-              host: {\n-                '[id]': '!(id | myPipe)'\n-              }\n-            })\n-            class FooCmp {}\n-         `);\n-         const errors = env.driveDiagnostics();\n-         expect(trim(errors[0].messageText as string))\n-             .toContain('Host binding expression cannot contain pipes');\n-       });\n-\n-    it('should throw in case pipes are used in host bindings (defined as `(value | pipe) === X`)',\n-       () => {\n-         env.write(`test.ts`, `\n-            import {Component} from '@angular/core';\n-\n-            @Component({\n-              selector: 'test',\n-              template: '...',\n-              host: {\n-                '[id]': '(id | myPipe) === true'\n-              }\n-            })\n-            class FooCmp {}\n-         `);\n-         const errors = env.driveDiagnostics();\n-         expect(trim(errors[0].messageText as string))\n-             .toContain('Host binding expression cannot contain pipes');\n-       });\n-\n     it('should generate host bindings for directives', () => {\n       env.write(`test.ts`, `\n         import {Component, HostBinding, HostListener, TemplateRef} from '@angular/core';"
        },
        {
            "sha": "8f97b71ff3856cde7fe68b10e8b33c8649657342",
            "filename": "packages/compiler/src/expression_parser/parser.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 14,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/9322b9a06040e3401377e2123691230e1e7e62e8/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/9322b9a06040e3401377e2123691230e1e7e62e8/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts?ref=9322b9a06040e3401377e2123691230e1e7e62e8",
            "patch": "@@ -10,7 +10,7 @@ import * as chars from '../chars';\n import {DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig} from '../ml_parser/interpolation_config';\n import {escapeRegExp} from '../util';\n \n-import {AbsoluteSourceSpan, AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Chain, Conditional, EmptyExpr, ExpressionBinding, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralMapKey, LiteralPrimitive, MethodCall, NonNullAssert, ParserError, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, SafeMethodCall, SafePropertyRead, TemplateBinding, TemplateBindingIdentifier, VariableBinding} from './ast';\n+import {AbsoluteSourceSpan, AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Chain, Conditional, EmptyExpr, ExpressionBinding, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralMapKey, LiteralPrimitive, MethodCall, NonNullAssert, ParserError, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeMethodCall, SafePropertyRead, TemplateBinding, TemplateBindingIdentifier, VariableBinding} from './ast';\n import {EOF, isIdentifier, isQuote, Lexer, Token, TokenType} from './lexer';\n \n export class SplitInterpolation {\n@@ -1052,11 +1052,11 @@ class SimpleExpressionChecker implements AstVisitor {\n   visitFunctionCall(ast: FunctionCall, context: any) {}\n \n   visitLiteralArray(ast: LiteralArray, context: any) {\n-    this.visitAll(ast.expressions);\n+    this.visitAll(ast.expressions, context);\n   }\n \n   visitLiteralMap(ast: LiteralMap, context: any) {\n-    this.visitAll(ast.values);\n+    this.visitAll(ast.values, context);\n   }\n \n   visitBinary(ast: Binary, context: any) {}\n@@ -1075,8 +1075,8 @@ class SimpleExpressionChecker implements AstVisitor {\n \n   visitKeyedWrite(ast: KeyedWrite, context: any) {}\n \n-  visitAll(asts: any[]): any[] {\n-    return asts.map(node => node.visit(this));\n+  visitAll(asts: any[], context: any): any[] {\n+    return asts.map(node => node.visit(this, context));\n   }\n \n   visitChain(ast: Chain, context: any) {}\n@@ -1085,19 +1085,16 @@ class SimpleExpressionChecker implements AstVisitor {\n }\n \n /**\n- * This class extends SimpleExpressionChecker used in View Engine and performs more strict checks to\n- * make sure host bindings do not contain pipes. In View Engine, having pipes in host bindings is\n+ * This class implements SimpleExpressionChecker used in View Engine and performs more strict checks\n+ * to make sure host bindings do not contain pipes. In View Engine, having pipes in host bindings is\n  * not supported as well, but in some cases (like `!(value | async)`) the error is not triggered at\n  * compile time. In order to preserve View Engine behavior, more strict checks are introduced for\n  * Ivy mode only.\n  */\n-class IvySimpleExpressionChecker extends SimpleExpressionChecker {\n-  visitBinary(ast: Binary, context: any) {\n-    ast.left.visit(this);\n-    ast.right.visit(this);\n-  }\n+class IvySimpleExpressionChecker extends RecursiveAstVisitor implements SimpleExpressionChecker {\n+  errors: string[] = [];\n \n-  visitPrefixNot(ast: PrefixNot, context: any) {\n-    ast.expression.visit(this);\n+  visitPipe() {\n+    this.errors.push('pipes');\n   }\n }"
        },
        {
            "sha": "e58f3a7efef4f5258646db679a8decfe0784e35d",
            "filename": "packages/compiler/test/expression_parser/parser_spec.ts",
            "status": "modified",
            "additions": 72,
            "deletions": 1,
            "changes": 73,
            "blob_url": "https://github.com/angular/angular/blob/9322b9a06040e3401377e2123691230e1e7e62e8/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9322b9a06040e3401377e2123691230e1e7e62e8/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts?ref=9322b9a06040e3401377e2123691230e1e7e62e8",
            "patch": "@@ -8,7 +8,7 @@\n \n import {ASTWithSource, BindingPipe, Interpolation, ParserError, TemplateBinding, VariableBinding} from '@angular/compiler/src/expression_parser/ast';\n import {Lexer} from '@angular/compiler/src/expression_parser/lexer';\n-import {Parser, SplitInterpolation} from '@angular/compiler/src/expression_parser/parser';\n+import {IvyParser, Parser, SplitInterpolation} from '@angular/compiler/src/expression_parser/parser';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n \n \n@@ -740,6 +740,68 @@ describe('parser', () => {\n     it('should report when encountering field write', () => {\n       expectError(validate(parseSimpleBinding('a = b')), 'Bindings cannot contain assignments');\n     });\n+\n+    describe('Ivy-only validations', () => {\n+      it('should throw if a pipe is used inside a conditional', () => {\n+        expectError(\n+            validate(parseSimpleBindingIvy('(hasId | myPipe) ? \"my-id\" : \"\"')),\n+            'Host binding expression cannot contain pipes');\n+      });\n+\n+      it('should throw if a pipe is used inside a function call', () => {\n+        expectError(\n+            validate(parseSimpleBindingIvy('getId(true, id | myPipe)')),\n+            'Host binding expression cannot contain pipes');\n+      });\n+\n+      it('should throw if a pipe is used inside a method call', () => {\n+        expectError(\n+            validate(parseSimpleBindingIvy('idService.getId(true, id | myPipe)')),\n+            'Host binding expression cannot contain pipes');\n+      });\n+\n+      it('should throw if a pipe is used inside a safe method call', () => {\n+        expectError(\n+            validate(parseSimpleBindingIvy('idService?.getId(true, id | myPipe)')),\n+            'Host binding expression cannot contain pipes');\n+      });\n+\n+      it('should throw if a pipe is used inside a property access', () => {\n+        expectError(\n+            validate(parseSimpleBindingIvy('a[id | myPipe]')),\n+            'Host binding expression cannot contain pipes');\n+      });\n+\n+      it('should throw if a pipe is used inside a keyed read expression', () => {\n+        expectError(\n+            validate(parseSimpleBindingIvy('a[id | myPipe].b')),\n+            'Host binding expression cannot contain pipes');\n+      });\n+\n+      it('should throw if a pipe is used inside a safe property read', () => {\n+        expectError(\n+            validate(parseSimpleBindingIvy('(id | myPipe)?.id')),\n+            'Host binding expression cannot contain pipes');\n+      });\n+\n+      it('should throw if a pipe is used inside a non-null assertion', () => {\n+        expectError(\n+            validate(parseSimpleBindingIvy('[id | myPipe]!')),\n+            'Host binding expression cannot contain pipes');\n+      });\n+\n+      it('should throw if a pipe is used inside a prefix not expression', () => {\n+        expectError(\n+            validate(parseSimpleBindingIvy('!(id | myPipe)')),\n+            'Host binding expression cannot contain pipes');\n+      });\n+\n+      it('should throw if a pipe is used inside a binary expression', () => {\n+        expectError(\n+            validate(parseSimpleBindingIvy('(id | myPipe) === true')),\n+            'Host binding expression cannot contain pipes');\n+      });\n+    });\n   });\n \n   describe('wrapLiteralPrimitive', () => {\n@@ -781,6 +843,10 @@ function createParser() {\n   return new Parser(new Lexer());\n }\n \n+function createIvyParser() {\n+  return new IvyParser(new Lexer());\n+}\n+\n function parseAction(text: string, location: any = null, offset: number = 0): ASTWithSource {\n   return createParser().parseAction(text, location, offset);\n }\n@@ -816,6 +882,11 @@ function parseSimpleBinding(text: string, location: any = null, offset: number =\n   return createParser().parseSimpleBinding(text, location, offset);\n }\n \n+function parseSimpleBindingIvy(\n+    text: string, location: any = null, offset: number = 0): ASTWithSource {\n+  return createIvyParser().parseSimpleBinding(text, location, offset);\n+}\n+\n function checkInterpolation(exp: string, expected?: string) {\n   const ast = parseInterpolation(exp)!;\n   if (expected == null) expected = exp;"
        }
    ],
    "stats": {
        "total": 136,
        "additions": 83,
        "deletions": 53
    }
}