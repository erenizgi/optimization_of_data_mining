{
    "author": "unknown",
    "message": "fix(common): ensure scrollRestoration is writable (#30630)\n\nSome specialised browsers that do not support scroll restoration\n(e.g. some web crawlers) do not allow `scrollRestoration` to be\nwritable.\n\nWe already sniff the browser to see if it has the `window.scrollTo`\nmethod, so now we also check whether `window.history.scrollRestoration`\nis writable too.\n\nFixes #30629\n\nPR Close #30630",
    "sha": "bb88c9fa3daac80086efbda951d81c159e3840f4",
    "files": [
        {
            "sha": "bd3ffd71f11519eafe15be4f3e8ebf2a00652399",
            "filename": "aio/src/app/shared/scroll.service.spec.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/bb88c9fa3daac80086efbda951d81c159e3840f4/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb88c9fa3daac80086efbda951d81c159e3840f4/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.spec.ts?ref=bb88c9fa3daac80086efbda951d81c159e3840f4",
            "patch": "@@ -80,6 +80,26 @@ describe('ScrollService', () => {\n        expect(updateScrollPositionInHistorySpy).toHaveBeenCalledTimes(1);\n      }));\n \n+  it('should not support `manual` scrollRestoration when it is not writable', () => {\n+    const original = Object.getOwnPropertyDescriptor(window.history, 'scrollRestoration');\n+    try {\n+      Object.defineProperty(window.history, 'scrollRestoration', {\n+        value: 'auto',\n+        configurable: true,\n+      });\n+      scrollService = createScrollService(\n+          document, platformLocation as PlatformLocation, viewportScrollerStub, location);\n+\n+      expect(scrollService.supportManualScrollRestoration).toBe(false);\n+    } finally {\n+      if (original !== undefined) {\n+        Object.defineProperty(window.history, 'scrollRestoration', original);\n+      } else {\n+        delete window.history.scrollRestoration;\n+      }\n+    }\n+  });\n+\n   it('should set `scrollRestoration` to `manual` if supported', () => {\n     if (scrollService.supportManualScrollRestoration) {\n       expect(window.history.scrollRestoration).toBe('manual');"
        },
        {
            "sha": "ab5f299b66e7c59e16ae0c1663ff698416182765",
            "filename": "aio/src/app/shared/scroll.service.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/bb88c9fa3daac80086efbda951d81c159e3840f4/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb88c9fa3daac80086efbda951d81c159e3840f4/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.ts?ref=bb88c9fa3daac80086efbda951d81c159e3840f4",
            "patch": "@@ -24,8 +24,7 @@ export class ScrollService implements OnDestroy {\n   poppedStateScrollPosition: ScrollPosition|null = null;\n   // Whether the browser supports the necessary features for manual scroll restoration.\n   supportManualScrollRestoration: boolean = !!window && ('scrollTo' in window) &&\n-      ('scrollX' in window) && ('scrollY' in window) && !!history &&\n-      ('scrollRestoration' in history);\n+      ('scrollX' in window) && ('scrollY' in window) && isScrollRestorationWritable();\n \n   // Offset from the top of the document to bottom of any static elements\n   // at the top (e.g. toolbar) + some margin\n@@ -243,3 +242,20 @@ export class ScrollService implements OnDestroy {\n     return decodeURIComponent(this.platformLocation.hash.replace(/^#/, ''));\n   }\n }\n+\n+/**\n+ * We need to check whether we can write to `history.scrollRestoration`\n+ *\n+ * We do this by checking the property descriptor of the property, but\n+ * it might actually be defined on the `history` prototype not the instance.\n+ *\n+ * In this context \"writable\" means either than the property is a `writable`\n+ * data file or a property that has a setter.\n+ */\n+function isScrollRestorationWritable() {\n+  const scrollRestorationDescriptor =\n+      Object.getOwnPropertyDescriptor(history, 'scrollRestoration') ||\n+      Object.getOwnPropertyDescriptor(Object.getPrototypeOf(history), 'scrollRestoration');\n+  return scrollRestorationDescriptor !== undefined &&\n+      !!(scrollRestorationDescriptor.writable || scrollRestorationDescriptor.set);\n+}"
        },
        {
            "sha": "8ebdb7da2442add26003c17cf1a9071b8482aabb",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/bb88c9fa3daac80086efbda951d81c159e3840f4/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/bb88c9fa3daac80086efbda951d81c159e3840f4/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=bb88c9fa3daac80086efbda951d81c159e3840f4",
            "patch": "@@ -21,9 +21,9 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3097,\n-        \"main-es2015\": 429885,\n+        \"main-es2015\": 430239,\n         \"polyfills-es2015\": 52195\n       }\n     }\n   }\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "cea5ca5d30d6035ed3354c445b4e9d82e6d760ec",
            "filename": "packages/common/src/viewport_scroller.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/bb88c9fa3daac80086efbda951d81c159e3840f4/packages%2Fcommon%2Fsrc%2Fviewport_scroller.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb88c9fa3daac80086efbda951d81c159e3840f4/packages%2Fcommon%2Fsrc%2Fviewport_scroller.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Fviewport_scroller.ts?ref=bb88c9fa3daac80086efbda951d81c159e3840f4",
            "patch": "@@ -165,13 +165,25 @@ export class BrowserViewportScroller implements ViewportScroller {\n    */\n   private supportScrollRestoration(): boolean {\n     try {\n-      return !!this.window && !!this.window.scrollTo;\n+      if (!this.window || !this.window.scrollTo) {\n+        return false;\n+      }\n+      // The `scrollRestoration` property could be on the `history` instance or its prototype.\n+      const scrollRestorationDescriptor = getScrollRestorationProperty(this.window.history) ||\n+          getScrollRestorationProperty(Object.getPrototypeOf(this.window.history));\n+      // We can write to the `scrollRestoration` property if it is a writable data field or it has a\n+      // setter function.\n+      return !!scrollRestorationDescriptor &&\n+          !!(scrollRestorationDescriptor.writable || scrollRestorationDescriptor.set);\n     } catch {\n       return false;\n     }\n   }\n }\n \n+function getScrollRestorationProperty(obj: any): PropertyDescriptor|undefined {\n+  return Object.getOwnPropertyDescriptor(obj, 'scrollRestoration');\n+}\n \n /**\n  * Provides an empty implementation of the viewport scroller. This will"
        },
        {
            "sha": "2ac9328fc1b95d02952c2ecf73a0543e5e717234",
            "filename": "packages/common/test/viewport_scroller_spec.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/bb88c9fa3daac80086efbda951d81c159e3840f4/packages%2Fcommon%2Ftest%2Fviewport_scroller_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb88c9fa3daac80086efbda951d81c159e3840f4/packages%2Fcommon%2Ftest%2Fviewport_scroller_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Ftest%2Fviewport_scroller_spec.ts?ref=bb88c9fa3daac80086efbda951d81c159e3840f4",
            "patch": "@@ -23,10 +23,25 @@ import {BrowserViewportScroller, ViewportScroller} from '../src/viewport_scrolle\n   describe('BrowserViewportScroller', () => {\n     let scroller: ViewportScroller;\n     let documentSpy: any;\n+    let windowSpy: any;\n+\n     beforeEach(() => {\n+      windowSpy = jasmine.createSpyObj('window', ['history']);\n+      windowSpy.scrollTo = 1;\n+      windowSpy.history.scrollRestoration = 'auto';\n+\n       documentSpy = jasmine.createSpyObj('document', ['querySelector']);\n-      scroller = new BrowserViewportScroller(documentSpy, {scrollTo: 1}, null!);\n+      scroller = new BrowserViewportScroller(documentSpy, windowSpy, null!);\n     });\n+\n+    it('should not crash when scrollRestoration is not writable', () => {\n+      Object.defineProperty(windowSpy.history, 'scrollRestoration', {\n+        value: 'auto',\n+        configurable: true,\n+      });\n+      expect(() => scroller.setHistoryScrollRestoration('manual')).not.toThrow();\n+    });\n+\n     it('escapes invalid characters selectors', () => {\n       const invalidSelectorChars = `\"' :.[],=`;\n       // Double escaped to make sure we match the actual value passed to `querySelector`"
        }
    ],
    "stats": {
        "total": 75,
        "additions": 69,
        "deletions": 6
    }
}