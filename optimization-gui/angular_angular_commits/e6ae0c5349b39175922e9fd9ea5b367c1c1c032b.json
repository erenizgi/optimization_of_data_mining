{
    "author": "mhevery",
    "message": "refactor(core): Remove circular dependency between `LContainer` and `ViewRef`. (#39621)\n\n`LContainer` stores `ViewRef`s this is not quite right as it creates\ncircular dependency between the two types. Also `LContainer` should not\nbe aware of `ViewRef` which iv ViewEngine specific construct.\n\nPR Close #39621",
    "sha": "e6ae0c5349b39175922e9fd9ea5b367c1c1c032b",
    "files": [
        {
            "sha": "b3e4d06665dcb28be6eb56387e150805a29a06de",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 536,
            "deletions": 2214,
            "changes": 2750,
            "blob_url": "https://github.com/angular/angular/blob/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=e6ae0c5349b39175922e9fd9ea5b367c1c1c032b"
        },
        {
            "sha": "cfc09e27956ab161cae21b45336f50f0f13766ae",
            "filename": "packages/core/src/linker/view_container_ref.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 15,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts?ref=e6ae0c5349b39175922e9fd9ea5b367c1c1c032b",
            "patch": "@@ -222,7 +222,8 @@ const R3ViewContainerRef = class ViewContainerRef extends VE_ViewContainerRef {\n   }\n \n   get(index: number): ViewRef|null {\n-    return this._lContainer[VIEW_REFS] !== null && this._lContainer[VIEW_REFS]![index] || null;\n+    const viewRefs = getViewRefs(this._lContainer);\n+    return viewRefs !== null && viewRefs[index] || null;\n   }\n \n   get length(): number {\n@@ -265,8 +266,6 @@ const R3ViewContainerRef = class ViewContainerRef extends VE_ViewContainerRef {\n       throw new Error('Cannot insert a destroyed View in a ViewContainer!');\n     }\n \n-    this.allocateContainerIfNeeded();\n-\n     if (viewAttachedToContainer(lView)) {\n       // If view is already attached, detach it first so we clean up references appropriately.\n \n@@ -309,7 +308,7 @@ const R3ViewContainerRef = class ViewContainerRef extends VE_ViewContainerRef {\n     }\n \n     (viewRef as R3ViewRef<any>).attachToViewContainerRef(this);\n-    addToArray(lContainer[VIEW_REFS]!, adjustedIdx, viewRef);\n+    addToArray(getOrCreateViewRefs(lContainer), adjustedIdx, viewRef);\n \n     return viewRef;\n   }\n@@ -322,12 +321,11 @@ const R3ViewContainerRef = class ViewContainerRef extends VE_ViewContainerRef {\n   }\n \n   indexOf(viewRef: ViewRef): number {\n-    const viewRefsArr = this._lContainer[VIEW_REFS];\n+    const viewRefsArr = getViewRefs(this._lContainer);\n     return viewRefsArr !== null ? viewRefsArr.indexOf(viewRef) : -1;\n   }\n \n   remove(index?: number): void {\n-    this.allocateContainerIfNeeded();\n     const adjustedIdx = this._adjustIndex(index, -1);\n     const detachedView = detachView(this._lContainer, adjustedIdx);\n \n@@ -338,17 +336,17 @@ const R3ViewContainerRef = class ViewContainerRef extends VE_ViewContainerRef {\n       // rely on an accurate container length.\n       // (e.g. a method on this view container being called by a child directive's OnDestroy\n       // lifecycle hook)\n-      removeFromArray(this._lContainer[VIEW_REFS]!, adjustedIdx);\n+      removeFromArray(getOrCreateViewRefs(this._lContainer), adjustedIdx);\n       destroyLView(detachedView[TVIEW], detachedView);\n     }\n   }\n \n   detach(index?: number): ViewRef|null {\n-    this.allocateContainerIfNeeded();\n     const adjustedIdx = this._adjustIndex(index, -1);\n     const view = detachView(this._lContainer, adjustedIdx);\n \n-    const wasDetached = view && removeFromArray(this._lContainer[VIEW_REFS]!, adjustedIdx) != null;\n+    const wasDetached =\n+        view && removeFromArray(getOrCreateViewRefs(this._lContainer), adjustedIdx) != null;\n     return wasDetached ? new R3ViewRef(view!) : null;\n   }\n \n@@ -363,14 +361,16 @@ const R3ViewContainerRef = class ViewContainerRef extends VE_ViewContainerRef {\n     }\n     return index;\n   }\n-\n-  private allocateContainerIfNeeded(): void {\n-    if (this._lContainer[VIEW_REFS] === null) {\n-      this._lContainer[VIEW_REFS] = [];\n-    }\n-  }\n };\n \n+function getViewRefs(lContainer: LContainer): ViewRef[]|null {\n+  return lContainer[VIEW_REFS];\n+}\n+\n+function getOrCreateViewRefs(lContainer: LContainer): ViewRef[] {\n+  return lContainer[VIEW_REFS] || (lContainer[VIEW_REFS] = []);\n+}\n+\n /**\n  * Creates a ViewContainerRef and stores it on the injector.\n  *"
        },
        {
            "sha": "5879f9b0c4aebdcffb786948b2cb3fd2f893fd59",
            "filename": "packages/core/src/render3/collect_native_nodes.ts",
            "status": "added",
            "additions": 85,
            "deletions": 0,
            "changes": 85,
            "blob_url": "https://github.com/angular/angular/blob/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Fsrc%2Frender3%2Fcollect_native_nodes.ts",
            "raw_url": "https://github.com/angular/angular/raw/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Fsrc%2Frender3%2Fcollect_native_nodes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fcollect_native_nodes.ts?ref=e6ae0c5349b39175922e9fd9ea5b367c1c1c032b",
            "patch": "@@ -0,0 +1,85 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {assertDefined} from '../util/assert';\n+\n+import {icuContainerIterate} from './i18n/i18n_tree_shaking';\n+import {CONTAINER_HEADER_OFFSET} from './interfaces/container';\n+import {TElementNode, TIcuContainerNode, TNode, TNodeType} from './interfaces/node';\n+import {RNode} from './interfaces/renderer';\n+import {isLContainer} from './interfaces/type_checks';\n+import {DECLARATION_COMPONENT_VIEW, LView, T_HOST, TVIEW, TView} from './interfaces/view';\n+import {assertTNodeType} from './node_assert';\n+import {getLViewParent} from './util/view_traversal_utils';\n+import {unwrapRNode} from './util/view_utils';\n+\n+\n+\n+export function collectNativeNodes(\n+    tView: TView, lView: LView, tNode: TNode|null, result: any[],\n+    isProjection: boolean = false): any[] {\n+  while (tNode !== null) {\n+    ngDevMode &&\n+        assertTNodeType(\n+            tNode,\n+            TNodeType.AnyRNode | TNodeType.AnyContainer | TNodeType.Projection | TNodeType.Icu);\n+\n+    const lNode = lView[tNode.index];\n+    if (lNode !== null) {\n+      result.push(unwrapRNode(lNode));\n+    }\n+\n+    // A given lNode can represent either a native node or a LContainer (when it is a host of a\n+    // ViewContainerRef). When we find a LContainer we need to descend into it to collect root nodes\n+    // from the views in this container.\n+    if (isLContainer(lNode)) {\n+      for (let i = CONTAINER_HEADER_OFFSET; i < lNode.length; i++) {\n+        const lViewInAContainer = lNode[i];\n+        const lViewFirstChildTNode = lViewInAContainer[TVIEW].firstChild;\n+        if (lViewFirstChildTNode !== null) {\n+          collectNativeNodes(\n+              lViewInAContainer[TVIEW], lViewInAContainer, lViewFirstChildTNode, result);\n+        }\n+      }\n+    }\n+\n+    const tNodeType = tNode.type;\n+    if (tNodeType & TNodeType.ElementContainer) {\n+      collectNativeNodes(tView, lView, tNode.child, result);\n+    } else if (tNodeType & TNodeType.Icu) {\n+      const nextRNode = icuContainerIterate(tNode as TIcuContainerNode, lView);\n+      let rNode: RNode|null;\n+      while (rNode = nextRNode()) {\n+        result.push(rNode);\n+      }\n+    } else if (tNodeType & TNodeType.Projection) {\n+      const componentView = lView[DECLARATION_COMPONENT_VIEW];\n+      const componentHost = componentView[T_HOST] as TElementNode;\n+      const slotIdx = tNode.projection as number;\n+      ngDevMode &&\n+          assertDefined(\n+              componentHost.projection,\n+              'Components with projection nodes (<ng-content>) must have projection slots defined.');\n+\n+      const nodesInSlot = componentHost.projection![slotIdx];\n+      if (Array.isArray(nodesInSlot)) {\n+        result.push(...nodesInSlot);\n+      } else {\n+        const parentView = getLViewParent(componentView)!;\n+        ngDevMode &&\n+            assertDefined(\n+                parentView,\n+                'Component views should always have a parent view (component\\'s host view)');\n+        collectNativeNodes(parentView[TVIEW], parentView, nodesInSlot, result, true);\n+      }\n+    }\n+    tNode = isProjection ? tNode.projectionNext : tNode.next;\n+  }\n+\n+  return result;\n+}"
        },
        {
            "sha": "cffd2223cbf32b2e736683c77540805ac0dd1d33",
            "filename": "packages/core/src/render3/interfaces/container.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fcontainer.ts",
            "raw_url": "https://github.com/angular/angular/raw/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fcontainer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fcontainer.ts?ref=e6ae0c5349b39175922e9fd9ea5b367c1c1c032b",
            "patch": "@@ -6,8 +6,6 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ViewRef} from '../../linker/view_ref';\n-\n import {TNode} from './node';\n import {RComment, RElement} from './renderer';\n import {HOST, LView, NEXT, PARENT, T_HOST, TRANSPLANTED_VIEWS_TO_REFRESH} from './view';\n@@ -127,8 +125,11 @@ export interface LContainer extends Array<any> {\n    * Array of `ViewRef`s used by any `ViewContainerRef`s that point to this container.\n    *\n    * This is lazily initialized by `ViewContainerRef` when the first view is inserted.\n+   *\n+   * NOTE: This is stored as `any[]` because render3 should really not be aware of `ViewRef` and\n+   * doing so creates circular dependency.\n    */\n-  [VIEW_REFS]: ViewRef[]|null;\n+  [VIEW_REFS]: any[]|null;\n }\n \n // Note: This hack is necessary so we don't erroneously get a circular dependency"
        },
        {
            "sha": "b6ea085f6c5167e243cacc03048565194eacd795",
            "filename": "packages/core/src/render3/view_ref.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 75,
            "changes": 77,
            "blob_url": "https://github.com/angular/angular/blob/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts?ref=e6ae0c5349b39175922e9fd9ea5b367c1c1c032b",
            "patch": "@@ -10,19 +10,10 @@ import {ApplicationRef} from '../application_ref';\n import {ChangeDetectorRef as viewEngine_ChangeDetectorRef} from '../change_detection/change_detector_ref';\n import {ViewContainerRef as viewEngine_ViewContainerRef} from '../linker/view_container_ref';\n import {EmbeddedViewRef as viewEngine_EmbeddedViewRef, InternalViewRef as viewEngine_InternalViewRef} from '../linker/view_ref';\n-import {assertDefined} from '../util/assert';\n-import {icuContainerIterate} from './i18n/i18n_tree_shaking';\n-\n+import {collectNativeNodes} from './collect_native_nodes';\n import {checkNoChangesInRootView, checkNoChangesInternal, detectChangesInRootView, detectChangesInternal, markViewDirty, storeCleanupWithContext} from './instructions/shared';\n-import {CONTAINER_HEADER_OFFSET} from './interfaces/container';\n-import {TElementNode, TIcuContainerNode, TNode, TNodeType} from './interfaces/node';\n-import {RNode} from './interfaces/renderer';\n-import {isLContainer} from './interfaces/type_checks';\n-import {CONTEXT, DECLARATION_COMPONENT_VIEW, FLAGS, LView, LViewFlags, T_HOST, TVIEW, TView} from './interfaces/view';\n-import {assertTNodeType} from './node_assert';\n+import {CONTEXT, FLAGS, LView, LViewFlags, TVIEW} from './interfaces/view';\n import {destroyLView, renderDetachView} from './node_manipulation';\n-import {getLViewParent} from './util/view_traversal_utils';\n-import {unwrapRNode} from './util/view_utils';\n \n \n \n@@ -319,67 +310,3 @@ export class RootViewRef<T> extends ViewRef<T> {\n     return null!;\n   }\n }\n-\n-function collectNativeNodes(\n-    tView: TView, lView: LView, tNode: TNode|null, result: any[],\n-    isProjection: boolean = false): any[] {\n-  while (tNode !== null) {\n-    ngDevMode &&\n-        assertTNodeType(\n-            tNode,\n-            TNodeType.AnyRNode | TNodeType.AnyContainer | TNodeType.Projection | TNodeType.Icu);\n-\n-    const lNode = lView[tNode.index];\n-    if (lNode !== null) {\n-      result.push(unwrapRNode(lNode));\n-    }\n-\n-    // A given lNode can represent either a native node or a LContainer (when it is a host of a\n-    // ViewContainerRef). When we find a LContainer we need to descend into it to collect root nodes\n-    // from the views in this container.\n-    if (isLContainer(lNode)) {\n-      for (let i = CONTAINER_HEADER_OFFSET; i < lNode.length; i++) {\n-        const lViewInAContainer = lNode[i];\n-        const lViewFirstChildTNode = lViewInAContainer[TVIEW].firstChild;\n-        if (lViewFirstChildTNode !== null) {\n-          collectNativeNodes(\n-              lViewInAContainer[TVIEW], lViewInAContainer, lViewFirstChildTNode, result);\n-        }\n-      }\n-    }\n-\n-    const tNodeType = tNode.type;\n-    if (tNodeType & TNodeType.ElementContainer) {\n-      collectNativeNodes(tView, lView, tNode.child, result);\n-    } else if (tNodeType & TNodeType.Icu) {\n-      const nextRNode = icuContainerIterate(tNode as TIcuContainerNode, lView);\n-      let rNode: RNode|null;\n-      while (rNode = nextRNode()) {\n-        result.push(rNode);\n-      }\n-    } else if (tNodeType & TNodeType.Projection) {\n-      const componentView = lView[DECLARATION_COMPONENT_VIEW];\n-      const componentHost = componentView[T_HOST] as TElementNode;\n-      const slotIdx = tNode.projection as number;\n-      ngDevMode &&\n-          assertDefined(\n-              componentHost.projection,\n-              'Components with projection nodes (<ng-content>) must have projection slots defined.');\n-\n-      const nodesInSlot = componentHost.projection![slotIdx];\n-      if (Array.isArray(nodesInSlot)) {\n-        result.push(...nodesInSlot);\n-      } else {\n-        const parentView = getLViewParent(componentView)!;\n-        ngDevMode &&\n-            assertDefined(\n-                parentView,\n-                'Component views should always have a parent view (component\\'s host view)');\n-        collectNativeNodes(parentView[TVIEW], parentView, nodesInSlot, result, true);\n-      }\n-    }\n-    tNode = isProjection ? tNode.projectionNext : tNode.next;\n-  }\n-\n-  return result;\n-}"
        },
        {
            "sha": "343372b33517091f1db12e1738e8af73ea9e36fb",
            "filename": "packages/core/test/bundling/forms/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json?ref=e6ae0c5349b39175922e9fd9ea5b367c1c1c032b",
            "patch": "@@ -1055,6 +1055,9 @@\n   {\n     \"name\": \"getOrCreateTNode\"\n   },\n+  {\n+    \"name\": \"getOrCreateViewRefs\"\n+  },\n   {\n     \"name\": \"getOriginalError\"\n   },\n@@ -1106,6 +1109,9 @@\n   {\n     \"name\": \"getTView\"\n   },\n+  {\n+    \"name\": \"getViewRefs\"\n+  },\n   {\n     \"name\": \"handleError\"\n   },"
        },
        {
            "sha": "80875c9f4d908686fd40360099629cc7ba0b3d59",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=e6ae0c5349b39175922e9fd9ea5b367c1c1c032b",
            "patch": "@@ -1370,6 +1370,9 @@\n   {\n     \"name\": \"getOrCreateTNode\"\n   },\n+  {\n+    \"name\": \"getOrCreateViewRefs\"\n+  },\n   {\n     \"name\": \"getOriginalError\"\n   },\n@@ -1439,6 +1442,9 @@\n   {\n     \"name\": \"getToken\"\n   },\n+  {\n+    \"name\": \"getViewRefs\"\n+  },\n   {\n     \"name\": \"handleError\"\n   },"
        },
        {
            "sha": "32acaa552f89a76c7b5af7a8f4e51746ea298021",
            "filename": "packages/core/test/bundling/todo/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/e6ae0c5349b39175922e9fd9ea5b367c1c1c032b/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json?ref=e6ae0c5349b39175922e9fd9ea5b367c1c1c032b",
            "patch": "@@ -410,6 +410,9 @@\n   {\n     \"name\": \"getOrCreateTNode\"\n   },\n+  {\n+    \"name\": \"getOrCreateViewRefs\"\n+  },\n   {\n     \"name\": \"getOriginalError\"\n   },\n@@ -446,6 +449,9 @@\n   {\n     \"name\": \"getTView\"\n   },\n+  {\n+    \"name\": \"getViewRefs\"\n+  },\n   {\n     \"name\": \"handleError\"\n   },"
        }
    ],
    "stats": {
        "total": 2967,
        "additions": 660,
        "deletions": 2307
    }
}