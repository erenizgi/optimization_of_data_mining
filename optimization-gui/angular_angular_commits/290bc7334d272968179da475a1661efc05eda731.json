{
    "author": "petebacondarwin",
    "message": "test(localize): add compile time extraction to integration test (#32912)\n\nThe integration test for i18n now makes use of the new extraction tooling\nfrom the `@angular/localize` package rather than the old ViewEngine extractor.\n\nPR Close #32912",
    "sha": "290bc7334d272968179da475a1661efc05eda731",
    "files": [
        {
            "sha": "545dfe2aec1496b6d46db48a6be0f870e4bf1383",
            "filename": "integration/ivy-i18n/angular.json",
            "status": "modified",
            "additions": 9,
            "deletions": 8,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/290bc7334d272968179da475a1661efc05eda731/integration%2Fivy-i18n%2Fangular.json",
            "raw_url": "https://github.com/angular/angular/raw/290bc7334d272968179da475a1661efc05eda731/integration%2Fivy-i18n%2Fangular.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fivy-i18n%2Fangular.json?ref=290bc7334d272968179da475a1661efc05eda731",
            "patch": "@@ -13,6 +13,8 @@\n         \"build\": {\n           \"builder\": \"@angular-devkit/build-angular:browser\",\n           \"options\": {\n+            \"localize\": false, // To prevent the CLI from doing inlining itself\n+            \"aot\": true,\n             \"outputPath\": \"dist\",\n             \"index\": \"src/index.html\",\n             \"main\": \"src/main.ts\",\n@@ -33,7 +35,6 @@\n               \"tsConfig\": \"tsconfig.view-engine.json\"\n             },\n             \"production\": {\n-              \"localize\": false, // TODO: enable when CLI supports inlining the locale\n               \"fileReplacements\": [\n                 {\n                   \"replace\": \"src/environments/environment.ts\",\n@@ -42,10 +43,9 @@\n               ],\n               \"optimization\": true,\n               \"outputHashing\": \"all\",\n-              \"sourceMap\": false,\n+              \"sourceMap\": true,\n               \"extractCss\": true,\n               \"namedChunks\": false,\n-              \"aot\": true,\n               \"extractLicenses\": true,\n               \"vendorChunk\": false,\n               \"buildOptimizer\": true,\n@@ -72,9 +72,9 @@\n             },\n             \"translated-legacy\": {\n               \"tsConfig\": \"tsconfig.legacy.json\",\n-              \"optimization\": true,\n+              \"optimization\": false,\n               \"outputHashing\": \"all\",\n-              \"sourceMap\": false,\n+              \"sourceMap\": true,\n               \"extractCss\": true,\n               \"namedChunks\": false,\n               \"aot\": true,\n@@ -84,9 +84,9 @@\n             },\n             \"translated-legacy-xmb\": {\n               \"tsConfig\": \"tsconfig.legacy-xmb.json\",\n-              \"optimization\": true,\n+              \"optimization\": false,\n               \"outputHashing\": \"all\",\n-              \"sourceMap\": false,\n+              \"sourceMap\": true,\n               \"extractCss\": true,\n               \"namedChunks\": false,\n               \"aot\": true,\n@@ -198,6 +198,7 @@\n           }\n         }\n       }\n-    }},\n+    }\n+  },\n   \"defaultProject\": \"cli-hello-world-ivy-i18n\"\n }"
        },
        {
            "sha": "71c2f9e6bf6604d97c3a9cef22b297b176c4a9f6",
            "filename": "integration/ivy-i18n/package.json",
            "status": "modified",
            "additions": 32,
            "deletions": 31,
            "changes": 63,
            "blob_url": "https://github.com/angular/angular/blob/290bc7334d272968179da475a1661efc05eda731/integration%2Fivy-i18n%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/290bc7334d272968179da475a1661efc05eda731/integration%2Fivy-i18n%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fivy-i18n%2Fpackage.json?ref=290bc7334d272968179da475a1661efc05eda731",
            "patch": "@@ -9,9 +9,9 @@\n     \"ng\": \"ng\",\n     \"postinstall\": \"ngcc --properties es2015 browser module main --first-only --create-ivy-entry-points\",\n     \"start\": \"ng serve\",\n-    \"pretest\": \"ng version\",\n+    \"pretest\": \"ng version && rm -fr ../tmp\",\n     \"test\": \"ng test && yarn e2e --configuration=ci && yarn e2e --configuration=ci-production && yarn translated:test && yarn translated:legacy-xlf:test && yarn translated:legacy-xmb:test\",\n-    \"translate\": \"localize-translate -r \\\"dist/\\\" -s \\\"**/*\\\" -l \\\"en-US\\\" -t \\\"[src/locales/messages.de.json, src/locales/extra.de.json]\\\" [src/locales/messages.fr.json,src/locales/extra.fr.json] -o \\\"../tmp/translations/{{LOCALE}}\\\"\",\n+    \"translate\": \"localize-translate --root \\\"dist/\\\" --source \\\"**/*\\\" --source-locale \\\"en-US\\\" --translations \\\"[src/locales/messages.de.json, src/locales/extra.de.json]\\\" [src/locales/messages.fr.json,src/locales/extra.fr.json] --outputPath \\\"../tmp/translations/{{LOCALE}}\\\"\",\n     \"runtime:test\": \"yarn e2e --configuration=runtime-translations\",\n     \"translated:test\": \"yarn build && yarn translate && yarn translated:fr:e2e && yarn translated:de:e2e && yarn translated:en:e2e\",\n     \"translated:fr:serve\": \"serve ../tmp/translations/fr --listen 4200\",\n@@ -22,36 +22,37 @@\n     \"translated:en:e2e\": \"npm-run-all -p -r translated:en:serve \\\"ng e2e --configuration=translated-en\\\"\",\n     \"translated:legacy:serve\": \"serve ../tmp/translations/legacy --listen 4200\",\n     \"translated:legacy:e2e\": \"npm-run-all -p -r translated:legacy:serve \\\"ng e2e --configuration=translated-legacy\\\"\",\n-    \"translated:legacy:translate\": \"localize-translate -r \\\"dist/\\\" -s \\\"**/*\\\" -o \\\"../tmp/translations/{{LOCALE}}\\\"\",\n-    \"translated:legacy-xlf:test\": \"yarn ng xi18n && yarn translated:legacy-xlf:update-translations && yarn ng build --configuration=translated-legacy && yarn translated:legacy:translate -t \\\"../tmp/legacy-locales/messages.legacy.xlf\\\" && yarn translated:legacy:e2e\",\n-    \"translated:legacy-xlf:update-translations\": \"sed -i.bak -e 's/source>/target>'/ -e 's/Hello/Bonjour/' -e 's/source-language=\\\"en-US\\\"/source-language=\\\"en-US\\\" target-language=\\\"legacy\\\"/' ../tmp/legacy-locales/messages.legacy.xlf\",\n-    \"translated:legacy-xmb:test\": \"yarn ng xi18n --format=xmb --outFile=messages.legacy.xmb && yarn translated:legacy-xmb:update-translations && yarn ng build --configuration=translated-legacy-xmb && yarn translated:legacy:translate -t \\\"../tmp/legacy-locales/messages.legacy.xtb\\\" && yarn translated:legacy:e2e\",\n-    \"translated:legacy-xmb:update-translations\": \"sed -e 's/messagebundle/translationbundle/' -e 's/<translationbundle>/<translationbundle lang=\\\"legacy\\\">/' -e 's/msg/translation/' -e 's/Hello/Bonjour/' -e 's/<source>.*<\\\\/source>//' ../tmp/legacy-locales/messages.legacy.xmb > ../tmp/legacy-locales/messages.legacy.xtb\"\n+    \"translated:legacy:translate\": \"localize-translate --root \\\"dist/\\\" --source \\\"**/*\\\" --outputPath \\\"../tmp/translations/{{LOCALE}}\\\"\",\n+    \"translated:legacy-xlf:test\": \"yarn ng build && yarn extract --format xliff --outputPath ../tmp/legacy-locales/messages.legacy.xlf && yarn translated:legacy-xlf:update-translations && yarn ng build --configuration=translated-legacy && yarn translated:legacy:translate -t \\\"../tmp/legacy-locales/messages.legacy.xlf\\\" && yarn translated:legacy:e2e\",\n+    \"translated:legacy-xlf:update-translations\": \"node scripts/update-xlf-translation-file.js \\\"../tmp/legacy-locales/messages.legacy.xlf\\\"\",\n+    \"translated:legacy-xmb:test\": \"yarn ng build && yarn extract --format xmb --outputPath ../tmp/legacy-locales/messages.legacy.xmb && yarn translated:legacy-xmb:update-translations && yarn ng build --configuration=translated-legacy-xmb && yarn translated:legacy:translate -t \\\"../tmp/legacy-locales/messages.legacy.xtb\\\" && yarn translated:legacy:e2e\",\n+    \"translated:legacy-xmb:update-translations\": \"node scripts/update-xmb-translation-file.js \\\"../tmp/legacy-locales/messages.legacy.xmb\\\"\",\n+    \"extract\": \"localize-extract --source dist/main-es2015*.js\"\n   },\n   \"private\": true,\n   \"dependencies\": {\n-    \"@angular/animations\": \"file:../../dist/packages-dist/animations\",\n-    \"@angular/common\": \"file:../../dist/packages-dist/common\",\n-    \"@angular/compiler\": \"file:../../dist/packages-dist/compiler\",\n-    \"@angular/core\": \"file:../../dist/packages-dist/core\",\n-    \"@angular/forms\": \"file:../../dist/packages-dist/forms\",\n-    \"@angular/localize\": \"file:../../dist/packages-dist/localize\",\n-    \"@angular/platform-browser\": \"file:../../dist/packages-dist/platform-browser\",\n-    \"@angular/platform-browser-dynamic\": \"file:../../dist/packages-dist/platform-browser-dynamic\",\n-    \"@angular/router\": \"file:../../dist/packages-dist/router\",\n-    \"core-js\": \"file:../../node_modules/core-js\",\n-    \"rxjs\": \"file:../../node_modules/rxjs\",\n-    \"tslib\": \"file:../../node_modules/tslib\",\n-    \"zone.js\": \"file:../../dist/zone.js-dist/zone.js\"\n+    \"@angular/animations\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/animations/npm_package_archive.tar.gz\",\n+    \"@angular/common\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/common/npm_package_archive.tar.gz\",\n+    \"@angular/compiler\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/compiler/npm_package_archive.tar.gz\",\n+    \"@angular/core\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/core/npm_package_archive.tar.gz\",\n+    \"@angular/forms\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/forms/npm_package_archive.tar.gz\",\n+    \"@angular/localize\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/localize/npm_package_archive.tar.gz\",\n+    \"@angular/platform-browser\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/platform-browser/npm_package_archive.tar.gz\",\n+    \"@angular/platform-browser-dynamic\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/platform-browser-dynamic/npm_package_archive.tar.gz\",\n+    \"@angular/router\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/router/npm_package_archive.tar.gz\",\n+    \"core-js\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/core-js_archive.tar.gz\",\n+    \"rxjs\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/rxjs_archive.tar.gz\",\n+    \"tslib\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/tslib_archive.tar.gz\",\n+    \"zone.js\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/zone.js/npm_package_archive.tar.gz\"\n   },\n   \"devDependencies\": {\n-    \"@angular-devkit/build-angular\": \"file:../../node_modules/@angular-devkit/build-angular\",\n-    \"@angular/cli\": \"file:../../node_modules/@angular/cli\",\n-    \"@angular/compiler-cli\": \"file:../../dist/packages-dist/compiler-cli\",\n-    \"@angular/language-service\": \"file:../../dist/packages-dist/language-service\",\n-    \"@types/jasmine\": \"file:../../node_modules/@types/jasmine\",\n-    \"@types/jasminewd2\": \"file:../../node_modules/@types/jasminewd2\",\n-    \"@types/node\": \"file:../../node_modules/@types/node\",\n+    \"@angular-devkit/build-angular\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/angular-devkit_build-angular_archive.tar.gz\",\n+    \"@angular/cli\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/angular_cli_archive.tar.gz\",\n+    \"@angular/compiler-cli\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/compiler-cli/npm_package_archive.tar.gz\",\n+    \"@angular/language-service\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/angular/packages/language-service/npm_package_archive.tar.gz\",\n+    \"@types/jasmine\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/types_jasmine_archive.tar.gz\",\n+    \"@types/jasminewd2\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/types_jasminewd2_archive.tar.gz\",\n+    \"@types/node\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/types_node_archive.tar.gz\",\n     \"codelyzer\": \"5.2.0\",\n     \"jasmine-core\": \"3.5.0\",\n     \"jasmine-spec-reporter\": \"4.2.1\",\n@@ -61,15 +62,15 @@\n     \"karma-jasmine\": \"2.0.1\",\n     \"karma-jasmine-html-reporter\": \"1.4.2\",\n     \"npm-run-all\": \"4.1.5\",\n-    \"protractor\": \"file:../../node_modules/protractor\",\n-    \"puppeteer\": \"file:../../node_modules/puppeteer\",\n+    \"protractor\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/protractor_archive.tar.gz\",\n+    \"puppeteer\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/puppeteer_archive.tar.gz\",\n     \"serve\": \"11.2.0\",\n     \"ts-node\": \"8.3.0\",\n     \"tslint\": \"5.18.0\",\n-    \"typescript\": \"file:../../node_modules/typescript\"\n+    \"typescript\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/typescript_archive.tar.gz\"\n   },\n   \"//resolutions-comment\": \"Ensure a single version of webdriver-manager which comes from root node_modules that has already run webdriver-manager update\",\n   \"resolutions\": {\n-    \"**/webdriver-manager\": \"file:../../node_modules/webdriver-manager\"\n+    \"**/webdriver-manager\": \"file:/private/var/tmp/_bazel_pete/f9acfb7f019473a10a34c8c30adc55ea/execroot/angular/bazel-out/darwin-fastbuild/bin/integration/ivy-i18n_test.debug.sh.runfiles/npm/webdriver-manager_archive.tar.gz\"\n   }\n }\n\\ No newline at end of file"
        },
        {
            "sha": "79a0001a3b4bb062a8449923fede5f7783b3710c",
            "filename": "integration/ivy-i18n/scripts/update-xlf-translation-file.js",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/290bc7334d272968179da475a1661efc05eda731/integration%2Fivy-i18n%2Fscripts%2Fupdate-xlf-translation-file.js",
            "raw_url": "https://github.com/angular/angular/raw/290bc7334d272968179da475a1661efc05eda731/integration%2Fivy-i18n%2Fscripts%2Fupdate-xlf-translation-file.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fivy-i18n%2Fscripts%2Fupdate-xlf-translation-file.js?ref=290bc7334d272968179da475a1661efc05eda731",
            "patch": "@@ -0,0 +1,20 @@\n+/**\n+ * This file simulates translating a generated translation file into a new locale.\n+ * In particular it takes an English locale XLIFF 1.2 format and translates to the French locale.\n+ */\n+const fs = require('fs');\n+const path = require('path');\n+\n+// Load the file\n+const filePath = path.resolve(__dirname, '..', process.argv.pop());\n+const contents = fs.readFileSync(filePath, 'utf8');\n+\n+// Backup the file\n+fs.writeFileSync(filePath + '.bak', contents, 'utf8');\n+\n+// Write translated file\n+const updated =\n+    contents.replace(/source>/g, 'target>')\n+        .replace(/Hello/g, 'Bonjour')\n+        .replace(/source-language=\"([^\"]+)\"/g, 'source-language=\"$1\" target-language=\"legacy\"');\n+fs.writeFileSync(filePath, updated, 'utf8');"
        },
        {
            "sha": "98f5da8be7ce202ef85466a690593a4214a3bda8",
            "filename": "integration/ivy-i18n/scripts/update-xmb-translation-file.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/290bc7334d272968179da475a1661efc05eda731/integration%2Fivy-i18n%2Fscripts%2Fupdate-xmb-translation-file.js",
            "raw_url": "https://github.com/angular/angular/raw/290bc7334d272968179da475a1661efc05eda731/integration%2Fivy-i18n%2Fscripts%2Fupdate-xmb-translation-file.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fivy-i18n%2Fscripts%2Fupdate-xmb-translation-file.js?ref=290bc7334d272968179da475a1661efc05eda731",
            "patch": "@@ -0,0 +1,19 @@\n+/**\n+ * This file simulates translating a generated translation file into a new locale.\n+ * In particular it takes an English locale XMB format and translates to a French locale XTB format.\n+ */\n+const fs = require('fs');\n+const path = require('path');\n+\n+// Load the file\n+const filePath = path.resolve(__dirname, '..', process.argv.pop());\n+const contents = fs.readFileSync(filePath, 'utf8');\n+\n+// Write translated file\n+const updatedFilePath = filePath.replace(/\\.xmb$/, '.xtb');\n+const updatedContents = contents.replace(/messagebundle/g, 'translationbundle>')\n+                            .replace(/<translationbundle>/g, '<translationbundle lang=\"legacy\">')\n+                            .replace(/\\bmsg\\b/g, 'translation')\n+                            .replace(/Hello/g, 'Bonjour')\n+                            .replace(/<source>.*<\\/source>/g, '');\n+fs.writeFileSync(updatedFilePath, updatedContents, 'utf8');"
        },
        {
            "sha": "f15743a5e4e9db5bc6b12473b0f049b32bdd4ba9",
            "filename": "integration/ivy-i18n/yarn.lock",
            "status": "modified",
            "additions": 2476,
            "deletions": 1552,
            "changes": 4028,
            "blob_url": "https://github.com/angular/angular/blob/290bc7334d272968179da475a1661efc05eda731/integration%2Fivy-i18n%2Fyarn.lock",
            "raw_url": "https://github.com/angular/angular/raw/290bc7334d272968179da475a1661efc05eda731/integration%2Fivy-i18n%2Fyarn.lock",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fivy-i18n%2Fyarn.lock?ref=290bc7334d272968179da475a1661efc05eda731"
        }
    ],
    "stats": {
        "total": 4147,
        "additions": 2556,
        "deletions": 1591
    }
}