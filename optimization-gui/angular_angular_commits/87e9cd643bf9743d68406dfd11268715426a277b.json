{
    "author": "JoostK",
    "message": "feat(compiler-cli): implement partial directive declaration linking (#39518)\n\nThis commit implements the logic to compile a partial declaration of a\ndirective into its full AOT compilation output.\n\nPR Close #39518",
    "sha": "87e9cd643bf9743d68406dfd11268715426a277b",
    "files": [
        {
            "sha": "936ef1ac59c87d4220664c1ddd63bf742983e67b",
            "filename": "packages/compiler-cli/linker/src/file_linker/file_linker.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/87e9cd643bf9743d68406dfd11268715426a277b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Ffile_linker.ts",
            "raw_url": "https://github.com/angular/angular/raw/87e9cd643bf9743d68406dfd11268715426a277b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Ffile_linker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Ffile_linker.ts?ref=87e9cd643bf9743d68406dfd11268715426a277b",
            "patch": "@@ -18,7 +18,7 @@ export const NO_STATEMENTS: Readonly<any[]> = [] as const;\n  * This class is responsible for linking all the partial declarations found in a single file.\n  */\n export class FileLinker<TConstantScope, TStatement, TExpression> {\n-  private linkerSelector = new PartialLinkerSelector<TStatement, TExpression>();\n+  private linkerSelector = new PartialLinkerSelector<TExpression>();\n   private emitScopes = new Map<TConstantScope, EmitScope<TStatement, TExpression>>();\n \n   constructor("
        },
        {
            "sha": "b32dda466d9a83369bb42913f5c9729d14adab56",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_component_linker_1.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/87e9cd643bf9743d68406dfd11268715426a277b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/87e9cd643bf9743d68406dfd11268715426a277b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts?ref=87e9cd643bf9743d68406dfd11268715426a277b",
            "patch": "@@ -15,8 +15,7 @@ import {PartialLinker} from './partial_linker';\n /**\n  * A `PartialLinker` that is designed to process `$ngDeclareComponent()` call expressions.\n  */\n-export class PartialComponentLinkerVersion1<TStatement, TExpression> implements\n-    PartialLinker<TStatement, TExpression> {\n+export class PartialComponentLinkerVersion1<TExpression> implements PartialLinker<TExpression> {\n   linkPartialDeclaration(\n       sourceUrl: string, code: string, constantPool: ConstantPool,\n       metaObj: AstObject<TExpression>): o.Expression {"
        },
        {
            "sha": "bcd80f86cf7b19fe8a4ac60bad765e8c5a42e570",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_directive_linker_1.ts",
            "status": "modified",
            "additions": 137,
            "deletions": 5,
            "changes": 142,
            "blob_url": "https://github.com/angular/angular/blob/87e9cd643bf9743d68406dfd11268715426a277b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_directive_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/87e9cd643bf9743d68406dfd11268715426a277b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_directive_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_directive_linker_1.ts?ref=87e9cd643bf9743d68406dfd11268715426a277b",
            "patch": "@@ -5,21 +5,153 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {ConstantPool} from '@angular/compiler';\n+import {compileDirectiveFromMetadata, ConstantPool, makeBindingParser, ParseLocation, ParseSourceFile, ParseSourceSpan, R3DirectiveMetadata, R3HostMetadata, R3QueryMetadata, R3Reference} from '@angular/compiler';\n import * as o from '@angular/compiler/src/output/output_ast';\n \n-import {AstObject} from '../../ast/ast_value';\n+import {Range} from '../../ast/ast_host';\n+import {AstObject, AstValue} from '../../ast/ast_value';\n+import {FatalLinkerError} from '../../fatal_linker_error';\n \n import {PartialLinker} from './partial_linker';\n \n /**\n  * A `PartialLinker` that is designed to process `$ngDeclareDirective()` call expressions.\n  */\n-export class PartialDirectiveLinkerVersion1<TStatement, TExpression> implements\n-    PartialLinker<TStatement, TExpression> {\n+export class PartialDirectiveLinkerVersion1<TExpression> implements PartialLinker<TExpression> {\n   linkPartialDeclaration(\n       sourceUrl: string, code: string, constantPool: ConstantPool,\n       metaObj: AstObject<TExpression>): o.Expression {\n-    throw new Error('Not implemented.');\n+    const meta = toR3DirectiveMeta(metaObj, code, sourceUrl);\n+    const def = compileDirectiveFromMetadata(meta, constantPool, makeBindingParser());\n+    return def.expression;\n   }\n }\n+\n+/**\n+ * Derives the `R3DirectiveMetadata` structure from the AST object.\n+ */\n+export function toR3DirectiveMeta<TExpression>(\n+    metaObj: AstObject<TExpression>, code: string, sourceUrl: string): R3DirectiveMetadata {\n+  const typeExpr = metaObj.getValue('type');\n+  const typeName = typeExpr.getSymbolName();\n+  if (typeName === null) {\n+    throw new FatalLinkerError(\n+        typeExpr.expression, 'Unsupported type, its name could not be determined');\n+  }\n+\n+  return {\n+    typeSourceSpan: createSourceSpan(typeExpr.getRange(), code, sourceUrl),\n+    type: wrapReference(typeExpr.getOpaque()),\n+    typeArgumentCount: 0,\n+    internalType: metaObj.getOpaque('type'),\n+    deps: null,\n+    host: toHostMetadata(metaObj),\n+    inputs: metaObj.has('inputs') ? metaObj.getObject('inputs').toLiteral(toInputMapping) : {},\n+    outputs: metaObj.has('outputs') ?\n+        metaObj.getObject('outputs').toLiteral(value => value.getString()) :\n+        {},\n+    queries: metaObj.has('queries') ?\n+        metaObj.getArray('queries').map(entry => toQueryMetadata(entry.getObject())) :\n+        [],\n+    viewQueries: metaObj.has('viewQueries') ?\n+        metaObj.getArray('viewQueries').map(entry => toQueryMetadata(entry.getObject())) :\n+        [],\n+    providers: metaObj.has('providers') ? metaObj.getOpaque('providers') : null,\n+    fullInheritance: false,\n+    selector: metaObj.has('selector') ? metaObj.getString('selector') : null,\n+    exportAs: metaObj.has('exportAs') ?\n+        metaObj.getArray('exportAs').map(entry => entry.getString()) :\n+        null,\n+    lifecycle: {\n+      usesOnChanges: metaObj.has('usesOnChanges') ? metaObj.getBoolean('usesOnChanges') : false,\n+    },\n+    name: typeName,\n+    usesInheritance: metaObj.has('usesInheritance') ? metaObj.getBoolean('usesInheritance') : false,\n+  };\n+}\n+\n+/**\n+ * Decodes the AST value for a single input to its representation as used in the metadata.\n+ */\n+function toInputMapping<TExpression>(value: AstValue<TExpression>): string|[string, string] {\n+  if (value.isString()) {\n+    return value.getString();\n+  }\n+\n+  const values = value.getArray().map(innerValue => innerValue.getString());\n+  if (values.length !== 2) {\n+    throw new FatalLinkerError(\n+        value.expression,\n+        'Unsupported input, expected a string or an array containing exactly two strings');\n+  }\n+  return values as [string, string];\n+}\n+\n+/**\n+ * Extracts the host metadata configuration from the AST metadata object.\n+ */\n+function toHostMetadata<TExpression>(metaObj: AstObject<TExpression>): R3HostMetadata {\n+  if (!metaObj.has('host')) {\n+    return {\n+      attributes: {},\n+      listeners: {},\n+      properties: {},\n+      specialAttributes: {},\n+    };\n+  }\n+\n+  const host = metaObj.getObject('host');\n+\n+  const specialAttributes: R3HostMetadata['specialAttributes'] = {};\n+  if (host.has('styleAttribute')) {\n+    specialAttributes.styleAttr = host.getString('styleAttribute');\n+  }\n+  if (host.has('classAttribute')) {\n+    specialAttributes.classAttr = host.getString('classAttribute');\n+  }\n+\n+  return {\n+    attributes: host.has('attributes') ?\n+        host.getObject('attributes').toLiteral(value => value.getOpaque()) :\n+        {},\n+    listeners: host.has('listeners') ?\n+        host.getObject('listeners').toLiteral(value => value.getString()) :\n+        {},\n+    properties: host.has('properties') ?\n+        host.getObject('properties').toLiteral(value => value.getString()) :\n+        {},\n+    specialAttributes,\n+  };\n+}\n+\n+/**\n+ * Extracts the metadata for a single query from an AST object.\n+ */\n+function toQueryMetadata<TExpression>(obj: AstObject<TExpression>): R3QueryMetadata {\n+  let predicate: R3QueryMetadata['predicate'];\n+  const predicateExpr = obj.getValue('predicate');\n+  if (predicateExpr.isArray()) {\n+    predicate = predicateExpr.getArray().map(entry => entry.getString());\n+  } else {\n+    predicate = predicateExpr.getOpaque();\n+  }\n+  return {\n+    propertyName: obj.getString('propertyName'),\n+    first: obj.getBoolean('first'),\n+    predicate,\n+    descendants: obj.getBoolean('descendants'),\n+    read: obj.has('read') ? obj.getOpaque('read') : null,\n+    static: obj.getBoolean('static'),\n+  };\n+}\n+\n+function wrapReference<TExpression>(wrapped: o.WrappedNodeExpr<TExpression>): R3Reference {\n+  return {value: wrapped, type: wrapped};\n+}\n+\n+export function createSourceSpan(range: Range, code: string, sourceUrl: string): ParseSourceSpan {\n+  const sourceFile = new ParseSourceFile(code, sourceUrl);\n+  const startLocation =\n+      new ParseLocation(sourceFile, range.startPos, range.startLine, range.startCol);\n+  return new ParseSourceSpan(startLocation, startLocation.moveBy(range.endPos - range.startPos));\n+}"
        },
        {
            "sha": "e9d0119793ae93c7bb566af485c455d58d692f13",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_linker.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/87e9cd643bf9743d68406dfd11268715426a277b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker.ts",
            "raw_url": "https://github.com/angular/angular/raw/87e9cd643bf9743d68406dfd11268715426a277b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker.ts?ref=87e9cd643bf9743d68406dfd11268715426a277b",
            "patch": "@@ -12,7 +12,7 @@ import {AstObject} from '../../ast/ast_value';\n /**\n  * An interface for classes that can link partial declarations into full definitions.\n  */\n-export interface PartialLinker<TStatement, TExpression> {\n+export interface PartialLinker<TExpression> {\n   /**\n    * Link the partial declaration `metaObj` information to generate a full definition expression.\n    */"
        },
        {
            "sha": "f2490ba17bececd1b702331abafb890cebd23793",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_linker_selector.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/87e9cd643bf9743d68406dfd11268715426a277b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "raw_url": "https://github.com/angular/angular/raw/87e9cd643bf9743d68406dfd11268715426a277b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts?ref=87e9cd643bf9743d68406dfd11268715426a277b",
            "patch": "@@ -9,8 +9,8 @@ import {PartialComponentLinkerVersion1} from './partial_component_linker_1';\n import {PartialDirectiveLinkerVersion1} from './partial_directive_linker_1';\n import {PartialLinker} from './partial_linker';\n \n-export class PartialLinkerSelector<TStatement, TExpression> {\n-  private linkers: Record<string, Record<number, PartialLinker<TStatement, TExpression>>> = {\n+export class PartialLinkerSelector<TExpression> {\n+  private linkers: Record<string, Record<number, PartialLinker<TExpression>>> = {\n     '$ngDeclareDirective': {\n       1: new PartialDirectiveLinkerVersion1(),\n     },\n@@ -30,7 +30,7 @@ export class PartialLinkerSelector<TStatement, TExpression> {\n    * Returns the `PartialLinker` that can handle functions with the given name and version.\n    * Throws an error if there is none.\n    */\n-  getLinker(functionName: string, version: number): PartialLinker<TStatement, TExpression> {\n+  getLinker(functionName: string, version: number): PartialLinker<TExpression> {\n     const versions = this.linkers[functionName];\n     if (versions === undefined) {\n       throw new Error(`Unknown partial declaration function ${functionName}.`);"
        }
    ],
    "stats": {
        "total": 155,
        "additions": 143,
        "deletions": 12
    }
}