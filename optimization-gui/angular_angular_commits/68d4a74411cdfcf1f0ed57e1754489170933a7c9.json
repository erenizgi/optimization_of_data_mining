{
    "author": "atscott",
    "message": "fix(core): Ensure OnPush ancestors are marked dirty when events occur (#39833)\n\nWe currently only wrap the event listener in the function which ensures\nancestors are marked for check when the listener is placed on an element\nthat has a native method for listening to an event. We actually need to do\nthis wrapping in all cases so that events that are attached to non-rendered\ntemplate items (`ng-template` and `ng-container`) also mark ancestors for check\nwhen they receive the event.\n\nfixes #39832\n\nPR Close #39833",
    "sha": "68d4a74411cdfcf1f0ed57e1754489170933a7c9",
    "files": [
        {
            "sha": "50616cc96244baa550d86879b1c289af035e097d",
            "filename": "packages/core/src/render3/instructions/listener.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/68d4a74411cdfcf1f0ed57e1754489170933a7c9/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts",
            "raw_url": "https://github.com/angular/angular/raw/68d4a74411cdfcf1f0ed57e1754489170933a7c9/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts?ref=68d4a74411cdfcf1f0ed57e1754489170933a7c9",
            "patch": "@@ -193,6 +193,10 @@ function listenerInternal(\n       lCleanup.push(listenerFn);\n       tCleanup && tCleanup.push(eventName, idxOrTargetGetter, lCleanupIndex, useCapture);\n     }\n+  } else {\n+    // Even if there is no native listener to add, we still need to wrap the listener so that OnPush\n+    // ancestors are marked dirty when an event occurs.\n+    listenerFn = wrapListener(tNode, lView, listenerFn, false /** preventDefault */);\n   }\n \n   // subscribe to directive outputs"
        },
        {
            "sha": "36b07659ed09339e0aa41019622a7d4d968339e8",
            "filename": "packages/core/test/acceptance/change_detection_spec.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 2,
            "changes": 39,
            "blob_url": "https://github.com/angular/angular/blob/68d4a74411cdfcf1f0ed57e1754489170933a7c9/packages%2Fcore%2Ftest%2Facceptance%2Fchange_detection_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/68d4a74411cdfcf1f0ed57e1754489170933a7c9/packages%2Fcore%2Ftest%2Facceptance%2Fchange_detection_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fchange_detection_spec.ts?ref=68d4a74411cdfcf1f0ed57e1754489170933a7c9",
            "patch": "@@ -8,8 +8,8 @@\n \n \n import {CommonModule} from '@angular/common';\n-import {ApplicationRef, ChangeDetectionStrategy, ChangeDetectorRef, Component, ComponentFactoryResolver, ComponentRef, Directive, DoCheck, EmbeddedViewRef, ErrorHandler, Input, NgModule, OnInit, QueryList, TemplateRef, Type, ViewChild, ViewChildren, ViewContainerRef} from '@angular/core';\n-import {ComponentFixture, TestBed} from '@angular/core/testing';\n+import {ApplicationRef, ChangeDetectionStrategy, ChangeDetectorRef, Component, ComponentFactoryResolver, ComponentRef, Directive, DoCheck, EmbeddedViewRef, ErrorHandler, EventEmitter, Input, NgModule, OnInit, Output, QueryList, TemplateRef, Type, ViewChild, ViewChildren, ViewContainerRef} from '@angular/core';\n+import {ComponentFixture, fakeAsync, TestBed, tick} from '@angular/core/testing';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n import {ivyEnabled} from '@angular/private/testing';\n import {BehaviorSubject} from 'rxjs';\n@@ -461,6 +461,41 @@ describe('change detection', () => {\n       expect(comp.doCheckCount).toEqual(2);\n       expect(fixture.nativeElement.textContent.trim()).toEqual('3 - 2 - Nancy');\n     });\n+\n+    it('should check parent OnPush components when child directive on a template emits event',\n+       fakeAsync(() => {\n+         @Directive({\n+           selector: '[emitter]',\n+         })\n+         class Emitter {\n+           @Output() event = new EventEmitter<string>();\n+\n+           ngOnInit() {\n+             setTimeout(() => {\n+               this.event.emit('new message');\n+             });\n+           }\n+         }\n+\n+\n+         @Component({\n+           selector: 'my-app',\n+           template: '{{message}} <ng-template emitter (event)=\"message = $event\"></ng-template>',\n+           changeDetection: ChangeDetectionStrategy.OnPush\n+         })\n+         class MyApp {\n+           message = 'initial message';\n+         }\n+\n+         const fixture = TestBed.configureTestingModule({declarations: [MyApp, Emitter]})\n+                             .createComponent(MyApp);\n+         fixture.detectChanges();\n+\n+         expect(fixture.nativeElement.textContent.trim()).toEqual('initial message');\n+         tick();\n+         fixture.detectChanges();\n+         expect(fixture.nativeElement.textContent.trim()).toEqual('new message');\n+       }));\n   });\n \n   describe('ChangeDetectorRef', () => {"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 41,
        "deletions": 2
    }
}