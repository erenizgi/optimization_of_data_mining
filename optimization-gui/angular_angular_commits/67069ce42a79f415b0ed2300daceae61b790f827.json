{
    "author": "josephperrott",
    "message": "fix(bazel): only providing stamping information if the --stamp flag is used (#39392)\n\nPreviously the volatile status file was always provided to the ng_rollup\naction which prevented it from being cacheable remotely.  This change to\nonly provide this file as an input when the --stamp flag is used will allow\nfor the action to be remotely cached and prevent needing to run the action\non every CI run.\n\nPR Close #39392",
    "sha": "67069ce42a79f415b0ed2300daceae61b790f827",
    "files": [
        {
            "sha": "c7823003fea099954f77dcf5dea4f448cc0a3b50",
            "filename": "packages/bazel/src/ng_package/ng_package.bzl",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/67069ce42a79f415b0ed2300daceae61b790f827/packages%2Fbazel%2Fsrc%2Fng_package%2Fng_package.bzl",
            "raw_url": "https://github.com/angular/angular/raw/67069ce42a79f415b0ed2300daceae61b790f827/packages%2Fbazel%2Fsrc%2Fng_package%2Fng_package.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_package%2Fng_package.bzl?ref=67069ce42a79f415b0ed2300daceae61b790f827",
            "patch": "@@ -13,7 +13,7 @@ It packages your library following the Angular Package Format, see the\n specification of this format at https://goo.gl/jB3GVv\n \"\"\"\n \n-load(\"@build_bazel_rules_nodejs//:providers.bzl\", \"JSEcmaScriptModuleInfo\", \"JSNamedModuleInfo\", \"NpmPackageInfo\", \"node_modules_aspect\")\n+load(\"@build_bazel_rules_nodejs//:providers.bzl\", \"JSEcmaScriptModuleInfo\", \"JSNamedModuleInfo\", \"NodeContextInfo\", \"NpmPackageInfo\", \"node_modules_aspect\")\n load(\n     \"@build_bazel_rules_nodejs//internal/pkg_npm:pkg_npm.bzl\",\n     \"PKG_NPM_ATTRS\",\n@@ -230,6 +230,9 @@ def _write_rollup_config(\n     if not include_tslib:\n         external.append(\"tslib\")\n \n+    # Whether the --stamp flag is applied in the context of the action's execution.\n+    stamp = ctx.attr.node_context_data[NodeContextInfo].stamp\n+\n     # Pass external & globals through a templated config file because on Windows there is\n     # an argument limit and we there might be a lot of globals which need to be passed to\n     # rollup.\n@@ -242,7 +245,7 @@ def _write_rollup_config(\n             \"TMPL_module_mappings\": str(mappings),\n             \"TMPL_node_modules_root\": _compute_node_modules_root(ctx),\n             \"TMPL_root_dir\": root_dir,\n-            \"TMPL_stamp_data\": \"\\\"%s\\\"\" % ctx.version_file.path if ctx.version_file else \"undefined\",\n+            \"TMPL_stamp_data\": \"\\\"%s\\\"\" % ctx.version_file.path if (stamp and ctx.version_file) else \"undefined\",\n             \"TMPL_workspace_name\": ctx.workspace_name,\n             \"TMPL_external\": \", \".join([\"'%s'\" % e for e in external]),\n             \"TMPL_globals\": \", \".join([\"'%s': '%s'\" % g for g in globals.items()]),\n@@ -289,10 +292,13 @@ def _run_rollup(ctx, bundle_name, rollup_config, entry_point, inputs, js_output,\n     # bazel rule prints nothing on success.\n     args.add(\"--silent\")\n \n+    # Whether the --stamp flag is applied in the context of the action's execution.\n+    stamp = ctx.attr.node_context_data[NodeContextInfo].stamp\n+\n     other_inputs = [rollup_config]\n     if ctx.file.license_banner:\n         other_inputs.append(ctx.file.license_banner)\n-    if ctx.version_file:\n+    if stamp and ctx.version_file:\n         other_inputs.append(ctx.version_file)\n     ctx.actions.run(\n         progress_message = \"ng_package: Rollup %s %s\" % (bundle_name, ctx.label),"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 9,
        "deletions": 3
    }
}