{
    "author": "atscott",
    "message": "Revert \"fix(language-service): only provide template results on reference requests (#41041)\" (#41930)\n\nThis reverts commit 10aa5641dd85a5eb89f1d1590b9df4119015c29f.\n\nIssue resolved upstream https://github.com/microsoft/vscode/issues/117095\n\nPR Close #41930",
    "sha": "3777cf55aa8873f407c823b83bb487a7b1f7f3dd",
    "files": [
        {
            "sha": "5a4ff0783fa983750061da45df67adc5f6d22de6",
            "filename": "packages/language-service/ivy/references.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/3777cf55aa8873f407c823b83bb487a7b1f7f3dd/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "raw_url": "https://github.com/angular/angular/raw/3777cf55aa8873f407c823b83bb487a7b1f7f3dd/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences.ts?ref=3777cf55aa8873f407c823b83bb487a7b1f7f3dd",
            "patch": "@@ -366,9 +366,7 @@ export class ReferencesAndRenameBuilder {\n           entries.set(createLocationKey(entry), entry);\n         }\n       } else {\n-        // TODO(atscott): uncomment when VSCode deduplicates results on their end\n-        // https://github.com/microsoft/vscode/issues/117095\n-        // entries.set(createLocationKey(ref), ref);\n+        entries.set(createLocationKey(ref), ref);\n       }\n     }\n     return Array.from(entries.values());"
        },
        {
            "sha": "70295cac8042f5d4768d4d8765a199a6a2d15a89",
            "filename": "packages/language-service/ivy/test/references_spec.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 58,
            "changes": 119,
            "blob_url": "https://github.com/angular/angular/blob/3777cf55aa8873f407c823b83bb487a7b1f7f3dd/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3777cf55aa8873f407c823b83bb487a7b1f7f3dd/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts?ref=3777cf55aa8873f407c823b83bb487a7b1f7f3dd",
            "patch": "@@ -43,8 +43,8 @@ describe('find references and rename locations', () => {\n \n     it('gets component member references from TS file and external template', () => {\n       const refs = getReferencesAtPosition(appFile)!;\n-      expect(refs.length).toBe(1);\n-      assertFileNames(refs, ['app.html']);\n+      expect(refs.length).toBe(2);\n+      assertFileNames(refs, ['app.html', 'app.ts']);\n       assertTextSpans(refs, ['myProp']);\n     });\n \n@@ -78,8 +78,8 @@ describe('find references and rename locations', () => {\n \n     it('gets references', () => {\n       const refs = getReferencesAtPosition(templateFile)!;\n-      expect(refs.length).toBe(1);\n-      assertFileNames(refs, ['app.html']);\n+      expect(refs.length).toBe(2);\n+      assertFileNames(refs, ['app.html', 'app.ts']);\n       assertTextSpans(refs, ['myProp']);\n     });\n \n@@ -112,7 +112,7 @@ describe('find references and rename locations', () => {\n \n     it('gets component member reference in ts file', () => {\n       const refs = getReferencesAtPosition(appFile)!;\n-      expect(refs.length).toBe(1);\n+      expect(refs.length).toBe(2);\n \n       assertFileNames(refs, ['app.ts']);\n       assertTextSpans(refs, ['setTitle']);\n@@ -149,7 +149,7 @@ describe('find references and rename locations', () => {\n \n     it('gets member reference in ts file', () => {\n       const refs = getReferencesAtPosition(appFile)!;\n-      expect(refs.length).toBe(1);\n+      expect(refs.length).toBe(2);\n \n       assertTextSpans(refs, ['title']);\n     });\n@@ -215,9 +215,9 @@ describe('find references and rename locations', () => {\n \n     it('gets member reference in ts file', () => {\n       const refs = getReferencesAtPosition(file)!;\n-      expect(refs.length).toBe(1);\n+      expect(refs.length).toBe(2);\n \n-      assertFileNames(refs, ['app.html']);\n+      assertFileNames(refs, ['app.ts', 'app.html']);\n       assertTextSpans(refs, ['title']);\n     });\n \n@@ -253,7 +253,7 @@ describe('find references and rename locations', () => {\n \n     it('get reference to member in ts file', () => {\n       const refs = getReferencesAtPosition(file)!;\n-      expect(refs.length).toBe(1);\n+      expect(refs.length).toBe(2);\n \n       assertFileNames(refs, ['app.ts']);\n       assertTextSpans(refs, ['otherTitle']);\n@@ -290,15 +290,15 @@ describe('find references and rename locations', () => {\n     it('gets reference to member type definition and initialization in component class', () => {\n       const refs = getReferencesAtPosition(file)!;\n       // 3 references: the type definition, the value assignment, and the read in the template\n-      expect(refs.length).toBe(1);\n+      expect(refs.length).toBe(3);\n \n       assertFileNames(refs, ['app.ts']);\n       // TODO(atscott): investigate if we can make the template keyed read be just the 'name' part.\n       // The TypeScript implementation specifically adjusts the span to accommodate string literals:\n       // https://sourcegraph.com/github.com/microsoft/TypeScript@d5779c75d3dd19565b60b9e2960b8aac36d4d635/-/blob/src/services/findAllReferences.ts#L508-512\n       // One possible solution would be to extend `FullTemplateMapping` to include the matched TCB\n       // node and then do the same thing that TS does: if the node is a string, adjust the span.\n-      assertTextSpans(refs, ['\"name\"']);\n+      assertTextSpans(refs, ['name', '\"name\"']);\n     });\n \n     it('gets rename locations in component class', () => {\n@@ -338,9 +338,9 @@ describe('find references and rename locations', () => {\n \n     it('get references in ts file', () => {\n       const refs = getReferencesAtPosition(file)!;\n-      expect(refs.length).toBe(1);\n+      expect(refs.length).toBe(2);\n \n-      assertFileNames(refs, ['app.html']);\n+      assertFileNames(refs, ['app.ts', 'app.html']);\n       assertTextSpans(refs, ['batman']);\n     });\n \n@@ -493,8 +493,8 @@ describe('find references and rename locations', () => {\n \n         it('should get references', () => {\n           const refs = getReferencesAtPosition(file)!;\n-          expect(refs.length).toBe(1);\n-          assertFileNames(refs, ['app.html']);\n+          expect(refs.length).toBe(2);\n+          assertFileNames(refs, ['dir.ts', 'app.html']);\n           assertTextSpans(refs, ['dirValue']);\n         });\n \n@@ -523,8 +523,8 @@ describe('find references and rename locations', () => {\n \n         it('should get references', () => {\n           const refs = getReferencesAtPosition(file)!;\n-          expect(refs.length).toBe(1);\n-          assertFileNames(refs, ['app.html']);\n+          expect(refs.length).toBe(2);\n+          assertFileNames(refs, ['dir.ts', 'app.html']);\n           assertTextSpans(refs, ['dirValue']);\n         });\n \n@@ -553,8 +553,8 @@ describe('find references and rename locations', () => {\n \n         it('should get references', () => {\n           const refs = getReferencesAtPosition(file)!;\n-          expect(refs.length).toBe(1);\n-          assertFileNames(refs, ['app.html']);\n+          expect(refs.length).toBe(2);\n+          assertFileNames(refs, ['dir.ts', 'app.html']);\n           assertTextSpans(refs, ['doSomething']);\n         });\n \n@@ -693,8 +693,8 @@ describe('find references and rename locations', () => {\n \n       it('should find references', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toBe(1);\n-        assertFileNames(refs, ['app.ts']);\n+        expect(refs.length).toBe(2);\n+        assertFileNames(refs, ['app.ts', 'example-directive.ts']);\n         assertTextSpans(refs, ['identifier']);\n       });\n \n@@ -727,7 +727,7 @@ describe('find references and rename locations', () => {\n \n       it('should find references', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toBe(1);\n+        expect(refs.length).toBe(2);\n         assertFileNames(refs, ['app.ts']);\n         assertTextSpans(refs, ['name']);\n       });\n@@ -777,9 +777,9 @@ describe('find references and rename locations', () => {\n \n       it('should find references', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toBe(1);\n-        assertFileNames(refs, ['app.ts']);\n-        assertTextSpans(refs, ['prefixPipe']);\n+        expect(refs.length).toBe(5);\n+        assertFileNames(refs, ['index.d.ts', 'prefix-pipe.ts', 'app.ts']);\n+        assertTextSpans(refs, ['transform', 'prefixPipe']);\n       });\n \n       it('should find rename locations', () => {\n@@ -817,7 +817,7 @@ describe('find references and rename locations', () => {\n \n       it('should find references', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toBe(1);\n+        expect(refs.length).toBe(2);\n         assertFileNames(refs, ['app.ts']);\n         assertTextSpans(refs, ['prefix']);\n       });\n@@ -862,8 +862,8 @@ describe('find references and rename locations', () => {\n \n       it('should find references', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toEqual(1);\n-        assertFileNames(refs, ['app.ts']);\n+        expect(refs.length).toEqual(2);\n+        assertFileNames(refs, ['string-model.ts', 'app.ts']);\n         assertTextSpans(refs, ['model']);\n       });\n \n@@ -947,8 +947,8 @@ describe('find references and rename locations', () => {\n \n       it('should work for text attributes', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toEqual(1);\n-        assertFileNames(refs, ['app.ts']);\n+        expect(refs.length).toEqual(2);\n+        assertFileNames(refs, ['string-model.ts', 'app.ts']);\n         assertTextSpans(refs, ['model']);\n       });\n \n@@ -988,8 +988,8 @@ describe('find references and rename locations', () => {\n \n       it('should work from the TS input declaration', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toEqual(1);\n-        assertFileNames(refs, ['app.ts']);\n+        expect(refs.length).toEqual(2);\n+        assertFileNames(refs, ['app.ts', 'string-model.ts']);\n         assertTextSpans(refs, ['model']);\n       });\n \n@@ -1041,8 +1041,8 @@ describe('find references and rename locations', () => {\n \n       it('should find references', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toEqual(1);\n-        assertFileNames(refs, ['app.ts']);\n+        expect(refs.length).toEqual(3);\n+        assertFileNames(refs, ['app.ts', 'string-model.ts', 'other-dir.ts']);\n         assertTextSpans(refs, ['model']);\n       });\n \n@@ -1076,9 +1076,9 @@ describe('find references and rename locations', () => {\n \n       it('should find references', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toEqual(1);\n-        assertFileNames(refs, ['app.ts']);\n-        assertTextSpans(refs, ['alias']);\n+        expect(refs.length).toEqual(2);\n+        assertFileNames(refs, ['string-model.ts', 'app.ts']);\n+        assertTextSpans(refs, ['aliasedModel', 'alias']);\n       });\n \n       it('should find rename locations', () => {\n@@ -1130,7 +1130,7 @@ describe('find references and rename locations', () => {\n \n       it('should find references', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toEqual(1);\n+        expect(refs.length).toEqual(2);\n         assertTextSpans(refs, ['modelChange']);\n       });\n \n@@ -1154,8 +1154,8 @@ describe('find references and rename locations', () => {\n \n       it('should find references', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toEqual(1);\n-        assertTextSpans(refs, ['alias']);\n+        expect(refs.length).toEqual(2);\n+        assertTextSpans(refs, ['aliasedModelChange', 'alias']);\n       });\n \n       it('should find rename locations', () => {\n@@ -1194,9 +1194,12 @@ describe('find references and rename locations', () => {\n     file.moveCursorToText('[(modÂ¦el)]');\n \n     const refs = getReferencesAtPosition(file)!;\n-    expect(refs.length).toEqual(2);\n-    assertFileNames(refs, ['app.ts']);\n-    assertTextSpans(refs, ['model']);\n+    // Note that this includes the 'model` twice from the template. As with other potential\n+    // duplicates (like if another plugin returns the same span), we expect the LS clients to filter\n+    // these out themselves.\n+    expect(refs.length).toEqual(4);\n+    assertFileNames(refs, ['dir.ts', 'app.ts']);\n+    assertTextSpans(refs, ['model', 'modelChange']);\n   });\n \n   describe('directives', () => {\n@@ -1232,9 +1235,9 @@ describe('find references and rename locations', () => {\n         const refs = getReferencesAtPosition(file)!;\n         // 4 references are:  class declaration, template usage, app import and use in declarations\n         // list.\n-        expect(refs.length).toBe(1);\n-        assertTextSpans(refs, ['<div dir>']);\n-        assertFileNames(refs, ['app.ts']);\n+        expect(refs.length).toBe(4);\n+        assertTextSpans(refs, ['<div dir>', 'Dir']);\n+        assertFileNames(refs, ['app.ts', 'dir.ts']);\n       });\n \n       it('should find rename locations', () => {\n@@ -1281,9 +1284,9 @@ describe('find references and rename locations', () => {\n \n       it('gets references to all matching directives', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toBe(2);\n-        assertTextSpans(refs, ['<div dir>']);\n-        assertFileNames(refs, ['app.ts']);\n+        expect(refs.length).toBe(8);\n+        assertTextSpans(refs, ['<div dir>', 'Dir', 'Dir2']);\n+        assertFileNames(refs, ['app.ts', 'dir.ts', 'dir2.ts']);\n       });\n \n       it('finds rename locations for all matching directives', () => {\n@@ -1318,9 +1321,9 @@ describe('find references and rename locations', () => {\n \n       it('should be able to request references', () => {\n         const refs = getReferencesAtPosition(file)!;\n-        expect(refs.length).toBe(1);\n-        assertTextSpans(refs, ['<div *ngFor=\"let item of items\"></div>']);\n-        assertFileNames(refs, ['app.ts']);\n+        expect(refs.length).toBe(6);\n+        assertTextSpans(refs, ['<div *ngFor=\"let item of items\"></div>', 'NgForOf']);\n+        assertFileNames(refs, ['index.d.ts', 'app.ts']);\n       });\n \n       it('should not support rename if directive is in a dts file', () => {\n@@ -1360,9 +1363,9 @@ describe('find references and rename locations', () => {\n         const refs = getReferencesAtPosition(file)!;\n         // 4 references are:  class declaration, template usage, app import and use in declarations\n         // list.\n-        expect(refs.length).toBe(1);\n-        assertTextSpans(refs, ['<my-comp>']);\n-        assertFileNames(refs, ['app.ts']);\n+        expect(refs.length).toBe(4);\n+        assertTextSpans(refs, ['<my-comp>', 'MyComp']);\n+        assertFileNames(refs, ['app.ts', 'comp.ts']);\n       });\n \n       it('gets rename locations', () => {\n@@ -1405,9 +1408,9 @@ describe('find references and rename locations', () => {\n         const refs = getReferencesAtPosition(file)!;\n         // 4 references are:  class declaration, template usage, app import and use in declarations\n         // list.\n-        expect(refs.length).toBe(1);\n-        assertTextSpans(refs, ['<my-comp>']);\n-        assertFileNames(refs, ['app.ts']);\n+        expect(refs.length).toBe(4);\n+        assertTextSpans(refs, ['<my-comp>', 'MyComp']);\n+        assertFileNames(refs, ['app.ts', 'comp.ts']);\n       });\n \n       it('finds rename locations', () => {"
        }
    ],
    "stats": {
        "total": 123,
        "additions": 62,
        "deletions": 61
    }
}