{
    "author": "petebacondarwin",
    "message": "fix(ngcc): copy (and update) source-maps for unmodified source files (#40429)\n\nWhen using the `NewEntryPointWriter` we copy unmodified files over to the new\nentry-point in addition to writing out the source files that are processed by ngcc.\nBut we were not copying over associated source-map files for these unmodified\nsource files, leading to warnings in downstream tooling.\n\nNow we will also copy over source-maps that reside as siblings of unmodified\nsource files. We have to make sure that the sources of the source-map point\nto the correct files, so we also update the `sourceRoot` property of the copied\nsource-map.\n\nFixes #40358\n\nPR Close #40429",
    "sha": "ad0fb9c6bb28730c83321537a72c10b94fb1b873",
    "files": [
        {
            "sha": "15e2d8f414caafc846b8559510e21090056d0043",
            "filename": "packages/compiler-cli/ngcc/src/writing/new_entry_point_file_writer.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 4,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/ad0fb9c6bb28730c83321537a72c10b94fb1b873/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fwriting%2Fnew_entry_point_file_writer.ts",
            "raw_url": "https://github.com/angular/angular/raw/ad0fb9c6bb28730c83321537a72c10b94fb1b873/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fwriting%2Fnew_entry_point_file_writer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fwriting%2Fnew_entry_point_file_writer.ts?ref=ad0fb9c6bb28730c83321537a72c10b94fb1b873",
            "patch": "@@ -69,16 +69,49 @@ export class NewEntryPointFileWriter extends InPlaceFileWriter {\n   protected copyBundle(\n       bundle: EntryPointBundle, packagePath: AbsoluteFsPath, ngccFolder: AbsoluteFsPath) {\n     bundle.src.program.getSourceFiles().forEach(sourceFile => {\n-      const relativePath = this.fs.relative(packagePath, absoluteFromSourceFile(sourceFile));\n+      const originalPath = absoluteFromSourceFile(sourceFile);\n+      const relativePath = this.fs.relative(packagePath, originalPath);\n       const isInsidePackage = isLocalRelativePath(relativePath);\n       if (!sourceFile.isDeclarationFile && isInsidePackage) {\n-        const newFilePath = this.fs.resolve(ngccFolder, relativePath);\n-        this.fs.ensureDir(this.fs.dirname(newFilePath));\n-        this.fs.copyFile(absoluteFromSourceFile(sourceFile), newFilePath);\n+        const newPath = this.fs.resolve(ngccFolder, relativePath);\n+        this.fs.ensureDir(this.fs.dirname(newPath));\n+        this.fs.copyFile(originalPath, newPath);\n+        this.copyAndUpdateSourceMap(originalPath, newPath);\n       }\n     });\n   }\n \n+  /**\n+   * If a source file has an associated source-map, then copy this, while updating its sourceRoot\n+   * accordingly.\n+   *\n+   * For now don't try to parse the source for inline source-maps or external source-map links,\n+   * since that is more complex and will slow ngcc down.\n+   * Instead just check for a source-map file residing next to the source file, which is by far\n+   * the most common case.\n+   *\n+   * @param originalSrcPath absolute path to the original source file being copied.\n+   * @param newSrcPath absolute path to where the source will be written.\n+   */\n+  protected copyAndUpdateSourceMap(originalSrcPath: AbsoluteFsPath, newSrcPath: AbsoluteFsPath):\n+      void {\n+    const sourceMapPath = (originalSrcPath + '.map') as AbsoluteFsPath;\n+    if (this.fs.exists(sourceMapPath)) {\n+      try {\n+        const sourceMap = JSON.parse(this.fs.readFile(sourceMapPath));\n+        const newSourceMapPath = (newSrcPath + '.map') as AbsoluteFsPath;\n+        const relativePath =\n+            this.fs.relative(this.fs.dirname(newSourceMapPath), this.fs.dirname(sourceMapPath));\n+        sourceMap['sourceRoot'] = this.fs.join(relativePath, sourceMap['sourceRoot'] || '.');\n+        this.fs.ensureDir(this.fs.dirname(newSourceMapPath));\n+        this.fs.writeFile(newSourceMapPath, JSON.stringify(sourceMap));\n+      } catch (e) {\n+        this.logger.warn(`Failed to process source-map at ${sourceMapPath}`);\n+        this.logger.warn(e.message ?? e);\n+      }\n+    }\n+  }\n+\n   protected writeFile(file: FileToWrite, packagePath: AbsoluteFsPath, ngccFolder: AbsoluteFsPath):\n       void {\n     if (isDtsPath(file.path.replace(/\\.map$/, ''))) {"
        },
        {
            "sha": "92406496c8bc5ddee70485db49f67c4db93d6533",
            "filename": "packages/compiler-cli/ngcc/test/writing/new_entry_point_file_writer_spec.ts",
            "status": "modified",
            "additions": 85,
            "deletions": 0,
            "changes": 85,
            "blob_url": "https://github.com/angular/angular/blob/ad0fb9c6bb28730c83321537a72c10b94fb1b873/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fwriting%2Fnew_entry_point_file_writer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ad0fb9c6bb28730c83321537a72c10b94fb1b873/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fwriting%2Fnew_entry_point_file_writer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fwriting%2Fnew_entry_point_file_writer_spec.ts?ref=ad0fb9c6bb28730c83321537a72c10b94fb1b873",
            "patch": "@@ -51,6 +51,12 @@ runInEachFileSystem(() => {\n         {name: _('/node_modules/test/esm5.js'), contents: 'export function FooTop() {}'},\n         {name: _('/node_modules/test/esm5.js.map'), contents: 'ORIGINAL MAPPING DATA'},\n         {name: _('/node_modules/test/es2015/index.js'), contents: 'export {FooTop} from \"./foo\";'},\n+        {\n+          name: _('/node_modules/test/es2015/index.js.map'),\n+          contents:\n+              '{\"version\":3,\"file\":\"index.js\",\"sources\":[\"../src/index.ts\"],\"mappings\":\"AAAA\"}'\n+        },\n+        {name: _('/node_modules/test/src/index.ts'), contents: 'export {FooTop} from \"./foo\";'},\n         {name: _('/node_modules/test/es2015/foo.js'), contents: 'export class FooTop {}'},\n         {\n           name: _('/node_modules/test/a/package.json'),\n@@ -154,6 +160,85 @@ runInEachFileSystem(() => {\n             .toEqual('export {FooTop} from \"./foo\";');\n       });\n \n+      it('should copy any source-map for unmodified files in the program (adding missing sourceRoot)',\n+         () => {\n+           // Ensure source-mapping for a non-processed source file `index.js`.\n+           const sourceMap = {\n+             version: 3,\n+             file: 'index.js',\n+             sources: ['../src/index.ts'],\n+             mappings: 'AAAA',\n+           };\n+           loadTestFiles([\n+             {\n+               name: _('/node_modules/test/es2015/index.js.map'),\n+               contents: JSON.stringify(sourceMap)\n+             },\n+             {name: _('/node_modules/test/src/index.ts'), contents: 'export {FooTop} from \"./foo\";'}\n+           ]);\n+\n+           // Simulate that only the `foo.js` file was modified\n+           const modifiedFiles = [{\n+             path: _('/node_modules/test/es2015/foo.js'),\n+             contents: 'export class FooTop {} // MODIFIED'\n+           }];\n+           fileWriter.writeBundle(esm2015bundle, modifiedFiles, ['es2015']);\n+\n+           expect(JSON.parse(fs.readFile(_('/node_modules/test/__ivy_ngcc__/es2015/index.js.map'))))\n+               .toEqual({...sourceMap, sourceRoot: '../../es2015'});\n+         });\n+\n+      it('should copy any source-map for unmodified files in the program (updating sourceRoot)',\n+         () => {\n+           // Ensure source-mapping for a non-processed source file `index.js`.\n+           const sourceMap = {\n+             version: 3,\n+             file: 'index.js',\n+             sourceRoot: '../src',\n+             sources: ['index.ts'],\n+             mappings: 'AAAA',\n+           };\n+           loadTestFiles([\n+             {\n+               name: _('/node_modules/test/es2015/index.js.map'),\n+               contents: JSON.stringify(sourceMap)\n+             },\n+             {name: _('/node_modules/test/src/index.ts'), contents: 'export {FooTop} from \"./foo\";'}\n+           ]);\n+\n+           // Simulate that only the `foo.js` file was modified\n+           const modifiedFiles = [{\n+             path: _('/node_modules/test/es2015/foo.js'),\n+             contents: 'export class FooTop {} // MODIFIED'\n+           }];\n+           fileWriter.writeBundle(esm2015bundle, modifiedFiles, ['es2015']);\n+\n+           expect(JSON.parse(fs.readFile(_('/node_modules/test/__ivy_ngcc__/es2015/index.js.map'))))\n+               .toEqual({...sourceMap, sourceRoot: '../../src'});\n+         });\n+\n+      it('should ignore (with a warning) any invalid source-map for unmodified files in the program',\n+         () => {\n+           // Ensure source-mapping for a non-processed source file `index.js`.\n+           loadTestFiles([\n+             {name: _('/node_modules/test/es2015/index.js.map'), contents: 'INVALID JSON STRING'},\n+             {name: _('/node_modules/test/src/index.ts'), contents: 'export {FooTop} from \"./foo\";'}\n+           ]);\n+\n+           // Simulate that only the `foo.js` file was modified\n+           const modifiedFiles = [{\n+             path: _('/node_modules/test/es2015/foo.js'),\n+             contents: 'export class FooTop {} // MODIFIED'\n+           }];\n+           fileWriter.writeBundle(esm2015bundle, modifiedFiles, ['es2015']);\n+\n+           expect(fs.exists(_('/node_modules/test/__ivy_ngcc__/es2015/index.js.map'))).toBe(false);\n+           expect(logger.logs.warn).toEqual([\n+             [`Failed to process source-map at ${_('/node_modules/test/es2015/index.js.map')}`],\n+             ['Unexpected token I in JSON at position 0'],\n+           ]);\n+         });\n+\n       it('should update the package.json properties', () => {\n         fileWriter.writeBundle(\n             esm5bundle,"
        }
    ],
    "stats": {
        "total": 126,
        "additions": 122,
        "deletions": 4
    }
}