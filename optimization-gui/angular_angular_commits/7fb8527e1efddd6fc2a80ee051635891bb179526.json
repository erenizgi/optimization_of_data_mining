{
    "author": "devversion",
    "message": "refactor(dev-infra): remove invoke bazel clean command from release tool (#42101)\n\nCurrently the ng-dev release tool always run `bazel clean` before\ncalling the configured build release function. The clean is necessary\nto ensure the release output is actually built; and not restored\nfrom previous builds which could have different bazel workspace\nstatus variables (which provide the NPM package version).\n\nInstead of doing this as part of the release tool, the\nactual script running to build the release output should\nrun the `bazel clean`. The release tool does not intend to\nknow about details on how the release output is built. This\nis necessary because the build setup could vary between version\nbranches (especially for older ones; such as LTS version branches).\n\nPR Close #42101",
    "sha": "7fb8527e1efddd6fc2a80ee051635891bb179526",
    "files": [
        {
            "sha": "9778612953cbd16823c147789de04f4eee090b7b",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 0,
            "deletions": 20,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/7fb8527e1efddd6fc2a80ee051635891bb179526/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/7fb8527e1efddd6fc2a80ee051635891bb179526/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=7fb8527e1efddd6fc2a80ee051635891bb179526",
            "patch": "@@ -5623,25 +5623,6 @@ function invokeYarnInstallCommand(projectDir) {\n         }\n     });\n }\n-/**\n- * Invokes the `yarn bazel clean` command in order to clean the output tree and ensure new artifacts\n- * are created for builds.\n- */\n-function invokeBazelCleanCommand(projectDir) {\n-    return tslib.__awaiter(this, void 0, void 0, function* () {\n-        try {\n-            // Note: No progress indicator needed as that is the responsibility of the command.\n-            // TODO: Consider using an Ora spinner instead to ensure minimal console output.\n-            yield spawnWithDebugOutput('yarn', ['bazel', 'clean'], { cwd: projectDir });\n-            info(green('  ✓   Cleaned bazel output tree.'));\n-        }\n-        catch (e) {\n-            error(e);\n-            error(red('  ✘   An error occurred while cleaning the bazel output tree.'));\n-            throw new FatalReleaseActionError();\n-        }\n-    });\n-}\n \n /**\n  * @license\n@@ -6297,7 +6278,6 @@ class ReleaseAction {\n             // created in the `next` branch. The new package would not be part of the patch branch,\n             // so we cannot build and publish it.\n             yield invokeYarnInstallCommand(this.projectDir);\n-            yield invokeBazelCleanCommand(this.projectDir);\n             const builtPackages = yield invokeReleaseBuildCommand();\n             // Verify the packages built are the correct version.\n             yield this._verifyPackageVersions(releaseNotes.version, builtPackages);"
        },
        {
            "sha": "95aa24eaf292e46e669151a6495dccc31ade8c10",
            "filename": "dev-infra/release/publish/actions.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/7fb8527e1efddd6fc2a80ee051635891bb179526/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "raw_url": "https://github.com/angular/angular/raw/7fb8527e1efddd6fc2a80ee051635891bb179526/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions.ts?ref=7fb8527e1efddd6fc2a80ee051635891bb179526",
            "patch": "@@ -21,7 +21,7 @@ import {runNpmPublish} from '../versioning/npm-publish';\n import {FatalReleaseActionError, UserAbortedReleaseActionError} from './actions-error';\n import {getCommitMessageForRelease, getReleaseNoteCherryPickCommitMessage} from './commit-message';\n import {changelogPath, packageJsonPath, waitForPullRequestInterval} from './constants';\n-import {invokeBazelCleanCommand, invokeReleaseBuildCommand, invokeYarnInstallCommand} from './external-commands';\n+import {invokeReleaseBuildCommand, invokeYarnInstallCommand} from './external-commands';\n import {findOwnedForksOfRepoQuery} from './graphql-queries';\n import {getPullRequestState} from './pull-request-state';\n import {getLocalChangelogFilePath, ReleaseNotes} from './release-notes/release-notes';\n@@ -463,7 +463,6 @@ export abstract class ReleaseAction {\n     // created in the `next` branch. The new package would not be part of the patch branch,\n     // so we cannot build and publish it.\n     await invokeYarnInstallCommand(this.projectDir);\n-    await invokeBazelCleanCommand(this.projectDir);\n     const builtPackages = await invokeReleaseBuildCommand();\n \n     // Verify the packages built are the correct version."
        },
        {
            "sha": "3c9cfbe8f7071b376a68641b8cb6611f73b273ea",
            "filename": "dev-infra/release/publish/external-commands.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 17,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/7fb8527e1efddd6fc2a80ee051635891bb179526/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts",
            "raw_url": "https://github.com/angular/angular/raw/7fb8527e1efddd6fc2a80ee051635891bb179526/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts?ref=7fb8527e1efddd6fc2a80ee051635891bb179526",
            "patch": "@@ -90,20 +90,3 @@ export async function invokeYarnInstallCommand(projectDir: string): Promise<void\n     throw new FatalReleaseActionError();\n   }\n }\n-\n-/**\n- * Invokes the `yarn bazel clean` command in order to clean the output tree and ensure new artifacts\n- * are created for builds.\n- */\n-export async function invokeBazelCleanCommand(projectDir: string): Promise<void> {\n-  try {\n-    // Note: No progress indicator needed as that is the responsibility of the command.\n-    // TODO: Consider using an Ora spinner instead to ensure minimal console output.\n-    await spawnWithDebugOutput('yarn', ['bazel', 'clean'], {cwd: projectDir});\n-    info(green('  ✓   Cleaned bazel output tree.'));\n-  } catch (e) {\n-    error(e);\n-    error(red('  ✘   An error occurred while cleaning the bazel output tree.'));\n-    throw new FatalReleaseActionError();\n-  }\n-}"
        },
        {
            "sha": "77dd64410fc6d689c8dbe743e77e2608708146a9",
            "filename": "dev-infra/release/publish/test/test-utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/7fb8527e1efddd6fc2a80ee051635891bb179526/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/7fb8527e1efddd6fc2a80ee051635891bb179526/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts?ref=7fb8527e1efddd6fc2a80ee051635891bb179526",
            "patch": "@@ -97,7 +97,6 @@ export function setupReleaseActionForTesting<T extends ReleaseAction>(\n   spyOn(npm, 'runNpmPublish').and.resolveTo();\n   spyOn(externalCommands, 'invokeSetNpmDistCommand').and.resolveTo();\n   spyOn(externalCommands, 'invokeYarnInstallCommand').and.resolveTo();\n-  spyOn(externalCommands, 'invokeBazelCleanCommand').and.resolveTo();\n   spyOn(externalCommands, 'invokeReleaseBuildCommand').and.resolveTo([\n     {name: '@angular/pkg1', outputPath: `${testTmpDir}/dist/pkg1`},\n     {name: '@angular/pkg2', outputPath: `${testTmpDir}/dist/pkg2`}"
        },
        {
            "sha": "9081eb70b4df1aecf29e3ccdf265aa4deab41c37",
            "filename": "scripts/build/package-builder.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/7fb8527e1efddd6fc2a80ee051635891bb179526/scripts%2Fbuild%2Fpackage-builder.js",
            "raw_url": "https://github.com/angular/angular/raw/7fb8527e1efddd6fc2a80ee051635891bb179526/scripts%2Fbuild%2Fpackage-builder.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fpackage-builder.js?ref=7fb8527e1efddd6fc2a80ee051635891bb179526",
            "patch": "@@ -81,6 +81,16 @@ function buildTargetPackages(destDir, enableIvy, description, isRelease = false)\n       bazelCmd} query --output=label \"attr('tags', '\\\\[.*release-with-framework.*\\\\]', //packages/...) intersect kind('ng_package|pkg_npm', //packages/...)\"`;\n   const targets = exec(getTargetsCmd, true).split(/\\r?\\n/);\n \n+  // If we are in release mode, run `bazel clean` to ensure the execroot and action cache\n+  // are not populated. This is necessary because targets using `npm_package` rely on\n+  // workspace status variables for the package version. Such NPM package targets are not\n+  // rebuilt if only the workspace status variables change. This could result in accidental\n+  // re-use of previously built package output with a different `version` in the `package.json`.\n+  if (isRelease) {\n+    console.info('Building in release mode. Resetting the Bazel execroot and action cache..');\n+    exec(`${bazelCmd} clean`);\n+  }\n+\n   // Use either `--config=snapshot` or `--config=release` so that builds are created with the\n   // correct embedded version info.\n   exec(`${bazelCmd} build --config=${isRelease ? 'release' : 'snapshot'} --config=${"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 11,
        "deletions": 40
    }
}