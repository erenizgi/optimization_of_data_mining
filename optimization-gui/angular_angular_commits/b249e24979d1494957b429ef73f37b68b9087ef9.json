{
    "author": "JoostK",
    "message": "fix(compiler): generate correct code for safe method calls (#44088)\n\nWhen a safe method call such as `person?.getName()` is used, the\ncompiler would generate invalid code if the argument list also contained\na safe method call. For example, the following code:\n\n```\nperson?.getName(config?.get('title').enabled)\n```\n\nwould generate\n\n```\nlet tmp;\nctx.person == null ? null : ctx.person.getName((tmp = tmp) == null ?\nnull : tmp.enabled)\n```\n\nNotice how the call to `config.get('title')` has completely disappeared,\nwith `(tmp = tmp)` having taken its place.\n\nThe issue occurred due to how the argument list would be converted\nfrom expression AST to output AST twice. First, the outer safe method\ncall would first convert its arguments list. This resulted in a\ntemporary being allocated for `config.get('title')`, which was stored in\nthe internal `_resultMap`. Only after the argument list has been\nconverted would the outer safe method call realize that it should be\nguarded by a safe access of `person`, entering the `convertSafeAccess`\nprocedure to convert itself. This would convert the argument list once\nagain, but this time the `_resultMap` would already contain the\ntemporary `tmp` for `config?.get('title')`. Consequently, the safe\nmethod in the argument list would be emitted as `tmp`.\n\nThis commit fixes the issue by ensuring that nodes are only converted\nonce.\n\nCloses #44069\n\nPR Close #44088",
    "sha": "b249e24979d1494957b429ef73f37b68b9087ef9",
    "files": [
        {
            "sha": "4b0100cf3b862749c38d2f1a3e1deb7c83503b3d",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FGOLDEN_PARTIAL.js?ref=b249e24979d1494957b429ef73f37b68b9087ef9",
            "patch": "@@ -63,3 +63,48 @@ export declare class MyModule {\n     static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: safe_method_call.js\n+ ****************************************************************************************************/\n+import { Component } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class MyApp {\n+}\n+MyApp.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"ng-component\", ngImport: i0, template: `\n+    <span [title]=\"person?.getName(false)\"></span>\n+    <span [title]=\"person?.getName(false) || ''\"></span>\n+    <span [title]=\"person?.getName(false)?.toLowerCase()\"></span>\n+    <span [title]=\"person?.getName(config.get('title')?.enabled)\"></span>\n+    <span [title]=\"person?.getName(config.get('title')?.enabled ?? true)\"></span>\n+`, isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, decorators: [{\n+            type: Component,\n+            args: [{\n+                    template: `\n+    <span [title]=\"person?.getName(false)\"></span>\n+    <span [title]=\"person?.getName(false) || ''\"></span>\n+    <span [title]=\"person?.getName(false)?.toLowerCase()\"></span>\n+    <span [title]=\"person?.getName(config.get('title')?.enabled)\"></span>\n+    <span [title]=\"person?.getName(config.get('title')?.enabled ?? true)\"></span>\n+`\n+                }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: safe_method_call.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class MyApp {\n+    person?: {\n+        getName: (includeTitle: boolean | undefined) => string;\n+    };\n+    config: {\n+        get: (name: string) => {\n+            enabled: boolean;\n+        } | undefined;\n+    };\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyApp, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<MyApp, \"ng-component\", never, {}, {}, never, never>;\n+}\n+"
        },
        {
            "sha": "c9eda3547f967750d4e38630e97a947c78a43a76",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/TEST_CASES.json",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FTEST_CASES.json?ref=b249e24979d1494957b429ef73f37b68b9087ef9",
            "patch": "@@ -17,6 +17,23 @@\n           \"failureMessage\": \"Incorrect template\"\n         }\n       ]\n+    },\n+    {\n+      \"description\": \"should handle safe method calls inside templates\",\n+      \"inputFiles\": [\n+        \"safe_method_call.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"files\": [\n+            {\n+              \"expected\": \"safe_method_call.js\",\n+              \"generated\": \"safe_method_call.js\"\n+            }\n+          ],\n+          \"failureMessage\": \"Incorrect template\"\n+        }\n+      ]\n     }\n   ]\n }"
        },
        {
            "sha": "fc34aa3545d208ee614f6f4733afde0f5a9f6ba9",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/safe_method_call.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_method_call.js",
            "raw_url": "https://github.com/angular/angular/raw/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_method_call.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_method_call.js?ref=b249e24979d1494957b429ef73f37b68b9087ef9",
            "patch": "@@ -0,0 +1,19 @@\n+template: function MyApp_Template(rf, $ctx$) {\n+  if (rf & 1) {\n+    // ...\n+  }\n+  if (rf & 2) {\n+    let $tmp_0_0$;\n+    let $tmp_1_0$;\n+    let $tmp_2_0$;\n+    $i0$.ɵɵproperty(\"title\", $ctx$.person == null ? null : $ctx$.person.getName(false));\n+    $i0$.ɵɵadvance(1);\n+    $i0$.ɵɵproperty(\"title\", ($ctx$.person == null ? null : $ctx$.person.getName(false)) || \"\");\n+    $i0$.ɵɵadvance(1);\n+    $i0$.ɵɵproperty(\"title\", $ctx$.person == null ? null : ($tmp_0_0$ = $ctx$.person.getName(false)) == null ? null : $tmp_0_0$.toLowerCase());\n+    $i0$.ɵɵadvance(1);\n+    $i0$.ɵɵproperty(\"title\", $ctx$.person == null ? null : $ctx$.person.getName(($tmp_1_0$ = $ctx$.config.get(\"title\")) == null ? null : $tmp_1_0$.enabled));\n+    $i0$.ɵɵadvance(1);\n+    $i0$.ɵɵproperty(\"title\", $ctx$.person == null ? null : $ctx$.person.getName(($tmp_2_0$ = ($tmp_2_0$ = $ctx$.config.get(\"title\")) == null ? null : $tmp_2_0$.enabled) !== null && $tmp_2_0$ !== undefined ? $tmp_2_0$ : true));\n+  }\n+}"
        },
        {
            "sha": "e4971a2966cbb68cc0c410f748ddcb0235e7b3b7",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/safe_method_call.ts",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_method_call.ts",
            "raw_url": "https://github.com/angular/angular/raw/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_method_call.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_method_call.ts?ref=b249e24979d1494957b429ef73f37b68b9087ef9",
            "patch": "@@ -0,0 +1,21 @@\n+import {Component} from '@angular/core';\n+\n+@Component({\n+  template: `\n+    <span [title]=\"person?.getName(false)\"></span>\n+    <span [title]=\"person?.getName(false) || ''\"></span>\n+    <span [title]=\"person?.getName(false)?.toLowerCase()\"></span>\n+    <span [title]=\"person?.getName(config.get('title')?.enabled)\"></span>\n+    <span [title]=\"person?.getName(config.get('title')?.enabled ?? true)\"></span>\n+`\n+})\n+export class MyApp {\n+  person?: {getName: (includeTitle: boolean|undefined) => string;};\n+  config: {\n+    get:\n+        (name: string) => {\n+          enabled: boolean\n+        } |\n+        undefined;\n+  }\n+}"
        },
        {
            "sha": "dea48b9a250f3ab62baff9a1ba50722951a2f07f",
            "filename": "packages/compiler/src/compiler_util/expression_converter.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "raw_url": "https://github.com/angular/angular/raw/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts?ref=b249e24979d1494957b429ef73f37b68b9087ef9",
            "patch": "@@ -596,6 +596,11 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n   }\n \n   visitCall(ast: cdAst.Call, mode: _Mode): any {\n+    const leftMostSafe = this.leftMostSafeNode(ast);\n+    if (leftMostSafe) {\n+      return this.convertSafeAccess(ast, leftMostSafe, mode);\n+    }\n+\n     const convertedArgs = this.visitAll(ast.args, _Mode.Expression);\n \n     if (ast instanceof BuiltinFunctionCall) {\n@@ -616,11 +621,6 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n               .cast(o.DYNAMIC_TYPE, this.convertSourceSpan(ast.span)));\n     }\n \n-    const leftMostSafe = this.leftMostSafeNode(ast);\n-    if (leftMostSafe) {\n-      return this.convertSafeAccess(ast, leftMostSafe, mode);\n-    }\n-\n     const call = this._visit(receiver, _Mode.Expression)\n                      .callFn(convertedArgs, this.convertSourceSpan(ast.span));\n     return convertToStatementIfNeeded(mode, call);\n@@ -674,7 +674,7 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n     // which comes in as leftMostSafe to this routine.\n \n     let guardedExpression = this._visit(leftMostSafe.receiver, _Mode.Expression);\n-    let temporary: o.ReadVarExpr = undefined!;\n+    let temporary: o.ReadVarExpr|undefined = undefined;\n     if (this.needsTemporaryInSafeAccess(leftMostSafe.receiver)) {\n       // If the expression has method calls or pipes then we need to save the result into a\n       // temporary variable to avoid calling stateful or impure code more than once."
        },
        {
            "sha": "b07d2d54180293c6a05e4bde0087ef29f9e6600c",
            "filename": "packages/core/test/acceptance/integration_spec.ts",
            "status": "modified",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/angular/angular/blob/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b249e24979d1494957b429ef73f37b68b9087ef9/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts?ref=b249e24979d1494957b429ef73f37b68b9087ef9",
            "patch": "@@ -2091,6 +2091,69 @@ describe('acceptance integration tests', () => {\n     expect(fixture.nativeElement.textContent).toContain('Hello, unknown!');\n   });\n \n+  it('should handle nested calls to a safe access methods in templates', () => {\n+    const log: string[] = [];\n+\n+    class Person {\n+      constructor(public name: string, public title: string) {}\n+\n+      getName(includeTitle: boolean|undefined) {\n+        log.push(`person.getName(${includeTitle})`);\n+        return includeTitle ? `${this.title} ${this.name}` : this.name;\n+      }\n+    }\n+\n+    @Component({\n+      template: `\n+      <span>Hello, {{ (person?.getName(getConfig('showTitle')?.enabled ?? getDefaultShowTitle()) ?? getFallbackName()) }}!</span>\n+    `\n+    })\n+    class App {\n+      person: Person|null = null;\n+      showTitle: boolean|null = null;\n+\n+      getConfig(name: string): {enabled: boolean}|null {\n+        log.push(`getConfig(${name})`);\n+        return this.showTitle !== null ? {enabled: this.showTitle} : null;\n+      }\n+\n+      getDefaultShowTitle(): boolean {\n+        log.push(`getDefaultShowTitle()`);\n+        return false;\n+      }\n+\n+      getFallbackName(): string {\n+        log.push(`getFallbackName()`);\n+        return 'unknown';\n+      }\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [App]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges(/* checkNoChanges */ false);\n+    expect(fixture.nativeElement.textContent).toContain('Hello, unknown!');\n+    expect(log).toEqual(['getFallbackName()']);\n+    log.length = 0;\n+\n+    fixture.componentInstance.person = new Person('Penelope', 'Lady');\n+    fixture.detectChanges(/* checkNoChanges */ false);\n+    expect(fixture.nativeElement.textContent).toContain('Hello, Penelope!');\n+    expect(log).toEqual(['getConfig(showTitle)', 'getDefaultShowTitle()', 'person.getName(false)']);\n+    log.length = 0;\n+\n+    fixture.componentInstance.showTitle = true;\n+    fixture.detectChanges(/* checkNoChanges */ false);\n+    expect(fixture.nativeElement.textContent).toContain('Hello, Lady Penelope!');\n+    expect(log).toEqual(['getConfig(showTitle)', 'person.getName(true)']);\n+    log.length = 0;\n+\n+    fixture.componentInstance.showTitle = false;\n+    fixture.detectChanges(/* checkNoChanges */ false);\n+    expect(fixture.nativeElement.textContent).toContain('Hello, Penelope!');\n+    expect(log).toEqual(['getConfig(showTitle)', 'person.getName(false)']);\n+    log.length = 0;\n+  });\n+\n   describe('tView.firstUpdatePass', () => {\n     function isFirstUpdatePass() {\n       const lView = getLView();"
        }
    ],
    "stats": {
        "total": 177,
        "additions": 171,
        "deletions": 6
    }
}