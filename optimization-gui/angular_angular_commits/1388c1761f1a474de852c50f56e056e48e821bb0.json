{
    "author": "JoostK",
    "message": "perf(compiler-cli): don't emit template guards when child scope is empty (#38418)\n\nFor a template that contains for example `<span *ngIf=\"first\"></span>`\nthere's no need to render the `NgIf` guard expression, as the child\nscope does not have any type-checking statements, so any narrowing\neffect of the guard is not applicable.\n\nThis seems like a minor improvement, however it reduces the number of\nflow-node antecedents that TypeScript needs to keep into account for\nsuch cases, resulting in an overall reduction of type-checking time.\n\nPR Close #38418",
    "sha": "1388c1761f1a474de852c50f56e056e48e821bb0",
    "files": [
        {
            "sha": "5576556a7154121a7a3c67f54419bfa26b03a05c",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/1388c1761f1a474de852c50f56e056e48e821bb0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/1388c1761f1a474de852c50f56e056e48e821bb0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=1388c1761f1a474de852c50f56e056e48e821bb0",
            "patch": "@@ -304,8 +304,19 @@ class TcbTemplateBodyOp extends TcbOp {\n     // children, as well as tracks bindings within the template.\n     const tmplScope = Scope.forNodes(this.tcb, this.scope, this.template, guard);\n \n-    // Render the template's `Scope` into a block.\n-    let tmplBlock: ts.Statement = ts.createBlock(tmplScope.render());\n+    // Render the template's `Scope` into its statements.\n+    const statements = tmplScope.render();\n+    if (statements.length === 0) {\n+      // As an optimization, don't generate the scope's block if it has no statements. This is\n+      // beneficial for templates that contain for example `<span *ngIf=\"first\"></span>`, in which\n+      // case there's no need to render the `NgIf` guard expression. This seems like a minor\n+      // improvement, however it reduces the number of flow-node antecedents that TypeScript needs\n+      // to keep into account for such cases, resulting in an overall reduction of\n+      // type-checking time.\n+      return null;\n+    }\n+\n+    let tmplBlock: ts.Statement = ts.createBlock(statements);\n     if (guard !== null) {\n       // The scope has a guard that needs to be applied, so wrap the template block into an `if`\n       // statement containing the guard expression."
        },
        {
            "sha": "9dafff8bde64fe42e1296fed6d5aadb2a5a6f377",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_check_block_spec.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/1388c1761f1a474de852c50f56e056e48e821bb0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1388c1761f1a474de852c50f56e056e48e821bb0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts?ref=1388c1761f1a474de852c50f56e056e48e821bb0",
            "patch": "@@ -585,7 +585,7 @@ describe('type check blocks', () => {\n           type: 'invocation',\n         }]\n       }];\n-      const TEMPLATE = `<div *ngIf=\"person\"></div>`;\n+      const TEMPLATE = `<div *ngIf=\"person\">{{person.name}}</div>`;\n       const block = tcb(TEMPLATE, DIRECTIVES);\n       expect(block).toContain('if (NgIf.ngTemplateGuard_ngIf(_t1, ((ctx).person)))');\n     });\n@@ -601,10 +601,26 @@ describe('type check blocks', () => {\n           type: 'binding',\n         }]\n       }];\n-      const TEMPLATE = `<div *ngIf=\"person !== null\"></div>`;\n+      const TEMPLATE = `<div *ngIf=\"person !== null\">{{person.name}}</div>`;\n       const block = tcb(TEMPLATE, DIRECTIVES);\n       expect(block).toContain('if ((((ctx).person)) !== (null))');\n     });\n+\n+    it('should not emit guards when the child scope is empty', () => {\n+      const DIRECTIVES: TestDeclaration[] = [{\n+        type: 'directive',\n+        name: 'NgIf',\n+        selector: '[ngIf]',\n+        inputs: {'ngIf': 'ngIf'},\n+        ngTemplateGuards: [{\n+          inputName: 'ngIf',\n+          type: 'invocation',\n+        }]\n+      }];\n+      const TEMPLATE = `<div *ngIf=\"person\">static</div>`;\n+      const block = tcb(TEMPLATE, DIRECTIVES);\n+      expect(block).not.toContain('NgIf.ngTemplateGuard_ngIf');\n+    });\n   });\n \n   describe('outputs', () => {\n@@ -681,7 +697,7 @@ describe('type check blocks', () => {\n     };\n \n     describe('config.applyTemplateContextGuards', () => {\n-      const TEMPLATE = `<div *dir></div>`;\n+      const TEMPLATE = `<div *dir>{{ value }}</div>`;\n       const GUARD_APPLIED = 'if (Dir.ngTemplateContextGuard(';\n \n       it('should apply template context guards when enabled', () => {"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 32,
        "deletions": 5
    }
}