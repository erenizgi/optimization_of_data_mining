{
    "author": "alxhub",
    "message": "refactor(compiler-cli): extract xi18n utility functions to a separate file (#42485)\n\nThis commit moves some xi18n-related functions in the View Engine\nng.Program into a new file. This is necessary in order to depend on them\nfrom the Ivy ng.Program while avoiding a cycle.\n\nPR Close #42485",
    "sha": "4538bd6c96923db6e7c6c429767a499865d97436",
    "files": [
        {
            "sha": "f2db15a0e852d541458afe94f877ef84e150ec97",
            "filename": "packages/compiler-cli/src/transformers/i18n.ts",
            "status": "added",
            "additions": 74,
            "deletions": 0,
            "changes": 74,
            "blob_url": "https://github.com/angular/angular/blob/4538bd6c96923db6e7c6c429767a499865d97436/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fi18n.ts",
            "raw_url": "https://github.com/angular/angular/raw/4538bd6c96923db6e7c6c429767a499865d97436/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fi18n.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fi18n.ts?ref=4538bd6c96923db6e7c6c429767a499865d97436",
            "patch": "@@ -0,0 +1,74 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {MessageBundle, Serializer, Xliff, Xliff2, Xmb} from '@angular/compiler';\n+import * as path from 'path';\n+import * as ts from 'typescript';\n+\n+import {CompilerOptions} from './api';\n+\n+export function i18nGetExtension(formatName: string): string {\n+  const format = formatName.toLowerCase();\n+\n+  switch (format) {\n+    case 'xmb':\n+      return 'xmb';\n+    case 'xlf':\n+    case 'xlif':\n+    case 'xliff':\n+    case 'xlf2':\n+    case 'xliff2':\n+      return 'xlf';\n+  }\n+\n+  throw new Error(`Unsupported format \"${formatName}\"`);\n+}\n+\n+export function i18nExtract(\n+    formatName: string|null, outFile: string|null, host: ts.CompilerHost, options: CompilerOptions,\n+    bundle: MessageBundle,\n+    pathResolve: (...segments: string[]) => string = path.resolve): string[] {\n+  formatName = formatName || 'xlf';\n+  // Checks the format and returns the extension\n+  const ext = i18nGetExtension(formatName);\n+  const content = i18nSerialize(bundle, formatName, options);\n+  const dstFile = outFile || `messages.${ext}`;\n+  const dstPath = pathResolve(options.outDir || options.basePath!, dstFile);\n+  host.writeFile(dstPath, content, false, undefined, []);\n+  return [dstPath];\n+}\n+\n+export function i18nSerialize(\n+    bundle: MessageBundle, formatName: string, options: CompilerOptions): string {\n+  const format = formatName.toLowerCase();\n+  let serializer: Serializer;\n+\n+  switch (format) {\n+    case 'xmb':\n+      serializer = new Xmb();\n+      break;\n+    case 'xliff2':\n+    case 'xlf2':\n+      serializer = new Xliff2();\n+      break;\n+    case 'xlf':\n+    case 'xliff':\n+    default:\n+      serializer = new Xliff();\n+  }\n+\n+  return bundle.write(serializer, getPathNormalizer(options.basePath));\n+}\n+\n+function getPathNormalizer(basePath?: string) {\n+  // normalize source paths by removing the base path and always using \"/\" as a separator\n+  return (sourcePath: string) => {\n+    sourcePath = basePath ? path.relative(basePath, sourcePath) : sourcePath;\n+    return sourcePath.split(path.sep).join('/');\n+  };\n+}"
        },
        {
            "sha": "9e32a2a905747966efcbaaa0b810c4a4c889576f",
            "filename": "packages/compiler-cli/src/transformers/program.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 61,
            "changes": 63,
            "blob_url": "https://github.com/angular/angular/blob/4538bd6c96923db6e7c6c429767a499865d97436/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fprogram.ts",
            "raw_url": "https://github.com/angular/angular/raw/4538bd6c96923db6e7c6c429767a499865d97436/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fprogram.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fprogram.ts?ref=4538bd6c96923db6e7c6c429767a499865d97436",
            "patch": "@@ -7,7 +7,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AotCompiler, AotCompilerOptions, core, createAotCompiler, FormattedMessageChain, GeneratedFile, getMissingNgModuleMetadataErrorData, getParseErrors, isFormattedError, isSyntaxError, MessageBundle, NgAnalyzedFileWithInjectables, NgAnalyzedModules, ParseSourceSpan, PartialModule, Serializer, Xliff, Xliff2, Xmb} from '@angular/compiler';\n+import {AotCompiler, AotCompilerOptions, core, createAotCompiler, FormattedMessageChain, GeneratedFile, getMissingNgModuleMetadataErrorData, getParseErrors, isFormattedError, isSyntaxError, MessageBundle, NgAnalyzedFileWithInjectables, NgAnalyzedModules, ParseSourceSpan, PartialModule} from '@angular/compiler';\n import * as fs from 'fs';\n import * as path from 'path';\n import * as ts from 'typescript';\n@@ -22,6 +22,7 @@ import {verifySupportedTypeScriptVersion} from '../typescript_support';\n import {CompilerHost, CompilerOptions, CustomTransformers, DEFAULT_ERROR_CODE, Diagnostic, DiagnosticMessageChain, EmitFlags, LazyRoute, LibrarySummary, Program, SOURCE, TsEmitCallback, TsMergeEmitResultsCallback} from './api';\n import {CodeGenerator, getOriginalReferences, TsCompilerAotCompilerTypeCheckHostAdapter} from './compiler_host';\n import {getDownlevelDecoratorsTransform} from './downlevel_decorators_transform';\n+import {i18nExtract} from './i18n';\n import {getInlineResourcesTransformFactory, InlineResourcesMetadataTransformer} from './inline_resources';\n import {getExpressionLoweringTransformFactory, LowerMetadataTransform} from './lower_expressions';\n import {MetadataCache, MetadataTransformer} from './metadata_cache';\n@@ -938,66 +939,6 @@ export function createSrcToOutPathMapper(\n   }\n }\n \n-export function i18nExtract(\n-    formatName: string|null, outFile: string|null, host: ts.CompilerHost, options: CompilerOptions,\n-    bundle: MessageBundle): string[] {\n-  formatName = formatName || 'xlf';\n-  // Checks the format and returns the extension\n-  const ext = i18nGetExtension(formatName);\n-  const content = i18nSerialize(bundle, formatName, options);\n-  const dstFile = outFile || `messages.${ext}`;\n-  const dstPath = path.resolve(options.outDir || options.basePath!, dstFile);\n-  host.writeFile(dstPath, content, false, undefined, []);\n-  return [dstPath];\n-}\n-\n-export function i18nSerialize(\n-    bundle: MessageBundle, formatName: string, options: CompilerOptions): string {\n-  const format = formatName.toLowerCase();\n-  let serializer: Serializer;\n-\n-  switch (format) {\n-    case 'xmb':\n-      serializer = new Xmb();\n-      break;\n-    case 'xliff2':\n-    case 'xlf2':\n-      serializer = new Xliff2();\n-      break;\n-    case 'xlf':\n-    case 'xliff':\n-    default:\n-      serializer = new Xliff();\n-  }\n-\n-  return bundle.write(serializer, getPathNormalizer(options.basePath));\n-}\n-\n-function getPathNormalizer(basePath?: string) {\n-  // normalize source paths by removing the base path and always using \"/\" as a separator\n-  return (sourcePath: string) => {\n-    sourcePath = basePath ? path.relative(basePath, sourcePath) : sourcePath;\n-    return sourcePath.split(path.sep).join('/');\n-  };\n-}\n-\n-export function i18nGetExtension(formatName: string): string {\n-  const format = formatName.toLowerCase();\n-\n-  switch (format) {\n-    case 'xmb':\n-      return 'xmb';\n-    case 'xlf':\n-    case 'xlif':\n-    case 'xliff':\n-    case 'xlf2':\n-    case 'xliff2':\n-      return 'xlf';\n-  }\n-\n-  throw new Error(`Unsupported format \"${formatName}\"`);\n-}\n-\n function mergeEmitResults(emitResults: ts.EmitResult[]): ts.EmitResult {\n   const diagnostics: ts.Diagnostic[] = [];\n   let emitSkipped = false;"
        }
    ],
    "stats": {
        "total": 137,
        "additions": 76,
        "deletions": 61
    }
}