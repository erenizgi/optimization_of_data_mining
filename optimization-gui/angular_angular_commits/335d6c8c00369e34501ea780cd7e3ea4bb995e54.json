{
    "author": "crisbeto",
    "message": "fix(compiler): incorrectly encapsulating selectors with escape sequences (#40264)\n\nCSS supports escaping in selectors, e.g. writing `.foo:bar` will match an element with the\n`foo` class and `bar` pseudo-class, but `.foo\\:bar` will match the `foo:bar` class. Our\nshimmed shadow DOM encapsulation always assumes that `:` means a pseudo selector\nwhich breaks a selector like `.foo\\:bar`.\n\nThese changes add some extra logic so that escaped characters in selectors are preserved.\n\nFixes #31844.\n\nPR Close #40264",
    "sha": "335d6c8c00369e34501ea780cd7e3ea4bb995e54",
    "files": [
        {
            "sha": "5fe6ecb8a871712aeecd96d7f89fb6d87bfef4db",
            "filename": "packages/compiler/src/shadow_css.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 7,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/335d6c8c00369e34501ea780cd7e3ea4bb995e54/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts",
            "raw_url": "https://github.com/angular/angular/raw/335d6c8c00369e34501ea780cd7e3ea4bb995e54/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts?ref=335d6c8c00369e34501ea780cd7e3ea4bb995e54",
            "patch": "@@ -485,12 +485,14 @@ class SafeSelector {\n   constructor(selector: string) {\n     // Replaces attribute selectors with placeholders.\n     // The WS in [attr=\"va lue\"] would otherwise be interpreted as a selector separator.\n-    selector = selector.replace(/(\\[[^\\]]*\\])/g, (_, keep) => {\n-      const replaceBy = `__ph-${this.index}__`;\n-      this.placeholders.push(keep);\n-      this.index++;\n-      return replaceBy;\n-    });\n+    selector = this._escapeRegexMatches(selector, /(\\[[^\\]]*\\])/g);\n+\n+    // CSS allows for certain special characters to be used in selectors if they're escaped.\n+    // E.g. `.foo:blue` won't match a class called `foo:blue`, because the colon denotes a\n+    // pseudo-class, but writing `.foo\\:blue` will match, because the colon was escaped.\n+    // Replace all escape sequences (`\\` followed by a character) with a placeholder so\n+    // that our handling of pseudo-selectors doesn't mess with them.\n+    selector = this._escapeRegexMatches(selector, /(\\\\.)/g);\n \n     // Replaces the expression in `:nth-child(2n + 1)` with a placeholder.\n     // WS and \"+\" would otherwise be interpreted as selector separators.\n@@ -503,12 +505,25 @@ class SafeSelector {\n   }\n \n   restore(content: string): string {\n-    return content.replace(/__ph-(\\d+)__/g, (ph, index) => this.placeholders[+index]);\n+    return content.replace(/__ph-(\\d+)__/g, (_ph, index) => this.placeholders[+index]);\n   }\n \n   content(): string {\n     return this._content;\n   }\n+\n+  /**\n+   * Replaces all of the substrings that match a regex within a\n+   * special string (e.g. `__ph-0__`, `__ph-1__`, etc).\n+   */\n+  private _escapeRegexMatches(content: string, pattern: RegExp): string {\n+    return content.replace(pattern, (_, keep) => {\n+      const replaceBy = `__ph-${this.index}__`;\n+      this.placeholders.push(keep);\n+      this.index++;\n+      return replaceBy;\n+    });\n+  }\n }\n \n const _cssContentNextSelectorRe ="
        },
        {
            "sha": "5b9ba518813bda03fbffbc066514ab73d325876c",
            "filename": "packages/compiler/test/shadow_css_spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/335d6c8c00369e34501ea780cd7e3ea4bb995e54/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/335d6c8c00369e34501ea780cd7e3ea4bb995e54/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts?ref=335d6c8c00369e34501ea780cd7e3ea4bb995e54",
            "patch": "@@ -10,7 +10,7 @@ import {CssRule, processRules, ShadowCss} from '@angular/compiler/src/shadow_css\n import {normalizeCSS} from '@angular/platform-browser/testing/src/browser_util';\n \n {\n-  describe('ShadowCss', function() {\n+  describe('ShadowCss', () => {\n     function s(css: string, contentAttr: string, hostAttr: string = '') {\n       const shadowCss = new ShadowCss();\n       const shim = shadowCss.shimCssText(css, contentAttr, hostAttr);\n@@ -112,6 +112,15 @@ import {normalizeCSS} from '@angular/platform-browser/testing/src/browser_util';\n       expect(s('[is=\"one\"] {}', 'contenta')).toEqual('[is=\"one\"][contenta] {}');\n     });\n \n+    it('should handle escaped sequences in selectors', () => {\n+      expect(s('one\\\\/two {}', 'contenta')).toEqual('one\\\\/two[contenta] {}');\n+      expect(s('one\\\\:two {}', 'contenta')).toEqual('one\\\\:two[contenta] {}');\n+      expect(s('one\\\\\\\\:two {}', 'contenta')).toEqual('one\\\\\\\\[contenta]:two {}');\n+      expect(s('.one\\\\:two {}', 'contenta')).toEqual('.one\\\\:two[contenta] {}');\n+      expect(s('.one\\\\:two .three\\\\:four {}', 'contenta'))\n+          .toEqual('.one\\\\:two[contenta] .three\\\\:four[contenta] {}');\n+    });\n+\n     describe((':host'), () => {\n       it('should handle no context', () => {\n         expect(s(':host {}', 'contenta', 'a-host')).toEqual('[a-host] {}');"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 32,
        "deletions": 8
    }
}