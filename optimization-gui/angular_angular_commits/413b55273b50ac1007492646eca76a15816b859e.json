{
    "author": "petebacondarwin",
    "message": "fix(ngcc): capture UMD/CommonJS inner class implementation node correctly (#39346)\n\nPreviously, UMD/CommonJS class inline declarations of the form:\n\n```ts\nexports.Foo = (function() { function Foo(); return Foo; })();\n```\n\nwere capturing the whole IIFE as the implementation, rather than\nthe inner class (i.e. `function Foo() {}` in this case). This caused\nthe interpreter to break when it was trying to access such an export,\nsince it would try to evaluate the IIFE rather than treating it as a class\ndeclaration.\n\nPR Close #39346",
    "sha": "413b55273b50ac1007492646eca76a15816b859e",
    "files": [
        {
            "sha": "f467d5beee0cc310e61abf403a0d6327e063f0bb",
            "filename": "packages/compiler-cli/ngcc/src/host/commonjs_host.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 1,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fcommonjs_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fcommonjs_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fcommonjs_host.ts?ref=413b55273b50ac1007492646eca76a15816b859e",
            "patch": "@@ -14,7 +14,8 @@ import {Declaration, DeclarationKind, Import} from '../../../src/ngtsc/reflectio\n import {BundleProgram} from '../packages/bundle_program';\n import {FactoryMap, isDefined} from '../utils';\n \n-import {DefinePropertyReexportStatement, ExportDeclaration, ExportsStatement, extractGetterFnExpression, findNamespaceOfIdentifier, findRequireCallReference, isDefinePropertyReexportStatement, isExportsStatement, isExternalImport, isRequireCall, isWildcardReexportStatement, RequireCall, skipAliases, WildcardReexportStatement} from './commonjs_umd_utils';\n+import {DefinePropertyReexportStatement, ExportDeclaration, ExportsStatement, extractGetterFnExpression, findNamespaceOfIdentifier, findRequireCallReference, isDefinePropertyReexportStatement, isExportsAssignment, isExportsStatement, isExternalImport, isRequireCall, isWildcardReexportStatement, RequireCall, skipAliases, WildcardReexportStatement} from './commonjs_umd_utils';\n+import {getInnerClassDeclaration, getOuterNodeFromInnerDeclaration} from './esm2015_host';\n import {Esm5ReflectionHost} from './esm5_host';\n import {NgccClassSymbol} from './ngcc_host';\n \n@@ -216,6 +217,27 @@ export class CommonJsReflectionHost extends Esm5ReflectionHost {\n     return {node: module, known: null, viaModule, identity: null, kind: DeclarationKind.Concrete};\n   }\n \n+  /**\n+   * If this is an IFE then try to grab the outer and inner classes otherwise fallback on the super\n+   * class.\n+   */\n+  protected getDeclarationOfExpression(expression: ts.Expression): Declaration|null {\n+    const inner = getInnerClassDeclaration(expression);\n+    if (inner !== null) {\n+      const outer = getOuterNodeFromInnerDeclaration(inner);\n+      if (outer !== null && isExportsAssignment(outer)) {\n+        return {\n+          kind: DeclarationKind.Inline,\n+          node: outer.left,\n+          implementation: inner,\n+          known: null,\n+          viaModule: null,\n+        };\n+      }\n+    }\n+    return super.getDeclarationOfExpression(expression);\n+  }\n+\n   private resolveModuleName(moduleName: string, containingFile: ts.SourceFile): ts.SourceFile\n       |undefined {\n     if (this.compilerHost.resolveModuleNames) {"
        },
        {
            "sha": "fa8080d1e4b6c6e4d0dc66db10efa973a5641af7",
            "filename": "packages/compiler-cli/ngcc/src/host/umd_host.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts?ref=413b55273b50ac1007492646eca76a15816b859e",
            "patch": "@@ -470,6 +470,27 @@ export class UmdReflectionHost extends Esm5ReflectionHost {\n     return requireCall.arguments[0].text;\n   }\n \n+  /**\n+   * If this is an IIFE then try to grab the outer and inner classes otherwise fallback on the super\n+   * class.\n+   */\n+  protected getDeclarationOfExpression(expression: ts.Expression): Declaration|null {\n+    const inner = getInnerClassDeclaration(expression);\n+    if (inner !== null) {\n+      const outer = getOuterNodeFromInnerDeclaration(inner);\n+      if (outer !== null && isExportsAssignment(outer)) {\n+        return {\n+          kind: DeclarationKind.Inline,\n+          node: outer.left,\n+          implementation: inner,\n+          known: null,\n+          viaModule: null,\n+        };\n+      }\n+    }\n+    return super.getDeclarationOfExpression(expression);\n+  }\n+\n   private resolveModuleName(moduleName: string, containingFile: ts.SourceFile): ts.SourceFile\n       |undefined {\n     if (this.compilerHost.resolveModuleNames) {"
        },
        {
            "sha": "c548908896393577013122bef5ad216eda48cbf0",
            "filename": "packages/compiler-cli/ngcc/test/host/commonjs_host_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fcommonjs_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fcommonjs_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fcommonjs_host_spec.ts?ref=413b55273b50ac1007492646eca76a15816b859e",
            "patch": "@@ -208,6 +208,7 @@ foo.decorators = [\n   { type: core.Directive, args: [{ selector: '[ignored]' },] }\n ];\n exports.directives = [foo];\n+exports.Inline = (function() { function Inline() {} return Inline; })();\n `,\n       };\n \n@@ -2422,11 +2423,16 @@ exports.MissingClass2 = MissingClass2;\n           const file = getSourceFileOrError(bundle.program, _('/inline_export.js'));\n           const exportDeclarations = host.getExportsOfModule(file);\n           expect(exportDeclarations).not.toBeNull();\n-          const decl = exportDeclarations!.get('directives') as InlineDeclaration;\n-          expect(decl).toBeDefined();\n-          expect(decl.node.getText()).toEqual('exports.directives');\n-          expect(decl.implementation!.getText()).toEqual('[foo]');\n-          expect(decl.kind).toEqual(DeclarationKind.Inline);\n+          const entries: [string, InlineDeclaration][] =\n+              Array.from(exportDeclarations!.entries()) as any;\n+          expect(\n+              entries.map(\n+                  ([name, decl]) =>\n+                      [name, decl.node!.getText(), decl.implementation!.getText(), decl.viaModule]))\n+              .toEqual([\n+                ['directives', 'exports.directives', '[foo]', null],\n+                ['Inline', 'exports.Inline', 'function Inline() {}', null],\n+              ]);\n         });\n \n         it('should recognize declarations of known TypeScript helpers', () => {"
        },
        {
            "sha": "add1647568399d86a1e535e1668ed73dee2693b1",
            "filename": "packages/compiler-cli/ngcc/test/host/umd_host_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 9,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts?ref=413b55273b50ac1007492646eca76a15816b859e",
            "patch": "@@ -287,6 +287,7 @@ runInEachFileSystem(() => {\n     { type: core.Directive, args: [{ selector: '[ignored]' },] }\n   ];\n   exports.directives = [foo];\n+  exports.Inline = (function() { function Inline() {} return Inline; })();\n })));\n `,\n         };\n@@ -2732,10 +2733,8 @@ runInEachFileSystem(() => {\n                 ['e', `e = 'e'`, null],\n                 ['DirectiveX', `Directive: FnWithArg<(clazz: any) => any>`, '@angular/core'],\n                 [\n-                  'SomeClass', `SomeClass = (function() {\n-    function SomeClass() {}\n-    return SomeClass;\n-  }())`,\n+                  'SomeClass',\n+                  'SomeClass = (function() {\\n    function SomeClass() {}\\n    return SomeClass;\\n  }())',\n                   null\n                 ],\n               ]);\n@@ -2824,11 +2823,16 @@ runInEachFileSystem(() => {\n           const file = getSourceFileOrError(bundle.program, INLINE_EXPORT_FILE.name);\n           const exportDeclarations = host.getExportsOfModule(file);\n           expect(exportDeclarations).not.toBe(null);\n-          const decl = exportDeclarations!.get('directives') as InlineDeclaration;\n-          expect(decl).toBeDefined();\n-          expect(decl.node.getText()).toEqual('exports.directives');\n-          expect(decl.implementation!.getText()).toEqual('[foo]');\n-          expect(decl.kind).toEqual(DeclarationKind.Inline);\n+          const entries: [string, InlineDeclaration][] =\n+              Array.from(exportDeclarations!.entries()) as any;\n+          expect(\n+              entries.map(\n+                  ([name, decl]) =>\n+                      [name, decl.node!.getText(), decl.implementation!.getText(), decl.viaModule]))\n+              .toEqual([\n+                ['directives', 'exports.directives', '[foo]', null],\n+                ['Inline', 'exports.Inline', 'function Inline() {}', null],\n+              ]);\n         });\n \n         it('should recognize declarations of known TypeScript helpers', () => {"
        },
        {
            "sha": "0bd2af3e83b796279c03c75e509a55ca0965ca85",
            "filename": "packages/compiler-cli/ngcc/test/integration/ngcc_spec.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/angular/angular/blob/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts?ref=413b55273b50ac1007492646eca76a15816b859e",
            "patch": "@@ -467,6 +467,67 @@ runInEachFileSystem(() => {\n              .not.toThrow();\n        });\n \n+    it('should support inline UMD/CommonJS exports declarations', () => {\n+      // Setup an Angular entry-point in UMD module format that has an inline exports declaration\n+      // referenced by an NgModule.\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test-package/package.json'),\n+          contents: '{\"name\": \"test-package\", \"main\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.js'),\n+          contents: `\n+          (function (global, factory) {\n+            typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/core')) :\n+            typeof define === 'function' && define.amd ? define('test', ['exports', 'core'], factory) :\n+            (factory(global.test, global.core));\n+          }(this, (function (exports, core) { 'use strict';\n+            exports.FooModule = /** @class */ (function () {\n+              function FooModule() {}\n+              FooModule = __decorate([\n+                  core.NgModule({declarations: exports.declarations})\n+              ], FooModule);\n+              return FooModule;\n+            }());\n+\n+            exports.declarations = [exports.FooDirective];\n+\n+            exports.FooDirective = /** @class */ (function () {\n+              function FooDirective() {}\n+              FooDirective = __decorate([\n+                core.Directive({selector: '[foo]'})\n+              ], FooDirective);\n+              return FooDirective;\n+            }());\n+          })));\n+          `\n+        },\n+        {\n+          name: _('/node_modules/test-package/index.d.ts'),\n+          contents: `\n+          export declare class FooModule { }\n+          export declare class FooDirective { }\n+          `\n+        },\n+        {name: _('/node_modules/test-package/index.metadata.json'), contents: 'DUMMY DATA'},\n+      ]);\n+\n+      expect(() => mainNgcc({\n+               basePath: '/node_modules',\n+               targetEntryPointPath: 'test-package',\n+               propertiesToConsider: ['main'],\n+             }))\n+          .not.toThrow();\n+\n+      const processedFile = fs.readFile(_('/node_modules/test-package/index.js'));\n+      expect(processedFile)\n+          .toContain('FooModule.ɵmod = ɵngcc0.ɵɵdefineNgModule({ type: FooModule });');\n+      expect(processedFile)\n+          .toContain(\n+              'ɵngcc0.ɵɵsetNgModuleScope(FooModule, { declarations: function () { return [exports.FooDirective]; } });');\n+    });\n+\n     it('should not be able to evaluate code in external packages when no .d.ts files are present',\n        () => {\n          loadTestFiles(["
        },
        {
            "sha": "20f19320550a39580c9e74eedcf55e48bf312f30",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/src/interpreter.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts",
            "raw_url": "https://github.com/angular/angular/raw/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts?ref=413b55273b50ac1007492646eca76a15816b859e",
            "patch": "@@ -342,10 +342,12 @@ export class StaticInterpreter {\n   }\n \n   private visitAmbiguousDeclaration(decl: Declaration, declContext: Context) {\n-    return decl.kind === DeclarationKind.Inline && decl.implementation !== undefined ?\n-        // Inline declarations with an `implementation` should be visited as expressions\n+    return decl.kind === DeclarationKind.Inline && decl.implementation !== undefined &&\n+            !isDeclaration(decl.implementation) ?\n+        // Inline declarations whose `implementation` is a `ts.Expression` should be visited as\n+        // an expression.\n         this.visitExpression(decl.implementation, declContext) :\n-        // Otherwise just visit the declaration `node`\n+        // Otherwise just visit the `node` as a declaration.\n         this.visitDeclaration(decl.node, declContext);\n   }\n "
        },
        {
            "sha": "cbf28be5b898bfa31f61fd877dfcbc2e58277cb4",
            "filename": "packages/compiler-cli/src/ngtsc/reflection/src/host.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Fhost.ts",
            "raw_url": "https://github.com/angular/angular/raw/413b55273b50ac1007492646eca76a15816b859e/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Fhost.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Fhost.ts?ref=413b55273b50ac1007492646eca76a15816b859e",
            "patch": "@@ -625,7 +625,7 @@ export interface DownleveledEnum {\n export interface InlineDeclaration extends\n     BaseDeclaration<Exclude<DeclarationNode, ts.Declaration>> {\n   kind: DeclarationKind.Inline;\n-  implementation?: ts.Expression;\n+  implementation?: DeclarationNode;\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 154,
        "additions": 135,
        "deletions": 19
    }
}