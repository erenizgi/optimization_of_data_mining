{
    "author": "IgorMinar",
    "message": "feat(docs-infra): update deploy-to-firebase.sh script to support v9 multisite setup (#37721)\n\nv9.angular.io was used to pilot the firebase hosting multisites setup for angular.io.\n\nThe deployments so far have been done manually to control the deployment process.\n\nThis change, automates the deployment for v9.angular.io so that future deployments can be made from\nthe CI.\n\nSee https://angular-team.atlassian.net/browse/DEV-125 for more info.\n\nIn the process of updating the scripts I rediscovered a bug in the deploy-to-firebase.sh script that\nincorrect compared two numbers as strings. This previously worked correctly because we were comparing\nsingle digit numbers. With the release of v10, we now compare 9 > 10 which behaves differently for\nstrings and numbers. The bug was fixed by switching to an arithmetic comparison of the two variables.\n\nThis bug has been fixed on the master branch but not on the 9.1.x branch. I realized this during the\nrebase, but found my version to be a bit cleaner, so I kept it.\n\nPR Close #37721",
    "sha": "3a698e2d08032a021c145420e1a90e89f65a36f3",
    "files": [
        {
            "sha": "5a8970eef8b65d66ee5c3d01f5dfc2d830bb5484",
            "filename": "aio/firebase.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/3a698e2d08032a021c145420e1a90e89f65a36f3/aio%2Ffirebase.json",
            "raw_url": "https://github.com/angular/angular/raw/3a698e2d08032a021c145420e1a90e89f65a36f3/aio%2Ffirebase.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ffirebase.json?ref=3a698e2d08032a021c145420e1a90e89f65a36f3",
            "patch": "@@ -1,5 +1,6 @@\n {\n   \"hosting\": {\n+    \"target\": \"aio\",\n     \"public\": \"dist\",\n     \"cleanUrls\": true,\n     \"redirects\": ["
        },
        {
            "sha": "a6d7ca38a35a00dae633a45d86425c1ed38d1712",
            "filename": "aio/scripts/deploy-to-firebase.sh",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/3a698e2d08032a021c145420e1a90e89f65a36f3/aio%2Fscripts%2Fdeploy-to-firebase.sh",
            "raw_url": "https://github.com/angular/angular/raw/3a698e2d08032a021c145420e1a90e89f65a36f3/aio%2Fscripts%2Fdeploy-to-firebase.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.sh?ref=3a698e2d08032a021c145420e1a90e89f65a36f3",
            "patch": "@@ -33,7 +33,7 @@ else\n   readonly majorVersionStable=${CI_STABLE_BRANCH%%.*}\n \n   # Do not deploy if the major version is not less than the stable branch major version\n-  if [[ !( \"$majorVersion\" -lt \"$majorVersionStable\" ) ]]; then\n+  if (( $majorVersion >= $majorVersionStable )); then\n     echo \"Skipping deploy of branch \\\"$CI_BRANCH\\\" to firebase.\"\n     echo \"We only deploy archive branches with the major version less than the stable branch: \\\"$CI_STABLE_BRANCH\\\"\"\n     exit 0\n@@ -105,9 +105,20 @@ fi\n   # Check payload size\n   yarn payload-size\n \n+\n   # Deploy to Firebase\n-  yarn firebase use \"$projectId\" --token \"$firebaseToken\"\n-  yarn firebase deploy --message \"Commit: $CI_COMMIT\" --non-interactive --token \"$firebaseToken\"\n+\n+  # Special case v9-angular-io because its piloting the firebase hosting \"multisites\" setup\n+  # See https://angular-team.atlassian.net/browse/DEV-125 for more info.\n+  if [[ \"$projectId\" == \"v9-angular-io\" ]]; then\n+    yarn firebase use aio-staging --token \"$firebaseToken\"\n+    yarn firebase target:apply hosting aio $projectId --token \"$firebaseToken\"\n+    yarn firebase deploy --only hosting:aio --message \"Commit: $CI_COMMIT\" --non-interactive --token \"$firebaseToken\"\n+  elif\n+    yarn firebase use \"$projectId\" --token \"$firebaseToken\"\n+    yarn firebase deploy --message \"Commit: $CI_COMMIT\" --non-interactive --token \"$firebaseToken\"\n+  fi\n+\n \n   # Run PWA-score tests\n   yarn test-pwa-score \"$deployedUrl\" \"$CI_AIO_MIN_PWA_SCORE\""
        },
        {
            "sha": "37b4e3d832e5cd95d7810ea559b400e2fd1dc473",
            "filename": "aio/scripts/deploy-to-firebase.test.sh",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/3a698e2d08032a021c145420e1a90e89f65a36f3/aio%2Fscripts%2Fdeploy-to-firebase.test.sh",
            "raw_url": "https://github.com/angular/angular/raw/3a698e2d08032a021c145420e1a90e89f65a36f3/aio%2Fscripts%2Fdeploy-to-firebase.test.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.test.sh?ref=3a698e2d08032a021c145420e1a90e89f65a36f3",
            "patch": "@@ -143,6 +143,31 @@ Deployment URL    : https://v2.angular.io/\"\n   check \"$actual\" \"$expected\"\n )\n \n+(\n+  echo ===== archive - v9-angular-io multisite special case - deploy success\n+  actual=$(\n+    export BASH_ENV=/dev/null\n+    export CI_REPO_OWNER=angular\n+    export CI_REPO_NAME=angular\n+    export CI_PULL_REQUEST=false\n+    export CI_BRANCH=9.1.x\n+    export CI_STABLE_BRANCH=10.0.x\n+    export CI_COMMIT=$(git ls-remote origin 9.1.x | cut -c1-40)\n+    export CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN=XXXXX\n+    $deployToFirebaseDryRun\n+  )\n+  expected=\"Git branch        : 9.1.x\n+Build/deploy mode : archive\n+Firebase project  : v9-angular-io\n+Deployment URL    : https://v9.angular.io/\"\n+  # TODO: This test incorrectly expects the Firebase project to be v9-angular-io.\n+  #       v9-angular-io is a \"multisites\" project currently within the aio-staging project\n+  #       This setup is temporary and was created in order to deploy v9.angular.io without\n+  #       disruptions.\n+  #       See https://angular-team.atlassian.net/browse/DEV-125 for more info.\n+  check \"$actual\" \"$expected\"\n+)\n+\n (\n   echo ===== archive - skip deploy - commit not HEAD\n   actual=$("
        }
    ],
    "stats": {
        "total": 43,
        "additions": 40,
        "deletions": 3
    }
}