{
    "author": "devversion",
    "message": "build: only ship type definitions along with bundles for compiler-cli (#43431)\n\nWe switched the build output for the compiler-cli to use esbuild-generated\nbundles.\n\nThis means that actual devmode ES5 sources, or prodmode ES2020 non-bundled\nsources are not actually needed. Only the types are needed, and this commit\nmakes sure only the type definitions are shipped. This reduces the code size\nof the compiler-cli and also helps with avoiding incorrect module resolution.\n\nPR Close #43431",
    "sha": "7e0bab38569e3c63b01e5eeccd945d42bcb211f5",
    "files": [
        {
            "sha": "7ed45e5dca55e8476a68faf895ab57cc8de176b7",
            "filename": "packages/compiler-cli/BUILD.bazel",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/7e0bab38569e3c63b01e5eeccd945d42bcb211f5/packages%2Fcompiler-cli%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/7e0bab38569e3c63b01e5eeccd945d42bcb211f5/packages%2Fcompiler-cli%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2FBUILD.bazel?ref=7e0bab38569e3c63b01e5eeccd945d42bcb211f5",
            "patch": "@@ -1,5 +1,6 @@\n load(\"//tools:defaults.bzl\", \"api_golden_test\", \"pkg_npm\", \"ts_config\", \"ts_library\")\n load(\"@npm//@bazel/esbuild:index.bzl\", \"esbuild\", \"esbuild_config\")\n+load(\":extract_typings_rule.bzl\", \"extract_typings\")\n \n # Load ng_perf_flag explicitly from ng_perf.bzl as it's private API, and not exposed to other\n # consumers of @angular/bazel.\n@@ -105,6 +106,11 @@ ts_library(\n     ],\n )\n \n+extract_typings(\n+    name = \"api_type_definitions\",\n+    deps = PUBLIC_TARGETS,\n+)\n+\n pkg_npm(\n     name = \"npm_package\",\n     srcs = [\n@@ -119,11 +125,10 @@ pkg_npm(\n         \"//integration:__pkg__\",\n         \"//packages/compiler-cli/integrationtest:__pkg__\",\n     ],\n-    # Note: We add `PUBLIC_TARGETS` here to pull in the type definitions into\n-    # the NPM package. This also brings in the devmode ES5 sources currently.\n-    # These are not referenced anywhere but we would want to only include types.\n-    # TODO(devversion): add support for including only type definitions here.\n-    deps = [\":bundles\"] + PUBLIC_TARGETS,\n+    deps = [\n+        \":api_type_definitions\",\n+        \":bundles\",\n+    ],\n )\n \n api_golden_test("
        },
        {
            "sha": "0cb80c1d509e2aee47d7e059731fcc4cf921b8f9",
            "filename": "packages/compiler-cli/extract_typings_rule.bzl",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/7e0bab38569e3c63b01e5eeccd945d42bcb211f5/packages%2Fcompiler-cli%2Fextract_typings_rule.bzl",
            "raw_url": "https://github.com/angular/angular/raw/7e0bab38569e3c63b01e5eeccd945d42bcb211f5/packages%2Fcompiler-cli%2Fextract_typings_rule.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fextract_typings_rule.bzl?ref=7e0bab38569e3c63b01e5eeccd945d42bcb211f5",
            "patch": "@@ -0,0 +1,25 @@\n+\"\"\"Starlark file that exposes a rule for extracting type definitions of dependencies.\"\"\"\n+\n+load(\"@build_bazel_rules_nodejs//:providers.bzl\", \"DeclarationInfo\")\n+\n+def _extract_typings_rule_impl(ctx):\n+    \"\"\"Implementation of the `extract_typings` rule.\"\"\"\n+    transitive_depsets = []\n+\n+    for dep in ctx.attr.deps:\n+        # Based on whether declarations should be collected, extract direct\n+        # and transitive declaration files using the `DeclarationInfo` provider.\n+        if DeclarationInfo in dep:\n+            transitive_depsets.append(dep[DeclarationInfo].transitive_declarations)\n+\n+    return [DefaultInfo(files = depset(transitive = transitive_depsets))]\n+\n+extract_typings = rule(\n+    implementation = _extract_typings_rule_impl,\n+    doc = \"\"\"Rule that extracts all transitive typings of dependencies\"\"\",\n+    attrs = {\n+        \"deps\": attr.label_list(\n+            allow_files = True,\n+        ),\n+    },\n+)"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 35,
        "deletions": 5
    }
}