{
    "author": "JoostK",
    "message": "fix(core): do not use Function constructors in development mode to avoid CSP violations (#43587)\n\nThis commit removes the dynamic creation of named arrays for internal\nruntime storage arrays as they may cause CSP violations in development\nmode,  when an application's CSP configuration does not include\n`unsafe-eval`.\n\nNamed arrays for view data can still be enabled in development mode\nusing the `ngDevMode=namedConstructors` query parameter when loading the\napplication.\n\nThe usage of native class syntax for named arrays does not have the\ndesired effect when the code is downleveled to ES5. Since ES5 targets\nare becoming increasingly more rare this is considered less of a problem\nthan the CSP violation.\n\nFixes #43494\n\nPR Close #43587",
    "sha": "4f8eaac7ff2b73dd18d6317c955d447011a69301",
    "files": [
        {
            "sha": "9d6b6d2af241d97350b4aff79874b24b8183b999",
            "filename": "packages/core/src/render3/instructions/lview_debug.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 26,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/4f8eaac7ff2b73dd18d6317c955d447011a69301/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f8eaac7ff2b73dd18d6317c955d447011a69301/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts?ref=4f8eaac7ff2b73dd18d6317c955d447011a69301",
            "patch": "@@ -13,7 +13,6 @@ import {Sanitizer} from '../../sanitization/sanitizer';\n import {KeyValueArray} from '../../util/array_utils';\n import {assertDefined} from '../../util/assert';\n import {createNamedArrayType} from '../../util/named_array_type';\n-import {initNgDevMode} from '../../util/ng_dev_mode';\n import {assertNodeInjector} from '../assert';\n import {getInjectorIndex, getParentInjectorLocation} from '../di';\n import {CONTAINER_HEADER_OFFSET, HAS_TRANSPLANTED_VIEWS, LContainer, MOVED_VIEWS, NATIVE} from '../interfaces/container';\n@@ -30,8 +29,6 @@ import {attachDebugObject} from '../util/debug_utils';\n import {getParentInjectorIndex, getParentInjectorView} from '../util/injector_utils';\n import {unwrapRNode} from '../util/view_utils';\n \n-const NG_DEV_MODE = ((typeof ngDevMode === 'undefined' || !!ngDevMode) && initNgDevMode());\n-\n /*\n  * This file contains conditionally attached classes which provide human readable (debug) level\n  * information for `LView`, `LContainer` and other internal data structures. These data structures\n@@ -61,9 +58,11 @@ const NG_DEV_MODE = ((typeof ngDevMode === 'undefined' || !!ngDevMode) && initNg\n  * ```\n  */\n \n-let LVIEW_COMPONENT_CACHE!: Map<string|null, Array<any>>;\n-let LVIEW_EMBEDDED_CACHE!: Map<string|null, Array<any>>;\n-let LVIEW_ROOT!: Array<any>;\n+let LVIEW_COMPONENT_CACHE: Map<string|null, Array<any>>|undefined;\n+let LVIEW_EMBEDDED_CACHE: Map<string|null, Array<any>>|undefined;\n+let LVIEW_ROOT: Array<any>|undefined;\n+let LVIEW_COMPONENT: Array<any>|undefined;\n+let LVIEW_EMBEDDED: Array<any>|undefined;\n \n interface TViewDebug extends ITView {\n   type: TViewType;\n@@ -80,12 +79,20 @@ export function cloneToLViewFromTViewBlueprint(tView: TView): LView {\n   return lView.concat(tView.blueprint) as any;\n }\n \n+class LRootView extends Array {}\n+class LComponentView extends Array {}\n+class LEmbeddedView extends Array {}\n+\n function getLViewToClone(type: TViewType, name: string|null): Array<any> {\n   switch (type) {\n     case TViewType.Root:\n-      if (LVIEW_ROOT === undefined) LVIEW_ROOT = new (createNamedArrayType('LRootView'))();\n+      if (LVIEW_ROOT === undefined) LVIEW_ROOT = new LRootView();\n       return LVIEW_ROOT;\n     case TViewType.Component:\n+      if (!ngDevMode || !ngDevMode.namedConstructors) {\n+        if (LVIEW_COMPONENT === undefined) LVIEW_COMPONENT = new LComponentView();\n+        return LVIEW_COMPONENT;\n+      }\n       if (LVIEW_COMPONENT_CACHE === undefined) LVIEW_COMPONENT_CACHE = new Map();\n       let componentArray = LVIEW_COMPONENT_CACHE.get(name);\n       if (componentArray === undefined) {\n@@ -94,6 +101,10 @@ function getLViewToClone(type: TViewType, name: string|null): Array<any> {\n       }\n       return componentArray;\n     case TViewType.Embedded:\n+      if (!ngDevMode || !ngDevMode.namedConstructors) {\n+        if (LVIEW_EMBEDDED === undefined) LVIEW_EMBEDDED = new LEmbeddedView();\n+        return LVIEW_EMBEDDED;\n+      }\n       if (LVIEW_EMBEDDED_CACHE === undefined) LVIEW_EMBEDDED_CACHE = new Map();\n       let embeddedArray = LVIEW_EMBEDDED_CACHE.get(name);\n       if (embeddedArray === undefined) {\n@@ -347,7 +358,7 @@ function processTNodeChildren(tNode: ITNode|null, buf: string[]) {\n   }\n }\n \n-const TViewData = NG_DEV_MODE && createNamedArrayType('TViewData') || null! as ArrayConstructor;\n+class TViewData extends Array {}\n let TVIEWDATA_EMPTY: unknown[];  // can't initialize here or it will not be tree shaken, because\n                                  // `LView` constructor could have side-effects.\n /**\n@@ -360,24 +371,13 @@ export function cloneToTViewData(list: any[]): TData {\n   return TVIEWDATA_EMPTY.concat(list) as any;\n }\n \n-export const LViewBlueprint =\n-    NG_DEV_MODE && createNamedArrayType('LViewBlueprint') || null! as ArrayConstructor;\n-export const MatchesArray =\n-    NG_DEV_MODE && createNamedArrayType('MatchesArray') || null! as ArrayConstructor;\n-export const TViewComponents =\n-    NG_DEV_MODE && createNamedArrayType('TViewComponents') || null! as ArrayConstructor;\n-export const TNodeLocalNames =\n-    NG_DEV_MODE && createNamedArrayType('TNodeLocalNames') || null! as ArrayConstructor;\n-export const TNodeInitialInputs =\n-    NG_DEV_MODE && createNamedArrayType('TNodeInitialInputs') || null! as ArrayConstructor;\n-export const TNodeInitialData =\n-    NG_DEV_MODE && createNamedArrayType('TNodeInitialData') || null! as ArrayConstructor;\n-export const LCleanup =\n-    NG_DEV_MODE && createNamedArrayType('LCleanup') || null! as ArrayConstructor;\n-export const TCleanup =\n-    NG_DEV_MODE && createNamedArrayType('TCleanup') || null! as ArrayConstructor;\n-\n-\n+export class LViewBlueprint extends Array {}\n+export class MatchesArray extends Array {}\n+export class TViewComponents extends Array {}\n+export class TNodeLocalNames extends Array {}\n+export class TNodeInitialInputs extends Array {}\n+export class LCleanup extends Array {}\n+export class TCleanup extends Array {}\n \n export function attachLViewDebug(lView: LView) {\n   attachDebugObject(lView, new LViewDebug(lView));"
        },
        {
            "sha": "c05e733b5db3554165aee021c89a39ff33eeec06",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/4f8eaac7ff2b73dd18d6317c955d447011a69301/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f8eaac7ff2b73dd18d6317c955d447011a69301/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=4f8eaac7ff2b73dd18d6317c955d447011a69301",
            "patch": "@@ -14,8 +14,6 @@ import {validateAgainstEventAttributes, validateAgainstEventProperties} from '..\n import {Sanitizer} from '../../sanitization/sanitizer';\n import {assertDefined, assertDomNode, assertEqual, assertGreaterThanOrEqual, assertIndexInRange, assertNotEqual, assertNotSame, assertSame, assertString} from '../../util/assert';\n import {escapeCommentText} from '../../util/dom';\n-import {createNamedArrayType} from '../../util/named_array_type';\n-import {initNgDevMode} from '../../util/ng_dev_mode';\n import {normalizeDebugBindingName, normalizeDebugBindingValue} from '../../util/ng_reflect';\n import {stringify} from '../../util/stringify';\n import {assertFirstCreatePass, assertFirstUpdatePass, assertLContainer, assertLView, assertTNodeForLView, assertTNodeForTView} from '../assert';\n@@ -1623,8 +1621,7 @@ function generateInitialInputs(inputs: {[key: string]: string}, attrs: TAttribut\n //////////////////////////\n \n // Not sure why I need to do `any` here but TS complains later.\n-const LContainerArray: any = ((typeof ngDevMode === 'undefined' || ngDevMode) && initNgDevMode()) &&\n-    createNamedArrayType('LContainer');\n+const LContainerArray: any = class LContainer extends Array {};\n \n /**\n  * Creates a LContainer, either from a container instruction, or for a ViewContainerRef."
        },
        {
            "sha": "8eef5a817cd70b54bae9ed131948f3c04784b508",
            "filename": "packages/core/test/acceptance/ngdevmode_debug_spec.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 6,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/4f8eaac7ff2b73dd18d6317c955d447011a69301/packages%2Fcore%2Ftest%2Facceptance%2Fngdevmode_debug_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f8eaac7ff2b73dd18d6317c955d447011a69301/packages%2Fcore%2Ftest%2Facceptance%2Fngdevmode_debug_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fngdevmode_debug_spec.ts?ref=4f8eaac7ff2b73dd18d6317c955d447011a69301",
            "patch": "@@ -11,15 +11,28 @@ import {Component} from '@angular/core';\n import {getLContext} from '@angular/core/src/render3/context_discovery';\n import {getComponentLView} from '@angular/core/src/render3/util/discovery_utils';\n import {createNamedArrayType} from '@angular/core/src/util/named_array_type';\n+import {ngDevModeResetPerfCounters} from '@angular/core/src/util/ng_dev_mode';\n import {TestBed} from '@angular/core/testing';\n import {onlyInIvy} from '@angular/private/testing';\n \n-const supportsArraySubclassing =\n-    createNamedArrayType('SupportsArraySubclassing').name === 'SupportsArraySubclassing';\n+class SupportsArraySubclassing extends Array {}\n+\n+// If this is being compiled to ES5 then the array subclass has `Array` as constructor\n+// instead of `SupportsArraySubclassing`.\n+const targetSupportsArraySubclassing =\n+    (new SupportsArraySubclassing()).constructor.name === 'SupportsArraySubclassing';\n+\n+// Creation of a named array types dynamically may succeed even in ES5 targets, as the named array\n+// is created using the Function constructor.\n+const runtimeSupportsArraySubclassing =\n+    (new (createNamedArrayType('SupportsArraySubclassing'))).constructor.name ===\n+    'SupportsArraySubclassing';\n \n onlyInIvy('Debug information exist in ivy only').describe('ngDevMode debug', () => {\n   describe('LViewDebug', () => {\n-    supportsArraySubclassing && it('should name LView based on type', () => {\n+    beforeEach(ngDevModeResetPerfCounters);\n+\n+    runtimeSupportsArraySubclassing && it('should not name LView based on type by default', () => {\n       @Component({\n         template: `\n         <ul>\n@@ -33,16 +46,49 @@ onlyInIvy('Debug information exist in ivy only').describe('ngDevMode debug', ()\n       TestBed.configureTestingModule({declarations: [MyApp], imports: [CommonModule]});\n       const fixture = TestBed.createComponent(MyApp);\n       const rootLView = getLContext(fixture.nativeElement)!.lView;\n-      expect(rootLView.constructor.name).toEqual('LRootView');\n+      expect(rootLView.constructor.name)\n+          .toEqual(targetSupportsArraySubclassing ? 'LRootView' : 'Array');\n \n       const componentLView = getComponentLView(fixture.componentInstance);\n-      expect(componentLView.constructor.name).toEqual('LComponentView_MyApp');\n+      expect(componentLView.constructor.name)\n+          .toEqual(targetSupportsArraySubclassing ? 'LComponentView' : 'Array');\n \n       const element: HTMLElement = fixture.nativeElement;\n       fixture.detectChanges();\n       const li = element.querySelector('li')!;\n       const embeddedLView = getLContext(li)!.lView;\n-      expect(embeddedLView.constructor.name).toEqual('LEmbeddedView_MyApp_li_1');\n+      expect(embeddedLView.constructor.name)\n+          .toEqual(targetSupportsArraySubclassing ? 'LEmbeddedView' : 'Array');\n     });\n+\n+    runtimeSupportsArraySubclassing &&\n+        it('should name LView based on type when namedConstructors is true', () => {\n+          ngDevMode!.namedConstructors = true;\n+\n+          @Component({\n+            template: `\n+            <ul>\n+              <li *ngIf=\"true\">item</li>\n+            </ul>\n+            `\n+          })\n+          class MyApp {\n+          }\n+\n+          TestBed.configureTestingModule({declarations: [MyApp], imports: [CommonModule]});\n+          const fixture = TestBed.createComponent(MyApp);\n+          const rootLView = getLContext(fixture.nativeElement)!.lView;\n+          expect(rootLView.constructor.name)\n+              .toEqual(targetSupportsArraySubclassing ? 'LRootView' : 'Array');\n+\n+          const componentLView = getComponentLView(fixture.componentInstance);\n+          expect(componentLView.constructor.name).toEqual('LComponentView_MyApp');\n+\n+          const element: HTMLElement = fixture.nativeElement;\n+          fixture.detectChanges();\n+          const li = element.querySelector('li')!;\n+          const embeddedLView = getLContext(li)!.lView;\n+          expect(embeddedLView.constructor.name).toEqual('LEmbeddedView_MyApp_li_1');\n+        });\n   });\n });"
        }
    ],
    "stats": {
        "total": 115,
        "additions": 79,
        "deletions": 36
    }
}