{
    "author": "JoostK",
    "message": "refactor(compiler): remove type-casting related output AST types (#44411)\n\nThe Ivy compiler no longer generates code for type-checking purposes\nusing the output AST types. Instead, it uses TypeScript AST nodes and\nits printer for type-checking. This commit removes the type-related\noutput nodes.\n\nPR Close #44411",
    "sha": "8cadfe1f5bc6ac0077550325b57cf3cea47e807f",
    "files": [
        {
            "sha": "72584c0d6599e163ee1c87d969446d4d238c4b92",
            "filename": "packages/compiler-cli/src/ngtsc/translator/src/translator.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 11,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftranslator.ts",
            "raw_url": "https://github.com/angular/angular/raw/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftranslator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftranslator.ts?ref=8cadfe1f5bc6ac0077550325b57cf3cea47e807f",
            "patch": "@@ -60,9 +60,9 @@ export class ExpressionTranslatorVisitor<TStatement, TExpression> implements o.E\n   }\n \n   visitDeclareVarStmt(stmt: o.DeclareVarStmt, context: Context): TStatement {\n-    const varType = this.downlevelVariableDeclarations ?\n-        'var' :\n-        stmt.hasModifier(o.StmtModifier.Final) ? 'const' : 'let';\n+    const varType = this.downlevelVariableDeclarations ? 'var' :\n+        stmt.hasModifier(o.StmtModifier.Final)         ? 'const' :\n+                                                         'let';\n     return this.attachComments(\n         this.factory.createVariableDeclaration(\n             stmt.name, stmt.value?.visitExpression(this, context.withExpressionMode), varType),\n@@ -305,14 +305,6 @@ export class ExpressionTranslatorVisitor<TStatement, TExpression> implements o.E\n     return this.factory.createUnaryExpression('!', ast.condition.visitExpression(this, context));\n   }\n \n-  visitAssertNotNullExpr(ast: o.AssertNotNull, context: Context): TExpression {\n-    return ast.condition.visitExpression(this, context);\n-  }\n-\n-  visitCastExpr(ast: o.CastExpr, context: Context): TExpression {\n-    return ast.value.visitExpression(this, context);\n-  }\n-\n   visitFunctionExpr(ast: o.FunctionExpr, context: Context): TExpression {\n     return this.factory.createFunctionExpression(\n         ast.name ?? null, ast.params.map(param => param.name),"
        },
        {
            "sha": "631eda234f244023f0280a6181c86885d755eab6",
            "filename": "packages/compiler-cli/src/ngtsc/translator/src/type_translator.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftype_translator.ts",
            "raw_url": "https://github.com/angular/angular/raw/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftype_translator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftype_translator.ts?ref=8cadfe1f5bc6ac0077550325b57cf3cea47e807f",
            "patch": "@@ -145,14 +145,6 @@ export class TypeTranslatorVisitor implements o.ExpressionVisitor, o.TypeVisitor\n     throw new Error('Method not implemented.');\n   }\n \n-  visitAssertNotNullExpr(ast: o.AssertNotNull, context: Context) {\n-    throw new Error('Method not implemented.');\n-  }\n-\n-  visitCastExpr(ast: o.CastExpr, context: Context) {\n-    throw new Error('Method not implemented.');\n-  }\n-\n   visitFunctionExpr(ast: o.FunctionExpr, context: Context) {\n     throw new Error('Method not implemented.');\n   }"
        },
        {
            "sha": "59bcd5a0a9f09d04ad6a5851761c340b22426906",
            "filename": "packages/compiler/src/compiler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler.ts?ref=8cadfe1f5bc6ac0077550325b57cf3cea47e807f",
            "patch": "@@ -53,7 +53,7 @@ export * from './ml_parser/tags';\n export {ParseTreeResult, TreeError} from './ml_parser/parser';\n export {LexerRange} from './ml_parser/lexer';\n export * from './ml_parser/xml_parser';\n-export {ArrayType, AssertNotNull, DYNAMIC_TYPE, BinaryOperator, BinaryOperatorExpr, BuiltinType, BuiltinTypeName, CastExpr, ClassField, ClassMethod, ClassStmt, CommaExpr, ConditionalExpr, DeclareFunctionStmt, DeclareVarStmt, Expression, ExpressionStatement, ExpressionType, ExpressionVisitor, ExternalExpr, ExternalReference, literalMap, FunctionExpr, IfStmt, InstantiateExpr, InvokeFunctionExpr, LiteralArrayExpr, LiteralExpr, LiteralMapExpr, MapType, NotExpr, NONE_TYPE, ReadKeyExpr, ReadPropExpr, ReadVarExpr, ReturnStatement, StatementVisitor, TaggedTemplateExpr, TemplateLiteral, TemplateLiteralElement, Type, TypeVisitor, WrappedNodeExpr, WriteKeyExpr, WritePropExpr, WriteVarExpr, StmtModifier, Statement, STRING_TYPE, TypeofExpr, collectExternalReferences, jsDocComment, leadingComment, LeadingComment, JSDocComment, UnaryOperator, UnaryOperatorExpr, LocalizedString} from './output/output_ast';\n+export {ArrayType, DYNAMIC_TYPE, BinaryOperator, BinaryOperatorExpr, BuiltinType, BuiltinTypeName, ClassField, ClassMethod, ClassStmt, CommaExpr, ConditionalExpr, DeclareFunctionStmt, DeclareVarStmt, Expression, ExpressionStatement, ExpressionType, ExpressionVisitor, ExternalExpr, ExternalReference, literalMap, FunctionExpr, IfStmt, InstantiateExpr, InvokeFunctionExpr, LiteralArrayExpr, LiteralExpr, LiteralMapExpr, MapType, NotExpr, NONE_TYPE, ReadKeyExpr, ReadPropExpr, ReadVarExpr, ReturnStatement, StatementVisitor, TaggedTemplateExpr, TemplateLiteral, TemplateLiteralElement, Type, TypeVisitor, WrappedNodeExpr, WriteKeyExpr, WritePropExpr, WriteVarExpr, StmtModifier, Statement, STRING_TYPE, TypeofExpr, collectExternalReferences, jsDocComment, leadingComment, LeadingComment, JSDocComment, UnaryOperator, UnaryOperatorExpr, LocalizedString} from './output/output_ast';\n export {EmitterVisitorContext} from './output/abstract_emitter';\n export {JitEvaluator} from './output/output_jit';\n export * from './parse_util';"
        },
        {
            "sha": "3ca324cece856c11a89006b1b8a81e180521cc52",
            "filename": "packages/compiler/src/compiler_util/expression_converter.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "raw_url": "https://github.com/angular/angular/raw/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts?ref=8cadfe1f5bc6ac0077550325b57cf3cea47e807f",
            "patch": "@@ -445,8 +445,7 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n   }\n \n   visitNonNullAssert(ast: cdAst.NonNullAssert, mode: _Mode): any {\n-    return convertToStatementIfNeeded(\n-        mode, o.assertNotNull(this._visit(ast.expression, _Mode.Expression)));\n+    return convertToStatementIfNeeded(mode, this._visit(ast.expression, _Mode.Expression));\n   }\n \n   visitPropertyRead(ast: cdAst.PropertyRead, mode: _Mode): any {\n@@ -544,10 +543,7 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n         throw new Error(`Invalid call to $any, expected 1 argument but received ${\n             convertedArgs.length || 'none'}`);\n       }\n-      return convertToStatementIfNeeded(\n-          mode,\n-          (convertedArgs[0] as o.Expression)\n-              .cast(o.DYNAMIC_TYPE, this.convertSourceSpan(ast.span)));\n+      return convertToStatementIfNeeded(mode, convertedArgs[0] as o.Expression);\n     }\n \n     const call = this._visit(receiver, _Mode.Expression)"
        },
        {
            "sha": "d956aaad48bfb807056f3407a03530607b214749",
            "filename": "packages/compiler/src/output/abstract_emitter.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_emitter.ts",
            "raw_url": "https://github.com/angular/angular/raw/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_emitter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_emitter.ts?ref=8cadfe1f5bc6ac0077550325b57cf3cea47e807f",
            "patch": "@@ -226,8 +226,6 @@ export abstract class AbstractEmitterVisitor implements o.StatementVisitor, o.Ex\n     return null;\n   }\n \n-  abstract visitCastExpr(ast: o.CastExpr, context: any): any;\n-\n   abstract visitDeclareClassStmt(stmt: o.ClassStmt, ctx: EmitterVisitorContext): any;\n \n   visitIfStmt(stmt: o.IfStmt, ctx: EmitterVisitorContext): any {\n@@ -377,10 +375,6 @@ export abstract class AbstractEmitterVisitor implements o.StatementVisitor, o.Ex\n     ast.condition.visitExpression(this, ctx);\n     return null;\n   }\n-  visitAssertNotNullExpr(ast: o.AssertNotNull, ctx: EmitterVisitorContext): any {\n-    ast.condition.visitExpression(this, ctx);\n-    return null;\n-  }\n   abstract visitFunctionExpr(ast: o.FunctionExpr, ctx: EmitterVisitorContext): any;\n   abstract visitDeclareFunctionStmt(stmt: o.DeclareFunctionStmt, context: any): any;\n "
        },
        {
            "sha": "592ac0df78ade4b3ea167c116f4a9091aaefa9cb",
            "filename": "packages/compiler/src/output/abstract_js_emitter.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_js_emitter.ts",
            "raw_url": "https://github.com/angular/angular/raw/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_js_emitter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_js_emitter.ts?ref=8cadfe1f5bc6ac0077550325b57cf3cea47e807f",
            "patch": "@@ -100,10 +100,6 @@ export abstract class AbstractJsEmitterVisitor extends AbstractEmitterVisitor {\n     ctx.println(stmt, `;`);\n     return null;\n   }\n-  override visitCastExpr(ast: o.CastExpr, ctx: EmitterVisitorContext): any {\n-    ast.value.visitExpression(this, ctx);\n-    return null;\n-  }\n   override visitTaggedTemplateExpr(ast: o.TaggedTemplateExpr, ctx: EmitterVisitorContext): any {\n     // The following convoluted piece of code is effectively the downlevelled equivalent of\n     // ```"
        },
        {
            "sha": "3cb8b333f92d50bea17bafbc49b8e79293c0156e",
            "filename": "packages/compiler/src/output/output_ast.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 64,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/8cadfe1f5bc6ac0077550325b57cf3cea47e807f/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts?ref=8cadfe1f5bc6ac0077550325b57cf3cea47e807f",
            "patch": "@@ -248,9 +248,6 @@ export abstract class Expression {\n     // We use the typed null to allow strictNullChecks to narrow types.\n     return this.equals(TYPED_NULL_EXPR, sourceSpan);\n   }\n-  cast(type: Type, sourceSpan?: ParseSourceSpan|null): Expression {\n-    return new CastExpr(this, type, sourceSpan);\n-  }\n   nullishCoalesce(rhs: Expression, sourceSpan?: ParseSourceSpan|null): BinaryOperatorExpr {\n     return new BinaryOperatorExpr(BinaryOperator.NullishCoalesce, this, rhs, null, sourceSpan);\n   }\n@@ -722,43 +719,6 @@ export class NotExpr extends Expression {\n   }\n }\n \n-export class AssertNotNull extends Expression {\n-  constructor(public condition: Expression, sourceSpan?: ParseSourceSpan|null) {\n-    super(condition.type, sourceSpan);\n-  }\n-\n-  override isEquivalent(e: Expression): boolean {\n-    return e instanceof AssertNotNull && this.condition.isEquivalent(e.condition);\n-  }\n-\n-  override isConstant() {\n-    return false;\n-  }\n-\n-  override visitExpression(visitor: ExpressionVisitor, context: any): any {\n-    return visitor.visitAssertNotNullExpr(this, context);\n-  }\n-}\n-\n-export class CastExpr extends Expression {\n-  constructor(public value: Expression, type?: Type|null, sourceSpan?: ParseSourceSpan|null) {\n-    super(type, sourceSpan);\n-  }\n-\n-  override isEquivalent(e: Expression): boolean {\n-    return e instanceof CastExpr && this.value.isEquivalent(e.value);\n-  }\n-\n-  override isConstant() {\n-    return false;\n-  }\n-\n-  override visitExpression(visitor: ExpressionVisitor, context: any): any {\n-    return visitor.visitCastExpr(this, context);\n-  }\n-}\n-\n-\n export class FnParam {\n   constructor(public name: string, public type: Type|null = null) {}\n \n@@ -973,8 +933,6 @@ export interface ExpressionVisitor {\n   visitExternalExpr(ast: ExternalExpr, context: any): any;\n   visitConditionalExpr(ast: ConditionalExpr, context: any): any;\n   visitNotExpr(ast: NotExpr, context: any): any;\n-  visitAssertNotNullExpr(ast: AssertNotNull, context: any): any;\n-  visitCastExpr(ast: CastExpr, context: any): any;\n   visitFunctionExpr(ast: FunctionExpr, context: any): any;\n   visitUnaryOperatorExpr(ast: UnaryOperatorExpr, context: any): any;\n   visitBinaryOperatorExpr(ast: BinaryOperatorExpr, context: any): any;\n@@ -1293,16 +1251,6 @@ export class AstTransformer implements StatementVisitor, ExpressionVisitor {\n         new NotExpr(ast.condition.visitExpression(this, context), ast.sourceSpan), context);\n   }\n \n-  visitAssertNotNullExpr(ast: AssertNotNull, context: any): any {\n-    return this.transformExpr(\n-        new AssertNotNull(ast.condition.visitExpression(this, context), ast.sourceSpan), context);\n-  }\n-\n-  visitCastExpr(ast: CastExpr, context: any): any {\n-    return this.transformExpr(\n-        new CastExpr(ast.value.visitExpression(this, context), ast.type, ast.sourceSpan), context);\n-  }\n-\n   visitFunctionExpr(ast: FunctionExpr, context: any): any {\n     return this.transformExpr(\n         new FunctionExpr(\n@@ -1515,14 +1463,6 @@ export class RecursiveAstVisitor implements StatementVisitor, ExpressionVisitor\n     ast.condition.visitExpression(this, context);\n     return this.visitExpression(ast, context);\n   }\n-  visitAssertNotNullExpr(ast: AssertNotNull, context: any): any {\n-    ast.condition.visitExpression(this, context);\n-    return this.visitExpression(ast, context);\n-  }\n-  visitCastExpr(ast: CastExpr, context: any): any {\n-    ast.value.visitExpression(this, context);\n-    return this.visitExpression(ast, context);\n-  }\n   visitFunctionExpr(ast: FunctionExpr, context: any): any {\n     this.visitAllStatements(ast.statements, context);\n     return this.visitExpression(ast, context);\n@@ -1747,10 +1687,6 @@ export function not(expr: Expression, sourceSpan?: ParseSourceSpan|null): NotExp\n   return new NotExpr(expr, sourceSpan);\n }\n \n-export function assertNotNull(expr: Expression, sourceSpan?: ParseSourceSpan|null): AssertNotNull {\n-  return new AssertNotNull(expr, sourceSpan);\n-}\n-\n export function fn(\n     params: FnParam[], body: Statement[], type?: Type|null, sourceSpan?: ParseSourceSpan|null,\n     name?: string|null): FunctionExpr {"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 6,
        "deletions": 100
    }
}