{
    "author": "petebacondarwin",
    "message": "feat(localize): expose `canParse()` diagnostics (#37909)\n\nWhen loading a translation file we ask each `TranslationParser`\nwhether it can parse the file. Occasionally, this check can find\nerrors in the file that would be useful to the developer. For example\nif the file has invalid XML.\n\nThis commit deprecates the previous `canParse()` method and replaces it\nwith a new `analyze()` method. This returns an object that includes a\nboolean `canParse` and then either a `hint` if it can parse the file,\nor a `diagnostics` object filled with any messages that can be used to\ndiagnose problems with the format of the file.\n\nCloses #37901\n\nPR Close #37909",
    "sha": "ec32eba02c411b363b1195dfb84781bec05747a8",
    "files": [
        {
            "sha": "8323c0821a7a3b83e8e73804669e2ee4ac19752a",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_loader.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 7,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_loader.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_loader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_loader.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -9,7 +9,7 @@ import {AbsoluteFsPath, FileSystem} from '@angular/compiler-cli/src/ngtsc/file_s\n import {DiagnosticHandlingStrategy, Diagnostics} from '../../diagnostics';\n import {TranslationBundle} from '../translator';\n \n-import {TranslationParser} from './translation_parsers/translation_parser';\n+import {ParseAnalysis, TranslationParser} from './translation_parsers/translation_parser';\n \n /**\n  * Use this class to load a collection of translation files from disk.\n@@ -57,14 +57,16 @@ export class TranslationLoader {\n   private loadBundle(filePath: AbsoluteFsPath, providedLocale: string|undefined):\n       TranslationBundle {\n     const fileContents = this.fs.readFile(filePath);\n+    const unusedParsers = new Map<TranslationParser<any>, ParseAnalysis<any>>();\n     for (const translationParser of this.translationParsers) {\n-      const result = translationParser.canParse(filePath, fileContents);\n-      if (!result) {\n+      const result = translationParser.analyze(filePath, fileContents);\n+      if (!result.canParse) {\n+        unusedParsers.set(translationParser, result);\n         continue;\n       }\n \n       const {locale: parsedLocale, translations, diagnostics} =\n-          translationParser.parse(filePath, fileContents, result);\n+          translationParser.parse(filePath, fileContents, result.hint);\n       if (diagnostics.hasErrors) {\n         throw new Error(diagnostics.formatDiagnostics(\n             `The translation file \"${filePath}\" could not be parsed.`));\n@@ -90,13 +92,20 @@ export class TranslationLoader {\n \n       return {locale, translations, diagnostics};\n     }\n+\n+    const diagnosticsMessages: string[] = [];\n+    for (const [parser, result] of unusedParsers.entries()) {\n+      diagnosticsMessages.push(result.diagnostics.formatDiagnostics(\n+          `\\n${parser.constructor.name} cannot parse translation file.`));\n+    }\n     throw new Error(\n-        `There is no \"TranslationParser\" that can parse this translation file: ${filePath}.`);\n+        `There is no \"TranslationParser\" that can parse this translation file: ${filePath}.` +\n+        diagnosticsMessages.join('\\n'));\n   }\n \n   /**\n-   * There is more than one `filePath` for this locale, so load each as a bundle and then merge them\n-   * all together.\n+   * There is more than one `filePath` for this locale, so load each as a bundle and then merge\n+   * them all together.\n    */\n   private mergeBundles(filePaths: AbsoluteFsPath[], providedLocale: string|undefined):\n       TranslationBundle {"
        },
        {
            "sha": "2ee09b5fac23dfb10aec1cac71410812bf586302",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/simple_json_translation_parser.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 5,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fsimple_json_translation_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fsimple_json_translation_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fsimple_json_translation_parser.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -8,7 +8,8 @@\n import {ɵMessageId, ɵParsedTranslation, ɵparseTranslation} from '@angular/localize';\n import {extname} from 'path';\n import {Diagnostics} from '../../../diagnostics';\n-import {ParsedTranslationBundle, TranslationParser} from './translation_parser';\n+\n+import {ParseAnalysis, ParsedTranslationBundle, TranslationParser} from './translation_parser';\n \n /**\n  * A translation parser that can parse JSON that has the form:\n@@ -26,15 +27,42 @@ import {ParsedTranslationBundle, TranslationParser} from './translation_parser';\n  * @see SimpleJsonTranslationSerializer\n  */\n export class SimpleJsonTranslationParser implements TranslationParser<Object> {\n+  /**\n+   * @deprecated\n+   */\n   canParse(filePath: string, contents: string): Object|false {\n+    const result = this.analyze(filePath, contents);\n+    return result.canParse && result.hint;\n+  }\n+\n+  analyze(filePath: string, contents: string): ParseAnalysis<Object> {\n+    const diagnostics = new Diagnostics();\n     if (extname(filePath) !== '.json') {\n-      return false;\n+      diagnostics.warn('File does not have .json extension.');\n+      return {canParse: false, diagnostics};\n     }\n     try {\n       const json = JSON.parse(contents);\n-      return (typeof json.locale === 'string' && typeof json.translations === 'object') && json;\n-    } catch {\n-      return false;\n+      if (json.locale === undefined) {\n+        diagnostics.warn('Required \"locale\" property missing.');\n+        return {canParse: false, diagnostics};\n+      }\n+      if (typeof json.locale !== 'string') {\n+        diagnostics.warn('The \"locale\" property is not a string.');\n+        return {canParse: false, diagnostics};\n+      }\n+      if (json.translations === undefined) {\n+        diagnostics.warn('Required \"translations\" property missing.');\n+        return {canParse: false, diagnostics};\n+      }\n+      if (typeof json.translations !== 'object') {\n+        diagnostics.warn('The \"translations\" is not an object.');\n+        return {canParse: false, diagnostics};\n+      }\n+      return {canParse: true, diagnostics, hint: json};\n+    } catch (e) {\n+      diagnostics.warn('File is not valid JSON.');\n+      return {canParse: false, diagnostics};\n     }\n   }\n "
        },
        {
            "sha": "514ff7bdecfb6fee1e81377bf19e6ea2ef92caf9",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/translation_parser.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_parser.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -8,6 +8,29 @@\n import {ɵMessageId, ɵParsedTranslation} from '@angular/localize/private';\n import {Diagnostics} from '../../../diagnostics';\n \n+/**\n+ * Indicates that a parser can parse a given file, with a hint that can be used to speed up actual\n+ * parsing.\n+ */\n+export interface CanParseAnalysis<Hint> {\n+  canParse: true;\n+  diagnostics: Diagnostics;\n+  hint: Hint;\n+}\n+\n+/**\n+ * Indicates that a parser cannot parse a given file with diagnostics as why this is.\n+ * */\n+export interface CannotParseAnalysis {\n+  canParse: false;\n+  diagnostics: Diagnostics;\n+}\n+\n+/**\n+ * Information about whether a `TranslationParser` can parse a given file.\n+ */\n+export type ParseAnalysis<Hint> = CanParseAnalysis<Hint>|CannotParseAnalysis;\n+\n /**\n  * An object that holds translations that have been parsed from a translation file.\n  */\n@@ -38,13 +61,24 @@ export interface TranslationParser<Hint = true> {\n   /**\n    * Can this parser parse the given file?\n    *\n+   * @deprecated Use `analyze()` instead\n+   *\n    * @param filePath The absolute path to the translation file.\n    * @param contents The contents of the translation file.\n    * @returns A hint, which can be used in doing the actual parsing, if the file can be parsed by\n    * this parser; false otherwise.\n    */\n   canParse(filePath: string, contents: string): Hint|false;\n \n+  /**\n+   * Analyze the file to see if this parser can parse the given file.\n+   *\n+   * @param filePath The absolute path to the translation file.\n+   * @param contents The contents of the translation file.\n+   * @returns Information indicating whether the file can be parsed by this parser.\n+   */\n+  analyze(filePath: string, contents: string): ParseAnalysis<Hint>;\n+\n   /**\n    * Parses the given file, extracting the target locale and translations.\n    *"
        },
        {
            "sha": "e45738740fc1353481e0c77384d9c71d4e61302b",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/translation_utils.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_utils.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -8,6 +8,7 @@\n import {Element, LexerRange, Node, ParseError, ParseErrorLevel, ParseSourceSpan, XmlParser} from '@angular/compiler';\n import {Diagnostics} from '../../../diagnostics';\n import {TranslationParseError} from './translation_parse_error';\n+import {ParseAnalysis} from './translation_parser';\n \n export function getAttrOrThrow(element: Element, attrName: string): string {\n   const attrValue = getAttribute(element, attrName);\n@@ -81,25 +82,33 @@ export interface XmlTranslationParserHint {\n  */\n export function canParseXml(\n     filePath: string, contents: string, rootNodeName: string,\n-    attributes: Record<string, string>): XmlTranslationParserHint|false {\n+    attributes: Record<string, string>): ParseAnalysis<XmlTranslationParserHint> {\n+  const diagnostics = new Diagnostics();\n   const xmlParser = new XmlParser();\n   const xml = xmlParser.parse(contents, filePath);\n \n   if (xml.rootNodes.length === 0 ||\n       xml.errors.some(error => error.level === ParseErrorLevel.ERROR)) {\n-    return false;\n+    xml.errors.forEach(e => addParseError(diagnostics, e));\n+    return {canParse: false, diagnostics};\n   }\n \n   const rootElements = xml.rootNodes.filter(isNamedElement(rootNodeName));\n   const rootElement = rootElements[0];\n   if (rootElement === undefined) {\n-    return false;\n+    diagnostics.warn(`The XML file does not contain a <${rootNodeName}> root node.`);\n+    return {canParse: false, diagnostics};\n   }\n \n   for (const attrKey of Object.keys(attributes)) {\n     const attr = rootElement.attrs.find(attr => attr.name === attrKey);\n     if (attr === undefined || attr.value !== attributes[attrKey]) {\n-      return false;\n+      addParseDiagnostic(\n+          diagnostics, rootElement.sourceSpan,\n+          `The <${rootNodeName}> node does not have the required attribute: ${attrKey}=\"${\n+              attributes[attrKey]}\".`,\n+          ParseErrorLevel.WARNING);\n+      return {canParse: false, diagnostics};\n     }\n   }\n \n@@ -110,7 +119,7 @@ export function canParseXml(\n         ParseErrorLevel.WARNING));\n   }\n \n-  return {element: rootElement, errors: xml.errors};\n+  return {canParse: true, diagnostics, hint: {element: rootElement, errors: xml.errors}};\n }\n \n /**"
        },
        {
            "sha": "0f0636b10e1ed373223464310cc419ee01c7c289",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/xliff1_translation_parser.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -13,7 +13,7 @@ import {BaseVisitor} from '../base_visitor';\n import {MessageSerializer} from '../message_serialization/message_serializer';\n import {TargetMessageRenderer} from '../message_serialization/target_message_renderer';\n \n-import {ParsedTranslationBundle, TranslationParser} from './translation_parser';\n+import {ParseAnalysis, ParsedTranslationBundle, TranslationParser} from './translation_parser';\n import {addParseDiagnostic, addParseError, canParseXml, getAttribute, isNamedElement, parseInnerRange, XmlTranslationParserHint} from './translation_utils';\n \n /**\n@@ -25,7 +25,15 @@ import {addParseDiagnostic, addParseError, canParseXml, getAttribute, isNamedEle\n  * @see Xliff1TranslationSerializer\n  */\n export class Xliff1TranslationParser implements TranslationParser<XmlTranslationParserHint> {\n+  /**\n+   * @deprecated\n+   */\n   canParse(filePath: string, contents: string): XmlTranslationParserHint|false {\n+    const result = this.analyze(filePath, contents);\n+    return result.canParse && result.hint;\n+  }\n+\n+  analyze(filePath: string, contents: string): ParseAnalysis<XmlTranslationParserHint> {\n     return canParseXml(filePath, contents, 'xliff', {version: '1.2'});\n   }\n "
        },
        {
            "sha": "5304665cde804bb68721c4709555bb5bc09703c1",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/xliff2_translation_parser.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -13,7 +13,7 @@ import {BaseVisitor} from '../base_visitor';\n import {MessageSerializer} from '../message_serialization/message_serializer';\n import {TargetMessageRenderer} from '../message_serialization/target_message_renderer';\n \n-import {ParsedTranslationBundle, TranslationParser} from './translation_parser';\n+import {ParseAnalysis, ParsedTranslationBundle, TranslationParser} from './translation_parser';\n import {addParseDiagnostic, addParseError, canParseXml, getAttribute, isNamedElement, parseInnerRange, XmlTranslationParserHint} from './translation_utils';\n \n /**\n@@ -24,7 +24,15 @@ import {addParseDiagnostic, addParseError, canParseXml, getAttribute, isNamedEle\n  * @see Xliff2TranslationSerializer\n  */\n export class Xliff2TranslationParser implements TranslationParser<XmlTranslationParserHint> {\n+  /**\n+   * @deprecated\n+   */\n   canParse(filePath: string, contents: string): XmlTranslationParserHint|false {\n+    const result = this.analyze(filePath, contents);\n+    return result.canParse && result.hint;\n+  }\n+\n+  analyze(filePath: string, contents: string): ParseAnalysis<XmlTranslationParserHint> {\n     return canParseXml(filePath, contents, 'xliff', {version: '2.0'});\n   }\n "
        },
        {
            "sha": "e20260896eb8c3621d2bd3329d0aef9e06dc594d",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/xtb_translation_parser.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -14,7 +14,7 @@ import {BaseVisitor} from '../base_visitor';\n import {MessageSerializer} from '../message_serialization/message_serializer';\n import {TargetMessageRenderer} from '../message_serialization/target_message_renderer';\n \n-import {ParsedTranslationBundle, TranslationParser} from './translation_parser';\n+import {ParseAnalysis, ParsedTranslationBundle, TranslationParser} from './translation_parser';\n import {addParseDiagnostic, addParseError, canParseXml, getAttribute, parseInnerRange, XmlTranslationParserHint} from './translation_utils';\n \n \n@@ -26,10 +26,20 @@ import {addParseDiagnostic, addParseError, canParseXml, getAttribute, parseInner\n  * @see XmbTranslationSerializer\n  */\n export class XtbTranslationParser implements TranslationParser<XmlTranslationParserHint> {\n+  /**\n+   * @deprecated\n+   */\n   canParse(filePath: string, contents: string): XmlTranslationParserHint|false {\n+    const result = this.analyze(filePath, contents);\n+    return result.canParse && result.hint;\n+  }\n+\n+  analyze(filePath: string, contents: string): ParseAnalysis<XmlTranslationParserHint> {\n     const extension = extname(filePath);\n     if (extension !== '.xtb' && extension !== '.xmb') {\n-      return false;\n+      const diagnostics = new Diagnostics();\n+      diagnostics.warn('Must have xtb or xmb extension.');\n+      return {canParse: false, diagnostics};\n     }\n     return canParseXml(filePath, contents, 'translationbundle', {});\n   }\n@@ -81,7 +91,7 @@ class XtbVisitor extends BaseVisitor {\n         if (id === undefined) {\n           addParseDiagnostic(\n               bundle.diagnostics, element.sourceSpan,\n-              `Missing required \"id\" attribute on <trans-unit> element.`, ParseErrorLevel.ERROR);\n+              `Missing required \"id\" attribute on <translation> element.`, ParseErrorLevel.ERROR);\n           return;\n         }\n "
        },
        {
            "sha": "0c52eba69c16e1d980111c0d132b41f865610ea0",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_loader_spec.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_loader_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_loader_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_loader_spec.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -12,7 +12,7 @@ import {ɵParsedTranslation, ɵparseTranslation} from '@angular/localize';\n import {DiagnosticHandlingStrategy, Diagnostics} from '../../../src/diagnostics';\n import {TranslationLoader} from '../../../src/translate/translation_files/translation_loader';\n import {SimpleJsonTranslationParser} from '../../../src/translate/translation_files/translation_parsers/simple_json_translation_parser';\n-import {TranslationParser} from '../../../src/translate/translation_files/translation_parsers/translation_parser';\n+import {ParseAnalysis, TranslationParser} from '../../../src/translate/translation_files/translation_parsers/translation_parser';\n \n runInEachFileSystem(() => {\n   describe('TranslationLoader', () => {\n@@ -204,8 +204,11 @@ runInEachFileSystem(() => {\n         const parser = new MockTranslationParser(neverCanParse);\n         const loader = new TranslationLoader(fs, [parser], 'error', diagnostics);\n         expect(() => loader.loadBundles([[enTranslationPath], [frTranslationPath]], []))\n-            .toThrowError(`There is no \"TranslationParser\" that can parse this translation file: ${\n-                enTranslationPath}.`);\n+            .toThrowError(\n+                `There is no \"TranslationParser\" that can parse this translation file: ${\n+                    enTranslationPath}.\\n` +\n+                `MockTranslationParser cannot parse translation file.\\n` +\n+                `WARNINGS:\\n - This is a mock failure warning.`);\n       });\n     });\n   });\n@@ -217,8 +220,16 @@ runInEachFileSystem(() => {\n         private _translations: Record<string, ɵParsedTranslation> = {}) {}\n \n     canParse(filePath: string, fileContents: string) {\n+      const result = this.analyze(filePath, fileContents);\n+      return result.canParse && result.hint;\n+    }\n+\n+    analyze(filePath: string, fileContents: string): ParseAnalysis<true> {\n+      const diagnostics = new Diagnostics();\n+      diagnostics.warn('This is a mock failure warning.');\n       this.log.push(`canParse(${filePath}, ${fileContents})`);\n-      return this._canParse(filePath);\n+      return this._canParse(filePath) ? {canParse: true, hint: true, diagnostics} :\n+                                        {canParse: false, diagnostics};\n     }\n \n     parse(filePath: string, fileContents: string) {"
        },
        {
            "sha": "20567a5465ef88a9460a83f100d40fba503cb024",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_parsers/simple_json_spec.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fsimple_json_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fsimple_json_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fsimple_json_spec.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -23,6 +23,29 @@ describe('SimpleJsonTranslationParser', () => {\n        });\n   });\n \n+  describe('analyze()', () => {\n+    it('should return a success object if the file extension  is `.json` and contains top level `locale` and `translations` properties',\n+       () => {\n+         const parser = new SimpleJsonTranslationParser();\n+         expect(parser.analyze('/some/file.json', '{ \"locale\" : \"fr\", \"translations\" : {}}'))\n+             .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+       });\n+\n+    it('should return a failure object if the file is not a valid format', () => {\n+      const parser = new SimpleJsonTranslationParser();\n+      expect(parser.analyze('/some/file.xlf', '')).toEqual(jasmine.objectContaining({\n+        canParse: false\n+      }));\n+      expect(parser.analyze('/some/file.json', '{}')).toEqual(jasmine.objectContaining({\n+        canParse: false\n+      }));\n+      expect(parser.analyze('/some/file.json', '{ \"translations\" : {} }'))\n+          .toEqual(jasmine.objectContaining({canParse: false}));\n+      expect(parser.analyze('/some/file.json', '{ \"locale\" : \"fr\" }'))\n+          .toEqual(jasmine.objectContaining({canParse: false}));\n+    });\n+  });\n+\n   for (const withHint of [true, false]) {\n     describe(`parse() [${withHint ? 'with' : 'without'} hint]`, () => {\n       const doParse: (fileName: string, contents: string) => ParsedTranslationBundle ="
        },
        {
            "sha": "de347c5de8cd7290c9a32edb35b43b80af14cf79",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_parsers/xliff1_translation_parser_spec.ts",
            "status": "modified",
            "additions": 55,
            "deletions": 1,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser_spec.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {ɵcomputeMsgId, ɵmakeParsedTranslation} from '@angular/localize';\n-import {ParsedTranslationBundle} from '../../../../src/translate/translation_files/translation_parsers/translation_parser';\n+import {ParseAnalysis, ParsedTranslationBundle} from '../../../../src/translate/translation_files/translation_parsers/translation_parser';\n import {Xliff1TranslationParser} from '../../../../src/translate/translation_files/translation_parsers/xliff1_translation_parser';\n \n describe('Xliff1TranslationParser', () => {\n@@ -31,6 +31,60 @@ describe('Xliff1TranslationParser', () => {\n        });\n   });\n \n+  describe('analyze()', () => {\n+    it('should return a success object if the file contains an <xliff> element with version=\"1.2\" attribute',\n+       () => {\n+         const parser = new Xliff1TranslationParser();\n+         expect(parser.analyze('/some/file.xlf', '<xliff version=\"1.2\">'))\n+             .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+         expect(parser.analyze('/some/file.json', '<xliff version=\"1.2\">'))\n+             .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+         expect(parser.analyze('/some/file.xliff', '<xliff version=\"1.2\">'))\n+             .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+         expect(parser.analyze('/some/file.json', '<xliff version=\"1.2\">'))\n+             .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+       });\n+\n+    it('should return a failure object if the file cannot be parsed as XLIFF 1.2', () => {\n+      const parser = new Xliff1TranslationParser();\n+      expect(parser.analyze('/some/file.xlf', '<xliff>')).toEqual(jasmine.objectContaining({\n+        canParse: false\n+      }));\n+      expect(parser.analyze('/some/file.xlf', '<xliff version=\"2.0\">'))\n+          .toEqual(jasmine.objectContaining({canParse: false}));\n+      expect(parser.analyze('/some/file.xlf', '')).toEqual(jasmine.objectContaining({\n+        canParse: false\n+      }));\n+      expect(parser.analyze('/some/file.json', '')).toEqual(jasmine.objectContaining({\n+        canParse: false\n+      }));\n+    });\n+\n+    it('should return a diagnostics object when the file is not a valid format', () => {\n+      let result: ParseAnalysis<any>;\n+      const parser = new Xliff1TranslationParser();\n+\n+      result = parser.analyze('/some/file.xlf', '<moo>');\n+      expect(result.diagnostics.messages).toEqual([\n+        {type: 'warning', message: 'The XML file does not contain a <xliff> root node.'}\n+      ]);\n+\n+      result = parser.analyze('/some/file.xlf', '<xliff version=\"2.0\">');\n+      expect(result.diagnostics.messages).toEqual([{\n+        type: 'warning',\n+        message:\n+            'The <xliff> node does not have the required attribute: version=\"1.2\". (\"[WARNING ->]<xliff version=\"2.0\">\"): /some/file.xlf@0:0'\n+      }]);\n+\n+      result = parser.analyze('/some/file.xlf', '<xliff version=\"1.2\"></file>');\n+      expect(result.diagnostics.messages).toEqual([{\n+        type: 'error',\n+        message:\n+            'Unexpected closing tag \"file\". It may happen when the tag has already been closed by another tag. For more info see https://www.w3.org/TR/html5/syntax.html#closing-elements-that-have-implied-end-tags (\"<xliff version=\"1.2\">[ERROR ->]</file>\"): /some/file.xlf@0:21'\n+      }]);\n+    });\n+  });\n+\n   for (const withHint of [true, false]) {\n     describe(`parse() [${withHint ? 'with' : 'without'} hint]`, () => {\n       const doParse: (fileName: string, XLIFF: string) => ParsedTranslationBundle ="
        },
        {
            "sha": "82ef7484adbb685b8c303b95cae17e2fdcf6b075",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_parsers/xliff2_translation_parser_spec.ts",
            "status": "modified",
            "additions": 59,
            "deletions": 1,
            "changes": 60,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser_spec.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {ɵcomputeMsgId, ɵmakeParsedTranslation} from '@angular/localize';\n-import {ParsedTranslationBundle} from '../../../../src/translate/translation_files/translation_parsers/translation_parser';\n+import {ParseAnalysis, ParsedTranslationBundle} from '../../../../src/translate/translation_files/translation_parsers/translation_parser';\n import {Xliff2TranslationParser} from '../../../../src/translate/translation_files/translation_parsers/xliff2_translation_parser';\n \n describe(\n@@ -32,6 +32,64 @@ describe(\n            });\n       });\n \n+      describe('analyze', () => {\n+        it('should return a success object if the file contains an <xliff> element with version=\"2.0\" attribute',\n+           () => {\n+             const parser = new Xliff2TranslationParser();\n+             expect(parser.analyze(\n+                        '/some/file.xlf',\n+                        '<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\">'))\n+                 .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+             expect(parser.analyze(\n+                        '/some/file.json',\n+                        '<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\">'))\n+                 .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+             expect(parser.analyze('/some/file.xliff', '<xliff version=\"2.0\">'))\n+                 .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+             expect(parser.analyze('/some/file.json', '<xliff version=\"2.0\">'))\n+                 .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+           });\n+\n+        it('should return a failure object if the file cannot be parsed as XLIFF 2.0', () => {\n+          const parser = new Xliff2TranslationParser();\n+          expect(parser.analyze('/some/file.xlf', '<xliff>')).toEqual(jasmine.objectContaining({\n+            canParse: false\n+          }));\n+          expect(parser.analyze('/some/file.xlf', '<xliff version=\"1.2\">'))\n+              .toEqual(jasmine.objectContaining({canParse: false}));\n+          expect(parser.analyze('/some/file.xlf', '')).toEqual(jasmine.objectContaining({\n+            canParse: false\n+          }));\n+          expect(parser.analyze('/some/file.json', '')).toEqual(jasmine.objectContaining({\n+            canParse: false\n+          }));\n+        });\n+\n+        it('should return a diagnostics object when the file is not a valid format', () => {\n+          let result: ParseAnalysis<any>;\n+          const parser = new Xliff2TranslationParser();\n+\n+          result = parser.analyze('/some/file.xlf', '<moo>');\n+          expect(result.diagnostics.messages).toEqual([\n+            {type: 'warning', message: 'The XML file does not contain a <xliff> root node.'}\n+          ]);\n+\n+          result = parser.analyze('/some/file.xlf', '<xliff version=\"1.2\">');\n+          expect(result.diagnostics.messages).toEqual([{\n+            type: 'warning',\n+            message:\n+                'The <xliff> node does not have the required attribute: version=\"2.0\". (\"[WARNING ->]<xliff version=\"1.2\">\"): /some/file.xlf@0:0'\n+          }]);\n+\n+          result = parser.analyze('/some/file.xlf', '<xliff version=\"2.0\"></file>');\n+          expect(result.diagnostics.messages).toEqual([{\n+            type: 'error',\n+            message:\n+                'Unexpected closing tag \"file\". It may happen when the tag has already been closed by another tag. For more info see https://www.w3.org/TR/html5/syntax.html#closing-elements-that-have-implied-end-tags (\"<xliff version=\"2.0\">[ERROR ->]</file>\"): /some/file.xlf@0:21'\n+          }]);\n+        });\n+      });\n+\n       for (const withHint of [true, false]) {\n         describe(\n             `parse() [${withHint ? 'with' : 'without'} hint]`, () => {"
        },
        {
            "sha": "77a568044d1c95cd652bf3ebf9b8d538152ddad0",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_parsers/xtb_translation_parser_spec.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 2,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec32eba02c411b363b1195dfb84781bec05747a8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser_spec.ts?ref=ec32eba02c411b363b1195dfb84781bec05747a8",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {ɵcomputeMsgId, ɵmakeParsedTranslation} from '@angular/localize';\n-import {ParsedTranslationBundle} from '../../../../src/translate/translation_files/translation_parsers/translation_parser';\n+import {ParseAnalysis, ParsedTranslationBundle} from '../../../../src/translate/translation_files/translation_parsers/translation_parser';\n import {XtbTranslationParser} from '../../../../src/translate/translation_files/translation_parsers/xtb_translation_parser';\n \n describe('XtbTranslationParser', () => {\n@@ -24,6 +24,50 @@ describe('XtbTranslationParser', () => {\n        });\n   });\n \n+  describe('analyze()', () => {\n+    it('should return a success object if the file extension is `.xtb` or `.xmb` and it contains the `<translationbundle>` tag',\n+       () => {\n+         const parser = new XtbTranslationParser();\n+         expect(parser.analyze('/some/file.xtb', '<translationbundle>'))\n+             .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+         expect(parser.analyze('/some/file.xmb', '<translationbundle>'))\n+             .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+         expect(parser.analyze('/some/file.xtb', '<translationbundle lang=\"en\">'))\n+             .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+         expect(parser.analyze('/some/file.xmb', '<translationbundle lang=\"en\">'))\n+             .toEqual(jasmine.objectContaining({canParse: true, hint: jasmine.any(Object)}));\n+       });\n+\n+    it('should return a failure object if the file is not valid XTB', () => {\n+      const parser = new XtbTranslationParser();\n+      expect(parser.analyze('/some/file.json', '<translationbundle>'))\n+          .toEqual(jasmine.objectContaining({canParse: false}));\n+      expect(parser.analyze('/some/file.xmb', '')).toEqual(jasmine.objectContaining({\n+        canParse: false\n+      }));\n+      expect(parser.analyze('/some/file.xtb', '')).toEqual(jasmine.objectContaining({\n+        canParse: false\n+      }));\n+    });\n+\n+    it('should return a diagnostics object when the file is not a valid format', () => {\n+      let results: ParseAnalysis<any>;\n+      const parser = new XtbTranslationParser();\n+\n+      results = parser.analyze('/some/file.xtb', '<moo>');\n+      expect(results.diagnostics.messages).toEqual([\n+        {type: 'warning', message: 'The XML file does not contain a <translationbundle> root node.'}\n+      ]);\n+\n+      results = parser.analyze('/some/file.xtb', '<translationbundle></translation>');\n+      expect(results.diagnostics.messages).toEqual([{\n+        type: 'error',\n+        message:\n+            'Unexpected closing tag \"translation\". It may happen when the tag has already been closed by another tag. For more info see https://www.w3.org/TR/html5/syntax.html#closing-elements-that-have-implied-end-tags (\"<translationbundle>[ERROR ->]</translation>\"): /some/file.xtb@0:19'\n+      }]);\n+    });\n+  });\n+\n   for (const withHint of [true, false]) {\n     describe(`parse() [${withHint ? 'with' : 'without'} hint]`, () => {\n       const doParse: (fileName: string, XTB: string) => ParsedTranslationBundle =\n@@ -261,7 +305,7 @@ describe('XtbTranslationParser', () => {\n           ].join('\\n');\n \n           expectToFail('/some/file.xtb', XTB, /Missing required \"id\" attribute/, [\n-            `Missing required \"id\" attribute on <trans-unit> element. (\"<translationbundle>`,\n+            `Missing required \"id\" attribute on <translation> element. (\"<translationbundle>`,\n             `  [ERROR ->]<translation></translation>`,\n             `</translationbundle>\"): /some/file.xtb@1:2`,\n           ].join('\\n'));"
        }
    ],
    "stats": {
        "total": 356,
        "additions": 326,
        "deletions": 30
    }
}