{
    "author": "petebacondarwin",
    "message": "refactor(compiler-cli): visit inline declarations with implementations differently (#39267)\n\nSome inline declarations are of the form:\n\n```\nexports.<name> = <implementation>;\n```\n\nIn this case the declaration `node` is `exports.<name>`.\nWhen interpreting such inline declarations we actually want\nto visit the `implementation` expression rather than visiting\nthe declaration `node`.\n\nThis commit adds `implementation?: ts.Expression` to the\n`InlineDeclaration` type and updates the interpreter to visit\nthese expressions as described above.\n\nPR Close #39267",
    "sha": "ac0016cd828e3484f6911c7ba8a92e0260b14e03",
    "files": [
        {
            "sha": "fcabb150327a4353f48d68b62ebe09a99e919b61",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/src/interpreter.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/ac0016cd828e3484f6911c7ba8a92e0260b14e03/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts",
            "raw_url": "https://github.com/angular/angular/raw/ac0016cd828e3484f6911c7ba8a92e0260b14e03/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts?ref=ac0016cd828e3484f6911c7ba8a92e0260b14e03",
            "patch": "@@ -11,7 +11,7 @@ import * as ts from 'typescript';\n import {Reference} from '../../imports';\n import {OwningModule} from '../../imports/src/references';\n import {DependencyTracker} from '../../incremental/api';\n-import {Declaration, DeclarationNode, EnumMember, FunctionDefinition, isConcreteDeclaration, ReflectionHost, SpecialDeclarationKind} from '../../reflection';\n+import {Declaration, DeclarationKind, DeclarationNode, EnumMember, FunctionDefinition, isConcreteDeclaration, ReflectionHost, SpecialDeclarationKind} from '../../reflection';\n import {isDeclaration} from '../../util/src/typescript';\n \n import {ArrayConcatBuiltinFn, ArraySliceBuiltinFn} from './builtin';\n@@ -231,7 +231,7 @@ export class StaticInterpreter {\n       return this.getResolvedEnum(decl.node, decl.identity.enumMembers, context);\n     }\n     const declContext = {...context, ...joinModuleContext(context, node, decl)};\n-    const result = this.visitDeclaration(decl.node, declContext);\n+    const result = this.visitAmbiguousDeclaration(decl, declContext);\n     if (result instanceof Reference) {\n       // Only record identifiers to non-synthetic references. Synthetic references may not have the\n       // same value at runtime as they do at compile time, so it's not legal to refer to them by the\n@@ -337,10 +337,18 @@ export class StaticInterpreter {\n       };\n \n       // Visit both concrete and inline declarations.\n-      return this.visitDeclaration(decl.node, declContext);\n+      return this.visitAmbiguousDeclaration(decl, declContext);\n     });\n   }\n \n+  private visitAmbiguousDeclaration(decl: Declaration, declContext: Context) {\n+    return decl.kind === DeclarationKind.Inline && decl.implementation !== undefined ?\n+        // Inline declarations with an `implementation` should be visited as expressions\n+        this.visitExpression(decl.implementation, declContext) :\n+        // Otherwise just visit the declaration `node`\n+        this.visitDeclaration(decl.node, declContext);\n+  }\n+\n   private accessHelper(node: ts.Node, lhs: ResolvedValue, rhs: string|number, context: Context):\n       ResolvedValue {\n     const strIndex = `${rhs}`;"
        },
        {
            "sha": "3ae572f5c806f12eb91c5c1ba915326a27e019c8",
            "filename": "packages/compiler-cli/src/ngtsc/reflection/src/host.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/ac0016cd828e3484f6911c7ba8a92e0260b14e03/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Fhost.ts",
            "raw_url": "https://github.com/angular/angular/raw/ac0016cd828e3484f6911c7ba8a92e0260b14e03/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Fhost.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Fhost.ts?ref=ac0016cd828e3484f6911c7ba8a92e0260b14e03",
            "patch": "@@ -625,6 +625,7 @@ export interface DownleveledEnum {\n export interface InlineDeclaration extends\n     BaseDeclaration<Exclude<DeclarationNode, ts.Declaration>> {\n   kind: DeclarationKind.Inline;\n+  implementation?: ts.Expression;\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 12,
        "deletions": 3
    }
}