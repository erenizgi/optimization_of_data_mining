{
    "author": "gkalpak",
    "message": "ci: reduce flakiness of docs-infra `deploy-to-firebase.js` tests (#40088)\n\nThe `deploy-to-firebase.js` tests rely on git info retrieved from the\n`angular/angular` repository (via `git ls-remote ...`).\n\nPreviously, different calls to `git ls-remote ...` could return\ndifferent values if a new commit was pushed or a new branch was created\nduring test execution, resulting in errors ([example CI failure][1]).\n\nThis commit makes the tests more stable by memoizing the result of\n`git ls-remote ...` and returning the same result for subsequent calls\nwith the same arguments (even if meanwhile the remote has been updated).\n\n[1]: https://circleci.com/gh/angular/angular/877626\n\nPR Close #40088",
    "sha": "c18a9d5c7990d9f8bd76d54b3cc85d99c109cf3a",
    "files": [
        {
            "sha": "e5c5f460ee6e776b68945e5e8c42131a2a7ef470",
            "filename": "aio/scripts/deploy-to-firebase.js",
            "status": "modified",
            "additions": 23,
            "deletions": 7,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/c18a9d5c7990d9f8bd76d54b3cc85d99c109cf3a/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "raw_url": "https://github.com/angular/angular/raw/c18a9d5c7990d9f8bd76d54b3cc85d99c109cf3a/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.js?ref=c18a9d5c7990d9f8bd76d54b3cc85d99c109cf3a",
            "patch": "@@ -12,6 +12,7 @@ set('-e');\n // Constants\n const REPO_SLUG = 'angular/angular';\n const NG_REMOTE_URL = `https://github.com/${REPO_SLUG}.git`;\n+const GIT_REMOTE_REFS_CACHE = new Map();\n \n // Exports\n module.exports = {\n@@ -55,7 +56,6 @@ if (require.main === module) {\n       }\n     }\n   });\n-\n }\n \n // Helpers\n@@ -260,13 +260,29 @@ function deploy(data) {\n   postDeployActions.forEach(fn => fn(data));\n }\n \n-function getRemoteRefs(refOrPattern, remote = NG_REMOTE_URL) {\n-  return exec(`git ls-remote ${remote} ${refOrPattern}`, {silent: true}).trim().split('\\n');\n+function getRemoteRefs(refOrPattern, {remote = NG_REMOTE_URL, retrieveFromCache = true} = {}) {\n+  // If remote refs for the same `refOrPattern` and `remote` have been requested before, return the\n+  // cached results. This improves the performance and ensures a more stable behavior.\n+  //\n+  // NOTE:\n+  // This shouldn't make any difference during normal execution (since there are no duplicate\n+  // requests atm), but makes the tests more stable (for example, avoiding errors caused by pushing\n+  // a new commit on a branch while the tests execute, which would cause `getLatestCommit()` to\n+  // return a different value).\n+  const cmd = `git ls-remote ${remote} ${refOrPattern}`;\n+  const result = (retrieveFromCache && GIT_REMOTE_REFS_CACHE.has(cmd))\n+      ? GIT_REMOTE_REFS_CACHE.get(cmd)\n+      : exec(cmd, {silent: true}).trim().split('\\n');\n+\n+  // Cache the result for future use (regardless of the value of `retrieveFromCache`).\n+  GIT_REMOTE_REFS_CACHE.set(cmd, result);\n+\n+  return result;\n }\n \n-function getMostRecentMinorBranch(major = '*') {\n+function getMostRecentMinorBranch(major = '*', options = undefined) {\n   // List the branches that start with the given major version (or any major if none given).\n-  return getRemoteRefs(`refs/heads/${major}.*.x`)\n+  return getRemoteRefs(`refs/heads/${major}.*.x`, options)\n       // Extract the branch name.\n       .map(line => line.split('/')[2])\n       // Filter out branches that are not of the format `<number>.<number>.x`.\n@@ -281,8 +297,8 @@ function getMostRecentMinorBranch(major = '*') {\n       .pop();\n }\n \n-function getLatestCommit(branchName, remote = undefined) {\n-  return getRemoteRefs(branchName, remote)[0].slice(0, 40);\n+function getLatestCommit(branchName, options = undefined) {\n+  return getRemoteRefs(branchName, options)[0].slice(0, 40);\n }\n \n function redirectToAngularIo() {"
        },
        {
            "sha": "c701977cd368a766550c83f25cc1bc25f0cfd02e",
            "filename": "aio/scripts/deploy-to-firebase.spec.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/c18a9d5c7990d9f8bd76d54b3cc85d99c109cf3a/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/c18a9d5c7990d9f8bd76d54b3cc85d99c109cf3a/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.spec.js?ref=c18a9d5c7990d9f8bd76d54b3cc85d99c109cf3a",
            "patch": "@@ -388,13 +388,18 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('integration - should run the main script without error', () => {\n+    // NOTE:\n+    // This test executes a new instance of the `deploy-to-firebase.js` script on a separate process\n+    // and thus does not share the `getRemoteRefs()` cache. To improve stability, we retrieve the\n+    // latest commit from master ignoring any cached entries.\n+    const latestCommitOnMaster = getLatestCommit('master', {retrieveFromCache: false});\n     const cmd = `\"${process.execPath}\" \"${__dirname}/deploy-to-firebase\" --dry-run`;\n     const env = {\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: 'master',\n-      CI_COMMIT: latestCommits.master,\n+      CI_COMMIT: latestCommitOnMaster,\n     };\n     const result = execSync(cmd, {encoding: 'utf8', env}).trim();\n     expect(result).toBe(\n@@ -405,7 +410,7 @@ describe('deploy-to-firebase:', () => {\n         'Deployment 1 of 1\\n' +\n         '-----------------\\n' +\n         'Git branch          : master\\n' +\n-        `Git commit          : ${latestCommits.master}\\n` +\n+        `Git commit          : ${latestCommitOnMaster}\\n` +\n         'Build/deploy mode   : next\\n' +\n         'Firebase project    : angular-io\\n' +\n         'Firebase site       : next-angular-io-site\\n' +"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 30,
        "deletions": 9
    }
}