{
    "author": "petebacondarwin",
    "message": "feat(localize): allow duplicate messages to be handled during extraction (#38082)\n\nPreviously, the i18n message extractor just quietly ignored messages that\nit extracted that had the same id. It can be helpful to identify these\nto track down messages that have the same id but different message text.\n\nNow the messages are checked for duplicate ids with different message text.\nAny that are found can be reported based on the new `--duplicateMessageHandling`\ncommand line option (or `duplicateMessageHandling` API options property).\n\n* \"ignore\" - no action is taken\n* \"warning\" - a diagnostic warning is written to the logger\n* \"error\" - the extractor throws an error and exits\n\nFixes #38077\n\nPR Close #38082",
    "sha": "cf9a47ba53738bf3b8ce282938211370e946bbf9",
    "files": [
        {
            "sha": "dfe1eb6f5ee2f7ab7b42c3e5a8d82a0e1ad7d174",
            "filename": "packages/localize/src/tools/src/extract/duplicates.ts",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/cf9a47ba53738bf3b8ce282938211370e946bbf9/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fduplicates.ts",
            "raw_url": "https://github.com/angular/angular/raw/cf9a47ba53738bf3b8ce282938211370e946bbf9/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fduplicates.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fduplicates.ts?ref=cf9a47ba53738bf3b8ce282938211370e946bbf9",
            "patch": "@@ -0,0 +1,58 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {AbsoluteFsPath, FileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {ɵMessageId, ɵParsedMessage} from '@angular/localize';\n+\n+import {DiagnosticHandlingStrategy, Diagnostics} from '../diagnostics';\n+import {serializeLocationPosition} from '../source_file_utils';\n+\n+/**\n+ * Check each of the given `messages` to find those that have the same id but different message\n+ * text. Add diagnostics messages for each of these duplicate messages to the given `diagnostics`\n+ * object (as necessary).\n+ */\n+export function checkDuplicateMessages(\n+    fs: FileSystem, messages: ɵParsedMessage[],\n+    duplicateMessageHandling: DiagnosticHandlingStrategy, basePath: AbsoluteFsPath): Diagnostics {\n+  const diagnostics = new Diagnostics();\n+  if (duplicateMessageHandling === 'ignore') return diagnostics;\n+\n+  const messageMap = new Map<ɵMessageId, ɵParsedMessage[]>();\n+  for (const message of messages) {\n+    if (messageMap.has(message.id)) {\n+      messageMap.get(message.id)!.push(message);\n+    } else {\n+      messageMap.set(message.id, [message]);\n+    }\n+  }\n+\n+  for (const duplicates of messageMap.values()) {\n+    if (duplicates.length <= 1) continue;\n+    if (duplicates.every(message => message.text === duplicates[0].text)) continue;\n+\n+    const diagnosticMessage = `Duplicate messages with id \"${duplicates[0].id}\":\\n` +\n+        duplicates.map(message => serializeMessage(fs, basePath, message)).join('\\n');\n+    diagnostics.add(duplicateMessageHandling, diagnosticMessage);\n+  }\n+\n+  return diagnostics;\n+}\n+\n+/**\n+ * Serialize the given `message` object into a string.\n+ */\n+function serializeMessage(\n+    fs: FileSystem, basePath: AbsoluteFsPath, message: ɵParsedMessage): string {\n+  if (message.location === undefined) {\n+    return `   - \"${message.text}\"`;\n+  } else {\n+    const locationFile = fs.relative(basePath, message.location.file);\n+    const locationPosition = serializeLocationPosition(message.location);\n+    return `   - \"${message.text}\" : ${locationFile}:${locationPosition}`;\n+  }\n+}"
        },
        {
            "sha": "e0a41f05280ce3c79f2edaa0704dea91ad45cdbe",
            "filename": "packages/localize/src/tools/src/extract/main.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 4,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/cf9a47ba53738bf3b8ce282938211370e946bbf9/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/cf9a47ba53738bf3b8ce282938211370e946bbf9/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts?ref=cf9a47ba53738bf3b8ce282938211370e946bbf9",
            "patch": "@@ -11,6 +11,10 @@ import {ConsoleLogger, Logger, LogLevel} from '@angular/compiler-cli/src/ngtsc/l\n import {ɵParsedMessage} from '@angular/localize';\n import * as glob from 'glob';\n import * as yargs from 'yargs';\n+\n+import {DiagnosticHandlingStrategy, Diagnostics} from '../diagnostics';\n+\n+import {checkDuplicateMessages} from './duplicates';\n import {MessageExtractor} from './extraction';\n import {TranslationSerializer} from './translation_files/translation_serializer';\n import {SimpleJsonTranslationSerializer} from './translation_files/json_translation_serializer';\n@@ -68,6 +72,12 @@ if (require.main === module) {\n             describe:\n                 'Whether to use the legacy id format for messages that were extracted from Angular templates.'\n           })\n+          .option('d', {\n+            alias: 'duplicateMessageHandling',\n+            describe: 'How to handle messages with the same id but different text.',\n+            choices: ['error', 'warning', 'ignore'],\n+            default: 'warning',\n+          })\n           .strict()\n           .help()\n           .parse(args);\n@@ -79,6 +89,7 @@ if (require.main === module) {\n   const sourceFilePaths = glob.sync(options['source'], {cwd: rootPath, nodir: true});\n   const logLevel = options['loglevel'] as (keyof typeof LogLevel) | undefined;\n   const logger = new ConsoleLogger(logLevel ? LogLevel[logLevel] : LogLevel.warn);\n+  const duplicateMessageHandling: DiagnosticHandlingStrategy = options['d'];\n \n \n   extractTranslations({\n@@ -90,6 +101,7 @@ if (require.main === module) {\n     logger,\n     useSourceMaps: options['useSourceMaps'],\n     useLegacyIds: options['useLegacyIds'],\n+    duplicateMessageHandling,\n   });\n }\n \n@@ -129,6 +141,10 @@ export interface ExtractTranslationsOptions {\n    * Whether to use the legacy id format for messages that were extracted from Angular templates\n    */\n   useLegacyIds: boolean;\n+  /**\n+   * How to handle messages with the same id but not the same text.\n+   */\n+  duplicateMessageHandling: DiagnosticHandlingStrategy;\n }\n \n export function extractTranslations({\n@@ -139,22 +155,32 @@ export function extractTranslations({\n   outputPath: output,\n   logger,\n   useSourceMaps,\n-  useLegacyIds\n+  useLegacyIds,\n+  duplicateMessageHandling,\n }: ExtractTranslationsOptions) {\n   const fs = getFileSystem();\n-  const extractor =\n-      new MessageExtractor(fs, logger, {basePath: fs.resolve(rootPath), useSourceMaps});\n+  const basePath = fs.resolve(rootPath);\n+  const extractor = new MessageExtractor(fs, logger, {basePath, useSourceMaps});\n \n   const messages: ɵParsedMessage[] = [];\n   for (const file of sourceFilePaths) {\n     messages.push(...extractor.extractMessages(file));\n   }\n \n+  const diagnostics = checkDuplicateMessages(fs, messages, duplicateMessageHandling, basePath);\n+  if (diagnostics.hasErrors) {\n+    throw new Error(diagnostics.formatDiagnostics('Failed to extract messages'));\n+  }\n+\n   const outputPath = fs.resolve(rootPath, output);\n   const serializer = getSerializer(format, sourceLocale, fs.dirname(outputPath), useLegacyIds);\n   const translationFile = serializer.serialize(messages);\n   fs.ensureDir(fs.dirname(outputPath));\n   fs.writeFile(outputPath, translationFile);\n+\n+  if (diagnostics.messages.length) {\n+    logger.warn(diagnostics.formatDiagnostics('Messages extracted with warnings'));\n+  }\n }\n \n export function getSerializer(\n@@ -175,4 +201,4 @@ export function getSerializer(\n       return new SimpleJsonTranslationSerializer(sourceLocale);\n   }\n   throw new Error(`No translation serializer can handle the provided format: ${format}`);\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "ed20ac156ae728f05aa12f967f8dc4b0548f4cd3",
            "filename": "packages/localize/src/tools/src/source_file_utils.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/cf9a47ba53738bf3b8ce282938211370e946bbf9/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/cf9a47ba53738bf3b8ce282938211370e946bbf9/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts?ref=cf9a47ba53738bf3b8ce282938211370e946bbf9",
            "patch": "@@ -365,6 +365,13 @@ export function getLocation(startPath: NodePath, endPath?: NodePath): ɵSourceLo\n   };\n }\n \n+export function serializeLocationPosition(location: ɵSourceLocation): string {\n+  const endLineString = location.end !== undefined && location.end.line !== location.start.line ?\n+      `,${location.end.line + 1}` :\n+      '';\n+  return `${location.start.line + 1}${endLineString}`;\n+}\n+\n function getFileFromPath(path: NodePath|undefined): AbsoluteFsPath|null {\n   const opts = path?.hub.file.opts;\n   return opts?.filename ?"
        },
        {
            "sha": "7e5fd37fc6d068f33c56c87c8ce7ac2557a546d8",
            "filename": "packages/localize/src/tools/test/extract/integration/main_spec.ts",
            "status": "modified",
            "additions": 85,
            "deletions": 3,
            "changes": 88,
            "blob_url": "https://github.com/angular/angular/blob/cf9a47ba53738bf3b8ce282938211370e946bbf9/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/cf9a47ba53738bf3b8ce282938211370e946bbf9/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts?ref=cf9a47ba53738bf3b8ce282938211370e946bbf9",
            "patch": "@@ -7,15 +7,14 @@\n  */\n import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n-import {Logger} from '@angular/compiler-cli/src/ngtsc/logging';\n import {MockLogger} from '@angular/compiler-cli/src/ngtsc/logging/testing';\n import {loadTestDirectory} from '@angular/compiler-cli/test/helpers';\n \n import {extractTranslations} from '../../../src/extract/main';\n \n runInEachFileSystem(() => {\n   let fs: FileSystem;\n-  let logger: Logger;\n+  let logger: MockLogger;\n   let rootPath: AbsoluteFsPath;\n   let outputPath: AbsoluteFsPath;\n   let sourceFilePath: AbsoluteFsPath;\n@@ -40,12 +39,13 @@ runInEachFileSystem(() => {\n       extractTranslations({\n         rootPath,\n         sourceLocale: 'en',\n-        sourceFilePaths: [],\n+        sourceFilePaths: [textFile1, textFile2],\n         format: 'json',\n         outputPath,\n         logger,\n         useSourceMaps: false,\n         useLegacyIds: false,\n+        duplicateMessageHandling: 'ignore',\n       });\n       expect(fs.readFile(outputPath)).toEqual([\n         `{`,\n@@ -65,6 +65,7 @@ runInEachFileSystem(() => {\n         logger,\n         useSourceMaps: false,\n         useLegacyIds: false,\n+        duplicateMessageHandling: 'ignore',\n       });\n       expect(fs.readFile(outputPath)).toEqual([\n         `{`,\n@@ -87,6 +88,7 @@ runInEachFileSystem(() => {\n         logger,\n         useSourceMaps: false,\n         useLegacyIds: false,\n+        duplicateMessageHandling: 'ignore',\n       });\n       expect(fs.readFile(outputPath)).toEqual([\n         `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n@@ -128,6 +130,7 @@ runInEachFileSystem(() => {\n         logger,\n         useSourceMaps: false,\n         useLegacyIds: false,\n+        duplicateMessageHandling: 'ignore',\n       });\n       expect(fs.readFile(outputPath)).toEqual([\n         `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n@@ -164,6 +167,7 @@ runInEachFileSystem(() => {\n         logger,\n         useSourceMaps: false,\n         useLegacyIds: false,\n+        duplicateMessageHandling: 'ignore',\n       });\n       expect(fs.readFile(outputPath)).toEqual([\n         `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n@@ -197,6 +201,7 @@ runInEachFileSystem(() => {\n              logger,\n              useSourceMaps: true,\n              useLegacyIds: false,\n+             duplicateMessageHandling: 'ignore',\n            });\n            expect(fs.readFile(outputPath)).toEqual([\n              `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n@@ -224,5 +229,82 @@ runInEachFileSystem(() => {\n            ].join('\\n'));\n          });\n     }\n+\n+    describe('[duplicateMessageHandling]', () => {\n+      it('should throw if set to \"error\"', () => {\n+        expect(() => extractTranslations({\n+                 rootPath,\n+                 sourceLocale: 'en-GB',\n+                 sourceFilePaths: [fs.resolve(rootPath, 'test_files/duplicate.js')],\n+                 format: 'json',\n+                 outputPath,\n+                 logger,\n+                 useSourceMaps: false,\n+                 useLegacyIds: false,\n+                 duplicateMessageHandling: 'error',\n+               }))\n+            .toThrowError(\n+                `Failed to extract messages\\n` +\n+                `ERRORS:\\n` +\n+                ` - Duplicate messages with id \"message-2\":\\n` +\n+                `   - \"message contents\" : test_files/duplicate.js:6\\n` +\n+                `   - \"different message contents\" : test_files/duplicate.js:7`);\n+        expect(fs.exists(outputPath)).toBe(false);\n+      });\n+\n+      it('should log to the logger if set to \"warning\"', () => {\n+        extractTranslations({\n+          rootPath,\n+          sourceLocale: 'en-GB',\n+          sourceFilePaths: [fs.resolve(rootPath, 'test_files/duplicate.js')],\n+          format: 'json',\n+          outputPath,\n+          logger,\n+          useSourceMaps: false,\n+          useLegacyIds: false,\n+          duplicateMessageHandling: 'warning',\n+        });\n+        expect(logger.logs.warn).toEqual([\n+          ['Messages extracted with warnings\\n' +\n+           `WARNINGS:\\n` +\n+           ` - Duplicate messages with id \"message-2\":\\n` +\n+           `   - \"message contents\" : test_files/duplicate.js:6\\n` +\n+           `   - \"different message contents\" : test_files/duplicate.js:7`]\n+        ]);\n+        expect(fs.readFile(outputPath)).toEqual([\n+          `{`,\n+          `  \"locale\": \"en-GB\",`,\n+          `  \"translations\": {`,\n+          `    \"message-1\": \"message {$PH} contents\",`,\n+          `    \"message-2\": \"different message contents\"`,\n+          `  }`,\n+          `}`,\n+        ].join('\\n'));\n+      });\n+\n+      it('should not log to the logger if set to \"ignore\"', () => {\n+        extractTranslations({\n+          rootPath,\n+          sourceLocale: 'en-GB',\n+          sourceFilePaths: [fs.resolve(rootPath, 'test_files/duplicate.js')],\n+          format: 'json',\n+          outputPath,\n+          logger,\n+          useSourceMaps: false,\n+          useLegacyIds: false,\n+          duplicateMessageHandling: 'ignore',\n+        });\n+        expect(logger.logs.warn).toEqual([]);\n+        expect(fs.readFile(outputPath)).toEqual([\n+          `{`,\n+          `  \"locale\": \"en-GB\",`,\n+          `  \"translations\": {`,\n+          `    \"message-1\": \"message {$PH} contents\",`,\n+          `    \"message-2\": \"different message contents\"`,\n+          `  }`,\n+          `}`,\n+        ].join('\\n'));\n+      });\n+    });\n   });\n });"
        },
        {
            "sha": "b25f64566d94c97b4d5a546f9a3007740b11ed2b",
            "filename": "packages/localize/src/tools/test/extract/integration/test_files/duplicate.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/cf9a47ba53738bf3b8ce282938211370e946bbf9/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Ftest_files%2Fduplicate.js",
            "raw_url": "https://github.com/angular/angular/raw/cf9a47ba53738bf3b8ce282938211370e946bbf9/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Ftest_files%2Fduplicate.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Ftest_files%2Fduplicate.js?ref=cf9a47ba53738bf3b8ce282938211370e946bbf9",
            "patch": "@@ -0,0 +1,7 @@\n+// Different interpolation values will not affect message text\n+const a = $localize`:@@message-1:message ${10} contents`;\n+const b = $localize`:@@message-1:message ${20} contents`;\n+\n+// But different actual text content will\n+const c = $localize`:@@message-2:message contents`;\n+const d = $localize`:@@message-2:different message contents`;\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 194,
        "additions": 187,
        "deletions": 7
    }
}