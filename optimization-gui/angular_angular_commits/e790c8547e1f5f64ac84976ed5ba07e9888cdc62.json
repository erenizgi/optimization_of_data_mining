{
    "author": "JoostK",
    "message": "test(compiler-cli): load test files into memory only once (#38909)\n\nPrior to this change, each invocation of `loadStandardTestFiles` would\nload the necessary files from disk. This function is typically called\nat the top-level of a test module in order to share the result across\ntests. The `//packages/compiler-cli/test/ngtsc` target has 8 modules\nwhere this call occurs, each loading their own copy of\n`node_modules/typescript` which is ~60MB in size, so the memory overhead\nused to be significant. This commit loads the individual packages into\na standalone `Folder` and mounts this folder into the filesystem of\nstandard test files, such that all file contents are no longer\nduplicated in memory.\n\nPR Close #38909",
    "sha": "e790c8547e1f5f64ac84976ed5ba07e9888cdc62",
    "files": [
        {
            "sha": "220ac4e0d55d66f3b2be34d11a4d7599f36a9a2c",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/testing/src/mock_file_system.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 10,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/e790c8547e1f5f64ac84976ed5ba07e9888cdc62/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Fsrc%2Fmock_file_system.ts",
            "raw_url": "https://github.com/angular/angular/raw/e790c8547e1f5f64ac84976ed5ba07e9888cdc62/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Fsrc%2Fmock_file_system.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Fsrc%2Fmock_file_system.ts?ref=e790c8547e1f5f64ac84976ed5ba07e9888cdc62",
            "patch": "@@ -127,12 +127,17 @@ export abstract class MockFileSystem implements FileSystem {\n     delete folder[name];\n   }\n \n-  ensureDir(path: AbsoluteFsPath): void {\n+  ensureDir(path: AbsoluteFsPath): Folder {\n     const segments = this.splitPath(path).map(segment => this.getCanonicalPath(segment));\n-    let current: Folder = this._fileTree;\n \n     // Convert the root folder to a canonical empty string `''` (on Windows it would be `'C:'`).\n     segments[0] = '';\n+    if (segments.length > 1 && segments[segments.length - 1] === '') {\n+      // Remove a trailing slash (unless the path was only `/`)\n+      segments.pop();\n+    }\n+\n+    let current: Folder = this._fileTree;\n     for (const segment of segments) {\n       if (isFile(current[segment])) {\n         throw new Error(`Folder already exists as a file.`);\n@@ -142,6 +147,7 @@ export abstract class MockFileSystem implements FileSystem {\n       }\n       current = current[segment] as Folder;\n     }\n+    return current;\n   }\n \n   removeDeep(path: AbsoluteFsPath): void {\n@@ -221,26 +227,45 @@ export abstract class MockFileSystem implements FileSystem {\n   protected abstract splitPath<T extends PathString>(path: T): string[];\n \n   dump(): Folder {\n-    return this.cloneFolder(this._fileTree);\n+    const {entity} = this.findFromPath(this.resolve('/'));\n+    if (entity === null || !isFolder(entity)) {\n+      return {};\n+    }\n+\n+    return this.cloneFolder(entity);\n   }\n+\n   init(folder: Folder): void {\n-    this._fileTree = this.cloneFolder(folder);\n+    this.mount(this.resolve('/'), folder);\n+  }\n+\n+  mount(path: AbsoluteFsPath, folder: Folder): void {\n+    if (this.exists(path)) {\n+      throw new Error(`Unable to mount in '${path}' as it already exists.`);\n+    }\n+    const mountFolder = this.ensureDir(path);\n+\n+    this.copyInto(folder, mountFolder);\n   }\n \n   private cloneFolder(folder: Folder): Folder {\n     const clone: Folder = {};\n-    for (const path in folder) {\n-      const item = folder[path];\n+    this.copyInto(folder, clone);\n+    return clone;\n+  }\n+\n+  private copyInto(from: Folder, to: Folder): void {\n+    for (const path in from) {\n+      const item = from[path];\n       const canonicalPath = this.getCanonicalPath(path);\n       if (isSymLink(item)) {\n-        clone[canonicalPath] = new SymLink(this.getCanonicalPath(item.path));\n+        to[canonicalPath] = new SymLink(this.getCanonicalPath(item.path));\n       } else if (isFolder(item)) {\n-        clone[canonicalPath] = this.cloneFolder(item);\n+        to[canonicalPath] = this.cloneFolder(item);\n       } else {\n-        clone[canonicalPath] = folder[path];\n+        to[canonicalPath] = from[path];\n       }\n     }\n-    return clone;\n   }\n \n "
        },
        {
            "sha": "749e57c93dcec325b6c31c2ec458a86f728ba1d7",
            "filename": "packages/compiler-cli/test/helpers/src/mock_file_loading.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 8,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/e790c8547e1f5f64ac84976ed5ba07e9888cdc62/packages%2Fcompiler-cli%2Ftest%2Fhelpers%2Fsrc%2Fmock_file_loading.ts",
            "raw_url": "https://github.com/angular/angular/raw/e790c8547e1f5f64ac84976ed5ba07e9888cdc62/packages%2Fcompiler-cli%2Ftest%2Fhelpers%2Fsrc%2Fmock_file_loading.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fhelpers%2Fsrc%2Fmock_file_loading.ts?ref=e790c8547e1f5f64ac84976ed5ba07e9888cdc62",
            "patch": "@@ -22,28 +22,43 @@ export function loadTestFiles(files: TestFile[]) {\n   });\n }\n \n+/**\n+ * A folder that is lazily loaded upon first access and then cached.\n+ */\n+class CachedFolder {\n+  private folder: Folder|null = null;\n+\n+  constructor(private loader: () => Folder) {}\n+\n+  get(): Folder {\n+    if (this.folder === null) {\n+      this.folder = this.loader();\n+    }\n+    return this.folder;\n+  }\n+}\n+\n+const typescriptFolder = new CachedFolder(() => loadFolder(resolveNpmTreeArtifact('typescript')));\n+const angularFolder = new CachedFolder(loadAngularFolder);\n+const rxjsFolder = new CachedFolder(() => loadFolder(resolveNpmTreeArtifact('rxjs')));\n+\n export function loadStandardTestFiles(\n     {fakeCore = true, rxjs = false}: {fakeCore?: boolean, rxjs?: boolean} = {}): Folder {\n   const tmpFs = new MockFileSystemPosix(true);\n   const basePath = '/' as AbsoluteFsPath;\n \n-  loadTestDirectory(\n-      tmpFs, resolveNpmTreeArtifact('typescript'),\n-      tmpFs.resolve(basePath, 'node_modules/typescript'));\n+  tmpFs.mount(tmpFs.resolve('/node_modules/typescript'), typescriptFolder.get());\n \n   loadTsLib(tmpFs, basePath);\n \n   if (fakeCore) {\n     loadFakeCore(tmpFs, basePath);\n   } else {\n-    getAngularPackagesFromRunfiles().forEach(({name, pkgPath}) => {\n-      loadTestDirectory(tmpFs, pkgPath, tmpFs.resolve(basePath, 'node_modules/@angular', name));\n-    });\n+    tmpFs.mount(tmpFs.resolve('/node_modules/@angular'), angularFolder.get());\n   }\n \n   if (rxjs) {\n-    loadTestDirectory(\n-        tmpFs, resolveNpmTreeArtifact('rxjs'), tmpFs.resolve(basePath, 'node_modules/rxjs'));\n+    tmpFs.mount(tmpFs.resolve('/node_modules/rxjs'), rxjsFolder.get());\n   }\n \n   return tmpFs.dump();\n@@ -60,6 +75,20 @@ export function loadFakeCore(fs: FileSystem, basePath: string = '/') {\n       fs.resolve(basePath, 'node_modules/@angular/core'));\n }\n \n+function loadFolder(path: string): Folder {\n+  const tmpFs = new MockFileSystemPosix(true);\n+  loadTestDirectory(tmpFs, tmpFs.resolve(path), tmpFs.resolve('/'));\n+  return tmpFs.dump();\n+}\n+\n+function loadAngularFolder(): Folder {\n+  const tmpFs = new MockFileSystemPosix(true);\n+  getAngularPackagesFromRunfiles().forEach(({name, pkgPath}) => {\n+    loadTestDirectory(tmpFs, pkgPath, tmpFs.resolve(name));\n+  });\n+  return tmpFs.dump();\n+}\n+\n /**\n  * Load real files from the real file-system into a mock file-system.\n  * @param fs the file-system where the directory is to be loaded."
        }
    ],
    "stats": {
        "total": 90,
        "additions": 72,
        "deletions": 18
    }
}