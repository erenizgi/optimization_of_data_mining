{
    "author": "atscott",
    "message": "refactor(compiler-cli): Add test to document use-case for invalid pipe argument nullish coallesce (#43419)\n\nAdds a test to the nullish coalescing diagnostic check to serve as\nself-documentation on how it works with nullish coalescing on pipes that\nare often misconfigured.\n\nThis also removes that non null assertion operator, which is incorrect\nbecause there _are_ situations where a symbol cannot be retrieved.\n\nPR Close #43419",
    "sha": "a360f4b0fc361c2d8cf944aef8fd12d341d22ba4",
    "files": [
        {
            "sha": "60b0f7c8759413c594bcc3fca54f79dac6c65367",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/checks/nullish_coalescing_not_nullable/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a360f4b0fc361c2d8cf944aef8fd12d341d22ba4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a360f4b0fc361c2d8cf944aef8fd12d341d22ba4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2Findex.ts?ref=a360f4b0fc361c2d8cf944aef8fd12d341d22ba4",
            "patch": "@@ -27,8 +27,8 @@ export class NullishCoalescingNotNullableCheck extends\n       NgTemplateDiagnostic<ErrorCode.NULLISH_COALESCING_NOT_NULLABLE>[] {\n     if (!(node instanceof Binary) || node.operation !== '??') return [];\n \n-    const symbolLeft = ctx.templateTypeChecker.getSymbolOfNode(node.left, component)!;\n-    if (symbolLeft.kind !== SymbolKind.Expression) {\n+    const symbolLeft = ctx.templateTypeChecker.getSymbolOfNode(node.left, component);\n+    if (symbolLeft === null || symbolLeft.kind !== SymbolKind.Expression) {\n       return [];\n     }\n     const typeLeft = symbolLeft.tsType;"
        },
        {
            "sha": "a5a8141dfc1759defb1116e6e2dc8aa71df6209c",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/test/checks/nullish_coalescing_not_nullable/spec.ts",
            "status": "modified",
            "additions": 82,
            "deletions": 0,
            "changes": 82,
            "blob_url": "https://github.com/angular/angular/blob/a360f4b0fc361c2d8cf944aef8fd12d341d22ba4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2Fspec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a360f4b0fc361c2d8cf944aef8fd12d341d22ba4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2Fspec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2Fspec.ts?ref=a360f4b0fc361c2d8cf944aef8fd12d341d22ba4",
            "patch": "@@ -71,5 +71,87 @@ runInEachFileSystem(() => {\n       const diags = extendedTemplateChecker.getDiagnosticsForComponent(component);\n       expect(diags.length).toBe(0);\n     });\n+\n+    it('warns for pipe arguments which are likely configured incorrectly (?? operates on \"format\" here)',\n+       () => {\n+         const fileName = absoluteFrom('/main.ts');\n+         const {program, templateTypeChecker} = setup([{\n+           fileName,\n+           templates: {\n+             'TestCmp': `{{ 123 | date: 'format' ?? 'invalid date' }}`,\n+           },\n+           source: `\n+            export class TestCmp { var1: string | undefined = \"text\"; }\n+            export class DatePipe {\n+              transform(value: string, format: string): string[] {\n+              }\n+            `,\n+           declarations: [{\n+             type: 'pipe',\n+             name: 'DatePipe',\n+             pipeName: 'date',\n+           }],\n+         }]);\n+         const sf = getSourceFileOrError(program, fileName);\n+         const component = getClass(sf, 'TestCmp');\n+         const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+             templateTypeChecker, program.getTypeChecker(),\n+             [new NullishCoalescingNotNullableCheck()]);\n+         const diags = extendedTemplateChecker.getDiagnosticsForComponent(component);\n+         expect(diags.length).toBe(1);\n+         expect(diags[0].category).toBe(ts.DiagnosticCategory.Warning);\n+         expect(diags[0].code).toBe(ngErrorCode(ErrorCode.NULLISH_COALESCING_NOT_NULLABLE));\n+         expect(getSourceCodeForDiagnostic(diags[0])).toBe(`'format' ?? 'invalid date'`);\n+       });\n+\n+    it('does not warn for pipe arguments when parens are used', () => {\n+      const fileName = absoluteFrom('/main.ts');\n+      const {program, templateTypeChecker} = setup([\n+        {\n+          fileName,\n+          templates: {\n+            'TestCmp': `{{ (123 | date: 'format') ?? 'invalid date' }}`,\n+          },\n+          source: `\n+            export class TestCmp { var1: string | undefined = \"text\"; }\n+            export class DatePipe {\n+              transform(value: string, format: string): string[] {\n+              }\n+          `,\n+          declarations: [{\n+            type: 'pipe',\n+            name: 'DatePipe',\n+            pipeName: 'date',\n+          }],\n+        },\n+      ]);\n+      const sf = getSourceFileOrError(program, fileName);\n+      const component = getClass(sf, 'TestCmp');\n+      const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+          templateTypeChecker, program.getTypeChecker(), [new NullishCoalescingNotNullableCheck()]);\n+      const diags = extendedTemplateChecker.getDiagnosticsForComponent(component);\n+      expect(diags.length).toBe(0);\n+    });\n+\n+    it('does not blow up when there is no symbol for the LHS of the operator', () => {\n+      const fileName = absoluteFrom('/main.ts');\n+      const {program, templateTypeChecker} = setup([\n+        {\n+          fileName,\n+          templates: {\n+            'TestCmp': `{{ (123 | doesNotExist) ?? 'invalid date' }}`,\n+          },\n+          source: `\n+            export class TestCmp { var1: string | undefined = \"text\"; }\n+          `,\n+        },\n+      ]);\n+      const sf = getSourceFileOrError(program, fileName);\n+      const component = getClass(sf, 'TestCmp');\n+      const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+          templateTypeChecker, program.getTypeChecker(), [new NullishCoalescingNotNullableCheck()]);\n+      const diags = extendedTemplateChecker.getDiagnosticsForComponent(component);\n+      expect(diags.length).toBe(0);\n+    });\n   });\n });"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 84,
        "deletions": 2
    }
}