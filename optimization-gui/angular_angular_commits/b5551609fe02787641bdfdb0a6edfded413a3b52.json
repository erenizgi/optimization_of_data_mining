{
    "author": "MatthiasKunnen",
    "message": "fix(router): fragment can be null (#37336)\n\nActivatedRoute.fragment was typed as Observable<string> but could emit\nboth null and undefined due to incorrect non-null assertion. These\nnon-null assertions have been removed and fragment has been retyped to\nstring | null.\n\nBREAKING CHANGE:\nStrict null checks will report on fragment potentially being null.\nMigration path: add null check.\n\nFixes #23894, fixes #34197.\n\nPR Close #37336",
    "sha": "b5551609fe02787641bdfdb0a6edfded413a3b52",
    "files": [
        {
            "sha": "a8bd2ceadf341c3c675620bed0506ca6aa8ce8b9",
            "filename": "goldens/public-api/router/router.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/b5551609fe02787641bdfdb0a6edfded413a3b52/goldens%2Fpublic-api%2Frouter%2Frouter.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5551609fe02787641bdfdb0a6edfded413a3b52/goldens%2Fpublic-api%2Frouter%2Frouter.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Frouter%2Frouter.d.ts?ref=b5551609fe02787641bdfdb0a6edfded413a3b52",
            "patch": "@@ -3,7 +3,7 @@ export declare class ActivatedRoute {\n     component: Type<any> | string | null;\n     data: Observable<Data>;\n     get firstChild(): ActivatedRoute | null;\n-    fragment: Observable<string>;\n+    fragment: Observable<string | null>;\n     outlet: string;\n     get paramMap(): Observable<ParamMap>;\n     params: Observable<Params>;\n@@ -23,7 +23,7 @@ export declare class ActivatedRouteSnapshot {\n     component: Type<any> | string | null;\n     data: Data;\n     get firstChild(): ActivatedRouteSnapshot | null;\n-    fragment: string;\n+    fragment: string | null;\n     outlet: string;\n     get paramMap(): ParamMap;\n     params: Params;"
        },
        {
            "sha": "391688a6ff2150a764f3abb4d9410dabefccca18",
            "filename": "packages/router/src/apply_redirects.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Fapply_redirects.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Fapply_redirects.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fapply_redirects.ts?ref=b5551609fe02787641bdfdb0a6edfded413a3b52",
            "patch": "@@ -91,7 +91,7 @@ class ApplyRedirects {\n         this.expandSegmentGroup(this.ngModule, this.config, rootSegmentGroup, PRIMARY_OUTLET);\n     const urlTrees$ = expanded$.pipe(map((rootSegmentGroup: UrlSegmentGroup) => {\n       return this.createUrlTree(\n-          squashSegmentGroup(rootSegmentGroup), this.urlTree.queryParams, this.urlTree.fragment!);\n+          squashSegmentGroup(rootSegmentGroup), this.urlTree.queryParams, this.urlTree.fragment);\n     }));\n     return urlTrees$.pipe(catchError((e: any) => {\n       if (e instanceof AbsoluteRedirect) {\n@@ -114,7 +114,7 @@ class ApplyRedirects {\n         this.expandSegmentGroup(this.ngModule, this.config, tree.root, PRIMARY_OUTLET);\n     const mapped$ = expanded$.pipe(map((rootSegmentGroup: UrlSegmentGroup) => {\n       return this.createUrlTree(\n-          squashSegmentGroup(rootSegmentGroup), tree.queryParams, tree.fragment!);\n+          squashSegmentGroup(rootSegmentGroup), tree.queryParams, tree.fragment);\n     }));\n     return mapped$.pipe(catchError((e: any): Observable<UrlTree> => {\n       if (e instanceof NoMatch) {\n@@ -129,7 +129,7 @@ class ApplyRedirects {\n     return new Error(`Cannot match any routes. URL Segment: '${e.segmentGroup}'`);\n   }\n \n-  private createUrlTree(rootCandidate: UrlSegmentGroup, queryParams: Params, fragment: string):\n+  private createUrlTree(rootCandidate: UrlSegmentGroup, queryParams: Params, fragment: string|null):\n       UrlTree {\n     const root = rootCandidate.segments.length > 0 ?\n         new UrlSegmentGroup([], {[PRIMARY_OUTLET]: rootCandidate}) :"
        },
        {
            "sha": "d79a06eba79d9e730d135f081164ba42b8304a3b",
            "filename": "packages/router/src/create_url_tree.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Fcreate_url_tree.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Fcreate_url_tree.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fcreate_url_tree.ts?ref=b5551609fe02787641bdfdb0a6edfded413a3b52",
            "patch": "@@ -12,8 +12,8 @@ import {UrlSegment, UrlSegmentGroup, UrlTree} from './url_tree';\n import {forEach, last, shallowEqual} from './utils/collection';\n \n export function createUrlTree(\n-    route: ActivatedRoute, urlTree: UrlTree, commands: any[], queryParams: Params,\n-    fragment: string): UrlTree {\n+    route: ActivatedRoute, urlTree: UrlTree, commands: any[], queryParams: Params|null,\n+    fragment: string|null): UrlTree {\n   if (commands.length === 0) {\n     return tree(urlTree.root, urlTree.root, urlTree, queryParams, fragment);\n   }\n@@ -47,7 +47,7 @@ function isCommandWithOutlets(command: any): command is {outlets: {[key: string]\n \n function tree(\n     oldSegmentGroup: UrlSegmentGroup, newSegmentGroup: UrlSegmentGroup, urlTree: UrlTree,\n-    queryParams: Params, fragment: string): UrlTree {\n+    queryParams: Params|null, fragment: string|null): UrlTree {\n   let qp: any = {};\n   if (queryParams) {\n     forEach(queryParams, (value: any, name: any) => {"
        },
        {
            "sha": "64d3f2545924f061f9fe220f6cf35fb69a8b927b",
            "filename": "packages/router/src/recognize.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Frecognize.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Frecognize.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frecognize.ts?ref=b5551609fe02787641bdfdb0a6edfded413a3b52",
            "patch": "@@ -67,7 +67,7 @@ export class Recognizer {\n     // Use Object.freeze to prevent readers of the Router state from modifying it outside of a\n     // navigation, resulting in the router being out of sync with the browser.\n     const root = new ActivatedRouteSnapshot(\n-        [], Object.freeze({}), Object.freeze({...this.urlTree.queryParams}), this.urlTree.fragment!,\n+        [], Object.freeze({}), Object.freeze({...this.urlTree.queryParams}), this.urlTree.fragment,\n         {}, PRIMARY_OUTLET, this.rootComponentType, null, this.urlTree.root, -1, {});\n \n     const rootNode = new TreeNode<ActivatedRouteSnapshot>(root, children);\n@@ -160,7 +160,7 @@ export class Recognizer {\n     if (route.path === '**') {\n       const params = segments.length > 0 ? last(segments)!.parameters : {};\n       snapshot = new ActivatedRouteSnapshot(\n-          segments, params, Object.freeze({...this.urlTree.queryParams}), this.urlTree.fragment!,\n+          segments, params, Object.freeze({...this.urlTree.queryParams}), this.urlTree.fragment,\n           getData(route), getOutlet(route), route.component!, route,\n           getSourceSegmentGroup(rawSegment), getPathIndexShift(rawSegment) + segments.length,\n           getResolve(route));\n@@ -174,7 +174,7 @@ export class Recognizer {\n \n       snapshot = new ActivatedRouteSnapshot(\n           consumedSegments, result.parameters, Object.freeze({...this.urlTree.queryParams}),\n-          this.urlTree.fragment!, getData(route), getOutlet(route), route.component!, route,\n+          this.urlTree.fragment, getData(route), getOutlet(route), route.component!, route,\n           getSourceSegmentGroup(rawSegment),\n           getPathIndexShift(rawSegment) + consumedSegments.length, getResolve(route));\n     }"
        },
        {
            "sha": "f67a6c9a1408f11b98c529cf63b42a29a5525190",
            "filename": "packages/router/src/router.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Frouter.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter.ts?ref=b5551609fe02787641bdfdb0a6edfded413a3b52",
            "patch": "@@ -1142,7 +1142,7 @@ export class Router {\n     if (q !== null) {\n       q = this.removeEmptyProps(q);\n     }\n-    return createUrlTree(a, this.currentUrlTree, commands, q!, f!);\n+    return createUrlTree(a, this.currentUrlTree, commands, q, f ?? null);\n   }\n \n   /**"
        },
        {
            "sha": "faf6edd3e1399e0c88e33bba68d136c15c960251",
            "filename": "packages/router/src/router_state.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Frouter_state.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Frouter_state.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter_state.ts?ref=b5551609fe02787641bdfdb0a6edfded413a3b52",
            "patch": "@@ -126,7 +126,7 @@ export class ActivatedRoute {\n       /** An observable of the query parameters shared by all the routes. */\n       public queryParams: Observable<Params>,\n       /** An observable of the URL fragment shared by all the routes. */\n-      public fragment: Observable<string>,\n+      public fragment: Observable<string|null>,\n       /** An observable of the static and resolved data of this route. */\n       public data: Observable<Data>,\n       /** The outlet name of the route, a constant. */\n@@ -321,7 +321,7 @@ export class ActivatedRouteSnapshot {\n       /** The query parameters shared by all the routes */\n       public queryParams: Params,\n       /** The URL fragment shared by all the routes */\n-      public fragment: string,\n+      public fragment: string|null,\n       /** The static and resolved data of this route */\n       public data: Data,\n       /** The outlet name of the route */"
        },
        {
            "sha": "6ed907e359078d2a54b14af985a073a4b6c0621b",
            "filename": "packages/router/src/url_tree.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Furl_tree.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Fsrc%2Furl_tree.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Furl_tree.ts?ref=b5551609fe02787641bdfdb0a6edfded413a3b52",
            "patch": "@@ -382,7 +382,7 @@ export class DefaultUrlSerializer implements UrlSerializer {\n     const segment = `/${serializeSegment(tree.root, true)}`;\n     const query = serializeQueryParams(tree.queryParams);\n     const fragment =\n-        typeof tree.fragment === `string` ? `#${encodeUriFragment(tree.fragment!)}` : '';\n+        typeof tree.fragment === `string` ? `#${encodeUriFragment(tree.fragment)}` : '';\n \n     return `${segment}${query}${fragment}`;\n   }"
        },
        {
            "sha": "bf704d577d42eab4c2f33c47eda21f009a836c70",
            "filename": "packages/router/test/create_url_tree.spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Ftest%2Fcreate_url_tree.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Ftest%2Fcreate_url_tree.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fcreate_url_tree.spec.ts?ref=b5551609fe02787641bdfdb0a6edfded413a3b52",
            "patch": "@@ -406,7 +406,7 @@ function createRoot(tree: UrlTree, commands: any[], queryParams?: Params, fragme\n       new BehaviorSubject(null!), new BehaviorSubject(null!), new BehaviorSubject(null!),\n       new BehaviorSubject(null!), new BehaviorSubject(null!), PRIMARY_OUTLET, 'someComponent', s);\n   advanceActivatedRoute(a);\n-  return createUrlTree(a, tree, commands, queryParams!, fragment!);\n+  return createUrlTree(a, tree, commands, queryParams ?? null, fragment ?? null);\n }\n \n function create(\n@@ -422,5 +422,5 @@ function create(\n       new BehaviorSubject(null!), new BehaviorSubject(null!), new BehaviorSubject(null!),\n       new BehaviorSubject(null!), new BehaviorSubject(null!), PRIMARY_OUTLET, 'someComponent', s);\n   advanceActivatedRoute(a);\n-  return createUrlTree(a, tree, commands, queryParams!, fragment!);\n+  return createUrlTree(a, tree, commands, queryParams ?? null, fragment ?? null);\n }"
        },
        {
            "sha": "818ab08e914112bc6c4529c1da0850f01a43557c",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 1,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=b5551609fe02787641bdfdb0a6edfded413a3b52",
            "patch": "@@ -1273,6 +1273,20 @@ describe('Integration', () => {\n        expect(fixture.nativeElement).toHaveText('query: 2 fragment: fragment2');\n      })));\n \n+  it('should handle empty or missing fragments', fakeAsync(inject([Router], (router: Router) => {\n+       const fixture = createRoot(router, RootCmp);\n+\n+       router.resetConfig([{path: 'query', component: QueryParamsAndFragmentCmp}]);\n+\n+       router.navigateByUrl('/query#');\n+       advance(fixture);\n+       expect(fixture.nativeElement).toHaveText('query:  fragment: ');\n+\n+       router.navigateByUrl('/query');\n+       advance(fixture);\n+       expect(fixture.nativeElement).toHaveText('query:  fragment: null');\n+     })));\n+\n   it('should ignore null and undefined query params',\n      fakeAsync(inject([Router], (router: Router) => {\n        const fixture = createRoot(router, RootCmp);\n@@ -6058,7 +6072,15 @@ class QueryParamsAndFragmentCmp {\n \n   constructor(route: ActivatedRoute) {\n     this.name = route.queryParamMap.pipe(map((p: ParamMap) => p.get('name')));\n-    this.fragment = route.fragment;\n+    this.fragment = route.fragment.pipe(map((p: string|null|undefined) => {\n+      if (p === undefined) {\n+        return 'undefined';\n+      } else if (p === null) {\n+        return 'null';\n+      } else {\n+        return p;\n+      }\n+    }));\n   }\n }\n "
        },
        {
            "sha": "3e10884b3626597d9d480ea7d7c3c13a989f49bc",
            "filename": "packages/router/test/url_serializer.spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Ftest%2Furl_serializer.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5551609fe02787641bdfdb0a6edfded413a3b52/packages%2Frouter%2Ftest%2Furl_serializer.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Furl_serializer.spec.ts?ref=b5551609fe02787641bdfdb0a6edfded413a3b52",
            "patch": "@@ -186,6 +186,12 @@ describe('url serializer', () => {\n     expect(url.serialize(tree)).toEqual('/one#');\n   });\n \n+  it('should parse no fragment', () => {\n+    const tree = url.parse('/one');\n+    expect(tree.fragment).toEqual(null);\n+    expect(url.serialize(tree)).toEqual('/one');\n+  });\n+\n   describe('encoding/decoding', () => {\n     it('should encode/decode path segments and parameters', () => {\n       const u = `/${encodeUriSegment('one two')};${encodeUriSegment('p 1')}=${"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 46,
        "deletions": 18
    }
}