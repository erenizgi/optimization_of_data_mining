{
    "author": "JoostK",
    "message": "fix(compiler-cli): type checking of expressions within ICUs (#39072)\n\nExpressions within ICU expressions in templates were not previously\ntype-checked, as they were skipped while traversing the elements\nwithin a template. This commit enables type checking of these\nexpressions by actually visiting the expressions.\n\nBREAKING CHANGE:\nExpressions within ICUs are now type-checked again, fixing a regression\nin Ivy. This may cause compilation failures if errors are found in\nexpressions that appear within an ICU. Please correct these expressions\nto resolve the type-check errors.\n\nFixes #39064\n\nPR Close #39072",
    "sha": "0a16e60afae27c7af023cf617de05297dddf5135",
    "files": [
        {
            "sha": "4864dfaec28ab9f24b75dee7ec970db123a4407b",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/0a16e60afae27c7af023cf617de05297dddf5135/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/0a16e60afae27c7af023cf617de05297dddf5135/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=0a16e60afae27c7af023cf617de05297dddf5135",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, BindingPipe, BindingType, BoundTarget, DYNAMIC_TYPE, ImplicitReceiver, MethodCall, ParsedEventType, ParseSourceSpan, PropertyRead, PropertyWrite, SchemaMetadata, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n+import {AST, BindingPipe, BindingType, BoundTarget, DYNAMIC_TYPE, ImplicitReceiver, MethodCall, ParsedEventType, ParseSourceSpan, PropertyRead, PropertyWrite, SchemaMetadata, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstElement, TmplAstIcu, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {Reference} from '../../imports';\n@@ -1333,6 +1333,8 @@ class Scope {\n       this.checkAndAppendReferencesOfNode(node);\n     } else if (node instanceof TmplAstBoundText) {\n       this.opQueue.push(new TcbTextInterpolationOp(this.tcb, this, node));\n+    } else if (node instanceof TmplAstIcu) {\n+      this.appendIcuExpressions(node);\n     }\n   }\n \n@@ -1459,6 +1461,17 @@ class Scope {\n       this.appendDeepSchemaChecks(node.children);\n     }\n   }\n+\n+  private appendIcuExpressions(node: TmplAstIcu): void {\n+    for (const variable of Object.values(node.vars)) {\n+      this.opQueue.push(new TcbTextInterpolationOp(this.tcb, this, variable));\n+    }\n+    for (const placeholder of Object.values(node.placeholders)) {\n+      if (placeholder instanceof TmplAstBoundText) {\n+        this.opQueue.push(new TcbTextInterpolationOp(this.tcb, this, placeholder));\n+      }\n+    }\n+  }\n }\n \n interface TcbBoundInput {"
        },
        {
            "sha": "0104b024a2851177f39278192f5b305686b7bc86",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/diagnostics_spec.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/0a16e60afae27c7af023cf617de05297dddf5135/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0a16e60afae27c7af023cf617de05297dddf5135/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts?ref=0a16e60afae27c7af023cf617de05297dddf5135",
            "patch": "@@ -176,6 +176,21 @@ runInEachFileSystem(() => {\n       ]);\n     });\n \n+    it('checks expressions in ICUs', () => {\n+      const messages = diagnose(\n+          `<span i18n>{switch, plural, other { {{interpolation}}\n+            {nestedSwitch, plural, other { {{nestedInterpolation}} }}\n+          }}</span>`,\n+          `class TestComponent {}`);\n+\n+      expect(messages.sort()).toEqual([\n+        `TestComponent.html(1, 13): Property 'switch' does not exist on type 'TestComponent'.`,\n+        `TestComponent.html(1, 39): Property 'interpolation' does not exist on type 'TestComponent'.`,\n+        `TestComponent.html(2, 14): Property 'nestedSwitch' does not exist on type 'TestComponent'.`,\n+        `TestComponent.html(2, 46): Property 'nestedInterpolation' does not exist on type 'TestComponent'.`,\n+      ]);\n+    });\n+\n     it('produces diagnostics for pipes', () => {\n       const messages = diagnose(\n           `<div>{{ person.name | pipe:person.age:1 }}</div>`, `"
        },
        {
            "sha": "e60ef28312c098592d9efc1552d89e9d8c201d83",
            "filename": "packages/compiler/src/compiler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/0a16e60afae27c7af023cf617de05297dddf5135/packages%2Fcompiler%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/0a16e60afae27c7af023cf617de05297dddf5135/packages%2Fcompiler%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler.ts?ref=0a16e60afae27c7af023cf617de05297dddf5135",
            "patch": "@@ -92,7 +92,7 @@ export {getParseErrors, isSyntaxError, syntaxError, Version} from './util';\n export {SourceMap} from './output/source_map';\n export * from './injectable_compiler_2';\n export * from './render3/view/api';\n-export {BoundAttribute as TmplAstBoundAttribute, BoundEvent as TmplAstBoundEvent, BoundText as TmplAstBoundText, Content as TmplAstContent, Element as TmplAstElement, Node as TmplAstNode, RecursiveVisitor as TmplAstRecursiveVisitor, Reference as TmplAstReference, Template as TmplAstTemplate, Text as TmplAstText, TextAttribute as TmplAstTextAttribute, Variable as TmplAstVariable,} from './render3/r3_ast';\n+export {BoundAttribute as TmplAstBoundAttribute, BoundEvent as TmplAstBoundEvent, BoundText as TmplAstBoundText, Content as TmplAstContent, Element as TmplAstElement, Icu as TmplAstIcu, Node as TmplAstNode, RecursiveVisitor as TmplAstRecursiveVisitor, Reference as TmplAstReference, Template as TmplAstTemplate, Text as TmplAstText, TextAttribute as TmplAstTextAttribute, Variable as TmplAstVariable} from './render3/r3_ast';\n export * from './render3/view/t2_api';\n export * from './render3/view/t2_binder';\n export {Identifiers as R3Identifiers} from './render3/r3_identifiers';"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 30,
        "deletions": 2
    }
}