{
    "author": "crisbeto",
    "message": "fix(core): handle !important in style property value (#39603)\n\n* Fixes that the Ivy styling logic wasn't accounting for `!important` in the property value.\n* Fixes that the default DOM renderer only sets `!important` on a property with a dash in its name.\n* Accounts for the `flags` parameter of `setStyle` in the server renderer.\n\nFixes #35323.\n\nPR Close #39603",
    "sha": "44763245e1d0c94343cdab89a7e0c30f5f32fc55",
    "files": [
        {
            "sha": "716bf6c5e47cc189e841a74405bb2543acf912f3",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/44763245e1d0c94343cdab89a7e0c30f5f32fc55/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/44763245e1d0c94343cdab89a7e0c30f5f32fc55/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=44763245e1d0c94343cdab89a7e0c30f5f32fc55",
            "patch": "@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3037,\n-        \"main-es2015\": 448922,\n+        \"main-es2015\": 449483,\n         \"polyfills-es2015\": 52415\n       }\n     }"
        },
        {
            "sha": "a08fbce88ca88b1dcd7bde95b7436817987ad2cb",
            "filename": "packages/core/src/render3/node_manipulation.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/44763245e1d0c94343cdab89a7e0c30f5f32fc55/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "raw_url": "https://github.com/angular/angular/raw/44763245e1d0c94343cdab89a7e0c30f5f32fc55/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts?ref=44763245e1d0c94343cdab89a7e0c30f5f32fc55",
            "patch": "@@ -987,6 +987,13 @@ function applyContainer(\n   }\n }\n \n+// TODO(misko): Can't import RendererStyleFlags2.DashCase as it causes imports to be resolved\n+// in different order which causes failures. Duplicating for now.\n+const enum TempRendererStyleFlags2 {\n+  Important = 1 << 0,\n+  DashCase = 1 << 1\n+}\n+\n /**\n  * Writes class/style to element.\n  *\n@@ -1019,9 +1026,7 @@ export function applyStyling(\n       }\n     }\n   } else {\n-    // TODO(misko): Can't import RendererStyleFlags2.DashCase as it causes imports to be resolved\n-    // in different order which causes failures. Using direct constant as workaround for now.\n-    const flags = prop.indexOf('-') == -1 ? undefined : 2 /* RendererStyleFlags2.DashCase */;\n+    let flags = prop.indexOf('-') === -1 ? undefined : TempRendererStyleFlags2.DashCase as number;\n     if (value == null /** || value === undefined */) {\n       ngDevMode && ngDevMode.rendererRemoveStyle++;\n       if (isProcedural) {\n@@ -1030,12 +1035,22 @@ export function applyStyling(\n         (rNode as HTMLElement).style.removeProperty(prop);\n       }\n     } else {\n+      // A value is important if it ends with `!important`. The style\n+      // parser strips any semicolons at the end of the value.\n+      const isImportant = typeof value === 'string' ? value.endsWith('!important') : false;\n+\n+      if (isImportant) {\n+        // !important has to be stripped from the value for it to be valid.\n+        value = value.slice(0, -10);\n+        flags! |= TempRendererStyleFlags2.Important;\n+      }\n+\n       ngDevMode && ngDevMode.rendererSetStyle++;\n       if (isProcedural) {\n         (renderer as Renderer2).setStyle(rNode, prop, value, flags);\n       } else {\n         ngDevMode && assertDefined((rNode as HTMLElement).style, 'HTMLElement expected');\n-        (rNode as HTMLElement).style.setProperty(prop, value);\n+        (rNode as HTMLElement).style.setProperty(prop, value, isImportant ? 'important' : '');\n       }\n     }\n   }"
        },
        {
            "sha": "e6ac22da2175c9c84330fd9ec623a8f12f7bc585",
            "filename": "packages/core/test/acceptance/styling_spec.ts",
            "status": "modified",
            "additions": 149,
            "deletions": 0,
            "changes": 149,
            "blob_url": "https://github.com/angular/angular/blob/44763245e1d0c94343cdab89a7e0c30f5f32fc55/packages%2Fcore%2Ftest%2Facceptance%2Fstyling_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/44763245e1d0c94343cdab89a7e0c30f5f32fc55/packages%2Fcore%2Ftest%2Facceptance%2Fstyling_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fstyling_spec.ts?ref=44763245e1d0c94343cdab89a7e0c30f5f32fc55",
            "patch": "@@ -12,6 +12,7 @@ import {ngDevModeResetPerfCounters} from '@angular/core/src/util/ng_dev_mode';\n import {TestBed} from '@angular/core/testing';\n import {getElementClasses, getElementStyles, getSortedClassName, getSortedStyle} from '@angular/core/testing/src/styling';\n import {By, DomSanitizer, SafeStyle} from '@angular/platform-browser';\n+import {browserDetection} from '@angular/platform-browser/testing/src/browser_util';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n import {ivyEnabled, modifiedInIvy, onlyInIvy} from '@angular/private/testing';\n \n@@ -801,6 +802,154 @@ describe('styling', () => {\n     });\n   });\n \n+  onlyInIvy('ViewEngine only supports !important when set through the `style` attribute')\n+      .it('should set !important on a single property', () => {\n+        // We go through `CSSStyleDeclaration.setProperty` to set `!important`. Values set through\n+        // `setProperty` aren't propagated to the `style` attribute on IE11, even though the style\n+        // is applied, so we have to skip the test there since we don't have a way of asserting.\n+        if (browserDetection.isIE) {\n+          return;\n+        }\n+\n+        @Component({template: '<div [style.width]=\"width\"></div>'})\n+        class Cmp {\n+          width!: string;\n+        }\n+\n+        TestBed.configureTestingModule({declarations: [Cmp]});\n+        const fixture = TestBed.createComponent(Cmp);\n+        fixture.componentInstance.width = '50px !important';\n+        fixture.detectChanges();\n+        const html = fixture.nativeElement.innerHTML;\n+\n+        // We have to check the `style` attribute, because `element.style.prop` doesn't include\n+        // `!important`. Use a regex, because the different renderers produce different whitespace.\n+        expect(html).toMatch(/style=[\"|']width:\\s*50px\\s*!important/);\n+\n+        onlyInIvy('perf counters').expectPerfCounters({\n+          rendererSetStyle: 1,\n+          tNode: 2,\n+        });\n+      });\n+\n+  onlyInIvy('ViewEngine only supports !important when set through the `style` attribute')\n+      .it('should set !important that is not preceded by a space', () => {\n+        // We go through `CSSStyleDeclaration.setProperty` to set `!important`. Values set through\n+        // `setProperty` aren't propagated to the `style` attribute on IE11, even though the style\n+        // is applied, so we have to skip the test there since we don't have a way of asserting.\n+        if (browserDetection.isIE) {\n+          return;\n+        }\n+\n+        @Component({template: '<div [style.width]=\"width\"></div>'})\n+        class Cmp {\n+          width!: string;\n+        }\n+\n+        TestBed.configureTestingModule({declarations: [Cmp]});\n+        const fixture = TestBed.createComponent(Cmp);\n+        fixture.componentInstance.width = '50px!important';\n+        fixture.detectChanges();\n+        const html = fixture.nativeElement.innerHTML;\n+\n+        // We have to check the `style` attribute, because `element.style.prop` doesn't include\n+        // `!important`. Use a regex, because the different renderers produce different whitespace.\n+        expect(html).toMatch(/style=[\"|']width:\\s*50px\\s*!important/);\n+\n+        onlyInIvy('perf counters').expectPerfCounters({\n+          rendererSetStyle: 1,\n+          tNode: 2,\n+        });\n+      });\n+\n+  onlyInIvy('ViewEngine only supports !important when set through the `style` attribute')\n+      .it('should set !important on a dash-case property', () => {\n+        // We go through `CSSStyleDeclaration.setProperty` to set `!important`. Values set through\n+        // `setProperty` aren't propagated to the `style` attribute on IE11, even though the style\n+        // is applied, so we have to skip the test there since we don't have a way of asserting.\n+        if (browserDetection.isIE) {\n+          return;\n+        }\n+\n+        @Component({template: '<div [style.margin-right]=\"marginRight\"></div>'})\n+        class Cmp {\n+          marginRight!: string;\n+        }\n+\n+        TestBed.configureTestingModule({declarations: [Cmp]});\n+        const fixture = TestBed.createComponent(Cmp);\n+        fixture.componentInstance.marginRight = '5px !important';\n+        fixture.detectChanges();\n+        const html = fixture.nativeElement.innerHTML;\n+\n+        // We have to check the `style` attribute, because `element.style.prop` doesn't include\n+        // `!important`. Use a regex, because the different renderers produce different whitespace.\n+        expect(html).toMatch(/style=[\"|']margin-right:\\s*5px\\s*!important/);\n+\n+        onlyInIvy('perf counters').expectPerfCounters({\n+          rendererSetStyle: 1,\n+          tNode: 2,\n+        });\n+      });\n+\n+  it('should set !important on multiple properties', () => {\n+    // We go through `CSSStyleDeclaration.setProperty` to set `!important`. Values set through\n+    // `setProperty` aren't propagated to the `style` attribute on IE11, even though the style is\n+    // applied, so we have to skip the test there since we don't have a way of asserting.\n+    if (browserDetection.isIE) {\n+      return;\n+    }\n+\n+    @Component({template: '<div [style]=\"styles\"></div>'})\n+    class Cmp {\n+      styles!: string;\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [Cmp]});\n+    const fixture = TestBed.createComponent(Cmp);\n+    fixture.componentInstance.styles = 'height: 25px !important; width: 50px !important;';\n+    fixture.detectChanges();\n+    const html = fixture.nativeElement.innerHTML;\n+\n+    // We have to check the `style` attribute, because `element.style.prop` doesn't include\n+    // `!important`. Use a regex, because the different renderers produce different whitespace.\n+    expect(html).toMatch(/style=[\"|']height:\\s*25px\\s*!important;\\s*width:\\s*50px\\s*!important/);\n+\n+    onlyInIvy('perf counters').expectPerfCounters({\n+      rendererSetStyle: 2,\n+      tNode: 2,\n+    });\n+  });\n+\n+  it('should set !important if some properties are !important and other are not', () => {\n+    // We go through `CSSStyleDeclaration.setProperty` to set `!important`. Values set through\n+    // `setProperty` aren't propagated to the `style` attribute on IE11, even though the style is\n+    // applied, so we have to skip the test there since we don't have a way of asserting.\n+    if (browserDetection.isIE) {\n+      return;\n+    }\n+\n+    @Component({template: '<div [style]=\"styles\"></div>'})\n+    class Cmp {\n+      styles!: string;\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [Cmp]});\n+    const fixture = TestBed.createComponent(Cmp);\n+    fixture.componentInstance.styles = 'height: 25px; width: 50px !important;';\n+    fixture.detectChanges();\n+    const html = fixture.nativeElement.innerHTML;\n+\n+    // We have to check the `style` attribute, because `element.style.prop` doesn't include\n+    // `!important`. Use a regex, because the different renderers produce different whitespace.\n+    expect(html).toMatch(/style=[\"|']height:\\s*25px;\\s*width:\\s*50px\\s*!important/);\n+\n+    onlyInIvy('perf counters').expectPerfCounters({\n+      rendererSetStyle: 2,\n+      tNode: 2,\n+    });\n+  });\n+\n   it('should not write to the native element if a directive shadows the class input', () => {\n     // This ex is a bit contrived. In real apps, you might have a shared class that is extended\n     // both by components with host elements and by directives on template nodes. In that case, the"
        },
        {
            "sha": "b9f8e66cf40c1e10b70ef16aa18ec4e9871bc9f5",
            "filename": "packages/platform-browser/src/dom/dom_renderer.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/44763245e1d0c94343cdab89a7e0c30f5f32fc55/packages%2Fplatform-browser%2Fsrc%2Fdom%2Fdom_renderer.ts",
            "raw_url": "https://github.com/angular/angular/raw/44763245e1d0c94343cdab89a7e0c30f5f32fc55/packages%2Fplatform-browser%2Fsrc%2Fdom%2Fdom_renderer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Fsrc%2Fdom%2Fdom_renderer.ts?ref=44763245e1d0c94343cdab89a7e0c30f5f32fc55",
            "patch": "@@ -234,9 +234,8 @@ class DefaultDomRenderer2 implements Renderer2 {\n   }\n \n   setStyle(el: any, style: string, value: any, flags: RendererStyleFlags2): void {\n-    if (flags & RendererStyleFlags2.DashCase) {\n-      el.style.setProperty(\n-          style, value, !!(flags & RendererStyleFlags2.Important) ? 'important' : '');\n+    if (flags & (RendererStyleFlags2.DashCase | RendererStyleFlags2.Important)) {\n+      el.style.setProperty(style, value, flags & RendererStyleFlags2.Important ? 'important' : '');\n     } else {\n       el.style[style] = value;\n     }"
        },
        {
            "sha": "33f21fa4abc7a68ac4be720daa42231518180972",
            "filename": "packages/platform-server/src/server_renderer.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/44763245e1d0c94343cdab89a7e0c30f5f32fc55/packages%2Fplatform-server%2Fsrc%2Fserver_renderer.ts",
            "raw_url": "https://github.com/angular/angular/raw/44763245e1d0c94343cdab89a7e0c30f5f32fc55/packages%2Fplatform-server%2Fsrc%2Fserver_renderer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-server%2Fsrc%2Fserver_renderer.ts?ref=44763245e1d0c94343cdab89a7e0c30f5f32fc55",
            "patch": "@@ -160,6 +160,9 @@ class DefaultServerRenderer2 implements Renderer2 {\n   setStyle(el: any, style: string, value: any, flags: RendererStyleFlags2): void {\n     style = style.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();\n     const styleMap = _readStyleAttribute(el);\n+    if (flags & RendererStyleFlags2.Important) {\n+      value += ' !important';\n+    }\n     styleMap[style] = value == null ? '' : value;\n     _writeStyleAttribute(el, styleMap);\n   }"
        }
    ],
    "stats": {
        "total": 182,
        "additions": 174,
        "deletions": 8
    }
}