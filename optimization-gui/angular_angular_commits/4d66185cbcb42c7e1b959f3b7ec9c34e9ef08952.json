{
    "author": "AndrewKushnir",
    "message": "fix(forms): properly cleanup in cases when FormControlName has no CVA (#40526)\n\nPR #39235 introduced additional cleanup logic for form controls and directives. The cleanup logic relies\non the presence of ControlValueAccessor instances on FormControlName and FormControl directives. In general\nthese fields are present and there are also checks to make sure that the mentioned directive instances are\ncreated with CVAs. However some scenarios (primarily tests) may invoke the logic in a way that the directive\ninstance would not be fully initialized, thus causing CVA to be absent. As a result, the cleanup logic fails\nwhile trying to call some methods on associated CVA instances.\n\nThis commit updates the cleanup logic to take into account the situation when CVA is not present.\n\nFixes #40521.\n\nPR Close #40526",
    "sha": "4d66185cbcb42c7e1b959f3b7ec9c34e9ef08952",
    "files": [
        {
            "sha": "17c0a1d75ae117c5c1aa8154d388956f94c4b576",
            "filename": "packages/forms/src/directives/shared.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/4d66185cbcb42c7e1b959f3b7ec9c34e9ef08952/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/4d66185cbcb42c7e1b959f3b7ec9c34e9ef08952/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts?ref=4d66185cbcb42c7e1b959f3b7ec9c34e9ef08952",
            "patch": "@@ -75,8 +75,15 @@ export function cleanUpControl(\n     }\n   };\n \n-  dir.valueAccessor!.registerOnChange(noop);\n-  dir.valueAccessor!.registerOnTouched(noop);\n+  // The `valueAccessor` field is typically defined on FromControl and FormControlName directive\n+  // instances and there is a logic in `selectValueAccessor` function that throws if it's not the\n+  // case. We still check the presence of `valueAccessor` before invoking its methods to make sure\n+  // that cleanup works correctly if app code or tests are setup to ignore the error thrown from\n+  // `selectValueAccessor`. See https://github.com/angular/angular/issues/40521.\n+  if (dir.valueAccessor) {\n+    dir.valueAccessor.registerOnChange(noop);\n+    dir.valueAccessor.registerOnTouched(noop);\n+  }\n \n   cleanUpValidators(control, dir, /* handleOnValidatorChange */ true);\n "
        },
        {
            "sha": "fcdb1c6c451c384f09d059ea1f1a3f3471f466ee",
            "filename": "packages/forms/test/reactive_integration_spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 1,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/4d66185cbcb42c7e1b959f3b7ec9c34e9ef08952/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4d66185cbcb42c7e1b959f3b7ec9c34e9ef08952/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts?ref=4d66185cbcb42c7e1b959f3b7ec9c34e9ef08952",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {ÉµgetDOM as getDOM} from '@angular/common';\n-import {Component, Directive, forwardRef, Input, OnDestroy, Type} from '@angular/core';\n+import {Component, Directive, forwardRef, Input, NgModule, OnDestroy, Type} from '@angular/core';\n import {ComponentFixture, fakeAsync, TestBed, tick} from '@angular/core/testing';\n import {expect} from '@angular/core/testing/src/testing_internal';\n import {AbstractControl, AsyncValidator, AsyncValidatorFn, COMPOSITION_BUFFER_MODE, ControlValueAccessor, DefaultValueAccessor, FormArray, FormControl, FormControlDirective, FormControlName, FormGroup, FormGroupDirective, FormsModule, NG_ASYNC_VALIDATORS, NG_VALIDATORS, NG_VALUE_ACCESSOR, ReactiveFormsModule, Validator, Validators} from '@angular/forms';\n@@ -4127,6 +4127,32 @@ const ValueAccessorB = createControlValueAccessor('[cva-b]');\n           valueChanges: {group: {control: 'Updated value'}},\n         });\n       });\n+\n+      // See https://github.com/angular/angular/issues/40521.\n+      it('should properly clean up when FormControlName has no CVA', () => {\n+        @Component({\n+          selector: 'no-cva-compo',\n+          template: `\n+            <form [formGroup]=\"form\">\n+              <div formControlName=\"control\"></div>\n+            </form>\n+          `\n+        })\n+        class NoCVAComponent {\n+          form = new FormGroup({control: new FormControl()});\n+        }\n+\n+        const fixture = initTest(NoCVAComponent);\n+        expect(() => {\n+          fixture.detectChanges();\n+        }).toThrowError('No value accessor for form control with name: \\'control\\'');\n+\n+        // Making sure that cleanup between tests doesn't cause any issues\n+        // for not fully initialized controls.\n+        expect(() => {\n+          fixture.destroy();\n+        }).not.toThrow();\n+      });\n     });\n   });\n }"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 36,
        "deletions": 3
    }
}