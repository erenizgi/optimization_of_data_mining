{
    "author": "clydin",
    "message": "refactor(migrations): support use of an ESM `@angular/compiler-cli` package (#43657)\n\nCurrently, migrations and schematics must be in CommonJS format. However, framework packages will only be ESM from v13 and onward. To support this configuration, dynamic import expressions are now used to load `@angular/compiler-cli` and its new secondary entry point `@angular/compiler-cli/private/migrations`. Dynamic imports within Node.js allow the `@angular/core` migrationsâ€™ CommonJS code to load ESM code. Unfortunately, TypeScript will currently, unconditionally down-level dynamic import into a require call. `require` calls cannot load ESM code and will result in a runtime error. To workaround this, a Function constructor is used to prevent TypeScript from changing the dynamic import. Once TypeScript provides support for keeping the dynamic import this workaround can be dropped and replaced with a standard dynamic import.  Due to the use of the dynamic import, a reference to the dynamically loaded modules must now be passed to all locations that use values from the modules.\n\nPR Close #43657",
    "sha": "e0015d3c456d584242269b0765878d598a550888",
    "files": [
        {
            "sha": "74bfee1edb4cb88f2574df91b81196c948a3dbd0",
            "filename": "packages/core/schematics/migrations/google3/BUILD.bazel",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FBUILD.bazel?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -7,6 +7,10 @@ ts_library(\n     visibility = [\"//packages/core/schematics/test/google3:__pkg__\"],\n     deps = [\n         \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/annotations\",\n+        \"//packages/compiler-cli/src/ngtsc/imports\",\n+        \"//packages/compiler-cli/src/ngtsc/partial_evaluator\",\n+        \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/core/schematics/migrations/activated-route-snapshot-fragment\",\n         \"//packages/core/schematics/migrations/can-activate-with-redirect-to\",\n         \"//packages/core/schematics/migrations/dynamic-queries\","
        },
        {
            "sha": "e1eabb0cac7762cb2808f259a9e73bbb1fc2996f",
            "filename": "packages/core/schematics/migrations/google3/noMissingInjectableRule.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FnoMissingInjectableRule.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FnoMissingInjectableRule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FnoMissingInjectableRule.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -6,6 +6,11 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {forwardRefResolver} from '@angular/compiler-cli/src/ngtsc/annotations';\n+import {Reference} from '@angular/compiler-cli/src/ngtsc/imports';\n+import {DynamicValue, PartialEvaluator} from '@angular/compiler-cli/src/ngtsc/partial_evaluator';\n+import {StaticInterpreter} from '@angular/compiler-cli/src/ngtsc/partial_evaluator/src/interpreter';\n+import {reflectObjectLiteral, TypeScriptReflectionHost} from '@angular/compiler-cli/src/ngtsc/reflection';\n import {RuleFailure, Rules} from 'tslint';\n import ts from 'typescript';\n \n@@ -34,7 +39,15 @@ export class Rule extends Rules.TypedRule {\n     sourceFiles.forEach(sourceFile => definitionCollector.visitNode(sourceFile));\n \n     const {resolvedModules, resolvedDirectives} = definitionCollector;\n-    const transformer = new MissingInjectableTransform(typeChecker, getUpdateRecorder);\n+    const transformer = new MissingInjectableTransform(typeChecker, getUpdateRecorder, {\n+      Reference,\n+      DynamicValue,\n+      PartialEvaluator,\n+      StaticInterpreter,\n+      TypeScriptReflectionHost,\n+      forwardRefResolver,\n+      reflectObjectLiteral,\n+    });\n     const updateRecorders = new Map<ts.SourceFile, TslintUpdateRecorder>();\n \n     [...transformer.migrateModules(resolvedModules),"
        },
        {
            "sha": "99492c0efb76c0e8efd460fd03ce884d4904f86d",
            "filename": "packages/core/schematics/migrations/google3/undecoratedClassesWithDecoratedFieldsRule.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FundecoratedClassesWithDecoratedFieldsRule.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FundecoratedClassesWithDecoratedFieldsRule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FundecoratedClassesWithDecoratedFieldsRule.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -5,7 +5,11 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-\n+import {forwardRefResolver} from '@angular/compiler-cli/src/ngtsc/annotations';\n+import {Reference} from '@angular/compiler-cli/src/ngtsc/imports';\n+import {DynamicValue, PartialEvaluator} from '@angular/compiler-cli/src/ngtsc/partial_evaluator';\n+import {StaticInterpreter} from '@angular/compiler-cli/src/ngtsc/partial_evaluator/src/interpreter';\n+import {reflectObjectLiteral, TypeScriptReflectionHost} from '@angular/compiler-cli/src/ngtsc/reflection';\n import {RuleFailure, Rules} from 'tslint';\n import ts from 'typescript';\n import {TslintUpdateRecorder} from '../undecorated-classes-with-decorated-fields/google3/tslint_update_recorder';\n@@ -23,7 +27,15 @@ export class Rule extends Rules.TypedRule {\n         s => !s.isDeclarationFile && !program.isSourceFileFromExternalLibrary(s));\n     const updateRecorders = new Map<ts.SourceFile, TslintUpdateRecorder>();\n     const transform =\n-        new UndecoratedClassesWithDecoratedFieldsTransform(typeChecker, getUpdateRecorder);\n+        new UndecoratedClassesWithDecoratedFieldsTransform(typeChecker, getUpdateRecorder, {\n+          Reference,\n+          DynamicValue,\n+          PartialEvaluator,\n+          StaticInterpreter,\n+          TypeScriptReflectionHost,\n+          forwardRefResolver,\n+          reflectObjectLiteral,\n+        });\n \n     // Migrate all source files in the project.\n     transform.migrate(sourceFiles);"
        },
        {
            "sha": "5052f5ff45473eedc615820f68460616ec60d562",
            "filename": "packages/core/schematics/migrations/missing-injectable/index.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Findex.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -9,6 +9,8 @@\n import {Rule, SchematicContext, SchematicsException, Tree} from '@angular-devkit/schematics';\n import {relative} from 'path';\n import ts from 'typescript';\n+\n+import {loadCompilerCliMigrationsModule, loadEsmModule} from '../../utils/load_esm';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n import {NgDefinitionCollector} from './definition_collector';\n@@ -28,8 +30,20 @@ export default function(): Rule {\n           'which don\\'t have that decorator set.');\n     }\n \n+    let compilerCliMigrationsModule;\n+    try {\n+      // Load ESM `@angular/compiler/private/migrations` using the TypeScript dynamic import\n+      // workaround. Once TypeScript provides support for keeping the dynamic import this workaround\n+      // can be changed to a direct dynamic import.\n+      compilerCliMigrationsModule = await loadCompilerCliMigrationsModule();\n+    } catch (e) {\n+      throw new SchematicsException(\n+          `Unable to load the '@angular/compiler-cli' package. Details: ${e.message}`);\n+    }\n+\n     for (const tsconfigPath of [...buildPaths, ...testPaths]) {\n-      failures.push(...runMissingInjectableMigration(tree, tsconfigPath, basePath));\n+      failures.push(...runMissingInjectableMigration(\n+          tree, tsconfigPath, basePath, compilerCliMigrationsModule));\n     }\n \n     if (failures.length) {\n@@ -41,7 +55,9 @@ export default function(): Rule {\n }\n \n function runMissingInjectableMigration(\n-    tree: Tree, tsconfigPath: string, basePath: string): string[] {\n+    tree: Tree, tsconfigPath: string, basePath: string,\n+    compilerCliMigrationsModule: typeof import('@angular/compiler-cli/private/migrations')):\n+    string[] {\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const failures: string[] = [];\n   const typeChecker = program.getTypeChecker();\n@@ -53,7 +69,8 @@ function runMissingInjectableMigration(\n   sourceFiles.forEach(sourceFile => definitionCollector.visitNode(sourceFile));\n \n   const {resolvedModules, resolvedDirectives} = definitionCollector;\n-  const transformer = new MissingInjectableTransform(typeChecker, getUpdateRecorder);\n+  const transformer =\n+      new MissingInjectableTransform(typeChecker, getUpdateRecorder, compilerCliMigrationsModule);\n   const updateRecorders = new Map<ts.SourceFile, UpdateRecorder>();\n \n   [...transformer.migrateModules(resolvedModules),"
        },
        {
            "sha": "1d7928454c43ef96b26f47afff8f52577b42a9ec",
            "filename": "packages/core/schematics/migrations/missing-injectable/providers_evaluator.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 34,
            "changes": 86,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Fproviders_evaluator.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Fproviders_evaluator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Fproviders_evaluator.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -6,51 +6,69 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {forwardRefResolver, ResolvedValue, StaticInterpreter} from '@angular/compiler-cli/private/migrations';\n import ts from 'typescript';\n \n+import type {ResolvedValue, TypeScriptReflectionHost} from '@angular/compiler-cli/private/migrations';\n+\n export interface ProviderLiteral {\n   node: ts.ObjectLiteralExpression;\n   resolvedValue: ResolvedValue;\n }\n \n /**\n- * Providers evaluator that extends the ngtsc static interpreter. This is necessary because\n- * the static interpreter by default only exposes the resolved value, but we are also interested\n- * in the TypeScript nodes that declare providers. It would be possible to manually traverse the\n- * AST to collect these nodes, but that would mean that we need to re-implement the static\n- * interpreter in order to handle all possible scenarios. (e.g. spread operator, function calls,\n- * callee scope). This can be avoided by simply extending the static interpreter and intercepting\n- * the \"visitObjectLiteralExpression\" method.\n+ * A factory function to create an evaluator for providers. This is required to be a\n+ * factory function because the underlying class extends a class that is only available\n+ * from within a dynamically imported module (`@angular/compiler-cli/private/migrations`)\n+ * and is therefore not available at module evaluation time.\n  */\n-export class ProvidersEvaluator extends StaticInterpreter {\n-  private _providerLiterals: ProviderLiteral[] = [];\n+export function createProvidersEvaluator(\n+    compilerCliMigrationsModule: typeof import('@angular/compiler-cli/private/migrations'),\n+    host: TypeScriptReflectionHost, checker: ts.TypeChecker): {\n+  evaluate:\n+      (expr: ts.Expression) => {\n+        resolvedValue: ResolvedValue, literals: ProviderLiteral[]\n+      }\n+} {\n+  /**\n+   * Providers evaluator that extends the ngtsc static interpreter. This is necessary because\n+   * the static interpreter by default only exposes the resolved value, but we are also interested\n+   * in the TypeScript nodes that declare providers. It would be possible to manually traverse the\n+   * AST to collect these nodes, but that would mean that we need to re-implement the static\n+   * interpreter in order to handle all possible scenarios. (e.g. spread operator, function calls,\n+   * callee scope). This can be avoided by simply extending the static interpreter and intercepting\n+   * the \"visitObjectLiteralExpression\" method.\n+   */\n+  class ProvidersEvaluator extends compilerCliMigrationsModule.StaticInterpreter {\n+    private _providerLiterals: ProviderLiteral[] = [];\n \n-  override visitObjectLiteralExpression(node: ts.ObjectLiteralExpression, context: any) {\n-    const resolvedValue =\n-        super.visitObjectLiteralExpression(node, {...context, insideProviderDef: true});\n-    // do not collect nested object literals. e.g. a provider could use a\n-    // spread assignment (which resolves to another object literal). In that\n-    // case the referenced object literal is not a provider object literal.\n-    if (!context.insideProviderDef) {\n-      this._providerLiterals.push({node, resolvedValue});\n+    override visitObjectLiteralExpression(node: ts.ObjectLiteralExpression, context: any) {\n+      const resolvedValue =\n+          super.visitObjectLiteralExpression(node, {...context, insideProviderDef: true});\n+      // do not collect nested object literals. e.g. a provider could use a\n+      // spread assignment (which resolves to another object literal). In that\n+      // case the referenced object literal is not a provider object literal.\n+      if (!context.insideProviderDef) {\n+        this._providerLiterals.push({node, resolvedValue});\n+      }\n+      return resolvedValue;\n     }\n-    return resolvedValue;\n-  }\n \n-  /**\n-   * Evaluates the given expression and returns its statically resolved value\n-   * and a list of object literals which define Angular providers.\n-   */\n-  evaluate(expr: ts.Expression) {\n-    this._providerLiterals = [];\n-    const resolvedValue = this.visit(expr, {\n-      originatingFile: expr.getSourceFile(),\n-      absoluteModuleName: null,\n-      resolutionContext: expr.getSourceFile().fileName,\n-      scope: new Map(),\n-      foreignFunctionResolver: forwardRefResolver\n-    });\n-    return {resolvedValue, literals: this._providerLiterals};\n+    /**\n+     * Evaluates the given expression and returns its statically resolved value\n+     * and a list of object literals which define Angular providers.\n+     */\n+    evaluate(expr: ts.Expression) {\n+      this._providerLiterals = [];\n+      const resolvedValue = this.visit(expr, {\n+        originatingFile: expr.getSourceFile(),\n+        absoluteModuleName: null,\n+        resolutionContext: expr.getSourceFile().fileName,\n+        scope: new Map(),\n+        foreignFunctionResolver: compilerCliMigrationsModule.forwardRefResolver\n+      });\n+      return {resolvedValue, literals: this._providerLiterals};\n+    }\n   }\n+\n+  return new ProvidersEvaluator(host, checker, /* dependencyTracker */ null);\n }"
        },
        {
            "sha": "0c996748e3e4c3ceac326645f52830c98951deb4",
            "filename": "packages/core/schematics/migrations/missing-injectable/transform.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Ftransform.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Ftransform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Ftransform.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -6,14 +6,14 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {DynamicValue, Reference, ResolvedValue, TypeScriptReflectionHost} from '@angular/compiler-cli/private/migrations';\n+import type {ResolvedValue} from '@angular/compiler-cli/private/migrations';\n import ts from 'typescript';\n \n import {ImportManager} from '../../utils/import_manager';\n import {getAngularDecorators} from '../../utils/ng_decorators';\n \n import {ResolvedDirective, ResolvedNgModule} from './definition_collector';\n-import {ProviderLiteral, ProvidersEvaluator} from './providers_evaluator';\n+import {createProvidersEvaluator, ProviderLiteral} from './providers_evaluator';\n import {UpdateRecorder} from './update_recorder';\n \n /**\n@@ -33,7 +33,7 @@ export interface AnalysisFailure {\n export class MissingInjectableTransform {\n   private printer = ts.createPrinter();\n   private importManager = new ImportManager(this.getUpdateRecorder, this.printer);\n-  private providersEvaluator: ProvidersEvaluator;\n+  private providersEvaluator;\n \n   /** Set of provider class declarations which were already checked or migrated. */\n   private visitedProviderClasses = new Set<ts.ClassDeclaration>();\n@@ -43,9 +43,12 @@ export class MissingInjectableTransform {\n \n   constructor(\n       private typeChecker: ts.TypeChecker,\n-      private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder) {\n-    this.providersEvaluator = new ProvidersEvaluator(\n-        new TypeScriptReflectionHost(typeChecker), typeChecker, /* dependencyTracker */ null);\n+      private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder,\n+      private compilerCliMigrationsModule:\n+          typeof import('@angular/compiler-cli/private/migrations')) {\n+    this.providersEvaluator = createProvidersEvaluator(\n+        compilerCliMigrationsModule,\n+        new compilerCliMigrationsModule.TypeScriptReflectionHost(typeChecker), typeChecker);\n   }\n \n   recordChanges() {\n@@ -214,7 +217,8 @@ export class MissingInjectableTransform {\n    */\n   private _visitProviderResolvedValue(value: ResolvedValue, module: ResolvedNgModule):\n       AnalysisFailure[] {\n-    if (value instanceof Reference && ts.isClassDeclaration(value.node)) {\n+    if (value instanceof this.compilerCliMigrationsModule.Reference &&\n+        ts.isClassDeclaration(value.node)) {\n       this.migrateProviderClass(value.node, module);\n     } else if (value instanceof Map) {\n       // If a \"ClassProvider\" has the \"deps\" property set, then we do not need to\n@@ -227,7 +231,7 @@ export class MissingInjectableTransform {\n       return value.reduce(\n           (res, v) => res.concat(this._visitProviderResolvedValue(v, module)),\n           [] as AnalysisFailure[]);\n-    } else if (value instanceof DynamicValue) {\n+    } else if (value instanceof this.compilerCliMigrationsModule.DynamicValue) {\n       return [{node: value.node, message: `Provider is not statically analyzable.`}];\n     }\n     return [];"
        },
        {
            "sha": "b315211ac426edd4bc4a7edcf3b331761993f30a",
            "filename": "packages/core/schematics/migrations/module-with-providers/index.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fmodule-with-providers%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fmodule-with-providers%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fmodule-with-providers%2Findex.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -10,6 +10,7 @@ import {Rule, SchematicContext, SchematicsException, Tree, UpdateRecorder} from\n import {relative} from 'path';\n import ts from 'typescript';\n \n+import {loadCompilerCliMigrationsModule, loadEsmModule} from '../../utils/load_esm';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n \n@@ -32,8 +33,20 @@ export default function(): Rule {\n           'Could not find any tsconfig file. Cannot migrate ModuleWithProviders.');\n     }\n \n+    let compilerCliMigrationsModule;\n+    try {\n+      // Load ESM `@angular/compiler/private/migrations` using the TypeScript dynamic import\n+      // workaround. Once TypeScript provides support for keeping the dynamic import this workaround\n+      // can be changed to a direct dynamic import.\n+      compilerCliMigrationsModule = await loadCompilerCliMigrationsModule();\n+    } catch (e) {\n+      throw new SchematicsException(\n+          `Unable to load the '@angular/compiler-cli' package. Details: ${e.message}`);\n+    }\n+\n     for (const tsconfigPath of allPaths) {\n-      failures.push(...runModuleWithProvidersMigration(tree, tsconfigPath, basePath));\n+      failures.push(...runModuleWithProvidersMigration(\n+          tree, tsconfigPath, basePath, compilerCliMigrationsModule));\n     }\n \n     if (failures.length) {\n@@ -44,7 +57,9 @@ export default function(): Rule {\n   };\n }\n \n-function runModuleWithProvidersMigration(tree: Tree, tsconfigPath: string, basePath: string) {\n+function runModuleWithProvidersMigration(\n+    tree: Tree, tsconfigPath: string, basePath: string,\n+    compilerCliMigrationsModule: typeof import('@angular/compiler-cli/private/migrations')) {\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const failures: string[] = [];\n   const typeChecker = program.getTypeChecker();\n@@ -56,7 +71,8 @@ function runModuleWithProvidersMigration(tree: Tree, tsconfigPath: string, baseP\n   sourceFiles.forEach(sourceFile => collector.visitNode(sourceFile));\n \n   const {resolvedModules, resolvedNonGenerics} = collector;\n-  const transformer = new ModuleWithProvidersTransform(typeChecker, getUpdateRecorder);\n+  const transformer =\n+      new ModuleWithProvidersTransform(typeChecker, getUpdateRecorder, compilerCliMigrationsModule);\n   const updateRecorders = new Map<ts.SourceFile, UpdateRecorder>();\n \n   [...resolvedModules.reduce("
        },
        {
            "sha": "9064cfb530ad086509a36fd566df6df53f8d10f2",
            "filename": "packages/core/schematics/migrations/module-with-providers/transform.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fmodule-with-providers%2Ftransform.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fmodule-with-providers%2Ftransform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fmodule-with-providers%2Ftransform.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {UpdateRecorder} from '@angular-devkit/schematics';\n-import {DynamicValue, PartialEvaluator, Reference, ResolvedValue, ResolvedValueMap, TypeScriptReflectionHost} from '@angular/compiler-cli/private/migrations';\n+import type {ResolvedValue, ResolvedValueMap} from '@angular/compiler-cli/private/migrations';\n import ts from 'typescript';\n \n import {ResolvedNgModule} from './collector';\n@@ -22,13 +22,16 @@ const TODO_COMMENT = 'TODO: The following node requires a generic type for `Modu\n \n export class ModuleWithProvidersTransform {\n   private printer = ts.createPrinter();\n-  private partialEvaluator: PartialEvaluator = new PartialEvaluator(\n-      new TypeScriptReflectionHost(this.typeChecker), this.typeChecker,\n+  private partialEvaluator = new this.compilerCliMigrationsModule.PartialEvaluator(\n+      new this.compilerCliMigrationsModule.TypeScriptReflectionHost(this.typeChecker),\n+      this.typeChecker,\n       /* dependencyTracker */ null);\n \n   constructor(\n       private typeChecker: ts.TypeChecker,\n-      private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder) {}\n+      private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder,\n+      private compilerCliMigrationsModule:\n+          typeof import('@angular/compiler-cli/private/migrations')) {}\n \n   /** Migrates a given NgModule by walking through the referenced providers and static methods. */\n   migrateModule(module: ResolvedNgModule): AnalysisFailure[] {\n@@ -132,10 +135,10 @@ export class ModuleWithProvidersTransform {\n   private _getTypeOfResolvedValue(value: ResolvedValue): string|undefined {\n     if (value instanceof Map && this.isModuleWithProvidersType(value)) {\n       const mapValue = value.get('ngModule')!;\n-      if (mapValue instanceof Reference && ts.isClassDeclaration(mapValue.node) &&\n-          mapValue.node.name) {\n+      if (mapValue instanceof this.compilerCliMigrationsModule.Reference &&\n+          ts.isClassDeclaration(mapValue.node) && mapValue.node.name) {\n         return mapValue.node.name.text;\n-      } else if (mapValue instanceof DynamicValue) {\n+      } else if (mapValue instanceof this.compilerCliMigrationsModule.DynamicValue) {\n         addTodoToNode(mapValue.node, TODO_COMMENT);\n         this._updateNode(mapValue.node, mapValue.node);\n       }"
        },
        {
            "sha": "bc058565b022d5a722070e72989e1599f20d3e9e",
            "filename": "packages/core/schematics/migrations/static-queries/index.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 6,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Findex.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -81,10 +81,22 @@ async function runMigration(tree: Tree, context: SchematicContext) {\n         `Unable to load the '@angular/compiler' package. Details: ${e.message}`);\n   }\n \n+  let compilerCliModule;\n+  try {\n+    // Load ESM `@angular/compiler-cli` using the TypeScript dynamic import workaround.\n+    // Once TypeScript provides support for keeping the dynamic import this workaround can be\n+    // changed to a direct dynamic import.\n+    compilerCliModule =\n+        await loadEsmModule<typeof import('@angular/compiler-cli')>('@angular/compiler-cli');\n+  } catch (e) {\n+    throw new SchematicsException(\n+        `Unable to load the '@angular/compiler' package. Details: ${e.message}`);\n+  }\n+\n   if (buildProjects.size) {\n     for (let project of Array.from(buildProjects.values())) {\n-      failures.push(\n-          ...await runStaticQueryMigration(tree, project, strategy, logger, compilerModule));\n+      failures.push(...await runStaticQueryMigration(\n+          tree, project, strategy, logger, compilerModule, compilerCliModule));\n     }\n   }\n \n@@ -94,7 +106,7 @@ async function runMigration(tree: Tree, context: SchematicContext) {\n     const project = await analyzeProject(tree, tsconfigPath, basePath, analyzedFiles, logger);\n     if (project) {\n       failures.push(...await runStaticQueryMigration(\n-          tree, project, SELECTED_STRATEGY.TESTS, logger, compilerModule));\n+          tree, project, SELECTED_STRATEGY.TESTS, logger, compilerModule, compilerCliModule));\n     }\n   }\n \n@@ -163,8 +175,8 @@ function analyzeProject(\n  */\n async function runStaticQueryMigration(\n     tree: Tree, project: AnalyzedProject, selectedStrategy: SELECTED_STRATEGY,\n-    logger: logging.LoggerApi,\n-    compilerModule: typeof import('@angular/compiler')): Promise<string[]> {\n+    logger: logging.LoggerApi, compilerModule: typeof import('@angular/compiler'),\n+    compilerCliModule: typeof import('@angular/compiler-cli')): Promise<string[]> {\n   const {sourceFiles, typeChecker, host, queryVisitor, tsconfigPath, basePath} = project;\n   const printer = ts.createPrinter();\n   const failureMessages: string[] = [];\n@@ -195,7 +207,8 @@ async function runStaticQueryMigration(\n   } else if (selectedStrategy === SELECTED_STRATEGY.TESTS) {\n     strategy = new QueryTestStrategy();\n   } else {\n-    strategy = new QueryTemplateStrategy(tsconfigPath, classMetadata, host, compilerModule);\n+    strategy = new QueryTemplateStrategy(\n+        tsconfigPath, classMetadata, host, compilerModule, compilerCliModule);\n   }\n \n   try {"
        },
        {
            "sha": "054c37fa26feb9a7a4c018996dcbe4a3bd7c3429",
            "filename": "packages/core/schematics/migrations/static-queries/strategies/template_strategy/template_strategy.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 10,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Ftemplate_strategy%2Ftemplate_strategy.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Ftemplate_strategy%2Ftemplate_strategy.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Ftemplate_strategy%2Ftemplate_strategy.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -6,8 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import type {AotCompiler, CompileDirectiveMetadata, CompileMetadataResolver, CompileNgModuleMetadata, CompileStylesheetMetadata, ElementAst, EmbeddedTemplateAst, NgAnalyzedModules, QueryMatch, StaticSymbol, TemplateAst} from '@angular/compiler';\n-import {createProgram, Diagnostic, readConfiguration} from '@angular/compiler-cli';\n+import type {AotCompiler, CompileDirectiveMetadata, CompileMetadataResolver, CompileNgModuleMetadata, CompileStylesheetMetadata, NgAnalyzedModules, QueryMatch, StaticSymbol, TemplateAst} from '@angular/compiler';\n import {resolve} from 'path';\n import ts from 'typescript';\n \n@@ -25,22 +24,23 @@ export class QueryTemplateStrategy implements TimingStrategy {\n \n   constructor(\n       private projectPath: string, private classMetadata: ClassMetadataMap,\n-      private host: ts.CompilerHost, private compilerModule: typeof import('@angular/compiler')) {}\n+      private host: ts.CompilerHost, private compilerModule: typeof import('@angular/compiler'),\n+      private compilerCliModule: typeof import('@angular/compiler-cli')) {}\n \n   /**\n    * Sets up the template strategy by creating the AngularCompilerProgram. Returns false if\n    * the AOT compiler program could not be created due to failure diagnostics.\n    */\n   setup() {\n-    const {rootNames, options} = readConfiguration(this.projectPath);\n+    const {rootNames, options} = this.compilerCliModule.readConfiguration(this.projectPath);\n \n     // https://github.com/angular/angular/commit/ec4381dd401f03bded652665b047b6b90f2b425f made Ivy\n     // the default. This breaks the assumption that \"createProgram\" from compiler-cli returns the\n     // NGC program. In order to ensure that the migration runs properly, we set \"enableIvy\" to\n     // false.\n     options.enableIvy = false;\n \n-    const aotProgram = createProgram({rootNames, options, host: this.host});\n+    const aotProgram = this.compilerCliModule.createProgram({rootNames, options, host: this.host});\n \n     // The \"AngularCompilerProgram\" does not expose the \"AotCompiler\" instance, nor does it\n     // expose the logic that is necessary to analyze the determined modules. We work around\n@@ -65,7 +65,7 @@ export class QueryTemplateStrategy implements TimingStrategy {\n \n     const ngStructuralDiagnostics = aotProgram.getNgStructuralDiagnostics();\n     if (ngStructuralDiagnostics.length) {\n-      throw this._createDiagnosticsError(ngStructuralDiagnostics);\n+      throw new Error(this.compilerCliModule.formatDiagnostics(ngStructuralDiagnostics, this.host));\n     }\n \n     analyzedModules.files.forEach(file => {\n@@ -180,10 +180,6 @@ export class QueryTemplateStrategy implements TimingStrategy {\n         .template;\n   }\n \n-  private _createDiagnosticsError(diagnostics: ReadonlyArray<Diagnostic>) {\n-    return new Error(ts.formatDiagnostics(diagnostics as ts.Diagnostic[], this.host));\n-  }\n-\n   private _getViewQueryUniqueKey(filePath: string, className: string, propName: string) {\n     return `${resolve(filePath)}#${className}-${propName}`;\n   }"
        },
        {
            "sha": "fea367105eb3a131acf2f4a4d08d7f8ee28568a6",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-decorated-fields/index.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-decorated-fields%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-decorated-fields%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-decorated-fields%2Findex.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -10,6 +10,7 @@ import {Rule, SchematicContext, SchematicsException, Tree,} from '@angular-devki\n import {relative} from 'path';\n import ts from 'typescript';\n \n+import {loadCompilerCliMigrationsModule, loadEsmModule} from '../../utils/load_esm';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n \n@@ -32,8 +33,20 @@ export default function(): Rule {\n           'Could not find any tsconfig file. Cannot add an Angular decorator to undecorated classes.');\n     }\n \n+    let compilerCliMigrationsModule;\n+    try {\n+      // Load ESM `@angular/compiler/private/migrations` using the TypeScript dynamic import\n+      // workaround. Once TypeScript provides support for keeping the dynamic import this workaround\n+      // can be changed to a direct dynamic import.\n+      compilerCliMigrationsModule = await loadCompilerCliMigrationsModule();\n+    } catch (e) {\n+      throw new SchematicsException(\n+          `Unable to load the '@angular/compiler-cli' package. Details: ${e.message}`);\n+    }\n+\n     for (const tsconfigPath of allPaths) {\n-      failures.push(...runUndecoratedClassesMigration(tree, tsconfigPath, basePath));\n+      failures.push(...runUndecoratedClassesMigration(\n+          tree, tsconfigPath, basePath, compilerCliMigrationsModule));\n     }\n \n     if (failures.length) {\n@@ -45,15 +58,17 @@ export default function(): Rule {\n }\n \n function runUndecoratedClassesMigration(\n-    tree: Tree, tsconfigPath: string, basePath: string): string[] {\n+    tree: Tree, tsconfigPath: string, basePath: string,\n+    compilerCliMigrationsModule: typeof import('@angular/compiler-cli/private/migrations')):\n+    string[] {\n   const failures: string[] = [];\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n   const sourceFiles =\n       program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n   const updateRecorders = new Map<ts.SourceFile, UpdateRecorder>();\n-  const transform =\n-      new UndecoratedClassesWithDecoratedFieldsTransform(typeChecker, getUpdateRecorder);\n+  const transform = new UndecoratedClassesWithDecoratedFieldsTransform(\n+      typeChecker, getUpdateRecorder, compilerCliMigrationsModule);\n \n   // Migrate all source files in the project.\n   transform.migrate(sourceFiles).forEach(({node, message}) => {"
        },
        {
            "sha": "6f5c2500787a691eb89e35e05b6e3a95a18ead75",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-decorated-fields/transform.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-decorated-fields%2Ftransform.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-decorated-fields%2Ftransform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-decorated-fields%2Ftransform.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -6,7 +6,6 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {PartialEvaluator, reflectObjectLiteral, TypeScriptReflectionHost} from '@angular/compiler-cli/private/migrations';\n import ts from 'typescript';\n \n import {ImportManager} from '../../utils/import_manager';\n@@ -76,12 +75,16 @@ const AMBIGUOUS_CLASS_TODO = 'Add Angular decorator.';\n export class UndecoratedClassesWithDecoratedFieldsTransform {\n   private printer = ts.createPrinter();\n   private importManager = new ImportManager(this.getUpdateRecorder, this.printer);\n-  private reflectionHost = new TypeScriptReflectionHost(this.typeChecker);\n-  private partialEvaluator = new PartialEvaluator(this.reflectionHost, this.typeChecker, null);\n+  private reflectionHost =\n+      new this.compilerCliMigrationsModule.TypeScriptReflectionHost(this.typeChecker);\n+  private partialEvaluator = new this.compilerCliMigrationsModule.PartialEvaluator(\n+      this.reflectionHost, this.typeChecker, null);\n \n   constructor(\n       private typeChecker: ts.TypeChecker,\n-      private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder) {}\n+      private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder,\n+      private compilerCliMigrationsModule:\n+          typeof import('@angular/compiler-cli/private/migrations')) {}\n \n   /**\n    * Migrates the specified source files. The transform adds the abstract `@Directive`\n@@ -265,7 +268,7 @@ export class UndecoratedClassesWithDecoratedFieldsTransform {\n     if (!ts.isObjectLiteralExpression(metadataExpr)) {\n       return false;\n     }\n-    const metadata = reflectObjectLiteral(metadataExpr);\n+    const metadata = this.compilerCliMigrationsModule.reflectObjectLiteral(metadataExpr);\n     if (!metadata.has('selector')) {\n       return false;\n     }"
        },
        {
            "sha": "138542abe748b040d648b51332b384ec1358c06d",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2FBUILD.bazel?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -12,7 +12,6 @@ ts_library(\n     deps = [\n         \"//packages/compiler\",\n         \"//packages/compiler-cli\",\n-        \"//packages/compiler-cli/private\",\n         \"//packages/core\",\n         \"//packages/core/schematics/utils\",\n         \"@npm//@angular-devkit/core\","
        },
        {
            "sha": "a97f4aa16d0f1c3c8b7b965439bb5ed93f45c0a9",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/create_ngc_program.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fcreate_ngc_program.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fcreate_ngc_program.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fcreate_ngc_program.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -7,13 +7,14 @@\n  */\n \n import type {AotCompiler} from '@angular/compiler';\n-import {CompilerHost, createProgram, readConfiguration} from '@angular/compiler-cli';\n+import type {CompilerHost} from '@angular/compiler-cli';\n import ts from 'typescript';\n \n /** Creates an NGC program that can be used to read and parse metadata for files. */\n export function createNgcProgram(\n+    compilerCliModule: typeof import('@angular/compiler-cli'),\n     createHost: (options: ts.CompilerOptions) => CompilerHost, tsconfigPath: string) {\n-  const {rootNames, options} = readConfiguration(tsconfigPath);\n+  const {rootNames, options} = compilerCliModule.readConfiguration(tsconfigPath);\n \n   // https://github.com/angular/angular/commit/ec4381dd401f03bded652665b047b6b90f2b425f made Ivy\n   // the default. This breaks the assumption that \"createProgram\" from compiler-cli returns the\n@@ -42,7 +43,7 @@ export function createNgcProgram(\n   host.readResource = () => '';\n   host.resourceNameToFileName = () => '$fake-file$';\n \n-  const ngcProgram = createProgram({rootNames, options, host});\n+  const ngcProgram = compilerCliModule.createProgram({rootNames, options, host});\n \n   // The \"AngularCompilerProgram\" does not expose the \"AotCompiler\" instance, nor does it\n   // expose the logic that is necessary to analyze the determined modules. We work around"
        },
        {
            "sha": "12bb8f98a21cffbb2704f76da52b762f86ea979c",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/decorator_rewrite/decorator_rewriter.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fdecorator_rewriter.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fdecorator_rewriter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fdecorator_rewriter.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -7,7 +7,6 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import type {AotCompiler} from '@angular/compiler';\n-import {PartialEvaluator} from '@angular/compiler-cli/private/migrations';\n import ts from 'typescript';\n \n import {ImportManager} from '../../../utils/import_manager';\n@@ -35,7 +34,7 @@ export class DecoratorRewriter {\n \n   constructor(\n       private importManager: ImportManager, private typeChecker: ts.TypeChecker,\n-      private evaluator: PartialEvaluator, private compiler: AotCompiler) {}\n+      private compiler: AotCompiler) {}\n \n   rewrite(ngDecorator: NgDecorator, newSourceFile: ts.SourceFile): ts.Decorator {\n     const decorator = ngDecorator.node;"
        },
        {
            "sha": "95479905fed133cd8bc0b5c673bfd67910a6dd66",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/index.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 15,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Findex.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -9,12 +9,11 @@\n import {logging} from '@angular-devkit/core';\n import {Rule, SchematicContext, SchematicsException, Tree} from '@angular-devkit/schematics';\n import type {AotCompiler} from '@angular/compiler';\n-import {Diagnostic as NgDiagnostic} from '@angular/compiler-cli';\n-import {PartialEvaluator, TypeScriptReflectionHost} from '@angular/compiler-cli/private/migrations';\n+import type {Diagnostic as NgDiagnostic} from '@angular/compiler-cli';\n import {relative} from 'path';\n import ts from 'typescript';\n \n-import {loadEsmModule} from '../../utils/load_esm';\n+import {loadCompilerCliMigrationsModule, loadEsmModule} from '../../utils/load_esm';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n import {canMigrateFile, createMigrationCompilerHost} from '../../utils/typescript/compiler_host';\n \n@@ -55,9 +54,44 @@ export default function(): Rule {\n           `Unable to load the '@angular/compiler' package. Details: ${e.message}`);\n     }\n \n+    let compilerCliModule;\n+    try {\n+      // Load ESM `@angular/compiler-cli` using the TypeScript dynamic import workaround.\n+      // Once TypeScript provides support for keeping the dynamic import this workaround can be\n+      // changed to a direct dynamic import.\n+      compilerCliModule =\n+          await loadEsmModule<typeof import('@angular/compiler-cli')>('@angular/compiler-cli');\n+    } catch (e) {\n+      throw new SchematicsException(\n+          `Unable to load the '@angular/compiler-cli' package. Details: ${e.message}`);\n+    }\n+\n+    let coreModule;\n+    try {\n+      // Load ESM `@angular/compiler-cli` using the TypeScript dynamic import workaround.\n+      // Once TypeScript provides support for keeping the dynamic import this workaround can be\n+      // changed to a direct dynamic import.\n+      coreModule = await loadEsmModule<typeof import('@angular/core')>('@angular/core');\n+    } catch (e) {\n+      throw new SchematicsException(\n+          `Unable to load the '@angular/core' package. Details: ${e.message}`);\n+    }\n+\n+    let compilerCliMigrationsModule;\n+    try {\n+      // Load ESM `@angular/compiler/private/migrations` using the TypeScript dynamic import\n+      // workaround. Once TypeScript provides support for keeping the dynamic import this workaround\n+      // can be changed to a direct dynamic import.\n+      compilerCliMigrationsModule = await loadCompilerCliMigrationsModule();\n+    } catch (e) {\n+      throw new SchematicsException(\n+          `Unable to load the '@angular/compiler-cli' package. Details: ${e.message}`);\n+    }\n+\n     for (const tsconfigPath of buildPaths) {\n-      const result =\n-          runUndecoratedClassesMigration(tree, tsconfigPath, basePath, ctx.logger, compilerModule);\n+      const result = runUndecoratedClassesMigration(\n+          tree, tsconfigPath, basePath, ctx.logger, compilerModule, compilerCliModule,\n+          compilerCliMigrationsModule, coreModule);\n       failures.push(...result.failures);\n       programError = programError || !!result.programError;\n     }\n@@ -83,10 +117,13 @@ export default function(): Rule {\n \n function runUndecoratedClassesMigration(\n     tree: Tree, tsconfigPath: string, basePath: string, logger: logging.LoggerApi,\n-    compilerModule: typeof import('@angular/compiler')):\n-    {failures: string[], programError?: boolean} {\n+    compilerModule: typeof import('@angular/compiler'),\n+    compilerCliModule: typeof import('@angular/compiler-cli'),\n+    compilerCliMigrationsModule: typeof import('@angular/compiler-cli/private/migrations'),\n+    coreModule: typeof import('@angular/core')): {failures: string[], programError?: boolean} {\n   const failures: string[] = [];\n-  const programData = gracefullyCreateProgram(tree, basePath, tsconfigPath, logger);\n+  const programData =\n+      gracefullyCreateProgram(tree, basePath, tsconfigPath, logger, compilerCliModule);\n \n   // Gracefully exit if the program could not be created.\n   if (programData === null) {\n@@ -95,9 +132,8 @@ function runUndecoratedClassesMigration(\n \n   const {program, compiler} = programData;\n   const typeChecker = program.getTypeChecker();\n-  const partialEvaluator = new PartialEvaluator(\n-      new TypeScriptReflectionHost(typeChecker), typeChecker, /* dependencyTracker */ null);\n-  const declarationCollector = new NgDeclarationCollector(typeChecker, partialEvaluator);\n+\n+  const declarationCollector = new NgDeclarationCollector(typeChecker, compilerCliMigrationsModule);\n   const sourceFiles =\n       program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n@@ -106,7 +142,7 @@ function runUndecoratedClassesMigration(\n \n   const {decoratedDirectives, decoratedProviders, undecoratedDeclarations} = declarationCollector;\n   const transform = new UndecoratedClassesTransform(\n-      typeChecker, compiler, partialEvaluator, getUpdateRecorder, compilerModule);\n+      typeChecker, compiler, getUpdateRecorder, compilerModule, coreModule);\n   const updateRecorders = new Map<ts.SourceFile, UpdateRecorder>();\n \n   // Run the migrations for decorated providers and both decorated and undecorated\n@@ -173,11 +209,13 @@ function getErrorDiagnostics(diagnostics: ReadonlyArray<ts.Diagnostic|NgDiagnost\n }\n \n function gracefullyCreateProgram(\n-    tree: Tree, basePath: string, tsconfigPath: string,\n-    logger: logging.LoggerApi): {compiler: AotCompiler, program: ts.Program}|null {\n+    tree: Tree, basePath: string, tsconfigPath: string, logger: logging.LoggerApi,\n+    compilerCliModule: typeof import('@angular/compiler-cli')):\n+    {compiler: AotCompiler, program: ts.Program}|null {\n   try {\n     const {ngcProgram, host, program, compiler} = createNgcProgram(\n-        (options) => createMigrationCompilerHost(tree, options, basePath), tsconfigPath);\n+        compilerCliModule, (options) => createMigrationCompilerHost(tree, options, basePath),\n+        tsconfigPath);\n     const syntacticDiagnostics = getErrorDiagnostics(ngcProgram.getTsSyntacticDiagnostics());\n     const structuralDiagnostics = getErrorDiagnostics(ngcProgram.getNgStructuralDiagnostics());\n     const configDiagnostics = getErrorDiagnostics("
        },
        {
            "sha": "99218da5228b04aeb3e12ce09b265b0203cb6fea",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/ng_declaration_collector.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 24,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fng_declaration_collector.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fng_declaration_collector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fng_declaration_collector.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -6,7 +6,6 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {PartialEvaluator, Reference, ResolvedValue} from '@angular/compiler-cli/private/migrations';\n import ts from 'typescript';\n \n import {getAngularDecorators, NgDecorator} from '../../utils/ng_decorators';\n@@ -28,7 +27,16 @@ export class NgDeclarationCollector {\n   /** Set of resolved Angular declarations which are not decorated. */\n   undecoratedDeclarations = new Set<ts.ClassDeclaration>();\n \n-  constructor(public typeChecker: ts.TypeChecker, private evaluator: PartialEvaluator) {}\n+  private evaluator;\n+\n+  constructor(\n+      public typeChecker: ts.TypeChecker,\n+      private compilerCliMigrationsModule:\n+          typeof import('@angular/compiler-cli/private/migrations')) {\n+    this.evaluator = new compilerCliMigrationsModule.PartialEvaluator(\n+        new compilerCliMigrationsModule.TypeScriptReflectionHost(typeChecker), typeChecker,\n+        /* dependencyTracker */ null);\n+  }\n \n   visitNode(node: ts.Node) {\n     if (ts.isClassDeclaration(node)) {\n@@ -80,39 +88,29 @@ export class NgDeclarationCollector {\n       }\n     });\n \n+    const values = [];\n+\n     // In case the module specifies the \"entryComponents\" field, walk through all\n     // resolved entry components and collect the referenced directives.\n     if (entryComponentsNode) {\n-      flattenTypeList(this.evaluator.evaluate(entryComponentsNode)).forEach(ref => {\n-        if (ts.isClassDeclaration(ref.node) &&\n-            !hasNgDeclarationDecorator(ref.node, this.typeChecker)) {\n-          this.undecoratedDeclarations.add(ref.node);\n-        }\n-      });\n+      values.push(this.evaluator.evaluate(entryComponentsNode));\n     }\n \n     // In case the module specifies the \"declarations\" field, walk through all\n     // resolved declarations and collect the referenced directives.\n     if (declarationsNode) {\n-      flattenTypeList(this.evaluator.evaluate(declarationsNode)).forEach(ref => {\n-        if (ts.isClassDeclaration(ref.node) &&\n-            !hasNgDeclarationDecorator(ref.node, this.typeChecker)) {\n-          this.undecoratedDeclarations.add(ref.node);\n-        }\n-      });\n+      values.push(this.evaluator.evaluate(declarationsNode));\n     }\n-  }\n-}\n \n-/** Flattens a list of type references. */\n-function flattenTypeList(value: ResolvedValue): Reference[] {\n-  if (Array.isArray(value)) {\n-    return <Reference[]>value.reduce(\n-        (res: Reference[], v: ResolvedValue) => res.concat(flattenTypeList(v)), []);\n-  } else if (value instanceof Reference) {\n-    return [value];\n+    // Flatten values and analyze references\n+    for (const value of values.flat(Infinity)) {\n+      if (value instanceof this.compilerCliMigrationsModule.Reference &&\n+          ts.isClassDeclaration(value.node) &&\n+          !hasNgDeclarationDecorator(value.node, this.typeChecker)) {\n+        this.undecoratedDeclarations.add(value.node);\n+      }\n+    }\n   }\n-  return [];\n }\n \n /** Checks whether the given node has the \"@Directive\" or \"@Component\" decorator set. */"
        },
        {
            "sha": "2d0e81277864a0b3cc0a83c79e07b5441c30f3d7",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/transform.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Ftransform.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Ftransform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Ftransform.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -7,8 +7,6 @@\n  */\n \n import type {AotCompiler, AotCompilerHost, CompileMetadataResolver, StaticSymbol, StaticSymbolResolver, SummaryResolver} from '@angular/compiler';\n-import {PartialEvaluator} from '@angular/compiler-cli/private/migrations';\n-import {ChangeDetectionStrategy, ViewEncapsulation} from '@angular/core';\n import ts from 'typescript';\n \n import {ImportManager} from '../../utils/import_manager';\n@@ -39,7 +37,7 @@ export class UndecoratedClassesTransform {\n   private printer = ts.createPrinter({newLine: ts.NewLineKind.LineFeed});\n   private importManager = new ImportManager(this.getUpdateRecorder, this.printer);\n   private decoratorRewriter =\n-      new DecoratorRewriter(this.importManager, this.typeChecker, this.evaluator, this.compiler);\n+      new DecoratorRewriter(this.importManager, this.typeChecker, this.compiler);\n \n   private compilerHost: AotCompilerHost;\n   private symbolResolver: StaticSymbolResolver;\n@@ -57,9 +55,9 @@ export class UndecoratedClassesTransform {\n \n   constructor(\n       private typeChecker: ts.TypeChecker, private compiler: AotCompiler,\n-      private evaluator: PartialEvaluator,\n       private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder,\n-      private compilerModule: typeof import('@angular/compiler')) {\n+      private compilerModule: typeof import('@angular/compiler'),\n+      private coreModule: typeof import('@angular/core')) {\n     this.symbolResolver = compiler['_symbolResolver'];\n     this.compilerHost = compiler['_host'];\n     this.metadataResolver = compiler['_metadataResolver'];\n@@ -349,12 +347,12 @@ export class UndecoratedClassesTransform {\n               return ts.createPropertyAccess(\n                   this.importManager.addImportToSourceFile(\n                       targetSourceFile, 'ChangeDetectionStrategy', '@angular/core'),\n-                  ChangeDetectionStrategy[value]);\n+                  this.coreModule.ChangeDetectionStrategy[value]);\n             } else if (propertyName === 'encapsulation' && typeof value === 'number') {\n               return ts.createPropertyAccess(\n                   this.importManager.addImportToSourceFile(\n                       targetSourceFile, 'ViewEncapsulation', '@angular/core'),\n-                  ViewEncapsulation[value]);\n+                  this.coreModule.ViewEncapsulation[value]);\n             }\n             return null;\n           });"
        },
        {
            "sha": "d709032e7092af360d9e63f749345cbaf302163a",
            "filename": "packages/core/schematics/utils/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Futils%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Futils%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Futils%2FBUILD.bazel?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -7,6 +7,7 @@ ts_library(\n     visibility = [\"//packages/core/schematics:__subpackages__\"],\n     deps = [\n         \"//packages/compiler\",\n+        \"//packages/compiler-cli/private\",\n         \"@npm//@angular-devkit/core\",\n         \"@npm//@angular-devkit/schematics\",\n         \"@npm//@types/inquirer\","
        },
        {
            "sha": "5ba0bc6fc2b51638ab45592434d9fd6adaee6c9f",
            "filename": "packages/core/schematics/utils/load_esm.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Futils%2Fload_esm.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0015d3c456d584242269b0765878d598a550888/packages%2Fcore%2Fschematics%2Futils%2Fload_esm.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Futils%2Fload_esm.ts?ref=e0015d3c456d584242269b0765878d598a550888",
            "patch": "@@ -33,3 +33,23 @@ export async function loadEsmModule<T>(modulePath: string|URL): Promise<T> {\n     return namespaceObject;\n   }\n }\n+\n+/**\n+ * Attempt to load the new `@angular/compiler-cli/private/migrations` entry. If not yet present\n+ * the previous deep imports are used to constructor an equivalent object.\n+ *\n+ * @returns A Promise that resolves to the dynamically imported compiler-cli private migrations\n+ * entry or an equivalent object if not available.\n+ */\n+export async function loadCompilerCliMigrationsModule():\n+    Promise<typeof import('@angular/compiler-cli/private/migrations')> {\n+  try {\n+    return await loadEsmModule('@angular/compiler-cli/private/migrations');\n+  } catch {\n+    // rules_nodejs currently does not support exports field entries. This is a temporary workaround\n+    // that leverages devmode currently being CommonJS. If that changes before rules_nodejs supports\n+    // exports then this workaround needs to be reworked.\n+    // TODO_ESM: This can be removed once Bazel supports exports fields.\n+    return require('@angular/compiler-cli/private/migrations.js');\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 438,
        "additions": 303,
        "deletions": 135
    }
}