{
    "author": "benbraou",
    "message": "refactor(forms): refactor common validators used in unit tests (#38020)\n\nA util file is added to forms test package:\n- it exposes simpleAsyncValidator, asyncValidator and asyncValidatorReturningObservable validators\n- it refactors simpleAsyncValidator and asyncValidator to use common promise creation code\n- it exposes currentStateOf allowing to get the validation state of a list of AbstractControl\n\nCloses #37831\n\nPR Close #38020",
    "sha": "062b8d90afaf60e0066568d64188ca074001986f",
    "files": [
        {
            "sha": "dd497dc30c2ede07ce7cdbaaee76623c03f9ba0b",
            "filename": "packages/forms/test/directives_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 18,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/062b8d90afaf60e0066568d64188ca074001986f/packages%2Fforms%2Ftest%2Fdirectives_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/062b8d90afaf60e0066568d64188ca074001986f/packages%2Fforms%2Ftest%2Fdirectives_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Fdirectives_spec.ts?ref=062b8d90afaf60e0066568d64188ca074001986f",
            "patch": "@@ -12,6 +12,7 @@ import {beforeEach, describe, expect, it} from '@angular/core/testing/src/testin\n import {AbstractControl, CheckboxControlValueAccessor, ControlValueAccessor, DefaultValueAccessor, FormArray, FormArrayName, FormControl, FormControlDirective, FormControlName, FormGroup, FormGroupDirective, FormGroupName, NgControl, NgForm, NgModel, NgModelGroup, SelectControlValueAccessor, SelectMultipleControlValueAccessor, ValidationErrors, Validator, Validators} from '@angular/forms';\n import {composeValidators, selectValueAccessor} from '@angular/forms/src/directives/shared';\n import {SpyNgControl, SpyValueAccessor} from './spies';\n+import {asyncValidator} from './util';\n \n class DummyControlValueAccessor implements ControlValueAccessor {\n   writtenValue: any;\n@@ -30,24 +31,6 @@ class CustomValidatorDirective implements Validator {\n   }\n }\n \n-function asyncValidator(expected: any, timeout = 0) {\n-  return (c: AbstractControl): any => {\n-    let resolve: (result: any) => void = undefined!;\n-    const promise = new Promise(res => {\n-      resolve = res;\n-    });\n-    const res = c.value != expected ? {'async': true} : null;\n-    if (timeout == 0) {\n-      resolve(res);\n-    } else {\n-      setTimeout(() => {\n-        resolve(res);\n-      }, timeout);\n-    }\n-    return promise;\n-  };\n-}\n-\n {\n   describe('Form Directives', () => {\n     let defaultAccessor: DefaultValueAccessor;"
        },
        {
            "sha": "7159500b47cffeb4a04b7e34773916266d216f85",
            "filename": "packages/forms/test/form_array_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 21,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/062b8d90afaf60e0066568d64188ca074001986f/packages%2Fforms%2Ftest%2Fform_array_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/062b8d90afaf60e0066568d64188ca074001986f/packages%2Fforms%2Ftest%2Fform_array_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Fform_array_spec.ts?ref=062b8d90afaf60e0066568d64188ca074001986f",
            "patch": "@@ -11,29 +11,9 @@ import {AsyncTestCompleter, beforeEach, describe, inject, it} from '@angular/cor\n import {AbstractControl, FormArray, FormControl, FormGroup, ValidationErrors, ValidatorFn} from '@angular/forms';\n import {Validators} from '@angular/forms/src/validators';\n import {of} from 'rxjs';\n+import {asyncValidator} from './util';\n \n (function() {\n-function asyncValidator(expected: string, timeouts = {}) {\n-  return (c: AbstractControl) => {\n-    let resolve: (result: any) => void = undefined!;\n-    const promise = new Promise<ValidationErrors|null>(res => {\n-      resolve = res;\n-    });\n-    const t = (timeouts as any)[c.value] != null ? (timeouts as any)[c.value] : 0;\n-    const res = c.value != expected ? {'async': true} : null;\n-\n-    if (t == 0) {\n-      resolve(res);\n-    } else {\n-      setTimeout(() => {\n-        resolve(res);\n-      }, t);\n-    }\n-\n-    return promise;\n-  };\n-}\n-\n describe('FormArray', () => {\n   describe('adding/removing', () => {\n     let a: FormArray;"
        },
        {
            "sha": "d9eaafdcd489a5fce734b4fe9cd0b76ac89e40ea",
            "filename": "packages/forms/test/form_control_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 31,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/062b8d90afaf60e0066568d64188ca074001986f/packages%2Fforms%2Ftest%2Fform_control_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/062b8d90afaf60e0066568d64188ca074001986f/packages%2Fforms%2Ftest%2Fform_control_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Fform_control_spec.ts?ref=062b8d90afaf60e0066568d64188ca074001986f",
            "patch": "@@ -6,43 +6,14 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {EventEmitter} from '@angular/core';\n import {fakeAsync, tick} from '@angular/core/testing';\n import {AsyncTestCompleter, beforeEach, describe, inject, it} from '@angular/core/testing/src/testing_internal';\n-import {AbstractControl, AsyncValidatorFn, FormControl, FormGroup, ValidationErrors, Validators} from '@angular/forms';\n+import {FormControl, FormGroup, Validators} from '@angular/forms';\n \n import {FormArray} from '@angular/forms/src/model';\n+import {asyncValidator, asyncValidatorReturningObservable} from './util';\n \n (function() {\n-function asyncValidator(expected: string, timeouts = {}): AsyncValidatorFn {\n-  return (c: AbstractControl) => {\n-    let resolve: (result: any) => void = undefined!;\n-    const promise = new Promise<ValidationErrors|null>(res => {\n-      resolve = res;\n-    });\n-    const t = (timeouts as any)[c.value] != null ? (timeouts as any)[c.value] : 0;\n-    const res = c.value != expected ? {'async': true} : null;\n-\n-    if (t == 0) {\n-      resolve(res);\n-    } else {\n-      setTimeout(() => {\n-        resolve(res);\n-      }, t);\n-    }\n-\n-    return promise;\n-  };\n-}\n-\n-function asyncValidatorReturningObservable(c: AbstractControl) {\n-  const e = new EventEmitter<Record<string, boolean>>();\n-  Promise.resolve(null).then(() => {\n-    e.emit({'async': true});\n-  });\n-  return e;\n-}\n-\n function otherAsyncValidator() {\n   return Promise.resolve({'other': true});\n }"
        },
        {
            "sha": "9addf0dd37e08be42b9065736875205e595bd0a5",
            "filename": "packages/forms/test/form_group_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 63,
            "changes": 65,
            "blob_url": "https://github.com/angular/angular/blob/062b8d90afaf60e0066568d64188ca074001986f/packages%2Fforms%2Ftest%2Fform_group_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/062b8d90afaf60e0066568d64188ca074001986f/packages%2Fforms%2Ftest%2Fform_group_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Fform_group_spec.ts?ref=062b8d90afaf60e0066568d64188ca074001986f",
            "patch": "@@ -6,80 +6,19 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {EventEmitter} from '@angular/core';\n import {async, fakeAsync, tick} from '@angular/core/testing';\n import {AsyncTestCompleter, beforeEach, describe, inject, it} from '@angular/core/testing/src/testing_internal';\n import {AbstractControl, FormArray, FormControl, FormGroup, ValidationErrors, Validators} from '@angular/forms';\n import {of} from 'rxjs';\n \n+import {asyncValidator, asyncValidatorReturningObservable, currentStateOf, simpleAsyncValidator} from './util';\n+\n \n (function() {\n function simpleValidator(c: AbstractControl): ValidationErrors|null {\n   return c.get('one')!.value === 'correct' ? null : {'broken': true};\n }\n \n-function asyncValidator(expected: string, timeouts = {}) {\n-  return (c: AbstractControl) => {\n-    let resolve: (result: any) => void = undefined!;\n-    const promise = new Promise<ValidationErrors|null>(res => {\n-      resolve = res;\n-    });\n-    const t = (timeouts as any)[c.value] != null ? (timeouts as any)[c.value] : 0;\n-    const res = c.value != expected ? {'async': true} : null;\n-\n-    if (t == 0) {\n-      resolve(res);\n-    } else {\n-      setTimeout(() => {\n-        resolve(res);\n-      }, t);\n-    }\n-\n-    return promise;\n-  };\n-}\n-\n-function simpleAsyncValidator({\n-  timeout = 0,\n-  shouldFail,\n-  customError =\n-  {\n-    async: true\n-  }\n-}: {timeout?: number, shouldFail: boolean, customError?: any}) {\n-  return (c: AbstractControl) => {\n-    const res = shouldFail ? customError : null;\n-\n-    if (timeout === 0) {\n-      return of(res);\n-    }\n-\n-    let resolve: (result: any) => void = undefined!;\n-    const promise = new Promise<ValidationErrors|null>(res => {\n-      resolve = res;\n-    });\n-\n-    setTimeout(() => {\n-      resolve(res);\n-    }, timeout);\n-\n-    return promise;\n-  };\n-}\n-\n-function currentStateOf(controls: AbstractControl[]):\n-    {errors: any; pending: boolean; status: string;}[] {\n-  return controls.map(c => ({errors: c.errors, pending: c.pending, status: c.status}));\n-}\n-\n-function asyncValidatorReturningObservable(c: AbstractControl) {\n-  const e = new EventEmitter();\n-  Promise.resolve(null).then(() => {\n-    e.emit({'async': true});\n-  });\n-  return e;\n-}\n-\n function otherObservableValidator() {\n   return of({'other': true});\n }"
        },
        {
            "sha": "148f398a3e4ddbe6a75e120299a452366d48e7c9",
            "filename": "packages/forms/test/util.ts",
            "status": "added",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/angular/angular/blob/062b8d90afaf60e0066568d64188ca074001986f/packages%2Fforms%2Ftest%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/062b8d90afaf60e0066568d64188ca074001986f/packages%2Fforms%2Ftest%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Futil.ts?ref=062b8d90afaf60e0066568d64188ca074001986f",
            "patch": "@@ -0,0 +1,87 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {EventEmitter} from '@angular/core';\n+import {AbstractControl, AsyncValidatorFn, ValidationErrors} from '@angular/forms';\n+import {of} from 'rxjs';\n+\n+function createValidationPromise(\n+    result: ValidationErrors|null, timeout: number): Promise<ValidationErrors|null> {\n+  return new Promise(resolve => {\n+    if (timeout == 0) {\n+      resolve(result);\n+    } else {\n+      setTimeout(() => {\n+        resolve(result);\n+      }, timeout);\n+    }\n+  });\n+}\n+\n+/**\n+ * Returns a promise-based async validator that emits, after a delay, either:\n+ *  - an error `{async: true}` if the control value does not match the expected value\n+ *  - or null, otherwise\n+ *  The delay is either:\n+ *  - defined in `timeouts` parameter, as the association to the control value\n+ *  - or 0ms otherwise\n+ *\n+ * @param expected The expected control value\n+ * @param timeouts A dictionary associating a control value to when the validation will trigger for\n+ *     that value\n+ */\n+export function asyncValidator(expected: string, timeouts = {}): AsyncValidatorFn {\n+  return (control: AbstractControl) => {\n+    const timeout = (timeouts as any)[control.value] ?? 0;\n+    const result = control.value != expected ? {async: true} : null;\n+    return createValidationPromise(result, timeout);\n+  };\n+}\n+\n+/**\n+ * Returns an async validator that emits null or a custom error after a specified delay.\n+ * If the delay is set to 0ms, the validator emits synchronously.\n+ *\n+ * @param timeout Indicates when the validator will emit\n+ * @param shouldFail When true, a validation error is emitted, otherwise null is emitted\n+ * @param customError When supplied, overrides the default error `{async: true}`\n+ */\n+export function simpleAsyncValidator({\n+  timeout = 0,\n+  shouldFail,\n+  customError =\n+  {\n+    async: true\n+  }\n+}: {timeout?: number, shouldFail: boolean, customError?: any}): AsyncValidatorFn {\n+  const result = shouldFail ? customError : null;\n+  return (c: AbstractControl) =>\n+             timeout === 0 ? of(result) : createValidationPromise(result, timeout);\n+}\n+\n+/**\n+ * Returns the asynchronous validation state of each provided control\n+ * @param controls A collection of controls\n+ */\n+export function currentStateOf(controls: AbstractControl[]):\n+    {errors: any; pending: boolean; status: string;}[] {\n+  return controls.map(c => ({errors: c.errors, pending: c.pending, status: c.status}));\n+}\n+\n+/**\n+ * Returns an `EventEmitter` emitting the default error `{'async': true}`\n+ *\n+ * @param c The control instance\n+ */\n+export function asyncValidatorReturningObservable(c: AbstractControl): EventEmitter<any> {\n+  const e = new EventEmitter();\n+  Promise.resolve(null).then(() => {\n+    e.emit({'async': true});\n+  });\n+  return e;\n+}"
        }
    ],
    "stats": {
        "total": 226,
        "additions": 93,
        "deletions": 133
    }
}