{
    "author": "JiaLiPassion",
    "message": "fix(zone.js): update several flaky cases (#41526)\n\nRelated to #41434\n\nFix several flaky cases.\n\n1. should restore `window.onerror` in test cases.\n2. expect().toThrow() should pass a function.\n\nPR Close #41526",
    "sha": "25a83eb264aa19fc4616cea45e04d790b9bcd777",
    "files": [
        {
            "sha": "b796f30b3cdfe13a853e51a6aac72c97a17bbfe7",
            "filename": "packages/zone.js/test/browser/browser.spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/25a83eb264aa19fc4616cea45e04d790b9bcd777/packages%2Fzone.js%2Ftest%2Fbrowser%2Fbrowser.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/25a83eb264aa19fc4616cea45e04d790b9bcd777/packages%2Fzone.js%2Ftest%2Fbrowser%2Fbrowser.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fbrowser%2Fbrowser.spec.ts?ref=25a83eb264aa19fc4616cea45e04d790b9bcd777",
            "patch": "@@ -395,16 +395,22 @@ describe('Zone', function() {\n \n           it('get window onerror should not throw error',\n              ifEnvSupports(canPatchOnProperty(window, 'onerror'), function() {\n+               const oriOnError = window.onerror;\n                const testFn = function() {\n-                 let onerror = window.onerror;\n-                 window.onerror = function() {};\n-                 onerror = window.onerror;\n+                 try {\n+                   let onerror = window.onerror;\n+                   window.onerror = function() {};\n+                   onerror = window.onerror;\n+                 } finally {\n+                   window.onerror = oriOnError;\n+                 }\n                };\n                expect(testFn).not.toThrow();\n              }));\n \n           it('window.onerror callback signiture should be (message, source, lineno, colno, error)',\n              ifEnvSupportsWithDone(canPatchOnProperty(window, 'onerror'), function(done: DoneFn) {\n+               const oriOnError = window.onerror;\n                let testError = new Error('testError');\n                window.onerror = function(\n                    message: any, source?: string, lineno?: number, colno?: number, error?: any) {\n@@ -413,7 +419,7 @@ describe('Zone', function() {\n                    // Edge 14, error will be undefined.\n                    expect(error).toBe(testError);\n                  }\n-                 (window as any).onerror = null;\n+                 (window as any).onerror = oriOnError;\n                  setTimeout(done);\n                  return true;\n                };"
        },
        {
            "sha": "27be7617e93c03a9b0ff53475697e4ea098e528e",
            "filename": "packages/zone.js/test/common/zone.spec.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 17,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/25a83eb264aa19fc4616cea45e04d790b9bcd777/packages%2Fzone.js%2Ftest%2Fcommon%2Fzone.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/25a83eb264aa19fc4616cea45e04d790b9bcd777/packages%2Fzone.js%2Ftest%2Fcommon%2Fzone.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fcommon%2Fzone.spec.ts?ref=25a83eb264aa19fc4616cea45e04d790b9bcd777",
            "patch": "@@ -334,23 +334,23 @@ describe('Zone', function() {\n         Zone.assertZonePatched();\n       });\n \n-      // xit('should throw error if ZoneAwarePromise has been overwritten', () => {\n-      //   class WrongPromise {\n-      //     static resolve(value: any) {}\n-\n-      //     then() {}\n-      //   }\n-\n-      //   const ZoneAwarePromise = global.Promise;\n-      //   try {\n-      //     global.Promise = WrongPromise;\n-      //     expect(Zone.assertZonePatched()).toThrow();\n-      //   } finally {\n-      //     // restore it.\n-      //     global.Promise = ZoneAwarePromise;\n-      //   }\n-      //   Zone.assertZonePatched();\n-      // });\n+      it('should throw error if ZoneAwarePromise has been overwritten', () => {\n+        class WrongPromise {\n+          static resolve(value: any) {}\n+\n+          then() {}\n+        }\n+\n+        const ZoneAwarePromise = global.Promise;\n+        try {\n+          (global as any).Promise = WrongPromise;\n+          expect(() => Zone.assertZonePatched()).toThrow();\n+        } finally {\n+          // restore it.\n+          global.Promise = ZoneAwarePromise;\n+        }\n+        Zone.assertZonePatched();\n+      });\n     });\n   });\n "
        }
    ],
    "stats": {
        "total": 48,
        "additions": 27,
        "deletions": 21
    }
}