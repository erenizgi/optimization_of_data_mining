{
    "author": "AndrewKushnir",
    "message": "test(core): verify `onDestroy` callbacks are invoked when ComponentRef is destroyed (#39876)\n\nThis commit adds a few tests to verify that the `onDestroy` callbacks are invoked when `ComponentRef` instance\nis destroyed and the logic is consistent between ViewEngine and Ivy.\n\nPR Close #39876",
    "sha": "a55e01b89cb641cc23d20dd677ea7b833c1d6a42",
    "files": [
        {
            "sha": "ace2cec25bc808064e4da0a87d6c7a6c5b84716c",
            "filename": "packages/core/src/application_ref.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a55e01b89cb641cc23d20dd677ea7b833c1d6a42/packages%2Fcore%2Fsrc%2Fapplication_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/a55e01b89cb641cc23d20dd677ea7b833c1d6a42/packages%2Fcore%2Fsrc%2Fapplication_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fapplication_ref.ts?ref=a55e01b89cb641cc23d20dd677ea7b833c1d6a42",
            "patch": "@@ -804,7 +804,6 @@ export class ApplicationRef {\n \n   /** @internal */\n   ngOnDestroy() {\n-    // TODO(alxhub): Dispose of the NgZone.\n     this._views.slice().forEach((view) => view.destroy());\n     this._onMicrotaskEmptySubscription.unsubscribe();\n   }"
        },
        {
            "sha": "020470d1a8d831b2e3fcea676f859669f6fa6164",
            "filename": "packages/core/test/acceptance/bootstrap_spec.ts",
            "status": "modified",
            "additions": 77,
            "deletions": 1,
            "changes": 78,
            "blob_url": "https://github.com/angular/angular/blob/a55e01b89cb641cc23d20dd677ea7b833c1d6a42/packages%2Fcore%2Ftest%2Facceptance%2Fbootstrap_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a55e01b89cb641cc23d20dd677ea7b833c1d6a42/packages%2Fcore%2Ftest%2Facceptance%2Fbootstrap_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fbootstrap_spec.ts?ref=a55e01b89cb641cc23d20dd677ea7b833c1d6a42",
            "patch": "@@ -6,7 +6,8 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {COMPILER_OPTIONS, Component, destroyPlatform, NgModule, ViewEncapsulation} from '@angular/core';\n+import {ApplicationRef, COMPILER_OPTIONS, Component, destroyPlatform, NgModule, TestabilityRegistry, ViewEncapsulation} from '@angular/core';\n+import {expect} from '@angular/core/testing/src/testing_internal';\n import {BrowserModule} from '@angular/platform-browser';\n import {platformBrowserDynamic} from '@angular/platform-browser-dynamic';\n import {onlyInIvy, withBody} from '@angular/private/testing';\n@@ -151,6 +152,81 @@ describe('bootstrap', () => {\n          ngModuleRef.destroy();\n        }));\n \n+    describe('ApplicationRef cleanup', () => {\n+      it('should cleanup ApplicationRef when Injector is destroyed',\n+         withBody('<my-app></my-app>', async () => {\n+           const TestModule = createComponentAndModule();\n+\n+           const ngModuleRef = await platformBrowserDynamic().bootstrapModule(TestModule);\n+           const appRef = ngModuleRef.injector.get(ApplicationRef);\n+           const testabilityRegistry = ngModuleRef.injector.get(TestabilityRegistry);\n+\n+           expect(appRef.components.length).toBe(1);\n+           expect(testabilityRegistry.getAllRootElements().length).toBe(1);\n+\n+           ngModuleRef.destroy();  // also destroys an Injector instance.\n+\n+           expect(appRef.components.length).toBe(0);\n+           expect(testabilityRegistry.getAllRootElements().length).toBe(0);\n+         }));\n+\n+      it('should cleanup ApplicationRef when ComponentRef is destroyed',\n+         withBody('<my-app></my-app>', async () => {\n+           const TestModule = createComponentAndModule();\n+\n+           const ngModuleRef = await platformBrowserDynamic().bootstrapModule(TestModule);\n+           const appRef = ngModuleRef.injector.get(ApplicationRef);\n+           const testabilityRegistry = ngModuleRef.injector.get(TestabilityRegistry);\n+           const componentRef = appRef.components[0];\n+\n+           expect(appRef.components.length).toBe(1);\n+           expect(testabilityRegistry.getAllRootElements().length).toBe(1);\n+\n+           componentRef.destroy();\n+\n+           expect(appRef.components.length).toBe(0);\n+           expect(testabilityRegistry.getAllRootElements().length).toBe(0);\n+         }));\n+\n+      it('should not throw in case ComponentRef is destroyed and Injector is destroyed after that',\n+         withBody('<my-app></my-app>', async () => {\n+           const TestModule = createComponentAndModule();\n+\n+           const ngModuleRef = await platformBrowserDynamic().bootstrapModule(TestModule);\n+           const appRef = ngModuleRef.injector.get(ApplicationRef);\n+           const testabilityRegistry = ngModuleRef.injector.get(TestabilityRegistry);\n+           const componentRef = appRef.components[0];\n+\n+           expect(appRef.components.length).toBe(1);\n+           expect(testabilityRegistry.getAllRootElements().length).toBe(1);\n+\n+           componentRef.destroy();\n+           ngModuleRef.destroy();  // also destroys an Injector instance.\n+\n+           expect(appRef.components.length).toBe(0);\n+           expect(testabilityRegistry.getAllRootElements().length).toBe(0);\n+         }));\n+\n+      it('should not throw in case Injector is destroyed and ComponentRef is destroyed after that',\n+         withBody('<my-app></my-app>', async () => {\n+           const TestModule = createComponentAndModule();\n+\n+           const ngModuleRef = await platformBrowserDynamic().bootstrapModule(TestModule);\n+           const appRef = ngModuleRef.injector.get(ApplicationRef);\n+           const testabilityRegistry = ngModuleRef.injector.get(TestabilityRegistry);\n+           const componentRef = appRef.components[0];\n+\n+           expect(appRef.components.length).toBe(1);\n+           expect(testabilityRegistry.getAllRootElements().length).toBe(1);\n+\n+           ngModuleRef.destroy();  // also destroys an Injector instance.\n+           componentRef.destroy();\n+\n+           expect(appRef.components.length).toBe(0);\n+           expect(testabilityRegistry.getAllRootElements().length).toBe(0);\n+         }));\n+    });\n+\n     onlyInIvy('options cannot be changed in Ivy').describe('changing bootstrap options', () => {\n       beforeEach(() => {\n         spyOn(console, 'error');"
        },
        {
            "sha": "463759577107d8e759f6388847015ea10a4baa10",
            "filename": "packages/core/test/acceptance/component_spec.ts",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/a55e01b89cb641cc23d20dd677ea7b833c1d6a42/packages%2Fcore%2Ftest%2Facceptance%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a55e01b89cb641cc23d20dd677ea7b833c1d6a42/packages%2Fcore%2Ftest%2Facceptance%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fcomponent_spec.ts?ref=a55e01b89cb641cc23d20dd677ea7b833c1d6a42",
            "patch": "@@ -303,6 +303,57 @@ describe('component', () => {\n        expect(wrapperEls.length).toBe(2);  // other elements are preserved\n      });\n \n+  it('should invoke `onDestroy` callbacks of dynamically created component', () => {\n+    let wasOnDestroyCalled = false;\n+    @Component({\n+      selector: '[comp]',\n+      template: 'comp content',\n+    })\n+    class DynamicComponent {\n+    }\n+\n+    @NgModule({\n+      declarations: [DynamicComponent],\n+      entryComponents: [DynamicComponent],  // needed only for ViewEngine\n+    })\n+    class TestModule {\n+    }\n+\n+    @Component({\n+      selector: 'button',\n+      template: '<div id=\"app-root\" #anchor></div>',\n+    })\n+    class App {\n+      @ViewChild('anchor', {read: ViewContainerRef}) anchor!: ViewContainerRef;\n+\n+      constructor(private cfr: ComponentFactoryResolver, private injector: Injector) {}\n+\n+      create() {\n+        const factory = this.cfr.resolveComponentFactory(DynamicComponent);\n+        const componentRef = factory.create(this.injector);\n+        componentRef.onDestroy(() => {\n+          wasOnDestroyCalled = true;\n+        });\n+        this.anchor.insert(componentRef.hostView);\n+      }\n+\n+      clear() {\n+        this.anchor.clear();\n+      }\n+    }\n+\n+    TestBed.configureTestingModule({imports: [TestModule], declarations: [App]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+\n+    // Add ComponentRef to ViewContainerRef instance.\n+    fixture.componentInstance.create();\n+    // Clear ViewContainerRef to invoke `onDestroy` callbacks on ComponentRef.\n+    fixture.componentInstance.clear();\n+\n+    expect(wasOnDestroyCalled).toBeTrue();\n+  });\n+\n   describe('invalid host element', () => {\n     it('should throw when <ng-container> is used as a host element for a Component', () => {\n       @Component({"
        }
    ],
    "stats": {
        "total": 130,
        "additions": 128,
        "deletions": 2
    }
}