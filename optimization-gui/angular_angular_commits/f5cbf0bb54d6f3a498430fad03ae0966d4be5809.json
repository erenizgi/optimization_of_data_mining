{
    "author": "sonukapoor",
    "message": "fix(core): support `Attribute` DI decorator in `deps` section of a token (#37085)\n\nThis commit fixes a bug when `Attribute` DI decorator is used in the\n`deps` section of a token that uses a factory function. The problem\nappeared because the `Attribute` DI decorator was not handled correctly\nwhile injecting factory function attributes.\n\nCloses #36479\n\nPR Close #37085",
    "sha": "f5cbf0bb54d6f3a498430fad03ae0966d4be5809",
    "files": [
        {
            "sha": "18f105b46fa1c07afff41ed63106ccf005c1ebe0",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/angular/angular/blob/f5cbf0bb54d6f3a498430fad03ae0966d4be5809/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/f5cbf0bb54d6f3a498430fad03ae0966d4be5809/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=f5cbf0bb54d6f3a498430fad03ae0966d4be5809",
            "patch": "@@ -176,6 +176,57 @@\n     \"packages/core/src/change_detection/differs/default_keyvalue_differ.ts\",\n     \"packages/core/src/change_detection/differs/keyvalue_differs.ts\"\n   ],\n+  [\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/injectable.ts\",\n+    \"packages/core/src/di/jit/injectable.ts\",\n+    \"packages/core/src/di/jit/environment.ts\",\n+    \"packages/core/src/di/injector_compatibility.ts\",\n+    \"packages/core/src/di/injector.ts\",\n+    \"packages/core/src/di/metadata.ts\",\n+    \"packages/core/src/render3/instructions/di.ts\"\n+  ],\n+  [\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/injectable.ts\",\n+    \"packages/core/src/di/jit/injectable.ts\",\n+    \"packages/core/src/di/jit/environment.ts\",\n+    \"packages/core/src/di/injector_compatibility.ts\",\n+    \"packages/core/src/di/metadata.ts\",\n+    \"packages/core/src/render3/instructions/di.ts\"\n+  ],\n+  [\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/injectable.ts\",\n+    \"packages/core/src/di/jit/injectable.ts\",\n+    \"packages/core/src/di/jit/util.ts\",\n+    \"packages/core/src/di/metadata.ts\",\n+    \"packages/core/src/render3/instructions/di.ts\"\n+  ],\n+  [\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/metadata.ts\",\n+    \"packages/core/src/render3/instructions/di.ts\"\n+  ],\n+  [\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/reflective_injector.ts\",\n+    \"packages/core/src/di/metadata.ts\",\n+    \"packages/core/src/render3/instructions/di.ts\"\n+  ],\n+  [\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/reflective_injector.ts\",\n+    \"packages/core/src/di/reflective_provider.ts\",\n+    \"packages/core/src/di/metadata.ts\",\n+    \"packages/core/src/render3/instructions/di.ts\"\n+  ],\n   [\n     \"packages/core/src/di/injectable.ts\",\n     \"packages/core/src/di/jit/injectable.ts\"\n@@ -184,6 +235,16 @@\n     \"packages/core/src/di/injector_compatibility.ts\",\n     \"packages/core/src/di/injector.ts\"\n   ],\n+  [\n+    \"packages/core/src/di/injector_compatibility.ts\",\n+    \"packages/core/src/di/injector.ts\",\n+    \"packages/core/src/di/null_injector.ts\"\n+  ],\n+  [\n+    \"packages/core/src/di/injector_compatibility.ts\",\n+    \"packages/core/src/di/injector.ts\",\n+    \"packages/core/src/di/r3_injector.ts\"\n+  ],\n   [\n     \"packages/core/src/di/injector_token.ts\",\n     \"packages/core/src/di/injector.ts\""
        },
        {
            "sha": "358a4316c3e7982db38fa0c509c9812fbcdbb4c4",
            "filename": "packages/core/src/core_render3_private_export.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/f5cbf0bb54d6f3a498430fad03ae0966d4be5809/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "raw_url": "https://github.com/angular/angular/raw/f5cbf0bb54d6f3a498430fad03ae0966d4be5809/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts?ref=f5cbf0bb54d6f3a498430fad03ae0966d4be5809",
            "patch": "@@ -25,6 +25,7 @@ export {\n   SWITCH_COMPILE_INJECTABLE__POST_R3__ as ɵSWITCH_COMPILE_INJECTABLE__POST_R3__,\n } from './di/injectable';\n export {INJECTOR_IMPL__POST_R3__ as ɵINJECTOR_IMPL__POST_R3__} from './di/injector';\n+export {CREATE_ATTRIBUTE_DECORATOR__POST_R3__ as ɵCREATE_ATTRIBUTE_DECORATOR__POST_R3__} from './di/metadata';\n export {\n   NG_INJ_DEF as ɵNG_INJ_DEF,\n   NG_PROV_DEF as ɵNG_PROV_DEF,"
        },
        {
            "sha": "658a39ef628965db2d17bfe9a947e583b8ac6d7f",
            "filename": "packages/core/src/di/metadata.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/f5cbf0bb54d6f3a498430fad03ae0966d4be5809/packages%2Fcore%2Fsrc%2Fdi%2Fmetadata.ts",
            "raw_url": "https://github.com/angular/angular/raw/f5cbf0bb54d6f3a498430fad03ae0966d4be5809/packages%2Fcore%2Fsrc%2Fdi%2Fmetadata.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fdi%2Fmetadata.ts?ref=f5cbf0bb54d6f3a498430fad03ae0966d4be5809",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {makeParamDecorator} from '../util/decorators';\n-\n+import {ɵɵinjectAttribute} from '../render3/instructions/di';\n \n \n /**\n@@ -274,11 +274,25 @@ export interface Attribute {\n   attributeName: string;\n }\n \n+function CREATE_ATTRIBUTE_DECORATOR__PRE_R3__(): AttributeDecorator {\n+  return makeParamDecorator(\n+    'Attribute',\n+    (attributeName?: string) => ({attributeName}));\n+}\n+\n+export function CREATE_ATTRIBUTE_DECORATOR__POST_R3__(): AttributeDecorator {\n+  return makeParamDecorator(\n+    'Attribute',\n+    (attributeName?: string) =>\n+        ({attributeName, __NG_ELEMENT_ID__: () => ɵɵinjectAttribute(attributeName!)}));\n+}\n+\n+const CREATE_ATTRIBUTE_DECORATOR_IMPL = CREATE_ATTRIBUTE_DECORATOR__PRE_R3__;\n+\n /**\n  * Attribute decorator and metadata.\n  *\n  * @Annotation\n  * @publicApi\n- */\n-export const Attribute: AttributeDecorator =\n-    makeParamDecorator('Attribute', (attributeName?: string) => ({attributeName}));\n+*/\n+export const Attribute: AttributeDecorator = CREATE_ATTRIBUTE_DECORATOR_IMPL();"
        },
        {
            "sha": "70f59007a01154952385f0d21cc4a4c4b4d7399b",
            "filename": "packages/core/test/acceptance/di_spec.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/f5cbf0bb54d6f3a498430fad03ae0966d4be5809/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f5cbf0bb54d6f3a498430fad03ae0966d4be5809/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts?ref=f5cbf0bb54d6f3a498430fad03ae0966d4be5809",
            "patch": "@@ -2771,6 +2771,38 @@ describe('di', () => {\n     });\n   });\n \n+  describe('attribute tokens', () => {\n+    it('should be able to provide an attribute token', () => {\n+      const TOKEN = new InjectionToken<string>('Some token');\n+      function factory(token: string): string {\n+        return token + ' with factory';\n+      }\n+      @Component({\n+        selector: 'my-comp',\n+        template: '...',\n+        providers: [{\n+          provide: TOKEN,\n+          deps: [[new Attribute('token')]],\n+          useFactory: factory,\n+        }]\n+      })\n+      class MyComp {\n+        constructor(@Inject(TOKEN) readonly token: string) {}\n+      }\n+\n+      @Component({template: `<my-comp token='token'></my-comp>`})\n+      class WrapperComp {\n+        @ViewChild(MyComp) myComp!: MyComp;\n+      }\n+\n+      TestBed.configureTestingModule({declarations: [MyComp, WrapperComp]});\n+\n+      const fixture = TestBed.createComponent(WrapperComp);\n+      fixture.detectChanges();\n+      expect(fixture.componentInstance.myComp.token).toBe('token with factory');\n+    });\n+  });\n+\n   it('should not cause cyclic dependency if same token is requested in deps with @SkipSelf', () => {\n     @Component({\n       selector: 'my-comp',"
        }
    ],
    "stats": {
        "total": 116,
        "additions": 112,
        "deletions": 4
    }
}