{
    "author": "JiaLiPassion",
    "message": "fix(core): NgZone coaleascing options should trigger onStable correctly (#40540)\n\nfix https://github.com/angular/components/issues/21674\n\nWhen setting `ngZoneRunCoalescing` to true, `onStable` is not emitted correctly.\nthe reason is before this commit, the code looks like this:\n\n```\n// application code call `ngZone.run()`\nngzone.run(() => {}); // step 1\n\n// inside NgZone, in the OnInvoke hook, NgZone try to delay the checkStable()\n\nfunction delayChangeDetectionForEvents(zone: NgZonePrivate) {\n  if (zone.lastRequestAnimationFrameId !== -1) { // step 9\n    return;\n  }\n  zone.lastRequestAnimationFrameId = zone.nativeRequestAnimationFrame.call(global, () => { // step 2\n    if (!zone.fakeTopEventTask) {\n      zone.fakeTopEventTask = Zone.root.scheduleEventTask('fakeTopEventTask', () => {\n        zone.lastRequestAnimationFrameId = -1; // step 3\n        updateMicroTaskStatus(zone); // step 4\n        checkStable(zone); // step 6\n      }, undefined, () => {}, () => {});\n    }\n    zone.fakeTopEventTask.invoke();\n  });\n  updatemicroTaskStatus(zone);\n}\n\nfunction updateMicroTaskStatus(zone: NgZonePrivate, ignoreCheckRAFId = false) {\n  if (zone._hasPendingMicrotasks ||\n      ((zone.shouldCoalesceEventChangeDetection || zone.shouldCoalesceRunChangeDetection) &&\n       zone.lastRequestAnimationFrameId !== -1)) { // step 5\n    zone.hasPendingMicrotasks = true;\n  } else {\n    zone.hasPendingMicrotasks = false;\n  }\n}\n\nfunction checkStable(zone: NgZonePrivate) {\n  if (zone._nesting == 0 && !zone.hasPendingMicrotasks && !zone.isStable) { // step 7\n    try {\n      zone._nesting++;\n      zone.onMicrotaskEmpty.emit(null);\n    ...\n}\n\n// application ref subscribe onMicroTaskEmpty\nngzone.onMicroTaskEmpty.subscribe(() => {\n  ngzone.run(() => { // step 8\n    tick();\n  });\n});\n\n```\n\nand the process is:\n1. step 1: application call ngZone.run()\n2. step 2: NgZone delay the checkStable() call in a requestAnimationFrame, and also set\nzone.lastRequestAnimationFrameId\n3. step 3: Inside the requestAnimationFrame callback, reset zone.lastRequestAnimationFrameId first\n4. step 4: update microTask status\n5, step 5: if zone.lastRequestAnimationFrameId is -1, that means no microTask pending.\n6. step 6: checkStable and trigger onMicrotaskEmpty emitter.\n7. step 7: ApplicationRef subscribed onMicrotaskEmpty, so it will call another `ngZone.run()` to process\ntick()\n8. step 8: And this new `ngZone.run()` will try to check `zone.lastRequestAnimationFrameId` in `step 9`\nwhen trying to delay the checkStable(), and since the zone.lastRequestAnimationFrameId is already reset\nto -1 in step 3, so this ngZone.run() will run into step 2 again.\n9. and become a infinite loop..., so onStable is never emit\n\nin this commit, there is a new flag `zone.isCheckStableRunning` added to\nprevent re-entry when `shouldCoaleascing` flag is enabled.\n\nPR Close #40540",
    "sha": "dc9fd1aaefa9cf2a019e293581117a8e84ae277c",
    "files": [
        {
            "sha": "74d1748116e07544835e55c83c36ecf526d4a038",
            "filename": "packages/core/src/zone/ng_zone.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 1,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/dc9fd1aaefa9cf2a019e293581117a8e84ae277c/packages%2Fcore%2Fsrc%2Fzone%2Fng_zone.ts",
            "raw_url": "https://github.com/angular/angular/raw/dc9fd1aaefa9cf2a019e293581117a8e84ae277c/packages%2Fcore%2Fsrc%2Fzone%2Fng_zone.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fzone%2Fng_zone.ts?ref=dc9fd1aaefa9cf2a019e293581117a8e84ae277c",
            "patch": "@@ -243,6 +243,17 @@ interface NgZonePrivate extends NgZone {\n   hasPendingMacrotasks: boolean;\n   hasPendingMicrotasks: boolean;\n   lastRequestAnimationFrameId: number;\n+  /**\n+   * A flag to indicate if NgZone is currently inside\n+   * checkStable and to prevent re-entry. The flag is\n+   * needed because it is possible to invoke the change\n+   * detection from within change detection leading to\n+   * incorrect behavior.\n+   *\n+   * For detail, please refer here,\n+   * https://github.com/angular/angular/pull/40540\n+   */\n+  isCheckStableRunning: boolean;\n   isStable: boolean;\n   /**\n    * Optionally specify coalescing event change detections or not.\n@@ -291,6 +302,21 @@ interface NgZonePrivate extends NgZone {\n }\n \n function checkStable(zone: NgZonePrivate) {\n+  // TODO: @JiaLiPassion, should check zone.isCheckStableRunning to prevent\n+  // re-entry. The case is:\n+  //\n+  // @Component({...})\n+  // export class AppComponent {\n+  // constructor(private ngZone: NgZone) {\n+  //   this.ngZone.onStable.subscribe(() => {\n+  //     this.ngZone.run(() => console.log('stable'););\n+  //   });\n+  // }\n+  //\n+  // The onStable subscriber run another function inside ngZone\n+  // which causes `checkStable()` re-entry.\n+  // But this fix causes some issues in g3, so this fix will be\n+  // launched in another PR.\n   if (zone._nesting == 0 && !zone.hasPendingMicrotasks && !zone.isStable) {\n     try {\n       zone._nesting++;\n@@ -309,7 +335,20 @@ function checkStable(zone: NgZonePrivate) {\n }\n \n function delayChangeDetectionForEvents(zone: NgZonePrivate) {\n-  if (zone.lastRequestAnimationFrameId !== -1) {\n+  /**\n+   * We also need to check _nesting here\n+   * Consider the following case with shouldCoalesceRunChangeDetection = true\n+   *\n+   * ngZone.run(() => {});\n+   * ngZone.run(() => {});\n+   *\n+   * We want the two `ngZone.run()` only trigger one change detection\n+   * when shouldCoalesceRunChangeDetection is true.\n+   * And because in this case, change detection run in async way(requestAnimationFrame),\n+   * so we also need to check the _nesting here to prevent multiple\n+   * change detections.\n+   */\n+  if (zone.isCheckStableRunning || zone.lastRequestAnimationFrameId !== -1) {\n     return;\n   }\n   zone.lastRequestAnimationFrameId = zone.nativeRequestAnimationFrame.call(global, () => {\n@@ -326,7 +365,9 @@ function delayChangeDetectionForEvents(zone: NgZonePrivate) {\n       zone.fakeTopEventTask = Zone.root.scheduleEventTask('fakeTopEventTask', () => {\n         zone.lastRequestAnimationFrameId = -1;\n         updateMicroTaskStatus(zone);\n+        zone.isCheckStableRunning = true;\n         checkStable(zone);\n+        zone.isCheckStableRunning = false;\n       }, undefined, () => {}, () => {});\n     }\n     zone.fakeTopEventTask.invoke();"
        },
        {
            "sha": "dd9b6cc5ad9555be2e9d5dabce2998d93086db01",
            "filename": "packages/core/test/zone/ng_zone_spec.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/dc9fd1aaefa9cf2a019e293581117a8e84ae277c/packages%2Fcore%2Ftest%2Fzone%2Fng_zone_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/dc9fd1aaefa9cf2a019e293581117a8e84ae277c/packages%2Fcore%2Ftest%2Fzone%2Fng_zone_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fzone%2Fng_zone_spec.ts?ref=dc9fd1aaefa9cf2a019e293581117a8e84ae277c",
            "patch": "@@ -982,6 +982,7 @@ function commonTests() {\n \n     describe('shouldCoalesceEventChangeDetection = true, shouldCoalesceRunChangeDetection = false', () => {\n       let nativeRequestAnimationFrame: (fn: FrameRequestCallback) => void;\n+      let nativeSetTimeout: any = (global as any)[Zone.__symbol__('setTimeout')];\n       if (!(global as any).requestAnimationFrame) {\n         nativeRequestAnimationFrame = function(fn: Function) {\n           (global as any)[Zone.__symbol__('setTimeout')](fn, 16);\n@@ -1042,6 +1043,32 @@ function commonTests() {\n            });\n          });\n \n+      it('should only emit onMicroTaskEmpty once within the same event loop for ngZone.run in onMicrotaskEmpty subscription',\n+         (done: DoneFn) => {\n+           const tasks: Task[] = [];\n+           coalesceZone.onMicrotaskEmpty.subscribe(() => {\n+             coalesceZone.run(() => {});\n+           });\n+           coalesceZone.run(() => {\n+             tasks.push(Zone.current.scheduleEventTask('myEvent', () => {\n+               logs.push('eventTask1');\n+             }, undefined, () => {}));\n+           });\n+           coalesceZone.run(() => {\n+             tasks.push(Zone.current.scheduleEventTask('myEvent', () => {\n+               logs.push('eventTask2');\n+             }, undefined, () => {}));\n+           });\n+           tasks.forEach(t => t.invoke());\n+           expect(logs).toEqual(['microTask empty', 'microTask empty', 'eventTask1', 'eventTask2']);\n+           nativeSetTimeout(() => {\n+             expect(logs).toEqual([\n+               'microTask empty', 'microTask empty', 'eventTask1', 'eventTask2', 'microTask empty'\n+             ]);\n+             done();\n+           }, 100);\n+         });\n+\n       it('should emit onMicroTaskEmpty once within the same event loop for not only event tasks, but event tasks are before other tasks',\n          (done: DoneFn) => {\n            const tasks: Task[] = [];\n@@ -1094,6 +1121,7 @@ function commonTests() {\n \n     describe('shouldCoalesceRunChangeDetection = true', () => {\n       let nativeRequestAnimationFrame: (fn: FrameRequestCallback) => void;\n+      let nativeSetTimeout: any = (global as any)[Zone.__symbol__('setTimeout')];\n       if (!(global as any).requestAnimationFrame) {\n         nativeRequestAnimationFrame = function(fn: Function) {\n           (global as any)[Zone.__symbol__('setTimeout')](fn, 16);\n@@ -1139,6 +1167,20 @@ function commonTests() {\n            });\n          });\n \n+      it('should only emit onMicroTaskEmpty once within the same event loop for ngZone.run in onMicrotaskEmpty subscription',\n+         (done: DoneFn) => {\n+           coalesceZone.onMicrotaskEmpty.subscribe(() => {\n+             coalesceZone.run(() => {});\n+           });\n+           coalesceZone.run(() => {});\n+           coalesceZone.run(() => {});\n+           expect(logs).toEqual([]);\n+           nativeSetTimeout(() => {\n+             expect(logs).toEqual(['microTask empty']);\n+             done();\n+           }, 100);\n+         });\n+\n       it('should only emit onMicroTaskEmpty once within the same event loop for multiple tasks',\n          (done: DoneFn) => {\n            const tasks: Task[] = [];"
        },
        {
            "sha": "0369cd615c81bafc64eb7db25bd6502189f0e2fb",
            "filename": "packages/platform-browser/test/dom/events/event_manager_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/dc9fd1aaefa9cf2a019e293581117a8e84ae277c/packages%2Fplatform-browser%2Ftest%2Fdom%2Fevents%2Fevent_manager_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/dc9fd1aaefa9cf2a019e293581117a8e84ae277c/packages%2Fplatform-browser%2Ftest%2Fdom%2Fevents%2Fevent_manager_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Ftest%2Fdom%2Fevents%2Fevent_manager_spec.ts?ref=dc9fd1aaefa9cf2a019e293581117a8e84ae277c",
            "patch": "@@ -436,13 +436,13 @@ describe('EventManager', () => {\n          removerChildFocus = manager.addEventListener(child, 'blur', blurHandler);\n        });\n        const sub = zone.onStable.subscribe(() => {\n+         sub.unsubscribe();\n          logs.push('begin');\n          Promise.resolve().then(() => {\n            logs.push('promise resolved');\n          });\n          element.appendChild(child);\n          getDOM().dispatchEvent(child, dispatchedBlurEvent);\n-         sub.unsubscribe();\n          logs.push('end');\n        });\n        getDOM().dispatchEvent(element, dispatchedClickEvent);\n@@ -482,13 +482,13 @@ describe('EventManager', () => {\n          removerChildFocus = manager.addEventListener(child, 'blur', blurHandler);\n        });\n        const sub = zone.onStable.subscribe(() => {\n+         sub.unsubscribe();\n          logs.push('begin');\n          Promise.resolve().then(() => {\n            logs.push('promise resolved');\n          });\n          element.appendChild(child);\n          getDOM().dispatchEvent(child, dispatchedBlurEvent);\n-         sub.unsubscribe();\n          logs.push('end');\n        });\n        getDOM().dispatchEvent(element, dispatchedClickEvent);"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 86,
        "deletions": 3
    }
}