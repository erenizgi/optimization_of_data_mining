{
    "author": "josephperrott",
    "message": "Revert \"fix(compiler-cli): autocomplete literal types in templates. (#41456)\" (#41623)\n\nThis reverts commit 1d12c50f63f90c91636185b2287e31e9c0291121.\n\nPR Close #41623",
    "sha": "0bc539af29a79604f904b770d0469717793a77de",
    "files": [
        {
            "sha": "da1d0bb294a9637d4164bd120c0d4993b059473c",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/checker.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/0bc539af29a79604f904b770d0469717793a77de/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/0bc539af29a79604f904b770d0469717793a77de/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts?ref=0bc539af29a79604f904b770d0469717793a77de",
            "patch": "@@ -105,9 +105,8 @@ export interface TemplateTypeChecker {\n    * include completions from the template's context component, as well as any local references or\n    * template variables which are in scope for that expression.\n    */\n-  getGlobalCompletions(\n-      context: TmplAstTemplate|null, component: ts.ClassDeclaration,\n-      node: AST|TmplAstNode): GlobalCompletion|null;\n+  getGlobalCompletions(context: TmplAstTemplate|null, component: ts.ClassDeclaration):\n+      GlobalCompletion|null;\n \n \n   /**"
        },
        {
            "sha": "7fb996cfb49d5677480f189ea533aed064c35321",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/completion.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/0bc539af29a79604f904b770d0469717793a77de/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcompletion.ts",
            "raw_url": "https://github.com/angular/angular/raw/0bc539af29a79604f904b770d0469717793a77de/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcompletion.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcompletion.ts?ref=0bc539af29a79604f904b770d0469717793a77de",
            "patch": "@@ -71,10 +71,4 @@ export interface GlobalCompletion {\n    * the same name (from the `componentContext` completions).\n    */\n   templateContext: Map<string, ReferenceCompletion|VariableCompletion>;\n-\n-  /**\n-   * A location within the type-checking shim where TypeScript's completion APIs can be used to\n-   * access completions for the AST node of the cursor position (primitive constants).\n-   */\n-  nodeContext: ShimLocation|null;\n }"
        },
        {
            "sha": "2490ad92bb4bbdab2df646d68226a09b90ea17bd",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/0bc539af29a79604f904b770d0469717793a77de/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/0bc539af29a79604f904b770d0469717793a77de/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=0bc539af29a79604f904b770d0469717793a77de",
            "patch": "@@ -257,15 +257,14 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     return this.getLatestComponentState(component).tcb;\n   }\n \n-  getGlobalCompletions(\n-      context: TmplAstTemplate|null, component: ts.ClassDeclaration,\n-      node: AST|TmplAstNode): GlobalCompletion|null {\n+  getGlobalCompletions(context: TmplAstTemplate|null, component: ts.ClassDeclaration):\n+      GlobalCompletion|null {\n     const engine = this.getOrCreateCompletionEngine(component);\n     if (engine === null) {\n       return null;\n     }\n     return this.perf.inPhase(\n-        PerfPhase.TtcAutocompletion, () => engine.getGlobalCompletions(context, node));\n+        PerfPhase.TtcAutocompletion, () => engine.getGlobalCompletions(context));\n   }\n \n   getExpressionCompletionLocation("
        },
        {
            "sha": "6157a663d758b581562214745b1eb1fffd33d83c",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/completion.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 82,
            "changes": 120,
            "blob_url": "https://github.com/angular/angular/blob/0bc539af29a79604f904b770d0469717793a77de/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcompletion.ts",
            "raw_url": "https://github.com/angular/angular/raw/0bc539af29a79604f904b770d0469717793a77de/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcompletion.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcompletion.ts?ref=0bc539af29a79604f904b770d0469717793a77de",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {TmplAstReference, TmplAstTemplate} from '@angular/compiler';\n-import {AST, EmptyExpr, MethodCall, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstNode} from '@angular/compiler/src/compiler';\n+import {MethodCall, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead} from '@angular/compiler/src/compiler';\n import * as ts from 'typescript';\n \n import {AbsoluteFsPath} from '../../file_system';\n@@ -23,77 +23,65 @@ import {TemplateData} from './context';\n  * surrounding TS program have changed.\n  */\n export class CompletionEngine {\n-  private componentContext: ShimLocation|null;\n-\n   /**\n-   * Cache of completions for various levels of the template, including the root template (`null`).\n-   * Memoizes `getTemplateContextCompletions`.\n+   * Cache of `GlobalCompletion`s for various levels of the template, including the root template\n+   * (`null`).\n    */\n-  private templateContextCache =\n-      new Map<TmplAstTemplate|null, Map<string, ReferenceCompletion|VariableCompletion>>();\n+  private globalCompletionCache = new Map<TmplAstTemplate|null, GlobalCompletion>();\n \n   private expressionCompletionCache =\n       new Map<PropertyRead|SafePropertyRead|MethodCall|SafeMethodCall, ShimLocation>();\n \n+  constructor(private tcb: ts.Node, private data: TemplateData, private shimPath: AbsoluteFsPath) {}\n+\n+  /**\n+   * Get global completions within the given template context - either a `TmplAstTemplate` embedded\n+   * view, or `null` for the root template context.\n+   */\n+  getGlobalCompletions(context: TmplAstTemplate|null): GlobalCompletion|null {\n+    if (this.globalCompletionCache.has(context)) {\n+      return this.globalCompletionCache.get(context)!;\n+    }\n \n-  constructor(private tcb: ts.Node, private data: TemplateData, private shimPath: AbsoluteFsPath) {\n     // Find the component completion expression within the TCB. This looks like: `ctx. /* ... */;`\n     const globalRead = findFirstMatchingNode(this.tcb, {\n       filter: ts.isPropertyAccessExpression,\n       withExpressionIdentifier: ExpressionIdentifier.COMPONENT_COMPLETION\n     });\n \n-    if (globalRead !== null) {\n-      this.componentContext = {\n+    if (globalRead === null) {\n+      return null;\n+    }\n+\n+    const completion: GlobalCompletion = {\n+      componentContext: {\n         shimPath: this.shimPath,\n         // `globalRead.name` is an empty `ts.Identifier`, so its start position immediately follows\n         // the `.` in `ctx.`. TS autocompletion APIs can then be used to access completion results\n         // for the component context.\n         positionInShimFile: globalRead.name.getStart(),\n-      };\n-    } else {\n-      this.componentContext = null;\n-    }\n-  }\n-\n-  /**\n-   * Get global completions within the given template context and AST node.\n-   *\n-   * @param context the given template context - either a `TmplAstTemplate` embedded view, or `null`\n-   *     for the root\n-   * template context.\n-   * @param node the given AST node\n-   */\n-  getGlobalCompletions(context: TmplAstTemplate|null, node: AST|TmplAstNode): GlobalCompletion\n-      |null {\n-    if (this.componentContext === null) {\n-      return null;\n-    }\n-\n-    const templateContext = this.getTemplateContextCompletions(context);\n-    if (templateContext === null) {\n-      return null;\n-    }\n+      },\n+      templateContext: new Map<string, ReferenceCompletion|VariableCompletion>(),\n+    };\n \n-    let nodeContext: ShimLocation|null = null;\n-    if (node instanceof EmptyExpr) {\n-      const nodeLocation = findFirstMatchingNode(this.tcb, {\n-        filter: ts.isIdentifier,\n-        withSpan: node.sourceSpan,\n-      });\n-      if (nodeLocation !== null) {\n-        nodeContext = {\n-          shimPath: this.shimPath,\n-          positionInShimFile: nodeLocation.getStart(),\n-        };\n+    // The bound template already has details about the references and variables in scope in the\n+    // `context` template - they just need to be converted to `Completion`s.\n+    for (const node of this.data.boundTarget.getEntitiesInTemplateScope(context)) {\n+      if (node instanceof TmplAstReference) {\n+        completion.templateContext.set(node.name, {\n+          kind: CompletionKind.Reference,\n+          node,\n+        });\n+      } else {\n+        completion.templateContext.set(node.name, {\n+          kind: CompletionKind.Variable,\n+          node,\n+        });\n       }\n     }\n \n-    return {\n-      componentContext: this.componentContext,\n-      templateContext,\n-      nodeContext,\n-    };\n+    this.globalCompletionCache.set(context, completion);\n+    return completion;\n   }\n \n   getExpressionCompletionLocation(expr: PropertyRead|PropertyWrite|MethodCall|\n@@ -143,36 +131,4 @@ export class CompletionEngine {\n     this.expressionCompletionCache.set(expr, res);\n     return res;\n   }\n-\n-  /**\n-   * Get global completions within the given template context - either a `TmplAstTemplate` embedded\n-   * view, or `null` for the root context.\n-   */\n-  private getTemplateContextCompletions(context: TmplAstTemplate|null):\n-      Map<string, ReferenceCompletion|VariableCompletion>|null {\n-    if (this.templateContextCache.has(context)) {\n-      return this.templateContextCache.get(context)!;\n-    }\n-\n-    const templateContext = new Map<string, ReferenceCompletion|VariableCompletion>();\n-\n-    // The bound template already has details about the references and variables in scope in the\n-    // `context` template - they just need to be converted to `Completion`s.\n-    for (const node of this.data.boundTarget.getEntitiesInTemplateScope(context)) {\n-      if (node instanceof TmplAstReference) {\n-        templateContext.set(node.name, {\n-          kind: CompletionKind.Reference,\n-          node,\n-        });\n-      } else {\n-        templateContext.set(node.name, {\n-          kind: CompletionKind.Variable,\n-          node,\n-        });\n-      }\n-    }\n-\n-    this.templateContextCache.set(context, templateContext);\n-    return templateContext;\n-  }\n }"
        },
        {
            "sha": "104b3ed279da63eef0830ec79aefecb14d73b4e0",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker__completion_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/0bc539af29a79604f904b770d0469717793a77de/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__completion_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0bc539af29a79604f904b770d0469717793a77de/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__completion_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__completion_spec.ts?ref=0bc539af29a79604f904b770d0469717793a77de",
            "patch": "@@ -141,7 +141,7 @@ function setupCompletions(\n     context = tmpl;\n   }\n \n-  const completions = templateTypeChecker.getGlobalCompletions(context, SomeCmp, null!)!;\n+  const completions = templateTypeChecker.getGlobalCompletions(context, SomeCmp)!;\n   expect(completions).toBeDefined();\n   return {\n     completions,"
        },
        {
            "sha": "69a0a8bd759d391d4d115f2dc92403ee2aaae72b",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 44,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/0bc539af29a79604f904b770d0469717793a77de/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/0bc539af29a79604f904b770d0469717793a77de/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=0bc539af29a79604f904b770d0469717793a77de",
            "patch": "@@ -216,21 +216,21 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       options: ts.GetCompletionsAtPositionOptions|\n       undefined): ts.WithMetadata<ts.CompletionInfo>|undefined {\n     const completions =\n-        this.templateTypeChecker.getGlobalCompletions(this.template, this.component, this.node);\n+        this.templateTypeChecker.getGlobalCompletions(this.template, this.component);\n     if (completions === null) {\n       return undefined;\n     }\n \n-    const {componentContext, templateContext, nodeContext: astContext} = completions;\n+    const {componentContext, templateContext} = completions;\n \n     const replacementSpan = makeReplacementSpanFromAst(this.node);\n \n     // Merge TS completion results with results from the template scope.\n     let entries: ts.CompletionEntry[] = [];\n-    const componentCompletions = this.tsLS.getCompletionsAtPosition(\n+    const tsLsCompletions = this.tsLS.getCompletionsAtPosition(\n         componentContext.shimPath, componentContext.positionInShimFile, options);\n-    if (componentCompletions !== undefined) {\n-      for (const tsCompletion of componentCompletions.entries) {\n+    if (tsLsCompletions !== undefined) {\n+      for (const tsCompletion of tsLsCompletions.entries) {\n         // Skip completions that are shadowed by a template entity definition.\n         if (templateContext.has(tsCompletion.name)) {\n           continue;\n@@ -244,24 +244,6 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       }\n     }\n \n-    // Merge TS completion results with results from the ast context.\n-    if (astContext !== null) {\n-      const nodeCompletions = this.tsLS.getCompletionsAtPosition(\n-          astContext.shimPath, astContext.positionInShimFile, options);\n-      if (nodeCompletions !== undefined) {\n-        for (const tsCompletion of nodeCompletions.entries) {\n-          if (this.isValidNodeContextCompletion(tsCompletion)) {\n-            entries.push({\n-              ...tsCompletion,\n-              // Substitute the TS completion's `replacementSpan` (which uses offsets within the\n-              // TCB) with the `replacementSpan` within the template source.\n-              replacementSpan,\n-            });\n-          }\n-        }\n-      }\n-    }\n-\n     for (const [name, entity] of templateContext) {\n       entries.push({\n         name,\n@@ -294,7 +276,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       formatOptions: ts.FormatCodeOptions|ts.FormatCodeSettings|undefined,\n       preferences: ts.UserPreferences|undefined): ts.CompletionEntryDetails|undefined {\n     const completions =\n-        this.templateTypeChecker.getGlobalCompletions(this.template, this.component, this.node);\n+        this.templateTypeChecker.getGlobalCompletions(this.template, this.component);\n     if (completions === null) {\n       return undefined;\n     }\n@@ -335,7 +317,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n   private getGlobalPropertyExpressionCompletionSymbol(\n       this: PropertyExpressionCompletionBuilder, entryName: string): ts.Symbol|undefined {\n     const completions =\n-        this.templateTypeChecker.getGlobalCompletions(this.template, this.component, this.node);\n+        this.templateTypeChecker.getGlobalCompletions(this.template, this.component);\n     if (completions === null) {\n       return undefined;\n     }\n@@ -656,25 +638,6 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       isNewIdentifierLocation: false,\n     };\n   }\n-\n-  /**\n-   * From the AST node of the cursor position, include completion of string literals, number\n-   * literals, `true`, `false`, `null`, and `undefined`.\n-   */\n-  private isValidNodeContextCompletion(completion: ts.CompletionEntry): boolean {\n-    if (completion.kind === ts.ScriptElementKind.string) {\n-      // 'string' kind includes both string literals and number literals\n-      return true;\n-    }\n-    if (completion.kind === ts.ScriptElementKind.keyword) {\n-      return completion.name === 'true' || completion.name === 'false' ||\n-          completion.name === 'null';\n-    }\n-    if (completion.kind === ts.ScriptElementKind.variableElement) {\n-      return completion.name === 'undefined';\n-    }\n-    return false;\n-  }\n }\n \n function makeReplacementSpanFromParseSourceSpan(span: ParseSourceSpan): ts.TextSpan {"
        },
        {
            "sha": "b881a614e7ce7702721973b55047afa125c6a5bb",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 26,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/0bc539af29a79604f904b770d0469717793a77de/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0bc539af29a79604f904b770d0469717793a77de/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=0bc539af29a79604f904b770d0469717793a77de",
            "patch": "@@ -24,18 +24,6 @@ const DIR_WITH_INPUT = {\n   `\n };\n \n-const DIR_WITH_UNION_TYPE_INPUT = {\n-  'Dir': `\n-    @Directive({\n-      selector: '[dir]',\n-      inputs: ['myInput']\n-    })\n-    export class Dir {\n-      myInput!: 'foo'|42|null|undefined\n-    }\n-  `\n-};\n-\n const DIR_WITH_OUTPUT = {\n   'Dir': `\n     @Directive({\n@@ -215,18 +203,6 @@ describe('completions', () => {\n       const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title']);\n     });\n-\n-    it('should return completions of string literals, number literals, `true`, `false`, `null` and `undefined`',\n-       () => {\n-         const {templateFile} = setup(`<input dir [myInput]=\"\">`, '', DIR_WITH_UNION_TYPE_INPUT);\n-         templateFile.moveCursorToText('dir [myInput]=\"Â¦\">');\n-\n-         const completions = templateFile.getCompletionsAtPosition();\n-         expectContain(completions, ts.ScriptElementKind.string, [`'foo'`, '42']);\n-         expectContain(completions, ts.ScriptElementKind.keyword, ['null']);\n-         expectContain(completions, ts.ScriptElementKind.variableElement, ['undefined']);\n-         expectDoesNotContain(completions, ts.ScriptElementKind.parameterElement, ['ctx']);\n-       });\n   });\n \n   describe('in an expression scope', () => {\n@@ -813,7 +789,7 @@ function setup(\n         export class AppCmp {\n           ${classContents}\n         }\n-\n+        \n         ${otherDirectiveClassDecls}\n \n         @NgModule({\n@@ -846,7 +822,7 @@ function setupInlineTemplate(\n         export class AppCmp {\n           ${classContents}\n         }\n-\n+        \n         ${otherDirectiveClassDecls}\n \n         @NgModule({"
        }
    ],
    "stats": {
        "total": 219,
        "additions": 53,
        "deletions": 166
    }
}