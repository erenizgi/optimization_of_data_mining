{
    "author": "petebacondarwin",
    "message": "fix(localize): improve invalid syntax in extraction error message (#40724)\n\nPreviously if the code is invalid the error message might look like:\n\n```\nUnexpected messageParts for `$localize` (expected an array of strings).\n```\n\nThis is not very helpful for debugging where the problem occurs.\n\nNow we build a \"code-frame\" description to give more useful information:\n\n```\nTypeError: Cannot create property 'message' on string '.../src/app/app.component.js:\nUnexpected messageParts for `$localize` (expected an array of strings).\n  4 | export class AppComponent {\n  5 |     constructor() {\n> 6 |         this.title = $localize(a = ['myapp'], []);\n    |                                ^^^^^^^^^^^^^\n  7 |     }\n  8 | }\n  ```\n\nPR Close #40724",
    "sha": "9dada8a2dd808181d2084fb1bc52ffa931af3e38",
    "files": [
        {
            "sha": "27ae97333a37c259e2449cc6cf6c7285e9064eb3",
            "filename": "packages/localize/src/tools/src/extract/source_files/es5_extract_plugin.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 12,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/9dada8a2dd808181d2084fb1bc52ffa931af3e38/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fsource_files%2Fes5_extract_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dada8a2dd808181d2084fb1bc52ffa931af3e38/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fsource_files%2Fes5_extract_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fsource_files%2Fes5_extract_plugin.ts?ref=9dada8a2dd808181d2084fb1bc52ffa931af3e38",
            "patch": "@@ -10,24 +10,35 @@ import {ɵParsedMessage, ɵparseMessage} from '@angular/localize';\n import {NodePath, PluginObj} from '@babel/core';\n import {CallExpression} from '@babel/types';\n \n-import {getLocation, isGlobalIdentifier, isNamedIdentifier, unwrapMessagePartsFromLocalizeCall, unwrapSubstitutionsFromLocalizeCall} from '../../source_file_utils';\n+import {buildCodeFrameError, getLocation, isBabelParseError, isGlobalIdentifier, isNamedIdentifier, unwrapMessagePartsFromLocalizeCall, unwrapSubstitutionsFromLocalizeCall} from '../../source_file_utils';\n \n export function makeEs5ExtractPlugin(\n     fs: PathManipulation, messages: ɵParsedMessage[], localizeName = '$localize'): PluginObj {\n   return {\n     visitor: {\n       CallExpression(callPath: NodePath<CallExpression>) {\n-        const calleePath = callPath.get('callee');\n-        if (isNamedIdentifier(calleePath, localizeName) && isGlobalIdentifier(calleePath)) {\n-          const [messageParts, messagePartLocations] =\n-              unwrapMessagePartsFromLocalizeCall(callPath, fs);\n-          const [expressions, expressionLocations] =\n-              unwrapSubstitutionsFromLocalizeCall(callPath, fs);\n-          const [messagePartsArg, expressionsArg] = callPath.get('arguments');\n-          const location = getLocation(fs, messagePartsArg, expressionsArg);\n-          const message = ɵparseMessage(\n-              messageParts, expressions, location, messagePartLocations, expressionLocations);\n-          messages.push(message);\n+        try {\n+          const calleePath = callPath.get('callee');\n+          if (isNamedIdentifier(calleePath, localizeName) && isGlobalIdentifier(calleePath)) {\n+            const [messageParts, messagePartLocations] =\n+                unwrapMessagePartsFromLocalizeCall(callPath, fs);\n+            const [expressions, expressionLocations] =\n+                unwrapSubstitutionsFromLocalizeCall(callPath, fs);\n+            const [messagePartsArg, expressionsArg] = callPath.get('arguments');\n+            const location = getLocation(fs, messagePartsArg, expressionsArg);\n+            const message = ɵparseMessage(\n+                messageParts, expressions, location, messagePartLocations, expressionLocations);\n+            messages.push(message);\n+          }\n+        } catch (e) {\n+          if (isBabelParseError(e)) {\n+            // If we get a BabelParseError here then something went wrong with Babel itself\n+            // since there must be something wrong with the structure of the AST generated\n+            // by Babel parsing a TaggedTemplateExpression.\n+            throw buildCodeFrameError(callPath, e);\n+          } else {\n+            throw e;\n+          }\n         }\n       }\n     }"
        },
        {
            "sha": "db587f04130dc24368f0e591792e3c2ffd91c875",
            "filename": "packages/localize/src/tools/test/extract/source_files/es5_extract_plugin_spec.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/9dada8a2dd808181d2084fb1bc52ffa931af3e38/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fsource_files%2Fes5_extract_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dada8a2dd808181d2084fb1bc52ffa931af3e38/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fsource_files%2Fes5_extract_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fsource_files%2Fes5_extract_plugin_spec.ts?ref=9dada8a2dd808181d2084fb1bc52ffa931af3e38",
            "patch": "@@ -0,0 +1,37 @@\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {ɵParsedMessage} from '@angular/localize/private';\n+import {transformSync} from '@babel/core';\n+\n+import {makeEs5ExtractPlugin} from '../../../src/extract/source_files/es5_extract_plugin';\n+\n+runInEachFileSystem(() => {\n+  describe('makeEs5ExtractPlugin()', () => {\n+    it('should error with code-frame information if the first argument to `$localize` is not an array',\n+       () => {\n+         const input = '$localize(null, [])';\n+         expect(() => transformCode(input))\n+             .toThrowError(\n+                 'Cannot create property \\'message\\' on string \\'/app/dist/test.js: Unexpected messageParts for `$localize` (expected an array of strings).\\n' +\n+                 '> 1 | $localize(null, [])\\n' +\n+                 '    |           ^^^^\\'');\n+       });\n+\n+    function transformCode(input: string): ɵParsedMessage[] {\n+      const messages: ɵParsedMessage[] = [];\n+      transformSync(input, {\n+        plugins: [makeEs5ExtractPlugin(getFileSystem(), messages)],\n+        filename: '/app/dist/test.js'\n+      })!.code!;\n+      return messages;\n+    }\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 60,
        "deletions": 12
    }
}