{
    "author": "petebacondarwin",
    "message": "fix(compiler): support i18n interpolated only attribute bindings (#43815)\n\nWhile fully dynamic bound properties (and attributes) cannot be marked for localization, properties that only contain interpolation can.\n\nThis commit ensure that attribute bindings that only contain interpolation can also be marked for localization.\n\nCloses #43260\n\nPR Close #43815",
    "sha": "bba0a8705548f16b4db3b88d03deb6e67a85e414",
    "files": [
        {
            "sha": "e759cc6def59ae3077db43c3fe4d373a160ff723",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 60,
            "deletions": 0,
            "changes": 60,
            "blob_url": "https://github.com/angular/angular/blob/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FGOLDEN_PARTIAL.js?ref=bba0a8705548f16b4db3b88d03deb6e67a85e414",
            "patch": "@@ -358,6 +358,66 @@ export declare class MyModule {\n     static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: interpolated_attributes.js\n+ ****************************************************************************************************/\n+import { Component, NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class MyComponent {\n+    constructor() {\n+        this.name = 'Angular';\n+    }\n+}\n+MyComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: `\n+  <div\n+  title=\"title {{name}}\" i18n-title\n+  attr.label=\"label {{name}}\" i18n-label=\"@@id1\"\n+  attr.lang=\"lang {{name}}\" i18n-attr.lang=\"@@id2\"\n+  attr.dir=\"dir {{name}}\" i18n-attr.dir=\"@@id3\" i18n-dir=\"@@id4\"\n+  attr.draggable=\"draggable {{name}}\" i18n-draggable=\"@@id5\" i18n-attr.draggable=\"@@id6\">\n+  </div>\n+  `, isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyComponent, decorators: [{\n+            type: Component,\n+            args: [{\n+                    selector: 'my-component',\n+                    template: `\n+  <div\n+  title=\"title {{name}}\" i18n-title\n+  attr.label=\"label {{name}}\" i18n-label=\"@@id1\"\n+  attr.lang=\"lang {{name}}\" i18n-attr.lang=\"@@id2\"\n+  attr.dir=\"dir {{name}}\" i18n-attr.dir=\"@@id3\" i18n-dir=\"@@id4\"\n+  attr.draggable=\"draggable {{name}}\" i18n-draggable=\"@@id5\" i18n-attr.draggable=\"@@id6\">\n+  </div>\n+  `\n+                }]\n+        }] });\n+export class MyModule {\n+}\n+MyModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\n+MyModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, declarations: [MyComponent] });\n+MyModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{ declarations: [MyComponent] }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: interpolated_attributes.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class MyComponent {\n+    name: string;\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyComponent, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<MyComponent, \"my-component\", never, {}, {}, never, never>;\n+}\n+export declare class MyModule {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyModule, never>;\n+    static ɵmod: i0.ɵɵNgModuleDeclaration<MyModule, [typeof MyComponent], never, never>;\n+    static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n+}\n+\n /****************************************************************************************************\n  * PARTIAL FILE: static_attributes.js\n  ****************************************************************************************************/"
        },
        {
            "sha": "dde7fe0746c179b7dfa3245c1483a8caafb75b99",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/TEST_CASES.json",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FTEST_CASES.json?ref=bba0a8705548f16b4db3b88d03deb6e67a85e414",
            "patch": "@@ -99,6 +99,20 @@\n         }\n       ]\n     },\n+    {\n+      \"description\": \"should create translations for interpolated attributes\",\n+      \"inputFiles\": [\n+        \"interpolated_attributes.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"extraChecks\": [\n+            \"verifyPlaceholdersIntegrity\",\n+            \"verifyUniqueConsts\"\n+          ]\n+        }\n+      ]\n+    },\n     {\n       \"description\": \"should translate static attributes\",\n       \"inputFiles\": ["
        },
        {
            "sha": "d4953741084f0fd99e31e87875f4ce431dd5b388",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/interpolated_attributes.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Finterpolated_attributes.js",
            "raw_url": "https://github.com/angular/angular/raw/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Finterpolated_attributes.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Finterpolated_attributes.js?ref=bba0a8705548f16b4db3b88d03deb6e67a85e414",
            "patch": "@@ -0,0 +1,21 @@\n+consts: function () {\n+  __i18nMsg__('title {$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]], {})\n+  __i18nMsg__('label {$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]], {id: 'id1'})\n+  __i18nMsg__('lang {$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]], {id: 'id2'})\n+  __i18nMsg__('dir {$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]], {id: 'id3'})\n+  __i18nMsg__('draggable {$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]], {id: 'id6'})\n+  return [\n+    [6, \"title\", \"label\", \"lang\", \"dir\", \"draggable\"], [\"title\", $i18n_1$, \"label\", $i18n_2$, \"lang\", $i18n_3$, \"dir\", $i18n_4$, \"draggable\", $i18n_5$]\n+  ];\n+},\n+template: function MyComponent_Template(rf, ctx) {\n+  if (rf & 1) {\n+    i0.ɵɵelementStart(0, \"div\", 0);\n+    i0.ɵɵi18nAttributes(1, 1);\n+    i0.ɵɵelementEnd();\n+  }\n+  if (rf & 2) {\n+    i0.ɵɵi18nExp(ctx.name)(ctx.name)(ctx.name)(ctx.name)(ctx.name);\n+    i0.ɵɵi18nApply(1);\n+  }\n+}"
        },
        {
            "sha": "e641fd48e45d19a0f72b4d39118300fbc56a749a",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/interpolated_attributes.ts",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Finterpolated_attributes.ts",
            "raw_url": "https://github.com/angular/angular/raw/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Finterpolated_attributes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Finterpolated_attributes.ts?ref=bba0a8705548f16b4db3b88d03deb6e67a85e414",
            "patch": "@@ -0,0 +1,21 @@\n+import {Component, NgModule} from '@angular/core';\n+\n+@Component({\n+  selector: 'my-component',\n+  template: `\n+  <div\n+  title=\"title {{name}}\" i18n-title\n+  attr.label=\"label {{name}}\" i18n-label=\"@@id1\"\n+  attr.lang=\"lang {{name}}\" i18n-attr.lang=\"@@id2\"\n+  attr.dir=\"dir {{name}}\" i18n-attr.dir=\"@@id3\" i18n-dir=\"@@id4\"\n+  attr.draggable=\"draggable {{name}}\" i18n-draggable=\"@@id5\" i18n-attr.draggable=\"@@id6\">\n+  </div>\n+  `\n+})\n+export class MyComponent {\n+  name = 'Angular';\n+}\n+\n+@NgModule({declarations: [MyComponent]})\n+export class MyModule {\n+}"
        },
        {
            "sha": "992f420b496aa36a6c8ed35993d9dd1128b3c12c",
            "filename": "packages/compiler/src/render3/view/i18n/meta.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts",
            "raw_url": "https://github.com/angular/angular/raw/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts?ref=bba0a8705548f16b4db3b88d03deb6e67a85e414",
            "patch": "@@ -16,7 +16,7 @@ import {ParseTreeResult} from '../../../ml_parser/parser';\n import * as o from '../../../output/output_ast';\n import {isTrustedTypesSink} from '../../../schema/trusted_types_sinks';\n \n-import {hasI18nAttrs, I18N_ATTR, I18N_ATTR_PREFIX, icuFromI18nMessage} from './util';\n+import {ATTR_BINDING_MATCHER, hasI18nAttrs, I18N_ATTR, I18N_ATTR_PREFIX, icuFromI18nMessage} from './util';\n \n export type I18nMeta = {\n   id?: string,\n@@ -83,7 +83,7 @@ export class I18nMetaVisitor implements html.Visitor {\n \n       for (const attr of element.attrs) {\n         if (attr.name === I18N_ATTR) {\n-          // root 'i18n' node attribute\n+          // 'i18n' attribute that marks the element contents as an i18n message\n           const i18n = element.i18n || attr.value;\n           message = this._generateI18nMessage(element.children, i18n, setI18nRefs);\n           if (message.nodes.length === 0) {\n@@ -110,7 +110,10 @@ export class I18nMetaVisitor implements html.Visitor {\n       // set i18n meta for attributes\n       if (Object.keys(attrsMeta).length) {\n         for (const attr of attrs) {\n-          const meta = attrsMeta[attr.name];\n+          // First try to match the metadata to the attribute name as-is.\n+          // If that cannot be found try removing any `attr.` prefix from the attribute name.\n+          const meta =\n+              attrsMeta[attr.name] ?? attrsMeta[attr.name.replace(ATTR_BINDING_MATCHER, '')];\n           // do not create translation for empty attributes\n           if (meta !== undefined && attr.value) {\n             attr.i18n = this._generateI18nMessage([attr], attr.i18n || meta);"
        },
        {
            "sha": "821d83c40bf2aa332294c6a4509a249d579584d8",
            "filename": "packages/compiler/src/render3/view/i18n/util.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Futil.ts?ref=bba0a8705548f16b4db3b88d03deb6e67a85e414",
            "patch": "@@ -24,6 +24,12 @@ export const TRANSLATION_VAR_PREFIX = 'i18n_';\n /** Name of the i18n attributes **/\n export const I18N_ATTR = 'i18n';\n export const I18N_ATTR_PREFIX = 'i18n-';\n+/**\n+ * Matches the prefix used when binding to an attribute rather than a property.\n+ *\n+ * For example: `[attr.title]=\"expression\"`.\n+ * */\n+export const ATTR_BINDING_MATCHER = /^attr\\./i;\n \n /** Prefix of var expressions used in ICUs */\n export const I18N_ICU_VAR_PREFIX = 'VAR_';"
        },
        {
            "sha": "0a32abbd7822c8d91c9c5310795562f8a53c17c5",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=bba0a8705548f16b4db3b88d03deb6e67a85e414",
            "patch": "@@ -656,7 +656,8 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n     element.inputs.forEach(input => {\n       const stylingInputWasSet = stylingBuilder.registerBoundInput(input);\n       if (!stylingInputWasSet) {\n-        if (input.type === BindingType.Property && input.i18n) {\n+        if ((input.type === BindingType.Property || input.type === BindingType.Attribute) &&\n+            input.i18n) {\n           boundI18nAttrs.push(input);\n         } else {\n           allOtherInputs.push(input);"
        },
        {
            "sha": "454954692e2c5d0c46411011cf81b0d2e170fc86",
            "filename": "packages/core/test/acceptance/i18n_spec.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bba0a8705548f16b4db3b88d03deb6e67a85e414/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts?ref=bba0a8705548f16b4db3b88d03deb6e67a85e414",
            "patch": "@@ -1616,6 +1616,27 @@ onlyInIvy('Ivy i18n logic').describe('runtime i18n', () => {\n       expect(fixture.nativeElement.innerHTML).toEqual(`<div title=\"bonjour John\"></div>`);\n     });\n \n+    it('interpolated \"attr.\" bindings', () => {\n+      loadTranslations({\n+        [computeMsgId('hello {$INTERPOLATION}')]: 'bonjour {$INTERPOLATION}',\n+        custom: 'translated-{$INTERPOLATION}'\n+      });\n+      const fixture = initWithTemplate(AppComp, `\n+        <div i18n-attr.title attr.title=\"hello {{name}}\"></div>\n+        <div i18n-title attr.title=\"hello {{name}}\"></div>\n+        <div i18n-attr.title=\"@@custom\" attr.title=\"original-{{name}}\"></div>\n+      `);\n+      expect(fixture.nativeElement.innerHTML)\n+          .toEqual(\n+              `<div title=\"bonjour Angular\"></div><div title=\"bonjour Angular\"></div><div title=\"translated-Angular\"></div>`);\n+\n+      fixture.componentRef.instance.name = 'John';\n+      fixture.detectChanges();\n+      expect(fixture.nativeElement.innerHTML)\n+          .toEqual(\n+              `<div title=\"bonjour John\"></div><div title=\"bonjour John\"></div><div title=\"translated-John\"></div>`);\n+    });\n+\n     it('with pipes', () => {\n       loadTranslations({[computeMsgId('hello {$INTERPOLATION}')]: 'bonjour {$INTERPOLATION}'});\n       const fixture = initWithTemplate("
        }
    ],
    "stats": {
        "total": 155,
        "additions": 151,
        "deletions": 4
    }
}