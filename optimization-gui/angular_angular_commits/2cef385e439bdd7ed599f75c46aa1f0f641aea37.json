{
    "author": "josephperrott",
    "message": "feat(dev-infra): prevent `git push` from being called in dryRun mode (#41387)\n\nUpdate GitClient to prevent the `push` command from being run in dryMode.\n\nPR Close #41387",
    "sha": "2cef385e439bdd7ed599f75c46aa1f0f641aea37",
    "files": [
        {
            "sha": "e8490cf065fad2c2857022112cc675d7d038344e",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/2cef385e439bdd7ed599f75c46aa1f0f641aea37/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/2cef385e439bdd7ed599f75c46aa1f0f641aea37/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=2cef385e439bdd7ed599f75c46aa1f0f641aea37",
            "patch": "@@ -434,6 +434,31 @@ function addGithubTokenOption(yargs) {\n         .default('github-token', '', '<LOCAL TOKEN>');\n }\n \n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/** Whether the current environment is in dry run mode. */\n+function isDryRun() {\n+    return process.env['DRY_RUN'] !== undefined;\n+}\n+/** Error to be thrown when a function or method is called in dryRun mode and shouldn't be. */\n+var DryRunError = /** @class */ (function (_super) {\n+    tslib.__extends(DryRunError, _super);\n+    function DryRunError() {\n+        var _this = _super.call(this, 'Cannot call this function in dryRun mode.') || this;\n+        // Set the prototype explicitly because in ES5, the prototype is accidentally lost due to\n+        // a limitation in down-leveling.\n+        // https://github.com/Microsoft/TypeScript/wiki/FAQ#why-doesnt-extending-built-ins-like-error-array-and-map-work.\n+        Object.setPrototypeOf(_this, DryRunError.prototype);\n+        return _this;\n+    }\n+    return DryRunError;\n+}(Error));\n+\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n@@ -604,6 +629,12 @@ var GitClient = /** @class */ (function () {\n      */\n     GitClient.prototype.runGraceful = function (args, options) {\n         if (options === void 0) { options = {}; }\n+        /** The git command to be run. */\n+        var gitCommand = args[0];\n+        if (isDryRun() && gitCommand === 'push') {\n+            debug(\"\\\"git push\\\" is not able to be run in dryRun mode.\");\n+            throw new DryRunError();\n+        }\n         // To improve the debugging experience in case something fails, we print all executed Git\n         // commands to better understand the git actions occuring. Depending on the command being\n         // executed, this debugging information should be logged at different logging levels."
        },
        {
            "sha": "e1358e4af2ce5a77f937b7523e42354c53348e85",
            "filename": "dev-infra/utils/dry-run.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/2cef385e439bdd7ed599f75c46aa1f0f641aea37/dev-infra%2Futils%2Fdry-run.ts",
            "raw_url": "https://github.com/angular/angular/raw/2cef385e439bdd7ed599f75c46aa1f0f641aea37/dev-infra%2Futils%2Fdry-run.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fdry-run.ts?ref=2cef385e439bdd7ed599f75c46aa1f0f641aea37",
            "patch": "@@ -9,7 +9,7 @@\n import {Argv} from 'yargs';\n \n /**\n- * Add a --dry-run flag to the available options for the yargs argv object.  When present, sets an\n+ * Add a --dry-run flag to the available options for the yargs argv object. When present, sets an\n  * environment variable noting dry run mode.\n  */\n export function addDryRunFlag<T>(args: Argv<T>) {"
        },
        {
            "sha": "0eb030be52f1b9b5fd20fe1b54edb61311cf5129",
            "filename": "dev-infra/utils/git/index.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/2cef385e439bdd7ed599f75c46aa1f0f641aea37/dev-infra%2Futils%2Fgit%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/2cef385e439bdd7ed599f75c46aa1f0f641aea37/dev-infra%2Futils%2Fgit%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Findex.ts?ref=2cef385e439bdd7ed599f75c46aa1f0f641aea37",
            "patch": "@@ -11,6 +11,7 @@ import {spawnSync, SpawnSyncOptions, SpawnSyncReturns} from 'child_process';\n \n import {getConfig, getRepoBaseDir, NgDevConfig} from '../config';\n import {debug, info, yellow} from '../console';\n+import {DryRunError, isDryRun} from '../dry-run';\n import {GithubClient} from './github';\n import {getRepositoryGitUrl, GITHUB_TOKEN_GENERATE_URL, GITHUB_TOKEN_SETTINGS_URL} from './github-urls';\n \n@@ -89,6 +90,14 @@ export class GitClient {\n    * info failed commands.\n    */\n   runGraceful(args: string[], options: SpawnSyncOptions = {}): SpawnSyncReturns<string> {\n+    /** The git command to be run. */\n+    const gitCommand = args[0];\n+\n+    if (isDryRun() && gitCommand === 'push') {\n+      debug(`\"git push\" is not able to be run in dryRun mode.`);\n+      throw new DryRunError();\n+    }\n+\n     // To improve the debugging experience in case something fails, we print all executed Git\n     // commands to better understand the git actions occuring. Depending on the command being\n     // executed, this debugging information should be logged at different logging levels."
        }
    ],
    "stats": {
        "total": 42,
        "additions": 41,
        "deletions": 1
    }
}