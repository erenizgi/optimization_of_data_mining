{
    "author": "arturovt",
    "message": "fix(platform-browser): ensure that Hammer loader is called only once (#40911)\n\nCurrently, the function that is provided through `HAMMER_LOADER` is called the\nsame number of times as the `HammerGesturesPlugin.addEventListener` method is called\n(until the Hammer is loaded).\n\nThis commit adds a class property in which the loader call is saved, thereby\npreventing multiple calls to the loader function.\n\nPR Close #25995\n\nPR Close #40911",
    "sha": "228b5f73b14ff5bde3274bcece0b7a4eaad01a54",
    "files": [
        {
            "sha": "11f9a70f3c6acc0a78d6b696acf65614dc8b03b2",
            "filename": "packages/platform-browser/src/dom/events/hammer_gestures.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 9,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/228b5f73b14ff5bde3274bcece0b7a4eaad01a54/packages%2Fplatform-browser%2Fsrc%2Fdom%2Fevents%2Fhammer_gestures.ts",
            "raw_url": "https://github.com/angular/angular/raw/228b5f73b14ff5bde3274bcece0b7a4eaad01a54/packages%2Fplatform-browser%2Fsrc%2Fdom%2Fevents%2Fhammer_gestures.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Fsrc%2Fdom%2Fevents%2Fhammer_gestures.ts?ref=228b5f73b14ff5bde3274bcece0b7a4eaad01a54",
            "patch": "@@ -162,6 +162,8 @@ export class HammerGestureConfig {\n  */\n @Injectable()\n export class HammerGesturesPlugin extends EventManagerPlugin {\n+  private _loaderPromise: Promise<void>|null = null;\n+\n   constructor(\n       @Inject(DOCUMENT) doc: any,\n       @Inject(HAMMER_GESTURE_CONFIG) private _config: HammerGestureConfig, private console: Console,\n@@ -175,9 +177,11 @@ export class HammerGesturesPlugin extends EventManagerPlugin {\n     }\n \n     if (!(window as any).Hammer && !this.loader) {\n-      this.console.warn(\n-          `The \"${eventName}\" event cannot be bound because Hammer.JS is not ` +\n-          `loaded and no custom loader has been specified.`);\n+      if (typeof ngDevMode === 'undefined' || ngDevMode) {\n+        this.console.warn(\n+            `The \"${eventName}\" event cannot be bound because Hammer.JS is not ` +\n+            `loaded and no custom loader has been specified.`);\n+      }\n       return false;\n     }\n \n@@ -191,6 +195,7 @@ export class HammerGesturesPlugin extends EventManagerPlugin {\n     // If Hammer is not present but a loader is specified, we defer adding the event listener\n     // until Hammer is loaded.\n     if (!(window as any).Hammer && this.loader) {\n+      this._loaderPromise = this._loaderPromise || this.loader();\n       // This `addEventListener` method returns a function to remove the added listener.\n       // Until Hammer is loaded, the returned function needs to *cancel* the registration rather\n       // than remove anything.\n@@ -199,12 +204,14 @@ export class HammerGesturesPlugin extends EventManagerPlugin {\n         cancelRegistration = true;\n       };\n \n-      this.loader()\n+      this._loaderPromise\n           .then(() => {\n             // If Hammer isn't actually loaded when the custom loader resolves, give up.\n             if (!(window as any).Hammer) {\n-              this.console.warn(\n-                  `The custom HAMMER_LOADER completed, but Hammer.JS is not present.`);\n+              if (typeof ngDevMode === 'undefined' || ngDevMode) {\n+                this.console.warn(\n+                    `The custom HAMMER_LOADER completed, but Hammer.JS is not present.`);\n+              }\n               deregister = () => {};\n               return;\n             }\n@@ -216,9 +223,11 @@ export class HammerGesturesPlugin extends EventManagerPlugin {\n             }\n           })\n           .catch(() => {\n-            this.console.warn(\n-                `The \"${eventName}\" event cannot be bound because the custom ` +\n-                `Hammer.JS loader failed.`);\n+            if (typeof ngDevMode === 'undefined' || ngDevMode) {\n+              this.console.warn(\n+                  `The \"${eventName}\" event cannot be bound because the custom ` +\n+                  `Hammer.JS loader failed.`);\n+            }\n             deregister = () => {};\n           });\n "
        },
        {
            "sha": "715cc5b48279164c94114ff56133ec2d43aedb87",
            "filename": "packages/platform-browser/test/dom/events/hammer_gestures_spec.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/228b5f73b14ff5bde3274bcece0b7a4eaad01a54/packages%2Fplatform-browser%2Ftest%2Fdom%2Fevents%2Fhammer_gestures_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/228b5f73b14ff5bde3274bcece0b7a4eaad01a54/packages%2Fplatform-browser%2Ftest%2Fdom%2Fevents%2Fhammer_gestures_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Ftest%2Fdom%2Fevents%2Fhammer_gestures_spec.ts?ref=228b5f73b14ff5bde3274bcece0b7a4eaad01a54",
            "patch": "@@ -67,6 +67,8 @@ import {HammerGestureConfig, HammerGesturesPlugin,} from '@angular/platform-brow\n         ngZone = z;\n       }));\n \n+      let loaderCalled = 0;\n+\n       beforeEach(() => {\n         originalHammerGlobal = (window as any).Hammer;\n         (window as any).Hammer = undefined;\n@@ -76,10 +78,13 @@ import {HammerGestureConfig, HammerGesturesPlugin,} from '@angular/platform-brow\n           off: jasmine.createSpy('mc.off'),\n         };\n \n-        loader = () => new Promise((resolve, reject) => {\n-          resolveLoader = resolve;\n-          failLoader = reject;\n-        });\n+        loader = () => {\n+          loaderCalled++;\n+          return new Promise((resolve, reject) => {\n+            resolveLoader = resolve;\n+            failLoader = reject;\n+          });\n+        };\n \n         // Make the hammer config return a fake hammer instance\n         const hammerConfig = new HammerGestureConfig();\n@@ -95,9 +100,19 @@ import {HammerGestureConfig, HammerGesturesPlugin,} from '@angular/platform-brow\n       });\n \n       afterEach(() => {\n+        loaderCalled = 0;\n         (window as any).Hammer = originalHammerGlobal;\n       });\n \n+      it('should call the loader provider only once', () => {\n+        plugin.addEventListener(someElement, 'swipe', () => {});\n+        plugin.addEventListener(someElement, 'panleft', () => {});\n+        plugin.addEventListener(someElement, 'panright', () => {});\n+        // Ensure that the loader is called only once, because previouly\n+        // it was called the same number of times as `addEventListener` was called.\n+        expect(loaderCalled).toEqual(1);\n+      });\n+\n       it('should not log a warning when HammerJS is not loaded', () => {\n         plugin.addEventListener(someElement, 'swipe', () => {});\n         expect(fakeConsole.warn).not.toHaveBeenCalled();"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 37,
        "deletions": 13
    }
}