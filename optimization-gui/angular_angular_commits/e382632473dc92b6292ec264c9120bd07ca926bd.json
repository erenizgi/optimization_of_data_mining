{
    "author": "devversion",
    "message": "build: fix symbol extractor not dealing with ES2015 classes (#38093)\n\nWe recently reworked our `ng_rollup_bundle` rule to no longer output\nESM5 and to optimize applications properly (previously applications were\nnot optimized properly due to incorrect build optimizer setup).\n\nThis change meant that a lot of symbols have been removed from the\ngolden correctly. See: fd65958b887f6ea8dd5235e6de1d533e4c578602\n\nUnfortunately though, a few symbols have been accidentally removed\nbecause they are now part of the bundle as ES2015 classes which the\nsymbol extractor does not pick up. This commit fixes the symbol\nextractor to capture ES2015 classes. We also update the golden to\nreflect this change.\n\nPR Close #38093",
    "sha": "e382632473dc92b6292ec264c9120bd07ca926bd",
    "files": [
        {
            "sha": "c2ba0e34b1824c8c023bd9a3f0b2944880f19541",
            "filename": "packages/core/test/bundling/cyclic_import/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/e382632473dc92b6292ec264c9120bd07ca926bd/packages%2Fcore%2Ftest%2Fbundling%2Fcyclic_import%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/e382632473dc92b6292ec264c9120bd07ca926bd/packages%2Fcore%2Ftest%2Fbundling%2Fcyclic_import%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fcyclic_import%2Fbundle.golden_symbols.json?ref=e382632473dc92b6292ec264c9120bd07ca926bd",
            "patch": "@@ -35,6 +35,12 @@\n   {\n     \"name\": \"NO_CHANGE\"\n   },\n+  {\n+    \"name\": \"NodeInjectorFactory\"\n+  },\n+  {\n+    \"name\": \"SimpleChange\"\n+  },\n   {\n     \"name\": \"TriggerComponent\"\n   },"
        },
        {
            "sha": "0777fe91e6eb4102cd49daa08ebeb7bdc855bcb7",
            "filename": "packages/core/test/bundling/hello_world/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/e382632473dc92b6292ec264c9120bd07ca926bd/packages%2Fcore%2Ftest%2Fbundling%2Fhello_world%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/e382632473dc92b6292ec264c9120bd07ca926bd/packages%2Fcore%2Ftest%2Fbundling%2Fhello_world%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fhello_world%2Fbundle.golden_symbols.json?ref=e382632473dc92b6292ec264c9120bd07ca926bd",
            "patch": "@@ -29,6 +29,12 @@\n   {\n     \"name\": \"NO_CHANGE\"\n   },\n+  {\n+    \"name\": \"NodeInjectorFactory\"\n+  },\n+  {\n+    \"name\": \"SimpleChange\"\n+  },\n   {\n     \"name\": \"ViewEncapsulation\"\n   },"
        },
        {
            "sha": "4dd6420bd205f1b8c97ab44e1ba6eeea413ca4e9",
            "filename": "packages/core/test/bundling/injection/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/e382632473dc92b6292ec264c9120bd07ca926bd/packages%2Fcore%2Ftest%2Fbundling%2Finjection%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/e382632473dc92b6292ec264c9120bd07ca926bd/packages%2Fcore%2Ftest%2Fbundling%2Finjection%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Finjection%2Fbundle.golden_symbols.json?ref=e382632473dc92b6292ec264c9120bd07ca926bd",
            "patch": "@@ -17,6 +17,9 @@\n   {\n     \"name\": \"InjectFlags\"\n   },\n+  {\n+    \"name\": \"InjectionToken\"\n+  },\n   {\n     \"name\": \"NEW_LINE\"\n   },\n@@ -44,9 +47,15 @@\n   {\n     \"name\": \"NULL_INJECTOR\"\n   },\n+  {\n+    \"name\": \"NullInjector\"\n+  },\n   {\n     \"name\": \"Optional\"\n   },\n+  {\n+    \"name\": \"R3Injector\"\n+  },\n   {\n     \"name\": \"ScopedService\"\n   },"
        },
        {
            "sha": "621068548e7cfb2731448c8bd58dc354982bb82a",
            "filename": "packages/core/test/bundling/todo/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/e382632473dc92b6292ec264c9120bd07ca926bd/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/e382632473dc92b6292ec264c9120bd07ca926bd/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json?ref=e382632473dc92b6292ec264c9120bd07ca926bd",
            "patch": "@@ -5,6 +5,12 @@\n   {\n     \"name\": \"ChangeDetectionStrategy\"\n   },\n+  {\n+    \"name\": \"DefaultIterableDiffer\"\n+  },\n+  {\n+    \"name\": \"DefaultIterableDifferFactory\"\n+  },\n   {\n     \"name\": \"EMPTY_ARRAY\"\n   },\n@@ -17,9 +23,15 @@\n   {\n     \"name\": \"ElementRef\"\n   },\n+  {\n+    \"name\": \"ErrorHandler\"\n+  },\n   {\n     \"name\": \"InjectFlags\"\n   },\n+  {\n+    \"name\": \"IterableChangeRecord_\"\n+  },\n   {\n     \"name\": \"IterableDiffers\"\n   },\n@@ -53,12 +65,30 @@\n   {\n     \"name\": \"NgForOf\"\n   },\n+  {\n+    \"name\": \"NgForOfContext\"\n+  },\n   {\n     \"name\": \"NgIf\"\n   },\n+  {\n+    \"name\": \"NgIfContext\"\n+  },\n+  {\n+    \"name\": \"NgModuleRef\"\n+  },\n+  {\n+    \"name\": \"NodeInjector\"\n+  },\n+  {\n+    \"name\": \"NodeInjectorFactory\"\n+  },\n   {\n     \"name\": \"Optional\"\n   },\n+  {\n+    \"name\": \"RecordViewTuple\"\n+  },\n   {\n     \"name\": \"SWITCH_ELEMENT_REF_FACTORY\"\n   },\n@@ -68,6 +98,9 @@\n   {\n     \"name\": \"SWITCH_VIEW_CONTAINER_REF_FACTORY\"\n   },\n+  {\n+    \"name\": \"SimpleChange\"\n+  },\n   {\n     \"name\": \"SkipSelf\"\n   },\n@@ -92,6 +125,9 @@\n   {\n     \"name\": \"ToDoAppComponent_section_5_li_3_input_6_Template\"\n   },\n+  {\n+    \"name\": \"Todo\"\n+  },\n   {\n     \"name\": \"TodoStore\"\n   },\n@@ -101,9 +137,18 @@\n   {\n     \"name\": \"ViewEncapsulation\"\n   },\n+  {\n+    \"name\": \"ViewRef\"\n+  },\n   {\n     \"name\": \"_CLEAN_PROMISE\"\n   },\n+  {\n+    \"name\": \"_DuplicateItemRecordList\"\n+  },\n+  {\n+    \"name\": \"_DuplicateMap\"\n+  },\n   {\n     \"name\": \"__forward_ref__\"\n   },"
        },
        {
            "sha": "057c7cc6c04845ba5b8b2100724a526deb92a7dd",
            "filename": "tools/symbol-extractor/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2FBUILD.bazel?ref=e382632473dc92b6292ec264c9120bd07ca926bd",
            "patch": "@@ -37,5 +37,7 @@ jasmine_node_test(\n     data = glob([\"symbol_extractor_spec/**\"]),\n     deps = [\n         \":test_lib\",\n+        \"//tools/symbol-extractor/symbol_extractor_spec:es2015_class_output\",\n+        \"//tools/symbol-extractor/symbol_extractor_spec:fixtures\",\n     ],\n )"
        },
        {
            "sha": "0c781bbde8fcf054ac51be0efbf50b1720cf1137",
            "filename": "tools/symbol-extractor/symbol_extractor.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2Fsymbol_extractor.ts",
            "raw_url": "https://github.com/angular/angular/raw/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2Fsymbol_extractor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor.ts?ref=e382632473dc92b6292ec264c9120bd07ca926bd",
            "patch": "@@ -58,6 +58,10 @@ export class SymbolExtractor {\n           const funcDecl = child as ts.FunctionDeclaration;\n           funcDecl.name && symbols.push({name: stripSuffix(funcDecl.name.getText())});\n           break;\n+        case ts.SyntaxKind.ClassDeclaration:\n+          const classDecl = child as ts.ClassDeclaration;\n+          classDecl.name && symbols.push({name: stripSuffix(classDecl.name.getText())});\n+          break;\n         default:\n           // Left for easier debugging.\n           // console.log('###', ts.SyntaxKind[child.kind], child.getText());"
        },
        {
            "sha": "b8fe910149a72212d9b9dd7bc2519d5dd910c03c",
            "filename": "tools/symbol-extractor/symbol_extractor_spec.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 11,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec.ts?ref=e382632473dc92b6292ec264c9120bd07ca926bd",
            "patch": "@@ -8,31 +8,51 @@\n \n import * as fs from 'fs';\n import * as path from 'path';\n-import * as ts from 'typescript';\n \n-import {Symbol, SymbolExtractor} from './symbol_extractor';\n+import {SymbolExtractor} from './symbol_extractor';\n \n describe('scenarios', () => {\n   const symbolExtractorSpecDir = path.dirname(\n       require.resolve('angular/tools/symbol-extractor/symbol_extractor_spec/empty.json'));\n   const scenarioFiles = fs.readdirSync(symbolExtractorSpecDir);\n-  for (let i = 0; i < scenarioFiles.length; i = i + 2) {\n-    let jsFile = scenarioFiles[i];\n-    let jsonFile = scenarioFiles[i + 1];\n-    let testName = jsFile.substring(0, jsFile.lastIndexOf('.'));\n-    if (!jsFile.endsWith('.js')) throw new Error('Expected: .js file found: ' + jsFile);\n-    if (!jsonFile.endsWith('.json')) throw new Error('Expected: .json file found: ' + jsonFile);\n+  for (let i = 0; i < scenarioFiles.length; i++) {\n+    const filePath = scenarioFiles[i];\n+    // We only consider files as tests if they have a `.js` extension, but do\n+    // not resolve to a tsickle externs file (which is a leftover from TS targets).\n+    if (!filePath.endsWith('.js') || filePath.endsWith('.externs.js')) {\n+      continue;\n+    }\n+    const testName = filePath.substring(0, filePath.lastIndexOf('.'));\n+    const goldenFilePath = path.join(symbolExtractorSpecDir, `${testName}.json`);\n+\n+    if (!fs.existsSync(goldenFilePath)) {\n+      throw new Error(`No golden file found for test: ${filePath}`);\n+    }\n \n     // Left here so that it is easy to debug single test.\n     // if (testName !== 'hello_world_min_debug') continue;\n \n     it(testName, () => {\n-      const jsFileContent = fs.readFileSync(path.join(symbolExtractorSpecDir, jsFile)).toString();\n-      const jsonFileContent =\n-          fs.readFileSync(path.join(symbolExtractorSpecDir, jsonFile)).toString();\n+      const jsFileContent = fs.readFileSync(path.join(symbolExtractorSpecDir, filePath)).toString();\n+      const jsonFileContent = fs.readFileSync(goldenFilePath).toString();\n       const symbols = SymbolExtractor.parse(testName, jsFileContent);\n       const diff = SymbolExtractor.diff(symbols, jsonFileContent);\n       expect(diff).toEqual({});\n     });\n   }\n+\n+  // Tests not existing in source root. We cannot glob for generated test fixtures as\n+  // tests do not run in a sandbox on Windows.\n+\n+  it('should properly capture classes in TypeScript ES2015 class output', () => {\n+    const jsFileContent = fs.readFileSync(\n+        require.resolve(\n+            'angular/tools/symbol-extractor/symbol_extractor_spec/es2015_class_output.mjs'),\n+        'utf8');\n+    const jsonFileContent =\n+        fs.readFileSync(path.join(symbolExtractorSpecDir, 'es2015_class_output.json')).toString();\n+    const symbols = SymbolExtractor.parse('es2015_class_output', jsFileContent);\n+    const diff = SymbolExtractor.diff(symbols, jsonFileContent);\n+    expect(diff).toEqual({});\n+  });\n });"
        },
        {
            "sha": "220b271b77283a569aedce8dceb0c8fbdc08a4c9",
            "filename": "tools/symbol-extractor/symbol_extractor_spec/BUILD.bazel",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2FBUILD.bazel?ref=e382632473dc92b6292ec264c9120bd07ca926bd",
            "patch": "@@ -0,0 +1,22 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+ts_library(\n+    name = \"es2015_class_output_lib\",\n+    srcs = [\"es2015_class_output.ts\"],\n+)\n+\n+filegroup(\n+    name = \"es2015_class_output\",\n+    srcs = [\":es2015_class_output_lib\"],\n+    output_group = \"es6_sources\",\n+)\n+\n+filegroup(\n+    name = \"fixtures\",\n+    srcs = glob([\n+        \"**/*.js\",\n+        \"**/*.json\",\n+    ]),\n+)"
        },
        {
            "sha": "c4e8c4de75008e9895476677da6bc5c2045d4795",
            "filename": "tools/symbol-extractor/symbol_extractor_spec/es2015_class_output.json",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fes2015_class_output.json",
            "raw_url": "https://github.com/angular/angular/raw/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fes2015_class_output.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fes2015_class_output.json?ref=e382632473dc92b6292ec264c9120bd07ca926bd",
            "patch": "@@ -0,0 +1,4 @@\n+[\n+  \"HelloWorld\",\n+  \"WithStaticMembers\"\n+]"
        },
        {
            "sha": "787624f259d7523296a866ad7b470b4386b06a2f",
            "filename": "tools/symbol-extractor/symbol_extractor_spec/es2015_class_output.ts",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fes2015_class_output.ts",
            "raw_url": "https://github.com/angular/angular/raw/e382632473dc92b6292ec264c9120bd07ca926bd/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fes2015_class_output.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fes2015_class_output.ts?ref=e382632473dc92b6292ec264c9120bd07ca926bd",
            "patch": "@@ -0,0 +1,19 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+class HelloWorld {\n+  greet() {\n+    console.info('Hello!');\n+  }\n+}\n+\n+// TypeScript generates different output for classes with\n+// static members.\n+class WithStaticMembers extends HelloWorld {\n+  static message = 'literal value';\n+}"
        }
    ],
    "stats": {
        "total": 159,
        "additions": 148,
        "deletions": 11
    }
}