{
    "author": "atscott",
    "message": "refactor(language-service): convert references_spec to new testing package (#40966)\n\nrefactor(language-service): convert references_spec to new testing package\n\nPR Close #40966",
    "sha": "dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf",
    "files": [
        {
            "sha": "964297d3d750d0602374810e51d7ef612093df17",
            "filename": "packages/language-service/ivy/references.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "raw_url": "https://github.com/angular/angular/raw/dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences.ts?ref=dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf",
            "patch": "@@ -392,6 +392,11 @@ export class ReferencesAndRenameBuilder {\n       ...shimDocumentSpan,\n       fileName: templateUrl,\n       textSpan: toTextSpan(span),\n+      // Specifically clear other text span values because we do not have enough knowledge to\n+      // convert these to spans in the template.\n+      contextSpan: undefined,\n+      originalContextSpan: undefined,\n+      originalTextSpan: undefined,\n     };\n   }\n }"
        },
        {
            "sha": "70295cac8042f5d4768d4d8765a199a6a2d15a89",
            "filename": "packages/language-service/ivy/test/references_spec.ts",
            "status": "modified",
            "additions": 495,
            "deletions": 435,
            "changes": 930,
            "blob_url": "https://github.com/angular/angular/blob/dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts?ref=dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf",
            "patch": "@@ -6,14 +6,12 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom, absoluteFrom as _} from '@angular/compiler-cli/src/ngtsc/file_system';\n-import {initMockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n \n-import {extractCursorInfo, LanguageServiceTestEnvironment} from './env';\n-import {assertFileNames, assertTextSpans, createModuleWithDeclarations, humanizeDocumentSpanLike} from './test_utils';\n+import {assertFileNames, assertTextSpans, createModuleAndProjectWithDeclarations, humanizeDocumentSpanLike, LanguageServiceTestEnv, OpenBuffer} from '../testing';\n \n describe('find references and rename locations', () => {\n-  let env: LanguageServiceTestEnvironment;\n+  let env: LanguageServiceTestEnv;\n \n   beforeEach(() => {\n     initMockFileSystem('Native');\n@@ -25,98 +23,103 @@ describe('find references and rename locations', () => {\n   });\n \n   describe('cursor is on binding in component class', () => {\n-    let cursor: number;\n+    let appFile: OpenBuffer;\n \n     beforeEach(() => {\n-      const cursorInfo = extractCursorInfo(`\n-          import {Component} from '@angular/core';\n+      const files = {\n+        'app.ts': `import {Component} from '@angular/core';\n \n           @Component({templateUrl: './app.html'})\n           export class AppCmp {\n-            myP¦rop!: string;\n-          }`);\n-      cursor = cursorInfo.cursor;\n-      const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-      const templateFile = {name: _('/app.html'), contents: '{{myProp}}'};\n-      env = createModuleWithDeclarations([appFile], [templateFile]);\n+            myProp!: string;\n+          }`,\n+        'app.html': '{{myProp}}'\n+      };\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      appFile = project.openFile('app.ts');\n+      appFile.moveCursorToText('myP¦rop');\n     });\n \n     it('gets component member references from TS file and external template', () => {\n-      const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+      const refs = getReferencesAtPosition(appFile)!;\n       expect(refs.length).toBe(2);\n       assertFileNames(refs, ['app.html', 'app.ts']);\n       assertTextSpans(refs, ['myProp']);\n     });\n \n     it('gets rename locations from TS file and external template', () => {\n-      const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+      const renameLocations = getRenameLocationsAtPosition(appFile)!;\n       expect(renameLocations.length).toBe(2);\n       assertFileNames(renameLocations, ['app.html', 'app.ts']);\n       assertTextSpans(renameLocations, ['myProp']);\n     });\n   });\n \n   describe('when cursor is on binding in an external template', () => {\n-    let cursor: number;\n+    let templateFile: OpenBuffer;\n \n     beforeEach(() => {\n-      const appFile = {\n-        name: _('/app.ts'),\n-        contents: `\n+      const files = {\n+        'app.ts': `\n           import {Component} from '@angular/core';\n \n           @Component({templateUrl: './app.html'})\n           export class AppCmp {\n             myProp = '';\n           }`,\n+        'app.html': '{{myProp}}'\n       };\n-      const cursorInfo = extractCursorInfo('{{myP¦rop}}');\n-      cursor = cursorInfo.cursor;\n-      const templateFile = {name: _('/app.html'), contents: cursorInfo.text};\n-      env = createModuleWithDeclarations([appFile], [templateFile]);\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      templateFile = project.openFile('app.html');\n+      templateFile.moveCursorToText('myP¦rop');\n     });\n \n     it('gets references', () => {\n-      const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n+      const refs = getReferencesAtPosition(templateFile)!;\n       expect(refs.length).toBe(2);\n       assertFileNames(refs, ['app.html', 'app.ts']);\n       assertTextSpans(refs, ['myProp']);\n     });\n \n     it('gets rename locations', () => {\n-      const renameLocations = getRenameLocationsAtPosition(_('/app.html'), cursor)!;\n+      const renameLocations = getRenameLocationsAtPosition(templateFile)!;\n       expect(renameLocations.length).toBe(2);\n       assertFileNames(renameLocations, ['app.html', 'app.ts']);\n       assertTextSpans(renameLocations, ['myProp']);\n     });\n   });\n \n   describe('when cursor is on function call in external template', () => {\n-    let cursor: number;\n+    let appFile: OpenBuffer;\n \n     beforeEach(() => {\n-      const cursorInfo = extractCursorInfo(`\n+      const files = {\n+        'app.ts': `\n           import {Component} from '@angular/core';\n \n-          @Component({template: '<div (click)=\"set¦Title(2)\"></div>'})\n+          @Component({template: '<div (click)=\"setTitle(2)\"></div>'})\n           export class AppCmp {\n             setTitle(s: number) {}\n-          }`);\n-      cursor = cursorInfo.cursor;\n-      const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-      env = createModuleWithDeclarations([appFile]);\n+          }`\n+      };\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      appFile = project.openFile('app.ts');\n+      appFile.moveCursorToText('setTi¦tle(2)');\n     });\n \n     it('gets component member reference in ts file', () => {\n-      const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+      const refs = getReferencesAtPosition(appFile)!;\n       expect(refs.length).toBe(2);\n \n       assertFileNames(refs, ['app.ts']);\n       assertTextSpans(refs, ['setTitle']);\n     });\n \n     it('gets rename location in ts file', () => {\n-      const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+      const renameLocations = getRenameLocationsAtPosition(appFile)!;\n       expect(renameLocations.length).toBe(2);\n \n       assertFileNames(renameLocations, ['app.ts']);\n@@ -125,96 +128,101 @@ describe('find references and rename locations', () => {\n   });\n \n   describe('when cursor in on argument to a function call in an external template', () => {\n-    let cursor: number;\n+    let appFile: OpenBuffer;\n \n     beforeEach(() => {\n-      const cursorInfo = extractCursorInfo(`\n+      const files = {\n+        'app.ts': `\n           import {Component} from '@angular/core';\n \n-          @Component({template: '<div (click)=\"setTitle(ti¦tle)\"></div>'})\n+          @Component({template: '<div (click)=\"setTitle(title)\"></div>'})\n           export class AppCmp {\n             title = '';\n             setTitle(s: string) {}\n-          }`);\n-      cursor = cursorInfo.cursor;\n-      const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-      env = createModuleWithDeclarations([appFile]);\n+          }`\n+      };\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      appFile = project.openFile('app.ts');\n+      appFile.moveCursorToText('(ti¦tle)');\n     });\n \n     it('gets member reference in ts file', () => {\n-      const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+      const refs = getReferencesAtPosition(appFile)!;\n       expect(refs.length).toBe(2);\n \n       assertTextSpans(refs, ['title']);\n     });\n \n     it('finds rename location in ts file', () => {\n-      const refs = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+      const refs = getRenameLocationsAtPosition(appFile)!;\n       expect(refs.length).toBe(2);\n \n       assertTextSpans(refs, ['title']);\n     });\n   });\n \n   describe('when cursor is on $event in method call arguments', () => {\n-    let cursor: number;\n+    let file: OpenBuffer;\n \n     beforeEach(() => {\n-      const cursorInfo = extractCursorInfo(`\n+      const files = {\n+        'app.ts': `\n           import {Component} from '@angular/core';\n-          @Component({template: '<div (click)=\"setTitle($even¦t)\"></div>'})\n+          @Component({template: '<div (click)=\"setTitle($event)\"></div>'})\n           export class AppCmp {\n             setTitle(s: any) {}\n-          }`);\n-      cursor = cursorInfo.cursor;\n-      const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-      env = createModuleWithDeclarations([appFile]);\n+          }`\n+      };\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      file = project.openFile('app.ts');\n+      file.moveCursorToText('($even¦t)');\n     });\n \n     it('find references', () => {\n-      const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+      const refs = getReferencesAtPosition(file)!;\n       expect(refs.length).toBe(1);\n \n       assertTextSpans(refs, ['$event']);\n     });\n \n     it('gets no rename locations', () => {\n-      const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+      const renameLocations = getRenameLocationsAtPosition(file)!;\n       expect(renameLocations).toBeUndefined();\n     });\n   });\n \n   describe('when cursor in on LHS of property write in external template', () => {\n-    let cursor: number;\n+    let file: OpenBuffer;\n \n     beforeEach(() => {\n-      const appFile = {\n-        name: _('/app.ts'),\n-        contents: `\n+      const files = {\n+        'app.ts': `\n           import {Component} from '@angular/core';\n \n           @Component({templateUrl: './app.html' })\n           export class AppCmp {\n             title = '';\n           }`,\n+        'app.html': `<div (click)=\"title = 'newtitle'\"></div>`\n       };\n-      const templateFileWithCursor = `<div (click)=\"ti¦tle = 'newtitle'\"></div>`;\n-      const cursorInfo = extractCursorInfo(templateFileWithCursor);\n-      cursor = cursorInfo.cursor;\n-      const templateFile = {name: _('/app.html'), contents: cursorInfo.text};\n-      env = createModuleWithDeclarations([appFile], [templateFile]);\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      file = project.openFile('app.html');\n+      file.moveCursorToText('ti¦tle = ');\n     });\n \n     it('gets member reference in ts file', () => {\n-      const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n+      const refs = getReferencesAtPosition(file)!;\n       expect(refs.length).toBe(2);\n \n       assertFileNames(refs, ['app.ts', 'app.html']);\n       assertTextSpans(refs, ['title']);\n     });\n \n     it('gets rename location in ts file', () => {\n-      const renameLocations = getRenameLocationsAtPosition(_('/app.html'), cursor)!;\n+      const renameLocations = getRenameLocationsAtPosition(file)!;\n       expect(renameLocations.length).toBe(2);\n \n       assertFileNames(renameLocations, ['app.ts', 'app.html']);\n@@ -223,35 +231,36 @@ describe('find references and rename locations', () => {\n   });\n \n   describe('when cursor in on RHS of property write in external template', () => {\n-    let cursor: number;\n+    let file: OpenBuffer;\n \n     beforeEach(() => {\n-      const cursorInfo = extractCursorInfo(`\n+      const files = {\n+        'app.ts': ` \n           import {Component} from '@angular/core';\n \n-          @Component({template: '<div (click)=\"title = otherT¦itle\"></div>' })\n+          @Component({template: '<div (click)=\"title = otherTitle\"></div>' })\n           export class AppCmp {\n             title = '';\n             otherTitle = '';\n-          }`);\n-      cursor = cursorInfo.cursor;\n-      const appFile = {\n-        name: _('/app.ts'),\n-        contents: cursorInfo.text,\n+          }`\n       };\n-      env = createModuleWithDeclarations([appFile]);\n+\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      file = project.openFile('app.ts');\n+      file.moveCursorToText('= otherT¦itle\">');\n     });\n \n     it('get reference to member in ts file', () => {\n-      const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+      const refs = getReferencesAtPosition(file)!;\n       expect(refs.length).toBe(2);\n \n       assertFileNames(refs, ['app.ts']);\n       assertTextSpans(refs, ['otherTitle']);\n     });\n \n     it('finds rename location in ts file', () => {\n-      const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+      const renameLocations = getRenameLocationsAtPosition(file)!;\n       expect(renameLocations.length).toBe(2);\n \n       assertFileNames(renameLocations, ['app.ts']);\n@@ -260,26 +269,26 @@ describe('find references and rename locations', () => {\n   });\n \n   describe('when cursor in on a keyed read', () => {\n-    let cursor: number;\n+    let file: OpenBuffer;\n \n     beforeEach(() => {\n-      const cursorInfo = extractCursorInfo(`\n+      const files = {\n+        'app.ts': `\n           import {Component} from '@angular/core';\n \n-          @Component({template: '{{hero[\"na¦me\"]}}' })\n+          @Component({template: '{{hero[\"name\"]}}' })\n           export class AppCmp {\n             hero: {name: string} = {name: 'Superman'};\n-          }`);\n-      cursor = cursorInfo.cursor;\n-      const appFile = {\n-        name: _('/app.ts'),\n-        contents: cursorInfo.text,\n+          }`\n       };\n-      env = createModuleWithDeclarations([appFile]);\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      file = project.openFile('app.ts');\n+      file.moveCursorToText('{{hero[\"na¦me\"]}}');\n     });\n \n     it('gets reference to member type definition and initialization in component class', () => {\n-      const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+      const refs = getReferencesAtPosition(file)!;\n       // 3 references: the type definition, the value assignment, and the read in the template\n       expect(refs.length).toBe(3);\n \n@@ -293,7 +302,7 @@ describe('find references and rename locations', () => {\n     });\n \n     it('gets rename locations in component class', () => {\n-      const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+      const renameLocations = getRenameLocationsAtPosition(file)!;\n       expect(renameLocations).toBeUndefined();\n \n       // TODO(atscott): We should handle this case. The fix requires us to fix the result span as\n@@ -307,37 +316,36 @@ describe('find references and rename locations', () => {\n   });\n \n   describe('when cursor in on RHS of keyed write in a template', () => {\n-    let cursor: number;\n+    let file: OpenBuffer;\n \n     beforeEach(() => {\n-      const appFile = {\n-        name: _('/app.ts'),\n-        contents: `\n+      const files = {\n+        'app.ts': `\n           import {Component} from '@angular/core';\n \n           @Component({templateUrl: './app.html' })\n           export class AppCmp {\n             hero: {name: string} = {name: 'Superman'};\n             batman = 'batman';\n           }`,\n+        'app.html': `<div (click)=\"hero['name'] = batman\"></div>`\n       };\n-      const templateFileWithCursor = `<div (click)=\"hero['name'] = bat¦man\"></div>`;\n-      const cursorInfo = extractCursorInfo(templateFileWithCursor);\n-      cursor = cursorInfo.cursor;\n-      const templateFile = {name: _('/app.html'), contents: cursorInfo.text};\n-      env = createModuleWithDeclarations([appFile], [templateFile]);\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      file = project.openFile('app.html');\n+      file.moveCursorToText('bat¦man');\n     });\n \n     it('get references in ts file', () => {\n-      const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n+      const refs = getReferencesAtPosition(file)!;\n       expect(refs.length).toBe(2);\n \n       assertFileNames(refs, ['app.ts', 'app.html']);\n       assertTextSpans(refs, ['batman']);\n     });\n \n     it('finds rename location in ts file', () => {\n-      const renameLocations = getRenameLocationsAtPosition(_('/app.html'), cursor)!;\n+      const renameLocations = getRenameLocationsAtPosition(file)!;\n       expect(renameLocations.length).toBe(2);\n \n       assertFileNames(renameLocations, ['app.ts', 'app.html']);\n@@ -346,23 +354,26 @@ describe('find references and rename locations', () => {\n   });\n \n   describe('when cursor in on an element reference', () => {\n-    let cursor: number;\n+    let file: OpenBuffer;\n \n     beforeEach(() => {\n-      const cursorInfo = extractCursorInfo(`\n+      const files = {\n+        'app.ts': `\n           import {Component} from '@angular/core';\n \n-          @Component({template: '<input #myInput /> {{ myIn¦put.value }}'})\n+          @Component({template: '<input #myInput /> {{ myInput.value }}'})\n           export class AppCmp {\n             title = '';\n-          }`);\n-      cursor = cursorInfo.cursor;\n-      const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-      env = createModuleWithDeclarations([appFile]);\n+          }`\n+      };\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      file = project.openFile('app.ts');\n+      file.moveCursorToText('myInp¦ut.value');\n     });\n \n     it('get reference to declaration in template', () => {\n-      const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+      const refs = getReferencesAtPosition(file)!;\n \n       expect(refs.length).toBe(2);\n       assertTextSpans(refs, ['myInput']);\n@@ -373,38 +384,37 @@ describe('find references and rename locations', () => {\n     });\n \n     it('finds rename location in template', () => {\n-      const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+      const renameLocations = getRenameLocationsAtPosition(file)!;\n \n       expect(renameLocations.length).toBe(2);\n       assertTextSpans(renameLocations, ['myInput']);\n     });\n   });\n \n   describe('when cursor in on a template reference', () => {\n-    let cursor: number;\n+    let file: OpenBuffer;\n \n     beforeEach(() => {\n-      const templateWithCursor = `\n-              <ng-template #myTemplate >bla</ng-template>\n-              <ng-container [ngTemplateOutlet]=\"myTem¦plate\"></ng-container>`;\n-      const appFile = {\n-        name: _('/app.ts'),\n-        contents: `\n+      const files = {\n+        'app.ts': `\n           import {Component} from '@angular/core';\n \n           @Component({templateUrl: './app.html'})\n           export class AppCmp {\n             title = '';\n           }`,\n+        'app.html': `\n+              <ng-template #myTemplate >bla</ng-template>\n+              <ng-container [ngTemplateOutlet]=\"myTemplate\"></ng-container>`\n       };\n-      const cursorInfo = extractCursorInfo(templateWithCursor);\n-      cursor = cursorInfo.cursor;\n-      const templateFile = {name: _('/app.html'), contents: cursorInfo.text};\n-      env = createModuleWithDeclarations([appFile], [templateFile]);\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+      file = project.openFile('app.html');\n+      file.moveCursorToText('#myTem¦plate');\n     });\n \n     it('gets reference to declaration', () => {\n-      const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n+      const refs = getReferencesAtPosition(file)!;\n       expect(refs.length).toBe(2);\n       assertTextSpans(refs, ['myTemplate']);\n       assertFileNames(refs, ['app.html']);\n@@ -415,7 +425,7 @@ describe('find references and rename locations', () => {\n     });\n \n     it('finds rename location in template', () => {\n-      const renameLocations = getRenameLocationsAtPosition(_('/app.html'), cursor)!;\n+      const renameLocations = getRenameLocationsAtPosition(file)!;\n       expect(renameLocations.length).toBe(2);\n       assertTextSpans(renameLocations, ['myTemplate']);\n       assertFileNames(renameLocations, ['app.html']);\n@@ -424,123 +434,132 @@ describe('find references and rename locations', () => {\n \n   describe('template references', () => {\n     describe('directives', () => {\n-      let appFile: TestFile;\n-      let dirFile: TestFile;\n-\n-      beforeEach(() => {\n-        const dirFileContents = `\n+      const dirFileContents = `\n             import {Directive} from '@angular/core';\n \n             @Directive({selector: '[dir]', exportAs: 'myDir'})\n             export class Dir {\n               dirValue!: string;\n               doSomething() {}\n             }`;\n-        const appFileContents = `\n+      const appFileContents = `\n             import {Component} from '@angular/core';\n \n             @Component({templateUrl: './app.html'})\n             export class AppCmp {}`;\n-        appFile = {name: _('/app.ts'), contents: appFileContents};\n-        dirFile = {name: _('/dir.ts'), contents: dirFileContents};\n-      });\n \n       describe('when cursor is on usage of template reference', () => {\n-        let cursor: number;\n+        let file: OpenBuffer;\n         beforeEach(() => {\n-          const templateWithCursor = '<div [dir] #dirRef=\"myDir\"></div> {{ dirR¦ef }}';\n-          const cursorInfo = extractCursorInfo(templateWithCursor);\n-          cursor = cursorInfo.cursor;\n-          const templateFile = {name: _('/app.html'), contents: cursorInfo.text};\n-          env = createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n+          const files = {\n+            'app.ts': appFileContents,\n+            'dir.ts': dirFileContents,\n+            'app.html': '<div [dir] #dirRef=\"myDir\"></div> {{ dirRef }}'\n+          };\n+          env = LanguageServiceTestEnv.setup();\n+          const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+          file = project.openFile('app.html');\n+          file.moveCursorToText('#dirR¦ef');\n         });\n \n         it('should get references', () => {\n-          const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n+          const refs = getReferencesAtPosition(file)!;\n           expect(refs.length).toBe(2);\n           assertFileNames(refs, ['app.html']);\n           assertTextSpans(refs, ['dirRef']);\n         });\n \n         it('should find rename locations', () => {\n-          const renameLocations = getRenameLocationsAtPosition(_('/app.html'), cursor)!;\n+          const renameLocations = getRenameLocationsAtPosition(file)!;\n           expect(renameLocations.length).toBe(2);\n           assertFileNames(renameLocations, ['app.html']);\n           assertTextSpans(renameLocations, ['dirRef']);\n         });\n       });\n \n       describe('when cursor is on a property read of directive reference', () => {\n-        let cursor: number;\n+        let file: OpenBuffer;\n         beforeEach(() => {\n-          const fileWithCursor = '<div [dir] #dirRef=\"myDir\"></div> {{ dirRef.dirV¦alue }}';\n-          const cursorInfo = extractCursorInfo(fileWithCursor);\n-          cursor = cursorInfo.cursor;\n-          const templateFile = {name: _('/app.html'), contents: cursorInfo.text};\n-          env = createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n+          const files = {\n+            'app.ts': appFileContents,\n+            'dir.ts': dirFileContents,\n+            'app.html': '<div [dir] #dirRef=\"myDir\"></div> {{ dirRef.dirValue }}'\n+          };\n+          env = LanguageServiceTestEnv.setup();\n+          const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+          file = project.openFile('app.html');\n+          file.moveCursorToText('dirRef.dirV¦alue');\n         });\n \n         it('should get references', () => {\n-          const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n+          const refs = getReferencesAtPosition(file)!;\n           expect(refs.length).toBe(2);\n           assertFileNames(refs, ['dir.ts', 'app.html']);\n           assertTextSpans(refs, ['dirValue']);\n         });\n \n         it('should find rename locations', () => {\n-          const renameLocations = getRenameLocationsAtPosition(_('/app.html'), cursor)!;\n+          const renameLocations = getRenameLocationsAtPosition(file)!;\n           expect(renameLocations.length).toBe(2);\n           assertFileNames(renameLocations, ['dir.ts', 'app.html']);\n           assertTextSpans(renameLocations, ['dirValue']);\n         });\n       });\n \n       describe('when cursor is on a safe prop read', () => {\n-        let cursor: number;\n+        let file: OpenBuffer;\n         beforeEach(() => {\n-          const fileWithCursor = '<div [dir] #dirRef=\"myDir\"></div> {{ dirRef?.dirV¦alue }}';\n-          const cursorInfo = extractCursorInfo(fileWithCursor);\n-          cursor = cursorInfo.cursor;\n-          const templateFile = {name: _('/app.html'), contents: cursorInfo.text};\n-          env = createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n+          const files = {\n+            'app.ts': appFileContents,\n+            'dir.ts': dirFileContents,\n+            'app.html': '<div [dir] #dirRef=\"myDir\"></div> {{ dirRef?.dirValue }}'\n+          };\n+          env = LanguageServiceTestEnv.setup();\n+          const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+          file = project.openFile('app.html');\n+          file.moveCursorToText('dirRef?.dirV¦alue');\n         });\n \n \n         it('should get references', () => {\n-          const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n+          const refs = getReferencesAtPosition(file)!;\n           expect(refs.length).toBe(2);\n           assertFileNames(refs, ['dir.ts', 'app.html']);\n           assertTextSpans(refs, ['dirValue']);\n         });\n \n         it('should find rename locations', () => {\n-          const renameLocations = getRenameLocationsAtPosition(_('/app.html'), cursor)!;\n+          const renameLocations = getRenameLocationsAtPosition(file)!;\n           expect(renameLocations.length).toBe(2);\n           assertFileNames(renameLocations, ['dir.ts', 'app.html']);\n           assertTextSpans(renameLocations, ['dirValue']);\n         });\n       });\n \n       describe('when cursor is on safe method call', () => {\n-        let cursor: number;\n+        let file: OpenBuffer;\n         beforeEach(() => {\n-          const fileWithCursor = '<div [dir] #dirRef=\"myDir\"></div> {{ dirRef?.doSometh¦ing() }}';\n-          const cursorInfo = extractCursorInfo(fileWithCursor);\n-          cursor = cursorInfo.cursor;\n-          const templateFile = {name: _('/app.html'), contents: cursorInfo.text};\n-          env = createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n+          const files = {\n+            'app.ts': appFileContents,\n+            'dir.ts': dirFileContents,\n+            'app.html': '<div [dir] #dirRef=\"myDir\"></div> {{ dirRef?.doSomething() }}'\n+          };\n+          env = LanguageServiceTestEnv.setup();\n+          const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+          file = project.openFile('app.html');\n+          file.moveCursorToText('dirRef?.doSometh¦ing()');\n         });\n \n \n         it('should get references', () => {\n-          const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n+          const refs = getReferencesAtPosition(file)!;\n           expect(refs.length).toBe(2);\n           assertFileNames(refs, ['dir.ts', 'app.html']);\n           assertTextSpans(refs, ['doSomething']);\n         });\n \n         it('should find rename locations', () => {\n-          const renameLocations = getRenameLocationsAtPosition(_('/app.html'), cursor)!;\n+          const renameLocations = getRenameLocationsAtPosition(file)!;\n           expect(renameLocations.length).toBe(2);\n           assertFileNames(renameLocations, ['dir.ts', 'app.html']);\n           assertTextSpans(renameLocations, ['doSomething']);\n@@ -551,89 +570,92 @@ describe('find references and rename locations', () => {\n \n   describe('template variables', () => {\n     describe('when cursor is on variable which was initialized implicitly', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const cursorInfo = extractCursorInfo(`\n-          <div *ngFor=\"let hero of heroes\">\n-            <span *ngIf=\"hero\">\n-              {{her¦o}}\n-            </span>\n-          </div>\n-          `);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {\n-          name: _('/app.ts'),\n-          contents: `\n+        const files = {\n+          'app.ts': `\n           import {Component} from '@angular/core';\n \n           @Component({templateUrl: './template.ng.html'})\n           export class AppCmp {\n             heroes: string[] = [];\n-          }`\n+          }`,\n+          'template.ng.html': `\n+          <div *ngFor=\"let hero of heroes\">\n+            <span *ngIf=\"hero\">\n+              {{hero}}\n+            </span>\n+          </div>\n+          `\n         };\n-        const templateFile = {name: _('/template.ng.html'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile], [templateFile]);\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('template.ng.html');\n+        file.moveCursorToText('{{her¦o}}');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/template.ng.html'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toBe(3);\n         assertFileNames(refs, ['template.ng.html']);\n         assertTextSpans(refs, ['hero']);\n \n-        const originalRefs = env.ngLS.getReferencesAtPosition(_('/template.ng.html'), cursor)!;\n         // Get the declaration by finding the reference that appears first in the template\n-        originalRefs.sort((a, b) => a.textSpan.start - b.textSpan.start);\n-        expect(originalRefs[0].isDefinition).toBe(true);\n+        refs.sort((a, b) => a.textSpan.start - b.textSpan.start);\n+        expect(refs[0].isDefinition).toBe(true);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/template.ng.html'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toBe(3);\n         assertFileNames(renameLocations, ['template.ng.html']);\n         assertTextSpans(renameLocations, ['hero']);\n       });\n     });\n \n     describe('when cursor is on renamed variable', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const cursorInfo = extractCursorInfo(`\n+        const files = {\n+          'app.ts': ` \n           import {Component} from '@angular/core';\n \n-          @Component({template: '<div *ngFor=\"let hero of heroes; let iRef = index\">{{iR¦ef}}</div>'})\n+          @Component({template: '<div *ngFor=\"let hero of heroes; let iRef = index\">{{iRef}}</div>'})\n           export class AppCmp {\n             heroes: string[] = [];\n-          }`);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile]);\n+          }`\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('{{iR¦ef}}');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toBe(2);\n         assertFileNames(refs, ['app.ts']);\n         assertTextSpans(refs, ['iRef']);\n \n-        const originalRefs = env.ngLS.getReferencesAtPosition(_('/app.ts'), cursor)!;\n         // Get the declaration by finding the reference that appears first in the template\n-        originalRefs.sort((a, b) => a.textSpan.start - b.textSpan.start);\n-        expect(originalRefs[0].isDefinition).toBe(true);\n+        refs.sort((a, b) => a.textSpan.start - b.textSpan.start);\n+        expect(refs[0].isDefinition).toBe(true);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toBe(2);\n         assertFileNames(renameLocations, ['app.ts']);\n         assertTextSpans(renameLocations, ['iRef']);\n       });\n     });\n \n     describe('when cursor is on initializer of variable', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const dirFile = `\n+        const files = {\n+          'example-directive.ts': `\n         import {Directive, Input} from '@angular/core';\n \n         export class ExampleContext<T> {\n@@ -647,67 +669,71 @@ describe('find references and rename locations', () => {\n             ctx is ExampleContext<T> {\n             return true;\n           }\n-        }`;\n-        const fileWithCursor = `\n+        }`,\n+          'app.ts': `\n         import {Component, NgModule} from '@angular/core';\n         import {ExampleDirective} from './example-directive';\n \n-        @Component({template: '<div *example=\"state; let id = identif¦ier\">{{id}}</div>'})\n+        @Component({template: '<div *example=\"state; let id = identifier\">{{id}}</div>'})\n         export class AppCmp {\n           state = {};\n         }\n \n         @NgModule({declarations: [AppCmp, ExampleDirective]})\n-        export class AppModule {}`;\n-        const cursorInfo = extractCursorInfo(fileWithCursor);\n-        cursor = cursorInfo.cursor;\n-        env = LanguageServiceTestEnvironment.setup([\n-          {name: _('/app.ts'), contents: cursorInfo.text, isRoot: true},\n-          {name: _('/example-directive.ts'), contents: dirFile},\n-        ]);\n+        export class AppModule {}`\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = env.addProject('test', files);\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('identif¦ier');\n         env.expectNoSourceDiagnostics();\n-        env.expectNoTemplateDiagnostics(absoluteFrom('/app.ts'), 'AppCmp');\n+        project.expectNoTemplateDiagnostics('app.ts', 'AppCmp');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toBe(2);\n         assertFileNames(refs, ['app.ts', 'example-directive.ts']);\n         assertTextSpans(refs, ['identifier']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toBe(2);\n         assertFileNames(renameLocations, ['app.ts', 'example-directive.ts']);\n         assertTextSpans(renameLocations, ['identifier']);\n       });\n     });\n \n     describe('when cursor is on property read of variable', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const cursorInfo = extractCursorInfo(`\n+        const files = {\n+          'app.ts': `\n             import {Component} from '@angular/core';\n \n-            @Component({template: '<div *ngFor=\"let hero of heroes\">{{hero.na¦me}}</div>'})\n+            @Component({template: '<div *ngFor=\"let hero of heroes\">{{hero.name}}</div>'})\n             export class AppCmp {\n               heroes: Array<{name: string}> = [];\n-            }`);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile]);\n+            }`\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('hero.na¦me');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toBe(2);\n         assertFileNames(refs, ['app.ts']);\n         assertTextSpans(refs, ['name']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toBe(2);\n         assertFileNames(renameLocations, ['app.ts']);\n         assertTextSpans(renameLocations, ['name']);\n@@ -716,9 +742,7 @@ describe('find references and rename locations', () => {\n   });\n \n   describe('pipes', () => {\n-    let prefixPipeFile: TestFile;\n-    beforeEach(() => {\n-      const prefixPipe = `\n+    const prefixPipe = `\n         import {Pipe, PipeTransform} from '@angular/core';\n \n         @Pipe({ name: 'prefixPipe' })\n@@ -729,35 +753,37 @@ describe('find references and rename locations', () => {\n             return '';\n           }\n         }`;\n-      prefixPipeFile = {name: _('/prefix-pipe.ts'), contents: prefixPipe};\n-    });\n \n     describe('when cursor is on pipe name', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const appContentsWithCursor = `\n+        const files = {\n+          'app.ts': `\n         import {Component} from '@angular/core';\n \n-        @Component({template: '{{birthday | prefi¦xPipe: \"MM/dd/yy\"}}'})\n+        @Component({template: '{{birthday | prefixPipe: \"MM/dd/yy\"}}'})\n         export class AppCmp {\n           birthday = '';\n         }\n-      `;\n-        const cursorInfo = extractCursorInfo(appContentsWithCursor);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile, prefixPipeFile]);\n+      `,\n+          'prefix-pipe.ts': prefixPipe\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('prefi¦xPipe:');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toBe(5);\n         assertFileNames(refs, ['index.d.ts', 'prefix-pipe.ts', 'app.ts']);\n         assertTextSpans(refs, ['transform', 'prefixPipe']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations).toBeUndefined();\n \n         // TODO(atscott): Add support for renaming the pipe 'name'\n@@ -768,32 +794,36 @@ describe('find references and rename locations', () => {\n     });\n \n     describe('when cursor is on pipe argument', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const appContentsWithCursor = `\n+        const files = {\n+          'prefix-pipe.ts': prefixPipe,\n+          'app.ts': `\n         import {Component} from '@angular/core';\n \n-        @Component({template: '{{birthday | prefixPipe: pr¦efix}}'})\n+        @Component({template: '{{birthday | prefixPipe: prefix}}'})\n         export class AppCmp {\n           birthday = '';\n           prefix = '';\n         }\n-      `;\n-        const cursorInfo = extractCursorInfo(appContentsWithCursor);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile, prefixPipeFile]);\n+      `\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('prefixPipe: pr¦efix');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toBe(2);\n         assertFileNames(refs, ['app.ts']);\n         assertTextSpans(refs, ['prefix']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toBe(2);\n         assertFileNames(renameLocations, ['app.ts']);\n         assertTextSpans(renameLocations, ['prefix']);\n@@ -811,67 +841,72 @@ describe('find references and rename locations', () => {\n           @Input('alias') aliasedModel!: string;\n         }`;\n     describe('when cursor is on the input in the template', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const stringModelTestFile = {name: _('/string-model.ts'), contents: dirFileContents};\n-        const cursorInfo = extractCursorInfo(`\n+        const files = {\n+          'string-model.ts': dirFileContents,\n+          'app.ts': `\n         import {Component} from '@angular/core';\n \n-        @Component({template: '<div string-model [mod¦el]=\"title\"></div>'})\n+        @Component({template: '<div string-model [model]=\"title\"></div>'})\n         export class AppCmp {\n           title = 'title';\n-        }`);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile, stringModelTestFile]);\n+        }`\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('[mod¦el]');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toEqual(2);\n         assertFileNames(refs, ['string-model.ts', 'app.ts']);\n         assertTextSpans(refs, ['model']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toEqual(2);\n         assertFileNames(renameLocations, ['string-model.ts', 'app.ts']);\n         assertTextSpans(renameLocations, ['model']);\n       });\n     });\n \n     describe('when cursor is on an input that maps to multiple directives', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const otherDirFile = {\n-          name: _('/other-dir.ts'),\n-          contents: `\n+        const files = {\n+          'other-dir.ts': `\n         import {Directive, Input} from '@angular/core';\n \n         @Directive({selector: '[string-model]'})\n         export class OtherDir {\n           @Input('model') model!: any;\n         }\n-        `\n-        };\n-        const stringModelTestFile = {name: _('/string-model.ts'), contents: dirFileContents};\n-        const cursorInfo = extractCursorInfo(`\n+        `,\n+          'string-model.ts': dirFileContents,\n+          'app.ts': `\n         import {Component} from '@angular/core';\n \n-        @Component({template: '<div string-model [mod¦el]=\"title\"></div>'})\n+        @Component({template: '<div string-model [model]=\"title\"></div>'})\n         export class AppCmp {\n           title = 'title';\n-        }`);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile, stringModelTestFile, otherDirFile]);\n+        }`\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('[mod¦el]');\n       });\n \n       // TODO(atscott): This test does not pass because the template symbol builder only returns one\n       // binding.\n       xit('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toEqual(3);\n         assertFileNames(refs, ['string-model.ts', 'app.ts', 'other-dir']);\n         assertTextSpans(refs, ['model', 'otherDirAliasedInput']);\n@@ -881,7 +916,7 @@ describe('find references and rename locations', () => {\n       // The result is that rather than returning `undefined` because we don't handle alias inputs,\n       // we return the rename locations for the first binding.\n       xit('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations).toBeUndefined();\n         // TODO(atscott):\n         // expect(renameLocations.length).toEqual(3);\n@@ -891,81 +926,86 @@ describe('find references and rename locations', () => {\n     });\n \n     describe('should work when cursor is on text attribute input', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const stringModelTestFile = {name: _('/string-model.ts'), contents: dirFileContents};\n-        const cursorInfo = extractCursorInfo(`\n+        const files = {\n+          'string-model.ts': dirFileContents,\n+          'app.ts': `\n         import {Component} from '@angular/core';\n \n-        @Component({template: '<div string-model mod¦el=\"title\"></div>'})\n+        @Component({template: '<div string-model model=\"title\"></div>'})\n         export class AppCmp {\n           title = 'title';\n-        }`);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile, stringModelTestFile]);\n+        }`\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('mod¦el=\"title\"');\n       });\n \n       it('should work for text attributes', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toEqual(2);\n         assertFileNames(refs, ['string-model.ts', 'app.ts']);\n         assertTextSpans(refs, ['model']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toEqual(2);\n         assertFileNames(renameLocations, ['string-model.ts', 'app.ts']);\n         assertTextSpans(renameLocations, ['model']);\n       });\n     });\n \n     describe('when cursor is on the class member input', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const dirFileWithCursor = `\n+        const files = {\n+          'string-model.ts': `\n         import {Directive, Input} from '@angular/core';\n \n         @Directive({selector: '[string-model]'})\n         export class StringModel {\n-          @Input() mod¦el!: string;\n-        }`;\n-        const cursorInfo = extractCursorInfo(dirFileWithCursor);\n-        cursor = cursorInfo.cursor;\n-        const stringModelTestFile = {name: _('/string-model.ts'), contents: cursorInfo.text};\n-        const appFile = {\n-          name: _('/app.ts'),\n-          contents: `\n+          @Input() model!: string;\n+        }`,\n+          'app.ts': `\n         import {Component} from '@angular/core';\n \n         @Component({template: '<div string-model model=\"title\"></div>'})\n         export class AppCmp {\n           title = 'title';\n-        }`,\n+        }`\n         };\n-        env = createModuleWithDeclarations([appFile, stringModelTestFile]);\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('string-model.ts');\n+        file.moveCursorToText('@Input() mod¦el!');\n       });\n \n       it('should work from the TS input declaration', () => {\n-        const refs = getReferencesAtPosition(_('/string-model.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toEqual(2);\n         assertFileNames(refs, ['app.ts', 'string-model.ts']);\n         assertTextSpans(refs, ['model']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/string-model.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toEqual(2);\n         assertFileNames(renameLocations, ['app.ts', 'string-model.ts']);\n         assertTextSpans(renameLocations, ['model']);\n       });\n     });\n \n     describe('when cursor is on input referenced somewhere in the class functions', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const otherDirContents = `\n+        const files = {\n+          'other-dir.ts': `\n         import {Directive, Input} from '@angular/core';\n         import {StringModel} from './string-model';\n \n@@ -974,75 +1014,75 @@ describe('find references and rename locations', () => {\n           @Input() stringModelRef!: StringModel;\n \n           doSomething() {\n-            console.log(this.stringModelRef.mod¦el);\n+            console.log(this.stringModelRef.model);\n           }\n-        }`;\n-        const cursorInfo = extractCursorInfo(otherDirContents);\n-        cursor = cursorInfo.cursor;\n-        const otherDirFile = {name: _('/other-dir.ts'), contents: cursorInfo.text};\n-        const stringModelTestFile = {\n-          name: _('/string-model.ts'),\n-          contents: `\n+        }`,\n+          'string-model.ts': `\n         import {Directive, Input} from '@angular/core';\n \n         @Directive({selector: '[string-model]'})\n         export class StringModel {\n           @Input() model!: string;\n         }`,\n-        };\n-        const appFile = {\n-          name: _('/app.ts'),\n-          contents: `\n+          'app.ts': `\n         import {Component} from '@angular/core';\n \n         @Component({template: '<div string-model other-dir model=\"title\"></div>'})\n         export class AppCmp {\n           title = 'title';\n-        }`,\n+        }`\n         };\n-        env = createModuleWithDeclarations([appFile, stringModelTestFile, otherDirFile]);\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('other-dir.ts');\n+        file.moveCursorToText('this.stringModelRef.mod¦el');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/other-dir.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toEqual(3);\n         assertFileNames(refs, ['app.ts', 'string-model.ts', 'other-dir.ts']);\n         assertTextSpans(refs, ['model']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/other-dir.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toEqual(3);\n         assertFileNames(renameLocations, ['app.ts', 'string-model.ts', 'other-dir.ts']);\n         assertTextSpans(renameLocations, ['model']);\n       });\n     });\n \n     describe('when cursor is on an aliased input', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const stringModelTestFile = {name: _('/string-model.ts'), contents: dirFileContents};\n-        const cursorInfo = extractCursorInfo(`\n+        const files = {\n+          'string-model.ts': dirFileContents,\n+          'app.ts': `\n         import {Component} from '@angular/core';\n \n-        @Component({template: '<div string-model [al¦ias]=\"title\"></div>'})\n+        @Component({template: '<div string-model [alias]=\"title\"></div>'})\n         export class AppCmp {\n           title = 'title';\n-        }`);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile, stringModelTestFile]);\n+        }`\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('[al¦ias]');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toEqual(2);\n         assertFileNames(refs, ['string-model.ts', 'app.ts']);\n         assertTextSpans(refs, ['aliasedModel', 'alias']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations).toBeUndefined();\n         // TODO(atscott): add support for renaming alias outputs\n         // expect(renameLocations.length).toEqual(2);\n@@ -1077,50 +1117,49 @@ describe('find references and rename locations', () => {\n     }\n \n     describe('when cursor is on output key in template', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const cursorInfo = extractCursorInfo(\n-            generateAppFile(`<div string-model (mod¦elChange)=\"setTitle($event)\"></div>`));\n-        cursor = cursorInfo.cursor;\n-        env = LanguageServiceTestEnvironment.setup([\n-          {name: _('/app.ts'), contents: cursorInfo.text, isRoot: true},\n-          {name: _('/string-model.ts'), contents: dirFile},\n-        ]);\n+        const appFile =\n+            generateAppFile(`<div string-model (modelChange)=\"setTitle($event)\"></div>`);\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = env.addProject('test', {'app.ts': appFile, 'string-model.ts': dirFile});\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('(mod¦elChange)');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toEqual(2);\n         assertTextSpans(refs, ['modelChange']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toEqual(2);\n         assertTextSpans(renameLocations, ['modelChange']);\n       });\n     });\n \n     describe('when cursor is on alias output key', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const cursorInfo = extractCursorInfo(\n-            generateAppFile(`<div string-model (a¦lias)=\"setTitle($event)\"></div>`));\n-        cursor = cursorInfo.cursor;\n-        env = LanguageServiceTestEnvironment.setup([\n-          {name: _('/app.ts'), contents: cursorInfo.text, isRoot: true},\n-          {name: _('/string-model.ts'), contents: dirFile},\n-        ]);\n+        const appFile = generateAppFile(`<div string-model (alias)=\"setTitle($event)\"></div>`);\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = env.addProject('test', {'app.ts': appFile, 'string-model.ts': dirFile});\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('(a¦lias)');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toEqual(2);\n         assertTextSpans(refs, ['aliasedModelChange', 'alias']);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations).toBeUndefined();\n         // TODO(atscott): add support for renaming alias outputs\n         // expect(renameLocations.length).toEqual(2);\n@@ -1130,28 +1169,31 @@ describe('find references and rename locations', () => {\n   });\n \n   it('should get references to both input and output for two-way binding', () => {\n-    const dirFile = {\n-      name: _('/dir.ts'),\n-      contents: `\n+    const files = {\n+      'dir.ts': `\n       import {Directive, Input, Output} from '@angular/core';\n \n       @Directive({selector: '[string-model]'})\n       export class StringModel {\n         @Input() model!: any;\n         @Output() modelChange!: any;\n+      }`,\n+      'app.ts': `\n+      import {Component} from '@angular/core';\n+  \n+      @Component({template: '<div string-model [(model)]=\"title\"></div>'})\n+      export class AppCmp {\n+        title = 'title';\n       }`\n+\n     };\n-    const {text, cursor} = extractCursorInfo(`\n-    import {Component} from '@angular/core';\n \n-    @Component({template: '<div string-model [(mod¦el)]=\"title\"></div>'})\n-    export class AppCmp {\n-      title = 'title';\n-    }`);\n-    const appFile = {name: _('/app.ts'), contents: text};\n-    env = createModuleWithDeclarations([appFile, dirFile]);\n+    env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const file = project.openFile('app.ts');\n+    file.moveCursorToText('[(mod¦el)]');\n \n-    const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+    const refs = getReferencesAtPosition(file)!;\n     // Note that this includes the 'model` twice from the template. As with other potential\n     // duplicates (like if another plugin returns the same span), we expect the LS clients to filter\n     // these out themselves.\n@@ -1162,15 +1204,15 @@ describe('find references and rename locations', () => {\n \n   describe('directives', () => {\n     describe('when cursor is on the directive class', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const cursorInfo = extractCursorInfo(`\n+        const files = {\n+          'dir.ts': `\n       import {Directive} from '@angular/core';\n \n       @Directive({selector: '[dir]'})\n-      export class Di¦r {}`);\n-        cursor = cursorInfo.cursor;\n-        const appFile = `\n+      export class Dir {}`,\n+          'app.ts': `\n         import {Component, NgModule} from '@angular/core';\n         import {Dir} from './dir';\n \n@@ -1180,15 +1222,17 @@ describe('find references and rename locations', () => {\n \n         @NgModule({declarations: [AppCmp, Dir]})\n         export class AppModule {}\n-      `;\n-        env = LanguageServiceTestEnvironment.setup([\n-          {name: _('/app.ts'), contents: appFile, isRoot: true},\n-          {name: _('/dir.ts'), contents: cursorInfo.text},\n-        ]);\n+      `\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = env.addProject('test', files);\n+        file = project.openFile('dir.ts');\n+        file.moveCursorToText('export class Di¦r {}');\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/dir.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         // 4 references are:  class declaration, template usage, app import and use in declarations\n         // list.\n         expect(refs.length).toBe(4);\n@@ -1197,7 +1241,7 @@ describe('find references and rename locations', () => {\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/dir.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations).toBeUndefined();\n         // TODO(atscott): We should handle this case, but exclude the template results\n         // expect(renameLocations.length).toBe(3);\n@@ -1207,7 +1251,7 @@ describe('find references and rename locations', () => {\n     });\n \n     describe('when cursor is on an attribute', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n         const dirFile = `\n       import {Directive} from '@angular/core';\n@@ -1219,35 +1263,34 @@ describe('find references and rename locations', () => {\n \n       @Directive({selector: '[dir]'})\n       export class Dir2 {}`;\n-        const cursorInfo = extractCursorInfo(`\n+        const appFile = `\n         import {Component, NgModule} from '@angular/core';\n         import {Dir} from './dir';\n         import {Dir2} from './dir2';\n \n-        @Component({template: '<div di¦r></div>'})\n+        @Component({template: '<div dir></div>'})\n         export class AppCmp {\n         }\n \n         @NgModule({declarations: [AppCmp, Dir, Dir2]})\n         export class AppModule {}\n-      `);\n-        cursor = cursorInfo.cursor;\n-        env = LanguageServiceTestEnvironment.setup([\n-          {name: _('/app.ts'), contents: cursorInfo.text, isRoot: true},\n-          {name: _('/dir.ts'), contents: dirFile},\n-          {name: _('/dir2.ts'), contents: dirFile2},\n-        ]);\n+      `;\n+        env = LanguageServiceTestEnv.setup();\n+        const project =\n+            env.addProject('test', {'app.ts': appFile, 'dir.ts': dirFile, 'dir2.ts': dirFile2});\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('<div di¦r></div>');\n       });\n \n       it('gets references to all matching directives', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toBe(8);\n         assertTextSpans(refs, ['<div dir>', 'Dir', 'Dir2']);\n         assertFileNames(refs, ['app.ts', 'dir.ts', 'dir2.ts']);\n       });\n \n       it('finds rename locations for all matching directives', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations).toBeUndefined();\n         // TODO(atscott): We could consider supporting rename for directive selectors in the future\n         // expect(renameLocations.length).toBe(3);\n@@ -1257,44 +1300,48 @@ describe('find references and rename locations', () => {\n     });\n \n     describe('when cursor is on generic directive selector in template', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const cursorInfo = extractCursorInfo(`\n+        const files = {\n+          'app.ts': `\n         import {Component, NgModule} from '@angular/core';\n \n-        @Component({template: '<div *ngF¦or=\"let item of items\"></div>'})\n+        @Component({template: '<div *ngFor=\"let item of items\"></div>'})\n         export class AppCmp {\n           items = [];\n         }\n-      `);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile]);\n+      `\n+        };\n+\n+        env = LanguageServiceTestEnv.setup();\n+        const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('*ngF¦or');\n       });\n \n       it('should be able to request references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         expect(refs.length).toBe(6);\n         assertTextSpans(refs, ['<div *ngFor=\"let item of items\"></div>', 'NgForOf']);\n         assertFileNames(refs, ['index.d.ts', 'app.ts']);\n       });\n \n       it('should not support rename if directive is in a dts file', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor);\n+        const renameLocations = getRenameLocationsAtPosition(file);\n         expect(renameLocations).toBeUndefined();\n       });\n     });\n   });\n \n   describe('components', () => {\n     describe('when cursor is on component class', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n-        const cursorInfo = extractCursorInfo(`\n+        const myComp = `\n       import {Component} from '@angular/core';\n \n       @Component({selector: 'my-comp', template: ''})\n-      export class MyCo¦mp {}`);\n+      export class MyComp {}`;\n         const appFile = `\n         import {Component, NgModule} from '@angular/core';\n         import {MyComp} from './comp';\n@@ -1306,15 +1353,14 @@ describe('find references and rename locations', () => {\n         @NgModule({declarations: [AppCmp, MyComp]})\n         export class AppModule {}\n       `;\n-        cursor = cursorInfo.cursor;\n-        env = LanguageServiceTestEnvironment.setup([\n-          {name: _('/app.ts'), contents: appFile, isRoot: true},\n-          {name: _('/comp.ts'), contents: cursorInfo.text},\n-        ]);\n+        env = LanguageServiceTestEnv.setup();\n+        const project = env.addProject('test', {'comp.ts': myComp, 'app.ts': appFile});\n+        file = project.openFile('comp.ts');\n+        file.moveCursorToText('MyCo¦mp');\n       });\n \n       it('finds references', () => {\n-        const refs = getReferencesAtPosition(_('/comp.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         // 4 references are:  class declaration, template usage, app import and use in declarations\n         // list.\n         expect(refs.length).toBe(4);\n@@ -1323,7 +1369,7 @@ describe('find references and rename locations', () => {\n       });\n \n       it('gets rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/comp.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations).toBeUndefined();\n         // TODO(atscott): If we register as an exclusive provider for TS, we may need to return\n         // results here and should exclude the template results.\n@@ -1334,33 +1380,32 @@ describe('find references and rename locations', () => {\n     });\n \n     describe('when cursor is on the element tag', () => {\n-      let cursor: number;\n+      let file: OpenBuffer;\n       beforeEach(() => {\n         const compFile = `\n       import {Component} from '@angular/core';\n \n       @Component({selector: 'my-comp', template: ''})\n       export class MyComp {}`;\n-        const cursorInfo = extractCursorInfo(`\n+        const app = `\n         import {Component, NgModule} from '@angular/core';\n         import {MyComp} from './comp';\n \n-        @Component({template: '<my-c¦omp></my-comp>'})\n+        @Component({template: '<my-comp></my-comp>'})\n         export class AppCmp {\n         }\n \n         @NgModule({declarations: [AppCmp, MyComp]})\n         export class AppModule {}\n-      `);\n-        cursor = cursorInfo.cursor;\n-        env = LanguageServiceTestEnvironment.setup([\n-          {name: _('/app.ts'), contents: cursorInfo.text, isRoot: true},\n-          {name: _('/comp.ts'), contents: compFile},\n-        ]);\n+      `;\n+        env = LanguageServiceTestEnv.setup();\n+        const project = env.addProject('test', {'app.ts': app, 'comp.ts': compFile});\n+        file = project.openFile('app.ts');\n+        file.moveCursorToText('<my-c¦omp></my-comp>');\n       });\n \n       it('gets references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const refs = getReferencesAtPosition(file)!;\n         // 4 references are:  class declaration, template usage, app import and use in declarations\n         // list.\n         expect(refs.length).toBe(4);\n@@ -1369,7 +1414,7 @@ describe('find references and rename locations', () => {\n       });\n \n       it('finds rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n+        const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations).toBeUndefined();\n         // TODO(atscott): We may consider supporting rename of component selector in the future\n         // expect(renameLocations.length).toBe(2);\n@@ -1382,95 +1427,110 @@ describe('find references and rename locations', () => {\n   describe('get rename info', () => {\n     it('indicates inability to rename when cursor is outside template and in a string literal',\n        () => {\n-         const {cursor, text} = extractCursorInfo(`\n+         const comp = `\n             import {Component} from '@angular/core';\n \n             @Component({selector: 'my-comp', template: ''})\n             export class MyComp {\n-              myProp = 'cannot rena¦me me';\n-            }`);\n-         env = createModuleWithDeclarations([{name: _('/my-comp.ts'), contents: text}]);\n+              myProp = 'cannot rename me';\n+            }`;\n+         env = LanguageServiceTestEnv.setup();\n+         const project = createModuleAndProjectWithDeclarations(env, 'test', {'my-comp.ts': comp});\n          env.expectNoSourceDiagnostics();\n-         const result = env.ngLS.getRenameInfo(_('/my-comp.ts'), cursor);\n+\n+         const file = project.openFile('my-comp.ts');\n+         file.moveCursorToText('cannot rena¦me me');\n+         const result = file.getRenameInfo();\n          expect(result.canRename).toEqual(false);\n        });\n \n     it('gets rename info when cursor is outside template', () => {\n-      const {cursor, text} = extractCursorInfo(`\n+      const comp = `\n             import {Component, Input} from '@angular/core';\n \n             @Component({name: 'my-comp', template: ''})\n             export class MyComp {\n-              @Input() m¦yProp!: string;\n-            }`);\n-      env = createModuleWithDeclarations([{name: _('/my-comp.ts'), contents: text}]);\n+              @Input() myProp!: string;\n+            }`;\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', {'my-comp.ts': comp});\n       env.expectNoSourceDiagnostics();\n-      const result = env.ngLS.getRenameInfo(_('/my-comp.ts'), cursor) as ts.RenameInfoSuccess;\n+\n+      const file = project.openFile('my-comp.ts');\n+      file.moveCursorToText('m¦yProp!');\n+      const result = file.getRenameInfo() as ts.RenameInfoSuccess;\n       expect(result.canRename).toEqual(true);\n       expect(result.displayName).toEqual('myProp');\n       expect(result.kind).toEqual('property');\n     });\n \n     it('gets rename info on keyed read', () => {\n-      const {cursor, text} = extractCursorInfo(`\n+      const text = `\n             import {Component} from '@angular/core';\n \n-            @Component({name: 'my-comp', template: '{{ myObj[\"my¦Prop\"] }}'})\n+            @Component({name: 'my-comp', template: '{{ myObj[\"myProp\"] }}'})\n             export class MyComp {\n               readonly myObj = {'myProp': 'hello world'};\n-            }`);\n-      env = createModuleWithDeclarations([{name: _('/my-comp.ts'), contents: text}]);\n+            }`;\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', {'my-comp.ts': text});\n       env.expectNoSourceDiagnostics();\n-      const result = env.ngLS.getRenameInfo(_('/my-comp.ts'), cursor) as ts.RenameInfoSuccess;\n+      const file = project.openFile('my-comp.ts');\n+      file.moveCursorToText('myObj[\"my¦Prop\"]');\n+\n+      const result = file.getRenameInfo() as ts.RenameInfoSuccess;\n       expect(result.canRename).toEqual(true);\n       expect(result.displayName).toEqual('myProp');\n       expect(result.kind).toEqual('property');\n       expect(text.substring(\n                  result.triggerSpan.start, result.triggerSpan.start + result.triggerSpan.length))\n           .toBe('myProp');\n       // re-queries also work\n-      const {triggerSpan, displayName} =\n-          env.ngLS.getRenameInfo(_('/my-comp.ts'), cursor) as ts.RenameInfoSuccess;\n+      const {triggerSpan, displayName} = file.getRenameInfo() as ts.RenameInfoSuccess;\n       expect(displayName).toEqual('myProp');\n       expect(text.substring(triggerSpan.start, triggerSpan.start + triggerSpan.length))\n           .toBe('myProp');\n     });\n \n     it('gets rename info when cursor is on a directive input in a template', () => {\n-      const dirFile = {\n-        name: _('/dir.ts'),\n-        contents: `\n+      const files = {\n+        'dir.ts': `\n         import {Directive, Input} from '@angular/core';\n         @Directive({selector: '[dir]'})\n         export class MyDir {\n           @Input() dir!: any;\n-        }`\n-      };\n-      const {cursor, text} = extractCursorInfo(`\n+        }`,\n+        'my-comp.ts': `\n             import {Component, Input} from '@angular/core';\n \n-            @Component({name: 'my-comp', template: '<div di¦r=\"something\"></div>'})\n+            @Component({name: 'my-comp', template: '<div dir=\"something\"></div>'})\n             export class MyComp {\n               @Input() myProp!: string;\n-            }`);\n-      env = createModuleWithDeclarations([{name: _('/my-comp.ts'), contents: text}, dirFile]);\n+            }`\n+      };\n+\n+      env = LanguageServiceTestEnv.setup();\n+      const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n       env.expectNoSourceDiagnostics();\n-      const result = env.ngLS.getRenameInfo(_('/my-comp.ts'), cursor) as ts.RenameInfoSuccess;\n+\n+      const file = project.openFile('my-comp.ts');\n+      file.moveCursorToText('di¦r=\"something\"');\n+      const result = file.getRenameInfo() as ts.RenameInfoSuccess;\n       expect(result.canRename).toEqual(true);\n       expect(result.displayName).toEqual('dir');\n       expect(result.kind).toEqual('property');\n     });\n   });\n \n-  function getReferencesAtPosition(fileName: string, position: number) {\n+  function getReferencesAtPosition(file: OpenBuffer) {\n     env.expectNoSourceDiagnostics();\n-    const result = env.ngLS.getReferencesAtPosition(fileName, position);\n+    const result = file.getReferencesAtPosition();\n     return result?.map((item) => humanizeDocumentSpanLike(item, env));\n   }\n \n-  function getRenameLocationsAtPosition(fileName: string, position: number) {\n+  function getRenameLocationsAtPosition(file: OpenBuffer) {\n     env.expectNoSourceDiagnostics();\n-    const result = env.ngLS.findRenameLocations(fileName, position);\n+    const result = file.fineRenameLocations();\n     return result?.map((item) => humanizeDocumentSpanLike(item, env));\n   }\n });"
        },
        {
            "sha": "aa7a49eb9e1221a213e932b5c5a08d8ae6d1fc6a",
            "filename": "packages/language-service/ivy/testing/src/buffer.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "raw_url": "https://github.com/angular/angular/raw/dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts?ref=dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf",
            "patch": "@@ -88,4 +88,16 @@ export class OpenBuffer {\n   getTypeDefinitionAtPosition() {\n     return this.ngLS.getTypeDefinitionAtPosition(this.scriptInfo.fileName, this._cursor);\n   }\n+\n+  getReferencesAtPosition() {\n+    return this.ngLS.getReferencesAtPosition(this.scriptInfo.fileName, this._cursor);\n+  }\n+\n+  fineRenameLocations() {\n+    return this.ngLS.findRenameLocations(this.scriptInfo.fileName, this._cursor);\n+  }\n+\n+  getRenameInfo() {\n+    return this.ngLS.getRenameInfo(this.scriptInfo.fileName, this._cursor);\n+  }\n }"
        },
        {
            "sha": "8838b5b22913c7cf732abbd7951922b45a1030bb",
            "filename": "packages/language-service/ivy/testing/src/project.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "raw_url": "https://github.com/angular/angular/raw/dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts?ref=dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf",
            "patch": "@@ -98,9 +98,14 @@ export class Project {\n   openFile(projectFileName: string): OpenBuffer {\n     if (!this.buffers.has(projectFileName)) {\n       const fileName = absoluteFrom(`/${this.name}/${projectFileName}`);\n+      let scriptInfo = this.tsProject.getScriptInfo(fileName);\n       this.projectService.openClientFile(fileName);\n+      // Mark the project as dirty because the act of opening a file may result in the version\n+      // changing since TypeScript will `switchToScriptVersionCache` when a file is opened.\n+      // Note that this emulates what we have to do in the server/extension as well.\n+      this.tsProject.markAsDirty();\n \n-      const scriptInfo = this.tsProject.getScriptInfo(fileName);\n+      scriptInfo = this.tsProject.getScriptInfo(fileName);\n       if (scriptInfo === undefined) {\n         throw new Error(\n             `Unable to open ScriptInfo for ${projectFileName} in project ${this.tsConfigPath}`);"
        },
        {
            "sha": "780ad538532cbca4bfd59e91871647694db37d3a",
            "filename": "packages/language-service/ivy/testing/src/util.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts?ref=dcee784b4f176a9428fca9e84a0c8ffdd3e06fcf",
            "patch": "@@ -45,6 +45,11 @@ export function assertFileNames(refs: Array<{fileName: string}>, expectedFileNam\n   expect(new Set(actualFileNames)).toEqual(new Set(expectedFileNames));\n }\n \n+export function assertTextSpans(items: Array<{textSpan: string}>, expectedTextSpans: string[]) {\n+  const actualSpans = items.map(item => item.textSpan);\n+  expect(new Set(actualSpans)).toEqual(new Set(expectedTextSpans));\n+}\n+\n /**\n  * Returns whether the given `ts.Diagnostic` is of a type only produced by the Angular compiler (as\n  * opposed to being an upstream TypeScript diagnostic)."
        }
    ],
    "stats": {
        "total": 959,
        "additions": 523,
        "deletions": 436
    }
}