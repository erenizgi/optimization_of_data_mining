{
    "author": "petebacondarwin",
    "message": "fix(ngcc): support alternate wrapper function layout for UMD (#43879)\n\nRecently rollup, used by ng-packagr, changed the position of parentheses\naround its generated UMD wrapper functions.\n\nThis commit ensures that ngcc can handle both.\n\nFixes #43870\n\nPR Close #43879",
    "sha": "ec8a565655972db61efab2ade0b88617f91ef409",
    "files": [
        {
            "sha": "2bf0f2f77a2a669f27756a2053cf0738f049b29f",
            "filename": "packages/compiler-cli/ngcc/src/host/umd_host.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 15,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/ec8a565655972db61efab2ade0b88617f91ef409/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec8a565655972db61efab2ade0b88617f91ef409/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts?ref=ec8a565655972db61efab2ade0b88617f91ef409",
            "patch": "@@ -511,30 +511,40 @@ export class UmdReflectionHost extends Esm5ReflectionHost {\n }\n \n export function parseStatementForUmdModule(statement: ts.Statement): UmdModule|null {\n-  const wrapperCall = getUmdWrapperCall(statement);\n-  if (!wrapperCall) return null;\n+  const wrapper = getUmdWrapper(statement);\n+  if (wrapper === null) return null;\n \n-  const wrapperFn = wrapperCall.expression;\n-  if (!ts.isFunctionExpression(wrapperFn)) return null;\n-\n-  const factoryFnParamIndex = wrapperFn.parameters.findIndex(\n+  const factoryFnParamIndex = wrapper.fn.parameters.findIndex(\n       parameter => ts.isIdentifier(parameter.name) && parameter.name.text === 'factory');\n   if (factoryFnParamIndex === -1) return null;\n \n-  const factoryFn = stripParentheses(wrapperCall.arguments[factoryFnParamIndex]);\n+  const factoryFn = stripParentheses(wrapper.call.arguments[factoryFnParamIndex]);\n   if (!factoryFn || !ts.isFunctionExpression(factoryFn)) return null;\n \n-  return {wrapperFn, factoryFn};\n+  return {wrapperFn: wrapper.fn, factoryFn};\n }\n \n-function getUmdWrapperCall(statement: ts.Statement): ts.CallExpression&\n-    {expression: ts.FunctionExpression}|null {\n-  if (!ts.isExpressionStatement(statement) || !ts.isParenthesizedExpression(statement.expression) ||\n-      !ts.isCallExpression(statement.expression.expression) ||\n-      !ts.isFunctionExpression(statement.expression.expression.expression)) {\n-    return null;\n+function getUmdWrapper(statement: ts.Statement):\n+    {call: ts.CallExpression, fn: ts.FunctionExpression}|null {\n+  if (!ts.isExpressionStatement(statement)) return null;\n+\n+  if (ts.isParenthesizedExpression(statement.expression) &&\n+      ts.isCallExpression(statement.expression.expression) &&\n+      ts.isFunctionExpression(statement.expression.expression.expression)) {\n+    // (function () { ... } (...) );\n+    const call = statement.expression.expression;\n+    const fn = statement.expression.expression.expression;\n+    return {call, fn};\n+  }\n+  if (ts.isCallExpression(statement.expression) &&\n+      ts.isParenthesizedExpression(statement.expression.expression) &&\n+      ts.isFunctionExpression(statement.expression.expression.expression)) {\n+    // (function () { ... }) (...);\n+    const call = statement.expression;\n+    const fn = statement.expression.expression.expression;\n+    return {call, fn};\n   }\n-  return statement.expression.expression as ts.CallExpression & {expression: ts.FunctionExpression};\n+  return null;\n }\n \n "
        },
        {
            "sha": "d8720dbd4184a4b366cbf40853cce683386dfecd",
            "filename": "packages/compiler-cli/ngcc/test/packages/entry_point_spec.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/ec8a565655972db61efab2ade0b88617f91ef409/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fentry_point_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec8a565655972db61efab2ade0b88617f91ef409/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fentry_point_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fentry_point_spec.ts?ref=ec8a565655972db61efab2ade0b88617f91ef409",
            "patch": "@@ -747,6 +747,25 @@ runInEachFileSystem(() => {\n         entryPoint.packageJson.main = './bundles/valid_entry_point';\n         expect(getEntryPointFormat(fs, entryPoint, browserOrMain)).toBe('umd');\n       });\n+\n+      it('should match alternate UMD format', () => {\n+        // Note that in this format, instead of the whole wrapper being enclosed in parentheses,\n+        // only the wrapper function is enclosed and the call is not inside the parentheses.\n+        loadTestFiles([{\n+          name: _(\n+              '/project/node_modules/some_package/valid_entry_point/bundles/valid_entry_point/index.js'),\n+          contents: `\n+        (function (global, factory) {\n+          typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/core')) :\n+          typeof define === 'function' && define.amd ? define('@angular/common', ['exports', '@angular/core'], factory) :\n+          (global = global || self, factory((global.ng = global.ng || {}, global.ng.common = {}), global.ng.core));\n+        })(this, function (exports, core) { 'use strict'; });\n+      `\n+        }]);\n+\n+        entryPoint.packageJson.main = './bundles/valid_entry_point';\n+        expect(getEntryPointFormat(fs, entryPoint, browserOrMain)).toBe('umd');\n+      });\n     });\n \n     it('should return `undefined` if the `browser` property is not a string', () => {"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 44,
        "deletions": 15
    }
}