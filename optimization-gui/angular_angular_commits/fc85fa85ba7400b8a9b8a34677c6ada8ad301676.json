{
    "author": "danieltre23",
    "message": "refactor(compiler-cli): use `TemplateCheckWithVisitor` in `InvalidBananaInBoxCheck` (#43232)\n\nModify the existing template check to use the new abstract class. This\nmakes template checks easier to read and understand.\n\nRefs #42966\n\nPR Close #43232",
    "sha": "fc85fa85ba7400b8a9b8a34677c6ada8ad301676",
    "files": [
        {
            "sha": "1e129bf35927f25e70221b9ddbaafe8d4e88b68a",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/checks/invalid_banana_in_box/index.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 47,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/fc85fa85ba7400b8a9b8a34677c6ada8ad301676/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Finvalid_banana_in_box%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/fc85fa85ba7400b8a9b8a34677c6ada8ad301676/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Finvalid_banana_in_box%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Finvalid_banana_in_box%2Findex.ts?ref=fc85fa85ba7400b8a9b8a34677c6ada8ad301676",
            "patch": "@@ -6,62 +6,36 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {TmplAstBoundEvent, TmplAstNode, TmplAstRecursiveVisitor} from '@angular/compiler';\n+import {AST, TmplAstBoundEvent, TmplAstNode} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {ErrorCode} from '../../../../diagnostics';\n import {NgTemplateDiagnostic} from '../../../api';\n-import {TemplateCheck, TemplateContext} from '../../api';\n+import {TemplateCheckWithVisitor, TemplateContext} from '../../api';\n \n /**\n  * Ensures the two-way binding syntax is correct.\n  * Parentheses should be inside the brackets \"[()]\".\n  * Will return diagnostic information when \"([])\" is found.\n  */\n-export class InvalidBananaInBoxCheck implements TemplateCheck<ErrorCode.INVALID_BANANA_IN_BOX> {\n-  code: ErrorCode.INVALID_BANANA_IN_BOX = 8101;\n-\n-  run(ctx: TemplateContext, component: ts.ClassDeclaration,\n-      template: TmplAstNode[]): NgTemplateDiagnostic<ErrorCode.INVALID_BANANA_IN_BOX>[] {\n-    const visitor = new BananaVisitor(ctx, component);\n-\n-    return visitor.getDiagnostics(template);\n-  }\n-}\n-\n-class BananaVisitor extends TmplAstRecursiveVisitor {\n-  private diagnostics: NgTemplateDiagnostic<ErrorCode.INVALID_BANANA_IN_BOX>[] = [];\n-\n-  constructor(\n-      public readonly ctx: TemplateContext, private readonly component: ts.ClassDeclaration) {\n-    super();\n-  }\n-\n-  /**\n-   * Check for outputs with names surrounded in brackets \"[]\".\n-   * The syntax '([foo])=\"bar\"' would be interpreted as an @Output()\n-   * with name '[foo]'. Just like '(foo)=\"bar\"' would have the name 'foo'.\n-   * Generate diagnostic information for the cases found.\n-   */\n-  override visitBoundEvent(boundEvent: TmplAstBoundEvent) {\n-    const name = boundEvent.name;\n-    if (name.startsWith('[') && name.endsWith(']')) {\n-      const boundSyntax = boundEvent.sourceSpan.toString();\n-      const expectedBoundSyntax = boundSyntax.replace(`(${name})`, `[(${name.slice(1, -1)})]`);\n-      this.diagnostics.push(this.ctx.templateTypeChecker.makeTemplateDiagnostic(\n-          this.component, boundEvent.sourceSpan, ts.DiagnosticCategory.Warning,\n-          ErrorCode.INVALID_BANANA_IN_BOX,\n-          `In the two-way binding syntax the parentheses should be inside the brackets, ex. '${\n-              expectedBoundSyntax}'. \n-                Find more at https://angular.io/guide/two-way-binding`));\n-    }\n-  }\n-\n-  getDiagnostics(template: TmplAstNode[]): NgTemplateDiagnostic<ErrorCode.INVALID_BANANA_IN_BOX>[] {\n-    this.diagnostics = [];\n-    for (const node of template) {\n-      node.visit(this);\n-    }\n-    return this.diagnostics;\n+export class InvalidBananaInBoxCheck extends\n+    TemplateCheckWithVisitor<ErrorCode.INVALID_BANANA_IN_BOX> {\n+  override code = ErrorCode.INVALID_BANANA_IN_BOX as const;\n+\n+  override visitNode(ctx: TemplateContext, component: ts.ClassDeclaration, node: TmplAstNode|AST):\n+      NgTemplateDiagnostic<ErrorCode.INVALID_BANANA_IN_BOX>[] {\n+    if (!(node instanceof TmplAstBoundEvent)) return [];\n+\n+    const name = node.name;\n+    if (!name.startsWith('[') || !name.endsWith(']')) return [];\n+\n+    const boundSyntax = node.sourceSpan.toString();\n+    const expectedBoundSyntax = boundSyntax.replace(`(${name})`, `[(${name.slice(1, -1)})]`);\n+    const diagnostic = ctx.templateTypeChecker.makeTemplateDiagnostic(\n+        component, node.sourceSpan, ts.DiagnosticCategory.Warning, ErrorCode.INVALID_BANANA_IN_BOX,\n+        `In the two-way binding syntax the parentheses should be inside the brackets, ex. '${\n+            expectedBoundSyntax}'. \n+        Find more at https://angular.io/guide/two-way-binding`);\n+    return [diagnostic];\n   }\n }"
        },
        {
            "sha": "6e1a3b6609cdc8e0a5d76bb457764e740585987a",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/src/extended_template_checker.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 53,
            "changes": 54,
            "blob_url": "https://github.com/angular/angular/blob/fc85fa85ba7400b8a9b8a34677c6ada8ad301676/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts",
            "raw_url": "https://github.com/angular/angular/raw/fc85fa85ba7400b8a9b8a34677c6ada8ad301676/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts?ref=fc85fa85ba7400b8a9b8a34677c6ada8ad301676",
            "patch": "@@ -33,61 +33,9 @@ export class ExtendedTemplateCheckerImpl implements ExtendedTemplateChecker {\n     const diagnostics: TemplateDiagnostic[] = [];\n \n     for (const check of this.templateChecks) {\n-      diagnostics.push(...deduplicateDiagnostics(check.run(this.ctx, component, template)));\n+      diagnostics.push(...check.run(this.ctx, component, template));\n     }\n \n     return diagnostics;\n   }\n }\n-\n-\n-// Filter out duplicated diagnostics, this is possible due to the way the compiler\n-// handles desugaring and produces `AST`s. Ex.\n-//\n-// ```\n-// <div *ngIf=\"true\" (foo)=\"bar\">test</div>\n-// ```\n-//\n-// Would result in the following AST:\n-//\n-// ```\n-// Template {\n-//   outputs: [\n-//    BoundEvent {\n-//      name: 'foo',\n-//      /.../\n-//    }\n-//   ],\n-//   children: [\n-//     Element {\n-//       outputs: [\n-//         BoundEvent {\n-//           name: 'foo',\n-//           /.../\n-//         }\n-//       ]\n-//     }\n-//   ],\n-//   /.../\n-// }\n-// ```\n-//\n-// In this case a duplicated diagnostic could be generated for the output `foo`.\n-// TODO(danieltrevino): handle duplicated diagnostics when they are being generated\n-// to avoid extra work (could be directly in the visitor).\n-// https://github.com/angular/angular/pull/42984#discussion_r684823926\n-function deduplicateDiagnostics<T extends ts.Diagnostic>(diagnostics: T[]): T[] {\n-  const result: T[] = [];\n-  for (const newDiag of diagnostics) {\n-    const isDuplicateDiag = result.some(existingDiag => areDiagnosticsEqual(newDiag, existingDiag));\n-    if (!isDuplicateDiag) {\n-      result.push(newDiag);\n-    }\n-  }\n-  return result;\n-}\n-\n-function areDiagnosticsEqual(first: ts.Diagnostic, second: ts.Diagnostic): boolean {\n-  return first.file?.fileName === second.file?.fileName && first.start === second.start &&\n-      first.length === second.length && first.code === second.code;\n-}"
        }
    ],
    "stats": {
        "total": 122,
        "additions": 22,
        "deletions": 100
    }
}