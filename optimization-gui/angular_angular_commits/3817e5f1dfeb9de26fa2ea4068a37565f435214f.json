{
    "author": "lemoinem",
    "message": "fix(router): Fix arguments order for call to shouldReuseRoute (#26949)\n\nThe `createOrReuseChildren` function calls shouldReuseRoute with the\nprevious child values use as the future and the future child value used\nas the current argument. This is incosistent with the argument order in\n`createNode`. This inconsistent order can make it difficult/impossible\nto correctly implement the `shouldReuseRoute` function. Usually this\norder doesn't matter because simple equality checks are made on the\nargs and it doesn't matter which is which.\n\nMore detail can be found in the bug report: #16192.\n\nFix #16192\n\nBREAKING CHANGE: This change corrects the argument order when calling\nRouteReuseStrategy#shouldReuseRoute. Previously, when evaluating child\nroutes, they would be called with the future and current arguments would\nbe swapped. If your RouteReuseStrategy relies specifically on only the future\nor current snapshot state, you may need to update the shouldReuseRoute\nimplementation's use of \"future\" and \"current\" ActivateRouteSnapshots.\n\nPR Close #26949",
    "sha": "3817e5f1dfeb9de26fa2ea4068a37565f435214f",
    "files": [
        {
            "sha": "92ca55bdbfde46e0b20b5452dc9db1e6686e63dc",
            "filename": "packages/router/src/create_router_state.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/3817e5f1dfeb9de26fa2ea4068a37565f435214f/packages%2Frouter%2Fsrc%2Fcreate_router_state.ts",
            "raw_url": "https://github.com/angular/angular/raw/3817e5f1dfeb9de26fa2ea4068a37565f435214f/packages%2Frouter%2Fsrc%2Fcreate_router_state.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fcreate_router_state.ts?ref=3817e5f1dfeb9de26fa2ea4068a37565f435214f",
            "patch": "@@ -65,7 +65,7 @@ function createOrReuseChildren(\n     prevState: TreeNode<ActivatedRoute>) {\n   return curr.children.map(child => {\n     for (const p of prevState.children) {\n-      if (routeReuseStrategy.shouldReuseRoute(p.value.snapshot, child.value)) {\n+      if (routeReuseStrategy.shouldReuseRoute(child.value, p.value.snapshot)) {\n         return createNode(routeReuseStrategy, child, p);\n       }\n     }"
        },
        {
            "sha": "7afb907eda4443cf3ecd71f24b1b602675310094",
            "filename": "packages/router/test/create_router_state.spec.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 1,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/3817e5f1dfeb9de26fa2ea4068a37565f435214f/packages%2Frouter%2Ftest%2Fcreate_router_state.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3817e5f1dfeb9de26fa2ea4068a37565f435214f/packages%2Frouter%2Ftest%2Fcreate_router_state.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fcreate_router_state.spec.ts?ref=3817e5f1dfeb9de26fa2ea4068a37565f435214f",
            "patch": "@@ -16,7 +16,10 @@ import {DefaultUrlSerializer, UrlSegmentGroup, UrlTree} from '../src/url_tree';\n import {TreeNode} from '../src/utils/tree';\n \n describe('create router state', () => {\n-  const reuseStrategy = new DefaultRouteReuseStrategy();\n+  let reuseStrategy: DefaultRouteReuseStrategy;\n+  beforeEach(() => {\n+    reuseStrategy = new DefaultRouteReuseStrategy();\n+  });\n \n   const emptyState = () =>\n       createEmptyState(new (UrlTree as any)(new UrlSegmentGroup([], {}), {}, null!), RootComponent);\n@@ -109,6 +112,33 @@ describe('create router state', () => {\n     // Verify the retrieve method has been called one more time\n     expect(reuseStrategy.retrieve).toHaveBeenCalledTimes(3);\n   });\n+\n+  it('should consistently represent future and current state', () => {\n+    const config = [\n+      {path: '', pathMatch: 'full', component: ComponentA},\n+      {path: 'product/:id', component: ComponentB}\n+    ];\n+    spyOn(reuseStrategy, 'shouldReuseRoute').and.callThrough();\n+    const previousState = createRouterState(reuseStrategy, createState(config, ''), emptyState());\n+    advanceState(previousState);\n+    (reuseStrategy.shouldReuseRoute as jasmine.Spy).calls.reset();\n+\n+    createRouterState(reuseStrategy, createState(config, 'product/30'), previousState);\n+\n+    // One call for the root and one call for each of the children\n+    expect(reuseStrategy.shouldReuseRoute).toHaveBeenCalledTimes(2);\n+    const reuseCalls = (reuseStrategy.shouldReuseRoute as jasmine.Spy).calls;\n+    const future1 = reuseCalls.argsFor(0)[0];\n+    const current1 = reuseCalls.argsFor(0)[1];\n+    const future2 = reuseCalls.argsFor(1)[0];\n+    const current2 = reuseCalls.argsFor(1)[1];\n+\n+    // Routing from '' to 'product/30'\n+    expect(current1._routerState.url).toEqual('');\n+    expect(future1._routerState.url).toEqual('product/30');\n+    expect(current2._routerState.url).toEqual('');\n+    expect(future2._routerState.url).toEqual('product/30');\n+  });\n });\n \n function advanceState(state: RouterState): void {"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 32,
        "deletions": 2
    }
}