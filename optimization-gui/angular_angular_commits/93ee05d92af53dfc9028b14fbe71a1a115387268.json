{
    "author": "josephperrott",
    "message": "fix(router): create schematic for preserveQueryParams (#38762)\n\nCreate a schematic for migrating preserveQueryParams to use queryParamsHandler\ninstead.\n\nPR Close #38762",
    "sha": "93ee05d92af53dfc9028b14fbe71a1a115387268",
    "files": [
        {
            "sha": "c58ce9ba1c5bd8e33eafe22f4b5a4653c06f7ec1",
            "filename": "packages/core/schematics/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2FBUILD.bazel?ref=93ee05d92af53dfc9028b14fbe71a1a115387268",
            "patch": "@@ -19,6 +19,7 @@ pkg_npm(\n         \"//packages/core/schematics/migrations/navigation-extras-omissions\",\n         \"//packages/core/schematics/migrations/relative-link-resolution\",\n         \"//packages/core/schematics/migrations/renderer-to-renderer2\",\n+        \"//packages/core/schematics/migrations/router-preserve-query-params\",\n         \"//packages/core/schematics/migrations/static-queries\",\n         \"//packages/core/schematics/migrations/template-var-assignment\",\n         \"//packages/core/schematics/migrations/undecorated-classes-with-decorated-fields\","
        },
        {
            "sha": "5f5a9f3e702602ecd1ded5813729f3f54d33efb0",
            "filename": "packages/core/schematics/migrations.json",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "raw_url": "https://github.com/angular/angular/raw/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations.json?ref=93ee05d92af53dfc9028b14fbe71a1a115387268",
            "patch": "@@ -69,6 +69,11 @@\n       \"version\": \"11.0.0-beta\",\n       \"description\": \"`async` to `waitForAsync` migration. The `async` testing function has been renamed to `waitForAsync` to avoid confusion with the native `async` keyword.\",\n       \"factory\": \"./migrations/wait-for-async/index\"\n+    },\n+    \"migration-v11-router-preserve-query-params\": {\n+      \"version\": \"11.0.0-beta\",\n+      \"description\": \"NavigationExtras.preserveQueryParams has been removed as of Angular version 11.  This migration replaces any usages with the appropriate assignment of the queryParamsHandler key.\",\n+      \"factory\": \"./migrations/router-preserve-query-params/index\"\n     }\n   }\n }"
        },
        {
            "sha": "58d793e1a6c52d6e7688f0dc6671ee75982d771a",
            "filename": "packages/core/schematics/migrations/router-preserve-query-params/BUILD.bazel",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2FBUILD.bazel?ref=93ee05d92af53dfc9028b14fbe71a1a115387268",
            "patch": "@@ -0,0 +1,18 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"router-preserve-query-params\",\n+    srcs = glob([\"**/*.ts\"]),\n+    tsconfig = \"//packages/core/schematics:tsconfig.json\",\n+    visibility = [\n+        \"//packages/core/schematics:__pkg__\",\n+        \"//packages/core/schematics/migrations/google3:__pkg__\",\n+        \"//packages/core/schematics/test:__pkg__\",\n+    ],\n+    deps = [\n+        \"//packages/core/schematics/utils\",\n+        \"@npm//@angular-devkit/schematics\",\n+        \"@npm//@types/node\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "125d39c6256bda7ed03c2b71bc2191429ec00004",
            "filename": "packages/core/schematics/migrations/router-preserve-query-params/README.md",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2FREADME.md?ref=93ee05d92af53dfc9028b14fbe71a1a115387268",
            "patch": "@@ -0,0 +1,35 @@\n+## Router's NavigationExtras.preserveQueryParams migration\n+\n+Previously the `NatigationExtras` property of `preserveQueryParams` defined what should be done with\n+query parameters on navigation.  This migration updates the usages of `preserveQueryParams` to\n+instead use the `queryParamsHandler` property.\n+\n+#### Before\n+```ts\n+import { Component } from '@angular/core';\n+import { Router } from '@angular/router';\n+\n+@Component({})\n+export class MyComponent {\n+  constructor(private _router: Router) {}\n+\n+  goHome() {\n+    this._router.navigate('/', {preserveQueryParams: true, skipLocationChange: 'foo'});\n+  }\n+}\n+```\n+\n+#### After\n+```ts\n+import { Component } from '@angular/core';\n+import { Router } from '@angular/router';\n+\n+@Component({})\n+export class MyComponent {\n+  constructor(private _router: Router) {}\n+\n+  goHome() {\n+    this._router.navigate('/', { queryParamsHandler: 'preserve', skipLocationChange: 'foo' });\n+  }\n+}\n+```"
        },
        {
            "sha": "973337f72ce8df633623b21eb664dee6cc818625",
            "filename": "packages/core/schematics/migrations/router-preserve-query-params/index.ts",
            "status": "added",
            "additions": 64,
            "deletions": 0,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2Findex.ts?ref=93ee05d92af53dfc9028b14fbe71a1a115387268",
            "patch": "@@ -0,0 +1,64 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Rule, SchematicsException, Tree} from '@angular-devkit/schematics';\n+import {relative} from 'path';\n+import * as ts from 'typescript';\n+\n+import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n+import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {findLiteralsToMigrate, migrateLiteral} from './util';\n+\n+\n+/**\n+ * Migration that switches `NavigationExtras.preserveQueryParams` to set the coresponding value via\n+ * `NavigationExtras`'s `queryParamsHandling` attribute.\n+ */\n+export default function(): Rule {\n+  return (tree: Tree) => {\n+    const {buildPaths, testPaths} = getProjectTsConfigPaths(tree);\n+    const basePath = process.cwd();\n+    const allPaths = [...buildPaths, ...testPaths];\n+\n+    if (!allPaths.length) {\n+      throw new SchematicsException(\n+          'Could not find any tsconfig file. Cannot migrate ' +\n+          'NavigationExtras.preserveQueryParams usages.');\n+    }\n+\n+    for (const tsconfigPath of allPaths) {\n+      runPreserveQueryParamsMigration(tree, tsconfigPath, basePath);\n+    }\n+  };\n+}\n+\n+function runPreserveQueryParamsMigration(tree: Tree, tsconfigPath: string, basePath: string) {\n+  const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n+  const typeChecker = program.getTypeChecker();\n+  const printer = ts.createPrinter();\n+  const sourceFiles = program.getSourceFiles().filter(\n+      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+\n+  sourceFiles.forEach(sourceFile => {\n+    const literalsToMigrate = findLiteralsToMigrate(sourceFile, typeChecker);\n+    const update = tree.beginUpdate(relative(basePath, sourceFile.fileName));\n+\n+    literalsToMigrate.forEach((instances, methodName) => instances.forEach(instance => {\n+      const migratedNode = migrateLiteral(methodName, instance);\n+\n+      if (migratedNode !== instance) {\n+        update.remove(instance.getStart(), instance.getWidth());\n+        update.insertRight(\n+            instance.getStart(),\n+            printer.printNode(ts.EmitHint.Unspecified, migratedNode, sourceFile));\n+      }\n+    }));\n+\n+    tree.commitUpdate(update);\n+  });\n+}"
        },
        {
            "sha": "3a4efc28e610212e443a002f8da479d760a8d8c5",
            "filename": "packages/core/schematics/migrations/router-preserve-query-params/util.ts",
            "status": "added",
            "additions": 105,
            "deletions": 0,
            "changes": 105,
            "blob_url": "https://github.com/angular/angular/blob/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2Futil.ts?ref=93ee05d92af53dfc9028b14fbe71a1a115387268",
            "patch": "@@ -0,0 +1,105 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript';\n+\n+import {getImportSpecifier} from '../../utils/typescript/imports';\n+import {isReferenceToImport} from '../../utils/typescript/symbol';\n+\n+/**\n+ * Configures the methods that the migration should be looking for\n+ * and the properties from `NavigationExtras` that should be preserved.\n+ */\n+const methodConfig = new Set<string>(['navigate', 'createUrlTree']);\n+\n+const preserveQueryParamsKey = 'preserveQueryParams';\n+\n+export function migrateLiteral(\n+    methodName: string, node: ts.ObjectLiteralExpression): ts.ObjectLiteralExpression {\n+  const isMigratableMethod = methodConfig.has(methodName);\n+\n+  if (!isMigratableMethod) {\n+    throw Error(`Attempting to migrate unconfigured method called ${methodName}.`);\n+  }\n+\n+\n+  const propertiesToKeep: ts.ObjectLiteralElementLike[] = [];\n+  let propertyToMigrate: ts.PropertyAssignment|ts.ShorthandPropertyAssignment|undefined = undefined;\n+\n+  for (const property of node.properties) {\n+    // Only look for regular and shorthand property assignments since resolving things\n+    // like spread operators becomes too complicated for this migration.\n+    if ((ts.isPropertyAssignment(property) || ts.isShorthandPropertyAssignment(property)) &&\n+        (ts.isStringLiteralLike(property.name) || ts.isNumericLiteral(property.name) ||\n+         ts.isIdentifier(property.name)) &&\n+        (property.name.text === preserveQueryParamsKey)) {\n+      propertyToMigrate = property;\n+      continue;\n+    }\n+    propertiesToKeep.push(property);\n+  }\n+\n+  // Don't modify the node if there's nothing to migrate.\n+  if (propertyToMigrate === undefined) {\n+    return node;\n+  }\n+\n+  if ((ts.isShorthandPropertyAssignment(propertyToMigrate) &&\n+       propertyToMigrate.objectAssignmentInitializer?.kind === ts.SyntaxKind.TrueKeyword) ||\n+      (ts.isPropertyAssignment(propertyToMigrate) &&\n+       propertyToMigrate.initializer.kind === ts.SyntaxKind.TrueKeyword)) {\n+    return ts.updateObjectLiteral(\n+        node,\n+        propertiesToKeep.concat(\n+            ts.createPropertyAssignment('queryParamsHandler', ts.createIdentifier(`'preserve'`))));\n+  }\n+\n+  return ts.updateObjectLiteral(node, propertiesToKeep);\n+}\n+\n+export function findLiteralsToMigrate(sourceFile: ts.SourceFile, typeChecker: ts.TypeChecker) {\n+  const results = new Map<string, Set<ts.ObjectLiteralExpression>>(\n+      Array.from(methodConfig.keys(), key => [key, new Set()]));\n+  const routerImport = getImportSpecifier(sourceFile, '@angular/router', 'Router');\n+  const seenLiterals = new Map<ts.ObjectLiteralExpression, string>();\n+\n+  if (routerImport) {\n+    sourceFile.forEachChild(function visitNode(node: ts.Node) {\n+      // Look for calls that look like `foo.<method to migrate>` with more than one parameter.\n+      if (ts.isCallExpression(node) && node.arguments.length > 1 &&\n+          ts.isPropertyAccessExpression(node.expression) && ts.isIdentifier(node.expression.name) &&\n+          methodConfig.has(node.expression.name.text)) {\n+        // Check whether the type of the object on which the\n+        // function is called refers to the Router import.\n+        if (isReferenceToImport(typeChecker, node.expression.expression, routerImport)) {\n+          const methodName = node.expression.name.text;\n+          const parameterDeclaration =\n+              typeChecker.getTypeAtLocation(node.arguments[1]).getSymbol()?.valueDeclaration;\n+\n+          // Find the source of the object literal.\n+          if (parameterDeclaration && ts.isObjectLiteralExpression(parameterDeclaration)) {\n+            if (!seenLiterals.has(parameterDeclaration)) {\n+              results.get(methodName)!.add(parameterDeclaration);\n+              seenLiterals.set(parameterDeclaration, methodName);\n+              // If the same literal has been passed into multiple different methods, we can't\n+              // migrate it, because the supported properties are different. When we detect such\n+              // a case, we drop it from the results so that it gets ignored. If it's used multiple\n+              // times for the same method, it can still be migrated.\n+            } else if (seenLiterals.get(parameterDeclaration) !== methodName) {\n+              results.forEach(literals => literals.delete(parameterDeclaration));\n+            }\n+          }\n+        }\n+      } else {\n+        node.forEachChild(visitNode);\n+      }\n+    });\n+  }\n+\n+  return results;\n+}"
        },
        {
            "sha": "6825f20bda0109963fb933d15b172078c4ec5395",
            "filename": "packages/core/schematics/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel?ref=93ee05d92af53dfc9028b14fbe71a1a115387268",
            "patch": "@@ -17,6 +17,7 @@ ts_library(\n         \"//packages/core/schematics/migrations/navigation-extras-omissions\",\n         \"//packages/core/schematics/migrations/relative-link-resolution\",\n         \"//packages/core/schematics/migrations/renderer-to-renderer2\",\n+        \"//packages/core/schematics/migrations/router-preserve-query-params\",\n         \"//packages/core/schematics/migrations/static-queries\",\n         \"//packages/core/schematics/migrations/template-var-assignment\",\n         \"//packages/core/schematics/migrations/undecorated-classes-with-decorated-fields\","
        },
        {
            "sha": "264fa4aa4b4692bd187cf4c12af0d8b39a544590",
            "filename": "packages/core/schematics/test/preserve_query_params_migration_spec.ts",
            "status": "added",
            "additions": 232,
            "deletions": 0,
            "changes": 232,
            "blob_url": "https://github.com/angular/angular/blob/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Ftest%2Fpreserve_query_params_migration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/93ee05d92af53dfc9028b14fbe71a1a115387268/packages%2Fcore%2Fschematics%2Ftest%2Fpreserve_query_params_migration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Fpreserve_query_params_migration_spec.ts?ref=93ee05d92af53dfc9028b14fbe71a1a115387268",
            "patch": "@@ -0,0 +1,232 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {getSystemPath, normalize, virtualFs} from '@angular-devkit/core';\n+import {TempScopedNodeJsSyncHost} from '@angular-devkit/core/node/testing';\n+import {HostTree} from '@angular-devkit/schematics';\n+import {SchematicTestRunner, UnitTestTree} from '@angular-devkit/schematics/testing';\n+import * as shx from 'shelljs';\n+\n+describe('NavigationExtras preserveQueryParams migration', () => {\n+  let runner: SchematicTestRunner;\n+  let host: TempScopedNodeJsSyncHost;\n+  let tree: UnitTestTree;\n+  let tmpDirPath: string;\n+  let previousWorkingDir: string;\n+\n+  beforeEach(() => {\n+    runner = new SchematicTestRunner('test', require.resolve('../migrations.json'));\n+    host = new TempScopedNodeJsSyncHost();\n+    tree = new UnitTestTree(new HostTree(host));\n+\n+    writeFile('/tsconfig.json', JSON.stringify({\n+      compilerOptions: {\n+        lib: ['es2015'],\n+        strictNullChecks: true,\n+      },\n+    }));\n+    writeFile('/angular.json', JSON.stringify({\n+      projects: {t: {architect: {build: {options: {tsConfig: './tsconfig.json'}}}}}\n+    }));\n+    // We need to declare the Angular symbols we're testing for, otherwise type checking won't work.\n+    writeFile('/node_modules/@angular/router/index.d.ts', `\n+      export declare class Router {\n+        navigate(url: string, extras?: any);\n+        createUrlTree(commands: any[], extras?: any);\n+      }\n+    `);\n+\n+    previousWorkingDir = shx.pwd();\n+    tmpDirPath = getSystemPath(host.root);\n+\n+    // Switch into the temporary directory path. This allows us to run\n+    // the schematic against our custom unit test tree.\n+    shx.cd(tmpDirPath);\n+  });\n+\n+  afterEach(() => {\n+    shx.cd(previousWorkingDir);\n+    shx.rm('-r', tmpDirPath);\n+  });\n+\n+  describe('updates the', () => {\n+    it('`navigate` function', async () => {\n+      writeFile('/index.ts', `\n+      import {Router} from '@angular/router';\n+\n+      class Navigator {\n+        constructor(private _router: Router) {}\n+\n+        goHome() {\n+          this._router.navigate('/', {preserveQueryParams: true});\n+        }\n+      }\n+    `);\n+\n+      await runMigration();\n+\n+      const content = tree.readContent('/index.ts');\n+      expect(content).toContain(`this._router.navigate('/', { queryParamsHandler: 'preserve' });`);\n+    });\n+\n+    it('`createUrlTree` function', async () => {\n+      writeFile('/index.ts', `\n+      import {Router} from '@angular/router';\n+\n+      class Navigator {\n+        constructor(private _router: Router) {}\n+\n+        goHome() {\n+          this._router.createUrlTree('/', {preserveQueryParams: false});\n+        }\n+      }\n+    `);\n+\n+      await runMigration();\n+\n+      const content = tree.readContent('/index.ts');\n+      expect(content).toContain(`this._router.createUrlTree('/', {});`);\n+    });\n+  });\n+\n+  describe('updates an object which is used for the parameter', () => {\n+    it('should migrate when the value is `true`', async () => {\n+      writeFile('/index.ts', `\n+        import {Router} from '@angular/router';\n+\n+        const config = {preserveQueryParams: true, replaceUrl: true, fragment: 'foo', state: {}};\n+\n+        class Navigator {\n+          constructor(private _router: Router) {}\n+\n+          goHome() {\n+            this._router.createUrlTree(['/'], config);\n+          }\n+        }\n+      `);\n+\n+      await runMigration();\n+\n+      const content = tree.readContent('/index.ts');\n+      expect(content).toContain(\n+          `const config = { replaceUrl: true, fragment: 'foo', state: {}, queryParamsHandler: 'preserve' };`);\n+    });\n+\n+    it('should remove when the value is `false`', async () => {\n+      writeFile('/index.ts', `\n+        import {Router} from '@angular/router';\n+\n+        const config = {preserveQueryParams: false, replaceUrl: true, fragment: 'foo', state: {}};\n+\n+        class Navigator {\n+          constructor(private _router: Router) {}\n+\n+          goHome() {\n+            this._router.createUrlTree(['/'], config);\n+          }\n+        }\n+      `);\n+\n+      await runMigration();\n+\n+      const content = tree.readContent('/index.ts');\n+      expect(content).toContain(`const config = { replaceUrl: true, fragment: 'foo', state: {} };`);\n+    });\n+\n+    it('should not modify when the property is no present', async () => {\n+      writeFile('/index.ts', `\n+        import {Router} from '@angular/router';\n+\n+        const config = {replaceUrl: true, fragment: 'foo', state: {}};\n+\n+        class Navigator {\n+          constructor(private _router: Router) {}\n+\n+          goHome() {\n+            this._router.navigate('/', config);\n+          }\n+        }\n+      `);\n+\n+      await runMigration();\n+\n+      const content = tree.readContent('/index.ts');\n+      expect(content).toContain(`const config = {replaceUrl: true, fragment: 'foo', state: {}};`);\n+    });\n+  });\n+\n+  describe('updates an the locally defined parameter in the method', () => {\n+    it('should migrate when the value is `true`', async () => {\n+      writeFile('/index.ts', `\n+        import {Router} from '@angular/router';\n+\n+        class Navigator {\n+          constructor(private _router: Router) {}\n+\n+          goHome() {\n+            this._router.navigate('/', {preserveQueryParams: true, replaceUrl: true, fragment: 'foo', state: {}});\n+          }\n+        }\n+      `);\n+\n+      await runMigration();\n+\n+      const content = tree.readContent('/index.ts');\n+      expect(content).toContain(\n+          `this._router.navigate('/', { replaceUrl: true, fragment: 'foo', state: {}, queryParamsHandler: 'preserve' });`);\n+    });\n+\n+    it('should remove when the value is `false`', async () => {\n+      writeFile('/index.ts', `\n+        import {Router} from '@angular/router';\n+\n+        class Navigator {\n+          constructor(private _router: Router) {}\n+\n+          goHome() {\n+            this._router.createUrlTree(['/'], {preserveQueryParams: false, replaceUrl: true, fragment: 'foo', state: {}};);\n+          }\n+        }\n+      `);\n+\n+      await runMigration();\n+\n+      const content = tree.readContent('/index.ts');\n+      expect(content).toContain(\n+          `this._router.createUrlTree(['/'], { replaceUrl: true, fragment: 'foo', state: {} };`);\n+    });\n+\n+    it('should not modify when the property is not present', async () => {\n+      writeFile('/index.ts', `\n+        import {Router} from '@angular/router';\n+\n+        class Navigator {\n+          constructor(private _router: Router) {}\n+\n+          goHome() {\n+            this._router.navigate('/', {replaceUrl: true, fragment: 'foo', state: {}});\n+          }\n+        }\n+      `);\n+\n+      await runMigration();\n+\n+      const content = tree.readContent('/index.ts');\n+      expect(content).toContain(\n+          `this._router.navigate('/', {replaceUrl: true, fragment: 'foo', state: {}});`);\n+    });\n+  });\n+  function writeFile(filePath: string, contents: string) {\n+    host.sync.write(normalize(filePath), virtualFs.stringToFileBuffer(contents));\n+  }\n+\n+  function runMigration() {\n+    return runner.runSchematicAsync('migration-v11-router-preserve-query-params', {}, tree)\n+        .toPromise();\n+  }\n+});"
        }
    ],
    "stats": {
        "total": 461,
        "additions": 461,
        "deletions": 0
    }
}