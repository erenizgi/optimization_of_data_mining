{
    "author": "JiaLiPassion",
    "message": "fix(zone.js): fesm2015 bundle should also be strict module. (#40456)\n\nClose #40215\n\n`fesm2015/zone.js` is built to `esm` bundle with rollup, so the 'use strict';\nstatement is not generated in the bundle, even we put the 'use strict' in the src code,\nrollup removes the code in the final bundle.\n\nSo if we load the `fesm2015/zone.js` as a module, such as `ng serve`, in the index.html\n\n```\n<script src=\"polyfills.js\" type=\"module\"></script>\n```\n\nEverything works fine, since polyfills.js is loaded as `module`, so it is always `strict`.\n\nBut in `ng test`, webpack concat the `zone.js` and loaded into the karma html. For other app and\n test code, they are still `strict` since they are `module` because they have `export/import`\nstatement, but `zone.js` is a bundle without `export`, it is a `side effect` bundle, so after\n loaded by webpack, it becomes non-strict. Which causes some issues, such as #40215,\nthe root cause is the `this` context should be `undefined` but treated as `Window` in `non-strict` mode.\n\n```\nObject.prototype.toString.apply(undefined);\n// should be [object undefined], but it is [object Window] in non-strict mode.\n\n// zone.js patched version of toString\nObject.prototype.toString = function() {\n  ...\n  // in non-strict mode, this is Window\n  return originalObjectPrototypeToString.call(this);\n}\n\n```\n\nSo in this commit, `'use strict';` is always added to the `esm` bundles.\n\nPR Close #40456",
    "sha": "f35f7c6d3776471dca4e73bf35f0c31361ed5fb6",
    "files": [
        {
            "sha": "60699d7176cacac2136887424b51d569f899c79b",
            "filename": "packages/zone.js/rollup-es5.config.js",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/f35f7c6d3776471dca4e73bf35f0c31361ed5fb6/packages%2Fzone.js%2Frollup-es5.config.js",
            "raw_url": "https://github.com/angular/angular/raw/f35f7c6d3776471dca4e73bf35f0c31361ed5fb6/packages%2Fzone.js%2Frollup-es5.config.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Frollup-es5.config.js?ref=f35f7c6d3776471dca4e73bf35f0c31361ed5fb6",
            "patch": "@@ -14,7 +14,16 @@ if (bazel_stamp_file) {\n   }\n }\n \n-const banner = `/**\n+// Add 'use strict' to the bundle, https://github.com/angular/angular/pull/40456\n+// When rollup build esm bundle of zone.js, there will be no 'use strict'\n+// since all esm bundles are `strict`, but when webpack load the esm bundle,\n+// because zone.js is a module without export and import, webpack is unable\n+// to determine the bundle is `esm` module or not, so it doesn't add the 'use strict'\n+// which webpack does to all other `esm` modules which has export or import.\n+// And it causes issues such as https://github.com/angular/angular/issues/40215\n+// `this` should be `undefined` but is assigned with `Window` instead.\n+const banner = `'use strict';\n+/**\n * @license Angular v${version}\n * (c) 2010-2020 Google LLC. https://angular.io/\n * License: MIT"
        },
        {
            "sha": "c54fd03eea63cb53af588b3dc00db983e2fbb4e4",
            "filename": "packages/zone.js/rollup-es5_global-es2015.config.js",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/f35f7c6d3776471dca4e73bf35f0c31361ed5fb6/packages%2Fzone.js%2Frollup-es5_global-es2015.config.js",
            "raw_url": "https://github.com/angular/angular/raw/f35f7c6d3776471dca4e73bf35f0c31361ed5fb6/packages%2Fzone.js%2Frollup-es5_global-es2015.config.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Frollup-es5_global-es2015.config.js?ref=f35f7c6d3776471dca4e73bf35f0c31361ed5fb6",
            "patch": "@@ -14,7 +14,16 @@ if (bazel_stamp_file) {\n   }\n }\n \n-const banner = `/**\n+// Add 'use strict' to the bundle, https://github.com/angular/angular/pull/40456\n+// When rollup build esm bundle of zone.js, there will be no 'use strict'\n+// since all esm bundles are `strict`, but when webpack load the esm bundle,\n+// because zone.js is a module without export and import, webpack is unable\n+// to determine the bundle is `esm` module or not, so it doesn't add the 'use strict'\n+// which webpack does to all other `esm` modules which has export or import.\n+// And it causes issues such as https://github.com/angular/angular/issues/40215\n+// `this` should be `undefined` but is assigned with `Window` instead.\n+const banner = `'use strict';\n+/**\n * @license Angular v${version}\n * (c) 2010-2020 Google LLC. https://angular.io/\n * License: MIT"
        },
        {
            "sha": "739a622e0093e7afb15dc8fbe34e192d39f5390f",
            "filename": "packages/zone.js/test/npm_package/npm_package.spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/f35f7c6d3776471dca4e73bf35f0c31361ed5fb6/packages%2Fzone.js%2Ftest%2Fnpm_package%2Fnpm_package.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f35f7c6d3776471dca4e73bf35f0c31361ed5fb6/packages%2Fzone.js%2Ftest%2Fnpm_package%2Fnpm_package.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fnpm_package%2Fnpm_package.spec.ts?ref=f35f7c6d3776471dca4e73bf35f0c31361ed5fb6",
            "patch": "@@ -86,6 +86,12 @@ describe('Zone.js npm_package', () => {\n           expect(shx.cat('zone.umd.js')).not.toContain('sourceMappingURL');\n         });\n       });\n+\n+      it('zone.js(es5) should contain use strict', () => {\n+        checkInSubFolder('./bundles', () => {\n+          expect(shx.cat('zone.umd.js')).toMatch(/^\\s*'use strict';/);\n+        });\n+      });\n     });\n \n     describe('es2015', () => {\n@@ -99,6 +105,11 @@ describe('Zone.js npm_package', () => {\n           expect(shx.cat('zone.js')).not.toContain('sourceMappingURL');\n         });\n       });\n+      it('zone.js(es2015) should contain use strict', () => {\n+        checkInSubFolder('./fesm2015', () => {\n+          expect(shx.cat('zone.js')).toMatch(/^\\s*'use strict';/);\n+        });\n+      });\n     });\n \n "
        }
    ],
    "stats": {
        "total": 33,
        "additions": 31,
        "deletions": 2
    }
}