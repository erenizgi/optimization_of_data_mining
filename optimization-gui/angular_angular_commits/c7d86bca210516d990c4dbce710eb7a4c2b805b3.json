{
    "author": "josephperrott",
    "message": "feat(dev-infra): add support for `targetLabelExemptScopes` for merging (#41459)\n\nAdd a property, `targetLabelExemptScopes`, to the merge configuration allowing certain\nscopes to be exempted from requirements for features and breaking changes only included\nin PRs targetting certain labels.\n\nPR Close #41459",
    "sha": "c7d86bca210516d990c4dbce710eb7a4c2b805b3",
    "files": [
        {
            "sha": "fe7ff2bf0576d4212eb66460141355d7e72b949f",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 31,
            "deletions": 18,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/c7d86bca210516d990c4dbce710eb7a4c2b805b3/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/c7d86bca210516d990c4dbce710eb7a4c2b805b3/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=c7d86bca210516d990c4dbce710eb7a4c2b805b3",
            "patch": "@@ -3355,13 +3355,13 @@ var PullRequestFailure = /** @class */ (function () {\n     };\n     PullRequestFailure.hasBreakingChanges = function (label) {\n         var message = \"Cannot merge into branch for \\\"\" + label.pattern + \"\\\" as the pull request has \" +\n-            \"breaking changes.  Breaking changes can only be merged with the \\\"target: major\\\" label.\";\n+            \"breaking changes. Breaking changes can only be merged with the \\\"target: major\\\" label.\";\n         return new this(message);\n     };\n     PullRequestFailure.hasFeatureCommits = function (label) {\n         var message = \"Cannot merge into branch for \\\"\" + label.pattern + \"\\\" as the pull request has \" +\n-            'commits with the \"feat\" type.  New features can only be merged with the \"target: minor\" or ' +\n-            '\"target: major\" label.';\n+            'commits with the \"feat\" type. New features can only be merged with the \"target: minor\" ' +\n+            'or \"target: major\" label.';\n         return new this(message);\n     };\n     return PullRequestFailure;\n@@ -3398,7 +3398,7 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n     var git = _a.git, config = _a.config;\n     if (ignoreNonFatalFailures === void 0) { ignoreNonFatalFailures = false; }\n     return tslib.__awaiter(this, void 0, void 0, function () {\n-        var prData, labels, targetLabel, state, githubTargetBranch, requiredBaseSha, needsCommitMessageFixup, hasCaretakerNote, targetBranches, error_1;\n+        var prData, labels, targetLabel, commitMessages, state, githubTargetBranch, requiredBaseSha, needsCommitMessageFixup, hasCaretakerNote, targetBranches, error_1;\n         return tslib.__generator(this, function (_b) {\n             switch (_b.label) {\n                 case 0: return [4 /*yield*/, fetchPullRequestFromGithub(git, prNumber)];\n@@ -3424,7 +3424,8 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n                         throw error;\n                     }\n                     try {\n-                        assertCorrectTargetForChanges(prData.commits.nodes.map(function (n) { return n.commit.message; }), targetLabel);\n+                        commitMessages = prData.commits.nodes.map(function (n) { return n.commit.message; });\n+                        assertChangesAllowForTargetLabel(commitMessages, targetLabel, config);\n                     }\n                     catch (error) {\n                         return [2 /*return*/, error];\n@@ -3465,17 +3466,20 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n                         hasCaretakerNote: hasCaretakerNote,\n                         targetBranches: targetBranches,\n                         title: prData.title,\n-                        commitCount: prData.commits.nodes.length,\n+                        commitCount: prData.commits.totalCount,\n                     }];\n             }\n         });\n     });\n }\n-/* GraphQL schema for the response body the requested PR. */\n+/* GraphQL schema for the response body the requested pull request. */\n var PR_SCHEMA$2 = {\n     url: typedGraphqlify.types.string,\n     number: typedGraphqlify.types.number,\n-    commits: typedGraphqlify.params({ first: 100 }, {\n+    // Only the last 100 commits from a pull request are obtained as we likely will never see a pull\n+    // requests with more than 100 commits.\n+    commits: typedGraphqlify.params({ last: 100 }, {\n+        totalCount: typedGraphqlify.types.number,\n         nodes: [{\n                 commit: {\n                     status: {\n@@ -3496,13 +3500,15 @@ var PR_SCHEMA$2 = {\n /** Fetches a pull request from Github. Returns null if an error occurred. */\n function fetchPullRequestFromGithub(git, prNumber) {\n     return tslib.__awaiter(this, void 0, void 0, function () {\n-        var e_1;\n+        var x, e_1;\n         return tslib.__generator(this, function (_a) {\n             switch (_a.label) {\n                 case 0:\n                     _a.trys.push([0, 2, , 3]);\n                     return [4 /*yield*/, getPr(PR_SCHEMA$2, prNumber, git)];\n-                case 1: return [2 /*return*/, _a.sent()];\n+                case 1:\n+                    x = _a.sent();\n+                    return [2 /*return*/, x];\n                 case 2:\n                     e_1 = _a.sent();\n                     // If the pull request could not be found, we want to return `null` so\n@@ -3524,32 +3530,39 @@ function isPullRequest(v) {\n  * Assert the commits provided are allowed to merge to the provided target label, throwing a\n  * PullRequestFailure otherwise.\n  */\n-function assertCorrectTargetForChanges(rawCommits, label) {\n-    /** List of ParsedCommits for all of the commits in the pull request. */\n-    var commits = rawCommits.map(parseCommitMessage);\n+function assertChangesAllowForTargetLabel(rawCommits, label, config) {\n+    /**\n+     * List of commit scopes which are exempted from target label content requirements. i.e. no `feat`\n+     * scopes in patch branches, no breaking changes in minor or patch changes.\n+     */\n+    var exemptedScopes = config.targetLabelExemptScopes || [];\n+    /** List of parsed commits which are subject to content requirements for the target label. */\n+    var commits = rawCommits.map(parseCommitMessage).filter(function (commit) {\n+        return !exemptedScopes.includes(commit.scope);\n+    });\n     switch (label.pattern) {\n         case 'target: major':\n             break;\n         case 'target: minor':\n-            // Check if any commits in the PR contains a breaking change.\n+            // Check if any commits in the pull request contains a breaking change.\n             if (commits.some(function (commit) { return commit.breakingChanges.length !== 0; })) {\n                 throw PullRequestFailure.hasBreakingChanges(label);\n             }\n             break;\n         case 'target: patch':\n         case 'target: lts':\n-            // Check if any commits in the PR contains a breaking change.\n+            // Check if any commits in the pull request contains a breaking change.\n             if (commits.some(function (commit) { return commit.breakingChanges.length !== 0; })) {\n                 throw PullRequestFailure.hasBreakingChanges(label);\n             }\n-            // Check if any commits in the PR contains a commit type of \"feat\".\n+            // Check if any commits in the pull request contains a commit type of \"feat\".\n             if (commits.some(function (commit) { return commit.type === 'feat'; })) {\n                 throw PullRequestFailure.hasFeatureCommits(label);\n             }\n             break;\n         default:\n-            warn(red('WARNING: Unable to confirm all commits in the PR are eligible to be merged'));\n-            warn(red(\"into the target branch: \" + label.pattern));\n+            warn(red('WARNING: Unable to confirm all commits in the pull request are eligible to be'));\n+            warn(red(\"merged into the target branch: \" + label.pattern));\n             break;\n     }\n }"
        },
        {
            "sha": "03cea76aaaf993a9fabcaf5757656a366ddf0e13",
            "filename": "dev-infra/pr/merge/config.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/c7d86bca210516d990c4dbce710eb7a4c2b805b3/dev-infra%2Fpr%2Fmerge%2Fconfig.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7d86bca210516d990c4dbce710eb7a4c2b805b3/dev-infra%2Fpr%2Fmerge%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fconfig.ts?ref=c7d86bca210516d990c4dbce710eb7a4c2b805b3",
            "patch": "@@ -71,6 +71,11 @@ export interface MergeConfig {\n    * not support this.\n    */\n   githubApiMerge: false|GithubApiMergeStrategyConfig;\n+  /**\n+   * List of commit scopes which are exempted from target label content requirements. i.e. no `feat`\n+   * scopes in patch branches, no breaking changes in minor or patch changes.\n+   */\n+  targetLabelExemptScopes?: string[];\n }\n \n /**"
        },
        {
            "sha": "01aa6ae2eeaf6bf3baf215e0a470349345fabaa1",
            "filename": "dev-infra/pr/merge/failures.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c7d86bca210516d990c4dbce710eb7a4c2b805b3/dev-infra%2Fpr%2Fmerge%2Ffailures.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7d86bca210516d990c4dbce710eb7a4c2b805b3/dev-infra%2Fpr%2Fmerge%2Ffailures.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ffailures.ts?ref=c7d86bca210516d990c4dbce710eb7a4c2b805b3",
            "patch": "@@ -77,13 +77,13 @@ export class PullRequestFailure {\n \n   static hasBreakingChanges(label: TargetLabel) {\n     const message = `Cannot merge into branch for \"${label.pattern}\" as the pull request has ` +\n-        `breaking changes.  Breaking changes can only be merged with the \"target: major\" label.`;\n+        `breaking changes. Breaking changes can only be merged with the \"target: major\" label.`;\n     return new this(message);\n   }\n \n   static hasFeatureCommits(label: TargetLabel) {\n     const message = `Cannot merge into branch for \"${label.pattern}\" as the pull request has ` +\n-        'commits with the \"feat\" type.  New features can only be merged with the \"target: minor\" ' +\n+        'commits with the \"feat\" type. New features can only be merged with the \"target: minor\" ' +\n         'or \"target: major\" label.';\n     return new this(message);\n   }"
        },
        {
            "sha": "4b80a543c4ed5d6e646b79efb03879b8e591cf54",
            "filename": "dev-infra/pr/merge/pull-request.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 14,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/c7d86bca210516d990c4dbce710eb7a4c2b805b3/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7d86bca210516d990c4dbce710eb7a4c2b805b3/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts?ref=c7d86bca210516d990c4dbce710eb7a4c2b805b3",
            "patch": "@@ -12,7 +12,7 @@ import {red, warn} from '../../utils/console';\n \n import {GitClient} from '../../utils/git/index';\n import {getPr} from '../../utils/github';\n-import {TargetLabel} from './config';\n+import {MergeConfig, TargetLabel} from './config';\n \n import {PullRequestFailure} from './failures';\n import {matchesPattern} from './string-pattern';\n@@ -76,11 +76,14 @@ export async function loadAndValidatePullRequest(\n   }\n \n   try {\n-    assertCorrectTargetForChanges(prData.commits.nodes.map(n => n.commit.message), targetLabel);\n+    /** Commit message strings for all commits in the pull request. */\n+    const commitMessages = prData.commits.nodes.map(n => n.commit.message);\n+    assertChangesAllowForTargetLabel(commitMessages, targetLabel, config);\n   } catch (error) {\n     return error;\n   }\n \n+  /** The combined status of the latest commit in the pull request. */\n   const state = prData.commits.nodes.slice(-1)[0].commit.status.state;\n   if (state === 'FAILURE' && !ignoreNonFatalFailures) {\n     return PullRequestFailure.failingCiJobs();\n@@ -121,15 +124,18 @@ export async function loadAndValidatePullRequest(\n     hasCaretakerNote,\n     targetBranches,\n     title: prData.title,\n-    commitCount: prData.commits.nodes.length,\n+    commitCount: prData.commits.totalCount,\n   };\n }\n \n-/* GraphQL schema for the response body the requested PR. */\n+/* GraphQL schema for the response body the requested pull request. */\n const PR_SCHEMA = {\n   url: graphQLTypes.string,\n   number: graphQLTypes.number,\n-  commits: params({first: 100}, {\n+  // Only the last 100 commits from a pull request are obtained as we likely will never see a pull\n+  // requests with more than 100 commits.\n+  commits: params({last: 100}, {\n+    totalCount: graphQLTypes.number,\n     nodes: [{\n       commit: {\n         status: {\n@@ -154,7 +160,8 @@ const PR_SCHEMA = {\n async function fetchPullRequestFromGithub(\n     git: GitClient, prNumber: number): Promise<typeof PR_SCHEMA|null> {\n   try {\n-    return await getPr(PR_SCHEMA, prNumber, git);\n+    const x = await getPr(PR_SCHEMA, prNumber, git);\n+    return x;\n   } catch (e) {\n     // If the pull request could not be found, we want to return `null` so\n     // that the error can be handled gracefully.\n@@ -174,32 +181,40 @@ export function isPullRequest(v: PullRequestFailure|PullRequest): v is PullReque\n  * Assert the commits provided are allowed to merge to the provided target label, throwing a\n  * PullRequestFailure otherwise.\n  */\n-function assertCorrectTargetForChanges(rawCommits: string[], label: TargetLabel) {\n-  /** List of ParsedCommits for all of the commits in the pull request. */\n-  const commits = rawCommits.map(parseCommitMessage);\n+function assertChangesAllowForTargetLabel(\n+    rawCommits: string[], label: TargetLabel, config: MergeConfig) {\n+  /**\n+   * List of commit scopes which are exempted from target label content requirements. i.e. no `feat`\n+   * scopes in patch branches, no breaking changes in minor or patch changes.\n+   */\n+  const exemptedScopes = config.targetLabelExemptScopes || [];\n+  /** List of parsed commits which are subject to content requirements for the target label. */\n+  let commits = rawCommits.map(parseCommitMessage).filter(commit => {\n+    return !exemptedScopes.includes(commit.scope);\n+  });\n   switch (label.pattern) {\n     case 'target: major':\n       break;\n     case 'target: minor':\n-      // Check if any commits in the PR contains a breaking change.\n+      // Check if any commits in the pull request contains a breaking change.\n       if (commits.some(commit => commit.breakingChanges.length !== 0)) {\n         throw PullRequestFailure.hasBreakingChanges(label);\n       }\n       break;\n     case 'target: patch':\n     case 'target: lts':\n-      // Check if any commits in the PR contains a breaking change.\n+      // Check if any commits in the pull request contains a breaking change.\n       if (commits.some(commit => commit.breakingChanges.length !== 0)) {\n         throw PullRequestFailure.hasBreakingChanges(label);\n       }\n-      // Check if any commits in the PR contains a commit type of \"feat\".\n+      // Check if any commits in the pull request contains a commit type of \"feat\".\n       if (commits.some(commit => commit.type === 'feat')) {\n         throw PullRequestFailure.hasFeatureCommits(label);\n       }\n       break;\n     default:\n-      warn(red('WARNING: Unable to confirm all commits in the PR are eligible to be merged'));\n-      warn(red(`into the target branch: ${label.pattern}`));\n+      warn(red('WARNING: Unable to confirm all commits in the pull request are eligible to be'));\n+      warn(red(`merged into the target branch: ${label.pattern}`));\n       break;\n   }\n }"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 67,
        "deletions": 34
    }
}