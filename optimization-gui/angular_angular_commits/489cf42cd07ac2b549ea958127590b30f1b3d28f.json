{
    "author": "devversion",
    "message": "fix(common): incorrect error type for XHR errors in `TestRequest` (#36082)\n\nCurrently the `HttpClient` always wraps errors from XHR requests, but\nthe underlying errors are always of type `ProgressEvent`, or don't have\na native error if the status code is just indicating failure (e.g. 404).\n\nThis behavior does not match in the `TestRequest` class provided by\n`@angular/common/http/testing` where errors are considered being\nof type `ErrorEvent`. This is incorrect because `ErrorEvent`s provide\ninformation for errors in scripts or files which are evaluated. Since\nthe `HttpClient` never evaluates scripts/files, and also since XHR requests\nclearly are documented to emit `ProgressEvent`'s, we should change the\n`TestSupport` to retrieve such `ProgressEvent`'s instead of incompatible\nobjects of type `ErrorEvent`.\n\nIn favor of having a deprecation period, we keep supporting `ErrorEvent`\nin the `TestRequest.error` signature. Eventually, we can remove this\nsignature in the future.\n\nResources:\n  * https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/error_event\n  * https://developer.mozilla.org/en-US/docs/Web/API/ErrorEvent\n  * https://xhr.spec.whatwg.org/#event-xhr-errpr\n\nRelated to: https://github.com/angular/angular/issues/34748.\n\nDEPRECATED: `TestRequest` from `@angular/common/http/testing` no longer\naccepts `ErrorEvent` when simulating XHR errors. Instead instances of\n`ProgressEvent` should be passed, matching with the native browser behavior.\n\nPR Close #36082",
    "sha": "489cf42cd07ac2b549ea958127590b30f1b3d28f",
    "files": [
        {
            "sha": "50605ac08e7429ae4645e54cc022941cf6b38647",
            "filename": "aio/content/examples/http/src/testing/http-client.spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 16,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/489cf42cd07ac2b549ea958127590b30f1b3d28f/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Ftesting%2Fhttp-client.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/489cf42cd07ac2b549ea958127590b30f1b3d28f/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Ftesting%2Fhttp-client.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Ftesting%2Fhttp-client.spec.ts?ref=489cf42cd07ac2b549ea958127590b30f1b3d28f",
            "patch": "@@ -137,31 +137,21 @@ describe('HttpClient testing', () => {\n   // #enddocregion 404\n \n   // #docregion network-error\n-  it('can test for network error', () => {\n-    const emsg = 'simulated network error';\n+  it('can test for network error', done => {\n+    // Create mock ProgressEvent with type `error`, raised when something goes wrong\n+    // at network level. e.g. Connection timeout, DNS error, offline, etc.\n+    const mockError = new ProgressEvent('error');\n \n     httpClient.get<Data[]>(testUrl).subscribe(\n       data => fail('should have failed with the network error'),\n       (error: HttpErrorResponse) => {\n-        expect(error.error.message).toEqual(emsg, 'message');\n+        expect(error.error).toBe(mockError);\n+        done();\n       }\n     );\n \n     const req = httpTestingController.expectOne(testUrl);\n \n-    // Create mock ErrorEvent, raised when something goes wrong at the network level.\n-    // Connection timeout, DNS error, offline, etc\n-    const mockError = new ErrorEvent('Network error', {\n-      message: emsg,\n-      // #enddocregion network-error\n-      // The rest of this is optional and not used.\n-      // Just showing that you could provide this too.\n-      filename: 'HeroService.ts',\n-      lineno: 42,\n-      colno: 21\n-    // #docregion network-error\n-    });\n-\n     // Respond with mock error\n     req.error(mockError);\n   });"
        },
        {
            "sha": "90384c3808e7b74df3eb0dbedae233e95ab6d0c7",
            "filename": "aio/content/examples/testing/src/app/model/hero.service.spec.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 14,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/489cf42cd07ac2b549ea958127590b30f1b3d28f/aio%2Fcontent%2Fexamples%2Ftesting%2Fsrc%2Fapp%2Fmodel%2Fhero.service.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/489cf42cd07ac2b549ea958127590b30f1b3d28f/aio%2Fcontent%2Fexamples%2Ftesting%2Fsrc%2Fapp%2Fmodel%2Fhero.service.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Ftesting%2Fsrc%2Fapp%2Fmodel%2Fhero.service.spec.ts?ref=489cf42cd07ac2b549ea958127590b30f1b3d28f",
            "patch": "@@ -186,28 +186,22 @@ describe('HeroesService (with mocks)', () => {\n       req.flush(msg, {status: 404, statusText: 'Not Found'});\n     });\n \n-    it('should turn network error into user-facing error', () => {\n-      const emsg = 'simulated network error';\n+    it('should turn network error into user-facing error', done => {\n+      // Create mock ProgressEvent with type `error`, raised when something goes wrong at\n+      // the network level. Connection timeout, DNS error, offline, etc.\n+      const errorEvent = new ProgressEvent('error');\n \n       const updateHero: Hero = { id: 1, name: 'A' };\n       heroService.updateHero(updateHero).subscribe(\n         heroes => fail('expected to fail'),\n-        error => expect(error.message).toContain(emsg)\n+        error => {\n+          expect(error).toBe(errorEvent);\n+          done();\n+        }\n       );\n \n       const req = httpTestingController.expectOne(heroService.heroesUrl);\n \n-      // Create mock ErrorEvent, raised when something goes wrong at the network level.\n-      // Connection timeout, DNS error, offline, etc\n-      const errorEvent = new ErrorEvent('so sad', {\n-        message: emsg,\n-        // The rest of this is optional and not used.\n-        // Just showing that you could provide this too.\n-        filename: 'HeroService.ts',\n-        lineno: 42,\n-        colno: 21\n-      });\n-\n       // Respond with mock error\n       req.error(errorEvent);\n     });"
        },
        {
            "sha": "9d8a8a1a033447e90dfa9a032e336bd3fc9b9e2f",
            "filename": "aio/content/examples/testing/src/app/model/hero.service.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/489cf42cd07ac2b549ea958127590b30f1b3d28f/aio%2Fcontent%2Fexamples%2Ftesting%2Fsrc%2Fapp%2Fmodel%2Fhero.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/489cf42cd07ac2b549ea958127590b30f1b3d28f/aio%2Fcontent%2Fexamples%2Ftesting%2Fsrc%2Fapp%2Fmodel%2Fhero.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Ftesting%2Fsrc%2Fapp%2Fmodel%2Fhero.service.ts?ref=489cf42cd07ac2b549ea958127590b30f1b3d28f",
            "patch": "@@ -81,10 +81,13 @@ export class HeroService {\n       // TODO: send the error to remote logging infrastructure\n       console.error(error); // log to console instead\n \n-      const message = (error.error instanceof ErrorEvent) ?\n-        error.error.message :\n-       `server returned code ${error.status} with body \"${error.error}\"`;\n+      // If a native error is caught, do not transform it. We only want to\n+      // transform response errors that are not wrapped in an `Error`.\n+      if (error.error instanceof Event) {\n+        throw error.error;\n+      }\n \n+      const message = `server returned code ${error.status} with body \"${error.error}\"`;\n       // TODO: better job of transforming error for user consumption\n       throw new Error(`${operation} failed: ${message}`);\n     };"
        },
        {
            "sha": "3b1fccbf369f98a484949562982fa24fe9a04758",
            "filename": "aio/content/examples/testing/src/app/model/testing/http-client.spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 14,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/489cf42cd07ac2b549ea958127590b30f1b3d28f/aio%2Fcontent%2Fexamples%2Ftesting%2Fsrc%2Fapp%2Fmodel%2Ftesting%2Fhttp-client.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/489cf42cd07ac2b549ea958127590b30f1b3d28f/aio%2Fcontent%2Fexamples%2Ftesting%2Fsrc%2Fapp%2Fmodel%2Ftesting%2Fhttp-client.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Ftesting%2Fsrc%2Fapp%2Fmodel%2Ftesting%2Fhttp-client.spec.ts?ref=489cf42cd07ac2b549ea958127590b30f1b3d28f",
            "patch": "@@ -121,29 +121,21 @@ describe('HttpClient testing', () => {\n     req.flush(emsg, { status: 404, statusText: 'Not Found' });\n   });\n \n-  it('can test for network error', () => {\n-    const emsg = 'simulated network error';\n+  it('can test for network error', done => {\n+    // Create mock ProgressEvent with type `error`, raised when something goes wrong at\n+    // the network level. Connection timeout, DNS error, offline, etc.\n+    const errorEvent = new ProgressEvent('error');\n \n     httpClient.get<Data[]>(testUrl).subscribe(\n       data => fail('should have failed with the network error'),\n       (error: HttpErrorResponse) => {\n-        expect(error.error.message).toEqual(emsg, 'message');\n+        expect(error.error).toBe(errorEvent);\n+        done();\n       }\n     );\n \n     const req = httpTestingController.expectOne(testUrl);\n \n-    // Create mock ErrorEvent, raised when something goes wrong at the network level.\n-    // Connection timeout, DNS error, offline, etc\n-    const errorEvent = new ErrorEvent('so sad', {\n-      message: emsg,\n-      // The rest of this is optional and not used.\n-      // Just showing that you could provide this too.\n-      filename: 'HeroService.ts',\n-      lineno: 42,\n-      colno: 21\n-    });\n-\n     // Respond with mock error\n     req.error(errorEvent);\n   });"
        },
        {
            "sha": "db4d05a9cd47e2967aa6da9f7cb70e11299a9be0",
            "filename": "aio/content/guide/deprecations.md",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/489cf42cd07ac2b549ea958127590b30f1b3d28f/aio%2Fcontent%2Fguide%2Fdeprecations.md",
            "raw_url": "https://github.com/angular/angular/raw/489cf42cd07ac2b549ea958127590b30f1b3d28f/aio%2Fcontent%2Fguide%2Fdeprecations.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fdeprecations.md?ref=489cf42cd07ac2b549ea958127590b30f1b3d28f",
            "patch": "@@ -38,6 +38,7 @@ v13 -> v16\n | `@angular/common`                   | [`ReflectiveInjector`](#reflectiveinjector)                                                                | <!--v8--> v11         |\n | `@angular/common`                   | [`CurrencyPipe` - `DEFAULT_CURRENCY_CODE`](api/common/CurrencyPipe#currency-code-deprecation)              | <!--v9--> v11         |\n | `@angular/common/http`              | [`XhrFactory`](api/common/http/XhrFactory)                                                                 | <!--v12--> v15        |\n+| `@angular/common/http/testing`      | [`TestRequest` accepting `ErrorEvent` for error simulation](#testrequest-errorevent)                       | <!--v13--> v16        |\n | `@angular/core`                     | [`DefaultIterableDiffer`](#core)                                                                           | <!--v7--> v11         |\n | `@angular/core`                     | [`ReflectiveKey`](#core)                                                                                   | <!--v8--> v11         |\n | `@angular/core`                     | [`RenderComponentType`](#core)                                                                             | <!--v7--> v11         |\n@@ -469,6 +470,26 @@ In ViewEngine, [JIT compilation](https://angular.io/guide/glossary#jit) required\n \n Important note: this deprecation doesn't affect JIT mode in Ivy (JIT remains available with Ivy, however we are exploring a possibility of deprecating it in the future. See [RFC: Exploration of use-cases for Angular JIT compilation mode](https://github.com/angular/angular/issues/43133)).\n \n+{@a testrequest-errorevent}\n+\n+### `TestRequest` accepting `ErrorEvent`\n+\n+Angular provides utilities for testing `HttpClient`. The `TestRequest` class from\n+`@angular/common/http/testing` mocks HTTP request objects for use with `HttpTestingController`.\n+\n+`TestRequest` provides an API for simulating an HTTP response with an error. In earlier versions\n+of Angular, this API accepted objects of type `ErrorEvent`, which does not match the type of\n+error event that browsers return natively. If you use `ErrorEvent` with `TestRequest`,\n+you should switch to `ProgressEvent`.\n+\n+Here is an example using a `ProgressEvent`:\n+\n+```ts\n+const mockError = new ProgressEvent('error');\n+const mockRequest = httpTestingController.expectOne(..);\n+\n+mockRequest.error(mockError);\n+```\n \n {@a deprecated-cli-flags}\n "
        },
        {
            "sha": "1b21c819a0d1569805f88b9e57bb33c8f22704cd",
            "filename": "goldens/public-api/common/http/testing/testing.md",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/489cf42cd07ac2b549ea958127590b30f1b3d28f/goldens%2Fpublic-api%2Fcommon%2Fhttp%2Ftesting%2Ftesting.md",
            "raw_url": "https://github.com/angular/angular/raw/489cf42cd07ac2b549ea958127590b30f1b3d28f/goldens%2Fpublic-api%2Fcommon%2Fhttp%2Ftesting%2Ftesting.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcommon%2Fhttp%2Ftesting%2Ftesting.md?ref=489cf42cd07ac2b549ea958127590b30f1b3d28f",
            "patch": "@@ -49,13 +49,9 @@ export interface RequestMatch {\n export class TestRequest {\n     constructor(request: HttpRequest<any>, observer: Observer<HttpEvent<any>>);\n     get cancelled(): boolean;\n-    error(error: ErrorEvent, opts?: {\n-        headers?: HttpHeaders | {\n-            [name: string]: string | string[];\n-        };\n-        status?: number;\n-        statusText?: string;\n-    }): void;\n+    // @deprecated\n+    error(error: ErrorEvent, opts?: TestRequestErrorOptions): void;\n+    error(error: ProgressEvent, opts?: TestRequestErrorOptions): void;\n     event(event: HttpEvent<any>): void;\n     flush(body: ArrayBuffer | Blob | boolean | string | number | Object | (boolean | string | number | Object | null)[] | null, opts?: {\n         headers?: HttpHeaders | {"
        },
        {
            "sha": "edfaa4aa41793cc54a1da5c6cd5f5e96cb6f9e3b",
            "filename": "packages/common/http/test/xhr_mock.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/489cf42cd07ac2b549ea958127590b30f1b3d28f/packages%2Fcommon%2Fhttp%2Ftest%2Fxhr_mock.ts",
            "raw_url": "https://github.com/angular/angular/raw/489cf42cd07ac2b549ea958127590b30f1b3d28f/packages%2Fcommon%2Fhttp%2Ftest%2Fxhr_mock.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fhttp%2Ftest%2Fxhr_mock.ts?ref=489cf42cd07ac2b549ea958127590b30f1b3d28f",
            "patch": "@@ -53,8 +53,8 @@ export class MockXMLHttpRequest {\n   mockResponseHeaders: string = '';\n \n   listeners: {\n-    error?: (event: ErrorEvent) => void,\n-    timeout?: (event: ErrorEvent) => void,\n+    error?: (event: ProgressEvent) => void,\n+    timeout?: (event: ProgressEvent) => void,\n     abort?: () => void,\n     load?: () => void,\n     progress?: (event: ProgressEvent) => void,"
        },
        {
            "sha": "38067641d449f67f24b9c545764f70b8e9352218",
            "filename": "packages/common/http/testing/src/request.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/489cf42cd07ac2b549ea958127590b30f1b3d28f/packages%2Fcommon%2Fhttp%2Ftesting%2Fsrc%2Frequest.ts",
            "raw_url": "https://github.com/angular/angular/raw/489cf42cd07ac2b549ea958127590b30f1b3d28f/packages%2Fcommon%2Fhttp%2Ftesting%2Fsrc%2Frequest.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fhttp%2Ftesting%2Fsrc%2Frequest.ts?ref=489cf42cd07ac2b549ea958127590b30f1b3d28f",
            "patch": "@@ -9,6 +9,16 @@\n import {HttpErrorResponse, HttpEvent, HttpHeaders, HttpRequest, HttpResponse, HttpStatusCode} from '@angular/common/http';\n import {Observer} from 'rxjs';\n \n+/**\n+ * Type that describes options that can be used to create an error\n+ * in `TestRequest`.\n+ */\n+type TestRequestErrorOptions = {\n+  headers?: HttpHeaders|{[name: string]: string | string[]},\n+  status?: number,\n+  statusText?: string,\n+};\n+\n /**\n  * A mock requests that was received and is ready to be answered.\n  *\n@@ -78,12 +88,14 @@ export class TestRequest {\n \n   /**\n    * Resolve the request by returning an `ErrorEvent` (e.g. simulating a network failure).\n+   * @deprecated Http requests never emit an `ErrorEvent`. Please specify a `ProgressEvent`.\n+   */\n+  error(error: ErrorEvent, opts?: TestRequestErrorOptions): void;\n+  /**\n+   * Resolve the request by returning an `ProgressEvent` (e.g. simulating a network failure).\n    */\n-  error(error: ErrorEvent, opts: {\n-    headers?: HttpHeaders|{[name: string]: string | string[]},\n-    status?: number,\n-    statusText?: string,\n-  } = {}): void {\n+  error(error: ProgressEvent, opts?: TestRequestErrorOptions): void;\n+  error(error: ProgressEvent|ErrorEvent, opts: TestRequestErrorOptions = {}): void {\n     if (this.cancelled) {\n       throw new Error(`Cannot return an error for a cancelled request.`);\n     }"
        }
    ],
    "stats": {
        "total": 130,
        "additions": 69,
        "deletions": 61
    }
}