{
    "author": "devversion",
    "message": "feat(bazel): allow for custom conditions to be set in `ng_package` targets (#43764)\n\nThe APF v13 `ng_package` rule will generate the `exports` field if not\nset. Currently it allows for additional subpath entries to be configured\nmanually. The packager does not allow for custom conditions in subpath\nexports which are auto-generated.\n\nThis is sometimes useful and necessary though. e.g. in Angular Material,\nwe also need to expose the index Sass file through a `sass` conditional\nthat the Webpack Sass loader will pick up. For this, the packager needs\nto support manual additional conditions (as long as they do not\nconflict).\n\nPR Close #43764",
    "sha": "e0667efa6eada64d1fb8b143840689090fc82e52",
    "files": [
        {
            "sha": "4305a46a63af99555dc2207b20a3b339b7a54070",
            "filename": "packages/bazel/src/ng_package/packager.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 7,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/e0667efa6eada64d1fb8b143840689090fc82e52/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0667efa6eada64d1fb8b143840689090fc82e52/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts?ref=e0667efa6eada64d1fb8b143840689090fc82e52",
            "patch": "@@ -467,17 +467,29 @@ function main(args: string[]): void {\n    */\n   function insertExportMappingOrError(\n       packageJson: PackageJson, subpath: string, mapping: ConditionalExport) {\n-    if (packageJson.exports?.[subpath] !== undefined) {\n-      throw Error(\n-          'Found a conflicting subpath export in the `package.json` file that would be overridden by the ' +\n-          `packager. Please unset the mapping for: \"${subpath}\".`);\n-    }\n-\n     if (packageJson.exports === undefined) {\n       packageJson.exports = {};\n     }\n+    if (packageJson.exports[subpath] === undefined) {\n+      packageJson.exports[subpath] = {};\n+    }\n+\n+    const subpathExport = packageJson.exports[subpath];\n \n-    packageJson.exports[subpath] = mapping;\n+    // Go through all conditions that should be inserted. If the condition is already\n+    // manually set of the subpath export, we throw an error. In general, we allow for\n+    // additional conditions to be set. These will always precede the generated ones.\n+    for (const conditionName of Object.keys(mapping) as [keyof ConditionalExport]) {\n+      if (subpathExport[conditionName] !== undefined) {\n+        throw Error(\n+            `Found a conflicting export condition for \"${subpath}\". The \"${conditionName} ` +\n+            `condition would be overridden by the packager. Please unset it.`);\n+      }\n+\n+      // **Note**: The order of the conditions is preserved even though we are setting\n+      // the conditions once at a time (the latest assignment will be at the end).\n+      subpathExport[conditionName] = mapping[conditionName];\n+    }\n   }\n \n   /** Whether the package explicitly sets any of the format properties (like `main`). */"
        },
        {
            "sha": "d805a80a023297bfd88e837abb2eee468e122f2c",
            "filename": "packages/bazel/test/ng_package/example/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/e0667efa6eada64d1fb8b143840689090fc82e52/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e0667efa6eada64d1fb8b143840689090fc82e52/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2FBUILD.bazel?ref=e0667efa6eada64d1fb8b143840689090fc82e52",
            "patch": "@@ -15,6 +15,7 @@ ng_module(\n ng_package(\n     name = \"npm_package\",\n     srcs = [\n+        \"_index.scss\",\n         \"package.json\",\n         \"some-file.txt\",\n     ],"
        },
        {
            "sha": "78b61b73692430d0b5ca9c21cc0c90e2b5a73194",
            "filename": "packages/bazel/test/ng_package/example/_index.scss",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/e0667efa6eada64d1fb8b143840689090fc82e52/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2F_index.scss",
            "raw_url": "https://github.com/angular/angular/raw/e0667efa6eada64d1fb8b143840689090fc82e52/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2F_index.scss",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2F_index.scss?ref=e0667efa6eada64d1fb8b143840689090fc82e52",
            "patch": "@@ -0,0 +1 @@\n+/// test file which should ship as part of the NPM package."
        },
        {
            "sha": "1414ea86d1817063dadf543990256a28781c1fe1",
            "filename": "packages/bazel/test/ng_package/example/package.json",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/e0667efa6eada64d1fb8b143840689090fc82e52/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/e0667efa6eada64d1fb8b143840689090fc82e52/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fexample%2Fpackage.json?ref=e0667efa6eada64d1fb8b143840689090fc82e52",
            "patch": "@@ -1,4 +1,9 @@\n {\n   \"name\": \"example\",\n-  \"version\": \"0.0.0-PLACEHOLDER\"\n-}\n\\ No newline at end of file\n+  \"version\": \"0.0.0-PLACEHOLDER\",\n+  \"exports\": {\n+    \".\": {\n+      \"sass\": \"./_index.scss\"\n+    }\n+  }\n+}"
        },
        {
            "sha": "2b42f76dab88e754d655ccd6fc87f6e0e7310238",
            "filename": "packages/bazel/test/ng_package/example_package.golden",
            "status": "modified",
            "additions": 18,
            "deletions": 11,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/e0667efa6eada64d1fb8b143840689090fc82e52/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_package.golden",
            "raw_url": "https://github.com/angular/angular/raw/e0667efa6eada64d1fb8b143840689090fc82e52/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_package.golden",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_package.golden?ref=e0667efa6eada64d1fb8b143840689090fc82e52",
            "patch": "@@ -1,4 +1,5 @@\n README.md\n+_index.scss\n a11y\n   a11y/a11y.d.ts\n   a11y/package.json\n@@ -63,6 +64,11 @@ Usage information and reference details can be found in [Angular documentation](\n License: MIT\n \n \n+--- _index.scss ---\n+\n+/// test file which should ship as part of the NPM package.\n+\n+\n --- a11y/a11y.d.ts ---\n \n /**\n@@ -773,25 +779,19 @@ export { }\n {\n   \"name\": \"example\",\n   \"version\": \"0.0.0\",\n-  \"fesm2020\": \"./fesm2020/waffels.mjs\",\n-  \"fesm2015\": \"./fesm2015/waffels.mjs\",\n-  \"esm2020\": \"./esm2020/example.mjs\",\n-  \"typings\": \"./example.d.ts\",\n-  \"module\": \"./fesm2015/waffels.mjs\",\n-  \"es2020\": \"./fesm2020/waffels.mjs\",\n-  \"type\": \"module\",\n   \"exports\": {\n-    \"./package.json\": {\n-      \"default\": \"./package.json\"\n-    },\n     \".\": {\n+      \"sass\": \"./_index.scss\",\n       \"types\": \"./example.d.ts\",\n       \"esm2020\": \"./esm2020/example.mjs\",\n       \"es2020\": \"./fesm2020/waffels.mjs\",\n       \"es2015\": \"./fesm2015/waffels.mjs\",\n       \"node\": \"./fesm2015/waffels.mjs\",\n       \"default\": \"./fesm2020/waffels.mjs\"\n     },\n+    \"./package.json\": {\n+      \"default\": \"./package.json\"\n+    },\n     \"./a11y\": {\n       \"types\": \"./a11y/a11y.d.ts\",\n       \"esm2020\": \"./esm2020/a11y/a11y.mjs\",\n@@ -816,7 +816,14 @@ export { }\n       \"node\": \"./fesm2015/secondary.mjs\",\n       \"default\": \"./fesm2020/secondary.mjs\"\n     }\n-  }\n+  },\n+  \"fesm2020\": \"./fesm2020/waffels.mjs\",\n+  \"fesm2015\": \"./fesm2015/waffels.mjs\",\n+  \"esm2020\": \"./esm2020/example.mjs\",\n+  \"typings\": \"./example.d.ts\",\n+  \"module\": \"./fesm2015/waffels.mjs\",\n+  \"es2020\": \"./fesm2020/waffels.mjs\",\n+  \"type\": \"module\"\n }\n \n --- secondary/package.json ---"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 46,
        "deletions": 20
    }
}