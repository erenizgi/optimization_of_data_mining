{
    "author": "petebacondarwin",
    "message": "fix(core): ensure sanitizer works if DOMParser return null body (#40107)\n\nIn some browsers, notably a mobile version of webkit on iPad, the\nresult of calling `DOMParser.parseFromString()` returns a document\nwhose `body` property is null until the next tick of the browser.\nSince this is of no use to us for sanitization, we now fall back to the\n\"inert document\" strategy for this case.\n\nFixes #39834\n\nPR Close #40107",
    "sha": "8ebac24b48cb4ed86c3606dc0dee2c6646ef2244",
    "files": [
        {
            "sha": "4086956ac64cadbc058168def22000ed5047c6ab",
            "filename": "packages/core/src/sanitization/inert_body.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/8ebac24b48cb4ed86c3606dc0dee2c6646ef2244/packages%2Fcore%2Fsrc%2Fsanitization%2Finert_body.ts",
            "raw_url": "https://github.com/angular/angular/raw/8ebac24b48cb4ed86c3606dc0dee2c6646ef2244/packages%2Fcore%2Fsrc%2Fsanitization%2Finert_body.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fsanitization%2Finert_body.ts?ref=8ebac24b48cb4ed86c3606dc0dee2c6646ef2244",
            "patch": "@@ -16,7 +16,8 @@ import {trustedHTMLFromString} from '../util/security/trusted_types';\n  * Fallback: InertDocument strategy\n  */\n export function getInertBodyHelper(defaultDoc: Document): InertBodyHelper {\n-  return isDOMParserAvailable() ? new DOMParserHelper() : new InertDocumentHelper(defaultDoc);\n+  const inertDocumentHelper = new InertDocumentHelper(defaultDoc);\n+  return isDOMParserAvailable() ? new DOMParserHelper(inertDocumentHelper) : inertDocumentHelper;\n }\n \n export interface InertBodyHelper {\n@@ -31,6 +32,8 @@ export interface InertBodyHelper {\n  * This is the default strategy used in browsers that support it.\n  */\n class DOMParserHelper implements InertBodyHelper {\n+  constructor(private inertDocumentHelper: InertBodyHelper) {}\n+\n   getInertBodyElement(html: string): HTMLElement|null {\n     // We add these extra elements to ensure that the rest of the content is parsed as expected\n     // e.g. leading whitespace is maintained and tags like `<meta>` do not get hoisted to the\n@@ -41,6 +44,12 @@ class DOMParserHelper implements InertBodyHelper {\n       const body = new window.DOMParser()\n                        .parseFromString(trustedHTMLFromString(html) as string, 'text/html')\n                        .body as HTMLBodyElement;\n+      if (body === null) {\n+        // In some browsers (e.g. Mozilla/5.0 iPad AppleWebKit Mobile) the `body` property only\n+        // becomes available in the following tick of the JS engine. In that case we fall back to\n+        // the `inertDocumentHelper` instead.\n+        return this.inertDocumentHelper.getInertBodyElement(html);\n+      }\n       body.removeChild(body.firstChild!);\n       return body;\n     } catch {"
        },
        {
            "sha": "01d805c9be0831915571695684c85ef25f5bf761",
            "filename": "packages/core/test/sanitization/html_sanitizer_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/8ebac24b48cb4ed86c3606dc0dee2c6646ef2244/packages%2Fcore%2Ftest%2Fsanitization%2Fhtml_sanitizer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8ebac24b48cb4ed86c3606dc0dee2c6646ef2244/packages%2Fcore%2Ftest%2Fsanitization%2Fhtml_sanitizer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fsanitization%2Fhtml_sanitizer_spec.ts?ref=8ebac24b48cb4ed86c3606dc0dee2c6646ef2244",
            "patch": "@@ -252,5 +252,14 @@ function sanitizeHtml(defaultDoc: any, unsafeHtmlInput: string): string {\n             .toMatch(/<a href=\"unsafe:(&#12288;)?javascript:alert\\(1\\)\">CLICKME<\\/a>/);\n       });\n     }\n+\n+    if (isDOMParserAvailable()) {\n+      it('should work even if DOMParser returns a null body', () => {\n+        // Simulate `DOMParser.parseFromString()` returning a null body.\n+        // See https://github.com/angular/angular/issues/39834\n+        spyOn(window.DOMParser.prototype, 'parseFromString').and.returnValue({body: null} as any);\n+        expect(sanitizeHtml(defaultDoc, 'Hello, World')).toEqual('Hello, World');\n+      });\n+    }\n   });\n }"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 19,
        "deletions": 1
    }
}