{
    "author": "danieltre23",
    "message": "refactor(compiler-cli): add `extendedTemplateCheck` phase to compiler (#43107)\n\nThis commit integrates extended template checks with the compiler, by\nadding another phase of diagnostics generation. This integration is\nunder the `_extendedTemplateDiagnostics` flag.\n\nRefs #42966\n\nPR Close #43107",
    "sha": "ff858ac9d8d30fc3b979452f81ab5e15f487a524",
    "files": [
        {
            "sha": "4361072e9642093dd459df30b067728b3fa6f9d3",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2FBUILD.bazel?ref=ff858ac9d8d30fc3b979452f81ab5e15f487a524",
            "patch": "@@ -26,6 +26,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/transform\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/diagnostics\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/extended/api\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"//packages/compiler-cli/src/ngtsc/xi18n\",\n         \"@npm//@types/node\","
        },
        {
            "sha": "0501886c56c26d191fb480cb38e75d656c0ccc69",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=ff858ac9d8d30fc3b979452f81ab5e15f487a524",
            "patch": "@@ -24,6 +24,7 @@ import {ClassDeclaration, DeclarationNode, Decorator, ReflectionHost, reflectObj\n import {ComponentScopeReader, LocalModuleScopeRegistry, TypeCheckScopeRegistry} from '../../scope';\n import {AnalysisOutput, CompileResult, DecoratorHandler, DetectResult, HandlerFlags, HandlerPrecedence, ResolveResult} from '../../transform';\n import {TemplateSourceMapping, TypeCheckContext} from '../../typecheck/api';\n+import {ExtendedTemplateChecker} from '../../typecheck/extended/api';\n import {SubsetOfKeys} from '../../util/src/typescript';\n import {Xi18nContext} from '../../xi18n';\n \n@@ -613,6 +614,12 @@ export class ComponentDecoratorHandler implements\n         meta.template.sourceMapping, meta.template.file, meta.template.errors);\n   }\n \n+  extendedTemplateCheck(\n+      component: ts.ClassDeclaration,\n+      extendedTemplateChecker: ExtendedTemplateChecker): ts.Diagnostic[] {\n+    return extendedTemplateChecker.getExtendedTemplateDiagnosticsForComponent(component);\n+  }\n+\n   resolve(\n       node: ClassDeclaration, analysis: Readonly<ComponentAnalysisData>,\n       symbol: ComponentSymbol): ResolveResult<ComponentResolutionData> {"
        },
        {
            "sha": "371248d1d6a51d98ae3d6c3f8fe7b149c016e0a5",
            "filename": "packages/compiler-cli/src/ngtsc/core/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel?ref=ff858ac9d8d30fc3b979452f81ab5e15f487a524",
            "patch": "@@ -37,6 +37,8 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/diagnostics\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/extended\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/extended/src/template_checks/invalid_banana_in_box\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"//packages/compiler-cli/src/ngtsc/xi18n\",\n         \"@npm//typescript\","
        },
        {
            "sha": "037de2de6ea5c273f3a59282f430215e6a42d393",
            "filename": "packages/compiler-cli/src/ngtsc/core/api/src/options.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Foptions.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Foptions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Foptions.ts?ref=ff858ac9d8d30fc3b979452f81ab5e15f487a524",
            "patch": "@@ -36,6 +36,16 @@ export interface TestOnlyOptions {\n   tracePerformance?: string;\n }\n \n+/**\n+ * Internal only options for compiler.\n+ */\n+export interface InternalOptions {\n+  /**\n+   * Whether to run all template checks and generate extended template diagnostics.\n+   */\n+  _extendedTemplateDiagnostics?: boolean;\n+}\n+\n /**\n  * A merged interface of all of the various Angular compiler options, as well as the standard\n  * `ts.CompilerOptions`.\n@@ -45,4 +55,4 @@ export interface TestOnlyOptions {\n export interface NgCompilerOptions extends ts.CompilerOptions, LegacyNgcOptions, BazelAndG3Options,\n                                            NgcCompatibilityOptions, StrictTemplateOptions,\n                                            TestOnlyOptions, I18nOptions, TargetOptions,\n-                                           MiscOptions {}\n+                                           InternalOptions, MiscOptions {}"
        },
        {
            "sha": "35b9fd7f38bab20db341bfcab18a249ded574515",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 6,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=ff858ac9d8d30fc3b979452f81ab5e15f487a524",
            "patch": "@@ -30,6 +30,8 @@ import {ivySwitchTransform} from '../../switch';\n import {aliasTransformFactory, CompilationMode, declarationTransformFactory, DecoratorHandler, DtsTransformRegistry, ivyTransformFactory, TraitCompiler} from '../../transform';\n import {TemplateTypeCheckerImpl} from '../../typecheck';\n import {OptimizeFor, TemplateTypeChecker, TypeCheckingConfig} from '../../typecheck/api';\n+import {ExtendedTemplateCheckerImpl} from '../../typecheck/extended';\n+import {InvalidBananaInBoxCheck} from '../../typecheck/extended/src/template_checks/invalid_banana_in_box';\n import {getSourceFileOrNull, isDtsPath, resolveModuleName, toUnredirectedSourceFile} from '../../util/src/typescript';\n import {Xi18nContext} from '../../xi18n';\n import {LazyRoute, NgCompilerAdapter, NgCompilerOptions} from '../api';\n@@ -316,6 +318,12 @@ export class NgCompiler {\n       readonly usePoisonedData: boolean,\n       private livePerfRecorder: ActivePerfRecorder,\n   ) {\n+    if (this.options._extendedTemplateDiagnostics === true &&\n+        this.options.strictTemplates === false) {\n+      throw new Error(\n+          'The \\'_extendedTemplateDiagnostics\\' option requires \\'strictTemplates\\' to also be enabled.');\n+    }\n+\n     this.constructionDiagnostics.push(...this.adapter.constructionDiagnostics);\n     const incompatibleTypeCheckOptionsDiagnostic = verifyCompatibleTypeCheckOptions(this.options);\n     if (incompatibleTypeCheckOptionsDiagnostic !== null) {\n@@ -425,8 +433,12 @@ export class NgCompiler {\n    * Get all Angular-related diagnostics for this compilation.\n    */\n   getDiagnostics(): ts.Diagnostic[] {\n-    return this.addMessageTextDetails(\n-        [...this.getNonTemplateDiagnostics(), ...this.getTemplateDiagnostics()]);\n+    const diagnostics: ts.Diagnostic[] = [];\n+    diagnostics.push(...this.getNonTemplateDiagnostics(), ...this.getTemplateDiagnostics());\n+    if (this.options._extendedTemplateDiagnostics) {\n+      diagnostics.push(...this.getExtendedTemplateDiagnostics());\n+    }\n+    return this.addMessageTextDetails(diagnostics);\n   }\n \n   /**\n@@ -435,10 +447,14 @@ export class NgCompiler {\n    * If a `ts.SourceFile` is passed, only diagnostics related to that file are returned.\n    */\n   getDiagnosticsForFile(file: ts.SourceFile, optimizeFor: OptimizeFor): ts.Diagnostic[] {\n-    return this.addMessageTextDetails([\n-      ...this.getNonTemplateDiagnostics().filter(diag => diag.file === file),\n-      ...this.getTemplateDiagnosticsForFile(file, optimizeFor)\n-    ]);\n+    const diagnostics: ts.Diagnostic[] = [];\n+    diagnostics.push(\n+        ...this.getNonTemplateDiagnostics().filter(diag => diag.file === file),\n+        ...this.getTemplateDiagnosticsForFile(file, optimizeFor));\n+    if (this.options._extendedTemplateDiagnostics) {\n+      diagnostics.push(...this.getExtendedTemplateDiagnostics(file));\n+    }\n+    return this.addMessageTextDetails(diagnostics);\n   }\n \n   /**\n@@ -892,6 +908,30 @@ export class NgCompiler {\n     return this.nonTemplateDiagnostics;\n   }\n \n+  /**\n+   * Calls the `extendedTemplateCheck` phase of the trait compiler\n+   * @param sf optional parameter to get diagnostics for a certain file\n+   *     or all files in the program if `sf` is undefined\n+   * @returns generated extended template diagnostics\n+   */\n+  private getExtendedTemplateDiagnostics(sf?: ts.SourceFile): ts.Diagnostic[] {\n+    const diagnostics: ts.Diagnostic[] = [];\n+    const compilation = this.ensureAnalyzed();\n+    const typeChecker = this.inputProgram.getTypeChecker();\n+    const templateChecks = [new InvalidBananaInBoxCheck()];\n+    const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+        compilation.templateTypeChecker, typeChecker, templateChecks);\n+    if (sf !== undefined) {\n+      return compilation.traitCompiler.extendedTemplateCheck(sf, extendedTemplateChecker);\n+    }\n+    for (const sf of this.inputProgram.getSourceFiles()) {\n+      diagnostics.push(\n+          ...compilation.traitCompiler.extendedTemplateCheck(sf, extendedTemplateChecker));\n+    }\n+\n+    return diagnostics;\n+  }\n+\n   private makeCompilation(): LazyCompilationState {\n     const checker = this.inputProgram.getTypeChecker();\n "
        },
        {
            "sha": "62ace8b72ce40548c523815faefb1fe8bf78b221",
            "filename": "packages/compiler-cli/src/ngtsc/transform/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2FBUILD.bazel?ref=ff858ac9d8d30fc3b979452f81ab5e15f487a524",
            "patch": "@@ -19,6 +19,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/compiler-cli/src/ngtsc/translator\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/extended/api\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"//packages/compiler-cli/src/ngtsc/xi18n\",\n         \"@npm//typescript\","
        },
        {
            "sha": "5bffd37a086c72b3eaae0179fe0e664f56fbf52d",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/api.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts?ref=ff858ac9d8d30fc3b979452f81ab5e15f487a524",
            "patch": "@@ -15,6 +15,7 @@ import {IndexingContext} from '../../indexer';\n import {ClassDeclaration, Decorator} from '../../reflection';\n import {ImportManager} from '../../translator';\n import {TypeCheckContext} from '../../typecheck/api';\n+import {ExtendedTemplateChecker} from '../../typecheck/extended/api';\n import {Xi18nContext} from '../../xi18n';\n \n /**\n@@ -187,6 +188,10 @@ export interface DecoratorHandler<D, A, S extends SemanticSymbol|null, R> {\n       (ctx: TypeCheckContext, node: ClassDeclaration, analysis: Readonly<A>,\n        resolution: Readonly<R>): void;\n \n+  extendedTemplateCheck?\n+      (component: ts.ClassDeclaration, extendedTemplateChecker: ExtendedTemplateChecker):\n+          ts.Diagnostic[];\n+\n   /**\n    * Generate a description of the field which should be added to the class, including any\n    * initialization code to be generated."
        },
        {
            "sha": "4f1d708275b766552328122b6e17e0551d638ed0",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/compilation.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts?ref=ff858ac9d8d30fc3b979452f81ab5e15f487a524",
            "patch": "@@ -14,8 +14,9 @@ import {IncrementalBuild} from '../../incremental/api';\n import {SemanticDepGraphUpdater, SemanticSymbol} from '../../incremental/semantic_graph';\n import {IndexingContext} from '../../indexer';\n import {PerfEvent, PerfRecorder} from '../../perf';\n-import {ClassDeclaration, DeclarationNode, Decorator, ReflectionHost} from '../../reflection';\n+import {ClassDeclaration, DeclarationNode, Decorator, isNamedClassDeclaration, ReflectionHost} from '../../reflection';\n import {ProgramTypeCheckAdapter, TypeCheckContext} from '../../typecheck/api';\n+import {ExtendedTemplateChecker} from '../../typecheck/extended/api';\n import {getSourceFile, isExported} from '../../util/src/typescript';\n import {Xi18nContext} from '../../xi18n';\n \n@@ -490,6 +491,29 @@ export class TraitCompiler implements ProgramTypeCheckAdapter {\n     }\n   }\n \n+  extendedTemplateCheck(sf: ts.SourceFile, extendedTemplateChecker: ExtendedTemplateChecker):\n+      ts.Diagnostic[] {\n+    const classes = this.fileToClasses.get(sf);\n+    if (classes === undefined) {\n+      return [];\n+    }\n+\n+    const diagnostics: ts.Diagnostic[] = [];\n+    for (const clazz of classes) {\n+      if (!isNamedClassDeclaration(clazz)) {\n+        continue;\n+      }\n+      const record = this.classes.get(clazz)!;\n+      for (const trait of record.traits) {\n+        if (trait.handler.extendedTemplateCheck === undefined) {\n+          continue;\n+        }\n+        diagnostics.push(...trait.handler.extendedTemplateCheck(clazz, extendedTemplateChecker));\n+      }\n+    }\n+    return diagnostics;\n+  }\n+\n   index(ctx: IndexingContext): void {\n     for (const clazz of this.classes.keys()) {\n       const record = this.classes.get(clazz)!;"
        },
        {
            "sha": "ff4c64af4448f674126c94f284e83bb1678a08d5",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/src/template_checks/invalid_banana_in_box/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Ftemplate_checks%2Finvalid_banana_in_box%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/ff858ac9d8d30fc3b979452f81ab5e15f487a524/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Ftemplate_checks%2Finvalid_banana_in_box%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Ftemplate_checks%2Finvalid_banana_in_box%2FBUILD.bazel?ref=ff858ac9d8d30fc3b979452f81ab5e15f487a524",
            "patch": "@@ -3,7 +3,7 @@ load(\"//tools:defaults.bzl\", \"ts_library\")\n ts_library(\n     name = \"invalid_banana_in_box\",\n     srcs = [\"index.ts\"],\n-    visibility = [\"//packages/compiler-cli/src/ngtsc/typecheck/extended:__subpackages__\"],\n+    visibility = [\"//packages/compiler-cli/src/ngtsc:__subpackages__\"],\n     deps = [\n         \"//packages/compiler\",\n         \"//packages/compiler-cli/src/ngtsc/diagnostics\","
        }
    ],
    "stats": {
        "total": 108,
        "additions": 99,
        "deletions": 9
    }
}