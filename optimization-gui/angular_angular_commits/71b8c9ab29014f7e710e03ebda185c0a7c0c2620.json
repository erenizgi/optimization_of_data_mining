{
    "author": "alan-agius4",
    "message": "refactor(bazel): remove old Angular CLI schematics and builder (#41575)\n\nThis is leftover code which is no longer used.\n\nPR Close #41575",
    "sha": "71b8c9ab29014f7e710e03ebda185c0a7c0c2620",
    "files": [
        {
            "sha": "6427fd234470771f513844a9b229ef53dffbace5",
            "filename": "package.json",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/71b8c9ab29014f7e710e03ebda185c0a7c0c2620/package.json",
            "raw_url": "https://github.com/angular/angular/raw/71b8c9ab29014f7e710e03ebda185c0a7c0c2620/package.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/package.json?ref=71b8c9ab29014f7e710e03ebda185c0a7c0c2620",
            "patch": "@@ -42,7 +42,6 @@\n   \"// 1\": \"dependencies are used locally and by bazel\",\n   \"dependencies\": {\n     \"@angular/cli\": \"12.0.0-next.7\",\n-    \"@angular-devkit/architect\": \"0.1200.0-next.7\",\n     \"@angular-devkit/build-angular\": \"github:angular/angular-devkit-build-angular-builds#e0c1374b12cfc892844030431bc19f631c0086a5\",\n     \"@angular-devkit/build-optimizer\": \"0.1200.0-next.7\",\n     \"@angular-devkit/core\": \"12.0.0-next.7\","
        },
        {
            "sha": "89ee85b4a46a74f60a3529610bc86a5b613f21fe",
            "filename": "packages/bazel/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/71b8c9ab29014f7e710e03ebda185c0a7c0c2620/packages%2Fbazel%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/71b8c9ab29014f7e710e03ebda185c0a7c0c2620/packages%2Fbazel%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2FBUILD.bazel?ref=71b8c9ab29014f7e710e03ebda185c0a7c0c2620",
            "patch": "@@ -13,9 +13,6 @@ pkg_npm(\n         \"//packages/bazel/src/ngc-wrapped:package_assets\",\n         \"//packages/bazel/third_party/github.com/bazelbuild/bazel/src/main/protobuf:package_assets\",\n     ],\n-    nested_packages = [\n-        \"//packages/bazel/docs\",\n-    ],\n     substitutions = {\n         \"(#|//)\\\\s+BEGIN-DEV-ONLY[\\\\w\\\\W]+?(#|//)\\\\s+END-DEV-ONLY\": \"\",\n         \"//packages/bazel/\": \"//@angular/bazel/\","
        },
        {
            "sha": "37e76ef8c3a08eaa8edc11f79f2eaf16a951c167",
            "filename": "packages/bazel/docs/BAZEL_SCHEMATICS.md",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/71b8c9ab29014f7e710e03ebda185c0a7c0c2620/packages%2Fbazel%2Fdocs%2FBAZEL_SCHEMATICS.md",
            "raw_url": "https://github.com/angular/angular/raw/71b8c9ab29014f7e710e03ebda185c0a7c0c2620/packages%2Fbazel%2Fdocs%2FBAZEL_SCHEMATICS.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fdocs%2FBAZEL_SCHEMATICS.md?ref=71b8c9ab29014f7e710e03ebda185c0a7c0c2620",
            "patch": "@@ -45,7 +45,7 @@ This new rule leverages ngtsc plugin supported by `ts_library`, and it is much f\n \n For the latest recommendations, please refer to the canonical Angular Bazel [repo](https://github.com/bazelbuild/rules_nodejs/tree/master/examples/angular).\n \n-For questions, please ask in the `#angular` channel in https://slack.bazel.build/.\n+For questions, please ask in the `#angular` channel in http://slack.bazel.build/.\n \n ## Angular CLI\n ",
            "previous_filename": "packages/bazel/src/schematics/README.md"
        },
        {
            "sha": "55b84494d89db873f4563c68b1b7a0ddd0e35ea7",
            "filename": "packages/bazel/docs/BUILD.bazel",
            "status": "removed",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fdocs%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fdocs%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fdocs%2FBUILD.bazel?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,13 +0,0 @@\n-load(\"@io_bazel_skydoc//skylark:skylark.bzl\", \"skylark_doc\")\n-\n-skylark_doc(\n-    name = \"docs\",\n-    srcs = [\n-        \"//packages/bazel/src:ng_module.bzl\",\n-        \"//packages/bazel/src/ng_package:ng_package.bzl\",\n-    ],\n-    format = \"html\",\n-    site_root = \"/bazel-builds\",\n-    strip_prefix = \"packages/bazel/\",\n-    visibility = [\"//packages/bazel:__subpackages__\"],\n-)"
        },
        {
            "sha": "c309914196c3e146afb35ea5382eb0a7e168357a",
            "filename": "packages/bazel/src/builders/bazel.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 200,
            "changes": 200,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fbuilders%2Fbazel.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fbuilders%2Fbazel.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fbuilders%2Fbazel.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,200 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-/// <reference types='node'/>\n-\n-import {spawn} from 'child_process';\n-import {copyFileSync, existsSync, readdirSync, readFileSync, statSync, unlinkSync, writeFileSync} from 'fs';\n-import {platform} from 'os';\n-import {dirname, join, normalize} from 'path';\n-\n-export type Executable = 'bazel'|'ibazel';\n-export type Command = 'build'|'test'|'run'|'coverage'|'query';\n-\n-/**\n- * Spawn the Bazel process. Trap SINGINT to make sure Bazel process is killed.\n- */\n-export function runBazel(\n-    projectDir: string, binary: string, command: Command, workspaceTarget: string,\n-    flags: string[]) {\n-  projectDir = normalize(projectDir);\n-  binary = normalize(binary);\n-  return new Promise((resolve, reject) => {\n-    const buildProcess = spawn(binary, [command, workspaceTarget, ...flags], {\n-      cwd: projectDir,\n-      stdio: 'inherit',\n-    });\n-\n-    process.on('SIGINT', (signal) => {\n-      if (!buildProcess.killed) {\n-        buildProcess.kill();\n-        reject(new Error(`Bazel process received ${signal}.`));\n-      }\n-    });\n-\n-    buildProcess.once('close', (code: number) => {\n-      if (code === 0) {\n-        resolve();\n-      } else {\n-        reject(new Error(`${binary} failed with code ${code}.`));\n-      }\n-    });\n-  });\n-}\n-\n-/**\n- * Resolves the path to `@bazel/bazel` or `@bazel/ibazel`.\n- */\n-export function checkInstallation(name: Executable, projectDir: string): string {\n-  projectDir = normalize(projectDir);\n-  const packageName = `@bazel/${name}`;\n-  try {\n-    const bazelPath = require.resolve(packageName, {\n-      paths: [projectDir],\n-    });\n-    return require(bazelPath).getNativeBinary();\n-  } catch (error) {\n-    if (error.code === 'MODULE_NOT_FOUND') {\n-      throw new Error(\n-          `Could not run ${name}. Please make sure that the ` +\n-          `\"${name}\" command is installed by running ` +\n-          `\"npm install ${packageName}\" or \"yarn install ${packageName}\".`);\n-    }\n-    throw error;\n-  }\n-}\n-\n-/**\n- * Returns the absolute path to the template directory in `@angular/bazel`.\n- */\n-export function getTemplateDir(root: string): string {\n-  root = normalize(root);\n-  const packageJson = require.resolve('@angular/bazel/package.json', {\n-    paths: [root],\n-  });\n-  const packageDir = dirname(packageJson);\n-  const templateDir = join(packageDir, 'src', 'builders', 'files');\n-  if (!statSync(templateDir).isDirectory()) {\n-    throw new Error('Could not find Bazel template directory in \"@angular/bazel\".');\n-  }\n-  return templateDir;\n-}\n-\n-/**\n- * Recursively list the specified 'dir' using depth-first approach. Paths\n- * returned are relative to 'dir'.\n- */\n-function listR(dir: string): string[] {\n-  function list(dir: string, root: string, results: string[]) {\n-    const paths = readdirSync(dir);\n-    for (const path of paths) {\n-      const absPath = join(dir, path);\n-      const relPath = join(root, path);\n-      if (statSync(absPath).isFile()) {\n-        results.push(relPath);\n-      } else {\n-        list(absPath, relPath, results);\n-      }\n-    }\n-    return results;\n-  }\n-\n-  return list(dir, '', []);\n-}\n-\n-/**\n- * Return the name of the lock file that is present in the specified 'root'\n- * directory. If none exists, default to creating an empty yarn.lock file.\n- */\n-function getOrCreateLockFile(root: string): 'yarn.lock'|'package-lock.json' {\n-  const yarnLock = join(root, 'yarn.lock');\n-  if (existsSync(yarnLock)) {\n-    return 'yarn.lock';\n-  }\n-  const npmLock = join(root, 'package-lock.json');\n-  if (existsSync(npmLock)) {\n-    return 'package-lock.json';\n-  }\n-  // Prefer yarn if no lock file exists\n-  writeFileSync(yarnLock, '');\n-  return 'yarn.lock';\n-}\n-\n-// Replace yarn_install rule with npm_install and copy from 'source' to 'dest'.\n-function replaceYarnWithNpm(source: string, dest: string) {\n-  const srcContent = readFileSync(source, 'utf-8');\n-  const destContent = srcContent.replace(/yarn_install/g, 'npm_install')\n-                          .replace('yarn_lock', 'package_lock_json')\n-                          .replace('yarn.lock', 'package-lock.json');\n-  writeFileSync(dest, destContent);\n-}\n-\n-/**\n- * Disable sandbox on Mac OS by setting spawn_strategy in .bazelrc.\n- * For a hello world (ng new) application, removing the sandbox improves build\n- * time by almost 40%.\n- * ng build with sandbox: 22.0 seconds\n- * ng build without sandbox: 13.3 seconds\n- */\n-function disableSandbox(source: string, dest: string) {\n-  const srcContent = readFileSync(source, 'utf-8');\n-  const destContent = `${srcContent}\n-# Disable sandbox on Mac OS for performance reason.\n-build --spawn_strategy=local\n-run --spawn_strategy=local\n-test --spawn_strategy=local\n-`;\n-  writeFileSync(dest, destContent);\n-}\n-\n-/**\n- * Copy Bazel files (WORKSPACE, BUILD.bazel, etc) from the template directory to\n- * the project `root` directory, and return the absolute paths of the files\n- * copied, so that they can be deleted later.\n- * Existing files in `root` will not be replaced.\n- */\n-export function copyBazelFiles(root: string, templateDir: string) {\n-  root = normalize(root);\n-  templateDir = normalize(templateDir);\n-  const bazelFiles: string[] = [];\n-  const templates = listR(templateDir);\n-  const useYarn = getOrCreateLockFile(root) === 'yarn.lock';\n-\n-  for (const template of templates) {\n-    const name = template.replace('__dot__', '.').replace('.template', '');\n-    const source = join(templateDir, template);\n-    const dest = join(root, name);\n-    try {\n-      if (!existsSync(dest)) {\n-        if (!useYarn && name === 'WORKSPACE') {\n-          replaceYarnWithNpm(source, dest);\n-        } else if (platform() === 'darwin' && name === '.bazelrc') {\n-          disableSandbox(source, dest);\n-        } else {\n-          copyFileSync(source, dest);\n-        }\n-        bazelFiles.push(dest);\n-      }\n-    } catch {\n-    }\n-  }\n-\n-  return bazelFiles;\n-}\n-\n-/**\n- * Delete the specified 'files'. This function never throws.\n- */\n-export function deleteBazelFiles(files: string[]) {\n-  for (const file of files) {\n-    try {\n-      unlinkSync(file);\n-    } catch {\n-    }\n-  }\n-}"
        },
        {
            "sha": "f0218c1cd48c3c0f4d5a420829f108cd349399b3",
            "filename": "packages/bazel/src/builders/index.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 41,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fbuilders%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fbuilders%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fbuilders%2Findex.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,41 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- *\n- * @fileoverview Bazel builder\n- */\n-\n-import {BuilderContext, BuilderOutput, createBuilder,} from '@angular-devkit/architect';\n-import {JsonObject} from '@angular-devkit/core';\n-import {checkInstallation, copyBazelFiles, deleteBazelFiles, getTemplateDir, runBazel} from './bazel';\n-import {Schema} from './schema';\n-\n-async function _bazelBuilder(\n-    options: JsonObject&Schema,\n-    context: BuilderContext,\n-    ): Promise<BuilderOutput> {\n-  const {logger, workspaceRoot} = context;\n-  const {bazelCommand, leaveBazelFilesOnDisk, targetLabel, watch} = options;\n-  const executable = watch ? 'ibazel' : 'bazel';\n-  const binary = checkInstallation(executable, workspaceRoot);\n-  const templateDir = getTemplateDir(workspaceRoot);\n-  const bazelFiles = copyBazelFiles(workspaceRoot, templateDir);\n-\n-  try {\n-    const flags: string[] = [];\n-    await runBazel(workspaceRoot, binary, bazelCommand, targetLabel, flags);\n-    return {success: true};\n-  } catch (err) {\n-    logger.error(err.message);\n-    return {success: false};\n-  } finally {\n-    if (!leaveBazelFilesOnDisk) {\n-      deleteBazelFiles(bazelFiles);  // this will never throw\n-    }\n-  }\n-}\n-\n-export default createBuilder(_bazelBuilder);"
        },
        {
            "sha": "7dc3de13112b239918fa4006003325d08d3f8d6d",
            "filename": "packages/bazel/src/builders/schema.d.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 38,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fbuilders%2Fschema.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fbuilders%2Fschema.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fbuilders%2Fschema.d.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,38 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-/**\n- * Options for Bazel Builder\n- */\n-export interface Schema {\n-  /**\n-   * Common commands supported by Bazel.\n-   */\n-  bazelCommand: BazelCommand;\n-  /**\n-   * If true, leave Bazel files on disk after running command.\n-   */\n-  leaveBazelFilesOnDisk?: boolean;\n-  /**\n-   * Target to be executed under Bazel.\n-   */\n-  targetLabel: string;\n-  /**\n-   * If true, watch the filesystem using ibazel.\n-   */\n-  watch?: boolean;\n-}\n-\n-/**\n- * Common commands supported by Bazel.\n- */\n-export enum BazelCommand {\n-  Build = 'build',\n-  Run = 'run',\n-  Test = 'test',\n-}"
        },
        {
            "sha": "f381a606e1f5ab037e183bf765861fec15595401",
            "filename": "packages/bazel/src/schematics/ng-add/index.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 357,
            "changes": 357,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-add%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-add%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-add%2Findex.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,357 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- *\n- * @fileoverview Schematics for ng-new project that builds with Bazel.\n- */\n-\n-import {JsonAstObject, parseJsonAst} from '@angular-devkit/core';\n-import {apply, applyTemplates, chain, mergeWith, Rule, SchematicContext, SchematicsException, Tree, url} from '@angular-devkit/schematics';\n-import {NodePackageInstallTask} from '@angular-devkit/schematics/tasks';\n-import {getWorkspace, getWorkspacePath} from '@schematics/angular/utility/config';\n-import {addPackageJsonDependency, getPackageJsonDependency, NodeDependencyType, removePackageJsonDependency} from '@schematics/angular/utility/dependencies';\n-import {findPropertyInAstObject, insertPropertyInAstObjectInOrder} from '@schematics/angular/utility/json-utils';\n-import {validateProjectName} from '@schematics/angular/utility/validation';\n-\n-import {isJsonAstObject, replacePropertyInAstObject} from '../utility/json-utils';\n-import {findE2eArchitect} from '../utility/workspace-utils';\n-\n-import {Schema} from './schema';\n-\n-\n-\n-/**\n- * Packages that build under Bazel require additional dev dependencies. This\n- * function adds those dependencies to \"devDependencies\" section in\n- * package.json.\n- */\n-function addDevDependenciesToPackageJson(options: Schema) {\n-  return (host: Tree) => {\n-    const angularCore = getPackageJsonDependency(host, '@angular/core');\n-    if (!angularCore) {\n-      throw new Error('@angular/core dependency not found in package.json');\n-    }\n-\n-    // TODO: use a Record<string, string> when the tsc lib setting allows us\n-    const devDependencies: [string, string][] = [\n-      ['@angular/bazel', angularCore.version],\n-      ['@bazel/bazel', '2.1.0'],\n-      ['@bazel/ibazel', '0.12.3'],\n-      ['@bazel/karma', '1.6.0'],\n-      ['@bazel/protractor', '1.6.0'],\n-      ['@bazel/rollup', '1.6.0'],\n-      ['@bazel/terser', '1.6.0'],\n-      ['@bazel/typescript', '1.6.0'],\n-      ['history-server', '1.3.1'],\n-      ['html-insert-assets', '0.5.0'],\n-      ['karma', '4.4.1'],\n-      ['karma-chrome-launcher', '3.1.0'],\n-      ['karma-firefox-launcher', '1.2.0'],\n-      ['karma-jasmine', '2.0.1'],\n-      ['karma-requirejs', '1.1.0'],\n-      ['karma-sourcemap-loader', '0.3.7'],\n-      ['protractor', '5.4.2'],\n-      ['requirejs', '2.3.6'],\n-      ['rollup', '1.27.5'],\n-      ['rollup-plugin-commonjs', '10.1.0'],\n-      ['rollup-plugin-node-resolve', '5.2.0'],\n-      ['terser', '4.4.0'],\n-    ];\n-\n-    for (const [name, version] of devDependencies) {\n-      const dep = getPackageJsonDependency(host, name);\n-      if (dep && dep.type !== NodeDependencyType.Dev) {\n-        removePackageJsonDependency(host, name);\n-      }\n-\n-      addPackageJsonDependency(host, {\n-        name,\n-        version,\n-        type: NodeDependencyType.Dev,\n-        overwrite: true,\n-      });\n-    }\n-  };\n-}\n-\n-/**\n- * Remove packages that are not needed under Bazel.\n- * @param options\n- */\n-function removeObsoleteDependenciesFromPackageJson(options: Schema) {\n-  return (host: Tree) => {\n-    const depsToRemove = [\n-      '@angular-devkit/build-angular',\n-    ];\n-\n-    for (const packageName of depsToRemove) {\n-      removePackageJsonDependency(host, packageName);\n-    }\n-  };\n-}\n-\n-/**\n- * Append additional Javascript / Typescript files needed to compile an Angular\n- * project under Bazel.\n- */\n-function addFilesRequiredByBazel(options: Schema) {\n-  return (host: Tree) => {\n-    return mergeWith(apply(url('./files'), [\n-      applyTemplates({}),\n-    ]));\n-  };\n-}\n-\n-/**\n- * Append '/bazel-out' to the gitignore file.\n- */\n-function updateGitignore() {\n-  return (host: Tree) => {\n-    const gitignore = '/.gitignore';\n-    if (!host.exists(gitignore)) {\n-      return host;\n-    }\n-    const gitIgnoreContentRaw = host.read(gitignore);\n-    if (!gitIgnoreContentRaw) {\n-      return host;\n-    }\n-    const gitIgnoreContent = gitIgnoreContentRaw.toString();\n-    if (gitIgnoreContent.includes('\\n/bazel-out\\n')) {\n-      return host;\n-    }\n-    const compiledOutput = '# compiled output\\n';\n-    const index = gitIgnoreContent.indexOf(compiledOutput);\n-    const insertionIndex = index >= 0 ? index + compiledOutput.length : gitIgnoreContent.length;\n-    const recorder = host.beginUpdate(gitignore);\n-    recorder.insertRight(insertionIndex, '/bazel-out\\n');\n-    host.commitUpdate(recorder);\n-    return host;\n-  };\n-}\n-\n-/**\n- * Change the architect in angular.json to use Bazel builder.\n- */\n-function updateAngularJsonToUseBazelBuilder(options: Schema): Rule {\n-  return (host: Tree) => {\n-    const name = options.name!;\n-    const workspacePath = getWorkspacePath(host);\n-    if (!workspacePath) {\n-      throw new Error('Could not find angular.json');\n-    }\n-    const workspaceContent = host.read(workspacePath);\n-    if (!workspaceContent) {\n-      throw new Error('Failed to read angular.json content');\n-    }\n-    const workspaceJsonAst = parseJsonAst(workspaceContent.toString()) as JsonAstObject;\n-    const projects = findPropertyInAstObject(workspaceJsonAst, 'projects');\n-    if (!projects) {\n-      throw new SchematicsException('Expect projects in angular.json to be an Object');\n-    }\n-    const project = findPropertyInAstObject(projects as JsonAstObject, name);\n-    if (!project) {\n-      throw new SchematicsException(`Expected projects to contain ${name}`);\n-    }\n-    const recorder = host.beginUpdate(workspacePath);\n-    const indent = 8;\n-    const architect =\n-        findPropertyInAstObject(project as JsonAstObject, 'architect') as JsonAstObject;\n-    replacePropertyInAstObject(\n-        recorder, architect, 'build', {\n-          builder: '@angular/bazel:build',\n-          options: {\n-            targetLabel: '//src:prodapp',\n-            bazelCommand: 'build',\n-          },\n-          configurations: {\n-            production: {\n-              targetLabel: '//src:prodapp',\n-            },\n-          },\n-        },\n-        indent);\n-    replacePropertyInAstObject(\n-        recorder, architect, 'serve', {\n-          builder: '@angular/bazel:build',\n-          options: {\n-            targetLabel: '//src:devserver',\n-            bazelCommand: 'run',\n-            watch: true,\n-          },\n-          configurations: {\n-            production: {\n-              targetLabel: '//src:prodserver',\n-            },\n-          },\n-        },\n-        indent);\n-\n-    if (findPropertyInAstObject(architect, 'test')) {\n-      replacePropertyInAstObject(\n-          recorder, architect, 'test', {\n-            builder: '@angular/bazel:build',\n-            options: {\n-              bazelCommand: 'test',\n-              targetLabel: '//src:test',\n-            },\n-          },\n-          indent);\n-    }\n-\n-    const e2eArchitect = findE2eArchitect(workspaceJsonAst, name);\n-    if (e2eArchitect && findPropertyInAstObject(e2eArchitect, 'e2e')) {\n-      replacePropertyInAstObject(\n-          recorder, e2eArchitect, 'e2e', {\n-            builder: '@angular/bazel:build',\n-            options: {\n-              bazelCommand: 'test',\n-              targetLabel: '//e2e:devserver_test',\n-            },\n-            configurations: {\n-              production: {\n-                targetLabel: '//e2e:prodserver_test',\n-              },\n-            }\n-          },\n-          indent);\n-    }\n-\n-    host.commitUpdate(recorder);\n-    return host;\n-  };\n-}\n-\n-/**\n- * Create a backup for the original angular.json file in case user wants to\n- * eject Bazel and revert to the original workflow.\n- */\n-function backupAngularJson(): Rule {\n-  return (host: Tree, context: SchematicContext) => {\n-    const workspacePath = getWorkspacePath(host);\n-    if (!workspacePath) {\n-      return;\n-    }\n-    host.create(\n-        `${workspacePath}.bak`,\n-        '// This is a backup file of the original angular.json. ' +\n-            'This file is needed in case you want to revert to the workflow without Bazel.\\n\\n' +\n-            host.read(workspacePath));\n-  };\n-}\n-\n-/**\n- * @angular/bazel requires minimum version of rxjs to be 6.4.0. This function\n- * upgrades the version of rxjs in package.json if necessary.\n- */\n-function upgradeRxjs() {\n-  return (host: Tree, context: SchematicContext) => {\n-    const rxjsNode = getPackageJsonDependency(host, 'rxjs');\n-    if (!rxjsNode) {\n-      throw new Error(`Failed to find rxjs dependency.`);\n-    }\n-\n-    const match = rxjsNode.version.match(/(\\d)+\\.(\\d)+.(\\d)+$/);\n-    if (match) {\n-      const [_, major, minor] = match;\n-      if (major < '6' || (major === '6' && minor < '5')) {\n-        addPackageJsonDependency(host, {\n-          ...rxjsNode,\n-          version: '~6.5.3',\n-          overwrite: true,\n-        });\n-      }\n-    } else {\n-      context.logger.info(\n-          'Could not determine version of rxjs. \\n' +\n-          'Please make sure that version is at least 6.5.3.');\n-    }\n-    return host;\n-  };\n-}\n-\n-/**\n- * When using Ivy, ngcc must be run as a postinstall step.\n- * This function adds this postinstall step.\n- */\n-function addPostinstallToRunNgcc() {\n-  return (host: Tree, context: SchematicContext) => {\n-    const packageJson = 'package.json';\n-    if (!host.exists(packageJson)) {\n-      throw new Error(`Could not find ${packageJson}`);\n-    }\n-    const content = host.read(packageJson);\n-    if (!content) {\n-      throw new Error('Failed to read package.json content');\n-    }\n-    const jsonAst = parseJsonAst(content.toString());\n-    if (!isJsonAstObject(jsonAst)) {\n-      throw new Error(`Failed to parse JSON for ${packageJson}`);\n-    }\n-    const scripts = findPropertyInAstObject(jsonAst, 'scripts') as JsonAstObject;\n-    const recorder = host.beginUpdate(packageJson);\n-    // For bazel we need to compile the all files in place so we\n-    // don't use `--first-only` or `--create-ivy-entry-points`\n-    const ngccCommand = 'ngcc --properties es2015 browser module main';\n-    if (scripts) {\n-      const postInstall = findPropertyInAstObject(scripts, 'postinstall');\n-      if (postInstall && postInstall.value) {\n-        let value = postInstall.value as string;\n-        if (/\\bngcc\\b/.test(value)) {\n-          // `ngcc` is already in the postinstall script\n-          value =\n-              value.replace(/\\s*--first-only\\b/, '').replace(/\\s*--create-ivy-entry-points\\b/, '');\n-          replacePropertyInAstObject(recorder, scripts, 'postinstall', value);\n-        } else {\n-          const command = `${postInstall.value}; ${ngccCommand}`;\n-          replacePropertyInAstObject(recorder, scripts, 'postinstall', command);\n-        }\n-      } else {\n-        insertPropertyInAstObjectInOrder(recorder, scripts, 'postinstall', ngccCommand, 4);\n-      }\n-    } else {\n-      insertPropertyInAstObjectInOrder(\n-          recorder, jsonAst, 'scripts', {\n-            postinstall: ngccCommand,\n-          },\n-          2);\n-    }\n-    host.commitUpdate(recorder);\n-    return host;\n-  };\n-}\n-\n-/**\n- * Schedule a task to perform npm / yarn install.\n- */\n-function installNodeModules(options: Schema): Rule {\n-  return (host: Tree, context: SchematicContext) => {\n-    if (!options.skipInstall) {\n-      context.addTask(new NodePackageInstallTask());\n-    }\n-  };\n-}\n-\n-export default function(options: Schema): Rule {\n-  return (host: Tree) => {\n-    options.name = options.name || getWorkspace(host).defaultProject;\n-    if (!options.name) {\n-      throw new Error('Please specify a project using \"--name project-name\"');\n-    }\n-    validateProjectName(options.name);\n-\n-    return chain([\n-      addFilesRequiredByBazel(options),\n-      addDevDependenciesToPackageJson(options),\n-      removeObsoleteDependenciesFromPackageJson(options),\n-      addPostinstallToRunNgcc(),\n-      backupAngularJson(),\n-      updateAngularJsonToUseBazelBuilder(options),\n-      updateGitignore(),\n-      upgradeRxjs(),\n-      installNodeModules(options),\n-    ]);\n-  };\n-}"
        },
        {
            "sha": "d75189077429c305ba65d4f5d02460b99ef84b55",
            "filename": "packages/bazel/src/schematics/ng-add/index_spec.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 340,
            "changes": 340,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-add%2Findex_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-add%2Findex_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-add%2Findex_spec.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,340 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import {HostTree} from '@angular-devkit/schematics';\n-import {SchematicTestRunner, UnitTestTree} from '@angular-devkit/schematics/testing';\n-\n-describe('ng-add schematic', () => {\n-  const defaultOptions = {name: 'demo'};\n-  let host: UnitTestTree;\n-  let schematicRunner: SchematicTestRunner;\n-\n-  beforeEach(() => {\n-    host = new UnitTestTree(new HostTree());\n-    host.create('package.json', JSON.stringify({\n-      name: 'demo',\n-      dependencies: {\n-        '@angular/core': '1.2.3',\n-        'rxjs': '~6.3.3',\n-      },\n-      devDependencies: {\n-        'typescript': '3.2.2',\n-      },\n-    }));\n-    host.create('tsconfig.json', JSON.stringify({\n-      compileOnSave: false,\n-      compilerOptions: {\n-        baseUrl: './',\n-        outDir: './dist/out-tsc',\n-      }\n-    }));\n-    host.create('angular.json', JSON.stringify({\n-      projects: {\n-        'demo': {\n-          architect: {\n-            build: {},\n-            serve: {},\n-            test: {},\n-            'extract-i18n': {\n-              builder: '@angular-devkit/build-angular:extract-i18n',\n-            },\n-          },\n-        },\n-        'demo-e2e': {\n-          architect: {\n-            e2e: {},\n-            lint: {\n-              builder: '@angular-devkit/build-angular:tslint',\n-            },\n-          },\n-        },\n-      },\n-      defaultProject: 'demo',\n-    }));\n-    schematicRunner =\n-        new SchematicTestRunner('@angular/bazel', require.resolve('../collection.json'));\n-  });\n-\n-  it('throws if package.json is not found', async () => {\n-    expect(host.files).toContain('/package.json');\n-    host.delete('/package.json');\n-\n-    let message = 'No error';\n-\n-    try {\n-      await schematicRunner.runSchematicAsync('ng-add', defaultOptions).toPromise();\n-    } catch (e) {\n-      message = e.message;\n-    }\n-\n-    expect(message).toBe('Could not read package.json.');\n-  });\n-\n-  it('throws if angular.json is not found', async () => {\n-    expect(host.files).toContain('/angular.json');\n-    host.delete('/angular.json');\n-\n-    let message = 'No error';\n-\n-    try {\n-      await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    } catch (e) {\n-      message = e.message;\n-    }\n-\n-    expect(message).toBe('Could not find angular.json');\n-  });\n-\n-  it('should add @angular/bazel to package.json dependencies', async () => {\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const {files} = host;\n-    expect(files).toContain('/package.json');\n-    const content = host.readContent('/package.json');\n-    expect(() => JSON.parse(content)).not.toThrow();\n-    const json = JSON.parse(content);\n-    const core = '@angular/core';\n-    const bazel = '@angular/bazel';\n-    expect(Object.keys(json)).toContain('dependencies');\n-    expect(Object.keys(json)).toContain('devDependencies');\n-    expect(Object.keys(json.dependencies)).toContain(core);\n-    expect(Object.keys(json.devDependencies)).toContain(bazel);\n-  });\n-\n-  it('should add @bazel/* dev dependencies', async () => {\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const content = host.readContent('/package.json');\n-    const json = JSON.parse(content);\n-    const devDeps = Object.keys(json.devDependencies);\n-    expect(devDeps).toContain('@bazel/bazel');\n-    expect(devDeps).toContain('@bazel/ibazel');\n-    expect(devDeps).toContain('@bazel/karma');\n-    expect(devDeps).toContain('@bazel/protractor');\n-    expect(devDeps).toContain('@bazel/typescript');\n-  });\n-\n-  it('should replace an existing dev dependency', async () => {\n-    expect(host.files).toContain('/package.json');\n-    const packageJson = JSON.parse(host.readContent('/package.json'));\n-    packageJson.devDependencies['@angular/bazel'] = '4.2.42';\n-    host.overwrite('/package.json', JSON.stringify(packageJson));\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const content = host.readContent('/package.json');\n-    // It is possible that a dep gets added twice if the package already exists.\n-    expect(content.match(/@angular\\/bazel/g)!.length).toEqual(1);\n-    const json = JSON.parse(content);\n-    expect(json.devDependencies['@angular/bazel']).toBe('1.2.3');\n-  });\n-\n-  it('should remove an existing dependency', async () => {\n-    expect(host.files).toContain('/package.json');\n-    const packageJson = JSON.parse(host.readContent('/package.json'));\n-    packageJson.dependencies['@angular/bazel'] = '4.2.42';\n-    expect(Object.keys(packageJson.dependencies)).toContain('@angular/bazel');\n-    host.overwrite('/package.json', JSON.stringify(packageJson));\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const content = host.readContent('/package.json');\n-    const json = JSON.parse(content);\n-    expect(Object.keys(json.dependencies)).not.toContain('@angular/bazel');\n-    expect(json.devDependencies['@angular/bazel']).toBe('1.2.3');\n-  });\n-\n-  it('should remove unneeded dependencies', async () => {\n-    const packageJson = JSON.parse(host.readContent('/package.json'));\n-    packageJson.devDependencies['@angular-devkit/build-angular'] = '1.2.3';\n-    host.overwrite('/package.json', JSON.stringify(packageJson));\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const content = host.readContent('/package.json');\n-    const json = JSON.parse(content);\n-    expect(json.devDependencies['angular-devkit/build-angular']).toBeUndefined();\n-  });\n-\n-  it('should append to scripts.postinstall if it already exists', async () => {\n-    const packageJson = JSON.parse(host.readContent('/package.json'));\n-    packageJson['scripts'] = {\n-      postinstall: 'angular rocks',\n-    };\n-    host.overwrite('/package.json', JSON.stringify(packageJson));\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const content = host.readContent('/package.json');\n-    const json = JSON.parse(content);\n-    expect(json.scripts['postinstall'])\n-        .toBe('angular rocks; ngcc --properties es2015 browser module main');\n-  });\n-\n-  it('should update ngcc in scripts.postinstall if it already exists', async () => {\n-    const packageJson = JSON.parse(host.readContent('/package.json'));\n-    packageJson['scripts'] = {\n-      postinstall:\n-          'ngcc --properties es2015 browser module main --first-only --create-ivy-entry-points',\n-    };\n-    host.overwrite('/package.json', JSON.stringify(packageJson));\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const content = host.readContent('/package.json');\n-    const json = JSON.parse(content);\n-    expect(json.scripts['postinstall']).toBe('ngcc --properties es2015 browser module main');\n-  });\n-\n-  it('should not create Bazel workspace file', async () => {\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const {files} = host;\n-    expect(files).not.toContain('/WORKSPACE');\n-    expect(files).not.toContain('/BUILD.bazel');\n-  });\n-\n-  it('should produce main.dev.ts and main.prod.ts for AOT', async () => {\n-    host.create('/src/main.ts', 'generated by CLI');\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const {files} = host;\n-    // main.dev.ts and main.prod.ts are used by Bazel for AOT\n-    expect(files).toContain('/src/main.dev.ts');\n-    expect(files).toContain('/src/main.prod.ts');\n-    // main.ts is produced by original ng-add schematics\n-    // This file should be present for backwards compatibility.\n-    expect(files).toContain('/src/main.ts');\n-  });\n-\n-  it('should not overwrite index.html with script tags', async () => {\n-    host.create('/src/index.html', '<html>Hello World</html>');\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const {files} = host;\n-    expect(files).toContain('/src/index.html');\n-    const content = host.readContent('/src/index.html');\n-    expect(content).not.toMatch('<script src=\"/zone.umd.min.js\"></script>');\n-    expect(content).not.toMatch('<script src=\"/bundle.min.js\"></script>');\n-  });\n-\n-  it('should generate main.dev.ts and main.prod.ts', async () => {\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const {files} = host;\n-    expect(files).toContain('/src/main.dev.ts');\n-    expect(files).toContain('/src/main.prod.ts');\n-  });\n-\n-  it('should overwrite .gitignore for bazel-out directory', async () => {\n-    host.create('.gitignore', '\\n# compiled output\\n');\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const {files} = host;\n-    expect(files).toContain('/.gitignore');\n-    const content = host.readContent('/.gitignore');\n-    expect(content).toMatch('\\n# compiled output\\n/bazel-out\\n');\n-  });\n-\n-  it('should create a backup for original angular.json', async () => {\n-    expect(host.files).toContain('/angular.json');\n-    const original = host.readContent('/angular.json');\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    expect(host.files).toContain('/angular.json.bak');\n-    const content = host.readContent('/angular.json.bak');\n-    expect(content.startsWith('// This is a backup file')).toBe(true);\n-    expect(content).toMatch(original);\n-  });\n-\n-  it('should update angular.json to use Bazel builder', async () => {\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    const {files} = host;\n-    expect(files).toContain('/angular.json');\n-    const content = host.readContent('/angular.json');\n-    expect(() => JSON.parse(content)).not.toThrow();\n-    const json = JSON.parse(content);\n-    const demo = json.projects.demo;\n-    const demo_e2e = json.projects['demo-e2e'];\n-    const {build, serve, test} = demo.architect;\n-    expect(build.builder).toBe('@angular/bazel:build');\n-    expect(serve.builder).toBe('@angular/bazel:build');\n-    expect(test.builder).toBe('@angular/bazel:build');\n-    const {e2e, lint} = demo_e2e.architect;\n-    expect(e2e.builder).toBe('@angular/bazel:build');\n-    // it should leave non-Bazel commands unmodified\n-    expect(demo.architect['extract-i18n'].builder)\n-        .toBe('@angular-devkit/build-angular:extract-i18n');\n-    expect(lint.builder).toBe('@angular-devkit/build-angular:tslint');\n-  });\n-\n-  it('should get defaultProject if name is not provided', async () => {\n-    const options = {};\n-    host = await schematicRunner.runSchematicAsync('ng-add', options, host).toPromise();\n-    const content = host.readContent('/angular.json');\n-    const json = JSON.parse(content);\n-    const builder = json.projects.demo.architect.build.builder;\n-    expect(builder).toBe('@angular/bazel:build');\n-  });\n-\n-  describe('rxjs', () => {\n-    const cases = [\n-      // version|upgrade\n-      ['6.3.3', true],\n-      ['~6.3.3', true],\n-      ['^6.3.3', true],\n-      ['~6.3.11', true],\n-      ['6.4.0', true],\n-      ['~6.4.0', true],\n-      ['~6.4.1', true],\n-      ['6.5.0', false],\n-      ['~6.5.0', false],\n-      ['^6.5.0', false],\n-      ['~7.0.1', false],\n-    ];\n-    for (const [version, upgrade] of cases) {\n-      it(`should ${upgrade ? '' : 'not '}upgrade v${version}')`, async () => {\n-        host.overwrite('package.json', JSON.stringify({\n-          name: 'demo',\n-          dependencies: {\n-            '@angular/core': '1.2.3',\n-            'rxjs': version,\n-          },\n-          devDependencies: {\n-            'typescript': '3.2.2',\n-          },\n-        }));\n-        host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-        expect(host.files).toContain('/package.json');\n-        const content = host.readContent('/package.json');\n-        const json = JSON.parse(content);\n-        if (upgrade) {\n-          expect(json.dependencies.rxjs).toBe('~6.5.3');\n-        } else {\n-          expect(json.dependencies.rxjs).toBe(version);\n-        }\n-      });\n-    }\n-  });\n-\n-  it('should add a postinstall step to package.json', async () => {\n-    host = await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    expect(host.files).toContain('/package.json');\n-    const content = host.readContent('/package.json');\n-    const json = JSON.parse(content);\n-    expect(json.scripts.postinstall).toBe('ngcc --properties es2015 browser module main');\n-  });\n-\n-  it('should work when run on a minimal project (without test and e2e targets)', async () => {\n-    host.overwrite('angular.json', JSON.stringify({\n-      projects: {\n-        'demo': {\n-          architect: {\n-            build: {},\n-            serve: {},\n-            'extract-i18n': {\n-              builder: '@angular-devkit/build-angular:extract-i18n',\n-            },\n-          },\n-        },\n-      },\n-    }));\n-\n-    let error: Error|null = null;\n-\n-    try {\n-      await schematicRunner.runSchematicAsync('ng-add', defaultOptions, host).toPromise();\n-    } catch (e) {\n-      error = e;\n-    }\n-\n-    expect(error).toBeNull();\n-  });\n-});"
        },
        {
            "sha": "9fa5a4be2b5eef336155ea195a8fd13d2b66177b",
            "filename": "packages/bazel/src/schematics/ng-add/schema.d.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 18,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-add%2Fschema.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-add%2Fschema.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-add%2Fschema.d.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,18 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-export interface Schema {\n-  /**\n-   * The name of the project.\n-   */\n-  name?: string;\n-  /**\n-   * When true, does not install dependency packages.\n-   */\n-  skipInstall?: boolean;\n-}"
        },
        {
            "sha": "05ffc596da4d4e0c2ce755bd76616dcdc32ff101",
            "filename": "packages/bazel/src/schematics/ng-new/index.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 33,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-new%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-new%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-new%2Findex.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,33 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- *\n- * @fileoverview Schematics for ng-new project that builds with Bazel.\n- */\n-\n-import {chain, externalSchematic, Rule, schematic, Tree} from '@angular-devkit/schematics';\n-import {validateProjectName} from '@schematics/angular/utility/validation';\n-\n-import {Schema} from './schema';\n-\n-export default function(options: Schema): Rule {\n-  return (host: Tree) => {\n-    validateProjectName(options.name);\n-\n-    return chain([\n-      externalSchematic('@schematics/angular', 'ng-new', options),\n-      schematic(\n-          'ng-add', {\n-            name: options.name,\n-            // skip install since `ng-new` above will schedule the task\n-            skipInstall: true,\n-          },\n-          {\n-            scope: options.name,\n-          }),\n-    ]);\n-  };\n-}"
        },
        {
            "sha": "99322d7bacabcc8c529fc6da553efde689300bdd",
            "filename": "packages/bazel/src/schematics/ng-new/index_spec.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 37,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-new%2Findex_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-new%2Findex_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-new%2Findex_spec.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,37 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import {SchematicTestRunner} from '@angular-devkit/schematics/testing';\n-\n-describe('ng-new schematic', () => {\n-  const schematicRunner = new SchematicTestRunner(\n-      '@angular/bazel',\n-      require.resolve('../collection.json'),\n-  );\n-  const defaultOptions = {\n-    name: 'demo',\n-    version: '7.0.0',\n-  };\n-\n-  it('should call external @schematics/angular', async () => {\n-    const options = {...defaultOptions};\n-    const host = await schematicRunner.runSchematicAsync('ng-new', options).toPromise();\n-    const {files} = host;\n-    // External schematic should produce workspace file angular.json\n-    expect(files).toContain('/demo/angular.json');\n-    expect(files).toContain('/demo/package.json');\n-  });\n-\n-  it('should call ng-add to generate additional files needed by Bazel', async () => {\n-    const options = {...defaultOptions};\n-    const host = await schematicRunner.runSchematicAsync('ng-new', options).toPromise();\n-    const {files} = host;\n-    expect(files).toContain('/demo/src/main.dev.ts');\n-    expect(files).toContain('/demo/src/main.prod.ts');\n-  });\n-});"
        },
        {
            "sha": "a734a45e27abd3b8e8d50b1fc20f3f036cabfb30",
            "filename": "packages/bazel/src/schematics/ng-new/schema.d.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 112,
            "changes": 112,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-new%2Fschema.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-new%2Fschema.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fschematics%2Fng-new%2Fschema.d.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,112 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-export interface Schema {\n-  /**\n-   * Initial git repository commit information.\n-   */\n-  commit?: CommitUnion;\n-  /**\n-   * When true (the default), creates a new initial app project in the src folder of the new\n-   * workspace. When false, creates an empty workspace with no initial app. You can then use\n-   * the generate application command so that all apps are created in the projects folder.\n-   */\n-  createApplication?: boolean;\n-  /**\n-   * The directory name to create the workspace in.\n-   */\n-  directory?: string;\n-  /**\n-   * When true, creates a new app that uses the Ivy rendering engine.\n-   */\n-  enableIvy?: boolean;\n-  /**\n-   * When true, includes styles inline in the component TS file. By default, an external\n-   * styles file is created and referenced in the component TS file.\n-   */\n-  inlineStyle?: boolean;\n-  /**\n-   * When true, includes template inline in the component TS file. By default, an external\n-   * template file is created and referenced in the component TS file.\n-   */\n-  inlineTemplate?: boolean;\n-  /**\n-   * When true, links the CLI to the global version (internal development only).\n-   */\n-  linkCli?: boolean;\n-  /**\n-   * When true, creates a project without any testing frameworks. (Use for learning purposes\n-   * only.)\n-   */\n-  minimal?: boolean;\n-  /**\n-   * The name of the new workspace and initial project.\n-   */\n-  name: string;\n-  /**\n-   * The path where new projects will be created, relative to the new workspace root.\n-   */\n-  newProjectRoot?: string;\n-  /**\n-   * The prefix to apply to generated selectors for the initial project.\n-   */\n-  prefix?: string;\n-  /**\n-   * When true, generates a routing module for the initial project.\n-   */\n-  routing?: boolean;\n-  /**\n-   * When true, does not initialize a git repository.\n-   */\n-  skipGit?: boolean;\n-  /**\n-   * When true, does not install dependency packages.\n-   */\n-  skipInstall?: boolean;\n-  /**\n-   * When true, does not generate \"spec.ts\" test files for the new project.\n-   */\n-  skipTests?: boolean;\n-  /**\n-   * The file extension or preprocessor to use for style files.\n-   */\n-  style?: Style;\n-  /**\n-   * The version of the Angular CLI to use.\n-   */\n-  version: string;\n-  /**\n-   * The view encapsulation strategy to use in the initial project.\n-   */\n-  viewEncapsulation?: ViewEncapsulation;\n-}\n-/**\n- * Initial git repository commit information.\n- */\n-export declare type CommitUnion = boolean | CommitObject;\n-export interface CommitObject {\n-  email: string;\n-  message?: string;\n-  name: string;\n-}\n-/**\n- * The file extension or preprocessor to use for style files.\n- */\n-export declare enum Style {\n-  Css = 'css',\n-  Sass = 'sass',\n-  Scss = 'scss',\n-}\n-/**\n- * The view encapsulation strategy to use in the initial project.\n- */\n-export declare enum ViewEncapsulation {\n-  Emulated = 'Emulated',\n-  None = 'None',\n-  ShadowDom = 'ShadowDom'\n-}"
        },
        {
            "sha": "4feb7f5f8fbbc269f1d0cf7ee53344847acb064f",
            "filename": "packages/bazel/src/schematics/utility/json-utils.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 65,
            "changes": 65,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fjson-utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fjson-utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fjson-utils.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,65 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import {JsonAstNode, JsonAstObject, JsonValue} from '@angular-devkit/core';\n-import {UpdateRecorder} from '@angular-devkit/schematics';\n-import {findPropertyInAstObject} from '@schematics/angular/utility/json-utils';\n-\n-/**\n- * Replace the value of the key-value pair in the 'node' object with a different\n- * 'value' and record the update using the specified 'recorder'.\n- */\n-export function replacePropertyInAstObject(\n-    recorder: UpdateRecorder, node: JsonAstObject, propertyName: string, value: JsonValue,\n-    indent: number = 0) {\n-  const property = findPropertyInAstObject(node, propertyName);\n-  if (property === null) {\n-    throw new Error(`Property '${propertyName}' does not exist in JSON object`);\n-  }\n-  const {start, text} = property;\n-  recorder.remove(start.offset, text.length);\n-  const indentStr = '\\n' +\n-      ' '.repeat(indent);\n-  const content = JSON.stringify(value, null, '  ').replace(/\\n/g, indentStr);\n-  recorder.insertLeft(start.offset, content);\n-}\n-\n-/**\n- * Remove the key-value pair with the specified 'key' in the specified 'node'\n- * object and record the update using the specified 'recorder'.\n- */\n-export function removeKeyValueInAstObject(\n-    recorder: UpdateRecorder, content: string, node: JsonAstObject, key: string) {\n-  for (const [i, prop] of node.properties.entries()) {\n-    if (prop.key.value === key) {\n-      const start = prop.start.offset;\n-      const end = prop.end.offset;\n-      let length = end - start;\n-      const match = content.slice(end).match(/^[,\\s]+/);\n-      if (match) {\n-        length += match.pop()!.length;\n-      }\n-      recorder.remove(start, length);\n-      if (i === node.properties.length - 1) {  // last property\n-        let offset = 0;\n-        while (/(,|\\s)/.test(content.charAt(start - offset - 1))) {\n-          offset++;\n-        }\n-        recorder.remove(start - offset, offset);\n-      }\n-      return;\n-    }\n-  }\n-}\n-\n-/**\n- * Returns true if the specified 'node' is a JsonAstObject, false otherwise.\n- */\n-export function isJsonAstObject(node: JsonAstNode|null): node is JsonAstObject {\n-  return !!node && node.kind === 'object';\n-}"
        },
        {
            "sha": "e8abe05120d1bc70726eaf1114ffc0ca58dca26b",
            "filename": "packages/bazel/src/schematics/utility/json-utils_spec.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 110,
            "changes": 110,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fjson-utils_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fjson-utils_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fjson-utils_spec.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,110 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import {JsonAstObject, parseJsonAst} from '@angular-devkit/core';\n-import {HostTree} from '@angular-devkit/schematics';\n-import {UnitTestTree} from '@angular-devkit/schematics/testing';\n-import {isJsonAstObject, removeKeyValueInAstObject, replacePropertyInAstObject} from './json-utils';\n-\n-describe('JsonUtils', () => {\n-  let tree: UnitTestTree;\n-  beforeEach(() => {\n-    tree = new UnitTestTree(new HostTree());\n-  });\n-\n-  describe('replacePropertyInAstObject', () => {\n-    it('should replace property', () => {\n-      const content = JSON.stringify({foo: {bar: 'baz'}});\n-      tree.create('tmp', content);\n-      const ast = parseJsonAst(content) as JsonAstObject;\n-      const recorder = tree.beginUpdate('tmp');\n-      replacePropertyInAstObject(recorder, ast, 'foo', [1, 2, 3]);\n-      tree.commitUpdate(recorder);\n-      const value = tree.readContent('tmp');\n-      expect(JSON.parse(value)).toEqual({\n-        foo: [1, 2, 3],\n-      });\n-      expect(value).toBe(`{\"foo\":[\n-  1,\n-  2,\n-  3\n-]}`);\n-    });\n-\n-    it('should respect the indent parameter', () => {\n-      const content = JSON.stringify({hello: 'world'}, null, 2);\n-      tree.create('tmp', content);\n-      const ast = parseJsonAst(content) as JsonAstObject;\n-      const recorder = tree.beginUpdate('tmp');\n-      replacePropertyInAstObject(recorder, ast, 'hello', 'world!', 2);\n-      tree.commitUpdate(recorder);\n-      const value = tree.readContent('tmp');\n-      expect(JSON.parse(value)).toEqual({\n-        hello: 'world!',\n-      });\n-      expect(value).toBe(`{\n-  \"hello\": \"world!\"\n-}`);\n-    });\n-\n-    it('should throw error if property is not found', () => {\n-      const content = JSON.stringify({});\n-      tree.create('tmp', content);\n-      const ast = parseJsonAst(content) as JsonAstObject;\n-      const recorder = tree.beginUpdate('tmp');\n-      expect(() => replacePropertyInAstObject(recorder, ast, 'foo', 'bar'))\n-          .toThrowError(`Property 'foo' does not exist in JSON object`);\n-    });\n-  });\n-\n-  describe('removeKeyValueInAstObject', () => {\n-    it('should remove key-value pair', () => {\n-      const content = JSON.stringify({hello: 'world', foo: 'bar'});\n-      tree.create('tmp', content);\n-      const ast = parseJsonAst(content) as JsonAstObject;\n-      let recorder = tree.beginUpdate('tmp');\n-      removeKeyValueInAstObject(recorder, content, ast, 'foo');\n-      tree.commitUpdate(recorder);\n-      const tmp = tree.readContent('tmp');\n-      expect(JSON.parse(tmp)).toEqual({\n-        hello: 'world',\n-      });\n-      expect(tmp).toBe('{\"hello\":\"world\"}');\n-      recorder = tree.beginUpdate('tmp');\n-      const newContent = tree.readContent('tmp');\n-      removeKeyValueInAstObject(recorder, newContent, ast, 'hello');\n-      tree.commitUpdate(recorder);\n-      const value = tree.readContent('tmp');\n-      expect(JSON.parse(value)).toEqual({});\n-      expect(value).toBe('{}');\n-    });\n-\n-    it('should be a noop if key is not found', () => {\n-      const content = JSON.stringify({foo: 'bar'});\n-      tree.create('tmp', content);\n-      const ast = parseJsonAst(content) as JsonAstObject;\n-      let recorder = tree.beginUpdate('tmp');\n-      expect(() => removeKeyValueInAstObject(recorder, content, ast, 'hello')).not.toThrow();\n-      tree.commitUpdate(recorder);\n-      const value = tree.readContent('tmp');\n-      expect(JSON.parse(value)).toEqual({foo: 'bar'});\n-      expect(value).toBe('{\"foo\":\"bar\"}');\n-    });\n-  });\n-\n-  describe('isJsonAstObject', () => {\n-    it('should return true for an object', () => {\n-      const ast = parseJsonAst(JSON.stringify({}));\n-      expect(isJsonAstObject(ast)).toBe(true);\n-    });\n-    it('should return false for a non-object', () => {\n-      const ast = parseJsonAst(JSON.stringify([]));\n-      expect(isJsonAstObject(ast)).toBe(false);\n-    });\n-  });\n-});"
        },
        {
            "sha": "ef1f43e608f13d31ee754bb0c16b17a4a6ce12d2",
            "filename": "packages/bazel/src/schematics/utility/workspace-utils.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 40,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fworkspace-utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fworkspace-utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fworkspace-utils.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,40 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import {JsonAstNode, JsonAstObject} from '@angular-devkit/core';\n-import {findPropertyInAstObject} from '@schematics/angular/utility/json-utils';\n-import {isJsonAstObject} from './json-utils';\n-\n-/**\n- * Find the e2e architect node in the JSON ast.\n- * The e2e application is relocated alongside the existing application.\n- * This function supports looking up the e2e architect in both the new and old\n- * layout.\n- * See https://github.com/angular/angular-cli/pull/13780\n- */\n-export function findE2eArchitect(ast: JsonAstObject, name: string): JsonAstObject|null {\n-  const projects = findPropertyInAstObject(ast, 'projects');\n-  if (!isJsonAstObject(projects)) {\n-    return null;\n-  }\n-  let architect: JsonAstNode|null;\n-  const e2e = findPropertyInAstObject(projects, `${name}-e2e`);\n-  if (isJsonAstObject(e2e)) {\n-    architect = findPropertyInAstObject(e2e, 'architect');\n-  } else {\n-    const project = findPropertyInAstObject(projects, name);\n-    if (!isJsonAstObject(project)) {\n-      return null;\n-    }\n-    architect = findPropertyInAstObject(project, 'architect');\n-  }\n-  if (!isJsonAstObject(architect)) {\n-    return null;\n-  }\n-  return architect;\n-}"
        },
        {
            "sha": "6d8909f32a1c57918380b8ba877e2e679ff40ddb",
            "filename": "packages/bazel/src/schematics/utility/workspace-utils_spec.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 42,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fworkspace-utils_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fworkspace-utils_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fschematics%2Futility%2Fworkspace-utils_spec.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -1,42 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import {JsonAstObject, parseJsonAst} from '@angular-devkit/core';\n-import {isJsonAstObject} from './json-utils';\n-import {findE2eArchitect} from './workspace-utils';\n-\n-describe('Workspace utils', () => {\n-  describe('findE2eArchitect', () => {\n-    it('should find e2e architect in old project layout', () => {\n-      const workspace = {\n-        projects: {\n-          demo: {},\n-          'demo-e2e': {\n-            architect: {},\n-          },\n-        },\n-      };\n-      const ast = parseJsonAst(JSON.stringify(workspace));\n-      const architect = findE2eArchitect(ast as JsonAstObject, 'demo');\n-      expect(isJsonAstObject(architect)).toBe(true);\n-    });\n-\n-    it('should find e2e architect in new project layout', () => {\n-      const workspace = {\n-        projects: {\n-          demo: {\n-            architect: {},\n-          },\n-        },\n-      };\n-      const ast = parseJsonAst(JSON.stringify(workspace));\n-      const architect = findE2eArchitect(ast as JsonAstObject, 'demo');\n-      expect(isJsonAstObject(architect)).toBe(true);\n-    });\n-  });\n-});"
        }
    ],
    "stats": {
        "total": 1452,
        "additions": 1,
        "deletions": 1451
    }
}