{
    "author": "gkalpak",
    "message": "refactor(docs-infra): convert `deploy-to-firebase` script to ESM (#43963)\n\nConvert the `deploy-to-firebase` script (and corresponding tests) from\nCommonJS format to ESM.\n\nPR Close #43963",
    "sha": "4f4b2b5ac901c339f085ea531608f379dede8271",
    "files": [
        {
            "sha": "a22f2fc0174b3da4ed53b8f5df8915052d412c7c",
            "filename": "aio/aio-builds-setup/docs/misc--integrate-with-ci.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Faio-builds-setup%2Fdocs%2Fmisc--integrate-with-ci.md",
            "raw_url": "https://github.com/angular/angular/raw/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Faio-builds-setup%2Fdocs%2Fmisc--integrate-with-ci.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Faio-builds-setup%2Fdocs%2Fmisc--integrate-with-ci.md?ref=4f4b2b5ac901c339f085ea531608f379dede8271",
            "patch": "@@ -6,4 +6,4 @@ TODO (gkalpak): Add docs. Mention:\n   Relevant files: `aio/aio-builds-setup/scripts/test.sh`\n - Deploying from CI.\n   Relevant files: `.circleci/config.yml`, `scripts/ci/deploy.sh`, `aio/scripts/build-artifacts.sh`,\n-  `aio/scripts/deploy-to-firebase/index.js`\n+  `aio/scripts/deploy-to-firebase/index.mjs`"
        },
        {
            "sha": "f0a7d61cc8d3a4a8ebec5c88b829fd317c4ff0aa",
            "filename": "aio/package.json",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fpackage.json?ref=4f4b2b5ac901c339f085ea531608f379dede8271",
            "patch": "@@ -44,7 +44,7 @@\n     \"example-use-local\": \"node tools/ng-packages-installer overwrite ./tools/examples/shared --debug --force\",\n     \"example-use-npm\": \"node tools/ng-packages-installer restore ./tools/examples/shared\",\n     \"example-check-local\": \"node tools/ng-packages-installer check ./tools/examples/shared\",\n-    \"deploy-production\": \"node scripts/deploy-to-firebase\",\n+    \"deploy-production\": \"node scripts/deploy-to-firebase/index.mjs\",\n     \"check-env\": \"yarn ~~check-env\",\n     \"postcheck-env\": \"yarn aio-check-local\",\n     \"payload-size\": \"scripts/payload.sh\",\n@@ -56,8 +56,8 @@\n     \"docs-test\": \"node tools/transforms/test.js\",\n     \"redirects-test\": \"node tests/deployment/unit/test\",\n     \"firebase-utils-test\": \"node tools/firebase-test-utils/test\",\n-    \"tools-lint\": \"eslint scripts/deploy-to-firebase && eslint tools/firebase-test-utils && eslint tools/ng-packages-installer\",\n-    \"tools-test\": \"yarn docs-test && yarn boilerplate:test && jasmine tools/ng-packages-installer/index.spec.js && jasmine scripts/deploy-to-firebase/**/*.spec.js && yarn firebase-utils-test\",\n+    \"tools-lint\": \"eslint --ext=.mjs scripts/deploy-to-firebase && eslint tools/firebase-test-utils && eslint tools/ng-packages-installer\",\n+    \"tools-test\": \"yarn docs-test && yarn boilerplate:test && jasmine tools/ng-packages-installer/index.spec.js && jasmine scripts/deploy-to-firebase/**/*.spec.mjs && yarn firebase-utils-test\",\n     \"preserve-and-sync\": \"yarn docs\",\n     \"serve-and-sync\": \"run-p \\\"docs-watch --watch-only\\\" \\\"start {@}\\\" --\",\n     \"boilerplate:add\": \"node ./tools/examples/example-boilerplate add\","
        },
        {
            "sha": "f70e9c8f14a4b66106abfe3e8bdd2b1c492cb1d4",
            "filename": "aio/scripts/deploy-to-firebase/.eslintrc.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Fscripts%2Fdeploy-to-firebase%2F.eslintrc.js",
            "raw_url": "https://github.com/angular/angular/raw/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Fscripts%2Fdeploy-to-firebase%2F.eslintrc.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2F.eslintrc.js?ref=4f4b2b5ac901c339f085ea531608f379dede8271",
            "patch": "@@ -8,6 +8,9 @@ module.exports = {\n     jasmine: true,\n     node: true,\n   },\n+  parserOptions: {\n+    sourceType: 'module',\n+  },\n   plugins: [\n     'jasmine',\n   ],"
        },
        {
            "sha": "e3529fa1072c77d43fd8027d0e2d1cb0c3bf0475",
            "filename": "aio/scripts/deploy-to-firebase/index.mjs",
            "status": "renamed",
            "additions": 24,
            "deletions": 13,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "raw_url": "https://github.com/angular/angular/raw/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs?ref=4f4b2b5ac901c339f085ea531608f379dede8271",
            "patch": "@@ -2,11 +2,12 @@\n //\n // WARNING: `CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN` should NOT be printed.\n //\n-'use strict';\n \n-const {cd, cp, exec, mv, sed, set} = require('shelljs');\n+import {dirname} from 'path';\n+import sh from 'shelljs';\n+import {fileURLToPath} from 'url';\n \n-set('-e');\n+sh.set('-e');\n \n \n // Constants\n@@ -15,18 +16,23 @@ const NG_REMOTE_URL = `https://github.com/${REPO_SLUG}.git`;\n const GIT_REMOTE_REFS_CACHE = new Map();\n \n // Exports\n-module.exports = {\n+export {\n   computeDeploymentsInfo,\n   computeInputVars,\n   computeMajorVersion,\n+  getDirname,\n   getLatestCommit,\n   getMostRecentMinorBranch,\n   skipDeployment,\n   validateDeploymentsInfo,\n };\n \n // Run\n-if (require.main === module) {\n+// ESM alternative for CommonJS' `require.main === module`. For simplicity, we assume command\n+// references the full file path (including the file extension).\n+// See https://stackoverflow.com/questions/45136831/node-js-require-main-module#answer-60309682 for\n+// more details.\n+if (fileURLToPath(import.meta.url) === process.argv[1]) {\n   const isDryRun = process.argv[2] === '--dry-run';\n   const inputVars = computeInputVars(process.env);\n   const deploymentsInfo = computeDeploymentsInfo(inputVars);\n@@ -67,7 +73,7 @@ function build({deployedUrl, deployEnv}) {\n   yarn(`build --configuration=${deployEnv} --progress=false`);\n \n   console.log('\\n\\n\\n==== Add any mode-specific files into the AIO distribution. ====\\n');\n-  cp('-rf', `src/extra-files/${deployEnv}/.`, 'dist/');\n+  sh.cp('-rf', `src/extra-files/${deployEnv}/.`, 'dist/');\n \n   console.log('\\n\\n\\n==== Update opensearch descriptor for AIO with `deployedUrl`. ====\\n');\n   yarn(`set-opensearch-url ${deployedUrl.replace(/[^/]$/, '$&/')}`);  // The URL must end with `/`.\n@@ -270,7 +276,7 @@ function deploy(data) {\n     siteId,\n   } = data;\n \n-  cd(`${__dirname}/../..`);\n+  sh.cd(`${getDirname(import.meta.url)}/../..`);\n \n   console.log('\\n\\n\\n==== Run pre-deploy actions. ====\\n');\n   preDeployActions.forEach(fn => fn(data));\n@@ -286,6 +292,10 @@ function deploy(data) {\n   postDeployActions.forEach(fn => fn(data));\n }\n \n+function getDirname(fileUrl) {\n+  return dirname(fileURLToPath(fileUrl));\n+}\n+\n function getRemoteRefs(refOrPattern, {remote = NG_REMOTE_URL, retrieveFromCache = true} = {}) {\n   // If remote refs for the same `refOrPattern` and `remote` have been requested before, return the\n   // cached results. This improves the performance and ensures a more stable behavior.\n@@ -298,7 +308,7 @@ function getRemoteRefs(refOrPattern, {remote = NG_REMOTE_URL, retrieveFromCache\n   const cmd = `git ls-remote ${remote} ${refOrPattern}`;\n   const result = (retrieveFromCache && GIT_REMOTE_REFS_CACHE.has(cmd)) ?\n     GIT_REMOTE_REFS_CACHE.get(cmd) :\n-    exec(cmd, {silent: true}).trim().split('\\n');\n+    sh.exec(cmd, {silent: true}).trim().split('\\n');\n \n   // Cache the result for future use (regardless of the value of `retrieveFromCache`).\n   GIT_REMOTE_REFS_CACHE.set(cmd, result);\n@@ -337,13 +347,13 @@ function redirectToAngularIo() {\n   // See https://firebase.google.com/docs/hosting/full-config#redirects.\n   const redirectRule =\n       '{\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"https://angular.io:1\"}';\n-  sed('-i', /(\\s*)\"redirects\": \\[/, `$&\\n$1  ${redirectRule},\\n`, 'firebase.json');\n+  sh.sed('-i', /(\\s*)\"redirects\": \\[/, `$&\\n$1  ${redirectRule},\\n`, 'firebase.json');\n }\n \n function removeServiceWorker() {\n   // Rename the SW manifest (`ngsw.json`). This will cause the ServiceWorker to unregister itself.\n   // See https://angular.io/guide/service-worker-devops#fail-safe.\n-  mv('dist/ngsw.json', 'dist/ngsw.json.bak');\n+  sh.mv('dist/ngsw.json', 'dist/ngsw.json.bak');\n }\n \n function serializeActions(actions) {\n@@ -360,7 +370,8 @@ function testNoActiveRcDeployment({deployedUrl}) {\n   // Ensure a request for `ngsw.json` returns 404.\n   const ngswJsonUrl = `${deployedOrigin}/ngsw.json`;\n   const ngswJsonScript = `https.get('${ngswJsonUrl}', res => console.log(res.statusCode))`;\n-  const ngswJsonActualStatusCode = exec(`node --eval \"${ngswJsonScript}\"`, {silent: true}).trim();\n+  const ngswJsonActualStatusCode =\n+      sh.exec(`node --eval \"${ngswJsonScript}\"`, {silent: true}).trim();\n   const ngswJsonExpectedStatusCode = '404';\n \n   if (ngswJsonActualStatusCode !== ngswJsonExpectedStatusCode) {\n@@ -374,7 +385,7 @@ function testNoActiveRcDeployment({deployedUrl}) {\n   const fooBarScript =\n       `https.get('${fooBarUrl}', res => console.log(res.statusCode, res.headers.location))`;\n   const [fooBarActualStatusCode, fooBarActualRedirectUrl] =\n-      exec(`node --eval \"${fooBarScript}\"`, {silent: true}).trim().split(' ');\n+      sh.exec(`node --eval \"${fooBarScript}\"`, {silent: true}).trim().split(' ');\n   const fooBarExpectedStatusCode = '302';\n   const fooBarExpectedRedirectUrl = 'https://angular.io/foo/bar?baz=qux';\n \n@@ -480,5 +491,5 @@ function yarn(cmd) {\n   // This is not strictly necessary, since CircleCI will mask secret environment variables in the\n   // output (see https://circleci.com/docs/2.0/env-vars/#secrets-masking), but is an extra\n   // precaution.\n-  return exec(`yarn --silent ${cmd}`);\n+  return sh.exec(`yarn --silent ${cmd}`);\n }",
            "previous_filename": "aio/scripts/deploy-to-firebase/index.js"
        },
        {
            "sha": "d5a4427dc42843727fd0aa63b49ff6e93751ac79",
            "filename": "aio/scripts/deploy-to-firebase/index.spec.mjs",
            "status": "renamed",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs?ref=4f4b2b5ac901c339f085ea531608f379dede8271",
            "patch": "@@ -1,16 +1,14 @@\n-#!/usr/bin/env node\n-'use strict';\n-\n-const {execSync} = require('child_process');\n-const {\n+import {execSync} from 'child_process';\n+import {\n   computeDeploymentsInfo,\n   computeInputVars,\n   computeMajorVersion,\n+  getDirname,\n   getLatestCommit,\n   getMostRecentMinorBranch,\n   skipDeployment,\n   validateDeploymentsInfo,\n-} = require('./index');\n+} from './index.mjs';\n \n \n describe('deploy-to-firebase:', () => {\n@@ -424,7 +422,8 @@ describe('deploy-to-firebase:', () => {\n     // and thus does not share the `getRemoteRefs()` cache. To improve stability, we retrieve the\n     // latest commit from master ignoring any cached entries.\n     const latestCommitOnMaster = getLatestCommit('master', {retrieveFromCache: false});\n-    const cmd = `\"${process.execPath}\" \"${__dirname}\" --dry-run`;\n+    const scriptPath = `${getDirname(import.meta.url)}/index.mjs`;\n+    const cmd = `\"${process.execPath}\" \"${scriptPath}\" --dry-run`;\n     const env = {\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',",
            "previous_filename": "aio/scripts/deploy-to-firebase/index.spec.js"
        },
        {
            "sha": "558e1cadee729740c8cb567fa8526692dcd1cdf8",
            "filename": "aio/src/extra-files/README.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Fsrc%2Fextra-files%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/4f4b2b5ac901c339f085ea531608f379dede8271/aio%2Fsrc%2Fextra-files%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fextra-files%2FREADME.md?ref=4f4b2b5ac901c339f085ea531608f379dede8271",
            "patch": "@@ -4,7 +4,7 @@ This folder is used for extra files that should be included in deployments to fi\n \n After the AIO application had been built and before it is deployed all files and folders inside the folder with the same name as the current deployment mode (next, stable, archive) will be copied to the `dist` folder.\n \n-See the `scripts/deploy-to-firebase/index.js` script for more details.\n+See the `scripts/deploy-to-firebase/index.mjs` script for more details.\n \n **Note:**\n The script always expects there to be a folder for the current deployment mode (even if it is empty)."
        }
    ],
    "stats": {
        "total": 63,
        "additions": 38,
        "deletions": 25
    }
}