{
    "author": "petebacondarwin",
    "message": "test(compiler-cli):  create initial \"linked compile\" compliance tests (#39617)\n\nThis commit adds bazel rules to test whether linking the golden partial\nfiles for test cases produces the same output as a full compile of the\ntest case would.\n\nPR Close #39617",
    "sha": "e719419d3f95c488d86126739df9197a89d1caff",
    "files": [
        {
            "sha": "e98f95b35d8cec5e8e8e0b7fe352445f58926a07",
            "filename": "packages/compiler-cli/test/compliance/linked/BUILD.bazel",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/e719419d3f95c488d86126739df9197a89d1caff/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e719419d3f95c488d86126739df9197a89d1caff/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2FBUILD.bazel?ref=e719419d3f95c488d86126739df9197a89d1caff",
            "patch": "@@ -0,0 +1,29 @@\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"ts_library\")\n+\n+ts_library(\n+    name = \"test_lib\",\n+    testonly = True,\n+    srcs = [\"linked_compile_spec.ts\"],\n+    deps = [\n+        \"//packages/compiler-cli/linker/babel\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/test/compliance/test_helpers\",\n+        \"@npm//@types/babel__core\",\n+    ],\n+)\n+\n+jasmine_node_test(\n+    name = \"linked\",\n+    bootstrap = [\"//tools/testing:node_no_angular_es5\"],\n+    data = [\n+        \"//packages/compiler-cli/test/compliance/test_cases\",\n+        \"//packages/compiler-cli/test/ngtsc/fake_core:npm_package\",\n+    ],\n+    shard_count = 2,\n+    tags = [\n+        \"ivy-only\",\n+    ],\n+    deps = [\n+        \":test_lib\",\n+    ],\n+)"
        },
        {
            "sha": "af99c45cd8615fd58408abd1f0e983823d0d7969",
            "filename": "packages/compiler-cli/test/compliance/linked/linked_compile_spec.ts",
            "status": "added",
            "additions": 79,
            "deletions": 0,
            "changes": 79,
            "blob_url": "https://github.com/angular/angular/blob/e719419d3f95c488d86126739df9197a89d1caff/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e719419d3f95c488d86126739df9197a89d1caff/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts?ref=e719419d3f95c488d86126739df9197a89d1caff",
            "patch": "@@ -0,0 +1,79 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {PluginObj, transformSync} from '@babel/core';\n+\n+import {createEs2015LinkerPlugin} from '../../../linker/babel';\n+import {AbsoluteFsPath, FileSystem} from '../../../src/ngtsc/file_system';\n+import {getBuildOutputDirectory} from '../test_helpers/compile_test';\n+import {ComplianceTest} from '../test_helpers/get_compliance_tests';\n+import {parseGoldenPartial} from '../test_helpers/golden_partials';\n+import {runTests} from '../test_helpers/test_runner';\n+\n+runTests('partial compile + link', linkPartials);\n+\n+/**\n+ * Link all the partials specified in the given `test`.\n+ *\n+ * @param fs The mock file-system to use for linking the partials.\n+ * @param test The compliance test whose partials will be linked.\n+ */\n+function linkPartials(fs: FileSystem, test: ComplianceTest): void {\n+  const builtDirectory = getBuildOutputDirectory(fs);\n+  const linkerPlugin = createEs2015LinkerPlugin(test.angularCompilerOptions);\n+  const goldenPartialPath = fs.resolve('/GOLDEN_PARTIAL.js');\n+  if (!fs.exists(goldenPartialPath)) {\n+    throw new Error(\n+        'Golden partial does not exist for this test\\n' +\n+        'Try generating it by running:\\n' +\n+        `bazel run //packages/compiler-cli/test/compliance/test_cases:${\n+            test.relativePath}.golden.update`);\n+  }\n+  const partialFile = fs.readFile(goldenPartialPath);\n+  const partials = parseGoldenPartial(partialFile).filter(f => f.path.endsWith('.js'));\n+  for (const partial of partials) {\n+    const linkedSource =\n+        applyLinker({fileName: partial.path, source: partial.content}, linkerPlugin);\n+    safeWrite(fs, fs.resolve(builtDirectory, partial.path), linkedSource);\n+  }\n+}\n+\n+/**\n+ * Run the file through the Babel linker plugin.\n+ *\n+ * It will ignore files that do not have a `.js` extension.\n+ *\n+ * @param file The file name and its source to be transformed using the linker.\n+ * @param linkerPlugin The linker plugin to apply.\n+ * @returns The file's source content, which has been transformed using the linker if necessary.\n+ */\n+function applyLinker(file: {fileName: string; source: string}, linkerPlugin: PluginObj): string {\n+  if (!file.fileName.endsWith('.js')) {\n+    return file.source;\n+  }\n+  const result = transformSync(file.source, {\n+    filename: file.fileName,\n+    plugins: [linkerPlugin],\n+    parserOpts: {sourceType: 'unambiguous'},\n+  });\n+  if (result === null) {\n+    throw fail('Babel transform did not have output');\n+  }\n+  if (result.code == null) {\n+    throw fail('Babel transform result does not have any code');\n+  }\n+  return result.code;\n+}\n+\n+/**\n+ * Write the `content` to the `path` on the `fs` file-system, first ensuring that the containing\n+ * directory exists.\n+ */\n+function safeWrite(fs: FileSystem, path: AbsoluteFsPath, content: string): void {\n+  fs.ensureDir(fs.dirname(path));\n+  fs.writeFile(path, content);\n+}"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 108,
        "deletions": 0
    }
}