{
    "author": "petebacondarwin",
    "message": "fix(compiler-cli): handle `\\r\\n` line-endings correctly in source-mapping (#40187)\n\nPreviously `\\r\\n` was being treated as a single character in source-map\nline start positions, which caused segment positions to become offset.\n\nNow the `\\r` is ignored when splitting, leaving it at the end of the\nprevious line, which solves the offsetting problem, and does not affect\nsource-mappings.\n\nFixes #40169\nFixes #39654\n\nPR Close #40187",
    "sha": "34f083c8edc64347488ef64232f1271c7a7b06df",
    "files": [
        {
            "sha": "32d29e893a6bafa28383f09788319ff44b08364c",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/src/source_file.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/34f083c8edc64347488ef64232f1271c7a7b06df/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file.ts",
            "raw_url": "https://github.com/angular/angular/raw/34f083c8edc64347488ef64232f1271c7a7b06df/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file.ts?ref=34f083c8edc64347488ef64232f1271c7a7b06df",
            "patch": "@@ -446,5 +446,5 @@ export function computeStartOfLinePositions(str: string) {\n }\n \n function computeLineLengths(str: string): number[] {\n-  return (str.split(/\\r?\\n/)).map(s => s.length);\n+  return (str.split(/\\n/)).map(s => s.length);\n }"
        },
        {
            "sha": "b374cafea6ee687fbd7d0bdca957653d13e80fb4",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/test/segment_marker_spec.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 13,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/34f083c8edc64347488ef64232f1271c7a7b06df/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsegment_marker_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/34f083c8edc64347488ef64232f1271c7a7b06df/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsegment_marker_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsegment_marker_spec.ts?ref=34f083c8edc64347488ef64232f1271c7a7b06df",
            "patch": "@@ -79,31 +79,32 @@ describe('SegmentMarker utils', () => {\n     it('should return a new marker offset by the given chars', () => {\n       const startOfLinePositions =\n           computeStartOfLinePositions('012345\\n0123456789\\r\\n012*4567\\n0123456');\n-      const marker = {line: 2, column: 3, position: 21, next: undefined};\n+      const marker = {line: 2, column: 3, position: 22, next: undefined};\n+\n       expect(offsetSegment(startOfLinePositions, marker, 1))\n-          .toEqual({line: 2, column: 4, position: 22, next: undefined});\n+          .toEqual({line: 2, column: 4, position: 23, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, 2))\n-          .toEqual({line: 2, column: 5, position: 23, next: undefined});\n+          .toEqual({line: 2, column: 5, position: 24, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, 4))\n-          .toEqual({line: 2, column: 7, position: 25, next: undefined});\n+          .toEqual({line: 2, column: 7, position: 26, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, 6))\n-          .toEqual({line: 3, column: 0, position: 27, next: undefined});\n+          .toEqual({line: 3, column: 0, position: 28, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, 8))\n-          .toEqual({line: 3, column: 2, position: 29, next: undefined});\n+          .toEqual({line: 3, column: 2, position: 30, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, 20))\n-          .toEqual({line: 3, column: 14, position: 41, next: undefined});\n+          .toEqual({line: 3, column: 14, position: 42, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, -1))\n-          .toEqual({line: 2, column: 2, position: 20, next: undefined});\n+          .toEqual({line: 2, column: 2, position: 21, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, -2))\n-          .toEqual({line: 2, column: 1, position: 19, next: undefined});\n+          .toEqual({line: 2, column: 1, position: 20, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, -3))\n-          .toEqual({line: 2, column: 0, position: 18, next: undefined});\n+          .toEqual({line: 2, column: 0, position: 19, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, -4))\n-          .toEqual({line: 1, column: 10, position: 17, next: undefined});\n+          .toEqual({line: 1, column: 11, position: 18, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, -6))\n-          .toEqual({line: 1, column: 8, position: 15, next: undefined});\n+          .toEqual({line: 1, column: 9, position: 16, next: undefined});\n       expect(offsetSegment(startOfLinePositions, marker, -16))\n-          .toEqual({line: 0, column: 5, position: 5, next: undefined});\n+          .toEqual({line: 0, column: 6, position: 6, next: undefined});\n     });\n   });\n });"
        },
        {
            "sha": "5fb7dad115be5128ea77126b57fae952d01297b7",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/test/source_file_spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/34f083c8edc64347488ef64232f1271c7a7b06df/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/34f083c8edc64347488ef64232f1271c7a7b06df/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_spec.ts?ref=34f083c8edc64347488ef64232f1271c7a7b06df",
            "patch": "@@ -677,8 +677,9 @@ runInEachFileSystem(() => {\n         expect(computeStartOfLinePositions('abc\\n')).toEqual([0, 4]);\n         expect(computeStartOfLinePositions('\\nabc')).toEqual([0, 1]);\n         expect(computeStartOfLinePositions('abc\\ndefg')).toEqual([0, 4]);\n-        expect(computeStartOfLinePositions('abc\\r\\n')).toEqual([0, 4]);\n-        expect(computeStartOfLinePositions('abc\\r\\ndefg')).toEqual([0, 4]);\n+        expect(computeStartOfLinePositions('abc\\r\\n')).toEqual([0, 5]);\n+        expect(computeStartOfLinePositions('abc\\r\\ndefg')).toEqual([0, 5]);\n+        expect(computeStartOfLinePositions('abc\\uD83D\\uDE80\\ndefðŸš€\\r\\n')).toEqual([0, 6, 13]);\n       });\n     });\n   });"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 18,
        "deletions": 16
    }
}