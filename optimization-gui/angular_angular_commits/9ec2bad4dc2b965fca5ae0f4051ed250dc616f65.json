{
    "author": "bjarkler",
    "message": "refactor(core): make HTML sanitizer return TrustedHTML (#39218)\n\nMake Angular's HTML sanitizer return a TrustedHTML, as its output is\ntrusted not to cause XSS vulnerabilities when used in a context where a\nbrowser may parse and evaluate HTML. Also update tests to reflect the\nnew behaviour.\n\nPR Close #39218",
    "sha": "9ec2bad4dc2b965fca5ae0f4051ed250dc616f65",
    "files": [
        {
            "sha": "b0b30311a041f5f3511eff7edf79104d3b301020",
            "filename": "packages/core/src/sanitization/html_sanitizer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/9ec2bad4dc2b965fca5ae0f4051ed250dc616f65/packages%2Fcore%2Fsrc%2Fsanitization%2Fhtml_sanitizer.ts",
            "raw_url": "https://github.com/angular/angular/raw/9ec2bad4dc2b965fca5ae0f4051ed250dc616f65/packages%2Fcore%2Fsrc%2Fsanitization%2Fhtml_sanitizer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fsanitization%2Fhtml_sanitizer.ts?ref=9ec2bad4dc2b965fca5ae0f4051ed250dc616f65",
            "patch": "@@ -7,6 +7,8 @@\n  */\n \n import {isDevMode} from '../util/is_dev_mode';\n+import {TrustedHTML} from '../util/security/trusted_type_defs';\n+import {trustedHTMLFromString} from '../util/security/trusted_types';\n import {getInertBodyHelper, InertBodyHelper} from './inert_body';\n import {_sanitizeUrl, sanitizeSrcset} from './url_sanitizer';\n \n@@ -242,7 +244,7 @@ let inertBodyHelper: InertBodyHelper;\n  * Sanitizes the given unsafe, untrusted HTML fragment, and returns HTML text that is safe to add to\n  * the DOM in a browser environment.\n  */\n-export function _sanitizeHtml(defaultDoc: any, unsafeHtmlInput: string): string {\n+export function _sanitizeHtml(defaultDoc: any, unsafeHtmlInput: string): TrustedHTML|string {\n   let inertBodyElement: HTMLElement|null = null;\n   try {\n     inertBodyHelper = inertBodyHelper || getInertBodyHelper(defaultDoc);\n@@ -274,7 +276,7 @@ export function _sanitizeHtml(defaultDoc: any, unsafeHtmlInput: string): string\n           'WARNING: sanitizing HTML stripped some content, see http://g.co/ng/security#xss');\n     }\n \n-    return safeHtml;\n+    return trustedHTMLFromString(safeHtml);\n   } finally {\n     // In case anything goes wrong, clear out inertElement to reset the entire DOM structure.\n     if (inertBodyElement) {"
        },
        {
            "sha": "aae4a184213049d185b0ebbae44af688c02fca5c",
            "filename": "packages/core/test/sanitization/html_sanitizer_spec.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 44,
            "changes": 91,
            "blob_url": "https://github.com/angular/angular/blob/9ec2bad4dc2b965fca5ae0f4051ed250dc616f65/packages%2Fcore%2Ftest%2Fsanitization%2Fhtml_sanitizer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9ec2bad4dc2b965fca5ae0f4051ed250dc616f65/packages%2Fcore%2Ftest%2Fsanitization%2Fhtml_sanitizer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fsanitization%2Fhtml_sanitizer_spec.ts?ref=9ec2bad4dc2b965fca5ae0f4051ed250dc616f65",
            "patch": "@@ -11,6 +11,10 @@ import {browserDetection} from '@angular/platform-browser/testing/src/browser_ut\n import {_sanitizeHtml} from '../../src/sanitization/html_sanitizer';\n import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n \n+function sanitizeHtml(defaultDoc: any, unsafeHtmlInput: string): string {\n+  return _sanitizeHtml(defaultDoc, unsafeHtmlInput).toString();\n+}\n+\n {\n   describe('HTML sanitizer', () => {\n     let defaultDoc: any;\n@@ -29,73 +33,73 @@ import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n     });\n \n     it('serializes nested structures', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<div alt=\"x\"><p>a</p>b<b>c<a alt=\"more\">d</a></b>e</div>'))\n+      expect(sanitizeHtml(defaultDoc, '<div alt=\"x\"><p>a</p>b<b>c<a alt=\"more\">d</a></b>e</div>'))\n           .toEqual('<div alt=\"x\"><p>a</p>b<b>c<a alt=\"more\">d</a></b>e</div>');\n       expect(logMsgs).toEqual([]);\n     });\n \n     it('serializes self closing elements', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<p>Hello <br> World</p>'))\n+      expect(sanitizeHtml(defaultDoc, '<p>Hello <br> World</p>'))\n           .toEqual('<p>Hello <br> World</p>');\n     });\n \n     it('supports namespaced elements', () => {\n-      expect(_sanitizeHtml(defaultDoc, 'a<my:hr/><my:div>b</my:div>c')).toEqual('abc');\n+      expect(sanitizeHtml(defaultDoc, 'a<my:hr/><my:div>b</my:div>c')).toEqual('abc');\n     });\n \n     it('supports namespaced attributes', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<a xlink:href=\"something\">t</a>'))\n+      expect(sanitizeHtml(defaultDoc, '<a xlink:href=\"something\">t</a>'))\n           .toEqual('<a xlink:href=\"something\">t</a>');\n-      expect(_sanitizeHtml(defaultDoc, '<a xlink:evil=\"something\">t</a>')).toEqual('<a>t</a>');\n-      expect(_sanitizeHtml(defaultDoc, '<a xlink:href=\"javascript:foo()\">t</a>'))\n+      expect(sanitizeHtml(defaultDoc, '<a xlink:evil=\"something\">t</a>')).toEqual('<a>t</a>');\n+      expect(sanitizeHtml(defaultDoc, '<a xlink:href=\"javascript:foo()\">t</a>'))\n           .toEqual('<a xlink:href=\"unsafe:javascript:foo()\">t</a>');\n     });\n \n     it('supports HTML5 elements', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<main><summary>Works</summary></main>'))\n+      expect(sanitizeHtml(defaultDoc, '<main><summary>Works</summary></main>'))\n           .toEqual('<main><summary>Works</summary></main>');\n     });\n \n     it('supports ARIA attributes', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<h1 role=\"presentation\" aria-haspopup=\"true\">Test</h1>'))\n+      expect(sanitizeHtml(defaultDoc, '<h1 role=\"presentation\" aria-haspopup=\"true\">Test</h1>'))\n           .toEqual('<h1 role=\"presentation\" aria-haspopup=\"true\">Test</h1>');\n-      expect(_sanitizeHtml(defaultDoc, '<i aria-label=\"Info\">Info</i>'))\n+      expect(sanitizeHtml(defaultDoc, '<i aria-label=\"Info\">Info</i>'))\n           .toEqual('<i aria-label=\"Info\">Info</i>');\n-      expect(_sanitizeHtml(defaultDoc, '<img src=\"pteranodon.jpg\" aria-details=\"details\">'))\n+      expect(sanitizeHtml(defaultDoc, '<img src=\"pteranodon.jpg\" aria-details=\"details\">'))\n           .toEqual('<img src=\"pteranodon.jpg\" aria-details=\"details\">');\n     });\n \n     it('sanitizes srcset attributes', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<img srcset=\"/foo.png 400px, javascript:evil() 23px\">'))\n+      expect(sanitizeHtml(defaultDoc, '<img srcset=\"/foo.png 400px, javascript:evil() 23px\">'))\n           .toEqual('<img srcset=\"/foo.png 400px, unsafe:javascript:evil() 23px\">');\n     });\n \n     it('supports sanitizing plain text', () => {\n-      expect(_sanitizeHtml(defaultDoc, 'Hello, World')).toEqual('Hello, World');\n+      expect(sanitizeHtml(defaultDoc, 'Hello, World')).toEqual('Hello, World');\n     });\n \n     it('ignores non-element, non-attribute nodes', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<!-- comments? -->no.')).toEqual('no.');\n-      expect(_sanitizeHtml(defaultDoc, '<?pi nodes?>no.')).toEqual('no.');\n+      expect(sanitizeHtml(defaultDoc, '<!-- comments? -->no.')).toEqual('no.');\n+      expect(sanitizeHtml(defaultDoc, '<?pi nodes?>no.')).toEqual('no.');\n       expect(logMsgs.join('\\n')).toMatch(/sanitizing HTML stripped some content/);\n     });\n \n     it('supports sanitizing escaped entities', () => {\n-      expect(_sanitizeHtml(defaultDoc, '&#128640;')).toEqual('&#128640;');\n+      expect(sanitizeHtml(defaultDoc, '&#128640;')).toEqual('&#128640;');\n       expect(logMsgs).toEqual([]);\n     });\n \n     it('does not warn when just re-encoding text', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<p>Hellö Wörld</p>'))\n+      expect(sanitizeHtml(defaultDoc, '<p>Hellö Wörld</p>'))\n           .toEqual('<p>Hell&#246; W&#246;rld</p>');\n       expect(logMsgs).toEqual([]);\n     });\n \n     it('escapes entities', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<p>Hello &lt; World</p>'))\n+      expect(sanitizeHtml(defaultDoc, '<p>Hello &lt; World</p>'))\n           .toEqual('<p>Hello &lt; World</p>');\n-      expect(_sanitizeHtml(defaultDoc, '<p>Hello < World</p>')).toEqual('<p>Hello &lt; World</p>');\n-      expect(_sanitizeHtml(defaultDoc, '<p alt=\"% &amp; &quot; !\">Hello</p>'))\n+      expect(sanitizeHtml(defaultDoc, '<p>Hello < World</p>')).toEqual('<p>Hello &lt; World</p>');\n+      expect(sanitizeHtml(defaultDoc, '<p alt=\"% &amp; &quot; !\">Hello</p>'))\n           .toEqual('<p alt=\"% &amp; &#34; !\">Hello</p>');  // NB: quote encoded as ASCII &#34;.\n     });\n \n@@ -110,7 +114,7 @@ import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n       ];\n       for (const tag of dangerousTags) {\n         it(tag, () => {\n-          expect(_sanitizeHtml(defaultDoc, `<${tag}>evil!</${tag}>`)).toEqual('evil!');\n+          expect(sanitizeHtml(defaultDoc, `<${tag}>evil!</${tag}>`)).toEqual('evil!');\n         });\n       }\n \n@@ -125,7 +129,7 @@ import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n       ];\n       for (const tag of dangerousSelfClosingTags) {\n         it(tag, () => {\n-          expect(_sanitizeHtml(defaultDoc, `before<${tag}>After`)).toEqual('beforeAfter');\n+          expect(sanitizeHtml(defaultDoc, `before<${tag}>After`)).toEqual('beforeAfter');\n         });\n       }\n \n@@ -136,15 +140,15 @@ import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n       ];\n       for (const tag of dangerousSkipContentTags) {\n         it(tag, () => {\n-          expect(_sanitizeHtml(defaultDoc, `<${tag}>evil!</${tag}>`)).toEqual('');\n+          expect(sanitizeHtml(defaultDoc, `<${tag}>evil!</${tag}>`)).toEqual('');\n         });\n       }\n \n       it(`frame`, () => {\n         // `<frame>` is special, because different browsers treat it differently (e.g. remove it\n         // altogether). // We just verify that (one way or another), there is no `<frame>` element\n         // after sanitization.\n-        expect(_sanitizeHtml(defaultDoc, `<frame>evil!</frame>`)).not.toContain('<frame>');\n+        expect(sanitizeHtml(defaultDoc, `<frame>evil!</frame>`)).not.toContain('<frame>');\n       });\n     });\n \n@@ -153,45 +157,45 @@ import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n \n       for (const attr of dangerousAttrs) {\n         it(`${attr}`, () => {\n-          expect(_sanitizeHtml(defaultDoc, `<a ${attr}=\"x\">evil!</a>`)).toEqual('<a>evil!</a>');\n+          expect(sanitizeHtml(defaultDoc, `<a ${attr}=\"x\">evil!</a>`)).toEqual('<a>evil!</a>');\n         });\n       }\n     });\n \n     it('ignores content of script elements', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<script>var foo=\"<p>bar</p>\"</script>')).toEqual('');\n-      expect(_sanitizeHtml(defaultDoc, '<script>var foo=\"<p>bar</p>\"</script><div>hi</div>'))\n+      expect(sanitizeHtml(defaultDoc, '<script>var foo=\"<p>bar</p>\"</script>')).toEqual('');\n+      expect(sanitizeHtml(defaultDoc, '<script>var foo=\"<p>bar</p>\"</script><div>hi</div>'))\n           .toEqual('<div>hi</div>');\n-      expect(_sanitizeHtml(defaultDoc, '<style>\\<\\!-- something--\\>hi</style>')).toEqual('');\n+      expect(sanitizeHtml(defaultDoc, '<style>\\<\\!-- something--\\>hi</style>')).toEqual('');\n     });\n \n     it('ignores content of style elements', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<style><!-- foobar --></style><div>hi</div>'))\n+      expect(sanitizeHtml(defaultDoc, '<style><!-- foobar --></style><div>hi</div>'))\n           .toEqual('<div>hi</div>');\n-      expect(_sanitizeHtml(defaultDoc, '<style><!-- foobar --></style>')).toEqual('');\n-      expect(_sanitizeHtml(defaultDoc, '<style>\\<\\!-- something--\\>hi</style>')).toEqual('');\n+      expect(sanitizeHtml(defaultDoc, '<style><!-- foobar --></style>')).toEqual('');\n+      expect(sanitizeHtml(defaultDoc, '<style>\\<\\!-- something--\\>hi</style>')).toEqual('');\n       expect(logMsgs.join('\\n')).toMatch(/sanitizing HTML stripped some content/);\n     });\n \n     it('should strip unclosed iframe tag', () => {\n-      expect(_sanitizeHtml(defaultDoc, '<iframe>')).toEqual('');\n+      expect(sanitizeHtml(defaultDoc, '<iframe>')).toEqual('');\n       expect([\n         '&lt;iframe&gt;',\n         // Double-escaped on IE\n         '&amp;lt;iframe&amp;gt;'\n-      ]).toContain(_sanitizeHtml(defaultDoc, '<iframe><iframe>'));\n+      ]).toContain(sanitizeHtml(defaultDoc, '<iframe><iframe>'));\n       expect([\n         '&lt;script&gt;evil();&lt;/script&gt;',\n         // Double-escaped on IE\n         '&amp;lt;script&amp;gt;evil();&amp;lt;/script&amp;gt;'\n-      ]).toContain(_sanitizeHtml(defaultDoc, '<iframe><script>evil();</script>'));\n+      ]).toContain(sanitizeHtml(defaultDoc, '<iframe><script>evil();</script>'));\n     });\n \n     it('should ignore extraneous body tags', () => {\n-      expect(_sanitizeHtml(defaultDoc, '</body>')).toEqual('');\n-      expect(_sanitizeHtml(defaultDoc, 'foo</body>bar')).toEqual('foobar');\n-      expect(_sanitizeHtml(defaultDoc, 'foo<body>bar')).toEqual('foobar');\n-      expect(_sanitizeHtml(defaultDoc, 'fo<body>ob</body>ar')).toEqual('foobar');\n+      expect(sanitizeHtml(defaultDoc, '</body>')).toEqual('');\n+      expect(sanitizeHtml(defaultDoc, 'foo</body>bar')).toEqual('foobar');\n+      expect(sanitizeHtml(defaultDoc, 'foo<body>bar')).toEqual('foobar');\n+      expect(sanitizeHtml(defaultDoc, 'fo<body>ob</body>ar')).toEqual('foobar');\n     });\n \n     it('should not enter an infinite loop on clobbered elements', () => {\n@@ -200,18 +204,17 @@ import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n       // Anyway what we want to test is that browsers do not enter an infinite loop which would\n       // result in a timeout error for the test.\n       try {\n-        _sanitizeHtml(defaultDoc, '<form><input name=\"parentNode\" /></form>');\n+        sanitizeHtml(defaultDoc, '<form><input name=\"parentNode\" /></form>');\n       } catch (e) {\n         // depending on the browser, we might ge an exception\n       }\n       try {\n-        _sanitizeHtml(defaultDoc, '<form><input name=\"nextSibling\" /></form>');\n+        sanitizeHtml(defaultDoc, '<form><input name=\"nextSibling\" /></form>');\n       } catch (e) {\n         // depending on the browser, we might ge an exception\n       }\n       try {\n-        _sanitizeHtml(\n-            defaultDoc, '<form><div><div><input name=\"nextSibling\" /></div></div></form>');\n+        sanitizeHtml(defaultDoc, '<form><div><div><input name=\"nextSibling\" /></div></div></form>');\n       } catch (e) {\n         // depending on the browser, we might ge an exception\n       }\n@@ -220,7 +223,7 @@ import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n     // See\n     // https://github.com/cure53/DOMPurify/blob/a992d3a75031cb8bb032e5ea8399ba972bdf9a65/src/purify.js#L439-L449\n     it('should not allow JavaScript execution when creating inert document', () => {\n-      const output = _sanitizeHtml(defaultDoc, '<svg><g onload=\"window.xxx = 100\"></g></svg>');\n+      const output = sanitizeHtml(defaultDoc, '<svg><g onload=\"window.xxx = 100\"></g></svg>');\n       const window = defaultDoc.defaultView;\n       if (window) {\n         expect(window.xxx).toBe(undefined);\n@@ -232,7 +235,7 @@ import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n     // See https://github.com/cure53/DOMPurify/releases/tag/0.6.7\n     it('should not allow JavaScript hidden in badly formed HTML to get through sanitization (Firefox bug)',\n        () => {\n-         expect(_sanitizeHtml(\n+         expect(sanitizeHtml(\n                     defaultDoc, '<svg><p><style><img src=\"</style><img src=x onerror=alert(1)//\">'))\n              .toEqual(\n                  isDOMParserAvailable() ?\n@@ -245,7 +248,7 @@ import {isDOMParserAvailable} from '../../src/sanitization/inert_body';\n     if (browserDetection.isWebkit) {\n       it('should prevent mXSS attacks', function() {\n         // In Chrome Canary 62, the ideographic space character is kept as a stringified HTML entity\n-        expect(_sanitizeHtml(defaultDoc, '<a href=\"&#x3000;javascript:alert(1)\">CLICKME</a>'))\n+        expect(sanitizeHtml(defaultDoc, '<a href=\"&#x3000;javascript:alert(1)\">CLICKME</a>'))\n             .toMatch(/<a href=\"unsafe:(&#12288;)?javascript:alert\\(1\\)\">CLICKME<\\/a>/);\n       });\n     }"
        },
        {
            "sha": "e144427a6d91aba1bb47212041467efd8c98207f",
            "filename": "packages/core/test/sanitization/sanitization_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/9ec2bad4dc2b965fca5ae0f4051ed250dc616f65/packages%2Fcore%2Ftest%2Fsanitization%2Fsanitization_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9ec2bad4dc2b965fca5ae0f4051ed250dc616f65/packages%2Fcore%2Ftest%2Fsanitization%2Fsanitization_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fsanitization%2Fsanitization_spec.ts?ref=9ec2bad4dc2b965fca5ae0f4051ed250dc616f65",
            "patch": "@@ -29,11 +29,11 @@ describe('sanitization', () => {\n     }\n   }\n   it('should sanitize html', () => {\n-    expect(ɵɵsanitizeHtml('<div></div>')).toEqual('<div></div>');\n-    expect(ɵɵsanitizeHtml(new Wrap('<div></div>'))).toEqual('<div></div>');\n-    expect(ɵɵsanitizeHtml('<img src=\"javascript:true\">'))\n+    expect(ɵɵsanitizeHtml('<div></div>').toString()).toEqual('<div></div>');\n+    expect(ɵɵsanitizeHtml(new Wrap('<div></div>')).toString()).toEqual('<div></div>');\n+    expect(ɵɵsanitizeHtml('<img src=\"javascript:true\">').toString())\n         .toEqual('<img src=\"unsafe:javascript:true\">');\n-    expect(ɵɵsanitizeHtml(new Wrap('<img src=\"javascript:true\">')))\n+    expect(ɵɵsanitizeHtml(new Wrap('<img src=\"javascript:true\">')).toString())\n         .toEqual('<img src=\"unsafe:javascript:true\">');\n     expect(() => ɵɵsanitizeHtml(bypassSanitizationTrustUrl('<img src=\"javascript:true\">')))\n         .toThrowError(/Required a safe HTML, got a URL/);"
        },
        {
            "sha": "1521a93f39b783f706bc798f95c418c5c52913b6",
            "filename": "packages/platform-browser/src/security/dom_sanitization_service.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9ec2bad4dc2b965fca5ae0f4051ed250dc616f65/packages%2Fplatform-browser%2Fsrc%2Fsecurity%2Fdom_sanitization_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/9ec2bad4dc2b965fca5ae0f4051ed250dc616f65/packages%2Fplatform-browser%2Fsrc%2Fsecurity%2Fdom_sanitization_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Fsrc%2Fsecurity%2Fdom_sanitization_service.ts?ref=9ec2bad4dc2b965fca5ae0f4051ed250dc616f65",
            "patch": "@@ -162,7 +162,7 @@ export class DomSanitizerImpl extends DomSanitizer {\n         if (allowSanitizationBypassOrThrow(value, BypassType.Html)) {\n           return unwrapSafeValue(value);\n         }\n-        return _sanitizeHtml(this._doc, String(value));\n+        return _sanitizeHtml(this._doc, String(value)).toString();\n       case SecurityContext.STYLE:\n         if (allowSanitizationBypassOrThrow(value, BypassType.Style)) {\n           return unwrapSafeValue(value);"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 56,
        "deletions": 51
    }
}