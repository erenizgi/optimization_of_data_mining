{
    "author": "atscott",
    "message": "fix(core): clear the `RefreshTransplantedView` when detached (#38768)\n\nThe `RefreshTransplantedView` flag is used to indicate that the view or one of its children\nis transplanted and dirty, so it should still be refreshed as part of change detection.\nThis flag is set on the transplanted view itself as well setting a\ncounter on as its parents.\nWhen a transplanted view is detached and still has this flag, it means\nit got detached before it was refreshed. This can happen for \"backwards\nreferences\" or transplanted views that are inserted at a location that\nwas already checked. In this case, we should decrement the parent\ncounters _and_ clear the flag on the detached view so it's not seen as\n\"transplanted\" anymore (it is detached and has no parent counters to\nadjust).\n\nfixes #38619\n\nPR Close #38768",
    "sha": "d1415162cb799b6a735c84c82429b211334b91fd",
    "files": [
        {
            "sha": "890307318146cf1629fa4e172b548551095ee5c7",
            "filename": "packages/core/src/render3/node_manipulation.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d1415162cb799b6a735c84c82429b211334b91fd/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "raw_url": "https://github.com/angular/angular/raw/d1415162cb799b6a735c84c82429b211334b91fd/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts?ref=d1415162cb799b6a735c84c82429b211334b91fd",
            "patch": "@@ -300,6 +300,7 @@ function detachMovedView(declarationContainer: LContainer, lView: LView) {\n   // would be cleared and the counter decremented), we need to decrement the view counter here\n   // instead.\n   if (lView[FLAGS] & LViewFlags.RefreshTransplantedView) {\n+    lView[FLAGS] &= ~LViewFlags.RefreshTransplantedView;\n     updateTransplantedViewCount(insertionLContainer, -1);\n   }\n "
        },
        {
            "sha": "815aebcb5cc4b836998953889cb3bedda37ea56d",
            "filename": "packages/core/test/acceptance/change_detection_transplanted_view_spec.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 1,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/d1415162cb799b6a735c84c82429b211334b91fd/packages%2Fcore%2Ftest%2Facceptance%2Fchange_detection_transplanted_view_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d1415162cb799b6a735c84c82429b211334b91fd/packages%2Fcore%2Ftest%2Facceptance%2Fchange_detection_transplanted_view_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fchange_detection_transplanted_view_spec.ts?ref=d1415162cb799b6a735c84c82429b211334b91fd",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {CommonModule} from '@angular/common';\n-import {ChangeDetectionStrategy, ChangeDetectorRef, Component, DoCheck, Input, TemplateRef, Type, ViewChild} from '@angular/core';\n+import {ChangeDetectionStrategy, ChangeDetectorRef, Component, DoCheck, Input, TemplateRef, Type, ViewChild, ViewContainerRef} from '@angular/core';\n import {AfterViewChecked} from '@angular/core/src/core';\n import {ComponentFixture, TestBed} from '@angular/core/testing';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n@@ -594,6 +594,40 @@ describe('change detection for transplanted views', () => {\n             'SheldonSheldonSheldon',\n             'Expected transplanted view to be refreshed even when insertion is not dirty');\n   });\n+\n+  it('should not fail when change detecting detached transplanted view', () => {\n+    @Component({template: '<ng-template>{{incrementChecks()}}</ng-template>'})\n+    class AppComponent {\n+      @ViewChild(TemplateRef) templateRef!: TemplateRef<{}>;\n+\n+      constructor(readonly rootVref: ViewContainerRef, readonly cdr: ChangeDetectorRef) {}\n+\n+      checks = 0;\n+      incrementChecks() {\n+        this.checks++;\n+      }\n+    }\n+\n+    const fixture = TestBed.configureTestingModule({declarations: [AppComponent]})\n+                        .createComponent(AppComponent);\n+    const component = fixture.componentInstance;\n+    fixture.detectChanges();\n+\n+    const viewRef = component.templateRef.createEmbeddedView({});\n+    // This `ViewContainerRef` is for the root view\n+    component.rootVref.insert(viewRef);\n+    // `detectChanges` on this `ChangeDetectorRef` will refresh this view and children, not the root\n+    // view that has the transplanted `viewRef` inserted.\n+    component.cdr.detectChanges();\n+    // The template should not have been refreshed because it was inserted \"above\" the component so\n+    // `detectChanges` will not refresh it.\n+    expect(component.checks).toEqual(0);\n+\n+    // Detach view, manually call `detectChanges`, and verify the template was refreshed\n+    component.rootVref.detach();\n+    viewRef.detectChanges();\n+    expect(component.checks).toEqual(1);\n+  });\n });\n \n function trim(text: string|null): string {"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 36,
        "deletions": 1
    }
}