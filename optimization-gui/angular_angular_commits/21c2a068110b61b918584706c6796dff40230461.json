{
    "author": "devversion",
    "message": "fix(dev-infra): spawned child processes messing with tty output (#41948)\n\nCurrently we have a common utility method for running commands\nin a child process. This method pipes all stdout and stderr, but sets\nthe `stdin` to `inherited`. This seemed to work as expected in terms of\nallowing interactive commands being executed, but it messes with the\nTTY in Windows (and potentially other platforms) so that colors and\nprompts no longer work properly. See attached screenshot.\n\nWe fix this by not inheriting the stdin by default; but exposing\na dedicated method for interactive commands. This results in more\nreadable and obvious code too, so it's worth making this change\nregardless of the TTY issues.\n\nPR Close #41948",
    "sha": "21c2a068110b61b918584706c6796dff40230461",
    "files": [
        {
            "sha": "60f4eef9cfcaa4869d5284f756f3edf27143fdd8",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/21c2a068110b61b918584706c6796dff40230461/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/21c2a068110b61b918584706c6796dff40230461/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=21c2a068110b61b918584706c6796dff40230461",
            "patch": "@@ -5212,6 +5212,21 @@ const ReleaseBuildCommandModule = {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+/**\n+ * Spawns a given command with the specified arguments inside an interactive shell. All process\n+ * stdin, stdout and stderr output is printed to the current console.\n+ *\n+ * @returns a Promise resolving on success, and rejecting on command failure with the status code.\n+ */\n+function spawnInteractiveCommand(command, args, options) {\n+    if (options === void 0) { options = {}; }\n+    return new Promise(function (resolve, reject) {\n+        var commandText = command + \" \" + args.join(' ');\n+        debug(\"Executing command: \" + commandText);\n+        var childProcess = child_process.spawn(command, args, tslib.__assign(tslib.__assign({}, options), { shell: true, stdio: 'inherit' }));\n+        childProcess.on('exit', function (status) { return status === 0 ? resolve() : reject(status); });\n+    });\n+}\n /**\n  * Spawns a given command with the specified arguments inside a shell. All process stdout\n  * output is captured and returned as resolution on completion. Depending on the chosen\n@@ -5226,7 +5241,7 @@ function spawnWithDebugOutput(command, args, options) {\n         var commandText = command + \" \" + args.join(' ');\n         var outputMode = options.mode;\n         debug(\"Executing command: \" + commandText);\n-        var childProcess = child_process.spawn(command, args, tslib.__assign(tslib.__assign({}, options), { shell: true, stdio: ['inherit', 'pipe', 'pipe'] }));\n+        var childProcess = child_process.spawn(command, args, tslib.__assign(tslib.__assign({}, options), { shell: true, stdio: 'pipe' }));\n         var logOutput = '';\n         var stdout = '';\n         var stderr = '';\n@@ -5324,7 +5339,7 @@ function npmIsLoggedIn(registryUrl) {\n }\n /**\n  * Log into NPM at a provided registry.\n- * @throws With the process log output if the login fails.\n+ * @throws With the `npm login` status code if the login failed.\n  */\n function npmLogin(registryUrl) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n@@ -5335,7 +5350,9 @@ function npmLogin(registryUrl) {\n         if (registryUrl !== undefined) {\n             args.splice(1, 0, '--registry', registryUrl);\n         }\n-        yield spawnWithDebugOutput('npm', args);\n+        // The login command prompts for username, password and other profile information. Hence\n+        // the process needs to be interactive (i.e. respecting current TTYs stdin).\n+        yield spawnInteractiveCommand('npm', args);\n     });\n }\n /**"
        },
        {
            "sha": "64b72a810ce0941df8453d7db7282684d5fcd626",
            "filename": "dev-infra/release/publish/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/21c2a068110b61b918584706c6796dff40230461/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/21c2a068110b61b918584706c6796dff40230461/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Findex.ts?ref=21c2a068110b61b918584706c6796dff40230461",
            "patch": "@@ -12,7 +12,6 @@ import {spawnWithDebugOutput} from '../../utils/child-process';\n import {GithubConfig} from '../../utils/config';\n import {debug, error, info, log, promptConfirm, red, yellow} from '../../utils/console';\n import {GitClient} from '../../utils/git/index';\n-import {exec} from '../../utils/shelljs';\n import {ReleaseConfig} from '../config/index';\n import {ActiveReleaseTrains, fetchActiveReleaseTrains, nextBranchName} from '../versioning/active-release-trains';\n import {npmIsLoggedIn, npmLogin, npmLogout} from '../versioning/npm-publish';"
        },
        {
            "sha": "4f71583b11efb35604d994ae95fbf27722dff48a",
            "filename": "dev-infra/release/versioning/npm-publish.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/21c2a068110b61b918584706c6796dff40230461/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts",
            "raw_url": "https://github.com/angular/angular/raw/21c2a068110b61b918584706c6796dff40230461/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts?ref=21c2a068110b61b918584706c6796dff40230461",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import * as semver from 'semver';\n-import {spawnWithDebugOutput} from '../../utils/child-process';\n+import {spawnInteractiveCommand, spawnWithDebugOutput} from '../../utils/child-process';\n \n /**\n  * Runs NPM publish within a specified package directory.\n@@ -57,7 +57,7 @@ export async function npmIsLoggedIn(registryUrl: string|undefined): Promise<bool\n \n /**\n  * Log into NPM at a provided registry.\n- * @throws With the process log output if the login fails.\n+ * @throws With the `npm login` status code if the login failed.\n  */\n export async function npmLogin(registryUrl: string|undefined) {\n   const args = ['login', '--no-browser'];\n@@ -67,7 +67,9 @@ export async function npmLogin(registryUrl: string|undefined) {\n   if (registryUrl !== undefined) {\n     args.splice(1, 0, '--registry', registryUrl);\n   }\n-  await spawnWithDebugOutput('npm', args);\n+  // The login command prompts for username, password and other profile information. Hence\n+  // the process needs to be interactive (i.e. respecting current TTYs stdin).\n+  await spawnInteractiveCommand('npm', args);\n }\n \n /**"
        },
        {
            "sha": "1a1950f3d51f01d9d53cfc7b5fccebe9b0d32242",
            "filename": "dev-infra/utils/child-process.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/21c2a068110b61b918584706c6796dff40230461/dev-infra%2Futils%2Fchild-process.ts",
            "raw_url": "https://github.com/angular/angular/raw/21c2a068110b61b918584706c6796dff40230461/dev-infra%2Futils%2Fchild-process.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fchild-process.ts?ref=21c2a068110b61b918584706c6796dff40230461",
            "patch": "@@ -23,6 +23,22 @@ export interface SpawnedProcessResult {\n   stderr: string;\n }\n \n+/**\n+ * Spawns a given command with the specified arguments inside an interactive shell. All process\n+ * stdin, stdout and stderr output is printed to the current console.\n+ *\n+ * @returns a Promise resolving on success, and rejecting on command failure with the status code.\n+ */\n+export function spawnInteractiveCommand(\n+    command: string, args: string[], options: Omit<SpawnOptions, 'stdio'> = {}) {\n+  return new Promise<void>((resolve, reject) => {\n+    const commandText = `${command} ${args.join(' ')}`;\n+    debug(`Executing command: ${commandText}`);\n+    const childProcess = spawn(command, args, {...options, shell: true, stdio: 'inherit'});\n+    childProcess.on('exit', status => status === 0 ? resolve() : reject(status));\n+  });\n+}\n+\n /**\n  * Spawns a given command with the specified arguments inside a shell. All process stdout\n  * output is captured and returned as resolution on completion. Depending on the chosen\n@@ -40,8 +56,7 @@ export function spawnWithDebugOutput(\n \n     debug(`Executing command: ${commandText}`);\n \n-    const childProcess =\n-        spawn(command, args, {...options, shell: true, stdio: ['inherit', 'pipe', 'pipe']});\n+    const childProcess = spawn(command, args, {...options, shell: true, stdio: 'pipe'});\n     let logOutput = '';\n     let stdout = '';\n     let stderr = '';\n@@ -57,6 +72,7 @@ export function spawnWithDebugOutput(\n         process.stderr.write(message);\n       }\n     });\n+\n     childProcess.stdout.on('data', message => {\n       stdout += message;\n       logOutput += message;"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 43,
        "deletions": 9
    }
}