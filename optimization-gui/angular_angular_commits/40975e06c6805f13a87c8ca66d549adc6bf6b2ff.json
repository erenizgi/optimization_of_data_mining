{
    "author": "alxhub",
    "message": "fix(compiler-cli): perform DOM schema checks even in basic mode in g3 (#38943)\n\nIn Ivy, template type-checking has 3 modes: basic, full, and strict. The\nprimary difference between basic and full modes is that basic mode only\nchecks the top-level template, whereas full mode descends into nested\ntemplates (embedded views like ngIfs and ngFors). Ivy applies this approach\nto all of its template type-checking, including the DOM schema checks which\nvalidate whether an element is a valid component/directive or not.\n\nView Engine has both the basic and the full mode, with the same distinction.\nHowever in View Engine, DOM schema checks happen for the full template even\nin the basic mode.\n\nIvy's behavior here is technically a \"fix\" as it does not make sense for\nsome checks to apply to the full template and others only to the top-level\nview. However, since g3 relies exclusively on the basic mode of checking and\ndevelopers there are used to DOM checks applying throughout their template,\nthis commit re-enables the nested schema checks even in basic mode only in\ng3. This is done by enabling the checks only when Closure Compiler\nannotations are requested.\n\nOutside of g3, it's recommended that applications use at least the full mode\nof checking (controlled by the `fullTemplateTypeCheck` flag), and ideally\nthe strict mode (`strictTemplates`).\n\nPR Close #38943",
    "sha": "40975e06c6805f13a87c8ca66d549adc6bf6b2ff",
    "files": [
        {
            "sha": "48857f59b7d489d36e66852208cbf4a8ad41333d",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=40975e06c6805f13a87c8ca66d549adc6bf6b2ff",
            "patch": "@@ -423,6 +423,7 @@ export class NgCompiler {\n         applyTemplateContextGuards: strictTemplates,\n         checkQueries: false,\n         checkTemplateBodies: true,\n+        alwaysCheckSchemaInTemplateBodies: true,\n         checkTypeOfInputBindings: strictTemplates,\n         honorAccessModifiersForInputBindings: false,\n         strictNullInputBindings: strictTemplates,\n@@ -451,6 +452,9 @@ export class NgCompiler {\n         applyTemplateContextGuards: false,\n         checkQueries: false,\n         checkTemplateBodies: false,\n+        // Enable deep schema checking in \"basic\" template type-checking mode only if Closure\n+        // compilation is requested, which is a good proxy for \"only in google3\".\n+        alwaysCheckSchemaInTemplateBodies: this.closureCompilerEnabled,\n         checkTypeOfInputBindings: false,\n         strictNullInputBindings: false,\n         honorAccessModifiersForInputBindings: false,"
        },
        {
            "sha": "2ff9d963df84847d20cd4733cc5c4766807b2c1a",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/api.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts?ref=40975e06c6805f13a87c8ca66d549adc6bf6b2ff",
            "patch": "@@ -230,6 +230,12 @@ export interface TypeCheckingConfig {\n    */\n   checkTemplateBodies: boolean;\n \n+  /**\n+   * Whether to always apply DOM schema checks in template bodies, independently of the\n+   * `checkTemplateBodies` setting.\n+   */\n+  alwaysCheckSchemaInTemplateBodies: boolean;\n+\n   /**\n    * Whether to check resolvable queries.\n    *"
        },
        {
            "sha": "1bc4af979851ffe23059a1046f009c0ede46c4e9",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=40975e06c6805f13a87c8ca66d549adc6bf6b2ff",
            "patch": "@@ -1298,6 +1298,8 @@ class Scope {\n       this.templateCtxOpMap.set(node, ctxIndex);\n       if (this.tcb.env.config.checkTemplateBodies) {\n         this.opQueue.push(new TcbTemplateBodyOp(this.tcb, this, node));\n+      } else if (this.tcb.env.config.alwaysCheckSchemaInTemplateBodies) {\n+        this.appendDeepSchemaChecks(node.children);\n       }\n       this.checkAndAppendReferencesOfNode(node);\n     } else if (node instanceof TmplAstBoundText) {\n@@ -1401,6 +1403,33 @@ class Scope {\n       this.opQueue.push(new TcbUnclaimedOutputsOp(this.tcb, this, node, claimedOutputs));\n     }\n   }\n+\n+  private appendDeepSchemaChecks(nodes: TmplAstNode[]): void {\n+    for (const node of nodes) {\n+      if (!(node instanceof TmplAstElement || node instanceof TmplAstTemplate)) {\n+        continue;\n+      }\n+\n+      if (node instanceof TmplAstElement) {\n+        const claimedInputs = new Set<string>();\n+        const directives = this.tcb.boundTarget.getDirectivesOfNode(node);\n+        let hasDirectives: boolean;\n+        if (directives === null || directives.length === 0) {\n+          hasDirectives = false;\n+        } else {\n+          hasDirectives = true;\n+          for (const dir of directives) {\n+            for (const propertyName of dir.inputs.propertyNames) {\n+              claimedInputs.add(propertyName);\n+            }\n+          }\n+        }\n+        this.opQueue.push(new TcbDomSchemaCheckerOp(this.tcb, node, !hasDirectives, claimedInputs));\n+      }\n+\n+      this.appendDeepSchemaChecks(node.children);\n+    }\n+  }\n }\n \n interface TcbBoundInput {"
        },
        {
            "sha": "b756e306c9ebec313d9e7a2625751de47c48574e",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=40975e06c6805f13a87c8ca66d549adc6bf6b2ff",
            "patch": "@@ -167,6 +167,7 @@ export const ALL_ENABLED_CONFIG: TypeCheckingConfig = {\n   applyTemplateContextGuards: true,\n   checkQueries: false,\n   checkTemplateBodies: true,\n+  alwaysCheckSchemaInTemplateBodies: true,\n   checkTypeOfInputBindings: true,\n   honorAccessModifiersForInputBindings: true,\n   strictNullInputBindings: true,\n@@ -238,6 +239,7 @@ export function tcb(\n     checkTypeOfNonDomReferences: true,\n     checkTypeOfPipes: true,\n     checkTemplateBodies: true,\n+    alwaysCheckSchemaInTemplateBodies: true,\n     strictSafeNavigationTypes: true,\n     useContextGenericType: true,\n     strictLiteralTypes: true,"
        },
        {
            "sha": "886a78f958f8468c561bb22dcea38eb1fee314c6",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_check_block_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts?ref=40975e06c6805f13a87c8ca66d549adc6bf6b2ff",
            "patch": "@@ -700,6 +700,7 @@ describe('type check blocks', () => {\n       applyTemplateContextGuards: true,\n       checkQueries: false,\n       checkTemplateBodies: true,\n+      alwaysCheckSchemaInTemplateBodies: true,\n       checkTypeOfInputBindings: true,\n       honorAccessModifiersForInputBindings: false,\n       strictNullInputBindings: true,"
        },
        {
            "sha": "193373668bfbb577ae6ac415926632756880609c",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/40975e06c6805f13a87c8ca66d549adc6bf6b2ff/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=40975e06c6805f13a87c8ca66d549adc6bf6b2ff",
            "patch": "@@ -390,6 +390,43 @@ runInEachFileSystem(os => {\n           expect(jsContents).toContain('/** @nocollapse */ TestCmp.Éµcmp');\n         });\n \n+        it('should still perform schema checks in embedded views', () => {\n+          env.tsconfig({\n+            'fullTemplateTypeCheck': false,\n+            'annotateForClosureCompiler': true,\n+            'ivyTemplateTypeCheck': true,\n+          });\n+          env.write('test.ts', `\n+            import {Component, Directive, NgModule} from '@angular/core';\n+\n+            @Component({\n+              selector: 'test-cmp',\n+              template: \\`\n+                <ng-template>\n+                  <some-dir>Has a directive, should be okay</some-dir>\n+                  <not-a-cmp>Should trigger a schema error</not-a-cmp>\n+                </ng-template>\n+              \\`\n+            })\n+            export class TestCmp {}\n+\n+            @Directive({\n+              selector: 'some-dir',\n+            })\n+            export class TestDir {}\n+\n+            @NgModule({\n+              declarations: [TestCmp, TestDir],\n+            })\n+            export class TestModule {}\n+          `);\n+\n+          const diags = env.driveDiagnostics();\n+          expect(diags.length).toBe(1);\n+          expect(diags[0].code).toBe(ngErrorCode(ErrorCode.SCHEMA_INVALID_ELEMENT));\n+          expect(ts.flattenDiagnosticMessageText(diags[0].messageText, '\\n'))\n+              .toContain('not-a-cmp');\n+        });\n         /**\n          * The following set of tests verify that after Tsickle run we do not have cases\n          * which trigger automatic semicolon insertion, which breaks the code. In order"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 79,
        "deletions": 0
    }
}