{
    "author": "JoostK",
    "message": "fix(compiler): detect pipes in ICUs in template binder (#38810)\n\nRecent work on compiler internals in #38539 led to an unexpected failure,\nwhere a pipe used exclusively inside of an ICU would no longer be\nemitted into the compilation output. This caused runtime errors due to\nmissing pipes.\n\nThe issue occurred because the change in #38539 would determine the set\nof used pipes up-front, independent from the template compilation using\nthe `R3TargetBinder`. However, `R3TargetBinder` did not consider\nexpressions within ICUs, so any pipe usages within those expressions\nwould not be detected. This fix unblocks #38539 and also concerns\nupcoming linker work, given that prelink compilations would not go\nthrough full template compilation but only `R3TargetBinder`.\n\nPR Close #38810",
    "sha": "15207e3c9c9ba26a6f41b497ab9f0f299486927c",
    "files": [
        {
            "sha": "f4abcb6a1c6ad59cae30b73048d449b309286215",
            "filename": "packages/compiler/src/render3/view/t2_binder.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/15207e3c9c9ba26a6f41b497ab9f0f299486927c/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ft2_binder.ts",
            "raw_url": "https://github.com/angular/angular/raw/15207e3c9c9ba26a6f41b497ab9f0f299486927c/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ft2_binder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ft2_binder.ts?ref=15207e3c9c9ba26a6f41b497ab9f0f299486927c",
            "patch": "@@ -434,7 +434,10 @@ class TemplateBinder extends RecursiveAstVisitor implements Visitor {\n   visitText(text: Text) {}\n   visitContent(content: Content) {}\n   visitTextAttribute(attribute: TextAttribute) {}\n-  visitIcu(icu: Icu): void {}\n+  visitIcu(icu: Icu): void {\n+    Object.keys(icu.vars).forEach(key => icu.vars[key].visit(this));\n+    Object.keys(icu.placeholders).forEach(key => icu.placeholders[key].visit(this));\n+  }\n \n   // The remaining visitors are concerned with processing AST expressions within template bindings\n "
        },
        {
            "sha": "6afb9c011ddae69a7292d847c4cf30e825d14901",
            "filename": "packages/compiler/test/render3/view/binding_spec.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/15207e3c9c9ba26a6f41b497ab9f0f299486927c/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fbinding_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/15207e3c9c9ba26a6f41b497ab9f0f299486927c/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fbinding_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fbinding_spec.ts?ref=15207e3c9c9ba26a6f41b497ab9f0f299486927c",
            "patch": "@@ -194,4 +194,38 @@ describe('t2 binding', () => {\n       expect(consumer).toEqual(el);\n     });\n   });\n+\n+  describe('used pipes', () => {\n+    it('should record pipes used in interpolations', () => {\n+      const template = parseTemplate('{{value|date}}', '', {});\n+      const binder = new R3TargetBinder(makeSelectorMatcher());\n+      const res = binder.bind({template: template.nodes});\n+      expect(res.getUsedPipes()).toEqual(['date']);\n+    });\n+\n+    it('should record pipes used in bound attributes', () => {\n+      const template = parseTemplate('<person [age]=\"age|number\"></person>', '', {});\n+      const binder = new R3TargetBinder(makeSelectorMatcher());\n+      const res = binder.bind({template: template.nodes});\n+      expect(res.getUsedPipes()).toEqual(['number']);\n+    });\n+\n+    it('should record pipes used in bound template attributes', () => {\n+      const template = parseTemplate('<ng-template [ngIf]=\"obs|async\"></ng-template>', '', {});\n+      const binder = new R3TargetBinder(makeSelectorMatcher());\n+      const res = binder.bind({template: template.nodes});\n+      expect(res.getUsedPipes()).toEqual(['async']);\n+    });\n+\n+    it('should record pipes used in ICUs', () => {\n+      const template = parseTemplate(\n+          `<span i18n>{count|number, plural,\n+            =1 { {{value|date}} }\n+          }</span>`,\n+          '', {});\n+      const binder = new R3TargetBinder(makeSelectorMatcher());\n+      const res = binder.bind({template: template.nodes});\n+      expect(res.getUsedPipes()).toEqual(['number', 'date']);\n+    });\n+  });\n });"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 38,
        "deletions": 1
    }
}