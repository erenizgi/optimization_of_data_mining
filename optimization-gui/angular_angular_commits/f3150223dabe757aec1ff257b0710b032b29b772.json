{
    "author": "josephperrott",
    "message": "feat(dev-infra): show CI status of all active release trains (#39067)\n\nAs part of the ng-dev caretaker check command, show the status of the\nlastest CircleCI run for each active release train.\n\nPR Close #39067",
    "sha": "f3150223dabe757aec1ff257b0710b032b29b772",
    "files": [
        {
            "sha": "d8d8b058dad5d39cc9b12899b38abbbf25cb648b",
            "filename": "dev-infra/caretaker/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/f3150223dabe757aec1ff257b0710b032b29b772/dev-infra%2Fcaretaker%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/f3150223dabe757aec1ff257b0710b032b29b772/dev-infra%2Fcaretaker%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2FBUILD.bazel?ref=f3150223dabe757aec1ff257b0710b032b29b772",
            "patch": "@@ -8,6 +8,7 @@ ts_library(\n     module_name = \"@angular/dev-infra-private/caretaker\",\n     visibility = [\"//dev-infra:__subpackages__\"],\n     deps = [\n+        \"//dev-infra/release/versioning\",\n         \"//dev-infra/utils\",\n         \"@npm//@types/node\",\n         \"@npm//@types/node-fetch\","
        },
        {
            "sha": "ff32fe052cb6f1acae81b1c9aedb581f0b73c0c2",
            "filename": "dev-infra/caretaker/check/ci.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 19,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/f3150223dabe757aec1ff257b0710b032b29b772/dev-infra%2Fcaretaker%2Fcheck%2Fci.ts",
            "raw_url": "https://github.com/angular/angular/raw/f3150223dabe757aec1ff257b0710b032b29b772/dev-infra%2Fcaretaker%2Fcheck%2Fci.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fci.ts?ref=f3150223dabe757aec1ff257b0710b032b29b772",
            "patch": "@@ -7,52 +7,55 @@\n  */\n \n import fetch from 'node-fetch';\n+import {fetchActiveReleaseTrains} from '../../release/versioning/index';\n \n-import {bold, green, info, red} from '../../utils/console';\n+import {bold, debug, info} from '../../utils/console';\n import {GitClient} from '../../utils/git';\n \n \n /** The results of checking the status of CI.  */\n interface StatusCheckResult {\n-  status: 'success'|'failed'|'canceled'|'infrastructure_fail'|'timedout'|'failed'|'no_tests';\n-  timestamp: Date;\n-  buildUrl: string;\n+  status: 'success'|'failed';\n }\n \n /** Retrieve and log status of CI for the project. */\n export async function printCiStatus(git: GitClient) {\n+  const releaseTrains = await fetchActiveReleaseTrains({api: git.github, ...git.remoteConfig});\n+\n   info.group(bold(`CI`));\n-  // TODO(josephperrott): Expand list of branches checked to all active branches.\n-  await printStatus(git, 'master');\n+  for (const [trainName, train] of Object.entries(releaseTrains)) {\n+    if (train === null) {\n+      debug(`No active release train for ${trainName}`);\n+      continue;\n+    }\n+    const status = await getStatusOfBranch(git, train.branchName);\n+    await printStatus(`${trainName.padEnd(6)} (${train.branchName})`, status);\n+  }\n   info.groupEnd();\n   info();\n }\n \n /** Log the status of CI for a given branch to the console. */\n-async function printStatus(git: GitClient, branch: string) {\n-  const result = await getStatusOfBranch(git, branch);\n-  const branchName = branch.padEnd(10);\n-  if (result === null) {\n+async function printStatus(label: string, status: StatusCheckResult|null) {\n+  const branchName = label.padEnd(16);\n+  if (status === null) {\n     info(`${branchName} was not found on CircleCI`);\n-  } else if (result.status === 'success') {\n+  } else if (status.status === 'success') {\n     info(`${branchName} ✅`);\n   } else {\n-    info(`${branchName} ❌ (Ran at: ${result.timestamp.toLocaleString()})`);\n+    info(`${branchName} ❌`);\n   }\n }\n \n /** Get the CI status of a given branch from CircleCI. */\n async function getStatusOfBranch(git: GitClient, branch: string): Promise<StatusCheckResult|null> {\n   const {owner, name} = git.remoteConfig;\n-  const url = `https://circleci.com/api/v1.1/project/gh/${owner}/${name}/tree/${\n-      branch}?limit=1&filter=completed&shallow=true`;\n-  const result = (await fetch(url).then(result => result.json()))?.[0];\n+  const url = `https://circleci.com/gh/${owner}/${name}/tree/${branch}.svg?style=shield`;\n+  const result = await fetch(url).then(result => result.text());\n \n-  if (result) {\n+  if (result && !result.includes('no builds')) {\n     return {\n-      status: result.outcome,\n-      timestamp: new Date(result.stop_time),\n-      buildUrl: result.build_url\n+      status: result.includes('passing') ? 'success' : 'failed',\n     };\n   }\n   return null;"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 23,
        "deletions": 19
    }
}