{
    "author": "JoostK",
    "message": "fix(core): support cyclic metadata in TestBed overrides (#44215)\n\nThe TestBed APIs to override metadata would crash when the metadata\ncontained objects with cyclic references. Metadata overrides use the\nJSON serialized representation of a value to compare objects, which\nthrows an error if the value has cyclic references. This commit avoids\nthe error by replacing multiple occurrences of the same object using\na unique string representation for the object.\n\nFixes #43948\n\nPR Close #44215",
    "sha": "b930547ffd951228c26e3c6bad456f90cc449e07",
    "files": [
        {
            "sha": "1b375835e85241e19c1abbacdcb3f76209d9bda0",
            "filename": "packages/core/test/test_bed_spec.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/b930547ffd951228c26e3c6bad456f90cc449e07/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b930547ffd951228c26e3c6bad456f90cc449e07/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts?ref=b930547ffd951228c26e3c6bad456f90cc449e07",
            "patch": "@@ -11,6 +11,7 @@ import {getTestBed, TestBed, TestBedViewEngine} from '@angular/core/testing/src/\n import {By} from '@angular/platform-browser';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n import {onlyInIvy} from '@angular/private/testing';\n+\n import {TestBedRender3} from '../testing/src/r3_test_bed';\n import {TEARDOWN_TESTING_MODULE_ON_DESTROY_DEFAULT} from '../testing/src/test_bed_common';\n \n@@ -723,6 +724,53 @@ describe('TestBed', () => {\n        expect(service.get()).toEqual('override');\n      });\n \n+  it('should allowing overriding a module with a cyclic structure in its metadata', () => {\n+    class Cyclic {\n+      cycle = this;\n+\n+      constructor(public name: string) {}\n+    }\n+\n+    const CYCLES = new InjectionToken<Cyclic[]>('cycles', {factory: () => []});\n+\n+    @NgModule({\n+      providers: [\n+        {provide: CYCLES, useValue: new Cyclic('a'), multi: true},\n+        {provide: CYCLES, useValue: new Cyclic('b'), multi: true},\n+      ],\n+    })\n+    class TestModule {\n+    }\n+\n+    TestBed\n+        .configureTestingModule({\n+          imports: [TestModule],\n+        })\n+        .overrideModule(TestModule, {\n+          remove: {\n+            providers: [\n+              // Removing the cycle named \"a\" should result in removing the provider for \"a\".\n+              // Note: although this removes a different instance than the one provided, metadata\n+              // overrides compare objects by value, not by reference.\n+              {provide: CYCLES, useValue: new Cyclic('a'), multi: true},\n+\n+              // Also attempt to remove a cycle named \"B\" (which does not exist) to verify that\n+              // objects are correctly compared by value.\n+              {provide: CYCLES, useValue: new Cyclic('B'), multi: true},\n+            ],\n+          },\n+          add: {\n+            providers: [\n+              {provide: CYCLES, useValue: new Cyclic('c'), multi: true},\n+            ],\n+          },\n+        })\n+        .compileComponents();\n+\n+    const values = TestBed.inject(CYCLES);\n+    expect(values.map(v => v.name)).toEqual(['b', 'c']);\n+  });\n+\n   it('overrides injectable that is using providedIn: AModule', () => {\n     @NgModule()\n     class ServiceModule {"
        },
        {
            "sha": "8866ff25e5a13d0b26c8803ddd81edca5b17fb9a",
            "filename": "packages/core/testing/src/metadata_overrider.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/b930547ffd951228c26e3c6bad456f90cc449e07/packages%2Fcore%2Ftesting%2Fsrc%2Fmetadata_overrider.ts",
            "raw_url": "https://github.com/angular/angular/raw/b930547ffd951228c26e3c6bad456f90cc449e07/packages%2Fcore%2Ftesting%2Fsrc%2Fmetadata_overrider.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Fmetadata_overrider.ts?ref=b930547ffd951228c26e3c6bad456f90cc449e07",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import {ɵstringify as stringify} from '@angular/core';\n+\n import {MetadataOverride} from './metadata_override';\n \n type StringMap = {\n@@ -89,8 +90,20 @@ function setMetadata(metadata: StringMap, set: any) {\n }\n \n function _propHashKey(propName: any, propValue: any, references: Map<any, string>): string {\n+  let nextObjectId = 0;\n+  const objectIds = new Map<object, string>();\n   const replacer = (key: any, value: any) => {\n-    if (typeof value === 'function') {\n+    if (value !== null && typeof value === 'object') {\n+      if (objectIds.has(value)) {\n+        return objectIds.get(value);\n+      }\n+      // Record an id for this object such that any later references use the object's id instead\n+      // of the object itself, in order to break cyclic pointers in objects.\n+      objectIds.set(value, `ɵobj#${nextObjectId++}`);\n+\n+      // The first time an object is seen the object itself is serialized.\n+      return value;\n+    } else if (typeof value === 'function') {\n       value = _serializeReference(value, references);\n     }\n     return value;"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 62,
        "deletions": 1
    }
}