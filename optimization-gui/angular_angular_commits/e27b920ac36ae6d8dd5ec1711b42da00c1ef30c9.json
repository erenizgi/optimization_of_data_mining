{
    "author": "petebacondarwin",
    "message": "refactor(compiler-cli): split up `NodeJSFileSystem` class (#40281)\n\nThis class is refactored to extend the new `NodeJSReadonlyFileSystem`\nwhich itself extends `NodeJSPathManipulation`. These new classes allow\nconsumers to create file-systems that provide a subset of the full file-system.\n\nPR Close #40281",
    "sha": "e27b920ac36ae6d8dd5ec1711b42da00c1ef30c9",
    "files": [
        {
            "sha": "12c91285c8b9f5d5b7b03c121fc7bf0e667dd1e4",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/src/node_js_file_system.ts",
            "status": "modified",
            "additions": 74,
            "deletions": 64,
            "changes": 138,
            "blob_url": "https://github.com/angular/angular/blob/e27b920ac36ae6d8dd5ec1711b42da00c1ef30c9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Fnode_js_file_system.ts",
            "raw_url": "https://github.com/angular/angular/raw/e27b920ac36ae6d8dd5ec1711b42da00c1ef30c9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Fnode_js_file_system.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Fnode_js_file_system.ts?ref=e27b920ac36ae6d8dd5ec1711b42da00c1ef30c9",
            "patch": "@@ -9,14 +9,62 @@\n import * as fs from 'fs';\n import * as fsExtra from 'fs-extra';\n import * as p from 'path';\n-import {absoluteFrom} from './helpers';\n-import {AbsoluteFsPath, FileStats, FileSystem, PathSegment, PathString} from './types';\n+import {AbsoluteFsPath, FileStats, FileSystem, PathManipulation, PathSegment, PathString, ReadonlyFileSystem} from './types';\n \n /**\n- * A wrapper around the Node.js file-system (i.e the `fs` package).\n+ * A wrapper around the Node.js file-system that supports path manipulation.\n  */\n-export class NodeJSFileSystem implements FileSystem {\n+export class NodeJSPathManipulation implements PathManipulation {\n+  pwd(): AbsoluteFsPath {\n+    return this.normalize(process.cwd()) as AbsoluteFsPath;\n+  }\n+  chdir(dir: AbsoluteFsPath): void {\n+    process.chdir(dir);\n+  }\n+  resolve(...paths: string[]): AbsoluteFsPath {\n+    return this.normalize(p.resolve(...paths)) as AbsoluteFsPath;\n+  }\n+\n+  dirname<T extends string>(file: T): T {\n+    return this.normalize(p.dirname(file)) as T;\n+  }\n+  join<T extends string>(basePath: T, ...paths: string[]): T {\n+    return this.normalize(p.join(basePath, ...paths)) as T;\n+  }\n+  isRoot(path: AbsoluteFsPath): boolean {\n+    return this.dirname(path) === this.normalize(path);\n+  }\n+  isRooted(path: string): boolean {\n+    return p.isAbsolute(path);\n+  }\n+  relative<T extends PathString>(from: T, to: T): PathSegment|AbsoluteFsPath {\n+    return this.normalize(p.relative(from, to)) as PathSegment | AbsoluteFsPath;\n+  }\n+  basename(filePath: string, extension?: string): PathSegment {\n+    return p.basename(filePath, extension) as PathSegment;\n+  }\n+  extname(path: AbsoluteFsPath|PathSegment): string {\n+    return p.extname(path);\n+  }\n+  normalize<T extends string>(path: T): T {\n+    // Convert backslashes to forward slashes\n+    return path.replace(/\\\\/g, '/') as T;\n+  }\n+}\n+\n+/**\n+ * A wrapper around the Node.js file-system that supports readonly operations and path manipulation.\n+ */\n+export class NodeJSReadonlyFileSystem extends NodeJSPathManipulation implements ReadonlyFileSystem {\n   private _caseSensitive: boolean|undefined = undefined;\n+  isCaseSensitive(): boolean {\n+    if (this._caseSensitive === undefined) {\n+      // Note the use of the real file-system is intentional:\n+      // `this.exists()` relies upon `isCaseSensitive()` so that would cause an infinite recursion.\n+      this._caseSensitive = !fs.existsSync(this.normalize(toggleCase(__filename)));\n+    }\n+    return this._caseSensitive;\n+  }\n   exists(path: AbsoluteFsPath): boolean {\n     return fs.existsSync(path);\n   }\n@@ -26,15 +74,6 @@ export class NodeJSFileSystem implements FileSystem {\n   readFileBuffer(path: AbsoluteFsPath): Uint8Array {\n     return fs.readFileSync(path);\n   }\n-  writeFile(path: AbsoluteFsPath, data: string|Uint8Array, exclusive: boolean = false): void {\n-    fs.writeFileSync(path, data, exclusive ? {flag: 'wx'} : undefined);\n-  }\n-  removeFile(path: AbsoluteFsPath): void {\n-    fs.unlinkSync(path);\n-  }\n-  symlink(target: AbsoluteFsPath, path: AbsoluteFsPath): void {\n-    fs.symlinkSync(target, path);\n-  }\n   readdir(path: AbsoluteFsPath): PathSegment[] {\n     return fs.readdirSync(path) as PathSegment[];\n   }\n@@ -44,11 +83,26 @@ export class NodeJSFileSystem implements FileSystem {\n   stat(path: AbsoluteFsPath): FileStats {\n     return fs.statSync(path);\n   }\n-  pwd(): AbsoluteFsPath {\n-    return this.normalize(process.cwd()) as AbsoluteFsPath;\n+  realpath(path: AbsoluteFsPath): AbsoluteFsPath {\n+    return this.resolve(fs.realpathSync(path));\n   }\n-  chdir(dir: AbsoluteFsPath): void {\n-    process.chdir(dir);\n+  getDefaultLibLocation(): AbsoluteFsPath {\n+    return this.resolve(require.resolve('typescript'), '..');\n+  }\n+}\n+\n+/**\n+ * A wrapper around the Node.js file-system (i.e. the `fs` package).\n+ */\n+export class NodeJSFileSystem extends NodeJSReadonlyFileSystem implements FileSystem {\n+  writeFile(path: AbsoluteFsPath, data: string|Uint8Array, exclusive: boolean = false): void {\n+    fs.writeFileSync(path, data, exclusive ? {flag: 'wx'} : undefined);\n+  }\n+  removeFile(path: AbsoluteFsPath): void {\n+    fs.unlinkSync(path);\n+  }\n+  symlink(target: AbsoluteFsPath, path: AbsoluteFsPath): void {\n+    fs.symlinkSync(target, path);\n   }\n   copyFile(from: AbsoluteFsPath, to: AbsoluteFsPath): void {\n     fs.copyFileSync(from, to);\n@@ -69,49 +123,6 @@ export class NodeJSFileSystem implements FileSystem {\n   removeDeep(path: AbsoluteFsPath): void {\n     fsExtra.removeSync(path);\n   }\n-  isCaseSensitive(): boolean {\n-    if (this._caseSensitive === undefined) {\n-      // Note the use of the real file-system is intentional:\n-      // `this.exists()` relies upon `isCaseSensitive()` so that would cause an infinite recursion.\n-      this._caseSensitive = !fs.existsSync(togglePathCase(__filename));\n-    }\n-    return this._caseSensitive;\n-  }\n-  resolve(...paths: string[]): AbsoluteFsPath {\n-    return this.normalize(p.resolve(...paths)) as AbsoluteFsPath;\n-  }\n-\n-  dirname<T extends string>(file: T): T {\n-    return this.normalize(p.dirname(file)) as T;\n-  }\n-  join<T extends string>(basePath: T, ...paths: string[]): T {\n-    return this.normalize(p.join(basePath, ...paths)) as T;\n-  }\n-  isRoot(path: AbsoluteFsPath): boolean {\n-    return this.dirname(path) === this.normalize(path);\n-  }\n-  isRooted(path: string): boolean {\n-    return p.isAbsolute(path);\n-  }\n-  relative<T extends PathString>(from: T, to: T): PathSegment|AbsoluteFsPath {\n-    return this.normalize(p.relative(from, to)) as PathSegment | AbsoluteFsPath;\n-  }\n-  basename(filePath: string, extension?: string): PathSegment {\n-    return p.basename(filePath, extension) as PathSegment;\n-  }\n-  extname(path: AbsoluteFsPath|PathSegment): string {\n-    return p.extname(path);\n-  }\n-  realpath(path: AbsoluteFsPath): AbsoluteFsPath {\n-    return this.resolve(fs.realpathSync(path));\n-  }\n-  getDefaultLibLocation(): AbsoluteFsPath {\n-    return this.resolve(require.resolve('typescript'), '..');\n-  }\n-  normalize<T extends string>(path: T): T {\n-    // Convert backslashes to forward slashes\n-    return path.replace(/\\\\/g, '/') as T;\n-  }\n \n   private safeMkdir(path: AbsoluteFsPath): void {\n     try {\n@@ -127,9 +138,8 @@ export class NodeJSFileSystem implements FileSystem {\n }\n \n /**\n- * Toggle the case of each character in a file path.\n+ * Toggle the case of each character in a string.\n  */\n-function togglePathCase(str: string): AbsoluteFsPath {\n-  return absoluteFrom(\n-      str.replace(/\\w/g, ch => ch.toUpperCase() === ch ? ch.toLowerCase() : ch.toUpperCase()));\n+function toggleCase(str: string): string {\n+  return str.replace(/\\w/g, ch => ch.toUpperCase() === ch ? ch.toLowerCase() : ch.toUpperCase());\n }"
        },
        {
            "sha": "4cd7cfb60cfc10073a964ba70a572855e8a1fe0a",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/test/node_js_file_system_spec.ts",
            "status": "modified",
            "additions": 78,
            "deletions": 58,
            "changes": 136,
            "blob_url": "https://github.com/angular/angular/blob/e27b920ac36ae6d8dd5ec1711b42da00c1ef30c9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftest%2Fnode_js_file_system_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e27b920ac36ae6d8dd5ec1711b42da00c1ef30c9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftest%2Fnode_js_file_system_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftest%2Fnode_js_file_system_spec.ts?ref=e27b920ac36ae6d8dd5ec1711b42da00c1ef30c9",
            "patch": "@@ -8,22 +8,55 @@\n import * as realFs from 'fs';\n import * as fsExtra from 'fs-extra';\n import * as os from 'os';\n-import {absoluteFrom, dirname, relativeFrom, setFileSystem} from '../src/helpers';\n-import {NodeJSFileSystem} from '../src/node_js_file_system';\n-import {AbsoluteFsPath} from '../src/types';\n+import {NodeJSFileSystem, NodeJSPathManipulation, NodeJSReadonlyFileSystem} from '../src/node_js_file_system';\n+import {AbsoluteFsPath, PathSegment} from '../src/types';\n \n-describe('NodeJSFileSystem', () => {\n-  let fs: NodeJSFileSystem;\n+describe('NodeJSPathManipulation', () => {\n+  let fs: NodeJSPathManipulation;\n   let abcPath: AbsoluteFsPath;\n   let xyzPath: AbsoluteFsPath;\n \n   beforeEach(() => {\n-    fs = new NodeJSFileSystem();\n-    // Set the file-system so that calls like `absoluteFrom()`\n-    // and `relativeFrom()` work correctly.\n-    setFileSystem(fs);\n-    abcPath = absoluteFrom('/a/b/c');\n-    xyzPath = absoluteFrom('/x/y/z');\n+    fs = new NodeJSPathManipulation();\n+    abcPath = fs.resolve('/a/b/c');\n+    xyzPath = fs.resolve('/x/y/z');\n+  });\n+\n+  describe('pwd()', () => {\n+    it('should delegate to process.cwd()', () => {\n+      const spy = spyOn(process, 'cwd').and.returnValue(abcPath);\n+      const result = fs.pwd();\n+      expect(result).toEqual(abcPath);\n+      expect(spy).toHaveBeenCalledWith();\n+    });\n+  });\n+\n+  if (os.platform() === 'win32') {\n+    // Only relevant on Windows\n+    describe('relative', () => {\n+      it('should handle Windows paths on different drives', () => {\n+        expect(fs.relative('C:\\\\a\\\\b\\\\c', 'D:\\\\a\\\\b\\\\d')).toEqual(fs.resolve('D:\\\\a\\\\b\\\\d'));\n+      });\n+    });\n+  }\n+});\n+\n+describe('NodeJSReadonlyFileSystem', () => {\n+  let fs: NodeJSReadonlyFileSystem;\n+  let abcPath: AbsoluteFsPath;\n+  let xyzPath: AbsoluteFsPath;\n+\n+  beforeEach(() => {\n+    fs = new NodeJSReadonlyFileSystem();\n+    abcPath = fs.resolve('/a/b/c');\n+    xyzPath = fs.resolve('/x/y/z');\n+  });\n+\n+  describe('isCaseSensitive()', () => {\n+    it('should return true if the FS is case-sensitive', () => {\n+      const isCaseSensitive = !realFs.existsSync(__filename.toUpperCase());\n+      expect(fs.isCaseSensitive()).toEqual(isCaseSensitive);\n+    });\n   });\n \n   describe('exists()', () => {\n@@ -55,30 +88,11 @@ describe('NodeJSFileSystem', () => {\n     });\n   });\n \n-  describe('writeFile()', () => {\n-    it('should delegate to fs.writeFileSync()', () => {\n-      const spy = spyOn(realFs, 'writeFileSync');\n-      fs.writeFile(abcPath, 'Some contents');\n-      expect(spy).toHaveBeenCalledWith(abcPath, 'Some contents', undefined);\n-      spy.calls.reset();\n-      fs.writeFile(abcPath, 'Some contents', /* exclusive */ true);\n-      expect(spy).toHaveBeenCalledWith(abcPath, 'Some contents', {flag: 'wx'});\n-    });\n-  });\n-\n-  describe('removeFile()', () => {\n-    it('should delegate to fs.unlink()', () => {\n-      const spy = spyOn(realFs, 'unlinkSync');\n-      fs.removeFile(abcPath);\n-      expect(spy).toHaveBeenCalledWith(abcPath);\n-    });\n-  });\n-\n   describe('readdir()', () => {\n     it('should delegate to fs.readdirSync()', () => {\n       const spy = spyOn(realFs, 'readdirSync').and.returnValue(['x', 'y/z'] as any);\n       const result = fs.readdir(abcPath);\n-      expect(result).toEqual([relativeFrom('x'), relativeFrom('y/z')]);\n+      expect(result).toEqual(['x' as PathSegment, 'y/z' as PathSegment]);\n       // TODO: @JiaLiPassion need to wait for @types/jasmine update to handle optional parameters.\n       // https://github.com/DefinitelyTyped/DefinitelyTyped/issues/43486\n       expect(spy as any).toHaveBeenCalledWith(abcPath);\n@@ -106,13 +120,35 @@ describe('NodeJSFileSystem', () => {\n       expect(spy as any).toHaveBeenCalledWith(abcPath);\n     });\n   });\n+});\n \n-  describe('pwd()', () => {\n-    it('should delegate to process.cwd()', () => {\n-      const spy = spyOn(process, 'cwd').and.returnValue(abcPath);\n-      const result = fs.pwd();\n-      expect(result).toEqual(abcPath);\n-      expect(spy).toHaveBeenCalledWith();\n+describe('NodeJSFileSystem', () => {\n+  let fs: NodeJSFileSystem;\n+  let abcPath: AbsoluteFsPath;\n+  let xyzPath: AbsoluteFsPath;\n+\n+  beforeEach(() => {\n+    fs = new NodeJSFileSystem();\n+    abcPath = fs.resolve('/a/b/c');\n+    xyzPath = fs.resolve('/x/y/z');\n+  });\n+\n+  describe('writeFile()', () => {\n+    it('should delegate to fs.writeFileSync()', () => {\n+      const spy = spyOn(realFs, 'writeFileSync');\n+      fs.writeFile(abcPath, 'Some contents');\n+      expect(spy).toHaveBeenCalledWith(abcPath, 'Some contents', undefined);\n+      spy.calls.reset();\n+      fs.writeFile(abcPath, 'Some contents', /* exclusive */ true);\n+      expect(spy).toHaveBeenCalledWith(abcPath, 'Some contents', {flag: 'wx'});\n+    });\n+  });\n+\n+  describe('removeFile()', () => {\n+    it('should delegate to fs.unlink()', () => {\n+      const spy = spyOn(realFs, 'unlinkSync');\n+      fs.removeFile(abcPath);\n+      expect(spy).toHaveBeenCalledWith(abcPath);\n     });\n   });\n \n@@ -134,10 +170,10 @@ describe('NodeJSFileSystem', () => {\n \n   describe('ensureDir()', () => {\n     it('should call exists() and fs.mkdir()', () => {\n-      const aPath = absoluteFrom('/a');\n-      const abPath = absoluteFrom('/a/b');\n-      const xPath = absoluteFrom('/x');\n-      const xyPath = absoluteFrom('/x/y');\n+      const aPath = fs.resolve('/a');\n+      const abPath = fs.resolve('/a/b');\n+      const xPath = fs.resolve('/x');\n+      const xyPath = fs.resolve('/x/y');\n       const mkdirCalls: string[] = [];\n       const existsCalls: string[] = [];\n       spyOn(realFs, 'mkdirSync').and.callFake(((path: string) => mkdirCalls.push(path)) as any);\n@@ -190,7 +226,7 @@ describe('NodeJSFileSystem', () => {\n          fs.ensureDir(abcPath);\n          expect(mkdirSyncSpy).toHaveBeenCalledTimes(3);\n          expect(mkdirSyncSpy).toHaveBeenCalledWith(abcPath);\n-         expect(mkdirSyncSpy).toHaveBeenCalledWith(dirname(abcPath));\n+         expect(mkdirSyncSpy).toHaveBeenCalledWith(fs.dirname(abcPath));\n        });\n \n     it('should fail if creating the directory throws and the directory does not exist', () => {\n@@ -239,20 +275,4 @@ describe('NodeJSFileSystem', () => {\n       expect(spy).toHaveBeenCalledWith(abcPath);\n     });\n   });\n-\n-  describe('isCaseSensitive()', () => {\n-    it('should return true if the FS is case-sensitive', () => {\n-      const isCaseSensitive = !realFs.existsSync(__filename.toUpperCase());\n-      expect(fs.isCaseSensitive()).toEqual(isCaseSensitive);\n-    });\n-  });\n-\n-  if (os.platform() === 'win32') {\n-    // Only relevant on Windows\n-    describe('relative', () => {\n-      it('should handle Windows paths on different drives', () => {\n-        expect(fs.relative('C:\\\\a\\\\b\\\\c', 'D:\\\\a\\\\b\\\\d')).toEqual(absoluteFrom('D:\\\\a\\\\b\\\\d'));\n-      });\n-    });\n-  }\n });"
        }
    ],
    "stats": {
        "total": 274,
        "additions": 152,
        "deletions": 122
    }
}