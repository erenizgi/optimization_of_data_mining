{
    "author": "JoostK",
    "message": "fix(compiler-cli): type-check inputs that include undefined when there's coercion members (#38273)\n\nFor attribute bindings that target a directive's input, the template\ntype checker is able to verify that the type of the input expression is\ncompatible with the directive's declaration for said input. This\nchecking adheres to the `strictNullChecks` flag as configured in the\nTypeScript compilation, such that errors are reported for expressions\nthat include `undefined` or `null` in their type if the input's\ndeclaration does not include those types.\n\nThere was a bug with this level of type-checking for directives that\nalso declare coercion members, where binding an expression that includes\nthe `undefined` type to a directive's input that does not include the\n`undefined` type would not be reported as error.\n\nThis commit fixes the bug by changing the type-constructor in type-check\ncode to use an intersection type of regular inputs and coerced inputs,\ninstead of a union type. The union type would inadvertently allow\n`undefined` types to be assigned into the regular inputs, as that would\nstill satisfy the characteristics of a union type.\n\nAs a result of this change, you may start to see build failures if\n`strictTemplates` is enabled and `strictInputTypes` is not disabled.\nThese errors are legitimate and some action is required to achieve a\nsuccessful build:\n\n1. Update the templates for which an error is reported and introduce the\n   non-null assertion operator at the end of the expression. This\n   removes the `undefined` type from the expression's type, making it\n   appear as a valid assignment.\n2. Disable `strictNullInputTypes` in the compiler options. This will\n   implicitly add the non-null assertion operators similar to option 1,\n   but all templates in the compilation are affected.\n3. Update the directive's input declaration to include the `undefined`\n   type, if the directive is not implemented in an external library.\n\nPR Close #38273",
    "sha": "7525f3afc114ba65c72bb98818d83c7c34d49042",
    "files": [
        {
            "sha": "f80fd0fc69d9d828b1c6ae5041ac0a0f15823528",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_constructor.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/7525f3afc114ba65c72bb98818d83c7c34d49042/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_constructor.ts",
            "raw_url": "https://github.com/angular/angular/raw/7525f3afc114ba65c72bb98818d83c7c34d49042/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_constructor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_constructor.ts?ref=7525f3afc114ba65c72bb98818d83c7c34d49042",
            "patch": "@@ -166,8 +166,8 @@ function constructTypeCtorParameter(\n   if (coercedKeys.length > 0) {\n     const coercedLiteral = ts.createTypeLiteralNode(coercedKeys);\n \n-    initType =\n-        initType !== null ? ts.createUnionTypeNode([initType, coercedLiteral]) : coercedLiteral;\n+    initType = initType !== null ? ts.createIntersectionTypeNode([initType, coercedLiteral]) :\n+                                   coercedLiteral;\n   }\n \n   if (initType === null) {"
        },
        {
            "sha": "f490cda7f5667e3eb77a5c658a8bde5229fa2083",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_constructor_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/7525f3afc114ba65c72bb98818d83c7c34d49042/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7525f3afc114ba65c72bb98818d83c7c34d49042/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts?ref=7525f3afc114ba65c72bb98818d83c7c34d49042",
            "patch": "@@ -179,7 +179,7 @@ TestClass.ngTypeCtor({value: 'test'});\n         const typeCtor = TestClassWithCtor.members.find(isTypeCtor)!;\n         const ctorText = typeCtor.getText().replace(/[ \\r\\n]+/g, ' ');\n         expect(ctorText).toContain(\n-            'init: Pick<TestClass, \"foo\"> | { bar: typeof TestClass.ngAcceptInputType_bar; }');\n+            'init: Pick<TestClass, \"foo\"> & { bar: typeof TestClass.ngAcceptInputType_bar; }');\n       });\n     });\n   });"
        },
        {
            "sha": "7c9ec4dbf464d3ec91b478fd40ff2cea489cc233",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/7525f3afc114ba65c72bb98818d83c7c34d49042/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7525f3afc114ba65c72bb98818d83c7c34d49042/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=7525f3afc114ba65c72bb98818d83c7c34d49042",
            "patch": "@@ -1498,6 +1498,39 @@ export declare class AnimationEvent {\n            expect(diags[0].messageText)\n                .toBe(`Type 'boolean' is not assignable to type 'string | number'.`);\n          });\n+\n+      it('should give an error for undefined bindings into regular inputs when coercion members are present',\n+         () => {\n+           env.tsconfig({strictTemplates: true});\n+           env.write('test.ts', `\n+            import {Component, Directive, NgModule, Input} from '@angular/core';\n+\n+            @Component({\n+              selector: 'blah',\n+              template: '<input dir [regular]=\"undefined\" [coerced]=\"1\">',\n+            })\n+            export class FooCmp {\n+              invalidType = true;\n+            }\n+\n+            @Directive({selector: '[dir]'})\n+            export class CoercionDir {\n+              @Input() regular: string;\n+              @Input() coerced: boolean;\n+\n+              static ngAcceptInputType_coerced: boolean|number;\n+            }\n+\n+            @NgModule({\n+              declarations: [FooCmp, CoercionDir],\n+            })\n+            export class FooModule {}\n+        `);\n+           const diags = env.driveDiagnostics();\n+           expect(diags.length).toBe(1);\n+           expect(diags[0].messageText)\n+               .toBe(`Type 'undefined' is not assignable to type 'string'.`);\n+         });\n     });\n \n     describe('legacy schema checking with the DOM schema', () => {"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 36,
        "deletions": 3
    }
}