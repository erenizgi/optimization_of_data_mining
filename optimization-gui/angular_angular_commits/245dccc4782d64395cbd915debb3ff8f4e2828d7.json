{
    "author": "josephperrott",
    "message": "build: update config flags for snapshot builds (#40095)\n\nUpdate the config flags used for snapshot builds and release builds.\n\nPR Close #40095",
    "sha": "245dccc4782d64395cbd915debb3ff8f4e2828d7",
    "files": [
        {
            "sha": "615785d2b2676ae80e5deb96d50db79dab55930e",
            "filename": ".bazelrc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/245dccc4782d64395cbd915debb3ff8f4e2828d7/.bazelrc",
            "raw_url": "https://github.com/angular/angular/raw/245dccc4782d64395cbd915debb3ff8f4e2828d7/.bazelrc",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.bazelrc?ref=245dccc4782d64395cbd915debb3ff8f4e2828d7",
            "patch": "@@ -47,9 +47,13 @@ build --nobuild_runfile_links\n # Releases should always be stamped with version control info\n # This command assumes node on the path and is a workaround for\n # https://github.com/bazelbuild/bazel/issues/4802\n-build:release --workspace_status_command=\"yarn -s ng-dev release build-env-stamp\"\n+build:release --workspace_status_command=\"yarn -s ng-dev release build-env-stamp --mode=release\"\n build:release --stamp\n \n+# Snapshots should also be stamped with version control information.\n+build:snapshot --workspace_status_command=\"yarn -s ng-dev release build-env-stamp --mode=snapshot\"\n+build:snapshot --stamp\n+\n ###############################\n # Output                      #\n ###############################"
        },
        {
            "sha": "49aa2af849e2786b855d7ec056bae62f51ef51ca",
            "filename": ".ng-dev/release.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/245dccc4782d64395cbd915debb3ff8f4e2828d7/.ng-dev%2Frelease.ts",
            "raw_url": "https://github.com/angular/angular/raw/245dccc4782d64395cbd915debb3ff8f4e2828d7/.ng-dev%2Frelease.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.ng-dev%2Frelease.ts?ref=245dccc4782d64395cbd915debb3ff8f4e2828d7",
            "patch": "@@ -26,7 +26,7 @@ export const release: ReleaseConfig = {\n     // The buildTargetPackages function is loaded at runtime as the loading the script causes an\n     // invocation of bazel.\n     const {buildTargetPackages} = require(join(__dirname, '../scripts/build/package-builder'));\n-    return buildTargetPackages('dist/release-output', false, 'Release');\n+    return buildTargetPackages('dist/release-output', false, 'Release', true);\n   },\n   // TODO: This can be removed once there is an org-wide tool for changelog generation.\n   generateReleaseNotesForHead: async () => {"
        },
        {
            "sha": "530a286f679da94f850c7fc34b6200ba3e0f08b7",
            "filename": "scripts/build/package-builder.js",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/245dccc4782d64395cbd915debb3ff8f4e2828d7/scripts%2Fbuild%2Fpackage-builder.js",
            "raw_url": "https://github.com/angular/angular/raw/245dccc4782d64395cbd915debb3ff8f4e2828d7/scripts%2Fbuild%2Fpackage-builder.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fpackage-builder.js?ref=245dccc4782d64395cbd915debb3ff8f4e2828d7",
            "patch": "@@ -62,9 +62,10 @@ module.exports = {\n  * This path should either be absolute or relative to the project root.\n  * @param {boolean} enableIvy True, if Ivy should be used.\n  * @param {string} description Human-readable description of the build.\n+ * @param {boolean?} isRelease True, if the build should be stamped for a release.\n  * @returns {Array<{name: string, outputPath: string}} A list of packages built.\n  */\n-function buildTargetPackages(destPath, enableIvy, description) {\n+function buildTargetPackages(destPath, enableIvy, description, isRelease = false) {\n   console.info('##################################');\n   console.info(`${scriptPath}:`);\n   console.info('  Building @angular/* npm packages');\n@@ -80,9 +81,10 @@ function buildTargetPackages(destPath, enableIvy, description) {\n       bazelCmd} query --output=label \"attr('tags', '\\\\[.*release-with-framework.*\\\\]', //packages/...) intersect kind('ng_package|pkg_npm', //packages/...)\"`;\n   const targets = exec(getTargetsCmd, true).split(/\\r?\\n/);\n \n-  // Use `--config=release` so that snapshot builds get published with embedded version info.\n-  exec(`${bazelCmd} build --config=release --config=${enableIvy ? 'ivy' : 'view-engine'} ${\n-      targets.join(' ')}`);\n+  // Use either `--config=snapshot` or `--config=release` so that builds are created with the\n+  // correct embedded version info.\n+  exec(`${bazelCmd} build --config=${isRelease ? 'release' : 'snapshot'} --config=${\n+      enableIvy ? 'ivy' : 'view-engine'} ${targets.join(' ')}`);\n \n   // Create the output directory.\n   const absDestPath = resolve(baseDir, destPath);"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 12,
        "deletions": 6
    }
}