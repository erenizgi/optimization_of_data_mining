{
    "author": "crisbeto",
    "message": "fix(compiler): incorrect context object being referenced from listener instructions inside embedded views (#42755)\n\nCurrently unless a listener inside of an embedded view tries to reference something from the parent view, or if the reference is a local ref, we don't generate the view restoration instructions and we allow for the value to be picked up from the context object in the function parameters. The problem is that the listener is only run during creation mode and the context object may have been swapped out afterwards.\n\nThese changes fix the issue by always generating the view restoration instructions for listeners inside templates.\n\nFixes #42698.\n\nPR Close #42755",
    "sha": "404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27",
    "files": [
        {
            "sha": "5e698d0a5fe5dfe5905ed4fe7319a60934f80f89",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_listener/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FGOLDEN_PARTIAL.js?ref=404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27",
            "patch": "@@ -636,3 +636,51 @@ export declare class MyModule {\n     static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: embedded_view_listener_context.js\n+ ****************************************************************************************************/\n+import { Component, NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class MyComponent {\n+}\n+MyComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: `\n+    <ng-template let-obj>\n+      <button (click)=\"obj.value = 1\">Change</button>\n+    </ng-template>\n+  `, isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyComponent, decorators: [{\n+            type: Component,\n+            args: [{\n+                    selector: 'my-component',\n+                    template: `\n+    <ng-template let-obj>\n+      <button (click)=\"obj.value = 1\">Change</button>\n+    </ng-template>\n+  `\n+                }]\n+        }] });\n+export class MyModule {\n+}\n+MyModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\n+MyModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, declarations: [MyComponent] });\n+MyModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{ declarations: [MyComponent] }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: embedded_view_listener_context.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class MyComponent {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyComponent, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<MyComponent, \"my-component\", never, {}, {}, never, never>;\n+}\n+export declare class MyModule {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyModule, never>;\n+    static ɵmod: i0.ɵɵNgModuleDeclaration<MyModule, [typeof MyComponent], never, never>;\n+    static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n+}\n+"
        },
        {
            "sha": "52cce6783385fc57c61794df90a17dde19b6f18d",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_listener/TEST_CASES.json",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FTEST_CASES.json?ref=404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27",
            "patch": "@@ -281,6 +281,23 @@\n           \"failureMessage\": \"Incorrect template\"\n         }\n       ]\n+    },\n+    {\n+      \"description\": \"should reference correct context in listener inside embedded view\",\n+      \"inputFiles\": [\n+        \"embedded_view_listener_context.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"files\": [\n+            {\n+              \"expected\": \"embedded_view_listener_context_template.js\",\n+              \"generated\": \"embedded_view_listener_context.js\"\n+            }\n+          ],\n+          \"failureMessage\": \"Incorrect template\"\n+        }\n+      ]\n     }\n   ]\n }"
        },
        {
            "sha": "72876362f8636c6bbc12b81c1983371265ac7028",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_listener/embedded_view_listener_context.ts",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fembedded_view_listener_context.ts",
            "raw_url": "https://github.com/angular/angular/raw/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fembedded_view_listener_context.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fembedded_view_listener_context.ts?ref=404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27",
            "patch": "@@ -0,0 +1,16 @@\n+import {Component, NgModule} from '@angular/core';\n+\n+@Component({\n+  selector: 'my-component',\n+  template: `\n+    <ng-template let-obj>\n+      <button (click)=\"obj.value = 1\">Change</button>\n+    </ng-template>\n+  `\n+})\n+export class MyComponent {\n+}\n+\n+@NgModule({declarations: [MyComponent]})\n+export class MyModule {\n+}"
        },
        {
            "sha": "f903938b9c43fcec56b01277ade53e42e1a0f9e6",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_listener/embedded_view_listener_context_template.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fembedded_view_listener_context_template.js",
            "raw_url": "https://github.com/angular/angular/raw/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fembedded_view_listener_context_template.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fembedded_view_listener_context_template.js?ref=404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27",
            "patch": "@@ -0,0 +1,13 @@\n+function MyComponent_ng_template_0_Template(rf, $ctx$) {\n+  if (rf & 1) {\n+    const _r3 = $i0$.ɵɵgetCurrentView();\n+    $i0$.ɵɵelementStart(0, \"button\", 0);\n+    $i0$.ɵɵlistener(\"click\", function MyComponent_ng_template_0_Template_button_click_0_listener() {\n+      const restoredCtx = $i0$.ɵɵrestoreView(_r3);\n+      const $obj_r1$ = restoredCtx.$implicit;\n+      return $obj_r1$.value = 1;\n+    });\n+    $i0$.ɵɵtext(1, \"Change\");\n+    $i0$.ɵɵelementEnd();\n+  }\n+}"
        },
        {
            "sha": "6911c6d98142646b7eceea6488fcf7e02b840b8f",
            "filename": "packages/compiler/src/compiler_util/expression_converter.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "raw_url": "https://github.com/angular/angular/raw/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts?ref=404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27",
            "patch": "@@ -19,7 +19,7 @@ export interface LocalResolver {\n   getLocal(name: string): o.Expression|null;\n   notifyImplicitReceiverUse(): void;\n   globals?: Set<string>;\n-  maybeRestoreView(retrievalLevel: number, localRefLookup: boolean): void;\n+  maybeRestoreView(): void;\n }\n \n export class ConvertActionBindingResult {\n@@ -490,7 +490,7 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n     const value: o.Expression = this._visit(ast.value, _Mode.Expression);\n \n     if (obj === this._implicitReceiver) {\n-      this._localResolver.maybeRestoreView(0, false);\n+      this._localResolver.maybeRestoreView();\n     }\n \n     return convertToStatementIfNeeded(mode, obj.key(key).set(value));"
        },
        {
            "sha": "9f5d1b61912fa6296a87fe9df037d4fa8b2e6b73",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 16,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27",
            "patch": "@@ -340,8 +340,8 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n   }\n \n   // LocalResolver\n-  maybeRestoreView(retrievalLevel: number, localRefLookup: boolean): void {\n-    this._bindingScope.maybeRestoreView(retrievalLevel, localRefLookup);\n+  maybeRestoreView(): void {\n+    this._bindingScope.maybeRestoreView();\n   }\n \n   private i18nTranslate(\n@@ -1656,7 +1656,6 @@ const SHARED_CONTEXT_KEY = '$$shared_ctx$$';\n type BindingData = {\n   retrievalLevel: number; lhs: o.Expression;\n   declareLocalCallback?: DeclareLocalVarCallback; declare: boolean; priority: number;\n-  localRef: boolean;\n };\n \n /**\n@@ -1701,15 +1700,14 @@ export class BindingScope implements LocalResolver {\n             lhs: value.lhs,\n             declareLocalCallback: value.declareLocalCallback,\n             declare: false,\n-            priority: value.priority,\n-            localRef: value.localRef\n+            priority: value.priority\n           };\n \n           // Cache the value locally.\n           this.map.set(name, value);\n           // Possibly generate a shared context var\n           this.maybeGenerateSharedContextVar(value);\n-          this.maybeRestoreView(value.retrievalLevel, value.localRef);\n+          this.maybeRestoreView();\n         }\n \n         if (value.declareLocalCallback && !value.declare) {\n@@ -1754,7 +1752,6 @@ export class BindingScope implements LocalResolver {\n       declare: false,\n       declareLocalCallback: declareLocalCallback,\n       priority: priority,\n-      localRef: localRef || false\n     });\n     return this;\n   }\n@@ -1823,24 +1820,22 @@ export class BindingScope implements LocalResolver {\n       },\n       declare: false,\n       priority: DeclarationPriority.SHARED_CONTEXT,\n-      localRef: false\n     });\n   }\n \n   getComponentProperty(name: string): o.Expression {\n     const componentValue = this.map.get(SHARED_CONTEXT_KEY + 0)!;\n     componentValue.declare = true;\n-    this.maybeRestoreView(0, false);\n+    this.maybeRestoreView();\n     return componentValue.lhs.prop(name);\n   }\n \n-  maybeRestoreView(retrievalLevel: number, localRefLookup: boolean) {\n-    // We want to restore the current view in listener fns if:\n-    // 1 - we are accessing a value in a parent view, which requires walking the view tree rather\n-    // than using the ctx arg. In this case, the retrieval and binding level will be different.\n-    // 2 - we are looking up a local ref, which requires restoring the view where the local\n-    // ref is stored\n-    if (this.isListenerScope() && (retrievalLevel < this.bindingLevel || localRefLookup)) {\n+  maybeRestoreView() {\n+    // View restoration is required for listener instructions inside embedded views, because\n+    // they only run in creation mode and they can have references to the context object.\n+    // If the context object changes in update mode, the reference will be incorrect, because\n+    // it was established during creation.\n+    if (this.isListenerScope()) {\n       if (!this.parent!.restoreViewVariable) {\n         // parent saves variable to generate a shared `const $s$ = getCurrentView();` instruction\n         this.parent!.restoreViewVariable = o.variable(this.parent!.freshReferenceName());"
        },
        {
            "sha": "597d830d03f309f9eb0bd12aa7b28bcfad4580b7",
            "filename": "packages/core/test/acceptance/listener_spec.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcore%2Ftest%2Facceptance%2Flistener_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27/packages%2Fcore%2Ftest%2Facceptance%2Flistener_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Flistener_spec.ts?ref=404c8d0d88b88ae3ab5a80609d508fb2ecdf0d27",
            "patch": "@@ -552,4 +552,45 @@ describe('event listeners', () => {\n \n     expect(fixture.componentInstance.message).toBe('hello');\n   });\n+\n+  it('should reference the correct context object if it is swapped out', () => {\n+    @Component({\n+      template: `\n+        <ng-template let-obj #template>\n+          <button (click)=\"obj.value = obj.value + '!'\">Change</button>\n+        </ng-template>\n+\n+        <ng-container *ngTemplateOutlet=\"template; context: {$implicit: current}\"></ng-container>\n+      `\n+    })\n+    class MyComp {\n+      one = {value: 'one'};\n+      two = {value: 'two'};\n+      current = this.one;\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [MyComp], imports: [CommonModule]});\n+    const fixture = TestBed.createComponent(MyComp);\n+    const instance = fixture.componentInstance;\n+    fixture.detectChanges();\n+    const button = fixture.nativeElement.querySelector('button');\n+\n+    expect(instance.one.value).toBe('one');\n+    expect(instance.two.value).toBe('two');\n+\n+    button.click();\n+    fixture.detectChanges();\n+\n+    expect(instance.one.value).toBe('one!');\n+    expect(instance.two.value).toBe('two');\n+\n+    instance.current = instance.two;\n+    fixture.detectChanges();\n+\n+    button.click();\n+    fixture.detectChanges();\n+\n+    expect(instance.one.value).toBe('one!');\n+    expect(instance.two.value).toBe('two!');\n+  });\n });"
        }
    ],
    "stats": {
        "total": 166,
        "additions": 148,
        "deletions": 18
    }
}