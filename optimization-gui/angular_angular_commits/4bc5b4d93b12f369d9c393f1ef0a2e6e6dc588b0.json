{
    "author": "crisbeto",
    "message": "fix(core): global listeners not being bound on non-node host elements (#42014)\n\nWe skip event listeners on non-element host nodes (e.g. `ng-container` or `ng-element`), because they don't map to a DOM node so there's nothing to bind the event to. The problem is that this also prevents listeners bound to global targets from being bound.\n\nThese changes add an extra condition to allow for the event to be bound if it has a custom event target resolver.\n\nFixes #14191.\n\nPR Close #42014",
    "sha": "4bc5b4d93b12f369d9c393f1ef0a2e6e6dc588b0",
    "files": [
        {
            "sha": "ae31a5ffe8b5b4189550c69b85bd6d5a800742a9",
            "filename": "packages/core/src/render3/instructions/listener.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/4bc5b4d93b12f369d9c393f1ef0a2e6e6dc588b0/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts",
            "raw_url": "https://github.com/angular/angular/raw/4bc5b4d93b12f369d9c393f1ef0a2e6e6dc588b0/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts?ref=4bc5b4d93b12f369d9c393f1ef0a2e6e6dc588b0",
            "patch": "@@ -131,8 +131,11 @@ function listenerInternal(\n \n   let processOutputs = true;\n \n-  // add native event listener - applicable to elements only\n-  if (tNode.type & TNodeType.AnyRNode) {\n+  // Adding a native event listener is applicable when:\n+  // - The corresponding TNode represents a DOM element.\n+  // - The event target has a resolver (usually resulting in a global object,\n+  //   such as `window` or `document`).\n+  if ((tNode.type & TNodeType.AnyRNode) || eventTargetResolver) {\n     const native = getNativeByTNode(tNode, lView) as RElement;\n     const target = eventTargetResolver ? eventTargetResolver(native) : native;\n     const lCleanupIndex = lCleanup.length;"
        },
        {
            "sha": "51bf82f4ff66baea62c98c7bdd5a5f15e9b0e72d",
            "filename": "packages/core/test/acceptance/listener_spec.ts",
            "status": "modified",
            "additions": 104,
            "deletions": 1,
            "changes": 105,
            "blob_url": "https://github.com/angular/angular/blob/4bc5b4d93b12f369d9c393f1ef0a2e6e6dc588b0/packages%2Fcore%2Ftest%2Facceptance%2Flistener_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4bc5b4d93b12f369d9c393f1ef0a2e6e6dc588b0/packages%2Fcore%2Ftest%2Facceptance%2Flistener_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Flistener_spec.ts?ref=4bc5b4d93b12f369d9c393f1ef0a2e6e6dc588b0",
            "patch": "@@ -6,7 +6,8 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Component, Directive, ErrorHandler, EventEmitter, HostListener, Input, Output, QueryList, ViewChild, ViewChildren} from '@angular/core';\n+import {CommonModule} from '@angular/common';\n+import {Component, Directive, ErrorHandler, EventEmitter, HostListener, Input, OnInit, Output, QueryList, TemplateRef, ViewChild, ViewChildren, ViewContainerRef} from '@angular/core';\n import {TestBed} from '@angular/core/testing';\n import {By} from '@angular/platform-browser';\n import {onlyInIvy} from '@angular/private/testing';\n@@ -397,6 +398,108 @@ describe('event listeners', () => {\n     expect(comp.counter).toBe(1);\n   });\n \n+  onlyInIvy('global event listeners on non-node host elements are supported only in Ivy')\n+      .it('should bind global event listeners on an ng-container directive host', () => {\n+        let clicks = 0;\n+\n+        @Directive({selector: '[add-global-listener]'})\n+        class AddGlobalListener {\n+          @HostListener('document:click')\n+          handleClick() {\n+            clicks++;\n+          }\n+        }\n+\n+        @Component({\n+          template: `\n+            <ng-container add-global-listener>\n+              <button>Click me!</button>\n+            </ng-container>\n+          `\n+        })\n+        class MyComp {\n+        }\n+\n+        TestBed.configureTestingModule({declarations: [MyComp, AddGlobalListener]});\n+        const fixture = TestBed.createComponent(MyComp);\n+        fixture.detectChanges();\n+        const button = fixture.nativeElement.querySelector('button');\n+        button.click();\n+        fixture.detectChanges();\n+        expect(clicks).toBe(1);\n+      });\n+\n+  onlyInIvy('global event listeners on non-node host elements are supported only in Ivy')\n+      .it('should bind global event listeners on an ng-template directive host', () => {\n+        let clicks = 0;\n+\n+        @Directive({selector: '[add-global-listener]'})\n+        class AddGlobalListener {\n+          @HostListener('document:click')\n+          handleClick() {\n+            clicks++;\n+          }\n+        }\n+\n+        @Component({\n+          template: `\n+            <ng-template #template add-global-listener>\n+              <button>Click me!</button>\n+            </ng-template>\n+\n+            <ng-container [ngTemplateOutlet]=\"template\"></ng-container>\n+          `\n+        })\n+        class MyComp {\n+        }\n+\n+        TestBed.configureTestingModule(\n+            {declarations: [MyComp, AddGlobalListener], imports: [CommonModule]});\n+        const fixture = TestBed.createComponent(MyComp);\n+        fixture.detectChanges();\n+        const button = fixture.nativeElement.querySelector('button');\n+        button.click();\n+        fixture.detectChanges();\n+        expect(clicks).toBe(1);\n+      });\n+\n+  onlyInIvy('global event listeners on non-node host elements are supported only in Ivy')\n+      .it('should bind global event listeners on a structural directive host', () => {\n+        let clicks = 0;\n+\n+        @Directive({selector: '[add-global-listener]'})\n+        class AddGlobalListener implements OnInit {\n+          @HostListener('document:click')\n+          handleClick() {\n+            clicks++;\n+          }\n+\n+          constructor(private _vcr: ViewContainerRef, private _templateRef: TemplateRef<any>) {}\n+\n+          ngOnInit() {\n+            this._vcr.createEmbeddedView(this._templateRef);\n+          }\n+        }\n+\n+        @Component({\n+          template: `\n+            <div *add-global-listener>\n+              <button>Click me!</button>\n+            </div>\n+          `\n+        })\n+        class MyComp {\n+        }\n+\n+        TestBed.configureTestingModule({declarations: [MyComp, AddGlobalListener]});\n+        const fixture = TestBed.createComponent(MyComp);\n+        fixture.detectChanges();\n+        const button = fixture.nativeElement.querySelector('button');\n+        button.click();\n+        fixture.detectChanges();\n+        expect(clicks).toBe(1);\n+      });\n+\n   onlyInIvy('issue has only been resolved for Ivy')\n       .it('should be able to access a property called $event using `this`', () => {\n         let eventVariable: number|undefined;"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 109,
        "deletions": 3
    }
}