{
    "author": "petebacondarwin",
    "message": "refactor(compiler): store the `fullStart` location on `ParseSourceSpan`s (#39486)\n\nThe lexer is able to skip leading trivia in the `start` location of tokens.\nThis makes the source-span more friendly since things like elements\nappear to begin at the start of the opening tag, rather than at the\nstart of any leading whitespace, which could include newlines.\n\nBut some tooling requires the full source-span to be available, such\nas when tokenizing a text span into an Angular expression.\n\nThis commit simply adds the `fullStart` location to the `ParseSourceSpan`\nclass, and ensures that places where such spans are cloned, this\nproperty flows through too.\n\nPR Close #39486",
    "sha": "8d90c1ad97439ad657b14557c93e809c32ec31ac",
    "files": [
        {
            "sha": "dd46e3adaf180ed264ed115238dfa92c2bb8ff9d",
            "filename": "packages/compiler/src/compiler_facade_interface.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts?ref=8d90c1ad97439ad657b14557c93e809c32ec31ac",
            "patch": "@@ -193,4 +193,5 @@ export interface ParseSourceSpan {\n   start: any;\n   end: any;\n   details: any;\n+  fullStart: any;\n }"
        },
        {
            "sha": "ecda7aa218b4d6887f90cda2e02e7bbf8b717669",
            "filename": "packages/compiler/src/compiler_util/expression_converter.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts?ref=8d90c1ad97439ad657b14557c93e809c32ec31ac",
            "patch": "@@ -917,7 +917,8 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n     if (this.baseSourceSpan) {\n       const start = this.baseSourceSpan.start.moveBy(span.start);\n       const end = this.baseSourceSpan.start.moveBy(span.end);\n-      return new ParseSourceSpan(start, end);\n+      const fullStart = this.baseSourceSpan.fullStart.moveBy(span.start);\n+      return new ParseSourceSpan(start, end, fullStart);\n     } else {\n       return null;\n     }"
        },
        {
            "sha": "2bd172921e4c82e021654bef7a32eec55d036e87",
            "filename": "packages/compiler/src/ml_parser/parser.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fparser.ts?ref=8d90c1ad97439ad657b14557c93e809c32ec31ac",
            "patch": "@@ -129,7 +129,8 @@ class _TreeBuilder {\n           TreeError.create(null, this._peek.sourceSpan, `Invalid ICU message. Missing '}'.`));\n       return;\n     }\n-    const sourceSpan = new ParseSourceSpan(token.sourceSpan.start, this._peek.sourceSpan.end);\n+    const sourceSpan = new ParseSourceSpan(\n+        token.sourceSpan.start, this._peek.sourceSpan.end, token.sourceSpan.fullStart);\n     this._addToParent(new html.Expansion(\n         switchValue.parts[0], type.parts[0], cases, sourceSpan, switchValue.sourceSpan));\n \n@@ -163,8 +164,10 @@ class _TreeBuilder {\n       return null;\n     }\n \n-    const sourceSpan = new ParseSourceSpan(value.sourceSpan.start, end.sourceSpan.end);\n-    const expSourceSpan = new ParseSourceSpan(start.sourceSpan.start, end.sourceSpan.end);\n+    const sourceSpan =\n+        new ParseSourceSpan(value.sourceSpan.start, end.sourceSpan.end, value.sourceSpan.fullStart);\n+    const expSourceSpan =\n+        new ParseSourceSpan(start.sourceSpan.start, end.sourceSpan.end, start.sourceSpan.fullStart);\n     return new html.ExpansionCase(\n         value.parts[0], expansionCaseParser.rootNodes, sourceSpan, value.sourceSpan, expSourceSpan);\n   }\n@@ -257,9 +260,11 @@ class _TreeBuilder {\n       selfClosing = false;\n     }\n     const end = this._peek.sourceSpan.start;\n-    const span = new ParseSourceSpan(startTagToken.sourceSpan.start, end);\n+    const span = new ParseSourceSpan(\n+        startTagToken.sourceSpan.start, end, startTagToken.sourceSpan.fullStart);\n     // Create a separate `startSpan` because `span` will be modified when there is an `end` span.\n-    const startSpan = new ParseSourceSpan(startTagToken.sourceSpan.start, end);\n+    const startSpan = new ParseSourceSpan(\n+        startTagToken.sourceSpan.start, end, startTagToken.sourceSpan.fullStart);\n     const el = new html.Element(fullName, attrs, [], span, startSpan, undefined);\n     this._pushElement(el);\n     if (selfClosing) {\n@@ -347,7 +352,9 @@ class _TreeBuilder {\n       end = quoteToken.sourceSpan.end;\n     }\n     return new html.Attribute(\n-        fullName, value, new ParseSourceSpan(attrName.sourceSpan.start, end), valueSpan);\n+        fullName, value,\n+        new ParseSourceSpan(attrName.sourceSpan.start, end, attrName.sourceSpan.fullStart),\n+        valueSpan);\n   }\n \n   private _getParentElement(): html.Element|null {"
        },
        {
            "sha": "190233f41328a2d333f66db2fa81290ef9e1f990",
            "filename": "packages/compiler/src/parse_util.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Fparse_util.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Fparse_util.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fparse_util.ts?ref=8d90c1ad97439ad657b14557c93e809c32ec31ac",
            "patch": "@@ -100,8 +100,32 @@ export class ParseSourceFile {\n }\n \n export class ParseSourceSpan {\n+  /**\n+   * Create an object that holds information about spans of tokens/nodes captured during\n+   * lexing/parsing of text.\n+   *\n+   * @param start\n+   * The location of the start of the span (having skipped leading trivia).\n+   * Skipping leading trivia makes source-spans more \"user friendly\", since things like HTML\n+   * elements will appear to begin at the start of the opening tag, rather than at the start of any\n+   * leading trivia, which could include newlines.\n+   *\n+   * @param end\n+   * The location of the end of the span.\n+   *\n+   * @param fullStart\n+   * The start of the token without skipping the leading trivia.\n+   * This is used by tooling that splits tokens further, such as extracting Angular interpolations\n+   * from text tokens. Such tooling creates new source-spans relative to the original token's\n+   * source-span. If leading trivia characters have been skipped then the new source-spans may be\n+   * incorrectly offset.\n+   *\n+   * @param details\n+   * Additional information (such as identifier names) that should be associated with the span.\n+   */\n   constructor(\n-      public start: ParseLocation, public end: ParseLocation, public details: string|null = null) {}\n+      public start: ParseLocation, public end: ParseLocation,\n+      public fullStart: ParseLocation = start, public details: string|null = null) {}\n \n   toString(): string {\n     return this.start.file.content.substring(this.start.offset, this.end.offset);"
        },
        {
            "sha": "4d2525d817cdb26a5d3d20befb0d2150556f76c9",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=8d90c1ad97439ad657b14557c93e809c32ec31ac",
            "patch": "@@ -331,7 +331,7 @@ class HtmlAstToIvyAst implements html.Visitor {\n       const normalizationAdjustment = attribute.name.length - name.length;\n       const keySpanStart = srcSpan.start.moveBy(prefix.length + normalizationAdjustment);\n       const keySpanEnd = keySpanStart.moveBy(identifier.length);\n-      return new ParseSourceSpan(keySpanStart, keySpanEnd, identifier);\n+      return new ParseSourceSpan(keySpanStart, keySpanEnd, keySpanStart, identifier);\n     }\n \n     const bindParts = name.match(BIND_NAME_REGEXP);"
        },
        {
            "sha": "85b4178edf5ee383a4f95e432a9b7d7d47dec49c",
            "filename": "packages/compiler/src/render3/view/i18n/localize_utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts?ref=8d90c1ad97439ad657b14557c93e809c32ec31ac",
            "patch": "@@ -90,7 +90,8 @@ function getSourceSpan(message: i18n.Message): ParseSourceSpan {\n   const startNode = message.nodes[0];\n   const endNode = message.nodes[message.nodes.length - 1];\n   return new ParseSourceSpan(\n-      startNode.sourceSpan.start, endNode.sourceSpan.end, startNode.sourceSpan.details);\n+      startNode.sourceSpan.start, endNode.sourceSpan.end, startNode.sourceSpan.fullStart,\n+      startNode.sourceSpan.details);\n }\n \n /**"
        },
        {
            "sha": "f810d55099e6abdcb32ae8dbd1510b04a7133563",
            "filename": "packages/compiler/src/template_parser/binding_parser.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts?ref=8d90c1ad97439ad657b14557c93e809c32ec31ac",
            "patch": "@@ -585,5 +585,7 @@ function moveParseSourceSpan(\n   // The difference of two absolute offsets provide the relative offset\n   const startDiff = absoluteSpan.start - sourceSpan.start.offset;\n   const endDiff = absoluteSpan.end - sourceSpan.end.offset;\n-  return new ParseSourceSpan(sourceSpan.start.moveBy(startDiff), sourceSpan.end.moveBy(endDiff));\n+  return new ParseSourceSpan(\n+      sourceSpan.start.moveBy(startDiff), sourceSpan.end.moveBy(endDiff),\n+      sourceSpan.fullStart.moveBy(startDiff), sourceSpan.details);\n }"
        },
        {
            "sha": "098e8f4979119ebcddef31087fda880d9f1e9062",
            "filename": "packages/compiler/src/template_parser/template_parser.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Ftemplate_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Ftemplate_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Ftemplate_parser.ts?ref=8d90c1ad97439ad657b14557c93e809c32ec31ac",
            "patch": "@@ -566,7 +566,7 @@ class TemplateParseVisitor implements html.Visitor {\n \n     const directiveAsts = directives.map((directive) => {\n       const sourceSpan = new ParseSourceSpan(\n-          elementSourceSpan.start, elementSourceSpan.end,\n+          elementSourceSpan.start, elementSourceSpan.end, elementSourceSpan.fullStart,\n           `Directive ${identifierName(directive.type)}`);\n \n       if (directive.isComponent) {"
        },
        {
            "sha": "dd46e3adaf180ed264ed115238dfa92c2bb8ff9d",
            "filename": "packages/core/src/compiler/compiler_facade_interface.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d90c1ad97439ad657b14557c93e809c32ec31ac/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts?ref=8d90c1ad97439ad657b14557c93e809c32ec31ac",
            "patch": "@@ -193,4 +193,5 @@ export interface ParseSourceSpan {\n   start: any;\n   end: any;\n   details: any;\n+  fullStart: any;\n }"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 49,
        "deletions": 12
    }
}