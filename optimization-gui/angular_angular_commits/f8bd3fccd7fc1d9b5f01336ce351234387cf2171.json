{
    "author": "mgechev",
    "message": "fix(devtools): preserve proper nesting in flattened node lists\n\nRather than naively filter the flattened list, preserve the nesting by\nfiltering the original tree.",
    "sha": "f8bd3fccd7fc1d9b5f01336ce351234387cf2171",
    "files": [
        {
            "sha": "16abef63ca742d401a5733d41abcd14e265a13cf",
            "filename": "projects/ng-devtools-backend/src/lib/client-event-subscribers.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f8bd3fccd7fc1d9b5f01336ce351234387cf2171/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts",
            "raw_url": "https://github.com/angular/angular/raw/f8bd3fccd7fc1d9b5f01336ce351234387cf2171/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts?ref=f8bd3fccd7fc1d9b5f01336ce351234387cf2171",
            "patch": "@@ -197,7 +197,7 @@ export interface SerializableComponentTreeNode\n // Here we drop properties to prepare the tree for serialization.\n // We don't need the component instance, so we just traverse the tree\n // and leave the component name.\n-export const prepareForestForSerialization = (roots: ComponentTreeNode[]): SerializableComponentTreeNode[] => {\n+const prepareForestForSerialization = (roots: ComponentTreeNode[]): SerializableComponentTreeNode[] => {\n   return roots.map((node) => {\n     return {\n       element: node.element,"
        },
        {
            "sha": "eed2cd53df79d52f2e626c589db214873ad88d88",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/directive-explorer/directive-forest/component-data-source.spec.ts",
            "status": "modified",
            "additions": 85,
            "deletions": 0,
            "changes": 85,
            "blob_url": "https://github.com/angular/angular/blob/f8bd3fccd7fc1d9b5f01336ce351234387cf2171/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fdirective-forest%2Fcomponent-data-source.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f8bd3fccd7fc1d9b5f01336ce351234387cf2171/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fdirective-forest%2Fcomponent-data-source.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fdirective-forest%2Fcomponent-data-source.spec.ts?ref=f8bd3fccd7fc1d9b5f01336ce351234387cf2171",
            "patch": "@@ -99,6 +99,79 @@ const tree3: DevToolsNode = {\n   nativeElement: document.createElement('foo'),\n };\n \n+const tree4: DevToolsNode = {\n+  element: 'app',\n+  directives: [\n+    {\n+      id: 1,\n+      name: 'foo',\n+    },\n+  ],\n+  component: null,\n+  children: [\n+    {\n+      children: [\n+        {\n+          children: [\n+            {\n+              children: [\n+                {\n+                  children: [\n+                    {\n+                      children: [],\n+                      component: {\n+                        id: 6,\n+                        isElement: false,\n+                        name: 'qux',\n+                      },\n+                      directives: [],\n+                      element: 'bar',\n+                      nativeElement: document.createComment('bar'),\n+                    },\n+                  ],\n+                  component: {\n+                    id: 5,\n+                    isElement: false,\n+                    name: 'qux',\n+                  },\n+                  directives: [],\n+                  element: '#comment',\n+                  nativeElement: document.createComment('bar'),\n+                },\n+              ],\n+              component: {\n+                id: 4,\n+                isElement: false,\n+                name: 'qux',\n+              },\n+              directives: [],\n+              element: '#comment',\n+              nativeElement: document.createComment('bar'),\n+            },\n+          ],\n+          component: {\n+            id: 3,\n+            isElement: false,\n+            name: 'qux',\n+          },\n+          directives: [],\n+          element: '#comment',\n+          nativeElement: document.createComment('bar'),\n+        },\n+      ],\n+      component: {\n+        id: 2,\n+        isElement: false,\n+        name: 'bar',\n+      },\n+      directives: [],\n+      element: '#comment',\n+      nativeElement: document.createComment('bar'),\n+    },\n+  ],\n+  nativeElement: document.createElement('foo'),\n+};\n+\n describe('ComponentDataSource', () => {\n   let dataSource: ComponentDataSource;\n   const treeControl = new FlatTreeControl<FlatNode>(\n@@ -126,4 +199,16 @@ describe('ComponentDataSource', () => {\n     expect(result.newItems.length).toBe(1);\n     expect(result.newItems[0].name).toBe('app');\n   });\n+\n+  it('should not break nesting with nested comment nodes', () => {\n+    const result = dataSource.update([tree4], false);\n+    expect(result.newItems.length).toBe(2);\n+    expect(result.newItems[0].name).toBe('app');\n+    expect(result.newItems[1].name).toBe('qux');\n+\n+    expect(result.newItems[0].level).toBe(0);\n+    expect(result.newItems[1].level).toBe(1);\n+\n+    expect(result.newItems[1].position).toEqual([0, 0, 0, 0, 0, 0]);\n+  });\n });"
        },
        {
            "sha": "f7fd00629f0dabbb2b234e4d793205c01a194f22",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/directive-explorer/directive-forest/component-data-source.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 4,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/f8bd3fccd7fc1d9b5f01336ce351234387cf2171/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fdirective-forest%2Fcomponent-data-source.ts",
            "raw_url": "https://github.com/angular/angular/raw/f8bd3fccd7fc1d9b5f01336ce351234387cf2171/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fdirective-forest%2Fcomponent-data-source.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fdirective-forest%2Fcomponent-data-source.ts?ref=f8bd3fccd7fc1d9b5f01336ce351234387cf2171",
            "patch": "@@ -37,6 +37,29 @@ const getId = (node: IndexedNode) => {\n   return prefix + '-' + dirIds.join('-');\n };\n \n+/**\n+ * Takes an `IndexedNode` forest and returns a transformed forest without `#comment` nodes.\n+ * The algorithm has linear complexity and O(depth(forest)) memory complexity.\n+ *\n+ * @param nodes indexed nodes, which have already have associated positions within the original\n+ *  tree and associated indices.\n+ * @returns forest with filtered `#comment` nodes.\n+ */\n+const filterCommentNodes = (nodes: IndexedNode[]) => {\n+  for (let i = 0; i < nodes.length; i++) {\n+    const node = nodes[i];\n+    if (node.element !== '#comment') {\n+      continue;\n+    }\n+    nodes.splice(i, 1, ...node.children);\n+    i--;\n+  }\n+  for (const node of nodes) {\n+    filterCommentNodes(node.children);\n+  }\n+  return nodes;\n+};\n+\n export class ComponentDataSource extends DataSource<FlatNode> {\n   private _differ = new DefaultIterableDiffer(trackBy);\n   private _expandedData = new BehaviorSubject<FlatNode[]>([]);\n@@ -92,13 +115,25 @@ export class ComponentDataSource extends DataSource<FlatNode> {\n       return { newItems: [], movedItems: [], removedItems: [] };\n     }\n \n-    const indexedForest = indexForest(forest);\n-    let flattenedCollection = this._treeFlattener.flattenNodes(indexedForest) as FlatNode[];\n-\n+    let indexedForest = indexForest(forest);\n+\n+    // We filter comment nodes here because we need to preserve the positions within the component tree.\n+    //\n+    // For example:\n+    // ```\n+    // - #comment\n+    //   - bar\n+    // ```\n+    //\n+    // #comment's position will be [0] and bar's will be [0, 0]. If we trim #comment nodes earlier\n+    // before indexing, bar's position will be [0] which will be inaccurate and will make the backend\n+    // enable to find the corresponding node when we request its properties.\n     if (!showCommentNodes) {\n-      flattenedCollection = flattenedCollection.filter((node) => node.original.element !== '#comment');\n+      indexedForest = filterCommentNodes(indexedForest);\n     }\n \n+    const flattenedCollection = this._treeFlattener.flattenNodes(indexedForest) as FlatNode[];\n+\n     this.data.forEach((i) => (i.newItem = false));\n \n     const expandedNodes = {};"
        }
    ],
    "stats": {
        "total": 130,
        "additions": 125,
        "deletions": 5
    }
}