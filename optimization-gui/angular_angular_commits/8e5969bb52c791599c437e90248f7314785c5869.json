{
    "author": "AndrewKushnir",
    "message": "fix(compiler): share identical stylesheets between components in the same file (#38213)\n\nPrior to this commit, duplicated styles defined in multiple components in the same file were not\nshared between components, thus causing extra payload size. This commit updates compiler logic to\nuse `ConstantPool` for the styles (while generating the `styles` array on component def), which\nenables styles sharing when needed (when duplicates styles are present).\n\nResolves #38204.\n\nPR Close #38213",
    "sha": "8e5969bb52c791599c437e90248f7314785c5869",
    "files": [
        {
            "sha": "b91c2891d62d57aa136655af60cca96c9730a7c5",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8e5969bb52c791599c437e90248f7314785c5869/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/8e5969bb52c791599c437e90248f7314785c5869/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=8e5969bb52c791599c437e90248f7314785c5869",
            "patch": "@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 2987,\n-        \"main-es2015\": 450596,\n+        \"main-es2015\": 448419,\n         \"polyfills-es2015\": 52630\n       }\n     }"
        },
        {
            "sha": "99933680d06b36fcd10b48e2dab5c1d41f890bdd",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/transform.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/8e5969bb52c791599c437e90248f7314785c5869/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Ftransform.ts",
            "raw_url": "https://github.com/angular/angular/raw/8e5969bb52c791599c437e90248f7314785c5869/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Ftransform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Ftransform.ts?ref=8e5969bb52c791599c437e90248f7314785c5869",
            "patch": "@@ -86,13 +86,15 @@ class IvyTransformationVisitor extends Visitor {\n       VisitListEntryResult<ts.Statement, ts.ClassDeclaration> {\n     // If this class is not registered in the map, it means that it doesn't have Angular decorators,\n     // thus no further processing is required.\n-    if (!this.classCompilationMap.has(node)) return {node};\n+    if (!this.classCompilationMap.has(node)) {\n+      return {node};\n+    }\n \n     // There is at least one field to add.\n     const statements: ts.Statement[] = [];\n     const members = [...node.members];\n \n-    this.classCompilationMap.get(node)!.forEach(field => {\n+    for (const field of this.classCompilationMap.get(node)!) {\n       // Translate the initializer for the field into TS nodes.\n       const exprNode = translateExpression(\n           field.initializer, this.importManager, this.defaultImportRecorder,\n@@ -120,7 +122,7 @@ class IvyTransformationVisitor extends Visitor {\n           .forEach(stmt => statements.push(stmt));\n \n       members.push(property);\n-    });\n+    }\n \n     // Replace the class declaration with an updated version.\n     node = ts.updateClassDeclaration("
        },
        {
            "sha": "e5fac6559cb5141c70bb7f86f024ebef2706cd83",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/8e5969bb52c791599c437e90248f7314785c5869/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8e5969bb52c791599c437e90248f7314785c5869/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=8e5969bb52c791599c437e90248f7314785c5869",
            "patch": "@@ -6623,6 +6623,68 @@ export const Foo = Foo__PRE_R3__;\n         const jsContents = env.getContents('test.js');\n         expect(jsContents).toContain('styles: [\"h1[_ngcontent-%COMP%] {font-size: larger}\"]');\n       });\n+\n+      it('should share same styles declared in different components in the same file', () => {\n+        env.write('test.ts', `\n+          import {Component} from '@angular/core';\n+\n+          @Component({\n+            selector: 'comp-a',\n+            template: 'Comp A',\n+            styles: [\n+              'span { font-size: larger; }',\n+              'div { background: url(/some-very-very-long-path.png); }',\n+              'img { background: url(/a/some-very-very-long-path.png); }'\n+            ]\n+          })\n+          export class CompA {}\n+\n+          @Component({\n+            selector: 'comp-b',\n+            template: 'Comp B',\n+            styles: [\n+              'span { font-size: larger; }',\n+              'div { background: url(/some-very-very-long-path.png); }',\n+              'img { background: url(/b/some-very-very-long-path.png); }'\n+            ]\n+          })\n+          export class CompB {}\n+        `);\n+\n+        env.driveMain();\n+        const jsContents = env.getContents('test.js');\n+\n+        // Verify that long styles present in both components are extracted to a separate var.\n+        expect(jsContents)\n+            .toContain(\n+                '_c0 = \"div[_ngcontent-%COMP%] { background: url(/some-very-very-long-path.png); }\";');\n+\n+        expect(jsContents)\n+            .toContain(\n+                'styles: [' +\n+                // This style is present in both components, but was not extracted into a separate\n+                // var since it doesn't reach length threshold (50 chars) in `ConstantPool`.\n+                '\"span[_ngcontent-%COMP%] { font-size: larger; }\", ' +\n+                // Style that is present in both components, but reaches length threshold -\n+                // extracted to a separate var.\n+                '_c0, ' +\n+                // Style that is unique to this component, but that reaches length threshold -\n+                // remains a string in the `styles` array.\n+                '\"img[_ngcontent-%COMP%] { background: url(/a/some-very-very-long-path.png); }\"]');\n+\n+        expect(jsContents)\n+            .toContain(\n+                'styles: [' +\n+                // This style is present in both components, but was not extracted into a separate\n+                // var since it doesn't reach length threshold (50 chars) in `ConstantPool`.\n+                '\"span[_ngcontent-%COMP%] { font-size: larger; }\", ' +\n+                // Style that is present in both components, but reaches length threshold -\n+                // extracted to a separate var.\n+                '_c0, ' +\n+                // Style that is unique to this component, but that reaches length threshold -\n+                // remains a string in the `styles` array.\n+                '\"img[_ngcontent-%COMP%] { background: url(/b/some-very-very-long-path.png); }\"]');\n+      });\n     });\n \n     describe('non-exported classes', () => {"
        },
        {
            "sha": "b083a2c1edeaa7dcd92d28abb83e495893f0c14d",
            "filename": "packages/compiler/src/constant_pool.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8e5969bb52c791599c437e90248f7314785c5869/packages%2Fcompiler%2Fsrc%2Fconstant_pool.ts",
            "raw_url": "https://github.com/angular/angular/raw/8e5969bb52c791599c437e90248f7314785c5869/packages%2Fcompiler%2Fsrc%2Fconstant_pool.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fconstant_pool.ts?ref=8e5969bb52c791599c437e90248f7314785c5869",
            "patch": "@@ -316,5 +316,5 @@ function isVariable(e: o.Expression): e is o.ReadVarExpr {\n \n function isLongStringExpr(expr: o.LiteralExpr): boolean {\n   return typeof expr.value === 'string' &&\n-      expr.value.length > POOL_INCLUSION_LENGTH_THRESHOLD_FOR_STRINGS;\n+      expr.value.length >= POOL_INCLUSION_LENGTH_THRESHOLD_FOR_STRINGS;\n }\n\\ No newline at end of file"
        },
        {
            "sha": "7adf55fb4389321ea1cd36366a3f86322e1d1c3c",
            "filename": "packages/compiler/src/render3/view/compiler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8e5969bb52c791599c437e90248f7314785c5869/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/8e5969bb52c791599c437e90248f7314785c5869/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts?ref=8e5969bb52c791599c437e90248f7314785c5869",
            "patch": "@@ -231,7 +231,7 @@ export function compileComponentFromMetadata(\n     const styleValues = meta.encapsulation == core.ViewEncapsulation.Emulated ?\n         compileStyles(meta.styles, CONTENT_ATTR, HOST_ATTR) :\n         meta.styles;\n-    const strings = styleValues.map(str => o.literal(str));\n+    const strings = styleValues.map(str => constantPool.getConstLiteral(o.literal(str)));\n     definitionMap.set('styles', o.literalArr(strings));\n   } else if (meta.encapsulation === core.ViewEncapsulation.Emulated) {\n     // If there is no style, don't generate css selectors on elements"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 70,
        "deletions": 6
    }
}