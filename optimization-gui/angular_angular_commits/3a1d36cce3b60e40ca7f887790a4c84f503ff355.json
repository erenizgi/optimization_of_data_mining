{
    "author": "atscott",
    "message": "refactor(language-service): Use compiler APIs in Ivy to get definitions for external resources (#39476)\n\nRather than re-reading component metadata that was already interpreted\nby the Ivy compiler, the Language Service should instead use the\ncompiler APIs to get information it needs about the metadata.\n\nPR Close #39476",
    "sha": "3a1d36cce3b60e40ca7f887790a4c84f503ff355",
    "files": [
        {
            "sha": "30a12ab42a70a129330f4d4e0a423fe6179b6dd2",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Findex.ts?ref=3a1d36cce3b60e40ca7f887790a4c84f503ff355",
            "patch": "@@ -10,6 +10,6 @@ export * from './src/api';\n export {DtsMetadataReader} from './src/dts';\n export {flattenInheritedDirectiveMetadata} from './src/inheritance';\n export {CompoundMetadataRegistry, LocalMetadataRegistry, InjectableClassRegistry} from './src/registry';\n-export {ResourceRegistry, Resource, ComponentResources} from './src/resource_registry';\n+export {ResourceRegistry, Resource, ComponentResources, isExternalResource, ExternalResource} from './src/resource_registry';\n export {extractDirectiveTypeCheckMeta, CompoundMetadataReader} from './src/util';\n export {BindingPropertyName, ClassPropertyMapping, ClassPropertyName, InputOrOutput} from './src/property_mapping';"
        },
        {
            "sha": "28a50e1263b0d4c7ef7cb7881251bf1c9e3f2191",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/resource_registry.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fresource_registry.ts",
            "raw_url": "https://github.com/angular/angular/raw/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fresource_registry.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fresource_registry.ts?ref=3a1d36cce3b60e40ca7f887790a4c84f503ff355",
            "patch": "@@ -23,6 +23,14 @@ export interface Resource {\n   expression: ts.Expression;\n }\n \n+export interface ExternalResource extends Resource {\n+  path: AbsoluteFsPath;\n+}\n+\n+export function isExternalResource(resource: Resource): resource is ExternalResource {\n+  return resource.path !== null;\n+}\n+\n /**\n  * Represents the either inline or external resources of a component.\n  *"
        },
        {
            "sha": "8b584217c607e31679e5a38b94cbd792da91fc6a",
            "filename": "packages/language-service/ivy/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2FBUILD.bazel?ref=3a1d36cce3b60e40ca7f887790a4c84f503ff355",
            "patch": "@@ -12,8 +12,8 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/core:api\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/incremental\",\n+        \"//packages/compiler-cli/src/ngtsc/metadata\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n-        \"//packages/compiler-cli/src/ngtsc/resource\",\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\","
        },
        {
            "sha": "5e59d651fe8e6e54925e2165d8a37db05d4630d6",
            "filename": "packages/language-service/ivy/definitions.ts",
            "status": "modified",
            "additions": 60,
            "deletions": 107,
            "changes": 167,
            "blob_url": "https://github.com/angular/angular/blob/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "raw_url": "https://github.com/angular/angular/raw/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts?ref=3a1d36cce3b60e40ca7f887790a4c84f503ff355",
            "patch": "@@ -8,108 +8,13 @@\n \n import {AST, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstTemplate, TmplAstTextAttribute} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n+import {isExternalResource} from '@angular/compiler-cli/src/ngtsc/metadata';\n import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ShimLocation, Symbol, SymbolKind, TemplateSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript';\n-import {getTargetAtPosition} from './template_target';\n-\n-import {findTightestNode, flatMap, getClassDeclFromDecoratorProp, getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getPropertyAssignmentFromValue, getTemplateInfoAtPosition, getTextSpanOfNode, isDollarEvent, isTypeScriptFile, TemplateInfo, toTextSpan} from './utils';\n-\n-\n-export interface ResourceResolver {\n-  /**\n-   * Resolve the url of a resource relative to the file that contains the reference to it.\n-   *\n-   * @param file The, possibly relative, url of the resource.\n-   * @param basePath The path to the file that contains the URL of the resource.\n-   * @returns A resolved url of resource.\n-   * @throws An error if the resource cannot be resolved.\n-   */\n-  resolve(file: string, basePath: string): string;\n-}\n-\n-/**\n- * Gets an Angular-specific definition in a TypeScript source file.\n- */\n-export function getTsDefinitionAndBoundSpan(\n-    sf: ts.SourceFile, position: number,\n-    resourceResolver: ResourceResolver): ts.DefinitionInfoAndBoundSpan|undefined {\n-  const node = findTightestNode(sf, position);\n-  if (!node) return;\n-  switch (node.kind) {\n-    case ts.SyntaxKind.StringLiteral:\n-    case ts.SyntaxKind.NoSubstitutionTemplateLiteral:\n-      // Attempt to extract definition of a URL in a property assignment.\n-      return getUrlFromProperty(node as ts.StringLiteralLike, resourceResolver);\n-    default:\n-      return undefined;\n-  }\n-}\n-\n-/**\n- * Attempts to get the definition of a file whose URL is specified in a property assignment in a\n- * directive decorator.\n- * Currently applies to `templateUrl` and `styleUrls` properties.\n- */\n-function getUrlFromProperty(urlNode: ts.StringLiteralLike, resourceResolver: ResourceResolver):\n-    ts.DefinitionInfoAndBoundSpan|undefined {\n-  // Get the property assignment node corresponding to the `templateUrl` or `styleUrls` assignment.\n-  // These assignments are specified differently; `templateUrl` is a string, and `styleUrls` is\n-  // an array of strings:\n-  //   {\n-  //        templateUrl: './template.ng.html',\n-  //        styleUrls: ['./style.css', './other-style.css']\n-  //   }\n-  // `templateUrl`'s property assignment can be found from the string literal node;\n-  // `styleUrls`'s property assignment can be found from the array (parent) node.\n-  //\n-  // First search for `templateUrl`.\n-  let asgn = getPropertyAssignmentFromValue(urlNode, 'templateUrl');\n-  if (!asgn) {\n-    // `templateUrl` assignment not found; search for `styleUrls` array assignment.\n-    asgn = getPropertyAssignmentFromValue(urlNode.parent, 'styleUrls');\n-    if (!asgn) {\n-      // Nothing found, bail.\n-      return;\n-    }\n-  }\n-\n-  // If the property assignment is not a property of a class decorator, don't generate definitions\n-  // for it.\n-  if (!getClassDeclFromDecoratorProp(asgn)) {\n-    return;\n-  }\n \n-  const sf = urlNode.getSourceFile();\n-  let url: string;\n-  try {\n-    url = resourceResolver.resolve(urlNode.text, sf.fileName);\n-  } catch {\n-    // If the file does not exist, bail.\n-    return;\n-  }\n-\n-  const templateDefinitions: ts.DefinitionInfo[] = [{\n-    kind: ts.ScriptElementKind.externalModuleName,\n-    name: url,\n-    containerKind: ts.ScriptElementKind.unknown,\n-    containerName: '',\n-    // Reading the template is expensive, so don't provide a preview.\n-    // TODO(ayazhafiz): Consider providing an actual span:\n-    //  1. We're likely to read the template anyway\n-    //  2. We could show just the first 100 chars or so\n-    textSpan: {start: 0, length: 0},\n-    fileName: url,\n-  }];\n-\n-  return {\n-    definitions: templateDefinitions,\n-    textSpan: {\n-      // Exclude opening and closing quotes in the url span.\n-      start: urlNode.getStart() + 1,\n-      length: urlNode.getWidth() - 2,\n-    },\n-  };\n-}\n+import {getTargetAtPosition} from './template_target';\n+import {findTightestNode, getParentClassDeclaration} from './ts_utils';\n+import {flatMap, getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getTemplateInfoAtPosition, getTextSpanOfNode, isDollarEvent, isTypeScriptFile, TemplateInfo, toTextSpan} from './utils';\n \n interface DefinitionMeta {\n   node: AST|TmplAstNode;\n@@ -122,9 +27,7 @@ interface HasShimLocation {\n }\n \n export class DefinitionBuilder {\n-  constructor(\n-      private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler,\n-      private readonly resourceResolver: ResourceResolver) {}\n+  constructor(private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler) {}\n \n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n@@ -136,11 +39,7 @@ export class DefinitionBuilder {\n       if (!isTypeScriptFile(fileName)) {\n         return;\n       }\n-      const sf = this.compiler.getNextProgram().getSourceFile(fileName);\n-      if (!sf) {\n-        return;\n-      }\n-      return getTsDefinitionAndBoundSpan(sf, position, this.resourceResolver);\n+      return getDefinitionForExpressionAtPosition(fileName, position, this.compiler);\n     }\n     const definitionMeta = this.getDefinitionMetaAtPosition(templateInfo, position);\n     // The `$event` of event handlers would point to the $event parameter in the shim file, as in\n@@ -315,3 +214,57 @@ export class DefinitionBuilder {\n     return {node, parent, symbol};\n   }\n }\n+\n+/**\n+ * Gets an Angular-specific definition in a TypeScript source file.\n+ */\n+function getDefinitionForExpressionAtPosition(\n+    fileName: string, position: number, compiler: NgCompiler): ts.DefinitionInfoAndBoundSpan|\n+    undefined {\n+  const sf = compiler.getNextProgram().getSourceFile(fileName);\n+  if (sf === undefined) {\n+    return;\n+  }\n+\n+  const expression = findTightestNode(sf, position);\n+  if (expression === undefined) {\n+    return;\n+  }\n+  const classDeclaration = getParentClassDeclaration(expression);\n+  if (classDeclaration === undefined) {\n+    return;\n+  }\n+  const componentResources = compiler.getComponentResources(classDeclaration);\n+  if (componentResources === null) {\n+    return;\n+  }\n+\n+  const allResources = [...componentResources.styles, componentResources.template];\n+\n+  const resourceForExpression = allResources.find(resource => resource.expression === expression);\n+  if (resourceForExpression === undefined || !isExternalResource(resourceForExpression)) {\n+    return;\n+  }\n+\n+  const templateDefinitions: ts.DefinitionInfo[] = [{\n+    kind: ts.ScriptElementKind.externalModuleName,\n+    name: resourceForExpression.path,\n+    containerKind: ts.ScriptElementKind.unknown,\n+    containerName: '',\n+    // Reading the template is expensive, so don't provide a preview.\n+    // TODO(ayazhafiz): Consider providing an actual span:\n+    //  1. We're likely to read the template anyway\n+    //  2. We could show just the first 100 chars or so\n+    textSpan: {start: 0, length: 0},\n+    fileName: resourceForExpression.path,\n+  }];\n+\n+  return {\n+    definitions: templateDefinitions,\n+    textSpan: {\n+      // Exclude opening and closing quotes in the url span.\n+      start: expression.getStart() + 1,\n+      length: expression.getWidth() - 2,\n+    },\n+  };\n+}"
        },
        {
            "sha": "4af86f7061a4fd2af19698b6b53f6902832cad36",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=3a1d36cce3b60e40ca7f887790a4c84f503ff355",
            "patch": "@@ -58,17 +58,17 @@ export class LanguageService {\n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n     const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n-    const results = new DefinitionBuilder(this.tsLS, compiler, this.adapter)\n-                        .getDefinitionAndBoundSpan(fileName, position);\n+    const results =\n+        new DefinitionBuilder(this.tsLS, compiler).getDefinitionAndBoundSpan(fileName, position);\n     this.compilerFactory.registerLastKnownProgram();\n     return results;\n   }\n \n   getTypeDefinitionAtPosition(fileName: string, position: number):\n       readonly ts.DefinitionInfo[]|undefined {\n     const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n-    const results = new DefinitionBuilder(this.tsLS, compiler, this.adapter)\n-                        .getTypeDefinitionsAtPosition(fileName, position);\n+    const results =\n+        new DefinitionBuilder(this.tsLS, compiler).getTypeDefinitionsAtPosition(fileName, position);\n     this.compilerFactory.registerLastKnownProgram();\n     return results;\n   }"
        },
        {
            "sha": "2aeb1e76a04ef79a65c532b45b6da9c032bdd661",
            "filename": "packages/language-service/ivy/language_service_adapter.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 8,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts",
            "raw_url": "https://github.com/angular/angular/raw/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts?ref=3a1d36cce3b60e40ca7f887790a4c84f503ff355",
            "patch": "@@ -8,14 +8,12 @@\n \n import {NgCompilerAdapter} from '@angular/compiler-cli/src/ngtsc/core/api';\n import {absoluteFrom, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n-import {AdapterResourceLoader} from '@angular/compiler-cli/src/ngtsc/resource';\n import {isShim} from '@angular/compiler-cli/src/ngtsc/shims';\n import * as ts from 'typescript/lib/tsserverlibrary';\n-import {ResourceResolver} from './definitions';\n \n import {isTypeScriptFile} from './utils';\n \n-export class LanguageServiceAdapter implements NgCompilerAdapter, ResourceResolver {\n+export class LanguageServiceAdapter implements NgCompilerAdapter {\n   readonly entryPoint = null;\n   readonly constructionDiagnostics: ts.Diagnostic[] = [];\n   readonly ignoreForEmit: Set<ts.SourceFile> = new Set();\n@@ -79,9 +77,4 @@ export class LanguageServiceAdapter implements NgCompilerAdapter, ResourceResolv\n     const latestVersion = this.project.getScriptVersion(fileName);\n     return lastVersion !== latestVersion;\n   }\n-\n-  resolve(file: string, basePath: string): string {\n-    const loader = new AdapterResourceLoader(this, this.project.getCompilationSettings());\n-    return loader.resolve(file, basePath);\n-  }\n }"
        },
        {
            "sha": "dcc52ca9f43f5e81d69b57ffaf0839540bc8861b",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=3a1d36cce3b60e40ca7f887790a4c84f503ff355",
            "patch": "@@ -459,7 +459,7 @@ describe('definitions', () => {\n \t      @Component({\n \t        templateUrl: './tes¦t.ng',\n \t      })\n-\t      export class MyComponent {}`);\n+\t      export class AppComponent {}`);\n       const result = ngLS.getDefinitionAndBoundSpan(APP_COMPONENT, position);\n \n       expect(result).toBeDefined();\n@@ -481,7 +481,7 @@ describe('definitions', () => {\n \t        template: 'empty',\n \t        styleUrls: ['./te¦st.css']\n \t      })\n-\t      export class MyComponent {}`);\n+\t      export class AppComponent {}`);\n       const result = ngLS.getDefinitionAndBoundSpan(APP_COMPONENT, position);\n \n \n@@ -497,6 +497,26 @@ describe('definitions', () => {\n       expect(def.fileName).toContain('/app/test.css');\n       expect(def.textSpan).toEqual({start: 0, length: 0});\n     });\n+\n+    xit('should be able to find a resource url with malformed component meta', () => {\n+      const {position, text} = service.overwrite(APP_COMPONENT, `\n+        import {Component} from '@angular/core';\n+\t      @Component({\n+\t        invalidProperty: '',\n+\t        styleUrls: ['./te¦st.css']\n+\t      })\n+\t      export class AppComponent {}`);\n+      const result = ngLS.getDefinitionAndBoundSpan(APP_COMPONENT, position);\n+\n+\n+      expect(result).toBeDefined();\n+      const {textSpan, definitions} = result!;\n+\n+      expect(text.substring(textSpan.start, textSpan.start + textSpan.length))\n+          .toEqual('./test.css');\n+      expect(definitions).toBeDefined();\n+      expect(definitions![0].fileName).toContain('/app/test.css');\n+    });\n   });\n \n   function getDefinitionsAndAssertBoundSpan("
        },
        {
            "sha": "4ebb791870302d640ab5066cdefb8a833100a3bb",
            "filename": "packages/language-service/ivy/ts_utils.ts",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Fts_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Fts_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_utils.ts?ref=3a1d36cce3b60e40ca7f887790a4c84f503ff355",
            "patch": "@@ -0,0 +1,30 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import * as ts from 'typescript';\n+\n+/**\n+ * Return the node that most tightly encompasses the specified `position`.\n+ * @param node The starting node to start the top-down search.\n+ * @param position The target position within the `node`.\n+ */\n+export function findTightestNode(node: ts.Node, position: number): ts.Node|undefined {\n+  if (node.getStart() <= position && position < node.getEnd()) {\n+    return node.forEachChild(c => findTightestNode(c, position)) ?? node;\n+  }\n+  return undefined;\n+}\n+\n+export function getParentClassDeclaration(startNode: ts.Node): ts.ClassDeclaration|undefined {\n+  while (startNode) {\n+    if (ts.isClassDeclaration(startNode)) {\n+      return startNode;\n+    }\n+    startNode = startNode.parent;\n+  }\n+  return undefined;\n+}"
        },
        {
            "sha": "1c54df46a1243ededdac9ef7a27e71566c8abd91",
            "filename": "packages/language-service/ivy/utils.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 111,
            "changes": 146,
            "blob_url": "https://github.com/angular/angular/blob/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fivy%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Futils.ts?ref=3a1d36cce3b60e40ca7f887790a4c84f503ff355",
            "patch": "@@ -7,94 +7,15 @@\n  */\n import {AbsoluteSourceSpan, CssSelector, ParseSourceSpan, SelectorMatcher} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n+import {isExternalResource} from '@angular/compiler-cli/src/ngtsc/metadata';\n import {DeclarationNode} from '@angular/compiler-cli/src/ngtsc/reflection';\n import {DirectiveSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as e from '@angular/compiler/src/expression_parser/ast';  // e for expression AST\n import * as t from '@angular/compiler/src/render3/r3_ast';         // t for template AST\n import * as ts from 'typescript';\n \n import {ALIAS_NAME, SYMBOL_PUNC} from './display_parts';\n-\n-\n-\n-/**\n- * Return the node that most tightly encompass the specified `position`.\n- * @param node\n- * @param position\n- */\n-export function findTightestNode(node: ts.Node, position: number): ts.Node|undefined {\n-  if (node.getStart() <= position && position < node.getEnd()) {\n-    return node.forEachChild(c => findTightestNode(c, position)) || node;\n-  }\n-}\n-\n-/**\n- * Returns a property assignment from the assignment value if the property name\n- * matches the specified `key`, or `undefined` if there is no match.\n- */\n-export function getPropertyAssignmentFromValue(value: ts.Node, key: string): ts.PropertyAssignment|\n-    undefined {\n-  const propAssignment = value.parent;\n-  if (!propAssignment || !ts.isPropertyAssignment(propAssignment) ||\n-      propAssignment.name.getText() !== key) {\n-    return;\n-  }\n-  return propAssignment;\n-}\n-\n-/**\n- * Given a decorator property assignment, return the ClassDeclaration node that corresponds to the\n- * directive class the property applies to.\n- * If the property assignment is not on a class decorator, no declaration is returned.\n- *\n- * For example,\n- *\n- * @Component({\n- *   template: '<div></div>'\n- *   ^^^^^^^^^^^^^^^^^^^^^^^---- property assignment\n- * })\n- * class AppComponent {}\n- *           ^---- class declaration node\n- *\n- * @param propAsgnNode property assignment\n- */\n-export function getClassDeclFromDecoratorProp(propAsgnNode: ts.PropertyAssignment):\n-    ts.ClassDeclaration|undefined {\n-  if (!propAsgnNode.parent || !ts.isObjectLiteralExpression(propAsgnNode.parent)) {\n-    return;\n-  }\n-  const objLitExprNode = propAsgnNode.parent;\n-  if (!objLitExprNode.parent || !ts.isCallExpression(objLitExprNode.parent)) {\n-    return;\n-  }\n-  const callExprNode = objLitExprNode.parent;\n-  if (!callExprNode.parent || !ts.isDecorator(callExprNode.parent)) {\n-    return;\n-  }\n-  const decorator = callExprNode.parent;\n-  if (!decorator.parent || !ts.isClassDeclaration(decorator.parent)) {\n-    return;\n-  }\n-  const classDeclNode = decorator.parent;\n-  return classDeclNode;\n-}\n-\n-/**\n- * Given the node which is the string of the inline template for a component, returns the\n- * `ts.ClassDeclaration` for the component.\n- */\n-export function getClassDeclOfInlineTemplateNode(templateStringNode: ts.Node): ts.ClassDeclaration|\n-    undefined {\n-  if (!ts.isStringLiteralLike(templateStringNode)) {\n-    return;\n-  }\n-  const tmplAsgn = getPropertyAssignmentFromValue(templateStringNode, 'template');\n-  if (!tmplAsgn) {\n-    return;\n-  }\n-  return getClassDeclFromDecoratorProp(tmplAsgn);\n-}\n-\n+import {findTightestNode, getParentClassDeclaration} from './ts_utils';\n \n export function getTextSpanOfNode(node: t.Node|e.AST): ts.TextSpan {\n   if (isTemplateNodeWithKeyAndValue(node)) {\n@@ -146,19 +67,50 @@ export interface TemplateInfo {\n   component: ts.ClassDeclaration;\n }\n \n+function getInlineTemplateInfoAtPosition(\n+    sf: ts.SourceFile, position: number, compiler: NgCompiler): TemplateInfo|undefined {\n+  const expression = findTightestNode(sf, position);\n+  if (expression === undefined) {\n+    return undefined;\n+  }\n+  const classDecl = getParentClassDeclaration(expression);\n+  if (classDecl === undefined) {\n+    return undefined;\n+  }\n+\n+  // Return `undefined` if the position is not on the template expression or the template resource\n+  // is not inline.\n+  const resources = compiler.getComponentResources(classDecl);\n+  if (resources === null || isExternalResource(resources.template) ||\n+      expression !== resources.template.expression) {\n+    return undefined;\n+  }\n+\n+  const template = compiler.getTemplateTypeChecker().getTemplate(classDecl);\n+  if (template === null) {\n+    return undefined;\n+  }\n+\n+  return {template, component: classDecl};\n+}\n+\n /**\n  * Retrieves the `ts.ClassDeclaration` at a location along with its template nodes.\n  */\n export function getTemplateInfoAtPosition(\n     fileName: string, position: number, compiler: NgCompiler): TemplateInfo|undefined {\n   if (isTypeScriptFile(fileName)) {\n-    return getTemplateInfoFromClassMeta(fileName, position, compiler);\n+    const sf = compiler.getNextProgram().getSourceFile(fileName);\n+    if (sf === undefined) {\n+      return undefined;\n+    }\n+\n+    return getInlineTemplateInfoAtPosition(sf, position, compiler);\n   } else {\n     return getFirstComponentForTemplateFile(fileName, compiler);\n   }\n }\n \n-\n /**\n  * First, attempt to sort component declarations by file name.\n  * If the files are the same, sort by start location of the declaration.\n@@ -194,34 +146,6 @@ function getFirstComponentForTemplateFile(fileName: string, compiler: NgCompiler\n   return undefined;\n }\n \n-/**\n- * Retrieves the `ts.ClassDeclaration` at a location along with its template nodes.\n- */\n-function getTemplateInfoFromClassMeta(\n-    fileName: string, position: number, compiler: NgCompiler): TemplateInfo|undefined {\n-  const classDecl = getClassDeclForInlineTemplateAtPosition(fileName, position, compiler);\n-  if (!classDecl || !classDecl.name) {  // Does not handle anonymous class\n-    return;\n-  }\n-  const template = compiler.getTemplateTypeChecker().getTemplate(classDecl);\n-  if (template === null) {\n-    return;\n-  }\n-\n-  return {template, component: classDecl};\n-}\n-\n-function getClassDeclForInlineTemplateAtPosition(\n-    fileName: string, position: number, compiler: NgCompiler): ts.ClassDeclaration|undefined {\n-  const sourceFile = compiler.getNextProgram().getSourceFile(fileName);\n-  if (!sourceFile) {\n-    return undefined;\n-  }\n-  const node = findTightestNode(sourceFile, position);\n-  if (!node) return;\n-  return getClassDeclOfInlineTemplateNode(node);\n-}\n-\n /**\n  * Given an attribute node, converts it to string form.\n  */"
        },
        {
            "sha": "ae927fd77d66e9b7344a0b227943acd040904090",
            "filename": "packages/language-service/src/typescript_host.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/3a1d36cce3b60e40ca7f887790a4c84f503ff355/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts?ref=3a1d36cce3b60e40ca7f887790a4c84f503ff355",
            "patch": "@@ -13,7 +13,7 @@ import * as tss from 'typescript/lib/tsserverlibrary';\n import {createLanguageService} from './language_service';\n import {ReflectorHost} from './reflector_host';\n import {ExternalTemplate, InlineTemplate} from './template';\n-import {findTightestNode, getClassDeclOfInlineTemplateNode, getDirectiveClassLike} from './ts_utils';\n+import {findTightestNode, getClassDeclFromDecoratorProp, getDirectiveClassLike, getPropertyAssignmentFromValue} from './ts_utils';\n import {AstResult, Declaration, DeclarationError, DiagnosticMessageChain, LanguageService, LanguageServiceHost, Span, TemplateSource} from './types';\n \n /**\n@@ -382,7 +382,11 @@ export class TypeScriptServiceHost implements LanguageServiceHost {\n     if (!tss.isStringLiteralLike(node)) {\n       return;\n     }\n-    const classDecl = getClassDeclOfInlineTemplateNode(node);\n+    const tmplAsgn = getPropertyAssignmentFromValue(node, 'template');\n+    if (!tmplAsgn) {\n+      return;\n+    }\n+    const classDecl = getClassDeclFromDecoratorProp(tmplAsgn);\n     if (!classDecl || !classDecl.name) {  // Does not handle anonymous class\n       return;\n     }"
        }
    ],
    "stats": {
        "total": 404,
        "additions": 168,
        "deletions": 236
    }
}