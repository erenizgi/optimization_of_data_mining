{
    "author": "atscott",
    "message": "fix(compiler-cli): Handle `ng-template` with structural directive in indexer (#44788)\n\nAn `ng-template` with an inline template (i.e. has a structural\ndirective) would previously not get an `undefined` `tagName` because the\nlogic assumed the element would be `t.Element` or `t.Content` and read\nthe tag name from the `name` property. For a `t.Template`, this exists\ninstead on the `t.tagName`. The final result would be an `tagName` of `undefined`\nfor the parent `t.Template`, causing failures in the indexer downstream.\n\nThis `undefined` value is actually expected in the renderer code, even\nthough the type does not specify this possibility. This change updates\nthe type of `tagName` to be `string|null` and explicitly handles the\ncase where there is a structural directive on an `ng-template`. You can\nsee how the two are differentiated in the compliance code that was\nmodified in this commit.\n\nPR Close #44788",
    "sha": "1bce51c0ed42621b2f9623d2f083424d76d1acfd",
    "files": [
        {
            "sha": "8b5f137eb9d0912a2e6498132bb2ef458d79247c",
            "filename": "packages/compiler-cli/src/ngtsc/indexer/src/template.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Fsrc%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Fsrc%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Fsrc%2Ftemplate.ts?ref=1bce51c0ed42621b2f9623d2f083424d76d1acfd",
            "patch": "@@ -229,7 +229,7 @@ class TemplateVisitor extends TmplAstRecursiveVisitor {\n     let name: string;\n     let kind: IdentifierKind.Element|IdentifierKind.Template;\n     if (node instanceof TmplAstTemplate) {\n-      name = node.tagName;\n+      name = node.tagName ?? 'ng-template';\n       kind = IdentifierKind.Template;\n     } else {\n       name = node.name;"
        },
        {
            "sha": "c5f63c04f2f4d7fa84d682a4abb3516bb5125aad",
            "filename": "packages/compiler-cli/src/ngtsc/indexer/test/template_spec.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Ftemplate_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Ftemplate_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Ftemplate_spec.ts?ref=1bce51c0ed42621b2f9623d2f083424d76d1acfd",
            "patch": "@@ -75,6 +75,20 @@ runInEachFileSystem(() => {\n       });\n     });\n \n+    it('works when structural directives are on templates', () => {\n+      const template = '<ng-template *ngIf=\"true\">';\n+      const refs = getTemplateIdentifiers(bind(template));\n+\n+      const [ref] = Array.from(refs);\n+      expect(ref).toEqual({\n+        kind: IdentifierKind.Template,\n+        name: 'ng-template',\n+        span: new AbsoluteSourceSpan(1, 12),\n+        usedDirectives: new Set(),\n+        attributes: new Set(),\n+      });\n+    });\n+\n     it('should generate nothing in empty template', () => {\n       const template = '';\n       const refs = getTemplateIdentifiers(bind(template));"
        },
        {
            "sha": "c09dc1d90c6d3f3939570750ac0c5d1ae64583a5",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/ng-template_interpolation_structural.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fng-template_interpolation_structural.js",
            "raw_url": "https://github.com/angular/angular/raw/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fng-template_interpolation_structural.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fng-template_interpolation_structural.js?ref=1bce51c0ed42621b2f9623d2f083424d76d1acfd",
            "patch": "@@ -20,7 +20,7 @@ consts: function() {\n },\n template: function MyComponent_Template(rf, ctx) {\n   if (rf & 1) {\n-    $r3$.ɵɵtemplate(0, MyComponent_0_Template, 2, 1, undefined, 0);\n+    $r3$.ɵɵtemplate(0, MyComponent_0_Template, 2, 1, null, 0);\n   }\n   if (rf & 2) {\n     $r3$.ɵɵproperty(\"ngIf\", true);"
        },
        {
            "sha": "71c70067d52bc6b6c258dd6fecde0c80095914f5",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/ng-template_structural.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fng-template_structural.js",
            "raw_url": "https://github.com/angular/angular/raw/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fng-template_structural.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fng-template_structural.js?ref=1bce51c0ed42621b2f9623d2f083424d76d1acfd",
            "patch": "@@ -19,7 +19,7 @@ consts: function() {\n },\n template: function MyComponent_Template(rf, ctx) {\n   if (rf & 1) {\n-    $r3$.ɵɵtemplate(0, MyComponent_0_Template, 1, 0, undefined, 0);\n+    $r3$.ɵɵtemplate(0, MyComponent_0_Template, 1, 0, null, 0);\n   }\n   if (rf & 2) {\n     $r3$.ɵɵproperty(\"ngIf\", ctx.visible);"
        },
        {
            "sha": "6659ace8c59e5b9637eabb08ab3fa0c3126dbf02",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/ng-container_ng-template/structural_directives.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fng-container_ng-template%2Fstructural_directives.js",
            "raw_url": "https://github.com/angular/angular/raw/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fng-container_ng-template%2Fstructural_directives.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fng-container_ng-template%2Fstructural_directives.js?ref=1bce51c0ed42621b2f9623d2f083424d76d1acfd",
            "patch": "@@ -31,7 +31,7 @@ consts: function() {\n },\n template: function MyComponent_Template(rf, ctx) {\n   if (rf & 1) {\n-    $r3$.ɵɵtemplate(0, MyComponent_0_Template, 1, 0, undefined, 0);\n+    $r3$.ɵɵtemplate(0, MyComponent_0_Template, 1, 0, null, 0);\n     $r3$.ɵɵtemplate(1, MyComponent_ng_container_1_Template, 2, 0, \"ng-container\", 0);\n   }\n   if (rf & 2) {"
        },
        {
            "sha": "96509eebd06ef52886d136c356212afbe6013c2b",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_template/ng_template_interpolated_prop_with_structural_directive_outer_template.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_template%2Fng_template_interpolated_prop_with_structural_directive_outer_template.js",
            "raw_url": "https://github.com/angular/angular/raw/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_template%2Fng_template_interpolated_prop_with_structural_directive_outer_template.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_template%2Fng_template_interpolated_prop_with_structural_directive_outer_template.js?ref=1bce51c0ed42621b2f9623d2f083424d76d1acfd",
            "patch": "@@ -1,7 +1,7 @@\n consts: [[4, \"ngIf\"], [3, \"dir\"]],\n template: function TestComp_Template(rf, ctx) {\n   if (rf & 1) {\n-    $i0$.ɵɵtemplate(0, $TestComp_0_Template$, 1, 1, undefined, 0);\n+    $i0$.ɵɵtemplate(0, $TestComp_0_Template$, 1, 1, null, 0);\n   }\n   if (rf & 2) {\n     $i0$.ɵɵproperty(\"ngIf\", true);"
        },
        {
            "sha": "6e4f1b94975c24a22a42d419c1b52a97ee07ab41",
            "filename": "packages/compiler/src/render3/r3_ast.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts?ref=1bce51c0ed42621b2f9623d2f083424d76d1acfd",
            "patch": "@@ -119,11 +119,23 @@ export class Element implements Node {\n \n export class Template implements Node {\n   constructor(\n-      public tagName: string, public attributes: TextAttribute[], public inputs: BoundAttribute[],\n-      public outputs: BoundEvent[], public templateAttrs: (BoundAttribute|TextAttribute)[],\n-      public children: Node[], public references: Reference[], public variables: Variable[],\n-      public sourceSpan: ParseSourceSpan, public startSourceSpan: ParseSourceSpan,\n-      public endSourceSpan: ParseSourceSpan|null, public i18n?: I18nMeta) {}\n+      // tagName is the name of the container element, if applicable.\n+      // `null` is a special case for when there is a structural directive on an `ng-template` so\n+      // the renderer can differentiate between the synthetic template and the one written in the\n+      // file.\n+      public tagName: string|null,\n+      public attributes: TextAttribute[],\n+      public inputs: BoundAttribute[],\n+      public outputs: BoundEvent[],\n+      public templateAttrs: (BoundAttribute|TextAttribute)[],\n+      public children: Node[],\n+      public references: Reference[],\n+      public variables: Variable[],\n+      public sourceSpan: ParseSourceSpan,\n+      public startSourceSpan: ParseSourceSpan,\n+      public endSourceSpan: ParseSourceSpan|null,\n+      public i18n?: I18nMeta,\n+  ) {}\n   visit<Result>(visitor: Visitor<Result>): Result {\n     return visitor.visitTemplate(this);\n   }"
        },
        {
            "sha": "bd9ec1c0d70c6c2f47231f4f85677d7fd1f8fd42",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=1bce51c0ed42621b2f9623d2f083424d76d1acfd",
            "patch": "@@ -186,7 +186,7 @@ class HtmlAstToIvyAst implements html.Visitor {\n     const children: t.Node[] =\n         html.visitAll(preparsedElement.nonBindable ? NON_BINDABLE_VISITOR : this, element.children);\n \n-    let parsedElement: t.Node|undefined;\n+    let parsedElement: t.Content|t.Template|t.Element|undefined;\n     if (preparsedElement.type === PreparsedElementType.NG_CONTENT) {\n       // `<ng-content>`\n       if (element.children &&\n@@ -235,13 +235,12 @@ class HtmlAstToIvyAst implements html.Visitor {\n       // the wrapping template to prevent unnecessary i18n instructions from being generated. The\n       // necessary i18n meta information will be extracted from child elements.\n       const i18n = isTemplateElement && isI18nRootElement ? undefined : element.i18n;\n+      const name = parsedElement instanceof t.Template ? null : parsedElement.name;\n \n-      // TODO(pk): test for this case\n       parsedElement = new t.Template(\n-          (parsedElement as t.Element | t.Content).name, hoistedAttrs.attributes,\n-          hoistedAttrs.inputs, hoistedAttrs.outputs, templateAttrs, [parsedElement],\n-          [/* no references */], templateVariables, element.sourceSpan, element.startSourceSpan,\n-          element.endSourceSpan, i18n);\n+          name, hoistedAttrs.attributes, hoistedAttrs.inputs, hoistedAttrs.outputs, templateAttrs,\n+          [parsedElement], [/* no references */], templateVariables, element.sourceSpan,\n+          element.startSourceSpan, element.endSourceSpan, i18n);\n     }\n     if (isI18nRootElement) {\n       this.inI18nBlock = false;"
        },
        {
            "sha": "ce9039193315dc10d25abf02e57162f9f5004c47",
            "filename": "packages/compiler/test/render3/r3_template_transform_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_template_transform_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_template_transform_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_template_transform_spec.ts?ref=1bce51c0ed42621b2f9623d2f083424d76d1acfd",
            "patch": "@@ -9,6 +9,7 @@\n import {BindingType} from '../../src/expression_parser/ast';\n import * as t from '../../src/render3/r3_ast';\n import {unparse} from '../expression_parser/utils/unparser';\n+\n import {parseR3 as parse} from './view/util';\n \n \n@@ -272,6 +273,18 @@ describe('R3 template transform', () => {\n       ]);\n     });\n \n+    it('should support <ng-template> with structural directive', () => {\n+      expectFromHtml('<ng-template *ngIf=\"true\"></ng-template>').toEqual([\n+        ['Template'],\n+        ['BoundAttribute', 0, 'ngIf', 'true'],\n+        ['Template'],\n+      ]);\n+      const res = parse('<ng-template *ngIf=\"true\"></ng-template>', {ignoreError: false});\n+      expect((res.nodes[0] as t.Template).tagName).toEqual(null);\n+      expect(((res.nodes[0] as t.Template).children[0] as t.Template).tagName)\n+          .toEqual('ng-template');\n+    });\n+\n     it('should support reference via #...', () => {\n       expectFromHtml('<ng-template #a></ng-template>').toEqual([\n         ['Template'],"
        },
        {
            "sha": "4c16ecbb25918baaeee562e78dc089a54186cb6d",
            "filename": "packages/language-service/src/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Flanguage-service%2Fsrc%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bce51c0ed42621b2f9623d2f083424d76d1acfd/packages%2Flanguage-service%2Fsrc%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Futils.ts?ref=1bce51c0ed42621b2f9623d2f083424d76d1acfd",
            "patch": "@@ -183,7 +183,7 @@ function toAttributeCssSelector(attribute: t.TextAttribute|t.BoundAttribute|t.Bo\n }\n \n function getNodeName(node: t.Template|t.Element): string {\n-  return node instanceof t.Template ? node.tagName : node.name;\n+  return node instanceof t.Template ? (node.tagName ?? 'ng-template') : node.name;\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 55,
        "deletions": 17
    }
}