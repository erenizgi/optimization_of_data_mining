{
    "author": "gkalpak",
    "message": "build(docs-infra): auto-generate SW `navigationUrls` from Firebase config (#42452)\n\nPreviously, redirects had to be configured in both the Firebase config\n(`firebase.json`) and the ServiceWorker config (`ngsw-config.json`).\nThis made it challenging to correctly configure redirects, since one had\nto understand the different formats of the two configs, and was also\nprone to getting out-of-sync configs.\n\nThis commit simplifies the process of adding redirects by removing the\nneed to update the ServiceWorker config (`ngsw-config.json`) and keep it\nin sync with the Firebase config (`firebase.json`). Instead the\nServiceWorker `navigationUrls` are automatically generated from the list\nof redirects in the Firebase config.\n\nNOTE:\nCurrently, the automatic generation only supports the limited set of\npatterns that are necessary to translate the existing redirects. It can\nbe made more sophisticated in the future, should the need arise.\n\nPR Close #42452",
    "sha": "d07e736f17a8dc0451adf581281b7221227785f2",
    "files": [
        {
            "sha": "513d7eef7f42f8cf4b98c81b9ef9130fdb602a1b",
            "filename": "aio/angular.json",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Fangular.json",
            "raw_url": "https://github.com/angular/angular/raw/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Fangular.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fangular.json?ref=d07e736f17a8dc0451adf581281b7221227785f2",
            "patch": "@@ -32,6 +32,7 @@\n             \"index\": \"src/index.html\",\n             \"main\": \"src/main.ts\",\n             \"polyfills\": \"src/polyfills.ts\",\n+            \"ngswConfigPath\": \"src/generated/ngsw-config.json\",\n             \"tsConfig\": \"tsconfig.app.json\",\n             \"webWorkerTsConfig\": \"tsconfig.worker.json\",\n             \"optimization\": {\n@@ -47,9 +48,16 @@\n             \"namedChunks\": true,\n             \"assets\": [\n               \"src/assets\",\n-              \"src/generated\",\n               \"src/pwa-manifest.json\",\n-              \"src/google385281288605d160.html\"\n+              \"src/google385281288605d160.html\",\n+              {\n+                \"input\": \"src/generated\",\n+                \"output\": \"generated\",\n+                \"glob\": \"**\",\n+                \"ignore\": [\n+                  \"ngsw-config.json\"\n+                ]\n+              }\n             ],\n             \"styles\": [\n               \"src/styles/main.scss\","
        },
        {
            "sha": "2e61ba4448c2fa127a375beac2a693256bbc94d8",
            "filename": "aio/firebase.json",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Ffirebase.json",
            "raw_url": "https://github.com/angular/angular/raw/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Ffirebase.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ffirebase.json?ref=d07e736f17a8dc0451adf581281b7221227785f2",
            "patch": "@@ -4,12 +4,6 @@\n     \"public\": \"dist\",\n     \"cleanUrls\": true,\n     \"redirects\": [\n-      //////////////////////////////////////////////////////////////////////////////////////////////\n-      // README:\n-      //   Redirects must also be handled by the ServiceWorker. If you add a redirect rule here,\n-      //   make sure it is compatible with the configuration in `ngsw-config.json`.\n-      //////////////////////////////////////////////////////////////////////////////////////////////\n-\n       // A random bad indexed page that used `api/api`\n       {\"type\": 301, \"source\": \"/api/api/:rest*\", \"destination\": \"/api/:rest*\"},\n "
        },
        {
            "sha": "10555ab0ca27168eb2bdc62315e03964c530f3c3",
            "filename": "aio/ngsw-config.json",
            "status": "removed",
            "additions": 0,
            "deletions": 143,
            "changes": 143,
            "blob_url": "https://github.com/angular/angular/blob/982521f284373e855f186985f1e46ad221a5b6fe/aio%2Fngsw-config.json",
            "raw_url": "https://github.com/angular/angular/raw/982521f284373e855f186985f1e46ad221a5b6fe/aio%2Fngsw-config.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fngsw-config.json?ref=982521f284373e855f186985f1e46ad221a5b6fe",
            "patch": "@@ -1,143 +0,0 @@\n-{\n-  \"index\": \"/index.html\",\n-  \"assetGroups\": [\n-    {\n-      \"name\": \"app-shell\",\n-      \"installMode\": \"prefetch\",\n-      \"updateMode\": \"prefetch\",\n-      \"resources\": {\n-        \"files\": [\n-          \"/index.html\",\n-          \"/pwa-manifest.json\",\n-          \"/assets/images/favicons/favicon.ico\",\n-          \"/assets/js/*.js\",\n-          \"/*.css\",\n-          \"/*.js\",\n-          \"!/*-es5*.js\"\n-        ],\n-        \"urls\": [\n-          \"https://fonts.googleapis.com/**\",\n-          \"https://fonts.gstatic.com/s/**\"\n-        ]\n-      }\n-    },\n-    {\n-      \"name\": \"assets-eager\",\n-      \"installMode\": \"prefetch\",\n-      \"updateMode\": \"prefetch\",\n-      \"resources\": {\n-        \"files\": [\n-          \"/assets/images/**\",\n-          \"/generated/images/marketing/**\",\n-          \"!/assets/images/favicons/**\",\n-          \"!/**/_unused/**\"\n-        ]\n-      }\n-    },\n-    {\n-      \"name\": \"assets-lazy\",\n-      \"installMode\": \"lazy\",\n-      \"updateMode\": \"prefetch\",\n-      \"resources\": {\n-        \"files\": [\n-          \"/assets/images/favicons/**\",\n-          \"/generated/js/custom-elements-es5-polyfills.js\",\n-          \"/*-es5*.js\",\n-          \"!/**/_unused/**\"\n-        ]\n-      }\n-    },\n-    {\n-      \"name\": \"docs-index\",\n-      \"installMode\": \"prefetch\",\n-      \"updateMode\": \"prefetch\",\n-      \"resources\": {\n-        \"files\": [\n-          \"/generated/*.json\",\n-          \"/generated/docs/*.json\",\n-          \"/generated/docs/api/api-list.json\",\n-          \"/generated/docs/app/search-data.json\"\n-        ]\n-      }\n-    },\n-    {\n-      \"name\": \"docs-lazy\",\n-      \"installMode\": \"lazy\",\n-      \"updateMode\": \"lazy\",\n-      \"resources\": {\n-        \"files\": [\n-          \"/generated/docs/**/*.json\",\n-          \"/generated/images/**\",\n-          \"!/**/_unused/**\"\n-        ]\n-      }\n-    }\n-  ],\n-  \"navigationUrls\": [\n-    \"/**\",\n-    \"!/**/*.*\",\n-    \"!/**/*__*\",\n-    \"!/**/*__*/**\",\n-    \"!/**/stackblitz/{0,1}\",\n-    \"!/**/AnimationStateDeclarationMetadata*\",\n-    \"!/**/CORE_DIRECTIVES*\",\n-    \"!/**/DirectiveMetadata-*\",\n-    \"!/**/HTTP_PROVIDERS*\",\n-    \"!/**/NgFor-*\",\n-    \"!/**/OptionalMetadata-*\",\n-    \"!/**/PLATFORM_PIPES*\",\n-    \"!/**/api/common/Control*\",\n-    \"!/**/api/common/ControlGroup*\",\n-    \"!/**/api/common/NgModel/{0,1}\",\n-    \"!/**/api/common/SelectControlValueAccessor-*\",\n-    \"!/**/api/common/index/MaxLengthValidator-*\",\n-    \"!/**/cookbook/ts-to-js*\",\n-    \"!/api/*/*-(class|decorator|directive|function|interface|let|pipe|type|type-alias|var)\",\n-    \"!/api/*/testing/*-(class|decorator|directive|function|interface|let|pipe|type|type-alias|var)\",\n-    \"!/api/*/testing/index/*\",\n-    \"!/api/animate/**\",\n-    \"!/api/api/**\",\n-    \"!/api/http/**\",\n-    \"!/api/http/{0,1}\",\n-    \"!/api/platform-browser/AnimationDriver/{0,1}\",\n-    \"!/api/testing/*-*\",\n-    \"!/api/upgrade/*/*-(class|decorator|directive|function|interface|let|pipe|type|type-alias|var)\",\n-    \"!/api/upgrade/*/index/*\",\n-    \"!/config/app-package-json/{0,1}\",\n-    \"!/config/solution-tsconfig/{0,1}\",\n-    \"!/config/tsconfig/{0,1}\",\n-    \"!/devtools/{0,1}\",\n-    \"!/docs/*/latest/**\",\n-    \"!/docs/*/latest/{0,1}\",\n-    \"!/docs/latest/**\",\n-    \"!/docs/styleguide*\",\n-    \"!/docs/styleguide/{0,1}\",\n-    \"!/getting-started/**\",\n-    \"!/getting-started/{0,1}\",\n-    \"!/guide/bazel/{0,1}\",\n-    \"!/guide/change-log/{0,1}\",\n-    \"!/guide/cli-quickstart/{0,1}\",\n-    \"!/guide/displaying-data/{0,1}\",\n-    \"!/guide/learning-angular*\",\n-    \"!/guide/metadata/{0,1}\",\n-    \"!/guide/ngmodule/{0,1}\",\n-    \"!/guide/quickstart/{0,1}\",\n-    \"!/guide/service-worker-comm/{0,1}\",\n-    \"!/guide/service-worker-configref/{0,1}\",\n-    \"!/guide/service-worker-getstart/{0,1}\",\n-    \"!/guide/setup-systemjs-anatomy/{0,1}\",\n-    \"!/guide/setup/{0,1}\",\n-    \"!/guide/updating-to-version-10/{0,1}\",\n-    \"!/guide/updating-to-version-11/{0,1}\",\n-    \"!/guide/webpack/{0,1}\",\n-    \"!/news*\",\n-    \"!/start/data/{0,1}\",\n-    \"!/start/deployment/{0,1}\",\n-    \"!/start/forms/{0,1}\",\n-    \"!/start/routing/{0,1}\",\n-    \"!/strict/{0,1}\",\n-    \"!/styleguide/{0,1}\",\n-    \"!/testing/**\",\n-    \"!/testing/{0,1}\"\n-  ]\n-}"
        },
        {
            "sha": "f28aceefde4d3922548f1673a966c1de7ba42cf2",
            "filename": "aio/ngsw-config.template.json",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/angular/angular/blob/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Fngsw-config.template.json",
            "raw_url": "https://github.com/angular/angular/raw/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Fngsw-config.template.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fngsw-config.template.json?ref=d07e736f17a8dc0451adf581281b7221227785f2",
            "patch": "@@ -0,0 +1,83 @@\n+{\n+  \"index\": \"/index.html\",\n+  \"assetGroups\": [\n+    {\n+      \"name\": \"app-shell\",\n+      \"installMode\": \"prefetch\",\n+      \"updateMode\": \"prefetch\",\n+      \"resources\": {\n+        \"files\": [\n+          \"/index.html\",\n+          \"/pwa-manifest.json\",\n+          \"/assets/images/favicons/favicon.ico\",\n+          \"/assets/js/*.js\",\n+          \"/*.css\",\n+          \"/*.js\",\n+          \"!/*-es5*.js\"\n+        ],\n+        \"urls\": [\n+          \"https://fonts.googleapis.com/**\",\n+          \"https://fonts.gstatic.com/s/**\"\n+        ]\n+      }\n+    },\n+    {\n+      \"name\": \"assets-eager\",\n+      \"installMode\": \"prefetch\",\n+      \"updateMode\": \"prefetch\",\n+      \"resources\": {\n+        \"files\": [\n+          \"/assets/images/**\",\n+          \"/generated/images/marketing/**\",\n+          \"!/assets/images/favicons/**\",\n+          \"!/**/_unused/**\"\n+        ]\n+      }\n+    },\n+    {\n+      \"name\": \"assets-lazy\",\n+      \"installMode\": \"lazy\",\n+      \"updateMode\": \"prefetch\",\n+      \"resources\": {\n+        \"files\": [\n+          \"/assets/images/favicons/**\",\n+          \"/generated/js/custom-elements-es5-polyfills.js\",\n+          \"/*-es5*.js\",\n+          \"!/**/_unused/**\"\n+        ]\n+      }\n+    },\n+    {\n+      \"name\": \"docs-index\",\n+      \"installMode\": \"prefetch\",\n+      \"updateMode\": \"prefetch\",\n+      \"resources\": {\n+        \"files\": [\n+          \"/generated/*.json\",\n+          \"/generated/docs/*.json\",\n+          \"/generated/docs/api/api-list.json\",\n+          \"/generated/docs/app/search-data.json\"\n+        ]\n+      }\n+    },\n+    {\n+      \"name\": \"docs-lazy\",\n+      \"installMode\": \"lazy\",\n+      \"updateMode\": \"lazy\",\n+      \"resources\": {\n+        \"files\": [\n+          \"/generated/docs/**/*.json\",\n+          \"/generated/images/**\",\n+          \"!/**/_unused/**\"\n+        ]\n+      }\n+    }\n+  ],\n+  \"navigationUrls\": [\n+    \"/**\",\n+    \"!/**/*.*\",\n+    \"!/**/*__*\",\n+    \"!/**/*__*/**\",\n+    \"!/**/stackblitz/{0,1}\"\n+  ]\n+}"
        },
        {
            "sha": "448c547162603f1f2ffec78cb5f38e70326d4a1a",
            "filename": "aio/package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fpackage.json?ref=d07e736f17a8dc0451adf581281b7221227785f2",
            "patch": "@@ -71,10 +71,11 @@\n     \"~~audit-web-app\": \"node scripts/audit-web-app\",\n     \"~~check-env\": \"node scripts/check-environment\",\n     \"~~clean-generated\": \"node --eval \\\"require('shelljs').rm('-rf', 'src/generated')\\\"\",\n-    \"pre~~build\": \"yarn ~~build-ce-es5-polyfills\",\n+    \"pre~~build\": \"yarn ~~build-ce-es5-polyfills && yarn ~~build-ngsw-config\",\n     \"~~build\": \"ng build --configuration=stable\",\n     \"post~~build\": \"yarn build-404-page\",\n     \"~~build-ce-es5-polyfills\": \"esbuild src/custom-elements-es5-polyfills.js --bundle --minify | swc --config=minify=true --filename=custom-elements-es5-polyfills.js --out-file=src/generated/js/custom-elements-es5-polyfills.js --no-swcrc\",\n+    \"~~build-ngsw-config\": \"node scripts/build-ngsw-config\",\n     \"~~light-server\": \"light-server --bind=localhost --historyindex=/index.html --no-reload\"\n   },\n   \"//engines-comment\": \"Keep this in sync with /package.json and /aio/tools/examples/shared/package.json\","
        },
        {
            "sha": "2cf16009f8849c051573dc704a2410acc61e6f82",
            "filename": "aio/scripts/build-ngsw-config.js",
            "status": "added",
            "additions": 85,
            "deletions": 0,
            "changes": 85,
            "blob_url": "https://github.com/angular/angular/blob/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Fscripts%2Fbuild-ngsw-config.js",
            "raw_url": "https://github.com/angular/angular/raw/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Fscripts%2Fbuild-ngsw-config.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fbuild-ngsw-config.js?ref=d07e736f17a8dc0451adf581281b7221227785f2",
            "patch": "@@ -0,0 +1,85 @@\n+// Imports\n+const {basename, dirname, resolve: resolvePath} = require('canonical-path');\n+const {mkdirSync, readFileSync, writeFileSync} = require('fs');\n+const {parse: parseJson} = require('json5');\n+\n+\n+// Constants\n+const FIREBASE_CONFIG_PATH = resolvePath(__dirname, '../firebase.json');\n+const NGSW_CONFIG_TEMPLATE_PATH = resolvePath(__dirname, '../ngsw-config.template.json');\n+const NGSW_CONFIG_OUTPUT_PATH = resolvePath(__dirname, '../src/generated/ngsw-config.json');\n+\n+// Run\n+_main();\n+\n+// Helpers\n+function _main() {\n+  const firebaseConfig = readJson(FIREBASE_CONFIG_PATH);\n+  const ngswConfig = readJson(NGSW_CONFIG_TEMPLATE_PATH);\n+\n+  const firebaseRedirects = firebaseConfig.hosting.redirects;\n+\n+  // Check that there are no regex-based redirects.\n+  const regexBasedRedirects = firebaseRedirects.filter(({regex}) => regex !== undefined);\n+  if (regexBasedRedirects.length > 0) {\n+    throw new Error(\n+      'The following redirects use `regex`, which is currently not supported by ' +\n+      `${basename(__filename)}:` +\n+      regexBasedRedirects.map(x => `\\n  - ${JSON.stringify(x)}`).join(''));\n+  }\n+\n+  // Check that there are no unsupported glob characters/patterns.\n+  const redirectsWithUnsupportedGlobs = firebaseRedirects\n+    .filter(({source}) => !/^(?:[/\\w\\-.*]|:\\w+|@\\([\\w\\-.|]+\\))+$/.test(source));\n+  if (redirectsWithUnsupportedGlobs.length > 0) {\n+    throw new Error(\n+      'The following redirects use glob characters/patterns that are currently not supported by ' +\n+      `${basename(__filename)}:` +\n+      redirectsWithUnsupportedGlobs.map(x => `\\n  - ${JSON.stringify(x)}`).join(''));\n+  }\n+\n+  // Compute additional ignore glob patterns to be added to `navigationUrls`.\n+  const additionalNavigationUrls = firebaseRedirects\n+    // Grab the redirect source glob.\n+    .map(({source}) => source)\n+    // Ignore redirects for files (since these are already ignored by the SW).\n+    .filter(glob => /\\/[^/.]*$/.test(glob))\n+    // Convert each Firebase-specific glob to a SW-compatible glob.\n+    .map(glob => `!${glob.replace(/:\\w+/g, '*').replace(/@(\\([\\w\\-.|]+\\))/g, '$1')}`)\n+    // Add optional trailing `/` for globs that don't end with `*`.\n+    .map(glob => /\\w$/.test(glob) ? `${glob}\\/{0,1}` : glob)\n+    // Remove more specific globs that are covered by more generic ones.\n+    .filter((glob, _i, globs) => !isGlobRedundant(glob, globs))\n+    // Sort the generated globs alphabetically.\n+    .sort();\n+\n+  // Add the additional `navigationUrls` globs and save the config.\n+  ngswConfig.navigationUrls.push(...additionalNavigationUrls);\n+\n+  mkdirSync(dirname(NGSW_CONFIG_OUTPUT_PATH), {recursive: true});\n+  writeJson(NGSW_CONFIG_OUTPUT_PATH, ngswConfig);\n+}\n+\n+function isGlobRedundant(glob, globs) {\n+  // Find all globs that could cover other globs.\n+  // For simplicity, we only consider globs ending with `/**`.\n+  const genericGlobs = globs.filter(g => g.endsWith('/**'));\n+\n+  // A glob is redundant if it starts with the path of a potentially generic glob (excluding the\n+  // trailing `**`) followed by a word character or a `*`.\n+  // For example, `/foo/bar/baz` is covered (and thus made redundant) by `/foo/**`, but `/foo/{0,1}`\n+  // is not.\n+  return genericGlobs.some(g => {\n+    const pathPrefix = g.slice(0, -2);\n+    return (glob !== g) && glob.startsWith(pathPrefix) &&\n+      /^[\\w*]/.test(glob.slice(pathPrefix.length));\n+  });\n+}\n+\n+function readJson(filePath) {\n+  return parseJson(readFileSync(filePath, 'utf8'));\n+}\n+\n+function writeJson(filePath, obj) {\n+  return writeFileSync(filePath, `${JSON.stringify(obj, null, 2)}\\n`);\n+}"
        },
        {
            "sha": "2444bf47357c3c863956ed2a0d22ad3338807b1d",
            "filename": "aio/src/index.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Fsrc%2Findex.html",
            "raw_url": "https://github.com/angular/angular/raw/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Fsrc%2Findex.html",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Findex.html?ref=d07e736f17a8dc0451adf581281b7221227785f2",
            "patch": "@@ -24,7 +24,7 @@\n   <link rel=\"apple-touch-icon\" sizes=\"144x144\" href=\"assets/images/favicons/favicon-144x144.png\">\n   <link rel=\"apple-touch-icon-precomposed\" sizes=\"144x144\" href=\"assets/images/favicons/favicon-144x144.png\">\n \n-  <!-- NOTE: These need to be kept in sync with `ngsw-config.json`. -->\n+  <!-- NOTE: These need to be kept in sync with `ngsw-config.template.json`. -->\n   <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap\">\n   <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500&display=swap\">\n   <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/icon?family=Material+Icons&display=block\">"
        },
        {
            "sha": "e439e985cfb9c5fa7954018dc747b43f5738a7b9",
            "filename": "aio/tests/deployment/shared/helpers.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Ftests%2Fdeployment%2Fshared%2Fhelpers.ts",
            "raw_url": "https://github.com/angular/angular/raw/d07e736f17a8dc0451adf581281b7221227785f2/aio%2Ftests%2Fdeployment%2Fshared%2Fhelpers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftests%2Fdeployment%2Fshared%2Fhelpers.ts?ref=d07e736f17a8dc0451adf581281b7221227785f2",
            "patch": "@@ -19,7 +19,7 @@ export function getRedirector() {\n }\n \n export function getSwNavigationUrlChecker() {\n-  const config = loadJson(`${AIO_DIR}/ngsw-config.json`);\n+  const config = loadJson(`${AIO_DIR}/src/generated/ngsw-config.json`);\n   const navigationUrlSpecs = processNavigationUrls('', config.navigationUrls);\n \n   const includePatterns = navigationUrlSpecs"
        }
    ],
    "stats": {
        "total": 336,
        "additions": 182,
        "deletions": 154
    }
}