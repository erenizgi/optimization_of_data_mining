{
    "author": "dgp1130",
    "message": "feat(bazel): add `strict_templates` and `experimental_extended_template_diagnostics` to `ng_module()` rule (#43582)\n\nRefs #42966.\nFixes #33452.\n\nThis allows `ng_module()` targets to be built with strict templates enabled, it mostly works the way we already do this internally. Also adds extended template diagnostics behind an experimental option so it can be used internally and for tests.\n\n`strict_templates` can only be used if `type_check` is also enabled and `experimental_extended_template_diagnostics` can only be used if `strict_templates` is enabled.\n\nPR Close #43582",
    "sha": "62d7005a52304f41a48f878f176f40e90437a555",
    "files": [
        {
            "sha": "8ea9df8287a7bdf1a3b8f28c70ff013b8aa77d7d",
            "filename": "packages/bazel/src/ng_module.bzl",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/62d7005a52304f41a48f878f176f40e90437a555/packages%2Fbazel%2Fsrc%2Fng_module.bzl",
            "raw_url": "https://github.com/angular/angular/raw/62d7005a52304f41a48f878f176f40e90437a555/packages%2Fbazel%2Fsrc%2Fng_module.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module.bzl?ref=62d7005a52304f41a48f878f176f40e90437a555",
            "patch": "@@ -326,6 +326,22 @@ def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n     else:\n         expected_outs = outs.closure_js\n \n+    if not ctx.attr.type_check and ctx.attr.strict_templates:\n+        fail(\"Cannot set type_check = False and strict_templates = True for ng_module()\")\n+\n+    # Targets that set strict_templates should only be built with Ivy. If we allowed\n+    # View Engine builds, then later attempts to migrate such targets to Ivy may fail\n+    # due to new template errors that only the Ivy compiler produces.\n+    #\n+    # Note that during i18n message extraction, Ivy targets are still built with\n+    # View Engine, so we specifically exempt xi18n compilations from this error.\n+    # See b/187342177 for context.\n+    if is_legacy_ngc and ctx.attr.strict_templates:\n+        fail(\"strict_templates is not available for legacy View Engine compilations. See go/angular/ivy for details on how to opt in.\")\n+\n+    if ctx.attr.experimental_extended_template_diagnostics and not ctx.attr.strict_templates:\n+        fail(\"Cannot set `experimental_extended_template_diagnostics = True` **and** `strict_templates = False` for `ng_module()`\")\n+\n     angular_compiler_options = {\n         \"enableResourceInlining\": ctx.attr.inline_resources,\n         \"generateCodeForLibraries\": False,\n@@ -337,6 +353,7 @@ def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n         \"enableIvy\": is_ivy_enabled(ctx),\n         \"compilationMode\": ctx.attr.compilation_mode,\n         \"fullTemplateTypeCheck\": ctx.attr.type_check,\n+        \"_extendedTemplateDiagnostics\": ctx.attr.experimental_extended_template_diagnostics,\n         # In Google3 we still want to use the symbol factory re-exports in order to\n         # not break existing apps inside Google. Unlike Bazel, Google3 does not only\n         # enforce strict dependencies of source files, but also for generated files\n@@ -354,6 +371,12 @@ def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n         \"_useManifestPathsAsModuleName\": (not _is_bazel()),\n     }\n \n+    # Only add `strictTemplates` if it is requested, that way an existing patch in components won't\n+    # be broken by duplicating the key.\n+    # TODO(#42966): Inline this in the above dict once components' patch is removed.\n+    if ctx.attr.strict_templates:\n+        angular_compiler_options[\"strictTemplates\"] = True\n+\n     if is_perf_requested(ctx):\n         # In Ivy mode, set the `tracePerformance` Angular compiler option to enable performance\n         # metric output.\n@@ -713,6 +736,11 @@ NG_MODULE_ATTRIBUTES = {\n     ),\n     \"filter_summaries\": attr.bool(default = False),\n     \"type_check\": attr.bool(default = True),\n+    \"strict_templates\": attr.bool(default = False),\n+    \"experimental_extended_template_diagnostics\": attr.bool(\n+        default = False,\n+        doc = \"Experimental option, not publicly supported.\",\n+    ),\n     \"inline_resources\": attr.bool(default = True),\n     \"compilation_mode\": attr.string(\n         doc = \"\"\"Set the compilation mode for the Angular compiler."
        }
    ],
    "stats": {
        "total": 28,
        "additions": 28,
        "deletions": 0
    }
}