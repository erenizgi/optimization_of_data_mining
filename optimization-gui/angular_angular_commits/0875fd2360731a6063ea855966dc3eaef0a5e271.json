{
    "author": "bjarkler",
    "message": "feat(core): create internal Trusted Types module (#39207)\n\nAdd a module that provides a Trusted Types policy for use internally by\nAngular. The policy is created lazily and stored in a module-local\nvariable. For now the module does not allow configuring custom policies\nor policy names, and instead creates its own policy with 'angular' as a\nfixed policy name. This is to more easily support tree-shakability.\n\nHelper functions for unsafely converting strings to each of the three\nTrusted Types are also introduced, with documentation that make it clear\nthat their use requires a security review. When Trusted Types are not\navailable, these helper functions fall back to returning strings.\n\nPR Close #39207",
    "sha": "0875fd2360731a6063ea855966dc3eaef0a5e271",
    "files": [
        {
            "sha": "2b7fdfaf45644875194086cad8ef2edf44c4d498",
            "filename": "packages/core/src/util/security/trusted_types.ts",
            "status": "added",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/angular/angular/blob/0875fd2360731a6063ea855966dc3eaef0a5e271/packages%2Fcore%2Fsrc%2Futil%2Fsecurity%2Ftrusted_types.ts",
            "raw_url": "https://github.com/angular/angular/raw/0875fd2360731a6063ea855966dc3eaef0a5e271/packages%2Fcore%2Fsrc%2Futil%2Fsecurity%2Ftrusted_types.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Futil%2Fsecurity%2Ftrusted_types.ts?ref=0875fd2360731a6063ea855966dc3eaef0a5e271",
            "patch": "@@ -0,0 +1,87 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * @fileoverview\n+ * A module to facilitate use of a Trusted Types policy internally within\n+ * Angular. It lazily constructs the Trusted Types policy, providing helper\n+ * utilities for promoting strings to Trusted Types. When Trusted Types are not\n+ * available, strings are used as a fallback.\n+ * @security All use of this module is security-sensitive and should go through\n+ * security review.\n+ */\n+\n+import {global} from '../global';\n+\n+/**\n+ * The Trusted Types policy, or null if Trusted Types are not\n+ * enabled/supported, or undefined if the policy has not been created yet.\n+ */\n+let policy: TrustedTypePolicy|null|undefined;\n+\n+/**\n+ * Returns the Trusted Types policy, or null if Trusted Types are not\n+ * enabled/supported. The first call to this function will create the policy.\n+ */\n+function getPolicy(): TrustedTypePolicy|null {\n+  if (policy === undefined) {\n+    policy = null;\n+    if (global.trustedTypes) {\n+      try {\n+        policy = (global.trustedTypes as TrustedTypePolicyFactory).createPolicy('angular', {\n+          createHTML: (s: string) => s,\n+          createScript: (s: string) => s,\n+          createScriptURL: (s: string) => s,\n+        });\n+      } catch {\n+        // trustedTypes.createPolicy throws if called with a name that is\n+        // already registered, even in report-only mode. Until the API changes,\n+        // catch the error not to break the applications functionally. In such\n+        // cases, the code will fall back to using strings.\n+      }\n+    }\n+  }\n+  return policy;\n+}\n+\n+/**\n+ * Unsafely promote a string to a TrustedHTML, falling back to strings when\n+ * Trusted Types are not available.\n+ * @security This is a security-sensitive function; any use of this function\n+ * must go through security review. In particular, it must be assured that the\n+ * provided string will never cause an XSS vulnerability if used in a context\n+ * that will be interpreted as HTML by a browser, e.g. when assigning to\n+ * element.innerHTML.\n+ */\n+export function trustedHTMLFromString(html: string): TrustedHTML|string {\n+  return getPolicy()?.createHTML(html) || html;\n+}\n+\n+/**\n+ * Unsafely promote a string to a TrustedScript, falling back to strings when\n+ * Trusted Types are not available.\n+ * @security In particular, it must be assured that the provided string will\n+ * never cause an XSS vulnerability if used in a context that will be\n+ * interpreted and executed as a script by a browser, e.g. when calling eval.\n+ */\n+export function trustedScriptFromString(script: string): TrustedScript|string {\n+  return getPolicy()?.createScript(script) || script;\n+}\n+\n+/**\n+ * Unsafely promote a string to a TrustedScriptURL, falling back to strings\n+ * when Trusted Types are not available.\n+ * @security This is a security-sensitive function; any use of this function\n+ * must go through security review. In particular, it must be assured that the\n+ * provided string will never cause an XSS vulnerability if used in a context\n+ * that will cause a browser to load and execute a resource, e.g. when\n+ * assigning to script.src.\n+ */\n+export function trustedScriptURLFromString(url: string): TrustedScriptURL|string {\n+  return getPolicy()?.createScriptURL(url) || url;\n+}"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 87,
        "deletions": 0
    }
}