{
    "author": "gkalpak",
    "message": "fix(docs-infra): do not redirect disambiguated URLs (#41842)\n\nIn #41788, logic was added to disambiguate case-insensitively equal docs\npaths/URLs. This process includes appending a `-\\d+` suffix to some\npaths/URLs (for example, `/.../inject-1`). Unfortunately, some of the\nFirebase redirects configured in `firebase.json` would match these URLs\nand redirect them to non-existing paths.\nExample failures: [stable][1], [next][2]\n\nNOTE:\nThis was not picked up in the regular CI tests run for PRs, because the\nlocal devserver and the preview server used to test PRs do not support\nFirebase-like redirects.\n\nThis commit fixes this by ensuring these disambiguated paths/URLs are\nnot matched by the redirect rules by checking whether the part of the\nsuffix after the `-` contains any numeric digits. While this check is\nnot ideal, it should be good enough for our purpose, since the legacy\nURLs that we do want to redirect contain suffixes such as `-class`,\n`-function` and thus no numeric digits.\n\n[1]: https://circleci.com/gh/angular/angular/974345\n[2]: https://circleci.com/gh/angular/angular/974346\n\nPR Close #41842",
    "sha": "3b7d4ebbd6445364889d61b7b1b1c65206534d34",
    "files": [
        {
            "sha": "bbf7b2220a841b41c9c858a83d1137744f044715",
            "filename": "aio/firebase.json",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/3b7d4ebbd6445364889d61b7b1b1c65206534d34/aio%2Ffirebase.json",
            "raw_url": "https://github.com/angular/angular/raw/3b7d4ebbd6445364889d61b7b1b1c65206534d34/aio%2Ffirebase.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ffirebase.json?ref=3b7d4ebbd6445364889d61b7b1b1c65206534d34",
            "patch": "@@ -92,11 +92,12 @@\n       {\"type\": 301, \"source\": \"/**/HTTP_PROVIDERS*\", \"destination\": \"/api/http/HttpModule\"},\n \n       // URLs that use the old scheme of adding the type to the end (e.g. `SomeClass-class`)\n-      {\"type\": 301, \"source\": \"/api/:package/:api-*\", \"destination\": \"/api/:package/:api\"},\n-      {\"type\": 301, \"source\": \"/api/:package/testing/index/:api-*\", \"destination\": \"/api/:package/testing/:api\"},\n-      {\"type\": 301, \"source\": \"/api/:package/testing/:api-*\", \"destination\": \"/api/:package/testing/:api\"},\n-      {\"type\": 301, \"source\": \"/api/upgrade/:package/index/:api-*\", \"destination\": \"/api/upgrade/:package/:api\"},\n-      {\"type\": 301, \"source\": \"/api/upgrade/:package/:api-*\", \"destination\": \"/api/upgrade/:package/:api\"},\n+      // (Exclude disambiguated URLs that might be suffixed with `-\\d+` (e.g. `SomeClass-1`))\n+      {\"type\": 301, \"regex\": \"^/api/(?P<package>[^/]+)/(?P<api>[^/]+)-\\\\D*$\", \"destination\": \"/api/:package/:api\"},\n+      {\"type\": 301, \"regex\": \"^/api/(?P<package>[^/]+)/testing/index/(?P<api>[^/]+)$\", \"destination\": \"/api/:package/testing/:api\"},\n+      {\"type\": 301, \"regex\": \"^/api/(?P<package>[^/]+)/testing/(?P<api>[^/]+)-\\\\D*$\", \"destination\": \"/api/:package/testing/:api\"},\n+      {\"type\": 301, \"regex\": \"^/api/upgrade/(?P<package>[^/]+)/index/(?P<api>[^/]+)$\", \"destination\": \"/api/upgrade/:package/:api\"},\n+      {\"type\": 301, \"regex\": \"^/api/upgrade/(?P<package>[^/]+)/(?P<api>[^/]+)-\\\\D*$\", \"destination\": \"/api/upgrade/:package/:api\"},\n \n       // URLs that use the old scheme before we moved the docs to the angular/angular repo\n       {\"type\": 301, \"source\": \"/docs/*/latest\", \"destination\": \"/docs\"},"
        },
        {
            "sha": "1231b6dece9a681ad73e8047f7df5e2975c1efd3",
            "filename": "aio/ngsw-config.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/3b7d4ebbd6445364889d61b7b1b1c65206534d34/aio%2Fngsw-config.json",
            "raw_url": "https://github.com/angular/angular/raw/3b7d4ebbd6445364889d61b7b1b1c65206534d34/aio%2Fngsw-config.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fngsw-config.json?ref=3b7d4ebbd6445364889d61b7b1b1c65206534d34",
            "patch": "@@ -76,7 +76,7 @@\n     \"!/**/*__*/**\",\n     \"!/**/stackblitz\",\n     \"!/**/stackblitz.html\",\n-    \"!/api/*/**/*-*\",\n+    \"!/api/*/**/*-\\\\D{0,}\",\n     \"!/api/**/AnimationStateDeclarationMetadata*\",\n     \"!/api/**/CORE_DIRECTIVES*\",\n     \"!/api/**/DirectiveMetadata*\","
        },
        {
            "sha": "7623227ae7142e4d109cd2dcdcee139be47effd7",
            "filename": "aio/tests/deployment/unit/testFirebaseRedirection.spec.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/3b7d4ebbd6445364889d61b7b1b1c65206534d34/aio%2Ftests%2Fdeployment%2Funit%2FtestFirebaseRedirection.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3b7d4ebbd6445364889d61b7b1b1c65206534d34/aio%2Ftests%2Fdeployment%2Funit%2FtestFirebaseRedirection.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftests%2Fdeployment%2Funit%2FtestFirebaseRedirection.spec.ts?ref=3b7d4ebbd6445364889d61b7b1b1c65206534d34",
            "patch": "@@ -33,4 +33,20 @@ describe('firebase.json redirect config', () => {\n       });\n     });\n   });\n+\n+  it('should not redirect disambiguated URLs', () => {\n+    const redirector = getRedirector();\n+\n+    // Disambiguated URL.\n+    const url1 = '/api/core/Foo-0';\n+    expect(redirector.redirect(url1)).toBe(url1);\n+\n+    // Disambiguated URL.\n+    const url2 = '/api/core/BAR-1337';\n+    expect(redirector.redirect(url2)).toBe(url2);\n+\n+    // Non-disambiguated URL with dash.\n+    const url3 = '/api/core/baz-class';\n+    expect(redirector.redirect(url3)).toBe('/api/core/baz');\n+  });\n });"
        },
        {
            "sha": "41fc8429ee3c7b7e2a5051de8fb3bf941485eb37",
            "filename": "aio/tests/deployment/unit/testServiceWorkerRoutes.spec.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/3b7d4ebbd6445364889d61b7b1b1c65206534d34/aio%2Ftests%2Fdeployment%2Funit%2FtestServiceWorkerRoutes.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3b7d4ebbd6445364889d61b7b1b1c65206534d34/aio%2Ftests%2Fdeployment%2Funit%2FtestServiceWorkerRoutes.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftests%2Fdeployment%2Funit%2FtestServiceWorkerRoutes.spec.ts?ref=3b7d4ebbd6445364889d61b7b1b1c65206534d34",
            "patch": "@@ -35,4 +35,18 @@ describe('ServiceWorker navigation URLs', () => {\n     navigationUrls.forEach(url => expect(isNavigationUrl(url)).toBeTruthy(url));\n     nonNavigationUrls.forEach(url => expect(isNavigationUrl(url)).toBeFalsy(url));\n   });\n+\n+  it('should treat disambiguated URLs as navigation URLs', () => {\n+    // Disambiguated URL.\n+    const url1 = '/api/core/Foo-0';\n+    expect(isNavigationUrl(url1)).toBeTruthy(url1);\n+\n+    // Disambiguated URL.\n+    const url2 = '/api/core/BAR-1337';\n+    expect(isNavigationUrl(url2)).toBeTruthy(url2);\n+\n+    // Non-disambiguated URL with dash.\n+    const url3 = '/api/core/baz-class';\n+    expect(isNavigationUrl(url3)).toBeFalsy(url3);\n+  });\n });"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 37,
        "deletions": 6
    }
}