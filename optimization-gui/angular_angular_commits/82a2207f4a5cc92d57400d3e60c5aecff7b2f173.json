{
    "author": "devversion",
    "message": "build: filter out duplicate cherry-picked commits in changelog (#37956)\n\nOften changelogs are generated from the patch branch and then\ncherry-picked into the `CHANGELOG.md` file in `master` for\nbetter access and readability. This is problematic though as\n`conventional-changelog` (the tool we use for generating the\nchangelog), will duplicate commits when a future changelog\nis generated from `master` then (i.e. for a new minor release).\n\nThis happens because conventional-changelog always generates the\nchangelog from the latest tag in a given branch to `HEAD`. The\ntag in the patch branch does not correspond to any SHA in `master`\nso the intersection of commits is not automatically omitted.\n\nWe work around this naively (until we have a better tool provided\nby dev-infra), by deduping commits that are already part of the\nchangelog. This has proven to work as expected in the components\nrepo.\n\nPR Close #37956",
    "sha": "82a2207f4a5cc92d57400d3e60c5aecff7b2f173",
    "files": [
        {
            "sha": "0caaf1c0d54c0fd6fbf0dcb75c25930138c02c26",
            "filename": "tools/gulp-tasks/changelog.js",
            "status": "modified",
            "additions": 53,
            "deletions": 6,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/82a2207f4a5cc92d57400d3e60c5aecff7b2f173/tools%2Fgulp-tasks%2Fchangelog.js",
            "raw_url": "https://github.com/angular/angular/raw/82a2207f4a5cc92d57400d3e60c5aecff7b2f173/tools%2Fgulp-tasks%2Fchangelog.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fgulp-tasks%2Fchangelog.js?ref=82a2207f4a5cc92d57400d3e60c5aecff7b2f173",
            "patch": "@@ -6,6 +6,9 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+const {readFileSync} = require('fs');\n+const {bold, yellow} = require('chalk');\n+\n module.exports = (gulp) => () => {\n   const conventionalChangelog = require('gulp-conventional-changelog');\n   const ignoredScopes = [\n@@ -16,11 +19,55 @@ module.exports = (gulp) => () => {\n   ];\n \n   return gulp.src('CHANGELOG.md')\n-      .pipe(conventionalChangelog({preset: 'angular'}, {}, {\n-        // Ignore commits that start with `<type>(<scope>)` for any of the ignored scopes.\n-        extendedRegexp: true,\n-        grep: `^[^(]+\\\\((${ignoredScopes.join('|')})\\\\)`,\n-        invertGrep: true,\n-      }))\n+      .pipe(conventionalChangelog(\n+          /* core options */ {preset: 'angular'},\n+          /* context options */ {},\n+          /* raw-commit options */ {\n+            // Ignore commits that start with `<type>(<scope>)` for any of the ignored scopes.\n+            extendedRegexp: true,\n+            grep: `^[^(]+\\\\((${ignoredScopes.join('|')})\\\\)`,\n+            invertGrep: true,\n+          },\n+          /* commit parser options */ null,\n+          /* writer options*/ createDedupeWriterOptions()))\n       .pipe(gulp.dest('./'));\n };\n+\n+/**\n+ * Creates changelog writer options which ensure that commits are not showing up multiple times.\n+ * Commits can show up multiple times if a changelog has been generated on a publish branch\n+ * and has been cherry-picked into \"master\". In that case, the changelog will already contain\n+ * commits from master which might be added to the changelog again. This is because usually\n+ * patch and minor releases are tagged from the publish branches and therefore\n+ * conventional-changelog tries to build the changelog from last minor version to HEAD when a\n+ * new minor version is being published from the \"master\" branch. We naively match commit\n+ * headers as otherwise we would need to query Git and diff commits between a given patch branch.\n+ * The commit header is reliable enough as it contains a direct reference to the source PR.\n+ */\n+function createDedupeWriterOptions() {\n+  const existingChangelogContent = readFileSync('CHANGELOG.md', 'utf8');\n+\n+  return {\n+    // Specify a writer option that can be used to modify the content of a new changelog section.\n+    // See: conventional-changelog/tree/master/packages/conventional-changelog-writer\n+    finalizeContext: (context) => {\n+      context.commitGroups = context.commitGroups.filter((group) => {\n+        group.commits = group.commits.filter((commit) => {\n+          // NOTE: We cannot compare the SHAs because the commits will have a different SHA\n+          // if they are being cherry-picked into a different branch.\n+          if (existingChangelogContent.includes(commit.subject)) {\n+            console.info(yellow(`  â†º   Skipping duplicate: \"${bold(commit.header)}\"`));\n+            return false;\n+          }\n+          return true;\n+        });\n+\n+        // Filter out commit groups which don't have any commits. Commit groups will become\n+        // empty if we filter out all duplicated commits.\n+        return group.commits.length !== 0;\n+      });\n+\n+      return context;\n+    }\n+  };\n+}"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 53,
        "deletions": 6
    }
}