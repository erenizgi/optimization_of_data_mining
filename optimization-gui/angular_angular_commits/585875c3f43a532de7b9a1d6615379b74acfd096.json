{
    "author": "mhevery",
    "message": "refactor(core): Cleanup circular dependency between ViewEngine and Ivy `Renderer2`. (#39621)\n\n`Renderer2` is declared in ViewEngine but it sub-classed in Ivy. This creates a circular\ndependency between ViewEngine `Renderer2` which needs to declare `__NG_ELEMENT_ID__` and\nivy factory which needs to create it. The workaround used to be to pass the `Renderer2`\nthrough stack but that created a very convoluted code. This refactoring simply bundles the\ntwo files together and removes the stack workaround making the code simpler to follow.\n\nPR Close #39621",
    "sha": "585875c3f43a532de7b9a1d6615379b74acfd096",
    "files": [
        {
            "sha": "54ddcdca4fb95f39f431c63d3326b2c0b8b59eb9",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 0,
            "deletions": 25,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/585875c3f43a532de7b9a1d6615379b74acfd096/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/585875c3f43a532de7b9a1d6615379b74acfd096/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=585875c3f43a532de7b9a1d6615379b74acfd096",
            "patch": "@@ -149,7 +149,6 @@\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\",\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/linker/view_ref.ts\"\n@@ -163,7 +162,6 @@\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\",\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n@@ -181,7 +179,6 @@\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\",\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n@@ -206,7 +203,6 @@\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\",\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n@@ -233,7 +229,6 @@\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\",\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/state.ts\",\n     \"packages/core/src/render3/assert.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -883,7 +878,6 @@\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\",\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/linker/view_ref.ts\"\n@@ -995,31 +989,23 @@\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\"\n-  ],\n-  [\n-    \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n@@ -1029,7 +1015,6 @@\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n@@ -1038,7 +1023,6 @@\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n@@ -1048,28 +1032,24 @@\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/state.ts\",\n     \"packages/core/src/render3/assert.ts\",\n     \"packages/core/src/render3/interfaces/injector.ts\",\n@@ -1078,38 +1058,33 @@\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/state.ts\",\n     \"packages/core/src/render3/assert.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/state.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/state.ts\",\n     \"packages/core/src/render3/util/view_utils.ts\",\n     \"packages/core/src/render3/interfaces/context.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/state.ts\",\n     \"packages/core/src/render3/util/view_utils.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n     \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/state.ts\",\n     \"packages/core/src/render3/util/view_utils.ts\",\n     \"packages/core/src/render3/interfaces/renderer.ts\""
        },
        {
            "sha": "7fee2951ca395f118f252113f202cd2209d20a7e",
            "filename": "packages/core/src/render/api.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 3,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/585875c3f43a532de7b9a1d6615379b74acfd096/packages%2Fcore%2Fsrc%2Frender%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/585875c3f43a532de7b9a1d6615379b74acfd096/packages%2Fcore%2Fsrc%2Frender%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender%2Fapi.ts?ref=585875c3f43a532de7b9a1d6615379b74acfd096",
            "patch": "@@ -8,7 +8,11 @@\n \n import {InjectionToken} from '../di/injection_token';\n import {ViewEncapsulation} from '../metadata/view';\n-import {injectRenderer2 as render3InjectRenderer2} from '../render3/view_engine_compatibility';\n+import {isProceduralRenderer} from '../render3/interfaces/renderer';\n+import {isLView} from '../render3/interfaces/type_checks';\n+import {LView, RENDERER} from '../render3/interfaces/view';\n+import {getCurrentTNode, getLView} from '../render3/state';\n+import {getComponentLViewByIndex} from '../render3/util/view_utils';\n import {noop} from '../util/noop';\n \n \n@@ -286,6 +290,25 @@ export abstract class Renderer2 {\n }\n \n \n-export const SWITCH_RENDERER2_FACTORY__POST_R3__ = render3InjectRenderer2;\n+export const SWITCH_RENDERER2_FACTORY__POST_R3__ = injectRenderer2;\n const SWITCH_RENDERER2_FACTORY__PRE_R3__ = noop;\n-const SWITCH_RENDERER2_FACTORY: typeof render3InjectRenderer2 = SWITCH_RENDERER2_FACTORY__PRE_R3__;\n+const SWITCH_RENDERER2_FACTORY: typeof injectRenderer2 = SWITCH_RENDERER2_FACTORY__PRE_R3__;\n+\n+/** Returns a Renderer2 (or throws when application was bootstrapped with Renderer3) */\n+function getOrCreateRenderer2(lView: LView): Renderer2 {\n+  const renderer = lView[RENDERER];\n+  if (ngDevMode && !isProceduralRenderer(renderer)) {\n+    throw new Error('Cannot inject Renderer2 when the application uses Renderer3!');\n+  }\n+  return renderer as Renderer2;\n+}\n+\n+/** Injects a Renderer2 for the current component. */\n+export function injectRenderer2(): Renderer2 {\n+  // We need the Renderer to be based on the component that it's being injected into, however since\n+  // DI happens before we've entered its view, `getLView` will return the parent view instead.\n+  const lView = getLView();\n+  const tNode = getCurrentTNode()!;\n+  const nodeAtIndex = getComponentLViewByIndex(tNode.index, lView);\n+  return getOrCreateRenderer2(isLView(nodeAtIndex) ? nodeAtIndex : lView);\n+}"
        },
        {
            "sha": "8d5d8cc4147a61229c62383c3a0340d1ec9600c8",
            "filename": "packages/core/src/render3/view_engine_compatibility.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 36,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/24b57d8b41548d524036fc0dc12cec746c4d9342/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "raw_url": "https://github.com/angular/angular/raw/24b57d8b41548d524036fc0dc12cec746c4d9342/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts?ref=24b57d8b41548d524036fc0dc12cec746c4d9342",
            "patch": "@@ -1,36 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import {Renderer2} from '../render/api';\n-import {isProceduralRenderer} from './interfaces/renderer';\n-import {isLView} from './interfaces/type_checks';\n-import {LView, RENDERER} from './interfaces/view';\n-import {getCurrentTNode, getLView} from './state';\n-import {getComponentLViewByIndex} from './util/view_utils';\n-\n-\n-\n-/** Returns a Renderer2 (or throws when application was bootstrapped with Renderer3) */\n-function getOrCreateRenderer2(view: LView): Renderer2 {\n-  const renderer = view[RENDERER];\n-  if (isProceduralRenderer(renderer)) {\n-    return renderer as Renderer2;\n-  } else {\n-    throw new Error('Cannot inject Renderer2 when the application uses Renderer3!');\n-  }\n-}\n-\n-/** Injects a Renderer2 for the current component. */\n-export function injectRenderer2(): Renderer2 {\n-  // We need the Renderer to be based on the component that it's being injected into, however since\n-  // DI happens before we've entered its view, `getLView` will return the parent view instead.\n-  const lView = getLView();\n-  const tNode = getCurrentTNode()!;\n-  const nodeAtIndex = getComponentLViewByIndex(tNode.index, lView);\n-  return getOrCreateRenderer2(isLView(nodeAtIndex) ? nodeAtIndex : lView);\n-}"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 26,
        "deletions": 64
    }
}