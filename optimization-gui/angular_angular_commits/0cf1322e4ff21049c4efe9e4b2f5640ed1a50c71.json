{
    "author": "dgp1130",
    "message": "refactor(compiler-cli): use configured diagnostic category when emitting warnings from extended template diagnostics (#44391)\n\nRefs #42966.\n\nThis updates `TemplateContext` to include a new `makeTemplateDiagnostic()` function which automatically uses the correct diagnostic category for that check. This makes sure that each diagnostic is emitted with the correct category. It also implicitly passes some known values like `component` and `code` to make the extended template diagnostics a little simpler. Diagnostics which are suppressed are never instantiated at all, which acts as a slight performance optimization since any emitted diagnostics would be ignored anyways.\n\nUnfortunately, diagnostics still have access to `ctx.templateTypeChecker.makeTemplateDiagnostic()` to manually create diagnostics with a different category. Both banana in box and nullish coalescing checks include tests to make sure they respect a manually configured category. This convention should hopefully give a reasonable certainty that new diagnostics will use the correct reporting function, even if that is not strictly enforced.\n\nPR Close #44391",
    "sha": "0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
    "files": [
        {
            "sha": "8323abb4b03064ba2cfd47fd2e88d3566f870e1e",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2FBUILD.bazel?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -7,6 +7,7 @@ ts_library(\n     ),\n     visibility = [\"//packages/compiler-cli/src/ngtsc:__subpackages__\"],\n     deps = [\n+        \"//packages/compiler\",\n         \"//packages/compiler-cli/src/ngtsc/core:api\",\n         \"//packages/compiler-cli/src/ngtsc/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\","
        },
        {
            "sha": "b34cdb6058fedad550e0ead17105144cf9f7035f",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/api/api.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 18,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fapi%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fapi%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fapi%2Fapi.ts?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, ASTWithSource, RecursiveAstVisitor, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstContent, TmplAstElement, TmplAstIcu, TmplAstNode, TmplAstRecursiveVisitor, TmplAstReference, TmplAstTemplate, TmplAstText, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n+import {AST, ASTWithSource, ParseSourceSpan, RecursiveAstVisitor, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstContent, TmplAstElement, TmplAstIcu, TmplAstNode, TmplAstRecursiveVisitor, TmplAstReference, TmplAstTemplate, TmplAstText, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n import ts from 'typescript';\n \n import {NgCompilerOptions} from '../../../core/api';\n@@ -17,19 +17,19 @@ import {NgTemplateDiagnostic, TemplateTypeChecker} from '../../api';\n  * A Template Check receives information about the template it's checking and returns\n  * information about the diagnostics to be generated.\n  */\n-export interface TemplateCheck<T extends ErrorCode> {\n+export interface TemplateCheck<Code extends ErrorCode> {\n   /** Unique template check code, used for configuration and searching the error. */\n-  code: T;\n+  code: Code;\n \n   /** Runs check and returns information about the diagnostics to be generated. */\n-  run(ctx: TemplateContext, component: ts.ClassDeclaration,\n-      template: TmplAstNode[]): NgTemplateDiagnostic<T>[];\n+  run(ctx: TemplateContext<Code>, component: ts.ClassDeclaration,\n+      template: TmplAstNode[]): NgTemplateDiagnostic<Code>[];\n }\n \n /**\n  * The TemplateContext provided to a Template Check to get diagnostic information.\n  */\n-export interface TemplateContext {\n+export interface TemplateContext<Code extends ErrorCode> {\n   /** Interface that provides information about template nodes. */\n   templateTypeChecker: TemplateTypeChecker;\n \n@@ -38,6 +38,17 @@ export interface TemplateContext {\n    * in the template (it is not to query types outside the Angular component).\n    */\n   typeChecker: ts.TypeChecker;\n+\n+  /**\n+   * Creates a template diagnostic with the given information for the template being processed and\n+   * using the diagnostic category configured for the extended template diagnostic.\n+   */\n+  makeTemplateDiagnostic(sourceSpan: ParseSourceSpan, message: string, relatedInformation?: {\n+    text: string,\n+    start: number,\n+    end: number,\n+    sourceFile: ts.SourceFile,\n+  }[]): NgTemplateDiagnostic<Code>;\n }\n \n /**\n@@ -56,37 +67,39 @@ export interface TemplateCheckFactory<\n /**\n  * This abstract class provides a base implementation for the run method.\n  */\n-export abstract class TemplateCheckWithVisitor<T extends ErrorCode> implements TemplateCheck<T> {\n-  abstract code: T;\n+export abstract class TemplateCheckWithVisitor<Code extends ErrorCode> implements\n+    TemplateCheck<Code> {\n+  abstract code: Code;\n \n   /**\n    * Base implementation for run function, visits all nodes in template and calls\n    * `visitNode()` for each one.\n    */\n-  run(ctx: TemplateContext, component: ts.ClassDeclaration,\n-      template: TmplAstNode[]): NgTemplateDiagnostic<T>[] {\n-    const visitor = new TemplateVisitor<T>(ctx, component, this);\n+  run(ctx: TemplateContext<Code>, component: ts.ClassDeclaration,\n+      template: TmplAstNode[]): NgTemplateDiagnostic<Code>[] {\n+    const visitor = new TemplateVisitor<Code>(ctx, component, this);\n     return visitor.getDiagnostics(template);\n   }\n \n   /**\n    * Visit a TmplAstNode or AST node of the template. Authors should override this\n    * method to implement the check and return diagnostics.\n    */\n-  abstract visitNode(ctx: TemplateContext, component: ts.ClassDeclaration, node: TmplAstNode|AST):\n-      NgTemplateDiagnostic<T>[];\n+  abstract visitNode(\n+      ctx: TemplateContext<Code>, component: ts.ClassDeclaration,\n+      node: TmplAstNode|AST): NgTemplateDiagnostic<Code>[];\n }\n \n /**\n  * Visits all nodes in a template (TmplAstNode and AST) and calls `visitNode` for each one.\n  */\n-class TemplateVisitor<T extends ErrorCode> extends RecursiveAstVisitor implements\n+class TemplateVisitor<Code extends ErrorCode> extends RecursiveAstVisitor implements\n     TmplAstRecursiveVisitor {\n-  diagnostics: NgTemplateDiagnostic<T>[] = [];\n+  diagnostics: NgTemplateDiagnostic<Code>[] = [];\n \n   constructor(\n-      private readonly ctx: TemplateContext, private readonly component: ts.ClassDeclaration,\n-      private readonly check: TemplateCheckWithVisitor<T>) {\n+      private readonly ctx: TemplateContext<Code>, private readonly component: ts.ClassDeclaration,\n+      private readonly check: TemplateCheckWithVisitor<Code>) {\n     super();\n   }\n \n@@ -146,7 +159,7 @@ class TemplateVisitor<T extends ErrorCode> extends RecursiveAstVisitor implement\n   }\n   visitIcu(icu: TmplAstIcu): void {}\n \n-  getDiagnostics(template: TmplAstNode[]): NgTemplateDiagnostic<T>[] {\n+  getDiagnostics(template: TmplAstNode[]): NgTemplateDiagnostic<Code>[] {\n     this.diagnostics = [];\n     this.visitAllNodes(template);\n     return this.diagnostics;"
        },
        {
            "sha": "aee972012afc327907344f56f305f742e8af60fb",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/checks/invalid_banana_in_box/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Finvalid_banana_in_box%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Finvalid_banana_in_box%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Finvalid_banana_in_box%2Findex.ts?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -21,17 +21,20 @@ import {TemplateCheckFactory, TemplateCheckWithVisitor, TemplateContext} from '.\n class InvalidBananaInBoxCheck extends TemplateCheckWithVisitor<ErrorCode.INVALID_BANANA_IN_BOX> {\n   override code = ErrorCode.INVALID_BANANA_IN_BOX as const;\n \n-  override visitNode(ctx: TemplateContext, component: ts.ClassDeclaration, node: TmplAstNode|AST):\n-      NgTemplateDiagnostic<ErrorCode.INVALID_BANANA_IN_BOX>[] {\n+  override visitNode(\n+      ctx: TemplateContext<ErrorCode.INVALID_BANANA_IN_BOX>,\n+      component: ts.ClassDeclaration,\n+      node: TmplAstNode|AST,\n+      ): NgTemplateDiagnostic<ErrorCode.INVALID_BANANA_IN_BOX>[] {\n     if (!(node instanceof TmplAstBoundEvent)) return [];\n \n     const name = node.name;\n     if (!name.startsWith('[') || !name.endsWith(']')) return [];\n \n     const boundSyntax = node.sourceSpan.toString();\n     const expectedBoundSyntax = boundSyntax.replace(`(${name})`, `[(${name.slice(1, -1)})]`);\n-    const diagnostic = ctx.templateTypeChecker.makeTemplateDiagnostic(\n-        component, node.sourceSpan, ts.DiagnosticCategory.Warning, ErrorCode.INVALID_BANANA_IN_BOX,\n+    const diagnostic = ctx.makeTemplateDiagnostic(\n+        node.sourceSpan,\n         `In the two-way binding syntax the parentheses should be inside the brackets, ex. '${\n             expectedBoundSyntax}'.\n         Find more at https://angular.io/guide/two-way-binding`);"
        },
        {
            "sha": "eaa0914d15f2da3598c4edb9525305df1e609f1a",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/checks/nullish_coalescing_not_nullable/index.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2Findex.ts?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -24,8 +24,10 @@ class NullishCoalescingNotNullableCheck extends\n     TemplateCheckWithVisitor<ErrorCode.NULLISH_COALESCING_NOT_NULLABLE> {\n   override code = ErrorCode.NULLISH_COALESCING_NOT_NULLABLE as const;\n \n-  override visitNode(ctx: TemplateContext, component: ts.ClassDeclaration, node: TmplAstNode|AST):\n-      NgTemplateDiagnostic<ErrorCode.NULLISH_COALESCING_NOT_NULLABLE>[] {\n+  override visitNode(\n+      ctx: TemplateContext<ErrorCode.NULLISH_COALESCING_NOT_NULLABLE>,\n+      component: ts.ClassDeclaration,\n+      node: TmplAstNode|AST): NgTemplateDiagnostic<ErrorCode.NULLISH_COALESCING_NOT_NULLABLE>[] {\n     if (!(node instanceof Binary) || node.operation !== '??') return [];\n \n     const symbolLeft = ctx.templateTypeChecker.getSymbolOfNode(node.left, component);\n@@ -44,8 +46,8 @@ class NullishCoalescingNotNullableCheck extends\n     }\n     const span =\n         ctx.templateTypeChecker.getTemplateMappingAtShimLocation(symbol.shimLocation)!.span;\n-    const diagnostic = ctx.templateTypeChecker.makeTemplateDiagnostic(\n-        component, span, ts.DiagnosticCategory.Warning, ErrorCode.NULLISH_COALESCING_NOT_NULLABLE,\n+    const diagnostic = ctx.makeTemplateDiagnostic(\n+        span,\n         `The left side of this nullish coalescing operation does not include 'null' or 'undefined' in its type, therefore the '??' operator can be safely removed.`);\n     return [diagnostic];\n   }"
        },
        {
            "sha": "146e149c344f8c2334705fc8f812ae726138884d",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/src/extended_template_checker.ts",
            "status": "modified",
            "additions": 70,
            "deletions": 11,
            "changes": 81,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -6,30 +6,53 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {ParseSourceSpan} from '@angular/compiler';\n import ts from 'typescript';\n \n-import {NgCompilerOptions} from '../../../core/api';\n+import {DiagnosticCategoryLabel, NgCompilerOptions} from '../../../core/api';\n import {ErrorCode, ExtendedTemplateDiagnosticName} from '../../../diagnostics';\n-import {TemplateDiagnostic, TemplateTypeChecker} from '../../api';\n+import {NgTemplateDiagnostic, TemplateDiagnostic, TemplateTypeChecker} from '../../api';\n import {ExtendedTemplateChecker, TemplateCheck, TemplateCheckFactory, TemplateContext} from '../api';\n \n export class ExtendedTemplateCheckerImpl implements ExtendedTemplateChecker {\n-  private readonly ctx: TemplateContext;\n-  private readonly templateChecks: TemplateCheck<ErrorCode>[];\n+  private readonly partialCtx: Omit<TemplateContext<ErrorCode>, 'makeTemplateDiagnostic'>;\n+  private readonly templateChecks: Map<TemplateCheck<ErrorCode>, ts.DiagnosticCategory>;\n \n   constructor(\n       templateTypeChecker: TemplateTypeChecker, typeChecker: ts.TypeChecker,\n       templateCheckFactories:\n           readonly TemplateCheckFactory<ErrorCode, ExtendedTemplateDiagnosticName>[],\n       options: NgCompilerOptions) {\n-    this.ctx = {templateTypeChecker: templateTypeChecker, typeChecker: typeChecker} as\n-        TemplateContext;\n-    this.templateChecks = templateCheckFactories.map((factory) => factory.create(options))\n-                              .filter((check): check is TemplateCheck<ErrorCode> => check !== null);\n+    this.partialCtx = {templateTypeChecker, typeChecker};\n+    this.templateChecks = new Map<TemplateCheck<ErrorCode>, ts.DiagnosticCategory>();\n+\n+    for (const factory of templateCheckFactories) {\n+      // Read the diagnostic category from compiler options.\n+      const category = diagnosticLabelToCategory(\n+          options?.extendedDiagnostics?.checks?.[factory.name] ?? DiagnosticCategoryLabel.Warning);\n+\n+      // Skip the diagnostic if suppressed via compiler options.\n+      if (category === null) {\n+        continue;\n+      }\n+\n+      // Try to create the check.\n+      const check = factory.create(options);\n+\n+      // Skip the diagnostic if it was disabled due to unsupported options. For example, this can\n+      // happen if the check requires `strictNullChecks: true` but that flag is disabled in compiler\n+      // options.\n+      if (check === null) {\n+        continue;\n+      }\n+\n+      // Use the check.\n+      this.templateChecks.set(check, category);\n+    }\n   }\n \n   getDiagnosticsForComponent(component: ts.ClassDeclaration): TemplateDiagnostic[] {\n-    const template = this.ctx.templateTypeChecker.getTemplate(component);\n+    const template = this.partialCtx.templateTypeChecker.getTemplate(component);\n     // Skip checks if component has no template. This can happen if the user writes a\n     // `@Component()` but doesn't add the template, could happen in the language service\n     // when users are in the middle of typing code.\n@@ -38,10 +61,46 @@ export class ExtendedTemplateCheckerImpl implements ExtendedTemplateChecker {\n     }\n     const diagnostics: TemplateDiagnostic[] = [];\n \n-    for (const check of this.templateChecks) {\n-      diagnostics.push(...check.run(this.ctx, component, template));\n+    for (const [check, category] of this.templateChecks.entries()) {\n+      const ctx: TemplateContext<ErrorCode> = {\n+        ...this.partialCtx,\n+        // Wrap `templateTypeChecker.makeTemplateDiagnostic()` to implicitly provide all the known\n+        // options.\n+        makeTemplateDiagnostic: (span: ParseSourceSpan, message: string, relatedInformation?: {\n+          text: string,\n+          start: number,\n+          end: number,\n+          sourceFile: ts.SourceFile,\n+        }[]): NgTemplateDiagnostic<ErrorCode> => {\n+          return this.partialCtx.templateTypeChecker.makeTemplateDiagnostic(\n+              component, span, category, check.code, message, relatedInformation);\n+        },\n+      };\n+\n+      diagnostics.push(...check.run(ctx, component, template));\n     }\n \n     return diagnostics;\n   }\n }\n+\n+/**\n+ * Converts a `DiagnosticCategoryLabel` to its equivalent `ts.DiagnosticCategory` or `undefined` if\n+ * the label is `DiagnosticCategoryLabel.Suppress`.\n+ */\n+function diagnosticLabelToCategory(label: DiagnosticCategoryLabel): ts.DiagnosticCategory|null {\n+  switch (label) {\n+    case DiagnosticCategoryLabel.Warning:\n+      return ts.DiagnosticCategory.Warning;\n+    case DiagnosticCategoryLabel.Error:\n+      return ts.DiagnosticCategory.Error;\n+    case DiagnosticCategoryLabel.Suppress:\n+      return null;\n+    default:\n+      return assertNever(label);\n+  }\n+}\n+\n+function assertNever(value: never): never {\n+  throw new Error(`Unexpected call to 'assertNever()' with value:\\n${value}`);\n+}"
        },
        {
            "sha": "7aabd8f431017d2e4361338c46f91633fd4ccfe7",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/test/checks/invalid_banana_in_box/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Finvalid_banana_in_box%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Finvalid_banana_in_box%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Finvalid_banana_in_box%2FBUILD.bazel?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -6,6 +6,7 @@ ts_library(\n     srcs = [\"invalid_banana_in_box_spec.ts\"],\n     deps = [\n         \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/core:api\",\n         \"//packages/compiler-cli/src/ngtsc/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/file_system/testing\","
        },
        {
            "sha": "e13c033f44dbced83e4c53aa37aaf2bfbeacf7a6",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/test/checks/invalid_banana_in_box/invalid_banana_in_box_spec.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Finvalid_banana_in_box%2Finvalid_banana_in_box_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Finvalid_banana_in_box%2Finvalid_banana_in_box_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Finvalid_banana_in_box%2Finvalid_banana_in_box_spec.ts?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -8,6 +8,7 @@\n \n import ts from 'typescript';\n \n+import {DiagnosticCategoryLabel} from '../../../../../core/api';\n import {ErrorCode, ExtendedTemplateDiagnosticName, ngErrorCode} from '../../../../../diagnostics';\n import {absoluteFrom, getSourceFileOrError} from '../../../../../file_system';\n import {runInEachFileSystem} from '../../../../../file_system/testing';\n@@ -110,5 +111,27 @@ runInEachFileSystem(() => {\n       expect(diags[1].code).toBe(ngErrorCode(ErrorCode.INVALID_BANANA_IN_BOX));\n       expect(getSourceCodeForDiagnostic(diags[1])).toBe('([notARealThing2])=\"var1\"');\n     });\n+\n+    it('should respect configured category', () => {\n+      const fileName = absoluteFrom('/main.ts');\n+      const {program, templateTypeChecker} = setup([{\n+        fileName,\n+        templates: {\n+          'TestCmp': '<div ([notARealThing])=\"var1\"> </div>',\n+        },\n+        source: 'export class TestCmp { var1: string = \"text\"; }'\n+      }]);\n+      const sf = getSourceFileOrError(program, fileName);\n+      const component = getClass(sf, 'TestCmp');\n+\n+      const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+          templateTypeChecker, program.getTypeChecker(), [invalidBananaInBoxFactory],\n+          {extendedDiagnostics: {checks: {invalidBananaInBox: DiagnosticCategoryLabel.Error}}});\n+      const diags = extendedTemplateChecker.getDiagnosticsForComponent(component);\n+\n+      expect(diags.length).toBe(1);\n+      expect(diags[0].category).toBe(ts.DiagnosticCategory.Error);\n+      expect(diags[0].code).toBe(ngErrorCode(ErrorCode.INVALID_BANANA_IN_BOX));\n+    });\n   });\n });"
        },
        {
            "sha": "df54421facfecaed82f1781d45b704e693677efb",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/test/checks/nullish_coalescing_not_nullable/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2FBUILD.bazel?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -6,6 +6,7 @@ ts_library(\n     srcs = [\"nullish_coalescing_not_nullable_spec.ts\"],\n     deps = [\n         \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/core:api\",\n         \"//packages/compiler-cli/src/ngtsc/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/file_system/testing\","
        },
        {
            "sha": "e79a8f72cc77f566ffdfc99cc8f2276bbc0efc8f",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/test/checks/nullish_coalescing_not_nullable/nullish_coalescing_not_nullable_spec.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2Fnullish_coalescing_not_nullable_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2Fnullish_coalescing_not_nullable_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2Fnullish_coalescing_not_nullable_spec.ts?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {DiagnosticCategoryLabel} from '@angular/compiler-cli/src/ngtsc/core/api';\n import ts from 'typescript';\n \n import {ErrorCode, ExtendedTemplateDiagnosticName, ngErrorCode} from '../../../../../diagnostics';\n@@ -177,5 +178,36 @@ runInEachFileSystem(() => {\n          const diags = extendedTemplateChecker.getDiagnosticsForComponent(component);\n          expect(diags.length).toBe(0);\n        });\n+\n+    it('should respect configured diagnostic category', () => {\n+      const fileName = absoluteFrom('/main.ts');\n+      const {program, templateTypeChecker} = setup([{\n+        fileName,\n+        templates: {\n+          'TestCmp': `{{ var1 ?? 'foo' }}`,\n+        },\n+        source: 'export class TestCmp { var1: string = \"text\"; }'\n+      }]);\n+      const sf = getSourceFileOrError(program, fileName);\n+      const component = getClass(sf, 'TestCmp');\n+\n+      const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+          templateTypeChecker,\n+          program.getTypeChecker(),\n+          [nullishCoalescingNotNullableFactory],\n+          {\n+            extendedDiagnostics: {\n+              checks: {\n+                nullishCoalescingNotNullable: DiagnosticCategoryLabel.Error,\n+              },\n+            },\n+          },\n+      );\n+      const diags = extendedTemplateChecker.getDiagnosticsForComponent(component);\n+\n+      expect(diags.length).toBe(1);\n+      expect(diags[0].category).toBe(ts.DiagnosticCategory.Error);\n+      expect(diags[0].code).toBe(ngErrorCode(ErrorCode.NULLISH_COALESCING_NOT_NULLABLE));\n+    });\n   });\n });"
        },
        {
            "sha": "25215c3d2fd0bae72cf90ae5dcf8a91e8d2d386b",
            "filename": "packages/compiler-cli/test/ngtsc/env.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -22,6 +22,12 @@ import {DeclarationNode} from '../../src/ngtsc/reflection';\n import {NgtscTestCompilerHost} from '../../src/ngtsc/testing';\n import {setWrapHostForTest} from '../../src/transformers/compiler_host';\n \n+type TsConfigOptionsValue =\n+    string|boolean|number|null|TsConfigOptionsValue[]|{[key: string]: TsConfigOptionsValue};\n+type TsConfigOptions = {\n+  [key: string]: TsConfigOptionsValue;\n+};\n+\n /**\n  * Manages a temporary testing directory structure and environment for testing ngtsc by feeding it\n  * TypeScript code.\n@@ -185,9 +191,7 @@ export class NgtscTestEnvironment {\n     }\n   }\n \n-  tsconfig(\n-      extraOpts: {[key: string]: string|boolean|null} = {}, extraRootDirs?: string[],\n-      files?: string[]): void {\n+  tsconfig(extraOpts: TsConfigOptions = {}, extraRootDirs?: string[], files?: string[]): void {\n     const tsconfig: {[key: string]: any} = {\n       extends: './tsconfig-base.json',\n       angularCompilerOptions: {...extraOpts, enableIvy: true},"
        },
        {
            "sha": "6b57a9d22c58d545301c3112491211fba0eec4f4",
            "filename": "packages/compiler-cli/test/ngtsc/extended_template_diagnostics_spec.ts",
            "status": "modified",
            "additions": 92,
            "deletions": 0,
            "changes": 92,
            "blob_url": "https://github.com/angular/angular/blob/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fextended_template_diagnostics_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fextended_template_diagnostics_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fextended_template_diagnostics_spec.ts?ref=0cf1322e4ff21049c4efe9e4b2f5640ed1a50c71",
            "patch": "@@ -123,5 +123,97 @@ runInEachFileSystem(() => {\n       expect(diags[0].code).toBe(ngErrorCode(ErrorCode.NULLISH_COALESCING_NOT_NULLABLE));\n       expect(getSourceCodeForDiagnostic(diags[0])).toBe('bar ?? \"foo\"');\n     });\n+\n+    describe('handles diagnostic configuration', () => {\n+      // Component definition which emits one warning.\n+      const warningComponent = `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          selector: 'test-component',\n+          // Invalid banana in box (should be \\`[(foo)]=\"bar\"\\`).\n+          template: '<div ([foo])=\"bar\"></div>',\n+        })\n+        class TestComponent {\n+          bar = 'test';\n+        }\n+      `;\n+\n+      it('by emitting unconfigured diagnostics as is', () => {\n+        env.tsconfig({\n+          strictTemplates: true,\n+          _extendedTemplateDiagnostics: true,\n+          extendedDiagnostics: {},  // No configured diagnostics.\n+        });\n+\n+        env.write('test.ts', warningComponent);\n+\n+        const diagnostics = env.driveDiagnostics(0 /* expectedExitCode */);\n+        expect(diagnostics.length).toBe(1);\n+        expect(diagnostics[0]).toEqual(jasmine.objectContaining({\n+          code: ngErrorCode(ErrorCode.INVALID_BANANA_IN_BOX),\n+          category: ts.DiagnosticCategory.Warning,\n+        }));\n+      });\n+\n+      it('by emitting diagnostics configured as `warning`', () => {\n+        env.tsconfig({\n+          strictTemplates: true,\n+          _extendedTemplateDiagnostics: true,\n+          extendedDiagnostics: {\n+            checks: {\n+              invalidBananaInBox: 'warning',\n+            },\n+          },\n+        });\n+\n+        env.write('test.ts', warningComponent);\n+\n+        const diagnostics = env.driveDiagnostics(0 /* expectedExitCode */);\n+        expect(diagnostics.length).toBe(1);\n+        expect(diagnostics[0]).toEqual(jasmine.objectContaining({\n+          code: ngErrorCode(ErrorCode.INVALID_BANANA_IN_BOX),\n+          category: ts.DiagnosticCategory.Warning,\n+        }));\n+      });\n+\n+      it('by promoting diagnostics configured as `error`', () => {\n+        env.tsconfig({\n+          strictTemplates: true,\n+          _extendedTemplateDiagnostics: true,\n+          extendedDiagnostics: {\n+            checks: {\n+              invalidBananaInBox: 'error',\n+            },\n+          },\n+        });\n+\n+        env.write('test.ts', warningComponent);\n+\n+        const diagnostics = env.driveDiagnostics(1 /* expectedExitCode */);\n+        expect(diagnostics.length).toBe(1);\n+        expect(diagnostics[0]).toEqual(jasmine.objectContaining({\n+          code: ngErrorCode(ErrorCode.INVALID_BANANA_IN_BOX),\n+          category: ts.DiagnosticCategory.Error,\n+        }));\n+      });\n+\n+      it('by suppressing diagnostics configured as `suppress`', () => {\n+        env.tsconfig({\n+          strictTemplates: true,\n+          _extendedTemplateDiagnostics: true,\n+          extendedDiagnostics: {\n+            checks: {\n+              invalidBananaInBox: 'suppress',\n+            },\n+          },\n+        });\n+\n+        env.write('test.ts', warningComponent);\n+\n+        const diagnostics = env.driveDiagnostics(0 /* expectedExitCode */);\n+        expect(diagnostics).toEqual([]);\n+      });\n+    });\n   });\n });"
        }
    ],
    "stats": {
        "total": 311,
        "additions": 271,
        "deletions": 40
    }
}