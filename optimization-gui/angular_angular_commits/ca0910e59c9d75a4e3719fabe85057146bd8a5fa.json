{
    "author": "AleksanderBodurri",
    "message": "perf(devtools): prevent directive forest from building twice every time a node is selected in the directive explorer",
    "sha": "ca0910e59c9d75a4e3719fabe85057146bd8a5fa",
    "files": [
        {
            "sha": "600785f3ee76da53dd93281331fe74c0c354d5e4",
            "filename": "projects/ng-devtools-backend/src/lib/client-event-subscribers.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/ca0910e59c9d75a4e3719fabe85057146bd8a5fa/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts",
            "raw_url": "https://github.com/angular/angular/raw/ca0910e59c9d75a4e3719fabe85057146bd8a5fa/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts?ref=ca0910e59c9d75a4e3719fabe85057146bd8a5fa",
            "patch": "@@ -71,19 +71,21 @@ const getLatestComponentExplorerViewCallback = (messageBus: MessageBus<Events>)\n ) => {\n   // We want to force re-indexing of the component tree.\n   // Pressing the refresh button means the user saw stuck UI.\n+\n   initializeOrGetDirectiveForestHooks().indexForest();\n+\n   if (!query) {\n     messageBus.emit('latestComponentExplorerView', [\n       {\n-        forest: prepareForestForSerialization(initializeOrGetDirectiveForestHooks().getDirectiveForest()),\n+        forest: prepareForestForSerialization(initializeOrGetDirectiveForestHooks().getIndexedDirectiveForest()),\n       },\n     ]);\n     return;\n   }\n   messageBus.emit('latestComponentExplorerView', [\n     {\n-      forest: prepareForestForSerialization(initializeOrGetDirectiveForestHooks().getDirectiveForest()),\n-      properties: getLatestComponentState(query),\n+      forest: prepareForestForSerialization(initializeOrGetDirectiveForestHooks().getIndexedDirectiveForest()),\n+      properties: getLatestComponentState(query, initializeOrGetDirectiveForestHooks().getDirectiveForest()),\n     },\n   ]);\n };\n@@ -100,7 +102,7 @@ const stopProfilingCallback = (messageBus: MessageBus<Events>) => () => {\n };\n \n const selectedComponentCallback = (position: ElementPosition) => {\n-  const node = queryDirectiveForest(position, initializeOrGetDirectiveForestHooks().getDirectiveForest());\n+  const node = queryDirectiveForest(position, initializeOrGetDirectiveForestHooks().getIndexedDirectiveForest());\n   setConsoleReference({ node, position });\n };\n \n@@ -109,7 +111,10 @@ const getNestedPropertiesCallback = (messageBus: MessageBus<Events>) => (\n   propPath: string[]\n ) => {\n   const emitEmpty = () => messageBus.emit('nestedProperties', [position, { props: {} }, propPath]);\n-  const node = queryDirectiveForest(position.element, initializeOrGetDirectiveForestHooks().getDirectiveForest());\n+  const node = queryDirectiveForest(\n+    position.element,\n+    initializeOrGetDirectiveForestHooks().getIndexedDirectiveForest()\n+  );\n   if (!node) {\n     return emitEmpty();\n   }"
        },
        {
            "sha": "0da6c21da8595bb1c03273946ffdb743925ceafc",
            "filename": "projects/ng-devtools-backend/src/lib/component-tree.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/ca0910e59c9d75a4e3719fabe85057146bd8a5fa/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fcomponent-tree.ts",
            "raw_url": "https://github.com/angular/angular/raw/ca0910e59c9d75a4e3719fabe85057146bd8a5fa/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fcomponent-tree.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fcomponent-tree.ts?ref=ca0910e59c9d75a4e3719fabe85057146bd8a5fa",
            "patch": "@@ -28,8 +28,14 @@ export interface ComponentTreeNode extends DevToolsNode<DirectiveInstanceType, C\n   children: ComponentTreeNode[];\n }\n \n-export const getLatestComponentState = (query: ComponentExplorerViewQuery): DirectivesProperties | undefined => {\n-  const node = queryDirectiveForest(query.selectedElement, buildDirectiveForest());\n+export const getLatestComponentState = (\n+  query: ComponentExplorerViewQuery,\n+  directiveForest?: ComponentTreeNode[]\n+): DirectivesProperties | undefined => {\n+  // if a directive forest is passed in we don't have to build the forest again.\n+  directiveForest = directiveForest ?? buildDirectiveForest();\n+\n+  const node = queryDirectiveForest(query.selectedElement, directiveForest);\n   if (!node) {\n     return;\n   }"
        },
        {
            "sha": "ce13c6affbc22df2ba36367fe9b52d2305a7975a",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/capture.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ca0910e59c9d75a4e3719fabe85057146bd8a5fa/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fcapture.ts",
            "raw_url": "https://github.com/angular/angular/raw/ca0910e59c9d75a4e3719fabe85057146bd8a5fa/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fcapture.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fcapture.ts?ref=ca0910e59c9d75a4e3719fabe85057146bd8a5fa",
            "patch": "@@ -197,7 +197,7 @@ const prepareInitialFrame = (source: string, duration: number) => {\n     directives: [],\n   };\n   const directiveForestHooks = initializeOrGetDirectiveForestHooks();\n-  const directiveForest = directiveForestHooks.getDirectiveForest();\n+  const directiveForest = directiveForestHooks.getIndexedDirectiveForest();\n   const traverse = (node: ComponentTreeNode, children = frame.directives) => {\n     let position: ElementPosition | undefined;\n     if (node.component) {"
        },
        {
            "sha": "025d5f65c877c378ef761d350580318676f022ea",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/hooks.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/ca0910e59c9d75a4e3719fabe85057146bd8a5fa/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fhooks.ts",
            "raw_url": "https://github.com/angular/angular/raw/ca0910e59c9d75a4e3719fabe85057146bd8a5fa/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fhooks.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fhooks.ts?ref=ca0910e59c9d75a4e3719fabe85057146bd8a5fa",
            "patch": "@@ -1,3 +1,4 @@\n+import { ComponentTreeNode } from './../component-tree';\n import { ElementPosition, LifecycleProfile } from 'protocol';\n import { componentMetadata, runOutsideAngular } from '../utils';\n import { IdentityTracker, IndexedNode } from './identity-tracker';\n@@ -109,7 +110,8 @@ export class DirectiveForestHooks {\n   private _undoLifecyclePatch: (() => void)[] = [];\n   private _lastChangeDetection = new Map<any, number>();\n   private _tracker = new IdentityTracker();\n-  private _forest: IndexedNode[] = [];\n+  private _forest: ComponentTreeNode[] = [];\n+  private _indexedForest: IndexedNode[] = [];\n   private _inChangeDetection = false;\n   private _changeDetection$ = new Subject<void>();\n \n@@ -139,7 +141,11 @@ export class DirectiveForestHooks {\n     return result;\n   }\n \n-  getDirectiveForest(): IndexedNode[] {\n+  getIndexedDirectiveForest(): IndexedNode[] {\n+    return this._indexedForest;\n+  }\n+\n+  getDirectiveForest(): ComponentTreeNode[] {\n     return this._forest;\n   }\n \n@@ -163,8 +169,9 @@ export class DirectiveForestHooks {\n   }\n \n   indexForest(): void {\n-    const { newNodes, removedNodes, indexedForest } = this._tracker.index();\n-    this._forest = indexedForest;\n+    const { newNodes, removedNodes, indexedForest, directiveForest } = this._tracker.index();\n+    this._indexedForest = indexedForest;\n+    this._forest = directiveForest;\n     newNodes.forEach((node) => {\n       this._observeLifecycle(node.directive, node.isComponent);\n       this._observeComponent(node.directive);"
        },
        {
            "sha": "c97e1d234892289c747342f6fe782f421f975f41",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/identity-tracker.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/ca0910e59c9d75a4e3719fabe85057146bd8a5fa/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fidentity-tracker.ts",
            "raw_url": "https://github.com/angular/angular/raw/ca0910e59c9d75a4e3719fabe85057146bd8a5fa/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fidentity-tracker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fidentity-tracker.ts?ref=ca0910e59c9d75a4e3719fabe85057146bd8a5fa",
            "patch": "@@ -1,3 +1,4 @@\n+import { ComponentTreeNode } from './../component-tree';\n import { ElementPosition, DevToolsNode } from 'protocol';\n import { buildDirectiveForest, DirectiveInstanceType, ComponentInstanceType } from '../component-tree';\n import { Type } from '@angular/core';\n@@ -31,8 +32,14 @@ export class IdentityTracker {\n     return this._currentDirectiveId.has(dir);\n   }\n \n-  index(): { newNodes: NodeArray; removedNodes: NodeArray; indexedForest: IndexedNode[] } {\n-    const indexedForest = indexForest(buildDirectiveForest());\n+  index(): {\n+    newNodes: NodeArray;\n+    removedNodes: NodeArray;\n+    indexedForest: IndexedNode[];\n+    directiveForest: ComponentTreeNode[];\n+  } {\n+    const directiveForest = buildDirectiveForest();\n+    const indexedForest = indexForest(directiveForest);\n     const newNodes: NodeArray = [];\n     const removedNodes: NodeArray = [];\n     const allNodes = new Set<any>();\n@@ -46,7 +53,7 @@ export class IdentityTracker {\n         // this._currentDirectivePosition.delete(dir);\n       }\n     });\n-    return { newNodes, removedNodes, indexedForest };\n+    return { newNodes, removedNodes, indexedForest, directiveForest };\n   }\n \n   private _index("
        }
    ],
    "stats": {
        "total": 55,
        "additions": 40,
        "deletions": 15
    }
}