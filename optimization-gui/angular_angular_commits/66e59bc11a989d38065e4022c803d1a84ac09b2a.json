{
    "author": "AndrewKushnir",
    "message": "refactor(core): make RuntimeError reusable across packages (#44398)\n\nThis commit updates the code around the `RuntimeError` class to make it more reusable between packages (currently it's only usable inside the `core` package). Specifically:\n- the error formatting logic was updated to handle cases when there is no error message provided\n- there is no special Set that contains a set of error codes for which we have guides on angular.io. Instead, this is now encoded into the error code itself (making such codes negative integers). Having a separate Set makes it non-tree-shakable, which we want to avoid.\n\nThis change should allow to employ the `RuntimeError` class in other packages to further standardize this subsystem and make the errors thrown by the framework consistent.\n\nAs a part of the refactoring, the `common` package code was also updated to follow the same logic as `core`, since the `RuntimeError` class was used there as well.\n\nPR Close #44398",
    "sha": "66e59bc11a989d38065e4022c803d1a84ac09b2a",
    "files": [
        {
            "sha": "f4c18eec6c580ab58d9f00edfe674453ee1baa4b",
            "filename": "packages/common/src/directives/ng_switch.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcommon%2Fsrc%2Fdirectives%2Fng_switch.ts",
            "raw_url": "https://github.com/angular/angular/raw/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcommon%2Fsrc%2Fdirectives%2Fng_switch.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Fdirectives%2Fng_switch.ts?ref=66e59bc11a989d38065e4022c803d1a84ac09b2a",
            "patch": "@@ -6,7 +6,9 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Directive, DoCheck, Host, Input, Optional, TemplateRef, ViewContainerRef, ɵRuntimeError as RuntimeError, ɵRuntimeErrorCode as RuntimeErrorCode} from '@angular/core';\n+import {Directive, DoCheck, Host, Input, Optional, TemplateRef, ViewContainerRef, ɵRuntimeError as RuntimeError} from '@angular/core';\n+\n+import {RuntimeErrorCode} from '../errors';\n \n export class SwitchView {\n   private _created = false;\n@@ -243,7 +245,7 @@ export class NgSwitchDefault {\n \n function throwNgSwitchProviderNotFoundError(attrName: string, directiveName: string): never {\n   throw new RuntimeError(\n-      RuntimeErrorCode.TEMPLATE_STRUCTURE_ERROR,\n+      RuntimeErrorCode.PARENT_NG_SWITCH_NOT_FOUND,\n       `An element with the \"${attrName}\" attribute ` +\n           `(matching the \"${\n               directiveName}\" directive) must be located inside an element with the \"ngSwitch\" attribute ` +"
        },
        {
            "sha": "ac763e1cb25fd032d3fc3e53a43a7720b191ab89",
            "filename": "packages/common/src/errors.ts",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcommon%2Fsrc%2Ferrors.ts",
            "raw_url": "https://github.com/angular/angular/raw/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcommon%2Fsrc%2Ferrors.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Ferrors.ts?ref=66e59bc11a989d38065e4022c803d1a84ac09b2a",
            "patch": "@@ -0,0 +1,16 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * The list of error codes used in runtime code of the `common` package.\n+ * Reserved error code range: 2000-2999.\n+ */\n+export const enum RuntimeErrorCode {\n+  // NgSwitch errors\n+  PARENT_NG_SWITCH_NOT_FOUND = 2000,\n+}"
        },
        {
            "sha": "a0498d227ec3b0026fa31514050f12ffd16012d3",
            "filename": "packages/common/test/directives/ng_switch_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcommon%2Ftest%2Fdirectives%2Fng_switch_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcommon%2Ftest%2Fdirectives%2Fng_switch_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Ftest%2Fdirectives%2Fng_switch_spec.ts?ref=66e59bc11a989d38065e4022c803d1a84ac09b2a",
            "patch": "@@ -182,7 +182,7 @@ import {expect} from '@angular/platform-browser/testing/src/matchers';\n \n            expect(() => createTestComponent(template))\n                .toThrowError(\n-                   'NG0305: An element with the \"ngSwitchCase\" attribute (matching the \"NgSwitchCase\" directive) must be located inside an element with the \"ngSwitch\" attribute (matching \"NgSwitch\" directive)');\n+                   'NG02000: An element with the \"ngSwitchCase\" attribute (matching the \"NgSwitchCase\" directive) must be located inside an element with the \"ngSwitch\" attribute (matching \"NgSwitch\" directive)');\n          }));\n \n       it('should throw error when ngSwitchDefault is used outside of ngSwitch', waitForAsync(() => {\n@@ -191,7 +191,7 @@ import {expect} from '@angular/platform-browser/testing/src/matchers';\n \n            expect(() => createTestComponent(template))\n                .toThrowError(\n-                   'NG0305: An element with the \"ngSwitchDefault\" attribute (matching the \"NgSwitchDefault\" directive) must be located inside an element with the \"ngSwitch\" attribute (matching \"NgSwitch\" directive)');\n+                   'NG02000: An element with the \"ngSwitchDefault\" attribute (matching the \"NgSwitchDefault\" directive) must be located inside an element with the \"ngSwitch\" attribute (matching \"NgSwitch\" directive)');\n          }));\n \n       it('should support nested NgSwitch on ng-container with ngTemplateOutlet', () => {"
        },
        {
            "sha": "1bdc76cf2cb710dac69f00700acd2e6a9b1be96b",
            "filename": "packages/core/src/core_private_export.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcore%2Fsrc%2Fcore_private_export.ts",
            "raw_url": "https://github.com/angular/angular/raw/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcore%2Fsrc%2Fcore_private_export.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcore_private_export.ts?ref=66e59bc11a989d38065e4022c803d1a84ac09b2a",
            "patch": "@@ -22,7 +22,7 @@ export {ComponentFactory as ɵComponentFactory} from './linker/component_factory\n export {clearResolutionOfComponentResourcesQueue as ɵclearResolutionOfComponentResourcesQueue, resolveComponentResources as ɵresolveComponentResources} from './metadata/resource_loading';\n export {ReflectionCapabilities as ɵReflectionCapabilities} from './reflection/reflection_capabilities';\n export {GetterFn as ɵGetterFn, MethodFn as ɵMethodFn, SetterFn as ɵSetterFn} from './reflection/types';\n-export {RuntimeError as ɵRuntimeError, RuntimeErrorCode as ɵRuntimeErrorCode} from './render3/error_code';\n+export {RuntimeError as ɵRuntimeError} from './render3/error_code';\n export {allowSanitizationBypassAndThrow as ɵallowSanitizationBypassAndThrow, BypassType as ɵBypassType, getSanitizationBypassType as ɵgetSanitizationBypassType, SafeHtml as ɵSafeHtml, SafeResourceUrl as ɵSafeResourceUrl, SafeScript as ɵSafeScript, SafeStyle as ɵSafeStyle, SafeUrl as ɵSafeUrl, SafeValue as ɵSafeValue, unwrapSafeValue as ɵunwrapSafeValue} from './sanitization/bypass';\n export {_sanitizeHtml as ɵ_sanitizeHtml} from './sanitization/html_sanitizer';\n export {_sanitizeUrl as ɵ_sanitizeUrl} from './sanitization/url_sanitizer';"
        },
        {
            "sha": "946ebb6b378f8004f901f31f9fb2eda42617fdda",
            "filename": "packages/core/src/render3/error_code.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 46,
            "changes": 84,
            "blob_url": "https://github.com/angular/angular/blob/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcore%2Fsrc%2Frender3%2Ferror_code.ts",
            "raw_url": "https://github.com/angular/angular/raw/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcore%2Fsrc%2Frender3%2Ferror_code.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Ferror_code.ts?ref=66e59bc11a989d38065e4022c803d1a84ac09b2a",
            "patch": "@@ -8,75 +8,67 @@\n \n import {ERROR_DETAILS_PAGE_BASE_URL} from './error_details_base_url';\n \n+/**\n+ * The list of error codes used in runtime code of the `core` package.\n+ * Reserved error code range: 100-999.\n+ *\n+ * Note: the minus sign denotes the fact that a particular code has a detailed guide on\n+ * angular.io. This extra annotation is needed to avoid introducing a separate set to store\n+ * error codes which have guides, which might leak into runtime code.\n+ *\n+ * Full list of available error guides can be found at https://angular.io/errors.\n+ */\n export const enum RuntimeErrorCode {\n-  // Internal Errors\n-\n   // Change Detection Errors\n-  EXPRESSION_CHANGED_AFTER_CHECKED = '100',\n-  RECURSIVE_APPLICATION_REF_TICK = '101',\n+  EXPRESSION_CHANGED_AFTER_CHECKED = -100,\n+  RECURSIVE_APPLICATION_REF_TICK = 101,\n \n   // Dependency Injection Errors\n-  CYCLIC_DI_DEPENDENCY = '200',\n-  PROVIDER_NOT_FOUND = '201',\n+  CYCLIC_DI_DEPENDENCY = -200,\n+  PROVIDER_NOT_FOUND = -201,\n \n   // Template Errors\n-  MULTIPLE_COMPONENTS_MATCH = '300',\n-  EXPORT_NOT_FOUND = '301',\n-  PIPE_NOT_FOUND = '302',\n-  UNKNOWN_BINDING = '303',\n-  UNKNOWN_ELEMENT = '304',\n-  TEMPLATE_STRUCTURE_ERROR = '305',\n+  MULTIPLE_COMPONENTS_MATCH = -300,\n+  EXPORT_NOT_FOUND = -301,\n+  PIPE_NOT_FOUND = -302,\n+  UNKNOWN_BINDING = 303,\n+  UNKNOWN_ELEMENT = 304,\n+  TEMPLATE_STRUCTURE_ERROR = 305,\n \n   // Bootstrap Errors\n-  MULTIPLE_PLATFORMS = '400',\n-  PLATFORM_NOT_FOUND = '401',\n-  ERROR_HANDLER_NOT_FOUND = '402',\n-  BOOTSTRAP_COMPONENTS_NOT_FOUND = '403',\n-  ALREADY_DESTROYED_PLATFORM = '404',\n-  ASYNC_INITIALIZERS_STILL_RUNNING = '405',\n+  MULTIPLE_PLATFORMS = 400,\n+  PLATFORM_NOT_FOUND = 401,\n+  ERROR_HANDLER_NOT_FOUND = 402,\n+  BOOTSTRAP_COMPONENTS_NOT_FOUND = 403,\n+  ALREADY_DESTROYED_PLATFORM = 404,\n+  ASYNC_INITIALIZERS_STILL_RUNNING = 405,\n \n   // Styling Errors\n \n   // Declarations Errors\n \n   // i18n Errors\n \n-  // Compilation Errors\n+  // JIT Compilation Errors\n }\n \n-export class RuntimeError extends Error {\n-  constructor(public code: RuntimeErrorCode, message: string) {\n-    super(formatRuntimeError(code, message));\n+export class RuntimeError<T = RuntimeErrorCode> extends Error {\n+  constructor(public code: T, message: string) {\n+    super(formatRuntimeError<T>(code, message));\n   }\n }\n \n-// Contains a set of error messages that have details guides at angular.io.\n-// Full list of available error guides can be found at https://angular.io/errors\n-/* tslint:disable:no-toplevel-property-access */\n-export const RUNTIME_ERRORS_WITH_GUIDES = new Set([\n-  RuntimeErrorCode.EXPRESSION_CHANGED_AFTER_CHECKED,\n-  RuntimeErrorCode.CYCLIC_DI_DEPENDENCY,\n-  RuntimeErrorCode.PROVIDER_NOT_FOUND,\n-  RuntimeErrorCode.MULTIPLE_COMPONENTS_MATCH,\n-  RuntimeErrorCode.EXPORT_NOT_FOUND,\n-  RuntimeErrorCode.PIPE_NOT_FOUND,\n-]);\n-/* tslint:enable:no-toplevel-property-access */\n-\n /** Called to format a runtime error */\n-export function formatRuntimeError(code: RuntimeErrorCode, message: string): string {\n-  const fullCode = code ? `NG0${code}: ` : '';\n+export function formatRuntimeError<T = RuntimeErrorCode>(code: T, message: string): string {\n+  const codeAsNumber = code as unknown as number;\n+  // Error code might be a negative number, which is a special marker that instructs the logic to\n+  // generate a link to the error details page on angular.io.\n+  const fullCode = `NG0${Math.abs(codeAsNumber)}`;\n \n-  let errorMessage = `${fullCode}${message}`;\n+  let errorMessage = `${fullCode}${message ? ': ' + message : ''}`;\n \n-  // Some runtime errors are still thrown without `ngDevMode` (for example\n-  // `throwProviderNotFoundError`), so we add `ngDevMode` check here to avoid pulling\n-  // `RUNTIME_ERRORS_WITH_GUIDES` symbol into prod bundles.\n-  // TODO: revisit all instances where `RuntimeError` is thrown and see if `ngDevMode` can be added\n-  // there instead to tree-shake more devmode-only code (and eventually remove `ngDevMode` check\n-  // from this code).\n-  if (ngDevMode && RUNTIME_ERRORS_WITH_GUIDES.has(code)) {\n-    errorMessage = `${errorMessage}. Find more at ${ERROR_DETAILS_PAGE_BASE_URL}/NG0${code}`;\n+  if (ngDevMode && codeAsNumber < 0) {\n+    errorMessage = `${errorMessage}. Find more at ${ERROR_DETAILS_PAGE_BASE_URL}/${fullCode}`;\n   }\n   return errorMessage;\n }"
        },
        {
            "sha": "1a804960778cb3e363b7e4daf9047569c1b3788c",
            "filename": "packages/core/src/render3/errors.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcore%2Fsrc%2Frender3%2Ferrors.ts",
            "raw_url": "https://github.com/angular/angular/raw/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcore%2Fsrc%2Frender3%2Ferrors.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Ferrors.ts?ref=66e59bc11a989d38065e4022c803d1a84ac09b2a",
            "patch": "@@ -32,8 +32,6 @@ export function throwErrorIfNoChangesMode(\n         ` It seems like the view has been created after its parent and its children have been dirty checked.` +\n         ` Has it been created in a change detection hook?`;\n   }\n-  // TODO: include debug context, see `viewDebugError` function in\n-  // `packages/core/src/view/errors.ts` for reference.\n   throw new RuntimeError(RuntimeErrorCode.EXPRESSION_CHANGED_AFTER_CHECKED, msg);\n }\n "
        },
        {
            "sha": "0a4ab17552499941959dc2a1b38b069cb8407116",
            "filename": "packages/core/src/render3/errors_di.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcore%2Fsrc%2Frender3%2Ferrors_di.ts",
            "raw_url": "https://github.com/angular/angular/raw/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcore%2Fsrc%2Frender3%2Ferrors_di.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Ferrors_di.ts?ref=66e59bc11a989d38065e4022c803d1a84ac09b2a",
            "patch": "@@ -7,6 +7,7 @@\n  */\n import {InjectorType} from '../di/interface/defs';\n import {stringify} from '../util/stringify';\n+\n import {RuntimeError, RuntimeErrorCode} from './error_code';\n import {stringifyForError} from './util/stringify_utils';\n "
        },
        {
            "sha": "540751413c7f382ba81414ca82446c540bf12754",
            "filename": "packages/core/test/runtime_error_spec.ts",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcore%2Ftest%2Fruntime_error_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/66e59bc11a989d38065e4022c803d1a84ac09b2a/packages%2Fcore%2Ftest%2Fruntime_error_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fruntime_error_spec.ts?ref=66e59bc11a989d38065e4022c803d1a84ac09b2a",
            "patch": "@@ -0,0 +1,32 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {RuntimeError, RuntimeErrorCode} from '../src/render3/error_code';\n+\n+describe('RuntimeError utils', () => {\n+  it('should format the error message correctly', () => {\n+    // Error with a guide, but without an error message.\n+    let errorInstance = new RuntimeError(RuntimeErrorCode.EXPORT_NOT_FOUND, '');\n+    expect(errorInstance.toString())\n+        .toBe('Error: NG0301. Find more at https://angular.io/errors/NG0301');\n+\n+    // Error without a guide and an error message.\n+    errorInstance = new RuntimeError(RuntimeErrorCode.TEMPLATE_STRUCTURE_ERROR, '');\n+    expect(errorInstance.toString()).toBe('Error: NG0305');\n+\n+    // Error without a guide, but with an error message.\n+    errorInstance =\n+        new RuntimeError(RuntimeErrorCode.TEMPLATE_STRUCTURE_ERROR, 'Some error message');\n+    expect(errorInstance.toString()).toBe('Error: NG0305: Some error message');\n+\n+    // Error with both a guide and an error message.\n+    errorInstance = new RuntimeError(RuntimeErrorCode.EXPORT_NOT_FOUND, 'Some error message');\n+    expect(errorInstance.toString())\n+        .toBe('Error: NG0301: Some error message. Find more at https://angular.io/errors/NG0301');\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 147,
        "additions": 94,
        "deletions": 53
    }
}