{
    "author": "devversion",
    "message": "feat(dev-infra): support user-failures when computing branches for target label (#38223)\n\nThe merge tool provides a way for configurations to determine the branches\nfor a label lazily. This is supported because it allows labels to respect\nthe currently selected base branch through the Github UI. e.g. if `target: label`\nis applied on a PR and the PR is based on the patch branch, then the change\ncould only go into the selected target branch, while if it would be based on\n`master`, the change would be cherry-picked to `master` too. This allows for\nconvenient back-porting of changes if they did not apply cleanly to the primary\ndevelopment branch (`master`).\n\nWe want to expand this function so that it is possible to report failures if an\ninvalid target label is appplied (e.g. `target: major` not allowed in\nsome situations), or if the Github base branch is not valid for the given target\nlabel (e.g. if `target: lts` is used, but it's not based on a LTS branch).\n\nPR Close #38223",
    "sha": "6f0f0d3ea2e44f9884a4a0c8acdf4dda52c09b6c",
    "files": [
        {
            "sha": "ddf4f75dcbe7eee1cb391c58ad268e65827744ed",
            "filename": "dev-infra/pr/merge/config.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/6f0f0d3ea2e44f9884a4a0c8acdf4dda52c09b6c/dev-infra%2Fpr%2Fmerge%2Fconfig.ts",
            "raw_url": "https://github.com/angular/angular/raw/6f0f0d3ea2e44f9884a4a0c8acdf4dda52c09b6c/dev-infra%2Fpr%2Fmerge%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fconfig.ts?ref=6f0f0d3ea2e44f9884a4a0c8acdf4dda52c09b6c",
            "patch": "@@ -31,6 +31,9 @@ export interface TargetLabel {\n    * List of branches a pull request with this target label should be merged into.\n    * Can also be wrapped in a function that accepts the target branch specified in the\n    * Github Web UI. This is useful for supporting labels like `target: development-branch`.\n+   *\n+   * @throws {InvalidTargetLabelError} Invalid label has been applied to pull request.\n+   * @throws {InvalidTargetBranchError} Invalid Github target branch has been selected.\n    */\n   branches: TargetLabelBranchResult|((githubTargetBranch: string) => TargetLabelBranchResult);\n }"
        },
        {
            "sha": "40e1d646a9e4ffde1ea84e6682ae35908012575d",
            "filename": "dev-infra/pr/merge/pull-request.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/6f0f0d3ea2e44f9884a4a0c8acdf4dda52c09b6c/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "raw_url": "https://github.com/angular/angular/raw/6f0f0d3ea2e44f9884a4a0c8acdf4dda52c09b6c/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts?ref=6f0f0d3ea2e44f9884a4a0c8acdf4dda52c09b6c",
            "patch": "@@ -12,7 +12,7 @@ import {GitClient} from '../../utils/git';\n \n import {PullRequestFailure} from './failures';\n import {matchesPattern} from './string-pattern';\n-import {getBranchesFromTargetLabel, getTargetLabelFromPullRequest} from './target-label';\n+import {getBranchesFromTargetLabel, getTargetLabelFromPullRequest, InvalidTargetBranchError, InvalidTargetLabelError} from './target-label';\n import {PullRequestMergeTask} from './task';\n \n /** Interface that describes a pull request. */\n@@ -83,6 +83,20 @@ export async function loadAndValidatePullRequest(\n       labels.some(name => matchesPattern(name, config.commitMessageFixupLabel));\n   const hasCaretakerNote = !!config.caretakerNoteLabel &&\n       labels.some(name => matchesPattern(name, config.caretakerNoteLabel!));\n+  let targetBranches: string[];\n+\n+  // If branches are determined for a given target label, capture errors that are\n+  // thrown as part of branch computation. This is expected because a merge configuration\n+  // can lazily compute branches for a target label and throw. e.g. if an invalid target\n+  // label is applied, we want to exit the script gracefully with an error message.\n+  try {\n+    targetBranches = await getBranchesFromTargetLabel(targetLabel, githubTargetBranch);\n+  } catch (error) {\n+    if (error instanceof InvalidTargetBranchError || error instanceof InvalidTargetLabelError) {\n+      return new PullRequestFailure(error.failureMessage);\n+    }\n+    throw error;\n+  }\n \n   return {\n     url: prData.html_url,\n@@ -92,8 +106,8 @@ export async function loadAndValidatePullRequest(\n     githubTargetBranch,\n     needsCommitMessageFixup,\n     hasCaretakerNote,\n+    targetBranches,\n     title: prData.title,\n-    targetBranches: getBranchesFromTargetLabel(targetLabel, githubTargetBranch),\n     commitCount: prData.commits,\n   };\n }"
        },
        {
            "sha": "ba43cecc1f151a972116556a4a7036f0973c29bf",
            "filename": "dev-infra/pr/merge/target-label.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 4,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/6f0f0d3ea2e44f9884a4a0c8acdf4dda52c09b6c/dev-infra%2Fpr%2Fmerge%2Ftarget-label.ts",
            "raw_url": "https://github.com/angular/angular/raw/6f0f0d3ea2e44f9884a4a0c8acdf4dda52c09b6c/dev-infra%2Fpr%2Fmerge%2Ftarget-label.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ftarget-label.ts?ref=6f0f0d3ea2e44f9884a4a0c8acdf4dda52c09b6c",
            "patch": "@@ -9,6 +9,22 @@\n import {MergeConfig, TargetLabel} from './config';\n import {matchesPattern} from './string-pattern';\n \n+/**\n+ * Unique error that can be thrown in the merge configuration if an\n+ * invalid branch is targeted.\n+ */\n+export class InvalidTargetBranchError {\n+  constructor(public failureMessage: string) {}\n+}\n+\n+/**\n+ * Unique error that can be thrown in the merge configuration if an\n+ * invalid label has been applied to a pull request.\n+ */\n+export class InvalidTargetLabelError {\n+  constructor(public failureMessage: string) {}\n+}\n+\n /** Gets the target label from the specified pull request labels. */\n export function getTargetLabelFromPullRequest(config: MergeConfig, labels: string[]): TargetLabel|\n     null {\n@@ -21,8 +37,14 @@ export function getTargetLabelFromPullRequest(config: MergeConfig, labels: strin\n   return null;\n }\n \n-/** Gets the branches from the specified target label. */\n-export function getBranchesFromTargetLabel(\n-    label: TargetLabel, githubTargetBranch: string): string[] {\n-  return typeof label.branches === 'function' ? label.branches(githubTargetBranch) : label.branches;\n+/**\n+ * Gets the branches from the specified target label.\n+ *\n+ * @throws {InvalidTargetLabelError} Invalid label has been applied to pull request.\n+ * @throws {InvalidTargetBranchError} Invalid Github target branch has been selected.\n+ */\n+export async function getBranchesFromTargetLabel(\n+    label: TargetLabel, githubTargetBranch: string): Promise<string[]> {\n+  return typeof label.branches === 'function' ? await label.branches(githubTargetBranch) :\n+                                                await label.branches;\n }"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 45,
        "deletions": 6
    }
}