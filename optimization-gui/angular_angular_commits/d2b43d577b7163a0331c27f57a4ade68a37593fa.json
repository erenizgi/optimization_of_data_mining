{
    "author": "atscott",
    "message": "refactor(language-service): migrate definitions_spec to new testing package (#40966)\n\nrefactor(language-service): migrate definitions_spec to new testing package\n\nPR Close #40966",
    "sha": "d2b43d577b7163a0331c27f57a4ade68a37593fa",
    "files": [
        {
            "sha": "db341d9ab775a5beac6f28e25411f06bce27d8eb",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 69,
            "changes": 130,
            "blob_url": "https://github.com/angular/angular/blob/d2b43d577b7163a0331c27f57a4ade68a37593fa/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2b43d577b7163a0331c27f57a4ade68a37593fa/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=d2b43d577b7163a0331c27f57a4ade68a37593fa",
            "patch": "@@ -6,102 +6,100 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n \n-import {extractCursorInfo, LanguageServiceTestEnvironment} from './env';\n-import {assertFileNames, createModuleWithDeclarations, humanizeDocumentSpanLike} from './test_utils';\n+import {assertFileNames, createModuleAndProjectWithDeclarations, humanizeDocumentSpanLike, LanguageServiceTestEnv, OpenBuffer} from '../testing';\n \n describe('definitions', () => {\n   it('gets definition for template reference in overridden template', () => {\n     initMockFileSystem('Native');\n-    const templateFile = {contents: '', name: absoluteFrom('/app.html')};\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+    const files = {\n+      'app.html': '',\n+      'app.ts': `\n         import {Component} from '@angular/core';\n \n         @Component({templateUrl: '/app.html'})\n         export class AppCmp {}\n       `,\n     };\n+    const env = LanguageServiceTestEnv.setup();\n \n-    const env = createModuleWithDeclarations([appFile], [templateFile]);\n-    const {cursor} = env.updateFileWithCursor(\n-        absoluteFrom('/app.html'), '<input #myInput /> {{myIn¦put.value}}');\n-    env.expectNoSourceDiagnostics();\n-    const {definitions} = env.ngLS.getDefinitionAndBoundSpan(absoluteFrom('/app.html'), cursor)!;\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const template = project.openFile('app.html');\n+    template.contents = '<input #myInput /> {{myInput.value}}';\n+    project.expectNoSourceDiagnostics();\n+\n+    template.moveCursorToText('{{myIn¦put.value}}');\n+    const {definitions} = getDefinitionsAndAssertBoundSpan(env, template);\n     expect(definitions![0].name).toEqual('myInput');\n     assertFileNames(Array.from(definitions!), ['app.html']);\n   });\n \n   it('returns the pipe class as definition when checkTypeOfPipes is false', () => {\n     initMockFileSystem('Native');\n-    const {cursor, text} = extractCursorInfo('{{\"1/1/2020\" | dat¦e}}');\n-    const templateFile = {contents: text, name: absoluteFrom('/app.html')};\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+    const files = {\n+      'app.ts': `\n         import {Component, NgModule} from '@angular/core';\n         import {CommonModule} from '@angular/common';\n \n         @Component({templateUrl: 'app.html'})\n         export class AppCmp {}\n       `,\n+      'app.html': '{{\"1/1/2020\" | date}}'\n     };\n     // checkTypeOfPipes is set to false when strict templates is false\n-    const env = createModuleWithDeclarations([appFile], [templateFile], {strictTemplates: false});\n-    const {textSpan, definitions} =\n-        getDefinitionsAndAssertBoundSpan(env, absoluteFrom('/app.html'), cursor);\n-    expect(text.substr(textSpan.start, textSpan.length)).toEqual('date');\n-\n-    expect(definitions.length).toEqual(1);\n-    const [def] = definitions;\n+    const env = LanguageServiceTestEnv.setup();\n+    const project =\n+        createModuleAndProjectWithDeclarations(env, 'test', files, {strictTemplates: false});\n+    const template = project.openFile('app.html');\n+    project.expectNoSourceDiagnostics();\n+    template.moveCursorToText('da¦te');\n+\n+    const {textSpan, definitions} = getDefinitionsAndAssertBoundSpan(env, template);\n+    expect(template.contents.substr(textSpan.start, textSpan.length)).toEqual('date');\n+    expect(definitions!.length).toEqual(1);\n+    const [def] = definitions!;\n     expect(def.textSpan).toContain('DatePipe');\n     expect(def.contextSpan).toContain('DatePipe');\n   });\n \n   it('gets definitions for all inputs when attribute matches more than one', () => {\n     initMockFileSystem('Native');\n-    const {cursor, text} = extractCursorInfo('<div dir inpu¦tA=\"abc\"></div>');\n-    const templateFile = {contents: text, name: absoluteFrom('/app.html')};\n-    const dirFile = {\n-      name: absoluteFrom('/dir.ts'),\n-      contents: `\n+    const files = {\n+      'app.ts': `\n+        import {Component, NgModule} from '@angular/core';\n+        import {CommonModule} from '@angular/common';\n+\n+        @Component({templateUrl: 'app.html'})\n+        export class AppCmp {}\n+      `,\n+      'app.html': '<div dir inputA=\"abc\"></div>',\n+      'dir.ts': `\n       import {Directive, Input} from '@angular/core';\n \n       @Directive({selector: '[dir]'})\n       export class MyDir {\n         @Input() inputA!: any;\n       }`,\n-    };\n-    const dirFile2 = {\n-      name: absoluteFrom('/dir2.ts'),\n-      contents: `\n+      'dir2.ts': `\n       import {Directive, Input} from '@angular/core';\n \n       @Directive({selector: '[dir]'})\n       export class MyDir2 {\n         @Input() inputA!: any;\n-      }`,\n-    };\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n-        import {Component, NgModule} from '@angular/core';\n-        import {CommonModule} from '@angular/common';\n+      }`\n \n-        @Component({templateUrl: 'app.html'})\n-        export class AppCmp {}\n-      `\n     };\n-    const env = createModuleWithDeclarations([appFile, dirFile, dirFile2], [templateFile]);\n-    const {textSpan, definitions} =\n-        getDefinitionsAndAssertBoundSpan(env, absoluteFrom('/app.html'), cursor);\n-    expect(text.substr(textSpan.start, textSpan.length)).toEqual('inputA');\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const template = project.openFile('app.html');\n+    template.moveCursorToText('inpu¦tA=\"abc\"');\n \n-    expect(definitions.length).toEqual(2);\n-    const [def, def2] = definitions;\n+    const {textSpan, definitions} = getDefinitionsAndAssertBoundSpan(env, template);\n+    expect(template.contents.substr(textSpan.start, textSpan.length)).toEqual('inputA');\n+\n+    expect(definitions!.length).toEqual(2);\n+    const [def, def2] = definitions!;\n     expect(def.textSpan).toContain('inputA');\n     expect(def2.textSpan).toContain('inputA');\n     // TODO(atscott): investigate why the text span includes more than just 'inputA'\n@@ -111,31 +109,23 @@ describe('definitions', () => {\n \n   it('gets definitions for all outputs when attribute matches more than one', () => {\n     initMockFileSystem('Native');\n-    const {cursor, text} = extractCursorInfo('<div dir (someEv¦ent)=\"doSomething()\"></div>');\n-    const templateFile = {contents: text, name: absoluteFrom('/app.html')};\n-    const dirFile = {\n-      name: absoluteFrom('/dir.ts'),\n-      contents: `\n+    const files = {\n+      'app.html': '<div dir (someEvent)=\"doSomething()\"></div>',\n+      'dir.ts': `\n       import {Directive, Output, EventEmitter} from '@angular/core';\n \n       @Directive({selector: '[dir]'})\n       export class MyDir {\n         @Output() someEvent = new EventEmitter<void>();\n       }`,\n-    };\n-    const dirFile2 = {\n-      name: absoluteFrom('/dir2.ts'),\n-      contents: `\n+      'dir2.ts': `\n       import {Directive, Output, EventEmitter} from '@angular/core';\n \n       @Directive({selector: '[dir]'})\n       export class MyDir2 {\n         @Output() someEvent = new EventEmitter<void>();\n       }`,\n-    };\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+      'app.ts': `\n         import {Component, NgModule} from '@angular/core';\n         import {CommonModule} from '@angular/common';\n \n@@ -145,10 +135,13 @@ describe('definitions', () => {\n         }\n       `\n     };\n-    const env = createModuleWithDeclarations([appFile, dirFile, dirFile2], [templateFile]);\n-    const {textSpan, definitions} =\n-        getDefinitionsAndAssertBoundSpan(env, absoluteFrom('/app.html'), cursor);\n-    expect(text.substr(textSpan.start, textSpan.length)).toEqual('someEvent');\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const template = project.openFile('app.html');\n+    template.moveCursorToText('(someEv¦ent)');\n+\n+    const {textSpan, definitions} = getDefinitionsAndAssertBoundSpan(env, template);\n+    expect(template.contents.substr(textSpan.start, textSpan.length)).toEqual('someEvent');\n \n     expect(definitions.length).toEqual(2);\n     const [def, def2] = definitions;\n@@ -159,10 +152,9 @@ describe('definitions', () => {\n     assertFileNames([def, def2], ['dir2.ts', 'dir.ts']);\n   });\n \n-  function getDefinitionsAndAssertBoundSpan(\n-      env: LanguageServiceTestEnvironment, fileName: AbsoluteFsPath, cursor: number) {\n+  function getDefinitionsAndAssertBoundSpan(env: LanguageServiceTestEnv, file: OpenBuffer) {\n     env.expectNoSourceDiagnostics();\n-    const definitionAndBoundSpan = env.ngLS.getDefinitionAndBoundSpan(fileName, cursor);\n+    const definitionAndBoundSpan = file.getDefinitionAndBoundSpan();\n     const {textSpan, definitions} = definitionAndBoundSpan!;\n     expect(definitions).toBeTruthy();\n     return {textSpan, definitions: definitions!.map(d => humanizeDocumentSpanLike(d, env))};"
        },
        {
            "sha": "482c81334cb9b04abfe311e4bd01a6e1f409c86a",
            "filename": "packages/language-service/ivy/testing/src/env.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/d2b43d577b7163a0331c27f57a4ade68a37593fa/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2b43d577b7163a0331c27f57a4ade68a37593fa/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fenv.ts?ref=d2b43d577b7163a0331c27f57a4ade68a37593fa",
            "patch": "@@ -12,7 +12,7 @@ import {loadStandardTestFiles} from '@angular/compiler-cli/src/ngtsc/testing';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {MockServerHost} from './host';\n-import {Project, ProjectFiles} from './project';\n+import {Project, ProjectFiles, TestableOptions} from './project';\n \n /**\n  * Testing environment for the Angular Language Service, which creates an in-memory tsserver\n@@ -48,12 +48,12 @@ export class LanguageServiceTestEnv {\n \n   constructor(private host: MockServerHost, private projectService: ts.server.ProjectService) {}\n \n-  addProject(name: string, files: ProjectFiles): Project {\n+  addProject(name: string, files: ProjectFiles, options: TestableOptions = {}): Project {\n     if (this.projects.has(name)) {\n       throw new Error(`Project ${name} is already defined`);\n     }\n \n-    const project = Project.initialize(name, this.projectService, files);\n+    const project = Project.initialize(name, this.projectService, files, options);\n     this.projects.set(name, project);\n     return project;\n   }\n@@ -65,6 +65,12 @@ export class LanguageServiceTestEnv {\n     }\n     return scriptInfo.getSnapshot().getText(span.start, span.start + span.length);\n   }\n+\n+  expectNoSourceDiagnostics(): void {\n+    for (const project of this.projects.values()) {\n+      project.expectNoSourceDiagnostics();\n+    }\n+  }\n }\n \n const logger: ts.server.Logger = {"
        },
        {
            "sha": "e59805bba2f72c545f235e5acf14026a4bd76250",
            "filename": "packages/language-service/ivy/testing/src/project.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/d2b43d577b7163a0331c27f57a4ade68a37593fa/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2b43d577b7163a0331c27f57a4ade68a37593fa/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts?ref=d2b43d577b7163a0331c27f57a4ade68a37593fa",
            "patch": "@@ -8,7 +8,7 @@\n \n import {StrictTemplateOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n-import { OptimizeFor } from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import {OptimizeFor} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n import {LanguageService} from '../../language_service';\n import {OpenBuffer} from './buffer';\n@@ -44,6 +44,7 @@ function writeTsconfig(\n           null, 2));\n }\n \n+export type TestableOptions = StrictTemplateOptions;\n \n export class Project {\n   private tsProject: ts.server.Project;\n@@ -52,7 +53,8 @@ export class Project {\n   private buffers = new Map<string, OpenBuffer>();\n \n   static initialize(\n-      projectName: string, projectService: ts.server.ProjectService, files: ProjectFiles): Project {\n+      projectName: string, projectService: ts.server.ProjectService, files: ProjectFiles,\n+      options: TestableOptions = {}): Project {\n     const fs = getFileSystem();\n     const tsConfigPath = absoluteFrom(`/${projectName}/tsconfig.json`);\n \n@@ -68,7 +70,7 @@ export class Project {\n       }\n     }\n \n-    writeTsconfig(fs, tsConfigPath, entryFiles, {});\n+    writeTsconfig(fs, tsConfigPath, entryFiles, options);\n \n     // Ensure the project is live in the ProjectService.\n     projectService.openClientFile(entryFiles[0]);"
        },
        {
            "sha": "50208c58f5800a33c2ba60d560f19103b27d3119",
            "filename": "packages/language-service/ivy/testing/src/util.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 4,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/d2b43d577b7163a0331c27f57a4ade68a37593fa/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2b43d577b7163a0331c27f57a4ade68a37593fa/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts?ref=d2b43d577b7163a0331c27f57a4ade68a37593fa",
            "patch": "@@ -8,7 +8,7 @@\n import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {LanguageServiceTestEnv} from './env';\n-import {Project, ProjectFiles} from './project';\n+import {Project, ProjectFiles, TestableOptions} from './project';\n \n /**\n  * Given a text snippet which contains exactly one cursor symbol ('¦'), extract both the offset of\n@@ -67,7 +67,7 @@ function getFirstClassDeclaration(declaration: string) {\n \n export function createModuleAndProjectWithDeclarations(\n     env: LanguageServiceTestEnv, projectName: string, projectFiles: ProjectFiles,\n-    options: any = {}): Project {\n+    options: TestableOptions = {}): Project {\n   const externalClasses: string[] = [];\n   const externalImports: string[] = [];\n   for (const [fileName, fileContents] of Object.entries(projectFiles)) {\n@@ -90,5 +90,28 @@ export function createModuleAndProjectWithDeclarations(\n         export class AppModule {}\n       `;\n   projectFiles['app-module.ts'] = moduleContents;\n-  return env.addProject(projectName, projectFiles);\n-}\n\\ No newline at end of file\n+  return env.addProject(projectName, projectFiles, options);\n+}\n+\n+export function humanizeDocumentSpanLike<T extends ts.DocumentSpan>(\n+    item: T, env: LanguageServiceTestEnv): T&Stringy<ts.DocumentSpan> {\n+  return {\n+    ...item,\n+    textSpan: env.getTextFromTsSpan(item.fileName, item.textSpan),\n+    contextSpan: item.contextSpan ? env.getTextFromTsSpan(item.fileName, item.contextSpan) :\n+                                    undefined,\n+    originalTextSpan: item.originalTextSpan ?\n+        env.getTextFromTsSpan(item.fileName, item.originalTextSpan) :\n+        undefined,\n+    originalContextSpan: item.originalContextSpan ?\n+        env.getTextFromTsSpan(item.fileName, item.originalContextSpan) :\n+        undefined,\n+  };\n+}\n+type Stringy<T> = {\n+  [P in keyof T]: string;\n+};\n+\n+export function getText(contents: string, textSpan: ts.TextSpan) {\n+  return contents.substr(textSpan.start, textSpan.length);\n+}"
        }
    ],
    "stats": {
        "total": 181,
        "additions": 102,
        "deletions": 79
    }
}