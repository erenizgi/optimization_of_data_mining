{
    "author": "mhevery",
    "message": "fix(core): fix possible XSS attack in development through SSR (#40525)\n\nThis is a follow up fix for\nhttps://github.com/angular/angular/pull/40136/commits/894286dd0c92b5af223364237e63798e18b14f58.\n\nIt turns out that comments can be closed in several ways:\n- `<!-->`\n- `<!-- -->`\n- `<!-- --!>`\n\nAll of the above are valid ways to close comment per:\nhttps://html.spec.whatwg.org/multipage/syntax.html#comments\n\nThe new fix surrounds `<` and `>` with zero width space so that it\nrenders in the same way, but it prevents the comment to be closed eagerly.\n\nPR Close #40525",
    "sha": "bb3b315eee8a669bf78940a24ecc4279cd04d380",
    "files": [
        {
            "sha": "c8f9845b121c8182957b400dfd57a19d80e99701",
            "filename": "packages/core/src/util/dom.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/bb3b315eee8a669bf78940a24ecc4279cd04d380/packages%2Fcore%2Fsrc%2Futil%2Fdom.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb3b315eee8a669bf78940a24ecc4279cd04d380/packages%2Fcore%2Fsrc%2Futil%2Fdom.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Futil%2Fdom.ts?ref=bb3b315eee8a669bf78940a24ecc4279cd04d380",
            "patch": "@@ -6,15 +6,18 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-const END_COMMENT = /-->/g;\n-const END_COMMENT_ESCAPED = '-\\u200B-\\u200B>';\n+const END_COMMENT = /(<|>)/g;\n+const END_COMMENT_ESCAPED = '\\u200B$1\\u200B';\n \n /**\n  * Escape the content of the strings so that it can be safely inserted into a comment node.\n  *\n  * The issue is that HTML does not specify any way to escape comment end text inside the comment.\n- * `<!-- The way you close a comment is with \"-->\". -->`. Above the `\"-->\"` is meant to be text not\n- * an end to the comment. This can be created programmatically through DOM APIs.\n+ * Consider: `<!-- The way you close a comment is with \">\", and \"->\" at the beginning or by \"-->\" or\n+ * \"--!>\" at the end. -->`. Above the `\"-->\"` is meant to be text not an end to the comment. This\n+ * can be created programmatically through DOM APIs. (`<!--` are also disallowed.)\n+ *\n+ * see: https://html.spec.whatwg.org/multipage/syntax.html#comments\n  *\n  * ```\n  * div.innerHTML = div.innerHTML\n@@ -26,7 +29,7 @@ const END_COMMENT_ESCAPED = '-\\u200B-\\u200B>';\n  * may contain such text and expect them to be safe.)\n  *\n  * This function escapes the comment text by looking for the closing char sequence `-->` and replace\n- * it with `-_-_>` where the `_` is a zero width space `\\u200B`. The result is that if a comment\n+ * it with `--_>_` where the `_` is a zero width space `\\u200B`. The result is that if a comment\n  * contains `-->` text it will render normally but it will not cause the HTML parser to close the\n  * comment.\n  *"
        },
        {
            "sha": "afc8b9ccd40d7adc54c0c56fb76474741979d68d",
            "filename": "packages/core/test/acceptance/security_spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 18,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/bb3b315eee8a669bf78940a24ecc4279cd04d380/packages%2Fcore%2Ftest%2Facceptance%2Fsecurity_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb3b315eee8a669bf78940a24ecc4279cd04d380/packages%2Fcore%2Ftest%2Facceptance%2Fsecurity_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fsecurity_spec.ts?ref=bb3b315eee8a669bf78940a24ecc4279cd04d380",
            "patch": "@@ -11,24 +11,33 @@ import {TestBed} from '@angular/core/testing';\n \n \n describe('comment node text escaping', () => {\n-  it('should not be possible to do XSS through comment reflect data', () => {\n-    @Component({template: `<div><span *ngIf=\"xssValue\"></span><div>`})\n-    class XSSComp {\n-      xssValue: string = '--> --><script>\"evil\"</script>';\n-    }\n+  // see: https://html.spec.whatwg.org/multipage/syntax.html#comments\n+  ['>',         // self closing\n+   '-->',       // standard closing\n+   '--!>',      // alternate closing\n+   '<!-- -->',  // embedded comment.\n+  ].forEach((xssValue) => {\n+    it('should not be possible to do XSS through comment reflect data when writing: ' + xssValue,\n+       () => {\n+         @Component({template: `<div><span *ngIf=\"xssValue\"></span><div>`})\n+         class XSSComp {\n+           // ngIf serializes the `xssValue` into a comment for debugging purposes.\n+           xssValue: string = xssValue + '<script>\"evil\"</script>';\n+         }\n \n-    TestBed.configureTestingModule({declarations: [XSSComp]});\n-    const fixture = TestBed.createComponent(XSSComp);\n-    fixture.detectChanges();\n-    const div = fixture.nativeElement.querySelector('div') as HTMLElement;\n-    // Serialize into a string to mimic SSR serialization.\n-    const html = div.innerHTML;\n-    // This must be escaped or we have XSS.\n-    expect(html).not.toContain('--><script');\n-    // Now parse it back into DOM (from string)\n-    div.innerHTML = html;\n-    // Verify that we did not accidentally deserialize the `<script>`\n-    const script = div.querySelector('script');\n-    expect(script).toBeFalsy();\n+         TestBed.configureTestingModule({declarations: [XSSComp]});\n+         const fixture = TestBed.createComponent(XSSComp);\n+         fixture.detectChanges();\n+         const div = fixture.nativeElement.querySelector('div') as HTMLElement;\n+         // Serialize into a string to mimic SSR serialization.\n+         const html = div.innerHTML;\n+         // This must be escaped or we have XSS.\n+         expect(html).not.toContain('--><script');\n+         // Now parse it back into DOM (from string)\n+         div.innerHTML = html;\n+         // Verify that we did not accidentally deserialize the `<script>`\n+         const script = div.querySelector('script');\n+         expect(script).toBeFalsy();\n+       });\n   });\n });\n\\ No newline at end of file"
        },
        {
            "sha": "dc28711c565cc7c3bd9b69891eb660117ccc51c8",
            "filename": "packages/core/test/util/dom_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/bb3b315eee8a669bf78940a24ecc4279cd04d380/packages%2Fcore%2Ftest%2Futil%2Fdom_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb3b315eee8a669bf78940a24ecc4279cd04d380/packages%2Fcore%2Ftest%2Futil%2Fdom_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Futil%2Fdom_spec.ts?ref=bb3b315eee8a669bf78940a24ecc4279cd04d380",
            "patch": "@@ -14,13 +14,20 @@ describe('comment node text escaping', () => {\n       expect(escapeCommentText('text')).toEqual('text');\n     });\n \n+    it('should escape \"<\" or \">\"', () => {\n+      expect(escapeCommentText('<')).toEqual('\\u200b<\\u200b');\n+      expect(escapeCommentText('<<')).toEqual('\\u200b<\\u200b\\u200b<\\u200b');\n+      expect(escapeCommentText('>')).toEqual('\\u200b>\\u200b');\n+      expect(escapeCommentText('>>')).toEqual('\\u200b>\\u200b\\u200b>\\u200b');\n+    });\n+\n     it('should escape end marker', () => {\n-      expect(escapeCommentText('before-->after')).toEqual('before-\\u200b-\\u200b>after');\n+      expect(escapeCommentText('before-->after')).toEqual('before--\\u200b>\\u200bafter');\n     });\n \n     it('should escape multiple markers', () => {\n       expect(escapeCommentText('before-->inline-->after'))\n-          .toEqual('before-\\u200b-\\u200b>inline-\\u200b-\\u200b>after');\n+          .toEqual('before--\\u200b>\\u200binline--\\u200b>\\u200bafter');\n     });\n   });\n });"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 44,
        "deletions": 25
    }
}