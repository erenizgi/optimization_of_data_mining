{
    "author": "devversion",
    "message": "build: ship locales in `@angular/common` in ESM format (#43431)\n\nSimilar to other code that is shipped as part of `@angular/common`\n(with APF v13), we should ship the generated locale files as ESM\nfiles as well. This is necessary/reasonable because we explicitly\nset `type: \"module\"` for the common package, so it makes sense to\nhave the same apply for the locale sub-directory.\n\nNote: The global locale scripts remain having the `.js` extension\nand will continue to be unmodified. They are CJS/ESM compatible either\nway, but refer to browser globals.\n\nPR Close #43431",
    "sha": "c5a5682b0600fbe1d78a6780594f16007e1d3586",
    "files": [
        {
            "sha": "fbbedd82aa88c9f2f3efd193406b7245f2b4ca02",
            "filename": "packages/bazel/test/ng_package/common_package.spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/c5a5682b0600fbe1d78a6780594f16007e1d3586/packages%2Fbazel%2Ftest%2Fng_package%2Fcommon_package.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c5a5682b0600fbe1d78a6780594f16007e1d3586/packages%2Fbazel%2Ftest%2Fng_package%2Fcommon_package.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fcommon_package.spec.ts?ref=c5a5682b0600fbe1d78a6780594f16007e1d3586",
            "patch": "@@ -21,17 +21,12 @@ describe('@angular/common ng_package', () => {\n     it('/locales', () => {\n       const files = shx.ls('locales').stdout.split('\\n');\n       expect(files.some(n => n.endsWith('.d.ts'))).toBe(true, `.d.ts files don't exist`);\n-      expect(files.some(n => n.endsWith('.js'))).toBe(true, `.js files don't exist`);\n+      expect(files.some(n => n.endsWith('.mjs'))).toBe(true, `.mjs files don't exist`);\n     });\n     it('/locales/extra', () => {\n       const files = shx.ls('locales/extra').stdout.split('\\n');\n       expect(files.some(n => n.endsWith('.d.ts'))).toBe(true, `.d.ts files don't exist`);\n-      expect(files.some(n => n.endsWith('.js'))).toBe(true, `.js files don't exist`);\n-    });\n-    // regression test for https://github.com/angular/angular/issues/23217\n-    // Note, we don't have an e2e test that covers this\n-    it('doesn\\'t pass require in a way that breaks webpack static analysis', () => {\n-      expect(shx.cat('locales/fr.js')).not.toContain('factory(require, exports)');\n+      expect(files.some(n => n.endsWith('.mjs'))).toBe(true, `.mjs files don't exist`);\n     });\n   });\n "
        },
        {
            "sha": "68e209b1a6a0c7c3483e16ec60d6d98f934df75b",
            "filename": "packages/common/locales/BUILD.bazel",
            "status": "modified",
            "additions": 5,
            "deletions": 12,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/c5a5682b0600fbe1d78a6780594f16007e1d3586/packages%2Fcommon%2Flocales%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/c5a5682b0600fbe1d78a6780594f16007e1d3586/packages%2Fcommon%2Flocales%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2FBUILD.bazel?ref=c5a5682b0600fbe1d78a6780594f16007e1d3586",
            "patch": "@@ -42,18 +42,11 @@ ts_library(\n pkg_npm(\n     name = \"package\",\n     srcs = [\"package.json\"],\n-    substitutions = {\n-        # Workaround for `.d.ts`` containing `/// <amd-module .../>`\n-        # which are generated in TypeScript v2.9, but not before.\n-        \"/// <amd-module name=.*/>\": \"\",\n-        # Workaround for https://github.com/angular/angular/issues/23217\n-        # Webpack will detect that the UMD outputs from TypeScript pass the\n-        # `require` function into the module, and cannot accurately track\n-        # dependencies in case require was called.\n-        # We don't actually import anything in the locale code so we can\n-        # null out the require reference passed into the module.\n-        \"factory\\\\(require, exports\\\\)\": \"factory(null, exports)\",\n-    },\n+    # We also ship the locales in ESM format so that the output matches with other code of\n+    # the `@angular/common` package. Note: This does not affect the output for the global\n+    # locale scripts (that can be loaded using basic `<script>` tags). The global locale\n+    # scripts do not use any ESM/CJS specific syntax so they continue to have the `.js` extension.\n+    use_prodmode_output = True,\n     # TODO(devversion): Remove glob for checked-in legacy locale files that haven't been\n     # removed in the past (when CLDR has been updated). These can be removed in a major.\n     deps = [\"global/%s.js\" % l for l in LOCALES] + [\":locales\"] + glob([\"global/*.js\"]),"
        },
        {
            "sha": "33c6a5725c4b7912bc4dd0128e4a6e4fe75b68d2",
            "filename": "tools/defaults.bzl",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/c5a5682b0600fbe1d78a6780594f16007e1d3586/tools%2Fdefaults.bzl",
            "raw_url": "https://github.com/angular/angular/raw/c5a5682b0600fbe1d78a6780594f16007e1d3586/tools%2Fdefaults.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fdefaults.bzl?ref=c5a5682b0600fbe1d78a6780594f16007e1d3586",
            "patch": "@@ -242,7 +242,7 @@ def ng_package(name, readme_md = None, license_banner = None, deps = [], **kwarg\n         visibility = visibility,\n     )\n \n-def pkg_npm(name, **kwargs):\n+def pkg_npm(name, use_prodmode_output = False, **kwargs):\n     \"\"\"Default values for pkg_npm\"\"\"\n     visibility = kwargs.pop(\"visibility\", None)\n \n@@ -258,15 +258,15 @@ def pkg_npm(name, **kwargs):\n \n     # The `pkg_npm` rule brings in devmode (`JSModuleInfo`) and prodmode (`JSEcmaScriptModuleInfo`)\n     # output into the the NPM package We do not intend to ship the prodmode ECMAScript `.mjs`\n-    # files, but the `JSModuleInfo` outputs (which correspond to devmode output). We cannot\n-    # ship prodmode ECMAScript output was our output is not fully ESM-compatible due to relative\n-    # imports not specifying an explicit extension.\n+    # files, but the `JSModuleInfo` outputs (which correspond to devmode output). Depending on\n+    # the `use_prodmode_output` macro attribute, we either ship the ESM output of dependencies,\n+    # or continue shipping the devmode ES5 output.\n     # TODO: Clean this up in the future if we have combined devmode and prodmode output.\n     # https://github.com/bazelbuild/rules_nodejs/commit/911529fd364eb3ee1b8ecdc568a9fcf38a8b55ca.\n     # https://github.com/bazelbuild/rules_nodejs/blob/stable/packages/typescript/internal/build_defs.bzl#L334-L337.\n     extract_js_module_output(\n         name = \"%s_js_module_output\" % name,\n-        provider = \"JSModuleInfo\",\n+        provider = \"JSEcmaScriptModuleInfo\" if use_prodmode_output else \"JSModuleInfo\",\n         include_declarations = True,\n         include_default_files = True,\n         deps = deps,"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 12,
        "deletions": 24
    }
}