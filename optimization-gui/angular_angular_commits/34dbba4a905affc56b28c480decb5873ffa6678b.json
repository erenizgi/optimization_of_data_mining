{
    "author": "josephperrott",
    "message": "refactor(dev-infra): remove branches created for g3 comparison (#39137)\n\nPreviously, temporary branches were created to be used for comparison to\nthe g3 branch, instead comparisons are now done using the branches\nlatest shas.\n\nPR Close #39137",
    "sha": "34dbba4a905affc56b28c480decb5873ffa6678b",
    "files": [
        {
            "sha": "1a5d8a48e63f4b8617971f1a8da33ed507b7109a",
            "filename": "dev-infra/caretaker/check/g3.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 24,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/34dbba4a905affc56b28c480decb5873ffa6678b/dev-infra%2Fcaretaker%2Fcheck%2Fg3.ts",
            "raw_url": "https://github.com/angular/angular/raw/34dbba4a905affc56b28c480decb5873ffa6678b/dev-infra%2Fcaretaker%2Fcheck%2Fg3.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fg3.ts?ref=34dbba4a905affc56b28c480decb5873ffa6678b",
            "patch": "@@ -35,31 +35,17 @@ export async function printG3Comparison(git: GitClient) {\n     return;\n   }\n \n-  /** Random prefix to create unique branch names. */\n-  const randomPrefix = `prefix${Math.floor(Math.random() * 1000000)}`;\n-  /** Ref name of the temporary master branch. */\n-  const masterRef = `${randomPrefix}-master`;\n-  /** Ref name of the temporary g3 branch. */\n-  const g3Ref = `${randomPrefix}-g3`;\n-  /** Url of the ref for fetching master and g3 branches. */\n-  const refUrl = `https://github.com/${git.remoteConfig.owner}/${git.remoteConfig.name}.git`;\n-  /** The result fo the fetch command. */\n-  const fetchResult =\n-      git.runGraceful(['fetch', '-q', refUrl, `master:${masterRef}`, `g3:${g3Ref}`]);\n-\n-  // If the upstream repository does not have a g3 branch to compare to, skip the comparison.\n-  if (fetchResult.status !== 0) {\n-    if (fetchResult.stderr.includes(`couldn't find remote ref g3`)) {\n-      return debug('No g3 branch exists on upstream, skipping.');\n-    }\n-    throw Error('Fetch of master and g3 branches for comparison failed.');\n+  /** The latest sha for the g3 branch. */\n+  const g3Ref = getShaForBranchLatest('g3');\n+  /** The latest sha for the master branch. */\n+  const masterRef = getShaForBranchLatest('master');\n+\n+  if (!g3Ref && !masterRef) {\n+    return debug('Exiting early as either the g3 or master was unable to be retrieved');\n   }\n \n   /** The statistical information about the git diff between master and g3. */\n-  const stats = getDiffStats(git);\n-\n-  // Delete the temporarily created mater and g3 branches.\n-  git.runGraceful(['branch', '-D', masterRef, g3Ref]);\n+  const stats = getDiffStats();\n \n   info.group(bold('g3 branch check'));\n   info(`${stats.commits} commits between g3 and master`);\n@@ -73,11 +59,27 @@ export async function printG3Comparison(git: GitClient) {\n   info();\n \n \n+  /** Fetch and retrieve the latest sha for a specific branch. */\n+  function getShaForBranchLatest(branch: string) {\n+    /** The result fo the fetch command. */\n+    const fetchResult = git.runGraceful([\n+      'fetch', '-q', `https://github.com/${git.remoteConfig.owner}/${git.remoteConfig.name}.git`,\n+      branch\n+    ]);\n+\n+    if (fetchResult.status !== 0 &&\n+        fetchResult.stderr.includes(`couldn't find remote ref ${branch}`)) {\n+      debug(`No '${branch}' branch exists on upstream, skipping.`);\n+      return false;\n+    }\n+    return git.runGraceful(['rev-parse', 'FETCH_HEAD']).stdout.trim();\n+  }\n+\n   /**\n    * Get git diff stats between master and g3, for all files and filtered to only g3 affecting\n    * files.\n    */\n-  function getDiffStats(git: GitClient) {\n+  function getDiffStats() {\n     /** The diff stats to be returned. */\n     const stats = {\n       insertions: 0,\n@@ -86,7 +88,6 @@ export async function printG3Comparison(git: GitClient) {\n       commits: 0,\n     };\n \n-\n     // Determine the number of commits between master and g3 refs. */\n     stats.commits = parseInt(git.run(['rev-list', '--count', `${g3Ref}..${masterRef}`]).stdout, 10);\n "
        }
    ],
    "stats": {
        "total": 49,
        "additions": 25,
        "deletions": 24
    }
}