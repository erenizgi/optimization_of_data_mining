{
    "author": "petebacondarwin",
    "message": "fix(localize): do not expose NodeJS typings in $localize runtime code (#38700)\n\nA recent change to `@angular/localize` brought in the `AbsoluteFsPath` type\nfrom the `@angular/compiler-cli`. But this brought along with it a reference\nto NodeJS typings - specifically the `FileSystem` interface refers to the\n`Buffer` type from NodeJS.\n\nThis affects compilation of `@angular/localize` code that will be run in\nthe browser - for example projects that reference `loadTranslations()`.\nThe compilation breaks if the NodeJS typings are not included in the build.\nClearly it is not desirable to have these typings included when the project\nis not targeting NodeJS.\n\nThis commit replaces references to the NodeJS `Buffer` type with `Uint8Array`,\nwhich is available across all platforms and is actually the super-class of\n`Buffer`.\n\nFixes #38692\n\nPR Close #38700",
    "sha": "2c4a98a28594afc16a481ff4fc56cb37ce1a04b0",
    "files": [
        {
            "sha": "5dadaa1fbdb4baa30edb7269566c0ece785a4548",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/src/invalid_file_system.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Finvalid_file_system.ts",
            "raw_url": "https://github.com/angular/angular/raw/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Finvalid_file_system.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Finvalid_file_system.ts?ref=2c4a98a28594afc16a481ff4fc56cb37ce1a04b0",
            "patch": "@@ -22,10 +22,10 @@ export class InvalidFileSystem implements FileSystem {\n   readFile(path: AbsoluteFsPath): string {\n     throw makeError();\n   }\n-  readFileBuffer(path: AbsoluteFsPath): Buffer {\n+  readFileBuffer(path: AbsoluteFsPath): Uint8Array {\n     throw makeError();\n   }\n-  writeFile(path: AbsoluteFsPath, data: string|Buffer, exclusive?: boolean): void {\n+  writeFile(path: AbsoluteFsPath, data: string|Uint8Array, exclusive?: boolean): void {\n     throw makeError();\n   }\n   removeFile(path: AbsoluteFsPath): void {"
        },
        {
            "sha": "444092831978d7195f0a54bb61faac7785725e18",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/src/node_js_file_system.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Fnode_js_file_system.ts",
            "raw_url": "https://github.com/angular/angular/raw/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Fnode_js_file_system.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Fnode_js_file_system.ts?ref=2c4a98a28594afc16a481ff4fc56cb37ce1a04b0",
            "patch": "@@ -23,10 +23,10 @@ export class NodeJSFileSystem implements FileSystem {\n   readFile(path: AbsoluteFsPath): string {\n     return fs.readFileSync(path, 'utf8');\n   }\n-  readFileBuffer(path: AbsoluteFsPath): Buffer {\n+  readFileBuffer(path: AbsoluteFsPath): Uint8Array {\n     return fs.readFileSync(path);\n   }\n-  writeFile(path: AbsoluteFsPath, data: string|Buffer, exclusive: boolean = false): void {\n+  writeFile(path: AbsoluteFsPath, data: string|Uint8Array, exclusive: boolean = false): void {\n     fs.writeFileSync(path, data, exclusive ? {flag: 'wx'} : undefined);\n   }\n   removeFile(path: AbsoluteFsPath): void {"
        },
        {
            "sha": "bdc660e3011f41a9659688f4586dab200b6bccac",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/src/types.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Ftypes.ts",
            "raw_url": "https://github.com/angular/angular/raw/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Ftypes.ts?ref=2c4a98a28594afc16a481ff4fc56cb37ce1a04b0",
            "patch": "@@ -37,8 +37,8 @@ export type PathSegment = BrandedPath<'PathSegment'>;\n export interface FileSystem {\n   exists(path: AbsoluteFsPath): boolean;\n   readFile(path: AbsoluteFsPath): string;\n-  readFileBuffer(path: AbsoluteFsPath): Buffer;\n-  writeFile(path: AbsoluteFsPath, data: string|Buffer, exclusive?: boolean): void;\n+  readFileBuffer(path: AbsoluteFsPath): Uint8Array;\n+  writeFile(path: AbsoluteFsPath, data: string|Uint8Array, exclusive?: boolean): void;\n   removeFile(path: AbsoluteFsPath): void;\n   symlink(target: AbsoluteFsPath, path: AbsoluteFsPath): void;\n   readdir(path: AbsoluteFsPath): PathSegment[];"
        },
        {
            "sha": "9122f531eb8e83cb221e9ce9a10921ce41c1a11a",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/testing/src/mock_file_system.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Fsrc%2Fmock_file_system.ts",
            "raw_url": "https://github.com/angular/angular/raw/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Fsrc%2Fmock_file_system.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Fsrc%2Fmock_file_system.ts?ref=2c4a98a28594afc16a481ff4fc56cb37ce1a04b0",
            "patch": "@@ -38,16 +38,16 @@ export abstract class MockFileSystem implements FileSystem {\n     }\n   }\n \n-  readFileBuffer(path: AbsoluteFsPath): Buffer {\n+  readFileBuffer(path: AbsoluteFsPath): Uint8Array {\n     const {entity} = this.findFromPath(path);\n     if (isFile(entity)) {\n-      return Buffer.isBuffer(entity) ? entity : new Buffer(entity);\n+      return entity instanceof Uint8Array ? entity : new Buffer(entity);\n     } else {\n       throw new MockFileSystemError('ENOENT', path, `File \"${path}\" does not exist.`);\n     }\n   }\n \n-  writeFile(path: AbsoluteFsPath, data: string|Buffer, exclusive: boolean = false): void {\n+  writeFile(path: AbsoluteFsPath, data: string|Uint8Array, exclusive: boolean = false): void {\n     const [folderPath, basename] = this.splitIntoFolderAndFile(path);\n     const {entity} = this.findFromPath(folderPath);\n     if (entity === null || !isFolder(entity)) {\n@@ -295,7 +295,7 @@ export type Entity = Folder|File|SymLink;\n export interface Folder {\n   [pathSegments: string]: Entity;\n }\n-export type File = string|Buffer;\n+export type File = string|Uint8Array;\n export class SymLink {\n   constructor(public path: AbsoluteFsPath) {}\n }"
        },
        {
            "sha": "3b0ddeec70a08c504871191063fd9c10b4b4aa66",
            "filename": "packages/localize/src/tools/src/translate/asset_files/asset_translation_handler.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fasset_files%2Fasset_translation_handler.ts",
            "raw_url": "https://github.com/angular/angular/raw/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fasset_files%2Fasset_translation_handler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fasset_files%2Fasset_translation_handler.ts?ref=2c4a98a28594afc16a481ff4fc56cb37ce1a04b0",
            "patch": "@@ -17,14 +17,14 @@ import {TranslationBundle, TranslationHandler} from '../translator';\n export class AssetTranslationHandler implements TranslationHandler {\n   constructor(private fs: FileSystem) {}\n \n-  canTranslate(_relativeFilePath: PathSegment|AbsoluteFsPath, _contents: Buffer): boolean {\n+  canTranslate(_relativeFilePath: PathSegment|AbsoluteFsPath, _contents: Uint8Array): boolean {\n     return true;\n   }\n \n   translate(\n       diagnostics: Diagnostics, _sourceRoot: AbsoluteFsPath,\n-      relativeFilePath: PathSegment|AbsoluteFsPath, contents: Buffer, outputPathFn: OutputPathFn,\n-      translations: TranslationBundle[], sourceLocale?: string): void {\n+      relativeFilePath: PathSegment|AbsoluteFsPath, contents: Uint8Array,\n+      outputPathFn: OutputPathFn, translations: TranslationBundle[], sourceLocale?: string): void {\n     for (const translation of translations) {\n       this.writeAssetFile(\n           diagnostics, outputPathFn, translation.locale, relativeFilePath, contents);\n@@ -36,7 +36,7 @@ export class AssetTranslationHandler implements TranslationHandler {\n \n   private writeAssetFile(\n       diagnostics: Diagnostics, outputPathFn: OutputPathFn, locale: string,\n-      relativeFilePath: PathSegment|AbsoluteFsPath, contents: Buffer): void {\n+      relativeFilePath: PathSegment|AbsoluteFsPath, contents: Uint8Array): void {\n     try {\n       const outputPath = absoluteFrom(outputPathFn(locale, relativeFilePath));\n       this.fs.ensureDir(this.fs.dirname(outputPath));"
        },
        {
            "sha": "18f41636b4dccd19d6186f85ae78d1a751c3b648",
            "filename": "packages/localize/src/tools/src/translate/source_files/source_file_translation_handler.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fsource_file_translation_handler.ts",
            "raw_url": "https://github.com/angular/angular/raw/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fsource_file_translation_handler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Fsource_files%2Fsource_file_translation_handler.ts?ref=2c4a98a28594afc16a481ff4fc56cb37ce1a04b0",
            "patch": "@@ -27,15 +27,15 @@ export class SourceFileTranslationHandler implements TranslationHandler {\n       TranslatePluginOptions = {...this.translationOptions, missingTranslation: 'ignore'};\n   constructor(private fs: FileSystem, private translationOptions: TranslatePluginOptions = {}) {}\n \n-  canTranslate(relativeFilePath: PathSegment|AbsoluteFsPath, _contents: Buffer): boolean {\n+  canTranslate(relativeFilePath: PathSegment|AbsoluteFsPath, _contents: Uint8Array): boolean {\n     return this.fs.extname(relativeFilePath) === '.js';\n   }\n \n   translate(\n       diagnostics: Diagnostics, sourceRoot: AbsoluteFsPath, relativeFilePath: PathSegment,\n-      contents: Buffer, outputPathFn: OutputPathFn, translations: TranslationBundle[],\n+      contents: Uint8Array, outputPathFn: OutputPathFn, translations: TranslationBundle[],\n       sourceLocale?: string): void {\n-    const sourceCode = contents.toString('utf8');\n+    const sourceCode = Buffer.from(contents).toString('utf8');\n     // A short-circuit check to avoid parsing the file into an AST if it does not contain any\n     // `$localize` identifiers.\n     if (!sourceCode.includes('$localize')) {\n@@ -97,7 +97,7 @@ export class SourceFileTranslationHandler implements TranslationHandler {\n \n   private writeSourceFile(\n       diagnostics: Diagnostics, outputPathFn: OutputPathFn, locale: string,\n-      relativeFilePath: PathSegment, contents: string|Buffer): void {\n+      relativeFilePath: PathSegment, contents: string|Uint8Array): void {\n     try {\n       const outputPath = absoluteFrom(outputPathFn(locale, relativeFilePath));\n       this.fs.ensureDir(this.fs.dirname(outputPath));"
        },
        {
            "sha": "6c1d1eb3d6107f4578006af0ec6386bd4529067b",
            "filename": "packages/localize/src/tools/src/translate/translator.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslator.ts",
            "raw_url": "https://github.com/angular/angular/raw/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslator.ts?ref=2c4a98a28594afc16a481ff4fc56cb37ce1a04b0",
            "patch": "@@ -35,7 +35,7 @@ export interface TranslationHandler {\n    * @param relativeFilePath A relative path from the sourceRoot to the resource file to handle.\n    * @param contents The contents of the file to handle.\n    */\n-  canTranslate(relativeFilePath: PathSegment|AbsoluteFsPath, contents: Buffer): boolean;\n+  canTranslate(relativeFilePath: PathSegment|AbsoluteFsPath, contents: Uint8Array): boolean;\n \n   /**\n    * Translate the file at `relativeFilePath` containing `contents`, using the given `translations`,\n@@ -54,8 +54,8 @@ export interface TranslationHandler {\n    */\n   translate(\n       diagnostics: Diagnostics, sourceRoot: AbsoluteFsPath,\n-      relativeFilePath: PathSegment|AbsoluteFsPath, contents: Buffer, outputPathFn: OutputPathFn,\n-      translations: TranslationBundle[], sourceLocale?: string): void;\n+      relativeFilePath: PathSegment|AbsoluteFsPath, contents: Uint8Array,\n+      outputPathFn: OutputPathFn, translations: TranslationBundle[], sourceLocale?: string): void;\n }\n \n /**"
        },
        {
            "sha": "ea42c7e5154808e65ce50f1ffdb5d69b61b2c676",
            "filename": "packages/localize/src/tools/test/translate/translator_spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslator_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/2c4a98a28594afc16a481ff4fc56cb37ce1a04b0/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslator_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslator_spec.ts?ref=2c4a98a28594afc16a481ff4fc56cb37ce1a04b0",
            "patch": "@@ -109,13 +109,13 @@ runInEachFileSystem(() => {\n     log: string[] = [];\n     constructor(private _canTranslate: boolean = true) {}\n \n-    canTranslate(relativePath: string, contents: Buffer) {\n-      this.log.push(`canTranslate(${relativePath}, ${contents.toString('utf8')})`);\n+    canTranslate(relativePath: string, contents: Uint8Array) {\n+      this.log.push(`canTranslate(${relativePath}, ${contents})`);\n       return this._canTranslate;\n     }\n \n     translate(\n-        _diagnostics: Diagnostics, rootPath: string, relativePath: string, contents: Buffer,\n+        _diagnostics: Diagnostics, rootPath: string, relativePath: string, contents: Uint8Array,\n         _outputPathFn: OutputPathFn, _translations: TranslationBundle[], sourceLocale?: string) {\n       this.log.push(\n           `translate(${rootPath}, ${relativePath}, ${contents}, ...` +"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 24,
        "deletions": 24
    }
}