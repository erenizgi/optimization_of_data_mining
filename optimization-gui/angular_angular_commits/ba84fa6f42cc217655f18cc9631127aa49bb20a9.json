{
    "author": "petebacondarwin",
    "message": "refactor(compiler-cli): remove i18n options from `LinkerOptions` (#41554)\n\nThere were three options being made available to users of the linker:\n\n- ` enableI18nLegacyMessageIdFormat`\n-  `i18nNormalizeLineEndingsInICUs`\n- ` i18nUseExternalIds`\n\nNone of these should actually be configurable at linking time\nbecause partially-linked libraries have tighter restrictions on\nwhat i18n options can be used.\n\nThis commit removes those options from the `LinkerOptions` interface.\nIt was considered to add a check for backwards compatibilty to ensure\nthat if these options were being passed, and were different to the expected\ndefaults, we would throw an informative error. But from looking at the\nAngular CLI (the only known client of the linker) it has never been setting\nthese options so they have already always been set to the defaults.\n\nBREAKING CHANGE:\n\nLinked libraries no longer generate legacy i18n message ids. Any downstream\napplication that provides translations for these messages, will need to\nmigrate their message ids using the `localize-migrate` command line tool.\n\nCloses #40673\n\nPR Close #41554",
    "sha": "ba84fa6f42cc217655f18cc9631127aa49bb20a9",
    "files": [
        {
            "sha": "505791f8453291350a0a8c5cd8733ac5a2fe0ab2",
            "filename": "packages/compiler-cli/linker/src/file_linker/linker_environment.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_environment.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_environment.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_environment.ts?ref=ba84fa6f42cc217655f18cc9631127aa49bb20a9",
            "patch": "@@ -29,11 +29,6 @@ export class LinkerEnvironment<TStatement, TExpression> {\n       factory: AstFactory<TStatement, TExpression>,\n       options: Partial<LinkerOptions>): LinkerEnvironment<TStatement, TExpression> {\n     return new LinkerEnvironment(fileSystem, logger, host, factory, {\n-      enableI18nLegacyMessageIdFormat: options.enableI18nLegacyMessageIdFormat ??\n-          DEFAULT_LINKER_OPTIONS.enableI18nLegacyMessageIdFormat,\n-      i18nNormalizeLineEndingsInICUs: options.i18nNormalizeLineEndingsInICUs ??\n-          DEFAULT_LINKER_OPTIONS.i18nNormalizeLineEndingsInICUs,\n-      i18nUseExternalIds: options.i18nUseExternalIds ?? DEFAULT_LINKER_OPTIONS.i18nUseExternalIds,\n       sourceMapping: options.sourceMapping ?? DEFAULT_LINKER_OPTIONS.sourceMapping,\n       linkerJitMode: options.linkerJitMode ?? DEFAULT_LINKER_OPTIONS.linkerJitMode,\n     });"
        },
        {
            "sha": "ebef3425bb976d8cef7f76bd9b7f95952d673bd3",
            "filename": "packages/compiler-cli/linker/src/file_linker/linker_options.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_options.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_options.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_options.ts?ref=ba84fa6f42cc217655f18cc9631127aa49bb20a9",
            "patch": "@@ -10,24 +10,6 @@\n  * Options to configure the linking behavior.\n  */\n export interface LinkerOptions {\n-  /**\n-   * Whether to generate legacy i18n message ids.\n-   * The default is `true`.\n-   */\n-  enableI18nLegacyMessageIdFormat: boolean;\n-  /**\n-   * Whether to convert all line-endings in ICU expressions to `\\n` characters.\n-   * The default is `false`.\n-   */\n-  i18nNormalizeLineEndingsInICUs: boolean;\n-\n-  /**\n-   * Whether translation variable name should contain external message id\n-   * (used by Closure Compiler's output of `goog.getMsg` for transition period)\n-   * The default is `false`.\n-   */\n-  i18nUseExternalIds: boolean;\n-\n   /**\n    * Whether to use source-mapping to compute the original source for external templates.\n    * The default is `true`.\n@@ -47,9 +29,6 @@ export interface LinkerOptions {\n  * The default linker options to use if properties are not provided.\n  */\n export const DEFAULT_LINKER_OPTIONS: LinkerOptions = {\n-  enableI18nLegacyMessageIdFormat: true,\n-  i18nNormalizeLineEndingsInICUs: false,\n-  i18nUseExternalIds: false,\n   sourceMapping: true,\n   linkerJitMode: false,\n };"
        },
        {
            "sha": "633099c4aaad1acc57562f4889c44b9a391bf4ff",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_component_linker_1.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 14,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts?ref=ba84fa6f42cc217655f18cc9631127aa49bb20a9",
            "patch": "@@ -14,7 +14,6 @@ import {Range} from '../../ast/ast_host';\n import {AstObject, AstValue} from '../../ast/ast_value';\n import {FatalLinkerError} from '../../fatal_linker_error';\n import {GetSourceFileFn} from '../get_source_file';\n-import {LinkerEnvironment} from '../linker_environment';\n \n import {toR3DirectiveMeta} from './partial_directive_linker_1';\n import {PartialLinker} from './partial_linker';\n@@ -25,14 +24,7 @@ import {extractForwardRef} from './util';\n  */\n export class PartialComponentLinkerVersion1<TStatement, TExpression> implements\n     PartialLinker<TExpression> {\n-  private readonly i18nNormalizeLineEndingsInICUs =\n-      this.environment.options.i18nNormalizeLineEndingsInICUs;\n-  private readonly enableI18nLegacyMessageIdFormat =\n-      this.environment.options.enableI18nLegacyMessageIdFormat;\n-  private readonly i18nUseExternalIds = this.environment.options.i18nUseExternalIds;\n-\n   constructor(\n-      private readonly environment: LinkerEnvironment<TStatement, TExpression>,\n       private readonly getSourceFile: GetSourceFileFn, private sourceUrl: AbsoluteFsPath,\n       private code: string) {}\n \n@@ -54,17 +46,15 @@ export class PartialComponentLinkerVersion1<TStatement, TExpression> implements\n     const isInline = metaObj.has('isInline') ? metaObj.getBoolean('isInline') : false;\n     const templateInfo = this.getTemplateInfo(templateSource, isInline);\n \n-    // We always normalize line endings if the template is inline.\n-    const i18nNormalizeLineEndingsInICUs = isInline || this.i18nNormalizeLineEndingsInICUs;\n-\n     const template = parseTemplate(templateInfo.code, templateInfo.sourceUrl, {\n       escapedString: templateInfo.isEscaped,\n       interpolationConfig: interpolation,\n       range: templateInfo.range,\n-      enableI18nLegacyMessageIdFormat: this.enableI18nLegacyMessageIdFormat,\n+      enableI18nLegacyMessageIdFormat: false,\n       preserveWhitespaces:\n           metaObj.has('preserveWhitespaces') ? metaObj.getBoolean('preserveWhitespaces') : false,\n-      i18nNormalizeLineEndingsInICUs,\n+      // We normalize line endings if the template is was inline.\n+      i18nNormalizeLineEndingsInICUs: isInline,\n       isInline,\n     });\n     if (template.errors !== null) {\n@@ -141,7 +131,7 @@ export class PartialComponentLinkerVersion1<TStatement, TExpression> implements\n           ChangeDetectionStrategy.Default,\n       animations: metaObj.has('animations') ? metaObj.getOpaque('animations') : null,\n       relativeContextFilePath: this.sourceUrl,\n-      i18nUseExternalIds: this.i18nUseExternalIds,\n+      i18nUseExternalIds: false,\n       pipes,\n       directives,\n     };"
        },
        {
            "sha": "eee77d65f9036d3ee4c58793572accd98e7cfba7",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_linker_selector.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts?ref=ba84fa6f42cc217655f18cc9631127aa49bb20a9",
            "patch": "@@ -95,8 +95,7 @@ export class PartialLinkerSelector<TStatement, TExpression> {\n     const partialDirectiveLinkerVersion1 = new PartialDirectiveLinkerVersion1(sourceUrl, code);\n     const partialClassMetadataLinkerVersion1 = new PartialClassMetadataLinkerVersion1();\n     const partialComponentLinkerVersion1 = new PartialComponentLinkerVersion1(\n-        environment, createGetSourceFile(sourceUrl, code, environment.sourceFileLoader), sourceUrl,\n-        code);\n+        createGetSourceFile(sourceUrl, code, environment.sourceFileLoader), sourceUrl, code);\n     const partialFactoryLinkerVersion1 = new PartialFactoryLinkerVersion1();\n     const partialInjectableLinkerVersion1 = new PartialInjectableLinkerVersion1();\n     const partialInjectorLinkerVersion1 = new PartialInjectorLinkerVersion1();"
        },
        {
            "sha": "d1e7475e80a8419e68258f022faa87d64165d905",
            "filename": "packages/compiler-cli/test/compliance/linked/linked_compile_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts?ref=ba84fa6f42cc217655f18cc9631127aa49bb20a9",
            "patch": "@@ -32,8 +32,6 @@ function linkPartials(fileSystem: FileSystem, test: ComplianceTest): CompileResu\n   const linkerPlugin = createEs2015LinkerPlugin({\n     fileSystem,\n     logger,\n-    // By default we don't render legacy message ids in compliance tests.\n-    enableI18nLegacyMessageIdFormat: false,\n     sourceMapping: test.compilerOptions?.sourceMap === true,\n     ...test.angularCompilerOptions\n   });"
        },
        {
            "sha": "d91df4e2f65fd73a02620ab703b18c31fec56ff5",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/line_ending_normalization/TEST_CASES.json",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fline_ending_normalization%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fline_ending_normalization%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fline_ending_normalization%2FTEST_CASES.json?ref=ba84fa6f42cc217655f18cc9631127aa49bb20a9",
            "patch": "@@ -106,6 +106,9 @@\n         \"i18nNormalizeLineEndingsInICUs\": true,\n         \"enableI18nLegacyMessageIdFormat\": true\n       },\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n       \"expectations\": [\n         {\n           \"files\": [\n@@ -130,6 +133,9 @@\n         \"i18nNormalizeLineEndingsInICUs\": false,\n         \"enableI18nLegacyMessageIdFormat\": true\n       },\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n       \"expectations\": [\n         {\n           \"files\": [\n@@ -154,6 +160,9 @@\n         \"i18nNormalizeLineEndingsInICUs\": true,\n         \"enableI18nLegacyMessageIdFormat\": true\n       },\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n       \"expectations\": [\n         {\n           \"extraChecks\": [\n@@ -172,6 +181,9 @@\n         \"i18nNormalizeLineEndingsInICUs\": false,\n         \"enableI18nLegacyMessageIdFormat\": true\n       },\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n       \"expectations\": [\n         {\n           \"extraChecks\": ["
        },
        {
            "sha": "ce115a95741c5feec0650dcb7329ad10d79c3311",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/localize_legacy_message_ids/TEST_CASES.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/ba84fa6f42cc217655f18cc9631127aa49bb20a9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2FTEST_CASES.json?ref=ba84fa6f42cc217655f18cc9631127aa49bb20a9",
            "patch": "@@ -9,6 +9,9 @@\n       \"angularCompilerOptions\": {\n         \"enableI18nLegacyMessageIdFormat\": true\n       },\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n       \"expectations\": [\n         {\n           \"extraChecks\": ["
        }
    ],
    "stats": {
        "total": 64,
        "additions": 20,
        "deletions": 44
    }
}