{
    "author": "JoostK",
    "message": "fix(compiler-cli): exclude type-only imports from cycle analysis (#42453)\n\nType-only imports are known to be elided by TypeScript, so the compiler\ncan be certain that such imports do not contribute to potential import\ncycles. As such, type-only imports are no longer considered during cycle\nanalysis.\n\nRegular import statements that would eventually be fully elided by\nTypeScript during emit if none of the imported symbols are used in a\nvalue position continue to be included in the cycle analysis, as the\ncycle analyzer is unaware of these elision opportunities. Only explicit\n`import type` statements are excluded.\n\nPR Close #42453",
    "sha": "bd1836b999938fdec98dd6cbfa407d3bcf828e3c",
    "files": [
        {
            "sha": "3bd544432eeda65df58e403330d1212de8b82653",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/src/imports.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/bd1836b999938fdec98dd6cbfa407d3bcf828e3c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fimports.ts",
            "raw_url": "https://github.com/angular/angular/raw/bd1836b999938fdec98dd6cbfa407d3bcf828e3c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fimports.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fimports.ts?ref=bd1836b999938fdec98dd6cbfa407d3bcf828e3c",
            "patch": "@@ -110,6 +110,13 @@ export class ImportGraph {\n           continue;\n         }\n \n+        if (ts.isImportDeclaration(stmt) && stmt.importClause !== undefined &&\n+            stmt.importClause.isTypeOnly) {\n+          // Exclude type-only imports as they are always elided, so they don't contribute to\n+          // cycles.\n+          continue;\n+        }\n+\n         const symbol = this.checker.getSymbolAtLocation(stmt.moduleSpecifier);\n         if (symbol === undefined || symbol.valueDeclaration === undefined) {\n           // No symbol could be found to skip over this import/export."
        },
        {
            "sha": "29152580d697c0ab29ee174176dc85786c8b0383",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/test/analyzer_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/bd1836b999938fdec98dd6cbfa407d3bcf828e3c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fanalyzer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bd1836b999938fdec98dd6cbfa407d3bcf828e3c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fanalyzer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fanalyzer_spec.ts?ref=bd1836b999938fdec98dd6cbfa407d3bcf828e3c",
            "patch": "@@ -70,6 +70,17 @@ runInEachFileSystem(() => {\n       expect(cycle).toBeInstanceOf(Cycle);\n       expect(importPath(cycle!.getPath())).toEqual('b,c,b');\n     });\n+\n+    it('should not consider type-only imports', () => {\n+      const {program, analyzer} = makeAnalyzer('a:b,c!;b;c');\n+      const a = getSourceFileOrError(program, (_('/a.ts')));\n+      const b = getSourceFileOrError(program, (_('/b.ts')));\n+      const c = getSourceFileOrError(program, (_('/c.ts')));\n+      expect(analyzer.wouldCreateCycle(c, a)).toBe(null);\n+      const cycle = analyzer.wouldCreateCycle(b, a);\n+      expect(cycle).toBeInstanceOf(Cycle);\n+      expect(importPath(cycle!.getPath())).toEqual('b,a,b');\n+    });\n   });\n \n   function makeAnalyzer(graph: string): {program: ts.Program, analyzer: CycleAnalyzer} {"
        },
        {
            "sha": "67868b936e74dc23c46ef0c9cb371a30559b2551",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/test/util.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/bd1836b999938fdec98dd6cbfa407d3bcf828e3c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/bd1836b999938fdec98dd6cbfa407d3bcf828e3c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Futil.ts?ref=bd1836b999938fdec98dd6cbfa407d3bcf828e3c",
            "patch": "@@ -30,6 +30,8 @@ import {makeProgram} from '../../testing';\n  * \"a:*b,c;b;c\"\n  *\n  * represents a program where a.ts exports from b.ts and imports from c.ts.\n+ *\n+ * An import can be suffixed with ! to make it a type-only import.\n  */\n export function makeProgramFromGraph(fs: PathManipulation, graph: string): {\n   program: ts.Program,\n@@ -43,6 +45,9 @@ export function makeProgramFromGraph(fs: PathManipulation, graph: string): {\n                            if (i.startsWith('*')) {\n                              const sym = i.substr(1);\n                              return `export {${sym}} from './${sym}';`;\n+                           } else if (i.endsWith('!')) {\n+                             const sym = i.substr(0, i.length - 1);\n+                             return `import type {${sym}} from './${sym}';`;\n                            } else {\n                              return `import {${i}} from './${i}';`;\n                            }"
        },
        {
            "sha": "1145052f0ad70d04065a74c45a4c0b714672695f",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/bd1836b999938fdec98dd6cbfa407d3bcf828e3c/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bd1836b999938fdec98dd6cbfa407d3bcf828e3c/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=bd1836b999938fdec98dd6cbfa407d3bcf828e3c",
            "patch": "@@ -4846,6 +4846,41 @@ function allTests(os: string) {\n         expect(jsContents).not.toContain('setComponentScope');\n       });\n \n+      it('should not consider type-only imports during cycle detection', () => {\n+        env.write('test.ts', `\n+        import {NgModule} from '@angular/core';\n+        import {ACmp} from './a';\n+        import {BCmp} from './b';\n+\n+        @NgModule({declarations: [ACmp, BCmp]})\n+        export class Module {}\n+      `);\n+        env.write('a.ts', `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          selector: 'a-cmp',\n+          template: '<b-cmp></b-cmp>',\n+        })\n+        export class ACmp {}\n+      `);\n+        env.write('b.ts', `\n+        import {Component} from '@angular/core';\n+        import type {ACmp} from './a';\n+\n+        @Component({\n+          selector: 'b-cmp',\n+          template: 'does not use a-cmp',\n+        })\n+        export class BCmp {\n+          a: ACmp;\n+        }\n+      `);\n+        env.driveMain();\n+        const jsContents = env.getContents('test.js');\n+        expect(jsContents).not.toContain('setComponentScope');\n+      });\n+\n       it('should only pass components actually used to setComponentScope', () => {\n         env.write('test.ts', `\n           import {Component, NgModule} from '@angular/core';"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 58,
        "deletions": 0
    }
}