{
    "author": "devversion",
    "message": "fix(compiler): non-literal inline templates incorrectly processed in partial compilation (#41583)\n\nCurrently if a component defines a template inline, but not through a\nstring literal, the partial compilation references the template expression\nas is. This is problematic because the component declaration can no longer\nbe processed by the linker later as there is no static interpretation. e.g.\n\n```js\nconst myTemplate = `...`;\n\nTestCmp.ɵcmp = i0.ɵɵngDeclareComponent({\n  version: \"0.0.0-PLACEHOLDER\",\n  type: TestCmp,\n  selector: \"test-cmp\",\n  ngImport: i0,\n  template: myTemplate,\n  isInline: true\n});\n```\n\nTo fix this, we use the the resolved template in such cases so that\nthe linker can process the template/component declaration as expected.\n\nPR Close #41583",
    "sha": "62e3f3279da12f4788483d24f28b9aae416fa906",
    "files": [
        {
            "sha": "58b41105432721a6041380a9e0fec4f3ed532eb3",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=62e3f3279da12f4788483d24f28b9aae416fa906",
            "patch": "@@ -886,8 +886,8 @@ export class ComponentDecoratorHandler implements\n       content: analysis.template.content,\n       sourceUrl: analysis.template.declaration.resolvedTemplateUrl,\n       isInline: analysis.template.declaration.isInline,\n-      inlineTemplateExpression: analysis.template.declaration.isInline ?\n-          new WrappedNodeExpr(analysis.template.declaration.expression) :\n+      inlineTemplateLiteralExpression: analysis.template.sourceMapping.type === 'direct' ?\n+          new WrappedNodeExpr(analysis.template.sourceMapping.node) :\n           null,\n     };\n     const meta: R3ComponentMetadata = {...analysis.meta, ...resolution};"
        },
        {
            "sha": "c4d6e1f421d4d4b30cb36c3e7238a8baebae8170",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 74,
            "deletions": 0,
            "changes": 74,
            "blob_url": "https://github.com/angular/angular/blob/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FGOLDEN_PARTIAL.js?ref=62e3f3279da12f4788483d24f28b9aae416fa906",
            "patch": "@@ -493,3 +493,77 @@ export declare class MyModule {\n     static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: non_literal_template.js\n+ ****************************************************************************************************/\n+import { Component } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+const myTemplate = `<div *ngIf=\"show\">Hello</div>`;\n+export class TestCmp {\n+}\n+TestCmp.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: TestCmp, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+TestCmp.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: TestCmp, selector: \"test-cmp\", ngImport: i0, template: \"<div *ngIf=\\\"show\\\">Hello</div>\", isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: TestCmp, decorators: [{\n+            type: Component,\n+            args: [{ selector: 'test-cmp', template: myTemplate }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: non_literal_template.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class TestCmp {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<TestCmp, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<TestCmp, \"test-cmp\", never, {}, {}, never, never>;\n+}\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: non_literal_template_with_substitution.js\n+ ****************************************************************************************************/\n+import { Component } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+const greeting = 'Hello!';\n+const myTemplate = `<div *ngIf=\"show\">${greeting}</div>`;\n+export class TestCmp {\n+}\n+TestCmp.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: TestCmp, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+TestCmp.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: TestCmp, selector: \"test-cmp\", ngImport: i0, template: \"<div *ngIf=\\\"show\\\">Hello!</div>\", isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: TestCmp, decorators: [{\n+            type: Component,\n+            args: [{ selector: 'test-cmp', template: myTemplate }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: non_literal_template_with_substitution.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class TestCmp {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<TestCmp, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<TestCmp, \"test-cmp\", never, {}, {}, never, never>;\n+}\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: non_literal_template_with_concatenation.js\n+ ****************************************************************************************************/\n+import { Component } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+const greeting = 'Hello!';\n+const myTemplate = '<div *ngIf=\"show\">' + greeting + '</div>';\n+export class TestCmp {\n+}\n+TestCmp.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: TestCmp, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+TestCmp.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: TestCmp, selector: \"test-cmp\", ngImport: i0, template: \"<div *ngIf=\\\"show\\\">Hello!</div>\", isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: TestCmp, decorators: [{\n+            type: Component,\n+            args: [{ selector: 'test-cmp', template: myTemplate }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: non_literal_template_with_concatenation.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class TestCmp {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<TestCmp, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<TestCmp, \"test-cmp\", never, {}, {}, never, never>;\n+}\n+"
        },
        {
            "sha": "0e4f3454d77e56593a39832521e0ab3a766db1d7",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/TEST_CASES.json",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FTEST_CASES.json?ref=62e3f3279da12f4788483d24f28b9aae416fa906",
            "patch": "@@ -160,6 +160,24 @@\n           ]\n         }\n       ]\n+    },\n+    {\n+      \"description\": \"should support inline non-literal templates\",\n+      \"inputFiles\": [\n+        \"non_literal_template.ts\"\n+      ]\n+    },\n+    {\n+      \"description\": \"should support inline non-literal templates using substitution\",\n+      \"inputFiles\": [\n+        \"non_literal_template_with_substitution.ts\"\n+      ]\n+    },\n+    {\n+      \"description\": \"should support inline non-literal templates using string concatenation\",\n+      \"inputFiles\": [\n+        \"non_literal_template_with_concatenation.ts\"\n+      ]\n     }\n   ]\n }"
        },
        {
            "sha": "57cc135d9f96dc92456d1db7cf2b9f37be9fd10a",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/non_literal_template.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template.js",
            "raw_url": "https://github.com/angular/angular/raw/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template.js?ref=62e3f3279da12f4788483d24f28b9aae416fa906",
            "patch": "@@ -0,0 +1,7 @@\n+function TestCmp_div_0_Template(rf, ctx) {\n+  if (rf & 1) {\n+    i0.ɵɵelementStart(0, \"div\");\n+    i0.ɵɵtext(1, \"Hello\");\n+    i0.ɵɵelementEnd();\n+  }\n+}"
        },
        {
            "sha": "57334f636802494177c947180f17d3b6f7c24a85",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/non_literal_template.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template.ts",
            "raw_url": "https://github.com/angular/angular/raw/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template.ts?ref=62e3f3279da12f4788483d24f28b9aae416fa906",
            "patch": "@@ -0,0 +1,7 @@\n+import {Component} from '@angular/core';\n+\n+const myTemplate = `<div *ngIf=\"show\">Hello</div>`;\n+\n+@Component({selector: 'test-cmp', template: myTemplate})\n+export class TestCmp {\n+}"
        },
        {
            "sha": "196bbb7f138e0236342665e73553be37ae223769",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/non_literal_template_with_concatenation.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_concatenation.js",
            "raw_url": "https://github.com/angular/angular/raw/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_concatenation.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_concatenation.js?ref=62e3f3279da12f4788483d24f28b9aae416fa906",
            "patch": "@@ -0,0 +1,7 @@\n+function TestCmp_div_0_Template(rf, ctx) {\n+  if (rf & 1) {\n+    i0.ɵɵelementStart(0, \"div\");\n+    i0.ɵɵtext(1, \"Hello!\");\n+    i0.ɵɵelementEnd();\n+  }\n+}"
        },
        {
            "sha": "8ab665d5cf9c796a2feba9f31bc2ac056fab025f",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/non_literal_template_with_concatenation.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_concatenation.ts",
            "raw_url": "https://github.com/angular/angular/raw/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_concatenation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_concatenation.ts?ref=62e3f3279da12f4788483d24f28b9aae416fa906",
            "patch": "@@ -0,0 +1,8 @@\n+import {Component} from '@angular/core';\n+\n+const greeting = 'Hello!';\n+const myTemplate = '<div *ngIf=\"show\">' + greeting + '</div>';\n+\n+@Component({selector: 'test-cmp', template: myTemplate})\n+export class TestCmp {\n+}"
        },
        {
            "sha": "196bbb7f138e0236342665e73553be37ae223769",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/non_literal_template_with_substitution.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_substitution.js",
            "raw_url": "https://github.com/angular/angular/raw/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_substitution.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_substitution.js?ref=62e3f3279da12f4788483d24f28b9aae416fa906",
            "patch": "@@ -0,0 +1,7 @@\n+function TestCmp_div_0_Template(rf, ctx) {\n+  if (rf & 1) {\n+    i0.ɵɵelementStart(0, \"div\");\n+    i0.ɵɵtext(1, \"Hello!\");\n+    i0.ɵɵelementEnd();\n+  }\n+}"
        },
        {
            "sha": "39095dc13cf6097efb3ea619a75721ce9c11ba63",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/non_literal_template_with_substitution.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_substitution.ts",
            "raw_url": "https://github.com/angular/angular/raw/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_substitution.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fnon_literal_template_with_substitution.ts?ref=62e3f3279da12f4788483d24f28b9aae416fa906",
            "patch": "@@ -0,0 +1,8 @@\n+import {Component} from '@angular/core';\n+\n+const greeting = 'Hello!';\n+const myTemplate = `<div *ngIf=\"show\">${greeting}</div>`;\n+\n+@Component({selector: 'test-cmp', template: myTemplate})\n+export class TestCmp {\n+}"
        },
        {
            "sha": "fb620b55bd412c6b18157d3bf51690609932fa04",
            "filename": "packages/compiler/src/render3/partial/component.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 13,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/62e3f3279da12f4788483d24f28b9aae416fa906/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts?ref=62e3f3279da12f4788483d24f28b9aae416fa906",
            "patch": "@@ -42,8 +42,11 @@ export interface DeclareComponentTemplateInfo {\n    */\n   isInline: boolean;\n \n-  /** Expression that resolves to the inline template. */\n-  inlineTemplateExpression: o.Expression|null;\n+  /**\n+   * If the template was defined inline by a direct string literal, then this is that literal\n+   * expression. Otherwise `null`, if the template was not defined inline or was not a literal.\n+   */\n+  inlineTemplateLiteralExpression: o.Expression|null;\n }\n \n /**\n@@ -111,19 +114,30 @@ export function createComponentDefinitionMap(\n \n function getTemplateExpression(\n     template: ParsedTemplate, templateInfo: DeclareComponentTemplateInfo): o.Expression {\n+  // If the template has been defined using a direct literal, we use that expression directly\n+  // without any modifications. This is ensures proper source mapping from the partially\n+  // compiled code to the source file declaring the template. Note that this does not capture\n+  // template literals referenced indirectly through an identifier.\n+  if (templateInfo.inlineTemplateLiteralExpression !== null) {\n+    return templateInfo.inlineTemplateLiteralExpression;\n+  }\n+\n+  // If the template is defined inline but not through a literal, the template has been resolved\n+  // through static interpretation. We create a literal but cannot provide any source span. Note\n+  // that we cannot use the expression defining the template because the linker expects the template\n+  // to be defined as a literal in the declaration.\n   if (templateInfo.isInline) {\n-    // The template is inline so we can just reuse the current expression node.\n-    return templateInfo.inlineTemplateExpression!;\n-  } else {\n-    // The template is external so we must synthesize an expression node with the appropriate\n-    // source-span.\n-    const contents = templateInfo.content;\n-    const file = new ParseSourceFile(contents, templateInfo.sourceUrl);\n-    const start = new ParseLocation(file, 0, 0, 0);\n-    const end = computeEndLocation(file, contents);\n-    const span = new ParseSourceSpan(start, end);\n-    return o.literal(contents, null, span);\n+    return o.literal(templateInfo.content, null, null);\n   }\n+\n+  // The template is external so we must synthesize an expression node with\n+  // the appropriate source-span.\n+  const contents = templateInfo.content;\n+  const file = new ParseSourceFile(contents, templateInfo.sourceUrl);\n+  const start = new ParseLocation(file, 0, 0, 0);\n+  const end = computeEndLocation(file, contents);\n+  const span = new ParseSourceSpan(start, end);\n+  return o.literal(contents, null, span);\n }\n \n function computeEndLocation(file: ParseSourceFile, contents: string): ParseLocation {"
        }
    ],
    "stats": {
        "total": 180,
        "additions": 165,
        "deletions": 15
    }
}