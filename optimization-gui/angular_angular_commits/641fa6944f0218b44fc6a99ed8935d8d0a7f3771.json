{
    "author": "gkalpak",
    "message": "ci: re-enable the `@angular/components` unit tests (#41816)\n\nPreviously, the `components-repo-unit-tests` CI job was temporarily\ndisabled due to a version mismatch between the `rules_nodejs`\ndependency version on the two repos (angular/angular and\nangular/components).\n\nNow that both repos have been updated to a `rules_nodejs` version\n>=2.0.0, we can re-enable the job and have `@angular/components` unit\ntests run on every build.\n\nPR Close #41816",
    "sha": "641fa6944f0218b44fc6a99ed8935d8d0a7f3771",
    "files": [
        {
            "sha": "355cb72782b2b93227d02bb59dd80ad48dbc6ba9",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 11,
            "deletions": 18,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/641fa6944f0218b44fc6a99ed8935d8d0a7f3771/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/641fa6944f0218b44fc6a99ed8935d8d0a7f3771/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=641fa6944f0218b44fc6a99ed8935d8d0a7f3771",
            "patch": "@@ -36,7 +36,7 @@ var_4_win: &cache_key_win_fallback v4-angular-win-node-14-{{ checksum \"month.txt\n \n # Cache key for the `components-repo-unit-tests` job. **Note** when updating the SHA in the\n # cache keys also update the SHA for the \"COMPONENTS_REPO_COMMIT\" environment variable.\n-var_5: &components_repo_unit_tests_cache_key v1-angular-components-{{ checksum \"month.txt\" }}-09e68db8ed5b1253f2fe38ff954ef0df019fc25a\n+var_5: &components_repo_unit_tests_cache_key v1-angular-components-{{ checksum \"month.txt\" }}-7cc42f5d835b7971e9ff73e220b801cf7834d515\n var_6: &components_repo_unit_tests_cache_key_fallback v1-angular-components-{{ checksum \"month.txt\" }}\n \n # Workspace initially persisted by the `setup` job, and then enhanced by `build-npm-packages` and\n@@ -722,11 +722,7 @@ jobs:\n       - run:\n           # Run yarn install to fetch the Bazel binaries as used in the components repo.\n           name: Installing dependencies.\n-          # TODO: remove this once the repo has been updated to use NodeJS v12 and Yarn 1.19.1.\n-          # We temporarily ignore the \"engines\" because the Angular components repository has\n-          # minimum dependency on NodeJS v12 and Yarn 1.19.1, but the framework repository uses\n-          # older versions.\n-          command: yarn --ignore-engines --cwd ${COMPONENTS_REPO_TMP_DIR} install --frozen-lockfile --non-interactive --cache-folder ~/.cache/yarn\n+          command: yarn --cwd ${COMPONENTS_REPO_TMP_DIR} install --frozen-lockfile --non-interactive --cache-folder ~/.cache/yarn\n       - save_cache:\n           key: *components_repo_unit_tests_cache_key\n           paths:\n@@ -736,10 +732,14 @@ jobs:\n             - \"/tmp/angular-components-repo\"\n       - run:\n           # Updates the `angular/components` `package.json` file to refer to the release output\n-          # inside the `packages-dist` directory. Note that it's not necessary to perform a yarn\n-          # install as Bazel runs Yarn automatically when needed.\n+          # inside the `packages-dist` directory.\n           name: Setting up release packages.\n           command: node scripts/ci/update-deps-to-dist-packages.js ${COMPONENTS_REPO_TMP_DIR}/package.json dist/packages-dist/\n+      - run:\n+          # Run `yarn install` again to install the Angular packages from `packages-dist/` and update the lockfile.\n+          # NOTE: We cannot rely on Bazel to run `yarn install`, because it uses the `--frozen-lockfile` flag and fails.\n+          name: Installing local Angular packages.\n+          command: yarn --cwd ${COMPONENTS_REPO_TMP_DIR} install --non-interactive --cache-folder ~/.cache/yarn\n       - run:\n           name: \"Running `angular/components` unit tests\"\n           command: ./scripts/ci/run_angular_components_unit_tests.sh\n@@ -870,16 +870,9 @@ workflows:\n             - build-npm-packages\n             - build-ivy-npm-packages\n             - legacy-unit-tests-saucelabs\n-      # Temporarily disabled components-repo-unit-tests to update rules_nodejs to 2.0.0. Breaking changes in\n-      # rules_nodejs create a dependency sandwich between angular/angular & angular/components that are very\n-      # difficult and time consuming to resolve and involve patching @angular/bazel in components repo such\n-      # as https://github.com/angular/components/commit/9e7ba251207df77164d73d66620e619bcbc4d2ad. It is simpler to\n-      # 1) land angular/angular upgrade to rule_nodejs 2.0.0 which has breaking changes\n-      # 2) land angular/components upgrade to rules_nodejs 2.0.0 using the @angular/bazel builds snapshot\n-      # 3) update angular/angular to the landed components commit and re-enable these tests\n-      # - components-repo-unit-tests:\n-      #     requires:\n-      #       - build-npm-packages\n+      - components-repo-unit-tests:\n+          requires:\n+            - build-npm-packages\n       - test_zonejs:\n           requires:\n             - setup"
        },
        {
            "sha": "6b5cb208e110cbb9a2ab28ec3e82d22571f14931",
            "filename": ".circleci/env.sh",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/641fa6944f0218b44fc6a99ed8935d8d0a7f3771/.circleci%2Fenv.sh",
            "raw_url": "https://github.com/angular/angular/raw/641fa6944f0218b44fc6a99ed8935d8d0a7f3771/.circleci%2Fenv.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fenv.sh?ref=641fa6944f0218b44fc6a99ed8935d8d0a7f3771",
            "patch": "@@ -74,7 +74,7 @@ setPublicVar COMPONENTS_REPO_TMP_DIR \"/tmp/angular-components-repo\"\n setPublicVar COMPONENTS_REPO_URL \"https://github.com/angular/components.git\"\n setPublicVar COMPONENTS_REPO_BRANCH \"master\"\n # **NOTE**: When updating the commit SHA, also update the cache key in the CircleCI `config.yml`.\n-setPublicVar COMPONENTS_REPO_COMMIT \"09e68db8ed5b1253f2fe38ff954ef0df019fc25a\"\n+setPublicVar COMPONENTS_REPO_COMMIT \"7cc42f5d835b7971e9ff73e220b801cf7834d515\"\n \n \n ####################################################################################################"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 12,
        "deletions": 19
    }
}