{
    "author": "JounQin",
    "message": "fix(compiler-cli): fix extending angularCompilerOptions from non relative extension less TypeScript configuration files (#41349)\n\nsupport non rooted file of node package and relative path without json extension\n\nclose #41343\n\nPR Close #41349",
    "sha": "f60fb7d92b212870abf54c436e4f9ccce4c6f048",
    "files": [
        {
            "sha": "f84f0e8ab934ca4bc887a3200c2384d0bd30b31d",
            "filename": "packages/compiler-cli/src/perform_compile.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 10,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/f60fb7d92b212870abf54c436e4f9ccce4c6f048/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "raw_url": "https://github.com/angular/angular/raw/f60fb7d92b212870abf54c436e4f9ccce4c6f048/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts?ref=f60fb7d92b212870abf54c436e4f9ccce4c6f048",
            "patch": "@@ -229,13 +229,25 @@ function createParseConfigHost(host: ConfigurationHost, fs = getFileSystem()): t\n function getExtendedConfigPath(\n     configFile: string, extendsValue: string, host: ConfigurationHost,\n     fs: FileSystem): AbsoluteFsPath|null {\n-  let extendedConfigPath: AbsoluteFsPath|null = null;\n+  const result = getExtendedConfigPathWorker(configFile, extendsValue, host, fs);\n+  if (result !== null) {\n+    return result;\n+  }\n+\n+  // Try to resolve the paths with a json extension append a json extension to the file in case if\n+  // it is missing and the resolution failed. This is to replicate TypeScript behaviour, see:\n+  // https://github.com/microsoft/TypeScript/blob/294a5a7d784a5a95a8048ee990400979a6bc3a1c/src/compiler/commandLineParser.ts#L2806\n+  return getExtendedConfigPathWorker(configFile, `${extendsValue}.json`, host, fs);\n+}\n \n+function getExtendedConfigPathWorker(\n+    configFile: string, extendsValue: string, host: ConfigurationHost,\n+    fs: FileSystem): AbsoluteFsPath|null {\n   if (extendsValue.startsWith('.') || fs.isRooted(extendsValue)) {\n-    extendedConfigPath = host.resolve(host.dirname(configFile), extendsValue);\n-    extendedConfigPath = host.extname(extendedConfigPath) ?\n-        extendedConfigPath :\n-        absoluteFrom(`${extendedConfigPath}.json`);\n+    const extendedConfigPath = host.resolve(host.dirname(configFile), extendsValue);\n+    if (host.exists(extendedConfigPath)) {\n+      return extendedConfigPath;\n+    }\n   } else {\n     const parseConfigHost = createParseConfigHost(host, fs);\n \n@@ -248,16 +260,13 @@ function getExtendedConfigPath(\n             {moduleResolution: ts.ModuleResolutionKind.NodeJs, resolveJsonModule: true},\n             parseConfigHost);\n     if (resolvedModule) {\n-      extendedConfigPath = absoluteFrom(resolvedModule.resolvedFileName);\n+      return absoluteFrom(resolvedModule.resolvedFileName);\n     }\n   }\n \n-  if (extendedConfigPath !== null && host.exists(extendedConfigPath)) {\n-    return extendedConfigPath;\n-  }\n-\n   return null;\n }\n+\n export interface PerformCompilationResult {\n   diagnostics: Diagnostics;\n   program?: api.Program;"
        },
        {
            "sha": "1fbce64926df8ff04d1706feb9a1b84c06803db5",
            "filename": "packages/compiler-cli/test/perform_compile_spec.ts",
            "status": "modified",
            "additions": 59,
            "deletions": 1,
            "changes": 60,
            "blob_url": "https://github.com/angular/angular/blob/f60fb7d92b212870abf54c436e4f9ccce4c6f048/packages%2Fcompiler-cli%2Ftest%2Fperform_compile_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f60fb7d92b212870abf54c436e4f9ccce4c6f048/packages%2Fcompiler-cli%2Ftest%2Fperform_compile_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fperform_compile_spec.ts?ref=f60fb7d92b212870abf54c436e4f9ccce4c6f048",
            "patch": "@@ -103,7 +103,7 @@ describe('perform_compile', () => {\n     }));\n   });\n \n-  it('should merge tsconfig \"angularCompilerOptions\" when extends point to node package', () => {\n+  it('should merge tsconfig \"angularCompilerOptions\" when extends points to node package', () => {\n     support.writeFiles({\n       'tsconfig-level-1.json': `{\n           \"extends\": \"@angular-ru/tsconfig\",\n@@ -136,4 +136,62 @@ describe('perform_compile', () => {\n       enableIvy: false,\n     }));\n   });\n+\n+  it('should merge tsconfig \"angularCompilerOptions\" when extends points to an extension less non rooted file',\n+     () => {\n+       support.writeFiles({\n+         'tsconfig-level-1.json': `{\n+            \"extends\": \"@1stg/tsconfig/angular\",\n+            \"angularCompilerOptions\": {\n+              \"enableIvy\": false\n+            }\n+          }`,\n+         'node_modules/@1stg/tsconfig/angular.json': `{\n+            \"compilerOptions\": {\n+              \"strict\": true\n+            },\n+            \"angularCompilerOptions\": {\n+              \"skipMetadataEmit\": true\n+            }\n+          }`,\n+         'node_modules/@1stg/tsconfig/package.json': `{\n+            \"name\": \"@1stg/tsconfig\",\n+            \"version\": \"0.0.0\"\n+          }`,\n+       });\n+\n+       const {options} = readConfiguration(path.resolve(basePath, 'tsconfig-level-1.json'));\n+       expect(options).toEqual(jasmine.objectContaining({\n+         strict: true,\n+         skipMetadataEmit: true,\n+         enableIvy: false,\n+       }));\n+     });\n+\n+  it('should merge tsconfig \"angularCompilerOptions\" when extends points to a non rooted file without json extension',\n+     () => {\n+       support.writeFiles({\n+         'tsconfig-level-1.json': `{\n+            \"extends\": \"./tsconfig.app\",\n+            \"angularCompilerOptions\": {\n+              \"enableIvy\": false\n+            }\n+          }`,\n+         'tsconfig.app.json': `{\n+            \"compilerOptions\": {\n+              \"strict\": true\n+            },\n+            \"angularCompilerOptions\": {\n+              \"skipMetadataEmit\": true\n+            }\n+          }`,\n+       });\n+\n+       const {options} = readConfiguration(path.resolve(basePath, 'tsconfig-level-1.json'));\n+       expect(options).toEqual(jasmine.objectContaining({\n+         strict: true,\n+         skipMetadataEmit: true,\n+         enableIvy: false,\n+       }));\n+     });\n });"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 78,
        "deletions": 11
    }
}