{
    "author": "kyliau",
    "message": "fix(language-service): use single entry point for Ivy and View Engine (#40967)\n\nCurrently there are two entry points for the `@angular/language-service`\npackage:\n\n- `@angular/language-service`\n  This default entry point is for View Engine LS. Through the redirection\n  of `main` field in `package.json`, it resolves to\n  `./bundles/language-service.js`.\n- `@angular/language-service/bundles/ivy.js`\n  This secondary entry point is for Ivy LS.\n\nTypeScript recently changed the behavior of tsserver to allow only package\nnames as plugin names [1] for security reasons. This means the secondary\nentry point for Ivy LS can no longer be used.\nWe implemented a quick hack in the module resolver (in the extension repo)\nto fix this, but the long term fix should be in `@angular/language-service`.\n\nHere, the `main` field in `package.json` is changed to `index.js`, and in the\nindex file we conditionally load View Engine or Ivy based on the input config.\nThis eliminates the need for multiple entry points.\n\nAs part of this PR, I also removed all source code for View Engine and Ivy\nincluded in the NPM package. Consumers of this package should run the bundled\noutput and nothing else. This would help us prevent an accidental import that\nresults in execution of unbundled code.\n\n[1]: https://github.com/microsoft/TypeScript/pull/42713\n\nPR Close #40967",
    "sha": "e986a9787b7787c3cffef69d06a2e7e1228e3f40",
    "files": [
        {
            "sha": "3379d4e4f7f883cb04685cfa6d5ef0b7b5a82d3b",
            "filename": "packages/language-service/BUILD.bazel",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/e986a9787b7787c3cffef69d06a2e7e1228e3f40/packages%2Flanguage-service%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e986a9787b7787c3cffef69d06a2e7e1228e3f40/packages%2Flanguage-service%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2FBUILD.bazel?ref=e986a9787b7787c3cffef69d06a2e7e1228e3f40",
            "patch": "@@ -6,15 +6,17 @@ ts_library(\n     name = \"api\",\n     srcs = [\n         \"api.ts\",\n+        \"index.ts\",\n     ],\n     deps = [\n+        \"@npm//@types/node\",\n         \"@npm//typescript\",\n     ],\n )\n \n ts_library(\n     name = \"language-service\",\n-    srcs = [\"index.ts\"] + glob(\n+    srcs = glob(\n         [\n             \"src/**/*.ts\",\n         ],\n@@ -54,8 +56,7 @@ pkg_npm(\n         \"//integration:__pkg__\",\n     ],\n     deps = [\n-        \":language-service\",\n-        \"//packages/language-service/ivy\",\n+        \":api\",\n         # min bundle is not used at the moment; omit from package to speed up build\n         \"//packages/language-service/bundles:language-service.js\",\n         \"//packages/language-service/bundles:ivy.js\","
        },
        {
            "sha": "a78f3173e450e21464db5e66987e576c0336bc77",
            "filename": "packages/language-service/api.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/e986a9787b7787c3cffef69d06a2e7e1228e3f40/packages%2Flanguage-service%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/e986a9787b7787c3cffef69d06a2e7e1228e3f40/packages%2Flanguage-service%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fapi.ts?ref=e986a9787b7787c3cffef69d06a2e7e1228e3f40",
            "patch": "@@ -14,6 +14,19 @@\n \n import * as ts from 'typescript';\n \n+export interface NgLanguageServiceConfig {\n+  /**\n+   * If true, return only Angular results. Otherwise, return Angular + TypeScript\n+   * results.\n+   */\n+  angularOnly: boolean;\n+  /**\n+   * If true, return factory function for Ivy LS during plugin initialization.\n+   * Otherwise return factory function for View Engine LS.\n+   */\n+  ivy: boolean;\n+}\n+\n export type GetTcbResponse = {\n   /**\n    * The filename of the SourceFile this typecheck block belongs to."
        },
        {
            "sha": "08e47e0d3833ed5fc9d5d5f00fb267e4e40c75b8",
            "filename": "packages/language-service/bundles/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/e986a9787b7787c3cffef69d06a2e7e1228e3f40/packages%2Flanguage-service%2Fbundles%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e986a9787b7787c3cffef69d06a2e7e1228e3f40/packages%2Flanguage-service%2Fbundles%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fbundles%2FBUILD.bazel?ref=e986a9787b7787c3cffef69d06a2e7e1228e3f40",
            "patch": "@@ -3,7 +3,7 @@ load(\"//dev-infra/benchmark/ng_rollup_bundle:ng_rollup_bundle.bzl\", \"ng_rollup_b\n ng_rollup_bundle(\n     name = \"language-service\",\n     build_optimizer = False,\n-    entry_point = \"//packages/language-service:index.ts\",\n+    entry_point = \"//packages/language-service:src/ts_plugin.ts\",\n     format = \"amd\",\n     globals = {\n         \"fs\": \"fs\","
        },
        {
            "sha": "07a78428c559747391a9be4248a3742dfcd94dcf",
            "filename": "packages/language-service/index.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 1,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/e986a9787b7787c3cffef69d06a2e7e1228e3f40/packages%2Flanguage-service%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/e986a9787b7787c3cffef69d06a2e7e1228e3f40/packages%2Flanguage-service%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Findex.ts?ref=e986a9787b7787c3cffef69d06a2e7e1228e3f40",
            "patch": "@@ -6,5 +6,33 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import * as ts from 'typescript/lib/tsserverlibrary';\n+import {NgLanguageService, NgLanguageServiceConfig} from './api';\n+\n export * from './api';\n-export {create, getExternalFiles} from './src/ts_plugin';\n+\n+interface PluginModule extends ts.server.PluginModule {\n+  create(createInfo: ts.server.PluginCreateInfo): NgLanguageService;\n+  onConfigurationChanged?(config: NgLanguageServiceConfig): void;\n+}\n+\n+const factory: ts.server.PluginModuleFactory = (tsModule): PluginModule => {\n+  let plugin: PluginModule;\n+\n+  return {\n+    create(info: ts.server.PluginCreateInfo): NgLanguageService {\n+      const config: NgLanguageServiceConfig = info.config;\n+      const bundleName = config.ivy ? 'ivy.js' : 'language-service.js';\n+      plugin = require(`./bundles/${bundleName}`)(tsModule);\n+      return plugin.create(info);\n+    },\n+    getExternalFiles(project: ts.server.Project): string[] {\n+      return plugin?.getExternalFiles?.(project) ?? [];\n+    },\n+    onConfigurationChanged(config: NgLanguageServiceConfig): void {\n+      plugin?.onConfigurationChanged?.(config);\n+    },\n+  };\n+};\n+\n+module.exports = factory;"
        },
        {
            "sha": "6bb933885dae8d3010c82281be98807e5a45033f",
            "filename": "packages/language-service/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/e986a9787b7787c3cffef69d06a2e7e1228e3f40/packages%2Flanguage-service%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/e986a9787b7787c3cffef69d06a2e7e1228e3f40/packages%2Flanguage-service%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fpackage.json?ref=e986a9787b7787c3cffef69d06a2e7e1228e3f40",
            "patch": "@@ -2,7 +2,7 @@\n   \"name\": \"@angular/language-service\",\n   \"version\": \"0.0.0-PLACEHOLDER\",\n   \"description\": \"Angular - language services\",\n-  \"main\": \"./bundles/language-service.js\",\n+  \"main\": \"./index.js\",\n   \"typings\": \"./index.d.ts\",\n   \"author\": \"angular\",\n   \"license\": \"MIT\","
        }
    ],
    "stats": {
        "total": 54,
        "additions": 48,
        "deletions": 6
    }
}