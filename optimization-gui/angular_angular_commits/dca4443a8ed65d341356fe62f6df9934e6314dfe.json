{
    "author": "dgp1130",
    "message": "fix(compiler-cli): mark eager `NgModuleFactory` construction as not side effectful (#38320)\n\nRoll forward of #38147.\n\nThis allows Closure compiler to tree shake unused constructor calls to `NgModuleFactory`, which is otherwise considered\nside-effectful. The Angular compiler generates factory objects which are exported but typically not used, as they are\nonly needed for compatibility with View Engine. This results in top-level constructor calls, such as:\n\n```typescript\nexport const FooNgFactory = new NgModuleFactory(Foo);\n```\n\n`NgModuleFactory` has a side-effecting constructor, so this statement cannot be tree shaken, even if `FooNgFactory` is\nnever imported. The `NgModuleFactory` continues to reference its associated `NgModule` and prevents the module and all\nits unused dependencies from being tree shaken, making Closure builds significantly larger than necessary.\n\nThe fix here is to wrap `NgModuleFactory` constructor with `noSideEffects(() => /* ... */)`, which tricks the Closure\ncompiler into assuming that the invoked function has no side effects. This allows it to tree-shake unused\n`NgModuleFactory()` constructors when they aren't imported. Since the factory can be removed, the module can also be\nremoved (if nothing else references it), thus tree shaking unused dependencies as expected.\n\nThe one notable edge case is for lazy loaded modules. Internally, lazy loading is done as a side effect when the lazy\nscript is evaluated. For Angular, this side effect is registering the `NgModule`. In Ivy this is done by the\n`NgModuleFactory` constructor, so lazy loaded modules **cannot** have their top-level `NgModuleFactory` constructor\ncall tree shaken. We handle this case by looking for the `id` field on `@NgModule` annotations. All lazy loaded modules\ninclude an `id`. When this `id` is found, the `NgModuleFactory` is generated **without** with `noSideEffects()` call,\nso Closure will not tree shake it and the module will lazy-load correctly.\n\nPR Close #38320",
    "sha": "dca4443a8ed65d341356fe62f6df9934e6314dfe",
    "files": [
        {
            "sha": "115a9e736103a6527ba026bc9a8efbaa7335239e",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/ng_module.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/dca4443a8ed65d341356fe62f6df9934e6314dfe/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/dca4443a8ed65d341356fe62f6df9934e6314dfe/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts?ref=dca4443a8ed65d341356fe62f6df9934e6314dfe",
            "patch": "@@ -309,7 +309,7 @@ export class NgModuleDecoratorHandler implements\n     if (this.factoryTracker !== null) {\n       this.factoryTracker.track(node.getSourceFile(), {\n         name: analysis.factorySymbolName,\n-        hasId: !!analysis.id,\n+        hasId: analysis.id !== null,\n       });\n     }\n "
        },
        {
            "sha": "4ee78ec5138b5e637fbf97edb16c962619ec88a3",
            "filename": "packages/compiler-cli/src/ngtsc/shims/src/factory_generator.ts",
            "status": "modified",
            "additions": 77,
            "deletions": 2,
            "changes": 79,
            "blob_url": "https://github.com/angular/angular/blob/dca4443a8ed65d341356fe62f6df9934e6314dfe/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fshims%2Fsrc%2Ffactory_generator.ts",
            "raw_url": "https://github.com/angular/angular/raw/dca4443a8ed65d341356fe62f6df9934e6314dfe/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fshims%2Fsrc%2Ffactory_generator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fshims%2Fsrc%2Ffactory_generator.ts?ref=dca4443a8ed65d341356fe62f6df9934e6314dfe",
            "patch": "@@ -186,8 +186,24 @@ function transformFactorySourceFile(\n \n         // Otherwise, check if this export is a factory for a known NgModule, and retain it if so.\n         const match = STRIP_NG_FACTORY.exec(decl.name.text);\n-        if (match !== null && moduleSymbols.has(match[1])) {\n-          transformedStatements.push(stmt);\n+        const module = match ? moduleSymbols.get(match[1]) : null;\n+        if (module) {\n+          // If the module can be tree shaken, then the factory should be wrapped in a\n+          // `noSideEffects()` call which tells Closure to treat the expression as pure, allowing\n+          // it to be removed if the result is not used.\n+          //\n+          // `NgModule`s with an `id` property will be lazy loaded. Google-internal lazy loading\n+          // infra relies on a side effect from the `new NgModuleFactory()` call, which registers\n+          // the module globally. Because of this, we **cannot** tree shake any module which has\n+          // an `id` property. Doing so would cause lazy loaded modules to never be registered.\n+          const moduleIsTreeShakable = !module.hasId;\n+          const newStmt = !moduleIsTreeShakable ?\n+              stmt :\n+              updateInitializers(\n+                  stmt,\n+                  (init) => init ? wrapInNoSideEffects(init) : undefined,\n+              );\n+          transformedStatements.push(newStmt);\n         }\n       } else {\n         // Leave the statement alone, as it can't be understood.\n@@ -266,3 +282,62 @@ function getFileoverviewComment(sourceFile: ts.SourceFile): string|null {\n \n   return commentText;\n }\n+\n+/**\n+ * Wraps the given expression in a call to `ɵnoSideEffects()`, which tells\n+ * Closure we don't care about the side effects of this expression and it should\n+ * be treated as \"pure\". Closure is free to tree shake this expression if its\n+ * result is not used.\n+ *\n+ * Example: Takes `1 + 2` and returns `i0.ɵnoSideEffects(() => 1 + 2)`.\n+ */\n+function wrapInNoSideEffects(expr: ts.Expression): ts.Expression {\n+  const noSideEffects = ts.createPropertyAccess(\n+      ts.createIdentifier('i0'),\n+      'ɵnoSideEffects',\n+  );\n+\n+  return ts.createCall(\n+      noSideEffects,\n+      /* typeArguments */[],\n+      /* arguments */\n+      [\n+        ts.createFunctionExpression(\n+            /* modifiers */[],\n+            /* asteriskToken */ undefined,\n+            /* name */ undefined,\n+            /* typeParameters */[],\n+            /* parameters */[],\n+            /* type */ undefined,\n+            /* body */ ts.createBlock([\n+              ts.createReturn(expr),\n+            ]),\n+            ),\n+      ],\n+  );\n+}\n+\n+/**\n+ * Clones and updates the initializers for a given statement to use the new\n+ * expression provided. Does not mutate the input statement.\n+ */\n+function updateInitializers(\n+    stmt: ts.VariableStatement,\n+    update: (initializer?: ts.Expression) => ts.Expression | undefined,\n+    ): ts.VariableStatement {\n+  return ts.updateVariableStatement(\n+      stmt,\n+      stmt.modifiers,\n+      ts.updateVariableDeclarationList(\n+          stmt.declarationList,\n+          stmt.declarationList.declarations.map(\n+              (decl) => ts.updateVariableDeclaration(\n+                  decl,\n+                  decl.name,\n+                  decl.type,\n+                  update(decl.initializer),\n+                  ),\n+              ),\n+          ),\n+  );\n+}"
        },
        {
            "sha": "5ae96b6e5c13f8bcc11701da70b3b755d9ad4259",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 6,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/dca4443a8ed65d341356fe62f6df9934e6314dfe/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/dca4443a8ed65d341356fe62f6df9934e6314dfe/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=dca4443a8ed65d341356fe62f6df9934e6314dfe",
            "patch": "@@ -3538,7 +3538,9 @@ runInEachFileSystem(os => {\n       expect(factoryContents).toContain(`import * as i0 from '@angular/core';`);\n       expect(factoryContents).toContain(`import { NotAModule, TestModule } from './test';`);\n       expect(factoryContents)\n-          .toContain(`export var TestModuleNgFactory = new i0.\\u0275NgModuleFactory(TestModule);`);\n+          .toContain(\n+              'export var TestModuleNgFactory = i0.\\u0275noSideEffects(function () { ' +\n+              'return new i0.\\u0275NgModuleFactory(TestModule); });');\n       expect(factoryContents).not.toContain(`NotAModuleNgFactory`);\n       expect(factoryContents).not.toContain('\\u0275NonEmptyModule');\n \n@@ -3677,11 +3679,32 @@ runInEachFileSystem(os => {\n         env.driveMain();\n \n         const factoryContents = env.getContents('test.ngfactory.js');\n-        expect(normalize(factoryContents)).toBe(normalize(`\n-        import * as i0 from \"./r3_symbols\";\n-        import { TestModule } from './test';\n-        export var TestModuleNgFactory = new i0.NgModuleFactory(TestModule);\n-      `));\n+        expect(factoryContents)\n+            .toBe(\n+                'import * as i0 from \"./r3_symbols\";\\n' +\n+                'import { TestModule } from \\'./test\\';\\n' +\n+                'export var TestModuleNgFactory = i0.\\u0275noSideEffects(function () {' +\n+                ' return new i0.NgModuleFactory(TestModule); });\\n');\n+      });\n+\n+      it('should generate side effectful NgModuleFactory constructor when lazy loaded', () => {\n+        env.tsconfig({'allowEmptyCodegenFiles': true});\n+\n+        env.write('test.ts', `\n+          import {NgModule} from '@angular/core';\n+\n+          @NgModule({\n+            id: 'test', // ID to use for lazy loading.\n+          })\n+          export class TestModule {}\n+        `);\n+\n+        env.driveMain();\n+\n+        // Should **not** contain noSideEffects(), because the module is lazy loaded.\n+        const factoryContents = env.getContents('test.ngfactory.js');\n+        expect(factoryContents)\n+            .toContain('export var TestModuleNgFactory = new i0.ɵNgModuleFactory(TestModule);');\n       });\n \n       describe('file-level comments', () => {"
        }
    ],
    "stats": {
        "total": 116,
        "additions": 107,
        "deletions": 9
    }
}