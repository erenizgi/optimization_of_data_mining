{
    "author": "gkalpak",
    "message": "test(docs-infra): correctly test URL redirects when the destination URL is also redirected (#42018)\n\nSince #41625, `/guide/updating-to-version-10` is being redirected to\n`https://v11.angular.io/guide/updating-to-version-11`. However,\n`v11.angular.io` itself is being redirected to `angular.io`, while v11\nis the latest stable version. As a result,\n`/guide/updating-to-version-10` ends up being redirected to\n`https://angular.io/guide/updating-to-version-11`. Currently, this\ncauses a CI failure in the `aio_monidoting` job ([example failure][1]).\n\nThis will change once v12 is released as the new stable version.\nAlternatively, we could update the config and tests to expected\n`/guide/updating-to-version-10` to be redirected to\n`https://angular.io/guide/updating-to-version-11`, but that would end up\nbeing redirected to `https://angular.io/guide/updating-to-version-12`\nonce v12 would be released, which is different behavior.\n\nThis commit provides a way to test for redirects when the destination\nURL is itself redirected to a different URL. This allows us to use the\nintended URL (for example, `https://v11.angular.io/...`), which will\ncontinue to work as expected regardless of what is the latest stable\nversion without causing CI failures.\n\n[1]: https://circleci.com/gh/angular/angular/983738\n\nPR Close #42018",
    "sha": "04ab5edf651d252b76496c18f4b969762aaaa724",
    "files": [
        {
            "sha": "7b64b968e7a2502f76b6df4ea0352a7e941756d1",
            "filename": "aio/tests/deployment/e2e/redirection.e2e-spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/04ab5edf651d252b76496c18f4b969762aaaa724/aio%2Ftests%2Fdeployment%2Fe2e%2Fredirection.e2e-spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/04ab5edf651d252b76496c18f4b969762aaaa724/aio%2Ftests%2Fdeployment%2Fe2e%2Fredirection.e2e-spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftests%2Fdeployment%2Fe2e%2Fredirection.e2e-spec.ts?ref=04ab5edf651d252b76496c18f4b969762aaaa724",
            "patch": "@@ -34,9 +34,20 @@ describe(browser.baseUrl, () => {\n       it(`should redirect '${fromUrl}' to '${toUrl}' (${i + 1}/${page.legacyUrls.length})`, async () => {\n         await page.goTo(fromUrl);\n \n-        const expectedUrl = stripTrailingSlash(/^https?:/.test(toUrl) ? toUrl : page.baseUrl + toUrl);\n+        let expectedUrl = stripTrailingSlash(/^https?:/.test(toUrl) ? toUrl : page.baseUrl + toUrl);\n         const actualUrl = await getCurrentUrl();\n \n+        if (actualUrl !== expectedUrl) {\n+          // If the actual URL does not match the expected URL, check whether the expected URL\n+          // itself is also redirected to the actual URL.\n+          await page.goTo(expectedUrl);\n+          const redirectedExpectedUrl = await getCurrentUrl();\n+\n+          if (actualUrl === redirectedExpectedUrl) {\n+            expectedUrl = redirectedExpectedUrl;\n+          }\n+        }\n+\n         expect(actualUrl).toBe(expectedUrl);\n       }, 120000);\n     });"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 12,
        "deletions": 1
    }
}