{
    "author": "kyliau",
    "message": "fix(language-service): hybrid visitor returns parent node of BoundAttribute (#38995)\n\nFor the following example, the cursor is between `keySpan` and `valueSpan`\nof the `BoundAttribute`.\n```html\n<test-cmp [foo]¦=\"bar\"></test-cmp>\n```\nOur hybrid visitor will return `Element`in this case, which is the parent\nnode of the `BoundAttribute`.\nThis is because we only look at the `keySpan` and `valueSpan`, and not\nthe source span. The last element in the AST path is `Element`, so it gets\nreturned.\n\nIn this PR, I propose fixing this by adding a sentinel value `undefined`\nto the AST path to signal that we've found a source span but the cursor is\nneither in the key span nor the value span.\n\nPR Close #38995",
    "sha": "323be39297450fa5a4a70f800511722b4964dec2",
    "files": [
        {
            "sha": "1dec2486ad74d22daf3edce60761765bfe517d9c",
            "filename": "packages/language-service/ivy/hybrid_visitor.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 13,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/323be39297450fa5a4a70f800511722b4964dec2/packages%2Flanguage-service%2Fivy%2Fhybrid_visitor.ts",
            "raw_url": "https://github.com/angular/angular/raw/323be39297450fa5a4a70f800511722b4964dec2/packages%2Flanguage-service%2Fivy%2Fhybrid_visitor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fhybrid_visitor.ts?ref=323be39297450fa5a4a70f800511722b4964dec2",
            "patch": "@@ -19,7 +19,19 @@ import * as t from '@angular/compiler/src/render3/r3_ast';         // t for temp\n export function findNodeAtPosition(ast: t.Node[], position: number): t.Node|e.AST|undefined {\n   const visitor = new R3Visitor(position);\n   visitor.visitAll(ast);\n-  return visitor.path[visitor.path.length - 1];\n+  const candidate = visitor.path[visitor.path.length - 1];\n+  if (!candidate) {\n+    return;\n+  }\n+  if (isTemplateNodeWithKeyAndValue(candidate)) {\n+    const {keySpan, valueSpan} = candidate;\n+    // If cursor is within source span but not within key span or value span,\n+    // do not return the node.\n+    if (!isWithin(position, keySpan) && (valueSpan && !isWithin(position, valueSpan))) {\n+      return;\n+    }\n+  }\n+  return candidate;\n }\n \n class R3Visitor implements t.Visitor {\n@@ -31,11 +43,6 @@ class R3Visitor implements t.Visitor {\n   constructor(private readonly position: number) {}\n \n   visit(node: t.Node) {\n-    if (node instanceof t.BoundAttribute) {\n-      node.visit(this);\n-      return;\n-    }\n-\n     const {start, end} = getSpanIncludingEndTag(node);\n     if (isWithin(this.position, {start, end})) {\n       const length = end - start;\n@@ -100,13 +107,8 @@ class R3Visitor implements t.Visitor {\n   }\n \n   visitBoundAttribute(attribute: t.BoundAttribute) {\n-    if (isWithin(this.position, attribute.keySpan)) {\n-      this.path.push(attribute);\n-    } else if (attribute.valueSpan && isWithin(this.position, attribute.valueSpan)) {\n-      this.path.push(attribute);\n-      const visitor = new ExpressionVisitor(this.position);\n-      visitor.visit(attribute.value, this.path);\n-    }\n+    const visitor = new ExpressionVisitor(this.position);\n+    visitor.visit(attribute.value, this.path);\n   }\n \n   visitBoundEvent(attribute: t.BoundEvent) {\n@@ -166,6 +168,15 @@ export function isTemplateNode(node: t.Node|e.AST): node is t.Node {\n   return node.sourceSpan instanceof ParseSourceSpan;\n }\n \n+interface NodeWithKeyAndValue extends t.Node {\n+  keySpan: ParseSourceSpan;\n+  valueSpan?: ParseSourceSpan;\n+}\n+\n+export function isTemplateNodeWithKeyAndValue(node: t.Node|e.AST): node is NodeWithKeyAndValue {\n+  return isTemplateNode(node) && node.hasOwnProperty('keySpan');\n+}\n+\n export function isExpressionNode(node: t.Node|e.AST): node is e.AST {\n   return node instanceof e.AST;\n }"
        },
        {
            "sha": "36504d389bd3bff82796bd6bbbfc305210cce932",
            "filename": "packages/language-service/ivy/test/hybrid_visitor_spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/323be39297450fa5a4a70f800511722b4964dec2/packages%2Flanguage-service%2Fivy%2Ftest%2Fhybrid_visitor_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/323be39297450fa5a4a70f800511722b4964dec2/packages%2Flanguage-service%2Fivy%2Ftest%2Fhybrid_visitor_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fhybrid_visitor_spec.ts?ref=323be39297450fa5a4a70f800511722b4964dec2",
            "patch": "@@ -97,6 +97,13 @@ describe('findNodeAtPosition for template AST', () => {\n     expect(node).toBeInstanceOf(e.PropertyRead);\n   });\n \n+  it('should not locate bound attribute if cursor is between key and value', () => {\n+    const {errors, nodes, position} = parse(`<test-cmp [foo]¦=\"bar\"></test-cmp>`);\n+    expect(errors).toBeNull();\n+    const node = findNodeAtPosition(nodes, position);\n+    expect(node).toBeUndefined();\n+  });\n+\n   it('should locate bound event key', () => {\n     const {errors, nodes, position} = parse(`<test-cmp (fo¦o)=\"bar()\"></test-cmp>`);\n     expect(errors).toBe(null);"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 31,
        "deletions": 13
    }
}