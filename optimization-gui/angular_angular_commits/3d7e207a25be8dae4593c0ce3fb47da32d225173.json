{
    "author": "josephperrott",
    "message": "fix(dev-infra): detect multiple target labels as invalid (#40156)\n\nWhen multiple target labels are applied to a PR, it should be considered\ninvalid as our tooling does not support a single PR targetting multiple\ntrains/versions.\n\nPR Close #40156",
    "sha": "3d7e207a25be8dae4593c0ce3fb47da32d225173",
    "files": [
        {
            "sha": "6f8e17082f5bb6216bf21475b0985bfdf8072bb2",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 30,
            "deletions": 16,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=3d7e207a25be8dae4593c0ce3fb47da32d225173",
            "patch": "@@ -2782,21 +2782,21 @@ var InvalidTargetLabelError = /** @class */ (function () {\n /** Gets the target label from the specified pull request labels. */\n function getTargetLabelFromPullRequest(config, labels) {\n     var e_1, _a;\n+    /** List of discovered target labels for the PR. */\n+    var matches = [];\n     var _loop_1 = function (label) {\n         var match = config.labels.find(function (_a) {\n             var pattern = _a.pattern;\n             return matchesPattern(label, pattern);\n         });\n         if (match !== undefined) {\n-            return { value: match };\n+            matches.push(match);\n         }\n     };\n     try {\n         for (var labels_1 = tslib.__values(labels), labels_1_1 = labels_1.next(); !labels_1_1.done; labels_1_1 = labels_1.next()) {\n             var label = labels_1_1.value;\n-            var state_1 = _loop_1(label);\n-            if (typeof state_1 === \"object\")\n-                return state_1.value;\n+            _loop_1(label);\n         }\n     }\n     catch (e_1_1) { e_1 = { error: e_1_1 }; }\n@@ -2806,7 +2806,13 @@ function getTargetLabelFromPullRequest(config, labels) {\n         }\n         finally { if (e_1) throw e_1.error; }\n     }\n-    return null;\n+    if (matches.length === 1) {\n+        return matches[0];\n+    }\n+    if (matches.length === 0) {\n+        throw new InvalidTargetLabelError('Unable to determine target for the PR as it has no target label.');\n+    }\n+    throw new InvalidTargetLabelError('Unable to determine target for the PR as it has multiple target labels.');\n }\n /**\n  * Gets the branches from the specified target label.\n@@ -2862,11 +2868,17 @@ function getTargetBranchesForPr(prNumber) {\n         /** The branch targetted via the Github UI. */\n         const githubTargetBranch = prData.base.ref;\n         /** The active label which is being used for targetting the PR. */\n-        const targetLabel = getTargetLabelFromPullRequest(mergeConfig, labels);\n-        if (targetLabel === null) {\n-            error(red(`No target label was found on pr #${prNumber}`));\n-            process.exitCode = 1;\n-            return;\n+        let targetLabel;\n+        try {\n+            targetLabel = getTargetLabelFromPullRequest(mergeConfig, labels);\n+        }\n+        catch (e) {\n+            if (e instanceof InvalidTargetLabelError) {\n+                error(red(e.failureMessage));\n+                process.exitCode = 1;\n+                return;\n+            }\n+            throw e;\n         }\n         /** The target branches based on the target label and branch targetted in the Github UI. */\n         return yield getBranchesFromTargetLabel(targetLabel, githubTargetBranch);\n@@ -3333,9 +3345,6 @@ var PullRequestFailure = /** @class */ (function () {\n     PullRequestFailure.notMergeReady = function () {\n         return new this(\"Not marked as merge ready.\");\n     };\n-    PullRequestFailure.noTargetLabel = function () {\n-        return new this(\"No target branch could be determined. Please ensure a target label is set.\");\n-    };\n     PullRequestFailure.mismatchingTargetBranch = function (allowedBranches) {\n         return new this(\"Pull request is set to wrong base branch. Please update the PR in the Github UI \" +\n             (\"to one of the following branches: \" + allowedBranches.join(', ') + \".\"));\n@@ -3413,9 +3422,14 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n                     if (!labels.some(function (name) { return matchesPattern(name, config.claSignedLabel); })) {\n                         return [2 /*return*/, PullRequestFailure.claUnsigned()];\n                     }\n-                    targetLabel = getTargetLabelFromPullRequest(config, labels);\n-                    if (targetLabel === null) {\n-                        return [2 /*return*/, PullRequestFailure.noTargetLabel()];\n+                    try {\n+                        targetLabel = getTargetLabelFromPullRequest(config, labels);\n+                    }\n+                    catch (error) {\n+                        if (error instanceof InvalidTargetLabelError) {\n+                            return [2 /*return*/, new PullRequestFailure(error.failureMessage)];\n+                        }\n+                        throw error;\n                     }\n                     return [4 /*yield*/, git.github.repos.getCombinedStatusForRef(tslib.__assign(tslib.__assign({}, git.remoteParams), { ref: prData.head.sha }))];\n                 case 2:"
        },
        {
            "sha": "09b96f435cb1ae883d0924f042557eb09b2b3861",
            "filename": "dev-infra/pr/check-target-branches/check-target-branches.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 7,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fpr%2Fcheck-target-branches%2Fcheck-target-branches.ts",
            "raw_url": "https://github.com/angular/angular/raw/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fpr%2Fcheck-target-branches%2Fcheck-target-branches.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcheck-target-branches%2Fcheck-target-branches.ts?ref=3d7e207a25be8dae4593c0ce3fb47da32d225173",
            "patch": "@@ -9,8 +9,8 @@\n import {getConfig} from '../../utils/config';\n import {error, info, red} from '../../utils/console';\n import {GitClient} from '../../utils/git/index';\n-import {loadAndValidateConfig} from '../merge/config';\n-import {getBranchesFromTargetLabel, getTargetLabelFromPullRequest} from '../merge/target-label';\n+import {loadAndValidateConfig, TargetLabel} from '../merge/config';\n+import {getBranchesFromTargetLabel, getTargetLabelFromPullRequest, InvalidTargetLabelError} from '../merge/target-label';\n \n export async function getTargetBranchesForPr(prNumber: number) {\n   /** The ng-dev configuration. */\n@@ -31,11 +31,17 @@ export async function getTargetBranchesForPr(prNumber: number) {\n   /** The branch targetted via the Github UI. */\n   const githubTargetBranch = prData.base.ref;\n   /** The active label which is being used for targetting the PR. */\n-  const targetLabel = getTargetLabelFromPullRequest(mergeConfig!, labels);\n-  if (targetLabel === null) {\n-    error(red(`No target label was found on pr #${prNumber}`));\n-    process.exitCode = 1;\n-    return;\n+  let targetLabel: TargetLabel;\n+\n+  try {\n+    targetLabel = getTargetLabelFromPullRequest(mergeConfig!, labels);\n+  } catch (e) {\n+    if (e instanceof InvalidTargetLabelError) {\n+      error(red(e.failureMessage));\n+      process.exitCode = 1;\n+      return;\n+    }\n+    throw e;\n   }\n   /** The target branches based on the target label and branch targetted in the Github UI. */\n   return await getBranchesFromTargetLabel(targetLabel, githubTargetBranch);"
        },
        {
            "sha": "41fa636f57cb0fc00f7b3c1205d1d32ce13065cd",
            "filename": "dev-infra/pr/merge/defaults/integration.spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts?ref=3d7e207a25be8dae4593c0ce3fb47da32d225173",
            "patch": "@@ -87,8 +87,10 @@ describe('default target labels', () => {\n     if (labels === undefined) {\n       labels = await computeTargetLabels();\n     }\n-    const label = getTargetLabelFromPullRequest({labels}, [name]);\n-    if (label === null) {\n+    let label: TargetLabel;\n+    try {\n+      label = getTargetLabelFromPullRequest({labels}, [name]);\n+    } catch (error) {\n       return null;\n     }\n     return await getBranchesFromTargetLabel(label, githubTargetBranch);"
        },
        {
            "sha": "043fcaf1260fac62566824bfcb1286bafe59519a",
            "filename": "dev-infra/pr/merge/failures.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fpr%2Fmerge%2Ffailures.ts",
            "raw_url": "https://github.com/angular/angular/raw/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fpr%2Fmerge%2Ffailures.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ffailures.ts?ref=3d7e207a25be8dae4593c0ce3fb47da32d225173",
            "patch": "@@ -34,10 +34,6 @@ export class PullRequestFailure {\n     return new this(`Not marked as merge ready.`);\n   }\n \n-  static noTargetLabel() {\n-    return new this(`No target branch could be determined. Please ensure a target label is set.`);\n-  }\n-\n   static mismatchingTargetBranch(allowedBranches: string[]) {\n     return new this(\n         `Pull request is set to wrong base branch. Please update the PR in the Github UI ` +"
        },
        {
            "sha": "222df0007a1234c4cbed2450295c94439657eb73",
            "filename": "dev-infra/pr/merge/pull-request.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "raw_url": "https://github.com/angular/angular/raw/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts?ref=3d7e207a25be8dae4593c0ce3fb47da32d225173",
            "patch": "@@ -9,6 +9,7 @@\n import * as Octokit from '@octokit/rest';\n \n import {GitClient} from '../../utils/git/index';\n+import {TargetLabel} from './config';\n \n import {PullRequestFailure} from './failures';\n import {matchesPattern} from './string-pattern';\n@@ -61,9 +62,14 @@ export async function loadAndValidatePullRequest(\n     return PullRequestFailure.claUnsigned();\n   }\n \n-  const targetLabel = getTargetLabelFromPullRequest(config, labels);\n-  if (targetLabel === null) {\n-    return PullRequestFailure.noTargetLabel();\n+  let targetLabel: TargetLabel;\n+  try {\n+    targetLabel = getTargetLabelFromPullRequest(config, labels);\n+  } catch (error) {\n+    if (error instanceof InvalidTargetLabelError) {\n+      return new PullRequestFailure(error.failureMessage);\n+    }\n+    throw error;\n   }\n \n   const {data: {state}} ="
        },
        {
            "sha": "707676306a05f125ec8a305f756752b4dc9bbbd0",
            "filename": "dev-infra/pr/merge/target-label.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fpr%2Fmerge%2Ftarget-label.ts",
            "raw_url": "https://github.com/angular/angular/raw/3d7e207a25be8dae4593c0ce3fb47da32d225173/dev-infra%2Fpr%2Fmerge%2Ftarget-label.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ftarget-label.ts?ref=3d7e207a25be8dae4593c0ce3fb47da32d225173",
            "patch": "@@ -27,14 +27,24 @@ export class InvalidTargetLabelError {\n \n /** Gets the target label from the specified pull request labels. */\n export function getTargetLabelFromPullRequest(\n-    config: Pick<MergeConfig, 'labels'>, labels: string[]): TargetLabel|null {\n+    config: Pick<MergeConfig, 'labels'>, labels: string[]): TargetLabel {\n+  /** List of discovered target labels for the PR. */\n+  const matches = [];\n   for (const label of labels) {\n     const match = config.labels.find(({pattern}) => matchesPattern(label, pattern));\n     if (match !== undefined) {\n-      return match;\n+      matches.push(match);\n     }\n   }\n-  return null;\n+  if (matches.length === 1) {\n+    return matches[0];\n+  }\n+  if (matches.length === 0) {\n+    throw new InvalidTargetLabelError(\n+        'Unable to determine target for the PR as it has no target label.');\n+  }\n+  throw new InvalidTargetLabelError(\n+      'Unable to determine target for the PR as it has multiple target labels.');\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 69,
        "deletions": 35
    }
}