{
    "author": "kyliau",
    "message": "feat(language-service): Add diagnostics to suggest turning on strict mode (#40423)\n\nThis PR adds a way for the language server to retrieve compiler options\ndiagnostics via `languageService.getCompilerOptionsDiagnostics()`.\n\nThis will be used by the language server to show a prompt in the editor if\nusers don't have `strict` or `fullTemplateTypeCheck` turned on.\n\nRef https://github.com/angular/vscode-ng-language-service/issues/1053\n\nPR Close #40423",
    "sha": "ecae75f4771922b8d3732e9df0a30f874aa4e207",
    "files": [
        {
            "sha": "3d37af79c6b046a8f54a819cb329710f85d560e7",
            "filename": "goldens/public-api/compiler-cli/error_code.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/ecae75f4771922b8d3732e9df0a30f874aa4e207/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/ecae75f4771922b8d3732e9df0a30f874aa4e207/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts?ref=ecae75f4771922b8d3732e9df0a30f874aa4e207",
            "patch": "@@ -35,5 +35,6 @@ export declare enum ErrorCode {\n     DUPLICATE_VARIABLE_DECLARATION = 8006,\n     INLINE_TCB_REQUIRED = 8900,\n     INLINE_TYPE_CTOR_REQUIRED = 8901,\n-    INJECTABLE_DUPLICATE_PROV = 9001\n+    INJECTABLE_DUPLICATE_PROV = 9001,\n+    SUGGEST_STRICT_TEMPLATES = 10001\n }"
        },
        {
            "sha": "115554b7d913d6d734fe51a9b94ae5c9ca552521",
            "filename": "packages/compiler-cli/src/ngtsc/core/api/src/public_options.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Fpublic_options.ts",
            "raw_url": "https://github.com/angular/angular/raw/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Fpublic_options.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Fpublic_options.ts?ref=ecae75f4771922b8d3732e9df0a30f874aa4e207",
            "patch": "@@ -127,9 +127,9 @@ export interface StrictTemplateOptions {\n   /**\n    * If `true`, implies all template strictness flags below (unless individually disabled).\n    *\n-   * Has no effect unless `fullTemplateTypeCheck` is also enabled.\n+   * This flag is a superset of `fullTemplateTypeCheck`.\n    *\n-   * Defaults to `false`, even if \"fullTemplateTypeCheck\" is set.\n+   * Defaults to `false`, even if \"fullTemplateTypeCheck\" is `true`.\n    */\n   strictTemplates?: boolean;\n "
        },
        {
            "sha": "840d52f5008bd5778e84dd9c5eab157463369758",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=ecae75f4771922b8d3732e9df0a30f874aa4e207",
            "patch": "@@ -906,7 +906,7 @@ function getR3SymbolsFile(program: ts.Program): ts.SourceFile|null {\n \n /**\n  * Since \"strictTemplates\" is a true superset of type checking capabilities compared to\n- * \"strictTemplateTypeCheck\", it is required that the latter is not explicitly disabled if the\n+ * \"fullTemplateTypeCheck\", it is required that the latter is not explicitly disabled if the\n  * former is enabled.\n  */\n function verifyCompatibleTypeCheckOptions(options: NgCompilerOptions): ts.Diagnostic|null {"
        },
        {
            "sha": "d34b791bfd4a2a1aeafab966a7ae08dbb99fd914",
            "filename": "packages/compiler-cli/src/ngtsc/diagnostics/src/error_code.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "raw_url": "https://github.com/angular/angular/raw/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts?ref=ecae75f4771922b8d3732e9df0a30f874aa4e207",
            "patch": "@@ -159,6 +159,16 @@ export enum ErrorCode {\n    * An injectable already has a `Éµprov` property.\n    */\n   INJECTABLE_DUPLICATE_PROV = 9001,\n+\n+  // 10XXX error codes are reserved for diagnostics with category\n+  // `ts.DiagnosticCategory.Suggestion`. These diagnostics are generated by\n+  // language service.\n+\n+  /**\n+   * Suggest users to enable `strictTemplates` to make use of full capabilities\n+   * provided by Angular language service.\n+   */\n+  SUGGEST_STRICT_TEMPLATES = 10001,\n }\n \n /**"
        },
        {
            "sha": "0a7aa1cb789fbeb3d1740e42d0a975d708e1275e",
            "filename": "packages/language-service/ivy/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2FBUILD.bazel?ref=ecae75f4771922b8d3732e9df0a30f874aa4e207",
            "patch": "@@ -10,6 +10,7 @@ ts_library(\n         \"//packages/compiler-cli\",\n         \"//packages/compiler-cli/src/ngtsc/core\",\n         \"//packages/compiler-cli/src/ngtsc/core:api\",\n+        \"//packages/compiler-cli/src/ngtsc/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/imports\",\n         \"//packages/compiler-cli/src/ngtsc/incremental\","
        },
        {
            "sha": "1895ad595dd2343b1ff7d36ad6ef459cfd56157e",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 1,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=ecae75f4771922b8d3732e9df0a30f874aa4e207",
            "patch": "@@ -9,6 +9,7 @@\n import {AbsoluteSourceSpan, AST, ParseSourceSpan, TmplAstBoundEvent, TmplAstNode} from '@angular/compiler';\n import {CompilerOptions, ConfigurationHost, readConfiguration} from '@angular/compiler-cli';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n+import {ErrorCode, ngErrorCode} from '@angular/compiler-cli/src/ngtsc/diagnostics';\n import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n@@ -50,7 +51,8 @@ export class LanguageService {\n   private readonly adapter: LanguageServiceAdapter;\n   private readonly parseConfigHost: LSParseConfigHost;\n \n-  constructor(project: ts.server.Project, private readonly tsLS: ts.LanguageService) {\n+  constructor(\n+      private readonly project: ts.server.Project, private readonly tsLS: ts.LanguageService) {\n     this.parseConfigHost = new LSParseConfigHost(project.projectService.host);\n     this.options = parseNgCompilerOptions(project, this.parseConfigHost);\n     logCompilerOptions(project, this.options);\n@@ -268,6 +270,34 @@ export class LanguageService {\n     return result;\n   }\n \n+  getCompilerOptionsDiagnostics(): ts.Diagnostic[] {\n+    const project = this.project;\n+    if (!(project instanceof ts.server.ConfiguredProject)) {\n+      return [];\n+    }\n+\n+    const diagnostics: ts.Diagnostic[] = [];\n+    const configSourceFile = ts.readJsonConfigFile(\n+        project.getConfigFilePath(), (path: string) => project.readFile(path));\n+\n+    if (!this.options.strictTemplates && !this.options.fullTemplateTypeCheck) {\n+      diagnostics.push({\n+        messageText: 'Some language features are not available. ' +\n+            'To access all features, enable `strictTemplates` in `angularCompilerOptions`.',\n+        category: ts.DiagnosticCategory.Suggestion,\n+        code: ngErrorCode(ErrorCode.SUGGEST_STRICT_TEMPLATES),\n+        file: configSourceFile,\n+        start: undefined,\n+        length: undefined,\n+      });\n+    }\n+\n+    const compiler = this.compilerFactory.getOrCreate();\n+    diagnostics.push(...compiler.getOptionDiagnostics());\n+\n+    return diagnostics;\n+  }\n+\n   private watchConfigFile(project: ts.server.Project) {\n     // TODO: Check the case when the project is disposed. An InferredProject\n     // could be disposed when a tsconfig.json is added to the workspace,"
        },
        {
            "sha": "28b0ff63adfc6efa267121de89932a09fc17016f",
            "filename": "packages/language-service/ivy/test/legacy/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2FBUILD.bazel?ref=ecae75f4771922b8d3732e9df0a30f874aa4e207",
            "patch": "@@ -6,6 +6,8 @@ ts_library(\n     srcs = glob([\"*.ts\"]),\n     deps = [\n         \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/core:api\",\n+        \"//packages/compiler-cli/src/ngtsc/diagnostics\",\n         \"//packages/language-service/ivy\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "6874be3bc048dc89b888d271951e4cbb573c1941",
            "filename": "packages/language-service/ivy/test/legacy/language_service_spec.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 14,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts?ref=ecae75f4771922b8d3732e9df0a30f874aa4e207",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {ErrorCode, ngErrorCode} from '@angular/compiler-cli/src/ngtsc/diagnostics';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {LanguageService} from '../../language_service';\n@@ -31,15 +32,6 @@ describe('language service adapter', () => {\n   });\n \n   describe('parse compiler options', () => {\n-    beforeEach(() => {\n-      // Need to reset project on each test to reinitialize file watchers.\n-      const {project: _project, tsLS, service: _service, configFileFs: _configFileFs} = setup();\n-      project = _project;\n-      service = _service;\n-      configFileFs = _configFileFs;\n-      ngLS = new LanguageService(project, tsLS);\n-    });\n-\n     it('should initialize with angularCompilerOptions from tsconfig.json', () => {\n       expect(ngLS.getCompilerOptions()).toEqual(jasmine.objectContaining({\n         enableIvy: true,  // default for ivy is true\n@@ -55,18 +47,56 @@ describe('language service adapter', () => {\n         strictInjectionParameters: true,\n       }));\n \n-      configFileFs.overwriteConfigFile(TSCONFIG, `{\n-         \"angularCompilerOptions\": {\n-           \"strictTemplates\": false\n-         }\n-       }`);\n+      configFileFs.overwriteConfigFile(TSCONFIG, {\n+        angularCompilerOptions: {\n+          strictTemplates: false,\n+        }\n+      });\n \n       expect(ngLS.getCompilerOptions()).toEqual(jasmine.objectContaining({\n         strictTemplates: false,\n       }));\n     });\n   });\n \n+  describe('compiler options diagnostics', () => {\n+    it('suggests turning on strict flag', () => {\n+      configFileFs.overwriteConfigFile(TSCONFIG, {\n+        angularCompilerOptions: {},\n+      });\n+      const diags = ngLS.getCompilerOptionsDiagnostics();\n+      const diag = diags.find(isSuggestStrictTemplatesDiag);\n+      expect(diag).toBeDefined();\n+      expect(diag!.category).toBe(ts.DiagnosticCategory.Suggestion);\n+      expect(diag!.file?.getSourceFile().fileName).toBe(TSCONFIG);\n+    });\n+\n+    it('does not suggest turning on strict mode is strictTemplates flag is on', () => {\n+      configFileFs.overwriteConfigFile(TSCONFIG, {\n+        angularCompilerOptions: {\n+          strictTemplates: true,\n+        },\n+      });\n+      const diags = ngLS.getCompilerOptionsDiagnostics();\n+      const diag = diags.find(isSuggestStrictTemplatesDiag);\n+      expect(diag).toBeUndefined();\n+    });\n+\n+    it('does not suggest turning on strict mode is fullTemplateTypeCheck flag is on', () => {\n+      configFileFs.overwriteConfigFile(TSCONFIG, {\n+        angularCompilerOptions: {\n+          fullTemplateTypeCheck: true,\n+        },\n+      });\n+      const diags = ngLS.getCompilerOptionsDiagnostics();\n+      const diag = diags.find(isSuggestStrictTemplatesDiag);\n+      expect(diag).toBeUndefined();\n+    });\n+\n+    function isSuggestStrictTemplatesDiag(diag: ts.Diagnostic) {\n+      return diag.code === ngErrorCode(ErrorCode.SUGGEST_STRICT_TEMPLATES);\n+    }\n+  });\n \n   describe('last known program', () => {\n     beforeEach(() => {"
        },
        {
            "sha": "4b97e42b1a1cd5e80d7cfe1dde46e860ecf2b1a5",
            "filename": "packages/language-service/ivy/test/legacy/mock_host.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fmock_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fmock_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fmock_host.ts?ref=ecae75f4771922b8d3732e9df0a30f874aa4e207",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {NgCompilerOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n import {join} from 'path';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n@@ -68,11 +69,11 @@ export class MockConfigFileFs implements\n   private configOverwrites = new Map<string, string>();\n   private configFileWatchers = new Map<string, MockWatcher>();\n \n-  overwriteConfigFile(configFile: string, contents: string) {\n+  overwriteConfigFile(configFile: string, contents: {angularCompilerOptions?: NgCompilerOptions}) {\n     if (!configFile.endsWith('.json')) {\n       throw new Error(`${configFile} is not a configuration file.`);\n     }\n-    this.configOverwrites.set(configFile, contents);\n+    this.configOverwrites.set(configFile, JSON.stringify(contents));\n     this.configFileWatchers.get(configFile)?.changed();\n   }\n \n@@ -98,8 +99,11 @@ export class MockConfigFileFs implements\n   }\n \n   clear() {\n+    for (const [fileName, watcher] of this.configFileWatchers) {\n+      this.configOverwrites.delete(fileName);\n+      watcher.changed();\n+    }\n     this.configOverwrites.clear();\n-    this.configFileWatchers.clear();\n   }\n }\n "
        },
        {
            "sha": "89f4c27a13a1ca60a149ab3f3939e76bf3b4e45d",
            "filename": "packages/language-service/ivy/ts_plugin.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/ecae75f4771922b8d3732e9df0a30f874aa4e207/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts?ref=ecae75f4771922b8d3732e9df0a30f874aa4e207",
            "patch": "@@ -119,6 +119,17 @@ export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n           ngLS.getCompletionEntrySymbol(fileName, position, name);\n     }\n   }\n+  /**\n+   * Gets global diagnostics related to the program configuration and compiler options.\n+   */\n+  function getCompilerOptionsDiagnostics(): ts.Diagnostic[] {\n+    const diagnostics: ts.Diagnostic[] = [];\n+    if (!angularOnly) {\n+      diagnostics.push(...tsLS.getCompilerOptionsDiagnostics());\n+    }\n+    diagnostics.push(...ngLS.getCompilerOptionsDiagnostics());\n+    return diagnostics;\n+  }\n \n   function getTcb(fileName: string, position: number): GetTcbResponse {\n     return ngLS.getTcb(fileName, position);\n@@ -137,6 +148,7 @@ export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n     getCompletionEntryDetails,\n     getCompletionEntrySymbol,\n     getTcb,\n+    getCompilerOptionsDiagnostics,\n   };\n }\n "
        }
    ],
    "stats": {
        "total": 134,
        "additions": 112,
        "deletions": 22
    }
}