{
    "author": "csr632",
    "message": "fix(core): make DefaultIterableDiffer keep the order of duplicates (#23941)\n\nPreviously, in `_mismatch()`, the `DefaultIterableDiffer` first checks\n`_linkedRecords` for `itemTrackBy`, then checks `_unlinkedRecords`.\nThis cause the `DefaultIterableDiffer` to move \"later\" items that match the\n`itemTrackBy` from the old collection, rather than using the \"earlier\" one.\n\nNow we check `_unlinkedRecords` first, so that the `DefaultIterableDiffer`\ncan give a more stable and reasonable result after diffing. For example,\nrather than (`a1` and `a2` have same trackById)\n\n```\na1 b c a2 => b a2 c a1\n```\n\nwe get\n\n```\na1 b c a2 => b a1 c a2\n```\n\nwhere a1 and a2 retain their original order despite both\nhaving the same track by value.\n\nFixes #23815\n\nPR Close #23941",
    "sha": "a8269264bf5698230eb991ca77c29374880a184b",
    "files": [
        {
            "sha": "60a1dacf8ddd8c869836180a7000200b08d21142",
            "filename": "packages/core/src/change_detection/differs/default_iterable_differ.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 10,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/a8269264bf5698230eb991ca77c29374880a184b/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fdefault_iterable_differ.ts",
            "raw_url": "https://github.com/angular/angular/raw/a8269264bf5698230eb991ca77c29374880a184b/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fdefault_iterable_differ.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fdefault_iterable_differ.ts?ref=a8269264bf5698230eb991ca77c29374880a184b",
            "patch": "@@ -281,23 +281,24 @@ export class DefaultIterableDiffer<V> implements IterableDiffer<V>, IterableChan\n       this._remove(record);\n     }\n \n-    // Attempt to see if we have seen the item before.\n-    record = this._linkedRecords === null ? null : this._linkedRecords.get(itemTrackBy, index);\n+    // See if we have evicted the item, which used to be at some anterior position of _itHead list.\n+    record = this._unlinkedRecords === null ? null : this._unlinkedRecords.get(itemTrackBy, null);\n     if (record !== null) {\n-      // We have seen this before, we need to move it forward in the collection.\n-      // But first we need to check if identity changed, so we can update in view if necessary\n+      // It is an item which we have evicted earlier: reinsert it back into the list.\n+      // But first we need to check if identity changed, so we can update in view if necessary.\n       if (!Object.is(record.item, item)) this._addIdentityChange(record, item);\n \n-      this._moveAfter(record, previousRecord, index);\n+      this._reinsertAfter(record, previousRecord, index);\n     } else {\n-      // Never seen it, check evicted list.\n-      record = this._unlinkedRecords === null ? null : this._unlinkedRecords.get(itemTrackBy, null);\n+      // Attempt to see if the item is at some posterior position of _itHead list.\n+      record = this._linkedRecords === null ? null : this._linkedRecords.get(itemTrackBy, index);\n       if (record !== null) {\n-        // It is an item which we have evicted earlier: reinsert it back into the list.\n-        // But first we need to check if identity changed, so we can update in view if necessary\n+        // We have the item in _itHead at/after `index` position. We need to move it forward in the\n+        // collection.\n+        // But first we need to check if identity changed, so we can update in view if necessary.\n         if (!Object.is(record.item, item)) this._addIdentityChange(record, item);\n \n-        this._reinsertAfter(record, previousRecord, index);\n+        this._moveAfter(record, previousRecord, index);\n       } else {\n         // It is a new item: add it.\n         record ="
        },
        {
            "sha": "ac244d071474b1671d9a634cb8aa503d3c8b0bb5",
            "filename": "packages/core/test/change_detection/differs/default_iterable_differ_spec.ts",
            "status": "modified",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/a8269264bf5698230eb991ca77c29374880a184b/packages%2Fcore%2Ftest%2Fchange_detection%2Fdiffers%2Fdefault_iterable_differ_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a8269264bf5698230eb991ca77c29374880a184b/packages%2Fcore%2Ftest%2Fchange_detection%2Fdiffers%2Fdefault_iterable_differ_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fchange_detection%2Fdiffers%2Fdefault_iterable_differ_spec.ts?ref=a8269264bf5698230eb991ca77c29374880a184b",
            "patch": "@@ -561,6 +561,65 @@ class ComplexItem {\n         }));\n       });\n \n+      it('should keep the order of duplicates', () => {\n+        const l1 = [\n+          new ComplexItem('a', 'blue'),\n+          new ComplexItem('b', 'yellow'),\n+          new ComplexItem('c', 'orange'),\n+          new ComplexItem('a', 'red'),\n+        ];\n+        differ.check(l1);\n+\n+        const l2 = [\n+          new ComplexItem('b', 'yellow'),\n+          new ComplexItem('a', 'blue'),\n+          new ComplexItem('c', 'orange'),\n+          new ComplexItem('a', 'red'),\n+        ];\n+        differ.check(l2);\n+\n+        expect(iterableDifferToString(differ)).toEqual(iterableChangesAsString({\n+          collection: [\n+            '{id: b, color: yellow}[1->0]', '{id: a, color: blue}[0->1]', '{id: c, color: orange}',\n+            '{id: a, color: red}'\n+          ],\n+          identityChanges: [\n+            '{id: b, color: yellow}[1->0]', '{id: a, color: blue}[0->1]', '{id: c, color: orange}',\n+            '{id: a, color: red}'\n+          ],\n+          previous: [\n+            '{id: a, color: blue}[0->1]', '{id: b, color: yellow}[1->0]', '{id: c, color: orange}',\n+            '{id: a, color: red}'\n+          ],\n+          moves: ['{id: b, color: yellow}[1->0]', '{id: a, color: blue}[0->1]'],\n+        }));\n+      });\n+\n+      it('should not have identity changed', () => {\n+        const l1 = [\n+          new ComplexItem('a', 'blue'),\n+          new ComplexItem('b', 'yellow'),\n+          new ComplexItem('c', 'orange'),\n+          new ComplexItem('a', 'red'),\n+        ];\n+        differ.check(l1);\n+\n+        const l2 = [l1[1], l1[0], l1[2], l1[3]];\n+        differ.check(l2);\n+\n+        expect(iterableDifferToString(differ)).toEqual(iterableChangesAsString({\n+          collection: [\n+            '{id: b, color: yellow}[1->0]', '{id: a, color: blue}[0->1]', '{id: c, color: orange}',\n+            '{id: a, color: red}'\n+          ],\n+          previous: [\n+            '{id: a, color: blue}[0->1]', '{id: b, color: yellow}[1->0]', '{id: c, color: orange}',\n+            '{id: a, color: red}'\n+          ],\n+          moves: ['{id: b, color: yellow}[1->0]', '{id: a, color: blue}[0->1]'],\n+        }));\n+      });\n+\n       it('should track removals normally', () => {\n         const l = buildItemList(['a', 'b', 'c']);\n         differ.check(l);"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 70,
        "deletions": 10
    }
}