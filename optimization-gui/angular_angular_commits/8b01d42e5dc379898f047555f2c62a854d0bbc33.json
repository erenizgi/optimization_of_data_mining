{
    "author": "devversion",
    "message": "feat(dev-infra): add shared testing utilities folder with git mock (#38656)\n\nAdds a new folder to dev-infra where shared testing utilities\ncould be placed in. This commit already adds initial testing\nutilities for dealing with the `GitClient` and SemVer versions.\n\nThe `GitClient` in the testing utilities simulates actual Git\nbehavior in a virtual manner. It's not complete at all, but can\nbe extended based on our needs. The currently implemented commands\nare the most basic ones that we'd need for our release tooling.\n\nPR Close #38656",
    "sha": "8b01d42e5dc379898f047555f2c62a854d0bbc33",
    "files": [
        {
            "sha": "bc24a5a00b9bee0ab7e2db5eb84aeca1c7772bee",
            "filename": "dev-infra/utils/testing/BUILD.bazel",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/8b01d42e5dc379898f047555f2c62a854d0bbc33/dev-infra%2Futils%2Ftesting%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/8b01d42e5dc379898f047555f2c62a854d0bbc33/dev-infra%2Futils%2Ftesting%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2FBUILD.bazel?ref=8b01d42e5dc379898f047555f2c62a854d0bbc33",
            "patch": "@@ -0,0 +1,15 @@\n+load(\"@npm_bazel_typescript//:index.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"testing\",\n+    srcs = glob([\"*.ts\"]),\n+    module_name = \"@angular/dev-infra-private/utils/testing\",\n+    visibility = [\"//dev-infra:__subpackages__\"],\n+    deps = [\n+        \"//dev-infra/utils\",\n+        \"@npm//@types/jasmine\",\n+        \"@npm//@types/minimist\",\n+        \"@npm//@types/node\",\n+        \"@npm//minimist\",\n+    ],\n+)"
        },
        {
            "sha": "1521532eaded99a335c99bd2ae33b685e7681383",
            "filename": "dev-infra/utils/testing/index.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/8b01d42e5dc379898f047555f2c62a854d0bbc33/dev-infra%2Futils%2Ftesting%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/8b01d42e5dc379898f047555f2c62a854d0bbc33/dev-infra%2Futils%2Ftesting%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2Findex.ts?ref=8b01d42e5dc379898f047555f2c62a854d0bbc33",
            "patch": "@@ -0,0 +1,11 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export * from './virtual-git-client';\n+export * from './virtual-git-matchers';\n+export * from './semver-matchers';"
        },
        {
            "sha": "fa38e6af12bc41d05989c59d9624b0b76ea27697",
            "filename": "dev-infra/utils/testing/semver-matchers.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/8b01d42e5dc379898f047555f2c62a854d0bbc33/dev-infra%2Futils%2Ftesting%2Fsemver-matchers.ts",
            "raw_url": "https://github.com/angular/angular/raw/8b01d42e5dc379898f047555f2c62a854d0bbc33/dev-infra%2Futils%2Ftesting%2Fsemver-matchers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2Fsemver-matchers.ts?ref=8b01d42e5dc379898f047555f2c62a854d0bbc33",
            "patch": "@@ -0,0 +1,12 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/** Gets a jasmine asymmetric matcher for matching a given SemVer version. */\n+export function matchesVersion(versionName: string) {\n+  return jasmine.objectContaining({raw: versionName, version: versionName});\n+}"
        },
        {
            "sha": "207347eb1eb34b8237e08fe69f137dbe1b53dc82",
            "filename": "dev-infra/utils/testing/virtual-git-client.ts",
            "status": "added",
            "additions": 173,
            "deletions": 0,
            "changes": 173,
            "blob_url": "https://github.com/angular/angular/blob/8b01d42e5dc379898f047555f2c62a854d0bbc33/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts",
            "raw_url": "https://github.com/angular/angular/raw/8b01d42e5dc379898f047555f2c62a854d0bbc33/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts?ref=8b01d42e5dc379898f047555f2c62a854d0bbc33",
            "patch": "@@ -0,0 +1,173 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {SpawnSyncOptions, SpawnSyncReturns} from 'child_process';\n+import * as parseArgs from 'minimist';\n+\n+import {GitClient} from '../git/index';\n+\n+/** Type describing a Git head. */\n+interface GitHead {\n+  /** Name of the head. Not defined in a detached state. */\n+  branch?: string;\n+  /** Ref associated with this head. i.e. the remote base of this head. */\n+  ref?: RemoteRef;\n+  /** List of commits added to this head (on top of the ref's base). */\n+  newCommits: Commit[];\n+}\n+\n+/** Type describing a remote Git ref. */\n+export interface RemoteRef {\n+  /** Name of the reference. */\n+  name: string;\n+  /** Repository containing this ref. */\n+  repoUrl: string;\n+}\n+\n+/** Type describing a Git commit. */\n+export interface Commit {\n+  /** Commit message. */\n+  message: string;\n+  /** List of files included in this commit. */\n+  files: string[];\n+}\n+\n+/**\n+ * Virtual git client that mocks Git commands and keeps track of the repository state\n+ * in memory. This allows for convenient test assertions with Git interactions.\n+ */\n+export class VirtualGitClient extends GitClient {\n+  /** Current Git HEAD that has been previously fetched. */\n+  fetchHeadRef: RemoteRef|null = null;\n+  /** List of known branches in the repository. */\n+  branches: {[branchName: string]: GitHead} = {master: {branch: 'master', newCommits: []}};\n+  /** Current checked out HEAD in the repository. */\n+  head: GitHead = this.branches['master'];\n+  /** List of pushed heads to a given remote ref. */\n+  pushed: {remote: RemoteRef, head: GitHead}[] = [];\n+\n+  /** Override for the actual Git client command execution. */\n+  runGraceful(args: string[], options: SpawnSyncOptions = {}): SpawnSyncReturns<string> {\n+    const [command, ...rawArgs] = args;\n+    switch (command) {\n+      case 'push':\n+        this._push(rawArgs);\n+        break;\n+      case 'fetch':\n+        this._fetch(rawArgs);\n+        break;\n+      case 'checkout':\n+        this._checkout(rawArgs);\n+        break;\n+      case 'commit':\n+        this._commit(rawArgs);\n+        break;\n+    }\n+\n+    // Return a fake spawn sync return value. We error non-gracefully if any command fails\n+    // in the tests, so we always return success and stub out the `SpawnSyncReturns` type.\n+    return {status: 0, stderr: '', output: [], pid: -1, signal: null, stdout: ''};\n+  }\n+\n+  /** Handler for the `git push` command. */\n+  private _push(args: string[]) {\n+    const [repoUrl, refspec] = parseArgs(args)._;\n+    const ref = this._unwrapRefspec(refspec);\n+    const name = ref.destination || ref.source;\n+    const existingPush =\n+        this.pushed.find(({remote}) => remote.repoUrl === repoUrl && remote.name === name);\n+    const pushedHead = this._cloneHead(this.head);\n+\n+    // Either, update a previously pushed branch, or keep track of a newly\n+    // performed branch push. We don't respect the `--force` flag.\n+    if (existingPush !== undefined) {\n+      existingPush.head = pushedHead;\n+    } else {\n+      this.pushed.push({remote: {repoUrl, name}, head: pushedHead});\n+    }\n+  }\n+\n+  /** Handler for the `git commit` command. */\n+  private _commit(rawArgs: string[]) {\n+    const args = parseArgs(rawArgs, {string: ['m', 'message']});\n+    const message = args['m'] || args['message'];\n+    const files = args._;\n+    if (!message) {\n+      throw Error('No commit message has been specified.');\n+    }\n+    this.head.newCommits.push({message, files});\n+  }\n+\n+  /** Handler for the `git fetch` command. */\n+  private _fetch(rawArgs: string[]) {\n+    const args = parseArgs(rawArgs, {boolean: ['f', 'force']});\n+    const [repoUrl, refspec] = args._;\n+    const force = args['f'] || args['force'];\n+    const ref = this._unwrapRefspec(refspec);\n+\n+    // Keep track of the fetch head, so that it can be checked out\n+    // later in a detached state.\n+    this.fetchHeadRef = {name: ref.source, repoUrl};\n+\n+    // If a destination has been specified in the ref spec, add it to the\n+    // list of available local branches.\n+    if (ref.destination) {\n+      if (this.branches[ref.destination] && !force) {\n+        throw Error('Cannot override existing local branch when fetching.');\n+      }\n+      this.branches[ref.destination] = {\n+        branch: ref.destination,\n+        ref: this.fetchHeadRef,\n+        newCommits: []\n+      };\n+    }\n+  }\n+\n+  /** Handler for the `git checkout` command. */\n+  private _checkout(rawArgs: string[]) {\n+    const args = parseArgs(rawArgs, {boolean: ['detach', 'B']});\n+    const createBranch = args['B'];\n+    const detached = args['detach'];\n+    const [target] = args._;\n+\n+    if (target === 'FETCH_HEAD') {\n+      if (this.fetchHeadRef === null) {\n+        throw Error('Unexpectedly trying to check out \"FETCH_HEAD\". Not fetch head set.');\n+      }\n+      this.head = {ref: this.fetchHeadRef, newCommits: []};\n+    } else if (this.branches[target]) {\n+      this.head = {...this._cloneHead(this.branches[target], detached)};\n+    } else if (createBranch) {\n+      this.head = this.branches[target] = {branch: target, ...this._cloneHead(this.head, detached)};\n+    } else {\n+      throw Error(`Unexpected branch checked out: ${target}`);\n+    }\n+  }\n+\n+  /**\n+   * Unwraps a refspec into the base and target ref names.\n+   * https://git-scm.com/docs/git-fetch#Documentation/git-fetch.txt-ltrefspecgt.\n+   */\n+  private _unwrapRefspec(refspec: string): {source: string, destination?: string} {\n+    const [source, destination] = refspec.split(':');\n+    if (!destination) {\n+      return {source};\n+    } else {\n+      return {source, destination};\n+    }\n+  }\n+\n+  /** Clones the specified Git head with respect to the detached flag. */\n+  private _cloneHead(head: GitHead, detached = false): GitHead {\n+    return {\n+      branch: detached ? undefined : head.branch,\n+      ref: head.ref,\n+      newCommits: [...head.newCommits],\n+    };\n+  }\n+}"
        },
        {
            "sha": "41c021aa6fbae7eab68a8d76ef43bd67dfb422fe",
            "filename": "dev-infra/utils/testing/virtual-git-matchers.ts",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/8b01d42e5dc379898f047555f2c62a854d0bbc33/dev-infra%2Futils%2Ftesting%2Fvirtual-git-matchers.ts",
            "raw_url": "https://github.com/angular/angular/raw/8b01d42e5dc379898f047555f2c62a854d0bbc33/dev-infra%2Futils%2Ftesting%2Fvirtual-git-matchers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2Fvirtual-git-matchers.ts?ref=8b01d42e5dc379898f047555f2c62a854d0bbc33",
            "patch": "@@ -0,0 +1,41 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {GithubRepo} from '../git/github';\n+\n+import {Commit} from './virtual-git-client';\n+\n+/** Interface describing the match parameters for a virtual Git client push. */\n+interface BranchPushMatchParameters {\n+  targetRepo: GithubRepo;\n+  targetBranch: string;\n+  baseRepo: GithubRepo;\n+  baseBranch: string;\n+  expectedCommits: Commit[]|jasmine.ArrayContaining<Commit>;\n+}\n+\n+/**\n+ * Gets a jasmine object matcher for asserting that a virtual Git client push\n+ * matches the specified branch push (through the match parameters).\n+ */\n+export function getBranchPushMatcher(options: BranchPushMatchParameters) {\n+  const {targetRepo, targetBranch, baseBranch, baseRepo, expectedCommits} = options;\n+  return jasmine.objectContaining({\n+    remote: {\n+      repoUrl: `https://github.com/${targetRepo.owner}/${targetRepo.name}.git`,\n+      name: `refs/heads/${targetBranch}`\n+    },\n+    head: jasmine.objectContaining({\n+      newCommits: expectedCommits,\n+      ref: {\n+        repoUrl: `https://github.com/${baseRepo.owner}/${baseRepo.name}.git`,\n+        name: baseBranch,\n+      },\n+    })\n+  });\n+}"
        }
    ],
    "stats": {
        "total": 252,
        "additions": 252,
        "deletions": 0
    }
}