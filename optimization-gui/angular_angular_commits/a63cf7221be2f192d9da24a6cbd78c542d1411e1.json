{
    "author": "josephperrott",
    "message": "feat(dev-infra): prevent attempting to merge draft, closed or merged pull requests (#41604)\n\nDuring pull request validation, assert that the pull request is not in\ndraft mode, already merged or already closed.\n\nPR Close #41604",
    "sha": "a63cf7221be2f192d9da24a6cbd78c542d1411e1",
    "files": [
        {
            "sha": "d20c1495fff48785797cc7eb6e31d17fffb7f757",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/a63cf7221be2f192d9da24a6cbd78c542d1411e1/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/a63cf7221be2f192d9da24a6cbd78c542d1411e1/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=a63cf7221be2f192d9da24a6cbd78c542d1411e1",
            "patch": "@@ -3379,6 +3379,15 @@ var PullRequestFailure = /** @class */ (function () {\n     PullRequestFailure.notMergeReady = function () {\n         return new this(\"Not marked as merge ready.\");\n     };\n+    PullRequestFailure.isDraft = function () {\n+        return new this('Pull request is still in draft.');\n+    };\n+    PullRequestFailure.isClosed = function () {\n+        return new this('Pull request is already closed.');\n+    };\n+    PullRequestFailure.isMerged = function () {\n+        return new this('Pull request is already merged.');\n+    };\n     PullRequestFailure.mismatchingTargetBranch = function (allowedBranches) {\n         return new this(\"Pull request is set to wrong base branch. Please update the PR in the Github UI \" +\n             (\"to one of the following branches: \" + allowedBranches.join(', ') + \".\"));\n@@ -3490,6 +3499,7 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n                     }\n                     commitsInPr = prData.commits.nodes.map(function (n) { return parseCommitMessage(n.commit.message); });\n                     try {\n+                        assertPendingState(prData);\n                         assertChangesAllowForTargetLabel(commitsInPr, targetLabel, config);\n                         assertCorrectBreakingChangeLabeling(commitsInPr, labels, config);\n                     }\n@@ -3541,6 +3551,8 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n /* Graphql schema for the response body the requested pull request. */\n var PR_SCHEMA$2 = {\n     url: typedGraphqlify.types.string,\n+    isDraft: typedGraphqlify.types.boolean,\n+    state: typedGraphqlify.types.oneOf(['OPEN', 'MERGED', 'CLOSED']),\n     number: typedGraphqlify.types.number,\n     // Only the last 100 commits from a pull request are obtained as we likely will never see a pull\n     // requests with more than 100 commits.\n@@ -3646,6 +3658,18 @@ function assertCorrectBreakingChangeLabeling(commits, labels, config) {\n         throw PullRequestFailure.missingBreakingChangeCommit();\n     }\n }\n+/** Assert the pull request is pending, not closed, merged or in draft. */\n+function assertPendingState(pr) {\n+    if (pr.isDraft) {\n+        throw PullRequestFailure.isDraft();\n+    }\n+    switch (pr.state) {\n+        case 'CLOSED':\n+            throw PullRequestFailure.isClosed();\n+        case 'MERGED':\n+            throw PullRequestFailure.isMerged();\n+    }\n+}\n \n /**\n  * @license"
        },
        {
            "sha": "587892c8b3168e89a292a2d952f24dc7d2731a36",
            "filename": "dev-infra/pr/merge/failures.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/a63cf7221be2f192d9da24a6cbd78c542d1411e1/dev-infra%2Fpr%2Fmerge%2Ffailures.ts",
            "raw_url": "https://github.com/angular/angular/raw/a63cf7221be2f192d9da24a6cbd78c542d1411e1/dev-infra%2Fpr%2Fmerge%2Ffailures.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ffailures.ts?ref=a63cf7221be2f192d9da24a6cbd78c542d1411e1",
            "patch": "@@ -36,6 +36,18 @@ export class PullRequestFailure {\n     return new this(`Not marked as merge ready.`);\n   }\n \n+  static isDraft() {\n+    return new this('Pull request is still in draft.');\n+  }\n+\n+  static isClosed() {\n+    return new this('Pull request is already closed.');\n+  }\n+\n+  static isMerged() {\n+    return new this('Pull request is already merged.');\n+  }\n+\n   static mismatchingTargetBranch(allowedBranches: string[]) {\n     return new this(\n         `Pull request is set to wrong base branch. Please update the PR in the Github UI ` +"
        },
        {
            "sha": "b7986269eb9ffc2d09dfec85fa556ba317378d63",
            "filename": "dev-infra/pr/merge/pull-request.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/a63cf7221be2f192d9da24a6cbd78c542d1411e1/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "raw_url": "https://github.com/angular/angular/raw/a63cf7221be2f192d9da24a6cbd78c542d1411e1/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts?ref=a63cf7221be2f192d9da24a6cbd78c542d1411e1",
            "patch": "@@ -82,6 +82,7 @@ export async function loadAndValidatePullRequest(\n   const commitsInPr = prData.commits.nodes.map(n => parseCommitMessage(n.commit.message));\n \n   try {\n+    assertPendingState(prData);\n     assertChangesAllowForTargetLabel(commitsInPr, targetLabel, config);\n     assertCorrectBreakingChangeLabeling(commitsInPr, labels, config);\n   } catch (error) {\n@@ -136,6 +137,8 @@ export async function loadAndValidatePullRequest(\n /* Graphql schema for the response body the requested pull request. */\n const PR_SCHEMA = {\n   url: graphqlTypes.string,\n+  isDraft: graphqlTypes.boolean,\n+  state: graphqlTypes.oneOf(['OPEN', 'MERGED', 'CLOSED'] as const),\n   number: graphqlTypes.number,\n   // Only the last 100 commits from a pull request are obtained as we likely will never see a pull\n   // requests with more than 100 commits.\n@@ -159,11 +162,13 @@ const PR_SCHEMA = {\n   }),\n };\n \n+/** A pull request retrieved from github via the graphql API. */\n+type RawPullRequest = typeof PR_SCHEMA;\n \n \n /** Fetches a pull request from Github. Returns null if an error occurred. */\n async function fetchPullRequestFromGithub(\n-    git: GitClient<true>, prNumber: number): Promise<typeof PR_SCHEMA|null> {\n+    git: GitClient<true>, prNumber: number): Promise<RawPullRequest|null> {\n   try {\n     const x = await getPr(PR_SCHEMA, prNumber, git);\n     return x;\n@@ -241,3 +246,17 @@ function assertCorrectBreakingChangeLabeling(\n     throw PullRequestFailure.missingBreakingChangeCommit();\n   }\n }\n+\n+\n+/** Assert the pull request is pending, not closed, merged or in draft. */\n+function assertPendingState(pr: RawPullRequest) {\n+  if (pr.isDraft) {\n+    throw PullRequestFailure.isDraft();\n+  }\n+  switch (pr.state) {\n+    case 'CLOSED':\n+      throw PullRequestFailure.isClosed();\n+    case 'MERGED':\n+      throw PullRequestFailure.isMerged();\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 56,
        "deletions": 1
    }
}