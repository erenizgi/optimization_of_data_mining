{
    "author": "atscott",
    "message": "perf(language-service): short-circuit LS operations (#40946)\n\nWhen certain information is requested from the Angular Language Service, we\nknow that there will be no additional Angular information if the requested\nposition is not in an inline template, template url, or style url. To avoid\nunnecessary compiler compilations, we short circuit and return `undefined`\nbefore asking the compiler for any type of answer which would trigger a\npartial compilation, at the very least.\n\nfixes https://github.com/angular/vscode-ng-language-service/issues/1104\n\nPR Close #40946",
    "sha": "f31a6015a0ee5fef34c34478566d8570b68ad8c2",
    "files": [
        {
            "sha": "682bd0bccec4af95e6135421fcffb6e01d981745",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 93,
            "deletions": 31,
            "changes": 124,
            "blob_url": "https://github.com/angular/angular/blob/f31a6015a0ee5fef34c34478566d8570b68ad8c2/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/f31a6015a0ee5fef34c34478566d8570b68ad8c2/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=f31a6015a0ee5fef34c34478566d8570b68ad8c2",
            "patch": "@@ -26,6 +26,7 @@ import {DefinitionBuilder} from './definitions';\n import {QuickInfoBuilder} from './quick_info';\n import {ReferencesAndRenameBuilder} from './references';\n import {getTargetAtPosition, TargetContext, TargetNodeKind} from './template_target';\n+import {findTightestNode, getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n import {getTemplateInfoAtPosition, isTypeScriptFile} from './utils';\n \n export class LanguageService {\n@@ -74,20 +75,24 @@ export class LanguageService {\n \n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n-    const compiler = this.compilerFactory.getOrCreate();\n-    const results =\n-        new DefinitionBuilder(this.tsLS, compiler).getDefinitionAndBoundSpan(fileName, position);\n-    this.compilerFactory.registerLastKnownProgram();\n-    return results;\n+    return this.withCompiler((compiler) => {\n+      if (!isInAngularContext(compiler.getNextProgram(), fileName, position)) {\n+        return undefined;\n+      }\n+      return new DefinitionBuilder(this.tsLS, compiler)\n+          .getDefinitionAndBoundSpan(fileName, position);\n+    });\n   }\n \n   getTypeDefinitionAtPosition(fileName: string, position: number):\n       readonly ts.DefinitionInfo[]|undefined {\n-    const compiler = this.compilerFactory.getOrCreate();\n-    const results =\n-        new DefinitionBuilder(this.tsLS, compiler).getTypeDefinitionsAtPosition(fileName, position);\n-    this.compilerFactory.registerLastKnownProgram();\n-    return results;\n+    return this.withCompiler((compiler) => {\n+      if (!isTemplateContext(compiler.getNextProgram(), fileName, position)) {\n+        return undefined;\n+      }\n+      return new DefinitionBuilder(this.tsLS, compiler)\n+          .getTypeDefinitionsAtPosition(fileName, position);\n+    });\n   }\n \n   getQuickInfoAtPosition(fileName: string, position: number): ts.QuickInfo|undefined {\n@@ -169,37 +174,51 @@ export class LanguageService {\n   getCompletionsAtPosition(\n       fileName: string, position: number, options: ts.GetCompletionsAtPositionOptions|undefined):\n       ts.WithMetadata<ts.CompletionInfo>|undefined {\n-    const builder = this.getCompletionBuilder(fileName, position);\n-    if (builder === null) {\n-      return undefined;\n-    }\n-    const result = builder.getCompletionsAtPosition(options);\n-    this.compilerFactory.registerLastKnownProgram();\n-    return result;\n+    return this.withCompiler((compiler) => {\n+      if (!isTemplateContext(compiler.getNextProgram(), fileName, position)) {\n+        return undefined;\n+      }\n+\n+      const builder = this.getCompletionBuilder(fileName, position);\n+      if (builder === null) {\n+        return undefined;\n+      }\n+      return builder.getCompletionsAtPosition(options);\n+    });\n   }\n \n   getCompletionEntryDetails(\n       fileName: string, position: number, entryName: string,\n       formatOptions: ts.FormatCodeOptions|ts.FormatCodeSettings|undefined,\n       preferences: ts.UserPreferences|undefined): ts.CompletionEntryDetails|undefined {\n-    const builder = this.getCompletionBuilder(fileName, position);\n-    if (builder === null) {\n-      return undefined;\n-    }\n-    const result = builder.getCompletionEntryDetails(entryName, formatOptions, preferences);\n-    this.compilerFactory.registerLastKnownProgram();\n-    return result;\n+    return this.withCompiler((compiler) => {\n+      if (!isTemplateContext(compiler.getNextProgram(), fileName, position)) {\n+        return undefined;\n+      }\n+\n+      const builder = this.getCompletionBuilder(fileName, position);\n+      if (builder === null) {\n+        return undefined;\n+      }\n+      return builder.getCompletionEntryDetails(entryName, formatOptions, preferences);\n+    });\n   }\n \n   getCompletionEntrySymbol(fileName: string, position: number, entryName: string): ts.Symbol\n       |undefined {\n-    const builder = this.getCompletionBuilder(fileName, position);\n-    if (builder === null) {\n-      return undefined;\n-    }\n-    const result = builder.getCompletionEntrySymbol(entryName);\n-    this.compilerFactory.registerLastKnownProgram();\n-    return result;\n+    return this.withCompiler((compiler) => {\n+      if (!isTemplateContext(compiler.getNextProgram(), fileName, position)) {\n+        return undefined;\n+      }\n+\n+      const builder = this.getCompletionBuilder(fileName, position);\n+      if (builder === null) {\n+        return undefined;\n+      }\n+      const result = builder.getCompletionEntrySymbol(entryName);\n+      this.compilerFactory.registerLastKnownProgram();\n+      return result;\n+    });\n   }\n \n   getComponentLocationsForTemplate(fileName: string): GetComponentLocationsForTemplateResponse {\n@@ -432,3 +451,46 @@ function nodeContextFromTarget(target: TargetContext): CompletionNodeContext {\n       return CompletionNodeContext.None;\n   }\n }\n+\n+function isTemplateContext(program: ts.Program, fileName: string, position: number): boolean {\n+  if (!isTypeScriptFile(fileName)) {\n+    // If we aren't in a TS file, we must be in an HTML file, which we treat as template context\n+    return true;\n+  }\n+\n+  const node = findTightestNodeAtPosition(program, fileName, position);\n+  if (node === undefined) {\n+    return false;\n+  }\n+\n+  let asgn = getPropertyAssignmentFromValue(node, 'template');\n+  if (asgn === null) {\n+    return false;\n+  }\n+  return getClassDeclFromDecoratorProp(asgn) !== null;\n+}\n+\n+function isInAngularContext(program: ts.Program, fileName: string, position: number) {\n+  if (!isTypeScriptFile(fileName)) {\n+    return true;\n+  }\n+\n+  const node = findTightestNodeAtPosition(program, fileName, position);\n+  if (node === undefined) {\n+    return false;\n+  }\n+\n+  const asgn = getPropertyAssignmentFromValue(node, 'template') ??\n+      getPropertyAssignmentFromValue(node, 'templateUrl') ??\n+      getPropertyAssignmentFromValue(node.parent, 'styleUrls');\n+  return asgn !== null && getClassDeclFromDecoratorProp(asgn) !== null;\n+}\n+\n+function findTightestNodeAtPosition(program: ts.Program, fileName: string, position: number) {\n+  const sourceFile = program.getSourceFile(fileName);\n+  if (sourceFile === undefined) {\n+    return undefined;\n+  }\n+\n+  return findTightestNode(sourceFile, position);\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "ef52343337fd31cdf00e16b878cb00e8d1de17d7",
            "filename": "packages/language-service/ivy/ts_utils.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 1,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/f31a6015a0ee5fef34c34478566d8570b68ad8c2/packages%2Flanguage-service%2Fivy%2Fts_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/f31a6015a0ee5fef34c34478566d8570b68ad8c2/packages%2Flanguage-service%2Fivy%2Fts_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_utils.ts?ref=f31a6015a0ee5fef34c34478566d8570b68ad8c2",
            "patch": "@@ -27,4 +27,55 @@ export function getParentClassDeclaration(startNode: ts.Node): ts.ClassDeclarati\n     startNode = startNode.parent;\n   }\n   return undefined;\n-}\n\\ No newline at end of file\n+}\n+\n+/**\n+ * Returns a property assignment from the assignment value if the property name\n+ * matches the specified `key`, or `null` if there is no match.\n+ */\n+export function getPropertyAssignmentFromValue(value: ts.Node, key: string): ts.PropertyAssignment|\n+    null {\n+  const propAssignment = value.parent;\n+  if (!propAssignment || !ts.isPropertyAssignment(propAssignment) ||\n+      propAssignment.name.getText() !== key) {\n+    return null;\n+  }\n+  return propAssignment;\n+}\n+\n+/**\n+ * Given a decorator property assignment, return the ClassDeclaration node that corresponds to the\n+ * directive class the property applies to.\n+ * If the property assignment is not on a class decorator, no declaration is returned.\n+ *\n+ * For example,\n+ *\n+ * @Component({\n+ *   template: '<div></div>'\n+ *   ^^^^^^^^^^^^^^^^^^^^^^^---- property assignment\n+ * })\n+ * class AppComponent {}\n+ *           ^---- class declaration node\n+ *\n+ * @param propAsgnNode property assignment\n+ */\n+export function getClassDeclFromDecoratorProp(propAsgnNode: ts.PropertyAssignment):\n+    ts.ClassDeclaration|undefined {\n+  if (!propAsgnNode.parent || !ts.isObjectLiteralExpression(propAsgnNode.parent)) {\n+    return;\n+  }\n+  const objLitExprNode = propAsgnNode.parent;\n+  if (!objLitExprNode.parent || !ts.isCallExpression(objLitExprNode.parent)) {\n+    return;\n+  }\n+  const callExprNode = objLitExprNode.parent;\n+  if (!callExprNode.parent || !ts.isDecorator(callExprNode.parent)) {\n+    return;\n+  }\n+  const decorator = callExprNode.parent;\n+  if (!decorator.parent || !ts.isClassDeclaration(decorator.parent)) {\n+    return;\n+  }\n+  const classDeclNode = decorator.parent;\n+  return classDeclNode;\n+}"
        }
    ],
    "stats": {
        "total": 177,
        "additions": 145,
        "deletions": 32
    }
}