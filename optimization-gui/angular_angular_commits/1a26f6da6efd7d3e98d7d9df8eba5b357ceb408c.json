{
    "author": "crisbeto",
    "message": "fix(core): migration error if program contains files outside of the project (#39790)\n\nCurrently all of our migrations are set up to find the tsconfig paths within a project,\ncreate a `Program` out of each and migrate the files inside of the `Program`. The\nproblem is that the `Program` can include files outside of the project and the CLI\nAPIs that we use to interact with the file system assume that all files are within\nthe project.\n\nThese changes consolidate the logic, that determines whether a file can be migrated,\nin a single place and add an extra check to exclude files outside of the root.\n\nFixes #39778.\n\nPR Close #39790",
    "sha": "1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
    "files": [
        {
            "sha": "31e701a98c2a0f255832665a691e8db683b63569",
            "filename": "packages/core/schematics/migrations/abstract-control-parent/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fabstract-control-parent%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fabstract-control-parent%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fabstract-control-parent%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -10,7 +10,7 @@ import {Rule, SchematicsException, Tree} from '@angular-devkit/schematics';\n import {relative} from 'path';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n import {findParentAccesses} from './util';\n \n \n@@ -36,8 +36,8 @@ function runNativeAbstractControlParentMigration(\n     tree: Tree, tsconfigPath: string, basePath: string) {\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   sourceFiles.forEach(sourceFile => {\n     // We sort the nodes based on their position in the file and we offset the positions by one"
        },
        {
            "sha": "45c96530d30207ca53987f6725aaf340909ea562",
            "filename": "packages/core/schematics/migrations/dynamic-queries/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fdynamic-queries%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fdynamic-queries%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fdynamic-queries%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -11,7 +11,7 @@ import {relative} from 'path';\n import * as ts from 'typescript';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n \n import {identifyDynamicQueryNodes, removeOptionsParameter, removeStaticFlag} from './util';\n \n@@ -39,8 +39,8 @@ export default function(): Rule {\n function runDynamicQueryMigration(tree: Tree, tsconfigPath: string, basePath: string) {\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n   const printer = ts.createPrinter();\n \n   sourceFiles.forEach(sourceFile => {"
        },
        {
            "sha": "8f566288a31456ae287b45ff5776d7fd84082563",
            "filename": "packages/core/schematics/migrations/google3/initialNavigationRule.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FinitialNavigationRule.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FinitialNavigationRule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FinitialNavigationRule.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -31,7 +31,7 @@ export class Rule extends Rules.TypedRule {\n     sourceFiles.forEach(sourceFile => initialNavigationCollector.visitNode(sourceFile));\n \n     const {assignments} = initialNavigationCollector;\n-    const transformer = new InitialNavigationTransform(typeChecker, getUpdateRecorder);\n+    const transformer = new InitialNavigationTransform(getUpdateRecorder);\n     const updateRecorders = new Map<ts.SourceFile, TslintUpdateRecorder>();\n \n     transformer.migrateInitialNavigationAssignments(Array.from(assignments));"
        },
        {
            "sha": "9c4a73b1344f325218c21482f032413167933b7e",
            "filename": "packages/core/schematics/migrations/initial-navigation/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Finitial-navigation%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Finitial-navigation%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Finitial-navigation%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -10,7 +10,7 @@ import {Rule, SchematicsException, Tree} from '@angular-devkit/schematics';\n import {relative} from 'path';\n import * as ts from 'typescript';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n import {InitialNavigationCollector} from './collector';\n import {InitialNavigationTransform} from './transform';\n import {UpdateRecorder} from './update_recorder';\n@@ -36,14 +36,14 @@ function runInitialNavigationMigration(tree: Tree, tsconfigPath: string, basePat\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n   const initialNavigationCollector = new InitialNavigationCollector(typeChecker);\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   // Analyze source files by detecting all modules.\n   sourceFiles.forEach(sourceFile => initialNavigationCollector.visitNode(sourceFile));\n \n   const {assignments} = initialNavigationCollector;\n-  const transformer = new InitialNavigationTransform(typeChecker, getUpdateRecorder);\n+  const transformer = new InitialNavigationTransform(getUpdateRecorder);\n   const updateRecorders = new Map<ts.SourceFile, UpdateRecorder>();\n   transformer.migrateInitialNavigationAssignments(Array.from(assignments));\n "
        },
        {
            "sha": "cecd85ccba081f59be622b26c4c15aff68e1ee93",
            "filename": "packages/core/schematics/migrations/initial-navigation/transform.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 14,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Finitial-navigation%2Ftransform.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Finitial-navigation%2Ftransform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Finitial-navigation%2Ftransform.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -13,9 +13,7 @@ import {UpdateRecorder} from './update_recorder';\n export class InitialNavigationTransform {\n   private printer = ts.createPrinter();\n \n-  constructor(\n-      private typeChecker: ts.TypeChecker,\n-      private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder) {}\n+  constructor(private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder) {}\n \n   /** Migrate the ExtraOptions#InitialNavigation property assignments. */\n   migrateInitialNavigationAssignments(literals: ts.PropertyAssignment[]) {\n@@ -62,14 +60,3 @@ function getUpdatedInitialNavigationValue(initializer: ts.Expression): ts.Expres\n \n   return !!newText ? ts.createIdentifier(`'${newText}'`) : null;\n }\n-\n-/**\n- * Check whether the value assigned to an `initialNavigation` assignment\n- * conforms to the expected types for ExtraOptions#InitialNavigation\n- * @param node the property assignment to check\n- */\n-function isValidInitialNavigationValue(node: ts.PropertyAssignment): boolean {\n-  return ts.isStringLiteralLike(node.initializer) ||\n-      node.initializer.kind === ts.SyntaxKind.FalseKeyword ||\n-      node.initializer.kind === ts.SyntaxKind.TrueKeyword;\n-}"
        },
        {
            "sha": "11c734e8840607cec7f6e8bb409d944263205ff4",
            "filename": "packages/core/schematics/migrations/missing-injectable/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fmissing-injectable%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -10,7 +10,7 @@ import {Rule, SchematicContext, SchematicsException, Tree} from '@angular-devkit\n import {relative} from 'path';\n import * as ts from 'typescript';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n import {NgDefinitionCollector} from './definition_collector';\n import {MissingInjectableTransform} from './transform';\n import {UpdateRecorder} from './update_recorder';\n@@ -46,8 +46,8 @@ function runMissingInjectableMigration(\n   const failures: string[] = [];\n   const typeChecker = program.getTypeChecker();\n   const definitionCollector = new NgDefinitionCollector(typeChecker);\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   // Analyze source files by detecting all modules, directives and components.\n   sourceFiles.forEach(sourceFile => definitionCollector.visitNode(sourceFile));"
        },
        {
            "sha": "feaa64554176b6c127215a7590ed98823f7003eb",
            "filename": "packages/core/schematics/migrations/module-with-providers/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fmodule-with-providers%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fmodule-with-providers%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fmodule-with-providers%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -11,7 +11,7 @@ import {relative} from 'path';\n import * as ts from 'typescript';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n \n import {Collector} from './collector';\n import {AnalysisFailure, ModuleWithProvidersTransform} from './transform';\n@@ -49,8 +49,8 @@ function runModuleWithProvidersMigration(tree: Tree, tsconfigPath: string, baseP\n   const failures: string[] = [];\n   const typeChecker = program.getTypeChecker();\n   const collector = new Collector(typeChecker);\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   // Analyze source files by detecting all modules.\n   sourceFiles.forEach(sourceFile => collector.visitNode(sourceFile));"
        },
        {
            "sha": "bcfe1221d72d21902372e4cb5b61d1c4c9f25fce",
            "filename": "packages/core/schematics/migrations/move-document/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fmove-document%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fmove-document%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fmove-document%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -11,7 +11,7 @@ import {relative} from 'path';\n import * as ts from 'typescript';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n \n import {COMMON_IMPORT, DOCUMENT_TOKEN_NAME, DocumentImportVisitor, ResolvedDocumentImport} from './document_import_visitor';\n import {addToImport, createImport, removeFromImport} from './move-import';\n@@ -43,8 +43,8 @@ function runMoveDocumentMigration(tree: Tree, tsconfigPath: string, basePath: st\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n   const visitor = new DocumentImportVisitor(typeChecker);\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   // Analyze source files by finding imports.\n   sourceFiles.forEach(sourceFile => visitor.visitNode(sourceFile));"
        },
        {
            "sha": "83d7a8312fb4eaa4e59f6e3a4f7417b16e2bf27c",
            "filename": "packages/core/schematics/migrations/native-view-encapsulation/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -10,7 +10,7 @@ import {Rule, SchematicsException, Tree} from '@angular-devkit/schematics';\n import {relative} from 'path';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n import {findNativeEncapsulationNodes} from './util';\n \n \n@@ -35,8 +35,8 @@ export default function(): Rule {\n function runNativeViewEncapsulationMigration(tree: Tree, tsconfigPath: string, basePath: string) {\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   sourceFiles.forEach(sourceFile => {\n     const update = tree.beginUpdate(relative(basePath, sourceFile.fileName));"
        },
        {
            "sha": "b027a24da19ade827fbd41e19280e4ca33648617",
            "filename": "packages/core/schematics/migrations/navigation-extras-omissions/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fnavigation-extras-omissions%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fnavigation-extras-omissions%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fnavigation-extras-omissions%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -11,7 +11,7 @@ import {relative} from 'path';\n import * as ts from 'typescript';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n import {findLiteralsToMigrate, migrateLiteral} from './util';\n \n \n@@ -38,8 +38,8 @@ function runNavigationExtrasOmissionsMigration(tree: Tree, tsconfigPath: string,\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n   const printer = ts.createPrinter();\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   sourceFiles.forEach(sourceFile => {\n     const literalsToMigrate = findLiteralsToMigrate(sourceFile, typeChecker);"
        },
        {
            "sha": "dba0f51508db48db0e1b36b54791d90458f66356",
            "filename": "packages/core/schematics/migrations/relative-link-resolution/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Frelative-link-resolution%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Frelative-link-resolution%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frelative-link-resolution%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -10,7 +10,7 @@ import {Rule, SchematicsException, Tree} from '@angular-devkit/schematics';\n import {relative} from 'path';\n import * as ts from 'typescript';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n import {RelativeLinkResolutionCollector} from './collector';\n import {RelativeLinkResolutionTransform} from './transform';\n import {UpdateRecorder} from './update_recorder';\n@@ -36,8 +36,8 @@ function runRelativeLinkResolutionMigration(tree: Tree, tsconfigPath: string, ba\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n   const relativeLinkResolutionCollector = new RelativeLinkResolutionCollector(typeChecker);\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   // Analyze source files by detecting all modules.\n   sourceFiles.forEach(sourceFile => relativeLinkResolutionCollector.visitNode(sourceFile));"
        },
        {
            "sha": "9caa76a98c97292e6870c5eb5b2d89406b8fea16",
            "filename": "packages/core/schematics/migrations/renderer-to-renderer2/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Frenderer-to-renderer2%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Frenderer-to-renderer2%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frenderer-to-renderer2%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -11,7 +11,7 @@ import {relative} from 'path';\n import * as ts from 'typescript';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n import {getImportSpecifier, replaceImport} from '../../utils/typescript/imports';\n import {closestNode} from '../../utils/typescript/nodes';\n \n@@ -59,8 +59,8 @@ function runRendererToRenderer2Migration(tree: Tree, tsconfigPath: string, baseP\n   }, [MODULE_AUGMENTATION_FILENAME]);\n   const typeChecker = program.getTypeChecker();\n   const printer = ts.createPrinter();\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   sourceFiles.forEach(sourceFile => {\n     const rendererImportSpecifier = getImportSpecifier(sourceFile, '@angular/core', 'Renderer');"
        },
        {
            "sha": "79c4f125ac4ce91ea68021d1898af1bd76159cb7",
            "filename": "packages/core/schematics/migrations/router-preserve-query-params/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-preserve-query-params%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -11,7 +11,7 @@ import {relative} from 'path';\n import * as ts from 'typescript';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n import {findLiteralsToMigrate, migrateLiteral} from './util';\n \n \n@@ -41,8 +41,8 @@ function runPreserveQueryParamsMigration(tree: Tree, tsconfigPath: string, baseP\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n   const printer = ts.createPrinter();\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   sourceFiles.forEach(sourceFile => {\n     const literalsToMigrate = findLiteralsToMigrate(sourceFile, typeChecker);"
        },
        {
            "sha": "b0c684a78e7198546097010667fd4eb63c717a5a",
            "filename": "packages/core/schematics/migrations/static-queries/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -14,7 +14,7 @@ import * as ts from 'typescript';\n \n import {NgComponentTemplateVisitor} from '../../utils/ng_component_template';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n \n import {NgQueryResolveVisitor} from './angular/ng_query_visitor';\n import {QueryTemplateStrategy} from './strategies/template_strategy/template_strategy';\n@@ -123,8 +123,8 @@ function analyzeProject(\n   }\n \n   const typeChecker = program.getTypeChecker();\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n   const queryVisitor = new NgQueryResolveVisitor(typeChecker);\n \n   // Analyze all project source-files and collect all queries that"
        },
        {
            "sha": "8f9f7f79d251a2235edfef07952313e4b9b32ed9",
            "filename": "packages/core/schematics/migrations/template-var-assignment/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -12,7 +12,7 @@ import {relative} from 'path';\n \n import {NgComponentTemplateVisitor} from '../../utils/ng_component_template';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n \n import {analyzeResolvedTemplate} from './analyze_template';\n \n@@ -48,8 +48,8 @@ function runTemplateVariableAssignmentCheck(\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n   const templateVisitor = new NgComponentTemplateVisitor(typeChecker);\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   // Analyze source files by detecting HTML templates.\n   sourceFiles.forEach(sourceFile => templateVisitor.visitNode(sourceFile));"
        },
        {
            "sha": "0676ed5de02fe7d5470222f1cdb43ac725b5dc4d",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-decorated-fields/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-decorated-fields%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-decorated-fields%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-decorated-fields%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -11,7 +11,7 @@ import {relative} from 'path';\n import * as ts from 'typescript';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n \n import {UndecoratedClassesWithDecoratedFieldsTransform} from './transform';\n import {UpdateRecorder} from './update_recorder';\n@@ -49,8 +49,8 @@ function runUndecoratedClassesMigration(\n   const failures: string[] = [];\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n-  const sourceFiles = program.getSourceFiles().filter(\n-      file => !file.isDeclarationFile && !program.isSourceFileFromExternalLibrary(file));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n   const updateRecorders = new Map<ts.SourceFile, UpdateRecorder>();\n   const transform =\n       new UndecoratedClassesWithDecoratedFieldsTransform(typeChecker, getUpdateRecorder);"
        },
        {
            "sha": "26d27102ffb1fb32f39a22b7e742d41d70ecc637",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -16,7 +16,7 @@ import {relative} from 'path';\n import * as ts from 'typescript';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationCompilerHost} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationCompilerHost} from '../../utils/typescript/compiler_host';\n \n import {createNgcProgram} from './create_ngc_program';\n import {NgDeclarationCollector} from './ng_declaration_collector';\n@@ -85,8 +85,8 @@ function runUndecoratedClassesMigration(\n   const partialEvaluator = new PartialEvaluator(\n       new TypeScriptReflectionHost(typeChecker), typeChecker, /* dependencyTracker */ null);\n   const declarationCollector = new NgDeclarationCollector(typeChecker, partialEvaluator);\n-  const sourceFiles = program.getSourceFiles().filter(\n-      s => !s.isDeclarationFile && !program.isSourceFileFromExternalLibrary(s));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n \n   // Analyze source files by detecting all directives, components and providers.\n   sourceFiles.forEach(sourceFile => declarationCollector.visitNode(sourceFile));"
        },
        {
            "sha": "8c04faa58dc5ece87431363a5d91ee4347f417c5",
            "filename": "packages/core/schematics/migrations/wait-for-async/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fwait-for-async%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Fmigrations%2Fwait-for-async%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fwait-for-async%2Findex.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -11,7 +11,7 @@ import {relative} from 'path';\n import * as ts from 'typescript';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n-import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n import {getImportSpecifier, replaceImport} from '../../utils/typescript/imports';\n import {closestNode} from '../../utils/typescript/nodes';\n \n@@ -54,8 +54,8 @@ function runWaitForAsyncMigration(tree: Tree, tsconfigPath: string, basePath: st\n   }, [MODULE_AUGMENTATION_FILENAME]);\n   const typeChecker = program.getTypeChecker();\n   const printer = ts.createPrinter();\n-  const sourceFiles = program.getSourceFiles().filter(\n-      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n   const deprecatedFunction = 'async';\n   const newFunction = 'waitForAsync';\n "
        },
        {
            "sha": "e39bdbc8ec6985cbf4b7e2d8c017e182cb936de4",
            "filename": "packages/core/schematics/utils/typescript/compiler_host.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Futils%2Ftypescript%2Fcompiler_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c/packages%2Fcore%2Fschematics%2Futils%2Ftypescript%2Fcompiler_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Futils%2Ftypescript%2Fcompiler_host.ts?ref=1a26f6da6efd7d3e98d7d9df8eba5b357ceb408c",
            "patch": "@@ -57,3 +57,24 @@ export function createMigrationCompilerHost(\n \n   return host;\n }\n+\n+/**\n+ * Checks whether a file can be migrate by our automated migrations.\n+ * @param basePath Absolute path to the project.\n+ * @param sourceFile File being checked.\n+ * @param program Program that includes the source file.\n+ */\n+export function canMigrateFile(\n+    basePath: string, sourceFile: ts.SourceFile, program: ts.Program): boolean {\n+  // We shouldn't migrate .d.ts files or files from an external library.\n+  if (sourceFile.isDeclarationFile || program.isSourceFileFromExternalLibrary(sourceFile)) {\n+    return false;\n+  }\n+\n+  // Our migrations are set up to create a `Program` from the project's tsconfig and to migrate all\n+  // the files within the program. This can include files that are outside of the Angular CLI\n+  // project. We can't migrate files outside of the project, because our file system interactions\n+  // go through the CLI's `Tree` which assumes that all files are within the project. See:\n+  // https://github.com/angular/angular-cli/blob/0b0961c9c233a825b6e4bb59ab7f0790f9b14676/packages/angular_devkit/schematics/src/tree/host-tree.ts#L131\n+  return !relative(basePath, sourceFile.fileName).startsWith('..');\n+}"
        }
    ],
    "stats": {
        "total": 136,
        "additions": 72,
        "deletions": 64
    }
}