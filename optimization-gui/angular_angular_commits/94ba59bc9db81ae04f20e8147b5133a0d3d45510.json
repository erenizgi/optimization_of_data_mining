{
    "author": "crisbeto",
    "message": "feat(core): enable test module teardown by default (#43353)\n\nSets the `destroyAfterEach` teardown behavior to be enabled by default.\n\nPR Close #43353",
    "sha": "94ba59bc9db81ae04f20e8147b5133a0d3d45510",
    "files": [
        {
            "sha": "d531a24b85cf516699ed84d5d4db3cda0d147531",
            "filename": "packages/core/test/test_bed_spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/94ba59bc9db81ae04f20e8147b5133a0d3d45510/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/94ba59bc9db81ae04f20e8147b5133a0d3d45510/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts?ref=94ba59bc9db81ae04f20e8147b5133a0d3d45510",
            "patch": "@@ -1344,20 +1344,20 @@ describe('TestBed module teardown', () => {\n     TestBed.resetTestingModule();\n   });\n \n-  it('should not tear down the test module by default', () => {\n-    expect(TestBed.shouldTearDownTestingModule()).toBe(false);\n+  it('should tear down the test module by default', () => {\n+    expect(TestBed.shouldTearDownTestingModule()).toBe(true);\n   });\n \n   it('should be able to configure the teardown behavior', () => {\n-    TestBed.configureTestingModule({teardown: {destroyAfterEach: true}});\n-    expect(TestBed.shouldTearDownTestingModule()).toBe(true);\n+    TestBed.configureTestingModule({teardown: {destroyAfterEach: false}});\n+    expect(TestBed.shouldTearDownTestingModule()).toBe(false);\n   });\n \n   it('should reset the teardown behavior back to the default when TestBed is reset', () => {\n-    TestBed.configureTestingModule({teardown: {destroyAfterEach: true}});\n-    expect(TestBed.shouldTearDownTestingModule()).toBe(true);\n-    TestBed.resetTestingModule();\n+    TestBed.configureTestingModule({teardown: {destroyAfterEach: false}});\n     expect(TestBed.shouldTearDownTestingModule()).toBe(false);\n+    TestBed.resetTestingModule();\n+    expect(TestBed.shouldTearDownTestingModule()).toBe(true);\n   });\n \n   it('should destroy test module providers when test module teardown is enabled', () => {"
        },
        {
            "sha": "af228342b27bce9675c4ede68f97523b36741fef",
            "filename": "packages/core/testing/src/test_bed.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/94ba59bc9db81ae04f20e8147b5133a0d3d45510/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed.ts",
            "raw_url": "https://github.com/angular/angular/raw/94ba59bc9db81ae04f20e8147b5133a0d3d45510/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed.ts?ref=94ba59bc9db81ae04f20e8147b5133a0d3d45510",
            "patch": "@@ -465,8 +465,11 @@ export class TestBedViewEngine implements TestBed {\n     this._moduleRef = this._moduleFactory.create(ngZoneInjector);\n     // ApplicationInitStatus.runInitializers() is marked @internal to core. So casting to any\n     // before accessing it.\n-    (this._moduleRef.injector.get(ApplicationInitStatus) as any).runInitializers();\n-    this._instantiated = true;\n+    try {\n+      (this._moduleRef.injector.get(ApplicationInitStatus) as any).runInitializers();\n+    } finally {\n+      this._instantiated = true;\n+    }\n   }\n \n   private _createCompilerAndModule(): Type<any> {"
        },
        {
            "sha": "85dfdb2a2584f03b4cc1d17d3c659ca078ece932",
            "filename": "packages/core/testing/src/test_bed_common.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/94ba59bc9db81ae04f20e8147b5133a0d3d45510/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed_common.ts",
            "raw_url": "https://github.com/angular/angular/raw/94ba59bc9db81ae04f20e8147b5133a0d3d45510/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed_common.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Ftest_bed_common.ts?ref=94ba59bc9db81ae04f20e8147b5133a0d3d45510",
            "patch": "@@ -12,11 +12,8 @@ import {ComponentFixture} from './component_fixture';\n import {MetadataOverride} from './metadata_override';\n import {TestBed} from './test_bed';\n \n-/**\n- * Whether test modules should be torn down by default.\n- * Currently disabled for backwards-compatibility reasons.\n- */\n-export const TEARDOWN_TESTING_MODULE_ON_DESTROY_DEFAULT = false;\n+/** Whether test modules should be torn down by default. */\n+export const TEARDOWN_TESTING_MODULE_ON_DESTROY_DEFAULT = true;\n \n /**\n  * An abstract class for inserting the root test component element in a platform independent way."
        },
        {
            "sha": "1c783ac55b5ccc45b21a2630240e61e3e57ba6b3",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 37,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/94ba59bc9db81ae04f20e8147b5133a0d3d45510/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/94ba59bc9db81ae04f20e8147b5133a0d3d45510/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=94ba59bc9db81ae04f20e8147b5133a0d3d45510",
            "patch": "@@ -16,7 +16,6 @@ import {ActivatedRoute, ActivatedRouteSnapshot, ActivationEnd, ActivationStart,\n import {EMPTY, Observable, Observer, of, Subscription, SubscriptionLike} from 'rxjs';\n import {delay, filter, first, map, mapTo, tap} from 'rxjs/operators';\n \n-import {RouterInitializer} from '../src/router_module';\n import {forEach} from '../src/utils/collection';\n import {isUrlTree} from '../src/utils/type_guards';\n import {RouterTestingModule} from '../testing';\n@@ -5943,42 +5942,6 @@ describe('Integration', () => {\n          expect(fixture).toContainComponent(Tool2Component, '(e)');\n        }));\n   });\n-\n-  describe('RouterInitializer', () => {\n-    it('should not throw from appInitializer if module is destroyed before location is initialized',\n-       done => {\n-         let resolveInitializer: () => void;\n-         let moduleRef: NgModuleRef<SelfDestructModule>;\n-\n-         @NgModule({\n-           imports: [RouterModule.forRoot([])],\n-           providers: [\n-             {\n-               provide: LOCATION_INITIALIZED,\n-               useValue: new Promise<void>(resolve => resolveInitializer = resolve)\n-             },\n-             {\n-               // Required when running the tests in a browser\n-               provide: APP_BASE_HREF,\n-               useValue: ''\n-             }\n-           ]\n-         })\n-         class SelfDestructModule {\n-           constructor(ref: NgModuleRef<SelfDestructModule>, routerInitializer: RouterInitializer) {\n-             moduleRef = ref;\n-             routerInitializer.appInitializer().then(done, done.fail);\n-           }\n-         }\n-\n-         TestBed.resetTestingModule()\n-             .configureTestingModule({imports: [SelfDestructModule], declarations: [SimpleCmp]})\n-             .createComponent(SimpleCmp);\n-\n-         moduleRef!.destroy();\n-         resolveInitializer!();\n-       });\n-  });\n });\n \n describe('Testing router options', () => {"
        },
        {
            "sha": "7d98600477276ec661f569460781a650359a8591",
            "filename": "packages/service-worker/test/comm_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/94ba59bc9db81ae04f20e8147b5133a0d3d45510/packages%2Fservice-worker%2Ftest%2Fcomm_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/94ba59bc9db81ae04f20e8147b5133a0d3d45510/packages%2Fservice-worker%2Ftest%2Fcomm_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Ftest%2Fcomm_spec.ts?ref=94ba59bc9db81ae04f20e8147b5133a0d3d45510",
            "patch": "@@ -469,7 +469,7 @@ import {MockPushManager, MockPushSubscription, MockServiceWorkerContainer, MockS\n             status: true,\n           });\n         });\n-        return update.activateUpdate().then(() => done()).catch(err => done.fail(err));\n+        update.activateUpdate().then(() => done()).catch(err => done.fail(err));\n       });\n       it('reports activation failure when requested', done => {\n         mock.messages.subscribe((msg: {action: string, statusNonce: number}) => {\n@@ -481,7 +481,7 @@ import {MockPushManager, MockPushSubscription, MockServiceWorkerContainer, MockS\n             error: 'Failed to activate',\n           });\n         });\n-        return update.activateUpdate()\n+        update.activateUpdate()\n             .catch(err => {\n               expect(err.message).toEqual('Failed to activate');\n             })"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 16,
        "deletions": 53
    }
}