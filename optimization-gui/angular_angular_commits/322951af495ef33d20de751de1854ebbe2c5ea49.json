{
    "author": "petebacondarwin",
    "message": "refactor(compiler-cli): error on cyclic imports in partial compilation (#40782)\n\nOur approach for handling cyclic imports results in code that is\nnot easy to tree-shake, so it is not suitable for publishing in a\nlibrary.\n\nWhen compiling in partial compilation mode, we are targeting\nsuch library publication, so we now create a fatal diagnostic\nerror instead of trying to handle the cyclic import situation.\n\nCloses #40678\n\nPR Close #40782",
    "sha": "322951af495ef33d20de751de1854ebbe2c5ea49",
    "files": [
        {
            "sha": "2122274820e0ab401684b2459a2c1c62a6ffdcf8",
            "filename": ".pullapprove.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/.pullapprove.yml",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/.pullapprove.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.pullapprove.yml?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -1223,6 +1223,7 @@ groups:\n           'aio/content/errors/*.md',\n           'aio/content/guide/glossary.md',\n           'aio/content/guide/styleguide.md',\n+          'aio/content/examples/errors/**',\n           'aio/content/examples/styleguide/**',\n           'aio/content/images/guide/styleguide/*'\n           ])"
        },
        {
            "sha": "6016d823d6633a1491f0f2f30ee0e4691bb96f04",
            "filename": "aio/content/errors/NG3003.md",
            "status": "added",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/aio%2Fcontent%2Ferrors%2FNG3003.md",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/aio%2Fcontent%2Ferrors%2FNG3003.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Ferrors%2FNG3003.md?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -0,0 +1,55 @@\n+@name Import Cycle Detected\n+@category compiler\n+@shortDescription Import cycles would need to be created to compile this component\n+\n+@description\n+\n+A component, directive or pipe that is referenced by this component would require the compiler\n+to add an import that would lead to a cycle of imports.  For example, consider a scenario where\n+a `ParentComponent` references a `ChildComponent` in its template:\n+\n+<code-example path=\"errors/cyclic-imports/parent.component.ts\" header=\"parent.component.ts\"></code-example>\n+\n+<code-example path=\"errors/cyclic-imports/child.component.ts\" header=\"child.component.ts\"></code-example>\n+\n+There is already an import from `child.component.ts` to `parent.component.ts` since the `ChildComponent`\n+references the `ParentComponent` in its constructor.\n+\n+But note that the parent component's template contains `<child></child>`. The generated code for this\n+template must therefore contain a reference to the `ChildComponent` class. In order to make this reference\n+the compiler would have to add an import from `parent.component.ts` to `child.component.ts`, which would\n+cause an import cycle:\n+\n+```\n+parent.component.ts -> child.component.ts -> parent.component.ts\n+```\n+\n+### Remote Scoping\n+\n+To avoid adding imports that create cycles, additional code is added to the `NgModule` class where\n+the component is declared that wires up the dependencies. This is known as \"remote scoping\".\n+\n+\n+### Libraries\n+\n+Unfortunately, \"remote scoping\" code is side-effectful, which prevents tree shaking, and cannot\n+be used in libraries. So when building libraries using the `\"compilationMode\": \"partial\"` setting,\n+any component that would require a cyclic import will cause this `NG3003` compiler error to be raised.\n+\n+\n+@debugging\n+\n+The cycle that would be generated is shown as part of the error message. For example:\n+\n+<code-example hideCopy=\"true\">\n+<span class=\"nocode\">The component ChildComponent is used in the template but importing it would create a cycle:\n+/parent.component.ts -> /child.component.ts -> /parent.component.ts</span>\n+</code-example>\n+\n+Use this to identify how the referenced component, pipe or directive has a dependency back to the\n+component being compiled. Here are some ideas for fixing the problem:\n+\n+* Try to re-arrange your dependencies to avoid the cycle. For example using an intermediate interface\n+that is stored in an independent file that can be imported to both dependent files without\n+causing an import cycle.\n+* Move the classes that reference each other into the same file, to avoid any imports between them."
        },
        {
            "sha": "94a1df51fe86aec38d20f3f95acb97f1ea959728",
            "filename": "aio/content/examples/errors/cyclic-imports/child.component.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/aio%2Fcontent%2Fexamples%2Ferrors%2Fcyclic-imports%2Fchild.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/aio%2Fcontent%2Fexamples%2Ferrors%2Fcyclic-imports%2Fchild.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Ferrors%2Fcyclic-imports%2Fchild.component.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -0,0 +1,7 @@\n+import { Component } from '@angular/core';\n+import { ParentComponent } from './parent.component';\n+\n+@Component({selector: 'app-child', template: 'The child!'})\n+export class ChildComponent {\n+  constructor(private parent: ParentComponent) {}\n+}"
        },
        {
            "sha": "a153f4783caf33db0175c394ef4676256928dfb9",
            "filename": "aio/content/examples/errors/cyclic-imports/module.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/aio%2Fcontent%2Fexamples%2Ferrors%2Fcyclic-imports%2Fmodule.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/aio%2Fcontent%2Fexamples%2Ferrors%2Fcyclic-imports%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Ferrors%2Fcyclic-imports%2Fmodule.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -0,0 +1,8 @@\n+import { NgModule } from '@angular/core';\n+import { ChildComponent } from './child.component';\n+import { ParentComponent } from './parent.component';\n+\n+@NgModule({\n+  declarations: [ParentComponent, ChildComponent]\n+})\n+export class AppModule {}"
        },
        {
            "sha": "6f20a3bcc0f0e88b8e053864eb9dfeac072f0949",
            "filename": "aio/content/examples/errors/cyclic-imports/parent.component.ts",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/aio%2Fcontent%2Fexamples%2Ferrors%2Fcyclic-imports%2Fparent.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/aio%2Fcontent%2Fexamples%2Ferrors%2Fcyclic-imports%2Fparent.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Ferrors%2Fcyclic-imports%2Fparent.component.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -0,0 +1,4 @@\n+import { Component } from '@angular/core';\n+\n+@Component({selector: 'app-parent', template: '<app-child></app-child>'})\n+export class ParentComponent {}"
        },
        {
            "sha": "ccfbd47e710e8431bf2ce23f42ba7e52320a7240",
            "filename": "goldens/public-api/compiler-cli/error_code.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -17,6 +17,7 @@ export declare enum ErrorCode {\n     COMPONENT_RESOURCE_NOT_FOUND = 2008,\n     SYMBOL_NOT_EXPORTED = 3001,\n     SYMBOL_EXPORTED_UNDER_DIFFERENT_NAME = 3002,\n+    IMPORT_CYCLE_DETECTED = 3003,\n     CONFIG_FLAT_MODULE_NO_INDEX = 4001,\n     CONFIG_STRICT_TEMPLATES_IMPLIES_FULL_TEMPLATE_TYPECHECK = 4002,\n     HOST_BINDING_PARSE_ERROR = 5001,"
        },
        {
            "sha": "c0b48fd38ba90ae274e15aabb65faa4cedbcd939",
            "filename": "packages/compiler-cli/ngcc/src/analysis/decoration_analyzer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -10,7 +10,7 @@ import * as ts from 'typescript';\n \n import {ParsedConfiguration} from '../../..';\n import {ComponentDecoratorHandler, DirectiveDecoratorHandler, InjectableDecoratorHandler, NgModuleDecoratorHandler, PipeDecoratorHandler, ReferencesRegistry, ResourceLoader} from '../../../src/ngtsc/annotations';\n-import {CycleAnalyzer, ImportGraph} from '../../../src/ngtsc/cycles';\n+import {CycleAnalyzer, CycleHandlingStrategy, ImportGraph} from '../../../src/ngtsc/cycles';\n import {isFatalDiagnosticError} from '../../../src/ngtsc/diagnostics';\n import {absoluteFromSourceFile, LogicalFileSystem, ReadonlyFileSystem} from '../../../src/ngtsc/file_system';\n import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, NOOP_DEFAULT_IMPORT_RECORDER, PrivateExportAliasingHost, Reexport, ReferenceEmitter} from '../../../src/ngtsc/imports';\n@@ -101,8 +101,9 @@ export class DecorationAnalyzer {\n         /* i18nUseExternalIds */ true, this.bundle.enableI18nLegacyMessageIdFormat,\n         /* usePoisonedData */ false,\n         /* i18nNormalizeLineEndingsInICUs */ false, this.moduleResolver, this.cycleAnalyzer,\n-        this.refEmitter, NOOP_DEFAULT_IMPORT_RECORDER, NOOP_DEPENDENCY_TRACKER,\n-        this.injectableRegistry, !!this.compilerOptions.annotateForClosureCompiler),\n+        CycleHandlingStrategy.UseRemoteScoping, this.refEmitter, NOOP_DEFAULT_IMPORT_RECORDER,\n+        NOOP_DEPENDENCY_TRACKER, this.injectableRegistry,\n+        !!this.compilerOptions.annotateForClosureCompiler),\n     // See the note in ngtsc about why this cast is needed.\n     // clang-format off\n     new DirectiveDecoratorHandler("
        },
        {
            "sha": "0dfddae248767bff1b3833f39f3c232014735325",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 69,
            "deletions": 19,
            "changes": 88,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -9,9 +9,9 @@\n import {compileComponentFromMetadata, compileDeclareComponentFromMetadata, ConstantPool, CssSelector, DeclarationListEmitMode, DEFAULT_INTERPOLATION_CONFIG, DomElementSchemaRegistry, Expression, ExternalExpr, Identifiers, InterpolationConfig, LexerRange, makeBindingParser, ParsedTemplate, ParseSourceFile, parseTemplate, R3ComponentDef, R3ComponentMetadata, R3FactoryTarget, R3TargetBinder, R3UsedDirectiveMetadata, SelectorMatcher, Statement, TmplAstNode, WrappedNodeExpr} from '@angular/compiler';\n import * as ts from 'typescript';\n \n-import {CycleAnalyzer} from '../../cycles';\n-import {ErrorCode, FatalDiagnosticError} from '../../diagnostics';\n-import {absoluteFrom, AbsoluteFsPath, relative} from '../../file_system';\n+import {Cycle, CycleAnalyzer, CycleHandlingStrategy} from '../../cycles';\n+import {ErrorCode, FatalDiagnosticError, makeDiagnostic, makeRelatedInformation} from '../../diagnostics';\n+import {absoluteFrom, relative} from '../../file_system';\n import {DefaultImportRecorder, ModuleResolver, Reference, ReferenceEmitter} from '../../imports';\n import {DependencyTracker} from '../../incremental/api';\n import {IndexingContext} from '../../indexer';\n@@ -127,7 +127,8 @@ export class ComponentDecoratorHandler implements\n       private enableI18nLegacyMessageIdFormat: boolean, private usePoisonedData: boolean,\n       private i18nNormalizeLineEndingsInICUs: boolean|undefined,\n       private moduleResolver: ModuleResolver, private cycleAnalyzer: CycleAnalyzer,\n-      private refEmitter: ReferenceEmitter, private defaultImportRecorder: DefaultImportRecorder,\n+      private cycleHandlingStrategy: CycleHandlingStrategy, private refEmitter: ReferenceEmitter,\n+      private defaultImportRecorder: DefaultImportRecorder,\n       private depTracker: DependencyTracker|null,\n       private injectableRegistry: InjectableClassRegistry,\n       private annotateForClosureCompiler: boolean) {}\n@@ -546,10 +547,12 @@ export class ComponentDecoratorHandler implements\n           inputs: directive.inputs.propertyNames,\n           outputs: directive.outputs.propertyNames,\n           exportAs: directive.exportAs,\n+          isComponent: directive.isComponent,\n         };\n       });\n \n-      const usedPipes: {ref: Reference, pipeName: string, expression: Expression}[] = [];\n+      type UsedPipe = {ref: Reference, pipeName: string, expression: Expression};\n+      const usedPipes: UsedPipe[] = [];\n       for (const pipeName of bound.getUsedPipes()) {\n         if (!pipes.has(pipeName)) {\n           continue;\n@@ -564,10 +567,22 @@ export class ComponentDecoratorHandler implements\n \n       // Scan through the directives/pipes actually used in the template and check whether any\n       // import which needs to be generated would create a cycle.\n-      const cycleDetected = usedDirectives.some(dir => this._isCyclicImport(dir.type, context)) ||\n-          usedPipes.some(pipe => this._isCyclicImport(pipe.expression, context));\n+      const cyclesFromDirectives = new Map<UsedDirective, Cycle>();\n+      for (const usedDirective of usedDirectives) {\n+        const cycle = this._checkForCyclicImport(usedDirective.ref, usedDirective.type, context);\n+        if (cycle !== null) {\n+          cyclesFromDirectives.set(usedDirective, cycle);\n+        }\n+      }\n+      const cyclesFromPipes = new Map<UsedPipe, Cycle>();\n+      for (const usedPipe of usedPipes) {\n+        const cycle = this._checkForCyclicImport(usedPipe.ref, usedPipe.expression, context);\n+        if (cycle !== null) {\n+          cyclesFromPipes.set(usedPipe, cycle);\n+        }\n+      }\n \n-      if (!cycleDetected) {\n+      if (cyclesFromDirectives.size === 0 && cyclesFromPipes.size === 0) {\n         // No cycle was detected. Record the imports that need to be created in the cycle detector\n         // so that future cyclic import checks consider their production.\n         for (const {type} of usedDirectives) {\n@@ -592,11 +607,28 @@ export class ComponentDecoratorHandler implements\n             DeclarationListEmitMode.Closure :\n             DeclarationListEmitMode.Direct;\n       } else {\n-        // Declaring the directiveDefs/pipeDefs arrays directly would require imports that would\n-        // create a cycle. Instead, mark this component as requiring remote scoping, so that the\n-        // NgModule file will take care of setting the directives for the component.\n-        this.scopeRegistry.setComponentRemoteScope(\n-            node, usedDirectives.map(dir => dir.ref), usedPipes.map(pipe => pipe.ref));\n+        if (this.cycleHandlingStrategy === CycleHandlingStrategy.UseRemoteScoping) {\n+          // Declaring the directiveDefs/pipeDefs arrays directly would require imports that would\n+          // create a cycle. Instead, mark this component as requiring remote scoping, so that the\n+          // NgModule file will take care of setting the directives for the component.\n+          this.scopeRegistry.setComponentRemoteScope(\n+              node, usedDirectives.map(dir => dir.ref), usedPipes.map(pipe => pipe.ref));\n+        } else {\n+          // We are not able to handle this cycle so throw an error.\n+          const relatedMessages: ts.DiagnosticRelatedInformation[] = [];\n+          for (const [dir, cycle] of cyclesFromDirectives) {\n+            relatedMessages.push(\n+                makeCyclicImportInfo(dir.ref, dir.isComponent ? 'component' : 'directive', cycle));\n+          }\n+          for (const [pipe, cycle] of cyclesFromPipes) {\n+            relatedMessages.push(makeCyclicImportInfo(pipe.ref, 'pipe', cycle));\n+          }\n+          throw new FatalDiagnosticError(\n+              ErrorCode.IMPORT_CYCLE_DETECTED, node,\n+              'One or more import cycles would need to be created to compile this component, ' +\n+                  'which is not supported by the current compiler configuration.',\n+              relatedMessages);\n+        }\n       }\n     }\n \n@@ -1052,14 +1084,20 @@ export class ComponentDecoratorHandler implements\n     return this.moduleResolver.resolveModule(expr.value.moduleName!, origin.fileName);\n   }\n \n-  private _isCyclicImport(expr: Expression, origin: ts.SourceFile): boolean {\n-    const imported = this._expressionToImportedFile(expr, origin);\n-    if (imported === null) {\n-      return false;\n+  /**\n+   * Check whether adding an import from `origin` to the source-file corresponding to `expr` would\n+   * create a cyclic import.\n+   *\n+   * @returns a `Cycle` object if a cycle would be created, otherwise `null`.\n+   */\n+  private _checkForCyclicImport(ref: Reference, expr: Expression, origin: ts.SourceFile): Cycle\n+      |null {\n+    const importedFile = this._expressionToImportedFile(expr, origin);\n+    if (importedFile === null) {\n+      return null;\n     }\n-\n     // Check whether the import is legal.\n-    return this.cycleAnalyzer.wouldCreateCycle(origin, imported);\n+    return this.cycleAnalyzer.wouldCreateCycle(origin, importedFile);\n   }\n \n   private _recordSyntheticImport(expr: Expression, origin: ts.SourceFile): void {\n@@ -1219,3 +1257,15 @@ interface ExternalTemplateDeclaration extends CommonTemplateDeclaration {\n  * record without needing to parse the original decorator again.\n  */\n type TemplateDeclaration = InlineTemplateDeclaration|ExternalTemplateDeclaration;\n+\n+/**\n+ * Generate a diagnostic related information object that describes a potential cyclic import path.\n+ */\n+function makeCyclicImportInfo(\n+    ref: Reference, type: string, cycle: Cycle): ts.DiagnosticRelatedInformation {\n+  const name = ref.debugName || '(unknown)';\n+  const path = cycle.getPath().map(sf => sf.fileName).join(' -> ');\n+  const message =\n+      `The ${type} '${name}' is used in the template but importing it would create a cycle: `;\n+  return makeRelatedInformation(ref.node, message + path);\n+}"
        },
        {
            "sha": "ac5db42f1f16fe1d23cd10deaeb0c459fc64eaf6",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/test/component_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -9,7 +9,7 @@\n import {ConstantPool} from '@angular/compiler';\n import * as ts from 'typescript';\n \n-import {CycleAnalyzer, ImportGraph} from '../../cycles';\n+import {CycleAnalyzer, CycleHandlingStrategy, ImportGraph} from '../../cycles';\n import {ErrorCode, FatalDiagnosticError} from '../../diagnostics';\n import {absoluteFrom} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n@@ -73,6 +73,7 @@ function setup(program: ts.Program, options: ts.CompilerOptions, host: ts.Compil\n       /* i18nNormalizeLineEndingsInICUs */ undefined,\n       moduleResolver,\n       cycleAnalyzer,\n+      CycleHandlingStrategy.UseRemoteScoping,\n       refEmitter,\n       NOOP_DEFAULT_IMPORT_RECORDER,\n       /* depTracker */ null,"
        },
        {
            "sha": "f2b4a8e7b43c9b3dbbf4510f47225478d8e2d9f4",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -10,7 +10,7 @@ import {Type} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {ComponentDecoratorHandler, DirectiveDecoratorHandler, InjectableDecoratorHandler, NgModuleDecoratorHandler, NoopReferencesRegistry, PipeDecoratorHandler, ReferencesRegistry} from '../../annotations';\n-import {CycleAnalyzer, ImportGraph} from '../../cycles';\n+import {CycleAnalyzer, CycleHandlingStrategy, ImportGraph} from '../../cycles';\n import {COMPILER_ERRORS_WITH_GUIDES, ERROR_DETAILS_PAGE_BASE_URL, ErrorCode, ngErrorCode} from '../../diagnostics';\n import {checkForPrivateExports, ReferenceGraph} from '../../entry_point';\n import {LogicalFileSystem, resolve} from '../../file_system';\n@@ -985,6 +985,16 @@ export class NgCompiler {\n     const defaultImportTracker = new DefaultImportTracker();\n     const resourceRegistry = new ResourceRegistry();\n \n+    const compilationMode =\n+        this.options.compilationMode === 'partial' ? CompilationMode.PARTIAL : CompilationMode.FULL;\n+\n+    // Cycles are handled in full compilation mode by \"remote scoping\".\n+    // \"Remote scoping\" does not work well with tree shaking for libraries.\n+    // So in partial compilation mode, when building a library, a cycle will cause an error.\n+    const cycleHandlingStrategy = compilationMode === CompilationMode.FULL ?\n+        CycleHandlingStrategy.UseRemoteScoping :\n+        CycleHandlingStrategy.Error;\n+\n     // Set up the IvyCompilation, which manages state for the Ivy transformer.\n     const handlers: DecoratorHandler<unknown, unknown, unknown>[] = [\n       new ComponentDecoratorHandler(\n@@ -994,8 +1004,8 @@ export class NgCompiler {\n           this.options.i18nUseExternalIds !== false,\n           this.options.enableI18nLegacyMessageIdFormat !== false, this.usePoisonedData,\n           this.options.i18nNormalizeLineEndingsInICUs, this.moduleResolver, this.cycleAnalyzer,\n-          refEmitter, defaultImportTracker, this.incrementalDriver.depGraph, injectableRegistry,\n-          this.closureCompilerEnabled),\n+          cycleHandlingStrategy, refEmitter, defaultImportTracker, this.incrementalDriver.depGraph,\n+          injectableRegistry, this.closureCompilerEnabled),\n       // TODO(alxhub): understand why the cast here is necessary (something to do with `null`\n       // not being assignable to `unknown` when wrapped in `Readonly`).\n       // clang-format off\n@@ -1022,8 +1032,6 @@ export class NgCompiler {\n           this.closureCompilerEnabled, injectableRegistry, this.options.i18nInLocale),\n     ];\n \n-    const compilationMode =\n-        this.options.compilationMode === 'partial' ? CompilationMode.PARTIAL : CompilationMode.FULL;\n     const traitCompiler = new TraitCompiler(\n         handlers, reflector, this.perfRecorder, this.incrementalDriver,\n         this.options.compileNonExportedClasses !== false, compilationMode, dtsTransforms);"
        },
        {
            "sha": "251d72e27eb6ba7a2e9e56fc76a024ef4a57785d",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Findex.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -6,5 +6,5 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-export {CycleAnalyzer} from './src/analyzer';\n+export {Cycle, CycleAnalyzer, CycleHandlingStrategy} from './src/analyzer';\n export {ImportGraph} from './src/imports';"
        },
        {
            "sha": "d9cd9e4533b3222bc66dac049eddab6d6a6deb47",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/src/analyzer.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 3,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fanalyzer.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fanalyzer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fanalyzer.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -17,11 +17,17 @@ export class CycleAnalyzer {\n   constructor(private importGraph: ImportGraph) {}\n \n   /**\n-   * Check whether adding an import from `from` to `to` would create a cycle in the `ts.Program`.\n+   * Check for a cycle to be created in the `ts.Program` by adding an import between `from` and\n+   * `to`.\n+   *\n+   * @returns a `Cycle` object if an import between `from` and `to` would create a cycle; `null`\n+   *     otherwise.\n    */\n-  wouldCreateCycle(from: ts.SourceFile, to: ts.SourceFile): boolean {\n+  wouldCreateCycle(from: ts.SourceFile, to: ts.SourceFile): Cycle|null {\n     // Import of 'from' -> 'to' is illegal if an edge 'to' -> 'from' already exists.\n-    return this.importGraph.transitiveImportsOf(to).has(from);\n+    return this.importGraph.transitiveImportsOf(to).has(from) ?\n+        new Cycle(this.importGraph, from, to) :\n+        null;\n   }\n \n   /**\n@@ -34,3 +40,35 @@ export class CycleAnalyzer {\n     this.importGraph.addSyntheticImport(from, to);\n   }\n }\n+\n+/**\n+ * Represents an import cycle between `from` and `to` in the program.\n+ *\n+ * This class allows us to do the work to compute the cyclic path between `from` and `to` only if\n+ * needed.\n+ */\n+export class Cycle {\n+  constructor(\n+      private importGraph: ImportGraph, readonly from: ts.SourceFile, readonly to: ts.SourceFile) {}\n+\n+  /**\n+   * Compute an array of source-files that illustrates the cyclic path between `from` and `to`.\n+   *\n+   * Note that a `Cycle` will not be created unless a path is available between `to` and `from`,\n+   * so `findPath()` will never return `null`.\n+   */\n+  getPath(): ts.SourceFile[] {\n+    return [this.from, ...this.importGraph.findPath(this.to, this.from)!];\n+  }\n+}\n+\n+\n+/**\n+ * What to do if a cycle is detected.\n+ */\n+export const enum CycleHandlingStrategy {\n+  /** Add \"remote scoping\" code to avoid creating a cycle. */\n+  UseRemoteScoping,\n+  /** Fail the compilation with an error. */\n+  Error,\n+}"
        },
        {
            "sha": "4f9915a283d099f2cfc0e0eb70a1b4a078832d67",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/src/imports.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fimports.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fimports.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fimports.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -52,6 +52,44 @@ export class ImportGraph {\n     });\n   }\n \n+  /**\n+   * Find an import path from the `start` SourceFile to the `end` SourceFile.\n+   *\n+   * This function implements a breadth first search that results in finding the\n+   * shortest path between the `start` and `end` points.\n+   *\n+   * @param start the starting point of the path.\n+   * @param end the ending point of the path.\n+   * @returns an array of source files that connect the `start` and `end` source files, or `null` if\n+   *     no path could be found.\n+   */\n+  findPath(start: ts.SourceFile, end: ts.SourceFile): ts.SourceFile[]|null {\n+    if (start === end) {\n+      // Escape early for the case where `start` and `end` are the same.\n+      return [start];\n+    }\n+\n+    const found = new Set<ts.SourceFile>([start]);\n+    const queue: Found[] = [new Found(start, null)];\n+\n+    while (queue.length > 0) {\n+      const current = queue.shift()!;\n+      const imports = this.importsOf(current.sourceFile);\n+      for (const importedFile of imports) {\n+        if (!found.has(importedFile)) {\n+          const next = new Found(importedFile, current);\n+          if (next.sourceFile === end) {\n+            // We have hit the target `end` path so we can stop here.\n+            return next.toPath();\n+          }\n+          found.add(importedFile);\n+          queue.push(next);\n+        }\n+      }\n+    }\n+    return null;\n+  }\n+\n   /**\n    * Add a record of an import from `sf` to `imported`, that's not present in the original\n    * `ts.Program` but will be remembered by the `ImportGraph`.\n@@ -84,3 +122,27 @@ export class ImportGraph {\n function isLocalFile(sf: ts.SourceFile): boolean {\n   return !sf.fileName.endsWith('.d.ts');\n }\n+\n+/**\n+ * A helper class to track which SourceFiles are being processed when searching for a path in\n+ * `getPath()` above.\n+ */\n+class Found {\n+  constructor(readonly sourceFile: ts.SourceFile, readonly parent: Found|null) {}\n+\n+  /**\n+   * Back track through this found SourceFile and its ancestors to generate an array of\n+   * SourceFiles that form am import path between two SourceFiles.\n+   */\n+  toPath(): ts.SourceFile[] {\n+    const array: ts.SourceFile[] = [];\n+    let current: Found|null = this;\n+    while (current !== null) {\n+      array.push(current.sourceFile);\n+      current = current.parent;\n+    }\n+    // Pushing and then reversing, O(n), rather than unshifting repeatedly, O(n^2), avoids\n+    // manipulating the array on every iteration: https://stackoverflow.com/a/26370620\n+    return array.reverse();\n+  }\n+}"
        },
        {
            "sha": "0d697e30051b593494486e25260cd5f9da2cbda0",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/test/analyzer_spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 12,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fanalyzer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fanalyzer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fanalyzer_spec.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -9,9 +9,9 @@ import * as ts from 'typescript';\n import {absoluteFrom, getFileSystem, getSourceFileOrError} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n import {ModuleResolver} from '../../imports';\n-import {CycleAnalyzer} from '../src/analyzer';\n+import {Cycle, CycleAnalyzer} from '../src/analyzer';\n import {ImportGraph} from '../src/imports';\n-import {makeProgramFromGraph} from './util';\n+import {importPath, makeProgramFromGraph} from './util';\n \n runInEachFileSystem(() => {\n   describe('cycle analyzer', () => {\n@@ -22,41 +22,53 @@ runInEachFileSystem(() => {\n       const {program, analyzer} = makeAnalyzer('a:b,c;b;c');\n       const b = getSourceFileOrError(program, (_('/b.ts')));\n       const c = getSourceFileOrError(program, (_('/c.ts')));\n-      expect(analyzer.wouldCreateCycle(b, c)).toBe(false);\n-      expect(analyzer.wouldCreateCycle(c, b)).toBe(false);\n+      expect(analyzer.wouldCreateCycle(b, c)).toBe(null);\n+      expect(analyzer.wouldCreateCycle(c, b)).toBe(null);\n     });\n \n     it('should detect a simple cycle between two files', () => {\n       const {program, analyzer} = makeAnalyzer('a:b;b');\n       const a = getSourceFileOrError(program, (_('/a.ts')));\n       const b = getSourceFileOrError(program, (_('/b.ts')));\n-      expect(analyzer.wouldCreateCycle(a, b)).toBe(false);\n-      expect(analyzer.wouldCreateCycle(b, a)).toBe(true);\n+      expect(analyzer.wouldCreateCycle(a, b)).toBe(null);\n+      const cycle = analyzer.wouldCreateCycle(b, a);\n+      expect(cycle).toBeInstanceOf(Cycle);\n+      expect(importPath(cycle!.getPath())).toEqual('b,a,b');\n     });\n \n     it('should detect a cycle with a re-export in the chain', () => {\n       const {program, analyzer} = makeAnalyzer('a:*b;b:c;c');\n       const a = getSourceFileOrError(program, (_('/a.ts')));\n+      const b = getSourceFileOrError(program, (_('/b.ts')));\n       const c = getSourceFileOrError(program, (_('/c.ts')));\n-      expect(analyzer.wouldCreateCycle(a, c)).toBe(false);\n-      expect(analyzer.wouldCreateCycle(c, a)).toBe(true);\n+      expect(analyzer.wouldCreateCycle(a, c)).toBe(null);\n+      const cycle = analyzer.wouldCreateCycle(c, a);\n+      expect(cycle).toBeInstanceOf(Cycle);\n+      expect(importPath(cycle!.getPath())).toEqual('c,a,b,c');\n     });\n \n     it('should detect a cycle in a more complex program', () => {\n       const {program, analyzer} = makeAnalyzer('a:*b,*c;b:*e,*f;c:*g,*h;e:f;f:c;g;h:g');\n       const b = getSourceFileOrError(program, (_('/b.ts')));\n+      const c = getSourceFileOrError(program, (_('/c.ts')));\n+      const e = getSourceFileOrError(program, (_('/e.ts')));\n+      const f = getSourceFileOrError(program, (_('/f.ts')));\n       const g = getSourceFileOrError(program, (_('/g.ts')));\n-      expect(analyzer.wouldCreateCycle(b, g)).toBe(false);\n-      expect(analyzer.wouldCreateCycle(g, b)).toBe(true);\n+      expect(analyzer.wouldCreateCycle(b, g)).toBe(null);\n+      const cycle = analyzer.wouldCreateCycle(g, b);\n+      expect(cycle).toBeInstanceOf(Cycle);\n+      expect(importPath(cycle!.getPath())).toEqual('g,b,f,c,g');\n     });\n \n     it('should detect a cycle caused by a synthetic edge', () => {\n       const {program, analyzer} = makeAnalyzer('a:b,c;b;c');\n       const b = getSourceFileOrError(program, (_('/b.ts')));\n       const c = getSourceFileOrError(program, (_('/c.ts')));\n-      expect(analyzer.wouldCreateCycle(b, c)).toBe(false);\n+      expect(analyzer.wouldCreateCycle(b, c)).toBe(null);\n       analyzer.recordSyntheticImport(c, b);\n-      expect(analyzer.wouldCreateCycle(b, c)).toBe(true);\n+      const cycle = analyzer.wouldCreateCycle(b, c);\n+      expect(cycle).toBeInstanceOf(Cycle);\n+      expect(importPath(cycle!.getPath())).toEqual('b,c,b');\n     });\n   });\n "
        },
        {
            "sha": "6f1fe6ad4edc9fce86ea793adbdbc744ce1fff3f",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/test/imports_spec.ts",
            "status": "modified",
            "additions": 60,
            "deletions": 30,
            "changes": 90,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fimports_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fimports_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fimports_spec.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -10,46 +10,76 @@ import {absoluteFrom, getFileSystem, getSourceFileOrError} from '../../file_syst\n import {runInEachFileSystem} from '../../file_system/testing';\n import {ModuleResolver} from '../../imports';\n import {ImportGraph} from '../src/imports';\n-import {makeProgramFromGraph} from './util';\n+import {importPath, makeProgramFromGraph} from './util';\n \n runInEachFileSystem(() => {\n-  describe('import graph', () => {\n+  describe('ImportGraph', () => {\n     let _: typeof absoluteFrom;\n     beforeEach(() => _ = absoluteFrom);\n \n-    it('should record imports of a simple program', () => {\n-      const {program, graph} = makeImportGraph('a:b;b:c;c');\n-      const a = getSourceFileOrError(program, (_('/a.ts')));\n-      const b = getSourceFileOrError(program, (_('/b.ts')));\n-      const c = getSourceFileOrError(program, (_('/c.ts')));\n-      expect(importsToString(graph.importsOf(a))).toBe('b');\n-      expect(importsToString(graph.importsOf(b))).toBe('c');\n+    describe('importsOf()', () => {\n+      it('should record imports of a simple program', () => {\n+        const {program, graph} = makeImportGraph('a:b;b:c;c');\n+        const a = getSourceFileOrError(program, (_('/a.ts')));\n+        const b = getSourceFileOrError(program, (_('/b.ts')));\n+        const c = getSourceFileOrError(program, (_('/c.ts')));\n+        expect(importsToString(graph.importsOf(a))).toBe('b');\n+        expect(importsToString(graph.importsOf(b))).toBe('c');\n+      });\n     });\n \n-    it('should calculate transitive imports of a simple program', () => {\n-      const {program, graph} = makeImportGraph('a:b;b:c;c');\n-      const a = getSourceFileOrError(program, (_('/a.ts')));\n-      const b = getSourceFileOrError(program, (_('/b.ts')));\n-      const c = getSourceFileOrError(program, (_('/c.ts')));\n-      expect(importsToString(graph.transitiveImportsOf(a))).toBe('a,b,c');\n-    });\n+    describe('transitiveImportsOf()', () => {\n+      it('should calculate transitive imports of a simple program', () => {\n+        const {program, graph} = makeImportGraph('a:b;b:c;c');\n+        const a = getSourceFileOrError(program, (_('/a.ts')));\n+        const b = getSourceFileOrError(program, (_('/b.ts')));\n+        const c = getSourceFileOrError(program, (_('/c.ts')));\n+        expect(importsToString(graph.transitiveImportsOf(a))).toBe('a,b,c');\n+      });\n+\n+      it('should calculate transitive imports in a more complex program (with a cycle)', () => {\n+        const {program, graph} = makeImportGraph('a:*b,*c;b:*e,*f;c:*g,*h;e:f;f;g:e;h:g');\n+        const c = getSourceFileOrError(program, (_('/c.ts')));\n+        expect(importsToString(graph.transitiveImportsOf(c))).toBe('c,e,f,g,h');\n+      });\n \n-    it('should calculate transitive imports in a more complex program (with a cycle)', () => {\n-      const {program, graph} = makeImportGraph('a:*b,*c;b:*e,*f;c:*g,*h;e:f;f;g:e;h:g');\n-      const c = getSourceFileOrError(program, (_('/c.ts')));\n-      expect(importsToString(graph.transitiveImportsOf(c))).toBe('c,e,f,g,h');\n+      it('should reflect the addition of a synthetic import', () => {\n+        const {program, graph} = makeImportGraph('a:b,c,d;b;c;d:b');\n+        const b = getSourceFileOrError(program, (_('/b.ts')));\n+        const c = getSourceFileOrError(program, (_('/c.ts')));\n+        const d = getSourceFileOrError(program, (_('/d.ts')));\n+        expect(importsToString(graph.importsOf(b))).toEqual('');\n+        expect(importsToString(graph.transitiveImportsOf(d))).toEqual('b,d');\n+        graph.addSyntheticImport(b, c);\n+        expect(importsToString(graph.importsOf(b))).toEqual('c');\n+        expect(importsToString(graph.transitiveImportsOf(d))).toEqual('b,c,d');\n+      });\n     });\n \n-    it('should reflect the addition of a synthetic import', () => {\n-      const {program, graph} = makeImportGraph('a:b,c,d;b;c;d:b');\n-      const b = getSourceFileOrError(program, (_('/b.ts')));\n-      const c = getSourceFileOrError(program, (_('/c.ts')));\n-      const d = getSourceFileOrError(program, (_('/d.ts')));\n-      expect(importsToString(graph.importsOf(b))).toEqual('');\n-      expect(importsToString(graph.transitiveImportsOf(d))).toEqual('b,d');\n-      graph.addSyntheticImport(b, c);\n-      expect(importsToString(graph.importsOf(b))).toEqual('c');\n-      expect(importsToString(graph.transitiveImportsOf(d))).toEqual('b,c,d');\n+    describe('findPath()', () => {\n+      it('should be able to compute the path between two source files if there is a cycle', () => {\n+        const {program, graph} = makeImportGraph('a:*b,*c;b:*e,*f;c:*g,*h;e:f;f;g:e;h:g');\n+        const a = getSourceFileOrError(program, (_('/a.ts')));\n+        const b = getSourceFileOrError(program, (_('/b.ts')));\n+        const c = getSourceFileOrError(program, (_('/c.ts')));\n+        const e = getSourceFileOrError(program, (_('/e.ts')));\n+        expect(importPath(graph.findPath(a, a)!)).toBe('a');\n+        expect(importPath(graph.findPath(a, b)!)).toBe('a,b');\n+        expect(importPath(graph.findPath(c, e)!)).toBe('c,g,e');\n+        expect(graph.findPath(e, c)).toBe(null);\n+        expect(graph.findPath(b, c)).toBe(null);\n+      });\n+\n+      it('should handle circular dependencies within the path between `from` and `to`', () => {\n+        // a -> b -> c -> d\n+        // ^----/    |\n+        // ^---------/\n+        const {program, graph} = makeImportGraph('a:b;b:a,c;c:a,d;d');\n+        const a = getSourceFileOrError(program, (_('/a.ts')));\n+        const c = getSourceFileOrError(program, (_('/c.ts')));\n+        const d = getSourceFileOrError(program, (_('/d.ts')));\n+        expect(importPath(graph.findPath(a, d)!)).toBe('a,b,c,d');\n+      });\n     });\n   });\n "
        },
        {
            "sha": "c4a8ca4ed422642b73fcd0912b47d999d98df5ac",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/test/util.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Futil.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as ts from 'typescript';\n-import {PathManipulation} from '../../file_system';\n+import {getFileSystem, PathManipulation} from '../../file_system';\n import {TestFile} from '../../file_system/testing';\n import {makeProgram} from '../../testing';\n \n@@ -56,3 +56,8 @@ export function makeProgramFromGraph(fs: PathManipulation, graph: string): {\n   });\n   return makeProgram(files);\n }\n+\n+export function importPath(files: ts.SourceFile[]): string {\n+  const fs = getFileSystem();\n+  return files.map(sf => fs.basename(sf.fileName).replace('.ts', '')).join(',');\n+}"
        },
        {
            "sha": "89292b56fa377baac5ef3af156a6ee219483aff7",
            "filename": "packages/compiler-cli/src/ngtsc/diagnostics/src/error_code.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -52,6 +52,11 @@ export enum ErrorCode {\n \n   SYMBOL_NOT_EXPORTED = 3001,\n   SYMBOL_EXPORTED_UNDER_DIFFERENT_NAME = 3002,\n+  /**\n+   * Raised when a relationship between directives and/or pipes would cause a cyclic import to be\n+   * created that cannot be handled, such as in partial compilation mode.\n+   */\n+  IMPORT_CYCLE_DETECTED = 3003,\n \n   CONFIG_FLAT_MODULE_NO_INDEX = 4001,\n   CONFIG_STRICT_TEMPLATES_IMPLIES_FULL_TEMPLATE_TYPECHECK = 4002,\n@@ -192,6 +197,7 @@ export const ERROR_DETAILS_PAGE_BASE_URL = 'https://angular.io/errors';\n  */\n export const COMPILER_ERRORS_WITH_GUIDES = new Set([\n   ErrorCode.DECORATOR_ARG_NOT_LITERAL,\n+  ErrorCode.IMPORT_CYCLE_DETECTED,\n   ErrorCode.PARAM_MISSING_TOKEN,\n   ErrorCode.SCHEMA_INVALID_ELEMENT,\n   ErrorCode.SCHEMA_INVALID_ATTRIBUTE,"
        },
        {
            "sha": "1a6761191d243f26a5a5b83045d5d70aa60418dc",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -4774,6 +4774,53 @@ runInEachFileSystem(os => {\n         const jsContents = env.getContents('test.js');\n         expect(jsContents).not.toMatch(/i\\d\\.ɵɵsetComponentScope\\([^)]*OtherComponent[^)]*\\)/);\n       });\n+\n+      it('should detect a simple cycle and fatally error if doing partial-compilation', () => {\n+        env.tsconfig({\n+          compilationMode: 'partial',\n+        });\n+\n+        env.write('test.ts', `\n+        import {Component, NgModule} from '@angular/core';\n+        import {NormalComponent} from './cyclic';\n+\n+        @Component({\n+          selector: 'cyclic-component',\n+          template: 'Importing this causes a cycle',\n+        })\n+        export class CyclicComponent {}\n+\n+        @NgModule({\n+          declarations: [NormalComponent, CyclicComponent],\n+        })\n+        export class Module {}\n+      `);\n+\n+        env.write('cyclic.ts', `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          selector: 'normal-component',\n+          template: '<cyclic-component></cyclic-component>',\n+        })\n+        export class NormalComponent {}\n+      `);\n+\n+        const diagnostics = env.driveDiagnostics();\n+        expect(diagnostics.length).toEqual(1);\n+        const error = diagnostics[0];\n+        expect(error.code).toBe(ngErrorCode(ErrorCode.IMPORT_CYCLE_DETECTED));\n+        expect(error.messageText)\n+            .toEqual(\n+                'One or more import cycles would need to be created to compile this component, ' +\n+                'which is not supported by the current compiler configuration.');\n+        const _abs = absoluteFrom;\n+        expect(error.relatedInformation?.map(diag => diag.messageText)).toEqual([\n+          `The component 'CyclicComponent' is used in the template ` +\n+              `but importing it would create a cycle: ` +\n+              `${_abs('/cyclic.ts')} -> ${_abs('/test.ts')} -> ${_abs('/cyclic.ts')}`,\n+        ]);\n+      });\n     });\n \n     describe('local refs', () => {"
        },
        {
            "sha": "139326d856c1bb7fff380f20b4f83e7f3f0ebebd",
            "filename": "packages/compiler/src/render3/view/api.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/322951af495ef33d20de751de1854ebbe2c5ea49/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fapi.ts?ref=322951af495ef33d20de751de1854ebbe2c5ea49",
            "patch": "@@ -277,6 +277,11 @@ export interface R3UsedDirectiveMetadata {\n    * Name under which the directive is exported, if any (exportAs in Angular). Null otherwise.\n    */\n   exportAs: string[]|null;\n+\n+  /**\n+   * If true then this directive is actually a component; otherwise it is not.\n+   */\n+  isComponent?: boolean;\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 491,
        "additions": 416,
        "deletions": 75
    }
}