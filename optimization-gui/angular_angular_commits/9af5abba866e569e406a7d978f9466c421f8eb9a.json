{
    "author": "devversion",
    "message": "feat(dev-infra): add bazel rule for extracting JavaScript module flavors from targets (#42809)\n\nIntroduces a rule that collects declared JavaScript module output files\nfrom a list of dependencies based on a configurable JavaScript module\nprovider. The extracted outputs are exposed within the `DefaultInfo` provider.\n\nTargets defined using this rule can be used as input for rules that\nrequire JavaScript sources, or if there are multiple JavaScript output\nvariants defined for a target while for example only the `JSModuleInfo`\noutputs are of interest.\n\nAs an example: This rule is helpful in combination with `ts_library` and\n`ng_module` as those rule expose multiple output flavors (which are\ndistinguishable by the JavaScript module providers as imported from `providers.bzl`).\ni.e. these rules expose flavors for named AMD modules and ECMAScript module output.\nIf we want to ship a NPM package only using ECMAScript modules for\nexample, we could extract all `JSEcmaScriptModuleInfo`-denoted output\nand feed that into the `pkg_npm` rule, compared to bringing in all\noutput flavors.\n\nFor reference:\nhttps://github.com/bazelbuild/rules_nodejs/blob/stable/packages/typescript/internal/build_defs.bzl#L334-L337\n\nPR Close #42809",
    "sha": "9af5abba866e569e406a7d978f9466c421f8eb9a",
    "files": [
        {
            "sha": "b8e78fe5d50931e22b0ae0d203ed903b5a50fef9",
            "filename": "dev-infra/bazel/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/9af5abba866e569e406a7d978f9466c421f8eb9a/dev-infra%2Fbazel%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9af5abba866e569e406a7d978f9466c421f8eb9a/dev-infra%2Fbazel%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2FBUILD.bazel?ref=9af5abba866e569e406a7d978f9466c421f8eb9a",
            "patch": "@@ -5,6 +5,7 @@ filegroup(\n     srcs = [\n         \"BUILD.bazel\",\n         \"expand_template.bzl\",\n+        \"extract_js_module_output.bzl\",\n         \"//dev-infra/bazel/api-golden:files\",\n         \"//dev-infra/bazel/browsers:files\",\n         \"//dev-infra/bazel/remote-execution:files\","
        },
        {
            "sha": "42ca77f738f67d104ad4c8fec945e8c131dbea79",
            "filename": "dev-infra/bazel/extract_js_module_output.bzl",
            "status": "added",
            "additions": 78,
            "deletions": 0,
            "changes": 78,
            "blob_url": "https://github.com/angular/angular/blob/9af5abba866e569e406a7d978f9466c421f8eb9a/dev-infra%2Fbazel%2Fextract_js_module_output.bzl",
            "raw_url": "https://github.com/angular/angular/raw/9af5abba866e569e406a7d978f9466c421f8eb9a/dev-infra%2Fbazel%2Fextract_js_module_output.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fextract_js_module_output.bzl?ref=9af5abba866e569e406a7d978f9466c421f8eb9a",
            "patch": "@@ -0,0 +1,78 @@\n+load(\"@build_bazel_rules_nodejs//:providers.bzl\", \"DeclarationInfo\", \"JSEcmaScriptModuleInfo\", \"JSModuleInfo\", \"JSNamedModuleInfo\")\n+\n+\"\"\"Converts a provider name to its actually Starlark provider instance.\"\"\"\n+\n+def _name_to_js_module_provider(name):\n+    if name == \"JSModuleInfo\":\n+        return JSModuleInfo\n+    elif name == \"JSNamedModuleInfo\":\n+        return JSNamedModuleInfo\n+    elif name == \"JSEcmaScriptModuleInfo\":\n+        return JSEcmaScriptModuleInfo\n+    fail(\"Unexpected JavaScript module provider.\")\n+\n+\"\"\"Implementation of the extract_js_module_output rule.\"\"\"\n+\n+def _extract_js_module_output_impl(ctx):\n+    js_module_provider = _name_to_js_module_provider(ctx.attr.provider)\n+    depsets = []\n+    for dep in ctx.attr.deps:\n+        # Include JavaScript sources (including transitive outputs) based on the\n+        # configured JavaScript module provider.\n+        if js_module_provider in dep:\n+            depsets.append(dep[js_module_provider].sources)\n+\n+        # Based on whether declarations should be collected, extract direct\n+        # and transitive declaration files using the `DeclarationInfo` provider.\n+        if ctx.attr.include_declarations and DeclarationInfo in dep:\n+            depsets.append(dep[DeclarationInfo].transitive_declarations)\n+\n+        # Based on whether default files should be collected, extract direct\n+        # files which are exposed using the `DefaultInfo` provider. Also include\n+        # data runfiles which are needed for the current target.\n+        # https://docs.bazel.build/versions/main/skylark/lib/DefaultInfo.html#data_runfiles\n+        if ctx.attr.include_default_files and DefaultInfo in dep:\n+            depsets.append(dep[DefaultInfo].files)\n+            depsets.append(dep[DefaultInfo].data_runfiles.files)\n+\n+    sources = depset(transitive = depsets)\n+\n+    return [DefaultInfo(files = sources)]\n+\n+\"\"\"\n+  Rule that collects declared JavaScript module output files from a list of dependencies\n+  based on a configurable JavaScript module provider. The extracted outputs are exposed\n+  within the `DefaultInfo` provider. Targets defined using this rule can be used as input\n+  for rules that require JavaScript sources, or if there are multiple JavaScript output\n+  variants defined for a target while for example only the `JSModule` outputs are of interest.\n+\n+  As an example: This rule is helpful in combination with `ts_library` and `ng_module` as\n+  those rule expose multiple output flavors (which are distinguishable by the JavaScript module\n+  providers as imported from `providers.bzl`). i.e. these rules expose flavors for named AMD\n+  modules and ECMAScript module output. For reference:\n+  https://github.com/bazelbuild/rules_nodejs/blob/stable/packages/typescript/internal/build_defs.bzl#L334-L337\n+\"\"\"\n+extract_js_module_output = rule(\n+    implementation = _extract_js_module_output_impl,\n+    attrs = {\n+        \"deps\": attr.label_list(\n+            allow_files = True,\n+        ),\n+        \"provider\": attr.string(\n+            doc = \"JavaScript module info provider that is used for collecting sources from the dependencies.\",\n+            mandatory = True,\n+            values = [\"JSModuleInfo\", \"JSNamedModuleInfo\", \"JSEcmaScriptModuleInfo\"],\n+        ),\n+        \"include_declarations\": attr.bool(\n+            mandatory = True,\n+            doc = \"Whether declaration files should be collected from the dependencies.\",\n+        ),\n+        \"include_default_files\": attr.bool(\n+            mandatory = True,\n+            doc = \"\"\"\n+              Whether files from the `DefaultInfo` provider should be collected. Includes\n+              data runfiles needed for the default outputs from dependencies.\n+            \"\"\",\n+        ),\n+    },\n+)"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 79,
        "deletions": 0
    }
}