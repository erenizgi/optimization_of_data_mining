{
    "author": "devversion",
    "message": "refactor: remove remaining dynamic require usages in package output (#43431)\n\nRemoves the remaining usages of dynamic require statements in the\npackage output. Since we declare all shipped packages as strict ESM,\nwe cannot use dynamic require statements anymore. This commit switches\nthese usages to actual `import` statements.\n\nNote: Tsickle continues to remain an optional dependency since bundling\ndoes not work with its UMD package output. Also tsickle is rarely used by\nconsumers, if at all, so bundling does not really provide any significant\nvalue. To continue keeping tsickle optional (since it's still needed by the\n`annotateForClosureCompiler` option which is also respected in ngtsc), we\npass-through a tsickle instance as a parameter to `main`. This allows us to\nkeep the compile functions synchronous without having to refactor the majority\nof the watch compilation code, and majority of tests for ngc, ngtsc.\n\nConsumers (like the `ngc` bin entry-point) can then load tsickle based on their\nmodule format. e.g. tsickle can be imported through `require` to keep everything\nsync, but in ESM, the dynamic import can be used beforehand to pass `tsickle` to\nthe `main` function. We can revisit this in the future but for now this does the\ntrick without exceeding the scope of this commit..\n\nPR Close #43431",
    "sha": "b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
    "files": [
        {
            "sha": "c0d3110687f40020890ce97a7c18e0e64160eb65",
            "filename": "packages/compiler-cli/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2FBUILD.bazel?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -41,6 +41,7 @@ esbuild(\n     external = [\n         \"@angular/compiler\",\n         \"typescript\",\n+        \"tsickle\",\n         \"@babel/core\",\n         \"reflect-metadata\",\n         \"minimist\",\n@@ -96,6 +97,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"@npm//@bazel/typescript\",\n+        \"@npm//@types/minimist\",\n         \"@npm//@types/node\",\n         \"@npm//chokidar\",\n         \"@npm//minimist\","
        },
        {
            "sha": "69754de8ae3609a3e3b25d53875863da285a079e",
            "filename": "packages/compiler-cli/ngcc/src/dependencies/dependency_resolver.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fdependencies%2Fdependency_resolver.ts",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fdependencies%2Fdependency_resolver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fdependencies%2Fdependency_resolver.ts?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import {DepGraph} from 'dependency-graph';\n+import module from 'module';\n \n import {AbsoluteFsPath, ReadonlyFileSystem} from '../../../src/ngtsc/file_system';\n import {Logger} from '../../../src/ngtsc/logging';\n@@ -16,7 +17,7 @@ import {PartiallyOrderedList} from '../utils';\n \n import {createDependencyInfo, DependencyHost, EntryPointWithDependencies} from './dependency_host';\n \n-const builtinNodeJsModules = new Set<string>(require('module').builtinModules);\n+const builtinNodeJsModules = new Set<string>(module.builtinModules);\n \n /**\n  * Holds information about entry points that are removed because"
        },
        {
            "sha": "6cc2abbf1785241705fd135778892d94f238526e",
            "filename": "packages/compiler-cli/src/bin/ngc.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 5,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Fsrc%2Fbin%2Fngc.ts",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Fsrc%2Fbin%2Fngc.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fbin%2Fngc.ts?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -13,8 +13,26 @@ import 'reflect-metadata';\n import {NodeJSFileSystem, setFileSystem} from '../ngtsc/file_system';\n import {main} from '../main';\n \n-process.title = 'Angular Compiler (ngc)';\n-const args = process.argv.slice(2);\n-// We are running the real compiler so run against the real file-system\n-setFileSystem(new NodeJSFileSystem());\n-process.exitCode = main(args);\n+async function runNgcComamnd() {\n+  process.title = 'Angular Compiler (ngc)';\n+  const args = process.argv.slice(2);\n+  // We are running the real compiler so run against the real file-system\n+  setFileSystem(new NodeJSFileSystem());\n+\n+  let tsickleModule: typeof import('tsickle')|undefined;\n+\n+  // Load tsickle if it's available. We load it here because tsickle\n+  // is not needed in all Angular projects directly using `ngc`.\n+  try {\n+    tsickleModule = (await import('tsickle')).default;\n+  } catch {\n+  }\n+\n+  process.exitCode =\n+      main(args, undefined, undefined, undefined, undefined, undefined, tsickleModule);\n+}\n+\n+runNgcComamnd().catch(e => {\n+  console.error(e);\n+  process.exitCode = 1;\n+});\n\\ No newline at end of file"
        },
        {
            "sha": "47c22bfe118faa8c2f31d40ff6beb821f74e5e4a",
            "filename": "packages/compiler-cli/src/extract_i18n.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Fsrc%2Fextract_i18n.ts",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Fsrc%2Fextract_i18n.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fextract_i18n.ts?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -10,9 +10,11 @@\n  * Extract i18n messages from source code\n  */\n \n-import * as api from './transformers/api';\n-import {ParsedConfiguration} from './perform_compile';\n+import minimist from 'minimist';\n+\n import {main, readCommandLineAndConfiguration} from './main';\n+import {ParsedConfiguration} from './perform_compile';\n+import * as api from './transformers/api';\n \n export function mainXi18n(\n     args: string[], consoleError: (msg: string) => void = console.error): number {\n@@ -22,7 +24,7 @@ export function mainXi18n(\n \n function readXi18nCommandLineAndConfiguration(args: string[]): ParsedConfiguration {\n   const options: api.CompilerOptions = {};\n-  const parsedArgs = require('minimist')(args);\n+  const parsedArgs = minimist(args);\n   if (parsedArgs.outFile) options.i18nOutFile = parsedArgs.outFile;\n   if (parsedArgs.i18nFormat) options.i18nOutFormat = parsedArgs.i18nFormat;\n   if (parsedArgs.locale) options.i18nOutLocale = parsedArgs.locale;"
        },
        {
            "sha": "9aad87956b8b651da5e15674b0ef36e770f4cdf1",
            "filename": "packages/compiler-cli/src/main.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 16,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Fsrc%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Fsrc%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fmain.ts?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -6,20 +6,23 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import * as tsickle from 'tsickle';\n+import minimist from 'minimist';\n import ts from 'typescript';\n \n+import type {TsickleHost} from 'tsickle';\n import {Diagnostics, exitCodeFromResult, filterErrorsAndWarnings, formatDiagnostics, ParsedConfiguration, performCompilation, readConfiguration} from './perform_compile';\n import {createPerformWatchHost, performWatchCompilation} from './perform_watch';\n import * as api from './transformers/api';\n import {GENERATED_FILES} from './transformers/util';\n \n+type TsickleModule = typeof import('tsickle');\n+\n export function main(\n     args: string[], consoleError: (s: string) => void = console.error,\n     config?: NgcParsedConfiguration, customTransformers?: api.CustomTransformers, programReuse?: {\n       program: api.Program|undefined,\n     },\n-    modifiedResourceFiles?: Set<string>|null): number {\n+    modifiedResourceFiles?: Set<string>|null, tsickle?: TsickleModule): number {\n   let {project, rootNames, options, errors: configErrors, watch, emitFlags} =\n       config || readNgcCommandLineAndConfiguration(args);\n   if (configErrors.length) {\n@@ -40,7 +43,7 @@ export function main(\n     options,\n     emitFlags,\n     oldProgram,\n-    emitCallback: createEmitCallback(options),\n+    emitCallback: createEmitCallback(options, tsickle),\n     customTransformers,\n     modifiedResourceFiles\n   });\n@@ -52,8 +55,8 @@ export function main(\n \n export function mainDiagnosticsForTest(\n     args: string[], config?: NgcParsedConfiguration,\n-    programReuse?: {program: api.Program|undefined},\n-    modifiedResourceFiles?: Set<string>|null): ReadonlyArray<ts.Diagnostic|api.Diagnostic> {\n+    programReuse?: {program: api.Program|undefined}, modifiedResourceFiles?: Set<string>|null,\n+    tsickle?: TsickleModule): ReadonlyArray<ts.Diagnostic|api.Diagnostic> {\n   let {project, rootNames, options, errors: configErrors, watch, emitFlags} =\n       config || readNgcCommandLineAndConfiguration(args);\n   if (configErrors.length) {\n@@ -71,7 +74,7 @@ export function mainDiagnosticsForTest(\n     emitFlags,\n     oldProgram,\n     modifiedResourceFiles,\n-    emitCallback: createEmitCallback(options),\n+    emitCallback: createEmitCallback(options, tsickle),\n   });\n \n   if (programReuse !== undefined) {\n@@ -81,12 +84,16 @@ export function mainDiagnosticsForTest(\n   return compileDiags;\n }\n \n-function createEmitCallback(options: api.CompilerOptions): api.TsEmitCallback|undefined {\n+function createEmitCallback(\n+    options: api.CompilerOptions, tsickle?: TsickleModule): api.TsEmitCallback|undefined {\n   if (!options.annotateForClosureCompiler) {\n     return undefined;\n   }\n+  if (tsickle == undefined) {\n+    throw Error('Tsickle is not provided but `annotateForClosureCompiler` is enabled.')\n+  }\n   const tsickleHost: Pick<\n-      tsickle.TsickleHost,\n+      TsickleHost,\n       'shouldSkipTsickleProcessing'|'pathToModuleName'|'shouldIgnoreWarningsForPath'|\n       'fileNameToModuleId'|'googmodule'|'untyped'|'convertIndexImportShorthand'|\n       'transformDecorators'|'transformTypesToClosure'> = {\n@@ -115,13 +122,12 @@ function createEmitCallback(options: api.CompilerOptions): api.TsEmitCallback|un\n            host,\n            options\n          }) =>\n-             // tslint:disable-next-line:no-require-imports only depend on tsickle if requested\n-      require('tsickle').emitWithTsickle(\n-          program, {...tsickleHost, options, host, moduleResolutionHost: host}, host, options,\n-          targetSourceFile, writeFile, cancellationToken, emitOnlyDtsFiles, {\n-            beforeTs: customTransformers.before,\n-            afterTs: customTransformers.after,\n-          });\n+             tsickle.emitWithTsickle(\n+                 program, {...tsickleHost, options, moduleResolutionHost: host}, host, options,\n+                 targetSourceFile, writeFile, cancellationToken, emitOnlyDtsFiles, {\n+                   beforeTs: customTransformers.before,\n+                   afterTs: customTransformers.after,\n+                 });\n }\n \n export interface NgcParsedConfiguration extends ParsedConfiguration {\n@@ -130,7 +136,7 @@ export interface NgcParsedConfiguration extends ParsedConfiguration {\n \n export function readNgcCommandLineAndConfiguration(args: string[]): NgcParsedConfiguration {\n   const options: api.CompilerOptions = {};\n-  const parsedArgs = require('minimist')(args);\n+  const parsedArgs = minimist(args);\n   if (parsedArgs.i18nFile) options.i18nInFile = parsedArgs.i18nFile;\n   if (parsedArgs.i18nFormat) options.i18nInFormat = parsedArgs.i18nFormat;\n   if (parsedArgs.locale) options.i18nInLocale = parsedArgs.locale;"
        },
        {
            "sha": "4e180560a250318dff761feab428336a98fcdb20",
            "filename": "packages/compiler-cli/src/transformers/compiler_host.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fcompiler_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fcompiler_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fcompiler_host.ts?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import {AotCompilerHost, collectExternalReferences, EmitterVisitorContext, GeneratedFile, ParseSourceSpan, syntaxError, TypeScriptEmitter} from '@angular/compiler';\n+import fs from 'fs';\n import * as path from 'path';\n import ts from 'typescript';\n \n@@ -253,7 +254,8 @@ export class TsCompilerAotCompilerTypeCheckHostAdapter implements ts.CompilerHos\n         try {\n           const modulePath = importedFile.substring(0, importedFile.length - moduleName.length) +\n               importedFilePackageName;\n-          const packageJson = require(modulePath + '/package.json');\n+          const packageJson =\n+              JSON.parse(fs.readFileSync(modulePath + '/package.json', 'utf8')) as any;\n           const packageTypings = join(modulePath, packageJson.typings);\n           if (packageTypings === originalImportedFile) {\n             moduleName = importedFilePackageName;"
        },
        {
            "sha": "a8d295f693e953a9007e5eae184c2f1952ef0196",
            "filename": "packages/compiler-cli/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -68,6 +68,7 @@ ts_library(\n         \":test_utils\",\n         \"//packages/compiler\",\n         \"//packages/compiler-cli\",\n+        \"@npm//tsickle\",\n         \"@npm//typescript\",\n     ],\n )\n@@ -92,7 +93,6 @@ jasmine_node_test(\n         \"//packages/core\",\n         \"@npm//minimist\",\n         \"@npm//rxjs\",\n-        \"@npm//tsickle\",\n     ],\n )\n "
        },
        {
            "sha": "f985679a6d0337713bb7064bc9e15faf2e03f571",
            "filename": "packages/compiler-cli/test/ngc_spec.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 7,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Ftest%2Fngc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Ftest%2Fngc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngc_spec.ts?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -8,9 +8,11 @@\n \n import * as fs from 'fs';\n import * as path from 'path';\n+import * as tsickle from 'tsickle';\n import ts from 'typescript';\n \n import {main, mainDiagnosticsForTest, readCommandLineAndConfiguration, watchMode} from '../src/main';\n+\n import {setup, stripAnsi} from './test_support';\n \n describe('ngc transformer command-line', () => {\n@@ -676,7 +678,8 @@ describe('ngc transformer command-line', () => {\n         export class MyModule {}\n       `);\n \n-        const exitCode = main(['-p', basePath], errorSpy);\n+        const exitCode =\n+            main(['-p', basePath], errorSpy, undefined, undefined, undefined, undefined, tsickle);\n         expect(exitCode).toEqual(0);\n \n         const mymodulejs = path.resolve(outDir, 'mymodule.js');\n@@ -708,7 +711,8 @@ describe('ngc transformer command-line', () => {\n         export class MyModule {}\n       `);\n \n-        const exitCode = main(['-p', basePath], errorSpy);\n+        const exitCode =\n+            main(['-p', basePath], errorSpy, undefined, undefined, undefined, undefined, tsickle);\n         expect(exitCode).toEqual(0);\n \n         const mymodulejs = path.resolve(outDir, 'mymodule.js');\n@@ -749,7 +753,8 @@ describe('ngc transformer command-line', () => {\n         export class MyModule {}\n     `);\n \n-      const exitCode = main(['-p', basePath], errorSpy);\n+      const exitCode =\n+          main(['-p', basePath], errorSpy, undefined, undefined, undefined, undefined, tsickle);\n       expect(exitCode).toEqual(0);\n       const mymodulejs = path.resolve(outDir, 'mymodule.js');\n       const mymoduleSource = fs.readFileSync(mymodulejs, 'utf8');\n@@ -2118,10 +2123,12 @@ describe('ngc transformer command-line', () => {\n   });\n \n   describe('tree shakeable services', () => {\n-    function compileService(source: string): string {\n+    function compileService(source: string, withTsickle = false): string {\n       write('service.ts', source);\n \n-      const exitCode = main(['-p', path.join(basePath, 'tsconfig.json')], errorSpy);\n+      const exitCode = main(\n+          ['-p', path.join(basePath, 'tsconfig.json')], errorSpy, undefined, undefined, undefined,\n+          undefined, withTsickle ? tsickle : undefined);\n       expect(exitCode).toEqual(0);\n \n       const servicePath = path.resolve(outDir, 'service.js');\n@@ -2203,15 +2210,17 @@ describe('ngc transformer command-line', () => {\n         },\n         \"files\": [\"service.ts\"]\n       }`);\n-      const source = compileService(`\n+      const input = `\n         import {Injectable} from '@angular/core';\n         import {Module} from './module';\n \n         @Injectable({\n           providedIn: Module,\n         })\n         export class Service {}\n-      `);\n+      `;\n+\n+      const source = compileService(input, /* withTsickle */ true);\n       expect(source).toMatch(/\\/\\*\\* @nocollapse \\*\\/ Service\\.Éµprov =/);\n     });\n "
        },
        {
            "sha": "4d039b9223e6ff4a97dc21cf3a1bef6bae6f9a17",
            "filename": "packages/compiler-cli/test/ngtsc/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2FBUILD.bazel?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -16,6 +16,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"//packages/compiler-cli/test:test_utils\",\n         \"@npm//source-map\",\n+        \"@npm//tsickle\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "165e04c16b9b348329c8989b01f8f941172cd9fc",
            "filename": "packages/compiler-cli/test/ngtsc/env.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -8,6 +8,7 @@\n \n import {CustomTransformers, defaultGatherDiagnostics, Program} from '@angular/compiler-cli';\n import * as api from '@angular/compiler-cli/src/transformers/api';\n+import * as tsickle from 'tsickle';\n import ts from 'typescript';\n \n import {createCompilerHost, createProgram} from '../../index';\n@@ -21,7 +22,6 @@ import {DeclarationNode} from '../../src/ngtsc/reflection';\n import {NgtscTestCompilerHost} from '../../src/ngtsc/testing';\n import {setWrapHostForTest} from '../../src/transformers/compiler_host';\n \n-\n /**\n  * Manages a temporary testing directory structure and environment for testing ngtsc by feeding it\n  * TypeScript code.\n@@ -220,7 +220,7 @@ export class NgtscTestEnvironment {\n     }\n     const exitCode = main(\n         this.commandLineArgs, errorSpy, undefined, customTransformers, reuseProgram,\n-        this.changedResources);\n+        this.changedResources, tsickle);\n     expect(errorSpy).not.toHaveBeenCalled();\n     expect(exitCode).toBe(0);\n     if (this.multiCompileHostExt !== null) {\n@@ -241,7 +241,7 @@ export class NgtscTestEnvironment {\n     }\n \n     const diags = mainDiagnosticsForTest(\n-        this.commandLineArgs, undefined, reuseProgram, this.changedResources);\n+        this.commandLineArgs, undefined, reuseProgram, this.changedResources, tsickle);\n \n \n     if (this.multiCompileHostExt !== null) {"
        },
        {
            "sha": "0678b52eda18f9aa446f23594912d5fdc4ca72ff",
            "filename": "packages/compiler/test/aot/compiler_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler%2Ftest%2Faot%2Fcompiler_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler%2Ftest%2Faot%2Fcompiler_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Faot%2Fcompiler_spec.ts?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -56,11 +56,10 @@ describe('compiler (unbundled Angular)', () => {\n           genFile => genFile.srcFileUrl === componentPath && genFile.genFileUrl.endsWith('.ts'))!;\n     }\n \n-    function findLineAndColumn(\n-        file: string, token: string): {line: number|null, column: number|null} {\n+    function findLineAndColumn(file: string, token: string): {line: number, column: number}|null {\n       const index = file.indexOf(token);\n       if (index === -1) {\n-        return {line: null, column: null};\n+        return null;\n       }\n       const linesUntilToken = file.slice(0, index).split('\\n');\n       const line = linesUntilToken.length;\n@@ -149,7 +148,7 @@ describe('compiler (unbundled Angular)', () => {\n         const genFile = compileApp();\n         const genSource = toTypeScript(genFile);\n         const sourceMap = extractSourceMap(genSource)!;\n-        expect(originalPositionFor(sourceMap, findLineAndColumn(genSource, `'span'`)))\n+        expect(originalPositionFor(sourceMap, findLineAndColumn(genSource, `'span'`)!))\n             .toEqual({line: 2, column: 3, source: ngUrl});\n       });\n \n@@ -161,7 +160,7 @@ describe('compiler (unbundled Angular)', () => {\n         const genFile = compileApp();\n         const genSource = toTypeScript(genFile);\n         const sourceMap = extractSourceMap(genSource)!;\n-        expect(originalPositionFor(sourceMap, findLineAndColumn(genSource, `someMethod()`)))\n+        expect(originalPositionFor(sourceMap, findLineAndColumn(genSource, `someMethod()`)!))\n             .toEqual({line: 2, column: 9, source: ngUrl});\n       });\n \n@@ -173,7 +172,7 @@ describe('compiler (unbundled Angular)', () => {\n         const genFile = compileApp();\n         const genSource = toTypeScript(genFile);\n         const sourceMap = extractSourceMap(genSource)!;\n-        expect(originalPositionFor(sourceMap, findLineAndColumn(genSource, `someMethod()`)))\n+        expect(originalPositionFor(sourceMap, findLineAndColumn(genSource, `someMethod()`)!))\n             .toEqual({line: 2, column: 9, source: ngUrl});\n       });\n "
        },
        {
            "sha": "0c8acaba4638be9da148d273b8b7ef26cc717150",
            "filename": "packages/compiler/testing/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler%2Ftesting%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler%2Ftesting%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftesting%2FBUILD.bazel?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -17,5 +17,7 @@ ng_module(\n         \"//packages/compiler\",\n         \"//packages/core\",\n         \"@npm//@types/node\",\n+        \"@npm//base64-js\",\n+        \"@npm//source-map\",\n     ],\n )"
        },
        {
            "sha": "34c80e318341ddee68d9f6f07de3ce268c9e080e",
            "filename": "packages/compiler/testing/src/output/source_map_util.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler%2Ftesting%2Fsrc%2Foutput%2Fsource_map_util.ts",
            "raw_url": "https://github.com/angular/angular/raw/b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2/packages%2Fcompiler%2Ftesting%2Fsrc%2Foutput%2Fsource_map_util.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftesting%2Fsrc%2Foutput%2Fsource_map_util.ts?ref=b46b3cf43ef7df5a2a3ff31dd6c8afd35e92fff2",
            "patch": "@@ -7,8 +7,8 @@\n  */\n \n import {SourceMap} from '@angular/compiler';\n-const b64 = require('base64-js');\n-const SourceMapConsumer = require('source-map').SourceMapConsumer;\n+import b64 from 'base64-js';\n+import {SourceMapConsumer} from 'source-map';\n \n export interface SourceLocation {\n   line: number;\n@@ -17,8 +17,10 @@ export interface SourceLocation {\n }\n \n export function originalPositionFor(\n-    sourceMap: SourceMap, genPosition: {line: number|null, column: number|null}): SourceLocation {\n-  const smc = new SourceMapConsumer(sourceMap);\n+    sourceMap: SourceMap, genPosition: {line: number, column: number}): SourceLocation {\n+  // Note: The `SourceMap` type from the compiler is different to `RawSourceMap`\n+  // from the `source-map` package, but the method we rely on works as expected.\n+  const smc = new SourceMapConsumer(sourceMap as any);\n   // Note: We don't return the original object as it also contains a `name` property\n   // which is always null and we don't want to include that in our assertions...\n   const {line, column, source} = smc.originalPositionFor(genPosition);"
        }
    ],
    "stats": {
        "total": 138,
        "additions": 91,
        "deletions": 47
    }
}