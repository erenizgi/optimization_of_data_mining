{
    "author": "clydin",
    "message": "refactor(migrations): remove remaining @angular/compiler deep imports (#43627)\n\nA base class that can be used to implement a Render3 Template AST visitor is now used throughout the `@angular/core` migrations. This class is used instead of the `NullVisitor` found within the `@angular/compiler` because the `NullVisitor` requires a deep import which is no longer supported with the ESM bundled packages as of v13. The `NullVisitor` is also fairly trivial in regards to its implementation and the new base class also provides additional helper methods for migration specific behavior. This removes all remaining deep imports of the `@angular/compiler` package from the `@angular/core` migrations while avoiding the need to modify the `@angular/compiler` package.\n\nPR Close #43627",
    "sha": "11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97",
    "files": [
        {
            "sha": "83052259b1a643f8f96ce73ad65a3326901af7b6",
            "filename": "packages/core/schematics/migrations/router-link-empty-expression/analyze_template.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fanalyze_template.ts",
            "raw_url": "https://github.com/angular/angular/raw/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fanalyze_template.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fanalyze_template.ts?ref=11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97",
            "patch": "@@ -7,7 +7,6 @@\n  */\n \n import {TmplAstBoundAttribute} from '@angular/compiler';\n-import {visitAll} from '@angular/compiler/src/render3/r3_ast';\n \n import {ResolvedTemplate} from '../../utils/ng_component_template';\n import {parseHtmlGracefully} from '../../utils/parse_html';\n@@ -24,7 +23,7 @@ export function analyzeResolvedTemplate(template: ResolvedTemplate): TmplAstBoun\n   const visitor = new RouterLinkEmptyExprVisitor();\n \n   // Analyze the Angular Render3 HTML AST and collect all template variable assignments.\n-  visitAll(visitor, templateNodes);\n+  visitor.visitAll(templateNodes);\n \n   return visitor.emptyRouterLinkExpressions;\n }"
        },
        {
            "sha": "152adef952cc68390058f1f19452e00054b55205",
            "filename": "packages/core/schematics/migrations/router-link-empty-expression/angular/html_routerlink_empty_expr_visitor.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fangular%2Fhtml_routerlink_empty_expr_visitor.ts",
            "raw_url": "https://github.com/angular/angular/raw/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fangular%2Fhtml_routerlink_empty_expr_visitor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fangular%2Fhtml_routerlink_empty_expr_visitor.ts?ref=11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97",
            "patch": "@@ -7,23 +7,23 @@\n  */\n \n import {ASTWithSource, EmptyExpr, TmplAstBoundAttribute, TmplAstElement, TmplAstTemplate} from '@angular/compiler';\n-import {NullVisitor, visitAll} from '@angular/compiler/src/render3/r3_ast';\n+import {TemplateAstVisitor} from '../../../utils/template_ast_visitor';\n \n /**\n  * HTML AST visitor that traverses the Render3 HTML AST in order to find all\n  * undefined routerLink asssignment ([routerLink]=\"\").\n  */\n-export class RouterLinkEmptyExprVisitor extends NullVisitor {\n+export class RouterLinkEmptyExprVisitor extends TemplateAstVisitor {\n   readonly emptyRouterLinkExpressions: TmplAstBoundAttribute[] = [];\n \n   override visitElement(element: TmplAstElement): void {\n-    visitAll(this, element.inputs);\n-    visitAll(this, element.children);\n+    this.visitAll(element.inputs);\n+    this.visitAll(element.children);\n   }\n \n   override visitTemplate(t: TmplAstTemplate): void {\n-    visitAll(this, t.inputs);\n-    visitAll(this, t.children);\n+    this.visitAll(t.inputs);\n+    this.visitAll(t.children);\n   }\n \n   override visitBoundAttribute(node: TmplAstBoundAttribute) {"
        },
        {
            "sha": "118308bd24a0c3d101f7e0221707d6bfcdbb78fc",
            "filename": "packages/core/schematics/migrations/static-queries/strategies/usage_strategy/template_usage_visitor.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Fusage_strategy%2Ftemplate_usage_visitor.ts",
            "raw_url": "https://github.com/angular/angular/raw/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Fusage_strategy%2Ftemplate_usage_visitor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Fusage_strategy%2Ftemplate_usage_visitor.ts?ref=11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97",
            "patch": "@@ -7,13 +7,13 @@\n  */\n \n import {ImplicitReceiver, ParseSourceSpan, PropertyRead, RecursiveAstVisitor, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstElement, TmplAstNode, TmplAstTemplate} from '@angular/compiler';\n-import {NullVisitor, visitAll} from '@angular/compiler/src/render3/r3_ast';\n+import {TemplateAstVisitor} from '../../../../utils/template_ast_visitor';\n \n /**\n  * AST visitor that traverses the Render3 HTML AST in order to check if the given\n  * query property is accessed statically in the template.\n  */\n-export class TemplateUsageVisitor extends NullVisitor {\n+export class TemplateUsageVisitor extends TemplateAstVisitor {\n   private hasQueryTemplateReference = false;\n   private expressionAstVisitor = new ExpressionAstVisitor(this.queryPropertyName);\n \n@@ -27,7 +27,7 @@ export class TemplateUsageVisitor extends NullVisitor {\n     this.expressionAstVisitor.hasQueryPropertyRead = false;\n \n     // Visit all AST nodes and check if the query property is used statically.\n-    visitAll(this, htmlNodes);\n+    this.visitAll(htmlNodes);\n \n     return !this.hasQueryTemplateReference && this.expressionAstVisitor.hasQueryPropertyRead;\n   }\n@@ -41,16 +41,16 @@ export class TemplateUsageVisitor extends NullVisitor {\n       return;\n     }\n \n-    visitAll(this, element.attributes);\n-    visitAll(this, element.inputs);\n-    visitAll(this, element.outputs);\n-    visitAll(this, element.children);\n+    this.visitAll(element.attributes);\n+    this.visitAll(element.inputs);\n+    this.visitAll(element.outputs);\n+    this.visitAll(element.children);\n   }\n \n   override visitTemplate(template: TmplAstTemplate): void {\n-    visitAll(this, template.attributes);\n-    visitAll(this, template.inputs);\n-    visitAll(this, template.outputs);\n+    this.visitAll(template.attributes);\n+    this.visitAll(template.inputs);\n+    this.visitAll(template.outputs);\n \n     // We don't want to visit any children of the template as these never can't\n     // access a query statically. The templates can be rendered in the ngAfterViewInit\""
        },
        {
            "sha": "a4a18c41f8b2a04e06bc61b3d740add8af3dce8e",
            "filename": "packages/core/schematics/migrations/template-var-assignment/analyze_template.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fanalyze_template.ts",
            "raw_url": "https://github.com/angular/angular/raw/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fanalyze_template.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fanalyze_template.ts?ref=11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97",
            "patch": "@@ -7,7 +7,6 @@\n  */\n \n import {PropertyWrite} from '@angular/compiler';\n-import {visitAll} from '@angular/compiler/src/render3/r3_ast';\n import {ResolvedTemplate} from '../../utils/ng_component_template';\n import {parseHtmlGracefully} from '../../utils/parse_html';\n import {HtmlVariableAssignmentVisitor} from './angular/html_variable_assignment_visitor';\n@@ -33,7 +32,7 @@ export function analyzeResolvedTemplate(template: ResolvedTemplate): TemplateVar\n   const visitor = new HtmlVariableAssignmentVisitor();\n \n   // Analyze the Angular Render3 HTML AST and collect all template variable assignments.\n-  visitAll(visitor, templateNodes);\n+  visitor.visitAll(templateNodes);\n \n   return visitor.variableAssignments.map(\n       ({node, start, end}) => ({node, start: start + node.span.start, end}));"
        },
        {
            "sha": "d93b6a4f47ca043c2e6ed08120bdc9af5b348339",
            "filename": "packages/core/schematics/migrations/template-var-assignment/angular/html_variable_assignment_visitor.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fangular%2Fhtml_variable_assignment_visitor.ts",
            "raw_url": "https://github.com/angular/angular/raw/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fangular%2Fhtml_variable_assignment_visitor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fangular%2Fhtml_variable_assignment_visitor.ts?ref=11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97",
            "patch": "@@ -7,7 +7,8 @@\n  */\n \n import {ImplicitReceiver, ParseSourceSpan, PropertyWrite, RecursiveAstVisitor, TmplAstBoundEvent, TmplAstElement, TmplAstTemplate, TmplAstVariable} from '@angular/compiler';\n-import {NullVisitor, visitAll} from '@angular/compiler/src/render3/r3_ast';\n+import {TemplateAstVisitor} from '../../../utils/template_ast_visitor';\n+\n \n export interface TemplateVariableAssignment {\n   start: number;\n@@ -19,16 +20,16 @@ export interface TemplateVariableAssignment {\n  * HTML AST visitor that traverses the Render3 HTML AST in order to find all\n  * expressions that write to local template variables within bound events.\n  */\n-export class HtmlVariableAssignmentVisitor extends NullVisitor {\n+export class HtmlVariableAssignmentVisitor extends TemplateAstVisitor {\n   variableAssignments: TemplateVariableAssignment[] = [];\n \n   private currentVariables: TmplAstVariable[] = [];\n   private expressionAstVisitor =\n       new ExpressionAstVisitor(this.variableAssignments, this.currentVariables);\n \n   override visitElement(element: TmplAstElement): void {\n-    visitAll(this, element.outputs);\n-    visitAll(this, element.children);\n+    this.visitAll(element.outputs);\n+    this.visitAll(element.children);\n   }\n \n   override visitTemplate(template: TmplAstTemplate): void {\n@@ -39,7 +40,7 @@ export class HtmlVariableAssignmentVisitor extends NullVisitor {\n     // Visit all children of the template. The template proxies the outputs of the\n     // immediate child elements, so we just ignore outputs on the \"Template\" in order\n     // to not visit similar bound events twice.\n-    visitAll(this, template.children);\n+    this.visitAll(template.children);\n \n     // Remove all previously added variables since all children that could access\n     // these have been visited already."
        },
        {
            "sha": "ea630fb7e5a9354cd291c5a297f29d02ffaad358",
            "filename": "packages/core/schematics/utils/template_ast_visitor.ts",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Futils%2Ftemplate_ast_visitor.ts",
            "raw_url": "https://github.com/angular/angular/raw/11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97/packages%2Fcore%2Fschematics%2Futils%2Ftemplate_ast_visitor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Futils%2Ftemplate_ast_visitor.ts?ref=11f26d5145b50ed8015c1fa5a1fa4b13ab5c3f97",
            "patch": "@@ -0,0 +1,52 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import type {TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstContent, TmplAstElement, TmplAstIcu, TmplAstNode, TmplAstRecursiveVisitor, TmplAstReference, TmplAstTemplate, TmplAstText, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n+\n+/**\n+ * A base class that can be used to implement a Render3 Template AST visitor.\n+ * This class is used instead of the `NullVisitor` found within the `@angular/compiler` because\n+ * the `NullVisitor` requires a deep import which is no longer supported with the ESM bundled\n+ * packages as of v13.\n+ * Schematics are also currently required to be CommonJS to support execution within the Angular\n+ * CLI. As a result, the ESM `@angular/compiler` package must be loaded via a native dynamic import.\n+ * Using a dynamic import makes classes extending from classes present in `@angular/compiler`\n+ * complicated due to the class not being present at module evaluation time. The classes using a\n+ * base class found within `@angular/compiler` must be wrapped in a factory to allow the class value\n+ * to be accessible at runtime after the dynamic import has completed. This class implements the\n+ * interface of the `TmplAstRecursiveVisitor` class (but does not extend) as the\n+ * `TmplAstRecursiveVisitor` as an interface provides the required set of visit methods. The base\n+ * interface `Visitor<T>` is not exported.\n+ */\n+export class TemplateAstVisitor implements TmplAstRecursiveVisitor {\n+  visitElement(element: TmplAstElement): void {}\n+  visitTemplate(template: TmplAstTemplate): void {}\n+  visitContent(content: TmplAstContent): void {}\n+  visitVariable(variable: TmplAstVariable): void {}\n+  visitReference(reference: TmplAstReference): void {}\n+  visitTextAttribute(attribute: TmplAstTextAttribute): void {}\n+  visitBoundAttribute(attribute: TmplAstBoundAttribute): void {}\n+  visitBoundEvent(attribute: TmplAstBoundEvent): void {}\n+  visitText(text: TmplAstText): void {}\n+  visitBoundText(text: TmplAstBoundText): void {}\n+  visitIcu(icu: TmplAstIcu): void {}\n+\n+  /**\n+   * Visits all the provided nodes in order using this Visitor's visit methods.\n+   * This is a simplified variant of the `visitAll` function found inside of (but not\n+   * exported from) the `@angular/compiler` that does not support returning a value\n+   * since the migrations do not directly transform the nodes.\n+   *\n+   * @param nodes An iterable of nodes to visit using this visitor.\n+   */\n+  visitAll(nodes: Iterable<TmplAstNode>): void {\n+    for (const node of nodes) {\n+      node.visit(this);\n+    }\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 76,
        "deletions": 25
    }
}