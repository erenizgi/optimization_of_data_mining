{
    "author": "petebacondarwin",
    "message": "fix(compiler-cli): allow linker to process minified booleans (#41747)\n\nSome partial libraries have been minified, which results in boolean literals\nbeing converted to `!0` and `!1`. This commit ensures that the linker can\nprocess these values.\n\nFixes #41655\n\nPR Close #41747",
    "sha": "7744e1e6737a95032a8f82a0fb49ce6d72f7f484",
    "files": [
        {
            "sha": "39490b7f4bd6163dbefb3aaf9f9142d39b055da1",
            "filename": "packages/compiler-cli/linker/babel/src/ast/babel_ast_host.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/7744e1e6737a95032a8f82a0fb49ce6d72f7f484/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fast%2Fbabel_ast_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/7744e1e6737a95032a8f82a0fb49ce6d72f7f484/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fast%2Fbabel_ast_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fast%2Fbabel_ast_host.ts?ref=7744e1e6737a95032a8f82a0fb49ce6d72f7f484",
            "patch": "@@ -38,11 +38,18 @@ export class BabelAstHost implements AstHost<t.Expression> {\n     return num.value;\n   }\n \n-  isBooleanLiteral = t.isBooleanLiteral;\n+  isBooleanLiteral(bool: t.Expression): boolean {\n+    return t.isBooleanLiteral(bool) || isMinifiedBooleanLiteral(bool);\n+  }\n \n   parseBooleanLiteral(bool: t.Expression): boolean {\n-    assert(bool, t.isBooleanLiteral, 'a boolean literal');\n-    return bool.value;\n+    if (t.isBooleanLiteral(bool)) {\n+      return bool.value;\n+    } else if (isMinifiedBooleanLiteral(bool)) {\n+      return !bool.argument.value;\n+    } else {\n+      throw new FatalLinkerError(bool, 'Unsupported syntax, expected a boolean literal.');\n+    }\n   }\n \n   isArrayLiteral = t.isArrayExpression;\n@@ -165,3 +172,13 @@ type ArgumentType = t.CallExpression['arguments'][number];\n function isNotSpreadArgument(arg: ArgumentType): arg is Exclude<ArgumentType, t.SpreadElement> {\n   return !t.isSpreadElement(arg);\n }\n+\n+type MinifiedBooleanLiteral = t.Expression&t.UnaryExpression&{argument: t.NumericLiteral};\n+\n+/**\n+ * Return true if the node is either `!0` or `!1`.\n+ */\n+function isMinifiedBooleanLiteral(node: t.Expression): node is MinifiedBooleanLiteral {\n+  return t.isUnaryExpression(node) && node.prefix && node.operator === '!' &&\n+      t.isNumericLiteral(node.argument) && (node.argument.value === 0 || node.argument.value === 1);\n+}"
        },
        {
            "sha": "2540a6508dde3fa319719d59a8f6639e08654bf4",
            "filename": "packages/compiler-cli/linker/babel/test/ast/babel_ast_host_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/7744e1e6737a95032a8f82a0fb49ce6d72f7f484/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fast%2Fbabel_ast_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7744e1e6737a95032a8f82a0fb49ce6d72f7f484/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fast%2Fbabel_ast_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fast%2Fbabel_ast_host_spec.ts?ref=7744e1e6737a95032a8f82a0fb49ce6d72f7f484",
            "patch": "@@ -96,6 +96,11 @@ describe('BabelAstHost', () => {\n       expect(host.isBooleanLiteral(expr('false'))).toBe(true);\n     });\n \n+    it('should return true if the expression is a minified boolean literal', () => {\n+      expect(host.isBooleanLiteral(expr('!0'))).toBe(true);\n+      expect(host.isBooleanLiteral(expr('!1'))).toBe(true);\n+    });\n+\n     it('should return false if the expression is not a boolean literal', () => {\n       expect(host.isBooleanLiteral(expr('\"moo\"'))).toBe(false);\n       expect(host.isBooleanLiteral(expr('\\'moo\\''))).toBe(false);\n@@ -106,6 +111,8 @@ describe('BabelAstHost', () => {\n       expect(host.isBooleanLiteral(expr('null'))).toBe(false);\n       expect(host.isBooleanLiteral(expr('\\'a\\' + \\'b\\''))).toBe(false);\n       expect(host.isBooleanLiteral(expr('\\`moo\\`'))).toBe(false);\n+      expect(host.isBooleanLiteral(expr('!2'))).toBe(false);\n+      expect(host.isBooleanLiteral(expr('~1'))).toBe(false);\n     });\n   });\n \n@@ -115,6 +122,11 @@ describe('BabelAstHost', () => {\n       expect(host.parseBooleanLiteral(expr('false'))).toEqual(false);\n     });\n \n+    it('should extract a minified boolean value', () => {\n+      expect(host.parseBooleanLiteral(expr('!0'))).toEqual(true);\n+      expect(host.parseBooleanLiteral(expr('!1'))).toEqual(false);\n+    });\n+\n     it('should error if the value is not a boolean literal', () => {\n       expect(() => host.parseBooleanLiteral(expr('\"moo\"')))\n           .toThrowError('Unsupported syntax, expected a boolean literal.');"
        },
        {
            "sha": "ff7a5a9222e4615996c6a76dec5f301fc63092e6",
            "filename": "packages/compiler-cli/linker/src/ast/ast_host.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/7744e1e6737a95032a8f82a0fb49ce6d72f7f484/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Fast%2Fast_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/7744e1e6737a95032a8f82a0fb49ce6d72f7f484/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Fast%2Fast_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Fast%2Fast_host.ts?ref=7744e1e6737a95032a8f82a0fb49ce6d72f7f484",
            "patch": "@@ -36,11 +36,17 @@ export interface AstHost<TExpression> {\n   parseNumericLiteral(num: TExpression): number;\n \n   /**\n-   * Return `true` if the given expression is a boolean literal, or false otherwise.\n+   * Return `true` if the given expression can be considered a boolean literal, or false otherwise.\n+   *\n+   * Note that this should also cover the special case of some minified code where `true` and\n+   * `false` are replaced by `!0` and `!1` respectively.\n    */\n   isBooleanLiteral(node: TExpression): boolean;\n   /**\n    * Parse the boolean value from the given expression, or throw if it is not a boolean literal.\n+   *\n+   * Note that this should also cover the special case of some minified code where `true` and\n+   * `false` are replaced by `!0` and `!1` respectively.\n    */\n   parseBooleanLiteral(bool: TExpression): boolean;\n "
        },
        {
            "sha": "9b6bb9069ff93306b84cdb6332d8420bb64f2fd4",
            "filename": "packages/compiler-cli/linker/src/ast/typescript/typescript_ast_host.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 4,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/7744e1e6737a95032a8f82a0fb49ce6d72f7f484/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Fast%2Ftypescript%2Ftypescript_ast_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/7744e1e6737a95032a8f82a0fb49ce6d72f7f484/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Fast%2Ftypescript%2Ftypescript_ast_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Fast%2Ftypescript%2Ftypescript_ast_host.ts?ref=7744e1e6737a95032a8f82a0fb49ce6d72f7f484",
            "patch": "@@ -47,13 +47,18 @@ export class TypeScriptAstHost implements AstHost<ts.Expression> {\n     return parseInt(num.text);\n   }\n \n-  isBooleanLiteral(node: ts.Expression): node is ts.FalseLiteral|ts.TrueLiteral {\n-    return node.kind === ts.SyntaxKind.TrueKeyword || node.kind === ts.SyntaxKind.FalseKeyword;\n+  isBooleanLiteral(node: ts.Expression): boolean {\n+    return isBooleanLiteral(node) || isMinifiedBooleanLiteral(node);\n   }\n \n   parseBooleanLiteral(bool: ts.Expression): boolean {\n-    assert(bool, this.isBooleanLiteral, 'a boolean literal');\n-    return bool.kind === ts.SyntaxKind.TrueKeyword;\n+    if (isBooleanLiteral(bool)) {\n+      return bool.kind === ts.SyntaxKind.TrueKeyword;\n+    } else if (isMinifiedBooleanLiteral(bool)) {\n+      return !(+bool.operand.text);\n+    } else {\n+      throw new FatalLinkerError(bool, 'Unsupported syntax, expected a boolean literal.');\n+    }\n   }\n \n   isArrayLiteral = ts.isArrayLiteralExpression;\n@@ -160,3 +165,20 @@ function isNotSpreadElement(e: ts.Expression|ts.SpreadElement): e is ts.Expressi\n function isPropertyName(e: ts.PropertyName): e is ts.Identifier|ts.StringLiteral|ts.NumericLiteral {\n   return ts.isIdentifier(e) || ts.isStringLiteral(e) || ts.isNumericLiteral(e);\n }\n+\n+/**\n+ * Return true if the node is either `true` or `false` literals.\n+ */\n+function isBooleanLiteral(node: ts.Expression): node is ts.TrueLiteral|ts.FalseLiteral {\n+  return node.kind === ts.SyntaxKind.TrueKeyword || node.kind === ts.SyntaxKind.FalseKeyword;\n+}\n+\n+type MinifiedBooleanLiteral = ts.PrefixUnaryExpression&{operand: ts.NumericLiteral};\n+\n+/**\n+ * Return true if the node is either `!0` or `!1`.\n+ */\n+function isMinifiedBooleanLiteral(node: ts.Expression): node is MinifiedBooleanLiteral {\n+  return ts.isPrefixUnaryExpression(node) && node.operator === ts.SyntaxKind.ExclamationToken &&\n+      ts.isNumericLiteral(node.operand) && (node.operand.text === '0' || node.operand.text === '1');\n+}"
        },
        {
            "sha": "1b840eee42aef3f51285707770d56b7950ebeeac",
            "filename": "packages/compiler-cli/linker/test/ast/typescript/typescript_ast_host_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/7744e1e6737a95032a8f82a0fb49ce6d72f7f484/packages%2Fcompiler-cli%2Flinker%2Ftest%2Fast%2Ftypescript%2Ftypescript_ast_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7744e1e6737a95032a8f82a0fb49ce6d72f7f484/packages%2Fcompiler-cli%2Flinker%2Ftest%2Fast%2Ftypescript%2Ftypescript_ast_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Ftest%2Fast%2Ftypescript%2Ftypescript_ast_host_spec.ts?ref=7744e1e6737a95032a8f82a0fb49ce6d72f7f484",
            "patch": "@@ -94,6 +94,11 @@ describe('TypeScriptAstHost', () => {\n       expect(host.isBooleanLiteral(expr('false'))).toBe(true);\n     });\n \n+    it('should return true if the expression is a minified boolean literal', () => {\n+      expect(host.isBooleanLiteral(expr('!0'))).toBe(true);\n+      expect(host.isBooleanLiteral(expr('!1'))).toBe(true);\n+    });\n+\n     it('should return false if the expression is not a boolean literal', () => {\n       expect(host.isBooleanLiteral(expr('\"moo\"'))).toBe(false);\n       expect(host.isBooleanLiteral(expr('\\'moo\\''))).toBe(false);\n@@ -104,6 +109,8 @@ describe('TypeScriptAstHost', () => {\n       expect(host.isBooleanLiteral(expr('null'))).toBe(false);\n       expect(host.isBooleanLiteral(expr('\\'a\\' + \\'b\\''))).toBe(false);\n       expect(host.isBooleanLiteral(expr('\\`moo\\`'))).toBe(false);\n+      expect(host.isBooleanLiteral(expr('!2'))).toBe(false);\n+      expect(host.isBooleanLiteral(expr('~1'))).toBe(false);\n     });\n   });\n \n@@ -113,6 +120,11 @@ describe('TypeScriptAstHost', () => {\n       expect(host.parseBooleanLiteral(expr('false'))).toEqual(false);\n     });\n \n+    it('should extract a minified boolean value', () => {\n+      expect(host.parseBooleanLiteral(expr('!0'))).toEqual(true);\n+      expect(host.parseBooleanLiteral(expr('!1'))).toEqual(false);\n+    });\n+\n     it('should error if the value is not a boolean literal', () => {\n       expect(() => host.parseBooleanLiteral(expr('\"moo\"')))\n           .toThrowError('Unsupported syntax, expected a boolean literal.');"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 77,
        "deletions": 8
    }
}