{
    "author": "gkalpak",
    "message": "fix(ngcc): correctly report error when collecting dependencies of UMD module (#44245)\n\nPreviously, the ngcc `UmdReflectionHost` would throw a misleading error\nwhen trying to collect dependencies of an invalidly formatted UMD\nmodule. This happened because an error would be thrown while trying to\nconstruct the error message for the actual error, by calling `getText()`\non certain TypeScript AST nodes. See\nhttps://github.com/angular/angular/issues/44019#issuecomment-959954121\nfor a more in-depth explanation.\n\nThis commit ensures `getText()` can be safely called on TypeScript AST\nnodes when collecting dependencies of UMD modules.\n\nPR Close #44245",
    "sha": "de0975c6d99bbe9332382a8f6f2b920f9e4b9d49",
    "files": [
        {
            "sha": "e5e4b21e0257230e07221cfee6e963c1de4e5396",
            "filename": "packages/compiler-cli/ngcc/src/dependencies/umd_dependency_host.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/de0975c6d99bbe9332382a8f6f2b920f9e4b9d49/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fdependencies%2Fumd_dependency_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/de0975c6d99bbe9332382a8f6f2b920f9e4b9d49/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fdependencies%2Fumd_dependency_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fdependencies%2Fumd_dependency_host.ts?ref=de0975c6d99bbe9332382a8f6f2b920f9e4b9d49",
            "patch": "@@ -24,7 +24,7 @@ export class UmdDependencyHost extends DependencyHostBase {\n   protected override extractImports(file: AbsoluteFsPath, fileContents: string): Set<string> {\n     // Parse the source into a TypeScript AST and then walk it looking for imports and re-exports.\n     const sf =\n-        ts.createSourceFile(file, fileContents, ts.ScriptTarget.ES2015, false, ts.ScriptKind.JS);\n+        ts.createSourceFile(file, fileContents, ts.ScriptTarget.ES2015, true, ts.ScriptKind.JS);\n \n     if (sf.statements.length !== 1) {\n       return new Set();"
        },
        {
            "sha": "c0713d0f0a05007db8f48daa08d477b30fdcd907",
            "filename": "packages/compiler-cli/ngcc/test/dependencies/umd_dependency_host_spec.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/de0975c6d99bbe9332382a8f6f2b920f9e4b9d49/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/de0975c6d99bbe9332382a8f6f2b920f9e4b9d49/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts?ref=de0975c6d99bbe9332382a8f6f2b920f9e4b9d49",
            "patch": "@@ -147,6 +147,16 @@ runInEachFileSystem(() => {\n             expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n             expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n           });\n+\n+          it('should correctly report errors for invalid source files', () => {\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+\n+            expect(\n+                () => host.collectDependencies(\n+                    _('/invalid/format/index.js'), {dependencies, missing, deepImports}))\n+                .toThrowError(\n+                    /^UMD wrapper body is not in a supported format \\(expected a conditional expression or if statement\\)/);\n+          });\n         });\n \n         function setupMockFileSystem(): void {\n@@ -172,6 +182,16 @@ runInEachFileSystem(() => {\n               contents: '{\"esm2015\": \"./index.js\"}'\n             },\n             {name: _('/no/imports/but/cannot/skip/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/invalid/format/index.js'),\n+              contents: `\n+                (function (global, factory) {\n+                  const invalidWrapperFunctionFormat = require('true');\n+                }(this, function () {}));\n+              `,\n+            },\n+            {name: _('/invalid/format/package.json'), contents: '{\"esm2015\": \"./index.js\"}'},\n+            {name: _('/invalid/format/index.metadata.json'), contents: 'MOCK METADATA'},\n             {\n               name: _('/external/imports/index.js'),\n               contents: umd('imports_index', ['lib_1', 'lib_1/sub_1'])"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 21,
        "deletions": 1
    }
}