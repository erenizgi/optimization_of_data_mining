{
    "author": "Carlosamouco",
    "message": "fix(router): prevent componentless routes from being detached (#44240)\n\nCurrently, when deactivating a route, the detach method of the RouteReuseStrategy is always called\neven when we are dealing with a componentless route. If when using a custom strategy we attempt to\ndetach a componentless route, an exception is thrown causing the navigation to break.\nThis change prevents this from happening, by not triggering the detach of the route reuse strategy.\n\nFixes #44239\n\nPR Close #44240",
    "sha": "f44cb57c12c29e76167272c675c0ce23838ce723",
    "files": [
        {
            "sha": "9489941cdd2eecaeee3abe1bbc51dde545a0022a",
            "filename": "packages/router/src/operators/activate_routes.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/f44cb57c12c29e76167272c675c0ce23838ce723/packages%2Frouter%2Fsrc%2Foperators%2Factivate_routes.ts",
            "raw_url": "https://github.com/angular/angular/raw/f44cb57c12c29e76167272c675c0ce23838ce723/packages%2Frouter%2Fsrc%2Foperators%2Factivate_routes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Foperators%2Factivate_routes.ts?ref=f44cb57c12c29e76167272c675c0ce23838ce723",
            "patch": "@@ -89,7 +89,9 @@ export class ActivateRoutes {\n \n   private deactivateRouteAndItsChildren(\n       route: TreeNode<ActivatedRoute>, parentContexts: ChildrenOutletContexts): void {\n-    if (this.routeReuseStrategy.shouldDetach(route.value.snapshot)) {\n+    // If there is no component, the Route is never attached to an outlet (because there is no\n+    // component to attach).\n+    if (route.value.component && this.routeReuseStrategy.shouldDetach(route.value.snapshot)) {\n       this.detachAndStoreRouteSubtree(route, parentContexts);\n     } else {\n       this.deactivateRouteAndOutlet(route, parentContexts);"
        },
        {
            "sha": "e132c47048f4e2d801f3c89c5152f1045607a667",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/f44cb57c12c29e76167272c675c0ce23838ce723/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f44cb57c12c29e76167272c675c0ce23838ce723/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=f44cb57c12c29e76167272c675c0ce23838ce723",
            "patch": "@@ -6083,6 +6083,57 @@ describe('Integration', () => {\n          advance(fixture);\n          expect(createdComps).toEqual(['parent', 'child', 'child']);\n        }));\n+\n+    it('should not try to detach the outlet of a route that does not get to attach a component',\n+       fakeAsync(() => {\n+         @Component({selector: 'root', template: `<router-outlet></router-outlet>`})\n+         class Root {\n+         }\n+\n+         @Component({selector: 'component-a', template: 'Component A'})\n+         class ComponentA {\n+         }\n+\n+         @Component({selector: 'component-b', template: 'Component B'})\n+         class ComponentB {\n+         }\n+\n+         @NgModule({\n+           declarations: [ComponentA],\n+           imports: [RouterModule.forChild([{path: '', component: ComponentA}])],\n+         })\n+         class LoadedModule {\n+         }\n+\n+         @NgModule({\n+           declarations: [Root, ComponentB],\n+           imports: [RouterTestingModule.withRoutes([\n+             {path: 'a', loadChildren: () => LoadedModule}, {path: 'b', component: ComponentB}\n+           ])],\n+           providers: [\n+             {provide: RouteReuseStrategy, useClass: AttachDetachReuseStrategy},\n+           ]\n+         })\n+         class TestModule {\n+         }\n+\n+         TestBed.configureTestingModule({imports: [TestModule]});\n+\n+         const router = TestBed.inject(Router);\n+         const strategy = TestBed.inject(RouteReuseStrategy);\n+         const fixture = createRoot(router, Root);\n+\n+         spyOn(strategy, 'shouldDetach').and.callThrough();\n+\n+         router.navigateByUrl('/a');\n+         advance(fixture);\n+\n+         // Deactivate 'a'\n+         // 'shouldDetach' should not be called for the componentless route\n+         router.navigateByUrl('/b');\n+         advance(fixture);\n+         expect(strategy.shouldDetach).toHaveBeenCalledTimes(1);\n+       }));\n   });\n });\n "
        }
    ],
    "stats": {
        "total": 55,
        "additions": 54,
        "deletions": 1
    }
}