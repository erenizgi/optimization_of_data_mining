{
    "author": "ivanwonder",
    "message": "fix(compiler): correct the `KeySpan` for animation events and properties (#40347)\n\nWe should provide the completion when the cursor is in the attribute\nname after the `@` and `animate-`, but now the `KeySpan` starts from the\n`@` or `animate-`. For example, the animation event `(@name.done)=\"v\"`,\nwe can know where the cursor is by the `KeySpan` of `name.done` exactly,\nit's in the event name or in the phase name.\n\nPR Close #40347",
    "sha": "40e0bfdc0d868b4d83c936eb525ee1b524ff0013",
    "files": [
        {
            "sha": "6608a5fd19befc43ac09fe1c79e1b88a2181c27f",
            "filename": "packages/compiler/src/template_parser/binding_parser.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/40e0bfdc0d868b4d83c936eb525ee1b524ff0013/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/40e0bfdc0d868b4d83c936eb525ee1b524ff0013/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts?ref=40e0bfdc0d868b4d83c936eb525ee1b524ff0013",
            "patch": "@@ -244,6 +244,10 @@ export class BindingParser {\n       targetProps: ParsedProperty[], keySpan?: ParseSourceSpan) {\n     if (isAnimationLabel(name)) {\n       name = name.substring(1);\n+      if (keySpan !== undefined) {\n+        keySpan = moveParseSourceSpan(\n+            keySpan, new AbsoluteSourceSpan(keySpan.start.offset + 1, keySpan.end.offset));\n+      }\n       if (value) {\n         this._reportError(\n             `Assigning animation triggers via @prop=\"exp\" attributes with an expression is invalid.` +\n@@ -274,9 +278,19 @@ export class BindingParser {\n     if (name.startsWith(ANIMATE_PROP_PREFIX)) {\n       isAnimationProp = true;\n       name = name.substring(ANIMATE_PROP_PREFIX.length);\n+      if (keySpan !== undefined) {\n+        keySpan = moveParseSourceSpan(\n+            keySpan,\n+            new AbsoluteSourceSpan(\n+                keySpan.start.offset + ANIMATE_PROP_PREFIX.length, keySpan.end.offset));\n+      }\n     } else if (isAnimationLabel(name)) {\n       isAnimationProp = true;\n       name = name.substring(1);\n+      if (keySpan !== undefined) {\n+        keySpan = moveParseSourceSpan(\n+            keySpan, new AbsoluteSourceSpan(keySpan.start.offset + 1, keySpan.end.offset));\n+      }\n     }\n \n     if (isAnimationProp) {\n@@ -424,6 +438,10 @@ export class BindingParser {\n \n     if (isAnimationLabel(name)) {\n       name = name.substr(1);\n+      if (keySpan !== undefined) {\n+        keySpan = moveParseSourceSpan(\n+            keySpan, new AbsoluteSourceSpan(keySpan.start.offset + 1, keySpan.end.offset));\n+      }\n       this._parseAnimationEvent(name, expression, sourceSpan, handlerSpan, targetEvents, keySpan);\n     } else {\n       this._parseRegularEvent("
        },
        {
            "sha": "f6f03a17a98933509f8ac4a6a3e9686721d3daf2",
            "filename": "packages/compiler/test/render3/r3_ast_spans_spec.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/40e0bfdc0d868b4d83c936eb525ee1b524ff0013/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/40e0bfdc0d868b4d83c936eb525ee1b524ff0013/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts?ref=40e0bfdc0d868b4d83c936eb525ee1b524ff0013",
            "patch": "@@ -193,6 +193,30 @@ describe('R3 AST source spans', () => {\n         ['BoundAttribute', 'data-prop=\"{{v}}\"', 'prop', '{{v}}'],\n       ]);\n     });\n+\n+    it('is correct for bound properties via @', () => {\n+      expectFromHtml('<div bind-@animation=\"v\"></div>').toEqual([\n+        ['Element', '<div bind-@animation=\"v\"></div>', '<div bind-@animation=\"v\">', '</div>'],\n+        ['BoundAttribute', 'bind-@animation=\"v\"', 'animation', 'v'],\n+      ]);\n+    });\n+\n+    it('is correct for bound properties via animation-', () => {\n+      expectFromHtml('<div bind-animate-animationName=\"v\"></div>').toEqual([\n+        [\n+          'Element', '<div bind-animate-animationName=\"v\"></div>',\n+          '<div bind-animate-animationName=\"v\">', '</div>'\n+        ],\n+        ['BoundAttribute', 'bind-animate-animationName=\"v\"', 'animationName', 'v'],\n+      ]);\n+    });\n+\n+    it('is correct for bound properties via @ without value', () => {\n+      expectFromHtml('<div @animation></div>').toEqual([\n+        ['Element', '<div @animation></div>', '<div @animation>', '</div>'],\n+        ['BoundAttribute', '@animation', 'animation', '<empty>'],\n+      ]);\n+    });\n   });\n \n   describe('templates', () => {\n@@ -401,6 +425,13 @@ describe('R3 AST source spans', () => {\n         ['BoundEvent', 'data-bindon-prop=\"v\"', 'prop', 'v'],\n       ]);\n     });\n+\n+    it('is correct for bound events via @', () => {\n+      expectFromHtml('<div (@name.done)=\"v\"></div>').toEqual([\n+        ['Element', '<div (@name.done)=\"v\"></div>', '<div (@name.done)=\"v\">', '</div>'],\n+        ['BoundEvent', '(@name.done)=\"v\"', 'name.done', 'v'],\n+      ]);\n+    });\n   });\n \n   describe('references', () => {"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 49,
        "deletions": 0
    }
}