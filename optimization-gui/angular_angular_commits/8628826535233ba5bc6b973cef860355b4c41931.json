{
    "author": "crisbeto",
    "message": "fix(core): incorrect error reported when trying to re-create view which had an error during creation (#43005)\n\nCurrently if a view throws an error during creation mode, we mark it as `incompleteFirstPass` so that we can try to recover later. The recovery is only possible inside component views.\n\nThe problem is that when this was introduced, I forgot to flip the `firstCreatePass` when an error is thrown which meant that calling `renderView` on the same component again is allowed. It will eventually hit an assertion which can be confusing for the end user. This issue only manifests itself when rendering views \"manually\" through `ViewContainerRef` (e.g. using `NgIf`).\n\nThese changes flip the `firstCreatePass` back to false on errors so that trying to re-render the same view will throw an error which is consistent to the one that broke the view during creation.\n\nFixes #41383.\n\nPR Close #43005",
    "sha": "8628826535233ba5bc6b973cef860355b4c41931",
    "files": [
        {
            "sha": "4b64276d0d0d6682e97961ad637d8d1af2441892",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8628826535233ba5bc6b973cef860355b4c41931/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/8628826535233ba5bc6b973cef860355b4c41931/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=8628826535233ba5bc6b973cef860355b4c41931",
            "patch": "@@ -30,7 +30,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 1190,\n-        \"main-es2015\": 136546,\n+        \"main-es2015\": 137055,\n         \"polyfills-es2015\": 37641\n       }\n     }"
        },
        {
            "sha": "a9214c4d73e2e9e73b527c87bc2d26a1eaa8e3ab",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/8628826535233ba5bc6b973cef860355b4c41931/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/8628826535233ba5bc6b973cef860355b4c41931/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=8628826535233ba5bc6b973cef860355b4c41931",
            "patch": "@@ -336,6 +336,7 @@ export function renderView<T>(tView: TView, lView: LView, context: T): void {\n     // an error, mark the view as corrupted so we can try to recover.\n     if (tView.firstCreatePass) {\n       tView.incompleteFirstPass = true;\n+      tView.firstCreatePass = false;\n     }\n \n     throw error;"
        },
        {
            "sha": "72a424c9d2cbb9bf129a1ffb1fc608918e1cde64",
            "filename": "packages/core/test/acceptance/view_insertion_spec.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 1,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/8628826535233ba5bc6b973cef860355b4c41931/packages%2Fcore%2Ftest%2Facceptance%2Fview_insertion_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8628826535233ba5bc6b973cef860355b4c41931/packages%2Fcore%2Ftest%2Facceptance%2Fview_insertion_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fview_insertion_spec.ts?ref=8628826535233ba5bc6b973cef860355b4c41931",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {CommonModule} from '@angular/common';\n-import {ChangeDetectorRef, Component, ComponentFactoryResolver, Directive, EmbeddedViewRef, Injector, Input, NgModule, TemplateRef, ViewChild, ViewContainerRef, ViewRef} from '@angular/core';\n+import {ChangeDetectorRef, Component, ComponentFactoryResolver, Directive, EmbeddedViewRef, Injectable, Injector, Input, NgModule, TemplateRef, ViewChild, ViewContainerRef, ViewRef} from '@angular/core';\n import {TestBed} from '@angular/core/testing';\n import {By} from '@angular/platform-browser';\n import {onlyInIvy} from '@angular/private/testing';\n@@ -886,5 +886,46 @@ describe('view insertion', () => {\n       fixture.detectChanges();\n       expect(fixture.nativeElement.textContent).toContain('2');\n     });\n+\n+    it('should consistently report errors raised by createEmbeddedView', () => {\n+      // Intentionally hasn't been added to `providers` so that it throws a DI error.\n+      @Injectable()\n+      class DoesNotExist {\n+      }\n+\n+      @Directive({selector: 'dir'})\n+      class Dir {\n+        constructor(willCauseError: DoesNotExist) {}\n+      }\n+\n+      @Component({\n+        template: `\n+          <ng-template #broken>\n+            <dir></dir>\n+          </ng-template>\n+        `,\n+      })\n+      class App {\n+        @ViewChild('broken') template !: TemplateRef<unknown>;\n+\n+        constructor(private _viewContainerRef: ViewContainerRef) {}\n+\n+        insertTemplate() {\n+          this._viewContainerRef.createEmbeddedView(this.template);\n+        }\n+      }\n+\n+      TestBed.configureTestingModule({declarations: [App, Dir]});\n+      const fixture = TestBed.createComponent(App);\n+      const tryRender = () => {\n+        fixture.componentInstance.insertTemplate();\n+        fixture.detectChanges();\n+      };\n+      fixture.detectChanges();\n+\n+      // We try to render the same template twice to ensure that we get consistent error messages.\n+      expect(tryRender).toThrowError(/No provider for DoesNotExist/);\n+      expect(tryRender).toThrowError(/No provider for DoesNotExist/);\n+    });\n   });\n });"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 44,
        "deletions": 2
    }
}