{
    "author": "JoostK",
    "message": "refactor(compiler-cli): allow visiting call expressions without an active linker (#39707)\n\nThe compilation result of components may have inserted template\nfunctions into the constant pool, which would be inserted into the Babel\nAST upon program exit. Babel will then proceed with visiting this newly\ninserted subtree, but we have already cleaned up the linker instance\nwhen exiting the program. Any call expressions within the template\nfunctions would then fail to be processed, as a file linker would no\nlonger be available.\n\nSince the inserted AST subtree is known not to contain yet more partial\ndeclarations, it is safe to skip visiting call expressions when no\nfile linker is available.\n\nPR Close #39707",
    "sha": "e79ce386fc4ab8e83372fa694971283a19a11a67",
    "files": [
        {
            "sha": "0ebe7b5db53e8cfd63990cb1d8bb982f0b4005e7",
            "filename": "packages/compiler-cli/linker/babel/src/es2015_linker_plugin.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/e79ce386fc4ab8e83372fa694971283a19a11a67/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fes2015_linker_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/e79ce386fc4ab8e83372fa694971283a19a11a67/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fes2015_linker_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fes2015_linker_plugin.ts?ref=e79ce386fc4ab8e83372fa694971283a19a11a67",
            "patch": "@@ -58,9 +58,14 @@ export function createEs2015LinkerPlugin(options: Partial<LinkerOptions> = {}):\n        * with the results of linking the declaration.\n        */\n       CallExpression(call: NodePath<t.CallExpression>): void {\n-        try {\n-          assertNotNull(fileLinker);\n+        if (fileLinker === null) {\n+          // Any statements that are inserted upon program exit will be visited outside of an active\n+          // linker context. These call expressions are known not to contain partial declarations,\n+          // so it's safe to skip visiting those call expressions.\n+          return;\n+        }\n \n+        try {\n           const callee = call.node.callee;\n           if (!t.isExpression(callee)) {\n             return;"
        },
        {
            "sha": "da4b2bc8b85d65c502e5c82542eab7d680cb51ac",
            "filename": "packages/compiler-cli/linker/babel/test/es2015_linker_plugin_spec.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/e79ce386fc4ab8e83372fa694971283a19a11a67/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fes2015_linker_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e79ce386fc4ab8e83372fa694971283a19a11a67/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fes2015_linker_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fes2015_linker_plugin_spec.ts?ref=e79ce386fc4ab8e83372fa694971283a19a11a67",
            "patch": "@@ -213,6 +213,41 @@ describe('createEs2015LinkerPlugin()', () => {\n          `(function(){const x1=[1];return function BAR(){};})();BAR;`,\n        ].join(''));\n      });\n+\n+  it('should not process call expressions within inserted functions', () => {\n+    spyOn(PartialDirectiveLinkerVersion1.prototype, 'linkPartialDeclaration')\n+        .and.callFake(((sourceUrl, code, constantPool) => {\n+                        // Insert a call expression into the constant pool. This is inserted into\n+                        // Babel's AST upon program exit, and will therefore be visited by Babel\n+                        // outside of an active linker context.\n+                        constantPool.statements.push(\n+                            o.fn(/* params */[], /* body */[], /* type */ undefined,\n+                                 /* sourceSpan */ undefined, /* name */ 'inserted')\n+                                .callFn([])\n+                                .toStmt());\n+\n+                        return o.literal('REPLACEMENT');\n+                      }) as typeof PartialDirectiveLinkerVersion1.prototype.linkPartialDeclaration);\n+\n+    const isPartialDeclarationSpy =\n+        spyOn(FileLinker.prototype, 'isPartialDeclaration').and.callThrough();\n+\n+    const result = transformSync(\n+        [\n+          'import * as core from \\'some-module\\';',\n+          `ɵɵngDeclareDirective({version: 1, ngImport: core})`,\n+        ].join('\\n'),\n+        {\n+          plugins: [createEs2015LinkerPlugin()],\n+          filename: '/test.js',\n+          parserOpts: {sourceType: 'unambiguous'},\n+          generatorOpts: {compact: true},\n+        });\n+    expect(result!.code)\n+        .toEqual('import*as core from\\'some-module\\';(function inserted(){})();\"REPLACEMENT\";');\n+\n+    expect(isPartialDeclarationSpy.calls.allArgs()).toEqual([['ɵɵngDeclareDirective']]);\n+  });\n });\n \n /**"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 42,
        "deletions": 2
    }
}