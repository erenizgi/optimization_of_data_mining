{
    "author": "devversion",
    "message": "feat(dev-infra): add option to setup global types in API golden test (#42876)\n\nPreviously we disabled automatic type-resolution for the API\nextractor because in non-sandbox environments this resulted in\ndifferent API reports. There are cases where global types are\nstill needed for analysis of an entry-point. To support this,\nwe add a new property called `types` which allows for explicit\ntype targets being specified.\n\nNote that we do not want to determine types from the `data`\nrunfiles because API extractor itself also brings in types\nwhich should not always be part of the API report analysis.\n\nPR Close #42876",
    "sha": "7eddd12bf001bab9e2e320339cc5c9f698f4cfd8",
    "files": [
        {
            "sha": "6f2142fbe976ca5b5ece92226b1b0d8fb8097ff8",
            "filename": "dev-infra/bazel/api-golden/index.bzl",
            "status": "modified",
            "additions": 35,
            "deletions": 7,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/7eddd12bf001bab9e2e320339cc5c9f698f4cfd8/dev-infra%2Fbazel%2Fapi-golden%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/7eddd12bf001bab9e2e320339cc5c9f698f4cfd8/dev-infra%2Fbazel%2Fapi-golden%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2Findex.bzl?ref=7eddd12bf001bab9e2e320339cc5c9f698f4cfd8",
            "patch": "@@ -17,6 +17,27 @@ default_strip_export_pattern = \"^ɵ(?!ɵdefineInjectable|ɵinject|ɵInjectableDe\n def _escape_regex_for_arg(value):\n     return \"\\\"%s\\\"\" % value\n \n+\"\"\"\n+  Extracts type names from a list of NPM type targets.\n+\n+  For example: Consider the `@npm//@types/node` target. This function extracts `node`\n+  from the label. This is needed so that the Node types can be wired up within a\n+  TypeScript program using the `types` tsconfig option.\n+\"\"\"\n+\n+def extract_type_names_from_labels(type_targets):\n+    type_names = []\n+    for type_target in type_targets:\n+        type_package = Label(type_target).package\n+\n+        if (type_package.startswith(\"@types/\")):\n+            type_names.append(type_package[len(\"@types/\"):])\n+        else:\n+            fail(\"Expected type target to match the following format: \" +\n+                 \"`@<npm_workspace>//@types/<name>`, but got: %s\" % type_target)\n+\n+    return type_names\n+\n \"\"\"\n   Builds an API report for the specified entry-point and compares it against the\n   specified golden\n@@ -28,6 +49,7 @@ def api_golden_test(\n         entry_point,\n         data = [],\n         strip_export_pattern = default_strip_export_pattern,\n+        types = [],\n         **kwargs):\n     quoted_export_pattern = _escape_regex_for_arg(strip_export_pattern)\n \n@@ -46,13 +68,15 @@ def api_golden_test(\n         include_default_files = False,\n     )\n \n-    test_data = [\"//dev-infra/bazel/api-golden\", \"//:package.json\", \":%s_data_typings\" % name] + data\n+    test_data = [\"//dev-infra/bazel/api-golden\", \"//:package.json\", \":%s_data_typings\" % name] + \\\n+                data + types\n \n     nodejs_test(\n         name = name,\n         data = test_data,\n         entry_point = \"//dev-infra/bazel/api-golden:index.ts\",\n-        templated_args = nodejs_test_args + [golden, entry_point, \"false\", quoted_export_pattern],\n+        templated_args = nodejs_test_args + [golden, entry_point, \"false\", quoted_export_pattern] +\n+                         extract_type_names_from_labels(types),\n         **kwargs\n     )\n \n@@ -61,7 +85,8 @@ def api_golden_test(\n         testonly = True,\n         data = test_data,\n         entry_point = \"//dev-infra/bazel/api-golden:index.ts\",\n-        templated_args = nodejs_test_args + [golden, entry_point, \"true\", quoted_export_pattern],\n+        templated_args = nodejs_test_args + [golden, entry_point, \"true\", quoted_export_pattern] +\n+                         extract_type_names_from_labels(types),\n         **kwargs\n     )\n \n@@ -76,24 +101,27 @@ def api_golden_test_npm_package(\n         npm_package,\n         data = [],\n         strip_export_pattern = default_strip_export_pattern,\n+        types = [],\n         **kwargs):\n     quoted_export_pattern = _escape_regex_for_arg(strip_export_pattern)\n \n     kwargs[\"tags\"] = kwargs.get(\"tags\", []) + [\"api_guard\"]\n \n     nodejs_test(\n         name = name,\n-        data = [\"//dev-infra/bazel/api-golden\"] + data,\n+        data = [\"//dev-infra/bazel/api-golden\"] + data + types,\n         entry_point = \"//dev-infra/bazel/api-golden:index_npm_packages.ts\",\n-        templated_args = nodejs_test_args + [golden_dir, npm_package, \"false\", quoted_export_pattern],\n+        templated_args = nodejs_test_args + [golden_dir, npm_package, \"false\", quoted_export_pattern] +\n+                         extract_type_names_from_labels(types),\n         **kwargs\n     )\n \n     nodejs_binary(\n         name = name + \".accept\",\n         testonly = True,\n-        data = [\"//dev-infra/bazel/api-golden\"] + data,\n+        data = [\"//dev-infra/bazel/api-golden\"] + data + types,\n         entry_point = \"//dev-infra/bazel/api-golden:index_npm_packages.ts\",\n-        templated_args = nodejs_test_args + [golden_dir, npm_package, \"true\", quoted_export_pattern],\n+        templated_args = nodejs_test_args + [golden_dir, npm_package, \"true\", quoted_export_pattern] +\n+                         extract_type_names_from_labels(types),\n         **kwargs\n     )"
        },
        {
            "sha": "3de18aa7ca0b746f5cb6dc2f03a642266cc35a8c",
            "filename": "dev-infra/bazel/api-golden/index.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/7eddd12bf001bab9e2e320339cc5c9f698f4cfd8/dev-infra%2Fbazel%2Fapi-golden%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/7eddd12bf001bab9e2e320339cc5c9f698f4cfd8/dev-infra%2Fbazel%2Fapi-golden%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2Findex.ts?ref=7eddd12bf001bab9e2e320339cc5c9f698f4cfd8",
            "patch": "@@ -17,9 +17,9 @@ import {testApiGolden} from './test_api_report';\n  */\n async function main(\n     goldenFilePath: string, entryPointFilePath: string, approveGolden: boolean,\n-    stripExportPattern: RegExp) {\n-  const {succeeded, apiReportChanged} =\n-      await testApiGolden(goldenFilePath, entryPointFilePath, approveGolden, stripExportPattern);\n+    stripExportPattern: RegExp, typeNames: string[]) {\n+  const {succeeded, apiReportChanged} = await testApiGolden(\n+      goldenFilePath, entryPointFilePath, approveGolden, stripExportPattern, typeNames);\n \n   if (!succeeded && apiReportChanged) {\n     console.error(chalk.red(`The API signature has changed and the golden file is outdated.`));\n@@ -37,9 +37,11 @@ if (require.main === module) {\n   const entryPointFilePath = runfiles.resolve(args[1]);\n   const approveGolden = args[2] === 'true';\n   const stripExportPattern = new RegExp(args[3]);\n+  const typeNames = args.slice(4);\n \n-  main(goldenFilePath, entryPointFilePath, approveGolden, stripExportPattern).catch(e => {\n-    console.error(e);\n-    process.exit(1);\n-  });\n+  main(goldenFilePath, entryPointFilePath, approveGolden, stripExportPattern, typeNames)\n+      .catch(e => {\n+        console.error(e);\n+        process.exit(1);\n+      });\n }"
        },
        {
            "sha": "20dc2a4d3ddc5dcf8881514f7d416dc1d2c41058",
            "filename": "dev-infra/bazel/api-golden/index_npm_packages.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/7eddd12bf001bab9e2e320339cc5c9f698f4cfd8/dev-infra%2Fbazel%2Fapi-golden%2Findex_npm_packages.ts",
            "raw_url": "https://github.com/angular/angular/raw/7eddd12bf001bab9e2e320339cc5c9f698f4cfd8/dev-infra%2Fbazel%2Fapi-golden%2Findex_npm_packages.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2Findex_npm_packages.ts?ref=7eddd12bf001bab9e2e320339cc5c9f698f4cfd8",
            "patch": "@@ -19,7 +19,8 @@ import {testApiGolden} from './test_api_report';\n  * against golden files within the given golden directory.\n  */\n async function main(\n-    goldenDir: string, npmPackageDir: string, approveGolden: boolean, stripExportPattern: RegExp) {\n+    goldenDir: string, npmPackageDir: string, approveGolden: boolean, stripExportPattern: RegExp,\n+    typeNames: string[]) {\n   const entryPoints = findEntryPointsWithinNpmPackage(npmPackageDir);\n   const outdatedGoldens: string[] = [];\n   let allTestsSucceeding = true;\n@@ -35,7 +36,8 @@ async function main(\n     const goldenFilePath = join(goldenDir, goldenName);\n \n     const {succeeded, apiReportChanged} = await testApiGolden(\n-        goldenFilePath, typesEntryPointPath, approveGolden, stripExportPattern, packageJsonPath);\n+        goldenFilePath, typesEntryPointPath, approveGolden, stripExportPattern, typeNames,\n+        packageJsonPath);\n \n     // Keep track of outdated goldens.\n     if (!succeeded && apiReportChanged) {\n@@ -63,8 +65,9 @@ if (require.main === module) {\n   const npmPackageDir = runfiles.resolve(args[1]);\n   const approveGolden = args[2] === 'true';\n   const stripExportPattern = new RegExp(args[3]);\n+  const typeNames = args.slice(4);\n \n-  main(goldenDir, npmPackageDir, approveGolden, stripExportPattern).catch(e => {\n+  main(goldenDir, npmPackageDir, approveGolden, stripExportPattern, typeNames).catch(e => {\n     console.error(e);\n     process.exit(1);\n   });"
        },
        {
            "sha": "45d82713c06efa85a20d9b369e959688182ad44b",
            "filename": "dev-infra/bazel/api-golden/test_api_report.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/7eddd12bf001bab9e2e320339cc5c9f698f4cfd8/dev-infra%2Fbazel%2Fapi-golden%2Ftest_api_report.ts",
            "raw_url": "https://github.com/angular/angular/raw/7eddd12bf001bab9e2e320339cc5c9f698f4cfd8/dev-infra%2Fbazel%2Fapi-golden%2Ftest_api_report.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2Ftest_api_report.ts?ref=7eddd12bf001bab9e2e320339cc5c9f698f4cfd8",
            "patch": "@@ -28,13 +28,15 @@ const _origFetchAstModuleExportInfo = ExportAnalyzer.prototype.fetchAstModuleExp\n  * @param approveGolden Whether the golden file should be updated.\n  * @param stripExportPattern Regular Expression that can be used to filter out exports\n  *   from the API report.\n+ * @param typeNames Name of types which should be included for analysis of the entry-point.\n+ *   Types are expected to exist within the default `node_modules/@types/` folder.\n  * @param packageJsonPath Optional path to a `package.json` file that contains the entry\n  *   point. Note that the `package.json` is currently only used by `api-extractor` to determine\n  *   the package name displayed within the API golden.\n  */\n export async function testApiGolden(\n     goldenFilePath: string, indexFilePath: string, approveGolden: boolean,\n-    stripExportPattern: RegExp,\n+    stripExportPattern: RegExp, typeNames: string[] = [],\n     packageJsonPath = resolveWorkspacePackageJsonPath()): Promise<ExtractorResult> {\n   // If no `TEST_TMPDIR` is defined, then this script runs using `bazel run`. We use\n   // the runfile directory as temporary directory for API extractor.\n@@ -43,9 +45,10 @@ export async function testApiGolden(\n   const configObject: IConfigFile = {\n     compiler: {\n       overrideTsconfig:\n-          // We disable inclusion of all `@types` installed as this throws-off API reports\n-          // and causes different goldens when the API test is run outside sandbox.\n-          {files: [indexFilePath], compilerOptions: {types: [], lib: ['esnext', 'dom']}}\n+          // We disable automatic `@types` resolution as this throws-off API reports\n+          // when the API test is run outside sandbox. Instead we expect a list of\n+          // hard-coded types that should be included. This works in non-sandbox too.\n+          {files: [indexFilePath], compilerOptions: {types: typeNames, lib: ['esnext', 'dom']}}\n     },\n     projectFolder: dirname(packageJsonPath),\n     mainEntryPointFilePath: indexFilePath,"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 57,
        "deletions": 21
    }
}