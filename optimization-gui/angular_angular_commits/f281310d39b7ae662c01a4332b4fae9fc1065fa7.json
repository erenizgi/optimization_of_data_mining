{
    "author": "gkalpak",
    "message": "fix(docs-infra): print info to help debugging SW cache issue (#41106)\n\nFrom time to time, an angular.io page fails to load due to requesting a\nfile that cannot be found neither on the server nor in the cache. We\nbelieve this is caused by the browser's partially clearing a cache.\nSee #28114 for more details.\n\nSome time ago, we introduced [SwUpdate#unrecoverable][1] to help work\naround this issue by [reloading the page][2] when such an error is\ndetected.\n\nHowever, this issue still pops up occasionally (for example, #41073).\n\nIn an attempt to help diagnose the issue, this commit prints more info\nregarding the SW state and cache content when this error occurs. It will\nresult in something like the following being printed to the console:\n\n```\nServiceWorker: activated\n\nCache: ngsw:/:db:control (2 entries)\n  - https://angular.io/assignments: {\"f5f02035-ee1f-463c-946c-e8b85badca25\":\"5c95f89a85255a6fefb4045a20f751ef32b2f3a4\"}\n  - https://angular.io/latest: {\"latest\":\"5c95f89a85255a6fefb4045a20f751ef32b2f3a4\"}\n\nCache: ngsw:/:5c95f89a85255a6fefb4045a20f751ef32b2f3a4:assets:app-shell:cache (24 entries)\n  - https://angular.io/0-es2015.867022f8bb092ae1efb1.worker.js\n  - https://angular.io/announcement-bar-announcement-bar-module-es2015.1b5b762c9c8837c770f8.js\n  - https://angular.io/api-api-list-module-es2015.40a43cd22f50f64d63bb.js\n  ...\n\nCache: ngsw:/:db:ngsw:/:5c95f89a85255a6fefb4045a20f751ef32b2f3a4:assets:app-shell:meta (1 entries)\n  - https://angular.io/https://fonts.gstatic.com/s/robotomono/v13/L0x5DF4xlVMF-BfR8bXMIjhLq3-cXbKD.woff2:\n      {\"ts\":1615031956601,\"used\":true}\n\nIf you see this error, please report an issue at https://github.com/angular/angular/issues/new?template=3-docs-bug.md\nincluding the above logs.\n```\n\nNOTE:\nThis change increases the main bundle by 1649B (0.37%), but it can be\nreverted as soon as we gather enough info to diagnose the issue.\n\n[1]: https://angular.io/api/service-worker/SwUpdate#unrecoverable\n[2]: https://github.com/angular/angular/blob/c676ec1ce5d586d4bc46/aio/src/app/sw-updates/sw-updates.service.ts#L55-L61\n\nPR Close #41106",
    "sha": "f281310d39b7ae662c01a4332b4fae9fc1065fa7",
    "files": [
        {
            "sha": "26c0528a843a17b393be620cf6e3f528c084f29f",
            "filename": "aio/src/app/layout/doc-viewer/doc-viewer.component.ts",
            "status": "modified",
            "additions": 69,
            "deletions": 1,
            "changes": 70,
            "blob_url": "https://github.com/angular/angular/blob/f281310d39b7ae662c01a4332b4fae9fc1065fa7/aio%2Fsrc%2Fapp%2Flayout%2Fdoc-viewer%2Fdoc-viewer.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/f281310d39b7ae662c01a4332b4fae9fc1065fa7/aio%2Fsrc%2Fapp%2Flayout%2Fdoc-viewer%2Fdoc-viewer.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Flayout%2Fdoc-viewer%2Fdoc-viewer.component.ts?ref=f281310d39b7ae662c01a4332b4fae9fc1065fa7",
            "patch": "@@ -143,10 +143,18 @@ export class DocViewerComponent implements OnDestroy {\n         switchMap(() => this.swapViews(addTitleAndToc)),\n         tap(() => this.docRendered.emit()),\n         catchError(err => {\n-          const errorMessage = (err instanceof Error) ? err.stack : err;\n+          const errorMessage = `${(err instanceof Error) ? err.stack : err}`;\n           this.logger.error(new Error(`[DocViewer] Error preparing document '${doc.id}': ${errorMessage}`));\n           this.nextViewContainer.innerHTML = '';\n           this.setNoIndex(true);\n+\n+          // TODO(gkalpak): Remove this once gathering debug info is no longer needed.\n+          if (/loading chunk \\d+ failed/i.test(errorMessage)) {\n+            // Print some info to help with debugging.\n+            // (There is no reason to wait for this async call to complete before continuing.)\n+            printSwDebugInfo();\n+          }\n+\n           return this.void$;\n         }),\n     );\n@@ -244,3 +252,63 @@ export class DocViewerComponent implements OnDestroy {\n     );\n   }\n }\n+\n+// Helpers\n+/**\n+ * Print some info regarding the ServiceWorker and the caches contents to help debugging potential\n+ * issues with failing to find resources in the cache.\n+ * (See https://github.com/angular/angular/issues/28114.)\n+ */\n+async function printSwDebugInfo(): Promise<void> {\n+  console.log(`\\nServiceWorker: ${navigator.serviceWorker?.controller?.state ?? 'N/A'}`);\n+\n+  if (typeof caches === 'undefined') {\n+    console.log('\\nCaches: N/A');\n+  } else {\n+    const allCacheNames = await caches.keys();\n+    const swCacheNames = allCacheNames.filter(name => name.startsWith('ngsw:/:'));\n+\n+    await findCachesAndPrintEntries(swCacheNames, 'db:control', true, ['manifests']);\n+    await findCachesAndPrintEntries(swCacheNames, 'assets:app-shell:cache', false);\n+    await findCachesAndPrintEntries(swCacheNames, 'assets:app-shell:meta', true);\n+  }\n+\n+  console.warn(\n+      '\\nIf you see this error, please report an issue at ' +\n+      'https://github.com/angular/angular/issues/new?template=3-docs-bug.md including the above logs.');\n+\n+  // Internal helpers\n+  async function findCachesAndPrintEntries(\n+      swCacheNames: string[], nameSuffix: string, includeValues: boolean,\n+      ignoredKeys: string[] = []): Promise<void> {\n+    const cacheNames = swCacheNames.filter(name => name.endsWith(nameSuffix));\n+\n+    for (const cacheName of cacheNames) {\n+      const cacheEntries = await getCacheEntries(cacheName, includeValues, ignoredKeys);\n+      await printCacheEntries(cacheName, cacheEntries);\n+    }\n+  }\n+\n+  async function getCacheEntries(\n+      name: string, includeValues: boolean,\n+      ignoredKeys: string[] = []): Promise<{key: string, value?: object}[]> {\n+    const ignoredUrls = new Set(ignoredKeys.map(key => new Request(key).url));\n+\n+    const cache = await caches.open(name);\n+    const keys = (await cache.keys()).map(req => req.url).filter(url => !ignoredUrls.has(url));\n+    const entries = await Promise.all(keys.map(async key => ({\n+      key,\n+      value: !includeValues ? undefined : await (await cache.match(key))?.json(),\n+    })));\n+\n+    return entries;\n+  }\n+\n+  function printCacheEntries(name: string, entries: {key: string, value?: object}[]): void {\n+    const entriesStr = entries\n+        .map(({key, value}) => `  - ${key}${!value ? '' : `: ${JSON.stringify(value)}`}`)\n+        .join('\\n');\n+\n+    console.log(`\\nCache: ${name} (${entries.length} entries)\\n${entriesStr}`);\n+  }\n+}"
        },
        {
            "sha": "18cd9550d23d67ddad9fb626e6ef089054be7ae1",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/f281310d39b7ae662c01a4332b4fae9fc1065fa7/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/f281310d39b7ae662c01a4332b4fae9fc1065fa7/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=f281310d39b7ae662c01a4332b4fae9fc1065fa7",
            "patch": "@@ -3,7 +3,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3033,\n-        \"main-es2015\": 449310,\n+        \"main-es2015\": 450953,\n         \"polyfills-es2015\": 52343\n       }\n     }\n@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3033,\n-        \"main-es2015\": 449759,\n+        \"main-es2015\": 451402,\n         \"polyfills-es2015\": 52493\n       }\n     }\n@@ -21,9 +21,9 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3153,\n-        \"main-es2015\": 435362,\n+        \"main-es2015\": 437005,\n         \"polyfills-es2015\": 52493\n       }\n     }\n   }\n-}\n\\ No newline at end of file\n+}"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 73,
        "deletions": 5
    }
}