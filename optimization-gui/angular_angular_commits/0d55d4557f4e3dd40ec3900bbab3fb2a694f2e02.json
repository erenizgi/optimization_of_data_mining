{
    "author": "martinsik",
    "message": "test(router): add Router regression test for hash location strategy (#40409)\n\nThis situation can probably happen only when using\n`HashLocationStrategy` and by manually changing hash that triggers a route\nguard that returns a new `UrlTree`. Then hash in the browser might not\nmatch the current route because navigation was canceled, while hash in\nthe URL remained set by the user.\n\nRelated to #37048\n\nPR Close #40409",
    "sha": "0d55d4557f4e3dd40ec3900bbab3fb2a694f2e02",
    "files": [
        {
            "sha": "371431b9e9582eb1b1c1425a4b6206df84aa5c5c",
            "filename": "packages/router/test/regression_integration.spec.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 1,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/0d55d4557f4e3dd40ec3900bbab3fb2a694f2e02/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0d55d4557f4e3dd40ec3900bbab3fb2a694f2e02/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts?ref=0d55d4557f4e3dd40ec3900bbab3fb2a694f2e02",
            "patch": "@@ -6,7 +6,8 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {CommonModule} from '@angular/common';\n+import {CommonModule, Location} from '@angular/common';\n+import {SpyLocation} from '@angular/common/testing';\n import {ChangeDetectionStrategy, ChangeDetectorRef, Component, NgModule, TemplateRef, Type, ViewChild, ViewContainerRef} from '@angular/core';\n import {ComponentFixture, fakeAsync, TestBed, tick} from '@angular/core/testing';\n import {Router} from '@angular/router';\n@@ -227,6 +228,54 @@ describe('Integration', () => {\n        expect(fixture.nativeElement.innerHTML).toContain('router-outlet');\n        expect(fixture.nativeElement.innerHTML).not.toContain('simple');\n      }));\n+\n+  describe('useHash', () => {\n+    it('should restore hash to match current route - #28561', fakeAsync(() => {\n+         @Component({selector: 'root-cmp', template: `<router-outlet></router-outlet>`})\n+         class RootCmp {\n+         }\n+\n+         @Component({template: 'simple'})\n+         class SimpleCmp {\n+         }\n+\n+         TestBed.configureTestingModule({\n+           imports: [RouterTestingModule.withRoutes([\n+             {path: '', component: SimpleCmp},\n+             {path: 'one', component: SimpleCmp, canActivate: ['returnRootUrlTree']}\n+           ])],\n+           declarations: [SimpleCmp, RootCmp],\n+           providers: [\n+             {\n+               provide: 'returnRootUrlTree',\n+               useFactory: (router: Router) => () => {\n+                 return router.parseUrl('/');\n+               },\n+               deps: [Router]\n+             },\n+           ],\n+         });\n+\n+         const router = TestBed.inject(Router);\n+         const location = TestBed.inject(Location) as SpyLocation;\n+\n+         router.navigateByUrl('/');\n+         // Will setup location change listeners\n+         const fixture = createRoot(router, RootCmp);\n+\n+         location.simulateHashChange('/one');\n+         advance(fixture);\n+\n+         const BASE_ERROR_MESSAGE =\n+             'This asserts current behavior, which is incorrect. When #28561 is fixed, it should be: ';\n+\n+         expect(location.path()).toEqual('/one', BASE_ERROR_MESSAGE + '/');\n+         const urlChanges = ['replace: /', 'hash: /one'];\n+         expect(location.urlChanges)\n+             .toEqual(\n+                 urlChanges, BASE_ERROR_MESSAGE + JSON.stringify(urlChanges.concat('replace: /')));\n+       }));\n+  });\n });\n \n function advance<T>(fixture: ComponentFixture<T>): void {"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 50,
        "deletions": 1
    }
}