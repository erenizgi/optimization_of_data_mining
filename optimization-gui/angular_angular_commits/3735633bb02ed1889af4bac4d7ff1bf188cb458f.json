{
    "author": "AndrewKushnir",
    "message": "fix(core): take @Host into account while processing `useFactory` arguments (#40122)\n\nDI providers can be defined via `useFactory` function, which may have arguments configured via `deps` array.\nThe `deps` array may contain DI flags represented by DI decorators (such as `@Self`, `@SkipSelf`, etc). Prior to this\ncommit, having the `@Host` decorator in `deps` array resulted in runtime error in Ivy. The problem was that the `@Host`\ndecorator was not taken into account while `useFactory` argument list was constructed, the `@Host` decorator was\ntreated as a token that should be looked up.\n\nThis commit updates the logic which prepares `useFactory` arguments to recognize the `@Host` decorator.\n\nPR Close #40122",
    "sha": "3735633bb02ed1889af4bac4d7ff1bf188cb458f",
    "files": [
        {
            "sha": "4cd45a5f521f7c95af56bee054c6f3b2373bad6a",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/3735633bb02ed1889af4bac4d7ff1bf188cb458f/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/3735633bb02ed1889af4bac4d7ff1bf188cb458f/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=3735633bb02ed1889af4bac4d7ff1bf188cb458f",
            "patch": "@@ -3,7 +3,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 1485,\n-        \"main-es2015\": 140333,\n+        \"main-es2015\": 140871,\n         \"polyfills-es2015\": 36964\n       }\n     }"
        },
        {
            "sha": "3332f92dfec33ddf47ee09ebd30f6fd3bc396e74",
            "filename": "packages/core/src/di/injector_compatibility.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/3735633bb02ed1889af4bac4d7ff1bf188cb458f/packages%2Fcore%2Fsrc%2Fdi%2Finjector_compatibility.ts",
            "raw_url": "https://github.com/angular/angular/raw/3735633bb02ed1889af4bac4d7ff1bf188cb458f/packages%2Fcore%2Fsrc%2Fdi%2Finjector_compatibility.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fdi%2Finjector_compatibility.ts?ref=3735633bb02ed1889af4bac4d7ff1bf188cb458f",
            "patch": "@@ -11,13 +11,14 @@ import '../util/ng_dev_mode';\n import {AbstractType, Type} from '../interface/type';\n import {getClosureSafeProperty} from '../util/property';\n import {stringify} from '../util/stringify';\n+\n import {resolveForwardRef} from './forward_ref';\n import {getInjectImplementation, injectRootLimpMode} from './inject_switch';\n import {InjectionToken} from './injection_token';\n import {Injector} from './injector';\n import {InjectFlags} from './interface/injector';\n import {ValueProvider} from './interface/provider';\n-import {Inject, Optional, Self, SkipSelf} from './metadata';\n+import {Host, Inject, Optional, Self, SkipSelf} from './metadata';\n \n \n const _THROW_IF_NOT_FOUND = {};\n@@ -151,6 +152,8 @@ export function injectArgs(types: (Type<any>|InjectionToken<any>|any[])[]): any[\n           flags |= InjectFlags.SkipSelf;\n         } else if (meta instanceof Self || meta.ngMetadataName === 'Self' || meta === Self) {\n           flags |= InjectFlags.Self;\n+        } else if (meta instanceof Host || meta.ngMetadataName === 'Host' || meta === Host) {\n+          flags |= InjectFlags.Host;\n         } else if (meta instanceof Inject || meta === Inject) {\n           type = meta.token;\n         } else {"
        },
        {
            "sha": "768a5621c133a9c56ab2de68734b132939350a0b",
            "filename": "packages/core/test/acceptance/di_spec.ts",
            "status": "modified",
            "additions": 100,
            "deletions": 0,
            "changes": 100,
            "blob_url": "https://github.com/angular/angular/blob/3735633bb02ed1889af4bac4d7ff1bf188cb458f/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3735633bb02ed1889af4bac4d7ff1bf188cb458f/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts?ref=3735633bb02ed1889af4bac4d7ff1bf188cb458f",
            "patch": "@@ -2803,6 +2803,106 @@ describe('di', () => {\n     });\n   });\n \n+  it('should be able to use Host in `useFactory` dependency config', () => {\n+    // Scenario:\n+    // ---------\n+    // <root (provides token A)>\n+    //   <comp (provides token B via useFactory(@Host() @Inject(A))></comp>\n+    // </root>\n+    @Component({\n+      selector: 'root',\n+      template: '<comp></comp>',\n+      viewProviders: [{\n+        provide: 'A',\n+        useValue: 'A from Root',\n+      }]\n+    })\n+    class Root {\n+    }\n+\n+    @Component({\n+      selector: 'comp',\n+      template: '{{ token }}',\n+      viewProviders: [{\n+        provide: 'B',\n+        deps: [[new Inject('A'), new Host()]],\n+        useFactory: (token: string) => `${token} (processed by useFactory)`,\n+      }]\n+    })\n+    class Comp {\n+      constructor(@Inject('B') readonly token: string) {}\n+    }\n+\n+    @Component({\n+      template: `<root></root>`,\n+    })\n+    class App {\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [Root, Comp, App]});\n+\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+\n+    expect(fixture.nativeElement.textContent).toBe('A from Root (processed by useFactory)');\n+  });\n+\n+  it('should not lookup outside of the host element when Host is used in `useFactory`', () => {\n+    // Scenario:\n+    // ---------\n+    // <root (provides token A)>\n+    //   <intermediate>\n+    //     <comp (provides token B via useFactory(@Host() @Inject(A))></comp>\n+    //   </intermediate>\n+    // </root>\n+    @Component({\n+      selector: 'root',\n+      template: '<intermediate></intermediate>',\n+      viewProviders: [{\n+        provide: 'A',\n+        useValue: 'A from Root',\n+      }]\n+    })\n+    class Root {\n+    }\n+\n+    @Component({\n+      selector: 'intermediate',\n+      template: '<comp></comp>',\n+    })\n+    class Intermediate {\n+    }\n+\n+    @Component({\n+      selector: 'comp',\n+      template: '{{ token }}',\n+      viewProviders: [{\n+        provide: 'B',\n+        deps: [[new Inject('A'), new Host(), new Optional()]],\n+        useFactory: (token: string) =>\n+            token ? `${token} (processed by useFactory)` : 'No token A found',\n+      }]\n+    })\n+    class Comp {\n+      constructor(@Inject('B') readonly token: string) {}\n+    }\n+\n+    @Component({\n+      template: `<root></root>`,\n+    })\n+    class App {\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [Root, Comp, App, Intermediate]});\n+\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+\n+    // Making sure that the `@Host` takes effect and token `A` becomes unavailable in DI since it's\n+    // defined one level up from the Comp's host view.\n+    expect(fixture.nativeElement.textContent).toBe('No token A found');\n+  });\n+\n   it('should not cause cyclic dependency if same token is requested in deps with @SkipSelf', () => {\n     @Component({\n       selector: 'my-comp',"
        },
        {
            "sha": "822538400b0afcf29a3aba4aa8525660f9f3b773",
            "filename": "packages/core/test/bundling/forms/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/3735633bb02ed1889af4bac4d7ff1bf188cb458f/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/3735633bb02ed1889af4bac4d7ff1bf188cb458f/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json?ref=3735633bb02ed1889af4bac4d7ff1bf188cb458f",
            "patch": "@@ -236,6 +236,9 @@\n   {\n     \"name\": \"FormsModule\"\n   },\n+  {\n+    \"name\": \"Host\"\n+  },\n   {\n     \"name\": \"INJECTOR\"\n   },"
        },
        {
            "sha": "45532497ed82b457dd2687df0fd3aea9e1220989",
            "filename": "packages/core/test/bundling/injection/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/3735633bb02ed1889af4bac4d7ff1bf188cb458f/packages%2Fcore%2Ftest%2Fbundling%2Finjection%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/3735633bb02ed1889af4bac4d7ff1bf188cb458f/packages%2Fcore%2Ftest%2Fbundling%2Finjection%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Finjection%2Fbundle.golden_symbols.json?ref=3735633bb02ed1889af4bac4d7ff1bf188cb458f",
            "patch": "@@ -5,6 +5,9 @@\n   {\n     \"name\": \"EMPTY_ARRAY\"\n   },\n+  {\n+    \"name\": \"Host\"\n+  },\n   {\n     \"name\": \"INJECTOR\"\n   },"
        },
        {
            "sha": "fb04c8493f4df1e9008418c0fd6774653e5f8351",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/3735633bb02ed1889af4bac4d7ff1bf188cb458f/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/3735633bb02ed1889af4bac4d7ff1bf188cb458f/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=3735633bb02ed1889af4bac4d7ff1bf188cb458f",
            "patch": "@@ -290,6 +290,9 @@\n   {\n     \"name\": \"HashLocationStrategy\"\n   },\n+  {\n+    \"name\": \"Host\"\n+  },\n   {\n     \"name\": \"INITIAL_VALUE\"\n   },"
        }
    ],
    "stats": {
        "total": 116,
        "additions": 114,
        "deletions": 2
    }
}