{
    "author": "mhevery",
    "message": "fix(core): Support extending differs from root `NgModule` (#39981)\n\nDiffers tries to inject parent differ in order to support extending.\nThis does not work in the 'root' injector as the provider overrides the\ndefault injector. The fix is to just assume standard set of providers\nand extend those instead.\n\nPR close #25015\nIssue close #11309 `Can't extend IterableDiffers`\nIssue close #18554 `IterableDiffers.extend is not AOT compatible`\n  (This is fixed because we no longer have an arrow function in the\n  factory but a proper function which can be imported.)\n\nPR Close #39981",
    "sha": "5fc45082cae33e8ce95d95560ba67e6388d07732",
    "files": [
        {
            "sha": "1538d4b8f8c691cdb588c63c5bfea4094208bfe0",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/5fc45082cae33e8ce95d95560ba67e6388d07732/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/5fc45082cae33e8ce95d95560ba67e6388d07732/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=5fc45082cae33e8ce95d95560ba67e6388d07732",
            "patch": "@@ -21,7 +21,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3153,\n-        \"main-es2015\": 431696,\n+        \"main-es2015\": 431137,\n         \"polyfills-es2015\": 52493\n       }\n     }"
        },
        {
            "sha": "9d14be1e8b051e0b3c7813c4549c77013dff7b0e",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/5fc45082cae33e8ce95d95560ba67e6388d07732/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/5fc45082cae33e8ce95d95560ba67e6388d07732/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=5fc45082cae33e8ce95d95560ba67e6388d07732",
            "patch": "@@ -3,7 +3,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 1485,\n-        \"main-es2015\": 140921,\n+        \"main-es2015\": 140333,\n         \"polyfills-es2015\": 36964\n       }\n     }"
        },
        {
            "sha": "69c2d80fb60383bc4b4d21d97cd46aa8b53c69fd",
            "filename": "packages/core/src/change_detection/differs/iterable_differs.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 13,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fiterable_differs.ts",
            "raw_url": "https://github.com/angular/angular/raw/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fiterable_differs.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fiterable_differs.ts?ref=5fc45082cae33e8ce95d95560ba67e6388d07732",
            "patch": "@@ -134,18 +134,19 @@ export interface IterableDifferFactory {\n   create<V>(trackByFn?: TrackByFunction<V>): IterableDiffer<V>;\n }\n \n+export function defaultIterableDiffersFactory() {\n+  return new IterableDiffers([new DefaultIterableDifferFactory()]);\n+}\n+\n /**\n  * A repository of different iterable diffing strategies used by NgFor, NgClass, and others.\n  *\n  * @publicApi\n  */\n export class IterableDiffers {\n   /** @nocollapse */\n-  static ɵprov = ɵɵdefineInjectable({\n-    token: IterableDiffers,\n-    providedIn: 'root',\n-    factory: () => new IterableDiffers([new DefaultIterableDifferFactory()])\n-  });\n+  static ɵprov = ɵɵdefineInjectable(\n+      {token: IterableDiffers, providedIn: 'root', factory: defaultIterableDiffersFactory});\n \n   /**\n    * @deprecated v4.0.0 - Should be private\n@@ -187,14 +188,11 @@ export class IterableDiffers {\n   static extend(factories: IterableDifferFactory[]): StaticProvider {\n     return {\n       provide: IterableDiffers,\n-      useFactory: (parent: IterableDiffers) => {\n-        if (!parent) {\n-          // Typically would occur when calling IterableDiffers.extend inside of dependencies passed\n-          // to\n-          // bootstrap(), which would override default pipes instead of extending them.\n-          throw new Error('Cannot extend IterableDiffers without a parent injector');\n-        }\n-        return IterableDiffers.create(factories, parent);\n+      useFactory: (parent: IterableDiffers|null) => {\n+        // if parent is null, it means that we are in the root injector and we have just overridden\n+        // the default injection mechanism for IterableDiffers, in such a case just assume\n+        // `defaultIterableDiffersFactory`.\n+        return IterableDiffers.create(factories, parent || defaultIterableDiffersFactory());\n       },\n       // Dependency technically isn't optional, but we can provide a better error message this way.\n       deps: [[IterableDiffers, new SkipSelf(), new Optional()]]"
        },
        {
            "sha": "ac31aa0aabfb323472d6e02348c567e8c8aac348",
            "filename": "packages/core/src/change_detection/differs/keyvalue_differs.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 11,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fkeyvalue_differs.ts",
            "raw_url": "https://github.com/angular/angular/raw/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fkeyvalue_differs.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fkeyvalue_differs.ts?ref=5fc45082cae33e8ce95d95560ba67e6388d07732",
            "patch": "@@ -111,18 +111,19 @@ export interface KeyValueDifferFactory {\n   create<K, V>(): KeyValueDiffer<K, V>;\n }\n \n+export function defaultKeyValueDiffersFactory() {\n+  return new KeyValueDiffers([new DefaultKeyValueDifferFactory()]);\n+}\n+\n /**\n  * A repository of different Map diffing strategies used by NgClass, NgStyle, and others.\n  *\n  * @publicApi\n  */\n export class KeyValueDiffers {\n   /** @nocollapse */\n-  static ɵprov = ɵɵdefineInjectable({\n-    token: KeyValueDiffers,\n-    providedIn: 'root',\n-    factory: () => new KeyValueDiffers([new DefaultKeyValueDifferFactory()])\n-  });\n+  static ɵprov = ɵɵdefineInjectable(\n+      {token: KeyValueDiffers, providedIn: 'root', factory: defaultKeyValueDiffersFactory});\n \n   /**\n    * @deprecated v4.0.0 - Should be private.\n@@ -165,12 +166,10 @@ export class KeyValueDiffers {\n     return {\n       provide: KeyValueDiffers,\n       useFactory: (parent: KeyValueDiffers) => {\n-        if (!parent) {\n-          // Typically would occur when calling KeyValueDiffers.extend inside of dependencies passed\n-          // to bootstrap(), which would override default pipes instead of extending them.\n-          throw new Error('Cannot extend KeyValueDiffers without a parent injector');\n-        }\n-        return KeyValueDiffers.create(factories, parent);\n+        // if parent is null, it means that we are in the root injector and we have just overridden\n+        // the default injection mechanism for KeyValueDiffers, in such a case just assume\n+        // `defaultKeyValueDiffersFactory`.\n+        return KeyValueDiffers.create(factories, parent || defaultKeyValueDiffersFactory());\n       },\n       // Dependency technically isn't optional, but we can provide a better error message this way.\n       deps: [[KeyValueDiffers, new SkipSelf(), new Optional()]]"
        },
        {
            "sha": "bf44a9ff83edb12d882ef196e94f9d8fa017fd2a",
            "filename": "packages/core/test/bundling/forms/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json?ref=5fc45082cae33e8ce95d95560ba67e6388d07732",
            "patch": "@@ -854,9 +854,15 @@\n   {\n     \"name\": \"defaultIterableDiffers\"\n   },\n+  {\n+    \"name\": \"defaultIterableDiffersFactory\"\n+  },\n   {\n     \"name\": \"defaultKeyValueDiffers\"\n   },\n+  {\n+    \"name\": \"defaultKeyValueDiffersFactory\"\n+  },\n   {\n     \"name\": \"defaultScheduler\"\n   },"
        },
        {
            "sha": "a6c8ad6d1330e683c58cf6b19387c5ae8994d255",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=5fc45082cae33e8ce95d95560ba67e6388d07732",
            "patch": "@@ -1121,9 +1121,15 @@\n   {\n     \"name\": \"defaultIterableDiffers\"\n   },\n+  {\n+    \"name\": \"defaultIterableDiffersFactory\"\n+  },\n   {\n     \"name\": \"defaultKeyValueDiffers\"\n   },\n+  {\n+    \"name\": \"defaultKeyValueDiffersFactory\"\n+  },\n   {\n     \"name\": \"defaultMalformedUriErrorHandler\"\n   },"
        },
        {
            "sha": "839e1f4e85319eab79ce662461729a3db5136728",
            "filename": "packages/core/test/bundling/todo/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json?ref=5fc45082cae33e8ce95d95560ba67e6388d07732",
            "patch": "@@ -281,6 +281,9 @@\n   {\n     \"name\": \"defaultErrorLogger\"\n   },\n+  {\n+    \"name\": \"defaultIterableDiffersFactory\"\n+  },\n   {\n     \"name\": \"defaultScheduler\"\n   },"
        },
        {
            "sha": "19cdd0e691d3d8403338301fc2edc9600c64d692",
            "filename": "packages/core/test/change_detection/differs/iterable_differs_spec.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 9,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Ftest%2Fchange_detection%2Fdiffers%2Fiterable_differs_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Ftest%2Fchange_detection%2Fdiffers%2Fiterable_differs_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fchange_detection%2Fdiffers%2Fiterable_differs_spec.ts?ref=5fc45082cae33e8ce95d95560ba67e6388d07732",
            "patch": "@@ -6,8 +6,8 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Injector} from '@angular/core';\n-import {IterableDiffers} from '@angular/core/src/change_detection/differs/iterable_differs';\n+import {Injector, IterableDiffer, IterableDifferFactory, IterableDiffers, NgModule, TrackByFunction} from '@angular/core';\n+import {TestBed} from '@angular/core/testing';\n \n import {SpyIterableDifferFactory} from '../../spies';\n \n@@ -49,13 +49,6 @@ import {SpyIterableDifferFactory} from '../../spies';\n     });\n \n     describe('.extend()', () => {\n-      it('should throw if calling extend when creating root injector', () => {\n-        const injector = Injector.create([IterableDiffers.extend([])]);\n-\n-        expect(() => injector.get(IterableDiffers))\n-            .toThrowError(/Cannot extend IterableDiffers without a parent injector/);\n-      });\n-\n       it('should extend di-inherited differs', () => {\n         const parent = new IterableDiffers([factory1]);\n         const injector = Injector.create([{provide: IterableDiffers, useValue: parent}]);\n@@ -66,6 +59,32 @@ import {SpyIterableDifferFactory} from '../../spies';\n           factory2, factory1\n         ]);\n       });\n+\n+      it('should support .extend in root NgModule', () => {\n+        const DIFFER: IterableDiffer<any> = {} as any;\n+        const log: string[] = [];\n+        class MyIterableDifferFactory implements IterableDifferFactory {\n+          supports(objects: any): boolean {\n+            log.push('supports', objects);\n+            return true;\n+          }\n+          create<V>(trackByFn?: TrackByFunction<V>): IterableDiffer<V> {\n+            log.push('create');\n+            return DIFFER;\n+          }\n+        }\n+\n+\n+        @NgModule({providers: [IterableDiffers.extend([new MyIterableDifferFactory()])]})\n+        class MyModule {\n+        }\n+\n+        TestBed.configureTestingModule({imports: [MyModule]});\n+        const differs = TestBed.inject(IterableDiffers);\n+        const differ = differs.find('VALUE').create(null!);\n+        expect(differ).toEqual(DIFFER);\n+        expect(log).toEqual(['supports', 'VALUE', 'create']);\n+      });\n     });\n   });\n }"
        },
        {
            "sha": "4e96b3ad0e7ad62ba96f78572eb0bed098bec7eb",
            "filename": "packages/core/test/change_detection/differs/keyvalue_differs_spec.ts",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/angular/angular/blob/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Ftest%2Fchange_detection%2Fdiffers%2Fkeyvalue_differs_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5fc45082cae33e8ce95d95560ba67e6388d07732/packages%2Fcore%2Ftest%2Fchange_detection%2Fdiffers%2Fkeyvalue_differs_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fchange_detection%2Fdiffers%2Fkeyvalue_differs_spec.ts?ref=5fc45082cae33e8ce95d95560ba67e6388d07732",
            "patch": "@@ -0,0 +1,39 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {KeyValueDiffer, KeyValueDifferFactory, KeyValueDiffers, NgModule} from '@angular/core';\n+import {TestBed} from '@angular/core/testing';\n+\n+\n+describe('KeyValueDiffers', function() {\n+  it('should support .extend in root NgModule', () => {\n+    const DIFFER: KeyValueDiffer<any, any> = {} as any;\n+    const log: string[] = [];\n+    class MyKeyValueDifferFactory implements KeyValueDifferFactory {\n+      supports(objects: any): boolean {\n+        log.push('supports', objects);\n+        return true;\n+      }\n+      create<K, V>(): KeyValueDiffer<K, V> {\n+        log.push('create');\n+        return DIFFER;\n+      }\n+    }\n+\n+\n+    @NgModule({providers: [KeyValueDiffers.extend([new MyKeyValueDifferFactory()])]})\n+    class MyModule {\n+    }\n+\n+    TestBed.configureTestingModule({imports: [MyModule]});\n+    const differs = TestBed.inject(KeyValueDiffers);\n+    const differ = differs.find('VALUE').create();\n+    expect(differ).toEqual(DIFFER);\n+    expect(log).toEqual(['supports', 'VALUE', 'create']);\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 140,
        "additions": 105,
        "deletions": 35
    }
}