{
    "author": "josephperrott",
    "message": "fix(dev-infra): ensure that building environment stamp fails silently (#42985)\n\nPreviously when a failure occurred in part of building the environment stamp, the entire\nprocess errored.  This should instead fail silently providing no value for the stamp.\n\nPR Close #42985",
    "sha": "2a0e28cf61767c9e61d3d9f9290efaf4a996cfb8",
    "files": [
        {
            "sha": "72f96de2b6a9cf7661424e2bbdb7a5681b3f8988",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 52,
            "deletions": 25,
            "changes": 77,
            "blob_url": "https://github.com/angular/angular/blob/2a0e28cf61767c9e61d3d9f9290efaf4a996cfb8/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/2a0e28cf61767c9e61d3d9f9290efaf4a996cfb8/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=2a0e28cf61767c9e61d3d9f9290efaf4a996cfb8",
            "patch": "@@ -7746,8 +7746,13 @@ function buildEnvStamp(mode) {\n }\n /** Whether the repo has local changes. */\n function hasLocalChanges() {\n-    const git = GitClient.get();\n-    return git.hasUncommittedChanges();\n+    try {\n+        const git = GitClient.get();\n+        return git.hasUncommittedChanges();\n+    }\n+    catch (_a) {\n+        return true;\n+    }\n }\n /**\n  * Get the versions for generated packages.\n@@ -7756,41 +7761,63 @@ function hasLocalChanges() {\n  * In release mode, the version is based on the base package.json version.\n  */\n function getSCMVersions(mode) {\n-    const git = GitClient.get();\n-    if (mode === 'release') {\n-        const packageJsonPath = path.join(git.baseDir, 'package.json');\n-        const { version } = new semver.SemVer(require(packageJsonPath).version);\n-        const { version: experimentalVersion } = createExperimentalSemver(new semver.SemVer(version));\n-        return { version, experimentalVersion };\n-    }\n-    if (mode === 'snapshot') {\n-        const localChanges = hasLocalChanges() ? '.with-local-changes' : '';\n-        const { stdout: rawVersion } = git.run(['describe', '--match', '*[0-9]*.[0-9]*.[0-9]*', '--abbrev=7', '--tags', 'HEAD~100']);\n-        const { version } = new semver.SemVer(rawVersion);\n-        const { version: experimentalVersion } = createExperimentalSemver(version);\n+    try {\n+        const git = GitClient.get();\n+        if (mode === 'snapshot') {\n+            const localChanges = hasLocalChanges() ? '.with-local-changes' : '';\n+            const { stdout: rawVersion } = git.run(['describe', '--match', '*[0-9]*.[0-9]*.[0-9]*', '--abbrev=7', '--tags', 'HEAD~100']);\n+            const { version } = new semver.SemVer(rawVersion);\n+            const { version: experimentalVersion } = createExperimentalSemver(version);\n+            return {\n+                version: `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n+                experimentalVersion: `${experimentalVersion.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n+            };\n+        }\n+        else {\n+            const packageJsonPath = path.join(git.baseDir, 'package.json');\n+            const { version } = new semver.SemVer(require(packageJsonPath).version);\n+            const { version: experimentalVersion } = createExperimentalSemver(new semver.SemVer(version));\n+            return { version, experimentalVersion };\n+        }\n+    }\n+    catch (_a) {\n         return {\n-            version: `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n-            experimentalVersion: `${experimentalVersion.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n+            version: '',\n+            experimentalVersion: '',\n         };\n     }\n-    throw Error('No environment stamp mode was provided.');\n }\n /** Get the current branch or revision of HEAD. */\n function getCurrentBranchOrRevision() {\n-    const git = GitClient.get();\n-    return git.getCurrentBranchOrRevision();\n+    try {\n+        const git = GitClient.get();\n+        return git.getCurrentBranchOrRevision();\n+    }\n+    catch (_a) {\n+        return '';\n+    }\n }\n /** Get the currently checked out branch. */\n function getCurrentBranch() {\n-    const git = GitClient.get();\n-    return git.run(['symbolic-ref', '--short', 'HEAD']).stdout.trim();\n+    try {\n+        const git = GitClient.get();\n+        return git.run(['symbolic-ref', '--short', 'HEAD']).stdout.trim();\n+    }\n+    catch (_a) {\n+        return '';\n+    }\n }\n /** Get the current git user based on the git config. */\n function getCurrentGitUser() {\n-    const git = GitClient.get();\n-    let userName = git.runGraceful(['config', 'user.name']).stdout.trim() || 'Unknown User';\n-    let userEmail = git.runGraceful(['config', 'user.email']).stdout.trim() || 'unknown_email';\n-    return `${userName} <${userEmail}>`;\n+    try {\n+        const git = GitClient.get();\n+        let userName = git.runGraceful(['config', 'user.name']).stdout.trim() || 'Unknown User';\n+        let userEmail = git.runGraceful(['config', 'user.email']).stdout.trim() || 'unknown_email';\n+        return `${userName} <${userEmail}>`;\n+    }\n+    catch (_a) {\n+        return '';\n+    }\n }\n \n /**"
        },
        {
            "sha": "a708e0f1d39656f4cc8c3b7d58bc2fffe1471f76",
            "filename": "dev-infra/release/stamping/env-stamp.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 27,
            "changes": 75,
            "blob_url": "https://github.com/angular/angular/blob/2a0e28cf61767c9e61d3d9f9290efaf4a996cfb8/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts",
            "raw_url": "https://github.com/angular/angular/raw/2a0e28cf61767c9e61d3d9f9290efaf4a996cfb8/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts?ref=2a0e28cf61767c9e61d3d9f9290efaf4a996cfb8",
            "patch": "@@ -37,8 +37,12 @@ export function buildEnvStamp(mode: EnvStampMode) {\n \n /** Whether the repo has local changes. */\n function hasLocalChanges() {\n-  const git = GitClient.get();\n-  return git.hasUncommittedChanges();\n+  try {\n+    const git = GitClient.get();\n+    return git.hasUncommittedChanges();\n+  } catch {\n+    return true;\n+  }\n }\n \n /**\n@@ -48,44 +52,61 @@ function hasLocalChanges() {\n  * In release mode, the version is based on the base package.json version.\n  */\n function getSCMVersions(mode: EnvStampMode): {version: string, experimentalVersion: string} {\n-  const git = GitClient.get();\n-  if (mode === 'release') {\n-    const packageJsonPath = join(git.baseDir, 'package.json');\n-    const {version} = new SemVer(require(packageJsonPath).version);\n-    const {version: experimentalVersion} = createExperimentalSemver(new SemVer(version));\n-    return {version, experimentalVersion};\n-  }\n-  if (mode === 'snapshot') {\n-    const localChanges = hasLocalChanges() ? '.with-local-changes' : '';\n-    const {stdout: rawVersion} = git.run(\n-        ['describe', '--match', '*[0-9]*.[0-9]*.[0-9]*', '--abbrev=7', '--tags', 'HEAD~100']);\n-    const {version} = new SemVer(rawVersion);\n-    const {version: experimentalVersion} = createExperimentalSemver(version);\n+  try {\n+    const git = GitClient.get();\n+    if (mode === 'snapshot') {\n+      const localChanges = hasLocalChanges() ? '.with-local-changes' : '';\n+      const {stdout: rawVersion} = git.run(\n+          ['describe', '--match', '*[0-9]*.[0-9]*.[0-9]*', '--abbrev=7', '--tags', 'HEAD~100']);\n+      const {version} = new SemVer(rawVersion);\n+      const {version: experimentalVersion} = createExperimentalSemver(version);\n+      return {\n+        version: `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n+        experimentalVersion:\n+            `${experimentalVersion.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n+      };\n+    } else {\n+      const packageJsonPath = join(git.baseDir, 'package.json');\n+      const {version} = new SemVer(require(packageJsonPath).version);\n+      const {version: experimentalVersion} = createExperimentalSemver(new SemVer(version));\n+      return {version, experimentalVersion};\n+    }\n+  } catch {\n     return {\n-      version: `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n-      experimentalVersion:\n-          `${experimentalVersion.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n+      version: '',\n+      experimentalVersion: '',\n     };\n   }\n-  throw Error('No environment stamp mode was provided.');\n }\n \n /** Get the current branch or revision of HEAD. */\n function getCurrentBranchOrRevision() {\n-  const git = GitClient.get();\n-  return git.getCurrentBranchOrRevision();\n+  try {\n+    const git = GitClient.get();\n+    return git.getCurrentBranchOrRevision();\n+  } catch {\n+    return '';\n+  }\n }\n \n /** Get the currently checked out branch. */\n function getCurrentBranch() {\n-  const git = GitClient.get();\n-  return git.run(['symbolic-ref', '--short', 'HEAD']).stdout.trim();\n+  try {\n+    const git = GitClient.get();\n+    return git.run(['symbolic-ref', '--short', 'HEAD']).stdout.trim();\n+  } catch {\n+    return '';\n+  }\n }\n \n /** Get the current git user based on the git config. */\n function getCurrentGitUser() {\n-  const git = GitClient.get();\n-  let userName = git.runGraceful(['config', 'user.name']).stdout.trim() || 'Unknown User';\n-  let userEmail = git.runGraceful(['config', 'user.email']).stdout.trim() || 'unknown_email';\n-  return `${userName} <${userEmail}>`;\n+  try {\n+    const git = GitClient.get();\n+    let userName = git.runGraceful(['config', 'user.name']).stdout.trim() || 'Unknown User';\n+    let userEmail = git.runGraceful(['config', 'user.email']).stdout.trim() || 'unknown_email';\n+    return `${userName} <${userEmail}>`;\n+  } catch {\n+    return '';\n+  }\n }"
        }
    ],
    "stats": {
        "total": 152,
        "additions": 100,
        "deletions": 52
    }
}