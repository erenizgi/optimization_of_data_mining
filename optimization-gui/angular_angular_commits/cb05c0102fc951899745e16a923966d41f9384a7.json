{
    "author": "AndrewKushnir",
    "message": "fix(core): move generated i18n statements to the `consts` field of ComponentDef (#38404)\n\nThis commit updates the code to move generated i18n statements into the `consts` field of\nComponentDef to avoid invoking `$localize` function before component initialization (to better\nsupport runtime translations) and also avoid problems with lazy-loading when i18n defs may not\nbe present in a chunk where it's referenced.\n\nPrior to this change the i18n statements were generated at the top leve:\n\n```\nvar I18N_0;\nif (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n    var MSG_X = goog.getMsg(“…”);\n    I18N_0 = MSG_X;\n} else {\n    I18N_0 = $localize('...');\n}\n\ndefineComponent({\n    // ...\n    template: function App_Template(rf, ctx) {\n        i0.ɵɵi18n(2, I18N_0);\n    }\n});\n```\n\nThis commit updates the logic to generate the following code instead:\n\n```\ndefineComponent({\n    // ...\n    consts: function() {\n        var I18N_0;\n        if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n            var MSG_X = goog.getMsg(“…”);\n            I18N_0 = MSG_X;\n        } else {\n            I18N_0 = $localize('...');\n        }\n        return [\n            I18N_0\n        ];\n    },\n    template: function App_Template(rf, ctx) {\n        i0.ɵɵi18n(2, 0);\n    }\n});\n```\n\nAlso note that i18n template instructions now refer to the `consts` array using an index\n(similar to other template instructions).\n\nPR Close #38404",
    "sha": "cb05c0102fc951899745e16a923966d41f9384a7",
    "files": [
        {
            "sha": "a3ed0a3a287560605e9f4291fefab83cdc669fcd",
            "filename": "packages/compiler-cli/test/compliance/r3_view_compiler_i18n_spec.ts",
            "status": "modified",
            "additions": 610,
            "deletions": 350,
            "changes": 960,
            "blob_url": "https://github.com/angular/angular/blob/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fr3_view_compiler_i18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fr3_view_compiler_i18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fr3_view_compiler_i18n_spec.ts?ref=cb05c0102fc951899745e16a923966d41f9384a7",
            "patch": "@@ -182,15 +182,17 @@ const verify = (input: string, output: string, extra: any = {}): void => {\n   }\n };\n \n-// Describes a simple key-value object.\n-type KVList = {\n-  [key: string]: string\n-};\n+// Describes message metadata object.\n+interface Meta {\n+  desc?: string;\n+  meaning?: string;\n+  id?: string;\n+}\n \n // Describes placeholder type used in tests. Note: the type is an array (not an object), since it's\n // important to preserve the order of placeholders (so that we can compare it with generated\n // output).\n-type Placeholder = string[];\n+type Placeholder = [string, string];\n \n // Unique message id index that is needed to avoid different i18n vars with the same name to appear\n // in the i18n block while generating an output string (used to verify compiler-generated code).\n@@ -202,7 +204,7 @@ let msgIndex = 0;\n const quotedValue = (value: string) => value.startsWith('$') ? value : `\"${value}\"`;\n \n // Generates a string that represents expected Closure metadata output.\n-const i18nMsgClosureMeta = (meta?: KVList): string => {\n+const i18nMsgClosureMeta = (meta?: Meta): string => {\n   if (!meta || !(meta.desc || meta.meaning)) return '';\n   return `\n     /**\n@@ -220,7 +222,7 @@ const i18nPlaceholdersToString = (placeholders: Placeholder[]): string => {\n };\n \n // Generates a string that represents expected $localize metadata output.\n-const i18nMsgLocalizeMeta = (meta?: KVList): string => {\n+const i18nMsgLocalizeMeta = (meta?: Meta): string => {\n   if (!meta) return '';\n   let localizeMeta = '';\n   if (meta.meaning) localizeMeta += `${meta.meaning}|`;\n@@ -244,7 +246,7 @@ const i18nMsgInsertLocalizePlaceholders =\n     };\n \n // Generates a string that represents expected i18n block content for simple message.\n-const i18nMsg = (message: string, placeholders: Placeholder[] = [], meta?: KVList) => {\n+const i18nMsg = (message: string, placeholders: Placeholder[] = [], meta?: Meta) => {\n   const varName = `$I18N_${msgIndex++}$`;\n   const closurePlaceholders = i18nPlaceholdersToString(placeholders);\n   const locMessageWithPlaceholders = i18nMsgInsertLocalizePlaceholders(message, placeholders);\n@@ -263,7 +265,7 @@ const i18nMsg = (message: string, placeholders: Placeholder[] = [], meta?: KVLis\n // Generates a string that represents expected i18n block content for a message that requires\n // post-processing (thus includes `ɵɵi18nPostprocess` in generated code).\n const i18nMsgWithPostprocess =\n-    (message: string, placeholders: Placeholder[] = [], meta?: KVList,\n+    (message: string, placeholders: Placeholder[] = [], meta?: Meta,\n      postprocessPlaceholders?: Placeholder[]) => {\n       const varName = `$I18N_${msgIndex}$`;\n       const ppPaceholders =\n@@ -275,10 +277,9 @@ const i18nMsgWithPostprocess =\n     };\n \n // Generates a string that represents expected i18n block content for an ICU.\n-const i18nIcuMsg =\n-    (message: string, placeholders: string[][] = []) => {\n-      return i18nMsgWithPostprocess(message, [], undefined, placeholders);\n-    }\n+const i18nIcuMsg = (message: string, placeholders: Placeholder[] = []) => {\n+  return i18nMsgWithPostprocess(message, [], undefined, placeholders);\n+};\n \n describe('i18n support in the template compiler', () => {\n   describe('element attributes', () => {\n@@ -303,18 +304,18 @@ describe('i18n support in the template compiler', () => {\n \n       // Keeping this block as a raw string, since it checks escaping of special chars.\n       const i18n_6 = String.raw`\n-        var $I18N_23$;\n+        var $i18n_23$;\n         if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n           /**\n            * @desc [BACKUP_$` +\n           String.raw`{MESSAGE}_ID:idH]` +\n           '`' + String.raw`desc\n            */\n           const $MSG_EXTERNAL_idG$$APP_SPEC_TS_24$ = goog.getMsg(\"Title G\");\n-          $I18N_23$ = $MSG_EXTERNAL_idG$$APP_SPEC_TS_24$;\n+          $i18n_23$ = $MSG_EXTERNAL_idG$$APP_SPEC_TS_24$;\n         }\n         else {\n-          $I18N_23$ = $localize \\`:[BACKUP_$\\{MESSAGE}_ID\\:idH]\\\\\\`desc@@idG:Title G\\`;\n+          $i18n_23$ = $localize \\`:[BACKUP_$\\{MESSAGE}_ID\\:idH]\\\\\\`desc@@idG:Title G\\`;\n         }\n       `;\n \n@@ -334,53 +335,58 @@ describe('i18n support in the template compiler', () => {\n       `;\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        const $_c5$ = [\"title\", $i18n_1$];\n-        ${i18n_2}\n-        const $_c9$ = [\"title\", $i18n_2$];\n-        ${i18n_3}\n-        const $_c13$ = [\"title\", $i18n_3$];\n-        ${i18n_4}\n-        const $_c17$ = [\"title\", $i18n_4$];\n-        ${i18n_5}\n-        const $_c21$ = [\"title\", $i18n_5$];\n-        ${i18n_6}\n-        const $_c25$ = [\"title\", $i18n_6$];\n-        ${i18n_7}\n-        …\n-        consts: [[${AttributeMarker.I18n}, \"title\"]],\n+        consts: function () {\n+          ${i18n_0}\n+          ${i18n_1}\n+          ${i18n_2}\n+          ${i18n_3}\n+          ${i18n_4}\n+          ${i18n_5}\n+          ${i18n_6}\n+          ${i18n_7}\n+          return [\n+            $i18n_0$,\n+            [${AttributeMarker.I18n}, \"title\"],\n+            [\"title\", $i18n_1$],\n+            [\"title\", $i18n_2$],\n+            [\"title\", $i18n_3$],\n+            [\"title\", $i18n_4$],\n+            [\"title\", $i18n_5$],\n+            [\"title\", $i18n_6$],\n+            $i18n_7$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n-            $r3$.ɵɵelementStart(2, \"div\", 0);\n-            $r3$.ɵɵi18nAttributes(3, $_c5$);\n+            $r3$.ɵɵelementStart(2, \"div\", 1);\n+            $r3$.ɵɵi18nAttributes(3, 2);\n             $r3$.ɵɵtext(4, \"Content B\");\n             $r3$.ɵɵelementEnd();\n-            $r3$.ɵɵelementStart(5, \"div\", 0);\n-            $r3$.ɵɵi18nAttributes(6, $_c9$);\n+            $r3$.ɵɵelementStart(5, \"div\", 1);\n+            $r3$.ɵɵi18nAttributes(6, 3);\n             $r3$.ɵɵtext(7, \"Content C\");\n             $r3$.ɵɵelementEnd();\n-            $r3$.ɵɵelementStart(8, \"div\", 0);\n-            $r3$.ɵɵi18nAttributes(9, $_c13$);\n+            $r3$.ɵɵelementStart(8, \"div\", 1);\n+            $r3$.ɵɵi18nAttributes(9, 4);\n             $r3$.ɵɵtext(10, \"Content D\");\n             $r3$.ɵɵelementEnd();\n-            $r3$.ɵɵelementStart(11, \"div\", 0);\n-            $r3$.ɵɵi18nAttributes(12, $_c17$);\n+            $r3$.ɵɵelementStart(11, \"div\", 1);\n+            $r3$.ɵɵi18nAttributes(12, 5);\n             $r3$.ɵɵtext(13, \"Content E\");\n             $r3$.ɵɵelementEnd();\n-            $r3$.ɵɵelementStart(14, \"div\", 0);\n-            $r3$.ɵɵi18nAttributes(15, $_c21$);\n+            $r3$.ɵɵelementStart(14, \"div\", 1);\n+            $r3$.ɵɵi18nAttributes(15, 6);\n             $r3$.ɵɵtext(16, \"Content F\");\n             $r3$.ɵɵelementEnd();\n-            $r3$.ɵɵelementStart(17, \"div\", 0);\n-            $r3$.ɵɵi18nAttributes(18, $_c25$);\n+            $r3$.ɵɵelementStart(17, \"div\", 1);\n+            $r3$.ɵɵi18nAttributes(18, 7);\n             $r3$.ɵɵtext(19, \"Content G\");\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementStart(20, \"div\");\n-            $r3$.ɵɵi18n(21, $i18n_7$);\n+            $r3$.ɵɵi18n(21, 8);\n             $r3$.ɵɵelementEnd();\n           }\n         }\n@@ -396,14 +402,17 @@ describe('i18n support in the template compiler', () => {\n \n       const i18n_0 = i18nMsg('Hello');\n       const output = String.raw`\n-        ${i18n_0}\n-        const $_c2$ = [\"title\", $i18n_0$];\n-        …\n-        consts: [[${AttributeMarker.I18n}, \"title\"]],\n+        consts: function () {\n+          ${i18n_0}\n+          return [\n+            [${AttributeMarker.I18n}, \"title\"],\n+            [\"title\", $i18n_0$]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵtemplate(0, MyComponent_ng_template_0_Template, 0, 0, \"ng-template\", 0);\n-            $r3$.ɵɵi18nAttributes(1, $_c2$);\n+            $r3$.ɵɵi18nAttributes(1, 1);\n           }\n         }\n       `;\n@@ -417,9 +426,8 @@ describe('i18n support in the template compiler', () => {\n           `;\n \n          const i18n_0 = i18nMsg('Hello');\n+\n          const output = String.raw`\n-            ${i18n_0}\n-            const $_c2$ = [\"title\", $i18n_0$];\n             function MyComponent_0_ng_template_0_Template(rf, ctx) {\n               if (rf & 1) {\n                 $r3$.ɵɵtext(0, \"Test\");\n@@ -428,11 +436,18 @@ describe('i18n support in the template compiler', () => {\n             function MyComponent_0_Template(rf, ctx) {\n               if (rf & 1) {\n                 $r3$.ɵɵtemplate(0, MyComponent_0_ng_template_0_Template, 1, 0, \"ng-template\", 1);\n-                $r3$.ɵɵi18nAttributes(1, $_c2$);\n+                $r3$.ɵɵi18nAttributes(1, 2);\n               }\n             }\n             …\n-            consts: [[${AttributeMarker.Template}, \"ngIf\"], [${AttributeMarker.I18n}, \"title\"]],\n+            consts: function() {\n+              ${i18n_0}\n+              return [\n+                [${AttributeMarker.Template}, \"ngIf\"],\n+                [${AttributeMarker.I18n}, \"title\"],\n+                [\"title\", $i18n_0$]\n+              ];\n+            },\n             template: function MyComponent_Template(rf, ctx) {\n               if (rf & 1) {\n                 $r3$.ɵɵtemplate(0, MyComponent_0_Template, 2, 0, undefined, 0);\n@@ -454,14 +469,17 @@ describe('i18n support in the template compiler', () => {\n          const i18n_0 =\n              i18nMsg('Hello {$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]]);\n          const output = String.raw`\n-           ${i18n_0}\n-           const $_c2$ = [\"title\", $i18n_0$];\n-           …\n-           consts: [[${AttributeMarker.Bindings}, \"title\"]],\n+           consts: function() {\n+             ${i18n_0}\n+             return [\n+               [${AttributeMarker.Bindings}, \"title\"],\n+               [\"title\", $i18n_0$]\n+             ];\n+           },\n            template: function MyComponent_Template(rf, ctx) {\n              if (rf & 1) {\n                $r3$.ɵɵtemplate(0, MyComponent_ng_template_0_Template, 0, 0, \"ng-template\", 0);\n-               $r3$.ɵɵi18nAttributes(1, $_c2$);\n+               $r3$.ɵɵi18nAttributes(1, 1);\n              }\n              if (rf & 2) {\n                $r3$.ɵɵi18nExp(ctx.name);\n@@ -481,13 +499,10 @@ describe('i18n support in the template compiler', () => {\n          const i18n_0 =\n              i18nMsg('Hello {$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]]);\n          const output = String.raw`\n-            ${i18n_0}\n-            const $_c2$ = [\"title\", $i18n_0$];\n-            …\n             function MyComponent_0_Template(rf, ctx) {\n               if (rf & 1) {\n                 $r3$.ɵɵtemplate(0, MyComponent_0_ng_template_0_Template, 0, 0, \"ng-template\", 1);\n-                $r3$.ɵɵi18nAttributes(1, $_c2$);\n+                $r3$.ɵɵi18nAttributes(1, 2);\n               }\n               if (rf & 2) {\n                 const $ctx_r2$ = $r3$.ɵɵnextContext();\n@@ -496,7 +511,14 @@ describe('i18n support in the template compiler', () => {\n               }\n             }\n             …\n-            consts: [[${AttributeMarker.Template}, \"ngIf\"], [${AttributeMarker.Bindings}, \"title\"]],\n+            consts: function() {\n+              ${i18n_0}\n+              return [\n+                [${AttributeMarker.Template}, \"ngIf\"],\n+                [${AttributeMarker.Bindings}, \"title\"],\n+                [\"title\", $i18n_0$]\n+              ];\n+            },\n             template: function MyComponent_Template(rf, ctx) {\n               if (rf & 1) {\n                 $r3$.ɵɵtemplate(0, MyComponent_0_Template, 2, 1, undefined, 0);\n@@ -536,7 +558,6 @@ describe('i18n support in the template compiler', () => {\n       `;\n \n       const output = `\n-        …\n         consts: [[3, \"title\"]],\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n@@ -558,15 +579,19 @@ describe('i18n support in the template compiler', () => {\n       `;\n \n       const i18n_0 = i18nMsg('introduction', [], {meaning: 'm', desc: 'd'});\n+\n       const output = String.raw`\n-        ${i18n_0}\n-        const $_c1$ = [\"title\", $i18n_0$];\n-        …\n-        consts: [[\"id\", \"static\", ${AttributeMarker.I18n}, \"title\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [\"id\", \"static\", ${AttributeMarker.I18n}, \"title\"],\n+            [\"title\", $i18n_0$]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\", 0);\n-            $r3$.ɵɵi18nAttributes(1, $_c1$);\n+            $r3$.ɵɵi18nAttributes(1, 1);\n             $r3$.ɵɵelementEnd();\n           }\n         }\n@@ -606,35 +631,30 @@ describe('i18n support in the template compiler', () => {\n       const i18n_4 = i18nMsg('{$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        ${i18n_2}\n-        const $_c1$ = [\n-          \"aria-roledescription\", $i18n_0$,\n-          \"title\", $i18n_1$,\n-          \"aria-label\", $i18n_2$\n-        ];\n-        ${i18n_3}\n-        ${i18n_4}\n-        const $_c3$ = [\n-          \"title\", $i18n_3$,\n-          \"aria-roledescription\", $i18n_4$\n-        ];\n-        …\n         decls: 5,\n         vars: 8,\n-        consts: [[\"id\", \"dynamic-1\", ${\n-          AttributeMarker\n-              .I18n}, \"aria-roledescription\", \"title\", \"aria-label\"], [\"id\", \"dynamic-2\", ${\n-          AttributeMarker.I18n}, \"title\", \"aria-roledescription\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          ${i18n_2}\n+          ${i18n_3}\n+          ${i18n_4}\n+          return [\n+            [\"id\", \"dynamic-1\", ${AttributeMarker.I18n}, \"aria-roledescription\",\n+                                                                \"title\", \"aria-label\"],\n+            [\"aria-roledescription\", $i18n_0$, \"title\", $i18n_1$, \"aria-label\", $i18n_2$],\n+            [\"id\", \"dynamic-2\", ${AttributeMarker.I18n}, \"title\", \"aria-roledescription\"],\n+            [\"title\", $i18n_3$, \"aria-roledescription\", $i18n_4$]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\", 0);\n             $r3$.ɵɵpipe(1, \"uppercase\");\n-            $r3$.ɵɵi18nAttributes(2, $_c1$);\n+            $r3$.ɵɵi18nAttributes(2, 1);\n             $r3$.ɵɵelementEnd();\n-            $r3$.ɵɵelementStart(3, \"div\", 1);\n-            $r3$.ɵɵi18nAttributes(4, $_c3$);\n+            $r3$.ɵɵelementStart(3, \"div\", 2);\n+            $r3$.ɵɵi18nAttributes(4, 3);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -658,16 +678,20 @@ describe('i18n support in the template compiler', () => {\n       const i18n_0 = i18nMsg(\n           'intro {$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]],\n           {meaning: 'm', desc: 'd'});\n+\n       const output = String.raw`\n-        ${i18n_0}\n-        const $_c3$ = [\"title\", $i18n_0$];\n-        …\n-        consts: [[${AttributeMarker.I18n}, \"title\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [${AttributeMarker.I18n}, \"title\"],\n+            [\"title\", $i18n_0$]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\", 0);\n             $r3$.ɵɵpipe(1, \"uppercase\");\n-            $r3$.ɵɵi18nAttributes(2, $_c3$);\n+            $r3$.ɵɵi18nAttributes(2, 1);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -691,14 +715,12 @@ describe('i18n support in the template compiler', () => {\n           {meaning: 'm', desc: 'd'});\n \n       const output = String.raw`\n-        ${i18n_0}\n-        const $_c2$ = [\"title\", $i18n_0$];\n         function MyComponent_div_0_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n             $r3$.ɵɵelementStart(1, \"div\", 1);\n             $r3$.ɵɵpipe(2, \"uppercase\");\n-            $r3$.ɵɵi18nAttributes(3, $_c2$);\n+            $r3$.ɵɵi18nAttributes(3, 2);\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementEnd();\n           }\n@@ -712,8 +734,14 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 1,\n         vars: 1,\n-        consts: [[${AttributeMarker.Template}, \"ngFor\", \"ngForOf\"], [${\n-          AttributeMarker.I18n}, \"title\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [${AttributeMarker.Template}, \"ngFor\", \"ngForOf\"],\n+            [${AttributeMarker.I18n}, \"title\"],\n+            [\"title\", $i18n_0$]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵtemplate(0, MyComponent_div_0_Template, 4, 3, \"div\", 0);\n@@ -736,16 +764,19 @@ describe('i18n support in the template compiler', () => {\n           i18nMsg('{$interpolation} title', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        const $_c3$ = [\"title\", $i18n_0$];\n-        …\n         decls: 2,\n         vars: 1,\n-        consts: [[${AttributeMarker.I18n}, \"title\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [${AttributeMarker.I18n}, \"title\"],\n+            [\"title\", $i18n_0$]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\", 0);\n-            $r3$.ɵɵi18nAttributes(1, $_c3$);\n+            $r3$.ɵɵi18nAttributes(1, 1);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -790,35 +821,30 @@ describe('i18n support in the template compiler', () => {\n       const i18n_4 = i18nMsg('{$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        ${i18n_2}\n-        const $_c1$ = [\n-          \"aria-roledescription\", $i18n_0$,\n-          \"title\", $i18n_1$,\n-          \"aria-label\", $i18n_2$\n-        ];\n-        ${i18n_3}\n-        ${i18n_4}\n-        const $_c3$ = [\n-          \"title\", $i18n_3$,\n-          \"aria-roledescription\", $i18n_4$\n-        ];\n-        …\n         decls: 5,\n         vars: 8,\n-        consts: [[\n-          \"id\", \"dynamic-1\",\n-          ${AttributeMarker.I18n}, \"aria-roledescription\", \"title\", \"aria-label\"\n-        ], [\"id\", \"dynamic-2\", ${AttributeMarker.I18n}, \"title\", \"aria-roledescription\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          ${i18n_2}\n+          ${i18n_3}\n+          ${i18n_4}\n+          return [\n+            [\"id\", \"dynamic-1\", ${AttributeMarker.I18n}, \"aria-roledescription\",\n+                                                                \"title\", \"aria-label\"],\n+            [\"aria-roledescription\", $i18n_0$, \"title\", $i18n_1$, \"aria-label\", $i18n_2$],\n+            [\"id\", \"dynamic-2\", ${AttributeMarker.I18n}, \"title\", \"aria-roledescription\"],\n+            [\"title\", $i18n_3$, \"aria-roledescription\", $i18n_4$]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\", 0);\n             $r3$.ɵɵpipe(1, \"uppercase\");\n-            $r3$.ɵɵi18nAttributes(2, $_c1$);\n+            $r3$.ɵɵi18nAttributes(2, 1);\n             $r3$.ɵɵelementEnd();\n-            $r3$.ɵɵelementStart(3, \"div\", 1);\n-            $r3$.ɵɵi18nAttributes(4, $_c3$);\n+            $r3$.ɵɵelementStart(3, \"div\", 2);\n+            $r3$.ɵɵi18nAttributes(4, 3);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -846,14 +872,12 @@ describe('i18n support in the template compiler', () => {\n           {meaning: 'm', desc: 'd'});\n \n       const output = String.raw`\n-        ${i18n_0}\n-        const $_c4$ = [\"title\", $i18n_0$];\n         function MyComponent_div_0_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n             $r3$.ɵɵelementStart(1, \"div\", 1);\n             $r3$.ɵɵpipe(2, \"uppercase\");\n-            $r3$.ɵɵi18nAttributes(3, $_c4$);\n+            $r3$.ɵɵi18nAttributes(3, 2);\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementEnd();\n           }\n@@ -867,8 +891,14 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 1,\n         vars: 1,\n-        consts: [[${AttributeMarker.Template}, \"ngFor\", \"ngForOf\"], [${\n-          AttributeMarker.I18n}, \"title\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [${AttributeMarker.Template}, \"ngFor\", \"ngForOf\"],\n+            [${AttributeMarker.I18n}, \"title\"],\n+            [\"title\", $i18n_0$]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵtemplate(0, MyComponent_div_0_Template, 4, 3, \"div\", 0);\n@@ -891,16 +921,20 @@ describe('i18n support in the template compiler', () => {\n       const i18n_1 = i18nMsg('Some content');\n \n       const output = String.raw`\n-        ${i18n_0}\n-        const $_c1$ = [\"title\", $i18n_0$];\n-        ${i18n_1}\n-        …\n-        consts: [[${AttributeMarker.I18n}, \"title\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          return [\n+            [${AttributeMarker.I18n}, \"title\"],\n+            [\"title\", $i18n_0$],\n+            $i18n_1$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\", 0);\n-            $r3$.ɵɵi18nAttributes(1, $_c1$);\n-            $r3$.ɵɵi18n(2, $i18n_1$);\n+            $r3$.ɵɵi18nAttributes(1, 1);\n+            $r3$.ɵɵi18n(2, 2);\n             $r3$.ɵɵelementEnd();\n           }\n         }\n@@ -925,7 +959,7 @@ describe('i18n support in the template compiler', () => {\n         else {\n             $I18N_0$ = $localize \\`:@@ID.WITH.INVALID.CHARS:Element title\\`;\n         }\n-        const $_c1$ = [\"title\", $I18N_0$];\n+        …\n         var $I18N_2$;\n         if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n             const $MSG_EXTERNAL_ID_WITH_INVALID_CHARS_2$$APP_SPEC_TS_4$ = goog.getMsg(\" Some content \");\n@@ -934,7 +968,6 @@ describe('i18n support in the template compiler', () => {\n         else {\n             $I18N_2$ = $localize \\`:@@ID.WITH.INVALID.CHARS.2: Some content \\`;\n         }\n-        …\n       `;\n \n       const exceptions = {\n@@ -1030,26 +1063,32 @@ describe('i18n support in the template compiler', () => {\n       const i18n_2 = i18nMsg('My i18n block #3');\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        ${i18n_2}\n-        …\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          ${i18n_2}\n+          return [\n+            $i18n_0$,\n+            $i18n_1$,\n+            $i18n_2$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementStart(2, \"div\");\n             $r3$.ɵɵtext(3, \"My non-i18n block #1\");\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementStart(4, \"div\");\n-            $r3$.ɵɵi18n(5, $i18n_1$);\n+            $r3$.ɵɵi18n(5, 1);\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementStart(6, \"div\");\n             $r3$.ɵɵtext(7, \"My non-i18n block #2\");\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementStart(8, \"div\");\n-            $r3$.ɵɵi18n(9, $i18n_2$);\n+            $r3$.ɵɵi18n(9, 2);\n             $r3$.ɵɵelementEnd();\n           }\n         }\n@@ -1068,7 +1107,7 @@ describe('i18n support in the template compiler', () => {\n \n       // Keeping raw content (avoiding `i18nMsg`) to illustrate how named interpolations are\n       // generated.\n-      const output = String.raw`\n+      const i18n_0 = String.raw`\n         var $I18N_0$;\n         if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n             const $MSG_EXTERNAL_7597881511811528589$$APP_SPEC_TS_0$ = goog.getMsg(\" Named interpolation: {$phA} Named interpolation with spaces: {$phB} \", {\n@@ -1082,13 +1121,21 @@ describe('i18n support in the template compiler', () => {\n           String.raw`{\"\\uFFFD0\\uFFFD\"}:PH_A: Named interpolation with spaces: $` +\n           String.raw`{\"\\uFFFD1\\uFFFD\"}:PH_B: \\`;\n         }\n-        …\n+      `;\n+\n+      const output = String.raw`\n         decls: 2,\n         vars: 2,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $I18N_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -1110,12 +1157,16 @@ describe('i18n support in the template compiler', () => {\n       const i18n_0 = i18nMsg('{$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -1144,12 +1195,16 @@ describe('i18n support in the template compiler', () => {\n       ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵpipe(2, \"async\");\n             $r3$.ɵɵelementEnd();\n           }\n@@ -1181,23 +1236,29 @@ describe('i18n support in the template compiler', () => {\n           'My i18n block #{$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        ${i18n_2}\n-        …\n         decls: 7,\n         vars: 5,\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          ${i18n_2}\n+          return [\n+            $i18n_0$,\n+            $i18n_1$,\n+            $i18n_2$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementStart(2, \"div\");\n-            $r3$.ɵɵi18n(3, $i18n_1$);\n+            $r3$.ɵɵi18n(3, 1);\n             $r3$.ɵɵpipe(4, \"uppercase\");\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementStart(5, \"div\");\n-            $r3$.ɵɵi18n(6, $i18n_2$);\n+            $r3$.ɵɵi18n(6, 2);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -1254,20 +1315,25 @@ describe('i18n support in the template compiler', () => {\n           ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        …\n         decls: 9,\n         vars: 5,\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          return [\n+            $i18n_0$,\n+            $i18n_1$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18nStart(1, $i18n_0$);\n+            $r3$.ɵɵi18nStart(1, 0);\n             $r3$.ɵɵelement(2, \"span\");\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementStart(3, \"div\");\n-            $r3$.ɵɵi18nStart(4, $i18n_1$);\n+            $r3$.ɵɵi18nStart(4, 1);\n             $r3$.ɵɵpipe(5, \"uppercase\");\n             $r3$.ɵɵelementStart(6, \"div\");\n             $r3$.ɵɵelementStart(7, \"div\");\n@@ -1328,30 +1394,35 @@ describe('i18n support in the template compiler', () => {\n           ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        const $_c4$ = [\"title\", $i18n_0$];\n-        ${i18n_1}\n-        ${i18n_2}\n-        const $_c9$ = [\"title\", $i18n_2$];\n-        ${i18n_3}\n-        …\n         decls: 9,\n         vars: 7,\n-        consts: [[${AttributeMarker.I18n}, \"title\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          ${i18n_2}\n+          ${i18n_3}\n+          return [\n+            $i18n_0$,\n+            [${AttributeMarker.I18n}, \"title\"],\n+            [\"title\", $i18n_1$],\n+            $i18n_2$,\n+            [\"title\", $i18n_3$]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18nStart(1, $i18n_1$);\n-            $r3$.ɵɵelementStart(2, \"span\", 0);\n-            $r3$.ɵɵi18nAttributes(3, $_c4$);\n+            $r3$.ɵɵi18nStart(1, 0);\n+            $r3$.ɵɵelementStart(2, \"span\", 1);\n+            $r3$.ɵɵi18nAttributes(3, 2);\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementStart(4, \"div\");\n-            $r3$.ɵɵi18nStart(5, $i18n_3$);\n+            $r3$.ɵɵi18nStart(5, 3);\n             $r3$.ɵɵpipe(6, \"uppercase\");\n-            $r3$.ɵɵelementStart(7, \"span\", 0);\n-            $r3$.ɵɵi18nAttributes(8, $_c9$);\n+            $r3$.ɵɵelementStart(7, \"span\", 1);\n+            $r3$.ɵɵi18nAttributes(8, 4);\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n@@ -1401,13 +1472,11 @@ describe('i18n support in the template compiler', () => {\n           ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n         function MyComponent_div_2_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n             $r3$.ɵɵelementStart(1, \"div\");\n-            $r3$.ɵɵi18nStart(2, $i18n_0$);\n+            $r3$.ɵɵi18nStart(2, 1);\n             $r3$.ɵɵelement(3, \"div\");\n             $r3$.ɵɵpipe(4, \"uppercase\");\n             $r3$.ɵɵi18nEnd();\n@@ -1424,7 +1493,13 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 3,\n         vars: 1,\n-        consts: [[${AttributeMarker.Template}, \"ngIf\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [${AttributeMarker.Template}, \"ngIf\"],\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n@@ -1458,12 +1533,11 @@ describe('i18n support in the template compiler', () => {\n             $r3$.ɵɵelement(0, \"img\", 0);\n           }\n         }\n-        ${i18n_0}\n-        const $_c4$ = [\"title\", $i18n_0$];\n+        …\n         function MyComponent_img_2_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"img\", 3);\n-            $r3$.ɵɵi18nAttributes(1, $_c4$);\n+            $r3$.ɵɵi18nAttributes(1, 4);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -1475,11 +1549,17 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 3,\n         vars: 2,\n-        consts: [[\"src\", \"logo.png\"], [\"src\", \"logo.png\", ${\n-          AttributeMarker.Template}, \"ngIf\"], [\"src\", \"logo.png\", ${\n-          AttributeMarker.Bindings}, \"title\", ${\n-          AttributeMarker.Template}, \"ngIf\"], [\"src\", \"logo.png\", ${\n-          AttributeMarker.I18n}, \"title\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [\"src\", \"logo.png\"],\n+            [\"src\", \"logo.png\", ${AttributeMarker.Template}, \"ngIf\"],\n+            [\"src\", \"logo.png\", ${AttributeMarker.Bindings}, \"title\",\n+                                ${AttributeMarker.Template}, \"ngIf\"],\n+            [\"src\", \"logo.png\", ${AttributeMarker.I18n}, \"title\"],\n+            [\"title\", $i18n_0$]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelement(0, \"img\", 0);\n@@ -1546,7 +1626,7 @@ describe('i18n support in the template compiler', () => {\n       const output = String.raw`\n         function MyComponent_div_2_div_4_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18nStart(0, $I18N_0$, 2);\n+            $r3$.ɵɵi18nStart(0, 0, 2);\n             $r3$.ɵɵelementStart(1, \"div\");\n             $r3$.ɵɵelement(2, \"div\");\n             $r3$.ɵɵelementEnd();\n@@ -1561,11 +1641,11 @@ describe('i18n support in the template compiler', () => {\n         }\n         function MyComponent_div_2_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18nStart(0, $I18N_0$, 1);\n+            $r3$.ɵɵi18nStart(0, 0, 1);\n             $r3$.ɵɵelementStart(1, \"div\");\n             $r3$.ɵɵelementStart(2, \"div\");\n             $r3$.ɵɵpipe(3, \"uppercase\");\n-            $r3$.ɵɵtemplate(4, MyComponent_div_2_div_4_Template, 3, 2, \"div\", 0);\n+            $r3$.ɵɵtemplate(4, MyComponent_div_2_div_4_Template, 3, 2, \"div\", 1);\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵi18nEnd();\n@@ -1578,10 +1658,10 @@ describe('i18n support in the template compiler', () => {\n             $r3$.ɵɵi18nApply(0);\n           }\n         }\n-        ${i18n_0}\n+        …\n         function MyComponent_div_3_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18nStart(0, $I18N_0$, 3);\n+            $r3$.ɵɵi18nStart(0, 0, 3);\n             $r3$.ɵɵelementStart(1, \"div\");\n             $r3$.ɵɵelement(2, \"div\");\n             $r3$.ɵɵpipe(3, \"uppercase\");\n@@ -1598,13 +1678,19 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 4,\n         vars: 2,\n-        consts: [[${AttributeMarker.Template}, \"ngIf\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$,\n+            [${AttributeMarker.Template}, \"ngIf\"]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18nStart(1, $I18N_0$);\n-            $r3$.ɵɵtemplate(2, MyComponent_div_2_Template, 5, 5, \"div\", 0);\n-            $r3$.ɵɵtemplate(3, MyComponent_div_3_Template, 4, 4, \"div\", 0);\n+            $r3$.ɵɵi18nStart(1, 0);\n+            $r3$.ɵɵtemplate(2, MyComponent_div_2_Template, 5, 5, \"div\", 1);\n+            $r3$.ɵɵtemplate(3, MyComponent_div_3_Template, 4, 4, \"div\", 1);\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n           }\n@@ -1631,12 +1717,10 @@ describe('i18n support in the template compiler', () => {\n       ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n         function MyComponent_div_0_Template(rf, ctx) {\n           if (rf & 1) {\n               $r3$.ɵɵelementStart(0, \"div\");\n-              $r3$.ɵɵi18nStart(1, $i18n_0$);\n+              $r3$.ɵɵi18nStart(1, 1);\n               $r3$.ɵɵelement(2, \"span\");\n               $r3$.ɵɵi18nEnd();\n               $r3$.ɵɵelementEnd();\n@@ -1651,7 +1735,13 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 1,\n         vars: 1,\n-        consts: [[${AttributeMarker.Template}, \"ngIf\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [${AttributeMarker.Template}, \"ngIf\"],\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵtemplate(0, MyComponent_div_0_Template, 3, 1, \"div\", 0);\n@@ -1673,14 +1763,18 @@ describe('i18n support in the template compiler', () => {\n       const i18n_0 = i18nMsg('Hello');\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n-        consts: [[${AttributeMarker.Bindings}, \"click\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [${AttributeMarker.Bindings}, \"click\"],\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\", 0);\n             $r3$.ɵɵlistener(\"click\", function MyComponent_Template_div_click_0_listener() { return ctx.onClick(); });\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 1);\n             $r3$.ɵɵelementEnd();\n           }\n         }\n@@ -1699,12 +1793,16 @@ describe('i18n support in the template compiler', () => {\n       const i18n_0 = i18nMsg('My i18n block #1');\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n         }\n@@ -1723,14 +1821,18 @@ describe('i18n support in the template compiler', () => {\n           [['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n         decls: 2,\n         vars: 1,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $I18N_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -1754,19 +1856,25 @@ describe('i18n support in the template compiler', () => {\n       const i18n_1 = i18nMsg('My i18n block #1');\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n         function MyComponent_ng_template_0_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18n(0, $i18n_1$);\n+            $r3$.ɵɵi18n(0, 1);\n           }\n         }\n         …\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          return [\n+            $i18n_0$,\n+            $i18n_1$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵtemplate(0, MyComponent_ng_template_0_Template, 1, 0, \"ng-template\");\n             $r3$.ɵɵelementContainerStart(1);\n-            $r3$.ɵɵi18n(2, $i18n_0$);\n+            $r3$.ɵɵi18n(2, 0);\n             $r3$.ɵɵelementContainerEnd();\n           }\n         }\n@@ -1785,20 +1893,25 @@ describe('i18n support in the template compiler', () => {\n       const i18n_1 = i18nMsg('Text #2');\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        …\n         decls: 4,\n         vars: 0,\n-        consts: [[${AttributeMarker.Classes}, \"myClass\"], [${\n-          AttributeMarker.Styles}, \"padding\", \"10px\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          return [\n+            [${AttributeMarker.Classes}, \"myClass\"],\n+            $i18n_0$,\n+            [${AttributeMarker.Styles}, \"padding\", \"10px\"],\n+            $i18n_1$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"span\", 0);\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 1);\n             $r3$.ɵɵelementEnd();\n-            $r3$.ɵɵelementStart(2, \"span\", 1);\n-            $r3$.ɵɵi18n(3, $i18n_1$);\n+            $r3$.ɵɵelementStart(2, \"span\", 2);\n+            $r3$.ɵɵi18n(3, 3);\n             $r3$.ɵɵelementEnd();\n           }\n         }\n@@ -1818,14 +1931,18 @@ describe('i18n support in the template compiler', () => {\n           i18nMsg('Some content: {$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n         decls: 3,\n         vars: 3,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementContainerStart(0);\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵpipe(2, \"uppercase\");\n             $r3$.ɵɵelementContainerEnd();\n           }\n@@ -1849,10 +1966,9 @@ describe('i18n support in the template compiler', () => {\n           i18nMsg('Some content: {$interpolation}', [['interpolation', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n         function MyComponent_ng_template_0_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18n(0, $i18n_0$);\n+            $r3$.ɵɵi18n(0, 0);\n             $r3$.ɵɵpipe(1, \"uppercase\");\n           } if (rf & 2) {\n             const $ctx_r0$ = $r3$.ɵɵnextContext();\n@@ -1864,6 +1980,12 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 1,\n         vars: 0,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵtemplate(0, MyComponent_ng_template_0_Template, 2, 3, \"ng-template\");\n@@ -1894,10 +2016,9 @@ describe('i18n support in the template compiler', () => {\n           ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n         function MyComponent_ng_template_2_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18n(0, $I18N_0$, 1);\n+            $r3$.ɵɵi18n(0, 0, 1);\n             $r3$.ɵɵpipe(1, \"uppercase\");\n           }\n           if (rf & 2) {\n@@ -1910,10 +2031,16 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 5,\n         vars: 3,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18nStart(1, $i18n_0$);\n+            $r3$.ɵɵi18nStart(1, 0);\n             $r3$.ɵɵtemplate(2, MyComponent_ng_template_2_Template, 2, 3, \"ng-template\");\n             $r3$.ɵɵelementContainer(3);\n             $r3$.ɵɵpipe(4, \"uppercase\");\n@@ -1945,11 +2072,9 @@ describe('i18n support in the template compiler', () => {\n           [['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n         function MyComponent_ng_template_0_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18n(0, $i18n_1$);\n+            $r3$.ɵɵi18n(0, 1);\n           }\n           if (rf & 2) {\n             const $ctx_r0$ = $r3$.ɵɵnextContext();\n@@ -1960,11 +2085,19 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 3,\n         vars: 1,\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          return [\n+            $i18n_0$,\n+            $i18n_1$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵtemplate(0, MyComponent_ng_template_0_Template, 1, 1, \"ng-template\");\n             $r3$.ɵɵelementContainerStart(1);\n-            $r3$.ɵɵi18n(2, $i18n_0$);\n+            $r3$.ɵɵi18n(2, 0);\n             $r3$.ɵɵelementContainerEnd();\n           }\n           if (rf & 2) {\n@@ -2011,7 +2144,7 @@ describe('i18n support in the template compiler', () => {\n       const output = String.raw`\n         function MyComponent_ng_template_2_ng_template_2_ng_template_1_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18n(0, $i18n_0$, 3);\n+            $r3$.ɵɵi18n(0, 0, 3);\n           }\n           if (rf & 2) {\n             const $ctx_r2$ = $r3$.ɵɵnextContext(3);\n@@ -2021,7 +2154,7 @@ describe('i18n support in the template compiler', () => {\n         }\n         function MyComponent_ng_template_2_ng_template_2_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18nStart(0, $i18n_0$, 2);\n+            $r3$.ɵɵi18nStart(0, 0, 2);\n             $r3$.ɵɵtemplate(1, MyComponent_ng_template_2_ng_template_2_ng_template_1_Template, 1, 1, \"ng-template\");\n             $r3$.ɵɵi18nEnd();\n           }\n@@ -2032,10 +2165,10 @@ describe('i18n support in the template compiler', () => {\n             $r3$.ɵɵi18nApply(0);\n           }\n         }\n-        ${i18n_0}\n+        …\n         function MyComponent_ng_template_2_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18nStart(0, $i18n_0$, 1);\n+            $r3$.ɵɵi18nStart(0, 0, 1);\n             $r3$.ɵɵpipe(1, \"uppercase\");\n             $r3$.ɵɵtemplate(2, MyComponent_ng_template_2_ng_template_2_Template, 2, 1, \"ng-template\");\n             $r3$.ɵɵi18nEnd();\n@@ -2050,10 +2183,16 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 3,\n         vars: 0,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18nStart(1, $i18n_0$);\n+            $r3$.ɵɵi18nStart(1, 0);\n             $r3$.ɵɵtemplate(2, MyComponent_ng_template_2_Template, 3, 3, \"ng-template\");\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n@@ -2078,11 +2217,9 @@ describe('i18n support in the template compiler', () => {\n           [['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n         function MyComponent_ng_template_2_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18n(0, $I18N_1$);\n+            $r3$.ɵɵi18n(0, 1);\n           }\n           if (rf & 2) {\n             const $ctx_r0$ = $r3$.ɵɵnextContext();\n@@ -2093,10 +2230,18 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 3,\n         vars: 1,\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          return [\n+            $i18n_0$,\n+            $i18n_1$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementContainerStart(0);\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementContainerEnd();\n             $r3$.ɵɵtemplate(2, MyComponent_ng_template_2_Template, 1, 1, \"ng-template\");\n           }\n@@ -2127,22 +2272,28 @@ describe('i18n support in the template compiler', () => {\n           '{$tagImg} is my logo #2 ', [['tagImg', String.raw`\\uFFFD#1\\uFFFD\\uFFFD/#1\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n         function MyComponent_ng_template_3_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18nStart(0, $i18n_1$);\n-            $r3$.ɵɵelement(1, \"img\", 0);\n+            $r3$.ɵɵi18nStart(0, 2);\n+            $r3$.ɵɵelement(1, \"img\", 1);\n             $r3$.ɵɵi18nEnd();\n           }\n         }\n         …\n-        consts: [[\"src\", \"logo.png\", \"title\", \"Logo\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          return [\n+            $i18n_0$,\n+            [\"src\", \"logo.png\", \"title\", \"Logo\"],\n+            $i18n_1$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementContainerStart(0);\n-            $r3$.ɵɵi18nStart(1, $i18n_0$);\n-            $r3$.ɵɵelement(2, \"img\", 0);\n+            $r3$.ɵɵi18nStart(1, 0);\n+            $r3$.ɵɵelement(2, \"img\", 1);\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementContainerEnd();\n             $r3$.ɵɵtemplate(3, MyComponent_ng_template_3_Template, 2, 0, \"ng-template\");\n@@ -2202,14 +2353,18 @@ describe('i18n support in the template compiler', () => {\n       ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n         decls: 3,\n         vars: 0,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18nStart(1, $i18n_0$);\n+            $r3$.ɵɵi18nStart(1, 0);\n             $r3$.ɵɵelementContainer(2);\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n@@ -2238,14 +2393,18 @@ describe('i18n support in the template compiler', () => {\n              ]);\n \n          const output = String.raw`\n-          ${i18n_0}\n-          …\n           decls: 4,\n           vars: 0,\n+          consts: function() {\n+            ${i18n_0}\n+            return [\n+              $i18n_0$\n+            ];\n+          },\n           template: function MyComponent_Template(rf, ctx) {\n             if (rf & 1) {\n               $r3$.ɵɵelementStart(0, \"div\");\n-              $r3$.ɵɵi18nStart(1, I18N_0);\n+              $r3$.ɵɵi18nStart(1, 0);\n               $r3$.ɵɵelementContainerStart(2);\n               $r3$.ɵɵelement(3, \"strong\");\n               $r3$.ɵɵelementContainerEnd();\n@@ -2270,29 +2429,36 @@ describe('i18n support in the template compiler', () => {\n       const i18n_1 = i18nMsg('Content B');\n \n       const output = String.raw`\n-        ${i18n_0}\n         function MyComponent_0_ng_template_0_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18n(0, $i18n_0$);\n+            $r3$.ɵɵi18n(0, 1);\n           }\n         }\n         function MyComponent_0_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵtemplate(0, MyComponent_0_ng_template_0_Template, 1, 0, \"ng-template\");\n           }\n         }\n-        ${i18n_1}\n+        …\n         function MyComponent_ng_container_1_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementContainerStart(0);\n-            $r3$.ɵɵi18n(1, $i18n_1$);\n+            $r3$.ɵɵi18n(1, 2);\n             $r3$.ɵɵelementContainerEnd();\n           }\n         }\n         …\n         decls: 2,\n         vars: 2,\n-        consts: [[4, \"ngIf\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          return [\n+            [${AttributeMarker.Template}, \"ngIf\"],\n+            $i18n_0$,\n+            $i18n_1$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵtemplate(0, MyComponent_0_Template, 1, 0, undefined, 0);\n@@ -2320,7 +2486,7 @@ describe('i18n support in the template compiler', () => {\n \n       // Keeping raw content (avoiding `i18nMsg`) to illustrate message layout\n       // in case of whitespace preserving mode.\n-      const output = String.raw`\n+      const i18n_0 = String.raw`\n         var $I18N_0$;\n         if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n             const $MSG_EXTERNAL_963542717423364282$$APP_SPEC_TS_0$ = goog.getMsg(\"\\n          Some text\\n          {$startTagSpan}Text inside span{$closeTagSpan}\\n        \", {\n@@ -2337,12 +2503,20 @@ describe('i18n support in the template compiler', () => {\n           String.raw`{\"\\uFFFD/#3\\uFFFD\"}:CLOSE_TAG_SPAN:\n         \\`;\n         }\n-        …\n+      `;\n+\n+      const output = String.raw`\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵtext(0, \"\\n        \");\n             $r3$.ɵɵelementStart(1, \"div\");\n-            $r3$.ɵɵi18nStart(2, $I18N_0$);\n+            $r3$.ɵɵi18nStart(2, 0);\n             $r3$.ɵɵelement(3, \"span\");\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n@@ -2366,14 +2540,18 @@ describe('i18n support in the template compiler', () => {\n           [['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n         decls: 2,\n         vars: 1,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $I18N_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -2419,13 +2597,17 @@ describe('i18n support in the template compiler', () => {\n           [['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`]]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n         decls: 1,\n         vars: 1,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18n(0, $i18n_0$);\n+            $r3$.ɵɵi18n(0, 0);\n           }\n           if (rf & 2) {\n             $r3$.ɵɵi18nExp(ctx.age);\n@@ -2460,13 +2642,11 @@ describe('i18n support in the template compiler', () => {\n           ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n         function MyComponent_div_2_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵelementStart(0, \"div\", 2);\n+            $r3$.ɵɵelementStart(0, \"div\", 3);\n             $r3$.ɵɵtext(1, \" \");\n-            $r3$.ɵɵi18n(2, $i18n_1$);\n+            $r3$.ɵɵi18n(2, 4);\n             $r3$.ɵɵtext(3, \" \");\n             $r3$.ɵɵelementEnd();\n           }\n@@ -2477,12 +2657,12 @@ describe('i18n support in the template compiler', () => {\n             $r3$.ɵɵi18nApply(2);\n           }\n         }\n-        ${i18n_2}\n+        …\n         function MyComponent_div_3_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵelementStart(0, \"div\", 3);\n+            $r3$.ɵɵelementStart(0, \"div\", 5);\n             $r3$.ɵɵtext(1, \" You have \");\n-            $r3$.ɵɵi18n(2, $i18n_2$);\n+            $r3$.ɵɵi18n(2, 6);\n             $r3$.ɵɵtext(3, \". \");\n             $r3$.ɵɵelementEnd();\n           }\n@@ -2496,16 +2676,27 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 4,\n         vars: 3,\n-        consts: [[\"title\", \"icu only\", ${\n-          AttributeMarker.Template}, \"ngIf\"], [\"title\", \"icu and text\", ${\n-          AttributeMarker.Template}, \"ngIf\"], [\"title\", \"icu only\"], [\"title\", \"icu and text\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          ${i18n_2}\n+          return [\n+            $i18n_0$,\n+            [\"title\", \"icu only\", ${AttributeMarker.Template}, \"ngIf\"],\n+            [\"title\", \"icu and text\", ${AttributeMarker.Template}, \"ngIf\"],\n+            [\"title\", \"icu only\"],\n+            $i18n_1$,\n+            [\"title\", \"icu and text\"],\n+            $i18n_2$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n-            $r3$.ɵɵtemplate(2, MyComponent_div_2_Template, 4, 1, \"div\", 0);\n-            $r3$.ɵɵtemplate(3, MyComponent_div_3_Template, 4, 2, \"div\", 1);\n+            $r3$.ɵɵtemplate(2, MyComponent_div_2_Template, 4, 1, \"div\", 1);\n+            $r3$.ɵɵtemplate(3, MyComponent_div_3_Template, 4, 2, \"div\", 2);\n           }\n           if (rf & 2) {\n             $r3$.ɵɵadvance(1);\n@@ -2533,12 +2724,16 @@ describe('i18n support in the template compiler', () => {\n           ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -2586,18 +2781,22 @@ describe('i18n support in the template compiler', () => {\n           ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        …\n         decls: 5,\n         vars: 1,\n-        consts: [[1, \"other\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          return [\n+            $i18n_1$,\n+            [${AttributeMarker.Classes}, \"other\"]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18nStart(1, $i18n_1$);\n+            $r3$.ɵɵi18nStart(1, 0);\n             $r3$.ɵɵelement(2, \"b\");\n-            $r3$.ɵɵelementStart(3, \"div\", 0);\n+            $r3$.ɵɵelementStart(3, \"div\", 1);\n             $r3$.ɵɵelement(4, \"i\");\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵi18nEnd();\n@@ -2627,14 +2826,18 @@ describe('i18n support in the template compiler', () => {\n           ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n         decls: 2,\n         vars: 2,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -2668,16 +2871,20 @@ describe('i18n support in the template compiler', () => {\n       ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        ${i18n_2}\n-        …\n         decls: 2,\n         vars: 2,\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          ${i18n_2}\n+          return [\n+            $i18n_2$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_2$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -2704,7 +2911,9 @@ describe('i18n support in the template compiler', () => {\n         </div>\n       `;\n \n-      const output = String.raw`\n+      // Keeping raw content here to illustrate the difference in placeholders generated for\n+      // goog.getMsg and $localize calls (see last i18n block).\n+      const i18n_0 = String.raw`\n         var $I18N_1$;\n         if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n             const $MSG_APP_SPEC_TS_1$ = goog.getMsg(\"{VAR_SELECT, select, male {male} female {female} other {other}}\");\n@@ -2761,9 +2970,12 @@ describe('i18n support in the template compiler', () => {\n         $I18N_0$ = $r3$.ɵɵi18nPostprocess($I18N_0$, {\n           \"ICU\": [$I18N_1$, $I18N_2$, $I18N_4$]\n         });\n+      `;\n+\n+      const output = String.raw`\n         function MyComponent_div_3_Template(rf, ctx) {\n           if (rf & 1) {\n-              $r3$.ɵɵi18nStart(0, $I18N_0$, 1);\n+              $r3$.ɵɵi18nStart(0, 0, 1);\n               $r3$.ɵɵelement(1, \"div\");\n               $r3$.ɵɵi18nEnd();\n           }\n@@ -2777,13 +2989,19 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 4,\n         vars: 3,\n-        consts: [[${AttributeMarker.Template}, \"ngIf\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$,\n+            [${AttributeMarker.Template}, \"ngIf\"]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18nStart(1, $I18N_0$);\n+            $r3$.ɵɵi18nStart(1, 0);\n             $r3$.ɵɵelement(2, \"div\");\n-            $r3$.ɵɵtemplate(3, MyComponent_div_3_Template, 2, 1, \"div\", 0);\n+            $r3$.ɵɵtemplate(3, MyComponent_div_3_Template, 2, 1, \"div\", 1);\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n           }\n@@ -2819,15 +3037,19 @@ describe('i18n support in the template compiler', () => {\n       const i18n_1 = i18nMsg(' {$icu} ', [['icu', '$i18n_0$']]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        …\n         decls: 2,\n         vars: 2,\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          return [\n+            $i18n_1$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_1$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -2865,14 +3087,18 @@ describe('i18n support in the template compiler', () => {\n           ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n         decls: 2,\n         vars: 3,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -2910,13 +3136,9 @@ describe('i18n support in the template compiler', () => {\n       ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        ${i18n_2}\n-        …\n         function MyComponent_span_2_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18nStart(0, $i18n_2$, 1);\n+            $r3$.ɵɵi18nStart(0, 0, 1);\n             $r3$.ɵɵelement(1, \"span\");\n             $r3$.ɵɵi18nEnd();\n           }\n@@ -2930,12 +3152,20 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 3,\n         vars: 2,\n-        consts: [[${AttributeMarker.Template}, \"ngIf\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          ${i18n_2}\n+          return [\n+            $i18n_2$,\n+            [${AttributeMarker.Template}, \"ngIf\"]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18nStart(1, $i18n_2$);\n-            $r3$.ɵɵtemplate(2, MyComponent_span_2_Template, 2, 1, \"span\", 0);\n+            $r3$.ɵɵi18nStart(1, 0);\n+            $r3$.ɵɵtemplate(2, MyComponent_span_2_Template, 2, 1, \"span\", 1);\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n           }\n@@ -2981,12 +3211,9 @@ describe('i18n support in the template compiler', () => {\n       ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        ${i18n_1}\n-        ${i18n_2}\n         function MyComponent_span_2_Template(rf, ctx) {\n           if (rf & 1) {\n-            $r3$.ɵɵi18nStart(0, $i18n_2$, 1);\n+            $r3$.ɵɵi18nStart(0, 0, 1);\n             $r3$.ɵɵelement(1, \"span\");\n             $r3$.ɵɵi18nEnd();\n           }\n@@ -3000,12 +3227,20 @@ describe('i18n support in the template compiler', () => {\n         …\n         decls: 3,\n         vars: 4,\n-        consts: [[${AttributeMarker.Template}, \"ngIf\"]],\n+        consts: function() {\n+          ${i18n_0}\n+          ${i18n_1}\n+          ${i18n_2}\n+          return [\n+            $i18n_2$,\n+            [${AttributeMarker.Template}, \"ngIf\"]\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18nStart(1, $i18n_2$);\n-            $r3$.ɵɵtemplate(2, MyComponent_span_2_Template, 2, 2, \"span\", 0);\n+            $r3$.ɵɵi18nStart(1, 0);\n+            $r3$.ɵɵtemplate(2, MyComponent_span_2_Template, 2, 2, \"span\", 1);\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n           }\n@@ -3042,14 +3277,18 @@ describe('i18n support in the template compiler', () => {\n           ]);\n \n       const output = String.raw`\n-        ${i18n_0}\n-        …\n         decls: 2,\n         vars: 4,\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            $i18n_0$\n+          ];\n+        },\n         template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵelementStart(0, \"div\");\n-            $r3$.ɵɵi18n(1, $i18n_0$);\n+            $r3$.ɵɵi18n(1, 0);\n             $r3$.ɵɵelementEnd();\n           }\n           if (rf & 2) {\n@@ -3283,7 +3522,7 @@ $` + String.raw`{$I18N_4$}:ICU:\\`;\n         </svg>\n       `;\n \n-      const output = String.raw`\n+      const i18n_0 = String.raw`\n         var $I18N_0$;\n         if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n           const $MSG_EXTERNAL_7128002169381370313$$APP_SPEC_TS_1$ = goog.getMsg(\"{$startTagXhtmlDiv} Count: {$startTagXhtmlSpan}5{$closeTagXhtmlSpan}{$closeTagXhtmlDiv}\", {\n@@ -3301,15 +3540,26 @@ $` + String.raw`{$I18N_4$}:ICU:\\`;\n           String.raw`{\"\\uFFFD/#4\\uFFFD\"}:CLOSE_TAG__XHTML_SPAN:$` +\n           String.raw`{\"\\uFFFD/#3\\uFFFD\"}:CLOSE_TAG__XHTML_DIV:\\`;\n         }\n+      `;\n+\n+      const output = String.raw`\n         …\n-        function MyComponent_Template(rf, ctx) {\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [\"xmlns\", \"http://www.w3.org/2000/svg\"],\n+            $i18n_0$,\n+            [\"xmlns\", \"http://www.w3.org/1999/xhtml\"]\n+          ];\n+        },\n+        template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵnamespaceSVG();\n             $r3$.ɵɵelementStart(0, \"svg\", 0);\n             $r3$.ɵɵelementStart(1, \"foreignObject\");\n-            $r3$.ɵɵi18nStart(2, $I18N_0$);\n+            $r3$.ɵɵi18nStart(2, 1);\n             $r3$.ɵɵnamespaceHTML();\n-            $r3$.ɵɵelementStart(3, \"div\", 1);\n+            $r3$.ɵɵelementStart(3, \"div\", 2);\n             $r3$.ɵɵelement(4, \"span\");\n             $r3$.ɵɵelementEnd();\n             $r3$.ɵɵi18nEnd();\n@@ -3333,7 +3583,7 @@ $` + String.raw`{$I18N_4$}:ICU:\\`;\n         </svg>\n       `;\n \n-      const output = String.raw`\n+      const i18n_0 = String.raw`\n         var $I18N_0$;\n         if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n           const $MSG_EXTERNAL_7428861019045796010$$APP_SPEC_TS_1$ = goog.getMsg(\" Count: {$startTagXhtmlSpan}5{$closeTagXhtmlSpan}\", {\n@@ -3347,15 +3597,25 @@ $` + String.raw`{$I18N_4$}:ICU:\\`;\n           String.raw`{\"\\uFFFD#4\\uFFFD\"}:START_TAG__XHTML_SPAN:5$` +\n           String.raw`{\"\\uFFFD/#4\\uFFFD\"}:CLOSE_TAG__XHTML_SPAN:\\`;\n         }\n-        …\n-        function MyComponent_Template(rf, ctx) {\n+      `;\n+\n+      const output = String.raw`\n+        consts: function() {\n+          ${i18n_0}\n+          return [\n+            [\"xmlns\", \"http://www.w3.org/2000/svg\"],\n+            [\"xmlns\", \"http://www.w3.org/1999/xhtml\"],\n+            $i18n_0$\n+          ];\n+        },\n+        template: function MyComponent_Template(rf, ctx) {\n           if (rf & 1) {\n             $r3$.ɵɵnamespaceSVG();\n             $r3$.ɵɵelementStart(0, \"svg\", 0);\n             $r3$.ɵɵelementStart(1, \"foreignObject\");\n             $r3$.ɵɵnamespaceHTML();\n             $r3$.ɵɵelementStart(2, \"div\", 1);\n-            $r3$.ɵɵi18nStart(3, $I18N_0$);\n+            $r3$.ɵɵi18nStart(3, 2);\n             $r3$.ɵɵelement(4, \"span\");\n             $r3$.ɵɵi18nEnd();\n             $r3$.ɵɵelementEnd();\n@@ -3365,7 +3625,7 @@ $` + String.raw`{$I18N_4$}:ICU:\\`;\n         }\n       `;\n \n-      verify(input, output, {verbose: true});\n+      verify(input, output);\n     });\n   });\n });"
        },
        {
            "sha": "9844830d0ab314bb2dd5079643c2c422d16a96cf",
            "filename": "packages/compiler/src/render3/view/compiler.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts?ref=cb05c0102fc951899745e16a923966d41f9384a7",
            "patch": "@@ -196,10 +196,19 @@ export function compileComponentFromMetadata(\n   // e.g. `vars: 2`\n   definitionMap.set('vars', o.literal(templateBuilder.getVarCount()));\n \n-  // e.g. `consts: [['one', 'two'], ['three', 'four']]\n-  const consts = templateBuilder.getConsts();\n-  if (consts.length > 0) {\n-    definitionMap.set('consts', o.literalArr(consts));\n+  // Generate `consts` section of ComponentDef:\n+  // - either as an array:\n+  //   `consts: [['one', 'two'], ['three', 'four']]`\n+  // - or as a factory function in case additional statements are present (to support i18n):\n+  //   `consts: function() { var i18n_0; if (ngI18nClosureMode) {...} else {...} return [i18n_0]; }`\n+  const {constExpressions, prepareStatements} = templateBuilder.getConsts();\n+  if (constExpressions.length > 0) {\n+    let constsExpr: o.LiteralArrayExpr|o.FunctionExpr = o.literalArr(constExpressions);\n+    // Prepare statements are present - turn `consts` into a function.\n+    if (prepareStatements.length > 0) {\n+      constsExpr = o.fn([], [...prepareStatements, new o.ReturnStatement(constsExpr)]);\n+    }\n+    definitionMap.set('consts', constsExpr);\n   }\n \n   definitionMap.set('template', templateFunctionExpression);"
        },
        {
            "sha": "da71db4b6782f77c2e1117311ad85d58f0dcc5e2",
            "filename": "packages/compiler/src/render3/view/i18n/util.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Futil.ts?ref=cb05c0102fc951899745e16a923966d41f9384a7",
            "patch": "@@ -12,10 +12,14 @@ import * as o from '../../../output/output_ast';\n import * as t from '../../r3_ast';\n \n /* Closure variables holding messages must be named `MSG_[A-Z0-9]+` */\n-const CLOSURE_TRANSLATION_PREFIX = 'MSG_';\n+const CLOSURE_TRANSLATION_VAR_PREFIX = 'MSG_';\n \n-/* Prefix for non-`goog.getMsg` i18n-related vars */\n-export const TRANSLATION_PREFIX = 'I18N_';\n+/**\n+ * Prefix for non-`goog.getMsg` i18n-related vars.\n+ * Note: the prefix uses lowercase characters intentionally due to a Closure behavior that\n+ * considers variables like `I18N_0` as constants and throws an error when their value changes.\n+ */\n+export const TRANSLATION_VAR_PREFIX = 'i18n_';\n \n /** Name of the i18n attributes **/\n export const I18N_ATTR = 'i18n';\n@@ -166,7 +170,7 @@ export function formatI18nPlaceholderName(name: string, useCamelCase: boolean =\n  * @returns Complete translation const prefix\n  */\n export function getTranslationConstPrefix(extra: string): string {\n-  return `${CLOSURE_TRANSLATION_PREFIX}${extra}`.toUpperCase();\n+  return `${CLOSURE_TRANSLATION_VAR_PREFIX}${extra}`.toUpperCase();\n }\n \n /**"
        },
        {
            "sha": "818d0c5119abc66bbc5604e9647a3be443d7faaf",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 17,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=cb05c0102fc951899745e16a923966d41f9384a7",
            "patch": "@@ -36,7 +36,7 @@ import {I18nContext} from './i18n/context';\n import {createGoogleGetMsgStatements} from './i18n/get_msg_utils';\n import {createLocalizeStatements} from './i18n/localize_utils';\n import {I18nMetaVisitor} from './i18n/meta';\n-import {assembleBoundTextPlaceholders, assembleI18nBoundString, declareI18nVariable, getTranslationConstPrefix, hasI18nMeta, I18N_ICU_MAPPING_PREFIX, i18nFormatPlaceholderNames, icuFromI18nMessage, isI18nRootNode, isSingleI18nIcu, placeholdersToParams, TRANSLATION_PREFIX, wrapI18nPlaceholder} from './i18n/util';\n+import {assembleBoundTextPlaceholders, assembleI18nBoundString, declareI18nVariable, getTranslationConstPrefix, hasI18nMeta, I18N_ICU_MAPPING_PREFIX, i18nFormatPlaceholderNames, icuFromI18nMessage, isI18nRootNode, isSingleI18nIcu, placeholdersToParams, TRANSLATION_VAR_PREFIX, wrapI18nPlaceholder} from './i18n/util';\n import {StylingBuilder, StylingInstruction} from './styling_builder';\n import {asLiteral, chainedInstruction, CONTEXT_NAME, getAttrsForDirectiveMatching, getInterpolationArgsLength, IMPLICIT_REFERENCE, invalid, NON_BINDABLE_ATTR, REFERENCE_PREFIX, RENDER_FLAGS, trimTrailingNulls, unsupported} from './util';\n \n@@ -103,6 +103,18 @@ export function prepareEventListenerParameters(\n   return params;\n }\n \n+// Collects information needed to generate `consts` field of the ComponentDef.\n+// When a constant requires some pre-processing, the `prepareStatements` section\n+// contains corresponding statements.\n+export interface ComponentDefConsts {\n+  prepareStatements: o.Statement[];\n+  constExpressions: o.Expression[];\n+}\n+\n+function createComponentDefConsts(): ComponentDefConsts {\n+  return {prepareStatements: [], constExpressions: []};\n+}\n+\n export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver {\n   private _dataIndex = 0;\n   private _bindingContext = 0;\n@@ -171,7 +183,8 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n       private directiveMatcher: SelectorMatcher|null, private directives: Set<o.Expression>,\n       private pipeTypeByName: Map<string, o.Expression>, private pipes: Set<o.Expression>,\n       private _namespace: o.ExternalReference, relativeContextFilePath: string,\n-      private i18nUseExternalIds: boolean, private _constants: o.Expression[] = []) {\n+      private i18nUseExternalIds: boolean,\n+      private _constants: ComponentDefConsts = createComponentDefConsts()) {\n     this._bindingScope = parentBindingScope.nestedScope(level);\n \n     // Turn the relative context file path into an identifier by replacing non-alphanumeric\n@@ -307,12 +320,12 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n   private i18nTranslate(\n       message: i18n.Message, params: {[name: string]: o.Expression} = {}, ref?: o.ReadVarExpr,\n       transformFn?: (raw: o.ReadVarExpr) => o.Expression): o.ReadVarExpr {\n-    const _ref = ref || o.variable(this.constantPool.uniqueName(TRANSLATION_PREFIX));\n+    const _ref = ref || this.i18nGenerateMainBlockVar();\n     // Closure Compiler requires const names to start with `MSG_` but disallows any other const to\n     // start with `MSG_`. We define a variable starting with `MSG_` just for the `goog.getMsg` call\n     const closureVar = this.i18nGenerateClosureVar(message.id);\n     const statements = getTranslationDeclStmts(message, _ref, closureVar, params, transformFn);\n-    this.constantPool.statements.push(...statements);\n+    this._constants.prepareStatements.push(...statements);\n     return _ref;\n   }\n \n@@ -364,6 +377,12 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n     return bound;\n   }\n \n+  // Generates top level vars for i18n blocks (i.e. `i18n_N`).\n+  private i18nGenerateMainBlockVar(): o.ReadVarExpr {\n+    return o.variable(this.constantPool.uniqueName(TRANSLATION_VAR_PREFIX));\n+  }\n+\n+  // Generates vars with Closure-specific names for i18n blocks (i.e. `MSG_XXX`).\n   private i18nGenerateClosureVar(messageId: string): o.ReadVarExpr {\n     let name: string;\n     const suffix = this.fileBasedI18nSuffix.toUpperCase();\n@@ -426,16 +445,13 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n   private i18nStart(span: ParseSourceSpan|null = null, meta: i18n.I18nMeta, selfClosing?: boolean):\n       void {\n     const index = this.allocateDataSlot();\n-    if (this.i18nContext) {\n-      this.i18n = this.i18nContext.forkChildContext(index, this.templateIndex!, meta);\n-    } else {\n-      const ref = o.variable(this.constantPool.uniqueName(TRANSLATION_PREFIX));\n-      this.i18n = new I18nContext(index, ref, 0, this.templateIndex, meta);\n-    }\n+    this.i18n = this.i18nContext ?\n+        this.i18nContext.forkChildContext(index, this.templateIndex!, meta) :\n+        new I18nContext(index, this.i18nGenerateMainBlockVar(), 0, this.templateIndex, meta);\n \n     // generate i18nStart instruction\n     const {id, ref} = this.i18n;\n-    const params: o.Expression[] = [o.literal(index), ref];\n+    const params: o.Expression[] = [o.literal(index), this.addToConsts(ref)];\n     if (id > 0) {\n       // do not push 3rd argument (sub-block id)\n       // into i18nStart call for top level i18n context\n@@ -507,8 +523,8 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n     }\n     if (i18nAttrArgs.length > 0) {\n       const index: o.Expression = o.literal(this.allocateDataSlot());\n-      const args = this.constantPool.getConstLiteral(o.literalArr(i18nAttrArgs), true);\n-      this.creationInstruction(sourceSpan, R3.i18nAttributes, [index, args]);\n+      const constIndex = this.addToConsts(o.literalArr(i18nAttrArgs));\n+      this.creationInstruction(sourceSpan, R3.i18nAttributes, [index, constIndex]);\n       if (hasBindings) {\n         this.updateInstruction(sourceSpan, R3.i18nApply, [index]);\n       }\n@@ -1028,7 +1044,7 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n     return this._pureFunctionSlots;\n   }\n \n-  getConsts() {\n+  getConsts(): ComponentDefConsts {\n     return this._constants;\n   }\n \n@@ -1352,14 +1368,16 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n       return o.TYPED_NULL_EXPR;\n     }\n \n+    const consts = this._constants.constExpressions;\n+\n     // Try to reuse a literal that's already in the array, if possible.\n-    for (let i = 0; i < this._constants.length; i++) {\n-      if (this._constants[i].isEquivalent(expression)) {\n+    for (let i = 0; i < consts.length; i++) {\n+      if (consts[i].isEquivalent(expression)) {\n         return o.literal(i);\n       }\n     }\n \n-    return o.literal(this._constants.push(expression) - 1);\n+    return o.literal(consts.push(expression) - 1);\n   }\n \n   private addAttrsToConsts(attrs: o.Expression[]): o.LiteralExpr {"
        },
        {
            "sha": "5b528ded1c90669553e1ba88c1534c18e3c2c404",
            "filename": "packages/core/src/render3/definition.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Fsrc%2Frender3%2Fdefinition.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Fsrc%2Frender3%2Fdefinition.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fdefinition.ts?ref=cb05c0102fc951899745e16a923966d41f9384a7",
            "patch": "@@ -18,7 +18,7 @@ import {stringify} from '../util/stringify';\n import {EMPTY_ARRAY, EMPTY_OBJ} from './empty';\n import {NG_COMP_DEF, NG_DIR_DEF, NG_FACTORY_DEF, NG_LOC_ID_DEF, NG_MOD_DEF, NG_PIPE_DEF} from './fields';\n import {ComponentDef, ComponentDefFeature, ComponentTemplate, ComponentType, ContentQueriesFunction, DirectiveDef, DirectiveDefFeature, DirectiveTypesOrFactory, FactoryFn, HostBindingsFunction, PipeDef, PipeType, PipeTypesOrFactory, ViewQueriesFunction} from './interfaces/definition';\n-import {AttributeMarker, TAttributes, TConstants} from './interfaces/node';\n+import {AttributeMarker, TAttributes, TConstantsOrFactory} from './interfaces/node';\n import {CssSelectorList, SelectorFlags} from './interfaces/projection';\n import {NgModuleType} from './ng_module_ref';\n \n@@ -220,7 +220,7 @@ export function ɵɵdefineComponent<T>(componentDefinition: {\n    * Constants for the nodes in the component's view.\n    * Includes attribute arrays, local definition arrays etc.\n    */\n-  consts?: TConstants;\n+  consts?: TConstantsOrFactory;\n \n   /**\n    * An array of `ngContent[selector]` values that were found in the template."
        },
        {
            "sha": "afaa3209c4a3202d50adec1699353af49ba98853",
            "filename": "packages/core/src/render3/instructions/i18n.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fi18n.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fi18n.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fi18n.ts?ref=cb05c0102fc951899745e16a923966d41f9384a7",
            "patch": "@@ -15,6 +15,7 @@ import {i18nAttributesFirstPass, i18nStartFirstPass} from '../i18n/i18n_parse';\n import {i18nPostprocess} from '../i18n/i18n_postprocess';\n import {HEADER_OFFSET} from '../interfaces/view';\n import {getLView, getTView, nextBindingIndex} from '../state';\n+import {getConstant} from '../util/view_utils';\n \n import {setDelayProjection} from './all';\n \n@@ -42,14 +43,15 @@ import {setDelayProjection} from './all';\n  *   `template` instruction index. A `block` that matches the sub-template in which it was declared.\n  *\n  * @param index A unique index of the translation in the static block.\n- * @param message The translation message.\n+ * @param messageIndex An index of the translation message from the `def.consts` array.\n  * @param subTemplateIndex Optional sub-template index in the `message`.\n  *\n  * @codeGenApi\n  */\n-export function ɵɵi18nStart(index: number, message: string, subTemplateIndex?: number): void {\n+export function ɵɵi18nStart(index: number, messageIndex: number, subTemplateIndex?: number): void {\n   const tView = getTView();\n   ngDevMode && assertDefined(tView, `tView should be defined`);\n+  const message = getConstant<string>(tView.consts, messageIndex)!;\n   pushI18nIndex(index);\n   // We need to delay projections until `i18nEnd`\n   setDelayProjection(true);\n@@ -96,13 +98,13 @@ export function ɵɵi18nEnd(): void {\n  *   `template` instruction index. A `block` that matches the sub-template in which it was declared.\n  *\n  * @param index A unique index of the translation in the static block.\n- * @param message The translation message.\n+ * @param messageIndex An index of the translation message from the `def.consts` array.\n  * @param subTemplateIndex Optional sub-template index in the `message`.\n  *\n  * @codeGenApi\n  */\n-export function ɵɵi18n(index: number, message: string, subTemplateIndex?: number): void {\n-  ɵɵi18nStart(index, message, subTemplateIndex);\n+export function ɵɵi18n(index: number, messageIndex: number, subTemplateIndex?: number): void {\n+  ɵɵi18nStart(index, messageIndex, subTemplateIndex);\n   ɵɵi18nEnd();\n }\n \n@@ -114,11 +116,12 @@ export function ɵɵi18n(index: number, message: string, subTemplateIndex?: numb\n  *\n  * @codeGenApi\n  */\n-export function ɵɵi18nAttributes(index: number, values: string[]): void {\n+export function ɵɵi18nAttributes(index: number, attrsIndex: number): void {\n   const lView = getLView();\n   const tView = getTView();\n   ngDevMode && assertDefined(tView, `tView should be defined`);\n-  i18nAttributesFirstPass(lView, tView, index, values);\n+  const attrs = getConstant<string[]>(tView.consts, attrsIndex)!;\n+  i18nAttributesFirstPass(lView, tView, index, attrs);\n }\n \n "
        },
        {
            "sha": "4addb1e83bb428147e0476041f889990914b4a9e",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=cb05c0102fc951899745e16a923966d41f9384a7",
            "patch": "@@ -26,7 +26,7 @@ import {executeCheckHooks, executeInitAndCheckHooks, incrementInitPhaseFlags} fr\n import {CONTAINER_HEADER_OFFSET, HAS_TRANSPLANTED_VIEWS, LContainer, MOVED_VIEWS} from '../interfaces/container';\n import {ComponentDef, ComponentTemplate, DirectiveDef, DirectiveDefListOrFactory, PipeDefListOrFactory, RenderFlags, ViewQueriesFunction} from '../interfaces/definition';\n import {INJECTOR_BLOOM_PARENT_SIZE, NodeInjectorFactory} from '../interfaces/injector';\n-import {AttributeMarker, InitialInputData, InitialInputs, LocalRefExtractor, PropertyAliases, PropertyAliasValue, TAttributes, TConstants, TContainerNode, TDirectiveHostNode, TElementContainerNode, TElementNode, TIcuContainerNode, TNode, TNodeFlags, TNodeProviderIndexes, TNodeType, TProjectionNode, TViewNode} from '../interfaces/node';\n+import {AttributeMarker, InitialInputData, InitialInputs, LocalRefExtractor, PropertyAliases, PropertyAliasValue, TAttributes, TConstantsOrFactory, TContainerNode, TDirectiveHostNode, TElementContainerNode, TElementNode, TIcuContainerNode, TNode, TNodeFlags, TNodeProviderIndexes, TNodeType, TProjectionNode, TViewNode} from '../interfaces/node';\n import {isProceduralRenderer, RComment, RElement, Renderer3, RendererFactory3, RNode, RText} from '../interfaces/renderer';\n import {SanitizerFn} from '../interfaces/sanitization';\n import {isComponentDef, isComponentHost, isContentQueryHost, isLContainer, isRootView} from '../interfaces/type_checks';\n@@ -650,14 +650,15 @@ export function createTView(\n     type: TViewType, viewIndex: number, templateFn: ComponentTemplate<any>|null, decls: number,\n     vars: number, directives: DirectiveDefListOrFactory|null, pipes: PipeDefListOrFactory|null,\n     viewQuery: ViewQueriesFunction<any>|null, schemas: SchemaMetadata[]|null,\n-    consts: TConstants|null): TView {\n+    constsOrFactory: TConstantsOrFactory|null): TView {\n   ngDevMode && ngDevMode.tView++;\n   const bindingStartIndex = HEADER_OFFSET + decls;\n   // This length does not yet contain host bindings from child directives because at this point,\n   // we don't know which directives are active on this template. As soon as a directive is matched\n   // that has a host binding, we will update the blueprint with that def's hostVars count.\n   const initialViewLength = bindingStartIndex + vars;\n   const blueprint = createViewBlueprint(bindingStartIndex, initialViewLength);\n+  const consts = typeof constsOrFactory === 'function' ? constsOrFactory() : constsOrFactory;\n   const tView = blueprint[TVIEW as any] = ngDevMode ?\n       new TViewConstructor(\n           type,"
        },
        {
            "sha": "c8de2c50e4eea260a6b6a1282a65475f147a7b3f",
            "filename": "packages/core/src/render3/interfaces/definition.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fdefinition.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fdefinition.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fdefinition.ts?ref=cb05c0102fc951899745e16a923966d41f9384a7",
            "patch": "@@ -10,7 +10,7 @@ import {SchemaMetadata, ViewEncapsulation} from '../../core';\n import {ProcessProvidersFunction} from '../../di/interface/provider';\n import {Type} from '../../interface/type';\n \n-import {TAttributes, TConstants} from './node';\n+import {TAttributes, TConstantsOrFactory} from './node';\n import {CssSelectorList} from './projection';\n import {TView} from './view';\n \n@@ -299,7 +299,7 @@ export interface ComponentDef<T> extends DirectiveDef<T> {\n   readonly template: ComponentTemplate<T>;\n \n   /** Constants associated with the component's view. */\n-  readonly consts: TConstants|null;\n+  readonly consts: TConstantsOrFactory|null;\n \n   /**\n    * An array of `ngContent[selector]` values that were found in the template."
        },
        {
            "sha": "22d974478621ca75b21e2dea266da196090eec8b",
            "filename": "packages/core/src/render3/interfaces/node.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fnode.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fnode.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fnode.ts?ref=cb05c0102fc951899745e16a923966d41f9384a7",
            "patch": "@@ -255,9 +255,24 @@ export type TAttributes = (string|AttributeMarker|CssSelector)[];\n  * Constants that are associated with a view. Includes:\n  * - Attribute arrays.\n  * - Local definition arrays.\n+ * - Translated messages (i18n).\n  */\n export type TConstants = (TAttributes|string)[];\n \n+/**\n+ * Factory function that returns an array of consts. Consts can be represented as a function in case\n+ * any additional statements are required to define consts in the list. An example is i18n where\n+ * additional i18n calls are generated, which should be executed when consts are requested for the\n+ * first time.\n+ */\n+export type TConstantsFactory = () => TConstants;\n+\n+/**\n+ * TConstants type that describes how the `consts` field is generated on ComponentDef: it can be\n+ * either an array or a factory function that returns that array.\n+ */\n+export type TConstantsOrFactory = TConstants|TConstantsFactory;\n+\n /**\n  * Binding data (flyweight) for a particular node that is shared between all templates\n  * of a specific type."
        },
        {
            "sha": "238a3a0d49bdf704b45e3aaf0420f16bcc4f9706",
            "filename": "packages/core/test/render3/i18n_spec.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 61,
            "changes": 114,
            "blob_url": "https://github.com/angular/angular/blob/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Ftest%2Frender3%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb05c0102fc951899745e16a923966d41f9384a7/packages%2Fcore%2Ftest%2Frender3%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fi18n_spec.ts?ref=cb05c0102fc951899745e16a923966d41f9384a7",
            "patch": "@@ -12,6 +12,7 @@ import {getTranslationForTemplate} from '@angular/core/src/render3/i18n/i18n_par\n import {noop} from '../../../compiler/src/render3/view/util';\n import {setDelayProjection, ɵɵelementEnd, ɵɵelementStart} from '../../src/render3/instructions/all';\n import {I18nUpdateOpCodes, TI18n, TIcu} from '../../src/render3/interfaces/i18n';\n+import {TConstants} from '../../src/render3/interfaces/node';\n import {HEADER_OFFSET, LView, TVIEW} from '../../src/render3/interfaces/view';\n import {getNativeByIndex} from '../../src/render3/util/view_utils';\n \n@@ -57,26 +58,29 @@ describe('Runtime i18n', () => {\n   });\n \n   function prepareFixture(\n-      createTemplate: () => void, updateTemplate: (() => void)|null, nbConsts = 0,\n-      nbVars = 0): TemplateFixture {\n-    return new TemplateFixture(createTemplate, updateTemplate || noop, nbConsts, nbVars);\n+      createTemplate: () => void, updateTemplate: (() => void)|null, nbConsts = 0, nbVars = 0,\n+      consts: TConstants = []): TemplateFixture {\n+    return new TemplateFixture(\n+        createTemplate, updateTemplate || noop, nbConsts, nbVars, null, null, null, undefined,\n+        consts);\n   }\n \n   function getOpCodes(\n-      createTemplate: () => void, updateTemplate: (() => void)|null, nbConsts: number,\n-      index: number): TI18n|I18nUpdateOpCodes {\n-    const fixture = prepareFixture(createTemplate, updateTemplate, nbConsts);\n+      messageOrAtrs: string|string[], createTemplate: () => void, updateTemplate: (() => void)|null,\n+      nbConsts: number, index: number): TI18n|I18nUpdateOpCodes {\n+    const fixture =\n+        prepareFixture(createTemplate, updateTemplate, nbConsts, undefined, [messageOrAtrs]);\n     const tView = fixture.hostView[TVIEW];\n     return tView.data[index + HEADER_OFFSET] as TI18n;\n   }\n \n   describe('i18nStart', () => {\n     it('for text', () => {\n-      const MSG_DIV = `simple text`;\n+      const message = 'simple text';\n       const nbConsts = 1;\n       const index = 0;\n-      const opCodes = getOpCodes(() => {\n-                        ɵɵi18nStart(index, MSG_DIV);\n+      const opCodes = getOpCodes(message, () => {\n+                        ɵɵi18nStart(index, 0);\n                       }, null, nbConsts, index) as TI18n;\n \n       expect(opCodes).toEqual({\n@@ -91,13 +95,13 @@ describe('Runtime i18n', () => {\n     });\n \n     it('for elements', () => {\n-      const MSG_DIV = `Hello �#2�world�/#2� and �#3�universe�/#3�!`;\n+      const message = `Hello �#2�world�/#2� and �#3�universe�/#3�!`;\n       // Template: `<div>Hello <div>world</div> and <span>universe</span>!`\n       // 3 consts for the 2 divs and 1 span + 1 const for `i18nStart` = 4 consts\n       const nbConsts = 4;\n       const index = 1;\n-      const opCodes = getOpCodes(() => {\n-        ɵɵi18nStart(index, MSG_DIV);\n+      const opCodes = getOpCodes(message, () => {\n+        ɵɵi18nStart(index, 0);\n       }, null, nbConsts, index);\n \n       expect(opCodes).toEqual({\n@@ -124,11 +128,11 @@ describe('Runtime i18n', () => {\n     });\n \n     it('for simple bindings', () => {\n-      const MSG_DIV = `Hello �0�!`;\n+      const message = `Hello �0�!`;\n       const nbConsts = 2;\n       const index = 1;\n-      const opCodes = getOpCodes(() => {\n-        ɵɵi18nStart(index, MSG_DIV);\n+      const opCodes = getOpCodes(message, () => {\n+        ɵɵi18nStart(index, 0);\n       }, null, nbConsts, index);\n \n       expect((opCodes as any).update.debug).toEqual([\n@@ -148,11 +152,11 @@ describe('Runtime i18n', () => {\n     });\n \n     it('for multiple bindings', () => {\n-      const MSG_DIV = `Hello �0� and �1�, again �0�!`;\n+      const message = `Hello �0� and �1�, again �0�!`;\n       const nbConsts = 2;\n       const index = 1;\n-      const opCodes = getOpCodes(() => {\n-        ɵɵi18nStart(index, MSG_DIV);\n+      const opCodes = getOpCodes(message, () => {\n+        ɵɵi18nStart(index, 0);\n       }, null, nbConsts, index);\n \n       expect(opCodes).toEqual({\n@@ -176,17 +180,15 @@ describe('Runtime i18n', () => {\n       //   </span>\n       //   !\n       // </div>\n-      const MSG_DIV =\n+      const message =\n           `�0� is rendered as: �*2:1��#1:1�before�*2:2��#1:2�middle�/#1:2��/*2:2�after�/#1:1��/*2:1�!`;\n \n       /**** Root template ****/\n       // �0� is rendered as: �*2:1��/*2:1�!\n       let nbConsts = 3;\n       let index = 1;\n-      const firstTextNode = 3;\n-      const rootTemplate = 2;\n-      let opCodes = getOpCodes(() => {\n-        ɵɵi18nStart(index, MSG_DIV);\n+      let opCodes = getOpCodes(message, () => {\n+        ɵɵi18nStart(index, 0);\n       }, null, nbConsts, index);\n \n       expect(opCodes).toEqual({\n@@ -207,10 +209,8 @@ describe('Runtime i18n', () => {\n       // �#1:1�before�*2:2�middle�/*2:2�after�/#1:1�\n       nbConsts = 3;\n       index = 0;\n-      const spanElement = 1;\n-      const bElementSubTemplate = 2;\n-      opCodes = getOpCodes(() => {\n-        ɵɵi18nStart(index, MSG_DIV, 1);\n+      opCodes = getOpCodes(message, () => {\n+        ɵɵi18nStart(index, 0, 1);\n       }, null, nbConsts, index);\n \n       expect(opCodes).toEqual({\n@@ -233,9 +233,8 @@ describe('Runtime i18n', () => {\n       // middle\n       nbConsts = 2;\n       index = 0;\n-      const bElement = 1;\n-      opCodes = getOpCodes(() => {\n-        ɵɵi18nStart(index, MSG_DIV, 2);\n+      opCodes = getOpCodes(message, () => {\n+        ɵɵi18nStart(index, 0, 2);\n       }, null, nbConsts, index);\n \n       expect(opCodes).toEqual({\n@@ -252,15 +251,15 @@ describe('Runtime i18n', () => {\n     });\n \n     it('for ICU expressions', () => {\n-      const MSG_DIV = `{�0�, plural,\n+      const message = `{�0�, plural,\n         =0 {no <b title=\"none\">emails</b>!}\n         =1 {one <i>email</i>}\n         other {�0� <span title=\"�1�\">emails</span>}\n       }`;\n       const nbConsts = 1;\n       const index = 0;\n-      const opCodes = getOpCodes(() => {\n-                        ɵɵi18nStart(index, MSG_DIV);\n+      const opCodes = getOpCodes(message, () => {\n+                        ɵɵi18nStart(index, 0);\n                       }, null, nbConsts, index) as TI18n;\n \n       expect(opCodes).toEqual({\n@@ -337,7 +336,7 @@ describe('Runtime i18n', () => {\n     });\n \n     it('for nested ICU expressions', () => {\n-      const MSG_DIV = `{�0�, plural,\n+      const message = `{�0�, plural,\n         =0 {zero}\n         other {�0� {�1�, select,\n                        cat {cats}\n@@ -347,16 +346,9 @@ describe('Runtime i18n', () => {\n       }`;\n       const nbConsts = 1;\n       const index = 0;\n-      const opCodes = getOpCodes(() => {\n-        ɵɵi18nStart(index, MSG_DIV);\n+      const opCodes = getOpCodes(message, () => {\n+        ɵɵi18nStart(index, 0);\n       }, null, nbConsts, index);\n-      const icuCommentNodeIndex = index + 1;\n-      const firstTextNodeIndex = index + 2;\n-      const nestedIcuCommentNodeIndex = index + 3;\n-      const lastTextNodeIndex = index + 4;\n-      const nestedTextNodeIndex = index + 5;\n-      const tIcuIndex = 1;\n-      const nestedTIcuIndex = 0;\n \n       expect(opCodes).toEqual({\n         vars: 9,\n@@ -443,31 +435,31 @@ describe('Runtime i18n', () => {\n \n   describe(`i18nAttribute`, () => {\n     it('for text', () => {\n-      const MSG_title = `Hello world!`;\n-      const MSG_div_attr = ['title', MSG_title];\n+      const message = `Hello world!`;\n+      const attrs = ['title', message];\n       const nbConsts = 2;\n       const index = 1;\n       const fixture = prepareFixture(() => {\n         ɵɵelementStart(0, 'div');\n-        ɵɵi18nAttributes(index, MSG_div_attr);\n+        ɵɵi18nAttributes(index, 0);\n         ɵɵelementEnd();\n-      }, null, nbConsts, index);\n+      }, null, nbConsts, index, [attrs]);\n       const tView = fixture.hostView[TVIEW];\n       const opCodes = tView.data[index + HEADER_OFFSET] as I18nUpdateOpCodes;\n \n       expect(opCodes).toEqual([]);\n       expect(\n           (getNativeByIndex(0, fixture.hostView as LView) as any as Element).getAttribute('title'))\n-          .toEqual(MSG_title);\n+          .toEqual(message);\n     });\n \n     it('for simple bindings', () => {\n-      const MSG_title = `Hello �0�!`;\n-      const MSG_div_attr = ['title', MSG_title];\n+      const message = `Hello �0�!`;\n+      const attrs = ['title', message];\n       const nbConsts = 2;\n       const index = 1;\n-      const opCodes = getOpCodes(() => {\n-        ɵɵi18nAttributes(index, MSG_div_attr);\n+      const opCodes = getOpCodes(attrs, () => {\n+        ɵɵi18nAttributes(index, 0);\n       }, null, nbConsts, index);\n \n       expect(opCodes).toEqual(debugMatch([\n@@ -476,12 +468,12 @@ describe('Runtime i18n', () => {\n     });\n \n     it('for multiple bindings', () => {\n-      const MSG_title = `Hello �0� and �1�, again �0�!`;\n-      const MSG_div_attr = ['title', MSG_title];\n+      const message = `Hello �0� and �1�, again �0�!`;\n+      const attrs = ['title', message];\n       const nbConsts = 2;\n       const index = 1;\n-      const opCodes = getOpCodes(() => {\n-        ɵɵi18nAttributes(index, MSG_div_attr);\n+      const opCodes = getOpCodes(attrs, () => {\n+        ɵɵi18nAttributes(index, 0);\n       }, null, nbConsts, index);\n \n       expect(opCodes).toEqual(debugMatch([\n@@ -490,12 +482,12 @@ describe('Runtime i18n', () => {\n     });\n \n     it('for multiple attributes', () => {\n-      const MSG_title = `Hello �0�!`;\n-      const MSG_div_attr = ['title', MSG_title, 'aria-label', MSG_title];\n+      const message = `Hello �0�!`;\n+      const attrs = ['title', message, 'aria-label', message];\n       const nbConsts = 2;\n       const index = 1;\n-      const opCodes = getOpCodes(() => {\n-        ɵɵi18nAttributes(index, MSG_div_attr);\n+      const opCodes = getOpCodes(attrs, () => {\n+        ɵɵi18nAttributes(index, 0);\n       }, null, nbConsts, index);\n \n       expect(opCodes).toEqual(debugMatch([\n@@ -643,4 +635,4 @@ describe('Runtime i18n', () => {\n           .toThrowError();\n     });\n   });\n-});\n+});\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 1200,
        "additions": 751,
        "deletions": 449
    }
}