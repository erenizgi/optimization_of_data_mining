{
    "author": "devversion",
    "message": "build: update postinstall script to account for local target references in dev-infra (#44490)\n\nWe are in an inconvenient situation where the ng-dev package might rely\non packages from the Angular framework repository. Given that we install\nthis package in the framework repository, we need to update some\nreferences through a postinstall.\n\nThis commit updates the patches to account for the latest changes in the\ndev-infra package/repository.\n\nPR Close #44490",
    "sha": "4e58a508a9c08d488fd8516bbc607eb6a1b250f2",
    "files": [
        {
            "sha": "07aaefde3469b50f3481888726e8c0dcf0a3b15a",
            "filename": "tools/postinstall-patches.js",
            "status": "modified",
            "additions": 58,
            "deletions": 12,
            "changes": 70,
            "blob_url": "https://github.com/angular/angular/blob/4e58a508a9c08d488fd8516bbc607eb6a1b250f2/tools%2Fpostinstall-patches.js",
            "raw_url": "https://github.com/angular/angular/raw/4e58a508a9c08d488fd8516bbc607eb6a1b250f2/tools%2Fpostinstall-patches.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fpostinstall-patches.js?ref=4e58a508a9c08d488fd8516bbc607eb6a1b250f2",
            "patch": "@@ -61,19 +61,65 @@ ls('node_modules/@types').filter(f => f.startsWith('babel__')).forEach(pkg => {\n   }\n });\n \n-log('\\n# patch: use local version of @angular/* and zone.js in component_benchmark from @angular/dev-infra.-private');\n-[['@npm//@angular/platform-browser', '@angular//packages/platform-browser'],\n- ['@npm//@angular/core', '@angular//packages/core'],\n- [\n-   'load\\\\(\"@npm//@angular/bazel:index.bzl\", \"ng_module\"\\\\)',\n-   'load\\(\"@angular//tools:defaults.bzl\", \"ng_module\"\\)'\n- ],\n- ['@npm//zone.js', '//packages/zone.js/bundles:zone.umd.js'],\n+log('\\n# patch: use local version of @angular/* and zone.js in Starlark files from @angular/dev-infra-private');\n \n-].forEach(([matcher, replacement]) => {\n-  sed('-i', matcher, replacement,\n-      'node_modules/@angular/dev-infra-private/bazel/benchmark/component_benchmark/component_benchmark.bzl');\n-});\n+const ngDevPatches = new Map();\n+const captureNgDevPatches = (files, patches) =>\n+    patches.forEach(p => _captureNgDevPatch(p[0], p[1], files));\n+const _captureNgDevPatch = (search, replace, files) => {\n+  for (const fileName of files) {\n+    const currentPatches = ngDevPatches.get(fileName) ?? [];\n+    ngDevPatches.set(fileName, [...currentPatches, [search, replace]]);\n+  }\n+};\n+\n+// Patches for the component benchmark rule.\n+captureNgDevPatches(\n+    [\n+      'node_modules/@angular/dev-infra-private/bazel/benchmark/component_benchmark/component_benchmark.bzl',\n+    ],\n+    [\n+      ['@npm//@angular/platform-browser', '@angular//packages/platform-browser'],\n+      ['@npm//@angular/core', '@angular//packages/core'],\n+      ['@npm//:node_modules/zone.js/bundles/zone.umd.js', '//packages/zone.js/bundles:zone.umd.js'],\n+      [\n+        'load\\\\(\"@npm//@angular/bazel:index.bzl\", \"ng_module\"\\\\)',\n+        'load\\(\"@angular//tools:defaults.bzl\", \"ng_module\"\\)'\n+      ],\n+    ]);\n+\n+// Patches for the app bundling\n+captureNgDevPatches(\n+    [\n+      'node_modules/@angular/dev-infra-private/bazel/benchmark/app_bundling/index.bzl',\n+      'node_modules/@angular/dev-infra-private/bazel/benchmark/app_bundling/esbuild.config-tmpl.mjs',\n+    ],\n+    [\n+      // The app bundle config accesses the linker entry-point as well, so we need\n+      // to request it as well.\n+      [\n+        '\"@npm//@angular/compiler-cli\"',\n+        '\"@angular//packages/compiler-cli\", \"@angular//packages/compiler-cli/linker/babel\"'\n+      ],\n+      // When these entry-points are consumed from sources within Bazel, the package exports\n+      // are not available and explicit imports (as per ECMAScript module) are needed.\n+      // This can be removed when devmode&prodmode is combined/ESM is used everywhere.\n+      [\n+        `from '@angular/compiler-cli/linker/babel'`,\n+        `from '@angular/compiler-cli/linker/babel/index.js'`\n+      ],\n+      [\n+        `from '@angular/compiler-cli/private/tooling'`,\n+        `from '@angular/compiler-cli/private/tooling.js'`\n+      ],\n+    ]);\n+\n+// Apply the captured patches for the `@angular/dev-infra-private` package.\n+for (const [fileName, patches] of ngDevPatches.entries()) {\n+  for (const patch of patches) {\n+    sed('-i', patch[0], patch[1], fileName);\n+  }\n+}\n \n log('\\n# patch: delete d.ts files referring to rxjs-compat');\n // more info in https://github.com/angular/angular/pull/33786"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 58,
        "deletions": 12
    }
}