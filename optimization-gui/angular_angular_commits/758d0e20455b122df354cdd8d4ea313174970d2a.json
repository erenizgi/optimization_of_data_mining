{
    "author": "devversion",
    "message": "refactor(dev-infra): share more github code between commands (#38656)\n\nInstead of repeating the logic for adding the github token to\na repository git url, we add a shared function for automatically\ncomputing the URls with token.\n\nAdditionally, URLs for updating/generating tokens have been moved\nto a dedicated file in the `utils` folder. Also while being at it,\nthe yargs github token helper is also moved into the dedicated\nGit/Github related util folder.\n\nPR Close #38656",
    "sha": "758d0e20455b122df354cdd8d4ea313174970d2a",
    "files": [
        {
            "sha": "19883814238c45ea8abb28b8804b7585ca4c3fc0",
            "filename": "dev-infra/caretaker/check/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fcaretaker%2Fcheck%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fcaretaker%2Fcheck%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fcli.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -8,7 +8,7 @@\n \n import {Arguments, Argv, CommandModule} from 'yargs';\n \n-import {addGithubTokenFlag} from '../../utils/yargs';\n+import {addGithubTokenOption} from '../../utils/git/github-yargs';\n \n import {checkServiceStatuses} from './check';\n \n@@ -17,12 +17,9 @@ export interface CaretakerCheckOptions {\n   githubToken: string;\n }\n \n-/** URL to the Github page where personal access tokens can be generated. */\n-export const GITHUB_TOKEN_GENERATE_URL = `https://github.com/settings/tokens`;\n-\n /** Builds the command. */\n function builder(yargs: Argv) {\n-  return addGithubTokenFlag(yargs);\n+  return addGithubTokenOption(yargs);\n }\n \n /** Handles the command. */"
        },
        {
            "sha": "1ea44bd937fefe66ef618e98d10f251a2c0121e8",
            "filename": "dev-infra/pr/checkout/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Fcheckout%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Fcheckout%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcheckout%2Fcli.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -8,7 +8,7 @@\n \n import {Arguments, Argv, CommandModule} from 'yargs';\n \n-import {addGithubTokenFlag} from '../../utils/yargs';\n+import {addGithubTokenOption} from '../../utils/git/github-yargs';\n import {checkOutPullRequestLocally} from '../common/checkout-pr';\n \n export interface CheckoutOptions {\n@@ -18,7 +18,7 @@ export interface CheckoutOptions {\n \n /** Builds the checkout pull request command. */\n function builder(yargs: Argv) {\n-  return addGithubTokenFlag(yargs).positional('prNumber', {type: 'number', demandOption: true});\n+  return addGithubTokenOption(yargs).positional('prNumber', {type: 'number', demandOption: true});\n }\n \n /** Handles the checkout pull request command. */"
        },
        {
            "sha": "dcb7be2e687344b2aac46fb7b294137612b84d52",
            "filename": "dev-infra/pr/common/checkout-pr.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -7,10 +7,10 @@\n  */\n \n import {types as graphQLTypes} from 'typed-graphqlify';\n-import {URL} from 'url';\n \n import {info} from '../../utils/console';\n import {GitClient} from '../../utils/git';\n+import {addTokenToGitHttpsUrl} from '../../utils/git/github-urls';\n import {getPr} from '../../utils/github';\n \n /* GraphQL schema for the response body for a pending PR. */\n@@ -83,7 +83,7 @@ export async function checkOutPullRequestLocally(\n   /** The full ref for the repository and branch the PR came from. */\n   const fullHeadRef = `${pr.headRef.repository.nameWithOwner}:${headRefName}`;\n   /** The full URL path of the repository the PR came from with github token as authentication. */\n-  const headRefUrl = addAuthenticationToUrl(pr.headRef.repository.url, githubToken);\n+  const headRefUrl = addTokenToGitHttpsUrl(pr.headRef.repository.url, githubToken);\n   // Note: Since we use a detached head for rebasing the PR and therefore do not have\n   // remote-tracking branches configured, we need to set our expected ref and SHA. This\n   // allows us to use `--force-with-lease` for the detached head while ensuring that we\n@@ -126,10 +126,3 @@ export async function checkOutPullRequestLocally(\n     }\n   };\n }\n-\n-/** Adds the provided token as username to the provided url. */\n-function addAuthenticationToUrl(urlString: string, token: string) {\n-  const url = new URL(urlString);\n-  url.username = token;\n-  return url.toString();\n-}"
        },
        {
            "sha": "0c2600351ae69be5e8bd56fc0f5b190699a8bfe8",
            "filename": "dev-infra/pr/merge/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Fmerge%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Fmerge%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fcli.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -8,7 +8,7 @@\n \n import {Arguments, Argv} from 'yargs';\n \n-import {addGithubTokenFlag} from '../../utils/yargs';\n+import {addGithubTokenOption} from '../../utils/git/github-yargs';\n \n import {mergePullRequest} from './index';\n \n@@ -20,7 +20,7 @@ export interface MergeCommandOptions {\n \n /** Builds the options for the merge command. */\n export function buildMergeCommand(yargs: Argv): Argv<MergeCommandOptions> {\n-  return addGithubTokenFlag(yargs).help().strict().positional(\n+  return addGithubTokenOption(yargs).help().strict().positional(\n       'pr-number', {demandOption: true, type: 'number'});\n }\n "
        },
        {
            "sha": "d6e1af255d2db826dad32ba04ba4f016f5680853",
            "filename": "dev-infra/pr/merge/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Fmerge%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Fmerge%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Findex.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -11,12 +11,11 @@ import {getConfig, getRepoBaseDir} from '../../utils/config';\n import {error, green, info, promptConfirm, red, yellow} from '../../utils/console';\n import {GitClient} from '../../utils/git';\n import {GithubApiRequestError} from '../../utils/git/github';\n-import {GITHUB_TOKEN_GENERATE_URL} from '../../utils/yargs';\n+import {GITHUB_TOKEN_GENERATE_URL} from '../../utils/git/github-urls';\n \n import {loadAndValidateConfig, MergeConfigWithRemote} from './config';\n import {MergeResult, MergeStatus, PullRequestMergeTask} from './task';\n \n-\n /**\n  * Merges a given pull request based on labels configured in the given merge configuration.\n  * Pull requests can be merged with different strategies such as the Github API merge"
        },
        {
            "sha": "6b1c0c05f128edca478a684d5f98808430501afd",
            "filename": "dev-infra/pr/rebase/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Frebase%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Frebase%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Frebase%2Fcli.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -8,7 +8,7 @@\n \n import {Arguments, Argv} from 'yargs';\n \n-import {addGithubTokenFlag} from '../../utils/yargs';\n+import {addGithubTokenOption} from '../../utils/git/github-yargs';\n \n import {rebasePr} from './index';\n \n@@ -20,7 +20,7 @@ export interface RebaseCommandOptions {\n \n /** Builds the rebase pull request command. */\n export function buildRebaseCommand(yargs: Argv): Argv<RebaseCommandOptions> {\n-  return addGithubTokenFlag(yargs).positional('prNumber', {type: 'number', demandOption: true});\n+  return addGithubTokenOption(yargs).positional('prNumber', {type: 'number', demandOption: true});\n }\n \n /** Handles the rebase pull request command. */"
        },
        {
            "sha": "b79abb2a100b4cf430df55137d7e3c9b48969c4d",
            "filename": "dev-infra/pr/rebase/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 9,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Frebase%2Findex.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -12,6 +12,7 @@ import {URL} from 'url';\n import {getConfig, NgDevConfig} from '../../utils/config';\n import {error, info, promptConfirm} from '../../utils/console';\n import {GitClient} from '../../utils/git';\n+import {addTokenToGitHttpsUrl} from '../../utils/git/github-urls';\n import {getPr} from '../../utils/github';\n \n /* GraphQL schema for the response body for each pending PR. */\n@@ -61,8 +62,8 @@ export async function rebasePr(\n   const baseRefName = pr.baseRef.name;\n   const fullHeadRef = `${pr.headRef.repository.nameWithOwner}:${headRefName}`;\n   const fullBaseRef = `${pr.baseRef.repository.nameWithOwner}:${baseRefName}`;\n-  const headRefUrl = addAuthenticationToUrl(pr.headRef.repository.url, githubToken);\n-  const baseRefUrl = addAuthenticationToUrl(pr.baseRef.repository.url, githubToken);\n+  const headRefUrl = addTokenToGitHttpsUrl(pr.headRef.repository.url, githubToken);\n+  const baseRefUrl = addTokenToGitHttpsUrl(pr.baseRef.repository.url, githubToken);\n \n   // Note: Since we use a detached head for rebasing the PR and therefore do not have\n   // remote-tracking branches configured, we need to set our expected ref and SHA. This\n@@ -140,10 +141,3 @@ export async function rebasePr(\n     git.runGraceful(['checkout', previousBranchOrRevision], {stdio: 'ignore'});\n   }\n }\n-\n-/** Adds the provided token as username to the provided url. */\n-function addAuthenticationToUrl(urlString: string, token: string) {\n-  const url = new URL(urlString);\n-  url.username = token;\n-  return url.toString();\n-}"
        },
        {
            "sha": "1e6a3735f78a4bf51bb3c6ff22d33b5302b327ca",
            "filename": "dev-infra/utils/git/github-urls.ts",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Futils%2Fgit%2Fgithub-urls.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Futils%2Fgit%2Fgithub-urls.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub-urls.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -0,0 +1,36 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+\n+import {URL} from 'url';\n+import {GithubConfig} from '../config';\n+\n+/** URL to the Github page where personal access tokens can be managed. */\n+export const GITHUB_TOKEN_SETTINGS_URL = `https://github.com/settings/tokens`;\n+\n+/** URL to the Github page where personal access tokens can be generated. */\n+export const GITHUB_TOKEN_GENERATE_URL = `https://github.com/settings/tokens/new`;\n+\n+/** Adds the provided token to the given Github HTTPs remote url. */\n+export function addTokenToGitHttpsUrl(githubHttpsUrl: string, token: string) {\n+  const url = new URL(githubHttpsUrl);\n+  url.username = token;\n+  return url.toString();\n+}\n+\n+/** Gets the repository Git URL for the given github config. */\n+export function getRepositoryGitUrl(config: GithubConfig, githubToken?: string): string {\n+  if (config.useSsh) {\n+    return `git@github.com:${config.owner}/${config.name}.git`;\n+  }\n+  const baseHttpUrl = `https://github.com/${config.owner}/${config.name}.git`;\n+  if (githubToken !== undefined) {\n+    return addTokenToGitHttpsUrl(baseHttpUrl, githubToken);\n+  }\n+  return baseHttpUrl;\n+}"
        },
        {
            "sha": "ecd615d57e400dc1305b139c38d4f95f29113813",
            "filename": "dev-infra/utils/git/github-yargs.ts",
            "status": "renamed",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Futils%2Fgit%2Fgithub-yargs.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Futils%2Fgit%2Fgithub-yargs.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub-yargs.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -7,11 +7,13 @@\n  */\n \n import {Argv} from 'yargs';\n-import {error, red, yellow} from './console';\n+import {error, red, yellow} from '../console';\n+import {GITHUB_TOKEN_GENERATE_URL} from './github-urls';\n \n export type ArgvWithGithubToken = Argv<{githubToken: string}>;\n \n-export function addGithubTokenFlag(yargs: Argv): ArgvWithGithubToken {\n+/** Sets up the `github-token` command option for the given Yargs instance. */\n+export function addGithubTokenOption(yargs: Argv): ArgvWithGithubToken {\n   return yargs\n       // 'github-token' is casted to 'githubToken' to properly set up typings to reflect the key in\n       // the Argv object being camelCase rather than kebob case due to the `camel-case-expansion`\n@@ -32,6 +34,3 @@ export function addGithubTokenFlag(yargs: Argv): ArgvWithGithubToken {\n       })\n       .default('github-token' as 'githubToken', '', '<LOCAL TOKEN>');\n }\n-\n-/** URL to the Github page where personal access tokens can be generated. */\n-export const GITHUB_TOKEN_GENERATE_URL = 'https://github.com/settings/tokens/new';",
            "previous_filename": "dev-infra/utils/yargs.ts"
        },
        {
            "sha": "158bd66775c372a5dd6bed980f2084a4f65f30b5",
            "filename": "dev-infra/utils/git/github.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Futils%2Fgit%2Fgithub.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Futils%2Fgit%2Fgithub.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -84,7 +84,6 @@ class GithubGraphqlClient {\n     }\n   }\n \n-\n   /** Perform a query using Github's GraphQL API. */\n   async query<T extends GraphQLQueryObject>(queryObject: T, params: RequestParameters = {}) {\n     const queryString = query(queryObject);"
        },
        {
            "sha": "c533c75575792ade0a8c7917f62ef7d60786495f",
            "filename": "dev-infra/utils/git/index.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 10,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Futils%2Fgit%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/758d0e20455b122df354cdd8d4ea313174970d2a/dev-infra%2Futils%2Fgit%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Findex.ts?ref=758d0e20455b122df354cdd8d4ea313174970d2a",
            "patch": "@@ -12,6 +12,7 @@ import {spawnSync, SpawnSyncOptions, SpawnSyncReturns} from 'child_process';\n import {getConfig, getRepoBaseDir, NgDevConfig} from '../config';\n import {info, yellow} from '../console';\n import {GithubClient} from './github';\n+import {getRepositoryGitUrl, GITHUB_TOKEN_GENERATE_URL, GITHUB_TOKEN_SETTINGS_URL} from './github-urls';\n \n /** Github response type extended to include the `x-oauth-scopes` headers presence. */\n type RateLimitResponseWithOAuthScopeHeader = Octokit.Response<Octokit.RateLimitGetResponse>&{\n@@ -45,11 +46,8 @@ export class GitClient {\n   remoteConfig = this._config.github;\n   /** Octokit request parameters object for targeting the configured remote. */\n   remoteParams = {owner: this.remoteConfig.owner, repo: this.remoteConfig.name};\n-  /** URL that resolves to the configured repository. */\n-  repoGitUrl = this.remoteConfig.useSsh ?\n-      `git@github.com:${this.remoteConfig.owner}/${this.remoteConfig.name}.git` :\n-      `https://${this._githubToken}@github.com/${this.remoteConfig.owner}/${\n-          this.remoteConfig.name}.git`;\n+  /** Git URL that resolves to the configured repository. */\n+  repoGitUrl = getRepositoryGitUrl(this.remoteConfig, this._githubToken);\n   /** Instance of the authenticated Github octokit API. */\n   github = new GithubClient(this._githubToken);\n \n@@ -191,8 +189,8 @@ export class GitClient {\n         `The provided <TOKEN> does not have required permissions due to missing scope(s): ` +\n         `${yellow(missingScopes.join(', '))}\\n\\n` +\n         `Update the token in use at:\\n` +\n-        `  https://github.com/settings/tokens\\n\\n` +\n-        `Alternatively, a new token can be created at: https://github.com/settings/tokens/new\\n`;\n+        `  ${GITHUB_TOKEN_SETTINGS_URL}\\n\\n` +\n+        `Alternatively, a new token can be created at: ${GITHUB_TOKEN_GENERATE_URL}\\n`;\n \n     return {error};\n   }\n@@ -202,12 +200,12 @@ export class GitClient {\n    **/\n   private async getAuthScopesForToken() {\n     // If the OAuth scopes have already been loaded, return the Promise containing them.\n-    if (this._oauthScopes !== null) {\n-      return this._oauthScopes;\n+    if (this._cachedOauthScopes !== null) {\n+      return this._cachedOauthScopes;\n     }\n     // OAuth scopes are loaded via the /rate_limit endpoint to prevent\n     // usage of a request against that rate_limit for this lookup.\n-    return this._oauthScopes = this.github.rateLimit.get().then(_response => {\n+    return this._cachedOauthScopes = this.github.rateLimit.get().then(_response => {\n       const response = _response as RateLimitResponseWithOAuthScopeHeader;\n       const scopes: string = response.headers['x-oauth-scopes'] || '';\n       return scopes.split(',').map(scope => scope.trim());"
        }
    ],
    "stats": {
        "total": 109,
        "additions": 62,
        "deletions": 47
    }
}