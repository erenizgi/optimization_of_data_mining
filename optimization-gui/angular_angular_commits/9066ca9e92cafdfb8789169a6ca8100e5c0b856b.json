{
    "author": "petebacondarwin",
    "message": "test(compiler-cli): add support for source-map checks in compliance tests (#39939)\n\nThis commit allows compliance test-cases to be written that specify\nsource-map mappings between the source and generated code.\n\nTo check a mapping, add a `// SOURCE:` comment to the end of a line:\n\n```\n<generated code> // SOURCE: \"<source-url>\" <source code>\n```\n\nThe generated code will still be checked, stripped of the `// SOURCE` comment,\nas normal by the `expectEmit()` helper.\n\nIn addition, the source-map segments are checked to ensure that there is a\nmapping from `<generated code>` to `<source code>` found in the file at\n`<source-url>`.\n\nNote:\n\n* The source-url should be absolute, with the directory containing the\n  TEST_CASES.json file assumed to be `/`.\n* Whitespace is important and will be included when comparing the segments.\n* There is a single space character between each part of the line.\n* Newlines within a mapping must be escaped since the mapping and comment\n  must all appear on a single line of this file.\n\nPR Close #39939",
    "sha": "9066ca9e92cafdfb8789169a6ca8100e5c0b856b",
    "files": [
        {
            "sha": "c34623e74956e40f0b95deede84e9d99c0c0015f",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Findex.ts?ref=9066ca9e92cafdfb8789169a6ca8100e5c0b856b",
            "patch": "@@ -7,4 +7,4 @@\n  */\n export {RawSourceMap} from './src/raw_source_map';\n export {Mapping, SourceFile} from './src/source_file';\n-export {SourceFileLoader} from './src/source_file_loader';\n+export {MapAndPath, SourceFileLoader} from './src/source_file_loader';"
        },
        {
            "sha": "cc2b45f517d1ac95512b123fd9025b459bf9d306",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/src/source_file_loader.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts",
            "raw_url": "https://github.com/angular/angular/raw/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts?ref=9066ca9e92cafdfb8789169a6ca8100e5c0b856b",
            "patch": "@@ -208,7 +208,7 @@ export class SourceFileLoader {\n }\n \n /** A small helper structure that is returned from `loadSourceMap()`. */\n-interface MapAndPath {\n+export interface MapAndPath {\n   /** The path to the source map if it was external or `null` if it was inline. */\n   mapPath: AbsoluteFsPath|null;\n   /** The raw source map itself. */"
        },
        {
            "sha": "acfa605089462a961c7ea7e40bbebd26c6daf765",
            "filename": "packages/compiler-cli/test/compliance/README.md",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2FREADME.md?ref=9066ca9e92cafdfb8789169a6ca8100e5c0b856b",
            "patch": "@@ -126,6 +126,28 @@ are intelligently matched to check whether they are equivalent.\n     `__i18nMsg__('message string', [ ['placeholder', 'pair] ], { meta: 'properties'})`.\n   * Attribute markers - for example: `__AttributeMarker.Bindings__`.\n \n+### Source-map checks\n+\n+To check a mapping, add a `// SOURCE:` comment to the end of a line in an expectation file:\n+\n+```\n+<generated code> // SOURCE: \"<source-url>\" <source code>\n+```\n+\n+The generated code, stripped of the `// SOURCE: ` comment, will still be checked as normal by the\n+`expectEmit()` helper. But, prior to that, the source-map segments are checked to ensure that there\n+is a mapping from `<generated code>` to `<source code>` found in the file at `<source-url>`.\n+\n+Note:\n+\n+* The source-url should be absolute, with the directory containing the TEST_CASES.json file assumed\n+  to be `/`.\n+* Whitespace is important and will be included when comparing the segments.\n+* There is a single space character between each part of the line.\n+* Newlines within a mapping must be escaped since the mapping and comment must all appear on a\n+  single line of this file.\n+\n+\n ## Running tests\n \n The simplest way to run all the compliance tests is:"
        },
        {
            "sha": "ea2c513b987e68dd084aed1e552863cc9bc18c21",
            "filename": "packages/compiler-cli/test/compliance/linked/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2FBUILD.bazel?ref=9066ca9e92cafdfb8789169a6ca8100e5c0b856b",
            "patch": "@@ -7,6 +7,8 @@ ts_library(\n     deps = [\n         \"//packages/compiler-cli/linker/babel\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/logging\",\n+        \"//packages/compiler-cli/src/ngtsc/sourcemaps\",\n         \"//packages/compiler-cli/test/compliance/test_helpers\",\n         \"@npm//@types/babel__core\",\n     ],"
        },
        {
            "sha": "2994347cdce2574f589b82599f4ff1af621fa75a",
            "filename": "packages/compiler-cli/test/compliance/linked/linked_compile_spec.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 8,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts?ref=9066ca9e92cafdfb8789169a6ca8100e5c0b856b",
            "patch": "@@ -9,6 +9,8 @@ import {PluginObj, transformSync} from '@babel/core';\n \n import {createEs2015LinkerPlugin} from '../../../linker/babel';\n import {AbsoluteFsPath, FileSystem} from '../../../src/ngtsc/file_system';\n+import {ConsoleLogger, LogLevel} from '../../../src/ngtsc/logging';\n+import {MapAndPath, RawSourceMap, SourceFileLoader} from '../../../src/ngtsc/sourcemaps';\n import {CompileResult, getBuildOutputDirectory} from '../test_helpers/compile_test';\n import {ComplianceTest} from '../test_helpers/get_compliance_tests';\n import {parseGoldenPartial} from '../test_helpers/golden_partials';\n@@ -23,6 +25,8 @@ runTests('linked compile', linkPartials);\n  * @param test The compliance test whose partials will be linked.\n  */\n function linkPartials(fs: FileSystem, test: ComplianceTest): CompileResult {\n+  const logger = new ConsoleLogger(LogLevel.debug);\n+  const loader = new SourceFileLoader(fs, logger, {});\n   const builtDirectory = getBuildOutputDirectory(fs);\n   const linkerPlugin = createEs2015LinkerPlugin({\n     // By default we don't render legacy message ids in compliance tests.\n@@ -38,11 +42,30 @@ function linkPartials(fs: FileSystem, test: ComplianceTest): CompileResult {\n             test.relativePath}.golden.update`);\n   }\n   const partialFile = fs.readFile(goldenPartialPath);\n-  const partials = parseGoldenPartial(partialFile).filter(f => f.path.endsWith('.js'));\n-  for (const partial of partials) {\n-    const linkedSource =\n-        applyLinker({fileName: partial.path, source: partial.content}, linkerPlugin);\n-    safeWrite(fs, fs.resolve(builtDirectory, partial.path), linkedSource);\n+  const partialFiles = parseGoldenPartial(partialFile);\n+\n+  partialFiles.forEach(f => safeWrite(fs, fs.resolve(builtDirectory, f.path), f.content));\n+\n+  for (const expectation of test.expectations) {\n+    for (const {generated: fileName} of expectation.files) {\n+      const partialPath = fs.resolve(builtDirectory, fileName);\n+      if (!fs.exists(partialPath)) {\n+        continue;\n+      }\n+      const source = fs.readFile(partialPath);\n+      const sourceMapPath = fs.resolve(partialPath + '.map');\n+      const sourceMap =\n+          fs.exists(sourceMapPath) ? JSON.parse(fs.readFile(sourceMapPath)) : undefined;\n+      const {linkedSource, linkedSourceMap} =\n+          applyLinker({fileName, source, sourceMap}, linkerPlugin);\n+\n+      if (linkedSourceMap !== undefined) {\n+        const mapAndPath: MapAndPath = {map: linkedSourceMap, mapPath: sourceMapPath};\n+        const sourceFile = loader.loadSourceFile(partialPath, linkedSource, mapAndPath);\n+        safeWrite(fs, sourceMapPath, JSON.stringify(sourceFile.renderFlattenedSourceMap()));\n+      }\n+      safeWrite(fs, partialPath, linkedSource);\n+    }\n   }\n   return {emittedFiles: [], errors: []};\n }\n@@ -56,12 +79,15 @@ function linkPartials(fs: FileSystem, test: ComplianceTest): CompileResult {\n  * @param linkerPlugin The linker plugin to apply.\n  * @returns The file's source content, which has been transformed using the linker if necessary.\n  */\n-function applyLinker(file: {fileName: string; source: string}, linkerPlugin: PluginObj): string {\n+function applyLinker(\n+    file: {fileName: string; source: string, sourceMap: RawSourceMap | undefined},\n+    linkerPlugin: PluginObj): {linkedSource: string, linkedSourceMap: RawSourceMap|undefined} {\n   if (!file.fileName.endsWith('.js')) {\n-    return file.source;\n+    return {linkedSource: file.source, linkedSourceMap: file.sourceMap};\n   }\n   const result = transformSync(file.source, {\n     filename: file.fileName,\n+    sourceMaps: !!file.sourceMap,\n     plugins: [linkerPlugin],\n     parserOpts: {sourceType: 'unambiguous'},\n   });\n@@ -71,7 +97,7 @@ function applyLinker(file: {fileName: string; source: string}, linkerPlugin: Plu\n   if (result.code == null) {\n     throw fail('Babel transform result does not have any code');\n   }\n-  return result.code;\n+  return {linkedSource: result.code, linkedSourceMap: result.map || undefined};\n }\n \n /**"
        },
        {
            "sha": "f7db924eca44dc1e93f2ad5414a889a3baadb48a",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2FBUILD.bazel?ref=9066ca9e92cafdfb8789169a6ca8100e5c0b856b",
            "patch": "@@ -15,6 +15,8 @@ ts_library(\n         \"//packages/compiler-cli\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/logging\",\n+        \"//packages/compiler-cli/src/ngtsc/sourcemaps\",\n         \"//packages/compiler-cli/src/ngtsc/testing\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "47e807a1aa3f5d78bd8287e51dccc402d586363f",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/check_expectations.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fcheck_expectations.ts",
            "raw_url": "https://github.com/angular/angular/raw/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fcheck_expectations.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fcheck_expectations.ts?ref=9066ca9e92cafdfb8789169a6ca8100e5c0b856b",
            "patch": "@@ -14,6 +14,7 @@ import {replaceMacros} from './expected_file_macros';\n import {verifyUniqueFunctions} from './function_checks';\n import {ExpectedFile, ExtraCheck} from './get_compliance_tests';\n import {verifyPlaceholdersIntegrity, verifyUniqueConsts} from './i18n_checks';\n+import {checkMappings} from './sourcemap_helpers';\n \n type ExtraCheckFunction = (generated: string, ...extraArgs: any[]) => boolean;\n const EXTRA_CHECK_FUNCTIONS: Record<string, ExtraCheckFunction> = {\n@@ -54,8 +55,10 @@ export function checkExpectations(\n       error.stack = '';\n       throw error;\n     }\n-    const expected = replaceMacros(fs.readFile(expectedPath));\n     const generated = fs.readFile(generatedPath);\n+    let expected = fs.readFile(expectedPath);\n+    expected = replaceMacros(expected);\n+    expected = checkMappings(fs, generated, generatedPath, expected);\n \n     expectEmit(\n         generated, expected,"
        },
        {
            "sha": "1ed43c393ecdf39a69c504a151bb494c8cd829bc",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/sourcemap_helpers.ts",
            "status": "added",
            "additions": 212,
            "deletions": 0,
            "changes": 212,
            "blob_url": "https://github.com/angular/angular/blob/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fsourcemap_helpers.ts",
            "raw_url": "https://github.com/angular/angular/raw/9066ca9e92cafdfb8789169a6ca8100e5c0b856b/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fsourcemap_helpers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fsourcemap_helpers.ts?ref=9066ca9e92cafdfb8789169a6ca8100e5c0b856b",
            "patch": "@@ -0,0 +1,212 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {AbsoluteFsPath, FileSystem} from '../../../src/ngtsc/file_system';\n+import {ConsoleLogger, LogLevel} from '../../../src/ngtsc/logging';\n+import {SourceFileLoader} from '../../../src/ngtsc/sourcemaps';\n+\n+/**\n+ * Check the source-mappings of the generated source file against mappings stored in the expected\n+ * source file.\n+ *\n+ * The source-mappings are encoded into the expected source file in the form of an end-of-line\n+ * comment that has the following syntax:\n+ *\n+ * ```\n+ * <generated code> // SOURCE: \"</path/to/original>\" <original source>\n+ * ```\n+ *\n+ * The `path/to/original` path will be absolute within the mock file-system, where the root is the\n+ * directory containing the `TEST_CASES.json` file. The `generated code` and the `original source`\n+ * are not trimmed of whitespace - but there is a single space after the generated and a single\n+ * space before the original source.\n+ *\n+ * @param fs The test file-system where the source, generated and expected files are stored.\n+ * @param generated The content of the generated source file.\n+ * @param generatedPath The absolute path, within the test file-system, of the generated source\n+ *     file.\n+ * @param expectedSource The content of the expected source file, containing mapping information.\n+ * @returns The content of the expected source file, stripped of the mapping information.\n+ */\n+export function checkMappings(\n+    fs: FileSystem, generated: string, generatedPath: AbsoluteFsPath,\n+    expectedSource: string): string {\n+  const actualMappings = getMappedSegments(fs, generatedPath, generated);\n+\n+  const {expected, mappings} = extractMappings(fs, expectedSource);\n+\n+  const failures: string[] = [];\n+  for (const expectedMapping of mappings) {\n+    const failure = checkMapping(actualMappings, expectedMapping);\n+    if (failure !== null) {\n+      failures.push(failure);\n+    }\n+  }\n+\n+  if (failures.length > 0) {\n+    throw new Error(\n+        `When checking mappings for ${generatedPath}...\\n\\n` +\n+        `${failures.join('\\n\\n')}\\n\\n` +\n+        `All the mappings:\\n\\n${dumpMappings(actualMappings)}`);\n+  }\n+\n+  return expected;\n+}\n+\n+/**\n+ * A mapping of a segment of generated text to a segment of source text.\n+ */\n+interface SegmentMapping {\n+  /** The generated text in this segment. */\n+  generated: string;\n+  /** The source text in this segment. */\n+  source: string;\n+  /** The URL of the source file for this segment. */\n+  sourceUrl: string;\n+}\n+\n+/**\n+ * Extract the source-map information (encoded in comments - see `checkMappings()`) from the given\n+ * `expected` source content, returning both the `mappings` and the `expected` source code, stripped\n+ * of the source-mapping comments.\n+ *\n+ * @param expected The content of the expected file containing source-map information.\n+ */\n+function extractMappings(\n+    fs: FileSystem, expected: string): {expected: string, mappings: SegmentMapping[]} {\n+  const mappings: SegmentMapping[] = [];\n+  // capture and remove source mapping info\n+  expected = expected.replace(\n+      /^(.*?) \\/\\/ SOURCE: \"([^\"]*?)\" (.*?)$/gm,\n+      (_, rawGenerated: string, rawSourceUrl: string, rawSource: string) => {\n+        // Since segments need to appear on a single line in the expected file, any newlines in the\n+        // segment being checked must be escaped in the expected file and then unescaped here before\n+        // being checked.\n+        const generated = unescape(rawGenerated);\n+        const source = unescape(rawSource);\n+        const sourceUrl = fs.resolve(rawSourceUrl);\n+\n+        mappings.push({generated, sourceUrl, source});\n+        return generated;\n+      });\n+  return {expected, mappings};\n+}\n+\n+function unescape(str: string): string {\n+  const replacements: Record<any, string> = {'\\\\n': '\\n', '\\\\\\\\': '\\\\'};\n+  return str.replace(/\\\\[n\\\\]/g, match => replacements[match]);\n+}\n+\n+/**\n+ * Process a generated file to extract human understandable segment mappings.\n+ *\n+ * These mappings are easier to compare in unit tests than the raw SourceMap mappings.\n+ *\n+ * @param fs the test file-system that holds the source and generated files.\n+ * @param generatedPath The path of the generated file to process.\n+ * @param generatedContents The contents of the generated file to process.\n+ * @returns An array of segment mappings for each mapped segment in the given generated file. An\n+ *     empty array is returned if there is no source-map file found.\n+ */\n+function getMappedSegments(\n+    fs: FileSystem, generatedPath: AbsoluteFsPath, generatedContents: string): SegmentMapping[] {\n+  const logger = new ConsoleLogger(LogLevel.debug);\n+  const loader = new SourceFileLoader(fs, logger, {});\n+  const generatedFile = loader.loadSourceFile(generatedPath, generatedContents);\n+  if (generatedFile === null) {\n+    return [];\n+  }\n+\n+  const segments: SegmentMapping[] = [];\n+  for (let i = 0; i < generatedFile.flattenedMappings.length - 1; i++) {\n+    const mapping = generatedFile.flattenedMappings[i];\n+    const generatedStart = mapping.generatedSegment;\n+    const generatedEnd = generatedFile.flattenedMappings[i + 1].generatedSegment;\n+    const originalFile = mapping.originalSource;\n+    const originalStart = mapping.originalSegment;\n+    let originalEnd = originalStart.next;\n+    // Skip until we find an end segment that is after the start segment\n+    while (originalEnd !== undefined && originalEnd.next !== originalEnd &&\n+           originalEnd.position === originalStart.position) {\n+      originalEnd = originalEnd.next;\n+    }\n+    if (originalEnd === undefined || originalEnd.next === originalEnd) {\n+      continue;\n+    }\n+\n+    const segment = {\n+      generated: generatedFile.contents.substring(generatedStart.position, generatedEnd.position),\n+      source: originalFile.contents.substring(originalStart.position, originalEnd!.position),\n+      sourceUrl: originalFile.sourcePath\n+    };\n+    segments.push(segment);\n+  }\n+\n+  return segments;\n+}\n+\n+/**\n+ * Check that the `expected` segment appears in the collection of `mappings`.\n+ *\n+ * @returns An error message if a matching segment cannot be found, or null if it can.\n+ */\n+function checkMapping(mappings: SegmentMapping[], expected: SegmentMapping): string|null {\n+  if (mappings.some(\n+          m => m.generated === expected.generated && m.source === expected.source &&\n+              m.sourceUrl === expected.sourceUrl)) {\n+    return null;\n+  }\n+  const matchingGenerated = mappings.filter(m => m.generated === expected.generated);\n+  const matchingSource = mappings.filter(m => m.source === expected.source);\n+\n+  const message = [\n+    'Expected mappings to contain the following mapping',\n+    prettyPrintMapping(expected),\n+  ];\n+  if (matchingGenerated.length > 0) {\n+    message.push('');\n+    message.push('There are the following mappings that match the generated text:');\n+    matchingGenerated.forEach(m => message.push(prettyPrintMapping(m)));\n+  }\n+  if (matchingSource.length > 0) {\n+    message.push('');\n+    message.push('There are the following mappings that match the source text:');\n+    matchingSource.forEach(m => message.push(prettyPrintMapping(m)));\n+  }\n+\n+  return message.join('\\n');\n+}\n+\n+function prettyPrintMapping(mapping: SegmentMapping): string {\n+  return [\n+    '{',\n+    `  generated: ${JSON.stringify(mapping.generated)}`,\n+    `  source   : ${JSON.stringify(mapping.source)}`,\n+    `  sourceUrl: ${JSON.stringify(mapping.sourceUrl)}`,\n+    '}',\n+  ].join('\\n');\n+}\n+\n+/**\n+ * Helper function for debugging failed mappings.\n+ * This lays out the segment mappings in the console to make it easier to compare.\n+ */\n+function dumpMappings(mappings: SegmentMapping[]): string {\n+  return mappings\n+      .map(\n+          mapping => padValue(mapping.sourceUrl, 20, 0) + ' : ' +\n+              padValue(JSON.stringify(mapping.source), 100, 23) + ' : ' +\n+              JSON.stringify(mapping.generated))\n+      .join('\\n');\n+}\n+\n+function padValue(value: string, max: number, start: number): string {\n+  const padding = value.length > max ? ('\\n' +\n+                                        ' '.repeat(max + start)) :\n+                                       ' '.repeat(max - value.length);\n+  return value + padding;\n+}"
        }
    ],
    "stats": {
        "total": 289,
        "additions": 278,
        "deletions": 11
    }
}