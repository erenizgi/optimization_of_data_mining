{
    "author": "bjarkler",
    "message": "feat(core): create a Trusted Types policy for bypass conversions (#39218)\n\nWhen an application uses a custom sanitizer or one of the\nbypassSecurityTrust functions, Angular has no way of knowing whether\nthey are implemented in a secure way. (It doesn't even know if they're\nintroduced by the application or by a shady third-party dependency.)\nThus using Angular's main Trusted Types policy to bless values coming\nfrom these two sources would undermine the security that Trusted Types\nbrings.\n\nInstead, introduce a Trusted Types policy called angular#unsafe-bypass\nspecifically for blessing values from these sources. This allows an\napplication to enforce Trusted Types even if their application uses a\ncustom sanitizer or the bypassSecurityTrust functions, knowing that\ncompromises to either of these two sources may lead to arbitrary script\nexecution. In the future Angular will provide a way to implement\ncustom sanitizers in a manner that makes better use of Trusted Types.\n\nPR Close #39218",
    "sha": "49197d12a0a721f6eae3d4cf79581c02955c3b34",
    "files": [
        {
            "sha": "3280785d08413de64d787a290bc5d9c5fca04dfd",
            "filename": "packages/core/src/util/security/trusted_types_bypass.ts",
            "status": "added",
            "additions": 89,
            "deletions": 0,
            "changes": 89,
            "blob_url": "https://github.com/angular/angular/blob/49197d12a0a721f6eae3d4cf79581c02955c3b34/packages%2Fcore%2Fsrc%2Futil%2Fsecurity%2Ftrusted_types_bypass.ts",
            "raw_url": "https://github.com/angular/angular/raw/49197d12a0a721f6eae3d4cf79581c02955c3b34/packages%2Fcore%2Fsrc%2Futil%2Fsecurity%2Ftrusted_types_bypass.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Futil%2Fsecurity%2Ftrusted_types_bypass.ts?ref=49197d12a0a721f6eae3d4cf79581c02955c3b34",
            "patch": "@@ -0,0 +1,89 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * @fileoverview\n+ * A module to facilitate use of a Trusted Types policy internally within\n+ * Angular specifically for bypassSecurityTrust* and custom sanitizers. It\n+ * lazily constructs the Trusted Types policy, providing helper utilities for\n+ * promoting strings to Trusted Types. When Trusted Types are not available,\n+ * strings are used as a fallback.\n+ * @security All use of this module is security-sensitive and should go through\n+ * security review.\n+ */\n+\n+import {global} from '../global';\n+import {TrustedHTML, TrustedScript, TrustedScriptURL, TrustedTypePolicy, TrustedTypePolicyFactory} from './trusted_type_defs';\n+\n+/**\n+ * The Trusted Types policy, or null if Trusted Types are not\n+ * enabled/supported, or undefined if the policy has not been created yet.\n+ */\n+let policy: TrustedTypePolicy|null|undefined;\n+\n+/**\n+ * Returns the Trusted Types policy, or null if Trusted Types are not\n+ * enabled/supported. The first call to this function will create the policy.\n+ */\n+function getPolicy(): TrustedTypePolicy|null {\n+  if (policy === undefined) {\n+    policy = null;\n+    if (global.trustedTypes) {\n+      try {\n+        policy = (global.trustedTypes as TrustedTypePolicyFactory)\n+                     .createPolicy('angular#unsafe-bypass', {\n+                       createHTML: (s: string) => s,\n+                       createScript: (s: string) => s,\n+                       createScriptURL: (s: string) => s,\n+                     });\n+      } catch {\n+        // trustedTypes.createPolicy throws if called with a name that is\n+        // already registered, even in report-only mode. Until the API changes,\n+        // catch the error not to break the applications functionally. In such\n+        // cases, the code will fall back to using strings.\n+      }\n+    }\n+  }\n+  return policy;\n+}\n+\n+/**\n+ * Unsafely promote a string to a TrustedHTML, falling back to strings when\n+ * Trusted Types are not available.\n+ * @security This is a security-sensitive function; any use of this function\n+ * must go through security review. In particular, it must be assured that it\n+ * is only passed strings that come directly from custom sanitizers or the\n+ * bypassSecurityTrust* functions.\n+ */\n+export function trustedHTMLFromStringBypass(html: string): TrustedHTML|string {\n+  return getPolicy()?.createHTML(html) || html;\n+}\n+\n+/**\n+ * Unsafely promote a string to a TrustedScript, falling back to strings when\n+ * Trusted Types are not available.\n+ * @security This is a security-sensitive function; any use of this function\n+ * must go through security review. In particular, it must be assured that it\n+ * is only passed strings that come directly from custom sanitizers or the\n+ * bypassSecurityTrust* functions.\n+ */\n+export function trustedScriptFromStringBypass(script: string): TrustedScript|string {\n+  return getPolicy()?.createScript(script) || script;\n+}\n+\n+/**\n+ * Unsafely promote a string to a TrustedScriptURL, falling back to strings\n+ * when Trusted Types are not available.\n+ * @security This is a security-sensitive function; any use of this function\n+ * must go through security review. In particular, it must be assured that it\n+ * is only passed strings that come directly from custom sanitizers or the\n+ * bypassSecurityTrust* functions.\n+ */\n+export function trustedScriptURLFromStringBypass(url: string): TrustedScriptURL|string {\n+  return getPolicy()?.createScriptURL(url) || url;\n+}"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 89,
        "deletions": 0
    }
}