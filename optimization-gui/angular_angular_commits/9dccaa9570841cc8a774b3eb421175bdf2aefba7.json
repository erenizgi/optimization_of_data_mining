{
    "author": "devversion",
    "message": "refactor(dev-infra): move common versioning tooling to shared location (#38656)\n\nWe initially added logic for determining active release trains into\nthe merge script. Given we now build more tools that rely on this\ninformation, we move the logic into a more general \"versioning\" folder\nthat can contain common logic following the versioning document for the\nAngular organization.\n\nPR Close #38656",
    "sha": "9dccaa9570841cc8a774b3eb421175bdf2aefba7",
    "files": [
        {
            "sha": "797c2d454752bdb3db6392e730b4e4b820ad332c",
            "filename": ".ng-dev/merge.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/.ng-dev%2Fmerge.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/.ng-dev%2Fmerge.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.ng-dev%2Fmerge.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -1,6 +1,7 @@\n import {DevInfraMergeConfig} from '../dev-infra/pr/merge/config';\n import {getDefaultTargetLabelConfiguration} from '../dev-infra/pr/merge/defaults';\n import {github} from './github';\n+import {release} from './release';\n \n /**\n  * Configuration for the merge tool in `ng-dev`. This sets up the labels which\n@@ -13,7 +14,9 @@ export const merge: DevInfraMergeConfig['merge'] = async api => {\n     mergeReadyLabel: /^action: merge(-assistance)?/,\n     caretakerNoteLabel: 'action: merge-assistance',\n     commitMessageFixupLabel: 'commit message fixup',\n-    labels: await getDefaultTargetLabelConfiguration(api, github, '@angular/core'),\n+    // We can pick any of the NPM packages as we are in a monorepo where all packages are\n+    // published together with the same version and branching.\n+    labels: await getDefaultTargetLabelConfiguration(api, github, release),\n     requiredBaseCommits: {\n       // PRs that target either `master` or the patch branch, need to be rebased\n       // on top of the latest commit message validation fix."
        },
        {
            "sha": "c5aa520c7c9f1b4f3c7535fc267c50aca6538c4e",
            "filename": "dev-infra/pr/merge/BUILD.bazel",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Fpr%2Fmerge%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Fpr%2Fmerge%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2FBUILD.bazel?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -11,6 +11,8 @@ ts_library(\n     visibility = [\"//dev-infra:__subpackages__\"],\n     deps = [\n         \"//dev-infra/commit-message\",\n+        \"//dev-infra/release/config\",\n+        \"//dev-infra/release/versioning\",\n         \"//dev-infra/utils\",\n         \"@npm//@octokit/rest\",\n         \"@npm//@types/inquirer\",\n@@ -28,6 +30,8 @@ ts_library(\n     srcs = glob([\"**/*.spec.ts\"]),\n     deps = [\n         \":merge\",\n+        \"//dev-infra/release/config\",\n+        \"//dev-infra/release/versioning\",\n         \"//dev-infra/utils\",\n         \"@npm//@types/jasmine\",\n         \"@npm//@types/node\","
        },
        {
            "sha": "292bf3fb3ebd79ff4c71a769207c784dfcf4c4cd",
            "filename": "dev-infra/pr/merge/defaults/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Findex.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -7,5 +7,4 @@\n  */\n \n export * from './labels';\n-export * from './branches';\n export * from './lts-branch';"
        },
        {
            "sha": "6db2cfc12fd3c30bc14ebeead8327c9f095ad974",
            "filename": "dev-infra/pr/merge/defaults/integration.spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 23,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -7,8 +7,9 @@\n  */\n \n import * as nock from 'nock';\n-import * as nodeFetch from 'node-fetch';\n \n+import {ReleaseConfig} from '../../../release/config/index';\n+import {_npmPackageInfoCache, NpmPackageInfo} from '../../../release/versioning/npm-registry';\n import {GithubConfig} from '../../../utils/config';\n import * as console from '../../../utils/console';\n import {GithubClient} from '../../../utils/git/github';\n@@ -21,13 +22,17 @@ const API_ENDPOINT = `https://api.github.com`;\n \n describe('default target labels', () => {\n   let api: GithubClient;\n-  let config: GithubConfig;\n-  let npmPackageName: string;\n+  let githubConfig: GithubConfig;\n+  let releaseConfig: ReleaseConfig;\n \n   beforeEach(() => {\n     api = new GithubClient();\n-    config = {owner: 'angular', name: 'dev-infra-test'};\n-    npmPackageName = '@angular/dev-infra-test-pkg';\n+    githubConfig = {owner: 'angular', name: 'dev-infra-test'};\n+    releaseConfig = {\n+      npmPackages: ['@angular/dev-infra-test-pkg'],\n+      buildPackages: async () => [],\n+      generateReleaseNotesForHead: async () => {},\n+    };\n \n     // The label determination will print warn messages. These should not be\n     // printed to the console, so we turn `console.warn` into a spy.\n@@ -37,11 +42,11 @@ describe('default target labels', () => {\n   afterEach(() => nock.cleanAll());\n \n   async function computeTargetLabels(): Promise<TargetLabel[]> {\n-    return getDefaultTargetLabelConfiguration(api, config, npmPackageName);\n+    return getDefaultTargetLabelConfiguration(api, githubConfig, releaseConfig);\n   }\n \n   function getRepoApiRequestUrl(): string {\n-    return `${API_ENDPOINT}/repos/${config.owner}/${config.name}`;\n+    return `${API_ENDPOINT}/repos/${githubConfig.owner}/${githubConfig.name}`;\n   }\n \n   /**\n@@ -61,10 +66,9 @@ describe('default target labels', () => {\n   }\n \n   /** Fakes a NPM package query API request. */\n-  function fakeNpmPackageQueryRequest(data: unknown) {\n-    // Note: We only need to mock the `json` function for a `Response`. Types\n-    // would expect us to mock more functions, so we need to cast to `any`.\n-    spyOn(nodeFetch, 'default').and.resolveTo({json: async () => data} as any);\n+  function fakeNpmPackageQueryRequest(data: Partial<NpmPackageInfo>) {\n+    _npmPackageInfoCache[releaseConfig.npmPackages[0]] =\n+        Promise.resolve({'dist-tags': {}, versions: {}, time: {}, ...data});\n   }\n \n   /**\n@@ -167,7 +171,7 @@ describe('default target labels', () => {\n       'time': {\n         // v10 has been released at the given specified date. We pick a date that\n         // guarantees that the version is no longer considered as active LTS version.\n-        '10.0.0': new Date(1912, 5, 23),\n+        '10.0.0': new Date(1912, 5, 23).toISOString(),\n       }\n     });\n \n@@ -234,7 +238,7 @@ describe('default target labels', () => {\n          'time': {\n            // v10 has been released at the given specified date. We pick a date that\n            // guarantees that the version is no longer considered as active LTS version.\n-           '10.0.0': new Date(1912, 5, 23),\n+           '10.0.0': new Date(1912, 5, 23).toISOString(),\n          }\n        });\n \n@@ -247,16 +251,14 @@ describe('default target labels', () => {\n     interceptBranchVersionRequest('10.5.x', '10.5.1');\n     interceptBranchesListRequest(['10.5.x', '11.0.x']);\n \n-    spyOn(require('node-fetch'), 'default').and.callFake(() => ({\n-                                                           json: () => ({\n-                                                             'dist-tags': {\n-                                                               'v10-lts': '10.5.1',\n-                                                             },\n-                                                             'time': {\n-                                                               '10.0.0': new Date().toISOString(),\n-                                                             }\n-                                                           }),\n-                                                         }));\n+    fakeNpmPackageQueryRequest({\n+      'dist-tags': {\n+        'v10-lts': '10.5.1',\n+      },\n+      'time': {\n+        '10.0.0': new Date().toISOString(),\n+      }\n+    });\n \n     expect(await getBranchesForLabel('target: lts', '10.5.x')).toEqual(['10.5.x']);\n   });"
        },
        {
            "sha": "e24bea6fed524f57e71c7922d06bcc26699b7df2",
            "filename": "dev-infra/pr/merge/defaults/labels.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 9,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Flabels.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Flabels.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Flabels.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -6,34 +6,40 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {ReleaseConfig} from '../../../release/config/index';\n+import {fetchActiveReleaseTrains, isVersionBranch, nextBranchName} from '../../../release/versioning';\n import {GithubConfig} from '../../../utils/config';\n import {GithubClient} from '../../../utils/git/github';\n import {TargetLabel} from '../config';\n import {InvalidTargetBranchError, InvalidTargetLabelError} from '../target-label';\n \n-import {fetchActiveReleaseTrainBranches, getVersionOfBranch, GithubRepoWithApi, isReleaseTrainBranch, nextBranchName} from './branches';\n import {assertActiveLtsBranch} from './lts-branch';\n \n /**\n  * Gets a label configuration for the merge tooling that reflects the default Angular\n  * organization-wide labeling and branching semantics as outlined in the specification.\n  *\n  * https://docs.google.com/document/d/197kVillDwx-RZtSVOBtPb4BBIAw0E9RT3q3v6DZkykU\n+ *\n+ * @param api Instance of an authenticated Github client.\n+ * @param githubConfig Configuration for the Github remote. Used as Git remote\n+ *   for the release train branches.\n+ * @param releaseConfig Configuration for the release packages. Used to fetch\n+ *   NPM version data when LTS version branches are validated.\n  */\n export async function getDefaultTargetLabelConfiguration(\n-    api: GithubClient, github: GithubConfig, npmPackageName: string): Promise<TargetLabel[]> {\n-  const repo: GithubRepoWithApi = {owner: github.owner, name: github.name, api};\n-  const nextVersion = await getVersionOfBranch(repo, nextBranchName);\n-  const hasNextMajorTrain = nextVersion.minor === 0;\n-  const {latest, releaseCandidate} = await fetchActiveReleaseTrainBranches(repo, nextVersion);\n+    api: GithubClient, githubConfig: GithubConfig,\n+    releaseConfig: ReleaseConfig): Promise<TargetLabel[]> {\n+  const repo = {owner: githubConfig.owner, name: githubConfig.name, api};\n+  const {latest, releaseCandidate, next} = await fetchActiveReleaseTrains(repo);\n \n   return [\n     {\n       pattern: 'target: major',\n       branches: () => {\n         // If `next` is currently not designated to be a major version, we do not\n         // allow merging of PRs with `target: major`.\n-        if (!hasNextMajorTrain) {\n+        if (!next.isMajor) {\n           throw new InvalidTargetLabelError(\n               `Unable to merge pull request. The \"${nextBranchName}\" branch will be ` +\n               `released as a minor version.`);\n@@ -99,7 +105,7 @@ export async function getDefaultTargetLabelConfiguration(\n       // commonly diverge quickly. This makes cherry-picking not an option for LTS changes.\n       pattern: 'target: lts',\n       branches: async githubTargetBranch => {\n-        if (!isReleaseTrainBranch(githubTargetBranch)) {\n+        if (!isVersionBranch(githubTargetBranch)) {\n           throw new InvalidTargetBranchError(\n               `PR cannot be merged as it does not target a long-term support ` +\n               `branch: \"${githubTargetBranch}\"`);\n@@ -115,7 +121,7 @@ export async function getDefaultTargetLabelConfiguration(\n               `branch. Consider changing the label to \"target: rc\" if this is intentional.`);\n         }\n         // Assert that the selected branch is an active LTS branch.\n-        await assertActiveLtsBranch(repo, npmPackageName, githubTargetBranch);\n+        await assertActiveLtsBranch(repo, releaseConfig, githubTargetBranch);\n         return [githubTargetBranch];\n       },\n     },"
        },
        {
            "sha": "b64158b072ad41ee3087c1bb4efc53782d1129b9",
            "filename": "dev-infra/pr/merge/defaults/lts-branch.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 45,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Flts-branch.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Flts-branch.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Flts-branch.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -6,46 +6,25 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import fetch from 'node-fetch';\n import * as semver from 'semver';\n \n+import {ReleaseConfig} from '../../../release/config/index';\n+import {computeLtsEndDateOfMajor, fetchProjectNpmPackageInfo, getLtsNpmDistTagOfMajor, getVersionOfBranch, GithubRepoWithApi} from '../../../release/versioning';\n import {promptConfirm, red, warn, yellow} from '../../../utils/console';\n import {InvalidTargetBranchError} from '../target-label';\n \n-import {getVersionOfBranch, GithubRepoWithApi} from './branches';\n-\n-/**\n- * Number of months a major version in Angular is actively supported. See:\n- * https://angular.io/guide/releases#support-policy-and-schedule.\n- */\n-export const majorActiveSupportDuration = 6;\n-\n-/**\n- * Number of months a major version has active long-term support. See:\n- * https://angular.io/guide/releases#support-policy-and-schedule.\n- */\n-export const majorActiveTermSupportDuration = 12;\n-\n-/** Regular expression that matches LTS NPM dist tags. */\n-export const ltsNpmDistTagRegex = /^v(\\d+)-lts$/;\n-\n /**\n  * Asserts that the given branch corresponds to an active LTS version-branch that can receive\n  * backport fixes. Throws an error if LTS expired or an invalid branch is selected.\n  *\n- * @param repo Github repository for which the given branch exists.\n- * @param representativeNpmPackage NPM package representing the given repository. Angular\n- *   repositories usually contain multiple packages in a monorepo scheme, but packages commonly\n- *   are released with the same versions. This means that a single package can be used for querying\n- *   NPM about previously published versions (e.g. to determine active LTS versions). The package\n- *   name is used to check if the given branch is containing an active LTS version.\n+ * @param repo Repository containing the given branch. Used for Github API queries.\n+ * @param releaseConfig Configuration for releases. Used to query NPM about past publishes.\n  * @param branchName Branch that is checked to be an active LTS version-branch.\n  * */\n export async function assertActiveLtsBranch(\n-    repo: GithubRepoWithApi, representativeNpmPackage: string, branchName: string) {\n+    repo: GithubRepoWithApi, releaseConfig: ReleaseConfig, branchName: string) {\n   const version = await getVersionOfBranch(repo, branchName);\n-  const {'dist-tags': distTags, time} =\n-      await (await fetch(`https://registry.npmjs.org/${representativeNpmPackage}`)).json();\n+  const {'dist-tags': distTags, time} = await fetchProjectNpmPackageInfo(releaseConfig);\n \n   // LTS versions should be tagged in NPM in the following format: `v{major}-lts`.\n   const ltsNpmTag = getLtsNpmDistTagOfMajor(version.major);\n@@ -87,21 +66,3 @@ export async function assertActiveLtsBranch(\n         `Pull request cannot be merged into the ${branchName} branch.`);\n   }\n }\n-\n-/**\n- * Computes the date when long-term support ends for a major released at the\n- * specified date.\n- */\n-export function computeLtsEndDateOfMajor(majorReleaseDate: Date): Date {\n-  return new Date(\n-      majorReleaseDate.getFullYear(),\n-      majorReleaseDate.getMonth() + majorActiveSupportDuration + majorActiveTermSupportDuration,\n-      majorReleaseDate.getDate(), majorReleaseDate.getHours(), majorReleaseDate.getMinutes(),\n-      majorReleaseDate.getSeconds(), majorReleaseDate.getMilliseconds());\n-}\n-\n-/** Gets the long-term support NPM dist tag for a given major version. */\n-export function getLtsNpmDistTagOfMajor(major: number): string {\n-  // LTS versions should be tagged in NPM in the following format: `v{major}-lts`.\n-  return `v${major}-lts`;\n-}"
        },
        {
            "sha": "8f575498bfc9c18d33287e62879aa5c27e1a9058",
            "filename": "dev-infra/release/versioning/BUILD.bazel",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2FBUILD.bazel?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -0,0 +1,18 @@\n+load(\"@npm_bazel_typescript//:index.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"versioning\",\n+    srcs = glob([\n+        \"**/*.ts\",\n+    ]),\n+    module_name = \"@angular/dev-infra-private/release/versioning\",\n+    visibility = [\"//dev-infra:__subpackages__\"],\n+    deps = [\n+        \"//dev-infra/release/config\",\n+        \"//dev-infra/utils\",\n+        \"@npm//@types/node-fetch\",\n+        \"@npm//@types/semver\",\n+        \"@npm//node-fetch\",\n+        \"@npm//semver\",\n+    ],\n+)"
        },
        {
            "sha": "c505a96ec71357503ef7a1e2e90da60ae130b35f",
            "filename": "dev-infra/release/versioning/README.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2FREADME.md?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -0,0 +1,5 @@\n+## Versioning for the Angular organization\n+\n+The folder contains common tooling needed for implementing the versioning as proposed\n+by [this design document](https://docs.google.com/document/d/197kVillDwx-RZtSVOBtPb4BBIAw0E9RT3q3v6DZkykU/edit#heading=h.s3qlps8f4zq7).\n+Primary tooling is the determination of _active_ release trains."
        },
        {
            "sha": "50ac8b406ab8c647bee2e763da0349ece906d3f7",
            "filename": "dev-infra/release/versioning/active-release-trains.ts",
            "status": "renamed",
            "additions": 18,
            "deletions": 100,
            "changes": 118,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Factive-release-trains.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Factive-release-trains.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Factive-release-trains.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -7,52 +7,28 @@\n  */\n \n import * as semver from 'semver';\n-import {GithubClient, GithubRepo} from '../../../utils/git/github';\n \n-/** Type describing a Github repository with corresponding API client. */\n-export interface GithubRepoWithApi extends GithubRepo {\n-  /** API client that can access the repository. */\n-  api: GithubClient;\n-}\n-\n-/** Type describing a version-branch. */\n-export interface VersionBranch {\n-  /** Name of the branch in Git. e.g. `10.0.x`. */\n-  name: string;\n-  /**\n-   * Parsed SemVer version for the version-branch. Version branches technically do\n-   * not follow the SemVer format, but we can have representative SemVer versions\n-   * that can be used for comparisons, sorting and other checks.\n-   */\n-  parsed: semver.SemVer;\n-}\n-\n-/** Type describing a release-train. */\n-export interface ReleaseTrain {\n-  /** Name of the branch for this release-train. */\n-  branchName: string;\n-  /** Current latest version for this release train. */\n-  version: semver.SemVer;\n+import {ReleaseTrain} from './release-trains';\n+import {getBranchesForMajorVersions, getVersionOfBranch, GithubRepoWithApi, VersionBranch} from './version-branches';\n+\n+/** Interface describing determined active release trains for a project. */\n+export interface ActiveReleaseTrains {\n+  /** Release-train currently in the \"release-candidate\" or \"feature-freeze\" phase. */\n+  releaseCandidate: ReleaseTrain|null;\n+  /** Release-train currently in the \"latest\" phase. */\n+  latest: ReleaseTrain;\n+  /** Release-train in the `next` phase */\n+  next: ReleaseTrain;\n }\n \n /** Branch name for the `next` branch. */\n export const nextBranchName = 'master';\n \n-/** Regular expression that matches version-branches for a release-train. */\n-const releaseTrainBranchNameRegex = /(\\d+)\\.(\\d+)\\.x/;\n-\n-/**\n- * Fetches the active release train and its branches for the specified major version. i.e.\n- * the latest active release-train branch name is resolved and an optional version-branch for\n- * a currently active feature-freeze/release-candidate release-train.\n- */\n-export async function fetchActiveReleaseTrainBranches(\n-    repo: GithubRepoWithApi, nextVersion: semver.SemVer): Promise<{\n-  /** Release-train currently in active release-candidate/feature-freeze phase. */\n-  releaseCandidate: ReleaseTrain | null,\n-  /** Latest non-prerelease release train (i.e. for the patch branch). */\n-  latest: ReleaseTrain\n-}> {\n+/** Fetches the active release trains for the configured project. */\n+export async function fetchActiveReleaseTrains(repo: GithubRepoWithApi):\n+    Promise<ActiveReleaseTrains> {\n+  const nextVersion = await getVersionOfBranch(repo, nextBranchName);\n+  const next = new ReleaseTrain(nextBranchName, nextVersion);\n   const majorVersionsToConsider: number[] = [];\n   let expectedReleaseCandidateMajor: number;\n \n@@ -93,65 +69,7 @@ export async function fetchActiveReleaseTrainBranches(\n         `have been considered: [${branches.map(b => b.name).join(', ')}]`);\n   }\n \n-  return {releaseCandidate, latest};\n-}\n-\n-/** Gets the version of a given branch by reading the `package.json` upstream. */\n-export async function getVersionOfBranch(\n-    repo: GithubRepoWithApi, branchName: string): Promise<semver.SemVer> {\n-  const {data} = await repo.api.repos.getContents(\n-      {owner: repo.owner, repo: repo.name, path: '/package.json', ref: branchName});\n-  const {version} = JSON.parse(Buffer.from(data.content, 'base64').toString());\n-  const parsedVersion = semver.parse(version);\n-  if (parsedVersion === null) {\n-    throw Error(`Invalid version detected in following branch: ${branchName}.`);\n-  }\n-  return parsedVersion;\n-}\n-\n-/** Whether the given branch corresponds to a release-train branch. */\n-export function isReleaseTrainBranch(branchName: string): boolean {\n-  return releaseTrainBranchNameRegex.test(branchName);\n-}\n-\n-/**\n- * Converts a given version-branch into a SemVer version that can be used with SemVer\n- * utilities. e.g. to determine semantic order, extract major digit, compare.\n- *\n- * For example `10.0.x` will become `10.0.0` in SemVer. The patch digit is not\n- * relevant but needed for parsing. SemVer does not allow `x` as patch digit.\n- */\n-export function getVersionForReleaseTrainBranch(branchName: string): semver.SemVer|null {\n-  // Convert a given version-branch into a SemVer version that can be used\n-  // with the SemVer utilities. i.e. to determine semantic order.\n-  return semver.parse(branchName.replace(releaseTrainBranchNameRegex, '$1.$2.0'));\n-}\n-\n-/**\n- * Gets the version branches for the specified major versions in descending\n- * order. i.e. latest version branches first.\n- */\n-export async function getBranchesForMajorVersions(\n-    repo: GithubRepoWithApi, majorVersions: number[]): Promise<VersionBranch[]> {\n-  const {data: branchData} =\n-      await repo.api.repos.listBranches({owner: repo.owner, repo: repo.name, protected: true});\n-  const branches: VersionBranch[] = [];\n-\n-  for (const {name} of branchData) {\n-    if (!isReleaseTrainBranch(name)) {\n-      continue;\n-    }\n-    // Convert the version-branch into a SemVer version that can be used with the\n-    // SemVer utilities. e.g. to determine semantic order, compare versions.\n-    const parsed = getVersionForReleaseTrainBranch(name);\n-    // Collect all version-branches that match the specified major versions.\n-    if (parsed !== null && majorVersions.includes(parsed.major)) {\n-      branches.push({name, parsed});\n-    }\n-  }\n-\n-  // Sort captured version-branches in descending order.\n-  return branches.sort((a, b) => semver.rcompare(a.parsed, b.parsed));\n+  return {releaseCandidate, latest, next};\n }\n \n /** Finds the currently active release trains from the specified version branches. */\n@@ -196,7 +114,7 @@ export async function findActiveReleaseTrainsFromVersionBranches(\n     }\n \n     const version = await getVersionOfBranch(repo, name);\n-    const releaseTrain: ReleaseTrain = {branchName: name, version};\n+    const releaseTrain = new ReleaseTrain(name, version);\n     const isPrerelease = version.prerelease[0] === 'rc' || version.prerelease[0] === 'next';\n \n     if (isPrerelease) {",
            "previous_filename": "dev-infra/pr/merge/defaults/branches.ts"
        },
        {
            "sha": "fa834458cd150bb4e6abaa77e15a2b2e5a979778",
            "filename": "dev-infra/release/versioning/index.ts",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Findex.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -0,0 +1,13 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export * from './active-release-trains';\n+export * from './release-trains';\n+export * from './long-term-support';\n+export * from './version-branches';\n+export * from './npm-registry';"
        },
        {
            "sha": "379fbb9b0e168f0486c88c93115ba8abc63b4e27",
            "filename": "dev-infra/release/versioning/long-term-support.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Flong-term-support.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Flong-term-support.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Flong-term-support.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -0,0 +1,37 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * Number of months a major version in Angular is actively supported. See:\n+ * https://angular.io/guide/releases#support-policy-and-schedule.\n+ */\n+export const majorActiveSupportDuration = 6;\n+\n+/**\n+ * Number of months a major version has active long-term support. See:\n+ * https://angular.io/guide/releases#support-policy-and-schedule.\n+ */\n+export const majorActiveTermSupportDuration = 12;\n+\n+/**\n+ * Computes the date when long-term support ends for a major released at the\n+ * specified date.\n+ */\n+export function computeLtsEndDateOfMajor(majorReleaseDate: Date): Date {\n+  return new Date(\n+      majorReleaseDate.getFullYear(),\n+      majorReleaseDate.getMonth() + majorActiveSupportDuration + majorActiveTermSupportDuration,\n+      majorReleaseDate.getDate(), majorReleaseDate.getHours(), majorReleaseDate.getMinutes(),\n+      majorReleaseDate.getSeconds(), majorReleaseDate.getMilliseconds());\n+}\n+\n+/** Gets the long-term support NPM dist tag for a given major version. */\n+export function getLtsNpmDistTagOfMajor(major: number): string {\n+  // LTS versions should be tagged in NPM in the following format: `v{major}-lts`.\n+  return `v${major}-lts`;\n+}"
        },
        {
            "sha": "1ac5c271efc88062ae63be4abcfa0604d257f70b",
            "filename": "dev-infra/release/versioning/npm-registry.ts",
            "status": "added",
            "additions": 66,
            "deletions": 0,
            "changes": 66,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Fnpm-registry.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Fnpm-registry.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Fnpm-registry.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -0,0 +1,66 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import fetch from 'node-fetch';\n+import * as semver from 'semver';\n+\n+import {ReleaseConfig} from '../config/index';\n+\n+/** Type describing an NPM package fetched from the registry. */\n+export interface NpmPackageInfo {\n+  /** Maps of versions and their package JSON objects. */\n+  'versions': {[name: string]: undefined|object};\n+  /** Map of NPM dist-tags and their chosen version. */\n+  'dist-tags': {[tagName: string]: string|undefined};\n+  /** Map of versions and their ISO release time. */\n+  'time': {[name: string]: string};\n+}\n+\n+/**\n+ * Cache for requested NPM package information. A cache is desirable as the NPM\n+ * registry requests are usually very large and slow.\n+ */\n+export const _npmPackageInfoCache: {[pkgName: string]: Promise<NpmPackageInfo>} = {};\n+\n+/**\n+ * Fetches the NPM package representing the project. Angular repositories usually contain\n+ * multiple packages in a monorepo scheme, but packages dealt with as part of the release\n+ * tooling are released together with the same versioning and branching. This means that\n+ * a single package can be used as source of truth for NPM package queries.\n+ */\n+export async function fetchProjectNpmPackageInfo(config: ReleaseConfig): Promise<NpmPackageInfo> {\n+  const pkgName = getRepresentativeNpmPackage(config);\n+  return await fetchPackageInfoFromNpmRegistry(pkgName);\n+}\n+\n+/** Gets whether the given version is published to NPM or not */\n+export async function isVersionPublishedToNpm(\n+    version: semver.SemVer, config: ReleaseConfig): Promise<boolean> {\n+  const {versions} = await fetchProjectNpmPackageInfo(config);\n+  return versions[version.format()] !== undefined;\n+}\n+\n+/**\n+ * Gets the representative NPM package for the specified release configuration. Angular\n+ * repositories usually contain multiple packages in a monorepo scheme, but packages dealt with\n+ * as part of the release tooling are released together with the same versioning and branching.\n+ * This means that a single package can be used as source of truth for NPM package queries.\n+ */\n+function getRepresentativeNpmPackage(config: ReleaseConfig) {\n+  return config.npmPackages[0];\n+}\n+\n+/** Fetches the specified NPM package from the NPM registry. */\n+async function fetchPackageInfoFromNpmRegistry(pkgName: string): Promise<NpmPackageInfo> {\n+  if (_npmPackageInfoCache[pkgName] !== undefined) {\n+    return await _npmPackageInfoCache[pkgName];\n+  }\n+  const result = _npmPackageInfoCache[pkgName] =\n+      fetch(`https://registry.npmjs.org/${pkgName}`).then(r => r.json());\n+  return await result;\n+}"
        },
        {
            "sha": "ee72c603f67c5a5b273625d9b815bb501771d814",
            "filename": "dev-infra/release/versioning/release-trains.ts",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Frelease-trains.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Frelease-trains.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Frelease-trains.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -0,0 +1,21 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as semver from 'semver';\n+\n+/** Class describing a release-train. */\n+export class ReleaseTrain {\n+  /** Whether the release train is currently targeting a major. */\n+  isMajor = this.version.minor === 0 && this.version.patch === 0;\n+\n+  constructor(\n+      /** Name of the branch for this release-train. */\n+      public branchName: string,\n+      /** Most recent version for this release train. */\n+      public version: semver.SemVer) {}\n+}"
        },
        {
            "sha": "fbd72ef5a64bf32bf496c2c6a0cb4ec44ce82588",
            "filename": "dev-infra/release/versioning/version-branches.ts",
            "status": "added",
            "additions": 89,
            "deletions": 0,
            "changes": 89,
            "blob_url": "https://github.com/angular/angular/blob/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Fversion-branches.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dccaa9570841cc8a774b3eb421175bdf2aefba7/dev-infra%2Frelease%2Fversioning%2Fversion-branches.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Fversion-branches.ts?ref=9dccaa9570841cc8a774b3eb421175bdf2aefba7",
            "patch": "@@ -0,0 +1,89 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as semver from 'semver';\n+import {GithubClient, GithubRepo} from '../../utils/git/github';\n+\n+/** Type describing a Github repository with corresponding API client. */\n+export interface GithubRepoWithApi extends GithubRepo {\n+  /** API client that can access the repository. */\n+  api: GithubClient;\n+}\n+\n+/** Type describing a version-branch. */\n+export interface VersionBranch {\n+  /** Name of the branch in Git. e.g. `10.0.x`. */\n+  name: string;\n+  /**\n+   * Parsed SemVer version for the version-branch. Version branches technically do\n+   * not follow the SemVer format, but we can have representative SemVer versions\n+   * that can be used for comparisons, sorting and other checks.\n+   */\n+  parsed: semver.SemVer;\n+}\n+\n+/** Regular expression that matches version-branches. */\n+const versionBranchNameRegex = /(\\d+)\\.(\\d+)\\.x/;\n+\n+/** Gets the version of a given branch by reading the `package.json` upstream. */\n+export async function getVersionOfBranch(\n+    repo: GithubRepoWithApi, branchName: string): Promise<semver.SemVer> {\n+  const {data} = await repo.api.repos.getContents(\n+      {owner: repo.owner, repo: repo.name, path: '/package.json', ref: branchName});\n+  const {version} = JSON.parse(Buffer.from(data.content, 'base64').toString());\n+  const parsedVersion = semver.parse(version);\n+  if (parsedVersion === null) {\n+    throw Error(`Invalid version detected in following branch: ${branchName}.`);\n+  }\n+  return parsedVersion;\n+}\n+\n+/** Whether the given branch corresponds to a version branch. */\n+export function isVersionBranch(branchName: string): boolean {\n+  return versionBranchNameRegex.test(branchName);\n+}\n+\n+/**\n+ * Converts a given version-branch into a SemVer version that can be used with SemVer\n+ * utilities. e.g. to determine semantic order, extract major digit, compare.\n+ *\n+ * For example `10.0.x` will become `10.0.0` in SemVer. The patch digit is not\n+ * relevant but needed for parsing. SemVer does not allow `x` as patch digit.\n+ */\n+export function getVersionForVersionBranch(branchName: string): semver.SemVer|null {\n+  // Convert a given version-branch into a SemVer version that can be used\n+  // with the SemVer utilities. i.e. to determine semantic order.\n+  return semver.parse(branchName.replace(versionBranchNameRegex, '$1.$2.0'));\n+}\n+\n+/**\n+ * Gets the version branches for the specified major versions in descending\n+ * order. i.e. latest version branches first.\n+ */\n+export async function getBranchesForMajorVersions(\n+    repo: GithubRepoWithApi, majorVersions: number[]): Promise<VersionBranch[]> {\n+  const {data: branchData} =\n+      await repo.api.repos.listBranches({owner: repo.owner, repo: repo.name, protected: true});\n+  const branches: VersionBranch[] = [];\n+\n+  for (const {name} of branchData) {\n+    if (!isVersionBranch(name)) {\n+      continue;\n+    }\n+    // Convert the version-branch into a SemVer version that can be used with the\n+    // SemVer utilities. e.g. to determine semantic order, compare versions.\n+    const parsed = getVersionForVersionBranch(name);\n+    // Collect all version-branches that match the specified major versions.\n+    if (parsed !== null && majorVersions.includes(parsed.major)) {\n+      branches.push({name, parsed});\n+    }\n+  }\n+\n+  // Sort captured version-branches in descending order.\n+  return branches.sort((a, b) => semver.rcompare(a.parsed, b.parsed));\n+}"
        }
    ],
    "stats": {
        "total": 500,
        "additions": 321,
        "deletions": 179
    }
}