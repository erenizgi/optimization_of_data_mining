{
    "author": "devversion",
    "message": "test: run platform-server integration test with v13 partial compilation packages (#43431)\n\nUpdates the platform-server integration test to rely on the v13 partial\ncompilation packages. This involves setting up the Babel linker plugin.\nThis is a great addition for coverage of the Babel linker plugin.\n\nPR Close #43431",
    "sha": "859ca504f845ac95f6d932a6e3658e15a5625ea1",
    "files": [
        {
            "sha": "b6e0d9e47af1bc81f847426c756729727a0741e0",
            "filename": "integration/BUILD.bazel",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2FBUILD.bazel?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -100,7 +100,12 @@ INTEGRATION_TESTS = {\n             \"@angular/router\",\n         ],\n     },\n-    \"platform-server\": {\"tags\": [\"no-ivy-aot\"]},\n+    \"platform-server\": {\n+        # This test relies on ESM for running the app in SSR. RxJS added ESM resolution\n+        # support with RXJS v7. We allow the version to be pinned to v7.\n+        # TODO: Remove this and update the test once the project uses RxJS v7, or if rxjs v6 has ESM support.\n+        \"pinned_npm_packages\": [\"rxjs\"],\n+    },\n     \"service-worker-schema\": {},\n     # The `side-effects` test is currently disabled as it does not run the\n     # Angular linker plugin and therefore partial declarations are retained"
        },
        {
            "sha": "affdad5de38631e5f331a398851dad3acb6a25c2",
            "filename": "integration/platform-server/base-config.mjs",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fbase-config.mjs",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fbase-config.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fbase-config.mjs?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -0,0 +1,24 @@\n+import {dirname} from 'path';\n+import {fileURLToPath} from 'url';\n+import linkerPlugin from '@angular/compiler-cli/linker/babel';\n+\n+export const baseDir = dirname(fileURLToPath(import.meta.url));\n+export const moduleRules = [\n+  {\n+    test: /\\.txt$/i,\n+    use: 'raw-loader',\n+  },\n+  {\n+    test: /\\.m?js$/,\n+    // Exclude Domino from being processed by Babel as Babel reports an error\n+    // for invalid use of `with` in strict mode.\n+    // https://github.com/fgnass/domino/issues/153.\n+    exclude: /domino/,\n+    use: {\n+      loader: 'babel-loader',\n+      options: {\n+        plugins: [linkerPlugin],\n+      }\n+    }\n+  }\n+];"
        },
        {
            "sha": "010c1d095ed23a305a3186c77d8142ddeadafb62",
            "filename": "integration/platform-server/build.sh",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fbuild.sh",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fbuild.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fbuild.sh?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -2,15 +2,15 @@\n \n set -eu -o pipefail\n \n-rm -rf built\n+rm -rf built/ webpack-out/\n \n ngc\n \n-# This is to mainlt copy the index.html to be packaged into the server.\n+# This is to mainly copy the index.html to be packaged into the server.\n cp -r src/* built/src\n \n # Bundle the server which hosts all the server side apps.\n-webpack  --config webpack.server.config.js\n+webpack --config webpack.server.config.mjs\n \n # Bundle the clients into individual bundles.\n-webpack  --config webpack.client.config.js\n\\ No newline at end of file\n+webpack --config webpack.client.config.mjs"
        },
        {
            "sha": "8fe11d62c95bb6f2a51e38694a943f5b0acff409",
            "filename": "integration/platform-server/package.json",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fpackage.json?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -17,22 +17,22 @@\n     \"@angular/platform-browser-dynamic\": \"file:../../dist/packages-dist/platform-browser-dynamic\",\n     \"@angular/platform-server\": \"file:../../dist/packages-dist/platform-server\",\n     \"express\": \"4.16.4\",\n-    \"rxjs\": \"file:../../node_modules/rxjs\",\n+    \"rxjs\": \"^7.3.0\",\n     \"typescript\": \"file:../../node_modules/typescript\",\n     \"zone.js\": \"file:../../dist/zone.js-dist/archive/zone.js.tgz\"\n   },\n   \"devDependencies\": {\n+    \"@babel/core\": \"^7.15.5\",\n     \"@types/jasmine\": \"file:../../node_modules/@types/jasmine\",\n     \"@types/jasminewd2\": \"file:../../node_modules/@types/jasminewd2\",\n     \"@types/node\": \"file:../../node_modules/@types/node\",\n-    \"babel-core\": \"6.26.3\",\n-    \"babel-loader\": \"6.4.1\",\n-    \"babel-preset-es2015\": \"6.24.1\",\n+    \"babel-loader\": \"^8.2.2\",\n     \"concurrently\": \"3.1.0\",\n     \"protractor\": \"file:../../node_modules/protractor\",\n     \"puppeteer\": \"file:../../node_modules/puppeteer\",\n-    \"raw-loader\": \"0.5.1\",\n-    \"webpack\": \"2.7.0\"\n+    \"raw-loader\": \"^4.0.2\",\n+    \"webpack\": \"^5.53.0\",\n+    \"webpack-cli\": \"^4.8.0\"\n   },\n   \"//resolutions-comment\": \"Ensure a single version of webdriver-manager which comes from root node_modules that has already run webdriver-manager update\",\n   \"resolutions\": {\n@@ -41,7 +41,7 @@\n   \"scripts\": {\n     \"build\": \"./build.sh\",\n     \"test\": \"yarn build && concurrently \\\"yarn serve\\\" \\\"yarn protractor\\\" --kill-others --success first\",\n-    \"serve\": \"node built/server-bundle.js\",\n+    \"serve\": \"node webpack-out/server-bundle.js\",\n     \"preprotractor\": \"tsc -p e2e\",\n     \"protractor\": \"protractor e2e/protractor.config.js\"\n   }"
        },
        {
            "sha": "18cdcf49eb74b45493a1840fcce11b62cb4540b6",
            "filename": "integration/platform-server/src/helloworld/client.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fsrc%2Fhelloworld%2Fclient.ts",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fsrc%2Fhelloworld%2Fclient.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fsrc%2Fhelloworld%2Fclient.ts?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -8,10 +8,9 @@\n \n import 'zone.js/bundles/zone.umd';\n \n-import {enableProdMode} from '@angular/core';\n import {platformBrowser} from '@angular/platform-browser';\n-import {HelloWorldModuleNgFactory} from './app.ngfactory';\n+import {HelloWorldModule} from './app';\n \n window['doBootstrap'] = function() {\n-  platformBrowser().bootstrapModuleFactory(HelloWorldModuleNgFactory);\n+  platformBrowser().bootstrapModule(HelloWorldModule);\n };"
        },
        {
            "sha": "07d9843ae2f038034a02d1629e5213dfeaee879d",
            "filename": "integration/platform-server/src/helloworld/index.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fsrc%2Fhelloworld%2Findex.html",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fsrc%2Fhelloworld%2Findex.html",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fsrc%2Fhelloworld%2Findex.html?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -2,7 +2,7 @@\n <head>\n \t<meta charset=\"UTF-8\">\n \t<title>Hello World</title>\n-  <script src=\"built/helloworld-bundle.js\"></script>\n+  <script src=\"webpack-out/helloworld-bundle.js\"></script>\n </head>\n <body>\n   <hello-world-app></hello-world-app>"
        },
        {
            "sha": "41f844999021faa363457d2031fdf3ffe5954539",
            "filename": "integration/platform-server/src/server.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fsrc%2Fserver.ts",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fsrc%2Fserver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fsrc%2Fserver.ts?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -8,21 +8,21 @@\n /* tslint:disable:no-console  */\n require('zone.js/bundles/zone-node.umd.js');\n \n-import {enableProdMode, NgModuleFactory} from '@angular/core';\n-import {renderModuleFactory} from '@angular/platform-server';\n+import {enableProdMode, Type} from '@angular/core';\n+import {renderModule} from '@angular/platform-server';\n import * as express from 'express';\n \n-import {HelloWorldServerModuleNgFactory} from './helloworld/app.server.ngfactory';\n-const helloworld = require('raw-loader!./helloworld/index.html');\n+import {HelloWorldServerModule} from './helloworld/app.server';\n+const {default: helloworld} = require('raw-loader!./helloworld/index.html');\n \n-import {TransferStateServerModuleNgFactory} from './transferstate/app.server.ngfactory';\n-const transferstate = require('raw-loader!./transferstate/index.html');\n+import {TransferStateServerModule} from './transferstate/app.server';\n+const {default: transferstate} = require('raw-loader!./transferstate/index.html');\n \n const app = express();\n \n-function render<T>(moduleFactory: NgModuleFactory<T>, html: string) {\n+function render(moduleType: Type<any>, html: string) {\n   return (req, res) => {\n-    renderModuleFactory(moduleFactory, {\n+    renderModule(moduleType, {\n       document: html,\n       url: req.url,\n     }).then((response) => { res.send(response); });\n@@ -32,13 +32,13 @@ function render<T>(moduleFactory: NgModuleFactory<T>, html: string) {\n enableProdMode();\n \n // Client bundles will be statically served from the built/ directory.\n-app.use('/built', express.static('built'));\n+app.use('/webpack-out', express.static('webpack-out'));\n \n // Keep the browser logs free of errors.\n app.get('/favicon.ico', (req, res) => { res.send(''); });\n \n //-----------ADD YOUR SERVER SIDE RENDERED APP HERE ----------------------\n-app.get('/helloworld', render(HelloWorldServerModuleNgFactory, helloworld));\n-app.get('/transferstate', render(TransferStateServerModuleNgFactory, transferstate));\n+app.get('/helloworld', render(HelloWorldServerModule, helloworld));\n+app.get('/transferstate', render(TransferStateServerModule, transferstate));\n \n app.listen(4206, function() { console.log('Server listening on port 4206!'); });"
        },
        {
            "sha": "1380b42d5dc9127948593cbe5144363937dd4119",
            "filename": "integration/platform-server/src/transferstate/client.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fsrc%2Ftransferstate%2Fclient.ts",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fsrc%2Ftransferstate%2Fclient.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fsrc%2Ftransferstate%2Fclient.ts?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -8,10 +8,9 @@\n \n import 'zone.js/bundles/zone.umd';\n \n-import {enableProdMode} from '@angular/core';\n import {platformBrowser} from '@angular/platform-browser';\n-import {TransferStateModuleNgFactory} from './app.ngfactory';\n+import {TransferStateModule} from './app';\n \n window['doBootstrap'] = function() {\n-  platformBrowser().bootstrapModuleFactory(TransferStateModuleNgFactory);\n+  platformBrowser().bootstrapModule(TransferStateModule);\n };"
        },
        {
            "sha": "41cb4389dcbacc2652046350a275154d21833056",
            "filename": "integration/platform-server/src/transferstate/index.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fsrc%2Ftransferstate%2Findex.html",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fsrc%2Ftransferstate%2Findex.html",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fsrc%2Ftransferstate%2Findex.html?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -2,7 +2,7 @@\n <head>\n \t<meta charset=\"UTF-8\">\n \t<title>Hello World</title>\n-  <script src=\"built/transferstate-bundle.js\"></script>\n+  <script src=\"webpack-out/transferstate-bundle.js\"></script>\n </head>\n <body>\n   <transfer-state-app></transfer-state-app>"
        },
        {
            "sha": "a9b3dd5625669401e9debff3f495932739b4cb6d",
            "filename": "integration/platform-server/tsconfig.json",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Ftsconfig.json",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Ftsconfig.json?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -1,14 +1,10 @@\n {\n-  \"angularCompilerOptions\": {\n-    \"enableIvy\": false,\n-  },\n-\n   \"compilerOptions\": {\n-    \"module\": \"es2015\",\n+    \"module\": \"es2020\",\n     \"moduleResolution\": \"node\",\n     // TODO(i): strictNullChecks should turned on but are temporarily disabled due to #15432\n     \"strictNullChecks\": false,\n-    \"target\": \"es6\",\n+    \"target\": \"es2020\",\n     \"noImplicitAny\": false,\n     \"sourceMap\": false,\n     \"experimentalDecorators\": true,"
        },
        {
            "sha": "2e1dbf91d066789f313d011c2c2fbae9d1aa2425",
            "filename": "integration/platform-server/webpack.client.config.mjs",
            "status": "renamed",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fwebpack.client.config.mjs",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fwebpack.client.config.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fwebpack.client.config.mjs?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -6,14 +6,18 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-const path = require('path');\n+import * as path from 'path';\n+import {moduleRules, baseDir} from './base-config.mjs';\n \n-module.exports = {\n+export default {\n   entry: {\n     helloworld: './built/src/helloworld/client.js',\n     transferstate: './built/src/transferstate/client.js',\n   },\n-  output: {path: path.join(__dirname, 'built'), filename: '[name]-bundle.js'},\n-  module: {loaders: [{test: /\\.js$/, loader: 'babel-loader?presets[]=es2015'}]},\n-  resolve: {extensions: ['.js']}\n+  // Allow for better debugging of this integration test.\n+  optimization: {minimize: false},\n+  output: {path: path.join(baseDir, 'webpack-out'), filename: '[name]-bundle.js'},\n+  module: {\n+    rules: moduleRules,\n+  }\n };",
            "previous_filename": "integration/platform-server/webpack.client.config.js"
        },
        {
            "sha": "c5c7e1dd8aa64caed7995e7269f5b469613e6e07",
            "filename": "integration/platform-server/webpack.server.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/c569b693529da5820443da13cb1de3575e45bb8d/integration%2Fplatform-server%2Fwebpack.server.config.js",
            "raw_url": "https://github.com/angular/angular/raw/c569b693529da5820443da13cb1de3575e45bb8d/integration%2Fplatform-server%2Fwebpack.server.config.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fwebpack.server.config.js?ref=c569b693529da5820443da13cb1de3575e45bb8d",
            "patch": "@@ -1,14 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-module.exports = {\n-  target: 'node',\n-  entry: './built/src/server.js',\n-  output: {filename: './built/server-bundle.js'},\n-  resolve: {extensions: ['.js']},\n-};"
        },
        {
            "sha": "aa0902a3da41b0b7925071a9168a2a8a2dd9d219",
            "filename": "integration/platform-server/webpack.server.config.mjs",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fwebpack.server.config.mjs",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fwebpack.server.config.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fwebpack.server.config.mjs?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1",
            "patch": "@@ -0,0 +1,23 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as path from 'path';\n+import {moduleRules, baseDir} from './base-config.mjs';\n+\n+export default {\n+  target: 'node',\n+  entry: './built/src/server.js',\n+  // Allow for better debugging of this integration test.\n+  // Also works around an issue where Domino is minimized incorrectly:\n+  // https://github.com/fgnass/domino/issues/146.\n+  optimization: {minimize: false},\n+  output: {path: path.join(baseDir, 'webpack-out'), filename: './server-bundle.js'},\n+  module: {\n+    rules: moduleRules,\n+  }\n+};"
        },
        {
            "sha": "6f6027ceed71d6945d3871573029c99608849556",
            "filename": "integration/platform-server/yarn.lock",
            "status": "modified",
            "additions": 1289,
            "deletions": 2739,
            "changes": 4028,
            "blob_url": "https://github.com/angular/angular/blob/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fyarn.lock",
            "raw_url": "https://github.com/angular/angular/raw/859ca504f845ac95f6d932a6e3658e15a5625ea1/integration%2Fplatform-server%2Fyarn.lock",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fplatform-server%2Fyarn.lock?ref=859ca504f845ac95f6d932a6e3658e15a5625ea1"
        }
    ],
    "stats": {
        "total": 4176,
        "additions": 1381,
        "deletions": 2795
    }
}