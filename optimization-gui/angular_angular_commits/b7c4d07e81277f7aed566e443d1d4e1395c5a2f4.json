{
    "author": "alan-agius4",
    "message": "fix(compiler-cli): `readConfiguration` existing options should override options in tsconfig (#40694)\n\nAt the moment, when passing an Angular Compiler option\nin the `existingOptions` it doesn't override the defined in the TSConfig.\n\nPR Close #40694",
    "sha": "b7c4d07e81277f7aed566e443d1d4e1395c5a2f4",
    "files": [
        {
            "sha": "522b5af41f0aeb42ad68944550c8848608c2510c",
            "filename": "packages/compiler-cli/src/perform_compile.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 47,
            "changes": 86,
            "blob_url": "https://github.com/angular/angular/blob/b7c4d07e81277f7aed566e443d1d4e1395c5a2f4/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "raw_url": "https://github.com/angular/angular/raw/b7c4d07e81277f7aed566e443d1d4e1395c5a2f4/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts?ref=b7c4d07e81277f7aed566e443d1d4e1395c5a2f4",
            "patch": "@@ -10,6 +10,7 @@ import {isSyntaxError, Position} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {absoluteFrom, AbsoluteFsPath, getFileSystem, ReadonlyFileSystem, relative, resolve} from '../src/ngtsc/file_system';\n+import {NgCompilerOptions} from './ngtsc/core/api';\n \n import {replaceTsWithNgInErrors} from './ngtsc/diagnostics';\n import * as api from './transformers/api';\n@@ -132,39 +133,28 @@ export function calcProjectFileAndBasePath(\n   return {projectFile, basePath};\n }\n \n-export function createNgCompilerOptions(\n-    basePath: string, config: any, tsOptions: ts.CompilerOptions): api.CompilerOptions {\n-  // enableIvy `ngtsc` is an alias for `true`.\n-  const {angularCompilerOptions = {}} = config;\n-  const {enableIvy} = angularCompilerOptions;\n-  angularCompilerOptions.enableIvy = enableIvy !== false && enableIvy !== 'tsc';\n-\n-  return {...tsOptions, ...angularCompilerOptions, genDir: basePath, basePath};\n-}\n-\n export function readConfiguration(\n-    project: string, existingOptions?: ts.CompilerOptions,\n+    project: string, existingOptions?: api.CompilerOptions,\n     host: ConfigurationHost = getFileSystem()): ParsedConfiguration {\n   try {\n-    const {projectFile, basePath} = calcProjectFileAndBasePath(project, host);\n-\n-    const readExtendedConfigFile =\n-        (configFile: string, existingConfig?: any): {config?: any, error?: ts.Diagnostic} => {\n-          const {config, error} =\n-              ts.readConfigFile(configFile, file => host.readFile(host.resolve(file)));\n+    const readConfigFile = (configFile: string) =>\n+        ts.readConfigFile(configFile, file => host.readFile(host.resolve(file)));\n+    const readAngularCompilerOptions =\n+        (configFile: string, parentOptions: NgCompilerOptions = {}): NgCompilerOptions => {\n+          const {config, error} = readConfigFile(configFile);\n \n           if (error) {\n-            return {error};\n+            // Errors are handled later on by 'parseJsonConfigFileContent'\n+            return parentOptions;\n           }\n \n           // we are only interested into merging 'angularCompilerOptions' as\n           // other options like 'compilerOptions' are merged by TS\n-          const baseConfig = existingConfig || config;\n-          if (existingConfig) {\n-            baseConfig.angularCompilerOptions = {\n-              ...config.angularCompilerOptions,\n-              ...baseConfig.angularCompilerOptions\n-            };\n+          let existingNgCompilerOptions: NgCompilerOptions;\n+          if (parentOptions && config.angularCompilerOptions) {\n+            existingNgCompilerOptions = {...config.angularCompilerOptions, ...parentOptions};\n+          } else {\n+            existingNgCompilerOptions = parentOptions || config.angularCompilerOptions;\n           }\n \n           if (config.extends) {\n@@ -174,16 +164,24 @@ export function readConfiguration(\n                 absoluteFrom(`${extendedConfigPath}.json`);\n \n             if (host.exists(extendedConfigPath)) {\n-              // Call read config recursively as TypeScript only merges CompilerOptions\n-              return readExtendedConfigFile(extendedConfigPath, baseConfig);\n+              // Call readAngularCompilerOptions recursively to merge NG Compiler options\n+              return readAngularCompilerOptions(extendedConfigPath, existingNgCompilerOptions);\n             }\n           }\n \n-          return {config: baseConfig};\n+          return existingNgCompilerOptions;\n         };\n \n-    const {config, error} = readExtendedConfigFile(projectFile);\n+    const parseConfigHost = {\n+      useCaseSensitiveFileNames: true,\n+      fileExists: host.exists.bind(host),\n+      readDirectory: ts.sys.readDirectory,\n+      readFile: ts.sys.readFile\n+    };\n \n+    const {projectFile, basePath} = calcProjectFileAndBasePath(project, host);\n+    const configFileName = host.resolve(host.pwd(), projectFile);\n+    const {config, error} = readConfigFile(projectFile);\n     if (error) {\n       return {\n         project,\n@@ -193,34 +191,28 @@ export function readConfiguration(\n         emitFlags: api.EmitFlags.Default\n       };\n     }\n-    const parseConfigHost = {\n-      useCaseSensitiveFileNames: true,\n-      fileExists: host.exists.bind(host),\n-      readDirectory: ts.sys.readDirectory,\n-      readFile: ts.sys.readFile\n+    const existingCompilerOptions = {\n+      genDir: basePath,\n+      basePath,\n+      ...readAngularCompilerOptions(configFileName),\n+      ...existingOptions,\n     };\n-    const configFileName = host.resolve(host.pwd(), projectFile);\n-    const parsed = ts.parseJsonConfigFileContent(\n-        config, parseConfigHost, basePath, existingOptions, configFileName);\n-    const rootNames = parsed.fileNames;\n-    const projectReferences = parsed.projectReferences;\n \n-    const options = createNgCompilerOptions(basePath, config, parsed.options);\n+    const {options, errors, fileNames: rootNames, projectReferences} =\n+        ts.parseJsonConfigFileContent(\n+            config, parseConfigHost, basePath, existingCompilerOptions, configFileName);\n+\n+    // Coerce to boolean as `enableIvy` can be `ngtsc|true|false|undefined` here.\n+    options.enableIvy = !!(options.enableIvy ?? true);\n+\n     let emitFlags = api.EmitFlags.Default;\n     if (!(options.skipMetadataEmit || options.flatModuleOutFile)) {\n       emitFlags |= api.EmitFlags.Metadata;\n     }\n     if (options.skipTemplateCodegen) {\n       emitFlags = emitFlags & ~api.EmitFlags.Codegen;\n     }\n-    return {\n-      project: projectFile,\n-      rootNames,\n-      projectReferences,\n-      options,\n-      errors: parsed.errors,\n-      emitFlags\n-    };\n+    return {project: projectFile, rootNames, projectReferences, options, errors, emitFlags};\n   } catch (e) {\n     const errors: ts.Diagnostic[] = [{\n       category: ts.DiagnosticCategory.Error,"
        },
        {
            "sha": "373108771b1607c62e6ff2e232695af42a95be7c",
            "filename": "packages/compiler-cli/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/b7c4d07e81277f7aed566e443d1d4e1395c5a2f4/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b7c4d07e81277f7aed566e443d1d4e1395c5a2f4/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel?ref=b7c4d07e81277f7aed566e443d1d4e1395c5a2f4",
            "patch": "@@ -135,6 +135,7 @@ ts_library(\n         \":test_utils\",\n         \"//packages/compiler\",\n         \"//packages/compiler-cli\",\n+        \"@npm//typescript\",\n     ],\n )\n "
        },
        {
            "sha": "3281f2dc28699a170f04005369b135b4eafa52d2",
            "filename": "packages/compiler-cli/test/perform_compile_spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/b7c4d07e81277f7aed566e443d1d4e1395c5a2f4/packages%2Fcompiler-cli%2Ftest%2Fperform_compile_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b7c4d07e81277f7aed566e443d1d4e1395c5a2f4/packages%2Fcompiler-cli%2Ftest%2Fperform_compile_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fperform_compile_spec.ts?ref=b7c4d07e81277f7aed566e443d1d4e1395c5a2f4",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import * as path from 'path';\n+import * as ts from 'typescript';\n \n import {readConfiguration} from '../src/perform_compile';\n \n@@ -77,4 +78,28 @@ describe('perform_compile', () => {\n        const {options} = readConfiguration(path.resolve(basePath, 'tsconfig-level-1.json'));\n        expect(options.enableIvy).toBe(false);\n      });\n+\n+  it('should override options defined in tsconfig with those defined in `existingOptions`', () => {\n+    support.writeFiles({\n+      'tsconfig-level-1.json': `{\n+          \"compilerOptions\": {\n+            \"target\": \"es2020\"\n+          },\n+          \"angularCompilerOptions\": {\n+            \"annotateForClosureCompiler\": true\n+          }\n+        }\n+      `\n+    });\n+\n+    const {options} = readConfiguration(\n+        path.resolve(basePath, 'tsconfig-level-1.json'),\n+        {annotateForClosureCompiler: false, target: ts.ScriptTarget.ES2015, enableIvy: false});\n+\n+    expect(options).toEqual(jasmine.objectContaining({\n+      enableIvy: false,\n+      target: ts.ScriptTarget.ES2015,\n+      annotateForClosureCompiler: false,\n+    }));\n+  });\n });"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 65,
        "deletions": 47
    }
}