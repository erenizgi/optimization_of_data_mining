{
    "author": "gkalpak",
    "message": "build: correctly publish `angular-in-memory-web-api` as CI build artifact (#41429)\n\nPreviously, the `angular-in-memory-web-api` package was built in\n`dist/packages-dist/misc/angular-in-memory-web-api/`. This was different\nfrom other Angular packages, which were placed directly in\n`dist/packages-dist/`. This caused the `create-package-archives.sh`\nscript to create an invalid `misc.tgz` archive (i.e. treating the\n`misc/` subdirectory as a package).\nSee, for example, the artifacts [here][1].\n\nThis commit changes the build scripts to have the\n`angular-in-memory-web-api` package built in\n`dist/angular-in-memory-web-api-dist/`, similar to how the `zone.js`\npackage is handled. It also updates the CircleCI config to correctly\npublish the `angular-in-memory-web-api` package to CI build artifacts.\n\n[1]: https://circleci.com/gh/angular/angular/951491\n\nPR Close #41429",
    "sha": "4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1",
    "files": [
        {
            "sha": "1263ed94b925439fcc663ae2c83c6da97caf547d",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1",
            "patch": "@@ -501,6 +501,7 @@ jobs:\n           root: *workspace_location\n           paths:\n             - ng/dist/packages-dist\n+            - ng/dist/angular-in-memory-web-api-dist\n             - ng/dist/zone.js-dist\n \n       # Save dependencies and bazel repository cache to use on subsequent runs.\n@@ -527,6 +528,7 @@ jobs:\n           root: *workspace_location\n           paths:\n             - ng/dist/packages-dist-ivy-aot\n+            - ng/dist/angular-in-memory-web-api-dist-ivy-aot\n             - ng/dist/zone.js-dist-ivy-aot\n \n   # This job creates compressed tarballs (`.tgz` files) for all Angular packages and stores them as\n@@ -537,6 +539,8 @@ jobs:\n   publish_packages_as_artifacts:\n     executor: default-executor\n     environment:\n+      AIMWA_PACKAGES_DIR: &aimwa_packages_dir 'dist/angular-in-memory-web-api-dist'\n+      AIMWA_PACKAGES_ARCHIVES_DIR: &aimwa_packages_archives_dir 'dist/angular-in-memory-web-api-dist-archives'\n       NG_PACKAGES_DIR: &ng_packages_dir 'dist/packages-dist'\n       NG_PACKAGES_ARCHIVES_DIR: &ng_packages_archives_dir 'dist/packages-dist-archives'\n       ZONEJS_PACKAGES_DIR: &zonejs_packages_dir 'dist/zone.js-dist'\n@@ -551,9 +555,17 @@ jobs:\n       - store_artifacts:\n           path: *ng_packages_archives_dir\n           destination: angular\n-      # Publish `zone.js` package.\n+      # Publish the `angular-in-memory-web-api` package.\n       - run:\n-          name: Create artifacts for zone.js package\n+          name: Create artifacts for the `angular-in-memory-web-api` package\n+          # Need to remove the zone.js.tgz before archive\n+          command: ./scripts/ci/create-package-archives.sh $CI_BRANCH $CI_COMMIT $AIMWA_PACKAGES_DIR $AIMWA_PACKAGES_ARCHIVES_DIR\n+      - store_artifacts:\n+          path: *aimwa_packages_archives_dir\n+          destination: angular-in-memory-web-api\n+      # Publish the `zone.js` package.\n+      - run:\n+          name: Create artifacts for the `zone.js` package\n           # Need to remove the zone.js.tgz before archive\n           command: rm -rf $ZONEJS_PACKAGES_DIR/archive && ./scripts/ci/create-package-archives.sh $CI_BRANCH $CI_COMMIT $ZONEJS_PACKAGES_DIR $ZONEJS_PACKAGES_ARCHIVES_DIR\n       - store_artifacts:"
        },
        {
            "sha": "2e021a2e41e93484b34845ceddbdaae445589c00",
            "filename": "aio/tools/ng-packages-installer/index.js",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/aio%2Ftools%2Fng-packages-installer%2Findex.js",
            "raw_url": "https://github.com/angular/angular/raw/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/aio%2Ftools%2Fng-packages-installer%2Findex.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Fng-packages-installer%2Findex.js?ref=4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1",
            "patch": "@@ -14,8 +14,8 @@ const LOCAL_MARKER_PATH = 'node_modules/_local_.json';\n \n const ANGULAR_ROOT_DIR = path.resolve(__dirname, '../../..');\n const ANGULAR_DIST_PACKAGES_DIR = path.join(ANGULAR_ROOT_DIR, 'dist/packages-dist');\n+const AIMWA_DIST_PACKAGES_DIR = path.join(ANGULAR_ROOT_DIR, 'dist/angular-in-memory-web-api-dist');\n const ZONEJS_DIST_PACKAGES_DIR = path.join(ANGULAR_ROOT_DIR, 'dist/zone.js-dist');\n-const ANGULAR_MISC_DIST_PACKAGES = path.join(ANGULAR_ROOT_DIR, 'dist/packages-dist/misc');\n const DIST_PACKAGES_BUILD_SCRIPT = path.join(ANGULAR_ROOT_DIR, 'scripts/build/build-packages-dist.js');\n const DIST_PACKAGES_BUILD_CMD = `\"${process.execPath}\" \"${DIST_PACKAGES_BUILD_SCRIPT}\"`;\n \n@@ -187,8 +187,8 @@ class NgPackagesInstaller {\n       this._warn([\n         'Automatically building the local Angular/angular-in-memory-web-api/zone.js packages is currently not ' +\n           'supported on Windows.',\n-        `Please, ensure '${ANGULAR_DIST_PACKAGES_DIR}', '${ZONEJS_DIST_PACKAGES_DIR}' and ` +\n-          `'${ANGULAR_MISC_DIST_PACKAGES}' exist and are up-to-date (e.g. by running '${DIST_PACKAGES_BUILD_SCRIPT}' ` +\n+        `Please, ensure '${ANGULAR_DIST_PACKAGES_DIR}', '${AIMWA_DIST_PACKAGES_DIR}' and ` +\n+          `'${ZONEJS_DIST_PACKAGES_DIR}' exist and are up-to-date (e.g. by running '${DIST_PACKAGES_BUILD_SCRIPT}' ` +\n           'in Git Bash for Windows, Windows Subsystem for Linux or a Linux docker container or VM).',\n         '',\n         'Proceeding anyway...',\n@@ -224,9 +224,9 @@ class NgPackagesInstaller {\n    * 'package.json' file.)\n    */\n   _getDistPackages() {\n-    this._log(`Angular distributable directory: ${ANGULAR_DIST_PACKAGES_DIR}.`);\n-    this._log(`Zone.js distributable directory: ${ZONEJS_DIST_PACKAGES_DIR}.`);\n-    this._log(`angular-in-memory-web-api distributable directory: ${ANGULAR_MISC_DIST_PACKAGES}.`);\n+    this._log(`Distributable directory for Angular framework: ${ANGULAR_DIST_PACKAGES_DIR}`);\n+    this._log(`Distributable directory for angular-in-memory-web-api: ${AIMWA_DIST_PACKAGES_DIR}`);\n+    this._log(`Distributable directory for zone.js: ${ZONEJS_DIST_PACKAGES_DIR}`);\n \n     if (this.buildPackages) {\n       this._buildDistPackages();\n@@ -264,8 +264,8 @@ class NgPackagesInstaller {\n \n     const packageConfigs = {\n       ...collectPackages(ANGULAR_DIST_PACKAGES_DIR),\n+      ...collectPackages(AIMWA_DIST_PACKAGES_DIR),\n       ...collectPackages(ZONEJS_DIST_PACKAGES_DIR),\n-      ...collectPackages(ANGULAR_MISC_DIST_PACKAGES),\n     };\n \n     this._log('Found the following Angular distributables:', ...Object.keys(packageConfigs).map(key => `\\n - ${key}`));"
        },
        {
            "sha": "77ff633c1718f7bf65ddfd6adae66a4182f421f2",
            "filename": "aio/tools/ng-packages-installer/index.spec.js",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/aio%2Ftools%2Fng-packages-installer%2Findex.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/aio%2Ftools%2Fng-packages-installer%2Findex.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Fng-packages-installer%2Findex.spec.js?ref=4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1",
            "patch": "@@ -15,6 +15,7 @@ describe('NgPackagesInstaller', () => {\n   const yarnLockPath = path.resolve(absoluteProjectDir, 'yarn.lock');\n   const ngRootDir = path.resolve(__dirname, '../../..');\n   const packagesDir = path.join(ngRootDir, 'dist/packages-dist');\n+  const aimwaDir = path.join(ngRootDir, 'dist/angular-in-memory-web-api-dist');\n   const zoneJsDir = path.join(ngRootDir, 'dist/zone.js-dist');\n   const toolsDir = path.join(ngRootDir, 'dist/tools/@angular');\n   let installer;\n@@ -104,6 +105,13 @@ describe('NgPackagesInstaller', () => {\n             peerDependencies: { tsickle: '^1.4.0' }\n           }\n         },\n+        'angular-in-memory-web-api': {\n+          packageDir: `${aimwaDir}/angular-in-memory-web-api`,\n+          packageJsonPath: `${aimwaDir}/angular-in-memory-web-api/package.json`,\n+          config: {\n+            dependencies: { rxjs: '^6.3.0' }\n+          }\n+        },\n         'zone.js': {\n           packageDir: `${zoneJsDir}/zone.js`,\n           packageJsonPath: `${zoneJsDir}/zone.js/package.json`,\n@@ -124,6 +132,7 @@ describe('NgPackagesInstaller', () => {\n         },\n         devDependencies: {\n           '@angular/compiler-cli': '4.4.1',\n+          'angular-in-memory-web-api': '^0.11.0',\n           'rxjs-dev': '^6.3.0'\n         }\n       };\n@@ -149,6 +158,7 @@ describe('NgPackagesInstaller', () => {\n         },\n         devDependencies: {\n           '@angular/compiler-cli': `file:${toolsDir}/compiler-cli`,\n+          'angular-in-memory-web-api': `file:${aimwaDir}/angular-in-memory-web-api`,\n           'rxjs-dev': '^6.3.0',\n           'some-package': '5.0.1',\n           typescript: '^2.4.2'\n@@ -200,10 +210,10 @@ describe('NgPackagesInstaller', () => {\n         const stringifyConfig = config => JSON.stringify(config, null, 2);\n \n         const allArgs = fs.writeFileSync.calls.allArgs();\n-        const firstSixArgs = allArgs.slice(0, 6);\n-        const lastSixArgs = allArgs.slice(-6);\n+        const firstSevenArgs = allArgs.slice(0, 7);\n+        const lastSevenArgs = allArgs.slice(-7);\n \n-        expect(firstSixArgs).toEqual([\n+        expect(firstSevenArgs).toEqual([\n           [\n             pkgJsonPathFor('@angular/core'),\n             stringifyConfig(overwriteConfigFor('@angular/core', {private: true})),\n@@ -230,18 +240,23 @@ describe('NgPackagesInstaller', () => {\n               devDependencies: { '@angular/common': `file:${packagesDir}/common` },\n             })),\n           ],\n+          [\n+            pkgJsonPathFor('angular-in-memory-web-api'),\n+            stringifyConfig(overwriteConfigFor('angular-in-memory-web-api', {private: true})),\n+          ],\n           [\n             pkgJsonPathFor('zone.js'),\n             stringifyConfig(overwriteConfigFor('zone.js', {private: true})),\n           ],\n         ]);\n \n-        expect(lastSixArgs).toEqual([\n+        expect(lastSevenArgs).toEqual([\n           '@angular/core',\n           '@angular/common',\n           '@angular/compiler',\n           '@angular/compiler-cli',\n           '@angular/tsc-wrapped',\n+          'angular-in-memory-web-api',\n           'zone.js',\n         ].map(pkgName => [pkgJsonPathFor(pkgName), stringifyConfig(pkgConfigFor(pkgName))]));\n       });"
        },
        {
            "sha": "0e8ac2ddb4a5a7ab1512707339ae35cea5f85905",
            "filename": "scripts/build/angular-in-memory-web-api.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/scripts%2Fbuild%2Fangular-in-memory-web-api.js",
            "raw_url": "https://github.com/angular/angular/raw/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/scripts%2Fbuild%2Fangular-in-memory-web-api.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fangular-in-memory-web-api.js?ref=4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1",
            "patch": "@@ -21,6 +21,11 @@ module.exports = {\n  * Build the `angular-in-memory-web-api` npm package and copy it to `destDir` for other\n  * scripts/tests to use.\n  *\n+ * NOTE: The `angular-in-memory-web-api` package is not built as part of `package-builder`'s\n+ *       `buildTargetPackages()` nor is it copied into the same directory as the Angular packages\n+ *       (e.g. `dist/packages-dist/`) despite its source's being inside `packages/`, because it is\n+ *       not published to npm under the `@angular` scope (as happens for the rest of the packages).\n+ *\n  * @param {string} destDir Path to the output directory into which we copy the npm package.\n  *     This path should either be absolute or relative to the project root.\n  */"
        },
        {
            "sha": "64870240f9ffa9d09c917d1e3fa03a281407c29d",
            "filename": "scripts/build/build-ivy-npm-packages.js",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/scripts%2Fbuild%2Fbuild-ivy-npm-packages.js",
            "raw_url": "https://github.com/angular/angular/raw/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/scripts%2Fbuild%2Fbuild-ivy-npm-packages.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fbuild-ivy-npm-packages.js?ref=4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1",
            "patch": "@@ -17,14 +17,15 @@ const {buildZoneJsPackage} = require('./zone-js-builder');\n // Build the ivy packages into `dist/packages-dist-ivy-aot/`.\n buildTargetPackages('dist/packages-dist-ivy-aot', true, 'Ivy AOT');\n \n-// Build the `angular-in-memory-web-api` npm package into `dist/packages-dist-ivy-aot/misc/`,\n-// because it might be needed by other scripts/targets.\n+// Build the `angular-in-memory-web-api` npm package into\n+// `dist/angular-in-memory-web-api-dist-ivy-aot/`, because it might be needed by other\n+// scripts/targets.\n //\n // NOTE:\n // The `-ivy-aot` suffix is only used to differentiate from the packages built by the\n // `build-packages-dist.js` script, so that there is no conflict when persisting them to the\n // workspace on CI.\n-buildAngularInMemoryWebApiPackage('dist/packages-dist-ivy-aot/misc');\n+buildAngularInMemoryWebApiPackage('dist/angular-in-memory-web-api-dist-ivy-aot');\n \n // Build the `zone.js` npm package into `dist/zone.js-dist-ivy-aot/`, because it might be needed by\n // other scripts/tests."
        },
        {
            "sha": "428f61c7e18d66fc8ff9b54415e5dfddb361e945",
            "filename": "scripts/build/build-packages-dist.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/scripts%2Fbuild%2Fbuild-packages-dist.js",
            "raw_url": "https://github.com/angular/angular/raw/4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1/scripts%2Fbuild%2Fbuild-packages-dist.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fbuild-packages-dist.js?ref=4ae57cabd8cf97b4233ea4b0d621c7605dbe91b1",
            "patch": "@@ -21,9 +21,9 @@ buildTargetPackages('dist/packages-dist', false, 'Production');\n // Build the `angular-dev-infra` npm package into `dist/packages-dist/`.\n buildDevInfraPackage('dist/packages-dist');\n \n-// Build the `angular-in-memory-web-api` npm package into `dist/packages-dist/misc/`, because it\n-// might be needed by other scripts/targets.\n-buildAngularInMemoryWebApiPackage('dist/packages-dist/misc');\n+// Build the `angular-in-memory-web-api` npm package into `dist/angular-in-memory-web-api-dist/`,\n+// because it might be needed by other scripts/targets.\n+buildAngularInMemoryWebApiPackage('dist/angular-in-memory-web-api-dist');\n \n // Build the `zone.js` npm package into `dist/zone.js-dist/`, because it might be needed by other\n // scripts/tests."
        }
    ],
    "stats": {
        "total": 71,
        "additions": 52,
        "deletions": 19
    }
}