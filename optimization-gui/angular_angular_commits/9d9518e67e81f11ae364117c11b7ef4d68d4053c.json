{
    "author": "mgechev",
    "message": "feat(devtools): implement negation in the filtering query language",
    "sha": "9d9518e67e81f11ae364117c11b7ef4d68d4053c",
    "files": [
        {
            "sha": "3915cb0ca143539bd1ab75b4e482d7047ab974f5",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/profiler/recording/timeline/filter.spec.ts",
            "status": "modified",
            "additions": 87,
            "deletions": 14,
            "changes": 101,
            "blob_url": "https://github.com/angular/angular/blob/9d9518e67e81f11ae364117c11b7ef4d68d4053c/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Ffilter.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d9518e67e81f11ae364117c11b7ef4d68d4053c/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Ffilter.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Ffilter.spec.ts?ref=9d9518e67e81f11ae364117c11b7ef4d68d4053c",
            "patch": "@@ -15,32 +15,33 @@ describe('filtering', () => {\n     it('should return proper result with duration', () => {\n       const result = parseFilter('duration  :  =2');\n       expect(result.length).toBe(1);\n-      expect(result[0][0]).toBe('duration');\n-      expect(result[0][1]).toEqual(['=', 2]);\n+      expect(result[0][0]).toBe(true);\n+      expect(result[0][1]).toBe('duration');\n+      expect(result[0][2]).toEqual(['=', 2]);\n     });\n \n     it('should return proper result with source', () => {\n       const result = parseFilter('source  :  foobar');\n       expect(result.length).toBe(1);\n-      expect(result[0][0]).toBe('source');\n-      expect(result[0][1]).toEqual('foobar');\n+      expect(result[0][1]).toBe('source');\n+      expect(result[0][2]).toEqual('foobar');\n     });\n \n     it('should return proper result with composite filters', () => {\n       const result = parseFilter('source  : foobar  baz duration: >= 4200');\n       expect(result.length).toBe(2);\n-      expect(result[0][0]).toBe('source');\n-      expect(result[0][1]).toEqual('foobar  baz');\n+      expect(result[0][1]).toBe('source');\n+      expect(result[0][2]).toEqual('foobar  baz');\n \n-      expect(result[1][0]).toBe('duration');\n-      expect(result[1][1]).toEqual(['>=', 4200]);\n+      expect(result[1][1]).toBe('duration');\n+      expect(result[1][2]).toEqual(['>=', 4200]);\n     });\n \n     it('should ignore invalid operators', () => {\n       const result1 = parseFilter('sorce  : foobar  baz duration: >= 4200');\n       expect(result1.length).toBe(1);\n-      expect(result1[0][0]).toBe('duration');\n-      expect(result1[0][1]).toEqual(['>=', 4200]);\n+      expect(result1[0][1]).toBe('duration');\n+      expect(result1[0][2]).toEqual(['>=', 4200]);\n \n       const result2 = parseFilter('sorce  : foobar  baz dration: >= 4200');\n       expect(result2.length).toBe(0);\n@@ -49,11 +50,27 @@ describe('filtering', () => {\n     it('should consider decimal values in durations queries with a ms suffix', () => {\n       const result = parseFilter('source: foobar duration: >=42.42ms');\n       expect(result.length).toBe(2);\n-      expect(result[0][0]).toBe('source');\n-      expect(result[0][1]).toEqual('foobar');\n+      expect(result[0][1]).toBe('source');\n+      expect(result[0][2]).toEqual('foobar');\n \n-      expect(result[1][0]).toBe('duration');\n-      expect(result[1][1]).toEqual(['>=', 42.42]);\n+      expect(result[1][1]).toBe('duration');\n+      expect(result[1][2]).toEqual(['>=', 42.42]);\n+    });\n+\n+    it('should consider negation', () => {\n+      const result = parseFilter(' ! source: foobar !duration: >=42.42ms duration: >=42.42ms');\n+      expect(result.length).toBe(3);\n+      expect(result[0][0]).toBe(false);\n+      expect(result[0][1]).toBe('source');\n+      expect(result[0][2]).toEqual('foobar');\n+\n+      expect(result[1][0]).toBe(false);\n+      expect(result[1][1]).toBe('duration');\n+      expect(result[1][2]).toEqual(['>=', 42.42]);\n+\n+      expect(result[2][0]).toBe(true);\n+      expect(result[2][1]).toBe('duration');\n+      expect(result[2][2]).toEqual(['>=', 42.42]);\n     });\n   });\n \n@@ -190,5 +207,61 @@ describe('filtering', () => {\n         })\n       ).toBeTrue();\n     });\n+\n+    it('should work with negation', () => {\n+      const filter = createFilter('!source:message');\n+\n+      expect(\n+        filter({\n+          frame: {\n+            directives: [],\n+            duration: 15,\n+            source: 'message',\n+          },\n+          style: {},\n+          toolTip: '',\n+        })\n+      ).toBeFalse();\n+    });\n+\n+    it('should work with negation and composite expressions', () => {\n+      const filter = createFilter('!duration:=15 !source:message source:click');\n+\n+      expect(\n+        filter({\n+          frame: {\n+            directives: [],\n+            duration: 15,\n+            source: 'click',\n+          },\n+          style: {},\n+          toolTip: '',\n+        })\n+      ).toBeFalse();\n+\n+      expect(\n+        filter({\n+          frame: {\n+            directives: [],\n+            duration: 10,\n+            source: 'message',\n+          },\n+          style: {},\n+          toolTip: '',\n+        })\n+      ).toBeFalse();\n+\n+      expect(\n+        filter({\n+          frame: {\n+            directives: [],\n+            duration: 14,\n+            source: 'click',\n+          },\n+          style: {},\n+          toolTip: '',\n+        })\n+      ).toBeTrue();\n+    });\n   });\n });"
        },
        {
            "sha": "626536aa2d9f4975b1890bab33c253ff36666a92",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/profiler/recording/timeline/filter.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 7,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/9d9518e67e81f11ae364117c11b7ef4d68d4053c/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Ffilter.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d9518e67e81f11ae364117c11b7ef4d68d4053c/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Ffilter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Ffilter.ts?ref=9d9518e67e81f11ae364117c11b7ef4d68d4053c",
            "patch": "@@ -78,14 +78,27 @@ const queryMap: { [query in QueryType]: Query } = [new DurationQuery(), new Sour\n   return map;\n }, {} as { [query in QueryType]: Query });\n \n-const queryRe = new RegExp(`(${QueryType.Duration}|${QueryType.Source})$`, 'g');\n-\n-export const parseFilter = (query: string): [QueryType, QueryArguments][] => {\n+const queryRe = new RegExp(`!?\\s*(${QueryType.Duration}|${QueryType.Source})$`, 'g');\n+\n+type Predicate = true | false;\n+type QueryAST = [Predicate, QueryType, QueryArguments];\n+\n+/**\n+ * Parses a query in the form:\n+ *  filter := ('!'? query)*\n+ *  query := 'sort': [a-z]* | 'duration': operator duration\n+ *  operator := '=' | '>' | '<' | '>=' | '<='\n+ *  duration := [0-9]* 'ms'?\n+ *\n+ * @param query string that represents the search query\n+ * @returns tuples representing the query type and its arguments\n+ */\n+export const parseFilter = (query: string): QueryAST[] => {\n   const parts = query.split(':').map((part) => part.trim());\n   if (parts.length <= 1) {\n     return [];\n   }\n-  const result: [QueryType, QueryArguments][] = [];\n+  const result: QueryAST[] = [];\n   for (let i = 0; i < parts.length - 1; i++) {\n     const part = parts[i];\n     if (!queryRe.test(part)) {\n@@ -104,20 +117,22 @@ export const parseFilter = (query: string): [QueryType, QueryArguments][] => {\n     if (!operand) {\n       continue;\n     }\n-    result.push([operator.name, operand]);\n+    const hasNegation = /^(.*?)\\s*!\\s*\\w+/.test(part);\n+    result.push([!hasNegation, operator.name, operand]);\n   }\n   return result;\n };\n \n export const createFilter = (query: string) => {\n   const queries = parseFilter(query);\n   return (frame: GraphNode) => {\n-    return queries.every(([queryName, args]) => {\n+    return queries.every(([predicate, queryName, args]) => {\n       const currentQuery = queryMap[queryName];\n       if (!currentQuery) {\n         return true;\n       }\n-      return currentQuery.apply(frame.frame, args);\n+      const result = currentQuery.apply(frame.frame, args);\n+      return predicate ? result : !result;\n     });\n   };\n };"
        }
    ],
    "stats": {
        "total": 130,
        "additions": 109,
        "deletions": 21
    }
}