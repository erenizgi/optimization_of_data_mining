{
    "author": "clydin",
    "message": "refactor(migrations): ensure CommonJS migrations can be accessed (#43657)\n\nThe `@angular/core` migrations are currently published as CommonJS and also not bundled. Schematics, of which migrations are a type, are currently required to be CommonJS modules due to the Schematics Runtime not yet supporting ESM-based schematics. To ensure that the migration files are loaded as CommonJS modules, a nested `package.json` file has been introduced within the `schematics` directory of the package to set the `type` field for all containing JavaScript files as CommonJS. Since the migrations are also not currently bundled and the `devmode` output used to build the migrations will replace all relative imports with fully-qualified module specifiers, an additional `exports` entry must be added to allow the fully-qualified module specifiers to correctly resolve. If `devmode` did not change the relative imports the additional entry would not be needed. Bundling would also remedy the situation and is the long-term path, especially once the migrations are converted to ESM. Additional followup changes should investigate bundling each migration. The additional `exports` entry should be removed if either `devmode` behavior is changed or the migrations are bundled.\n\nPR Close #43657",
    "sha": "6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9",
    "files": [
        {
            "sha": "ea19bf0fba8a560ac7bb8faef1c3555d79ca4cb0",
            "filename": "packages/bazel/test/ng_package/core_package.spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9/packages%2Fbazel%2Ftest%2Fng_package%2Fcore_package.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9/packages%2Fbazel%2Ftest%2Fng_package%2Fcore_package.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fcore_package.spec.ts?ref=6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9",
            "patch": "@@ -72,6 +72,9 @@ describe('@angular/core ng_package', () => {\n               node: './fesm2015/testing.mjs',\n               default: './fesm2020/testing.mjs',\n             },\n+            './schematics/*': {\n+              'default': './schematics/*.js',\n+            },\n           }\n         }));\n       });"
        },
        {
            "sha": "0dde09a527c7d40cbd37d77b445c09cc9d1debee",
            "filename": "packages/core/package.json",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9/packages%2Fcore%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9/packages%2Fcore%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fpackage.json?ref=6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9",
            "patch": "@@ -7,6 +7,11 @@\n   \"engines\": {\n     \"node\": \"^12.14.1 || >=14.0.0\"\n   },\n+  \"exports\": {\n+    \"./schematics/*\": {\n+      \"default\": \"./schematics/*.js\"\n+    }\n+  },\n   \"dependencies\": {\n     \"tslib\": \"^2.3.0\"\n   },"
        },
        {
            "sha": "a1397b8bb0a738bae1b96725f374480f21a3982e",
            "filename": "packages/core/schematics/BUILD.bazel",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2FBUILD.bazel?ref=6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9",
            "patch": "@@ -7,7 +7,10 @@ exports_files([\n \n pkg_npm(\n     name = \"npm_package\",\n-    srcs = [\"migrations.json\"],\n+    srcs = [\n+        \"migrations.json\",\n+        \"package.json\",\n+    ],\n     visibility = [\"//packages/core:__pkg__\"],\n     deps = [\n         \"//packages/core/schematics/migrations/abstract-control-parent\","
        },
        {
            "sha": "5bbefffbabee392d1855491b84dc0a716b6a3bf2",
            "filename": "packages/core/schematics/package.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9/packages%2Fcore%2Fschematics%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9/packages%2Fcore%2Fschematics%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fpackage.json?ref=6d1c2f79da9e034308c7f2cfbd16499e0cfd51f9",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"type\": \"commonjs\"\n+}"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 15,
        "deletions": 1
    }
}