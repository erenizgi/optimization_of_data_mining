{
    "author": "josephperrott",
    "message": "feat(dev-infra): include CI status check in the caretaker check (#38779)\n\nAdd a CI status check in the ng-dev caretaker check command.\n\nPR Close #38779",
    "sha": "b9ca6d20ccd4372222303953c34aa67df84fd965",
    "files": [
        {
            "sha": "ebd51125f8342a1de1872c6389a98a9e1d7c2d94",
            "filename": "dev-infra/caretaker/check/check.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/b9ca6d20ccd4372222303953c34aa67df84fd965/dev-infra%2Fcaretaker%2Fcheck%2Fcheck.ts",
            "raw_url": "https://github.com/angular/angular/raw/b9ca6d20ccd4372222303953c34aa67df84fd965/dev-infra%2Fcaretaker%2Fcheck%2Fcheck.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fcheck.ts?ref=b9ca6d20ccd4372222303953c34aa67df84fd965",
            "patch": "@@ -9,6 +9,7 @@\n import {GitClient} from '../../utils/git';\n import {getCaretakerConfig} from '../config';\n \n+import {printCiStatus} from './ci';\n import {printG3Comparison} from './g3';\n import {printGithubTasks} from './github';\n import {printServiceStatuses} from './services';\n@@ -21,7 +22,9 @@ export async function checkServiceStatuses(githubToken: string) {\n   /** The GitClient for interacting with git and Github. */\n   const git = new GitClient(githubToken, config);\n \n+  // TODO(josephperrott): Allow these checks to be loaded in parallel.\n   await printServiceStatuses();\n   await printGithubTasks(git, config.caretaker);\n   await printG3Comparison(git);\n+  await printCiStatus(git);\n }"
        },
        {
            "sha": "2e568e14d5ed7de02f42b648d62cde05b625c828",
            "filename": "dev-infra/caretaker/check/ci.ts",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/b9ca6d20ccd4372222303953c34aa67df84fd965/dev-infra%2Fcaretaker%2Fcheck%2Fci.ts",
            "raw_url": "https://github.com/angular/angular/raw/b9ca6d20ccd4372222303953c34aa67df84fd965/dev-infra%2Fcaretaker%2Fcheck%2Fci.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fci.ts?ref=b9ca6d20ccd4372222303953c34aa67df84fd965",
            "patch": "@@ -0,0 +1,59 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import fetch from 'node-fetch';\n+\n+import {bold, green, info, red} from '../../utils/console';\n+import {GitClient} from '../../utils/git';\n+\n+\n+/** The results of checking the status of CI.  */\n+interface StatusCheckResult {\n+  status: 'success'|'failed'|'canceled'|'infrastructure_fail'|'timedout'|'failed'|'no_tests';\n+  timestamp: Date;\n+  buildUrl: string;\n+}\n+\n+/** Retrieve and log status of CI for the project. */\n+export async function printCiStatus(git: GitClient) {\n+  info.group(bold(`CI`));\n+  // TODO(josephperrott): Expand list of branches checked to all active branches.\n+  await printStatus(git, 'master');\n+  info.groupEnd();\n+  info();\n+}\n+\n+/** Log the status of CI for a given branch to the console. */\n+async function printStatus(git: GitClient, branch: string) {\n+  const result = await getStatusOfBranch(git, branch);\n+  const branchName = branch.padEnd(10);\n+  if (result === null) {\n+    info(`${branchName} was not found on CircleCI`);\n+  } else if (result.status === 'success') {\n+    info(`${branchName} ✅`);\n+  } else {\n+    info(`${branchName} ❌ (Ran at: ${result.timestamp.toLocaleString()})`);\n+  }\n+}\n+\n+/** Get the CI status of a given branch from CircleCI. */\n+async function getStatusOfBranch(git: GitClient, branch: string): Promise<StatusCheckResult|null> {\n+  const {owner, name} = git.remoteConfig;\n+  const url = `https://circleci.com/api/v1.1/project/gh/${owner}/${name}/tree/${\n+      branch}?limit=1&filter=completed&shallow=true`;\n+  const result = (await fetch(url).then(result => result.json()))?.[0];\n+\n+  if (result) {\n+    return {\n+      status: result.outcome,\n+      timestamp: new Date(result.stop_time),\n+      buildUrl: result.build_url\n+    };\n+  }\n+  return null;\n+}"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 62,
        "deletions": 0
    }
}