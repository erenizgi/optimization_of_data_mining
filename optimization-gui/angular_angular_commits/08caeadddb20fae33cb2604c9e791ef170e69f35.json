{
    "author": "crisbeto",
    "message": "fix(core): avoid duplicating comments in TestBed teardown migration (#43776)\n\nCurrently the TestBed teardown migration is set up in a similar way to all other migrations where we take a `CallExpression`, add a parameter to it, print it, and replace the existing call. The problem is that doing so while preserving the `expression` of the original `CallExpression` can cause comments to be duplicated. This can happen quite frequently, because by default the CLI generates comments before `initTestModule` calls.\n\nTo work around it, these changes make the migration more precise by inserting a new parameter or replacing and existing one using string manipulation.\n\nThis requires a bit more code, but it's more reliable than the following alternatives:\n1. Using `getFullStart` and `getFullWidth` to replace the node. This would work with our current setup, but the problem is that `getFullStart` also includes whitespace and newlines before the leading comment. This can cause us to mess up the user's formatting and figuring out which whitespace to keep and which one to remove is tricky.\n2. Recreating the `CallExpression.expression` when constructing the new node. This would also work since it'll drop any existing comments, but the problem is that `CallExpression.expression` can be a wide variety of nodes which we would have to account for. We can't use `getMutableClone`, because it preserves the comments.\n\nFixes #43739.\n\nPR Close #43776",
    "sha": "08caeadddb20fae33cb2604c9e791ef170e69f35",
    "files": [
        {
            "sha": "4277395da47f305300d8ad3ecf7fd78ef6986e70",
            "filename": "packages/core/schematics/migrations/google3/testbedTeardownRule.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 16,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/08caeadddb20fae33cb2604c9e791ef170e69f35/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FtestbedTeardownRule.ts",
            "raw_url": "https://github.com/angular/angular/raw/08caeadddb20fae33cb2604c9e791ef170e69f35/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FtestbedTeardownRule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FtestbedTeardownRule.ts?ref=08caeadddb20fae33cb2604c9e791ef170e69f35",
            "patch": "@@ -8,7 +8,7 @@\n \n import {Replacement, RuleFailure, Rules} from 'tslint';\n import ts from 'typescript';\n-import {findInitTestEnvironmentCalls, findTestModuleMetadataNodes, InitTestEnvironmentAnalysis, migrateInitTestEnvironment, migrateTestModuleMetadataLiteral} from '../testbed-teardown/util';\n+import {findInitTestEnvironmentCalls, findTestModuleMetadataNodes, getInitTestEnvironmentLiteralReplacement, InitTestEnvironmentAnalysis, migrateTestModuleMetadataLiteral} from '../testbed-teardown/util';\n \n /** TSLint rule that adds the `teardown` flag to `TestBed` calls. */\n export class Rule extends Rules.TypedRule {\n@@ -42,31 +42,31 @@ export class Rule extends Rules.TypedRule {\n     if (initTestEnvironmentResult.totalCalls > 0) {\n       // Migrate all of the unmigrated calls `initTestEnvironment` in this file. This could be zero\n       // if the user has already opted into the new teardown behavior themselves.\n-      initTestEnvironmentResult.callsToMigrate.forEach(call => {\n+      initTestEnvironmentResult.callsToMigrate.forEach(node => {\n         // This analysis is global so we need to check that the call is within this file.\n-        if (call.getSourceFile() === sourceFile) {\n-          failures.push(this._getFailure(call, migrateInitTestEnvironment, printer));\n+        if (node.getSourceFile() === sourceFile) {\n+          const {span, text} = getInitTestEnvironmentLiteralReplacement(node, printer);\n+\n+          failures.push(new RuleFailure(\n+              sourceFile, span.start, span.end, 'Teardown behavior has to be configured.',\n+              this.ruleName, new Replacement(span.start, span.length, text)));\n         }\n       });\n     } else {\n       // Otherwise migrate the metadata passed into the `configureTestingModule` and `withModule`\n       // calls. This scenario is less likely, but it could happen if `initTestEnvironment` has been\n       // abstracted away or is inside a .js file.\n-      findTestModuleMetadataNodes(typeChecker, sourceFile).forEach(literal => {\n-        failures.push(this._getFailure(literal, migrateTestModuleMetadataLiteral, printer));\n+      findTestModuleMetadataNodes(typeChecker, sourceFile).forEach(node => {\n+        const sourceFile = node.getSourceFile();\n+        const migrated = migrateTestModuleMetadataLiteral(node);\n+        const replacementText = printer.printNode(ts.EmitHint.Unspecified, migrated, sourceFile);\n+\n+        failures.push(new RuleFailure(\n+            sourceFile, node.getStart(), node.getEnd(), 'Teardown behavior has to be configured.',\n+            this.ruleName, new Replacement(node.getStart(), node.getWidth(), replacementText)));\n       });\n     }\n \n     return failures;\n   }\n-\n-  private _getFailure<T extends ts.Node>(node: T, migrator: (node: T) => T, printer: ts.Printer) {\n-    const sourceFile = node.getSourceFile();\n-    const migrated = migrator(node);\n-    const replacementText = printer.printNode(ts.EmitHint.Unspecified, migrated, sourceFile);\n-\n-    return new RuleFailure(\n-        sourceFile, node.getStart(), node.getEnd(), 'Teardown behavior has to be configured.',\n-        this.ruleName, new Replacement(node.getStart(), node.getWidth(), replacementText));\n-  }\n }"
        },
        {
            "sha": "e741614e7b65cb64fee634f2940eda6b027b1c0b",
            "filename": "packages/core/schematics/migrations/testbed-teardown/index.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 16,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/08caeadddb20fae33cb2604c9e791ef170e69f35/packages%2Fcore%2Fschematics%2Fmigrations%2Ftestbed-teardown%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/08caeadddb20fae33cb2604c9e791ef170e69f35/packages%2Fcore%2Fschematics%2Fmigrations%2Ftestbed-teardown%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Ftestbed-teardown%2Findex.ts?ref=08caeadddb20fae33cb2604c9e791ef170e69f35",
            "patch": "@@ -12,7 +12,7 @@ import ts from 'typescript';\n \n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n-import {findInitTestEnvironmentCalls, findTestModuleMetadataNodes, migrateInitTestEnvironment, migrateTestModuleMetadataLiteral} from './util';\n+import {findInitTestEnvironmentCalls, findTestModuleMetadataNodes, getInitTestEnvironmentLiteralReplacement, migrateTestModuleMetadataLiteral} from './util';\n \n \n /** Migration that adds the `teardown` flag to `TestBed` calls. */\n@@ -48,28 +48,30 @@ function runTestbedTeardownMigration(tree: Tree, tsconfigPath: string, basePath:\n   if (initTestEnvironmentResult.totalCalls > 0) {\n     // Migrate all of the unmigrated calls `initTestEnvironment`. This could be zero\n     // if the user has already opted into the new teardown behavior themselves.\n-    initTestEnvironmentResult.callsToMigrate.forEach(call => {\n-      migrate(call, migrateInitTestEnvironment, tree, basePath, printer);\n+    initTestEnvironmentResult.callsToMigrate.forEach(node => {\n+      const {span, text} = getInitTestEnvironmentLiteralReplacement(node, printer);\n+      const update = tree.beginUpdate(relative(basePath, node.getSourceFile().fileName));\n+      // The update appears to break if we try to call `remove` with a zero length.\n+      if (span.length > 0) {\n+        update.remove(span.start, span.length);\n+      }\n+      update.insertRight(span.start, text);\n+      tree.commitUpdate(update);\n     });\n   } else {\n     // Otherwise migrate the metadata passed into the `configureTestingModule` and `withModule`\n     // calls. This scenario is less likely, but it could happen if `initTestEnvironment` has been\n     // abstracted away or is inside a .js file.\n     sourceFiles.forEach(sourceFile => {\n-      findTestModuleMetadataNodes(typeChecker, sourceFile).forEach(literal => {\n-        migrate(literal, migrateTestModuleMetadataLiteral, tree, basePath, printer);\n+      findTestModuleMetadataNodes(typeChecker, sourceFile).forEach(node => {\n+        const migrated = migrateTestModuleMetadataLiteral(node);\n+        const update = tree.beginUpdate(relative(basePath, node.getSourceFile().fileName));\n+        update.remove(node.getStart(), node.getWidth());\n+        update.insertRight(\n+            node.getStart(),\n+            printer.printNode(ts.EmitHint.Unspecified, migrated, node.getSourceFile()));\n+        tree.commitUpdate(update);\n       });\n     });\n   }\n }\n-\n-\n-function migrate<T extends ts.Node>(\n-    node: T, migrator: (node: T) => T, tree: Tree, basePath: string, printer: ts.Printer) {\n-  const migrated = migrator(node);\n-  const update = tree.beginUpdate(relative(basePath, node.getSourceFile().fileName));\n-  update.remove(node.getStart(), node.getWidth());\n-  update.insertRight(\n-      node.getStart(), printer.printNode(ts.EmitHint.Unspecified, migrated, node.getSourceFile()));\n-  tree.commitUpdate(update);\n-}"
        },
        {
            "sha": "ac59492f07c2a22ebc507e48d765f5bc919c78e9",
            "filename": "packages/core/schematics/migrations/testbed-teardown/util.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 9,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/08caeadddb20fae33cb2604c9e791ef170e69f35/packages%2Fcore%2Fschematics%2Fmigrations%2Ftestbed-teardown%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/08caeadddb20fae33cb2604c9e791ef170e69f35/packages%2Fcore%2Fschematics%2Fmigrations%2Ftestbed-teardown%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Ftestbed-teardown%2Futil.ts?ref=08caeadddb20fae33cb2604c9e791ef170e69f35",
            "patch": "@@ -82,26 +82,45 @@ export function findTestModuleMetadataNodes(\n   return sortInReverseSourceOrder(Array.from(testModuleMetadataLiterals));\n }\n \n-/** Migrates a call to `TestBed.initTestEnvironment`. */\n-export function migrateInitTestEnvironment(node: ts.CallExpression): ts.CallExpression {\n+/**\n+ * Gets data that can be used to migrate a call to `TestBed.initTestEnvironment`.\n+ * The returned `span` is used to mark the text that should be replaced while the `text`\n+ * is the code that should be inserted instead.\n+ */\n+export function getInitTestEnvironmentLiteralReplacement(\n+    node: ts.CallExpression, printer: ts.Printer) {\n   const literalProperties: ts.ObjectLiteralElementLike[] = [];\n+  const lastArg = node.arguments[node.arguments.length - 1];\n+  let span: {start: number, end: number, length: number};\n+  let prefix: string;\n \n   if (node.arguments.length > 2) {\n-    if (isFunction(node.arguments[2])) {\n+    if (isFunction(lastArg)) {\n       // If the last argument is a function, add the function as the `aotSummaries` property.\n-      literalProperties.push(ts.createPropertyAssignment('aotSummaries', node.arguments[2]));\n-    } else if (ts.isObjectLiteralExpression(node.arguments[2])) {\n+      literalProperties.push(ts.createPropertyAssignment('aotSummaries', lastArg));\n+    } else if (ts.isObjectLiteralExpression(lastArg)) {\n       // If the property is an object literal, copy over all the properties.\n-      literalProperties.push(...node.arguments[2].properties);\n+      literalProperties.push(...lastArg.properties);\n     }\n+\n+    prefix = '';\n+    span = {start: lastArg.getStart(), end: lastArg.getEnd(), length: lastArg.getWidth()};\n+  } else {\n+    const start = lastArg.getEnd();\n+    prefix = ', ';\n+    span = {start, end: start, length: 0};\n   }\n \n   // Finally push the teardown object so that it appears last.\n   literalProperties.push(createTeardownAssignment());\n \n-  return ts.createCall(\n-      node.expression, node.typeArguments,\n-      [...node.arguments.slice(0, 2), ts.createObjectLiteral(literalProperties, true)]);\n+  return {\n+    span,\n+    text: prefix +\n+        printer.printNode(\n+            ts.EmitHint.Unspecified, ts.createObjectLiteral(literalProperties, true),\n+            node.getSourceFile())\n+  };\n }\n \n /** Migrates an object literal that is passed into `configureTestingModule` or `withModule`. */"
        },
        {
            "sha": "876efece807be3dcc8b1d277981c1daac4660124",
            "filename": "packages/core/schematics/test/google3/testbed_teardown_spec.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/08caeadddb20fae33cb2604c9e791ef170e69f35/packages%2Fcore%2Fschematics%2Ftest%2Fgoogle3%2Ftestbed_teardown_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/08caeadddb20fae33cb2604c9e791ef170e69f35/packages%2Fcore%2Fschematics%2Ftest%2Fgoogle3%2Ftestbed_teardown_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Fgoogle3%2Ftestbed_teardown_spec.ts?ref=08caeadddb20fae33cb2604c9e791ef170e69f35",
            "patch": "@@ -704,4 +704,32 @@ describe('Google3 TestBed teardown TSLint rule', () => {\n         }));\n       `));\n      });\n+\n+  it('should not duplicate comments on initTestEnvironment calls', () => {\n+    writeFile('/index.ts', `\n+      import { TestBed } from '@angular/core/testing';\n+      import {\n+        BrowserDynamicTestingModule,\n+        platformBrowserDynamicTesting\n+      } from '@angular/platform-browser-dynamic/testing';\n+\n+      // Hello\n+      TestBed.initTestEnvironment(BrowserDynamicTestingModule, platformBrowserDynamicTesting());\n+    `);\n+\n+    runTSLint(true);\n+\n+    expect(stripWhitespace(getFile('/index.ts'))).toContain(stripWhitespace(`\n+      import { TestBed } from '@angular/core/testing';\n+      import {\n+        BrowserDynamicTestingModule,\n+        platformBrowserDynamicTesting\n+      } from '@angular/platform-browser-dynamic/testing';\n+\n+      // Hello\n+      TestBed.initTestEnvironment(BrowserDynamicTestingModule, platformBrowserDynamicTesting(), {\n+        teardown: { destroyAfterEach: false }\n+      });\n+    `));\n+  });\n });"
        },
        {
            "sha": "7048aceef2a0a346a1f9677c154d48638c93ed47",
            "filename": "packages/core/schematics/test/testbed_teardown_spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/08caeadddb20fae33cb2604c9e791ef170e69f35/packages%2Fcore%2Fschematics%2Ftest%2Ftestbed_teardown_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/08caeadddb20fae33cb2604c9e791ef170e69f35/packages%2Fcore%2Fschematics%2Ftest%2Ftestbed_teardown_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Ftestbed_teardown_spec.ts?ref=08caeadddb20fae33cb2604c9e791ef170e69f35",
            "patch": "@@ -649,6 +649,33 @@ describe('TestBed teardown migration', () => {\n       `));\n      });\n \n+  it('should not duplicate comments on initTestEnvironment calls', async () => {\n+    writeFile('/index.ts', `\n+      import { TestBed } from '@angular/core/testing';\n+      import {\n+        BrowserDynamicTestingModule,\n+        platformBrowserDynamicTesting\n+      } from '@angular/platform-browser-dynamic/testing';\n+\n+      // Hello\n+      TestBed.initTestEnvironment(BrowserDynamicTestingModule, platformBrowserDynamicTesting());\n+    `);\n+\n+    await runMigration();\n+\n+    expect(stripWhitespace(tree.readContent('/index.ts'))).toContain(stripWhitespace(`\n+      import { TestBed } from '@angular/core/testing';\n+      import {\n+        BrowserDynamicTestingModule,\n+        platformBrowserDynamicTesting\n+      } from '@angular/platform-browser-dynamic/testing';\n+\n+      // Hello\n+      TestBed.initTestEnvironment(BrowserDynamicTestingModule, platformBrowserDynamicTesting(), {\n+        teardown: { destroyAfterEach: false }\n+      });\n+    `));\n+  });\n \n   function writeFile(filePath: string, contents: string) {\n     host.sync.write(normalize(filePath), virtualFs.stringToFileBuffer(contents));"
        }
    ],
    "stats": {
        "total": 158,
        "additions": 117,
        "deletions": 41
    }
}