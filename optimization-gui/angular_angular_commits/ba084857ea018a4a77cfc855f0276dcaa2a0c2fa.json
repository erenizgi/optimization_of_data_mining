{
    "author": "crisbeto",
    "message": "feat(compiler): support safe keyed read expressions (#41911)\n\nCurrently we support safe property (`a?.b`) and method (`a?.b()`) accesses, but we don't handle safe keyed reads (`a?.[0]`) which is inconsistent. These changes expand the compiler in order to support safe key read expressions as well.\n\nPR Close #41911",
    "sha": "ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
    "files": [
        {
            "sha": "f92a01749ae82acbcaec74b6528d70b5c50e8964",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/expression.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 5,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Chain, Conditional, EmptyExpr, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, MethodCall, NonNullAssert, PrefixNot, PropertyRead, PropertyWrite, Quote, SafeMethodCall, SafePropertyRead, ThisReceiver, Unary} from '@angular/compiler';\n+import {AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Chain, Conditional, EmptyExpr, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, MethodCall, NonNullAssert, PrefixNot, PropertyRead, PropertyWrite, Quote, SafeKeyedRead, SafeMethodCall, SafePropertyRead, ThisReceiver, Unary} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {TypeCheckingConfig} from '../api';\n@@ -156,15 +156,15 @@ class AstTranslator implements AstVisitor {\n   }\n \n   visitKeyedRead(ast: KeyedRead): ts.Expression {\n-    const receiver = wrapForDiagnostics(this.translate(ast.obj));\n+    const receiver = wrapForDiagnostics(this.translate(ast.receiver));\n     const key = this.translate(ast.key);\n     const node = ts.createElementAccess(receiver, key);\n     addParseSpanInfo(node, ast.sourceSpan);\n     return node;\n   }\n \n   visitKeyedWrite(ast: KeyedWrite): ts.Expression {\n-    const receiver = wrapForDiagnostics(this.translate(ast.obj));\n+    const receiver = wrapForDiagnostics(this.translate(ast.receiver));\n     const left = ts.createElementAccess(receiver, this.translate(ast.key));\n     // TODO(joost): annotate `left` with the span of the element access, which is not currently\n     //  available on `ast`.\n@@ -330,6 +330,30 @@ class AstTranslator implements AstVisitor {\n     addParseSpanInfo(node, ast.sourceSpan);\n     return node;\n   }\n+\n+  visitSafeKeyedRead(ast: SafeKeyedRead): ts.Expression {\n+    const receiver = wrapForDiagnostics(this.translate(ast.receiver));\n+    const key = this.translate(ast.key);\n+    let node: ts.Expression;\n+\n+    // The form of safe property reads depends on whether strictness is in use.\n+    if (this.config.strictSafeNavigationTypes) {\n+      // \"a?.[...]\" becomes (null as any ? a![...] : undefined)\n+      const expr = ts.createElementAccess(ts.createNonNullExpression(receiver), key);\n+      addParseSpanInfo(expr, ast.sourceSpan);\n+      node = ts.createParen(ts.createConditional(NULL_AS_ANY, expr, UNDEFINED));\n+    } else if (VeSafeLhsInferenceBugDetector.veWillInferAnyFor(ast)) {\n+      // \"a?.[...]\" becomes (a as any)[...]\n+      node = ts.createElementAccess(tsCastToAny(receiver), key);\n+    } else {\n+      // \"a?.[...]\" becomes (a!.[...] as any)\n+      const expr = ts.createElementAccess(ts.createNonNullExpression(receiver), key);\n+      addParseSpanInfo(expr, ast.sourceSpan);\n+      node = tsCastToAny(expr);\n+    }\n+    addParseSpanInfo(node, ast.sourceSpan);\n+    return node;\n+  }\n }\n \n /**\n@@ -348,8 +372,9 @@ class AstTranslator implements AstVisitor {\n class VeSafeLhsInferenceBugDetector implements AstVisitor {\n   private static SINGLETON = new VeSafeLhsInferenceBugDetector();\n \n-  static veWillInferAnyFor(ast: SafeMethodCall|SafePropertyRead) {\n-    return ast.receiver.visit(VeSafeLhsInferenceBugDetector.SINGLETON);\n+  static veWillInferAnyFor(ast: SafeMethodCall|SafePropertyRead|SafeKeyedRead) {\n+    const visitor = VeSafeLhsInferenceBugDetector.SINGLETON;\n+    return ast instanceof SafeKeyedRead ? ast.receiver.visit(visitor) : ast.receiver.visit(visitor);\n   }\n \n   visitUnary(ast: Unary): boolean {\n@@ -418,4 +443,7 @@ class VeSafeLhsInferenceBugDetector implements AstVisitor {\n   visitSafePropertyRead(ast: SafePropertyRead): boolean {\n     return false;\n   }\n+  visitSafeKeyedRead(ast: SafeKeyedRead): boolean {\n+    return false;\n+  }\n }"
        },
        {
            "sha": "842cfc5b05878b62c90f04edb7d2ac97fc11aa04",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/diagnostics_spec.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -412,6 +412,35 @@ runInEachFileSystem(() => {\n \n         expect(messages).toEqual([]);\n       });\n+\n+      it('does not produce diagnostic for safe keyed access', () => {\n+        const messages =\n+            diagnose(`<div [class.red-text]=\"person.favoriteColors?.[0] === 'red'\"></div>`, `\n+              export class TestComponent {\n+                person: {\n+                  favoriteColors?: string[];\n+                };\n+              }`);\n+\n+        expect(messages).toEqual([]);\n+      });\n+\n+      it('infers a safe keyed read as undefined', () => {\n+        const messages = diagnose(`<div (click)=\"log(person.favoriteColors?.[0])\"></div>`, `\n+          export class TestComponent {\n+            person: {\n+              favoriteColors?: string[];\n+            };\n+\n+            log(color: string) {\n+              console.log(color);\n+            }\n+          }`);\n+\n+        expect(messages).toEqual([\n+          `TestComponent.html(1, 19): Argument of type 'string | undefined' is not assignable to parameter of type 'string'.`\n+        ]);\n+      });\n     });\n \n     it('computes line and column offsets', () => {"
        },
        {
            "sha": "9130af7095bf2b148bb9c7da7b91d318d52c6b05",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -44,6 +44,7 @@ export function typescriptLibDts(): TestFile {\n         call(...args: any[]): any;\n       }\n       declare interface Array<T> {\n+        [index: number]: T;\n         length: number;\n       }\n       declare interface String {"
        },
        {
            "sha": "d55df81b3f810e7fe9606a810d85bd842704060d",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_check_block_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -997,35 +997,39 @@ describe('type check blocks', () => {\n     });\n \n     describe('config.strictSafeNavigationTypes', () => {\n-      const TEMPLATE = `{{a?.b}} {{a?.method()}}`;\n+      const TEMPLATE = `{{a?.b}} {{a?.method()}} {{a?.[0]}}`;\n \n       it('should use undefined for safe navigation operations when enabled', () => {\n         const block = tcb(TEMPLATE, DIRECTIVES);\n         expect(block).toContain('(null as any ? (((ctx).a))!.method() : undefined)');\n         expect(block).toContain('(null as any ? (((ctx).a))!.b : undefined)');\n+        expect(block).toContain('(null as any ? (((ctx).a))![0] : undefined)');\n       });\n       it('should use an \\'any\\' type for safe navigation operations when disabled', () => {\n         const DISABLED_CONFIG:\n             TypeCheckingConfig = {...BASE_CONFIG, strictSafeNavigationTypes: false};\n         const block = tcb(TEMPLATE, DIRECTIVES, DISABLED_CONFIG);\n         expect(block).toContain('((((ctx).a))!.method() as any)');\n         expect(block).toContain('((((ctx).a))!.b as any)');\n+        expect(block).toContain('(((((ctx).a))![0] as any)');\n       });\n     });\n \n     describe('config.strictSafeNavigationTypes (View Engine bug emulation)', () => {\n-      const TEMPLATE = `{{a.method()?.b}} {{a()?.method()}}`;\n+      const TEMPLATE = `{{a.method()?.b}} {{a()?.method()}} {{a.method()?.[0]}}`;\n       it('should check the presence of a property/method on the receiver when enabled', () => {\n         const block = tcb(TEMPLATE, DIRECTIVES);\n         expect(block).toContain('(null as any ? ((((ctx).a)).method())!.b : undefined)');\n         expect(block).toContain('(null as any ? ((ctx).a())!.method() : undefined)');\n+        expect(block).toContain('(null as any ? ((((ctx).a)).method())![0] : undefined)');\n       });\n       it('should not check the presence of a property/method on the receiver when disabled', () => {\n         const DISABLED_CONFIG:\n             TypeCheckingConfig = {...BASE_CONFIG, strictSafeNavigationTypes: false};\n         const block = tcb(TEMPLATE, DIRECTIVES, DISABLED_CONFIG);\n         expect(block).toContain('(((((ctx).a)).method()) as any).b');\n         expect(block).toContain('(((ctx).a()) as any).method()');\n+        expect(block).toContain('(((((ctx).a)).method()) as any)[0]');\n       });\n     });\n "
        },
        {
            "sha": "53a62c187e90b262d8992fadcfdc11f6d1276287",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/GOLDEN_PARTIAL.js",
            "status": "added",
            "additions": 65,
            "deletions": 0,
            "changes": 65,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FGOLDEN_PARTIAL.js?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -0,0 +1,65 @@\n+/****************************************************************************************************\n+ * PARTIAL FILE: safe_keyed_read.js\n+ ****************************************************************************************************/\n+import { Component, NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class MyApp {\n+    constructor() {\n+        this.unknownNames = null;\n+        this.knownNames = [['Frodo', 'Bilbo']];\n+        this.species = null;\n+        this.keys = null;\n+        this.speciesMap = { key: 'unknown' };\n+    }\n+}\n+MyApp.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"ng-component\", ngImport: i0, template: `\n+    <span [title]=\"'Your last name is ' + (unknownNames?.[0] || 'unknown')\">\n+      Hello, {{ knownNames?.[0]?.[1] }}!\n+      You are a Balrog: {{ species?.[0]?.[1]?.[2]?.[3]?.[4]?.[5] || 'unknown' }}\n+      You are an Elf: {{ speciesMap?.[keys?.[0] ?? 'key'] }}\n+      You are an Orc: {{ speciesMap?.['key'] }}\n+    </span>\n+`, isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, decorators: [{\n+            type: Component,\n+            args: [{\n+                    template: `\n+    <span [title]=\"'Your last name is ' + (unknownNames?.[0] || 'unknown')\">\n+      Hello, {{ knownNames?.[0]?.[1] }}!\n+      You are a Balrog: {{ species?.[0]?.[1]?.[2]?.[3]?.[4]?.[5] || 'unknown' }}\n+      You are an Elf: {{ speciesMap?.[keys?.[0] ?? 'key'] }}\n+      You are an Orc: {{ speciesMap?.['key'] }}\n+    </span>\n+`\n+                }]\n+        }] });\n+export class MyModule {\n+}\n+MyModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\n+MyModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, declarations: [MyApp] });\n+MyModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{ declarations: [MyApp] }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: safe_keyed_read.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class MyApp {\n+    unknownNames: string[] | null;\n+    knownNames: string[][];\n+    species: null;\n+    keys: null;\n+    speciesMap: Record<string, string>;\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyApp, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<MyApp, \"ng-component\", never, {}, {}, never, never>;\n+}\n+export declare class MyModule {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyModule, never>;\n+    static ɵmod: i0.ɵɵNgModuleDeclaration<MyModule, [typeof MyApp], never, never>;\n+    static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n+}\n+"
        },
        {
            "sha": "d81f51d15d3fcc9626eb2906d98e824c0260f31a",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/TEST_CASES.json",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FTEST_CASES.json?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -0,0 +1,22 @@\n+{\n+  \"$schema\": \"../../test_case_schema.json\",\n+  \"cases\": [\n+    {\n+      \"description\": \"should handle safe keyed reads inside templates\",\n+      \"inputFiles\": [\n+        \"safe_keyed_read.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"files\": [\n+            {\n+              \"expected\": \"safe_keyed_read_template.js\",\n+              \"generated\": \"safe_keyed_read.js\"\n+            }\n+          ],\n+          \"failureMessage\": \"Incorrect template\"\n+        }\n+      ]\n+    }\n+  ]\n+}"
        },
        {
            "sha": "12bfd43564d00fce93a03810f6be6b38f5b1fbff",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/safe_keyed_read.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_keyed_read.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_keyed_read.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_keyed_read.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -0,0 +1,23 @@\n+import {Component, NgModule} from '@angular/core';\n+\n+@Component({\n+  template: `\n+    <span [title]=\"'Your last name is ' + (unknownNames?.[0] || 'unknown')\">\n+      Hello, {{ knownNames?.[0]?.[1] }}!\n+      You are a Balrog: {{ species?.[0]?.[1]?.[2]?.[3]?.[4]?.[5] || 'unknown' }}\n+      You are an Elf: {{ speciesMap?.[keys?.[0] ?? 'key'] }}\n+      You are an Orc: {{ speciesMap?.['key'] }}\n+    </span>\n+`\n+})\n+export class MyApp {\n+  unknownNames: string[]|null = null;\n+  knownNames: string[][] = [['Frodo', 'Bilbo']];\n+  species = null;\n+  keys = null;\n+  speciesMap: Record<string, string> = {key: 'unknown'};\n+}\n+\n+@NgModule({declarations: [MyApp]})\n+export class MyModule {\n+}"
        },
        {
            "sha": "b22f78118fe0827a4eba3c4fd9dd893b88646ec5",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/safe_keyed_read_template.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_keyed_read_template.js",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_keyed_read_template.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_keyed_read_template.js?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -0,0 +1,13 @@\n+template: function MyApp_Template(rf, ctx) {\n+  if (rf & 1) {\n+    i0.ɵɵelementStart(0, \"span\", 0);\n+    i0.ɵɵtext(1);\n+    i0.ɵɵelementEnd();\n+  }\n+  if (rf & 2) {\n+    let $tmp_0_0$;\n+    i0.ɵɵproperty(\"title\", \"Your last name is \" + ((ctx.unknownNames == null ? null : ctx.unknownNames[0]) || \"unknown\"));\n+    i0.ɵɵadvance(1);\n+    i0.ɵɵtextInterpolate4(\" Hello, \", ctx.knownNames == null ? null : ctx.knownNames[0] == null ? null : ctx.knownNames[0][1], \"! You are a Balrog: \", (ctx.species == null ? null : ctx.species[0] == null ? null : ctx.species[0][1] == null ? null : ctx.species[0][1][2] == null ? null : ctx.species[0][1][2][3] == null ? null : ctx.species[0][1][2][3][4] == null ? null : ctx.species[0][1][2][3][4][5]) || \"unknown\", \" You are an Elf: \", ctx.speciesMap == null ? null : ctx.speciesMap[($tmp_0_0$ = ctx.keys == null ? null : ctx.keys[0]) !== null && $tmp_0_0$ !== undefined ? $tmp_0_0$ : \"key\"], \" You are an Orc: \", ctx.speciesMap == null ? null : ctx.speciesMap[\"key\"], \" \");\n+  }\n+}"
        },
        {
            "sha": "476651660f2d19e039789c7dabd0b73b4ad620d5",
            "filename": "packages/compiler/src/compiler_util/expression_converter.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 5,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -478,12 +478,13 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n       return this.convertSafeAccess(ast, leftMostSafe, mode);\n     } else {\n       return convertToStatementIfNeeded(\n-          mode, this._visit(ast.obj, _Mode.Expression).key(this._visit(ast.key, _Mode.Expression)));\n+          mode,\n+          this._visit(ast.receiver, _Mode.Expression).key(this._visit(ast.key, _Mode.Expression)));\n     }\n   }\n \n   visitKeyedWrite(ast: cdAst.KeyedWrite, mode: _Mode): any {\n-    const obj: o.Expression = this._visit(ast.obj, _Mode.Expression);\n+    const obj: o.Expression = this._visit(ast.receiver, _Mode.Expression);\n     const key: o.Expression = this._visit(ast.key, _Mode.Expression);\n     const value: o.Expression = this._visit(ast.value, _Mode.Expression);\n     return convertToStatementIfNeeded(mode, obj.key(key).set(value));\n@@ -627,6 +628,10 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n     return this.convertSafeAccess(ast, this.leftMostSafeNode(ast), mode);\n   }\n \n+  visitSafeKeyedRead(ast: cdAst.SafeKeyedRead, mode: _Mode): any {\n+    return this.convertSafeAccess(ast, this.leftMostSafeNode(ast), mode);\n+  }\n+\n   visitAll(asts: cdAst.AST[], mode: _Mode): any {\n     return asts.map(ast => this._visit(ast, mode));\n   }\n@@ -643,7 +648,8 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n   }\n \n   private convertSafeAccess(\n-      ast: cdAst.AST, leftMostSafe: cdAst.SafeMethodCall|cdAst.SafePropertyRead, mode: _Mode): any {\n+      ast: cdAst.AST, leftMostSafe: cdAst.SafeMethodCall|cdAst.SafePropertyRead|cdAst.SafeKeyedRead,\n+      mode: _Mode): any {\n     // If the expression contains a safe access node on the left it needs to be converted to\n     // an expression that guards the access to the member by checking the receiver for blank. As\n     // execution proceeds from left to right, the left most part of the expression must be guarded\n@@ -707,6 +713,11 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n               leftMostSafe.span, leftMostSafe.sourceSpan, leftMostSafe.nameSpan,\n               leftMostSafe.receiver, leftMostSafe.name, leftMostSafe.args,\n               leftMostSafe.argumentSpan));\n+    } else if (leftMostSafe instanceof cdAst.SafeKeyedRead) {\n+      this._nodeMap.set(\n+          leftMostSafe,\n+          new cdAst.KeyedRead(\n+              leftMostSafe.span, leftMostSafe.sourceSpan, leftMostSafe.receiver, leftMostSafe.key));\n     } else {\n       this._nodeMap.set(\n           leftMostSafe,\n@@ -756,7 +767,8 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n   //   a == null ? null : a.c.b.c?.d.e\n   // then to:\n   //   a == null ? null : a.b.c == null ? null : a.b.c.d.e\n-  private leftMostSafeNode(ast: cdAst.AST): cdAst.SafePropertyRead|cdAst.SafeMethodCall {\n+  private leftMostSafeNode(ast: cdAst.AST): cdAst.SafePropertyRead|cdAst.SafeMethodCall\n+      |cdAst.SafeKeyedRead {\n     const visit = (visitor: cdAst.AstVisitor, ast: cdAst.AST): any => {\n       return (this._nodeMap.get(ast) || ast).visit(visitor);\n     };\n@@ -786,7 +798,7 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n         return null;\n       },\n       visitKeyedRead(ast: cdAst.KeyedRead) {\n-        return visit(this, ast.obj);\n+        return visit(this, ast.receiver);\n       },\n       visitKeyedWrite(ast: cdAst.KeyedWrite) {\n         return null;\n@@ -826,6 +838,9 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n       },\n       visitSafePropertyRead(ast: cdAst.SafePropertyRead) {\n         return visit(this, ast.receiver) || ast;\n+      },\n+      visitSafeKeyedRead(ast: cdAst.SafeKeyedRead) {\n+        return visit(this, ast.receiver) || ast;\n       }\n     });\n   }\n@@ -906,6 +921,9 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n       },\n       visitSafePropertyRead(ast: cdAst.SafePropertyRead) {\n         return false;\n+      },\n+      visitSafeKeyedRead(ast: cdAst.SafeKeyedRead) {\n+        return false;\n       }\n     });\n   }"
        },
        {
            "sha": "51b5ced0e7fd845d3ccbc3a8d2f241f794cbab68",
            "filename": "packages/compiler/src/expression_parser/ast.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 10,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -156,17 +156,28 @@ export class SafePropertyRead extends ASTWithName {\n }\n \n export class KeyedRead extends AST {\n-  constructor(span: ParseSpan, sourceSpan: AbsoluteSourceSpan, public obj: AST, public key: AST) {\n+  constructor(\n+      span: ParseSpan, sourceSpan: AbsoluteSourceSpan, public receiver: AST, public key: AST) {\n     super(span, sourceSpan);\n   }\n   visit(visitor: AstVisitor, context: any = null): any {\n     return visitor.visitKeyedRead(this, context);\n   }\n }\n \n+export class SafeKeyedRead extends AST {\n+  constructor(\n+      span: ParseSpan, sourceSpan: AbsoluteSourceSpan, public receiver: AST, public key: AST) {\n+    super(span, sourceSpan);\n+  }\n+  visit(visitor: AstVisitor, context: any = null): any {\n+    return visitor.visitSafeKeyedRead(this, context);\n+  }\n+}\n+\n export class KeyedWrite extends AST {\n   constructor(\n-      span: ParseSpan, sourceSpan: AbsoluteSourceSpan, public obj: AST, public key: AST,\n+      span: ParseSpan, sourceSpan: AbsoluteSourceSpan, public receiver: AST, public key: AST,\n       public value: AST) {\n     super(span, sourceSpan);\n   }\n@@ -453,6 +464,7 @@ export interface AstVisitor {\n   visitQuote(ast: Quote, context: any): any;\n   visitSafeMethodCall(ast: SafeMethodCall, context: any): any;\n   visitSafePropertyRead(ast: SafePropertyRead, context: any): any;\n+  visitSafeKeyedRead(ast: SafeKeyedRead, context: any): any;\n   visitASTWithSource?(ast: ASTWithSource, context: any): any;\n   /**\n    * This function is optionally defined to allow classes that implement this\n@@ -501,11 +513,11 @@ export class RecursiveAstVisitor implements AstVisitor {\n     this.visitAll(ast.expressions, context);\n   }\n   visitKeyedRead(ast: KeyedRead, context: any): any {\n-    this.visit(ast.obj, context);\n+    this.visit(ast.receiver, context);\n     this.visit(ast.key, context);\n   }\n   visitKeyedWrite(ast: KeyedWrite, context: any): any {\n-    this.visit(ast.obj, context);\n+    this.visit(ast.receiver, context);\n     this.visit(ast.key, context);\n     this.visit(ast.value, context);\n   }\n@@ -540,6 +552,10 @@ export class RecursiveAstVisitor implements AstVisitor {\n     this.visit(ast.receiver, context);\n     this.visitAll(ast.args, context);\n   }\n+  visitSafeKeyedRead(ast: SafeKeyedRead, context: any): any {\n+    this.visit(ast.receiver, context);\n+    this.visit(ast.key, context);\n+  }\n   visitQuote(ast: Quote, context: any): any {}\n   // This is not part of the AstVisitor interface, just a helper method\n   visitAll(asts: AST[], context: any): any {\n@@ -644,12 +660,13 @@ export class AstTransformer implements AstVisitor {\n   }\n \n   visitKeyedRead(ast: KeyedRead, context: any): AST {\n-    return new KeyedRead(ast.span, ast.sourceSpan, ast.obj.visit(this), ast.key.visit(this));\n+    return new KeyedRead(ast.span, ast.sourceSpan, ast.receiver.visit(this), ast.key.visit(this));\n   }\n \n   visitKeyedWrite(ast: KeyedWrite, context: any): AST {\n     return new KeyedWrite(\n-        ast.span, ast.sourceSpan, ast.obj.visit(this), ast.key.visit(this), ast.value.visit(this));\n+        ast.span, ast.sourceSpan, ast.receiver.visit(this), ast.key.visit(this),\n+        ast.value.visit(this));\n   }\n \n   visitAll(asts: any[]): any[] {\n@@ -668,6 +685,11 @@ export class AstTransformer implements AstVisitor {\n     return new Quote(\n         ast.span, ast.sourceSpan, ast.prefix, ast.uninterpretedExpression, ast.location);\n   }\n+\n+  visitSafeKeyedRead(ast: SafeKeyedRead, context: any): AST {\n+    return new SafeKeyedRead(\n+        ast.span, ast.sourceSpan, ast.receiver.visit(this), ast.key.visit(this));\n+  }\n }\n \n // A transformer that only creates new nodes if the transformer makes a change or\n@@ -822,19 +844,19 @@ export class AstMemoryEfficientTransformer implements AstVisitor {\n   }\n \n   visitKeyedRead(ast: KeyedRead, context: any): AST {\n-    const obj = ast.obj.visit(this);\n+    const obj = ast.receiver.visit(this);\n     const key = ast.key.visit(this);\n-    if (obj !== ast.obj || key !== ast.key) {\n+    if (obj !== ast.receiver || key !== ast.key) {\n       return new KeyedRead(ast.span, ast.sourceSpan, obj, key);\n     }\n     return ast;\n   }\n \n   visitKeyedWrite(ast: KeyedWrite, context: any): AST {\n-    const obj = ast.obj.visit(this);\n+    const obj = ast.receiver.visit(this);\n     const key = ast.key.visit(this);\n     const value = ast.value.visit(this);\n-    if (obj !== ast.obj || key !== ast.key || value !== ast.value) {\n+    if (obj !== ast.receiver || key !== ast.key || value !== ast.value) {\n       return new KeyedWrite(ast.span, ast.sourceSpan, obj, key, value);\n     }\n     return ast;\n@@ -863,6 +885,15 @@ export class AstMemoryEfficientTransformer implements AstVisitor {\n   visitQuote(ast: Quote, context: any): AST {\n     return ast;\n   }\n+\n+  visitSafeKeyedRead(ast: SafeKeyedRead, context: any): AST {\n+    const obj = ast.receiver.visit(this);\n+    const key = ast.key.visit(this);\n+    if (obj !== ast.receiver || key !== ast.key) {\n+      return new SafeKeyedRead(ast.span, ast.sourceSpan, obj, key);\n+    }\n+    return ast;\n+  }\n }\n \n // Bindings"
        },
        {
            "sha": "bf25bf46dda6f1dffd90aef7ccea6fedd524810f",
            "filename": "packages/compiler/src/expression_parser/parser.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 19,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -9,7 +9,7 @@\n import * as chars from '../chars';\n import {DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig} from '../ml_parser/interpolation_config';\n \n-import {AbsoluteSourceSpan, AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Chain, Conditional, EmptyExpr, ExpressionBinding, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralMapKey, LiteralPrimitive, MethodCall, NonNullAssert, ParserError, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeMethodCall, SafePropertyRead, TemplateBinding, TemplateBindingIdentifier, ThisReceiver, Unary, VariableBinding} from './ast';\n+import {AbsoluteSourceSpan, AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Chain, Conditional, EmptyExpr, ExpressionBinding, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralMapKey, LiteralPrimitive, MethodCall, NonNullAssert, ParserError, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeKeyedRead, SafeMethodCall, SafePropertyRead, TemplateBinding, TemplateBindingIdentifier, ThisReceiver, Unary, VariableBinding} from './ast';\n import {EOF, isIdentifier, isQuote, Lexer, Token, TokenType} from './lexer';\n \n export interface InterpolationPiece {\n@@ -822,24 +822,11 @@ export class _ParseAST {\n         result = this.parseAccessMemberOrMethodCall(result, start, false);\n \n       } else if (this.consumeOptionalOperator('?.')) {\n-        result = this.parseAccessMemberOrMethodCall(result, start, true);\n-\n+        result = this.consumeOptionalCharacter(chars.$LBRACKET) ?\n+            this.parseKeyedReadOrWrite(result, start, true) :\n+            this.parseAccessMemberOrMethodCall(result, start, true);\n       } else if (this.consumeOptionalCharacter(chars.$LBRACKET)) {\n-        this.withContext(ParseContextFlags.Writable, () => {\n-          this.rbracketsExpected++;\n-          const key = this.parsePipe();\n-          if (key instanceof EmptyExpr) {\n-            this.error(`Key access cannot be empty`);\n-          }\n-          this.rbracketsExpected--;\n-          this.expectCharacter(chars.$RBRACKET);\n-          if (this.consumeOptionalOperator('=')) {\n-            const value = this.parseConditional();\n-            result = new KeyedWrite(this.span(start), this.sourceSpan(start), result, key, value);\n-          } else {\n-            result = new KeyedRead(this.span(start), this.sourceSpan(start), result, key);\n-          }\n-        });\n+        result = this.parseKeyedReadOrWrite(result, start, false);\n       } else if (this.consumeOptionalCharacter(chars.$LPAREN)) {\n         this.rparensExpected++;\n         const args = this.parseCallArguments();\n@@ -954,7 +941,7 @@ export class _ParseAST {\n     return new LiteralMap(this.span(start), this.sourceSpan(start), keys, values);\n   }\n \n-  parseAccessMemberOrMethodCall(receiver: AST, start: number, isSafe: boolean = false): AST {\n+  parseAccessMemberOrMethodCall(receiver: AST, start: number, isSafe: boolean): AST {\n     const nameStart = this.inputIndex;\n     const id = this.withContext(ParseContextFlags.Writable, () => {\n       const id = this.expectIdentifierOrKeyword() ?? '';\n@@ -1095,6 +1082,31 @@ export class _ParseAST {\n     return new TemplateBindingParseResult(bindings, [] /* warnings */, this.errors);\n   }\n \n+  parseKeyedReadOrWrite(receiver: AST, start: number, isSafe: boolean): AST {\n+    return this.withContext(ParseContextFlags.Writable, () => {\n+      this.rbracketsExpected++;\n+      const key = this.parsePipe();\n+      if (key instanceof EmptyExpr) {\n+        this.error(`Key access cannot be empty`);\n+      }\n+      this.rbracketsExpected--;\n+      this.expectCharacter(chars.$RBRACKET);\n+      if (this.consumeOptionalOperator('=')) {\n+        if (isSafe) {\n+          this.error('The \\'?.\\' operator cannot be used in the assignment');\n+        } else {\n+          const value = this.parseConditional();\n+          return new KeyedWrite(this.span(start), this.sourceSpan(start), receiver, key, value);\n+        }\n+      } else {\n+        return isSafe ? new SafeKeyedRead(this.span(start), this.sourceSpan(start), receiver, key) :\n+                        new KeyedRead(this.span(start), this.sourceSpan(start), receiver, key);\n+      }\n+\n+      return new EmptyExpr(this.span(start), this.sourceSpan(start));\n+    });\n+  }\n+\n   /**\n    * Parse a directive keyword, followed by a mandatory expression.\n    * For example, \"of items\", \"trackBy: func\".\n@@ -1333,6 +1345,8 @@ class SimpleExpressionChecker implements AstVisitor {\n   visitChain(ast: Chain, context: any) {}\n \n   visitQuote(ast: Quote, context: any) {}\n+\n+  visitSafeKeyedRead(ast: SafeKeyedRead, context: any) {}\n }\n \n /**"
        },
        {
            "sha": "4bd2a638a4340dcb122a4a61adb4cc67d157eb32",
            "filename": "packages/compiler/test/expression_parser/lexer_spec.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -127,6 +127,14 @@ function expectErrorToken(token: Token, index: any, end: number, message: string\n         expectCharacterToken(tokens[3], 3, 4, ']');\n       });\n \n+      it('should tokenize a safe indexed operator', () => {\n+        const tokens: number[] = lex('j?.[k]');\n+        expect(tokens.length).toBe(5);\n+        expectOperatorToken(tokens[1], 1, 3, '?.');\n+        expectCharacterToken(tokens[2], 3, 4, '[');\n+        expectCharacterToken(tokens[4], 5, 6, ']');\n+      });\n+\n       it('should tokenize numbers', () => {\n         const tokens: number[] = lex('88');\n         expect(tokens.length).toEqual(1);"
        },
        {
            "sha": "5d9be9211539fed96e3b7a37fbfccacdff181e1e",
            "filename": "packages/compiler/test/expression_parser/parser_spec.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -215,9 +215,16 @@ describe('parser', () => {\n \n     describe('keyed read', () => {\n       it('should parse keyed reads', () => {\n-        checkAction('a[\"a\"]');\n-        checkAction('this.a[\"a\"]', 'a[\"a\"]');\n-        checkAction('a.a[\"a\"]');\n+        checkBinding('a[\"a\"]');\n+        checkBinding('this.a[\"a\"]', 'a[\"a\"]');\n+        checkBinding('a.a[\"a\"]');\n+      });\n+\n+      it('should parse safe keyed reads', () => {\n+        checkBinding('a?.[\"a\"]');\n+        checkBinding('this.a?.[\"a\"]', 'a?.[\"a\"]');\n+        checkBinding('a.a?.[\"a\"]');\n+        checkBinding('a.a?.[\"a\" | foo]', 'a.a?.[(\"a\" | foo)]');\n       });\n \n       describe('malformed keyed reads', () => {\n@@ -248,6 +255,10 @@ describe('parser', () => {\n         checkAction('a.a[\"a\"] = 1 + 2');\n       });\n \n+      it('should report on safe keyed writes', () => {\n+        expectActionError('a?.[\"a\"] = 123', 'cannot be used in the assignment');\n+      });\n+\n       describe('malformed keyed writes', () => {\n         it('should recover on empty rvalues', () => {\n           checkActionWithError('a[\"a\"] = ', 'a[\"a\"] = ', 'Unexpected end of expression');"
        },
        {
            "sha": "ba541ed48339c0024d7ceb405079d7ffc7444c4c",
            "filename": "packages/compiler/test/expression_parser/utils/unparser.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Funparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Funparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Funparser.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Chain, Conditional, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, MethodCall, NonNullAssert, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeMethodCall, SafePropertyRead, ThisReceiver, Unary} from '../../../src/expression_parser/ast';\n+import {AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Chain, Conditional, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, MethodCall, NonNullAssert, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeKeyedRead, SafeMethodCall, SafePropertyRead, ThisReceiver, Unary} from '../../../src/expression_parser/ast';\n import {DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig} from '../../../src/ml_parser/interpolation_config';\n \n class Unparser implements AstVisitor {\n@@ -101,14 +101,14 @@ class Unparser implements AstVisitor {\n   }\n \n   visitKeyedRead(ast: KeyedRead, context: any) {\n-    this._visit(ast.obj);\n+    this._visit(ast.receiver);\n     this._expression += '[';\n     this._visit(ast.key);\n     this._expression += ']';\n   }\n \n   visitKeyedWrite(ast: KeyedWrite, context: any) {\n-    this._visit(ast.obj);\n+    this._visit(ast.receiver);\n     this._expression += '[';\n     this._visit(ast.key);\n     this._expression += '] = ';\n@@ -193,6 +193,13 @@ class Unparser implements AstVisitor {\n     this._expression += `${ast.prefix}:${ast.uninterpretedExpression}`;\n   }\n \n+  visitSafeKeyedRead(ast: SafeKeyedRead, context: any) {\n+    this._visit(ast.receiver);\n+    this._expression += '?.[';\n+    this._visit(ast.key);\n+    this._expression += ']';\n+  }\n+\n   private _visit(ast: AST) {\n     ast.visit(this);\n   }"
        },
        {
            "sha": "81b330d68ce29369ad6e3aec9e979d1743e0ce25",
            "filename": "packages/compiler/test/expression_parser/utils/validator.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Fvalidator.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Fvalidator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Fvalidator.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, Binary, BindingPipe, Chain, Conditional, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, MethodCall, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeMethodCall, SafePropertyRead, Unary} from '../../../src/expression_parser/ast';\n+import {AST, Binary, BindingPipe, Chain, Conditional, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, MethodCall, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeKeyedRead, SafeMethodCall, SafePropertyRead, Unary} from '../../../src/expression_parser/ast';\n \n import {unparse} from './unparser';\n \n@@ -113,6 +113,10 @@ class ASTValidator extends RecursiveAstVisitor {\n   visitSafePropertyRead(ast: SafePropertyRead, context: any): any {\n     this.validate(ast, () => super.visitSafePropertyRead(ast, context));\n   }\n+\n+  visitSafeKeyedRead(ast: SafeKeyedRead, context: any): any {\n+    this.validate(ast, () => super.visitSafeKeyedRead(ast, context));\n+  }\n }\n \n function inSpan(span: ParseSpan, parentSpan: ParseSpan|undefined): parentSpan is ParseSpan {"
        },
        {
            "sha": "0eb621d078c4a393f28f25bb44c1ffeef50da22b",
            "filename": "packages/compiler/test/render3/util/expression.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Frender3%2Futil%2Fexpression.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Frender3%2Futil%2Fexpression.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Futil%2Fexpression.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -114,6 +114,10 @@ class ExpressionSourceHumanizer extends e.RecursiveAstVisitor implements t.Visit\n     this.recordAst(ast);\n     super.visitQuote(ast, null);\n   }\n+  visitSafeKeyedRead(ast: e.SafeKeyedRead) {\n+    this.recordAst(ast);\n+    super.visitSafeKeyedRead(ast, null);\n+  }\n \n   visitTemplate(ast: t.Template) {\n     t.visitAll(this, ast.children);"
        },
        {
            "sha": "54434e56d8fa776645dda9244a910ca6d7862e21",
            "filename": "packages/compiler/test/template_parser/util/expression.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Ftemplate_parser%2Futil%2Fexpression.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcompiler%2Ftest%2Ftemplate_parser%2Futil%2Fexpression.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Ftemplate_parser%2Futil%2Fexpression.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -114,6 +114,10 @@ class ExpressionSourceHumanizer extends e.RecursiveAstVisitor implements t.Templ\n     this.recordAst(ast);\n     super.visitQuote(ast, null);\n   }\n+  visitSafeKeyedRead(ast: e.SafeKeyedRead) {\n+    this.recordAst(ast);\n+    super.visitSafeKeyedRead(ast, null);\n+  }\n \n   visitNgContent(ast: t.NgContentAst) {}\n   visitEmbeddedTemplate(ast: t.EmbeddedTemplateAst) {"
        },
        {
            "sha": "9ffb95cdd61e417f2c29f617df46294d732110d7",
            "filename": "packages/core/test/acceptance/integration_spec.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -1955,6 +1955,36 @@ describe('acceptance integration tests', () => {\n     expect(content).toContain(`<span title=\"Your last name is Baggins\">`);\n   });\n \n+  it('should handle safe keyed reads inside templates', () => {\n+    @Component({\n+      template: `\n+      <span [title]=\"'Your last name is ' + (unknownNames?.[0] || 'unknown')\">\n+        Hello, {{ knownNames?.[0]?.[1] }}!\n+        You are a Balrog: {{ species?.[0]?.[1]?.[2]?.[3]?.[4]?.[5] || 'unknown' }}\n+        You are an Elf: {{ speciesMap?.[keys?.[0] ?? 'key'] }}\n+        You are an Orc: {{ speciesMap?.['key'] }}\n+      </span>\n+    `\n+    })\n+    class App {\n+      unknownNames: string[]|null = null;\n+      knownNames: string[][] = [['Frodo', 'Bilbo']];\n+      species = null;\n+      keys = null;\n+      speciesMap: Record<string, string> = {key: 'unknown'};\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [App]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+    const content = fixture.nativeElement.innerHTML;\n+\n+    expect(content).toContain('Hello, Bilbo!');\n+    expect(content).toContain('You are a Balrog: unknown');\n+    expect(content).toContain('You are an Elf: unknown');\n+    expect(content).toContain(`<span title=\"Your last name is unknown\">`);\n+  });\n+\n   it('should handle nullish coalescing inside host bindings', () => {\n     const logs: string[] = [];\n "
        },
        {
            "sha": "6b8e911f5758e2af3f0279dbb01bbf50cd6ee46e",
            "filename": "packages/language-service/ivy/test/legacy/template_target_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftemplate_target_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftemplate_target_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftemplate_target_spec.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -471,6 +471,15 @@ describe('getTargetAtPosition for expression AST', () => {\n     expect(node).toBeInstanceOf(e.KeyedRead);\n   });\n \n+  it('should locate safe keyed read', () => {\n+    const {errors, nodes, position} = parse(`{{ foo?.['bar']¦ }}`);\n+    expect(errors).toBe(null);\n+    const {context} = getTargetAtPosition(nodes, position)!;\n+    const {node} = context as SingleNodeTarget;\n+    expect(isExpressionNode(node!)).toBe(true);\n+    expect(node).toBeInstanceOf(e.SafeKeyedRead);\n+  });\n+\n   it('should locate property write', () => {\n     const {errors, nodes, position} = parse(`<div (foo)=\"b¦ar=$event\"></div>`);\n     expect(errors).toBe(null);"
        },
        {
            "sha": "f4e1972b79f46d3e941200b40e7539d305018b6c",
            "filename": "packages/language-service/src/expression_type.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Flanguage-service%2Fsrc%2Fexpression_type.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Flanguage-service%2Fsrc%2Fexpression_type.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fexpression_type.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, AstVisitor, ASTWithName, Binary, BindingPipe, Chain, Conditional, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, MethodCall, NonNullAssert, PrefixNot, PropertyRead, PropertyWrite, Quote, SafeMethodCall, SafePropertyRead, ThisReceiver, Unary} from '@angular/compiler';\n+import {AST, AstVisitor, ASTWithName, Binary, BindingPipe, Chain, Conditional, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, MethodCall, NonNullAssert, PrefixNot, PropertyRead, PropertyWrite, Quote, SafeKeyedRead, SafeMethodCall, SafePropertyRead, ThisReceiver, Unary} from '@angular/compiler';\n \n import {createDiagnostic, Diagnostic} from './diagnostic_messages';\n import {BuiltinType, Signature, Symbol, SymbolQuery, SymbolTable} from './symbols';\n@@ -271,7 +271,7 @@ export class AstType implements AstVisitor {\n   }\n \n   visitKeyedRead(ast: KeyedRead): Symbol {\n-    const targetType = this.getType(ast.obj);\n+    const targetType = this.getType(ast.receiver);\n     const keyType = this.getType(ast.key);\n     const result = targetType.indexed(\n         keyType, ast.key instanceof LiteralPrimitive ? ast.key.value : undefined);\n@@ -379,6 +379,14 @@ export class AstType implements AstVisitor {\n     return this.resolvePropertyRead(this.query.getNonNullableType(this.getType(ast.receiver)), ast);\n   }\n \n+  visitSafeKeyedRead(ast: SafeKeyedRead): Symbol {\n+    const targetType = this.query.getNonNullableType(this.getType(ast.receiver));\n+    const keyType = this.getType(ast.key);\n+    const result = targetType.indexed(\n+        keyType, ast.key instanceof LiteralPrimitive ? ast.key.value : undefined);\n+    return result || this.anyType;\n+  }\n+\n   /**\n    * Gets the source of an expession AST.\n    * The AST's sourceSpan is relative to the start of the template source code, which is contained"
        },
        {
            "sha": "be315c9bbc6c90bd5ed2edda710428178550d0c1",
            "filename": "packages/language-service/src/expressions.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Flanguage-service%2Fsrc%2Fexpressions.ts",
            "raw_url": "https://github.com/angular/angular/raw/ba084857ea018a4a77cfc855f0276dcaa2a0c2fa/packages%2Flanguage-service%2Fsrc%2Fexpressions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fexpressions.ts?ref=ba084857ea018a4a77cfc855f0276dcaa2a0c2fa",
            "patch": "@@ -74,6 +74,7 @@ export function getExpressionCompletions(\n       result = undefined;\n     },\n     visitKeyedRead(_ast) {},\n+    visitSafeKeyedRead(_ast) {},\n     visitKeyedWrite(_ast) {},\n     visitLiteralArray(_ast) {},\n     visitLiteralMap(_ast) {},\n@@ -168,6 +169,7 @@ export function getExpressionSymbol(\n     visitThisReceiver(_ast) {},\n     visitInterpolation(_ast) {},\n     visitKeyedRead(_ast) {},\n+    visitSafeKeyedRead(_ast) {},\n     visitKeyedWrite(_ast) {},\n     visitLiteralArray(_ast) {},\n     visitLiteralMap(_ast) {},"
        }
    ],
    "stats": {
        "total": 435,
        "additions": 385,
        "deletions": 50
    }
}