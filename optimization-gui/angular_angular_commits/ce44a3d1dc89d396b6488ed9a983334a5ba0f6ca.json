{
    "author": "petebacondarwin",
    "message": "fix(localize): support downleveled inlined helper localize calls (#40754)\n\nWhen the downleveling helper function has been  inlined into the\n`$localize` call, it is a bit more tricky to parse out the cooked and\nraw strings. There was already code to do this but it assumed that\nthe `cooked` and `raw` items were both arrays.\n\nSometimes the `raw` array is just a copy of the `cooked` array\nvia an expression similar to `raw || (raw=tcookedslice(0))`. This\ncommit changes the `unwrapMessagePartsFromLocalizeCall()`\nfunction to be able to handle such a situation.\n\nFixes #40702\n\nPR Close #40754",
    "sha": "ce44a3d1dc89d396b6488ed9a983334a5ba0f6ca",
    "files": [
        {
            "sha": "55cd10c5fabd53960895f3421b743c69f406502d",
            "filename": "packages/localize/src/tools/src/source_file_utils.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/ce44a3d1dc89d396b6488ed9a983334a5ba0f6ca/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/ce44a3d1dc89d396b6488ed9a983334a5ba0f6ca/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fsource_file_utils.ts?ref=ce44a3d1dc89d396b6488ed9a983334a5ba0f6ca",
            "patch": "@@ -89,7 +89,7 @@ export function unwrapMessagePartsFromLocalizeCall(\n   // If there is no call to `__makeTemplateObject(...)`, then `raw` must be the same as `cooked`.\n   let raw = cooked;\n \n-  // Check for cached call of the form `x || x = __makeTemplateObject(...)`\n+  // Check for a memoized form: `x || x = ...`\n   if (cooked.isLogicalExpression() && cooked.node.operator === '||' &&\n       cooked.get('left').isIdentifier()) {\n     const right = cooked.get('right');\n@@ -105,15 +105,22 @@ export function unwrapMessagePartsFromLocalizeCall(\n         // This is a minified sequence expression, where the first two expressions in the sequence\n         // are assignments of the cooked and raw arrays respectively.\n         const [first, second] = expressions;\n-        if (first.isAssignmentExpression() && second.isAssignmentExpression()) {\n+        if (first.isAssignmentExpression()) {\n           cooked = first.get('right');\n           if (!cooked.isExpression()) {\n             throw new BabelParseError(\n                 first.node, 'Unexpected cooked value, expected an expression.');\n           }\n-          raw = second.get('right');\n-          if (!raw.isExpression()) {\n-            throw new BabelParseError(second.node, 'Unexpected raw value, expected an expression.');\n+          if (second.isAssignmentExpression()) {\n+            raw = second.get('right');\n+            if (!raw.isExpression()) {\n+              throw new BabelParseError(\n+                  second.node, 'Unexpected raw value, expected an expression.');\n+            }\n+          } else {\n+            // If the second expression is not an assignment then it is probably code to take a copy\n+            // of the cooked array. For example: `raw || (raw=cooked.slice(0))`.\n+            raw = cooked;\n           }\n         }\n       }"
        },
        {
            "sha": "249c4beef838c12690132b4924afba8c3a08e519",
            "filename": "packages/localize/src/tools/test/source_file_utils_spec.ts",
            "status": "modified",
            "additions": 98,
            "deletions": 0,
            "changes": 98,
            "blob_url": "https://github.com/angular/angular/blob/ce44a3d1dc89d396b6488ed9a983334a5ba0f6ca/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fsource_file_utils_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ce44a3d1dc89d396b6488ed9a983334a5ba0f6ca/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fsource_file_utils_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fsource_file_utils_spec.ts?ref=ce44a3d1dc89d396b6488ed9a983334a5ba0f6ca",
            "patch": "@@ -132,6 +132,104 @@ runInEachFileSystem(() => {\n            ]);\n          });\n \n+      it('should return an array of string literals and locations from a (Babel helper) downleveled tagged template',\n+         () => {\n+           let localizeCall = getLocalizeCall(\n+               `$localize(babelHelpers.taggedTemplateLiteral(['a', 'b\\\\t', 'c'], ['a', 'b\\\\\\\\t', 'c']), 1, 2)`);\n+           const [parts, locations] = unwrapMessagePartsFromLocalizeCall(localizeCall, fs);\n+           expect(parts).toEqual(['a', 'b\\t', 'c']);\n+           expect(parts.raw).toEqual(['a', 'b\\\\t', 'c']);\n+           expect(locations).toEqual([\n+             {\n+               start: {line: 0, column: 65},\n+               end: {line: 0, column: 68},\n+               file: absoluteFrom('/test/file.js'),\n+               text: `'a'`,\n+             },\n+             {\n+               start: {line: 0, column: 70},\n+               end: {line: 0, column: 76},\n+               file: absoluteFrom('/test/file.js'),\n+               text: `'b\\\\\\\\t'`,\n+             },\n+             {\n+               start: {line: 0, column: 78},\n+               end: {line: 0, column: 81},\n+               file: absoluteFrom('/test/file.js'),\n+               text: `'c'`,\n+             },\n+           ]);\n+         });\n+\n+      it('should return an array of string literals and locations from a memoized downleveled tagged template',\n+         () => {\n+           let localizeCall = getLocalizeCall(`\n+                var _templateObject;\n+                $localize(_templateObject || (_templateObject = __makeTemplateObject(['a', 'b\\\\t', 'c'], ['a', 'b\\\\\\\\t', 'c'])), 1, 2)`);\n+           const [parts, locations] = unwrapMessagePartsFromLocalizeCall(localizeCall, fs);\n+           expect(parts).toEqual(['a', 'b\\t', 'c']);\n+           expect(parts.raw).toEqual(['a', 'b\\\\t', 'c']);\n+           expect(locations).toEqual([\n+             {\n+               start: {line: 2, column: 105},\n+               end: {line: 2, column: 108},\n+               file: absoluteFrom('/test/file.js'),\n+               text: `'a'`,\n+             },\n+             {\n+               start: {line: 2, column: 110},\n+               end: {line: 2, column: 116},\n+               file: absoluteFrom('/test/file.js'),\n+               text: `'b\\\\\\\\t'`,\n+             },\n+             {\n+               start: {line: 2, column: 118},\n+               end: {line: 2, column: 121},\n+               file: absoluteFrom('/test/file.js'),\n+               text: `'c'`,\n+             },\n+           ]);\n+         });\n+\n+      it('should return an array of string literals and locations from a memoized (inlined Babel helper) downleveled tagged template',\n+         () => {\n+           let localizeCall = getLocalizeCall(`\n+              var e,t,n;\n+              $localize(e ||\n+                (\n+                  t=[\"a\",\"b\\t\",\"c\"],\n+                  n || (n=t.slice(0)),\n+                  e = Object.freeze(\n+                    Object.defineProperties(t, { raw: { value: Object.freeze(n) } })\n+                  )\n+                ),\n+                1,2\n+              )`);\n+           const [parts, locations] = unwrapMessagePartsFromLocalizeCall(localizeCall, fs);\n+           expect(parts).toEqual(['a', 'b\\t', 'c']);\n+           expect(parts.raw).toEqual(['a', 'b\\t', 'c']);\n+           expect(locations).toEqual([\n+             {\n+               start: {line: 4, column: 21},\n+               end: {line: 4, column: 24},\n+               file: absoluteFrom('/test/file.js'),\n+               text: `\"a\"`,\n+             },\n+             {\n+               start: {line: 4, column: 25},\n+               end: {line: 4, column: 29},\n+               file: absoluteFrom('/test/file.js'),\n+               text: `\"b\\t\"`,\n+             },\n+             {\n+               start: {line: 4, column: 30},\n+               end: {line: 4, column: 33},\n+               file: absoluteFrom('/test/file.js'),\n+               text: `\"c\"`,\n+             },\n+           ]);\n+         });\n+\n       it('should return an array of string literals and locations from a lazy load template helper',\n          () => {\n            let localizeCall = getLocalizeCall(`"
        }
    ],
    "stats": {
        "total": 115,
        "additions": 110,
        "deletions": 5
    }
}