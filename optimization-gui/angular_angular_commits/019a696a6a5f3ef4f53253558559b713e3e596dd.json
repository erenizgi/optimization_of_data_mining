{
    "author": "AndrewKushnir",
    "message": "Revert \"build: remove obsolete Bazel function ctx.new_file (#38080)\" (#38101)\n\nThis reverts commit 406f801b7072f65491eac332056a8e444027dc10.\n\nThe reason for the revert is the breakage in i18n subsystem in g3.\n\nPR Close #38101",
    "sha": "019a696a6a5f3ef4f53253558559b713e3e596dd",
    "files": [
        {
            "sha": "fc67d737669bb64571ad303b16a078c352834262",
            "filename": "packages/bazel/src/ng_module.bzl",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/019a696a6a5f3ef4f53253558559b713e3e596dd/packages%2Fbazel%2Fsrc%2Fng_module.bzl",
            "raw_url": "https://github.com/angular/angular/raw/019a696a6a5f3ef4f53253558559b713e3e596dd/packages%2Fbazel%2Fsrc%2Fng_module.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module.bzl?ref=019a696a6a5f3ef4f53253558559b713e3e596dd",
            "patch": "@@ -277,8 +277,11 @@ def _expected_outs(ctx):\n \n     # TODO(alxhub): i18n is only produced by the legacy compiler currently. This should be re-enabled\n     # when ngtsc can extract messages\n-    if is_legacy_ngc:\n+    if is_legacy_ngc and _is_bazel():\n         i18n_messages_files = [ctx.actions.declare_file(ctx.label.name + \"_ngc_messages.xmb\")]\n+    elif is_legacy_ngc:\n+        # write the xmb file to blaze-genfiles since that path appears in the translation console keys\n+        i18n_messages_files = [ctx.new_file(ctx.genfiles_dir, ctx.label.name + \"_ngc_messages.xmb\")]\n     else:\n         i18n_messages_files = []\n \n@@ -455,13 +458,19 @@ def ngc_compile_action(\n     )\n \n     if is_legacy_ngc and messages_out != None:\n+        # The base path is bin_dir because of the way the ngc\n+        # compiler host is configured. Under Blaze, we need to explicitly\n+        # point to genfiles/ to redirect the output.\n+        # See _expected_outs above, where the output path for the message file\n+        # is conditional on whether we are in Bazel.\n+        message_file_path = messages_out[0].short_path if _is_bazel() else \"../genfiles/\" + messages_out[0].short_path\n         ctx.actions.run(\n             inputs = inputs,\n             outputs = messages_out,\n             executable = ctx.executable.ng_xi18n,\n             arguments = (_EXTRA_NODE_OPTIONS_FLAGS +\n                          [tsconfig_file.path] +\n-                         [messages_out[0].short_path]),\n+                         [message_file_path]),\n             progress_message = \"Extracting Angular 2 messages (ng_xi18n)\",\n             mnemonic = \"Angular2MessageExtractor\",\n         )"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 11,
        "deletions": 2
    }
}