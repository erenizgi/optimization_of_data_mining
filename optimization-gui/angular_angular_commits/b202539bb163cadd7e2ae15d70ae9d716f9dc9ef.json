{
    "author": "gkalpak",
    "message": "ci: improve angular.io deployment process for the RC branch (#43963)\n\nPreviously, (when there was an active RC) the RC branch was only\ndeployed to the `rc-angular-io-site` Firebase site, which is connected\nto the `rc.angular.io` domain. However, if the RC major version was\nhigher than the stable major version, we also had to manually configure\n(via the Firebase console and/or DNS records) the `v<X>.angular.io`\ndomain to redirect to `rc.angular.io`. Then, once `<X>` became the new\nstable version, we had to manually remove the redirect (to let\n`v<X>.angular.io` be redirected to `angular.io`).\n\nThis commit is part of a new process that reduces the manual steps as\nfollows (the steps below only apply to RC versions that have a higher\nmajor version than the current stable):\n- A `v<X>-angular-io-site` Firebase site will be created for the new RC\n  version.\n- The `v<X>.angular.io` domain will be connected to that new Firebase\n  site.\n- When deploying from the RC branch, we will deploy to both\n  `rc-angular-io-site` and `v<X>-angular-io-site`. In addition, the\n  deployment to `v<X>-angular-io-site` will update the Firebase config\n  file to redirect to `rc.angular.io`.\n- When the RC version becomes the new stable, we will start deploying to\n  `v<X>-angular-io-site` from the stable branch, which will update the\n  Firebase config to stop redirecting to `rc.angular.io` and redirect to\n  `angular.io` instead (without requiring changes in the Firebase\n  console or DNS).\n\nPR Close #43963",
    "sha": "b202539bb163cadd7e2ae15d70ae9d716f9dc9ef",
    "files": [
        {
            "sha": "65d140932c32cd4a39ad227f190b5c480b4bfcb9",
            "filename": "aio/scripts/deploy-to-firebase/index.mjs",
            "status": "modified",
            "additions": 29,
            "deletions": 3,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/b202539bb163cadd7e2ae15d70ae9d716f9dc9ef/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "raw_url": "https://github.com/angular/angular/raw/b202539bb163cadd7e2ae15d70ae9d716f9dc9ef/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs?ref=b202539bb163cadd7e2ae15d70ae9d716f9dc9ef",
            "patch": "@@ -25,13 +25,17 @@\n  * | branch    |        | redirectRcToStable              |                                 |\n  * | are we    |--------|---------------------------------|---------------------------------|\n  * | deploying | RC     | -                               | rc                              |\n- * | from?     |        |                                 |                                 |\n+ * | from?     |        |                                 | redirectVersionDomainToRc(*)    |\n  * |           |--------|---------------------------------|---------------------------------|\n  * |           | MASTER | next                            | next                            |\n  * |           |        |                                 |                                 |\n  * |-----------|--------|---------------------------------|---------------------------------|\n  *\n+ * (*):  Only if `v<RC>` > `v<STABLE>`.\n+ *\n  * NOTES:\n+ *   - The `v<X>-angular-io-site` Firebase site should be created (and connected to the\n+ *     `v<X>.angular.io` subdomain) before a new RC branch is created.\n  *   - When a new major version is released, the deploy CI jobs for the new stable branch (prev. RC\n  *     or next) and the old stable branch must be run AFTER the new stable version has been\n  *     published to NPM, because the NPM info is used to determine what the stable version is.\n@@ -126,6 +130,7 @@ function computeDeploymentsInfo(\n \n   // The deployment mode is computed based on the branch we are building.\n   const currentBranchMajorVersion = u.computeMajorVersion(currentBranch);\n+  const stableBranchMajorVersion = u.computeMajorVersion(stableBranch);\n   const deploymentInfoPerTarget = {\n     // PRIMARY DEPLOY TARGETS\n     //\n@@ -184,6 +189,16 @@ function computeDeploymentsInfo(\n     // Since there can be multiple secondary deployments (each tweaking the primary one in different\n     // ways), it is a good idea to ensure that any pre-deploy actions are undone in the post-deploy\n     // phase.\n+    redirectVersionDomainToRc: {\n+      name: 'redirectVersionDomainToRc',\n+      type: 'secondary',\n+      deployEnv: 'rc',\n+      projectId: 'angular-io',\n+      siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n+      deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n+      preDeployActions: [pre.redirectAllToRc],\n+      postDeployActions: [pre.undo.redirectAllToRc, post.testRedirectToRc],\n+    },\n     redirectVersionDomainToStable: {\n       name: 'redirectVersionDomainToStable',\n       type: 'secondary',\n@@ -225,7 +240,19 @@ function computeDeploymentsInfo(\n \n   // If the current branch is the RC branch, deploy as `rc`.\n   if (currentBranch === rcBranch) {\n-    return [deploymentInfoPerTarget.rc];\n+    return (currentBranchMajorVersion > stableBranchMajorVersion) ?\n+      // The RC major version is greater than the stable major version.\n+      // Deploy to both `rc-angular-io-site` and `v<RC>-angular-io-site`.\n+      [\n+        deploymentInfoPerTarget.rc,\n+        deploymentInfoPerTarget.redirectVersionDomainToRc,\n+      ] :\n+      // The RC major version is not greater than the stable major version.\n+      // Only deploy to `rc-angular-io-site` (since `v<RC>-angular-io-site` is probably\n+      // `v<STABLE>-angular-io-site` and we don't want to overwrite the stable deployment).\n+      [\n+        deploymentInfoPerTarget.rc,\n+      ];\n   }\n \n   // If the current branch is the stable branch, deploy as `stable`.\n@@ -266,7 +293,6 @@ function computeDeploymentsInfo(\n   }\n \n   // Do not deploy if it does not have a lower major version than stable.\n-  const stableBranchMajorVersion = u.computeMajorVersion(stableBranch);\n   if (currentBranchMajorVersion >= stableBranchMajorVersion) {\n     return [\n       skipDeployment("
        },
        {
            "sha": "cd9d600c3aec7882d1fdcef969f4dcf362e1a47b",
            "filename": "aio/scripts/deploy-to-firebase/index.spec.mjs",
            "status": "modified",
            "additions": 31,
            "deletions": 17,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/b202539bb163cadd7e2ae15d70ae9d716f9dc9ef/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/b202539bb163cadd7e2ae15d70ae9d716f9dc9ef/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs?ref=b202539bb163cadd7e2ae15d70ae9d716f9dc9ef",
            "patch": "@@ -85,6 +85,7 @@ describe('deploy-to-firebase:', () => {\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: 'master',\n+      CI_STABLE_BRANCH: mostRecentMinorBranch,\n       CI_COMMIT: latestCommits.master,\n     })).toEqual([\n       {\n@@ -151,7 +152,7 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('stable - deploy success - no active RC', () => {\n-    const majorVersion = u.computeMajorVersion(mostRecentMinorBranch);\n+    const stableMajorVersion = u.computeMajorVersion(mostRecentMinorBranch);\n \n     expect(getDeploymentsInfoFor({\n       CI_REPO_OWNER: 'angular',\n@@ -176,8 +177,8 @@ describe('deploy-to-firebase:', () => {\n         type: 'secondary',\n         deployEnv: 'stable',\n         projectId: 'angular-io',\n-        siteId: `v${majorVersion}-angular-io-site`,\n-        deployedUrl: `https://v${majorVersion}.angular.io/`,\n+        siteId: `v${stableMajorVersion}-angular-io-site`,\n+        deployedUrl: `https://v${stableMajorVersion}.angular.io/`,\n         preDeployActions: ['function:redirectAllToStable'],\n         postDeployActions: ['function:undoRedirectAllToStable', 'function:testRedirectToStable'],\n       },\n@@ -321,6 +322,8 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('rc - deploy success - major higher than stable', () => {\n+    const rcMajorVersion = u.computeMajorVersion(mostRecentMinorBranch);\n+\n     expect(getDeploymentsInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n@@ -339,6 +342,16 @@ describe('deploy-to-firebase:', () => {\n         preDeployActions: ['function:build', 'function:checkPayloadSize'],\n         postDeployActions: ['function:testPwaScore'],\n       },\n+      {\n+        name: 'redirectVersionDomainToRc',\n+        type: 'secondary',\n+        deployEnv: 'rc',\n+        projectId: 'angular-io',\n+        siteId: `v${rcMajorVersion}-angular-io-site`,\n+        deployedUrl: `https://v${rcMajorVersion}.angular.io/`,\n+        preDeployActions: ['function:redirectAllToRc'],\n+        postDeployActions: ['function:undoRedirectAllToRc', 'function:testRedirectToRc'],\n+      },\n     ]);\n   });\n \n@@ -451,35 +464,36 @@ describe('deploy-to-firebase:', () => {\n   it('integration - should run the main script without error', () => {\n     // NOTE:\n     // This test executes a new instance of the `deploy-to-firebase` script on a separate process\n-    // and thus does not share the `getRemoteRefs()` cache. To improve stability, we retrieve the\n-    // latest commit from master ignoring any cached entries.\n-    const latestCommitOnMaster = u.getLatestCommit('master', {retrieveFromCache: false});\n+    // and thus does not share the `getRemoteRefs()` cache. To improve stability, we use an older\n+    // branch (`4.4.x`) that is unlikely to receive any new commits (so the one retrieved at the\n+    // beginning of the tests will still be the latest one for that branch).\n     const scriptPath = `${u.getDirname(import.meta.url)}/index.mjs`;\n     const cmd = `\"${process.execPath}\" \"${scriptPath}\" --dry-run`;\n     const env = {\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n-      CI_BRANCH: 'master',\n-      CI_COMMIT: latestCommitOnMaster,\n+      CI_BRANCH: '4.4.x',\n+      CI_STABLE_BRANCH: mostRecentMinorBranch,\n+      CI_COMMIT: latestCommits['4.4.x'],\n     };\n     const result = execSync(cmd, {encoding: 'utf8', env}).trim();\n     expect(result).toBe(\n-        'Deployments (1): next\\n' +\n+        'Deployments (1): archive\\n' +\n         '\\n' +\n         '\\n' +\n         '\\n' +\n-        'Deployment 1 of 1: next\\n' +\n-        '-----------------------\\n' +\n-        'Git branch          : master\\n' +\n-        `Git commit          : ${latestCommitOnMaster}\\n` +\n-        'Build/deploy mode   : next\\n' +\n+        'Deployment 1 of 1: archive\\n' +\n+        '--------------------------\\n' +\n+        'Git branch          : 4.4.x\\n' +\n+        `Git commit          : ${latestCommits['4.4.x']}\\n` +\n+        'Build/deploy mode   : archive\\n' +\n         'Firebase project    : angular-io\\n' +\n-        'Firebase site       : next-angular-io-site\\n' +\n+        'Firebase site       : v4-angular-io-site\\n' +\n         'Pre-deploy actions  : build, checkPayloadSize\\n' +\n         'Post-deploy actions : testPwaScore\\n' +\n-        'Deployment URLs     : https://next.angular.io/\\n' +\n-        '                      https://next-angular-io-site.web.app/');\n+        'Deployment URLs     : https://v4.angular.io/\\n' +\n+        '                      https://v4-angular-io-site.web.app/');\n   });\n });\n "
        }
    ],
    "stats": {
        "total": 80,
        "additions": 60,
        "deletions": 20
    }
}