{
    "author": "gkalpak",
    "message": "fix(service-worker): allow checking for updates when constantly polling the server (#40234)\n\nPreviously, the SW would wait to become idle before executing scheduled\ntasks (including checks for newer app versions). It was considered idle\nwhen it hadn't received any request for at least 5 seconds. As a result,\nif the app performed polling (i.e. sent requests to the server) in a\nshorter than 5 seconds interval, the SW would never detect and update to\na newer app version.\nRelated issue: #40207\n\nThis commit fixes this by adding a max delay to `IdleScheduler` to\nensure that no scheduled task will remain pending for longer than the\nspecified max delay.\n\nPR Close #40234",
    "sha": "5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6",
    "files": [
        {
            "sha": "9838186ccf7b9c1d22173d0916620dd76ec5a75c",
            "filename": "packages/service-worker/worker/src/driver.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "raw_url": "https://github.com/angular/angular/raw/5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts?ref=5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6",
            "patch": "@@ -25,7 +25,8 @@ type ClientAssignments = {\n   [id: string]: ManifestHash\n };\n \n-const IDLE_THRESHOLD = 5000;\n+const IDLE_DELAY = 5000;\n+const MAX_IDLE_DELAY = 30000;\n \n const SUPPORTED_CONFIG_VERSION = 1;\n \n@@ -167,7 +168,7 @@ export class Driver implements Debuggable, UpdateSource {\n     this.debugger = new DebugHandler(this, this.adapter);\n \n     // The IdleScheduler will execute idle tasks after a given delay.\n-    this.idle = new IdleScheduler(this.adapter, IDLE_THRESHOLD, this.debugger);\n+    this.idle = new IdleScheduler(this.adapter, IDLE_DELAY, MAX_IDLE_DELAY, this.debugger);\n   }\n \n   /**"
        },
        {
            "sha": "36bae8d1c06668f7663284c8a1854df9569beac6",
            "filename": "packages/service-worker/worker/src/idle.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6/packages%2Fservice-worker%2Fworker%2Fsrc%2Fidle.ts",
            "raw_url": "https://github.com/angular/angular/raw/5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6/packages%2Fservice-worker%2Fworker%2Fsrc%2Fidle.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fidle.ts?ref=5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6",
            "patch": "@@ -25,8 +25,11 @@ export class IdleScheduler {\n   private emptyResolve: Function|null = null;\n   lastTrigger: number|null = null;\n   lastRun: number|null = null;\n+  oldestScheduledAt: number|null = null;\n \n-  constructor(private adapter: Adapter, private threshold: number, private debug: DebugLogger) {}\n+  constructor(\n+      private adapter: Adapter, private delay: number, private maxDelay: number,\n+      private debug: DebugLogger) {}\n \n   async trigger(): Promise<void> {\n     this.lastTrigger = this.adapter.time;\n@@ -43,7 +46,12 @@ export class IdleScheduler {\n     };\n     this.scheduled = scheduled;\n \n-    await this.adapter.timeout(this.threshold);\n+    // Ensure that no task remains pending for longer than `this.maxDelay` ms.\n+    const now = this.adapter.time;\n+    const maxDelay = Math.max(0, (this.oldestScheduledAt ?? now) + this.maxDelay - now);\n+    const delay = Math.min(maxDelay, this.delay);\n+\n+    await this.adapter.timeout(delay);\n \n     if (scheduled.cancel) {\n       return;\n@@ -75,15 +83,21 @@ export class IdleScheduler {\n       this.emptyResolve = null;\n     }\n     this.empty = Promise.resolve();\n+    this.oldestScheduledAt = null;\n   }\n \n   schedule(desc: string, run: () => Promise<void>): void {\n     this.queue.push({desc, run});\n+\n     if (this.emptyResolve === null) {\n       this.empty = new Promise(resolve => {\n         this.emptyResolve = resolve;\n       });\n     }\n+\n+    if (this.oldestScheduledAt === null) {\n+      this.oldestScheduledAt = this.adapter.time;\n+    }\n   }\n \n   get size(): number {"
        },
        {
            "sha": "3d223c6ce33f6dab2c7556fec3f12c50b7c9fdf1",
            "filename": "packages/service-worker/worker/test/idle_spec.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 1,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6/packages%2Fservice-worker%2Fworker%2Ftest%2Fidle_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6/packages%2Fservice-worker%2Fworker%2Ftest%2Fidle_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fidle_spec.ts?ref=5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6",
            "patch": "@@ -21,7 +21,7 @@ describe('IdleScheduler', () => {\n \n   beforeEach(() => {\n     scope = new SwTestHarnessBuilder().build();\n-    idle = new IdleScheduler(scope, 1000, {\n+    idle = new IdleScheduler(scope, 1000, 3000, {\n       log: (v, context) => console.error(v, context),\n     });\n   });\n@@ -137,5 +137,50 @@ describe('IdleScheduler', () => {\n     // The task should have executed.\n     expect(completed).toEqual(true);\n   });\n+\n+  it('executes tasks after max delay even with newer triggers', async () => {\n+    // Set up a single idle task to set the completed flag to true when it runs.\n+    let completed: boolean = false;\n+    idle.schedule('work', async () => {\n+      completed = true;\n+    });\n+\n+    // Trigger the queue once. This trigger will start a timer for the idle timeout,\n+    // but another `trigger()` will be called before that timeout passes.\n+    const firstTrigger = idle.trigger();\n+\n+    // Advance the clock a little, but not enough to actually cause tasks to execute.\n+    scope.advance(999);\n+    expect(completed).toBe(false);\n+\n+    // Next, trigger the queue again.\n+    const secondTrigger = idle.trigger();\n+\n+    // Advance the clock beyond the timeout for the first trigger, but not the second.\n+    // This should cause the first trigger to resolve, but without running the task.\n+    scope.advance(999);\n+    await firstTrigger;\n+    expect(completed).toBe(false);\n+\n+    // Next, trigger the queue again.\n+    const thirdTrigger = idle.trigger();\n+\n+    // Advance the clock beyond the timeout for the second trigger, but not the third.\n+    // This should cause the second trigger to resolve, but without running the task.\n+    scope.advance(999);\n+    await secondTrigger;\n+    expect(completed).toBe(false);\n+\n+    // Next, trigger the queue again.\n+    const forthTrigger = idle.trigger();\n+\n+    // Finally, advance the clock beyond `maxDelay` (3000) from the first trigger, but not beyond\n+    // the timeout for the forth. This should cause the task to be executed nontheless.\n+    scope.advance(3);\n+    await Promise.all([thirdTrigger, forthTrigger]);\n+\n+    // The task should have executed.\n+    expect(completed).toBe(true);\n+  });\n });\n })();"
        },
        {
            "sha": "df8970c2ebddecdb9ffeb27a83df6a1df1101ca6",
            "filename": "packages/service-worker/worker/test/prefetch_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6/packages%2Fservice-worker%2Fworker%2Ftest%2Fprefetch_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6/packages%2Fservice-worker%2Fworker%2Ftest%2Fprefetch_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fprefetch_spec.ts?ref=5e0dbe314bc76ba927e1ced8dcebbab9f31c3be6",
            "patch": "@@ -38,7 +38,7 @@ describe('prefetch assets', () => {\n   let group: PrefetchAssetGroup;\n   let idle: IdleScheduler;\n   beforeEach(() => {\n-    idle = new IdleScheduler(null!, 3000, {\n+    idle = new IdleScheduler(null!, 3000, 30000, {\n       log: (v, ctx = '') => console.error(v, ctx),\n     });\n     group = new PrefetchAssetGroup("
        }
    ],
    "stats": {
        "total": 72,
        "additions": 66,
        "deletions": 6
    }
}