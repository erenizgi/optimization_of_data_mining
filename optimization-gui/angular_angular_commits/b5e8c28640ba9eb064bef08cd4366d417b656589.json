{
    "author": "petebacondarwin",
    "message": "fix(localize): render correct closing tag placeholder names in XLIFF 2 (#41152)\n\nWhen there are elements in a translated message, the start and end tags\nare encoded as placeholders. The names of these placeholders are computed\nfrom the name of the element. For example `<a> will be `START_LINK` and\n`</a>` will be `CLOSE_LINK`.\n\nIf there are more than one element with the same name, but different attributes,\nthen the starting placeholder name is made unique.\nFor example `<a href=\"a\">` would be `START_LINK`, while `<a href=\"b\">` in\nthe same message would then be called `START_LINK_1`.\nBut the closing tags will not be made unique since there are no attrbutes;\nthe always have the same text `</a>`, which will produce, for example,\n`CLOSE_LINK`.\n\nPreviously, when extracting XLIFF 2 formatted translation files, the closing\ntag placeholder names were computed incorrectly from the opening tag\nplaceholder names. For example `CLOSE_LINK_1`.\n\nThis commit strips these `_1` type endings from the start tag placeholder\nname when computing the closing tag placeholder name. It also ensures\nthat the `type` of the placeholder is computed accurately in these cases\ntoo.\n\nFixes #41142\n\nPR Close #41152",
    "sha": "b5e8c28640ba9eb064bef08cd4366d417b656589",
    "files": [
        {
            "sha": "eff40c08cf698254b67d25cb02f1afad885bed59",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff2_translation_serializer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b5e8c28640ba9eb064bef08cd4366d417b656589/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5e8c28640ba9eb064bef08cd4366d417b656589/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts?ref=b5e8c28640ba9eb064bef08cd4366d417b656589",
            "patch": "@@ -113,7 +113,9 @@ export class Xliff2TranslationSerializer implements TranslationSerializer {\n     const text = substitutionLocations?.[placeholderName]?.text;\n \n     if (placeholderName.startsWith('START_')) {\n-      const closingPlaceholderName = placeholderName.replace(/^START/, 'CLOSE');\n+      // Replace the `START` with `CLOSE` and strip off any `_1` ids from the end.\n+      const closingPlaceholderName =\n+          placeholderName.replace(/^START/, 'CLOSE').replace(/_\\d+$/, '');\n       const closingText = substitutionLocations?.[closingPlaceholderName]?.text;\n       const attrs: Record<string, string> = {\n         id: `${this.currentPlaceholderId++}`,\n@@ -186,7 +188,7 @@ export class Xliff2TranslationSerializer implements TranslationSerializer {\n  * and links are special cases.\n  */\n function getTypeForPlaceholder(placeholder: string): string|null {\n-  const tag = placeholder.replace(/^(START_|CLOSE_)/, '');\n+  const tag = placeholder.replace(/^(START_|CLOSE_)/, '').replace(/_\\d+$/, '');\n   switch (tag) {\n     case 'BOLD_TEXT':\n     case 'EMPHASISED_TEXT':"
        },
        {
            "sha": "fbd5ab49d52588d9eb7c2acbaafd89fbfd3f795d",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xliff2_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/b5e8c28640ba9eb064bef08cd4366d417b656589/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b5e8c28640ba9eb064bef08cd4366d417b656589/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts?ref=b5e8c28640ba9eb064bef08cd4366d417b656589",
            "patch": "@@ -301,6 +301,27 @@ runInEachFileSystem(() => {\n                 '<source>a<pc id=\"0\" equivStart=\"START_TAG_DIV\" equivEnd=\"CLOSE_TAG_DIV\" type=\"other\">b</pc>c</source>',\n             );\n           });\n+\n+          it('should render the \"type\" for link elements', () => {\n+            const serializer = new Xliff2TranslationSerializer(\n+                'xx', absoluteFrom('/project'), useLegacyIds, options);\n+            const output = serializer.serialize(\n+                [mockMessage('6', ['a', 'b', 'c'], ['START_LINK', 'CLOSE_LINK'], {})]);\n+            expect(output).toContain(\n+                '<source>a<pc id=\"0\" equivStart=\"START_LINK\" equivEnd=\"CLOSE_LINK\" type=\"link\">b</pc>c</source>',\n+            );\n+          });\n+\n+          it('should render generic close tag placeholders for additional elements', () => {\n+            const serializer = new Xliff2TranslationSerializer(\n+                'xx', absoluteFrom('/project'), useLegacyIds, options);\n+            const output = serializer.serialize([mockMessage(\n+                '6', ['a', 'b', 'c', 'd', 'e'],\n+                ['START_LINK', 'CLOSE_LINK', 'START_LINK_1', 'CLOSE_LINK'], {})]);\n+            expect(output).toContain(\n+                '<source>a<pc id=\"0\" equivStart=\"START_LINK\" equivEnd=\"CLOSE_LINK\" type=\"link\">b</pc>c<pc id=\"1\" equivStart=\"START_LINK_1\" equivEnd=\"CLOSE_LINK\" type=\"link\">d</pc>e</source>',\n+            );\n+          });\n         });\n       });\n     });"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 25,
        "deletions": 2
    }
}