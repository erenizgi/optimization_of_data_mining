{
    "author": "alxhub",
    "message": "fix(compiler-cli): remove classes in .d.ts files from provider checks (#40118)\n\nThis commit temporarily excludes classes declared in .d.ts files from checks\nregarding whether providers are actually injectable.\n\nSuch classes used to be ignored (on accident) because the\n`TypeScriptReflectionHost.getConstructorParameters()` method did not return\nconstructor parameters from d.ts files, mostly as an oversight. This was\nrecently fixed, but caused more providers to be exposed to this check, which\ncreated a breakage in g3.\n\nThis commit temporarily fixes the breakage by continuing to exclude such\nproviders from the check, until g3 can be patched.\n\nPR Close #40118",
    "sha": "973bb403a51245dd3dca939fd9eb2c377e9004bb",
    "files": [
        {
            "sha": "073fa02897dae5de8a611dfc0fda2d95037a5674",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/util.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts?ref=973bb403a51245dd3dca939fd9eb2c377e9004bb",
            "patch": "@@ -516,7 +516,13 @@ export function resolveProvidersRequiringFactory(\n       }\n     }\n \n-    if (tokenClass !== null && reflector.isClass(tokenClass.node)) {\n+    // TODO(alxhub): there was a bug where `getConstructorParameters` would return `null` for a\n+    // class in a .d.ts file, always, even if the class had a constructor. This was fixed for\n+    // `getConstructorParameters`, but that fix causes more classes to be recognized here as needing\n+    // provider checks, which is a breaking change in g3. Avoid this breakage for now by skipping\n+    // classes from .d.ts files here directly, until g3 can be cleaned up.\n+    if (tokenClass !== null && !tokenClass.node.getSourceFile().isDeclarationFile &&\n+        reflector.isClass(tokenClass.node)) {\n       const constructorParameters = reflector.getConstructorParameters(tokenClass.node);\n \n       // Note that we only want to capture providers with a non-trivial constructor,"
        },
        {
            "sha": "b613f5ee9b0ea2fc81d38e8085602b1f6c349a86",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 10,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=973bb403a51245dd3dca939fd9eb2c377e9004bb",
            "patch": "@@ -7493,16 +7493,20 @@ export const Foo = Foo__PRE_R3__;\n            expect(diags.length).toBe(0);\n          });\n \n-      it('should error when an undecorated class with a non-trivial constructor in a declaration file is provided via useClass',\n-         () => {\n-           env.write('node_modules/@angular/core/testing/index.d.ts', `\n+      // TODO(alxhub): this test never worked correctly, as it used to declare a constructor with a\n+      // body, which real declaration files don't have. Without the body, the ReflectionHost used to\n+      // not return any constructor data, preventing an error from showing. That bug was fixed, but\n+      // the error for declaration files is disabled until g3 can be updated.\n+      xit('should error when an undecorated class with a non-trivial constructor in a declaration file is provided via useClass',\n+          () => {\n+            env.write('node_modules/@angular/core/testing/index.d.ts', `\n             export declare class NgZone {}\n \n             export declare class Testability {\n-              constructor(ngZone: NgZone) {}\n+              constructor(ngZone: NgZone);\n             }\n           `);\n-           env.write('test.ts', `\n+            env.write('test.ts', `\n             import {NgModule, Injectable} from '@angular/core';\n             import {Testability} from '@angular/core/testing';\n \n@@ -7515,10 +7519,10 @@ export const Foo = Foo__PRE_R3__;\n             export class SomeModule {}\n           `);\n \n-           const diags = env.driveDiagnostics();\n-           expect(diags.length).toBe(1);\n-           expect(diags[0].messageText).toContain('cannot be created via dependency injection');\n-         });\n+            const diags = env.driveDiagnostics();\n+            expect(diags.length).toBe(1);\n+            expect(diags[0].messageText).toContain('cannot be created via dependency injection');\n+          });\n \n       it('should not error when an class with a factory definition and a non-trivial constructor in a declaration file is provided via useClass',\n          () => {\n@@ -7529,7 +7533,7 @@ export const Foo = Foo__PRE_R3__;\n \n             export declare class Testability {\n               static ɵfac: i0.ɵɵFactoryDef<Testability, never>;\n-              constructor(ngZone: NgZone) {}\n+              constructor(ngZone: NgZone);\n             }\n           `);\n            env.write('test.ts', `"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 21,
        "deletions": 11
    }
}