{
    "author": "atscott",
    "message": "refactor(compiler-cli): expose TTC method to determine if file is tracked shim (#39768)\n\nThe Language Service \"find references\" currently uses the\n`ngtypecheck.ts` suffix to determine if a file is a shim file. Instead,\na better API would be to expose a method in the template type checker\nthat does this verification so that the LS does not have to \"know\" about\nthe typecheck suffix. This also fixes an issue (albeit unlikely) whereby a file\nin the user's program that _actually_ is named with the `ngtypecheck.ts`\nsuffix would have been interpreted as a shim file.\n\nPR Close #39768",
    "sha": "75fc89384d8db4d5cc0333ba608200ae58e95aa9",
    "files": [
        {
            "sha": "a6bc3c4c40b0098da52cb07b26706ab5a0c2578b",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/checker.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/75fc89384d8db4d5cc0333ba608200ae58e95aa9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/75fc89384d8db4d5cc0333ba608200ae58e95aa9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts?ref=75fc89384d8db4d5cc0333ba608200ae58e95aa9",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import {AST, ParseError, TmplAstNode, TmplAstTemplate} from '@angular/compiler';\n+import {AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import * as ts from 'typescript';\n \n import {FullTemplateMapping} from './api';\n@@ -87,6 +88,12 @@ export interface TemplateTypeChecker {\n    */\n   generateAllTypeCheckBlocks(): void;\n \n+  /**\n+   * Returns `true` if the given file is in the record of known shims generated by the compiler,\n+   * `false` if we cannot find the file in the shim records.\n+   */\n+  isTrackedTypeCheckFile(filePath: AbsoluteFsPath): boolean;\n+\n   /**\n    * Retrieve the top-level node representing the TCB for the given component.\n    *"
        },
        {
            "sha": "cd009e34efc3db7874c637b377705ce098a2d5d1",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/75fc89384d8db4d5cc0333ba608200ae58e95aa9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/75fc89384d8db4d5cc0333ba608200ae58e95aa9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=75fc89384d8db4d5cc0333ba608200ae58e95aa9",
            "patch": "@@ -172,6 +172,10 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     return {nodes};\n   }\n \n+  isTrackedTypeCheckFile(filePath: AbsoluteFsPath): boolean {\n+    return this.getFileAndShimRecordsForPath(filePath) !== null;\n+  }\n+\n   private getFileAndShimRecordsForPath(shimPath: AbsoluteFsPath):\n       {fileRecord: FileTypeCheckingData, shimRecord: ShimTypeCheckingData}|null {\n     for (const fileRecord of this.state.values()) {"
        },
        {
            "sha": "ad287cec668a4da984d5a6439d37b8d5b5f42361",
            "filename": "packages/language-service/ivy/references.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/75fc89384d8db4d5cc0333ba608200ae58e95aa9/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "raw_url": "https://github.com/angular/angular/raw/75fc89384d8db4d5cc0333ba608200ae58e95aa9/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences.ts?ref=75fc89384d8db4d5cc0333ba608200ae58e95aa9",
            "patch": "@@ -103,9 +103,7 @@ export class ReferenceBuilder {\n \n     const entries: ts.ReferenceEntry[] = [];\n     for (const ref of refs) {\n-      // TODO(atscott): Determine if a file is a shim file in a more robust way and make the API\n-      // available in an appropriate location.\n-      if (ref.fileName.endsWith('ngtypecheck.ts')) {\n+      if (this.ttc.isTrackedTypeCheckFile(absoluteFrom(ref.fileName))) {\n         const entry = convertToTemplateReferenceEntry(ref, this.ttc);\n         if (entry !== null) {\n           entries.push(entry);"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 12,
        "deletions": 3
    }
}