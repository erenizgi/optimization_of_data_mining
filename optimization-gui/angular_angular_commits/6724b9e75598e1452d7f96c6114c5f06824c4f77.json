{
    "author": "gkalpak",
    "message": "build(zone.js): do not error when build `zone.js` on Windows (#40557)\n\nIn older versions of `bazelbuild/rules_nodejs`, the `npm_package.pack`\nrule does not work on Windows. This has been fixed in\nbazelbuild/rules_nodejs#2257, but the fix is not available before\n[version 2.3.0][1].\n\nCurrently, we use version 2.2.0 (see [WORKSPACE][2]). In order to allow\nthe `zone-js-builder.js` script to work on Windows, this commit switches\nto using `npm pack` directly, intead of relying on `npm_package.pack`.\n\nFor reference, the version of `bazelbuild/rules_nodejs` was updated to\n2.3.2 in PR #39636, but this was later reverted due to CI flakes\n(4e6d69cc85c824faf8e55bbc474cc070aceb2950).\n\n[1]: https://github.com/bazelbuild/rules_nodejs/releases/tag/2.3.0\n[2]: https://github.com/angular/angular/blob/fc64fa8e1af9e0bbab40d1b441743744a40c5581/WORKSPACE#L12\n\nPR Close #40557",
    "sha": "6724b9e75598e1452d7f96c6114c5f06824c4f77",
    "files": [
        {
            "sha": "d91fda767af1ae9a01c3fa75396de69115a483fd",
            "filename": "scripts/build/zone-js-builder.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/6724b9e75598e1452d7f96c6114c5f06824c4f77/scripts%2Fbuild%2Fzone-js-builder.js",
            "raw_url": "https://github.com/angular/angular/raw/6724b9e75598e1452d7f96c6114c5f06824c4f77/scripts%2Fbuild%2Fzone-js-builder.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fzone-js-builder.js?ref=6724b9e75598e1452d7f96c6114c5f06824c4f77",
            "patch": "@@ -35,7 +35,7 @@ function buildZoneJsPackage(destPath) {\n   console.info(`${scriptPath}:`);\n   console.info('  Building zone.js npm package');\n   console.info('##############################');\n-  exec(`${bazelCmd} run //packages/zone.js:npm_package.pack`);\n+  exec(`${bazelCmd} build //packages/zone.js:npm_package`);\n \n   // Create the output directory.\n   const absDestPath = resolve(baseDir, destPath);\n@@ -46,6 +46,12 @@ function buildZoneJsPackage(destPath) {\n   const buildOutputDir = `${bazelBin}/packages/zone.js/npm_package`;\n   const distTargetDir = `${absDestPath}/zone.js`;\n \n+  // Also create an archive so we can test the package itself.\n+  // Currently, the `npm_package.pack` rule does not work on Windows, so run `npm pack` directly.\n+  //\n+  // TODO: Switch to `npm_package.pack`, once we upgrade to `bazelbuild/rules_nodejs` >=2.3.0.\n+  exec(`npm pack ${buildOutputDir}`, false, {cwd: baseDir});\n+\n   console.info(`# Copy npm_package artifacts to ${distTargetDir}`);\n   rm('-rf', distTargetDir);\n   cp('-R', buildOutputDir, distTargetDir);"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 7,
        "deletions": 1
    }
}