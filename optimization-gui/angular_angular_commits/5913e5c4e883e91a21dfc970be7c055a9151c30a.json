{
    "author": "bjarkler",
    "message": "feat(core): add Trusted Types workaround for Function constructor (#39209)\n\nChrome currently does not support passing TrustedScript to the Function\nconstructor, and instead fails with a Trusted Types violation when\ncalled. As the Function constructor is used in a handful of places\nwithin Angular, such as in the JIT compiler and named_array_type, the\nworkaround proposed on the following page is implemented:\nhttps://github.com/w3c/webappsec-trusted-types/wiki/Trusted-Types-for-function-constructor\n\nTo be precise, it constructs a string representing an anonymous function\nin a way that is equivalent to what the Function constructor does,\npromotes it to a TrustedScript and then calls eval.\n\nTo facilitate backwards compatibility, new Function is used directly in\nenvironments that do not support Trusted Types.\n\nPR Close #39209",
    "sha": "5913e5c4e883e91a21dfc970be7c055a9151c30a",
    "files": [
        {
            "sha": "94ca1acbe0476aee7448ba5326f78a08bee4de0e",
            "filename": "packages/core/src/util/security/trusted_types.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/5913e5c4e883e91a21dfc970be7c055a9151c30a/packages%2Fcore%2Fsrc%2Futil%2Fsecurity%2Ftrusted_types.ts",
            "raw_url": "https://github.com/angular/angular/raw/5913e5c4e883e91a21dfc970be7c055a9151c30a/packages%2Fcore%2Fsrc%2Futil%2Fsecurity%2Ftrusted_types.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Futil%2Fsecurity%2Ftrusted_types.ts?ref=5913e5c4e883e91a21dfc970be7c055a9151c30a",
            "patch": "@@ -85,3 +85,49 @@ export function trustedScriptFromString(script: string): TrustedScript|string {\n export function trustedScriptURLFromString(url: string): TrustedScriptURL|string {\n   return getPolicy()?.createScriptURL(url) || url;\n }\n+\n+/**\n+ * Unsafely call the Function constructor with the given string arguments. It\n+ * is only available in development mode, and should be stripped out of\n+ * production code.\n+ * @security This is a security-sensitive function; any use of this function\n+ * must go through security review. In particular, it must be assured that it\n+ * is only called from development code, as use in production code can lead to\n+ * XSS vulnerabilities.\n+ */\n+export function newTrustedFunctionForDev(...args: string[]): Function {\n+  if (typeof ngDevMode === 'undefined') {\n+    throw new Error('newTrustedFunctionForDev should never be called in production');\n+  }\n+  if (!global.trustedTypes) {\n+    // In environments that don't support Trusted Types, fall back to the most\n+    // straightforward implementation:\n+    return new Function(...args);\n+  }\n+\n+  // Chrome currently does not support passing TrustedScript to the Function\n+  // constructor. The following implements the workaround proposed on the page\n+  // below, where the Chromium bug is also referenced:\n+  // https://github.com/w3c/webappsec-trusted-types/wiki/Trusted-Types-for-function-constructor\n+  const fnArgs = args.slice(0, -1).join(',');\n+  const fnBody = args.pop()!.toString();\n+  const body = `(function anonymous(${fnArgs}\n+) { ${fnBody}\n+})`;\n+\n+  // Using eval directly confuses the compiler and prevents this module from\n+  // being stripped out of JS binaries even if not used. The global['eval']\n+  // indirection fixes that.\n+  const fn = global['eval'](trustedScriptFromString(body) as string) as Function;\n+\n+  // To completely mimic the behavior of calling \"new Function\", two more\n+  // things need to happen:\n+  // 1. Stringifying the resulting function should return its source code\n+  fn.toString = () => body;\n+  // 2. When calling the resulting function, `this` should refer to `global`\n+  return fn.bind(global);\n+\n+  // When Trusted Types support in Function constructors is widely available,\n+  // the implementation of this function can be simplified to:\n+  // return new Function(...args.map(a => trustedScriptFromString(a)));\n+}"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 46,
        "deletions": 0
    }
}