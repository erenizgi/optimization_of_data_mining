{
    "author": "alan-agius4",
    "message": "ci: use Node.js browsers image (#43810)\n\nSpinning up a Node.js browsers image has little to no overhead when the image is not cached on the host. `install_chrome_libs` however takes takes ~13s everytime.\n\nPR Close #43810",
    "sha": "17f529996767edcc4351e769265cc2ecc8cee7b5",
    "files": [
        {
            "sha": "b6801372e3a02212dec588c76f71ad17a07deebd",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 19,
            "deletions": 34,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/17f529996767edcc4351e769265cc2ecc8cee7b5/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/17f529996767edcc4351e769265cc2ecc8cee7b5/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=17f529996767edcc4351e769265cc2ecc8cee7b5",
            "patch": "@@ -90,6 +90,16 @@ executors:\n     resource_class: << parameters.resource_class >>\n     working_directory: ~/ng\n \n+  test-browser-executor:\n+    parameters:\n+      resource_class:\n+        type: string\n+        default: medium\n+    docker:\n+      - image: cimg/node:14.17.6-browsers@sha256:aa6d08a04d13dd8aa18ae94be70a703c14dde0e99ea572e885e548f47f95eaa9\n+    resource_class: << parameters.resource_class >>\n+    working_directory: ~/ng\n+\n   windows-executor:\n     working_directory: ~/ng\n     resource_class: windows.2xlarge\n@@ -118,22 +128,6 @@ commands:\n       - attach_workspace:\n           at: *workspace_location\n \n-  # Install shared libs used by Chrome that is either provisioned by\n-  # rules_webtesting or by puppeteer.\n-  install_chrome_libs:\n-    description: Install shared Chrome libs\n-    steps:\n-      - run:\n-          name: Install shared Chrome libs\n-          command: |\n-            sudo apt-get update\n-            # Install GTK+ graphical user interface (libgtk-3-0), advanced linux sound architecture (libasound2)\n-            # and network security service libraries (libnss3) & X11 Screen Saver extension library (libssx1)\n-            # which are dependencies of chrome & needed for karma & protractor headless chrome tests.\n-            # This is a very small install which takes around 7s in comparing to using the full\n-            # cimg/node:x.x.x-browsers image.\n-            sudo apt-get -y install libgtk-3-0 libasound2 libnss3 libxss1\n-\n   # Install java runtime which is required by some integration tests such as\n   # //integration:hello_world__closure_test, //integration:i18n_test and\n   # //integration:ng_elements_test to run the closure compiler\n@@ -298,7 +292,7 @@ jobs:\n \n   test:\n     executor:\n-      name: default-executor\n+      name: test-browser-executor\n       # Now that large integration tests are running locally in parallel (they can't run on RBE yet\n       # as they require network access for yarn install), this test is running out of memory\n       # consistently with the xlarge machine.\n@@ -307,7 +301,6 @@ jobs:\n     steps:\n       - custom_attach_workspace\n       - init_environment\n-      - install_chrome_libs\n       - install_java\n       - run:\n           command: yarn bazel test //... --build_tag_filters=-ivy-only --test_tag_filters=-ivy-only\n@@ -316,12 +309,11 @@ jobs:\n   # Temporary job to test what will happen when we flip the Ivy flag to true\n   test_ivy_aot:\n     executor:\n-      name: default-executor\n+      name: test-browser-executor\n       resource_class: xlarge\n     steps:\n       - custom_attach_workspace\n       - init_environment\n-      - install_chrome_libs\n       # We need to explicitly specify the --symlink_prefix option because otherwise we would\n       # not be able to easily find the output bin directory when uploading artifacts for size\n       # measurements.\n@@ -397,11 +389,10 @@ jobs:\n           webhook_url_env_var: SLACK_DEV_INFRA_CI_FAILURES_WEBHOOK_URL\n \n   test_aio:\n-    executor: default-executor\n+    executor: test-browser-executor\n     steps:\n       - custom_attach_workspace\n       - init_environment\n-      - install_chrome_libs\n         # Build aio\n       - run: yarn --cwd aio build --progress=false\n         # Lint the code\n@@ -420,21 +411,19 @@ jobs:\n       - run: yarn --cwd aio redirects-test\n \n   deploy_aio:\n-    executor: default-executor\n+    executor: test-browser-executor\n     steps:\n       - custom_attach_workspace\n       - init_environment\n-      - install_chrome_libs\n         # Deploy angular.io to production (if necessary)\n       - run: setPublicVar_CI_STABLE_BRANCH\n       - run: yarn --cwd aio deploy-production\n \n   test_aio_local:\n-    executor: default-executor\n+    executor: test-browser-executor\n     steps:\n       - custom_attach_workspace\n       - init_environment\n-      - install_chrome_libs\n         # Build aio (with local Angular packages)\n       - run: yarn --cwd aio build-local-ci\n         # Run unit tests\n@@ -460,15 +449,14 @@ jobs:\n \n   test_docs_examples:\n     executor:\n-      name: default-executor\n+      name: test-browser-executor\n       resource_class: xlarge\n     parallelism: 5\n     environment:\n       RXJS_VERSION_7: '7.4.0'\n     steps:\n       - custom_attach_workspace\n       - init_environment\n-      - install_chrome_libs\n         # Install aio\n       - run: yarn --cwd aio install --frozen-lockfile --non-interactive --cache-folder ~/.cache/yarn\n         # Run examples tests. The \"CIRCLE_NODE_INDEX\" will be set if \"parallelism\" is enabled.\n@@ -506,11 +494,10 @@ jobs:\n \n   # This job should only be run on PR builds, where `CI_PULL_REQUEST` is not `false`.\n   test_aio_preview:\n-    executor: default-executor\n+    executor: test-browser-executor\n     steps:\n       - custom_attach_workspace\n       - init_environment\n-      - install_chrome_libs\n       - run: yarn --cwd aio install --frozen-lockfile --non-interactive --cache-folder ~/.cache/yarn\n       - run:\n           name: Wait for preview and run tests\n@@ -618,11 +605,10 @@ jobs:\n           command: yarn node aio/scripts/test-external-urls.js\n \n   aio_monitoring_stable:\n-    executor: default-executor\n+    executor: test-browser-executor\n     steps:\n       - custom_attach_workspace\n       - init_environment\n-      - install_chrome_libs\n       - run: setPublicVar_CI_STABLE_BRANCH\n       - run:\n           name: Check out `aio/` and yarn from the stable branch\n@@ -641,11 +627,10 @@ jobs:\n           webhook_url_env_var: SLACK_DEV_INFRA_CI_FAILURES_WEBHOOK_URL\n \n   aio_monitoring_next:\n-    executor: default-executor\n+    executor: test-browser-executor\n     steps:\n       - custom_attach_workspace\n       - init_environment\n-      - install_chrome_libs\n       - run:\n           name: Run tests against https://next.angular.io/\n           command: ./aio/scripts/test-production.sh https://next.angular.io/ $CI_AIO_MIN_PWA_SCORE"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 19,
        "deletions": 34
    }
}