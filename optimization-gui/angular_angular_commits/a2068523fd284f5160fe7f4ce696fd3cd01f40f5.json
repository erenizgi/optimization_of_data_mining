{
    "author": "klemenoslaj",
    "message": "feat(service-worker): add the option to prefer network for navigation requests (#38565)\n\nThis commit introduces a new option for the service worker, called\n`navigationRequestStrategy`, which adds the possibility to force the service worker\nto always create a network request for navigation requests.\nThis enables the server redirects while retaining the offline behavior.\n\nFixes #38194\n\nPR Close #38565",
    "sha": "a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
    "files": [
        {
            "sha": "6135f2f2184cf9a1bd739515c1b6439311c5f12d",
            "filename": "aio/content/guide/service-worker-config.md",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/aio%2Fcontent%2Fguide%2Fservice-worker-config.md",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/aio%2Fcontent%2Fguide%2Fservice-worker-config.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fservice-worker-config.md?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -267,6 +267,12 @@ By default, these criteria are:\n 1. The URL must not contain a file extension (i.e. a `.`) in the last path segment.\n 2. The URL must not contain `__`.\n \n+<div class=\"alert is-helpful\">\n+\n+To configure whether navigation requests are sent through to the network or not, see the [navigationRequestStrategy](#navigation-request-strategy) section.\n+\n+</div>\n+\n ### Matching navigation request URLs\n \n While these default criteria are fine in most cases, it is sometimes desirable to configure different rules. For example, you may want to ignore specific routes (that are not part of the Angular app) and pass them through to the server.\n@@ -285,3 +291,32 @@ If the field is omitted, it defaults to:\n   '!/**/*__*/**',  // Exclude URLs containing `__` in any other segment.\n ]\n ```\n+\n+{@a navigation-request-strategy}\n+\n+## `navigationRequestStrategy`\n+\n+This optional property enables you to configure how the service worker handles navigation requests:\n+\n+```json\n+{\n+  \"navigationRequestStrategy\": \"freshness\"\n+}\n+```\n+\n+Possible values:\n+\n+- `'performance'`: The default setting. Serves the specified [index file](#index-file), which is typically cached.\n+- `'freshness'`: Passes the requests through to the network and falls back to the `performance` behavior when offline.\n+  This value is useful when the server redirects the navigation requests elsewhere using an HTTP redirect (3xx status code).\n+  Reasons for using this value include:\n+    - Redirecting to an authentication website when authentication is not handled by the application.\n+    - Redirecting specific URLs to avoid breaking existing links/bookmarks after a website redesign.\n+    - Redirecting to a different website, such as a server-status page, while a page is temporarily down.\n+\n+<div class=\"alert is-important\">\n+\n+The `freshness` strategy usually results in more requests sent to the server, which can increase response latency.\n+It is recommended that you use the default performance strategy whenever possible.\n+\n+</div>\n\\ No newline at end of file"
        },
        {
            "sha": "75a007d98b50509a21caed32026c65f5c4a6534e",
            "filename": "goldens/public-api/service-worker/config/config.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/goldens%2Fpublic-api%2Fservice-worker%2Fconfig%2Fconfig.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/goldens%2Fpublic-api%2Fservice-worker%2Fconfig%2Fconfig.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fservice-worker%2Fconfig%2Fconfig.d.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -14,6 +14,7 @@ export declare interface Config {\n     assetGroups?: AssetGroup[];\n     dataGroups?: DataGroup[];\n     index: string;\n+    navigationRequestStrategy?: 'freshness' | 'performance';\n     navigationUrls?: string[];\n }\n "
        },
        {
            "sha": "a8cfecd218f81574a1d0f49e0893a3b3e792c547",
            "filename": "packages/service-worker/config/schema.json",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fconfig%2Fschema.json",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fconfig%2Fschema.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fconfig%2Fschema.json?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -161,6 +161,14 @@\n         \"type\": \"string\"\n       },\n       \"uniqueItems\": true\n+    },\n+    \"navigationRequestStrategy\": {\n+      \"enum\": [\n+        \"freshness\",\n+        \"performance\"\n+      ],\n+      \"default\": \"performance\",\n+      \"description\": \"The Angular service worker can use two request strategies for navigation requests. 'performance', the default, skips navigation requests. The other strategy, 'freshness', forces all navigation requests through the network.\"\n     }\n   },\n   \"required\": ["
        },
        {
            "sha": "61f3e0e5da190a8399b7f2136a16cbf4f4745514",
            "filename": "packages/service-worker/config/src/generator.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fgenerator.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fgenerator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fgenerator.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -39,6 +39,7 @@ export class Generator {\n       dataGroups: this.processDataGroups(config),\n       hashTable: withOrderedKeys(unorderedHashTable),\n       navigationUrls: processNavigationUrls(this.baseHref, config.navigationUrls),\n+      navigationRequestStrategy: config.navigationRequestStrategy ?? 'performance',\n     };\n   }\n "
        },
        {
            "sha": "09fe07563bc6e847bd691db4765f24b7cd82d8e8",
            "filename": "packages/service-worker/config/src/in.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fin.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fin.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -27,6 +27,7 @@ export interface Config {\n   assetGroups?: AssetGroup[];\n   dataGroups?: DataGroup[];\n   navigationUrls?: string[];\n+  navigationRequestStrategy?: 'freshness'|'performance';\n }\n \n /**"
        },
        {
            "sha": "f94a2125d32923bbc3c0e76468d9e4f5fe9320da",
            "filename": "packages/service-worker/config/test/generator_spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fconfig%2Ftest%2Fgenerator_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fconfig%2Ftest%2Fgenerator_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fconfig%2Ftest%2Fgenerator_spec.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -117,6 +117,7 @@ describe('Generator', () => {\n         {positive: true, regex: '^http:\\\\/\\\\/example\\\\.com\\\\/included$'},\n         {positive: false, regex: '^http:\\\\/\\\\/example\\\\.com\\\\/excluded$'},\n       ],\n+      navigationRequestStrategy: 'performance',\n       hashTable: {\n         '/test/foo/test.html': '18f6f8eb7b1c23d2bb61bff028b83d867a9e4643',\n         '/test/index.html': 'a54d88e06612d820bc3be72877c74f257b561b19',\n@@ -149,6 +150,7 @@ describe('Generator', () => {\n         {positive: false, regex: '^\\\\/(?:.+\\\\/)?[^/]*__[^/]*$'},\n         {positive: false, regex: '^\\\\/(?:.+\\\\/)?[^/]*__[^/]*\\\\/.*$'},\n       ],\n+      navigationRequestStrategy: 'performance',\n       hashTable: {},\n     });\n   });\n@@ -249,6 +251,7 @@ describe('Generator', () => {\n         {positive: false, regex: '^\\\\/(?:.+\\\\/)?[^/]*__[^/]*$'},\n         {positive: false, regex: '^\\\\/(?:.+\\\\/)?[^/]*__[^/]*\\\\/.*$'},\n       ],\n+      navigationRequestStrategy: 'performance',\n       hashTable: {\n         '/index.html': 'a54d88e06612d820bc3be72877c74f257b561b19',\n         '/main.js': '41347a66676cdc0516934c76d9d13010df420f2c',"
        },
        {
            "sha": "eeee1ad2b7895061f2678596317740385f01c323",
            "filename": "packages/service-worker/test/integration_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Ftest%2Fintegration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Ftest%2Fintegration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Ftest%2Fintegration_spec.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -47,6 +47,7 @@ const manifest: Manifest = {\n     cacheQueryOptions: {ignoreVary: true},\n   }],\n   navigationUrls: [],\n+  navigationRequestStrategy: 'performance',\n   hashTable: tmpHashTableForFs(dist),\n };\n \n@@ -64,6 +65,7 @@ const manifestUpdate: Manifest = {\n     cacheQueryOptions: {ignoreVary: true},\n   }],\n   navigationUrls: [],\n+  navigationRequestStrategy: 'performance',\n   hashTable: tmpHashTableForFs(distUpdate),\n };\n "
        },
        {
            "sha": "7e1054d85c1a13ef562ae9b606ddb5b54dbcf180",
            "filename": "packages/service-worker/worker/src/app-version.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -185,6 +185,18 @@ export class AppVersion implements UpdateSource {\n     // Next, check if this is a navigation request for a route. Detect circular\n     // navigations by checking if the request URL is the same as the index URL.\n     if (this.adapter.normalizeUrl(req.url) !== this.indexUrl && this.isNavigationRequest(req)) {\n+      if (this.manifest.navigationRequestStrategy === 'freshness') {\n+        // For navigation requests the freshness was configured. The request will always go trough\n+        // the network and fallback to default `handleFetch` behavior in case of failure.\n+        try {\n+          return await this.scope.fetch(req);\n+        } catch {\n+          // Navigation request failed - application is likely offline.\n+          // Proceed forward to the default `handleFetch` behavior, where\n+          // `indexUrl` will be requested and it should be available in the cache.\n+        }\n+      }\n+\n       // This was a navigation request. Re-enter `handleFetch` with a request for\n       // the URL.\n       return this.handleFetch(this.adapter.newRequest(this.indexUrl), context);"
        },
        {
            "sha": "cb9520b13e4b258e80b0f5e81a192550c299dd82",
            "filename": "packages/service-worker/worker/src/manifest.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Fsrc%2Fmanifest.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Fsrc%2Fmanifest.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fmanifest.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -18,6 +18,7 @@ export interface Manifest {\n   assetGroups?: AssetGroupConfig[];\n   dataGroups?: DataGroupConfig[];\n   navigationUrls: {positive: boolean, regex: string}[];\n+  navigationRequestStrategy: 'freshness'|'performance';\n   hashTable: {[url: string]: string};\n }\n "
        },
        {
            "sha": "448b95861bc639bdf3012e4550453ed160ffe9df",
            "filename": "packages/service-worker/worker/test/data_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Ftest%2Fdata_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Ftest%2Fdata_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fdata_spec.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -93,6 +93,7 @@ const manifest: Manifest = {\n     },\n   ],\n   navigationUrls: [],\n+  navigationRequestStrategy: 'performance',\n   hashTable: tmpHashTableForFs(dist),\n };\n "
        },
        {
            "sha": "09c5a374d71dc84e22c1cc8cd634792c708ad5a4",
            "filename": "packages/service-worker/worker/test/happy_spec.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -74,6 +74,7 @@ const brokenManifest: Manifest = {\n   }],\n   dataGroups: [],\n   navigationUrls: processNavigationUrls(''),\n+  navigationRequestStrategy: 'performance',\n   hashTable: tmpHashTableForFs(brokenFs, {'/foo.txt': true}),\n };\n \n@@ -105,6 +106,7 @@ const brokenLazyManifest: Manifest = {\n   ],\n   dataGroups: [],\n   navigationUrls: processNavigationUrls(''),\n+  navigationRequestStrategy: 'performance',\n   hashTable: tmpHashTableForFs(brokenFs, {'/bar.txt': true}),\n };\n \n@@ -198,6 +200,7 @@ const manifest: Manifest = {\n     },\n   ],\n   navigationUrls: processNavigationUrls(''),\n+  navigationRequestStrategy: 'performance',\n   hashTable: tmpHashTableForFs(dist),\n };\n \n@@ -256,6 +259,7 @@ const manifestUpdate: Manifest = {\n         '!/ignored/file1',\n         '!/ignored/dir/**',\n       ]),\n+  navigationRequestStrategy: 'performance',\n   hashTable: tmpHashTableForFs(distUpdate),\n };\n \n@@ -983,6 +987,7 @@ describe('Driver', () => {\n         },\n       ],\n       navigationUrls: processNavigationUrls(baseHref),\n+      navigationRequestStrategy: 'performance',\n       hashTable: tmpHashTableForFs(distDir, {}, baseHref),\n     });\n \n@@ -1343,6 +1348,7 @@ describe('Driver', () => {\n         }\n       ],\n       navigationUrls: processNavigationUrls('./'),\n+      navigationRequestStrategy: 'performance',\n       hashTable: tmpHashTableForFs(distDir, {}, './'),\n     });\n \n@@ -1754,6 +1760,7 @@ describe('Driver', () => {\n           }],\n           dataGroups: [],\n           navigationUrls: processNavigationUrls(''),\n+          navigationRequestStrategy: 'performance',\n           hashTable: tmpHashTableForFs(fileSystem),\n         };\n \n@@ -1922,6 +1929,52 @@ describe('Driver', () => {\n          });\n     });\n   });\n+\n+  describe('navigationRequestStrategy', () => {\n+    it('doesn\\'t create navigate request in performance mode', async () => {\n+      await makeRequest(scope, '/foo.txt');\n+      await driver.initialized;\n+      await server.clearRequests();\n+\n+      // Create multiple navigation requests to prove no navigation request was made.\n+      // By default the navigation request is not sent, it's replaced\n+      // with the index request - thus, the `this is foo` value.\n+      expect(await makeNavigationRequest(scope, '/', '')).toBe('this is foo');\n+      expect(await makeNavigationRequest(scope, '/foo', '')).toBe('this is foo');\n+      expect(await makeNavigationRequest(scope, '/foo/bar', '')).toBe('this is foo');\n+\n+      server.assertNoOtherRequests();\n+    });\n+\n+    it('sends the request to the server in freshness mode', async () => {\n+      const {server, scope, driver} = createSwForFreshnessStrategy();\n+\n+      await makeRequest(scope, '/foo.txt');\n+      await driver.initialized;\n+      await server.clearRequests();\n+\n+      // Create multiple navigation requests to prove the navigation request is constantly made.\n+      // When enabled, the navigation request is made each time and not replaced\n+      // with the index request - thus, the `null` value.\n+      expect(await makeNavigationRequest(scope, '/', '')).toBe(null);\n+      expect(await makeNavigationRequest(scope, '/foo', '')).toBe(null);\n+      expect(await makeNavigationRequest(scope, '/foo/bar', '')).toBe(null);\n+\n+      server.assertSawRequestFor('/');\n+      server.assertSawRequestFor('/foo');\n+      server.assertSawRequestFor('/foo/bar');\n+      server.assertNoOtherRequests();\n+    });\n+\n+    function createSwForFreshnessStrategy() {\n+      const freshnessManifest: Manifest = {...manifest, navigationRequestStrategy: 'freshness'};\n+      const server = serverBuilderBase.withManifest(freshnessManifest).build();\n+      const scope = new SwTestHarnessBuilder().withServerState(server).build();\n+      const driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+\n+      return {server, scope, driver};\n+    }\n+  });\n });\n })();\n "
        },
        {
            "sha": "62bb1c84e000a586cddf651db09486f8e8ef80de",
            "filename": "packages/service-worker/worker/testing/mock.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Ftesting%2Fmock.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Ftesting%2Fmock.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fmock.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -248,6 +248,7 @@ export function tmpManifestSingleAssetGroup(fs: MockFileSystem): Manifest {\n       },\n     ],\n     navigationUrls: [],\n+    navigationRequestStrategy: 'performance',\n     hashTable,\n   };\n }"
        },
        {
            "sha": "57e77055ee02d80a0409207e1e33b9619d46c6d9",
            "filename": "packages/service-worker/worker/testing/scope.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "raw_url": "https://github.com/angular/angular/raw/a2068523fd284f5160fe7f4ce696fd3cd01f40f5/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts?ref=a2068523fd284f5160fe7f4ce696fd3cd01f40f5",
            "patch": "@@ -346,6 +346,7 @@ export class ConfigBuilder {\n       index: '/index.html',\n       assetGroups,\n       navigationUrls: [],\n+      navigationRequestStrategy: 'performance',\n       hashTable,\n     };\n   }"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 120,
        "deletions": 0
    }
}