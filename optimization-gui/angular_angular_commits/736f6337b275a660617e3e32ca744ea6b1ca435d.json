{
    "author": "alxhub",
    "message": "refactor(compiler-cli): make file/shim split 1:n instead of 1:1 (#38105)\n\nPreviously in the template type-checking engine, it was assumed that every\ninput file would have an associated type-checking shim. The type check block\ncode for all components in the input file would be generated into this shim.\n\nThis is fine for whole-program type checking operations, but to support the\nlanguage service's requirements for low latency, it would be ideal to be\nable to check a single component in isolation, especially if the component\nis declared along with many others in a single file.\n\nThis commit removes the assumption that the file/shim mapping is 1:1, and\nintroduces the concept of component-to-shim mapping. Any\n`TypeCheckingProgramStrategy` must provide such a mapping.\n\nTo achieve this:\n\n * type checking record information is now split into file-level data as\n   well as per-shim data.\n * components are now assigned a stable `TemplateId` which is unique to the\n   file in which they're declared.\n\nPR Close #38105",
    "sha": "736f6337b275a660617e3e32ca744ea6b1ca435d",
    "files": [
        {
            "sha": "14d43c8a9f3cc37249efaf488a5293a96ca1c454",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/api.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fapi.ts?ref=736f6337b275a660617e3e32ca744ea6b1ca435d",
            "patch": "@@ -12,21 +12,21 @@ import {AbsoluteFsPath} from '../file_system';\n /**\n  * Interface of the incremental build engine.\n  *\n- * `W` is a generic type representing a unit of work. This is generic to avoid a cyclic dependency\n- * between the incremental engine API definition and its consumer(s).\n- * `T` is a generic type representing template type-checking data for a particular file, which is\n- * generic for the same reason.\n+ * `AnalysisT` is a generic type representing a unit of work. This is generic to avoid a cyclic\n+ * dependency between the incremental engine API definition and its consumer(s).\n+ * `FileTypeCheckDataT` is a generic type representing template type-checking data for a particular\n+ * input file, which is generic for the same reason.\n  */\n-export interface IncrementalBuild<W, T> {\n+export interface IncrementalBuild<AnalysisT, FileTypeCheckDataT> {\n   /**\n    * Retrieve the prior analysis work, if any, done for the given source file.\n    */\n-  priorWorkFor(sf: ts.SourceFile): W[]|null;\n+  priorWorkFor(sf: ts.SourceFile): AnalysisT[]|null;\n \n   /**\n    * Retrieve the prior type-checking work, if any, that's been done for the given source file.\n    */\n-  priorTypeCheckingResultsFor(sf: ts.SourceFile): T|null;\n+  priorTypeCheckingResultsFor(fileSf: ts.SourceFile): FileTypeCheckDataT|null;\n }\n \n /**"
        },
        {
            "sha": "fc9babdd8783ef25893e1ed290636ce20d101bdb",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/api.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fapi.ts?ref=736f6337b275a660617e3e32ca744ea6b1ca435d",
            "patch": "@@ -13,6 +13,7 @@ import {AbsoluteFsPath} from '../../file_system';\n import {Reference} from '../../imports';\n import {TemplateGuardMeta} from '../../metadata';\n import {ClassDeclaration} from '../../reflection';\n+import {ComponentToShimMappingStrategy} from './context';\n \n \n /**\n@@ -284,7 +285,7 @@ export interface ExternalTemplateSourceMapping {\n  * This abstraction allows both the Angular compiler itself as well as the language service to\n  * implement efficient template type-checking using common infrastructure.\n  */\n-export interface TypeCheckingProgramStrategy {\n+export interface TypeCheckingProgramStrategy extends ComponentToShimMappingStrategy {\n   /**\n    * Retrieve the latest version of the program, containing all the updates made thus far.\n    */"
        },
        {
            "sha": "902f0c413078d8ba76e8cee8bc2e411ec9fe8646",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/augmented_program.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts",
            "raw_url": "https://github.com/angular/angular/raw/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts?ref=736f6337b275a660617e3e32ca744ea6b1ca435d",
            "patch": "@@ -8,11 +8,12 @@\n \n import * as ts from 'typescript';\n \n-import {AbsoluteFsPath} from '../../file_system';\n+import {absoluteFromSourceFile, AbsoluteFsPath} from '../../file_system';\n import {retagAllTsFiles, untagAllTsFiles} from '../../shims';\n \n import {TypeCheckingProgramStrategy, UpdateMode} from './api';\n import {TypeCheckProgramHost} from './host';\n+import {TypeCheckShimGenerator} from './shim';\n \n /**\n  * Implements a template type-checking program using `ts.createProgram` and TypeScript's program\n@@ -78,4 +79,8 @@ export class ReusedProgramStrategy implements TypeCheckingProgramStrategy {\n     untagAllTsFiles(this.program);\n     untagAllTsFiles(oldProgram);\n   }\n+\n+  shimPathForComponent(node: ts.ClassDeclaration): AbsoluteFsPath {\n+    return TypeCheckShimGenerator.shimFor(absoluteFromSourceFile(node.getSourceFile()));\n+  }\n }"
        },
        {
            "sha": "9acdf13b46160552d59b8c4d233f1b13870b7a8f",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 18,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=736f6337b275a660617e3e32ca744ea6b1ca435d",
            "patch": "@@ -16,7 +16,7 @@ import {isShim} from '../../shims';\n \n import {TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from './api';\n import {FileTypeCheckingData, TypeCheckContext, TypeCheckRequest} from './context';\n-import {shouldReportDiagnostic, translateDiagnostic} from './diagnostics';\n+import {shouldReportDiagnostic, TemplateSourceResolver, translateDiagnostic} from './diagnostics';\n \n /**\n  * Interface to trigger generation of type-checking code for a program given a new\n@@ -49,8 +49,8 @@ export class TemplateTypeChecker {\n   refresh(): TypeCheckRequest {\n     this.files.clear();\n \n-    const ctx =\n-        new TypeCheckContext(this.config, this.compilerHost, this.refEmitter, this.reflector);\n+    const ctx = new TypeCheckContext(\n+        this.config, this.compilerHost, this.typeCheckingStrategy, this.refEmitter, this.reflector);\n \n     // Typecheck all the files.\n     for (const sf of this.originalProgram.getSourceFiles()) {\n@@ -86,25 +86,32 @@ export class TemplateTypeChecker {\n     if (!this.files.has(path)) {\n       return [];\n     }\n-    const record = this.files.get(path)!;\n+    const fileRecord = this.files.get(path)!;\n \n     const typeCheckProgram = this.typeCheckingStrategy.getProgram();\n-    const typeCheckSf = getSourceFileOrError(typeCheckProgram, record.typeCheckFile);\n-    const rawDiagnostics = [];\n-    rawDiagnostics.push(...typeCheckProgram.getSemanticDiagnostics(typeCheckSf));\n-    if (record.hasInlines) {\n+\n+    const diagnostics: (ts.Diagnostic|null)[] = [];\n+    if (fileRecord.hasInlines) {\n       const inlineSf = getSourceFileOrError(typeCheckProgram, path);\n-      rawDiagnostics.push(...typeCheckProgram.getSemanticDiagnostics(inlineSf));\n+      diagnostics.push(...typeCheckProgram.getSemanticDiagnostics(inlineSf).map(\n+          diag => convertDiagnostic(diag, fileRecord.sourceResolver)));\n+    }\n+    for (const [shimPath, shimRecord] of fileRecord.shimData) {\n+      const shimSf = getSourceFileOrError(typeCheckProgram, shimPath);\n+\n+      diagnostics.push(...typeCheckProgram.getSemanticDiagnostics(shimSf).map(\n+          diag => convertDiagnostic(diag, fileRecord.sourceResolver)));\n+      diagnostics.push(...shimRecord.genesisDiagnostics);\n     }\n \n-    return rawDiagnostics\n-        .map(diag => {\n-          if (!shouldReportDiagnostic(diag)) {\n-            return null;\n-          }\n-          return translateDiagnostic(diag, record.sourceResolver);\n-        })\n-        .filter((diag: ts.Diagnostic|null): diag is ts.Diagnostic => diag !== null)\n-        .concat(record.genesisDiagnostics);\n+    return diagnostics.filter((diag: ts.Diagnostic|null): diag is ts.Diagnostic => diag !== null);\n+  }\n+}\n+\n+function convertDiagnostic(\n+    diag: ts.Diagnostic, sourceResolver: TemplateSourceResolver): ts.Diagnostic|null {\n+  if (!shouldReportDiagnostic(diag)) {\n+    return null;\n   }\n+  return translateDiagnostic(diag, sourceResolver);\n }"
        },
        {
            "sha": "c2045b253f3a2d4c5d48b6301c9d32a0f00b818f",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/context.ts",
            "status": "modified",
            "additions": 105,
            "deletions": 38,
            "changes": 143,
            "blob_url": "https://github.com/angular/angular/blob/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts?ref=736f6337b275a660617e3e32ca744ea6b1ca435d",
            "patch": "@@ -14,12 +14,11 @@ import {NoopImportRewriter, Reference, ReferenceEmitter} from '../../imports';\n import {ClassDeclaration, ReflectionHost} from '../../reflection';\n import {ImportManager} from '../../translator';\n \n-import {TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckingConfig, TypeCtorMetadata} from './api';\n+import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckingConfig, TypeCtorMetadata} from './api';\n import {TemplateSourceResolver} from './diagnostics';\n import {DomSchemaChecker, RegistryDomSchemaChecker} from './dom';\n import {Environment} from './environment';\n import {OutOfBandDiagnosticRecorder, OutOfBandDiagnosticRecorderImpl} from './oob';\n-import {TypeCheckShimGenerator} from './shim';\n import {TemplateSourceManager} from './source';\n import {generateTypeCheckBlock, requiresInlineTypeCheckBlock} from './type_check_block';\n import {TypeCheckFile} from './type_check_file';\n@@ -46,7 +45,8 @@ export interface TypeCheckRequest {\n }\n \n /**\n- * Data for a type-checking shim which is required to support generation of diagnostics.\n+ * Data for template type-checking related to a specific input file in the user's program (which\n+ * contains components to be checked).\n  */\n export interface FileTypeCheckingData {\n   /**\n@@ -56,25 +56,39 @@ export interface FileTypeCheckingData {\n   hasInlines: boolean;\n \n   /**\n-   * Source mapping information for mapping diagnostics back to the original template.\n+   * Source mapping information for mapping diagnostics from inlined type check blocks back to the\n+   * original template.\n    */\n   sourceResolver: TemplateSourceResolver;\n \n   /**\n-   * Any `ts.Diagnostic`s which were produced during the generation of this shim.\n+   * Data for each shim generated from this input file.\n    *\n-   * Some diagnostics are produced during creation time and are tracked here.\n+   * A single input file will generate one or more shim files that actually contain template\n+   * type-checking code.\n    */\n-  genesisDiagnostics: ts.Diagnostic[];\n+  shimData: Map<AbsoluteFsPath, ShimTypeCheckingData>;\n+}\n \n+/**\n+ * Data specific to a single shim generated from an input file.\n+ */\n+export interface ShimTypeCheckingData {\n   /**\n    * Path to the shim file.\n    */\n-  typeCheckFile: AbsoluteFsPath;\n+  path: AbsoluteFsPath;\n+\n+  /**\n+   * Any `ts.Diagnostic`s which were produced during the generation of this shim.\n+   *\n+   * Some diagnostics are produced during creation time and are tracked here.\n+   */\n+  genesisDiagnostics: ts.Diagnostic[];\n }\n \n /**\n- * Data for a type-checking shim which is still having its code generated.\n+ * Data for an input file which is still in the process of template type-checking code generation.\n  */\n export interface PendingFileTypeCheckingData {\n   /**\n@@ -83,10 +97,18 @@ export interface PendingFileTypeCheckingData {\n   hasInlines: boolean;\n \n   /**\n-   * `TemplateSourceManager` being used to track source mapping information for this shim.\n+   * Source mapping information for mapping diagnostics from inlined type check blocks back to the\n+   * original template.\n    */\n   sourceManager: TemplateSourceManager;\n \n+  /**\n+   * Map of in-progress shim data for shims generated from this input file.\n+   */\n+  shimData: Map<AbsoluteFsPath, PendingShimData>;\n+}\n+\n+export interface PendingShimData {\n   /**\n    * Recorder for out-of-band diagnostics which are raised during generation.\n    */\n@@ -98,9 +120,28 @@ export interface PendingFileTypeCheckingData {\n   domSchemaChecker: DomSchemaChecker;\n \n   /**\n-   * Path to the shim file.\n+   * Shim file in the process of being generated.\n    */\n-  typeCheckFile: TypeCheckFile;\n+  file: TypeCheckFile;\n+}\n+\n+/**\n+ * Abstracts the operation of determining which shim file will host a particular component's\n+ * template type-checking code.\n+ *\n+ * Different consumers of the type checking infrastructure may choose different approaches to\n+ * optimize for their specific use case (for example, the command-line compiler optimizes for\n+ * efficient `ts.Program` reuse in watch mode).\n+ */\n+export interface ComponentToShimMappingStrategy {\n+  /**\n+   * Given a component, determine a path to the shim file into which that component's type checking\n+   * code will be generated.\n+   *\n+   * A major constraint is that components in different input files must not share the same shim\n+   * file. The behavior of the template type-checking system is undefined if this is violated.\n+   */\n+  shimPathForComponent(node: ts.ClassDeclaration): AbsoluteFsPath;\n }\n \n /**\n@@ -115,6 +156,7 @@ export class TypeCheckContext {\n   constructor(\n       private config: TypeCheckingConfig,\n       private compilerHost: Pick<ts.CompilerHost, 'getCanonicalFileName'>,\n+      private componentMappingStrategy: ComponentToShimMappingStrategy,\n       private refEmitter: ReferenceEmitter, private reflector: ReflectionHost) {}\n \n   /**\n@@ -160,8 +202,7 @@ export class TypeCheckContext {\n       schemas: SchemaMetadata[], sourceMapping: TemplateSourceMapping,\n       file: ParseSourceFile): void {\n     const fileData = this.dataForFile(ref.node.getSourceFile());\n-\n-    const id = fileData.sourceManager.captureSource(sourceMapping, file);\n+    const shimData = this.pendingShimForComponent(ref.node);\n     // Get all of the directives used in the template and record type constructors for all of them.\n     for (const dir of boundTarget.getUsedDirectives()) {\n       const dirRef = dir.ref as Reference<ClassDeclaration<ts.ClassDeclaration>>;\n@@ -184,15 +225,19 @@ export class TypeCheckContext {\n       }\n     }\n \n-    const tcbMetadata: TypeCheckBlockMetadata = {id, boundTarget, pipes, schemas};\n+    const meta = {\n+      id: fileData.sourceManager.captureSource(ref.node, sourceMapping, file),\n+      boundTarget,\n+      pipes,\n+      schemas,\n+    };\n     if (requiresInlineTypeCheckBlock(ref.node)) {\n       // This class didn't meet the requirements for external type checking, so generate an inline\n       // TCB for the class.\n-      this.addInlineTypeCheckBlock(fileData, ref, tcbMetadata);\n+      this.addInlineTypeCheckBlock(fileData, shimData, ref, meta);\n     } else {\n       // The class can be type-checked externally as normal.\n-      fileData.typeCheckFile.addTypeCheckBlock(\n-          ref, tcbMetadata, fileData.domSchemaChecker, fileData.oobRecorder);\n+      shimData.file.addTypeCheckBlock(ref, meta, shimData.domSchemaChecker, shimData.oobRecorder);\n     }\n   }\n \n@@ -278,17 +323,27 @@ export class TypeCheckContext {\n       perFileData: new Map<AbsoluteFsPath, FileTypeCheckingData>(),\n     };\n \n-    for (const [sfPath, fileData] of this.fileMap.entries()) {\n-      updates.set(fileData.typeCheckFile.fileName, fileData.typeCheckFile.render());\n-      results.perFileData.set(sfPath, {\n-        genesisDiagnostics: [\n-          ...fileData.domSchemaChecker.diagnostics,\n-          ...fileData.oobRecorder.diagnostics,\n-        ],\n-        hasInlines: fileData.hasInlines,\n-        sourceResolver: fileData.sourceManager,\n-        typeCheckFile: fileData.typeCheckFile.fileName,\n-      });\n+    // Then go through each input file that has pending code generation operations.\n+    for (const [sfPath, pendingFileData] of this.fileMap) {\n+      const fileData: FileTypeCheckingData = {\n+        hasInlines: pendingFileData.hasInlines,\n+        shimData: new Map(),\n+        sourceResolver: pendingFileData.sourceManager,\n+      };\n+\n+      // For each input file, consider generation operations for each of its shims.\n+      for (const [shimPath, pendingShimData] of pendingFileData.shimData) {\n+        updates.set(pendingShimData.file.fileName, pendingShimData.file.render());\n+        fileData.shimData.set(shimPath, {\n+          genesisDiagnostics: [\n+            ...pendingShimData.domSchemaChecker.diagnostics,\n+            ...pendingShimData.oobRecorder.diagnostics,\n+          ],\n+          path: pendingShimData.file.fileName,\n+        });\n+      }\n+\n+      results.perFileData.set(sfPath, fileData);\n     }\n \n     for (const [sfPath, fileData] of this.adoptedFiles.entries()) {\n@@ -299,32 +354,44 @@ export class TypeCheckContext {\n   }\n \n   private addInlineTypeCheckBlock(\n-      fileData: PendingFileTypeCheckingData, ref: Reference<ClassDeclaration<ts.ClassDeclaration>>,\n+      fileData: PendingFileTypeCheckingData, shimData: PendingShimData,\n+      ref: Reference<ClassDeclaration<ts.ClassDeclaration>>,\n       tcbMeta: TypeCheckBlockMetadata): void {\n     const sf = ref.node.getSourceFile();\n     if (!this.opMap.has(sf)) {\n       this.opMap.set(sf, []);\n     }\n     const ops = this.opMap.get(sf)!;\n     ops.push(new TcbOp(\n-        ref, tcbMeta, this.config, this.reflector, fileData.domSchemaChecker,\n-        fileData.oobRecorder));\n+        ref, tcbMeta, this.config, this.reflector, shimData.domSchemaChecker,\n+        shimData.oobRecorder));\n     fileData.hasInlines = true;\n   }\n \n+  private pendingShimForComponent(node: ts.ClassDeclaration): PendingShimData {\n+    const fileData = this.dataForFile(node.getSourceFile());\n+    const shimPath = this.componentMappingStrategy.shimPathForComponent(node);\n+    if (!fileData.shimData.has(shimPath)) {\n+      fileData.shimData.set(shimPath, {\n+        domSchemaChecker: new RegistryDomSchemaChecker(fileData.sourceManager),\n+        oobRecorder: new OutOfBandDiagnosticRecorderImpl(fileData.sourceManager),\n+        file: new TypeCheckFile(\n+            shimPath, this.config, this.refEmitter, this.reflector, this.compilerHost),\n+      });\n+    }\n+    return fileData.shimData.get(shimPath)!;\n+  }\n+\n   private dataForFile(sf: ts.SourceFile): PendingFileTypeCheckingData {\n     const sfPath = absoluteFromSourceFile(sf);\n \n+    const sourceManager = new TemplateSourceManager();\n+\n     if (!this.fileMap.has(sfPath)) {\n-      const sourceManager = new TemplateSourceManager();\n       const data: PendingFileTypeCheckingData = {\n-        domSchemaChecker: new RegistryDomSchemaChecker(sourceManager),\n-        oobRecorder: new OutOfBandDiagnosticRecorderImpl(sourceManager),\n-        typeCheckFile: new TypeCheckFile(\n-            TypeCheckShimGenerator.shimFor(sfPath), this.config, this.refEmitter, this.reflector,\n-            this.compilerHost),\n         hasInlines: false,\n         sourceManager,\n+        shimData: new Map(),\n       };\n       this.fileMap.set(sfPath, data);\n     }"
        },
        {
            "sha": "da5c08c47273df10e994a150b362b6ae186964c3",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/source.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 3,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fsource.ts",
            "raw_url": "https://github.com/angular/angular/raw/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fsource.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fsource.ts?ref=736f6337b275a660617e3e32ca744ea6b1ca435d",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import {AbsoluteSourceSpan, ParseLocation, ParseSourceFile, ParseSourceSpan} from '@angular/compiler';\n+import * as ts from 'typescript';\n \n import {TemplateId, TemplateSourceMapping} from './api';\n import {TemplateSourceResolver} from './diagnostics';\n@@ -47,16 +48,16 @@ export class TemplateSource {\n  * Implements `TemplateSourceResolver` to resolve the source of a template based on these IDs.\n  */\n export class TemplateSourceManager implements TemplateSourceResolver {\n-  private nextTemplateId: number = 1;\n   /**\n    * This map keeps track of all template sources that have been type-checked by the id that is\n    * attached to a TCB's function declaration as leading trivia. This enables translation of\n    * diagnostics produced for TCB code to their source location in the template.\n    */\n   private templateSources = new Map<TemplateId, TemplateSource>();\n \n-  captureSource(mapping: TemplateSourceMapping, file: ParseSourceFile): TemplateId {\n-    const id = `tcb${this.nextTemplateId++}` as TemplateId;\n+  captureSource(node: ts.ClassDeclaration, mapping: TemplateSourceMapping, file: ParseSourceFile):\n+      TemplateId {\n+    const id = getTemplateId(node);\n     this.templateSources.set(id, new TemplateSource(mapping, file));\n     return id;\n   }\n@@ -76,3 +77,28 @@ export class TemplateSourceManager implements TemplateSourceResolver {\n     return templateSource.toParseSourceSpan(span.start, span.end);\n   }\n }\n+\n+const TEMPLATE_ID = Symbol('ngTemplateId');\n+const NEXT_TEMPLATE_ID = Symbol('ngNextTemplateId');\n+\n+interface HasTemplateId {\n+  [TEMPLATE_ID]: TemplateId;\n+}\n+\n+interface HasNextTemplateId {\n+  [NEXT_TEMPLATE_ID]: number;\n+}\n+\n+function getTemplateId(node: ts.ClassDeclaration&Partial<HasTemplateId>): TemplateId {\n+  if (node[TEMPLATE_ID] === undefined) {\n+    node[TEMPLATE_ID] = allocateTemplateId(node.getSourceFile());\n+  }\n+  return node[TEMPLATE_ID]!;\n+}\n+\n+function allocateTemplateId(sf: ts.SourceFile&Partial<HasNextTemplateId>): TemplateId {\n+  if (sf[NEXT_TEMPLATE_ID] === undefined) {\n+    sf[NEXT_TEMPLATE_ID] = 1;\n+  }\n+  return (`tcb${sf[NEXT_TEMPLATE_ID]!++}`) as TemplateId;\n+}"
        },
        {
            "sha": "a846503320c4115fa92a418740d17b7e373ec6e4",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_constructor_spec.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 18,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts?ref=736f6337b275a660617e3e32ca744ea6b1ca435d",
            "patch": "@@ -7,16 +7,15 @@\n  */\n import * as ts from 'typescript';\n \n-import {absoluteFrom, getFileSystem, getSourceFileOrError, LogicalFileSystem, NgtscCompilerHost} from '../../file_system';\n+import {absoluteFrom, AbsoluteFsPath, getFileSystem, getSourceFileOrError, LogicalFileSystem, NgtscCompilerHost} from '../../file_system';\n import {runInEachFileSystem, TestFile} from '../../file_system/testing';\n import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, Reference, ReferenceEmitter} from '../../imports';\n import {isNamedClassDeclaration, ReflectionHost, TypeScriptReflectionHost} from '../../reflection';\n import {getDeclaration, makeProgram} from '../../testing';\n import {getRootDirs} from '../../util/src/typescript';\n import {UpdateMode} from '../src/api';\n import {ReusedProgramStrategy} from '../src/augmented_program';\n-import {PendingFileTypeCheckingData, TypeCheckContext} from '../src/context';\n-import {RegistryDomSchemaChecker} from '../src/dom';\n+import {ComponentToShimMappingStrategy, PendingFileTypeCheckingData, TypeCheckContext} from '../src/context';\n import {TemplateSourceManager} from '../src/source';\n import {TypeCheckFile} from '../src/type_check_file';\n \n@@ -73,10 +72,11 @@ TestClass.ngTypeCtor({value: 'test'});\n           new AbsoluteModuleStrategy(program, checker, moduleResolver, reflectionHost),\n           new LogicalProjectStrategy(reflectionHost, logicalFs),\n         ]);\n-        const ctx = new TypeCheckContext(ALL_ENABLED_CONFIG, host, emitter, reflectionHost);\n+        const ctx = new TypeCheckContext(\n+            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost);\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n-        const pendingFile = makePendingFile(reflectionHost, host);\n+        const pendingFile = makePendingFile();\n         ctx.addInlineTypeCtor(\n             pendingFile, getSourceFileOrError(program, _('/main.ts')), new Reference(TestClass), {\n               fnName: 'ngTypeCtor',\n@@ -109,8 +109,9 @@ TestClass.ngTypeCtor({value: 'test'});\n           new AbsoluteModuleStrategy(program, checker, moduleResolver, reflectionHost),\n           new LogicalProjectStrategy(reflectionHost, logicalFs),\n         ]);\n-        const pendingFile = makePendingFile(reflectionHost, host);\n-        const ctx = new TypeCheckContext(ALL_ENABLED_CONFIG, host, emitter, reflectionHost);\n+        const pendingFile = makePendingFile();\n+        const ctx = new TypeCheckContext(\n+            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost);\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         ctx.addInlineTypeCtor(\n@@ -152,8 +153,9 @@ TestClass.ngTypeCtor({value: 'test'});\n           new AbsoluteModuleStrategy(program, checker, moduleResolver, reflectionHost),\n           new LogicalProjectStrategy(reflectionHost, logicalFs),\n         ]);\n-        const pendingFile = makePendingFile(reflectionHost, host);\n-        const ctx = new TypeCheckContext(ALL_ENABLED_CONFIG, host, emitter, reflectionHost);\n+        const pendingFile = makePendingFile();\n+        const ctx = new TypeCheckContext(\n+            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost);\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         ctx.addInlineTypeCtor(\n@@ -184,16 +186,16 @@ TestClass.ngTypeCtor({value: 'test'});\n   }\n });\n \n-function makePendingFile(\n-    reflector: ReflectionHost, compilerHost: ts.CompilerHost): PendingFileTypeCheckingData {\n-  const manager = new TemplateSourceManager();\n+function makePendingFile(): PendingFileTypeCheckingData {\n   return {\n-    domSchemaChecker: new RegistryDomSchemaChecker(manager),\n     hasInlines: false,\n-    oobRecorder: new NoopOobRecorder(),\n-    sourceManager: manager,\n-    typeCheckFile: new TypeCheckFile(\n-        absoluteFrom('/typecheck.ts'), ALL_ENABLED_CONFIG, new ReferenceEmitter([]), reflector,\n-        compilerHost)\n+    sourceManager: new TemplateSourceManager(),\n+    shimData: new Map(),\n   };\n }\n+\n+class TestMappingStrategy implements ComponentToShimMappingStrategy {\n+  shimPathForComponent(): AbsoluteFsPath {\n+    return absoluteFrom('/typecheck.ts');\n+  }\n+}"
        },
        {
            "sha": "8a50aba578a7368b2e9670327de1113a739e3361",
            "filename": "packages/language-service/ivy/compiler/compiler.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/736f6337b275a660617e3e32ca744ea6b1ca435d/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts?ref=736f6337b275a660617e3e32ca744ea6b1ca435d",
            "patch": "@@ -9,9 +9,9 @@\n \n import {CompilerOptions} from '@angular/compiler-cli';\n import {NgCompiler, NgCompilerHost} from '@angular/compiler-cli/src/ngtsc/core';\n-import {AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {PatchedProgramIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/incremental';\n-import {TypeCheckingProgramStrategy, UpdateMode} from '@angular/compiler-cli/src/ngtsc/typecheck';\n+import {TypeCheckingProgramStrategy, TypeCheckShimGenerator, UpdateMode} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {makeCompilerHostFromProject} from './compiler_host';\n@@ -75,6 +75,9 @@ export class Compiler {\n function createTypeCheckingProgramStrategy(project: ts.server.Project):\n     TypeCheckingProgramStrategy {\n   return {\n+    shimPathForComponent(component: ts.ClassDeclaration): AbsoluteFsPath {\n+      return TypeCheckShimGenerator.shimFor(absoluteFromSourceFile(component.getSourceFile()));\n+    },\n     getProgram(): ts.Program {\n       const program = project.getLanguageService().getProgram();\n       if (!program) {"
        }
    ],
    "stats": {
        "total": 287,
        "additions": 199,
        "deletions": 88
    }
}