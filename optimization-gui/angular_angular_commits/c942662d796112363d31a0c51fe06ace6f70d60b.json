{
    "author": "kyliau",
    "message": "fix(language-service): reinstate getExternalFiles() (#37750)\n\n`getExternalFiles()` is an API that could optionally be provided by a tsserver plugin\nto notify the server of any additional files that should belong to a particular project.\n\nThis API was removed in https://github.com/angular/angular/pull/34260 mainly\ndue to performance reasons.\n\nHowever, with the introduction of \"solution-style\" tsconfig in typescript 3.9,\nthe Angular extension could no longer reliably detect the owning Project solely\nbased on the ancestor tsconfig.json. In order to support this use case, we have\nto reinstate `getExternalFiles()`.\n\nFixes https://github.com/angular/vscode-ng-language-service/issues/824\n\nPR Close #37750",
    "sha": "c942662d796112363d31a0c51fe06ace6f70d60b",
    "files": [
        {
            "sha": "05ad3c79c1936322cae91dc18fd9c38e4d5f2a51",
            "filename": "packages/language-service/src/ts_plugin.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/c942662d796112363d31a0c51fe06ace6f70d60b/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/c942662d796112363d31a0c51fe06ace6f70d60b/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts?ref=c942662d796112363d31a0c51fe06ace6f70d60b",
            "patch": "@@ -11,8 +11,30 @@ import * as tss from 'typescript/lib/tsserverlibrary';\n import {createLanguageService} from './language_service';\n import {TypeScriptServiceHost} from './typescript_host';\n \n+// Use a WeakMap to keep track of Project to Host mapping so that when Project\n+// is deleted Host could be garbage collected.\n+const PROJECT_MAP = new WeakMap<tss.server.Project, TypeScriptServiceHost>();\n+\n+/**\n+ * This function is called by tsserver to retrieve the external (non-TS) files\n+ * that should belong to the specified `project`. For Angular, these files are\n+ * external templates. This is called once when the project is loaded, then\n+ * every time when the program is updated.\n+ * @param project Project for which external files should be retrieved.\n+ */\n+export function getExternalFiles(project: tss.server.Project): string[] {\n+  if (!project.hasRoots()) {\n+    // During project initialization where there is no root files yet we should\n+    // not do any work.\n+    return [];\n+  }\n+  const ngLsHost = PROJECT_MAP.get(project);\n+  ngLsHost?.getAnalyzedModules();\n+  return ngLsHost?.getExternalTemplates() || [];\n+}\n+\n export function create(info: tss.server.PluginCreateInfo): tss.LanguageService {\n-  const {languageService: tsLS, languageServiceHost: tsLSHost, config} = info;\n+  const {languageService: tsLS, languageServiceHost: tsLSHost, config, project} = info;\n   // This plugin could operate under two different modes:\n   // 1. TS + Angular\n   //    Plugin augments TS language service to provide additional Angular\n@@ -25,6 +47,7 @@ export function create(info: tss.server.PluginCreateInfo): tss.LanguageService {\n   const angularOnly = config ? config.angularOnly === true : false;\n   const ngLSHost = new TypeScriptServiceHost(tsLSHost, tsLS);\n   const ngLS = createLanguageService(ngLSHost);\n+  PROJECT_MAP.set(project, ngLSHost);\n \n   function getCompletionsAtPosition(\n       fileName: string, position: number, options: tss.GetCompletionsAtPositionOptions|undefined) {"
        },
        {
            "sha": "ae927fd77d66e9b7344a0b227943acd040904090",
            "filename": "packages/language-service/src/typescript_host.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/c942662d796112363d31a0c51fe06ace6f70d60b/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/c942662d796112363d31a0c51fe06ace6f70d60b/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts?ref=c942662d796112363d31a0c51fe06ace6f70d60b",
            "patch": "@@ -151,6 +151,13 @@ export class TypeScriptServiceHost implements LanguageServiceHost {\n     return this.resolver.getReflector() as StaticReflector;\n   }\n \n+  /**\n+   * Return all known external templates.\n+   */\n+  getExternalTemplates(): string[] {\n+    return [...this.fileToComponent.keys()];\n+  }\n+\n   /**\n    * Checks whether the program has changed and returns all analyzed modules.\n    * If program has changed, invalidate all caches and update fileToComponent"
        },
        {
            "sha": "dc82a9cf5852373f50a11f7eb2802725caa0bbbe",
            "filename": "packages/language-service/test/ts_plugin_spec.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/c942662d796112363d31a0c51fe06ace6f70d60b/packages%2Flanguage-service%2Ftest%2Fts_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c942662d796112363d31a0c51fe06ace6f70d60b/packages%2Flanguage-service%2Ftest%2Fts_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Fts_plugin_spec.ts?ref=c942662d796112363d31a0c51fe06ace6f70d60b",
            "patch": "@@ -8,7 +8,7 @@\n \n import * as ts from 'typescript';\n \n-import {create} from '../src/ts_plugin';\n+import {create, getExternalFiles} from '../src/ts_plugin';\n import {CompletionKind} from '../src/types';\n \n import {MockTypescriptHost} from './test_utils';\n@@ -129,6 +129,13 @@ describe('plugin', () => {\n       },\n     ]);\n   });\n+\n+  it('should return external templates when getExternalFiles() is called', () => {\n+    const externalTemplates = getExternalFiles(mockProject);\n+    expect(externalTemplates).toEqual([\n+      '/app/test.ng',\n+    ]);\n+  });\n });\n \n describe(`with config 'angularOnly = true`, () => {"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 39,
        "deletions": 2
    }
}