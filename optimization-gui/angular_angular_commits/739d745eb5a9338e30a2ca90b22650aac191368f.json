{
    "author": "mhevery",
    "message": "refactor(core): Cleanup circular dependency between ViewEngine and Ivy `ViewContainerRef`. (#39621)\n\n`ViewContainerRef` is declared in ViewEngine but it sub-classed in Ivy. This creates a circular\ndependency between ViewEngine `ViewContainerRef` which needs to declare `__NG_ELEMENT_ID__` and\nivy factory which needs to create it. The workaround used to be to pass the `ViewContainerRef`\nthrough stack but that created a very convoluted code. This refactoring simply bundles the\ntwo files together and removes the stack workaround making the code simpler to follow.\n\nPR Close #39621",
    "sha": "739d745eb5a9338e30a2ca90b22650aac191368f",
    "files": [
        {
            "sha": "0046c2aa6d5a0af1dc32b77d3cb9871c2440a834",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 76,
            "deletions": 87,
            "changes": 163,
            "blob_url": "https://github.com/angular/angular/blob/739d745eb5a9338e30a2ca90b22650aac191368f/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/739d745eb5a9338e30a2ca90b22650aac191368f/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=739d745eb5a9338e30a2ca90b22650aac191368f",
            "patch": "@@ -147,19 +147,6 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/di/injector.ts\",\n-    \"packages/core/src/di/r3_injector.ts\",\n-    \"packages/core/src/render3/definition.ts\",\n-    \"packages/core/src/metadata/ng_module.ts\"\n-  ],\n-  [\n-    \"packages/core/src/application_ref.ts\",\n-    \"packages/core/src/application_tokens.ts\",\n-    \"packages/core/src/linker/component_factory.ts\",\n-    \"packages/core/src/change_detection/change_detection.ts\",\n-    \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/element_ref.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/di/injector.ts\",\n@@ -174,7 +161,6 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/element_ref.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/metadata.ts\",\n@@ -196,7 +182,6 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/element_ref.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n@@ -209,7 +194,6 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/element_ref.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/render3/interfaces/definition.ts\",\n@@ -233,7 +217,6 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/element_ref.ts\",\n     \"packages/core/src/render3/state.ts\",\n     \"packages/core/src/render3/assert.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -246,7 +229,17 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/ng_module_factory.ts\",\n+    \"packages/core/src/render3/view_ref.ts\"\n+  ],\n+  [\n+    \"packages/core/src/application_ref.ts\",\n+    \"packages/core/src/application_tokens.ts\",\n+    \"packages/core/src/linker/component_factory.ts\",\n+    \"packages/core/src/change_detection/change_detection.ts\",\n+    \"packages/core/src/change_detection/change_detector_ref.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -259,8 +252,10 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/ng_module_factory.ts\",\n-    \"packages/core/src/linker/component_factory_resolver.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/render3/di.ts\",\n+    \"packages/core/src/di/injector_compatibility.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -273,14 +268,9 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n-    \"packages/core/src/render3/instructions/shared.ts\",\n-    \"packages/core/src/di.ts\",\n-    \"packages/core/src/di/index.ts\",\n-    \"packages/core/src/di/injectable.ts\",\n-    \"packages/core/src/di/jit/injectable.ts\",\n-    \"packages/core/src/di/jit/environment.ts\",\n-    \"packages/core/src/di/injector_compatibility.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/render3/di.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -293,11 +283,22 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/render3/di.ts\",\n+    \"packages/core/src/render3/definition.ts\",\n+    \"packages/core/src/metadata/ng_module.ts\"\n+  ],\n+  [\n+    \"packages/core/src/application_ref.ts\",\n+    \"packages/core/src/application_tokens.ts\",\n+    \"packages/core/src/linker/component_factory.ts\",\n+    \"packages/core/src/change_detection/change_detection.ts\",\n+    \"packages/core/src/change_detection/change_detector_ref.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n-    \"packages/core/src/error_handler.ts\",\n-    \"packages/core/src/errors.ts\",\n-    \"packages/core/src/view/types.ts\",\n     \"packages/core/src/di.ts\",\n     \"packages/core/src/di/index.ts\",\n     \"packages/core/src/di/injectable.ts\",\n@@ -316,12 +317,18 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n     \"packages/core/src/error_handler.ts\",\n     \"packages/core/src/errors.ts\",\n     \"packages/core/src/view/types.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/di.ts\",\n+    \"packages/core/src/di/index.ts\",\n+    \"packages/core/src/di/injectable.ts\",\n+    \"packages/core/src/di/jit/injectable.ts\",\n+    \"packages/core/src/di/jit/environment.ts\",\n+    \"packages/core/src/di/injector_compatibility.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -334,22 +341,13 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n-    \"packages/core/src/render3/instructions/shared.ts\",\n-    \"packages/core/src/render3/definition.ts\",\n-    \"packages/core/src/metadata/ng_module.ts\"\n-  ],\n-  [\n-    \"packages/core/src/application_ref.ts\",\n-    \"packages/core/src/application_tokens.ts\",\n-    \"packages/core/src/linker/component_factory.ts\",\n-    \"packages/core/src/change_detection/change_detection.ts\",\n-    \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n-    \"packages/core/src/render3/di.ts\",\n-    \"packages/core/src/di/injector_compatibility.ts\",\n+    \"packages/core/src/error_handler.ts\",\n+    \"packages/core/src/errors.ts\",\n+    \"packages/core/src/view/types.ts\",\n+    \"packages/core/src/linker/ng_module_factory.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -362,9 +360,14 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n-    \"packages/core/src/render3/di.ts\",\n+    \"packages/core/src/error_handler.ts\",\n+    \"packages/core/src/errors.ts\",\n+    \"packages/core/src/view/types.ts\",\n+    \"packages/core/src/linker/ng_module_factory.ts\",\n+    \"packages/core/src/linker/component_factory_resolver.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n     \"packages/core/src/render3/definition.ts\",\n@@ -377,9 +380,9 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n-    \"packages/core/src/render3/di.ts\",\n     \"packages/core/src/render3/definition.ts\",\n     \"packages/core/src/metadata/ng_module.ts\"\n   ],\n@@ -390,7 +393,8 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n     \"packages/core/src/render3/instructions/lview_debug.ts\",\n     \"packages/core/src/core.ts\",\n@@ -406,16 +410,6 @@\n     \"packages/core/src/render3/definition.ts\",\n     \"packages/core/src/metadata/ng_module.ts\"\n   ],\n-  [\n-    \"packages/core/src/application_ref.ts\",\n-    \"packages/core/src/application_tokens.ts\",\n-    \"packages/core/src/linker/component_factory.ts\",\n-    \"packages/core/src/change_detection/change_detection.ts\",\n-    \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n-    \"packages/core/src/render3/view_ref.ts\"\n-  ],\n   [\n     \"packages/core/src/application_ref.ts\",\n     \"packages/core/src/application_tokens.ts\",\n@@ -851,21 +845,16 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/linker/component_factory.ts\"\n   ],\n   [\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/ng_module_factory.ts\",\n-    \"packages/core/src/linker/component_factory_resolver.ts\",\n-    \"packages/core/src/linker/component_factory.ts\"\n-  ],\n-  [\n-    \"packages/core/src/change_detection/change_detection.ts\",\n-    \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n     \"packages/core/src/error_handler.ts\",\n     \"packages/core/src/errors.ts\",\n@@ -876,12 +865,14 @@\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n     \"packages/core/src/error_handler.ts\",\n     \"packages/core/src/errors.ts\",\n     \"packages/core/src/view/types.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/linker/ng_module_factory.ts\",\n+    \"packages/core/src/linker/component_factory_resolver.ts\",\n     \"packages/core/src/linker/component_factory.ts\"\n   ],\n   [\n@@ -891,7 +882,6 @@\n   [\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/element_ref.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n@@ -900,7 +890,6 @@\n   [\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n     \"packages/core/src/render3/view_ref.ts\"\n   ],\n   [\n@@ -962,34 +951,30 @@\n     \"packages/core/src/error_handler.ts\",\n     \"packages/core/src/errors.ts\",\n     \"packages/core/src/view/types.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/linker/template_ref.ts\",\n+    \"packages/core/src/render3/view_ref.ts\",\n+    \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\"\n   ],\n   [\n     \"packages/core/src/error_handler.ts\",\n     \"packages/core/src/errors.ts\",\n     \"packages/core/src/view/types.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\"\n   ],\n   [\n     \"packages/core/src/linker/component_factory_resolver.ts\",\n     \"packages/core/src/linker/ng_module_factory.ts\"\n   ],\n-  [\n-    \"packages/core/src/linker/element_ref.ts\",\n-    \"packages/core/src/render3/interfaces/node.ts\",\n-    \"packages/core/src/render3/interfaces/renderer.ts\",\n-    \"packages/core/src/render/api.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\"\n-  ],\n   [\n     \"packages/core/src/linker/ng_module_factory_registration.ts\",\n     \"packages/core/src/render3/ng_module_ref.ts\"\n   ],\n+  [\n+    \"packages/core/src/linker/view_container_ref.ts\",\n+    \"packages/core/src/render3/view_ref.ts\"\n+  ],\n   [\n     \"packages/core/src/metadata/directives.ts\",\n     \"packages/core/src/render3/jit/directive.ts\"\n@@ -1008,6 +993,10 @@\n     \"packages/core/src/metadata/directives.ts\",\n     \"packages/core/src/render3/jit/pipe.ts\"\n   ],\n+  [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\"\n+  ],\n   [\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\","
        },
        {
            "sha": "bec0e00e8ddd9a0986cd14ab279bf51b10e94d4f",
            "filename": "packages/core/src/linker/view_container_ref.ts",
            "status": "modified",
            "additions": 274,
            "deletions": 9,
            "changes": 283,
            "blob_url": "https://github.com/angular/angular/blob/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts?ref=739d745eb5a9338e30a2ca90b22650aac191368f",
            "patch": "@@ -7,16 +7,36 @@\n  */\n \n import {Injector} from '../di/injector';\n-import {injectViewContainerRef as render3InjectViewContainerRef} from '../render3/view_engine_compatibility';\n+import {assertNodeInjector} from '../render3/assert';\n+import {getParentInjectorLocation, NodeInjector} from '../render3/di';\n+import {addToViewTree, createLContainer, createTNode} from '../render3/instructions/shared';\n+import {CONTAINER_HEADER_OFFSET, LContainer, NATIVE, VIEW_REFS} from '../render3/interfaces/container';\n+import {NodeInjectorOffset} from '../render3/interfaces/injector';\n+import {TContainerNode, TDirectiveHostNode, TElementContainerNode, TElementNode, TNodeType} from '../render3/interfaces/node';\n+import {RComment, RElement} from '../render3/interfaces/renderer';\n+import {isLContainer, isRootView} from '../render3/interfaces/type_checks';\n+import {LView, PARENT, RENDERER, T_HOST, TVIEW} from '../render3/interfaces/view';\n+import {assertTNodeType} from '../render3/node_assert';\n+import {addViewToContainer, appendChild, destroyLView, detachView, getBeforeNodeForView, insertView, nativeInsertBefore, nativeNextSibling, nativeParentNode} from '../render3/node_manipulation';\n+import {getCurrentTNode, getLView} from '../render3/state';\n+import {getParentInjectorIndex, getParentInjectorView, hasParentInjector} from '../render3/util/injector_utils';\n+import {getNativeByTNode, unwrapRNode, viewAttachedToContainer} from '../render3/util/view_utils';\n+import {ViewRef as R3ViewRef} from '../render3/view_ref';\n+import {addToArray, removeFromArray} from '../util/array_utils';\n+import {assertEqual, assertGreaterThan, assertLessThan} from '../util/assert';\n import {noop} from '../util/noop';\n-\n import {ComponentFactory, ComponentRef} from './component_factory';\n-import {ElementRef} from './element_ref';\n+import {createElementRef, ElementRef} from './element_ref';\n import {NgModuleRef} from './ng_module_factory';\n import {TemplateRef} from './template_ref';\n import {EmbeddedViewRef, ViewRef} from './view_ref';\n \n \n+export const SWITCH_VIEW_CONTAINER_REF_FACTORY__POST_R3__ = injectViewContainerRef;\n+const SWITCH_VIEW_CONTAINER_REF_FACTORY__PRE_R3__ = noop as typeof injectViewContainerRef;\n+const SWITCH_VIEW_CONTAINER_REF_FACTORY: typeof injectViewContainerRef =\n+    SWITCH_VIEW_CONTAINER_REF_FACTORY__PRE_R3__;\n+\n /**\n  * Represents a container where one or more views can be attached to a component.\n  *\n@@ -148,11 +168,256 @@ export abstract class ViewContainerRef {\n    * @internal\n    * @nocollapse\n    */\n-  static __NG_ELEMENT_ID__:\n-      () => ViewContainerRef = () => SWITCH_VIEW_CONTAINER_REF_FACTORY(ViewContainerRef)\n+  static __NG_ELEMENT_ID__: () => ViewContainerRef = SWITCH_VIEW_CONTAINER_REF_FACTORY;\n }\n \n-export const SWITCH_VIEW_CONTAINER_REF_FACTORY__POST_R3__ = render3InjectViewContainerRef;\n-const SWITCH_VIEW_CONTAINER_REF_FACTORY__PRE_R3__ = noop;\n-const SWITCH_VIEW_CONTAINER_REF_FACTORY: typeof render3InjectViewContainerRef =\n-    SWITCH_VIEW_CONTAINER_REF_FACTORY__PRE_R3__;\n+/**\n+ * Creates a ViewContainerRef and stores it on the injector. Or, if the ViewContainerRef\n+ * already exists, retrieves the existing ViewContainerRef.\n+ *\n+ * @returns The ViewContainerRef instance to use\n+ */\n+export function injectViewContainerRef(): ViewContainerRef {\n+  const previousTNode = getCurrentTNode() as TElementNode | TElementContainerNode | TContainerNode;\n+  return createContainerRef(previousTNode, getLView());\n+}\n+\n+const VE_ViewContainerRef = ViewContainerRef;\n+\n+const R3ViewContainerRef = class ViewContainerRef extends VE_ViewContainerRef {\n+  constructor(\n+      private _lContainer: LContainer,\n+      private _hostTNode: TElementNode|TContainerNode|TElementContainerNode,\n+      private _hostLView: LView) {\n+    super();\n+  }\n+\n+  get element(): ElementRef {\n+    return createElementRef(this._hostTNode, this._hostLView);\n+  }\n+\n+  get injector(): Injector {\n+    return new NodeInjector(this._hostTNode, this._hostLView);\n+  }\n+\n+  /** @deprecated No replacement */\n+  get parentInjector(): Injector {\n+    const parentLocation = getParentInjectorLocation(this._hostTNode, this._hostLView);\n+    if (hasParentInjector(parentLocation)) {\n+      const parentView = getParentInjectorView(parentLocation, this._hostLView);\n+      const injectorIndex = getParentInjectorIndex(parentLocation);\n+      ngDevMode && assertNodeInjector(parentView, injectorIndex);\n+      const parentTNode =\n+          parentView[TVIEW].data[injectorIndex + NodeInjectorOffset.TNODE] as TElementNode;\n+      return new NodeInjector(parentTNode, parentView);\n+    } else {\n+      return new NodeInjector(null, this._hostLView);\n+    }\n+  }\n+\n+  clear(): void {\n+    while (this.length > 0) {\n+      this.remove(this.length - 1);\n+    }\n+  }\n+\n+  get(index: number): ViewRef|null {\n+    return this._lContainer[VIEW_REFS] !== null && this._lContainer[VIEW_REFS]![index] || null;\n+  }\n+\n+  get length(): number {\n+    return this._lContainer.length - CONTAINER_HEADER_OFFSET;\n+  }\n+\n+  createEmbeddedView<C>(templateRef: TemplateRef<C>, context?: C, index?: number):\n+      EmbeddedViewRef<C> {\n+    const viewRef = templateRef.createEmbeddedView(context || <any>{});\n+    this.insert(viewRef, index);\n+    return viewRef;\n+  }\n+\n+  createComponent<C>(\n+      componentFactory: ComponentFactory<C>, index?: number|undefined,\n+      injector?: Injector|undefined, projectableNodes?: any[][]|undefined,\n+      ngModuleRef?: NgModuleRef<any>|undefined): ComponentRef<C> {\n+    const contextInjector = injector || this.parentInjector;\n+    if (!ngModuleRef && (componentFactory as any).ngModule == null && contextInjector) {\n+      // DO NOT REFACTOR. The code here used to have a `value || undefined` expression\n+      // which seems to cause internal google apps to fail. This is documented in the\n+      // following internal bug issue: go/b/142967802\n+      const result = contextInjector.get(NgModuleRef, null);\n+      if (result) {\n+        ngModuleRef = result;\n+      }\n+    }\n+\n+    const componentRef =\n+        componentFactory.create(contextInjector, projectableNodes, undefined, ngModuleRef);\n+    this.insert(componentRef.hostView, index);\n+    return componentRef;\n+  }\n+\n+  insert(viewRef: ViewRef, index?: number): ViewRef {\n+    const lView = (viewRef as R3ViewRef<any>)._lView!;\n+    const tView = lView[TVIEW];\n+\n+    if (ngDevMode && viewRef.destroyed) {\n+      throw new Error('Cannot insert a destroyed View in a ViewContainer!');\n+    }\n+\n+    this.allocateContainerIfNeeded();\n+\n+    if (viewAttachedToContainer(lView)) {\n+      // If view is already attached, detach it first so we clean up references appropriately.\n+\n+      const prevIdx = this.indexOf(viewRef);\n+\n+      // A view might be attached either to this or a different container. The `prevIdx` for\n+      // those cases will be:\n+      // equal to -1 for views attached to this ViewContainerRef\n+      // >= 0 for views attached to a different ViewContainerRef\n+      if (prevIdx !== -1) {\n+        this.detach(prevIdx);\n+      } else {\n+        const prevLContainer = lView[PARENT] as LContainer;\n+        ngDevMode &&\n+            assertEqual(\n+                isLContainer(prevLContainer), true,\n+                'An attached view should have its PARENT point to a container.');\n+\n+\n+        // We need to re-create a R3ViewContainerRef instance since those are not stored on\n+        // LView (nor anywhere else).\n+        const prevVCRef = new R3ViewContainerRef(\n+            prevLContainer, prevLContainer[T_HOST] as TDirectiveHostNode, prevLContainer[PARENT]);\n+\n+        prevVCRef.detach(prevVCRef.indexOf(viewRef));\n+      }\n+    }\n+\n+    // Logical operation of adding `LView` to `LContainer`\n+    const adjustedIdx = this._adjustIndex(index);\n+    const lContainer = this._lContainer;\n+    insertView(tView, lView, lContainer, adjustedIdx);\n+\n+    // Physical operation of adding the DOM nodes.\n+    const beforeNode = getBeforeNodeForView(adjustedIdx, lContainer);\n+    const renderer = lView[RENDERER];\n+    const parentRNode = nativeParentNode(renderer, lContainer[NATIVE] as RElement | RComment);\n+    if (parentRNode !== null) {\n+      addViewToContainer(tView, lContainer[T_HOST], renderer, lView, parentRNode, beforeNode);\n+    }\n+\n+    (viewRef as R3ViewRef<any>).attachToViewContainerRef(this);\n+    addToArray(lContainer[VIEW_REFS]!, adjustedIdx, viewRef);\n+\n+    return viewRef;\n+  }\n+\n+  move(viewRef: ViewRef, newIndex: number): ViewRef {\n+    if (ngDevMode && viewRef.destroyed) {\n+      throw new Error('Cannot move a destroyed View in a ViewContainer!');\n+    }\n+    return this.insert(viewRef, newIndex);\n+  }\n+\n+  indexOf(viewRef: ViewRef): number {\n+    const viewRefsArr = this._lContainer[VIEW_REFS];\n+    return viewRefsArr !== null ? viewRefsArr.indexOf(viewRef) : -1;\n+  }\n+\n+  remove(index?: number): void {\n+    this.allocateContainerIfNeeded();\n+    const adjustedIdx = this._adjustIndex(index, -1);\n+    const detachedView = detachView(this._lContainer, adjustedIdx);\n+\n+    if (detachedView) {\n+      // Before destroying the view, remove it from the container's array of `ViewRef`s.\n+      // This ensures the view container length is updated before calling\n+      // `destroyLView`, which could recursively call view container methods that\n+      // rely on an accurate container length.\n+      // (e.g. a method on this view container being called by a child directive's OnDestroy\n+      // lifecycle hook)\n+      removeFromArray(this._lContainer[VIEW_REFS]!, adjustedIdx);\n+      destroyLView(detachedView[TVIEW], detachedView);\n+    }\n+  }\n+\n+  detach(index?: number): ViewRef|null {\n+    this.allocateContainerIfNeeded();\n+    const adjustedIdx = this._adjustIndex(index, -1);\n+    const view = detachView(this._lContainer, adjustedIdx);\n+\n+    const wasDetached = view && removeFromArray(this._lContainer[VIEW_REFS]!, adjustedIdx) != null;\n+    return wasDetached ? new R3ViewRef(view!) : null;\n+  }\n+\n+  private _adjustIndex(index?: number, shift: number = 0) {\n+    if (index == null) {\n+      return this.length + shift;\n+    }\n+    if (ngDevMode) {\n+      assertGreaterThan(index, -1, `ViewRef index must be positive, got ${index}`);\n+      // +1 because it's legal to insert at the end.\n+      assertLessThan(index, this.length + 1 + shift, 'index');\n+    }\n+    return index;\n+  }\n+\n+  private allocateContainerIfNeeded(): void {\n+    if (this._lContainer[VIEW_REFS] === null) {\n+      this._lContainer[VIEW_REFS] = [];\n+    }\n+  }\n+};\n+\n+/**\n+ * Creates a ViewContainerRef and stores it on the injector.\n+ *\n+ * @param ViewContainerRefToken The ViewContainerRef type\n+ * @param ElementRefToken The ElementRef type\n+ * @param hostTNode The node that is requesting a ViewContainerRef\n+ * @param hostLView The view to which the node belongs\n+ * @returns The ViewContainerRef instance to use\n+ */\n+export function createContainerRef(\n+    hostTNode: TElementNode|TContainerNode|TElementContainerNode,\n+    hostLView: LView): ViewContainerRef {\n+  ngDevMode && assertTNodeType(hostTNode, TNodeType.AnyContainer | TNodeType.AnyRNode);\n+\n+  let lContainer: LContainer;\n+  const slotValue = hostLView[hostTNode.index];\n+  if (isLContainer(slotValue)) {\n+    // If the host is a container, we don't need to create a new LContainer\n+    lContainer = slotValue;\n+  } else {\n+    let commentNode: RComment;\n+    // If the host is an element container, the native host element is guaranteed to be a\n+    // comment and we can reuse that comment as anchor element for the new LContainer.\n+    // The comment node in question is already part of the DOM structure so we don't need to append\n+    // it again.\n+    if (hostTNode.type & TNodeType.ElementContainer) {\n+      commentNode = unwrapRNode(slotValue) as RComment;\n+    } else {\n+      // If the host is a regular element, we have to insert a comment node manually which will\n+      // be used as an anchor when inserting elements. In this specific case we use low-level DOM\n+      // manipulation to insert it.\n+      const renderer = hostLView[RENDERER];\n+      ngDevMode && ngDevMode.rendererCreateComment++;\n+      commentNode = renderer.createComment(ngDevMode ? 'container' : '');\n+\n+      const hostNative = getNativeByTNode(hostTNode, hostLView)!;\n+      const parentOfHostNative = nativeParentNode(renderer, hostNative);\n+      nativeInsertBefore(\n+          renderer, parentOfHostNative!, commentNode, nativeNextSibling(renderer, hostNative),\n+          false);\n+    }\n+\n+    hostLView[hostTNode.index] = lContainer =\n+        createLContainer(slotValue, hostLView, commentNode, hostTNode);\n+\n+    addToViewTree(hostLView, lContainer);\n+  }\n+\n+  return new R3ViewContainerRef(lContainer, hostTNode, hostLView);\n+}"
        },
        {
            "sha": "89fa943ec3901a4da8766ff279ea107ab63911d9",
            "filename": "packages/core/src/render3/query.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts",
            "raw_url": "https://github.com/angular/angular/raw/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts?ref=739d745eb5a9338e30a2ca90b22650aac191368f",
            "patch": "@@ -14,10 +14,9 @@ import {Type} from '../interface/type';\n import {createElementRef, ElementRef as ViewEngine_ElementRef} from '../linker/element_ref';\n import {QueryList} from '../linker/query_list';\n import {createTemplateRef, TemplateRef as ViewEngine_TemplateRef} from '../linker/template_ref';\n-import {ViewContainerRef} from '../linker/view_container_ref';\n+import {createContainerRef, ViewContainerRef} from '../linker/view_container_ref';\n import {assertDefined, assertIndexInRange, throwError} from '../util/assert';\n import {stringify} from '../util/stringify';\n-\n import {assertFirstCreatePass, assertLContainer} from './assert';\n import {getNodeInjectable, locateDirectiveOrProvider} from './di';\n import {storeCleanupWithContext} from './instructions/shared';\n@@ -30,7 +29,6 @@ import {DECLARATION_LCONTAINER, LView, PARENT, QUERIES, TVIEW, TView} from './in\n import {assertTNodeType} from './node_assert';\n import {getCurrentQueryIndex, getCurrentTNode, getLView, getTView, setCurrentQueryIndex} from './state';\n import {isCreationMode} from './util/view_utils';\n-import {createContainerRef} from './view_engine_compatibility';\n \n const unusedValueToPlacateAjd = unused1 + unused2 + unused3 + unused4;\n \n@@ -329,7 +327,7 @@ function createSpecialToken(lView: LView, tNode: TNode, read: any): any {\n   } else if (read === ViewContainerRef) {\n     ngDevMode && assertTNodeType(tNode, TNodeType.AnyRNode | TNodeType.AnyContainer);\n     return createContainerRef(\n-        ViewContainerRef, tNode as TElementNode | TContainerNode | TElementContainerNode, lView);\n+        tNode as TElementNode | TContainerNode | TElementContainerNode, lView);\n   } else {\n     ngDevMode &&\n         throwError("
        },
        {
            "sha": "85eb4a7f3ac777f3f2906fcc6f1bf5338cc78dfc",
            "filename": "packages/core/src/render3/view_engine_compatibility.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 285,
            "changes": 290,
            "blob_url": "https://github.com/angular/angular/blob/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "raw_url": "https://github.com/angular/angular/raw/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts?ref=739d745eb5a9338e30a2ca90b22650aac191368f",
            "patch": "@@ -7,297 +7,17 @@\n  */\n \n import {ChangeDetectorRef as ViewEngine_ChangeDetectorRef} from '../change_detection/change_detector_ref';\n-import {Injector} from '../di/injector';\n-import {ComponentFactory as viewEngine_ComponentFactory, ComponentRef as viewEngine_ComponentRef} from '../linker/component_factory';\n-import {createElementRef, ElementRef as ViewEngine_ElementRef} from '../linker/element_ref';\n-import {NgModuleRef as viewEngine_NgModuleRef} from '../linker/ng_module_factory';\n-import {TemplateRef as ViewEngine_TemplateRef} from '../linker/template_ref';\n-import {ViewContainerRef as ViewEngine_ViewContainerRef} from '../linker/view_container_ref';\n-import {EmbeddedViewRef as viewEngine_EmbeddedViewRef, ViewRef as viewEngine_ViewRef} from '../linker/view_ref';\n import {Renderer2} from '../render/api';\n-import {addToArray, removeFromArray} from '../util/array_utils';\n-import {assertEqual, assertGreaterThan, assertLessThan} from '../util/assert';\n-\n-import {assertNodeInjector} from './assert';\n-import {getParentInjectorLocation, NodeInjector} from './di';\n-import {addToViewTree, createLContainer} from './instructions/shared';\n-import {CONTAINER_HEADER_OFFSET, LContainer, NATIVE, VIEW_REFS} from './interfaces/container';\n-import {NodeInjectorOffset} from './interfaces/injector';\n-import {TContainerNode, TDirectiveHostNode, TElementContainerNode, TElementNode, TNode, TNodeType} from './interfaces/node';\n-import {isProceduralRenderer, RComment, RElement} from './interfaces/renderer';\n-import {isComponentHost, isLContainer, isLView} from './interfaces/type_checks';\n-import {DECLARATION_COMPONENT_VIEW, LView, PARENT, RENDERER, T_HOST, TVIEW} from './interfaces/view';\n-import {assertTNodeType} from './node_assert';\n-import {addViewToContainer, destroyLView, detachView, getBeforeNodeForView, insertView, nativeInsertBefore, nativeNextSibling, nativeParentNode} from './node_manipulation';\n+import {TNode, TNodeType} from './interfaces/node';\n+import {isProceduralRenderer} from './interfaces/renderer';\n+import {isComponentHost, isLView} from './interfaces/type_checks';\n+import {DECLARATION_COMPONENT_VIEW, LView, RENDERER} from './interfaces/view';\n import {getCurrentTNode, getLView} from './state';\n-import {getParentInjectorIndex, getParentInjectorView, hasParentInjector} from './util/injector_utils';\n-import {getComponentLViewByIndex, getNativeByTNode, unwrapRNode, viewAttachedToContainer} from './util/view_utils';\n+import {getComponentLViewByIndex} from './util/view_utils';\n import {ViewRef} from './view_ref';\n \n \n \n-let R3ViewContainerRef: {\n-  new (\n-      lContainer: LContainer, hostTNode: TElementNode|TContainerNode|TElementContainerNode,\n-      hostView: LView): ViewEngine_ViewContainerRef\n-};\n-\n-/**\n- * Creates a ViewContainerRef and stores it on the injector. Or, if the ViewContainerRef\n- * already exists, retrieves the existing ViewContainerRef.\n- *\n- * @returns The ViewContainerRef instance to use\n- */\n-export function injectViewContainerRef(ViewContainerRefToken: typeof ViewEngine_ViewContainerRef):\n-    ViewEngine_ViewContainerRef {\n-  const previousTNode = getCurrentTNode() as TElementNode | TElementContainerNode | TContainerNode;\n-  return createContainerRef(ViewContainerRefToken, previousTNode, getLView());\n-}\n-\n-/**\n- * Creates a ViewContainerRef and stores it on the injector.\n- *\n- * @param ViewContainerRefToken The ViewContainerRef type\n- * @param ElementRefToken The ElementRef type\n- * @param hostTNode The node that is requesting a ViewContainerRef\n- * @param hostView The view to which the node belongs\n- * @returns The ViewContainerRef instance to use\n- */\n-export function createContainerRef(\n-    ViewContainerRefToken: typeof ViewEngine_ViewContainerRef,\n-    hostTNode: TElementNode|TContainerNode|TElementContainerNode,\n-    hostView: LView): ViewEngine_ViewContainerRef {\n-  if (!R3ViewContainerRef) {\n-    R3ViewContainerRef = class ViewContainerRef extends ViewContainerRefToken {\n-      constructor(\n-          private _lContainer: LContainer,\n-          private _hostTNode: TElementNode|TContainerNode|TElementContainerNode,\n-          private _hostView: LView) {\n-        super();\n-      }\n-\n-      get element(): ViewEngine_ElementRef {\n-        return createElementRef(this._hostTNode, this._hostView);\n-      }\n-\n-      get injector(): Injector {\n-        return new NodeInjector(this._hostTNode, this._hostView);\n-      }\n-\n-      /** @deprecated No replacement */\n-      get parentInjector(): Injector {\n-        const parentLocation = getParentInjectorLocation(this._hostTNode, this._hostView);\n-        if (hasParentInjector(parentLocation)) {\n-          const parentView = getParentInjectorView(parentLocation, this._hostView);\n-          const injectorIndex = getParentInjectorIndex(parentLocation);\n-          ngDevMode && assertNodeInjector(parentView, injectorIndex);\n-          const parentTNode =\n-              parentView[TVIEW].data[injectorIndex + NodeInjectorOffset.TNODE] as TElementNode;\n-          return new NodeInjector(parentTNode, parentView);\n-        } else {\n-          return new NodeInjector(null, this._hostView);\n-        }\n-      }\n-\n-      clear(): void {\n-        while (this.length > 0) {\n-          this.remove(this.length - 1);\n-        }\n-      }\n-\n-      get(index: number): viewEngine_ViewRef|null {\n-        return this._lContainer[VIEW_REFS] !== null && this._lContainer[VIEW_REFS]![index] || null;\n-      }\n-\n-      get length(): number {\n-        return this._lContainer.length - CONTAINER_HEADER_OFFSET;\n-      }\n-\n-      createEmbeddedView<C>(templateRef: ViewEngine_TemplateRef<C>, context?: C, index?: number):\n-          viewEngine_EmbeddedViewRef<C> {\n-        const viewRef = templateRef.createEmbeddedView(context || <any>{});\n-        this.insert(viewRef, index);\n-        return viewRef;\n-      }\n-\n-      createComponent<C>(\n-          componentFactory: viewEngine_ComponentFactory<C>, index?: number|undefined,\n-          injector?: Injector|undefined, projectableNodes?: any[][]|undefined,\n-          ngModuleRef?: viewEngine_NgModuleRef<any>|undefined): viewEngine_ComponentRef<C> {\n-        const contextInjector = injector || this.parentInjector;\n-        if (!ngModuleRef && (componentFactory as any).ngModule == null && contextInjector) {\n-          // DO NOT REFACTOR. The code here used to have a `value || undefined` expression\n-          // which seems to cause internal google apps to fail. This is documented in the\n-          // following internal bug issue: go/b/142967802\n-          const result = contextInjector.get(viewEngine_NgModuleRef, null);\n-          if (result) {\n-            ngModuleRef = result;\n-          }\n-        }\n-\n-        const componentRef =\n-            componentFactory.create(contextInjector, projectableNodes, undefined, ngModuleRef);\n-        this.insert(componentRef.hostView, index);\n-        return componentRef;\n-      }\n-\n-      insert(viewRef: viewEngine_ViewRef, index?: number): viewEngine_ViewRef {\n-        const lView = (viewRef as ViewRef<any>)._lView!;\n-        const tView = lView[TVIEW];\n-\n-        if (viewRef.destroyed) {\n-          throw new Error('Cannot insert a destroyed View in a ViewContainer!');\n-        }\n-\n-        this.allocateContainerIfNeeded();\n-\n-        if (viewAttachedToContainer(lView)) {\n-          // If view is already attached, detach it first so we clean up references appropriately.\n-\n-          const prevIdx = this.indexOf(viewRef);\n-\n-          // A view might be attached either to this or a different container. The `prevIdx` for\n-          // those cases will be:\n-          // equal to -1 for views attached to this ViewContainerRef\n-          // >= 0 for views attached to a different ViewContainerRef\n-          if (prevIdx !== -1) {\n-            this.detach(prevIdx);\n-          } else {\n-            const prevLContainer = lView[PARENT] as LContainer;\n-            ngDevMode &&\n-                assertEqual(\n-                    isLContainer(prevLContainer), true,\n-                    'An attached view should have its PARENT point to a container.');\n-\n-\n-            // We need to re-create a R3ViewContainerRef instance since those are not stored on\n-            // LView (nor anywhere else).\n-            const prevVCRef = new R3ViewContainerRef(\n-                prevLContainer, prevLContainer[T_HOST] as TDirectiveHostNode,\n-                prevLContainer[PARENT]);\n-\n-            prevVCRef.detach(prevVCRef.indexOf(viewRef));\n-          }\n-        }\n-\n-        // Logical operation of adding `LView` to `LContainer`\n-        const adjustedIdx = this._adjustIndex(index);\n-        const lContainer = this._lContainer;\n-        insertView(tView, lView, lContainer, adjustedIdx);\n-\n-        // Physical operation of adding the DOM nodes.\n-        const beforeNode = getBeforeNodeForView(adjustedIdx, lContainer);\n-        const renderer = lView[RENDERER];\n-        const parentRNode = nativeParentNode(renderer, lContainer[NATIVE] as RElement | RComment);\n-        if (parentRNode !== null) {\n-          addViewToContainer(tView, lContainer[T_HOST], renderer, lView, parentRNode, beforeNode);\n-        }\n-\n-        (viewRef as ViewRef<any>).attachToViewContainerRef(this);\n-        addToArray(lContainer[VIEW_REFS]!, adjustedIdx, viewRef);\n-\n-        return viewRef;\n-      }\n-\n-      move(viewRef: viewEngine_ViewRef, newIndex: number): viewEngine_ViewRef {\n-        if (viewRef.destroyed) {\n-          throw new Error('Cannot move a destroyed View in a ViewContainer!');\n-        }\n-        return this.insert(viewRef, newIndex);\n-      }\n-\n-      indexOf(viewRef: viewEngine_ViewRef): number {\n-        const viewRefsArr = this._lContainer[VIEW_REFS];\n-        return viewRefsArr !== null ? viewRefsArr.indexOf(viewRef) : -1;\n-      }\n-\n-      remove(index?: number): void {\n-        this.allocateContainerIfNeeded();\n-        const adjustedIdx = this._adjustIndex(index, -1);\n-        const detachedView = detachView(this._lContainer, adjustedIdx);\n-\n-        if (detachedView) {\n-          // Before destroying the view, remove it from the container's array of `ViewRef`s.\n-          // This ensures the view container length is updated before calling\n-          // `destroyLView`, which could recursively call view container methods that\n-          // rely on an accurate container length.\n-          // (e.g. a method on this view container being called by a child directive's OnDestroy\n-          // lifecycle hook)\n-          removeFromArray(this._lContainer[VIEW_REFS]!, adjustedIdx);\n-          destroyLView(detachedView[TVIEW], detachedView);\n-        }\n-      }\n-\n-      detach(index?: number): viewEngine_ViewRef|null {\n-        this.allocateContainerIfNeeded();\n-        const adjustedIdx = this._adjustIndex(index, -1);\n-        const view = detachView(this._lContainer, adjustedIdx);\n-\n-        const wasDetached =\n-            view && removeFromArray(this._lContainer[VIEW_REFS]!, adjustedIdx) != null;\n-        return wasDetached ? new ViewRef(view!) : null;\n-      }\n-\n-      private _adjustIndex(index?: number, shift: number = 0) {\n-        if (index == null) {\n-          return this.length + shift;\n-        }\n-        if (ngDevMode) {\n-          assertGreaterThan(index, -1, `ViewRef index must be positive, got ${index}`);\n-          // +1 because it's legal to insert at the end.\n-          assertLessThan(index, this.length + 1 + shift, 'index');\n-        }\n-        return index;\n-      }\n-\n-      private allocateContainerIfNeeded(): void {\n-        if (this._lContainer[VIEW_REFS] === null) {\n-          this._lContainer[VIEW_REFS] = [];\n-        }\n-      }\n-    };\n-  }\n-\n-  ngDevMode && assertTNodeType(hostTNode, TNodeType.AnyContainer | TNodeType.AnyRNode);\n-\n-  let lContainer: LContainer;\n-  const slotValue = hostView[hostTNode.index];\n-  if (isLContainer(slotValue)) {\n-    // If the host is a container, we don't need to create a new LContainer\n-    lContainer = slotValue;\n-  } else {\n-    let commentNode: RComment;\n-    // If the host is an element container, the native host element is guaranteed to be a\n-    // comment and we can reuse that comment as anchor element for the new LContainer.\n-    // The comment node in question is already part of the DOM structure so we don't need to append\n-    // it again.\n-    if (hostTNode.type & TNodeType.ElementContainer) {\n-      commentNode = unwrapRNode(slotValue) as RComment;\n-    } else {\n-      // If the host is a regular element, we have to insert a comment node manually which will\n-      // be used as an anchor when inserting elements. In this specific case we use low-level DOM\n-      // manipulation to insert it.\n-      const renderer = hostView[RENDERER];\n-      ngDevMode && ngDevMode.rendererCreateComment++;\n-      commentNode = renderer.createComment(ngDevMode ? 'container' : '');\n-\n-      const hostNative = getNativeByTNode(hostTNode, hostView)!;\n-      const parentOfHostNative = nativeParentNode(renderer, hostNative);\n-      nativeInsertBefore(\n-          renderer, parentOfHostNative!, commentNode, nativeNextSibling(renderer, hostNative),\n-          false);\n-    }\n-\n-    hostView[hostTNode.index] = lContainer =\n-        createLContainer(slotValue, hostView, commentNode, hostTNode);\n-\n-    addToViewTree(hostView, lContainer);\n-  }\n-\n-  return new R3ViewContainerRef(lContainer, hostTNode, hostView);\n-}\n-\n-\n /** Returns a ChangeDetectorRef (a.k.a. a ViewRef) */\n export function injectChangeDetectorRef(isPipe = false): ViewEngine_ChangeDetectorRef {\n   return createViewRef(getCurrentTNode()!, getLView(), isPipe);"
        },
        {
            "sha": "6325a87e2cd288a1818655d1fa750c9e76846336",
            "filename": "packages/core/test/bundling/forms/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json?ref=739d745eb5a9338e30a2ca90b22650aac191368f",
            "patch": "@@ -470,6 +470,9 @@\n   {\n     \"name\": \"R3TemplateRef\"\n   },\n+  {\n+    \"name\": \"R3ViewContainerRef\"\n+  },\n   {\n     \"name\": \"RADIO_VALUE_ACCESSOR\"\n   },\n@@ -626,6 +629,9 @@\n   {\n     \"name\": \"ViewEngineTemplateRef\"\n   },\n+  {\n+    \"name\": \"VE_ViewContainerRef\"\n+  },\n   {\n     \"name\": \"Validators\"\n   },"
        },
        {
            "sha": "c00bdbf7b8ba42dbf4140956a8be3a32cf4bc2c9",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=739d745eb5a9338e30a2ca90b22650aac191368f",
            "patch": "@@ -575,6 +575,9 @@\n   {\n     \"name\": \"R3TemplateRef\"\n   },\n+  {\n+    \"name\": \"R3ViewContainerRef\"\n+  },\n   {\n     \"name\": \"ROUTER_CONFIGURATION\"\n   },\n@@ -845,6 +848,9 @@\n   {\n     \"name\": \"ViewEngineTemplateRef\"\n   },\n+  {\n+    \"name\": \"VE_ViewContainerRef\"\n+  },\n   {\n     \"name\": \"Version\"\n   },"
        },
        {
            "sha": "ada284be31af4e48908fa9112d98664b3a88e0d5",
            "filename": "packages/core/test/bundling/todo/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json?ref=739d745eb5a9338e30a2ca90b22650aac191368f",
            "patch": "@@ -89,6 +89,9 @@\n   {\n     \"name\": \"R3TemplateRef\"\n   },\n+  {\n+    \"name\": \"R3ViewContainerRef\"\n+  },\n   {\n     \"name\": \"RecordViewTuple\"\n   },\n@@ -140,6 +143,9 @@\n   {\n     \"name\": \"ViewEngineTemplateRef\"\n   },\n+  {\n+    \"name\": \"VE_ViewContainerRef\"\n+  },\n   {\n     \"name\": \"ViewContainerRef\"\n   },"
        },
        {
            "sha": "5e7b929683e5e9d332cd60bf0378a9e61a7e2459",
            "filename": "packages/core/test/render3/perf/ng_template/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fng_template%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fng_template%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fng_template%2Findex.ts?ref=739d745eb5a9338e30a2ca90b22650aac191368f",
            "patch": "@@ -6,17 +6,18 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {injectTemplateRef} from '@angular/core/src/linker/template_ref';\n+import {injectViewContainerRef} from '@angular/core/src/linker/view_container_ref';\n import {TemplateRef, ViewContainerRef} from '../../../../src/linker';\n import {defineDirective, directiveInject, template} from '../../../../src/render3/index';\n import {createLView, createTNode, createTView} from '../../../../src/render3/instructions/shared';\n import {RenderFlags} from '../../../../src/render3/interfaces/definition';\n import {TNodeType} from '../../../../src/render3/interfaces/node';\n import {LViewFlags, TViewType} from '../../../../src/render3/interfaces/view';\n-import {injectViewContainerRef} from '../../../../src/render3/view_engine_compatibility';\n import {createBenchmark} from '../micro_bench';\n import {createAndRenderLView} from '../setup';\n \n \n+\n class TemplateRefToken {\n   /**\n    * @internal\n@@ -32,7 +33,7 @@ class ViewContainerRefToken {\n    * @nocollapse\n    */\n   static __NG_ELEMENT_ID__(): ViewContainerRef {\n-    return injectViewContainerRef(ViewContainerRef);\n+    return injectViewContainerRef();\n   }\n }\n "
        },
        {
            "sha": "95970699bf8315ab1a53b6ccf476a752fbe26ad9",
            "filename": "packages/core/test/render3/render_util.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Ftest%2Frender3%2Frender_util.ts",
            "raw_url": "https://github.com/angular/angular/raw/739d745eb5a9338e30a2ca90b22650aac191368f/packages%2Fcore%2Ftest%2Frender3%2Frender_util.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Frender_util.ts?ref=739d745eb5a9338e30a2ca90b22650aac191368f",
            "patch": "@@ -454,7 +454,7 @@ export const text: RText = null as any as Text;\n export function enableIvyInjectableFactories() {\n   (ElementRef as any)[NG_ELEMENT_ID] = () => R3_ELEMENT_REF_FACTORY();\n   (TemplateRef as any)[NG_ELEMENT_ID] = () => R3_TEMPLATE_REF_FACTORY();\n-  (ViewContainerRef as any)[NG_ELEMENT_ID] = () => R3_VIEW_CONTAINER_REF_FACTORY(ViewContainerRef);\n+  (ViewContainerRef as any)[NG_ELEMENT_ID] = () => R3_VIEW_CONTAINER_REF_FACTORY();\n   (ChangeDetectorRef as any)[NG_ELEMENT_ID] = () => R3_CHANGE_DETECTOR_REF_FACTORY();\n   (Renderer2 as any)[NG_ELEMENT_ID] = () => R3_RENDERER2_FACTORY();\n }"
        }
    ],
    "stats": {
        "total": 767,
        "additions": 379,
        "deletions": 388
    }
}