{
    "author": "atscott",
    "message": "refactor(router): Remove `defer` as it's not needed anymore (#38781)\n\nThis change contains the test from #38780 and also removes `defer` from\nthe `apply_redirects` logic because the change that introduced\n`concatMap` instead of `map`...`concatAll` makes `defer` unnecessary.\n\nPR Close #38781",
    "sha": "281865bbcff3cb397ab3d88c12814a0819ddae7b",
    "files": [
        {
            "sha": "f984a93c079729df874e5569d3b32f0d06d8d0c8",
            "filename": "packages/router/src/apply_redirects.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/281865bbcff3cb397ab3d88c12814a0819ddae7b/packages%2Frouter%2Fsrc%2Fapply_redirects.ts",
            "raw_url": "https://github.com/angular/angular/raw/281865bbcff3cb397ab3d88c12814a0819ddae7b/packages%2Frouter%2Fsrc%2Fapply_redirects.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fapply_redirects.ts?ref=281865bbcff3cb397ab3d88c12814a0819ddae7b",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {Injector, NgModuleRef} from '@angular/core';\n-import {defer, EmptyError, from, Observable, Observer, of} from 'rxjs';\n+import {EmptyError, from, Observable, Observer, of} from 'rxjs';\n import {catchError, combineAll, concatMap, first, map, mergeMap, tap} from 'rxjs/operators';\n \n import {LoadedRouterConfig, Route, Routes} from './config';\n@@ -274,12 +274,11 @@ class ApplyRedirects {\n       segments: UrlSegment[]): Observable<UrlSegmentGroup> {\n     if (route.path === '**') {\n       if (route.loadChildren) {\n-        return defer(\n-            () => this.configLoader.load(ngModule.injector, route)\n-                      .pipe(map((cfg: LoadedRouterConfig) => {\n-                        route._loadedConfig = cfg;\n-                        return new UrlSegmentGroup(segments, {});\n-                      })));\n+        return this.configLoader.load(ngModule.injector, route)\n+            .pipe(map((cfg: LoadedRouterConfig) => {\n+              route._loadedConfig = cfg;\n+              return new UrlSegmentGroup(segments, {});\n+            }));\n       }\n \n       return of(new UrlSegmentGroup(segments, {}));"
        },
        {
            "sha": "580360f333439197bb97bf29973ae3773d7e5f07",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 2,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/281865bbcff3cb397ab3d88c12814a0819ddae7b/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/281865bbcff3cb397ab3d88c12814a0819ddae7b/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=281865bbcff3cb397ab3d88c12814a0819ddae7b",
            "patch": "@@ -4090,7 +4090,7 @@ describe('Integration', () => {\n         return of(delayMs).pipe(delay(delayMs), mapTo(true));\n       }\n \n-      @NgModule()\n+      @NgModule({imports: [RouterModule.forChild([{path: '', component: BlankCmp}])]})\n       class LoadedModule {\n       }\n \n@@ -4119,6 +4119,15 @@ describe('Integration', () => {\n                 return false;\n               }\n             },\n+            {\n+              provide: 'returnFalseAndNavigate',\n+              useFactory: (router: Router) => () => {\n+                log.push('returnFalseAndNavigate');\n+                router.navigateByUrl('/redirected');\n+                return false;\n+              },\n+              deps: [Router]\n+            },\n             {\n               provide: 'returnUrlTree',\n               useFactory: (router: Router) => () => {\n@@ -4132,7 +4141,23 @@ describe('Integration', () => {\n         });\n       });\n \n-      it('should wait for higher priority guards to be resolved',\n+      it('should only execute canLoad guards of routes being activated', fakeAsync(() => {\n+           const router = TestBed.inject(Router);\n+\n+           router.resetConfig([\n+             {path: 'lazy', canLoad: ['guard1'], loadChildren: () => of(LoadedModule)},\n+             {path: 'redirected', component: SimpleCmp},\n+             // canLoad should not run for this route because 'lazy' activates first\n+             {path: '', canLoad: ['returnFalseAndNavigate'], loadChildren: () => of(LoadedModule)},\n+           ]);\n+\n+           router.navigateByUrl('/lazy');\n+           tick(5);\n+           expect(log.length).toEqual(1);\n+           expect(log).toEqual(['guard1']);\n+         }));\n+\n+      it('should execute canLoad guards',\n          fakeAsync(inject(\n              [Router, NgModuleFactoryLoader],\n              (router: Router, loader: SpyNgModuleFactoryLoader) => {"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 33,
        "deletions": 9
    }
}