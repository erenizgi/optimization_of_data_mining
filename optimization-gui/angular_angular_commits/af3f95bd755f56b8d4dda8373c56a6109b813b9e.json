{
    "author": "atscott",
    "message": "refactor(language-service): migrate diagnostic_spec to new test infrastructure (#40966)\n\nrefactor(language-service): migrate diagnostic_spec to new test infrastructure\n\nPR Close #40966",
    "sha": "af3f95bd755f56b8d4dda8373c56a6109b813b9e",
    "files": [
        {
            "sha": "97ccf9dc1d5b69bb216cef08498ab58a2b56b140",
            "filename": "packages/language-service/ivy/test/diagnostic_spec.ts",
            "status": "modified",
            "additions": 51,
            "deletions": 70,
            "changes": 121,
            "blob_url": "https://github.com/angular/angular/blob/af3f95bd755f56b8d4dda8373c56a6109b813b9e/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/af3f95bd755f56b8d4dda8373c56a6109b813b9e/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts?ref=af3f95bd755f56b8d4dda8373c56a6109b813b9e",
            "patch": "@@ -6,21 +6,22 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n-import {LanguageServiceTestEnvironment} from '@angular/language-service/ivy/test/env';\n import * as ts from 'typescript';\n-import {createModuleWithDeclarations} from './test_utils';\n+\n+import {createModuleAndProjectWithDeclarations, LanguageServiceTestEnv} from '../testing';\n+\n \n describe('getSemanticDiagnostics', () => {\n+  let env: LanguageServiceTestEnv;\n   beforeEach(() => {\n     initMockFileSystem('Native');\n+    env = LanguageServiceTestEnv.setup();\n   });\n \n   it('should not produce error for a minimal component defintion', () => {\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+    const files = {\n+      'app.ts': `\n       import {Component, NgModule} from '@angular/core';\n \n       @Component({\n@@ -29,16 +30,15 @@ describe('getSemanticDiagnostics', () => {\n       export class AppComponent {}\n     `\n     };\n-    const env = createModuleWithDeclarations([appFile]);\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n \n-    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.ts'));\n+    const diags = project.getDiagnosticsForFile('app.ts');\n     expect(diags.length).toEqual(0);\n   });\n \n   it('should report member does not exist', () => {\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+    const files = {\n+      'app.ts': `\n       import {Component, NgModule} from '@angular/core';\n \n       @Component({\n@@ -47,67 +47,59 @@ describe('getSemanticDiagnostics', () => {\n       export class AppComponent {}\n     `\n     };\n-    const env = createModuleWithDeclarations([appFile]);\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n \n-    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.ts'));\n+    const diags = project.getDiagnosticsForFile('app.ts');\n     expect(diags.length).toBe(1);\n-    const {category, file, start, length, messageText} = diags[0];\n+    const {category, file, messageText} = diags[0];\n     expect(category).toBe(ts.DiagnosticCategory.Error);\n-    expect(file?.fileName).toBe('/app.ts');\n+    expect(file?.fileName).toBe('/test/app.ts');\n     expect(messageText).toBe(`Property 'nope' does not exist on type 'AppComponent'.`);\n   });\n \n   it('should process external template', () => {\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+    const files = {\n+      'app.ts': `\n       import {Component, NgModule} from '@angular/core';\n \n       @Component({\n         templateUrl: './app.html'\n       })\n       export class AppComponent {}\n-    `\n-    };\n-    const templateFile = {\n-      name: absoluteFrom('/app.html'),\n-      contents: `\n-      Hello world!\n-    `\n+    `,\n+      'app.html': `Hello world!`\n     };\n \n-    const env = createModuleWithDeclarations([appFile], [templateFile]);\n-    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.html'));\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const diags = project.getDiagnosticsForFile('app.html');\n     expect(diags).toEqual([]);\n   });\n \n   it('should report member does not exist in external template', () => {\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+    const files = {\n+      'app.ts': `\n       import {Component, NgModule} from '@angular/core';\n \n       @Component({\n         templateUrl: './app.html'\n       })\n       export class AppComponent {}\n-    `\n+    `,\n+      'app.html': '{{nope}}'\n     };\n-    const templateFile = {name: absoluteFrom('/app.html'), contents: `{{nope}}`};\n \n-    const env = createModuleWithDeclarations([appFile], [templateFile]);\n-    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.html'));\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const diags = project.getDiagnosticsForFile('app.html');\n     expect(diags.length).toBe(1);\n-    const {category, file, start, length, messageText} = diags[0];\n+    const {category, file, messageText} = diags[0];\n     expect(category).toBe(ts.DiagnosticCategory.Error);\n-    expect(file?.fileName).toBe('/app.html');\n+    expect(file?.fileName).toBe('/test/app.html');\n     expect(messageText).toBe(`Property 'nope' does not exist on type 'AppComponent'.`);\n   });\n \n   it('should report a parse error in external template', () => {\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+    const files = {\n+      'app.ts': `\n       import {Component, NgModule} from '@angular/core';\n \n       @Component({\n@@ -116,41 +108,36 @@ describe('getSemanticDiagnostics', () => {\n       export class AppComponent {\n         nope = false;\n       }\n-    `\n+    `,\n+      'app.html': '{{nope = true}}'\n     };\n-    const templateFile = {name: absoluteFrom('/app.html'), contents: `{{nope = true}}`};\n \n-    const env = createModuleWithDeclarations([appFile], [templateFile]);\n-    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.html'));\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const diags = project.getDiagnosticsForFile('app.html');\n     expect(diags.length).toBe(1);\n \n     const {category, file, messageText} = diags[0];\n     expect(category).toBe(ts.DiagnosticCategory.Error);\n-    expect(file?.fileName).toBe('/app.html');\n+    expect(file?.fileName).toBe('/test/app.html');\n     expect(messageText)\n         .toContain(\n             `Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = true}}]`);\n   });\n \n   it('should report parse errors of components defined in the same ts file', () => {\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+    const files = {\n+      'app.ts': `\n       import {Component, NgModule} from '@angular/core';\n \n       @Component({ templateUrl: './app1.html' })\n       export class AppComponent1 { nope = false; }\n \n       @Component({ templateUrl: './app2.html' })\n       export class AppComponent2 { nope = false; }\n-    `\n-    };\n-    const templateFile1 = {name: absoluteFrom('/app1.html'), contents: `{{nope = false}}`};\n-    const templateFile2 = {name: absoluteFrom('/app2.html'), contents: `{{nope = true}}`};\n-\n-    const moduleFile = {\n-      name: absoluteFrom('/app-module.ts'),\n-      contents: `\n+    `,\n+      'app1.html': '{{nope = false}}',\n+      'app2.html': '{{nope = true}}',\n+      'app-module.ts': `\n         import {NgModule} from '@angular/core';\n         import {CommonModule} from '@angular/common';\n         import {AppComponent, AppComponent2} from './app';\n@@ -160,34 +147,28 @@ describe('getSemanticDiagnostics', () => {\n           imports: [CommonModule],\n         })\n         export class AppModule {}\n-    `,\n-      isRoot: true\n+    `\n     };\n \n-    const env =\n-        LanguageServiceTestEnvironment.setup([moduleFile, appFile, templateFile1, templateFile2]);\n-\n-    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.ts'));\n-\n+    const project = env.addProject('test', files);\n+    const diags = project.getDiagnosticsForFile('app.ts');\n     expect(diags.map(x => x.messageText).sort()).toEqual([\n-      'Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = false}}] in /app1.html@0:0',\n-      'Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = true}}] in /app2.html@0:0'\n+      'Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = false}}] in /test/app1.html@0:0',\n+      'Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = true}}] in /test/app2.html@0:0'\n     ]);\n   });\n \n   it('reports a diagnostic for a component without a template', () => {\n-    const appFile = {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+    const files = {\n+      'app.ts': `\n       import {Component} from '@angular/core';\n       @Component({})\n       export class MyComponent {}\n     `\n     };\n \n-    const env = createModuleWithDeclarations([appFile]);\n-    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.ts'));\n-\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const diags = project.getDiagnosticsForFile('app.ts');\n     expect(diags.map(x => x.messageText)).toEqual([\n       'component is missing a template',\n     ]);"
        },
        {
            "sha": "9e13b9ded17468f3f9ad473bb9e69a33336f6744",
            "filename": "packages/language-service/ivy/testing/src/util.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/af3f95bd755f56b8d4dda8373c56a6109b813b9e/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/af3f95bd755f56b8d4dda8373c56a6109b813b9e/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts?ref=af3f95bd755f56b8d4dda8373c56a6109b813b9e",
            "patch": "@@ -5,6 +5,10 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {LanguageServiceTestEnv} from './env';\n+import {Project, ProjectFiles} from './project';\n \n /**\n  * Given a text snippet which contains exactly one cursor symbol ('Â¦'), extract both the offset of\n@@ -52,3 +56,39 @@ export function isNgSpecificDiagnostic(diag: ts.Diagnostic): boolean {\n   // Angular-specific diagnostics use a negative code space.\n   return diag.code < 0;\n }\n+\n+function getFirstClassDeclaration(declaration: string) {\n+  const matches = declaration.match(/(?:export class )(\\w+)(?:\\s|\\{)/);\n+  if (matches === null || matches.length !== 2) {\n+    throw new Error(`Did not find exactly one exported class in: ${declaration}`);\n+  }\n+  return matches[1].trim();\n+}\n+\n+export function createModuleAndProjectWithDeclarations(\n+    env: LanguageServiceTestEnv, projectName: string, projectFiles: ProjectFiles,\n+    options: any = {}): Project {\n+  const externalClasses: string[] = [];\n+  const externalImports: string[] = [];\n+  for (const [fileName, fileContents] of Object.entries(projectFiles)) {\n+    if (!fileName.endsWith('.ts')) {\n+      continue;\n+    }\n+    const className = getFirstClassDeclaration(fileContents);\n+    externalClasses.push(className);\n+    externalImports.push(`import {${className}} from './${fileName.replace('.ts', '')}';`);\n+  }\n+  const moduleContents = `\n+        import {NgModule} from '@angular/core';\n+        import {CommonModule} from '@angular/common';\n+        ${externalImports.join('\\n')}\n+\n+        @NgModule({\n+          declarations: [${externalClasses.join(',')}],\n+          imports: [CommonModule],\n+        })\n+        export class AppModule {}\n+      `;\n+  projectFiles['app-module.ts'] = moduleContents;\n+  return env.addProject(projectName, projectFiles);\n+}\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 161,
        "additions": 91,
        "deletions": 70
    }
}