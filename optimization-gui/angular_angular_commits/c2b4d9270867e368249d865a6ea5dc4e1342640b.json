{
    "author": "JiaLiPassion",
    "message": "feat(zone.js): patch jasmine.createSpyObj to make properties enumerable to be true (#34624)\n\nClose #33657\n\nin jasmine 3.5, there is a new feature, user can pass a properties object to `jasmine.createSpyObj`\n\n```\nconst spy = jasmine.createSpyObj('spy', ['method1'], {prop1: 'foo'});\nexpect(spy.prop1).toEqual('foo');\n```\n\nThis case will not work for Angular TestBed, for example,\n\n```\ndescribe('AppComponent', () => {\n  beforeEach(() => {\n\n    //Note the third parameter\n    // @ts-ignore\n    const someServiceSpy = jasmine.createSpyObj('SomeService', ['someFunction'], ['aProperty']);\n\n    TestBed.configureTestingModule({\n      declarations: [\n        AppComponent\n      ],\n      providers: [\n        {provide: SomeService, useValue: someServiceSpy},\n      ]\n    }).compileComponents();\n\n  });\n\n  it('should create the app', () => {\n    //spyObj will have someFunction, but will not have aProperty\n    let spyObj = TestBed.get(SomeService);\n  });\n```\n\nBecause `jasmine.createSpyObj` will create the `aProperty` with `enumerable=false`,\nand `TestBed.configureTestingModule` will try to copy all the properties from spyObj to\nthe injected service instance. And because `enumerable` is false, so the property (here is aProperty)\nwill not be copied.\n\nThis PR will monkey patch the `jasmine.createSpyObj` and make sure the new property's\n`enumerable=true`.\n\nPR Close #34624",
    "sha": "c2b4d9270867e368249d865a6ea5dc4e1342640b",
    "files": [
        {
            "sha": "2ad1e3596ec5cc9864d056f1119f95ca9a04121c",
            "filename": "packages/zone.js/lib/jasmine/jasmine.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/c2b4d9270867e368249d865a6ea5dc4e1342640b/packages%2Fzone.js%2Flib%2Fjasmine%2Fjasmine.ts",
            "raw_url": "https://github.com/angular/angular/raw/c2b4d9270867e368249d865a6ea5dc4e1342640b/packages%2Fzone.js%2Flib%2Fjasmine%2Fjasmine.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fjasmine%2Fjasmine.ts?ref=c2b4d9270867e368249d865a6ea5dc4e1342640b",
            "patch": "@@ -152,6 +152,33 @@ Zone.__load_patch('jasmine', (global: any, Zone: ZoneType, api: _ZonePrivate) =>\n       return clock;\n     };\n   }\n+\n+  // monkey patch createSpyObj to make properties enumerable to true\n+  if (!(jasmine as any)[Zone.__symbol__('createSpyObj')]) {\n+    const originalCreateSpyObj = jasmine.createSpyObj;\n+    (jasmine as any)[Zone.__symbol__('createSpyObj')] = originalCreateSpyObj;\n+    jasmine.createSpyObj = function() {\n+      const args: any = Array.prototype.slice.call(arguments);\n+      const propertyNames = args.length >= 3 ? args[2] : null;\n+      let spyObj: any;\n+      if (propertyNames) {\n+        const defineProperty = Object.defineProperty;\n+        Object.defineProperty = function(obj: any, p: string, attributes: any) {\n+          return defineProperty.call(\n+              this, obj, p, {...attributes, configurable: true, enumerable: true});\n+        };\n+        try {\n+          spyObj = originalCreateSpyObj.apply(this, args);\n+        } finally {\n+          Object.defineProperty = defineProperty;\n+        }\n+      } else {\n+        spyObj = originalCreateSpyObj.apply(this, args);\n+      }\n+      return spyObj;\n+    };\n+  }\n+\n   /**\n    * Gets a function wrapping the body of a Jasmine `describe` block to execute in a\n    * synchronous-only zone."
        },
        {
            "sha": "375f63ca1ba827668ea251e9f27dc9b699f2bfc4",
            "filename": "packages/zone.js/test/jasmine-patch.spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/c2b4d9270867e368249d865a6ea5dc4e1342640b/packages%2Fzone.js%2Ftest%2Fjasmine-patch.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c2b4d9270867e368249d865a6ea5dc4e1342640b/packages%2Fzone.js%2Ftest%2Fjasmine-patch.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fjasmine-patch.spec.ts?ref=c2b4d9270867e368249d865a6ea5dc4e1342640b",
            "patch": "@@ -77,4 +77,14 @@ ifEnvSupports(supportJasmineSpec, () => {\n       expect(log).toEqual(['resolved']);\n     });\n   });\n+\n+  describe('jasmine.createSpyObj', () => {\n+    it('createSpyObj with properties should be able to be retrieved from the spy', () => {\n+      const spy = jasmine.createSpyObj('obj', ['someFunction'], {prop1: 'foo'});\n+      expect(spy.prop1).toEqual('foo');\n+      const desc: any = Object.getOwnPropertyDescriptor(spy, 'prop1');\n+      expect(desc.enumerable).toBe(true);\n+      expect(desc.configurable).toBe(true);\n+    });\n+  });\n })();"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 37,
        "deletions": 0
    }
}