{
    "author": "atscott",
    "message": "refactor(language-service): migrate type_definitions_spec to the new testing package (#40966)\n\nrefactor(language-service): migrate type_definitions_spec to the new testing package\n\nPR Close #40966",
    "sha": "000ec6be3c3bc0b44719a4d47467e56b4a771678",
    "files": [
        {
            "sha": "a911986082ea07c2e9d68081a5a3da30b9b5af87",
            "filename": "packages/language-service/ivy/test/type_definitions_spec.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 25,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/000ec6be3c3bc0b44719a4d47467e56b4a771678/packages%2Flanguage-service%2Fivy%2Ftest%2Ftype_definitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/000ec6be3c3bc0b44719a4d47467e56b4a771678/packages%2Flanguage-service%2Fivy%2Ftest%2Ftype_definitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Ftype_definitions_spec.ts?ref=000ec6be3c3bc0b44719a4d47467e56b4a771678",
            "patch": "@@ -6,21 +6,17 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n-import {initMockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n \n-import {LanguageServiceTestEnvironment} from './env';\n-import {humanizeDocumentSpanLike} from './test_utils';\n+import {extractCursorInfo, humanizeDocumentSpanLike, LanguageServiceTestEnv, Project} from '../testing';\n \n describe('type definitions', () => {\n-  let env: LanguageServiceTestEnvironment;\n+  let env: LanguageServiceTestEnv;\n \n   it('returns the pipe class as definition when checkTypeOfPipes is false', () => {\n     initMockFileSystem('Native');\n-    const testFiles: TestFile[] = [\n-      {\n-        name: absoluteFrom('/app.ts'),\n-        contents: `\n+    const files = {\n+      'app.ts': `\n         import {Component, NgModule} from '@angular/core';\n         import {CommonModule} from '@angular/common';\n \n@@ -30,32 +26,31 @@ describe('type definitions', () => {\n         @NgModule({declarations: [AppCmp], imports: [CommonModule]})\n         export class AppModule {}\n       `,\n-        isRoot: true\n-      },\n-      {\n-        name: absoluteFrom('/app.html'),\n-        contents: `Will be overridden`,\n-      }\n-    ];\n+      'app.html': `Will be overridden`,\n+    };\n     // checkTypeOfPipes is set to false when strict templates is false\n-    env = LanguageServiceTestEnvironment.setup(testFiles, {strictTemplates: false});\n+    env = LanguageServiceTestEnv.setup();\n+    const project = env.addProject('test', files, {strictTemplates: false});\n     const definitions =\n-        getTypeDefinitionsAndAssertBoundSpan({templateOverride: '{{\"1/1/2020\" | dat¦e}}'});\n+        getTypeDefinitionsAndAssertBoundSpan(project, {templateOverride: '{{\"1/1/2020\" | dat¦e}}'});\n     expect(definitions!.length).toEqual(1);\n \n     const [def] = definitions;\n     expect(def.textSpan).toContain('DatePipe');\n     expect(def.contextSpan).toContain('DatePipe');\n   });\n \n-  function getTypeDefinitionsAndAssertBoundSpan({templateOverride}: {templateOverride: string}) {\n-    const {cursor, text} = env.updateFileWithCursor(absoluteFrom('/app.html'), templateOverride);\n+  function getTypeDefinitionsAndAssertBoundSpan(\n+      project: Project, {templateOverride}: {templateOverride: string}) {\n+    const {text} = extractCursorInfo(templateOverride);\n+    const template = project.openFile('app.html');\n+    template.contents = text;\n     env.expectNoSourceDiagnostics();\n-    env.expectNoTemplateDiagnostics(absoluteFrom('/app.ts'), 'AppCmp');\n-    const defs = env.ngLS.getTypeDefinitionAtPosition(absoluteFrom('/app.html'), cursor);\n+    project.expectNoTemplateDiagnostics('app.ts', 'AppCmp');\n+\n+    template.moveCursorToText(templateOverride);\n+    const defs = template.getTypeDefinitionAtPosition();\n     expect(defs).toBeTruthy();\n-    const overrides = new Map<string, string>();\n-    overrides.set(absoluteFrom('/app.html'), text);\n-    return defs!.map(d => humanizeDocumentSpanLike(d, env, overrides));\n+    return defs!.map(d => humanizeDocumentSpanLike(d, env));\n   }\n });"
        },
        {
            "sha": "b17c869c8d1a511e7e2ca3ed993a1d8ba377cde3",
            "filename": "packages/language-service/ivy/testing/src/buffer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/000ec6be3c3bc0b44719a4d47467e56b4a771678/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "raw_url": "https://github.com/angular/angular/raw/000ec6be3c3bc0b44719a4d47467e56b4a771678/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts?ref=000ec6be3c3bc0b44719a4d47467e56b4a771678",
            "patch": "@@ -84,4 +84,8 @@ export class OpenBuffer {\n   getQuickInfoAtPosition() {\n     return this.ngLS.getQuickInfoAtPosition(this.scriptInfo.fileName, this._cursor);\n   }\n+\n+  getTypeDefinitionAtPosition() {\n+    return this.ngLS.getTypeDefinitionAtPosition(this.scriptInfo.fileName, this._cursor);\n+  }\n }"
        },
        {
            "sha": "b79d903916a709f649dd2163db79caecf36979ad",
            "filename": "packages/language-service/ivy/testing/src/project.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 2,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/000ec6be3c3bc0b44719a4d47467e56b4a771678/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "raw_url": "https://github.com/angular/angular/raw/000ec6be3c3bc0b44719a4d47467e56b4a771678/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts?ref=000ec6be3c3bc0b44719a4d47467e56b4a771678",
            "patch": "@@ -7,8 +7,8 @@\n  */\n \n import {StrictTemplateOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n-import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n-import {OptimizeFor} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem, getSourceFileOrError} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {OptimizeFor, TemplateTypeChecker} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n import {LanguageService} from '../../language_service';\n import {OpenBuffer} from './buffer';\n@@ -156,4 +156,31 @@ export class Project {\n \n     this.ngLS.compilerFactory.registerLastKnownProgram();\n   }\n+\n+  expectNoTemplateDiagnostics(projectFileName: string, className: string): void {\n+    const program = this.tsLS.getProgram();\n+    if (program === undefined) {\n+      throw new Error(`Expected to get a ts.Program`);\n+    }\n+    const fileName = absoluteFrom(`/${this.name}/${projectFileName}`);\n+    const sf = getSourceFileOrError(program, fileName);\n+    const component = getClassOrError(sf, className);\n+\n+    const diags = this.getTemplateTypeChecker().getDiagnosticsForComponent(component);\n+    this.ngLS.compilerFactory.registerLastKnownProgram();\n+    expect(diags.map(diag => diag.messageText)).toEqual([]);\n+  }\n+\n+  getTemplateTypeChecker(): TemplateTypeChecker {\n+    return this.ngLS.compilerFactory.getOrCreate().getTemplateTypeChecker();\n+  }\n }\n+\n+function getClassOrError(sf: ts.SourceFile, name: string): ts.ClassDeclaration {\n+  for (const stmt of sf.statements) {\n+    if (ts.isClassDeclaration(stmt) && stmt.name !== undefined && stmt.name.text === name) {\n+      return stmt;\n+    }\n+  }\n+  throw new Error(`Class ${name} not found in file: ${sf.fileName}: ${sf.text}`);\n+}\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 53,
        "deletions": 27
    }
}