{
    "author": "gkalpak",
    "message": "fix(ngcc): do not fail hard when a format-path points to a non-existing or empty file (#40985)\n\nPreviously, when `ngcc` encountered an entry-point with a format-path\nthat pointed to a non-existing or empty file it would throw an error and\nstop processing the remaining tasks.\n\nIn the past, we used to ignore such format-paths and continue processing\nthe rest of the tasks ([see code][1]). This was changed to a hard\nfailure in 2954d1b5ca212548c5c4634a30ce773cfe3b9410. Looking at the code\nhistory, the reason for changing the behavior was an (incorrect)\nassumption that the condition could not fail. This assumption failed to\ntake into account the case where a 3rd-party library has an invalid\nformat-path in its `package.json`. This is an issue with the library,\nbut it should not prevent `ngcc` from processing other\npackages/entry-points/formats.\n\nThis commit fixes this by reporting the task as failed but not throwing\nan error, thus allowing `ngcc` to continue processing other tasks.\n\n[1]: https://github.com/angular/angular/blob/3077c9a1f89c5bd75fb96c16e/packages/compiler-cli/ngcc/src/main.ts#L124\n\nFixes #40965\n\nPR Close #40985",
    "sha": "284af7308b1e52efe5ef445ae8c3d6231e9dd633",
    "files": [
        {
            "sha": "3b2005d60c011c201266c8edf8f7db1a0efd8909",
            "filename": "packages/compiler-cli/ngcc/src/execution/create_compile_function.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/284af7308b1e52efe5ef445ae8c3d6231e9dd633/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcreate_compile_function.ts",
            "raw_url": "https://github.com/angular/angular/raw/284af7308b1e52efe5ef445ae8c3d6231e9dd633/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcreate_compile_function.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcreate_compile_function.ts?ref=284af7308b1e52efe5ef445ae8c3d6231e9dd633",
            "patch": "@@ -46,12 +46,13 @@ export function getCreateCompileFn(\n       // (i.e. they are defined in `entryPoint.packageJson`). Furthermore, they are also guaranteed\n       // to be among `SUPPORTED_FORMAT_PROPERTIES`.\n       // Based on the above, `formatPath` should always be defined and `getEntryPointFormat()`\n-      // should always return a format here (and not `undefined`).\n+      // should always return a format here (and not `undefined`) unless `formatPath` points to a\n+      // missing or empty file.\n       if (!formatPath || !format) {\n-        // This should never happen.\n-        throw new Error(\n-            `Invariant violated: No format-path or format for ${entryPoint.path} : ` +\n-            `${formatProperty} (formatPath: ${formatPath} | format: ${format})`);\n+        onTaskCompleted(\n+            task, TaskProcessingOutcome.Failed,\n+            `property \\`${formatProperty}\\` pointing to a missing or empty file: ${formatPath}`);\n+        return;\n       }\n \n       logger.info(`Compiling ${entryPoint.name} : ${formatProperty} as ${format}`);"
        },
        {
            "sha": "0fa0081084d9bf77ca40043a260f9799414f832b",
            "filename": "packages/compiler-cli/ngcc/src/execution/tasks/completion.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/284af7308b1e52efe5ef445ae8c3d6231e9dd633/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Ftasks%2Fcompletion.ts",
            "raw_url": "https://github.com/angular/angular/raw/284af7308b1e52efe5ef445ae8c3d6231e9dd633/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Ftasks%2Fcompletion.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Ftasks%2Fcompletion.ts?ref=284af7308b1e52efe5ef445ae8c3d6231e9dd633",
            "patch": "@@ -82,8 +82,8 @@ export function createLogErrorHandler(\n }\n \n function createErrorMessage(fs: ReadonlyFileSystem, task: Task, message: string|null): string {\n-  const jsFormat =\n-      `${task.formatProperty} as ${getEntryPointFormat(fs, task.entryPoint, task.formatProperty)}`;\n+  const jsFormat = `\\`${task.formatProperty}\\` as ${\n+      getEntryPointFormat(fs, task.entryPoint, task.formatProperty) ?? 'unknown format'}`;\n   const format = task.typingsOnly ? `typings only using ${jsFormat}` : jsFormat;\n   message = message !== null ? ` due to ${message}` : '';\n   return `Failed to compile entry-point ${task.entryPoint.name} (${format})` + message;"
        },
        {
            "sha": "657e70592b010312eef011aa19907f15becb9a70",
            "filename": "packages/compiler-cli/ngcc/test/integration/ngcc_spec.ts",
            "status": "modified",
            "additions": 82,
            "deletions": 3,
            "changes": 85,
            "blob_url": "https://github.com/angular/angular/blob/284af7308b1e52efe5ef445ae8c3d6231e9dd633/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/284af7308b1e52efe5ef445ae8c3d6231e9dd633/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts?ref=284af7308b1e52efe5ef445ae8c3d6231e9dd633",
            "patch": "@@ -154,6 +154,85 @@ runInEachFileSystem(() => {\n       expect(loadPackage('local-package', _('/dist')).__processed_by_ivy_ngcc__).toBeUndefined();\n     });\n \n+    it('should report an error, if one of the format-paths is missing or empty', () => {\n+      loadTestFiles([\n+        // A package with a format-path (main) that points to a missing file.\n+        {\n+          name: _(`/dist/pkg-with-missing-main/package.json`),\n+          contents: `\n+            {\n+              \"name\": \"pkg-with-missing-main\",\n+              \"typings\": \"./index.d.ts\",\n+              \"es2015\": \"./index-es2015.js\",\n+              \"fesm5\": \"./index-es5.js\",\n+              \"main\": \"./index-missing.js\"\n+            }\n+          `,\n+        },\n+        {\n+          name: _('/dist/pkg-with-missing-main/index.d.ts'),\n+          contents: 'export type DummyData = boolean;'\n+        },\n+        {\n+          name: _('/dist/pkg-with-missing-main/index-es2015.js'),\n+          contents: 'var DUMMY_DATA = true;'\n+        },\n+        {name: _('/dist/pkg-with-missing-main/index-es5.js'), contents: 'var DUMMY_DATA = true;'},\n+        {name: _('/dist/pkg-with-missing-main/index.metadata.json'), contents: 'DUMMY DATA'},\n+\n+        // A package with a format-path (main) that points to an empty file.\n+        {\n+          name: _(`/dist/pkg-with-empty-main/package.json`),\n+          contents: `\n+            {\n+              \"name\": \"pkg-with-empty-main\",\n+              \"typings\": \"./index.d.ts\",\n+              \"es2015\": \"./index-es2015.js\",\n+              \"fesm5\": \"./index-es5.js\",\n+              \"main\": \"./index-empty.js\"\n+            }\n+          `,\n+        },\n+        {\n+          name: _('/dist/pkg-with-empty-main/index.d.ts'),\n+          contents: 'export type DummyData = boolean;'\n+        },\n+        {name: _('/dist/pkg-with-empty-main/index-empty.js'), contents: ''},\n+        {name: _('/dist/pkg-with-empty-main/index-es2015.js'), contents: 'var DUMMY_DATA = true;'},\n+        {name: _('/dist/pkg-with-empty-main/index-es5.js'), contents: 'var DUMMY_DATA = true;'},\n+        {name: _('/dist/pkg-with-empty-main/index.metadata.json'), contents: 'DUMMY DATA'},\n+      ]);\n+\n+      const logger = new MockLogger();\n+      mainNgcc({\n+        basePath: '/dist',\n+        propertiesToConsider: ['es2015', 'main', 'fesm5'],\n+        logger,\n+      });\n+\n+      expect(loadPackage('pkg-with-missing-main', _('/dist')).__processed_by_ivy_ngcc__).toEqual({\n+        es2015: jasmine.any(String),\n+        fesm5: jasmine.any(String),\n+        typings: jasmine.any(String),\n+      });\n+      expect(loadPackage('pkg-with-empty-main', _('/dist')).__processed_by_ivy_ngcc__).toEqual({\n+        es2015: jasmine.any(String),\n+        fesm5: jasmine.any(String),\n+        typings: jasmine.any(String),\n+      });\n+\n+      expect(logger.logs.error).toEqual([\n+        [\n+          'Failed to compile entry-point pkg-with-missing-main (`main` as unknown format) due to ' +\n+              'property `main` pointing to a missing or empty file: ./index-missing.js',\n+        ],\n+        [\n+          'Failed to compile entry-point pkg-with-empty-main (`main` as unknown format) due to ' +\n+              'property `main` pointing to a missing or empty file: ./index-empty.js',\n+        ],\n+      ]);\n+    });\n+\n     it('should generate correct metadata for decorated getter/setter properties', () => {\n       setupAngularCoreEsm5();\n       compileIntoFlatEs5Package('test-package', {\n@@ -573,7 +652,7 @@ runInEachFileSystem(() => {\n            fail('should have thrown');\n          } catch (e) {\n            expect(e.message).toContain(\n-               'Failed to compile entry-point test-package (esm2015 as esm2015) due to compilation errors:');\n+               'Failed to compile entry-point test-package (`esm2015` as esm2015) due to compilation errors:');\n            expect(e.message).toContain('NG1010');\n            expect(e.message).toContain('selector must be a string');\n          }\n@@ -1552,7 +1631,7 @@ runInEachFileSystem(() => {\n              fail('should have thrown');\n            } catch (e) {\n              expect(e.message).toContain(\n-                 'Failed to compile entry-point fatal-error (es2015 as esm2015) due to compilation errors:');\n+                 'Failed to compile entry-point fatal-error (`es2015` as esm2015) due to compilation errors:');\n              expect(e.message).toContain('NG2001');\n              expect(e.message).toContain('component is missing a template');\n            }\n@@ -1630,7 +1709,7 @@ runInEachFileSystem(() => {\n            expect(logger.logs.error.length).toEqual(1);\n            const message = logger.logs.error[0][0];\n            expect(message).toContain(\n-               'Failed to compile entry-point fatal-error (es2015 as esm2015) due to compilation errors:');\n+               'Failed to compile entry-point fatal-error (`es2015` as esm2015) due to compilation errors:');\n            expect(message).toContain('NG2001');\n            expect(message).toContain('component is missing a template');\n "
        }
    ],
    "stats": {
        "total": 100,
        "additions": 90,
        "deletions": 10
    }
}