{
    "author": "atscott",
    "message": "feat(language-service): add command for getting components for a template file (#40655)\n\nThis commit adds a feature to the Angular Language Service that enables\ngetting the locations for components that use a template file.\n\nPart of https://github.com/angular/vscode-ng-language-service/issues/1081\n\nPR Close #40655",
    "sha": "5cde4ad5916220135b6063973d6098dfe5fbc405",
    "files": [
        {
            "sha": "ad5a203aeafde59ef760d7c0c4ed82483f3641b9",
            "filename": "packages/language-service/api.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/5cde4ad5916220135b6063973d6098dfe5fbc405/packages%2Flanguage-service%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/5cde4ad5916220135b6063973d6098dfe5fbc405/packages%2Flanguage-service%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fapi.ts?ref=5cde4ad5916220135b6063973d6098dfe5fbc405",
            "patch": "@@ -33,10 +33,13 @@ export type GetTcbResponse = {\n   selections: ts.TextSpan[],\n }|undefined;\n \n+export type GetComponentLocationsForTemplateResponse = ts.DocumentSpan[];\n+\n /**\n  * `NgLanguageService` describes an instance of an Angular language service,\n  * whose API surface is a strict superset of TypeScript's language service.\n  */\n export interface NgLanguageService extends ts.LanguageService {\n   getTcb(fileName: string, position: number): GetTcbResponse;\n+  getComponentLocationsForTemplate(fileName: string): GetComponentLocationsForTemplateResponse;\n }"
        },
        {
            "sha": "7f6a753595005787acea679f5fa927e448da1ea8",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/5cde4ad5916220135b6063973d6098dfe5fbc405/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/5cde4ad5916220135b6063973d6098dfe5fbc405/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=5cde4ad5916220135b6063973d6098dfe5fbc405",
            "patch": "@@ -11,11 +11,13 @@ import {CompilerOptions, ConfigurationHost, readConfiguration} from '@angular/co\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {ErrorCode, ngErrorCode} from '@angular/compiler-cli/src/ngtsc/diagnostics';\n import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {isNamedClassDeclaration} from '@angular/compiler-cli/src/ngtsc/reflection';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import {findFirstMatchingNode} from '@angular/compiler-cli/src/ngtsc/typecheck/src/comments';\n import * as ts from 'typescript/lib/tsserverlibrary';\n-import {GetTcbResponse} from '../api';\n+\n+import {GetComponentLocationsForTemplateResponse, GetTcbResponse} from '../api';\n \n import {LanguageServiceAdapter, LSParseConfigHost} from './adapters';\n import {CompilerFactory} from './compiler_factory';\n@@ -200,6 +202,29 @@ export class LanguageService {\n     return result;\n   }\n \n+  getComponentLocationsForTemplate(fileName: string): GetComponentLocationsForTemplateResponse {\n+    return this.withCompiler<GetComponentLocationsForTemplateResponse>((compiler) => {\n+      const components = compiler.getComponentsWithTemplateFile(fileName);\n+      const componentDeclarationLocations: ts.DocumentSpan[] =\n+          Array.from(components.values()).map(c => {\n+            let contextSpan: ts.TextSpan|undefined = undefined;\n+            let textSpan: ts.TextSpan;\n+            if (isNamedClassDeclaration(c)) {\n+              textSpan = ts.createTextSpanFromBounds(c.name.getStart(), c.name.getEnd());\n+              contextSpan = ts.createTextSpanFromBounds(c.getStart(), c.getEnd());\n+            } else {\n+              textSpan = ts.createTextSpanFromBounds(c.getStart(), c.getEnd());\n+            }\n+            return {\n+              fileName: c.getSourceFile().fileName,\n+              textSpan,\n+              contextSpan,\n+            };\n+          });\n+      return componentDeclarationLocations;\n+    });\n+  }\n+\n   getTcb(fileName: string, position: number): GetTcbResponse {\n     return this.withCompiler<GetTcbResponse>(compiler => {\n       const templateInfo = getTemplateInfoAtPosition(fileName, position, compiler);"
        },
        {
            "sha": "9acb7679e30dc4d74f4aa9d95c80a2f9ac9265cb",
            "filename": "packages/language-service/ivy/ts_plugin.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/5cde4ad5916220135b6063973d6098dfe5fbc405/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/5cde4ad5916220135b6063973d6098dfe5fbc405/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts?ref=5cde4ad5916220135b6063973d6098dfe5fbc405",
            "patch": "@@ -7,7 +7,9 @@\n  */\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n-import {GetTcbResponse, NgLanguageService} from '../api';\n+\n+import {GetComponentLocationsForTemplateResponse, GetTcbResponse, NgLanguageService} from '../api';\n+\n import {LanguageService} from './language_service';\n \n export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n@@ -132,6 +134,14 @@ export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n     return ngLS.getTcb(fileName, position);\n   }\n \n+  /**\n+   * Given an external template, finds the associated components that use it as a `templateUrl`.\n+   */\n+  function getComponentLocationsForTemplate(fileName: string):\n+      GetComponentLocationsForTemplateResponse {\n+    return ngLS.getComponentLocationsForTemplate(fileName);\n+  }\n+\n   return {\n     ...tsLS,\n     getSemanticDiagnostics,\n@@ -146,6 +156,7 @@ export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n     getCompletionEntrySymbol,\n     getTcb,\n     getCompilerOptionsDiagnostics,\n+    getComponentLocationsForTemplate,\n   };\n }\n "
        },
        {
            "sha": "671e811e8100b664d4e92f0ecd41873d788baa53",
            "filename": "packages/language-service/src/ts_plugin.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/5cde4ad5916220135b6063973d6098dfe5fbc405/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/5cde4ad5916220135b6063973d6098dfe5fbc405/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts?ref=5cde4ad5916220135b6063973d6098dfe5fbc405",
            "patch": "@@ -141,6 +141,11 @@ export function create(info: tss.server.PluginCreateInfo): NgLanguageService {\n     return undefined;\n   }\n \n+  function getComponentLocationsForTemplate(fileName: string) {\n+    // Not implemented in VE Language Service\n+    return [];\n+  }\n+\n   return {\n     // First clone the original TS language service\n     ...tsLS,\n@@ -154,5 +159,6 @@ export function create(info: tss.server.PluginCreateInfo): NgLanguageService {\n     getReferencesAtPosition,\n     findRenameLocations,\n     getTcb,\n+    getComponentLocationsForTemplate,\n   };\n }"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 47,
        "deletions": 2
    }
}