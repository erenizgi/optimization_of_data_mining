{
    "author": "dylhunn",
    "message": "fix(forms): Make some minor fixups for forward-compatibility with typed forms. (#44540)\n\nMake the following fixes:\n* When submitting the entire migration in a disabled state, I commented out more code than strictly required\n* Responding to some final review comments caused two conditions to become flipped\n* Always use explicit checks instead of boolean corecion\n* Fix one missed any cast in a test case\n\nPR Close #44540",
    "sha": "f7aa937cac0ad315e1012770aa1da97476aced54",
    "files": [
        {
            "sha": "4bf74de3fb8d0573fd9adb2661eb49a30112b331",
            "filename": "packages/core/schematics/migrations.json",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "raw_url": "https://github.com/angular/angular/raw/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations.json?ref=f7aa937cac0ad315e1012770aa1da97476aced54",
            "patch": "@@ -19,6 +19,11 @@\n       \"version\": \"14.0.0-beta\",\n       \"description\": \"As of Angular version 13, `entryComponents` are no longer necessary.\",\n       \"factory\": \"./migrations/entry-components/index\"\n+    },\n+    \"migration-v14-typed-forms\": {\n+      \"version\": \"9999.0.0\",\n+      \"description\": \"Experimental migration that adds <any>s for Typed Forms.\",\n+      \"factory\": \"./migrations/typed-forms/index\"\n     }\n   }\n }"
        },
        {
            "sha": "19cef67bd005dfaadab9e544330cba7c28ec377b",
            "filename": "packages/core/schematics/migrations/google3/typedFormsRule.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FtypedFormsRule.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FtypedFormsRule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FtypedFormsRule.ts?ref=f7aa937cac0ad315e1012770aa1da97476aced54",
            "patch": "@@ -22,7 +22,7 @@ export class Rule extends Rules.TypedRule {\n     const failures: RuleFailure[] = [];\n \n     // If no relevant classes are imported, we can exit early.\n-    if (controlClassImports.length === 0 && formBuilderImport !== null) return failures;\n+    if (controlClassImports.length === 0 && formBuilderImport === null) return failures;\n \n     // For each control class, migrate all of its uses.\n     for (const importSpecifier of controlClassImports) {\n@@ -39,9 +39,9 @@ export class Rule extends Rules.TypedRule {\n     }\n \n     // Add the any symbol used by the migrated calls.\n-    if (getAnyImport(sourceFile) !== null) {\n+    if (getAnyImport(sourceFile) === null) {\n       const firstValidFormsImport =\n-          [...controlClassImports, formBuilderImport].sort().filter(i => i)[0]!;\n+          [...controlClassImports, formBuilderImport].sort().filter(i => i !== null)[0]!;\n       failures.push(this.getImportFailure(firstValidFormsImport, sourceFile));\n     }\n "
        },
        {
            "sha": "62496cea962dd99f646091d102a6d196cf1dc917",
            "filename": "packages/core/schematics/migrations/typed-forms/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fcore%2Fschematics%2Fmigrations%2Ftyped-forms%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fcore%2Fschematics%2Fmigrations%2Ftyped-forms%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Ftyped-forms%2Findex.ts?ref=f7aa937cac0ad315e1012770aa1da97476aced54",
            "patch": "@@ -43,7 +43,7 @@ function runTypedFormsMigration(tree: Tree, tsconfigPath: string, basePath: stri\n     const formBuilderImport = getFormBuilderImport(sourceFile);\n \n     // If no relevant classes are imported, we can exit early.\n-    if (controlClassImports.length === 0 && formBuilderImport !== null) return;\n+    if (controlClassImports.length === 0 && formBuilderImport === null) return;\n \n     const update = tree.beginUpdate(relative(basePath, sourceFile.fileName));\n \n@@ -62,7 +62,7 @@ function runTypedFormsMigration(tree: Tree, tsconfigPath: string, basePath: stri\n     }\n \n     // Add the any symbol used by the migrated calls.\n-    if (getAnyImport(sourceFile) !== null) {\n+    if (getAnyImport(sourceFile) === null) {\n       const firstValidFormsImport =\n           [...controlClassImports, formBuilderImport].sort().filter(i => i !== null)[0]!;\n       insertAnyImport(update, firstValidFormsImport);"
        },
        {
            "sha": "f48632e2276163659680e10bae3ae49206099bcc",
            "filename": "packages/core/schematics/test/google3/typed_forms_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 13,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fcore%2Fschematics%2Ftest%2Fgoogle3%2Ftyped_forms_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fcore%2Fschematics%2Ftest%2Fgoogle3%2Ftyped_forms_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Fgoogle3%2Ftyped_forms_spec.ts?ref=f7aa937cac0ad315e1012770aa1da97476aced54",
            "patch": "@@ -13,9 +13,6 @@ import {Configuration, Linter} from 'tslint';\n \n const anySymbolName = 'AnyForUntypedForms';\n \n-// Tests disabled, as the migration is currently disabled in package.json.\n-/*\n-\n describe('Google3 typedForms TSLint rule', () => {\n   const rulesDirectory = dirname(require.resolve('../../migrations/google3/typedFormsRule'));\n \n@@ -91,8 +88,7 @@ describe('Google3 typedForms TSLint rule', () => {\n   it('should migrate a complete example', () => {\n     writeFile('/index.ts', `\n       import { Component } from '@angular/core';\n-      import { AbstractControl, FormArray, FormBuilder, FormControl as FC, FormGroup } from\n-'@angular/forms';\n+      import { AbstractControl, FormArray, FormBuilder, FormControl as FC, FormGroup } from '@angular/forms';\n \n       @Component({template: ''})\n       export class MyComponent {\n@@ -114,13 +110,13 @@ describe('Google3 typedForms TSLint rule', () => {\n     const linter = runTSLint(true);\n \n     [`import { ${\n-         anySymbolName}, AbstractControl, FormArray, FormBuilder, FormControl as FC, FormGroup }\n-from '@angular/forms';`, `private _control = new FC<${anySymbolName}>(42)`, `private _group = new\n-FormGroup<${anySymbolName}>({})`, `private _array = new FormArray<${anySymbolName}[]>([])`, `const\n-fc2 = new FC<${anySymbolName}>(0)`, `const c = this.fb.control<${anySymbolName}>(42)`, `const g =\n-this.fb.group<${anySymbolName}>({one: this.fb.control<${anySymbolName}>('')})`, `const a =\n-this.fb.array<${anySymbolName}[]>([42])`] .forEach(t => expect(getFile(`/index.ts`)).toContain(t));\n+         anySymbolName}, AbstractControl, FormArray, FormBuilder, FormControl as FC, FormGroup } from '@angular/forms';`,\n+     `private _control = new FC<${anySymbolName}>(42)`,\n+     `private _group = new FormGroup<${anySymbolName}>({})`,\n+     `private _array = new FormArray<${anySymbolName}[]>([])`,\n+     `const fc2 = new FC<${anySymbolName}>(0)`, `const c = this.fb.control<${anySymbolName}>(42)`,\n+     `const g = this.fb.group<${anySymbolName}>({one: this.fb.control<${anySymbolName}>('')})`,\n+     `const a = this.fb.array<${anySymbolName}[]>([42])`]\n+        .forEach(t => expect(getFile(`/index.ts`)).toContain(t));\n   });\n });\n-\n-*/"
        },
        {
            "sha": "1d833dcd739cabf10902f4c8feb2cdc1856e7047",
            "filename": "packages/core/schematics/test/typed_forms_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 14,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fcore%2Fschematics%2Ftest%2Ftyped_forms_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fcore%2Fschematics%2Ftest%2Ftyped_forms_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Ftyped_forms_spec.ts?ref=f7aa937cac0ad315e1012770aa1da97476aced54",
            "patch": "@@ -14,9 +14,6 @@ import * as shx from 'shelljs';\n \n const anySymbolName = 'AnyForUntypedForms';\n \n-// Tests disabled, as the migration is currently disabled in package.json.\n-/*\n-\n describe('Typed Forms migration', () => {\n   let runner: SchematicTestRunner;\n   let host: TempScopedNodeJsSyncHost;\n@@ -255,8 +252,7 @@ describe('Typed Forms migration', () => {\n     it('an integrated example', async () => {\n       writeFile('/index.ts', `\n            import { Component } from '@angular/core';\n-           import { AbstractControl, FormArray, FormBuilder, FormControl as FC, FormGroup } from\n-'@angular/forms';\n+           import { AbstractControl, FormArray, FormBuilder, FormControl as FC, FormGroup } from '@angular/forms';\n \n            @Component({template: ''})\n            export class MyComponent {\n@@ -276,13 +272,14 @@ describe('Typed Forms migration', () => {\n          `);\n       await runMigration();\n       [`import { ${\n-           anySymbolName}, AbstractControl, FormArray, FormBuilder, FormControl as FC, FormGroup }\n-from '@angular/forms';`, `private _control = new FC<${anySymbolName}>(42)`, `private _group = new\n-FormGroup<${anySymbolName}>({})`, `private _array = new FormArray<${anySymbolName}[]>([])`, `const\n-fc2 = new FC<${anySymbolName}>(0)`, `const c = this.fb.control<${anySymbolName}>(42)`, `const g =\n-this.fb.group<${anySymbolName}>({one: this.fb.control<${anySymbolName}>('')})`, `const a =\n-this.fb.array<${anySymbolName}[]>([42])`] .forEach(t =>\n-expect(tree.readContent('/index.ts')).toContain(t));\n+           anySymbolName}, AbstractControl, FormArray, FormBuilder, FormControl as FC, FormGroup } from '@angular/forms';`,\n+       `private _control = new FC<${anySymbolName}>(42)`,\n+       `private _group = new FormGroup<${anySymbolName}>({})`,\n+       `private _array = new FormArray<${anySymbolName}[]>([])`,\n+       `const fc2 = new FC<${anySymbolName}>(0)`, `const c = this.fb.control<${anySymbolName}>(42)`,\n+       `const g = this.fb.group<${anySymbolName}>({one: this.fb.control<${anySymbolName}>('')})`,\n+       `const a = this.fb.array<${anySymbolName}[]>([42])`]\n+          .forEach(t => expect(tree.readContent('/index.ts')).toContain(t));\n     });\n   });\n \n@@ -294,5 +291,3 @@ expect(tree.readContent('/index.ts')).toContain(t));\n     return runner.runSchematicAsync('migration-v14-typed-forms', {}, tree).toPromise();\n   }\n });\n-\n-*/"
        },
        {
            "sha": "596e84b59b69544dcb53eb1bd5dd021801fcf164",
            "filename": "packages/forms/test/form_array_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fforms%2Ftest%2Fform_array_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7aa937cac0ad315e1012770aa1da97476aced54/packages%2Fforms%2Ftest%2Fform_array_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Fform_array_spec.ts?ref=f7aa937cac0ad315e1012770aa1da97476aced54",
            "patch": "@@ -180,7 +180,7 @@ describe('FormArray', () => {\n     it('should work with nested form groups/arrays', () => {\n       a = new FormArray([\n         new FormGroup(\n-            {'c2': new FormControl('v2') as AbstractControl, 'c3': new FormControl('v3')}),\n+            {'c2': new FormControl('v2') as AbstractControl, 'c3': new FormControl('v3') as any}),\n         new FormArray([new FormControl('v4'), new FormControl('v5')])\n       ]);\n       a.at(0).get('c3')!.disable();"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 29,
        "deletions": 33
    }
}