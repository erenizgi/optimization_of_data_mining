{
    "author": "devversion",
    "message": "refactor(bazel): pass flat module out file reference to packager (#43431)\n\nIn preparation for using the partial compilation transition on the\npackager, we need to be able to have a reference to the flat module\nout file (that is used as \"index\" file for entry-point ng_module targets).\n\nWe need a reference to the file because with transitions applied, the\ninputs are not necessarily in the default `bazel-out` directory. The\npackager currently only guesses such paths (this worked most of the\ntime) but guessing the output directory with transitions will become\nimpossible.. so the paths need to be computed in a Bazel-idiomatic way.\nThis is more future-proof and correct (and more clean IMO).\n\nPR Close #43431",
    "sha": "e14d73b293a613a036a5dfedab2003b835f383f7",
    "files": [
        {
            "sha": "e851bc2bfc769eca7bbd4900523a8e7c8dc8f9c3",
            "filename": "packages/bazel/src/ng_module/ng_module.bzl",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/e14d73b293a613a036a5dfedab2003b835f383f7/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl",
            "raw_url": "https://github.com/angular/angular/raw/e14d73b293a613a036a5dfedab2003b835f383f7/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl?ref=e14d73b293a613a036a5dfedab2003b835f383f7",
            "patch": "@@ -179,6 +179,7 @@ def _expected_outs(ctx):\n     transpilation_infos = []\n     summary_files = []\n     metadata_files = []\n+    flat_module_out_prodmode_file = None\n \n     factory_basename_set = depset([_basename_of(ctx, src) for src in ctx.files.factories])\n \n@@ -253,13 +254,20 @@ def _expected_outs(ctx):\n \n     # We do this just when producing a flat module index for a publishable ng_module\n     if _should_produce_flat_module_outs(ctx):\n-        flat_module_out = _flat_module_out_file(ctx)\n-        devmode_js_files.append(ctx.actions.declare_file(\"%s.js\" % flat_module_out))\n-        closure_js_files.append(ctx.actions.declare_file(\"%s.mjs\" % flat_module_out))\n-        bundle_index_typings = ctx.actions.declare_file(\"%s.d.ts\" % flat_module_out)\n+        flat_module_out_name = _flat_module_out_file(ctx)\n+\n+        # Note: We keep track of the prodmode flat module output for `ng_packager` which\n+        # uses it as entry-point for producing FESM bundles.\n+        # TODO: Remove flat module from `ng_module` and detect package entry-point reliably\n+        # in Ivy. Related discussion: https://github.com/angular/angular/pull/36971#issuecomment-625282383.\n+        flat_module_out_prodmode_file = ctx.actions.declare_file(\"%s.mjs\" % flat_module_out_name)\n+\n+        closure_js_files.append(flat_module_out_prodmode_file)\n+        devmode_js_files.append(ctx.actions.declare_file(\"%s.js\" % flat_module_out_name))\n+        bundle_index_typings = ctx.actions.declare_file(\"%s.d.ts\" % flat_module_out_name)\n         declaration_files.append(bundle_index_typings)\n         if is_legacy_ngc:\n-            metadata_files.append(ctx.actions.declare_file(\"%s.metadata.json\" % flat_module_out))\n+            metadata_files.append(ctx.actions.declare_file(\"%s.metadata.json\" % flat_module_out_name))\n     else:\n         bundle_index_typings = None\n \n@@ -294,6 +302,7 @@ def _expected_outs(ctx):\n         i18n_messages = i18n_messages_files,\n         dev_perf_files = dev_perf_files,\n         prod_perf_files = prod_perf_files,\n+        flat_module_out_prodmode_file = flat_module_out_prodmode_file,\n     )\n \n # Determines if we need to generate View Engine shims (.ngfactory and .ngsummary files)\n@@ -670,7 +679,7 @@ def ng_module_impl(ctx, ts_compile_actions):\n             # Metadata files are only generated in the legacy ngc compiler.\n             metadata_file = outs.metadata[0] if is_legacy_ngc else None,\n             typings_file = outs.bundle_index_typings,\n-            flat_module_out_file = _flat_module_out_file(ctx),\n+            flat_module_out_prodmode_file = outs.flat_module_out_prodmode_file,\n         )\n \n     if outs.dts_bundle != None:"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 15,
        "deletions": 6
    }
}