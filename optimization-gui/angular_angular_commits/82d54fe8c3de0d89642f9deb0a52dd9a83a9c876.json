{
    "author": "JiaLiPassion",
    "message": "feat(zone.js): add jest fakeTimers support (#39016)\n\nClose #38851, support `jest` fakeTimers APIs' integration with `fakeAsync()`.\nAfter enable this feature, calling `jest.useFakeTimers()` will make all test\nrun into `fakeAsync()` automatically.\n\n```\nbeforeEach(() => {\n    jest.useFakeTimers('modern');\n  });\n  afterEach(() => {\n    jest.useRealTimers();\n  });\n\n  test('should run into fakeAsync() automatically', () => {\n    const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n    expect(fakeAsyncZoneSpec).toBeTruthy();\n  });\n```\n\nAlso there are mappings between `jest` and `zone` APIs.\n\n- `jest.runAllTicks()` will call `flushMicrotasks()`.\n- `jest.runAllTimers()` will call `flush()`.\n- `jest.advanceTimersByTime()` will call `tick()`\n- `jest.runOnlyPendingTimers()` will call `flushOnlyPendingTimers()`\n- `jest.advanceTimersToNextTimer()` will call `tickToNext()`\n- `jest.clearAllTimers()` will call `removeAllTimers()`\n- `jest.getTimerCount()` will call `getTimerCount()`\n\nPR Close #39016",
    "sha": "82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
    "files": [
        {
            "sha": "2625be7f821e010a866ad045a718dd9105ec96d4",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -749,7 +749,8 @@ jobs:\n              cp dist/bin/packages/zone.js/npm_package/bundles/zone-mix.umd.js ./packages/zone.js/test/extra/ &&\n              cp dist/bin/packages/zone.js/npm_package/bundles/zone-patch-electron.umd.js ./packages/zone.js/test/extra/ &&\n              yarn --cwd packages/zone.js electrontest\n-      - run: yarn --cwd packages/zone.js jesttest\n+      - run: yarn --cwd packages/zone.js jest:test\n+      - run: yarn --cwd packages/zone.js jest:nodetest\n       - run: yarn --cwd packages/zone.js/test/typings install --frozen-lockfile --non-interactive\n       - run: yarn --cwd packages/zone.js/test/typings test\n "
        },
        {
            "sha": "efe9b6a4339f4ce245502bfd72add5330045c2e4",
            "filename": "packages/zone.js/lib/jest/jest.ts",
            "status": "modified",
            "additions": 175,
            "deletions": 9,
            "changes": 184,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Flib%2Fjest%2Fjest.ts",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Flib%2Fjest%2Fjest.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fjest%2Fjest.ts?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -8,18 +8,13 @@\n \n 'use strict';\n \n-Zone.__load_patch('jest', (context: any, Zone: ZoneType) => {\n+Zone.__load_patch('jest', (context: any, Zone: ZoneType, api: _ZonePrivate) => {\n   if (typeof jest === 'undefined' || jest['__zone_patch__']) {\n     return;\n   }\n \n   jest['__zone_patch__'] = true;\n \n-\n-  if (typeof Zone === 'undefined') {\n-    throw new Error('Missing Zone.js');\n-  }\n-\n   const ProxyZoneSpec = (Zone as any)['ProxyZoneSpec'];\n   const SyncTestZoneSpec = (Zone as any)['SyncTestZoneSpec'];\n \n@@ -29,7 +24,8 @@ Zone.__load_patch('jest', (context: any, Zone: ZoneType) => {\n \n   const rootZone = Zone.current;\n   const syncZone = rootZone.fork(new SyncTestZoneSpec('jest.describe'));\n-  const proxyZone = rootZone.fork(new ProxyZoneSpec());\n+  const proxyZoneSpec = new ProxyZoneSpec();\n+  const proxyZone = rootZone.fork(proxyZoneSpec);\n \n   function wrapDescribeFactoryInZone(originalJestFn: Function) {\n     return function(this: unknown, ...tableArgs: any[]) {\n@@ -65,11 +61,20 @@ Zone.__load_patch('jest', (context: any, Zone: ZoneType) => {\n    * execute in a ProxyZone zone.\n    * This will run in the `proxyZone`.\n    */\n-  function wrapTestInZone(testBody: Function): Function {\n+  function wrapTestInZone(testBody: Function, isTestFunc = false): Function {\n     if (typeof testBody !== 'function') {\n       return testBody;\n     }\n     const wrappedFunc = function() {\n+      if ((Zone as any)[api.symbol('useFakeTimersCalled')] === true && testBody &&\n+          !(testBody as any).isFakeAsync) {\n+        // jest.useFakeTimers is called, run into fakeAsyncTest automatically.\n+        const fakeAsyncModule = (Zone as any)[Zone.__symbol__('fakeAsyncTest')];\n+        if (fakeAsyncModule && typeof fakeAsyncModule.fakeAsync === 'function') {\n+          testBody = fakeAsyncModule.fakeAsync(testBody);\n+        }\n+      }\n+      proxyZoneSpec.isTestFunc = isTestFunc;\n       return proxyZone.run(testBody, null, arguments as any);\n     };\n     // Update the length of wrappedFunc to be the same as the length of the testBody\n@@ -102,7 +107,7 @@ Zone.__load_patch('jest', (context: any, Zone: ZoneType) => {\n     }\n     context[Zone.__symbol__(methodName)] = originalJestFn;\n     context[methodName] = function(this: unknown, ...args: any[]) {\n-      args[1] = wrapTestInZone(args[1]);\n+      args[1] = wrapTestInZone(args[1], true);\n       return originalJestFn.apply(this, args);\n     };\n     context[methodName].each = wrapTestFactoryInZone((originalJestFn as any).each);\n@@ -125,4 +130,165 @@ Zone.__load_patch('jest', (context: any, Zone: ZoneType) => {\n       return originalJestFn.apply(this, args);\n     };\n   });\n+\n+  (Zone as any).patchJestObject = function patchJestObject(Timer: any, isModern = false) {\n+    // check whether currently the test is inside fakeAsync()\n+    function isPatchingFakeTimer() {\n+      const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+      return !!fakeAsyncZoneSpec;\n+    }\n+\n+    // check whether the current function is inside `test/it` or other methods\n+    // such as `describe/beforeEach`\n+    function isInTestFunc() {\n+      const proxyZoneSpec = Zone.current.get('ProxyZoneSpec');\n+      return proxyZoneSpec && proxyZoneSpec.isTestFunc;\n+    }\n+\n+    if (Timer[api.symbol('fakeTimers')]) {\n+      return;\n+    }\n+\n+    Timer[api.symbol('fakeTimers')] = true;\n+    // patch jest fakeTimer internal method to make sure no console.warn print out\n+    api.patchMethod(Timer, '_checkFakeTimers', delegate => {\n+      return function(self: any, args: any[]) {\n+        if (isPatchingFakeTimer()) {\n+          return true;\n+        } else {\n+          return delegate.apply(self, args);\n+        }\n+      }\n+    });\n+\n+    // patch useFakeTimers(), set useFakeTimersCalled flag, and make test auto run into fakeAsync\n+    api.patchMethod(Timer, 'useFakeTimers', delegate => {\n+      return function(self: any, args: any[]) {\n+        (Zone as any)[api.symbol('useFakeTimersCalled')] = true;\n+        if (isModern || isInTestFunc()) {\n+          return delegate.apply(self, args);\n+        }\n+        return self;\n+      }\n+    });\n+\n+    // patch useRealTimers(), unset useFakeTimers flag\n+    api.patchMethod(Timer, 'useRealTimers', delegate => {\n+      return function(self: any, args: any[]) {\n+        (Zone as any)[api.symbol('useFakeTimersCalled')] = false;\n+        if (isModern || isInTestFunc()) {\n+          return delegate.apply(self, args);\n+        }\n+        return self;\n+      }\n+    });\n+\n+    // patch setSystemTime(), call setCurrentRealTime() in the fakeAsyncTest\n+    api.patchMethod(Timer, 'setSystemTime', delegate => {\n+      return function(self: any, args: any[]) {\n+        const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+        if (fakeAsyncZoneSpec && isPatchingFakeTimer()) {\n+          fakeAsyncZoneSpec.setCurrentRealTime(args[0]);\n+        } else {\n+          return delegate.apply(self, args);\n+        }\n+      }\n+    });\n+\n+    // patch getSystemTime(), call getCurrentRealTime() in the fakeAsyncTest\n+    api.patchMethod(Timer, 'getRealSystemTime', delegate => {\n+      return function(self: any, args: any[]) {\n+        const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+        if (fakeAsyncZoneSpec && isPatchingFakeTimer()) {\n+          return fakeAsyncZoneSpec.getCurrentRealTime(args[0]);\n+        } else {\n+          return delegate.apply(self, args);\n+        }\n+      }\n+    });\n+\n+    // patch runAllTicks(), run all microTasks inside fakeAsync\n+    api.patchMethod(Timer, 'runAllTicks', delegate => {\n+      return function(self: any, args: any[]) {\n+        const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+        if (fakeAsyncZoneSpec) {\n+          fakeAsyncZoneSpec.flushMicrotasks();\n+        } else {\n+          return delegate.apply(self, args);\n+        }\n+      }\n+    });\n+\n+    // patch runAllTimers(), run all macroTasks inside fakeAsync\n+    api.patchMethod(Timer, 'runAllTimers', delegate => {\n+      return function(self: any, args: any[]) {\n+        const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+        if (fakeAsyncZoneSpec) {\n+          fakeAsyncZoneSpec.flush(100, true);\n+        } else {\n+          return delegate.apply(self, args);\n+        }\n+      }\n+    });\n+\n+    // patch advanceTimersByTime(), call tick() in the fakeAsyncTest\n+    api.patchMethod(Timer, 'advanceTimersByTime', delegate => {\n+      return function(self: any, args: any[]) {\n+        const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+        if (fakeAsyncZoneSpec) {\n+          fakeAsyncZoneSpec.tick(args[0]);\n+        } else {\n+          return delegate.apply(self, args);\n+        }\n+      }\n+    });\n+\n+    // patch runOnlyPendingTimers(), call flushOnlyPendingTimers() in the fakeAsyncTest\n+    api.patchMethod(Timer, 'runOnlyPendingTimers', delegate => {\n+      return function(self: any, args: any[]) {\n+        const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+        if (fakeAsyncZoneSpec) {\n+          fakeAsyncZoneSpec.flushOnlyPendingTimers();\n+        } else {\n+          return delegate.apply(self, args);\n+        }\n+      }\n+    });\n+\n+    // patch advanceTimersToNextTimer(), call tickToNext() in the fakeAsyncTest\n+    api.patchMethod(Timer, 'advanceTimersToNextTimer', delegate => {\n+      return function(self: any, args: any[]) {\n+        const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+        if (fakeAsyncZoneSpec) {\n+          fakeAsyncZoneSpec.tickToNext(args[0]);\n+        } else {\n+          return delegate.apply(self, args);\n+        }\n+      }\n+    });\n+\n+    // patch clearAllTimers(), call removeAllTimers() in the fakeAsyncTest\n+    api.patchMethod(Timer, 'clearAllTimers', delegate => {\n+      return function(self: any, args: any[]) {\n+        const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+        if (fakeAsyncZoneSpec) {\n+          fakeAsyncZoneSpec.removeAllTimers();\n+        } else {\n+          return delegate.apply(self, args);\n+        }\n+      }\n+    });\n+\n+    // patch getTimerCount(), call getTimerCount() in the fakeAsyncTest\n+    api.patchMethod(Timer, 'getTimerCount', delegate => {\n+      return function(self: any, args: any[]) {\n+        const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+        if (fakeAsyncZoneSpec) {\n+          return fakeAsyncZoneSpec.getTimerCount();\n+        } else {\n+          return delegate.apply(self, args);\n+        }\n+      }\n+    });\n+  }\n });"
        },
        {
            "sha": "29b22b5b5b317008968188e4c1ad9ea1d93c0f20",
            "filename": "packages/zone.js/lib/testing/fake-async.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Flib%2Ftesting%2Ffake-async.ts",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Flib%2Ftesting%2Ffake-async.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Ftesting%2Ffake-async.ts?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -52,7 +52,7 @@ Zone.__load_patch('fakeasync', (global: any, Zone: ZoneType, api: _ZonePrivate)\n    */\n   function fakeAsync(fn: Function): (...args: any[]) => any {\n     // Not using an arrow function to preserve context passed from call site\n-    return function(this: unknown, ...args: any[]) {\n+    const fakeAsyncFn: any = function(this: unknown, ...args: any[]) {\n       const proxyZoneSpec = ProxyZoneSpec.assertPresent();\n       if (Zone.current.get('FakeAsyncTestZoneSpec')) {\n         throw new Error('fakeAsync() calls can not be nested');\n@@ -93,6 +93,8 @@ Zone.__load_patch('fakeasync', (global: any, Zone: ZoneType, api: _ZonePrivate)\n         resetFakeAsyncZone();\n       }\n     };\n+    (fakeAsyncFn as any).isFakeAsync = true;\n+    return fakeAsyncFn;\n   }\n \n   function _getFakeAsyncZoneSpec(): any {"
        },
        {
            "sha": "76f6de53c091f46f9c4797a27bafd85a64f309a4",
            "filename": "packages/zone.js/lib/zone-spec/fake-async-test.ts",
            "status": "modified",
            "additions": 76,
            "deletions": 0,
            "changes": 76,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Flib%2Fzone-spec%2Ffake-async-test.ts",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Flib%2Fzone-spec%2Ffake-async-test.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fzone-spec%2Ffake-async-test.ts?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -92,6 +92,10 @@ class Scheduler {\n     this._currentRealTime = realTime;\n   }\n \n+  getRealSystemTime() {\n+    return OriginalDate.now();\n+  }\n+\n   scheduleFunction(cb: Function, delay: number, options?: {\n     args?: any[],\n     isPeriodic?: boolean,\n@@ -145,6 +149,27 @@ class Scheduler {\n     }\n   }\n \n+  removeAll(): void {\n+    this._schedulerQueue = [];\n+  }\n+\n+  getTimerCount(): number {\n+    return this._schedulerQueue.length;\n+  }\n+\n+  tickToNext(step: number = 1, doTick?: (elapsed: number) => void, tickOptions?: {\n+    processNewMacroTasksSynchronously: boolean\n+  }) {\n+    if (this._schedulerQueue.length < step) {\n+      return;\n+    }\n+    // Find the last task currently queued in the scheduler queue and tick\n+    // till that time.\n+    const startTime = this._currentTime;\n+    const targetTask = this._schedulerQueue[step - 1];\n+    this.tick(targetTask.endTime - startTime, doTick, tickOptions);\n+  }\n+\n   tick(millis: number = 0, doTick?: (elapsed: number) => void, tickOptions?: {\n     processNewMacroTasksSynchronously: boolean\n   }): void {\n@@ -212,6 +237,18 @@ class Scheduler {\n     }\n   }\n \n+  flushOnlyPendingTimers(doTick?: (elapsed: number) => void): number {\n+    if (this._schedulerQueue.length === 0) {\n+      return 0;\n+    }\n+    // Find the last task currently queued in the scheduler queue and tick\n+    // till that time.\n+    const startTime = this._currentTime;\n+    const lastTask = this._schedulerQueue[this._schedulerQueue.length - 1];\n+    this.tick(lastTask.endTime - startTime, doTick, {processNewMacroTasksSynchronously: false});\n+    return this._currentTime - startTime;\n+  }\n+\n   flush(limit = 20, flushPeriodic = false, doTick?: (elapsed: number) => void): number {\n     if (flushPeriodic) {\n       return this.flushPeriodic(doTick);\n@@ -401,6 +438,10 @@ class FakeAsyncTestZoneSpec implements ZoneSpec {\n     this._scheduler.setCurrentRealTime(realTime);\n   }\n \n+  getRealSystemTime() {\n+    return this._scheduler.getRealSystemTime();\n+  }\n+\n   static patchDate() {\n     if (!!global[Zone.__symbol__('disableDatePatching')]) {\n       // we don't want to patch global Date\n@@ -450,6 +491,20 @@ class FakeAsyncTestZoneSpec implements ZoneSpec {\n     FakeAsyncTestZoneSpec.resetDate();\n   }\n \n+  tickToNext(steps: number = 1, doTick?: (elapsed: number) => void, tickOptions: {\n+    processNewMacroTasksSynchronously: boolean\n+  } = {processNewMacroTasksSynchronously: true}): void {\n+    if (steps <= 0) {\n+      return;\n+    }\n+    FakeAsyncTestZoneSpec.assertInZone();\n+    this.flushMicrotasks();\n+    this._scheduler.tickToNext(steps, doTick, tickOptions);\n+    if (this._lastError !== null) {\n+      this._resetLastErrorAndThrow();\n+    }\n+  }\n+\n   tick(millis: number = 0, doTick?: (elapsed: number) => void, tickOptions: {\n     processNewMacroTasksSynchronously: boolean\n   } = {processNewMacroTasksSynchronously: true}): void {\n@@ -486,6 +541,27 @@ class FakeAsyncTestZoneSpec implements ZoneSpec {\n     return elapsed;\n   }\n \n+  flushOnlyPendingTimers(doTick?: (elapsed: number) => void): number {\n+    FakeAsyncTestZoneSpec.assertInZone();\n+    this.flushMicrotasks();\n+    const elapsed = this._scheduler.flushOnlyPendingTimers(doTick);\n+    if (this._lastError !== null) {\n+      this._resetLastErrorAndThrow();\n+    }\n+    return elapsed;\n+  }\n+\n+  removeAllTimers() {\n+    FakeAsyncTestZoneSpec.assertInZone();\n+    this._scheduler.removeAll();\n+    this.pendingPeriodicTimers = [];\n+    this.pendingTimers = [];\n+  }\n+\n+  getTimerCount() {\n+    return this._scheduler.getTimerCount() + this._microtasks.length;\n+  }\n+\n   // ZoneSpec implementation below.\n \n   name: string;"
        },
        {
            "sha": "f0b47294272512694b7014876b088f3a844d3879",
            "filename": "packages/zone.js/package.json",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Fpackage.json?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -13,15 +13,16 @@\n   \"devDependencies\": {\n     \"@types/node\": \"^10.9.4\",\n     \"domino\": \"2.1.2\",\n-    \"jest\": \"^25.1.0\",\n+    \"jest\": \"^26.4\",\n     \"mocha\": \"^3.1.2\",\n     \"mock-require\": \"3.0.3\",\n     \"promises-aplus-tests\": \"^2.1.2\",\n     \"typescript\": \"4.0.2\"\n   },\n   \"scripts\": {\n     \"electrontest\": \"cd test/extra && node electron.js\",\n-    \"jesttest\": \"jest --config ./test/jest/jest.config.js ./test/jest/jest.spec.js\",\n+    \"jest:test\": \"jest --config ./test/jest/jest.config.js ./test/jest/jest.spec.js\",\n+    \"jest:nodetest\": \"jest --config ./test/jest/jest.node.config.js ./test/jest/jest.spec.js\",\n     \"promisetest\": \"tsc -p . && node ./test/promise/promise-test.js\",\n     \"promisefinallytest\": \"tsc -p . && mocha ./test/promise/promise.finally.spec.js\"\n   },"
        },
        {
            "sha": "e69790b542ac02fba17b8a59228444ae9e4350d2",
            "filename": "packages/zone.js/test/jest/jest-zone-patch-fake-timer.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fjest-zone-patch-fake-timer.js",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fjest-zone-patch-fake-timer.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fjest%2Fjest-zone-patch-fake-timer.js?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -0,0 +1,6 @@\n+const exportFakeTimersToSandboxGlobal = function(jestEnv) {\n+  jestEnv.global.legacyFakeTimers = jestEnv.fakeTimers;\n+  jestEnv.global.modernFakeTimers = jestEnv.fakeTimersModern;\n+};\n+\n+module.exports = exportFakeTimersToSandboxGlobal;"
        },
        {
            "sha": "55ec80c9f9d63318c1927b50a0d075ea16adc0c5",
            "filename": "packages/zone.js/test/jest/jest-zone.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fjest-zone.js",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fjest-zone.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fjest%2Fjest-zone.js?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -1,2 +1,9 @@\n+const {legacyFakeTimers, modernFakeTimers} = global;\n+\n require('../../../../dist/bin/packages/zone.js/npm_package/dist/zone');\n require('../../../../dist/bin/packages/zone.js/npm_package/dist/zone-testing');\n+\n+if (Zone && Zone.patchJestObject) {\n+  Zone.patchJestObject(legacyFakeTimers);\n+  Zone.patchJestObject(modernFakeTimers);\n+}"
        },
        {
            "sha": "265fc1e021d72f4d550529fa06ee84389c693cb9",
            "filename": "packages/zone.js/test/jest/jest.config.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fjest.config.js",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fjest.config.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fjest%2Fjest.config.js?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -1,3 +1,4 @@\n module.exports = {\n-  setupFilesAfterEnv: ['./jest-zone.js']\n+  setupFilesAfterEnv: ['./jest-zone.js'],\n+  testEnvironment: './zone-jsdom-environment.js'\n };"
        },
        {
            "sha": "f4ea114aaaba3cce7c4bd0f527d921e21ab2ea79",
            "filename": "packages/zone.js/test/jest/jest.node.config.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fjest.node.config.js",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fjest.node.config.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fjest%2Fjest.node.config.js?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -0,0 +1,4 @@\n+module.exports = {\n+  setupFilesAfterEnv: ['./jest-zone.js'],\n+  testEnvironment: './zone-node-environment.js'\n+};"
        },
        {
            "sha": "f4a5f0bbf23e3888bd132555299225a93d74af3d",
            "filename": "packages/zone.js/test/jest/jest.spec.js",
            "status": "modified",
            "additions": 311,
            "deletions": 0,
            "changes": 311,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fjest.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fjest.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fjest%2Fjest.spec.js?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -100,3 +100,314 @@ test.each([[]])('test.each', () => {\n });\n \n test.todo('todo');\n+\n+function enableJestPatch() {\n+  global[Zone.__symbol__('fakeAsyncDisablePatchingFakeTimer')] = true;\n+}\n+\n+function disableJestPatch() {\n+  global[Zone.__symbol__('fakeAsyncDisablePatchingFakeTimer')] = false;\n+}\n+const {resetFakeAsyncZone, flushMicrotasks, discardPeriodicTasks, tick, flush, fakeAsync} =\n+    Zone[Zone.__symbol__('fakeAsyncTest')];\n+\n+describe('jest modern fakeTimers with zone.js fakeAsync', () => {\n+  beforeEach(() => {\n+    jest.useFakeTimers('modern');\n+  });\n+  afterEach(() => {\n+    jest.useRealTimers();\n+  });\n+\n+  test('should run into fakeAsync() automatically', () => {\n+    const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+    expect(fakeAsyncZoneSpec).toBeTruthy();\n+    expect(typeof fakeAsyncZoneSpec.tick).toEqual('function');\n+  });\n+\n+  test('setSystemTime should set FakeDate.currentRealTime', () => {\n+    const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+    const d = Date.now();\n+    jest.setSystemTime(d);\n+    expect(Date.now()).toEqual(d);\n+    for (let i = 0; i < 100000; i++) {\n+    }\n+    expect(fakeAsyncZoneSpec.getRealSystemTime()).not.toEqual(d);\n+  });\n+\n+  test('runAllTicks should run all microTasks', () => {\n+    const logs = [];\n+    Promise.resolve(1).then(v => logs.push(v));\n+    expect(logs).toEqual([]);\n+    jest.runAllTicks();\n+    expect(logs).toEqual([1]);\n+  });\n+\n+  test('runAllTimers should run all macroTasks', () => {\n+    const logs = [];\n+    Promise.resolve(1).then(v => logs.push(v));\n+    setTimeout(() => {logs.push('timeout')});\n+    const id = setInterval(() => {logs.push('interval')}, 100);\n+    expect(logs).toEqual([]);\n+    jest.runAllTimers();\n+    expect(logs).toEqual([1, 'timeout', 'interval']);\n+    clearInterval(id);\n+  });\n+\n+  test('advanceTimersByTime should act as tick', () => {\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout')}, 100);\n+    expect(logs).toEqual([]);\n+    jest.advanceTimersByTime(100);\n+    expect(logs).toEqual(['timeout']);\n+  });\n+\n+  test('runOnlyPendingTimers should run all macroTasks and ignore new spawn macroTasks', () => {\n+    const logs = [];\n+    Promise.resolve(1).then(v => logs.push(v));\n+    let nestedTimeoutId;\n+    setTimeout(() => {\n+      logs.push('timeout');\n+      nestedTimeoutId = setTimeout(() => {logs.push('new timeout')});\n+    });\n+    expect(logs).toEqual([]);\n+    jest.runOnlyPendingTimers();\n+    expect(logs).toEqual([1, 'timeout']);\n+    clearTimeout(nestedTimeoutId);\n+  });\n+\n+  test('advanceTimersToNextTimer should trigger correctly', () => {\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout1')}, 100);\n+    setTimeout(() => {logs.push('timeout11')}, 100);\n+    setTimeout(() => {logs.push('timeout2')}, 200);\n+    setTimeout(() => {logs.push('timeout3')}, 300);\n+    expect(logs).toEqual([]);\n+    jest.advanceTimersToNextTimer();\n+    expect(logs).toEqual(['timeout1', 'timeout11']);\n+    jest.advanceTimersToNextTimer(2);\n+    expect(logs).toEqual(['timeout1', 'timeout11', 'timeout2', 'timeout3']);\n+  });\n+\n+  test('clearAllTimers should clear all macroTasks', () => {\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout1')}, 100);\n+    setTimeout(() => {logs.push('timeout2')}, 200);\n+    setInterval(() => {logs.push('interval')}, 100);\n+    expect(logs).toEqual([]);\n+    jest.clearAllTimers();\n+    jest.advanceTimersByTime(300);\n+    expect(logs).toEqual([]);\n+  });\n+\n+  test('getTimerCount should get the count of macroTasks correctly', () => {\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout1')}, 100);\n+    setTimeout(() => {logs.push('timeout2')}, 200);\n+    setInterval(() => {logs.push('interval')}, 100);\n+    expect(logs).toEqual([]);\n+    expect(jest.getTimerCount()).toEqual(3);\n+    jest.clearAllTimers();\n+  });\n+});\n+\n+describe('jest legacy fakeTimers with zone.js fakeAsync', () => {\n+  beforeEach(() => {\n+    jest.useFakeTimers();\n+  });\n+  afterEach(() => {\n+    jest.useRealTimers();\n+  });\n+\n+  test('should run into fakeAsync() automatically', () => {\n+    const fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+    expect(fakeAsyncZoneSpec).toBeTruthy();\n+    expect(typeof fakeAsyncZoneSpec.tick).toEqual('function');\n+  });\n+\n+  test('setSystemTime should set FakeDate.currentRealTime', () => {\n+    const d = Date.now();\n+    expect(() => {jest.setSystemTime(d)}).toThrow();\n+  });\n+\n+  test('runAllTicks should run all microTasks', () => {\n+    const logs = [];\n+    Promise.resolve(1).then(v => logs.push(v));\n+    expect(logs).toEqual([]);\n+    jest.runAllTicks();\n+    expect(logs).toEqual([1]);\n+  });\n+\n+  test('runAllTimers should run all macroTasks', () => {\n+    const logs = [];\n+    Promise.resolve(1).then(v => logs.push(v));\n+    setTimeout(() => {logs.push('timeout')});\n+    const id = setInterval(() => {logs.push('interval')}, 100);\n+    expect(logs).toEqual([]);\n+    jest.runAllTimers();\n+    expect(logs).toEqual([1, 'timeout', 'interval']);\n+    clearInterval(id);\n+  });\n+\n+  test('advanceTimersByTime should act as tick', () => {\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout')}, 100);\n+    expect(logs).toEqual([]);\n+    jest.advanceTimersByTime(100);\n+    expect(logs).toEqual(['timeout']);\n+  });\n+\n+  test('runOnlyPendingTimers should run all macroTasks and ignore new spawn macroTasks', () => {\n+    const logs = [];\n+    Promise.resolve(1).then(v => logs.push(v));\n+    let nestedTimeoutId;\n+    setTimeout(() => {\n+      logs.push('timeout');\n+      nestedTimeoutId = setTimeout(() => {logs.push('new timeout')});\n+    });\n+    expect(logs).toEqual([]);\n+    jest.runOnlyPendingTimers();\n+    expect(logs).toEqual([1, 'timeout']);\n+    clearTimeout(nestedTimeoutId);\n+  });\n+\n+  test('advanceTimersToNextTimer should trigger correctly', () => {\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout1')}, 100);\n+    setTimeout(() => {logs.push('timeout11')}, 100);\n+    setTimeout(() => {logs.push('timeout2')}, 200);\n+    setTimeout(() => {logs.push('timeout3')}, 300);\n+    expect(logs).toEqual([]);\n+    jest.advanceTimersToNextTimer();\n+    expect(logs).toEqual(['timeout1', 'timeout11']);\n+    jest.advanceTimersToNextTimer(2);\n+    expect(logs).toEqual(['timeout1', 'timeout11', 'timeout2', 'timeout3']);\n+  });\n+\n+  test('clearAllTimers should clear all macroTasks', () => {\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout1')}, 100);\n+    setTimeout(() => {logs.push('timeout2')}, 200);\n+    setInterval(() => {logs.push('interval')}, 100);\n+    expect(logs).toEqual([]);\n+    jest.clearAllTimers();\n+    jest.advanceTimersByTime(300);\n+    expect(logs).toEqual([]);\n+  });\n+\n+  test('getTimerCount should get the count of macroTasks correctly', () => {\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout1')}, 100);\n+    setTimeout(() => {logs.push('timeout2')}, 200);\n+    setInterval(() => {logs.push('interval')}, 100);\n+    expect(logs).toEqual([]);\n+    expect(jest.getTimerCount()).toEqual(3);\n+    jest.clearAllTimers();\n+  });\n+});\n+\n+describe('jest fakeTimers inside test should call native delegate', () => {\n+  test('setSystemTime should set FakeDate.currentRealTime', () => {\n+    let fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+    expect(fakeAsyncZoneSpec).toBeFalsy();\n+    jest.useFakeTimers('modern');\n+    fakeAsyncZoneSpec = Zone.current.get('FakeAsyncTestZoneSpec');\n+    expect(fakeAsyncZoneSpec).toBeFalsy();\n+    const d = Date.now();\n+    jest.setSystemTime(d);\n+    for (let i = 0; i < 100000; i++) {\n+    }\n+    expect(jest.getRealSystemTime()).not.toEqual(d);\n+    jest.useRealTimers();\n+  });\n+\n+  test('runAllTicks should run all microTasks', () => {\n+    jest.useFakeTimers();\n+    const logs = [];\n+    process.nextTick(() => {logs.push(1)});\n+    expect(logs).toEqual([]);\n+    jest.runAllTicks();\n+    expect(logs).toEqual([1]);\n+    jest.useRealTimers();\n+  });\n+\n+  test('runAllTimers should run all macroTasks', () => {\n+    jest.useFakeTimers();\n+    const logs = [];\n+    process.nextTick(() => {logs.push(1)});\n+    setTimeout(() => {logs.push('timeout')});\n+    const id = setInterval(() => {\n+      logs.push('interval');\n+      clearInterval(id);\n+    }, 100);\n+    expect(logs).toEqual([]);\n+    jest.runAllTimers();\n+    expect(logs).toEqual([1, 'timeout', 'interval']);\n+    jest.useRealTimers();\n+  });\n+\n+  test('advanceTimersByTime should act as tick', () => {\n+    jest.useFakeTimers();\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout')}, 100);\n+    expect(logs).toEqual([]);\n+    jest.advanceTimersByTime(100);\n+    expect(logs).toEqual(['timeout']);\n+    jest.useRealTimers();\n+  });\n+\n+  test('runOnlyPendingTimers should run all macroTasks and ignore new spawn macroTasks', () => {\n+    jest.useFakeTimers();\n+    const logs = [];\n+    let nestedTimeoutId;\n+    setTimeout(() => {\n+      logs.push('timeout');\n+      nestedTimeoutId = setTimeout(() => {logs.push('new timeout')});\n+    });\n+    expect(logs).toEqual([]);\n+    jest.runOnlyPendingTimers();\n+    expect(logs).toEqual(['timeout']);\n+    clearTimeout(nestedTimeoutId);\n+    jest.useRealTimers();\n+  });\n+\n+  test('advanceTimersToNextTimer should trigger correctly', () => {\n+    jest.useFakeTimers();\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout1')}, 100);\n+    setTimeout(() => {logs.push('timeout11')}, 100);\n+    setTimeout(() => {logs.push('timeout2')}, 200);\n+    setTimeout(() => {logs.push('timeout3')}, 300);\n+    expect(logs).toEqual([]);\n+    jest.advanceTimersToNextTimer();\n+    expect(logs).toEqual(['timeout1', 'timeout11']);\n+    jest.advanceTimersToNextTimer(2);\n+    expect(logs).toEqual(['timeout1', 'timeout11', 'timeout2', 'timeout3']);\n+    jest.useRealTimers();\n+  });\n+\n+  test('clearAllTimers should clear all macroTasks', () => {\n+    jest.useFakeTimers();\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout1')}, 100);\n+    setTimeout(() => {logs.push('timeout2')}, 200);\n+    setInterval(() => {logs.push('interval')}, 100);\n+    expect(logs).toEqual([]);\n+    jest.clearAllTimers();\n+    jest.advanceTimersByTime(300);\n+    expect(logs).toEqual([]);\n+    jest.useRealTimers();\n+  });\n+\n+  test('getTimerCount should get the count of macroTasks correctly', () => {\n+    jest.useFakeTimers();\n+    const logs = [];\n+    setTimeout(() => {logs.push('timeout1')}, 100);\n+    setTimeout(() => {logs.push('timeout2')}, 200);\n+    setInterval(() => {logs.push('interval')}, 100);\n+    expect(logs).toEqual([]);\n+    expect(jest.getTimerCount()).toEqual(3);\n+    jest.clearAllTimers();\n+    jest.useRealTimers();\n+  });\n+});"
        },
        {
            "sha": "9fcfb0f9977ee2dd3b3538233b7775441e722349",
            "filename": "packages/zone.js/test/jest/zone-jsdom-environment.js",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fzone-jsdom-environment.js",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fzone-jsdom-environment.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fjest%2Fzone-jsdom-environment.js?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -0,0 +1,23 @@\n+const JsDOMEnvironment = require('jest-environment-jsdom');\n+const exportFakeTimersToSandboxGlobal = require('./jest-zone-patch-fake-timer');\n+\n+class ZoneJsDOMEnvironment extends JsDOMEnvironment {\n+  constructor(config) {\n+    super(config);\n+    exportFakeTimersToSandboxGlobal(this);\n+  }\n+\n+  async setup() {\n+    await super.setup();\n+  }\n+\n+  async teardown() {\n+    await super.teardown();\n+  }\n+\n+  runScript(script) {\n+    return super.runScript(script);\n+  }\n+}\n+\n+module.exports = ZoneJsDOMEnvironment;"
        },
        {
            "sha": "fd2c1e308173fb132d58f05fdb0949dde030922d",
            "filename": "packages/zone.js/test/jest/zone-node-environment.js",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fzone-node-environment.js",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Ftest%2Fjest%2Fzone-node-environment.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fjest%2Fzone-node-environment.js?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876",
            "patch": "@@ -0,0 +1,23 @@\n+const NodeEnvironment = require('jest-environment-node');\n+const exportFakeTimersToSandboxGlobal = require('./jest-zone-patch-fake-timer');\n+\n+class ZoneNodeEnvironment extends NodeEnvironment {\n+  constructor(config) {\n+    super(config);\n+    exportFakeTimersToSandboxGlobal(this);\n+  }\n+\n+  async setup() {\n+    await super.setup();\n+  }\n+\n+  async teardown() {\n+    await super.teardown();\n+  }\n+\n+  runScript(script) {\n+    return super.runScript(script);\n+  }\n+}\n+\n+module.exports = ZoneNodeEnvironment;"
        },
        {
            "sha": "6dc784f5669cf46d7ee705e12bafa2cc3080757a",
            "filename": "packages/zone.js/yarn.lock",
            "status": "added",
            "additions": 4065,
            "deletions": 0,
            "changes": 4065,
            "blob_url": "https://github.com/angular/angular/blob/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Fyarn.lock",
            "raw_url": "https://github.com/angular/angular/raw/82d54fe8c3de0d89642f9deb0a52dd9a83a9c876/packages%2Fzone.js%2Fyarn.lock",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Fyarn.lock?ref=82d54fe8c3de0d89642f9deb0a52dd9a83a9c876"
        }
    ],
    "stats": {
        "total": 4714,
        "additions": 4700,
        "deletions": 14
    }
}