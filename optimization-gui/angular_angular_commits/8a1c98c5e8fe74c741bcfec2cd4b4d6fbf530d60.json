{
    "author": "atscott",
    "message": "refactor(compiler-cli): add keySpan to reference nodes (#39616)\n\nSimilar to #39613, #39609, and #38898, we should store the `keySpan` for\nReference nodes so that we can accurately map from a template node to a\nspan in the original file. This is most notably an issue at the moment\nfor directive references `#ref=\"exportAs\"`. The current behavior for the\nlanguage service when requesting information for the reference\nis that it will return a text span that results in\nhighlighting the entire source when it should only highlight \"ref\" (test\nadded for this case as well).\n\nPR Close #39616",
    "sha": "8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60",
    "files": [
        {
            "sha": "dc121bbc054a329194d07cb8e85fac9aeaf44a58",
            "filename": "packages/compiler/src/render3/r3_ast.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts?ref=8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60",
            "patch": "@@ -139,7 +139,7 @@ export class Variable implements Node {\n export class Reference implements Node {\n   constructor(\n       public name: string, public value: string, public sourceSpan: ParseSourceSpan,\n-      public valueSpan?: ParseSourceSpan) {}\n+      readonly keySpan: ParseSourceSpan, public valueSpan?: ParseSourceSpan) {}\n   visit<Result>(visitor: Visitor<Result>): Result {\n     return visitor.visitReference(this);\n   }"
        },
        {
            "sha": "6a831f4a4840494a13234a1bdd32ead7bfb99e91",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60",
            "patch": "@@ -357,7 +357,8 @@ class HtmlAstToIvyAst implements html.Visitor {\n \n       } else if (bindParts[KW_REF_IDX]) {\n         const identifier = bindParts[IDENT_KW_IDX];\n-        this.parseReference(identifier, value, srcSpan, attribute.valueSpan, references);\n+        const keySpan = createKeySpan(srcSpan, bindParts[KW_REF_IDX], identifier);\n+        this.parseReference(identifier, value, srcSpan, keySpan, attribute.valueSpan, references);\n       } else if (bindParts[KW_ON_IDX]) {\n         const events: ParsedEvent[] = [];\n         const identifier = bindParts[IDENT_KW_IDX];\n@@ -451,15 +452,15 @@ class HtmlAstToIvyAst implements html.Visitor {\n   }\n \n   private parseReference(\n-      identifier: string, value: string, sourceSpan: ParseSourceSpan,\n+      identifier: string, value: string, sourceSpan: ParseSourceSpan, keySpan: ParseSourceSpan,\n       valueSpan: ParseSourceSpan|undefined, references: t.Reference[]) {\n     if (identifier.indexOf('-') > -1) {\n       this.reportError(`\"-\" is not allowed in reference names`, sourceSpan);\n     } else if (identifier.length === 0) {\n       this.reportError(`Reference does not have a name`, sourceSpan);\n     }\n \n-    references.push(new t.Reference(identifier, value, sourceSpan, valueSpan));\n+    references.push(new t.Reference(identifier, value, sourceSpan, keySpan, valueSpan));\n   }\n \n   private parseAssignmentEvent("
        },
        {
            "sha": "f073904a0e489814ddd0d9a2e132554c5299e09b",
            "filename": "packages/compiler/test/render3/r3_ast_spans_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts?ref=8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60",
            "patch": "@@ -59,8 +59,10 @@ class R3AstSourceSpans implements t.Visitor<void> {\n   }\n \n   visitReference(reference: t.Reference) {\n-    this.result.push(\n-        ['Reference', humanizeSpan(reference.sourceSpan), humanizeSpan(reference.valueSpan)]);\n+    this.result.push([\n+      'Reference', humanizeSpan(reference.sourceSpan), humanizeSpan(reference.keySpan),\n+      humanizeSpan(reference.valueSpan)\n+    ]);\n   }\n \n   visitTextAttribute(attribute: t.TextAttribute) {\n@@ -211,7 +213,7 @@ describe('R3 AST source spans', () => {\n     it('is correct for reference via #...', () => {\n       expectFromHtml('<ng-template #a></ng-template>').toEqual([\n         ['Template', '<ng-template #a></ng-template>', '<ng-template #a>', '</ng-template>'],\n-        ['Reference', '#a', '<empty>'],\n+        ['Reference', '#a', 'a', '<empty>'],\n       ]);\n     });\n \n@@ -220,14 +222,14 @@ describe('R3 AST source spans', () => {\n         [\n           'Template', '<ng-template #a=\"b\"></ng-template>', '<ng-template #a=\"b\">', '</ng-template>'\n         ],\n-        ['Reference', '#a=\"b\"', 'b'],\n+        ['Reference', '#a=\"b\"', 'a', 'b'],\n       ]);\n     });\n \n     it('is correct for reference via ref-...', () => {\n       expectFromHtml('<ng-template ref-a></ng-template>').toEqual([\n         ['Template', '<ng-template ref-a></ng-template>', '<ng-template ref-a>', '</ng-template>'],\n-        ['Reference', 'ref-a', '<empty>'],\n+        ['Reference', 'ref-a', 'a', '<empty>'],\n       ]);\n     });\n \n@@ -237,7 +239,7 @@ describe('R3 AST source spans', () => {\n           'Template', '<ng-template data-ref-a></ng-template>', '<ng-template data-ref-a>',\n           '</ng-template>'\n         ],\n-        ['Reference', 'data-ref-a', '<empty>'],\n+        ['Reference', 'data-ref-a', 'a', '<empty>'],\n       ]);\n     });\n \n@@ -405,28 +407,28 @@ describe('R3 AST source spans', () => {\n     it('is correct for references via #...', () => {\n       expectFromHtml('<div #a></div>').toEqual([\n         ['Element', '<div #a></div>', '<div #a>', '</div>'],\n-        ['Reference', '#a', '<empty>'],\n+        ['Reference', '#a', 'a', '<empty>'],\n       ]);\n     });\n \n     it('is correct for references with name', () => {\n       expectFromHtml('<div #a=\"b\"></div>').toEqual([\n         ['Element', '<div #a=\"b\"></div>', '<div #a=\"b\">', '</div>'],\n-        ['Reference', '#a=\"b\"', 'b'],\n+        ['Reference', '#a=\"b\"', 'a', 'b'],\n       ]);\n     });\n \n     it('is correct for references via ref-', () => {\n       expectFromHtml('<div ref-a></div>').toEqual([\n         ['Element', '<div ref-a></div>', '<div ref-a>', '</div>'],\n-        ['Reference', 'ref-a', '<empty>'],\n+        ['Reference', 'ref-a', 'a', '<empty>'],\n       ]);\n     });\n \n     it('is correct for references via data-ref-', () => {\n       expectFromHtml('<div ref-a></div>').toEqual([\n         ['Element', '<div ref-a></div>', '<div ref-a>', '</div>'],\n-        ['Reference', 'ref-a', '<empty>'],\n+        ['Reference', 'ref-a', 'a', '<empty>'],\n       ]);\n     });\n   });"
        },
        {
            "sha": "b9d0e0c88bc6c72a0a3ba4fc4807353f602d61ed",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60",
            "patch": "@@ -235,7 +235,7 @@ describe('definitions', () => {\n     it('should work for element reference declarations', () => {\n       const definitions = getDefinitionsAndAssertBoundSpan({\n         templateOverride: `<div #cha¦rt></div>{{chart}}`,\n-        expectedSpanText: '#chart',\n+        expectedSpanText: 'chart',\n       });\n       // We're already at the definition, so nothing is returned\n       expect(definitions).toEqual([]);\n@@ -249,7 +249,7 @@ describe('definitions', () => {\n       expect(definitions!.length).toEqual(1);\n \n       const [varDef] = definitions;\n-      expect(varDef.textSpan).toEqual('#chart');\n+      expect(varDef.textSpan).toEqual('chart');\n     });\n   });\n "
        },
        {
            "sha": "8d41c1463a5202ef123fb57e0561d0bd9488efc9",
            "filename": "packages/language-service/ivy/test/quick_info_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts?ref=8a1c98c5e8fe74c741bcfec2cd4b4d6fbf530d60",
            "patch": "@@ -196,7 +196,7 @@ describe('quick info', () => {\n     it('should work for element reference declarations', () => {\n       const {documentation} = expectQuickInfo({\n         templateOverride: `<div #¦chart></div>`,\n-        expectedSpanText: '#chart',\n+        expectedSpanText: 'chart',\n         expectedDisplayString: '(reference) chart: HTMLDivElement'\n       });\n       expect(toText(documentation))\n@@ -205,15 +205,23 @@ describe('quick info', () => {\n               'interface it also has available to it by inheritance) for manipulating <div> elements.');\n     });\n \n+    it('should work for directive references', () => {\n+      expectQuickInfo({\n+        templateOverride: `<div string-model #dir¦Ref=\"stringModel\"></div>`,\n+        expectedSpanText: 'dirRef',\n+        expectedDisplayString: '(reference) dirRef: StringModel'\n+      });\n+    });\n+\n     it('should work for ref- syntax', () => {\n       expectQuickInfo({\n         templateOverride: `<div ref-ch¦art></div>`,\n-        expectedSpanText: 'ref-chart',\n+        expectedSpanText: 'chart',\n         expectedDisplayString: '(reference) chart: HTMLDivElement'\n       });\n       expectQuickInfo({\n         templateOverride: `<div data-ref-ch¦art></div>`,\n-        expectedSpanText: 'data-ref-chart',\n+        expectedSpanText: 'chart',\n         expectedDisplayString: '(reference) chart: HTMLDivElement'\n       });\n     });"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 30,
        "deletions": 19
    }
}