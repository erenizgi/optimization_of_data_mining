{
    "author": "atscott",
    "message": "refactor(compiler-cli): Track external component resources in ResourceRegistry (#39373)\n\nIn addition to the template mapping that already existed, we want to also track the mapping for external\nstyle files. We also store the `ts.Expression` in the registry so external tools can look up a resource\non a component by expression and avoid reading the value.\n\nPR Close #39373",
    "sha": "371fb9a9554766cf48792a96c55c133afa733774",
    "files": [
        {
            "sha": "b6cd153955ea2be4092c4ffffd11708f7df6d83c",
            "filename": "packages/compiler-cli/ngcc/src/analysis/decoration_analyzer.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "raw_url": "https://github.com/angular/angular/raw/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts?ref=371fb9a9554766cf48792a96c55c133afa733774",
            "patch": "@@ -14,7 +14,7 @@ import {CycleAnalyzer, ImportGraph} from '../../../src/ngtsc/cycles';\n import {isFatalDiagnosticError} from '../../../src/ngtsc/diagnostics';\n import {absoluteFrom, absoluteFromSourceFile, dirname, FileSystem, LogicalFileSystem, resolve} from '../../../src/ngtsc/file_system';\n import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, NOOP_DEFAULT_IMPORT_RECORDER, PrivateExportAliasingHost, Reexport, ReferenceEmitter} from '../../../src/ngtsc/imports';\n-import {CompoundMetadataReader, CompoundMetadataRegistry, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry, TemplateMapping} from '../../../src/ngtsc/metadata';\n+import {CompoundMetadataReader, CompoundMetadataRegistry, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry, ResourceRegistry} from '../../../src/ngtsc/metadata';\n import {PartialEvaluator} from '../../../src/ngtsc/partial_evaluator';\n import {LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver} from '../../../src/ngtsc/scope';\n import {DecoratorHandler} from '../../../src/ngtsc/transform';\n@@ -94,7 +94,7 @@ export class DecorationAnalyzer {\n   handlers: DecoratorHandler<unknown, unknown, unknown>[] = [\n     new ComponentDecoratorHandler(\n         this.reflectionHost, this.evaluator, this.fullRegistry, this.fullMetaReader,\n-        this.scopeRegistry, this.scopeRegistry, new TemplateMapping(), this.isCore,\n+        this.scopeRegistry, this.scopeRegistry, new ResourceRegistry(), this.isCore,\n         this.resourceManager, this.rootDirs, !!this.compilerOptions.preserveWhitespaces,\n         /* i18nUseExternalIds */ true, this.bundle.enableI18nLegacyMessageIdFormat,\n         /* i18nNormalizeLineEndingsInICUs */ false, this.moduleResolver, this.cycleAnalyzer,"
        },
        {
            "sha": "7c255a40501457bfb0f3aaa0f12050e24c286374",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 6,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=371fb9a9554766cf48792a96c55c133afa733774",
            "patch": "@@ -15,7 +15,7 @@ import {absoluteFrom, relative, resolve} from '../../file_system';\n import {DefaultImportRecorder, ModuleResolver, Reference, ReferenceEmitter} from '../../imports';\n import {DependencyTracker} from '../../incremental/api';\n import {IndexingContext} from '../../indexer';\n-import {ClassPropertyMapping, DirectiveMeta, DirectiveTypeCheckMeta, extractDirectiveTypeCheckMeta, InjectableClassRegistry, MetadataReader, MetadataRegistry, TemplateMapping} from '../../metadata';\n+import {ClassPropertyMapping, ComponentResources, DirectiveMeta, DirectiveTypeCheckMeta, extractDirectiveTypeCheckMeta, InjectableClassRegistry, MetadataReader, MetadataRegistry, Resource, ResourceRegistry} from '../../metadata';\n import {EnumValue, PartialEvaluator} from '../../partial_evaluator';\n import {ClassDeclaration, DeclarationNode, Decorator, ReflectionHost, reflectObjectLiteral} from '../../reflection';\n import {ComponentScopeReader, LocalModuleScopeRegistry} from '../../scope';\n@@ -70,6 +70,8 @@ export interface ComponentAnalysisData {\n    * require an Angular factory definition at runtime.\n    */\n   viewProvidersRequiringFactory: Set<Reference<ClassDeclaration>>|null;\n+\n+  resources: ComponentResources;\n }\n \n export type ComponentResolutionData = Pick<R3ComponentMetadata, ComponentMetadataResolvedFields>;\n@@ -83,7 +85,7 @@ export class ComponentDecoratorHandler implements\n       private reflector: ReflectionHost, private evaluator: PartialEvaluator,\n       private metaRegistry: MetadataRegistry, private metaReader: MetadataReader,\n       private scopeReader: ComponentScopeReader, private scopeRegistry: LocalModuleScopeRegistry,\n-      private templateMapping: TemplateMapping, private isCore: boolean,\n+      private resourceRegistry: ResourceRegistry, private isCore: boolean,\n       private resourceLoader: ResourceLoader, private rootDirs: ReadonlyArray<string>,\n       private defaultPreserveWhitespaces: boolean, private i18nUseExternalIds: boolean,\n       private enableI18nLegacyMessageIdFormat: boolean,\n@@ -259,6 +261,9 @@ export class ComponentDecoratorHandler implements\n         template = this._extractInlineTemplate(node, decorator, component, containingFile);\n       }\n     }\n+    const templateResource = template.isInline ?\n+        null :\n+        {path: absoluteFrom(template.templateUrl), expression: template.sourceMapping.node};\n \n     let diagnostics: ts.Diagnostic[]|undefined = undefined;\n \n@@ -287,6 +292,7 @@ export class ComponentDecoratorHandler implements\n     // component.\n     let styles: string[]|null = null;\n \n+    const styleResources = this._extractStyleResources(component, containingFile);\n     const styleUrls = this._extractStyleUrls(component, template.styleUrls);\n     if (styleUrls !== null) {\n       if (styles === null) {\n@@ -359,6 +365,10 @@ export class ComponentDecoratorHandler implements\n         template,\n         providersRequiringFactory,\n         viewProvidersRequiringFactory,\n+        resources: {\n+          styles: styleResources,\n+          template: templateResource,\n+        },\n       },\n       diagnostics,\n     };\n@@ -385,10 +395,7 @@ export class ComponentDecoratorHandler implements\n       ...analysis.typeCheckMeta,\n     });\n \n-    if (!analysis.template.isInline) {\n-      this.templateMapping.register(resolve(analysis.template.templateUrl), node);\n-    }\n-\n+    this.resourceRegistry.registerResources(analysis.resources, node);\n     this.injectableRegistry.registerInjectable(node);\n   }\n \n@@ -657,6 +664,25 @@ export class ComponentDecoratorHandler implements\n     return styleUrls as string[];\n   }\n \n+  private _extractStyleResources(component: Map<string, ts.Expression>, containingFile: string):\n+      ReadonlySet<Resource> {\n+    const styleUrlsExpr = component.get('styleUrls');\n+    // If styleUrls is a literal array of strings, process each resource url individually and\n+    // register them. Otherwise, give up and return an empty set.\n+    if (styleUrlsExpr === undefined || !ts.isArrayLiteralExpression(styleUrlsExpr) ||\n+        !styleUrlsExpr.elements.every(e => ts.isStringLiteralLike(e))) {\n+      return new Set();\n+    }\n+\n+    const externalStyles = new Set<Resource>();\n+    for (const expression of styleUrlsExpr.elements) {\n+      const resourceUrl =\n+          this.resourceLoader.resolve((expression as ts.StringLiteralLike).text, containingFile);\n+      externalStyles.add({path: absoluteFrom(resourceUrl), expression});\n+    }\n+    return externalStyles;\n+  }\n+\n   private _preloadAndParseTemplate(\n       node: ClassDeclaration, decorator: Decorator, component: Map<string, ts.Expression>,\n       containingFile: string): Promise<ParsedTemplate|null> {"
        },
        {
            "sha": "395ff0f14cd34094a74b4ce59374ae196c7d524f",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/test/component_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts?ref=371fb9a9554766cf48792a96c55c133afa733774",
            "patch": "@@ -10,7 +10,7 @@ import {ErrorCode, FatalDiagnosticError} from '../../diagnostics';\n import {absoluteFrom} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n import {ModuleResolver, NOOP_DEFAULT_IMPORT_RECORDER, ReferenceEmitter} from '../../imports';\n-import {CompoundMetadataReader, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry, TemplateMapping} from '../../metadata';\n+import {CompoundMetadataReader, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry, ResourceRegistry} from '../../metadata';\n import {PartialEvaluator} from '../../partial_evaluator';\n import {isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver} from '../../scope';\n@@ -69,7 +69,7 @@ runInEachFileSystem(() => {\n \n       const handler = new ComponentDecoratorHandler(\n           reflectionHost, evaluator, metaRegistry, metaReader, scopeRegistry, scopeRegistry,\n-          new TemplateMapping(),\n+          new ResourceRegistry(),\n           /* isCore */ false, new NoopResourceLoader(), /* rootDirs */[''],\n           /* defaultPreserveWhitespaces */ false, /* i18nUseExternalIds */ true,\n           /* enableI18nLegacyMessageIdFormat */ false,"
        },
        {
            "sha": "e4bd76313eb79568af26d9be113b5b35c5bf48a1",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 8,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=371fb9a9554766cf48792a96c55c133afa733774",
            "patch": "@@ -17,11 +17,11 @@ import {LogicalFileSystem, resolve} from '../../file_system';\n import {AbsoluteModuleStrategy, AliasingHost, AliasStrategy, DefaultImportTracker, ImportRewriter, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, NoopImportRewriter, PrivateExportAliasingHost, R3SymbolsImportRewriter, Reference, ReferenceEmitStrategy, ReferenceEmitter, RelativePathStrategy, UnifiedModulesAliasingHost, UnifiedModulesStrategy} from '../../imports';\n import {IncrementalBuildStrategy, IncrementalDriver} from '../../incremental';\n import {generateAnalysis, IndexedComponent, IndexingContext} from '../../indexer';\n-import {CompoundMetadataReader, CompoundMetadataRegistry, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry, MetadataReader, TemplateMapping} from '../../metadata';\n+import {ComponentResources, CompoundMetadataReader, CompoundMetadataRegistry, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry, MetadataReader, ResourceRegistry} from '../../metadata';\n import {ModuleWithProvidersScanner} from '../../modulewithproviders';\n import {PartialEvaluator} from '../../partial_evaluator';\n import {NOOP_PERF_RECORDER, PerfRecorder} from '../../perf';\n-import {DeclarationNode, TypeScriptReflectionHost} from '../../reflection';\n+import {DeclarationNode, isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {AdapterResourceLoader} from '../../resource';\n import {entryPointKeyFor, NgModuleRouteAnalyzer} from '../../routing';\n import {ComponentScopeReader, LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver} from '../../scope';\n@@ -52,7 +52,7 @@ interface LazyCompilationState {\n   aliasingHost: AliasingHost|null;\n   refEmitter: ReferenceEmitter;\n   templateTypeChecker: TemplateTypeChecker;\n-  templateMapping: TemplateMapping;\n+  resourceRegistry: ResourceRegistry;\n }\n \n /**\n@@ -239,8 +239,30 @@ export class NgCompiler {\n    * Retrieves the `ts.Declaration`s for any component(s) which use the given template file.\n    */\n   getComponentsWithTemplateFile(templateFilePath: string): ReadonlySet<DeclarationNode> {\n-    const {templateMapping} = this.ensureAnalyzed();\n-    return templateMapping.getComponentsWithTemplate(resolve(templateFilePath));\n+    const {resourceRegistry} = this.ensureAnalyzed();\n+    return resourceRegistry.getComponentsWithTemplate(resolve(templateFilePath));\n+  }\n+\n+  /**\n+   * Retrieves the `ts.Declaration`s for any component(s) which use the given template file.\n+   */\n+  getComponentsWithStyleFile(styleFilePath: string): ReadonlySet<DeclarationNode> {\n+    const {resourceRegistry} = this.ensureAnalyzed();\n+    return resourceRegistry.getComponentsWithStyle(resolve(styleFilePath));\n+  }\n+\n+  /**\n+   * Retrieves external resources for the given component.\n+   */\n+  getComponentResources(classDecl: DeclarationNode): ComponentResources|null {\n+    if (!isNamedClassDeclaration(classDecl)) {\n+      return null;\n+    }\n+    const {resourceRegistry} = this.ensureAnalyzed();\n+    const styles = resourceRegistry.getStyles(classDecl);\n+    const template = resourceRegistry.getTemplate(classDecl);\n+\n+    return {styles, template};\n   }\n \n   /**\n@@ -734,13 +756,13 @@ export class NgCompiler {\n     const isCore = isAngularCorePackage(this.tsProgram);\n \n     const defaultImportTracker = new DefaultImportTracker();\n-    const templateMapping = new TemplateMapping();\n+    const resourceRegistry = new ResourceRegistry();\n \n     // Set up the IvyCompilation, which manages state for the Ivy transformer.\n     const handlers: DecoratorHandler<unknown, unknown, unknown>[] = [\n       new ComponentDecoratorHandler(\n           reflector, evaluator, metaRegistry, metaReader, scopeReader, scopeRegistry,\n-          templateMapping, isCore, this.resourceManager, this.adapter.rootDirs,\n+          resourceRegistry, isCore, this.resourceManager, this.adapter.rootDirs,\n           this.options.preserveWhitespaces || false, this.options.i18nUseExternalIds !== false,\n           this.options.enableI18nLegacyMessageIdFormat !== false,\n           this.options.i18nNormalizeLineEndingsInICUs, this.moduleResolver, this.cycleAnalyzer,\n@@ -797,7 +819,7 @@ export class NgCompiler {\n       aliasingHost,\n       refEmitter,\n       templateTypeChecker,\n-      templateMapping,\n+      resourceRegistry,\n     };\n   }\n }"
        },
        {
            "sha": "37be7020c616bafb43f4cbbba320d1361c05e552",
            "filename": "packages/compiler-cli/src/ngtsc/core/test/compiler_test.ts",
            "status": "modified",
            "additions": 121,
            "deletions": 0,
            "changes": 121,
            "blob_url": "https://github.com/angular/angular/blob/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "raw_url": "https://github.com/angular/angular/raw/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts?ref=371fb9a9554766cf48792a96c55c133afa733774",
            "patch": "@@ -106,6 +106,127 @@ runInEachFileSystem(() => {\n       });\n     });\n \n+    describe('getComponentsWithStyle', () => {\n+      it('should return the component(s) using a style file', () => {\n+        const styleFile = _('/style.css');\n+        fs.writeFile(styleFile, `/* This is the style, used by components CmpA and CmpC */`);\n+        const cmpAFile = _('/cmp-a.ts');\n+        fs.writeFile(cmpAFile, `\n+            import {Component} from '@angular/core';\n+            @Component({\n+              selector: 'cmp-a',\n+              template: '',\n+              styleUrls: ['./style.css'],\n+            })\n+            export class CmpA {}\n+          `);\n+        const cmpBFile = _('/cmp-b.ts');\n+        fs.writeFile(cmpBFile, `\n+            import {Component} from '@angular/core';\n+            @Component({\n+              selector: 'cmp-b',\n+              template: '',\n+              styles: ['/* CmpB does not use external style */'],\n+            })\n+            export class CmpB {}\n+          `);\n+        const cmpCFile = _('/cmp-c.ts');\n+        fs.writeFile(cmpCFile, `\n+            import {Component} from '@angular/core';\n+            @Component({\n+              selector: 'cmp-c',\n+              template: '',\n+              styleUrls: ['./style.css']\n+            })\n+            export class CmpC {}\n+          `);\n+\n+        const options: NgCompilerOptions = {};\n+\n+        const baseHost = new NgtscCompilerHost(getFileSystem(), options);\n+        const host = NgCompilerHost.wrap(\n+            baseHost, [cmpAFile, cmpBFile, cmpCFile], options, /* oldProgram */ null);\n+        const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n+        const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n+        const CmpC = getClass(getSourceFileOrError(program, cmpCFile), 'CmpC');\n+        const compiler = new NgCompiler(\n+            host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false);\n+        const components = compiler.getComponentsWithStyleFile(styleFile);\n+        expect(components).toEqual(new Set([CmpA, CmpC]));\n+      });\n+    });\n+\n+    describe('getComponentResources', () => {\n+      it('should return the component resources', () => {\n+        const styleFile = _('/style.css');\n+        fs.writeFile(styleFile, `/* This is the template, used by components CmpA */`);\n+        const styleFile2 = _('/style2.css');\n+        fs.writeFile(styleFile2, `/* This is the template, used by components CmpA */`);\n+        const templateFile = _('/template.ng.html');\n+        fs.writeFile(templateFile, `This is the template, used by components CmpA`);\n+        const cmpAFile = _('/cmp-a.ts');\n+        fs.writeFile(cmpAFile, `\n+            import {Component} from '@angular/core';\n+            @Component({\n+              selector: 'cmp-a',\n+              templateUrl: './template.ng.html',\n+              styleUrls: ['./style.css', '../../style2.css'],\n+            })\n+            export class CmpA {}\n+          `);\n+\n+        const options: NgCompilerOptions = {};\n+\n+        const baseHost = new NgtscCompilerHost(getFileSystem(), options);\n+        const host = NgCompilerHost.wrap(baseHost, [cmpAFile], options, /* oldProgram */ null);\n+        const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n+        const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n+        const compiler = new NgCompiler(\n+            host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false);\n+        const resources = compiler.getComponentResources(CmpA);\n+        expect(resources).not.toBeNull();\n+        const {template, styles} = resources!;\n+        expect(template !.path).toEqual(templateFile);\n+        expect(styles.size).toEqual(2);\n+        const actualPaths = new Set(Array.from(styles).map(r => r.path));\n+        expect(actualPaths).toEqual(new Set([styleFile, styleFile2]));\n+      });\n+\n+      it('does not return component style resources if not an array of strings', () => {\n+        const styleFile = _('/style.css');\n+        fs.writeFile(styleFile, `/* This is the template, used by components CmpA */`);\n+        const styleFile2 = _('/style2.css');\n+        fs.writeFile(styleFile2, `/* This is the template, used by components CmpA */`);\n+        const cmpAFile = _('/cmp-a.ts');\n+        fs.writeFile(cmpAFile, `\n+            import {Component} from '@angular/core';\n+            const STYLES = ['./style.css', '../../style2.css'];\n+            @Component({\n+              selector: 'cmp-a',\n+              template: '',\n+              styleUrls: STYLES,\n+            })\n+            export class CmpA {}\n+          `);\n+\n+        const options: NgCompilerOptions = {};\n+\n+        const baseHost = new NgtscCompilerHost(getFileSystem(), options);\n+        const host = NgCompilerHost.wrap(baseHost, [cmpAFile], options, /* oldProgram */ null);\n+        const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n+        const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n+        const compiler = new NgCompiler(\n+            host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false);\n+        const resources = compiler.getComponentResources(CmpA);\n+        expect(resources).not.toBeNull();\n+        const {styles} = resources!;\n+        expect(styles.size).toEqual(0);\n+      });\n+    });\n+\n     describe('getResourceDependencies', () => {\n       it('should return resource dependencies of a component source file', () => {\n         const COMPONENT = _('/cmp.ts');"
        },
        {
            "sha": "653465c77295fa5d29625e394b1c8fbe1b329d36",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Findex.ts?ref=371fb9a9554766cf48792a96c55c133afa733774",
            "patch": "@@ -10,6 +10,6 @@ export * from './src/api';\n export {DtsMetadataReader} from './src/dts';\n export {flattenInheritedDirectiveMetadata} from './src/inheritance';\n export {CompoundMetadataRegistry, LocalMetadataRegistry, InjectableClassRegistry} from './src/registry';\n-export {TemplateRegistry as TemplateMapping} from './src/template_mapping';\n+export {ResourceRegistry, Resource, ComponentResources} from './src/resource_registry';\n export {extractDirectiveTypeCheckMeta, CompoundMetadataReader} from './src/util';\n-export {BindingPropertyName, ClassPropertyMapping, ClassPropertyName, InputOrOutput} from './src/property_mapping';\n\\ No newline at end of file\n+export {BindingPropertyName, ClassPropertyMapping, ClassPropertyName, InputOrOutput} from './src/property_mapping';"
        },
        {
            "sha": "c52567807ad39304283762b6e954dedbcdcc7c76",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/resource_registry.ts",
            "status": "added",
            "additions": 107,
            "deletions": 0,
            "changes": 107,
            "blob_url": "https://github.com/angular/angular/blob/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fresource_registry.ts",
            "raw_url": "https://github.com/angular/angular/raw/371fb9a9554766cf48792a96c55c133afa733774/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fresource_registry.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fresource_registry.ts?ref=371fb9a9554766cf48792a96c55c133afa733774",
            "patch": "@@ -0,0 +1,107 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript';\n+\n+import {AbsoluteFsPath} from '../../file_system';\n+import {ClassDeclaration} from '../../reflection';\n+\n+/**\n+ * Represents an external resource for a component and contains the `AbsoluteFsPath`\n+ * to the file which was resolved by evaluating the `ts.Expression` (generally, a relative or\n+ * absolute string path to the resource).\n+ */\n+export interface Resource {\n+  path: AbsoluteFsPath;\n+  expression: ts.Expression;\n+}\n+\n+/**\n+ * Represents the external resources of a component.\n+ *\n+ * If the component uses an inline template, the template resource will be `null`.\n+ * If the component does not have external styles, the `styles` `Set` will be empty.\n+ */\n+export interface ComponentResources {\n+  template: Resource|null;\n+  styles: ReadonlySet<Resource>;\n+}\n+\n+/**\n+ * Tracks the mapping between external template/style files and the component(s) which use them.\n+ *\n+ * This information is produced during analysis of the program and is used mainly to support\n+ * external tooling, for which such a mapping is challenging to determine without compiler\n+ * assistance.\n+ */\n+export class ResourceRegistry {\n+  private templateToComponentsMap = new Map<AbsoluteFsPath, Set<ClassDeclaration>>();\n+  private componentToTemplateMap = new Map<ClassDeclaration, Resource>();\n+  private componentToStylesMap = new Map<ClassDeclaration, Set<Resource>>();\n+  private styleToComponentsMap = new Map<AbsoluteFsPath, Set<ClassDeclaration>>();\n+\n+  getComponentsWithTemplate(template: AbsoluteFsPath): ReadonlySet<ClassDeclaration> {\n+    if (!this.templateToComponentsMap.has(template)) {\n+      return new Set();\n+    }\n+\n+    return this.templateToComponentsMap.get(template)!;\n+  }\n+\n+  registerResources(resources: ComponentResources, component: ClassDeclaration) {\n+    if (resources.template !== null) {\n+      this.registerTemplate(resources.template, component);\n+    }\n+    for (const style of resources.styles) {\n+      this.registerStyle(style, component);\n+    }\n+  }\n+\n+  registerTemplate(templateResource: Resource, component: ClassDeclaration): void {\n+    const {path} = templateResource;\n+    if (!this.templateToComponentsMap.has(path)) {\n+      this.templateToComponentsMap.set(path, new Set());\n+    }\n+    this.templateToComponentsMap.get(path)!.add(component);\n+    this.componentToTemplateMap.set(component, templateResource);\n+  }\n+\n+  getTemplate(component: ClassDeclaration): Resource|null {\n+    if (!this.componentToTemplateMap.has(component)) {\n+      return null;\n+    }\n+    return this.componentToTemplateMap.get(component)!;\n+  }\n+\n+  registerStyle(styleResource: Resource, component: ClassDeclaration): void {\n+    const {path} = styleResource;\n+    if (!this.componentToStylesMap.has(component)) {\n+      this.componentToStylesMap.set(component, new Set());\n+    }\n+    if (!this.styleToComponentsMap.has(path)) {\n+      this.styleToComponentsMap.set(path, new Set());\n+    }\n+    this.styleToComponentsMap.get(path)!.add(component);\n+    this.componentToStylesMap.get(component)!.add(styleResource);\n+  }\n+\n+  getStyles(component: ClassDeclaration): Set<Resource> {\n+    if (!this.componentToStylesMap.has(component)) {\n+      return new Set();\n+    }\n+    return this.componentToStylesMap.get(component)!;\n+  }\n+\n+  getComponentsWithStyle(styleUrl: AbsoluteFsPath): ReadonlySet<ClassDeclaration> {\n+    if (!this.styleToComponentsMap.has(styleUrl)) {\n+      return new Set();\n+    }\n+\n+    return this.styleToComponentsMap.get(styleUrl)!;\n+  }\n+}"
        },
        {
            "sha": "2a5d49613ef6cdfd8d5b5e8fea6bed2b3a3e1989",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/template_mapping.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 36,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/a7518eb631b7f90d621bdd4c4ba761931d678c26/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Ftemplate_mapping.ts",
            "raw_url": "https://github.com/angular/angular/raw/a7518eb631b7f90d621bdd4c4ba761931d678c26/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Ftemplate_mapping.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Ftemplate_mapping.ts?ref=a7518eb631b7f90d621bdd4c4ba761931d678c26",
            "patch": "@@ -1,36 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import {AbsoluteFsPath} from '../../file_system';\n-import {ClassDeclaration} from '../../reflection';\n-\n-/**\n- * Tracks the mapping between external template files and the component(s) which use them.\n- *\n- * This information is produced during analysis of the program and is used mainly to support\n- * external tooling, for which such a mapping is challenging to determine without compiler\n- * assistance.\n- */\n-export class TemplateRegistry {\n-  private map = new Map<AbsoluteFsPath, Set<ClassDeclaration>>();\n-\n-  getComponentsWithTemplate(template: AbsoluteFsPath): ReadonlySet<ClassDeclaration> {\n-    if (!this.map.has(template)) {\n-      return new Set();\n-    }\n-\n-    return this.map.get(template)!;\n-  }\n-\n-  register(template: AbsoluteFsPath, component: ClassDeclaration): void {\n-    if (!this.map.has(template)) {\n-      this.map.set(template, new Set());\n-    }\n-    this.map.get(template)!.add(component);\n-  }\n-}"
        }
    ],
    "stats": {
        "total": 352,
        "additions": 296,
        "deletions": 56
    }
}