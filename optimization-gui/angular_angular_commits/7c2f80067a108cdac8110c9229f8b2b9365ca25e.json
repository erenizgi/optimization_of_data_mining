{
    "author": "gkalpak",
    "message": "test(service-worker): better align mock client implementations with actual implementations (#42736)\n\nThis commit better aligns the mock client implementations used in\nServiceWorker tests (and the associated typings) with the actual\nimplementations (and the official TypeScript typings). This allows\nverifying the ServiceWorker behavior in a slightly more realistic\nenvironment.\n\nThis is in preparation of switching from our custom typings to the\nofficial TypeScript typings (`lib.webworker.d.ts`).\n\nPR Close #42736",
    "sha": "7c2f80067a108cdac8110c9229f8b2b9365ca25e",
    "files": [
        {
            "sha": "6f07246906e3264b8a32c929ceade99ba3e19a8c",
            "filename": "packages/service-worker/test/integration_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Ftest%2Fintegration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Ftest%2Fintegration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Ftest%2Fintegration_spec.ts?ref=7c2f80067a108cdac8110c9229f8b2b9365ca25e",
            "patch": "@@ -89,7 +89,7 @@ describe('ngsw + companion lib', () => {\n     scope = new SwTestHarnessBuilder().withServerState(server).build();\n     driver = new Driver(scope, scope, new CacheDatabase(scope));\n \n-    scope.clients.add('default');\n+    scope.clients.add('default', scope.registration.scope);\n     scope.clients.getMock('default')!.queue.subscribe(msg => {\n       mock.sendMessage(msg);\n     });"
        },
        {
            "sha": "542dea815738edc5a3ca3630b5222a7a7f887210",
            "filename": "packages/service-worker/worker/src/driver.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "raw_url": "https://github.com/angular/angular/raw/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts?ref=7c2f80067a108cdac8110c9229f8b2b9365ca25e",
            "patch": "@@ -673,7 +673,7 @@ export class Driver implements Debuggable, UpdateSource {\n \n           const client = await this.scope.clients.get(clientId);\n \n-          await this.updateClient(client);\n+          await this.updateClient(client!);\n           appVersion = this.lookupVersionByHash(this.latestHash, 'assignVersion');\n         }\n \n@@ -1050,7 +1050,7 @@ export class Driver implements Debuggable, UpdateSource {\n \n     await Promise.all(affectedClients.map(async clientId => {\n       const client = await this.scope.clients.get(clientId);\n-      client.postMessage({type: 'UNRECOVERABLE_STATE', reason});\n+      client!.postMessage({type: 'UNRECOVERABLE_STATE', reason});\n     }));\n   }\n "
        },
        {
            "sha": "976a4a70f02632b14b6654293e54c669c46cf9b5",
            "filename": "packages/service-worker/worker/src/service-worker.d.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts?ref=7c2f80067a108cdac8110c9229f8b2b9365ca25e",
            "patch": "@@ -29,15 +29,16 @@ interface ExtendableEvent extends Event {\n // Client API\n \n declare class Client {\n-  frameType: ClientFrameType;\n-  id: string;\n-  url: string;\n-  postMessage(message: any): void;\n+    readonly frameType: FrameType;\n+    readonly id: string;\n+    readonly type: ClientTypes;\n+    readonly url: string;\n+    postMessage(message: any): void;\n }\n \n interface Clients {\n   claim(): Promise<void>;\n-  get(id: string): Promise<Client>;\n+  get(id: string): Promise<Client | undefined>;\n   matchAll<T extends ClientMatchOptions>(\n     options?: T\n   ): Promise<ReadonlyArray<T['type'] extends 'window' ? WindowClient : Client>>;\n@@ -46,20 +47,19 @@ interface Clients {\n \n interface ClientMatchOptions {\n   includeUncontrolled?: boolean;\n-  type?: ClientMatchTypes;\n+  type?: ClientTypes;\n }\n \n interface WindowClient extends Client {\n-  readonly ancestorOrigins: ReadonlyArray<string>;\n   readonly focused: boolean;\n   readonly visibilityState: VisibilityState;\n   focus(): Promise<WindowClient>;\n   navigate(url: string): Promise<WindowClient | null>;\n }\n \n-type ClientFrameType = 'auxiliary'|'top-level'|'nested'|'none';\n-type ClientMatchTypes = 'window'|'worker'|'sharedworker'|'all';\n-type WindowClientState = 'hidden'|'visible'|'prerender'|'unloaded';\n+type FrameType = 'auxiliary'|'top-level'|'nested'|'none';\n+type ClientTypes = 'window'|'worker'|'sharedworker'|'all';\n+type VisibilityState = 'hidden'|'visible';\n \n // Fetch API\n "
        },
        {
            "sha": "2280add54ab9e65fb73d00a5acd52a25e7963a5f",
            "filename": "packages/service-worker/worker/test/happy_spec.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 25,
            "changes": 55,
            "blob_url": "https://github.com/angular/angular/blob/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts?ref=7c2f80067a108cdac8110c9229f8b2b9365ca25e",
            "patch": "@@ -12,7 +12,7 @@ import {Driver, DriverReadyState} from '../src/driver';\n import {AssetGroupConfig, DataGroupConfig, Manifest} from '../src/manifest';\n import {sha1} from '../src/sha1';\n import {clearAllCaches, MockCache} from '../testing/cache';\n-import {WindowClientImpl} from '../testing/clients';\n+import {MockWindowClient} from '../testing/clients';\n import {MockRequest, MockResponse} from '../testing/fetch';\n import {MockFileSystem, MockFileSystemBuilder, MockServerState, MockServerStateBuilder, tmpHashTableForFs} from '../testing/mock';\n import {SwTestHarness, SwTestHarnessBuilder} from '../testing/scope';\n@@ -766,7 +766,7 @@ describe('Driver', () => {\n       await driver.initialized;\n       await scope.handleClick(\n           {title: 'This is a test with action', body: 'Test body with action'}, 'button');\n-      const message: any = scope.clients.getMock('default')!.messages[0];\n+      const message = scope.clients.getMock('default')!.messages[0];\n \n       expect(message.type).toEqual('NOTIFICATION_CLICK');\n       expect(message.data.action).toEqual('button');\n@@ -781,7 +781,7 @@ describe('Driver', () => {\n         title: 'This is a test without action',\n         body: 'Test body without action',\n       });\n-      const message: any = scope.clients.getMock('default')!.messages[0];\n+      const message = scope.clients.getMock('default')!.messages[0];\n \n       expect(message.type).toEqual('NOTIFICATION_CLICK');\n       expect(message.data.action).toBe('');\n@@ -837,12 +837,14 @@ describe('Driver', () => {\n       describe('`focusLastFocusedOrOpen` operation', () => {\n         it('focuses last client keeping previous url', async () => {\n           expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n-          const mockClient = new WindowClientImpl('fooBar');\n-          spyOn(scope.clients, 'matchAll').and.returnValue(Promise.resolve([mockClient]));\n-          spyOn(mockClient, 'focus');\n-          spyOn(mockClient, 'navigate');\n+\n+          scope.clients.add('fooBar', 'http://localhost/unique', 'window');\n+          const mockClient = scope.clients.getMock('fooBar') as MockWindowClient;\n           const url = 'foo';\n \n+          expect(mockClient.url).toBe('http://localhost/unique');\n+          expect(mockClient.focused).toBeFalse();\n+\n           await driver.initialized;\n           await scope.handleClick(\n               {\n@@ -855,9 +857,8 @@ describe('Driver', () => {\n                 },\n               },\n               'foo');\n-          expect(mockClient.navigate).not.toHaveBeenCalled();\n-          expect(mockClient.url).toEqual('http://localhost/unique');\n-          expect(mockClient.focus).toHaveBeenCalled();\n+          expect(mockClient.url).toBe('http://localhost/unique');\n+          expect(mockClient.focused).toBeTrue();\n         });\n \n         it('falls back to openWindow at url when no last client to focus', async () => {\n@@ -905,13 +906,15 @@ describe('Driver', () => {\n \n       describe('`navigateLastFocusedOrOpen` operation', () => {\n         it('navigates last client to `url`', async () => {\n-          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n-          const mockClient = new WindowClientImpl('fooBar');\n-          spyOn(scope.clients, 'matchAll').and.returnValue(Promise.resolve([mockClient]));\n-          spyOn(mockClient, 'focus');\n-          spyOn(mockClient, 'navigate').and.returnValue(Promise.resolve(mockClient));\n+          expect(await makeRequest(scope, '/foo.txt')).toBe('this is foo');\n+\n+          scope.clients.add('fooBar', 'http://localhost/unique', 'window');\n+          const mockClient = scope.clients.getMock('fooBar') as MockWindowClient;\n           const url = 'foo';\n \n+          expect(mockClient.url).toBe('http://localhost/unique');\n+          expect(mockClient.focused).toBeFalse();\n+\n           await driver.initialized;\n           await scope.handleClick(\n               {\n@@ -924,16 +927,18 @@ describe('Driver', () => {\n                 },\n               },\n               'foo');\n-          expect(mockClient.navigate).toHaveBeenCalledWith(`${scope.registration.scope}${url}`);\n-          expect(mockClient.focus).toHaveBeenCalled();\n+          expect(mockClient.url).toBe(`${scope.registration.scope}${url}`);\n+          expect(mockClient.focused).toBeTrue();\n         });\n \n-        it('navigates last client to `/` if no `url', async () => {\n-          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n-          const mockClient = new WindowClientImpl('fooBar');\n-          spyOn(scope.clients, 'matchAll').and.returnValue(Promise.resolve([mockClient]));\n-          spyOn(mockClient, 'focus');\n-          spyOn(mockClient, 'navigate').and.returnValue(Promise.resolve(mockClient));\n+        it('navigates last client to `/` if no `url`', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toBe('this is foo');\n+\n+          scope.clients.add('fooBar', 'http://localhost/unique', 'window');\n+          const mockClient = scope.clients.getMock('fooBar') as MockWindowClient;\n+\n+          expect(mockClient.url).toBe('http://localhost/unique');\n+          expect(mockClient.focused).toBeFalse();\n \n           await driver.initialized;\n           await scope.handleClick(\n@@ -947,8 +952,8 @@ describe('Driver', () => {\n                 },\n               },\n               'foo');\n-          expect(mockClient.navigate).toHaveBeenCalledWith(`${scope.registration.scope}`);\n-          expect(mockClient.focus).toHaveBeenCalled();\n+          expect(mockClient.url).toBe(scope.registration.scope);\n+          expect(mockClient.focused).toBeTrue();\n         });\n \n         it('falls back to openWindow at url when no last client to focus', async () => {"
        },
        {
            "sha": "cbdda4963f05e87aac4cbe0f5d161116e772b215",
            "filename": "packages/service-worker/worker/testing/clients.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 18,
            "changes": 67,
            "blob_url": "https://github.com/angular/angular/blob/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Fworker%2Ftesting%2Fclients.ts",
            "raw_url": "https://github.com/angular/angular/raw/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Fworker%2Ftesting%2Fclients.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fclients.ts?ref=7c2f80067a108cdac8110c9229f8b2b9365ca25e",
            "patch": "@@ -9,55 +9,68 @@\n import {Subject} from 'rxjs';\n \n \n-export class MockClient {\n-  queue = new Subject<Object>();\n+export class MockClient implements Client {\n+  readonly messages: any[] = [];\n+  readonly queue = new Subject<any>();\n+  lastFocusedAt = 0;\n \n-  constructor(readonly id: string) {}\n+  constructor(\n+      readonly id: string, readonly url: string, readonly type: ClientTypes = 'all',\n+      readonly frameType: FrameType = 'top-level') {}\n \n-  readonly messages: Object[] = [];\n-\n-  postMessage(message: Object): void {\n+  postMessage(message: any): void {\n     this.messages.push(message);\n     this.queue.next(message);\n   }\n }\n \n-export class WindowClientImpl extends MockClient implements WindowClient {\n-  readonly ancestorOrigins: ReadonlyArray<string> = [];\n+export class MockWindowClient extends MockClient implements WindowClient {\n   readonly focused: boolean = false;\n-  readonly visibilityState: VisibilityState = 'hidden';\n-  frameType: ClientFrameType = 'top-level';\n-  url = 'http://localhost/unique';\n+  readonly visibilityState: VisibilityState = 'visible';\n \n-  constructor(readonly id: string) {\n-    super(id);\n+  constructor(id: string, url: string, frameType: FrameType = 'top-level') {\n+    super(id, url, 'window', frameType);\n   }\n \n   async focus(): Promise<WindowClient> {\n+    // This is only used for relatively ordering clients based on focus order, so we don't need to\n+    // use `Adapter#time`.\n+    this.lastFocusedAt = Date.now();\n+    (this.focused as boolean) = true;\n     return this;\n   }\n \n   async navigate(url: string): Promise<WindowClient|null> {\n+    (this.url as string) = url;\n     return this;\n   }\n }\n \n export class MockClients implements Clients {\n   private clients = new Map<string, MockClient>();\n \n-  add(clientId: string): void {\n+  add(clientId: string, url: string, type: ClientTypes = 'window'): void {\n     if (this.clients.has(clientId)) {\n-      return;\n+      const existingClient = this.clients.get(clientId)!;\n+      if (existingClient.url === url) {\n+        return;\n+      }\n+      throw new Error(\n+          `Trying to add mock client with same ID (${existingClient.id}) and different URL ` +\n+          `(${existingClient.url} --> ${url})`);\n     }\n-    this.clients.set(clientId, new MockClient(clientId));\n+\n+    const client = (type === 'window') ? new MockWindowClient(clientId, url) :\n+                                         new MockClient(clientId, url, type);\n+    this.clients.set(clientId, client);\n   }\n \n   remove(clientId: string): void {\n     this.clients.delete(clientId);\n   }\n \n   async get(id: string): Promise<Client> {\n-    return this.clients.get(id)! as any as Client;\n+    return this.clients.get(id)!;\n   }\n \n   getMock(id: string): MockClient|undefined {\n@@ -66,7 +79,25 @@ export class MockClients implements Clients {\n \n   async matchAll<T extends ClientQueryOptions>(options?: T):\n       Promise<ReadonlyArray<T['type'] extends 'window'? WindowClient : Client>> {\n-    return Array.from(this.clients.values()) as any[];\n+    const type = options?.type ?? 'window';\n+    const allClients = Array.from(this.clients.values());\n+    const matchedClients =\n+        (type === 'all') ? allClients : allClients.filter(client => client.type === type);\n+\n+    // Order clients according to the [spec](https://w3c.github.io/ServiceWorker/#clients-matchall):\n+    // In most recently focused then most recently created order, with windows clients before other\n+    // clients.\n+    return matchedClients\n+               // Sort in most recently created order.\n+               .reverse()\n+               // Sort in most recently focused order.\n+               .sort((a, b) => b.lastFocusedAt - a.lastFocusedAt)\n+               // Sort windows clients before other clients (otherwise leave existing order).\n+               .sort((a, b) => {\n+                 const aScore = (a.type === 'window') ? 1 : 0;\n+                 const bScore = (b.type === 'window') ? 1 : 0;\n+                 return bScore - aScore;\n+               }) as any;\n   }\n \n   async openWindow(url: string): Promise<WindowClient|null> {"
        },
        {
            "sha": "5acf62e35459b657a8973692e178101e4d3ed0e1",
            "filename": "packages/service-worker/worker/testing/scope.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 11,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "raw_url": "https://github.com/angular/angular/raw/7c2f80067a108cdac8110c9229f8b2b9365ca25e/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts?ref=7c2f80067a108cdac8110c9229f8b2b9365ca25e",
            "patch": "@@ -164,30 +164,31 @@ export class SwTestHarness extends Adapter<MockCacheStorage> implements ServiceW\n     }\n \n     const isNavigation = req.mode === 'navigate';\n+\n+    if (clientId && !this.clients.getMock(clientId)) {\n+      this.clients.add(clientId, isNavigation ? req.url : this.scopeUrl);\n+    }\n+\n     const event = isNavigation ? new MockFetchEvent(req, '', clientId) :\n                                  new MockFetchEvent(req, clientId, '');\n     this.eventHandlers.get('fetch')!.call(this, event);\n \n-    if (clientId) {\n-      this.clients.add(clientId);\n-    }\n-\n     return [event.response, event.ready];\n   }\n \n   handleMessage(data: Object, clientId: string|null): Promise<void> {\n     if (!this.eventHandlers.has('message')) {\n       throw new Error('No message handler registered');\n     }\n-    let event: MockExtendableMessageEvent;\n-    if (clientId === null) {\n-      event = new MockExtendableMessageEvent(data, null);\n-    } else {\n-      this.clients.add(clientId);\n-      event = new MockExtendableMessageEvent(\n-          data, this.clients.getMock(clientId) as unknown as Client || null);\n+\n+    if (clientId && !this.clients.getMock(clientId)) {\n+      this.clients.add(clientId, this.scopeUrl);\n     }\n+\n+    const event =\n+        new MockExtendableMessageEvent(data, clientId && this.clients.getMock(clientId) || null);\n     this.eventHandlers.get('message')!.call(this, event);\n+\n     return event.ready;\n   }\n "
        }
    ],
    "stats": {
        "total": 171,
        "additions": 104,
        "deletions": 67
    }
}