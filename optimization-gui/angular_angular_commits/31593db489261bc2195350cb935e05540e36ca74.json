{
    "author": "JoostK",
    "message": "refactor(core): expand error logging when the JIT compiler is not available (#42693)\n\nIf a decorator or partial declaration has not been AOT compiled, then\nthe compiler is needed at runtime to be able to JIT compile the code.\nHowever, it may occur that the compiler is not available, if it has not\nbeen loaded into the application. The error that was reported in this\ncase did not provide insight into which class requested compilation, nor\ndid it differentiate between decorators vs. partial declarations.\n\nThis commit expands the error logging to provide better insight into the\nclass that initiated JIT compilation and offers a specialized error\nmessage for partial declarations. This should help a developer better\nunderstand why the error occurs and what can be done to resolve it.\n\nCloses #40609\n\nPR Close #42693",
    "sha": "31593db489261bc2195350cb935e05540e36ca74",
    "files": [
        {
            "sha": "ea4de55bcac886b74f5ae75cc58b4d5367038db2",
            "filename": "packages/core/src/application_ref.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Fapplication_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Fapplication_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fapplication_ref.ts?ref=31593db489261bc2195350cb935e05540e36ca74",
            "patch": "@@ -13,7 +13,7 @@ import {share} from 'rxjs/operators';\n \n import {ApplicationInitStatus} from './application_init';\n import {APP_BOOTSTRAP_LISTENER, PLATFORM_INITIALIZER} from './application_tokens';\n-import {getCompilerFacade} from './compiler/compiler_facade';\n+import {getCompilerFacade, JitCompilerUsage} from './compiler/compiler_facade';\n import {Console} from './console';\n import {Injectable} from './di/injectable';\n import {InjectionToken} from './di/injection_token';\n@@ -94,7 +94,11 @@ export function compileNgModuleFactory__POST_R3__<M>(\n     return Promise.resolve(moduleFactory);\n   }\n \n-  const compiler = getCompilerFacade();\n+  const compiler = getCompilerFacade({\n+    usage: JitCompilerUsage.Decorator,\n+    kind: 'NgModule',\n+    type: moduleType,\n+  });\n   const compilerInjector = Injector.create({providers: compilerProviders});\n   const resourceLoader = compilerInjector.get(compiler.ResourceLoader);\n   // The resource loader can also return a string while the \"resolveComponentResources\""
        },
        {
            "sha": "d81956de3eff3f5859a9c7c3d8a0cb6aa2eec813",
            "filename": "packages/core/src/compiler/compiler_facade.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 9,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade.ts",
            "raw_url": "https://github.com/angular/angular/raw/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade.ts?ref=31593db489261bc2195350cb935e05540e36ca74",
            "patch": "@@ -6,17 +6,51 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {global} from '../util/global';\n-import {CompilerFacade, ExportedCompilerFacade} from './compiler_facade_interface';\n+import {CompilerFacade, ExportedCompilerFacade, Type} from './compiler_facade_interface';\n export * from './compiler_facade_interface';\n \n-export function getCompilerFacade(): CompilerFacade {\n+export const enum JitCompilerUsage {\n+  Decorator,\n+  PartialDeclaration,\n+}\n+\n+interface JitCompilerUsageRequest {\n+  usage: JitCompilerUsage;\n+  kind: 'directive'|'component'|'pipe'|'injectable'|'NgModule';\n+  type: Type;\n+}\n+\n+export function getCompilerFacade(request: JitCompilerUsageRequest): CompilerFacade {\n   const globalNg: ExportedCompilerFacade = global['ng'];\n-  if (!globalNg || !globalNg.ɵcompilerFacade) {\n-    throw new Error(\n-        `Angular JIT compilation failed: '@angular/compiler' not loaded!\\n` +\n-        `  - JIT compilation is discouraged for production use-cases! Consider AOT mode instead.\\n` +\n-        `  - Did you bootstrap using '@angular/platform-browser-dynamic' or '@angular/platform-server'?\\n` +\n-        `  - Alternatively provide the compiler with 'import \"@angular/compiler\";' before bootstrapping.`);\n+  if (globalNg && globalNg.ɵcompilerFacade) {\n+    return globalNg.ɵcompilerFacade;\n+  }\n+\n+  if (typeof ngDevMode === 'undefined' || ngDevMode) {\n+    // Log the type as an error so that a developer can easily navigate to the type from the\n+    // console.\n+    console.error(`JIT compilation failed for ${request.kind}`, request.type);\n+\n+    let message = `The ${request.kind} '${\n+        request\n+            .type.name}' needs to be compiled using the JIT compiler, but '@angular/compiler' is not available.\\n\\n`;\n+    if (request.usage === JitCompilerUsage.PartialDeclaration) {\n+      message += `The ${request.kind} is part of a library that has been partially compiled.\\n`;\n+      message +=\n+          `However, the Angular Linker has not processed the library such that JIT compilation is used as fallback.\\n`;\n+      message += '\\n';\n+      message +=\n+          `Ideally, the library is processed using the Angular Linker to become fully AOT compiled.\\n`;\n+    } else {\n+      message +=\n+          `JIT compilation is discouraged for production use-cases! Consider using AOT mode instead.\\n`;\n+    }\n+    message +=\n+        `Alternatively, the JIT compiler should be loaded by bootstrapping using '@angular/platform-browser-dynamic' or '@angular/platform-server',\\n`;\n+    message +=\n+        `or manually provide the compiler with 'import \"@angular/compiler\";' before bootstrapping.`;\n+    throw new Error(message);\n+  } else {\n+    throw new Error('JIT compiler unavailable');\n   }\n-  return globalNg.ɵcompilerFacade;\n }"
        },
        {
            "sha": "43cab19ab57ff077cde63f47b5d4b9eba0044c9e",
            "filename": "packages/core/src/di/jit/injectable.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Fdi%2Fjit%2Finjectable.ts",
            "raw_url": "https://github.com/angular/angular/raw/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Fdi%2Fjit%2Finjectable.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fdi%2Fjit%2Finjectable.ts?ref=31593db489261bc2195350cb935e05540e36ca74",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {getCompilerFacade, R3InjectableMetadataFacade} from '../../compiler/compiler_facade';\n+import {getCompilerFacade, JitCompilerUsage, R3InjectableMetadataFacade} from '../../compiler/compiler_facade';\n import {Type} from '../../interface/type';\n import {NG_FACTORY_DEF} from '../../render3/fields';\n import {getClosureSafeProperty} from '../../util/property';\n@@ -33,7 +33,9 @@ export function compileInjectable(type: Type<any>, meta?: Injectable): void {\n     Object.defineProperty(type, NG_PROV_DEF, {\n       get: () => {\n         if (ngInjectableDef === null) {\n-          ngInjectableDef = getCompilerFacade().compileInjectable(\n+          const compiler =\n+              getCompilerFacade({usage: JitCompilerUsage.Decorator, kind: 'injectable', type});\n+          ngInjectableDef = compiler.compileInjectable(\n               angularCoreDiEnv, `ng:///${type.name}/ɵprov.js`, getInjectableMetadata(type, meta));\n         }\n         return ngInjectableDef;\n@@ -46,7 +48,8 @@ export function compileInjectable(type: Type<any>, meta?: Injectable): void {\n     Object.defineProperty(type, NG_FACTORY_DEF, {\n       get: () => {\n         if (ngFactoryDef === null) {\n-          const compiler = getCompilerFacade();\n+          const compiler =\n+              getCompilerFacade({usage: JitCompilerUsage.Decorator, kind: 'injectable', type});\n           ngFactoryDef = compiler.compileFactory(angularCoreDiEnv, `ng:///${type.name}/ɵfac.js`, {\n             name: type.name,\n             type,"
        },
        {
            "sha": "cf241f51a1f98ce2c0fe83cae1751d9eb3208aad",
            "filename": "packages/core/src/render3/jit/directive.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fdirective.ts",
            "raw_url": "https://github.com/angular/angular/raw/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fdirective.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fdirective.ts?ref=31593db489261bc2195350cb935e05540e36ca74",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {getCompilerFacade, R3DirectiveMetadataFacade} from '../../compiler/compiler_facade';\n+import {getCompilerFacade, JitCompilerUsage, R3DirectiveMetadataFacade} from '../../compiler/compiler_facade';\n import {R3ComponentMetadataFacade, R3QueryMetadataFacade} from '../../compiler/compiler_facade_interface';\n import {resolveForwardRef} from '../../di/forward_ref';\n import {getReflect, reflectDependencies} from '../../di/jit/util';\n@@ -68,7 +68,8 @@ export function compileComponent(type: Type<any>, metadata: Component): void {\n   Object.defineProperty(type, NG_COMP_DEF, {\n     get: () => {\n       if (ngComponentDef === null) {\n-        const compiler = getCompilerFacade();\n+        const compiler =\n+            getCompilerFacade({usage: JitCompilerUsage.Decorator, kind: 'component', type: type});\n \n         if (componentNeedsResolution(metadata)) {\n           const error = [`Component '${type.name}' is not resolved:`];\n@@ -180,8 +181,10 @@ export function compileDirective(type: Type<any>, directive: Directive|null): vo\n         // that use `@Directive()` with no selector. In that case, pass empty object to the\n         // `directiveMetadata` function instead of null.\n         const meta = getDirectiveMetadata(type, directive || {});\n+        const compiler =\n+            getCompilerFacade({usage: JitCompilerUsage.Decorator, kind: 'directive', type});\n         ngDirectiveDef =\n-            getCompilerFacade().compileDirective(angularCoreEnv, meta.sourceMapUrl, meta.metadata);\n+            compiler.compileDirective(angularCoreEnv, meta.sourceMapUrl, meta.metadata);\n       }\n       return ngDirectiveDef;\n     },\n@@ -193,7 +196,7 @@ export function compileDirective(type: Type<any>, directive: Directive|null): vo\n function getDirectiveMetadata(type: Type<any>, metadata: Directive) {\n   const name = type && type.name;\n   const sourceMapUrl = `ng:///${name}/ɵdir.js`;\n-  const compiler = getCompilerFacade();\n+  const compiler = getCompilerFacade({usage: JitCompilerUsage.Decorator, kind: 'directive', type});\n   const facade = directiveMetadata(type as ComponentType<any>, metadata);\n   facade.typeSourceSpan = compiler.createParseSourceSpan('Directive', name, sourceMapUrl);\n   if (facade.usesInheritance) {\n@@ -209,7 +212,8 @@ function addDirectiveFactoryDef(type: Type<any>, metadata: Directive|Component)\n     get: () => {\n       if (ngFactoryDef === null) {\n         const meta = getDirectiveMetadata(type, metadata);\n-        const compiler = getCompilerFacade();\n+        const compiler =\n+            getCompilerFacade({usage: JitCompilerUsage.Decorator, kind: 'directive', type});\n         ngFactoryDef = compiler.compileFactory(angularCoreEnv, `ng:///${type.name}/ɵfac.js`, {\n           name: meta.metadata.name,\n           type: meta.metadata.type,"
        },
        {
            "sha": "e636138a1fba227546b0523fa01dc7332f7b4f74",
            "filename": "packages/core/src/render3/jit/module.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 18,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fmodule.ts",
            "raw_url": "https://github.com/angular/angular/raw/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fmodule.ts?ref=31593db489261bc2195350cb935e05540e36ca74",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {getCompilerFacade, R3InjectorMetadataFacade} from '../../compiler/compiler_facade';\n+import {getCompilerFacade, JitCompilerUsage, R3InjectorMetadataFacade} from '../../compiler/compiler_facade';\n import {resolveForwardRef} from '../../di/forward_ref';\n import {NG_INJ_DEF} from '../../di/interface/defs';\n import {reflectDependencies} from '../../di/jit/util';\n@@ -114,20 +114,21 @@ export function compileNgModuleDefs(\n           // go into an infinite loop before we've reached the point where we throw all the errors.\n           throw new Error(`'${stringifyForError(moduleType)}' module can't import itself`);\n         }\n-        ngModuleDef = getCompilerFacade().compileNgModule(\n-            angularCoreEnv, `ng:///${moduleType.name}/ɵmod.js`, {\n-              type: moduleType,\n-              bootstrap: flatten(ngModule.bootstrap || EMPTY_ARRAY).map(resolveForwardRef),\n-              declarations: declarations.map(resolveForwardRef),\n-              imports: flatten(ngModule.imports || EMPTY_ARRAY)\n-                           .map(resolveForwardRef)\n-                           .map(expandModuleWithProviders),\n-              exports: flatten(ngModule.exports || EMPTY_ARRAY)\n-                           .map(resolveForwardRef)\n-                           .map(expandModuleWithProviders),\n-              schemas: ngModule.schemas ? flatten(ngModule.schemas) : null,\n-              id: ngModule.id || null,\n-            });\n+        const compiler = getCompilerFacade(\n+            {usage: JitCompilerUsage.Decorator, kind: 'NgModule', type: moduleType});\n+        ngModuleDef = compiler.compileNgModule(angularCoreEnv, `ng:///${moduleType.name}/ɵmod.js`, {\n+          type: moduleType,\n+          bootstrap: flatten(ngModule.bootstrap || EMPTY_ARRAY).map(resolveForwardRef),\n+          declarations: declarations.map(resolveForwardRef),\n+          imports: flatten(ngModule.imports || EMPTY_ARRAY)\n+                       .map(resolveForwardRef)\n+                       .map(expandModuleWithProviders),\n+          exports: flatten(ngModule.exports || EMPTY_ARRAY)\n+                       .map(resolveForwardRef)\n+                       .map(expandModuleWithProviders),\n+          schemas: ngModule.schemas ? flatten(ngModule.schemas) : null,\n+          id: ngModule.id || null,\n+        });\n         // Set `schemas` on ngModuleDef to an empty array in JIT mode to indicate that runtime\n         // should verify that there are no unknown elements in a template. In AOT mode, that check\n         // happens at compile time and `schemas` information is not present on Component and Module\n@@ -144,7 +145,8 @@ export function compileNgModuleDefs(\n   Object.defineProperty(moduleType, NG_FACTORY_DEF, {\n     get: () => {\n       if (ngFactoryDef === null) {\n-        const compiler = getCompilerFacade();\n+        const compiler = getCompilerFacade(\n+            {usage: JitCompilerUsage.Decorator, kind: 'NgModule', type: moduleType});\n         ngFactoryDef = compiler.compileFactory(angularCoreEnv, `ng:///${moduleType.name}/ɵfac.js`, {\n           name: moduleType.name,\n           type: moduleType,\n@@ -175,8 +177,10 @@ export function compileNgModuleDefs(\n             (ngModule.exports || EMPTY_ARRAY).map(resolveForwardRef),\n           ],\n         };\n-        ngInjectorDef = getCompilerFacade().compileInjector(\n-            angularCoreEnv, `ng:///${moduleType.name}/ɵinj.js`, meta);\n+        const compiler = getCompilerFacade(\n+            {usage: JitCompilerUsage.Decorator, kind: 'NgModule', type: moduleType});\n+        ngInjectorDef =\n+            compiler.compileInjector(angularCoreEnv, `ng:///${moduleType.name}/ɵinj.js`, meta);\n       }\n       return ngInjectorDef;\n     },"
        },
        {
            "sha": "99aa53ac34b79656497834190e0a8b04fe6d415e",
            "filename": "packages/core/src/render3/jit/partial.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 8,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts",
            "raw_url": "https://github.com/angular/angular/raw/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts?ref=31593db489261bc2195350cb935e05540e36ca74",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {getCompilerFacade, R3DeclareComponentFacade, R3DeclareDirectiveFacade, R3DeclareFactoryFacade, R3DeclareInjectableFacade, R3DeclareInjectorFacade, R3DeclareNgModuleFacade, R3DeclarePipeFacade} from '../../compiler/compiler_facade';\n+import {FactoryTarget, getCompilerFacade, JitCompilerUsage, R3DeclareComponentFacade, R3DeclareDirectiveFacade, R3DeclareFactoryFacade, R3DeclareInjectableFacade, R3DeclareInjectorFacade, R3DeclareNgModuleFacade, R3DeclarePipeFacade} from '../../compiler/compiler_facade';\n import {Type} from '../../interface/type';\n import {setClassMetadata} from '../metadata';\n import {angularCoreEnv} from './environment';\n@@ -17,7 +17,8 @@ import {angularCoreEnv} from './environment';\n  * @codeGenApi\n  */\n export function ɵɵngDeclareDirective(decl: R3DeclareDirectiveFacade): unknown {\n-  const compiler = getCompilerFacade();\n+  const compiler = getCompilerFacade(\n+      {usage: JitCompilerUsage.PartialDeclaration, kind: 'directive', type: decl.type});\n   return compiler.compileDirectiveDeclaration(\n       angularCoreEnv, `ng:///${decl.type.name}/ɵfac.js`, decl);\n }\n@@ -42,7 +43,8 @@ export function ɵɵngDeclareClassMetadata(decl: {\n  * @codeGenApi\n  */\n export function ɵɵngDeclareComponent(decl: R3DeclareComponentFacade): unknown {\n-  const compiler = getCompilerFacade();\n+  const compiler = getCompilerFacade(\n+      {usage: JitCompilerUsage.PartialDeclaration, kind: 'component', type: decl.type});\n   return compiler.compileComponentDeclaration(\n       angularCoreEnv, `ng:///${decl.type.name}/ɵcmp.js`, decl);\n }\n@@ -53,18 +55,38 @@ export function ɵɵngDeclareComponent(decl: R3DeclareComponentFacade): unknown\n  * @codeGenApi\n  */\n export function ɵɵngDeclareFactory(decl: R3DeclareFactoryFacade): unknown {\n-  const compiler = getCompilerFacade();\n+  const compiler = getCompilerFacade({\n+    usage: JitCompilerUsage.PartialDeclaration,\n+    kind: getFactoryKind(decl.target),\n+    type: decl.type\n+  });\n   return compiler.compileFactoryDeclaration(\n       angularCoreEnv, `ng:///${decl.type.name}/ɵfac.js`, decl);\n }\n \n+function getFactoryKind(target: FactoryTarget) {\n+  switch (target) {\n+    case FactoryTarget.Directive:\n+      return 'directive';\n+    case FactoryTarget.Component:\n+      return 'component';\n+    case FactoryTarget.Injectable:\n+      return 'injectable';\n+    case FactoryTarget.Pipe:\n+      return 'pipe';\n+    case FactoryTarget.NgModule:\n+      return 'NgModule';\n+  }\n+}\n+\n /**\n  * Compiles a partial injectable declaration object into a full injectable definition object.\n  *\n  * @codeGenApi\n  */\n export function ɵɵngDeclareInjectable(decl: R3DeclareInjectableFacade): unknown {\n-  const compiler = getCompilerFacade();\n+  const compiler = getCompilerFacade(\n+      {usage: JitCompilerUsage.PartialDeclaration, kind: 'injectable', type: decl.type});\n   return compiler.compileInjectableDeclaration(\n       angularCoreEnv, `ng:///${decl.type.name}/ɵprov.js`, decl);\n }\n@@ -80,7 +102,8 @@ export {FactoryTarget} from '../../compiler/compiler_facade';\n  * @codeGenApi\n  */\n export function ɵɵngDeclareInjector(decl: R3DeclareInjectorFacade): unknown {\n-  const compiler = getCompilerFacade();\n+  const compiler = getCompilerFacade(\n+      {usage: JitCompilerUsage.PartialDeclaration, kind: 'NgModule', type: decl.type});\n   return compiler.compileInjectorDeclaration(\n       angularCoreEnv, `ng:///${decl.type.name}/ɵinj.js`, decl);\n }\n@@ -91,7 +114,8 @@ export function ɵɵngDeclareInjector(decl: R3DeclareInjectorFacade): unknown {\n  * @codeGenApi\n  */\n export function ɵɵngDeclareNgModule(decl: R3DeclareNgModuleFacade): unknown {\n-  const compiler = getCompilerFacade();\n+  const compiler = getCompilerFacade(\n+      {usage: JitCompilerUsage.PartialDeclaration, kind: 'NgModule', type: decl.type});\n   return compiler.compileNgModuleDeclaration(\n       angularCoreEnv, `ng:///${decl.type.name}/ɵmod.js`, decl);\n }\n@@ -102,6 +126,7 @@ export function ɵɵngDeclareNgModule(decl: R3DeclareNgModuleFacade): unknown {\n  * @codeGenApi\n  */\n export function ɵɵngDeclarePipe(decl: R3DeclarePipeFacade): unknown {\n-  const compiler = getCompilerFacade();\n+  const compiler = getCompilerFacade(\n+      {usage: JitCompilerUsage.PartialDeclaration, kind: 'pipe', type: decl.type});\n   return compiler.compilePipeDeclaration(angularCoreEnv, `ng:///${decl.type.name}/ɵpipe.js`, decl);\n }"
        },
        {
            "sha": "7bc4abe7464d2d8697dc9924cad8019b9445ea51",
            "filename": "packages/core/src/render3/jit/pipe.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpipe.ts",
            "raw_url": "https://github.com/angular/angular/raw/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpipe.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpipe.ts?ref=31593db489261bc2195350cb935e05540e36ca74",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {getCompilerFacade, R3PipeMetadataFacade} from '../../compiler/compiler_facade';\n+import {getCompilerFacade, JitCompilerUsage, R3PipeMetadataFacade} from '../../compiler/compiler_facade';\n import {reflectDependencies} from '../../di/jit/util';\n import {Type} from '../../interface/type';\n import {Pipe} from '../../metadata/directives';\n@@ -22,7 +22,8 @@ export function compilePipe(type: Type<any>, meta: Pipe): void {\n     get: () => {\n       if (ngFactoryDef === null) {\n         const metadata = getPipeMetadata(type, meta);\n-        const compiler = getCompilerFacade();\n+        const compiler = getCompilerFacade(\n+            {usage: JitCompilerUsage.Decorator, kind: 'pipe', type: metadata.type});\n         ngFactoryDef = compiler.compileFactory(angularCoreEnv, `ng:///${metadata.name}/ɵfac.js`, {\n           name: metadata.name,\n           type: metadata.type,\n@@ -41,8 +42,10 @@ export function compilePipe(type: Type<any>, meta: Pipe): void {\n     get: () => {\n       if (ngPipeDef === null) {\n         const metadata = getPipeMetadata(type, meta);\n-        ngPipeDef = getCompilerFacade().compilePipe(\n-            angularCoreEnv, `ng:///${metadata.name}/ɵpipe.js`, metadata);\n+        const compiler = getCompilerFacade(\n+            {usage: JitCompilerUsage.Decorator, kind: 'pipe', type: metadata.type});\n+        ngPipeDef =\n+            compiler.compilePipe(angularCoreEnv, `ng:///${metadata.name}/ɵpipe.js`, metadata);\n       }\n       return ngPipeDef;\n     },"
        },
        {
            "sha": "95f8ca8b39cb919664f493e7fbfe736f7a975db2",
            "filename": "packages/core/test/compiler/BUILD.bazel",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Ftest%2Fcompiler%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Ftest%2Fcompiler%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fcompiler%2FBUILD.bazel?ref=31593db489261bc2195350cb935e05540e36ca74",
            "patch": "@@ -0,0 +1,30 @@\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"karma_web_test_suite\", \"ts_library\")\n+\n+package(default_visibility = [\"//visibility:private\"])\n+\n+ts_library(\n+    name = \"compiler_lib\",\n+    testonly = True,\n+    srcs = glob(\n+        [\"**/*.ts\"],\n+    ),\n+    deps = [\n+        \"//packages/core/src/compiler\",\n+        \"//packages/core/src/util\",\n+    ],\n+)\n+\n+jasmine_node_test(\n+    name = \"compiler\",\n+    bootstrap = [\"//tools/testing:node_es5\"],\n+    deps = [\n+        \":compiler_lib\",\n+    ],\n+)\n+\n+karma_web_test_suite(\n+    name = \"compiler_web\",\n+    deps = [\n+        \":compiler_lib\",\n+    ],\n+)"
        },
        {
            "sha": "6878c86442e510e34d0a33371c0b3c89de11f61a",
            "filename": "packages/core/test/compiler/compiler_facade_spec.ts",
            "status": "added",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/angular/angular/blob/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Ftest%2Fcompiler%2Fcompiler_facade_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/31593db489261bc2195350cb935e05540e36ca74/packages%2Fcore%2Ftest%2Fcompiler%2Fcompiler_facade_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fcompiler%2Fcompiler_facade_spec.ts?ref=31593db489261bc2195350cb935e05540e36ca74",
            "patch": "@@ -0,0 +1,69 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {getCompilerFacade, JitCompilerUsage} from '../../src/compiler/compiler_facade';\n+import {CompilerFacade, ExportedCompilerFacade} from '../../src/compiler/compiler_facade_interface';\n+import {global} from '../../src/util/global';\n+\n+describe('getCompilerFacade', () => {\n+  describe('errors', () => {\n+    beforeEach(clearCompilerFacade);\n+    afterEach(restoreCompilerFacade);\n+\n+    it('reports an error when requested for a decorator', () => {\n+      try {\n+        getCompilerFacade({usage: JitCompilerUsage.Decorator, kind: 'directive', type: TestClass});\n+        fail('Error expected as compiler facade is not available');\n+      } catch (e) {\n+        expect(e.message).toEqual(\n+            `The directive 'TestClass' needs to be compiled using the JIT compiler, but '@angular/compiler' is not available.\n+\n+JIT compilation is discouraged for production use-cases! Consider using AOT mode instead.\n+Alternatively, the JIT compiler should be loaded by bootstrapping using '@angular/platform-browser-dynamic' or '@angular/platform-server',\n+or manually provide the compiler with 'import \"@angular/compiler\";' before bootstrapping.`);\n+      }\n+    });\n+\n+    it('reports an error when requested for a partial declaration', () => {\n+      try {\n+        getCompilerFacade(\n+            {usage: JitCompilerUsage.PartialDeclaration, kind: 'directive', type: TestClass});\n+        fail('Error expected as compiler facade is not available');\n+      } catch (e) {\n+        expect(e.message).toEqual(\n+            `The directive 'TestClass' needs to be compiled using the JIT compiler, but '@angular/compiler' is not available.\n+\n+The directive is part of a library that has been partially compiled.\n+However, the Angular Linker has not processed the library such that JIT compilation is used as fallback.\n+\n+Ideally, the library is processed using the Angular Linker to become fully AOT compiled.\n+Alternatively, the JIT compiler should be loaded by bootstrapping using '@angular/platform-browser-dynamic' or '@angular/platform-server',\n+or manually provide the compiler with 'import \"@angular/compiler\";' before bootstrapping.`);\n+      }\n+    });\n+  });\n+});\n+\n+class TestClass {}\n+\n+let ɵcompilerFacade: CompilerFacade|null = null;\n+\n+function clearCompilerFacade() {\n+  const ng: ExportedCompilerFacade = global.ng;\n+  ɵcompilerFacade = ng.ɵcompilerFacade;\n+  ng.ɵcompilerFacade = undefined!;\n+}\n+\n+function restoreCompilerFacade() {\n+  if (ɵcompilerFacade === null) {\n+    return;\n+  }\n+  const ng: ExportedCompilerFacade = global.ng;\n+  ng.ɵcompilerFacade = ɵcompilerFacade;\n+  ɵcompilerFacade = null;\n+}"
        }
    ],
    "stats": {
        "total": 274,
        "additions": 225,
        "deletions": 49
    }
}