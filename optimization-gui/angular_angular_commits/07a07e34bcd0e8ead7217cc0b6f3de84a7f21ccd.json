{
    "author": "petebacondarwin",
    "message": "fix(compiler-cli): only read source-map comment from last line (#32912)\n\nSource-maps can be linked to from a source-file by a comment at\nthe end of the file.\n\nPreviously the `SourceFileLoader` would read\nthe first comment that matched `//# sourceMappingURL=` but\nthis is not valid since some bundlers may include embedded\nsource-files that contain such a comment.\n\nNow we only look for this comment in the last non-empty line\nin the file.\n\nPR Close #32912",
    "sha": "07a07e34bcd0e8ead7217cc0b6f3de84a7f21ccd",
    "files": [
        {
            "sha": "395a1ad62e5666e8f497c15a5f97c50ac78420f7",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/src/source_file_loader.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/07a07e34bcd0e8ead7217cc0b6f3de84a7f21ccd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts",
            "raw_url": "https://github.com/angular/angular/raw/07a07e34bcd0e8ead7217cc0b6f3de84a7f21ccd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts?ref=07a07e34bcd0e8ead7217cc0b6f3de84a7f21ccd",
            "patch": "@@ -102,12 +102,16 @@ export class SourceFileLoader {\n    * whose path is indicated in a comment or implied from the name of the source file itself.\n    */\n   private loadSourceMap(sourcePath: AbsoluteFsPath, contents: string): MapAndPath|null {\n-    const inline = commentRegex.exec(contents);\n+    // Only consider a source-map comment from the last non-empty line of the file, in case there\n+    // are embedded source-map comments elsewhere in the file (as can be the case with bundlers like\n+    // webpack).\n+    const lastLine = this.getLastNonEmptyLine(contents);\n+    const inline = commentRegex.exec(lastLine);\n     if (inline !== null) {\n       return {map: fromComment(inline.pop()!).sourcemap, mapPath: null};\n     }\n \n-    const external = mapFileCommentRegex.exec(contents);\n+    const external = mapFileCommentRegex.exec(lastLine);\n     if (external) {\n       try {\n         const fileName = external[1] || external[2];\n@@ -175,6 +179,20 @@ export class SourceFileLoader {\n     this.currentPaths.push(path);\n   }\n \n+  private getLastNonEmptyLine(contents: string): string {\n+    let trailingWhitespaceIndex = contents.length - 1;\n+    while (trailingWhitespaceIndex > 0 &&\n+           (contents[trailingWhitespaceIndex] === '\\n' ||\n+            contents[trailingWhitespaceIndex] === '\\r')) {\n+      trailingWhitespaceIndex--;\n+    }\n+    let lastRealLineIndex = contents.lastIndexOf('\\n', trailingWhitespaceIndex - 1);\n+    if (lastRealLineIndex === -1) {\n+      lastRealLineIndex = 0;\n+    }\n+    return contents.substr(lastRealLineIndex + 1);\n+  }\n+\n   /**\n    * Replace any matched URL schemes with their corresponding path held in the schemeMap.\n    *"
        },
        {
            "sha": "9686355a5e4541c59bf8a8c2f9fbe3749bb2ecde",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/test/source_file_loader_spec.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/07a07e34bcd0e8ead7217cc0b6f3de84a7f21ccd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_loader_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/07a07e34bcd0e8ead7217cc0b6f3de84a7f21ccd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_loader_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_loader_spec.ts?ref=07a07e34bcd0e8ead7217cc0b6f3de84a7f21ccd",
            "patch": "@@ -63,6 +63,44 @@ runInEachFileSystem(() => {\n         expect(sourceFile.rawMap).toEqual(sourceMap);\n       });\n \n+      it('should only read source-map comments from the last line of a file', () => {\n+        fs.ensureDir(_('/foo/src'));\n+        const sourceMap = createRawSourceMap({file: 'index.js'});\n+        fs.writeFile(_('/foo/src/external.js.map'), JSON.stringify(sourceMap));\n+        const sourceFile = registry.loadSourceFile(_('/foo/src/index.js'), [\n+          'some content',\n+          '//# sourceMappingURL=bad.js.map',\n+          'some more content',\n+          '//# sourceMappingURL=external.js.map',\n+        ].join('\\n'));\n+        if (sourceFile === null) {\n+          return fail('Expected source file to be defined');\n+        }\n+        expect(sourceFile.rawMap).toEqual(sourceMap);\n+      });\n+\n+      for (const eolMarker of ['\\n', '\\r\\n']) {\n+        it(`should only read source-map comments from the last non-blank line of a file [EOL marker: ${\n+               eolMarker === '\\n' ? '\\\\n' : '\\\\r\\\\n'}]`,\n+           () => {\n+             fs.ensureDir(_('/foo/src'));\n+             const sourceMap = createRawSourceMap({file: 'index.js'});\n+             fs.writeFile(_('/foo/src/external.js.map'), JSON.stringify(sourceMap));\n+             const sourceFile = registry.loadSourceFile(_('/foo/src/index.js'), [\n+               'some content',\n+               '//# sourceMappingURL=bad.js.map',\n+               'some more content',\n+               '//# sourceMappingURL=external.js.map',\n+               '',\n+               '',\n+             ].join(eolMarker));\n+             if (sourceFile === null) {\n+               return fail('Expected source file to be defined');\n+             }\n+             expect(sourceFile.rawMap).toEqual(sourceMap);\n+           });\n+      }\n+\n       it('should handle a missing external source map', () => {\n         fs.ensureDir(_('/foo/src'));\n         const sourceFile = registry.loadSourceFile("
        }
    ],
    "stats": {
        "total": 60,
        "additions": 58,
        "deletions": 2
    }
}