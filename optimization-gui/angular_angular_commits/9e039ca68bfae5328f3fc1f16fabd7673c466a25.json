{
    "author": "atscott",
    "message": "fix(router): Only trigger router navigation on `popstate` events from `Location` subscription (#43328)\n\nWith the merging of #41730, our tests now more closely emulate real\nbrowser behavior. This means that we can make changes to the `Router` which depend\non actual browser behavior rather than incorrectly mocked test behavior.\n\nThis change updates the logic in the `Router` to only trigger\nnavigations on `popstate` events. Since our `SpyLocation` now triggers\nthe `popstate` event correctly on `simulateHashChange`, `back`,\n`forward`, and `simulatePopState`, we are able to rely on this being\ntrue for all of these navigations in tests when using `SpyLocation` (the\ndefault for `RouterTestingModule`).\n\nIn addition, this behavior relies on documented browser behavior: The\n`popstate` event happens due to browser transitions as a result of user\ntriggered \"back\" button or otherwise.\nhttps://developer.mozilla.org/en-US/docs/Web/API/Window/popstate_event#when_popstate_is_sent\n\nIn addition, this change chooses `popstate` over `hashchange` because it\nis the event that is already being used for navigations since the\ndocumented behavior of browsers is that `popstate` happens before\n`hashchange`.\n\nfixes #41782\n\nPR Close #43328",
    "sha": "9e039ca68bfae5328f3fc1f16fabd7673c466a25",
    "files": [
        {
            "sha": "9704039f78bc189eae46ff9c70ec8f2caf990957",
            "filename": "packages/router/src/router.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 57,
            "changes": 65,
            "blob_url": "https://github.com/angular/angular/blob/9e039ca68bfae5328f3fc1f16fabd7673c466a25/packages%2Frouter%2Fsrc%2Frouter.ts",
            "raw_url": "https://github.com/angular/angular/raw/9e039ca68bfae5328f3fc1f16fabd7673c466a25/packages%2Frouter%2Fsrc%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter.ts?ref=9e039ca68bfae5328f3fc1f16fabd7673c466a25",
            "patch": "@@ -351,16 +351,6 @@ function defaultRouterHook(snapshot: RouterStateSnapshot, runExtras: {\n   return of(null) as any;\n }\n \n-/**\n- * Information related to a location change, necessary for scheduling follow-up Router navigations.\n- */\n-type LocationChangeInfo = {\n-  source: 'popstate'|'hashchange',\n-  urlTree: UrlTree,\n-  state: RestoredState|null,\n-  transitionId: number\n-};\n-\n /**\n  * The equivalent `IsActiveMatchOptions` options for `Router.isActive` is called with `true`\n  * (exact = true).\n@@ -407,11 +397,6 @@ export class Router {\n   private disposed = false;\n \n   private locationSubscription?: SubscriptionLike;\n-  /**\n-   * Tracks the previously seen location change from the location subscription so we can compare\n-   * the two latest to see if they are duplicates. See setUpLocationChangeListener.\n-   */\n-  private lastLocationChangeInfo: LocationChangeInfo|null = null;\n   private navigationId: number = 0;\n \n   /**\n@@ -1039,13 +1024,15 @@ export class Router {\n     // run into ngZone\n     if (!this.locationSubscription) {\n       this.locationSubscription = this.location.subscribe(event => {\n-        const currentChange = this.extractLocationChangeInfoFromEvent(event);\n-        // The `setTimeout` was added in #12160 and is likely to support Angular/AngularJS\n-        // hybrid apps.\n-        if (this.shouldScheduleNavigation(this.lastLocationChangeInfo, currentChange)) {\n+        const source = event['type'] === 'popstate' ? 'popstate' : 'hashchange';\n+        if (source === 'popstate') {\n+          // The `setTimeout` was added in #12160 and is likely to support Angular/AngularJS\n+          // hybrid apps.\n           setTimeout(() => {\n-            const {source, state, urlTree} = currentChange;\n             const extras: NavigationExtras = {replaceUrl: true};\n+            // Navigations coming from Angular router have a navigationId state\n+            // property. When this exists, restore the state.\n+            const state = event.state?.navigationId ? event.state : null;\n             if (state) {\n               const stateCopy = {...state} as Partial<RestoredState>;\n               delete stateCopy.navigationId;\n@@ -1054,50 +1041,14 @@ export class Router {\n                 extras.state = stateCopy;\n               }\n             }\n+            const urlTree = this.parseUrl(event['url']!);\n             this.scheduleNavigation(urlTree, source, state, extras);\n           }, 0);\n         }\n-        this.lastLocationChangeInfo = currentChange;\n       });\n     }\n   }\n \n-  /** Extracts router-related information from a `PopStateEvent`. */\n-  private extractLocationChangeInfoFromEvent(change: PopStateEvent): LocationChangeInfo {\n-    return {\n-      source: change['type'] === 'popstate' ? 'popstate' : 'hashchange',\n-      urlTree: this.parseUrl(change['url']!),\n-      // Navigations coming from Angular router have a navigationId state\n-      // property. When this exists, restore the state.\n-      state: change.state?.navigationId ? change.state : null,\n-      transitionId: this.getTransition().id\n-    } as const;\n-  }\n-\n-  /**\n-   * Determines whether two events triggered by the Location subscription are due to the same\n-   * navigation. The location subscription can fire two events (popstate and hashchange) for a\n-   * single navigation. The second one should be ignored, that is, we should not schedule another\n-   * navigation in the Router.\n-   */\n-  private shouldScheduleNavigation(previous: LocationChangeInfo|null, current: LocationChangeInfo):\n-      boolean {\n-    if (!previous) return true;\n-\n-    const sameDestination = current.urlTree.toString() === previous.urlTree.toString();\n-    const eventsOccurredAtSameTime = current.transitionId === previous.transitionId;\n-    if (!eventsOccurredAtSameTime || !sameDestination) {\n-      return true;\n-    }\n-\n-    if ((current.source === 'hashchange' && previous.source === 'popstate') ||\n-        (current.source === 'popstate' && previous.source === 'hashchange')) {\n-      return false;\n-    }\n-\n-    return true;\n-  }\n-\n   /** The current URL. */\n   get url(): string {\n     return this.serializeUrl(this.currentUrlTree);"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 8,
        "deletions": 57
    }
}