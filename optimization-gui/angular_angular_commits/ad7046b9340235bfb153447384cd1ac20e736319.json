{
    "author": "AndrewKushnir",
    "message": "feat(forms): AbstractControl to store raw validators in addition to combined validators function (#37881)\n\nThis commit refactors the way we store validators in AbstractControl-based classes:\nin addition to the combined validators function that we have, we also store the original list of validators.\nThis is needed to have an ability to clean them up later at destroy time (currently it's problematic since\nthey are combined in a single function).\n\nThe change preserves backwards compatibility by making sure public APIs stay the same.\nThe only public API update is the change to the `AbstractControl` class constructor to extend the set\nof possible types that it can accept and process (which should not be breaking).\n\nPR Close #37881",
    "sha": "ad7046b9340235bfb153447384cd1ac20e736319",
    "files": [
        {
            "sha": "5733623c01fa1909c70a0a4107487016f657b2cf",
            "filename": "goldens/public-api/forms/forms.d.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/ad7046b9340235bfb153447384cd1ac20e736319/goldens%2Fpublic-api%2Fforms%2Fforms.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/ad7046b9340235bfb153447384cd1ac20e736319/goldens%2Fpublic-api%2Fforms%2Fforms.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fforms%2Fforms.d.ts?ref=ad7046b9340235bfb153447384cd1ac20e736319",
            "patch": "@@ -1,5 +1,6 @@\n export declare abstract class AbstractControl {\n-    asyncValidator: AsyncValidatorFn | null;\n+    get asyncValidator(): AsyncValidatorFn | null;\n+    set asyncValidator(asyncValidatorFn: AsyncValidatorFn | null);\n     get dirty(): boolean;\n     get disabled(): boolean;\n     get enabled(): boolean;\n@@ -15,10 +16,11 @@ export declare abstract class AbstractControl {\n     get untouched(): boolean;\n     get updateOn(): FormHooks;\n     get valid(): boolean;\n-    validator: ValidatorFn | null;\n+    get validator(): ValidatorFn | null;\n+    set validator(validatorFn: ValidatorFn | null);\n     readonly value: any;\n     readonly valueChanges: Observable<any>;\n-    constructor(validator: ValidatorFn | null, asyncValidator: AsyncValidatorFn | null);\n+    constructor(validators: ValidatorFn | ValidatorFn[] | null, asyncValidators: AsyncValidatorFn | AsyncValidatorFn[] | null);\n     clearAsyncValidators(): void;\n     clearValidators(): void;\n     disable(opts?: {"
        },
        {
            "sha": "20af33769fa82c70b45041faa89ada17196c05d7",
            "filename": "packages/forms/src/model.ts",
            "status": "modified",
            "additions": 103,
            "deletions": 24,
            "changes": 127,
            "blob_url": "https://github.com/angular/angular/blob/ad7046b9340235bfb153447384cd1ac20e736319/packages%2Fforms%2Fsrc%2Fmodel.ts",
            "raw_url": "https://github.com/angular/angular/raw/ad7046b9340235bfb153447384cd1ac20e736319/packages%2Fforms%2Fsrc%2Fmodel.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fmodel.ts?ref=ad7046b9340235bfb153447384cd1ac20e736319",
            "patch": "@@ -69,20 +69,38 @@ function _find(control: AbstractControl, path: Array<string|number>|string, deli\n   return controlToFind;\n }\n \n-function coerceToValidator(validatorOrOpts?: ValidatorFn|ValidatorFn[]|AbstractControlOptions|\n-                           null): ValidatorFn|null {\n-  const validator = isOptionsObj(validatorOrOpts) ? validatorOrOpts.validators : validatorOrOpts;\n+/**\n+ * Gets validators from either an options object or given validators.\n+ */\n+function pickValidators(validatorOrOpts?: ValidatorFn|ValidatorFn[]|AbstractControlOptions|\n+                        null): ValidatorFn|ValidatorFn[]|null {\n+  return (isOptionsObj(validatorOrOpts) ? validatorOrOpts.validators : validatorOrOpts) || null;\n+}\n+\n+/**\n+ * Creates validator function by combining provided validators.\n+ */\n+function coerceToValidator(validator: ValidatorFn|ValidatorFn[]|null): ValidatorFn|null {\n   return Array.isArray(validator) ? composeValidators(validator) : validator || null;\n }\n \n-function coerceToAsyncValidator(\n+/**\n+ * Gets async validators from either an options object or given validators.\n+ */\n+function pickAsyncValidators(\n     asyncValidator?: AsyncValidatorFn|AsyncValidatorFn[]|null,\n     validatorOrOpts?: ValidatorFn|ValidatorFn[]|AbstractControlOptions|null): AsyncValidatorFn|\n-    null {\n-  const origAsyncValidator =\n-      isOptionsObj(validatorOrOpts) ? validatorOrOpts.asyncValidators : asyncValidator;\n-  return Array.isArray(origAsyncValidator) ? composeAsyncValidators(origAsyncValidator) :\n-                                             origAsyncValidator || null;\n+    AsyncValidatorFn[]|null {\n+  return (isOptionsObj(validatorOrOpts) ? validatorOrOpts.asyncValidators : asyncValidator) || null;\n+}\n+\n+/**\n+ * Creates async validator function by combining provided async validators.\n+ */\n+function coerceToAsyncValidator(asyncValidator?: AsyncValidatorFn|AsyncValidatorFn[]|\n+                                null): AsyncValidatorFn|null {\n+  return Array.isArray(asyncValidator) ? composeAsyncValidators(asyncValidator) :\n+                                         asyncValidator || null;\n }\n \n export type FormHooks = 'change'|'blur'|'submit';\n@@ -159,6 +177,43 @@ export abstract class AbstractControl {\n   private _parent!: FormGroup|FormArray;\n   private _asyncValidationSubscription: any;\n \n+  /**\n+   * Contains the result of merging synchronous validators into a single validator function\n+   * (combined using `Validators.compose`).\n+   *\n+   * @internal\n+   */\n+  private _composedValidatorFn: ValidatorFn|null;\n+\n+  /**\n+   * Contains the result of merging asynchronous validators into a single validator function\n+   * (combined using `Validators.composeAsync`).\n+   *\n+   * @internal\n+   */\n+  private _composedAsyncValidatorFn: AsyncValidatorFn|null;\n+\n+  /**\n+   * Synchronous validators as they were provided:\n+   *  - in `AbstractControl` constructor\n+   *  - as an argument while calling `setValidators` function\n+   *  - while calling the setter on the `validator` field (e.g. `control.validator = validatorFn`)\n+   *\n+   * @internal\n+   */\n+  private _rawValidators: ValidatorFn|ValidatorFn[]|null;\n+\n+  /**\n+   * Asynchronous validators as they were provided:\n+   *  - in `AbstractControl` constructor\n+   *  - as an argument while calling `setAsyncValidators` function\n+   *  - while calling the setter on the `asyncValidator` field (e.g. `control.asyncValidator =\n+   * asyncValidatorFn`)\n+   *\n+   * @internal\n+   */\n+  private _rawAsyncValidators: AsyncValidatorFn|AsyncValidatorFn[]|null;\n+\n   /**\n    * The current value of the control.\n    *\n@@ -175,11 +230,39 @@ export abstract class AbstractControl {\n   /**\n    * Initialize the AbstractControl instance.\n    *\n-   * @param validator The function that determines the synchronous validity of this control.\n-   * @param asyncValidator The function that determines the asynchronous validity of this\n-   * control.\n+   * @param validators The function or array of functions that is used to determine the validity of\n+   *     this control synchronously.\n+   * @param asyncValidators The function or array of functions that is used to determine validity of\n+   *     this control asynchronously.\n+   */\n+  constructor(\n+      validators: ValidatorFn|ValidatorFn[]|null,\n+      asyncValidators: AsyncValidatorFn|AsyncValidatorFn[]|null) {\n+    this._rawValidators = validators;\n+    this._rawAsyncValidators = asyncValidators;\n+    this._composedValidatorFn = coerceToValidator(this._rawValidators);\n+    this._composedAsyncValidatorFn = coerceToAsyncValidator(this._rawAsyncValidators);\n+  }\n+\n+  /**\n+   * The function that is used to determine the validity of this control synchronously.\n    */\n-  constructor(public validator: ValidatorFn|null, public asyncValidator: AsyncValidatorFn|null) {}\n+  get validator(): ValidatorFn|null {\n+    return this._composedValidatorFn;\n+  }\n+  set validator(validatorFn: ValidatorFn|null) {\n+    this._rawValidators = this._composedValidatorFn = validatorFn;\n+  }\n+\n+  /**\n+   * The function that is used to determine the validity of this control asynchronously.\n+   */\n+  get asyncValidator(): AsyncValidatorFn|null {\n+    return this._composedAsyncValidatorFn;\n+  }\n+  set asyncValidator(asyncValidatorFn: AsyncValidatorFn|null) {\n+    this._rawAsyncValidators = this._composedAsyncValidatorFn = asyncValidatorFn;\n+  }\n \n   /**\n    * The parent control.\n@@ -349,7 +432,8 @@ export abstract class AbstractControl {\n    *\n    */\n   setValidators(newValidator: ValidatorFn|ValidatorFn[]|null): void {\n-    this.validator = coerceToValidator(newValidator);\n+    this._rawValidators = newValidator;\n+    this._composedValidatorFn = coerceToValidator(newValidator);\n   }\n \n   /**\n@@ -361,7 +445,8 @@ export abstract class AbstractControl {\n    *\n    */\n   setAsyncValidators(newValidator: AsyncValidatorFn|AsyncValidatorFn[]|null): void {\n-    this.asyncValidator = coerceToAsyncValidator(newValidator);\n+    this._rawAsyncValidators = newValidator;\n+    this._composedAsyncValidatorFn = coerceToAsyncValidator(newValidator);\n   }\n \n   /**\n@@ -1061,9 +1146,7 @@ export class FormControl extends AbstractControl {\n       formState: any = null,\n       validatorOrOpts?: ValidatorFn|ValidatorFn[]|AbstractControlOptions|null,\n       asyncValidator?: AsyncValidatorFn|AsyncValidatorFn[]|null) {\n-    super(\n-        coerceToValidator(validatorOrOpts),\n-        coerceToAsyncValidator(asyncValidator, validatorOrOpts));\n+    super(pickValidators(validatorOrOpts), pickAsyncValidators(asyncValidator, validatorOrOpts));\n     this._applyFormState(formState);\n     this._setUpdateStrategy(validatorOrOpts);\n     this.updateValueAndValidity({onlySelf: true, emitEvent: false});\n@@ -1316,9 +1399,7 @@ export class FormGroup extends AbstractControl {\n       public controls: {[key: string]: AbstractControl},\n       validatorOrOpts?: ValidatorFn|ValidatorFn[]|AbstractControlOptions|null,\n       asyncValidator?: AsyncValidatorFn|AsyncValidatorFn[]|null) {\n-    super(\n-        coerceToValidator(validatorOrOpts),\n-        coerceToAsyncValidator(asyncValidator, validatorOrOpts));\n+    super(pickValidators(validatorOrOpts), pickAsyncValidators(asyncValidator, validatorOrOpts));\n     this._initObservables();\n     this._setUpdateStrategy(validatorOrOpts);\n     this._setUpControls();\n@@ -1738,9 +1819,7 @@ export class FormArray extends AbstractControl {\n       public controls: AbstractControl[],\n       validatorOrOpts?: ValidatorFn|ValidatorFn[]|AbstractControlOptions|null,\n       asyncValidator?: AsyncValidatorFn|AsyncValidatorFn[]|null) {\n-    super(\n-        coerceToValidator(validatorOrOpts),\n-        coerceToAsyncValidator(asyncValidator, validatorOrOpts));\n+    super(pickValidators(validatorOrOpts), pickAsyncValidators(asyncValidator, validatorOrOpts));\n     this._initObservables();\n     this._setUpdateStrategy(validatorOrOpts);\n     this._setUpControls();"
        },
        {
            "sha": "46a65e743b443ade186f0a6054a1dac9eb8e5d7c",
            "filename": "packages/forms/test/form_control_spec.ts",
            "status": "modified",
            "additions": 104,
            "deletions": 0,
            "changes": 104,
            "blob_url": "https://github.com/angular/angular/blob/ad7046b9340235bfb153447384cd1ac20e736319/packages%2Fforms%2Ftest%2Fform_control_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ad7046b9340235bfb153447384cd1ac20e736319/packages%2Fforms%2Ftest%2Fform_control_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Fform_control_spec.ts?ref=ad7046b9340235bfb153447384cd1ac20e736319",
            "patch": "@@ -263,6 +263,57 @@ describe('FormControl', () => {\n       expect(c.valid).toEqual(true);\n     });\n \n+    it('should override validators using `setValidators` function', () => {\n+      const c = new FormControl('');\n+      expect(c.valid).toEqual(true);\n+\n+      c.setValidators([Validators.minLength(5), Validators.required]);\n+\n+      c.setValue('');\n+      expect(c.valid).toEqual(false);\n+\n+      c.setValue('abc');\n+      expect(c.valid).toEqual(false);\n+\n+      c.setValue('abcde');\n+      expect(c.valid).toEqual(true);\n+\n+      // Define new set of validators, overriding previously applied ones.\n+      c.setValidators([Validators.maxLength(2)]);\n+\n+      c.setValue('abcdef');\n+      expect(c.valid).toEqual(false);\n+\n+      c.setValue('a');\n+      expect(c.valid).toEqual(true);\n+    });\n+\n+    it('should override validators by setting `control.validator` field value', () => {\n+      const c = new FormControl('');\n+      expect(c.valid).toEqual(true);\n+\n+      // Define new set of validators, overriding previously applied ones.\n+      c.validator = Validators.compose([Validators.minLength(5), Validators.required]);\n+\n+      c.setValue('');\n+      expect(c.valid).toEqual(false);\n+\n+      c.setValue('abc');\n+      expect(c.valid).toEqual(false);\n+\n+      c.setValue('abcde');\n+      expect(c.valid).toEqual(true);\n+\n+      // Define new set of validators, overriding previously applied ones.\n+      c.validator = Validators.compose([Validators.maxLength(2)]);\n+\n+      c.setValue('abcdef');\n+      expect(c.valid).toEqual(false);\n+\n+      c.setValue('a');\n+      expect(c.valid).toEqual(true);\n+    });\n+\n     it('should clear validators', () => {\n       const c = new FormControl('', Validators.required);\n       expect(c.valid).toEqual(false);\n@@ -412,6 +463,59 @@ describe('FormControl', () => {\n          expect(c.valid).toEqual(true);\n        }));\n \n+    it('should override validators using `setAsyncValidators` function', fakeAsync(() => {\n+         const c = new FormControl('');\n+         expect(c.valid).toEqual(true);\n+\n+         c.setAsyncValidators([asyncValidator('expected')]);\n+\n+         c.setValue('');\n+         tick();\n+         expect(c.valid).toEqual(false);\n+\n+         c.setValue('expected');\n+         tick();\n+         expect(c.valid).toEqual(true);\n+\n+         // Define new set of validators, overriding previously applied ones.\n+         c.setAsyncValidators([asyncValidator('new expected')]);\n+\n+         c.setValue('expected');\n+         tick();\n+         expect(c.valid).toEqual(false);\n+\n+         c.setValue('new expected');\n+         tick();\n+         expect(c.valid).toEqual(true);\n+       }));\n+\n+    it('should override validators by setting `control.asyncValidator` field value',\n+       fakeAsync(() => {\n+         const c = new FormControl('');\n+         expect(c.valid).toEqual(true);\n+\n+         c.asyncValidator = Validators.composeAsync([asyncValidator('expected')]);\n+\n+         c.setValue('');\n+         tick();\n+         expect(c.valid).toEqual(false);\n+\n+         c.setValue('expected');\n+         tick();\n+         expect(c.valid).toEqual(true);\n+\n+         // Define new set of validators, overriding previously applied ones.\n+         c.asyncValidator = Validators.composeAsync([asyncValidator('new expected')]);\n+\n+         c.setValue('expected');\n+         tick();\n+         expect(c.valid).toEqual(false);\n+\n+         c.setValue('new expected');\n+         tick();\n+         expect(c.valid).toEqual(true);\n+       }));\n+\n     it('should clear async validators', fakeAsync(() => {\n          const c = new FormControl('value', [asyncValidator('expected'), otherAsyncValidator]);\n "
        }
    ],
    "stats": {
        "total": 239,
        "additions": 212,
        "deletions": 27
    }
}