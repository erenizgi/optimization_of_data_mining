{
    "author": "josephperrott",
    "message": "fix(platform-server): remove styles added by ServerStylesHost on destruction (#38367)\n\nWhen a ServerStylesHost instance is destroyed, all of the shared styles added to the DOM\nhead element by that instance should be removed.  Without this removal, over time a large\nnumber of style rules will build up and cause extra memory pressure.  This brings the\nServerStylesHost in line with the DomStylesHost used by the platform browser, which\nperforms this same cleanup.\n\nPR Close #38367",
    "sha": "e34c33cd46535b62b1578d4c632da90d8f2d6654",
    "files": [
        {
            "sha": "e8364cb1833cb9058c8351b56f14e3bd19a08484",
            "filename": "packages/platform-server/src/styles_host.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/e34c33cd46535b62b1578d4c632da90d8f2d6654/packages%2Fplatform-server%2Fsrc%2Fstyles_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/e34c33cd46535b62b1578d4c632da90d8f2d6654/packages%2Fplatform-server%2Fsrc%2Fstyles_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-server%2Fsrc%2Fstyles_host.ts?ref=e34c33cd46535b62b1578d4c632da90d8f2d6654",
            "patch": "@@ -13,6 +13,7 @@ import {ɵSharedStylesHost as SharedStylesHost, ɵTRANSITION_ID} from '@angular/\n @Injectable()\n export class ServerStylesHost extends SharedStylesHost {\n   private head: any = null;\n+  private _styleNodes = new Set<HTMLElement>();\n \n   constructor(\n       @Inject(DOCUMENT) private doc: any,\n@@ -29,9 +30,14 @@ export class ServerStylesHost extends SharedStylesHost {\n       el.setAttribute('ng-transition', this.transitionId);\n     }\n     this.head.appendChild(el);\n+    this._styleNodes.add(el);\n   }\n \n   onStylesAdded(additions: Set<string>) {\n     additions.forEach(style => this._addStyle(style));\n   }\n+\n+  ngOnDestroy() {\n+    this._styleNodes.forEach(styleNode => styleNode.remove());\n+  }\n }"
        },
        {
            "sha": "5a0056fb13c6a35e5b89b05d61187361c9de0d51",
            "filename": "packages/platform-server/test/server_styles_host_spec.ts",
            "status": "added",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/e34c33cd46535b62b1578d4c632da90d8f2d6654/packages%2Fplatform-server%2Ftest%2Fserver_styles_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e34c33cd46535b62b1578d4c632da90d8f2d6654/packages%2Fplatform-server%2Ftest%2Fserver_styles_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-server%2Ftest%2Fserver_styles_host_spec.ts?ref=e34c33cd46535b62b1578d4c632da90d8f2d6654",
            "patch": "@@ -0,0 +1,50 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {ɵgetDOM as getDOM} from '@angular/common';\n+import {ServerStylesHost} from '@angular/platform-server/src/styles_host';\n+\n+\n+(function() {\n+if (getDOM().supportsDOMEvents()) return;  // NODE only\n+\n+describe('ServerStylesHost', () => {\n+  let ssh: ServerStylesHost;\n+  let documentHead: Element;\n+  beforeEach(() => {\n+    const doc = getDOM().createHtmlDocument();\n+    ssh = new ServerStylesHost(doc, '');\n+    documentHead = doc.head;\n+    doc.querySelector('title')?.remove();\n+  });\n+\n+  it('should add existing styles', () => {\n+    ssh.addStyles(['a {};']);\n+    expect(documentHead.innerHTML).toEqual('<style>a {};</style>');\n+  });\n+\n+  it('should add new styles to hosts', () => {\n+    ssh.addStyles(['a {};']);\n+    expect(documentHead.innerHTML).toEqual('<style>a {};</style>');\n+  });\n+\n+  it('should add styles only once to hosts', () => {\n+    ssh.addStyles(['a {};']);\n+    ssh.addStyles(['a {};']);\n+    expect(documentHead.innerHTML).toEqual('<style>a {};</style>');\n+  });\n+\n+  it('should remove style nodes on destroy', () => {\n+    ssh.addStyles(['a {};']);\n+    expect(documentHead.innerHTML).toEqual('<style>a {};</style>');\n+\n+    ssh.ngOnDestroy();\n+    expect(documentHead.innerHTML).toEqual('');\n+  });\n+});\n+})();"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 56,
        "deletions": 0
    }
}