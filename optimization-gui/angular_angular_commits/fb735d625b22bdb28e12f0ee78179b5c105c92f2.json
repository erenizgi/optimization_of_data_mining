{
    "author": "gkalpak",
    "message": "refactor(service-worker): use nominal type for normalized URLs (#37922)\n\nSome ServiceWorker operations and methods require normalized URLs.\nPreviously, the generic `string` type was used.\n\nThis commit introduces a new `NormalizedUrl` type, a special kind of\n`string`, to make this requirement explicit and use the type system to\nenforce it.\n\nPR Close #37922",
    "sha": "fb735d625b22bdb28e12f0ee78179b5c105c92f2",
    "files": [
        {
            "sha": "5174ef670a515041d215e0de0650832e4aae40e9",
            "filename": "packages/service-worker/worker/src/adapter.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 8,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Fsrc%2Fadapter.ts",
            "raw_url": "https://github.com/angular/angular/raw/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Fsrc%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fadapter.ts?ref=fb735d625b22bdb28e12f0ee78179b5c105c92f2",
            "patch": "@@ -6,6 +6,9 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {NormalizedUrl} from './api';\n+\n+\n /**\n  * Adapts the service worker to its runtime environment.\n  *\n@@ -75,16 +78,10 @@ export class Adapter {\n    * @param url The raw request URL.\n    * @return A normalized representation of the URL.\n    */\n-  normalizeUrl(url: string): string {\n+  normalizeUrl(url: string): NormalizedUrl {\n     // Check the URL's origin against the ServiceWorker's.\n     const parsed = this.parseUrl(url, this.scopeUrl);\n-    if (parsed.origin === this.origin) {\n-      // The URL is relative to the SW's origin: Return the path only.\n-      return parsed.path;\n-    } else {\n-      // The URL is not relative to the SW's origin: Return the full URL.\n-      return url;\n-    }\n+    return (parsed.origin === this.origin ? parsed.path : url) as NormalizedUrl;\n   }\n \n   /**"
        },
        {
            "sha": "d597d7564887eb9ca73f3d3df2ca8a7e35187fea",
            "filename": "packages/service-worker/worker/src/api.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapi.ts?ref=fb735d625b22bdb28e12f0ee78179b5c105c92f2",
            "patch": "@@ -12,6 +12,18 @@ export enum UpdateCacheStatus {\n   CACHED,\n }\n \n+/**\n+ * A `string` representing a URL that has been normalized relative to an origin (usually that of the\n+ * ServiceWorker).\n+ *\n+ * If the URL is relative to the origin, then it is representated by the path part only. Otherwise,\n+ * the full URL is used.\n+ *\n+ * NOTE: A `string` is not assignable to a `NormalizedUrl`, but a `NormalizedUrl` is assignable to a\n+ *       `string`.\n+ */\n+export type NormalizedUrl = string&{_brand: 'normalizedUrl'};\n+\n /**\n  * A source for old versions of URL contents and other resources.\n  *\n@@ -27,7 +39,7 @@ export interface UpdateSource {\n    * If an old version of the resource doesn't exist, or exists but does\n    * not match the hash given, this returns null.\n    */\n-  lookupResourceWithHash(url: string, hash: string): Promise<Response|null>;\n+  lookupResourceWithHash(url: NormalizedUrl, hash: string): Promise<Response|null>;\n \n   /**\n    * Lookup an older version of a resource for which the hash is not known.\n@@ -37,15 +49,15 @@ export interface UpdateSource {\n    * `Response`, but the cache metadata needed to re-cache the resource in\n    * a newer `AppVersion`.\n    */\n-  lookupResourceWithoutHash(url: string): Promise<CacheState|null>;\n+  lookupResourceWithoutHash(url: NormalizedUrl): Promise<CacheState|null>;\n \n   /**\n    * List the URLs of all of the resources which were previously cached.\n    *\n    * This allows for the discovery of resources which are not listed in the\n    * manifest but which were picked up because they matched URL patterns.\n    */\n-  previouslyCachedResources(): Promise<string[]>;\n+  previouslyCachedResources(): Promise<NormalizedUrl[]>;\n \n   /**\n    * Check whether a particular resource exists in the most recent cache."
        },
        {
            "sha": "a4c0cc9823dbb686838aa88add935f724e9d7f3b",
            "filename": "packages/service-worker/worker/src/app-version.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 10,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts",
            "raw_url": "https://github.com/angular/angular/raw/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts?ref=fb735d625b22bdb28e12f0ee78179b5c105c92f2",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {Adapter, Context} from './adapter';\n-import {CacheState, UpdateCacheStatus, UpdateSource} from './api';\n+import {CacheState, NormalizedUrl, UpdateCacheStatus, UpdateSource} from './api';\n import {AssetGroup, LazyAssetGroup, PrefetchAssetGroup} from './assets';\n import {DataGroup} from './data';\n import {Database} from './database';\n@@ -31,10 +31,9 @@ const BACKWARDS_COMPATIBILITY_NAVIGATION_URLS = [\n  */\n export class AppVersion implements UpdateSource {\n   /**\n-   * A Map of absolute URL paths (/foo.txt) to the known hash of their\n-   * contents (if available).\n+   * A Map of absolute URL paths (`/foo.txt`) to the known hash of their contents (if available).\n    */\n-  private hashTable = new Map<string, string>();\n+  private hashTable = new Map<NormalizedUrl, string>();\n \n   /**\n    * All of the asset groups active in this version of the app.\n@@ -218,7 +217,7 @@ export class AppVersion implements UpdateSource {\n   /**\n    * Check this version for a given resource with a particular hash.\n    */\n-  async lookupResourceWithHash(url: string, hash: string): Promise<Response|null> {\n+  async lookupResourceWithHash(url: NormalizedUrl, hash: string): Promise<Response|null> {\n     // Verify that this version has the requested resource cached. If not,\n     // there's no point in trying.\n     if (!this.hashTable.has(url)) {\n@@ -238,7 +237,7 @@ export class AppVersion implements UpdateSource {\n   /**\n    * Check this version for a given resource regardless of its hash.\n    */\n-  lookupResourceWithoutHash(url: string): Promise<CacheState|null> {\n+  lookupResourceWithoutHash(url: NormalizedUrl): Promise<CacheState|null> {\n     // Limit the search to asset groups, and only scan the cache, don't\n     // load resources from the network.\n     return this.assetGroups.reduce(async (potentialResponse, group) => {\n@@ -256,10 +255,10 @@ export class AppVersion implements UpdateSource {\n   /**\n    * List all unhashed resources from all asset groups.\n    */\n-  previouslyCachedResources(): Promise<string[]> {\n-    return this.assetGroups.reduce(async (resources, group) => {\n-      return (await resources).concat(await group.unhashedResources());\n-    }, Promise.resolve<string[]>([]));\n+  previouslyCachedResources(): Promise<NormalizedUrl[]> {\n+    return this.assetGroups.reduce(\n+        async (resources, group) => (await resources).concat(await group.unhashedResources()),\n+        Promise.resolve<NormalizedUrl[]>([]));\n   }\n \n   async recentCacheStatus(url: string): Promise<UpdateCacheStatus> {"
        },
        {
            "sha": "90e639d651b1d7a199548bc2a0cdb82b0b83469b",
            "filename": "packages/service-worker/worker/src/assets.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts",
            "raw_url": "https://github.com/angular/angular/raw/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts?ref=fb735d625b22bdb28e12f0ee78179b5c105c92f2",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {Adapter, Context} from './adapter';\n-import {CacheState, UpdateCacheStatus, UpdateSource, UrlMetadata} from './api';\n+import {CacheState, NormalizedUrl, UpdateCacheStatus, UpdateSource, UrlMetadata} from './api';\n import {Database, Table} from './database';\n import {errorToString, SwCriticalError} from './error';\n import {IdleScheduler} from './idle';\n@@ -29,7 +29,7 @@ export abstract class AssetGroup {\n   /**\n    * Normalized resource URLs.\n    */\n-  protected urls: string[] = [];\n+  protected urls: NormalizedUrl[] = [];\n \n   /**\n    * Regular expression patterns.\n@@ -266,7 +266,7 @@ export abstract class AssetGroup {\n   /**\n    * Lookup all resources currently stored in the cache which have no associated hash.\n    */\n-  async unhashedResources(): Promise<string[]> {\n+  async unhashedResources(): Promise<NormalizedUrl[]> {\n     const cache = await this.cache;\n     // Start with the set of all cached requests.\n     return (await cache.keys())"
        },
        {
            "sha": "86c31d843d3cb703d7070d96f7a338724c24b8f7",
            "filename": "packages/service-worker/worker/src/driver.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "raw_url": "https://github.com/angular/angular/raw/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts?ref=fb735d625b22bdb28e12f0ee78179b5c105c92f2",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {Adapter} from './adapter';\n-import {CacheState, Debuggable, DebugIdleState, DebugState, DebugVersion, UpdateCacheStatus, UpdateSource} from './api';\n+import {CacheState, Debuggable, DebugIdleState, DebugState, DebugVersion, NormalizedUrl, UpdateCacheStatus, UpdateSource} from './api';\n import {AppVersion} from './app-version';\n import {Database} from './database';\n import {DebugHandler} from './debug';\n@@ -959,7 +959,7 @@ export class Driver implements Debuggable, UpdateSource {\n    * Determine if a specific version of the given resource is cached anywhere within the SW,\n    * and fetch it if so.\n    */\n-  lookupResourceWithHash(url: string, hash: string): Promise<Response|null> {\n+  lookupResourceWithHash(url: NormalizedUrl, hash: string): Promise<Response|null> {\n     return Array\n         // Scan through the set of all cached versions, valid or otherwise. It's safe to do such\n         // lookups even for invalid versions as the cached version of a resource will have the\n@@ -981,13 +981,13 @@ export class Driver implements Debuggable, UpdateSource {\n         }, Promise.resolve<Response|null>(null));\n   }\n \n-  async lookupResourceWithoutHash(url: string): Promise<CacheState|null> {\n+  async lookupResourceWithoutHash(url: NormalizedUrl): Promise<CacheState|null> {\n     await this.initialized;\n     const version = this.versions.get(this.latestHash!);\n     return version ? version.lookupResourceWithoutHash(url) : null;\n   }\n \n-  async previouslyCachedResources(): Promise<string[]> {\n+  async previouslyCachedResources(): Promise<NormalizedUrl[]> {\n     await this.initialized;\n     const version = this.versions.get(this.latestHash!);\n     return version ? version.previouslyCachedResources() : [];"
        },
        {
            "sha": "761907eecfbe9713c20fb8d794263819448d3cdd",
            "filename": "packages/service-worker/worker/testing/utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Ftesting%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/fb735d625b22bdb28e12f0ee78179b5c105c92f2/packages%2Fservice-worker%2Fworker%2Ftesting%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Futils.ts?ref=fb735d625b22bdb28e12f0ee78179b5c105c92f2",
            "patch": "@@ -6,6 +6,9 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {NormalizedUrl} from '../src/api';\n+\n+\n /**\n  * Get a normalized representation of a URL relative to a provided base URL.\n  *\n@@ -19,11 +22,11 @@\n  *     (This is usually the ServiceWorker's origin or registration scope).\n  * @return A normalized representation of the URL.\n  */\n-export function normalizeUrl(url: string, relativeTo: string): string {\n+export function normalizeUrl(url: string, relativeTo: string): NormalizedUrl {\n   const {origin, path, search} = parseUrl(url, relativeTo);\n   const {origin: relativeToOrigin} = parseUrl(relativeTo);\n \n-  return (origin === relativeToOrigin) ? path + search : url;\n+  return ((origin === relativeToOrigin) ? path + search : url) as NormalizedUrl;\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 41,
        "deletions": 30
    }
}