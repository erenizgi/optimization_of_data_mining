{
    "author": "gkalpak",
    "message": "refactor(docs-infra): make `SwUpdatesService` depend on `LocationService` (#39651)\n\nPreviously, the `LocationService` depended on the `SwUpdatesService`.\nThis felt backwards, since `LocationService` is a more low-level and\nbasic service and should not be depending on a service for a\nhigher-level, specific feature (ServiceWorkers).\n\nThis commit inverses the relation, making `SwUpdatesService` depend on\n`LocationService` instead.\n\nPR Close #39651",
    "sha": "305d05545ad6037b3b8eccb8e53e09735836391e",
    "files": [
        {
            "sha": "eaf41d1af7d7b1009740397f590f72da9da85a2d",
            "filename": "aio/src/app/shared/location.service.spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 22,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/305d05545ad6037b3b8eccb8e53e09735836391e/aio%2Fsrc%2Fapp%2Fshared%2Flocation.service.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/305d05545ad6037b3b8eccb8e53e09735836391e/aio%2Fsrc%2Fapp%2Fshared%2Flocation.service.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Flocation.service.spec.ts?ref=305d05545ad6037b3b8eccb8e53e09735836391e",
            "patch": "@@ -1,36 +1,31 @@\n import { Injector } from '@angular/core';\n import { Location, LocationStrategy, PlatformLocation } from '@angular/common';\n import { MockLocationStrategy } from '@angular/common/testing';\n-import { Subject } from 'rxjs';\n \n import { GaService } from 'app/shared/ga.service';\n-import { SwUpdatesService } from 'app/sw-updates/sw-updates.service';\n import { LocationService } from './location.service';\n import { ScrollService } from './scroll.service';\n \n describe('LocationService', () => {\n   let injector: Injector;\n   let location: MockLocationStrategy;\n   let service: LocationService;\n-  let swUpdates: MockSwUpdatesService;\n   let scrollService: MockScrollService;\n \n   beforeEach(() => {\n     injector = Injector.create({\n       providers: [\n-        { provide: LocationService, deps: [GaService, Location, ScrollService, PlatformLocation, SwUpdatesService] },\n+        { provide: LocationService, deps: [GaService, Location, ScrollService, PlatformLocation] },\n         { provide: Location, deps: [LocationStrategy, PlatformLocation] },\n         { provide: GaService, useClass: TestGaService, deps: [] },\n         { provide: LocationStrategy, useClass: MockLocationStrategy, deps: [] },\n         { provide: PlatformLocation, useClass: MockPlatformLocation, deps: [] },\n-        { provide: SwUpdatesService, useClass: MockSwUpdatesService, deps: [] },\n         { provide: ScrollService, useClass: MockScrollService, deps: [] }\n       ]\n     });\n \n     location = injector.get(LocationStrategy) as unknown as MockLocationStrategy;\n     service = injector.get(LocationService);\n-    swUpdates = injector.get(SwUpdatesService) as unknown as MockSwUpdatesService;\n     scrollService = injector.get(ScrollService);\n   });\n \n@@ -244,7 +239,7 @@ describe('LocationService', () => {\n     });\n   });\n \n-  describe('go', () => {\n+  describe('go()', () => {\n \n     it('should update the location', () => {\n       service.go('some-new-url');\n@@ -295,19 +290,19 @@ describe('LocationService', () => {\n       expect(goExternalSpy).toHaveBeenCalledWith(externalUrl);\n     });\n \n-    it('should do a \"full page navigation\" and remove the stored scroll position when navigating to ' +\n-      'internal URLs only if a ServiceWorker update has been activated', () => {\n+    it('should do a \"full page navigation\" if requested and remove the stored scroll position ' +\n+        'when navigating to internal URLs only', () => {\n       const goExternalSpy = spyOn(service, 'goExternal');\n       const removeStoredScrollInfoSpy = spyOn(scrollService, 'removeStoredScrollInfo');\n \n-      // Internal URL - No ServiceWorker update\n+      // Internal URL - No full page navigation requested\n       service.go('some-internal-url');\n       expect(removeStoredScrollInfoSpy).not.toHaveBeenCalled();\n       expect(goExternalSpy).not.toHaveBeenCalled();\n       expect(location.path(true)).toEqual('some-internal-url');\n \n-      // Internal URL - ServiceWorker update\n-      swUpdates.updateActivated.next('foo');\n+      // Internal URL - Full page navigation requested\n+      service.fullPageNavigationNeeded();\n       service.go('other-internal-url');\n       expect(goExternalSpy).toHaveBeenCalledWith('other-internal-url');\n       expect(removeStoredScrollInfoSpy).toHaveBeenCalled();\n@@ -319,13 +314,13 @@ describe('LocationService', () => {\n       const externalUrl = 'http://some/far/away/land';\n       const otherExternalUrl = 'http://some/far/far/away/land';\n \n-      // External URL - No ServiceWorker update\n+      // External URL - No full page navigation requested\n       service.go(externalUrl);\n       expect(removeStoredScrollInfoSpy).not.toHaveBeenCalled();\n       expect(goExternalSpy).toHaveBeenCalledWith(externalUrl);\n \n-      // External URL - ServiceWorker update\n-      swUpdates.updateActivated.next('foo');\n+      // External URL - Full page navigation requested\n+      service.fullPageNavigationNeeded();\n       service.go(otherExternalUrl);\n       expect(removeStoredScrollInfoSpy).not.toHaveBeenCalled();\n       expect(goExternalSpy).toHaveBeenCalledWith(otherExternalUrl);\n@@ -341,7 +336,7 @@ describe('LocationService', () => {\n \n   });\n \n-  describe('search', () => {\n+  describe('search()', () => {\n     it('should read the query from the current location.path', () => {\n       location.simulatePopState('a/b/c?foo=bar&moo=car');\n       expect(service.search()).toEqual({ foo: 'bar', moo: 'car' });\n@@ -378,7 +373,7 @@ describe('LocationService', () => {\n     });\n   });\n \n-  describe('setSearch', () => {\n+  describe('setSearch()', () => {\n     let platformLocation: MockPlatformLocation;\n \n     beforeEach(() => {\n@@ -416,7 +411,7 @@ describe('LocationService', () => {\n     });\n   });\n \n-  describe('handleAnchorClick', () => {\n+  describe('handleAnchorClick()', () => {\n     let anchor: HTMLAnchorElement;\n \n     beforeEach(() => {\n@@ -630,10 +625,6 @@ class MockPlatformLocation {\n   replaceState = jasmine.createSpy('PlatformLocation.replaceState');\n }\n \n-class MockSwUpdatesService {\n-  updateActivated = new Subject<string>();\n-}\n-\n class MockScrollService {\n   removeStoredScrollInfo() { }\n }"
        },
        {
            "sha": "b1867dbbfe20603cdf3b45740687a274c8bde4b8",
            "filename": "aio/src/app/shared/location.service.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 9,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/305d05545ad6037b3b8eccb8e53e09735836391e/aio%2Fsrc%2Fapp%2Fshared%2Flocation.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/305d05545ad6037b3b8eccb8e53e09735836391e/aio%2Fsrc%2Fapp%2Fshared%2Flocation.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Flocation.service.ts?ref=305d05545ad6037b3b8eccb8e53e09735836391e",
            "patch": "@@ -5,15 +5,14 @@ import { ReplaySubject } from 'rxjs';\n import { map, tap } from 'rxjs/operators';\n \n import { GaService } from 'app/shared/ga.service';\n-import { SwUpdatesService } from 'app/sw-updates/sw-updates.service';\n import { ScrollService } from './scroll.service';\n \n @Injectable()\n export class LocationService {\n \n   private readonly urlParser = document.createElement('a');\n   private urlSubject = new ReplaySubject<string>(1);\n-  private swUpdateActivated = false;\n+  private fullPageNavigation = false;\n \n   currentUrl = this.urlSubject\n     .pipe(map(url => this.stripSlashes(url)));\n@@ -27,16 +26,22 @@ export class LocationService {\n     private gaService: GaService,\n     private location: Location,\n     private scrollService: ScrollService,\n-    private platformLocation: PlatformLocation,\n-    swUpdates: SwUpdatesService) {\n+    private platformLocation: PlatformLocation) {\n \n     this.urlSubject.next(location.path(true));\n \n     this.location.subscribe(state => {\n       return this.urlSubject.next(state.url || '');\n     });\n+  }\n \n-    swUpdates.updateActivated.subscribe(() => this.swUpdateActivated = true);\n+  /**\n+   * Signify that a full page navigation is needed (instead of a regular in-app navigation).\n+   *\n+   * This will happen on the next user-initiated navigation.\n+   */\n+  fullPageNavigationNeeded(): void {\n+    this.fullPageNavigation = true;\n   }\n \n   // TODO: ignore if url-without-hash-or-search matches current location?\n@@ -46,9 +51,9 @@ export class LocationService {\n     if (/^http/.test(url)) {\n       // Has http protocol so leave the site\n       this.goExternal(url);\n-    } else if (this.swUpdateActivated) {\n-      // (Do a \"full page navigation\" if a ServiceWorker update has been activated)\n-      // We need to remove stored Position in order to be sure to scroll to the Top position\n+    } else if (this.fullPageNavigation) {\n+      // Do a \"full page navigation\".\n+      // We need to remove the stored scroll position to ensure we scroll to the top.\n       this.scrollService.removeStoredScrollInfo();\n       this.goExternal(url);\n     } else {\n@@ -118,7 +123,6 @@ export class LocationService {\n    * `AppComponent`, whose element contains all the of the application and so captures all\n    * link clicks both inside and outside the `DocViewerComponent`.\n    */\n-\n   handleAnchorClick(anchor: HTMLAnchorElement, button = 0, ctrlKey = false, metaKey = false) {\n \n     // Check for modifier keys and non-left-button, which indicate the user wants to control navigation"
        },
        {
            "sha": "ee1d0dd1d7ec55b349d91cd036f977e480aad2ca",
            "filename": "aio/src/app/sw-updates/sw-updates.service.spec.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 18,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/305d05545ad6037b3b8eccb8e53e09735836391e/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/305d05545ad6037b3b8eccb8e53e09735836391e/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.spec.ts?ref=305d05545ad6037b3b8eccb8e53e09735836391e",
            "patch": "@@ -3,14 +3,17 @@ import { discardPeriodicTasks, fakeAsync, tick } from '@angular/core/testing';\n import { SwUpdate } from '@angular/service-worker';\n import { Subject } from 'rxjs';\n \n+import { LocationService } from 'app/shared/location.service';\n import { Logger } from 'app/shared/logger.service';\n+import { MockLocationService } from 'testing/location.service';\n import { MockLogger } from 'testing/logger.service';\n import { SwUpdatesService } from './sw-updates.service';\n \n \n describe('SwUpdatesService', () => {\n   let injector: Injector;\n   let appRef: MockApplicationRef;\n+  let location: MockLocationService;\n   let service: SwUpdatesService;\n   let swu: MockSwUpdate;\n   let checkInterval: number;\n@@ -24,12 +27,14 @@ describe('SwUpdatesService', () => {\n   const setup = (isSwUpdateEnabled: boolean) => {\n     injector = Injector.create({providers: [\n       { provide: ApplicationRef, useClass: MockApplicationRef, deps: [] },\n+      { provide: LocationService, useFactory: () => new MockLocationService(''), deps: [] },\n       { provide: Logger, useClass: MockLogger, deps: [] },\n       { provide: SwUpdate, useFactory: () => new MockSwUpdate(isSwUpdateEnabled), deps: [] },\n-      { provide: SwUpdatesService, deps: [ApplicationRef, Logger, SwUpdate] }\n+      { provide: SwUpdatesService, deps: [ApplicationRef, LocationService, Logger, SwUpdate] }\n     ]});\n \n     appRef = injector.get(ApplicationRef) as unknown as MockApplicationRef;\n+    location = injector.get(LocationService) as unknown as MockLocationService;\n     service = injector.get(SwUpdatesService);\n     swu = injector.get(SwUpdate) as unknown as MockSwUpdate;\n     checkInterval = (service as any).checkInterval;\n@@ -100,16 +105,18 @@ describe('SwUpdatesService', () => {\n     discardPeriodicTasks();\n   })));\n \n-  it('should emit on `updateActivated` when an update has been activated', run(() => {\n-    const activatedVersions: (string|undefined)[] = [];\n-    service.updateActivated.subscribe(v => activatedVersions.push(v));\n-\n+  it('should request a full page navigation when an update has been activated', run(() => {\n     swu.$$availableSubj.next({available: {hash: 'foo'}});\n+    expect(location.fullPageNavigationNeeded).toHaveBeenCalledTimes(0);\n+\n     swu.$$activatedSubj.next({current: {hash: 'bar'}});\n+    expect(location.fullPageNavigationNeeded).toHaveBeenCalledTimes(1);\n+\n     swu.$$availableSubj.next({available: {hash: 'baz'}});\n-    swu.$$activatedSubj.next({current: {hash: 'qux'}});\n+    expect(location.fullPageNavigationNeeded).toHaveBeenCalledTimes(1);\n \n-    expect(activatedVersions).toEqual(['bar', 'qux']);\n+    swu.$$activatedSubj.next({current: {hash: 'qux'}});\n+    expect(location.fullPageNavigationNeeded).toHaveBeenCalledTimes(2);\n   }));\n \n   describe('when `SwUpdate` is not enabled', () => {\n@@ -135,16 +142,13 @@ describe('SwUpdatesService', () => {\n       expect(swu.activateUpdate).not.toHaveBeenCalled();\n     })));\n \n-    it('should never emit on `updateActivated`', runDeactivated(() => {\n-      const activatedVersions: (string|undefined)[] = [];\n-      service.updateActivated.subscribe(v => activatedVersions.push(v));\n-\n+    it('should never request a full page navigation', runDeactivated(() => {\n       swu.$$availableSubj.next({available: {hash: 'foo'}});\n       swu.$$activatedSubj.next({current: {hash: 'bar'}});\n       swu.$$availableSubj.next({available: {hash: 'baz'}});\n       swu.$$activatedSubj.next({current: {hash: 'qux'}});\n \n-      expect(activatedVersions).toEqual([]);\n+      expect(location.fullPageNavigationNeeded).not.toHaveBeenCalled();\n     }));\n   });\n \n@@ -185,17 +189,17 @@ describe('SwUpdatesService', () => {\n       expect(swu.activateUpdate).not.toHaveBeenCalled();\n     })));\n \n-    it('should stop emitting on `updateActivated`', run(() => {\n-      const activatedVersions: (string|undefined)[] = [];\n-      service.updateActivated.subscribe(v => activatedVersions.push(v));\n-\n+    it('should stop requesting full page navigations when updates are activated', run(() => {\n       swu.$$availableSubj.next({available: {hash: 'foo'}});\n       swu.$$activatedSubj.next({current: {hash: 'bar'}});\n+      expect(location.fullPageNavigationNeeded).toHaveBeenCalledTimes(1);\n+\n       service.ngOnDestroy();\n+      location.fullPageNavigationNeeded.calls.reset();\n+\n       swu.$$availableSubj.next({available: {hash: 'baz'}});\n       swu.$$activatedSubj.next({current: {hash: 'qux'}});\n-\n-      expect(activatedVersions).toEqual(['bar']);\n+      expect(location.fullPageNavigationNeeded).not.toHaveBeenCalled();\n     }));\n   });\n });"
        },
        {
            "sha": "31763f203180979364155a4e9c74872e254b393c",
            "filename": "aio/src/app/sw-updates/sw-updates.service.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/305d05545ad6037b3b8eccb8e53e09735836391e/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/305d05545ad6037b3b8eccb8e53e09735836391e/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.ts?ref=305d05545ad6037b3b8eccb8e53e09735836391e",
            "patch": "@@ -1,8 +1,9 @@\n import { ApplicationRef, Injectable, OnDestroy } from '@angular/core';\n import { SwUpdate } from '@angular/service-worker';\n-import { concat, interval, NEVER, Observable, Subject } from 'rxjs';\n-import { first, map, takeUntil, tap } from 'rxjs/operators';\n+import { concat, interval, Subject } from 'rxjs';\n+import { first, takeUntil, tap } from 'rxjs/operators';\n \n+import { LocationService } from 'app/shared/location.service';\n import { Logger } from 'app/shared/logger.service';\n \n \n@@ -19,12 +20,10 @@ export class SwUpdatesService implements OnDestroy {\n   private checkInterval = 1000 * 60 * 60 * 6;  // 6 hours\n   private onDestroy = new Subject<void>();\n \n-  /** Emit the version hash whenever an update is activated. */\n-  updateActivated: Observable<string>;\n-\n-  constructor(appRef: ApplicationRef, private logger: Logger, private swu: SwUpdate) {\n+  constructor(\n+      appRef: ApplicationRef, location: LocationService, private logger: Logger,\n+      private swu: SwUpdate) {\n     if (!swu.isEnabled) {\n-      this.updateActivated = NEVER.pipe(takeUntil(this.onDestroy));\n       return;\n     }\n \n@@ -45,12 +44,13 @@ export class SwUpdatesService implements OnDestroy {\n         )\n         .subscribe(() => this.swu.activateUpdate());\n \n-    // Notify about activated updates.\n-    this.updateActivated = this.swu.activated.pipe(\n-        tap(evt => this.log(`Update activated: ${JSON.stringify(evt)}`)),\n-        map(evt => evt.current.hash),\n-        takeUntil(this.onDestroy),\n-    );\n+    // Request a full page navigation once an update has been activated.\n+    this.swu.activated\n+        .pipe(\n+            tap(evt => this.log(`Update activated: ${JSON.stringify(evt)}`)),\n+            takeUntil(this.onDestroy),\n+        )\n+        .subscribe(() => location.fullPageNavigationNeeded());\n   }\n \n   ngOnDestroy() {"
        },
        {
            "sha": "7f73181466486fcbd9f3a3f2dbcb6d9ea8d0acd0",
            "filename": "aio/src/testing/location.service.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/305d05545ad6037b3b8eccb8e53e09735836391e/aio%2Fsrc%2Ftesting%2Flocation.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/305d05545ad6037b3b8eccb8e53e09735836391e/aio%2Fsrc%2Ftesting%2Flocation.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Ftesting%2Flocation.service.ts?ref=305d05545ad6037b3b8eccb8e53e09735836391e",
            "patch": "@@ -8,6 +8,7 @@ export class MockLocationService {\n   currentPath = this.currentUrl.pipe(map(url => url.match(/[^?#]*/)![0]));\n   search = jasmine.createSpy('search').and.returnValue({});\n   setSearch = jasmine.createSpy('setSearch');\n+  fullPageNavigationNeeded = jasmine.createSpy('Location.fullPageNavigationNeeded');\n   go = jasmine.createSpy('Location.go').and\n               .callFake((url: string) => this.urlSubject.next(url));\n   goExternal = jasmine.createSpy('Location.goExternal');"
        },
        {
            "sha": "e76a6780a31cf81a175ab10322ed673ed095a237",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/305d05545ad6037b3b8eccb8e53e09735836391e/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/305d05545ad6037b3b8eccb8e53e09735836391e/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=305d05545ad6037b3b8eccb8e53e09735836391e",
            "patch": "@@ -3,7 +3,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3033,\n-        \"main-es2015\": 448327,\n+        \"main-es2015\": 447565,\n         \"polyfills-es2015\": 52343\n       }\n     }\n@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3033,\n-        \"main-es2015\": 448538,\n+        \"main-es2015\": 447774,\n         \"polyfills-es2015\": 52493\n       }\n     }"
        }
    ],
    "stats": {
        "total": 128,
        "additions": 64,
        "deletions": 64
    }
}