{
    "author": "dylhunn",
    "message": "feat(docs-infra): Add a new processor for `@overriddenImplementation`. (#44689)\n\nThis new processor, named `mergeOverriddenImplementation`, allows Dgeni to produce correct documentation for symbols with overridden exported constructors. For example, in the following example, the implementation documentation will be used, including the constructor signature:\n\n```\nexport const Foo: FooCtor = FooImpl as FooCtor;\n```\n\nThis is a major improvement over the current situation, in which no constructor signature is documented whatsoever.\n\nPR Close #44689",
    "sha": "c2da29065926f110cf47ef92a0e866c73914a2e2",
    "files": [
        {
            "sha": "c8fbbe455e7d5b180e73a37cf861ecbb221461b2",
            "filename": "aio/tools/transforms/angular-api-package/index.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c2da29065926f110cf47ef92a0e866c73914a2e2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Findex.js",
            "raw_url": "https://github.com/angular/angular/raw/c2da29065926f110cf47ef92a0e866c73914a2e2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Findex.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Findex.js?ref=c2da29065926f110cf47ef92a0e866c73914a2e2",
            "patch": "@@ -44,6 +44,7 @@ module.exports =\n         .processor(require('./processors/processNgModuleDocs'))\n         .processor(require('./processors/fixupRealProjectRelativePath'))\n         .processor(require('./processors/processAliasDocs'))\n+        .processor(require('./processors/mergeOverriddenImplementation'))\n \n \n         /**"
        },
        {
            "sha": "6477cbae2f4dac37068a9d21c44e1985eaf0ca9a",
            "filename": "aio/tools/transforms/angular-api-package/processors/mergeOverriddenImplementation.js",
            "status": "added",
            "additions": 103,
            "deletions": 0,
            "changes": 103,
            "blob_url": "https://github.com/angular/angular/blob/c2da29065926f110cf47ef92a0e866c73914a2e2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeOverriddenImplementation.js",
            "raw_url": "https://github.com/angular/angular/raw/c2da29065926f110cf47ef92a0e866c73914a2e2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeOverriddenImplementation.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeOverriddenImplementation.js?ref=c2da29065926f110cf47ef92a0e866c73914a2e2",
            "patch": "@@ -0,0 +1,103 @@\n+/**\n+ * In some cases it is desirable to override the exported implementation and constructor for a symbol.\n+ * This is useful for a few reasons:\n+ * - A symbol could have multiple constructors\n+ * - It is possible to disambiguate multiple different signatures from a single polymorphic constructor\n+ * - The return type of the overridden constructor can differ (e.g. `Foo<T|null>` vs `Foo<T>`)\n+ * \n+ * This looks like the following:\n+ * \n+ * ```\n+ * export interface Foo {\n+ *   bar();\n+ * }\n+ * \n+ * export class FooImpl {\n+ *   bar() {}\n+ * }\n+ * \n+ * export interface FooCtor {\n+ *   new(): Foo;\n+ * }\n+ * \n+ * export const Foo: FooCtor = FooImpl as FooCtor;\n+ * ```\n+ * \n+ * This processor will correct the docs for symbol `Foo` by copying them over from `FooImpl`\n+ * to the exported symbol `Foo`. The processor will also copy all documented constructor overrides from `FooCtor`.\n+ * \n+ * In order to use this processor, annotate the exported constant with `@overriddenImplementation`,\n+ * and mark the implementation and constructor types as `@internal`. Place the desired\n+ * documentation on the implementation class.\n+ */\n+ module.exports = function mergeOverriddenImplementation(getDocFromAlias, log) {\n+  return {\n+    $runAfter: ['tags-extracted', 'ids-computed'],\n+    $runBefore: ['filterPrivateDocs'],\n+    propertiesToKeep: [\n+      'name', 'id', 'aliases', 'fileInfo', 'startingLine', 'endingLine',\n+      'path', 'originalModule', 'outputPath', 'privateExport', 'moduleDoc'\n+    ],\n+    $process(docs) {\n+      docs.forEach(doc => {\n+        if (doc.overriddenImplementation) {          \n+          // Check the AST is of the expected expression shape, and extract the identifiers.\n+          const symbolAstObjects = [doc.declaration?.name, doc.declaration?.type, doc.declaration?.initializer?.expression];\n+          if (symbolAstObjects.some(symbol => symbol === undefined)) {\n+            throw new Error('@overriddenImplementation must have format `export const Foo: FooCtor = FooImpl as FooCtor;`');\n+          }\n+\n+          // Convert the AST nodes into docs.\n+          const symbolNames = symbolAstObjects.map(s => s.getText());\n+          const symbolDocArrays = symbolNames.map(symbol => getDocFromAlias(symbol));\n+          for (let i = 0; i < symbolDocArrays.length; i++) {\n+            if (symbolDocArrays[i].length === 0) {\n+              throw new Error(`@overriddenImplementation failed to find a doc for ${symbolNames[i]}. Are you sure this symbol is documented and exported?`);\n+            }\n+            if (symbolDocArrays[i].length >= 2) {\n+              throw new Error(`@overriddenImplementation found multiple docs for ${symbolNames[i]}. You may only have one documented symbol for each.`);\n+            }\n+          }\n+          const symbolDocs = symbolDocArrays.map(a => a[0]);\n+          const exportedNameDoc = symbolDocs[0];\n+          const ctorDoc = symbolDocs[1];\n+          const implDoc = symbolDocs[2];\n+\n+          // Clean out the unwanted properties from the exported doc.\n+          Object.keys(doc).forEach(key => {\n+            if (!this.propertiesToKeep.includes(key)) {\n+              delete doc[key];\n+            }\n+          });\n+\n+          // Copy over all the properties from the implementation doc.\n+          Object.keys(implDoc).forEach(key => {\n+            if (!this.propertiesToKeep.includes(key)) {\n+              exportedNameDoc[key] = implDoc[key];\n+            }\n+          });\n+\n+          // Copy the constructor overrides from the constructor doc, if any are present.\n+          if (!ctorDoc.members || ctorDoc.members.length !== 1 || !ctorDoc.members[0].name.includes('new')) {\n+            throw new Error(`@overriddenImplementation requires that the provided constructor ${symbolNames[1]} have exactly one member called \"new\", possibly with multiple overrides.`);\n+          }\n+          exportedNameDoc.constructorDoc = ctorDoc.members[0];\n+\n+          // Mark symbols other than the exported name as internal.\n+          if (!ctorDoc.internal) {\n+            log.warn(`Constructor doc ${symbolNames[1]} was not marked '@internal'; adding this annotation.`);\n+            ctorDoc.internal = true;\n+          }\n+          if (!implDoc.internal) {\n+            log.warn(`Implementation doc ${symbolNames[2]} was not marked '@internal'; adding this annotation.`);\n+            implDoc.internal = true;\n+          }\n+\n+          // The exported doc should not be private, unlike the implementation doc.\n+          exportedNameDoc.privateExport = false;\n+          exportedNameDoc.internal = false;\n+        }\n+      });\n+    }\n+  };\n+};"
        },
        {
            "sha": "252e1bc483c56f74286e981b57e0e0a73d250979",
            "filename": "aio/tools/transforms/angular-api-package/processors/mergeOverriddenImplementation.spec.js",
            "status": "added",
            "additions": 82,
            "deletions": 0,
            "changes": 82,
            "blob_url": "https://github.com/angular/angular/blob/c2da29065926f110cf47ef92a0e866c73914a2e2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeOverriddenImplementation.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/c2da29065926f110cf47ef92a0e866c73914a2e2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeOverriddenImplementation.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeOverriddenImplementation.spec.js?ref=c2da29065926f110cf47ef92a0e866c73914a2e2",
            "patch": "@@ -0,0 +1,82 @@\n+const testPackage = require('../../helpers/test-package');\n+const processorFactory = require('./mergeOverriddenImplementation');\n+const Dgeni = require('dgeni');\n+const mockLogFactory = require('dgeni/lib/mocks/log');\n+const createDocMessageFactory = require('dgeni-packages/base/services/createDocMessage');\n+\n+describe('mergeOverriddenImplementation processor', () => {\n+\n+  let getDocFromAlias, log, createDocMessage, processor;\n+\n+  beforeEach(() => {\n+    getDocFromAlias = jasmine.createSpy('getDocFromAlias');\n+    log = mockLogFactory(false);\n+    createDocMessage = createDocMessageFactory();\n+    processor = processorFactory(getDocFromAlias, log, createDocMessage);\n+  });\n+\n+  it('should be available on the injector', () => {\n+    const dgeni = new Dgeni([testPackage('angular-api-package')]);\n+    const injector = dgeni.configureInjector();\n+    const processor = injector.get('mergeOverriddenImplementation');\n+    expect(processor.$process).toBeDefined();\n+  });\n+\n+  it('should run before the correct processor', () => {\n+    expect(processor.$runBefore).toEqual(['filterPrivateDocs']);\n+  });\n+\n+  it('should run after the correct processor', () => {\n+    expect(processor.$runAfter).toEqual(['tags-extracted', 'ids-computed']);\n+  });\n+\n+  it('should ignore docs that do not have a `@overriddenImplementation` tag', () => {\n+    const docs = [{}];\n+    getDocFromAlias.and.returnValue([{ prop1: 'prop-1', prop2: 'prop-2', prop3: 'prop-3' }]);\n+    processor.$process(docs);\n+    expect(docs).toEqual([{}]);\n+  });\n+\n+  it('should replace properties with those from the implementation and constructor docs', () => {\n+    const exportedNameDoc = {\n+      overriddenImplementation: 'Foo has an overridden implementation.', // This processor should apply\n+      declaration: { // Imitate a valid AST\n+        name: {getText: () => 'Foo'},\n+        type: {getText: () => 'FooCtor'},\n+        initializer: {\n+          expression: {getText: () => 'FooImpl'},\n+        },\n+      },\n+      exportedProp: true, // This prop will be removed\n+    };\n+    const docs = [exportedNameDoc];\n+\n+    const fakeGetDocs = (docName) => {\n+      switch(docName) {\n+        case 'Foo': return [exportedNameDoc];\n+        case 'FooCtor': return [{ctorProp: true, members: [{name: 'new'}]}];\n+        case 'FooImpl': return [{implProp: true}];\n+      }\n+    };\n+\n+    getDocFromAlias.and.callFake(fakeGetDocs);\n+    processor.$process(docs);\n+\n+    expect(docs).toEqual([{\n+      // Property copied from the implementation\n+      implProp: true,\n+      // Constructor signature property\n+      constructorDoc: {name: 'new'},\n+      // The exported symbol should be explicitly marked non-internal\n+      internal: false,\n+      privateExport: false,\n+    }]);\n+  });\n+\n+  it('should have default properties to keep', () => {\n+    expect(processor.propertiesToKeep).toEqual([\n+      'name', 'id', 'aliases', 'fileInfo', 'startingLine', 'endingLine',\n+      'path', 'originalModule', 'outputPath', 'privateExport', 'moduleDoc'\n+    ]);\n+  });\n+});"
        },
        {
            "sha": "b71140a992c5eadc37e8f31967a776333d19cfd4",
            "filename": "aio/tools/transforms/angular-api-package/tag-defs/overriddenImplementation.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/c2da29065926f110cf47ef92a0e866c73914a2e2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Ftag-defs%2FoverriddenImplementation.js",
            "raw_url": "https://github.com/angular/angular/raw/c2da29065926f110cf47ef92a0e866c73914a2e2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Ftag-defs%2FoverriddenImplementation.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Ftag-defs%2FoverriddenImplementation.js?ref=c2da29065926f110cf47ef92a0e866c73914a2e2",
            "patch": "@@ -0,0 +1,5 @@\n+module.exports = function() {\n+  return {\n+    name: 'overriddenImplementation',\n+  };\n+};"
        }
    ],
    "stats": {
        "total": 191,
        "additions": 191,
        "deletions": 0
    }
}