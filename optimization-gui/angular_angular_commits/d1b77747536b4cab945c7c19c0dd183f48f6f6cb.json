{
    "author": "atscott",
    "message": "refactor(language-service): migrate quick_info_spec to new testing package (#40966)\n\nrefactor(language-service): migrate quick_info_spec to new testing package\n\nPR Close #40966",
    "sha": "d1b77747536b4cab945c7c19c0dd183f48f6f6cb",
    "files": [
        {
            "sha": "793cff68c2103371560e82ae7a8ce921d9198610",
            "filename": "packages/language-service/ivy/test/quick_info_spec.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 32,
            "changes": 61,
            "blob_url": "https://github.com/angular/angular/blob/d1b77747536b4cab945c7c19c0dd183f48f6f6cb/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d1b77747536b4cab945c7c19c0dd183f48f6f6cb/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts?ref=d1b77747536b4cab945c7c19c0dd183f48f6f6cb",
            "patch": "@@ -6,18 +6,14 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n-import {initMockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n+import {extractCursorInfo, LanguageServiceTestEnv, Project} from '../testing';\n \n-import {LanguageServiceTestEnvironment} from './env';\n-\n-function quickInfoSkeleton(): TestFile[] {\n-  return [\n-    {\n-      name: absoluteFrom('/app.ts'),\n-      contents: `\n+function quickInfoSkeleton(): {[fileName: string]: string} {\n+  return {\n+    'app.ts': `\n         import {Component, Directive, EventEmitter, Input, NgModule, Output, Pipe, PipeTransform} from '@angular/core';\n         import {CommonModule} from '@angular/common';\n \n@@ -92,22 +88,19 @@ function quickInfoSkeleton(): TestFile[] {\n         })\n         export class AppModule {}\n       `,\n-      isRoot: true,\n-    },\n-    {\n-      name: absoluteFrom('/app.html'),\n-      contents: `Will be overridden`,\n-    }\n-  ];\n+    'app.html': `Will be overridden`,\n+  };\n }\n \n describe('quick info', () => {\n-  let env: LanguageServiceTestEnvironment;\n+  let env: LanguageServiceTestEnv;\n+  let project: Project;\n \n   describe('strict templates (happy path)', () => {\n     beforeEach(() => {\n       initMockFileSystem('Native');\n-      env = LanguageServiceTestEnvironment.setup(quickInfoSkeleton());\n+      env = LanguageServiceTestEnv.setup();\n+      project = env.addProject('test', quickInfoSkeleton());\n     });\n \n     describe('elements', () => {\n@@ -476,20 +469,24 @@ describe('quick info', () => {\n       });\n \n       it('should provide documentation', () => {\n-        const {cursor} =\n-            env.updateFileWithCursor(absoluteFrom('/app.html'), `<div>{{¦title}}</div>`);\n-        const quickInfo = env.ngLS.getQuickInfoAtPosition(absoluteFrom('/app.html'), cursor);\n+        const template = project.openFile('app.html');\n+        template.contents = `<div>{{title}}</div>`;\n+        template.moveCursorToText('{{¦title}}');\n+        const quickInfo = template.getQuickInfoAtPosition();\n         const documentation = toText(quickInfo!.documentation);\n         expect(documentation).toBe('This is the title of the `AppCmp` Component.');\n       });\n     });\n   });\n \n   describe('non-strict compiler options', () => {\n-    it('should find input binding on text attribute when strictAttributeTypes is false', () => {\n+    beforeEach(() => {\n       initMockFileSystem('Native');\n-      env =\n-          LanguageServiceTestEnvironment.setup(quickInfoSkeleton(), {strictAttributeTypes: false});\n+      env = LanguageServiceTestEnv.setup();\n+    });\n+\n+    it('should find input binding on text attribute when strictAttributeTypes is false', () => {\n+      project = env.addProject('test', quickInfoSkeleton(), {strictAttributeTypes: false});\n       expectQuickInfo({\n         templateOverride: `<test-comp tcN¦ame=\"title\"></test-comp>`,\n         expectedSpanText: 'tcName',\n@@ -498,9 +495,7 @@ describe('quick info', () => {\n     });\n \n     it('can still get quick info when strictOutputEventTypes is false', () => {\n-      initMockFileSystem('Native');\n-      env = LanguageServiceTestEnvironment.setup(\n-          quickInfoSkeleton(), {strictOutputEventTypes: false});\n+      project = env.addProject('test', quickInfoSkeleton(), {strictOutputEventTypes: false});\n       expectQuickInfo({\n         templateOverride: `<test-comp (te¦st)=\"myClick($event)\"></test-comp>`,\n         expectedSpanText: 'test',\n@@ -509,9 +504,8 @@ describe('quick info', () => {\n     });\n \n     it('should work for pipes even if checkTypeOfPipes is false', () => {\n-      initMockFileSystem('Native');\n       // checkTypeOfPipes is set to false when strict templates is false\n-      env = LanguageServiceTestEnvironment.setup(quickInfoSkeleton(), {strictTemplates: false});\n+      project = env.addProject('test', quickInfoSkeleton(), {strictTemplates: false});\n       const templateOverride = `<p>The hero's birthday is {{birthday | da¦te: \"MM/dd/yy\"}}</p>`;\n       expectQuickInfo(\n           {templateOverride, expectedSpanText: 'date', expectedDisplayString: '(pipe) DatePipe'});\n@@ -522,10 +516,13 @@ describe('quick info', () => {\n       {templateOverride, expectedSpanText, expectedDisplayString}:\n           {templateOverride: string, expectedSpanText: string, expectedDisplayString: string}):\n       ts.QuickInfo {\n-    const {cursor, text} = env.updateFileWithCursor(absoluteFrom('/app.html'), templateOverride);\n+    const {text} = extractCursorInfo(templateOverride);\n+    const template = project.openFile('app.html');\n+    template.contents = text;\n     env.expectNoSourceDiagnostics();\n-    env.expectNoTemplateDiagnostics(absoluteFrom('/app.ts'), 'AppCmp');\n-    const quickInfo = env.ngLS.getQuickInfoAtPosition(absoluteFrom('/app.html'), cursor);\n+\n+    template.moveCursorToText(templateOverride);\n+    const quickInfo = template.getQuickInfoAtPosition();\n     expect(quickInfo).toBeTruthy();\n     const {textSpan, displayParts} = quickInfo!;\n     expect(text.substring(textSpan.start, textSpan.start + textSpan.length))"
        },
        {
            "sha": "7c0fc9798cf075871f05ce11c1e1eb6c37a6c285",
            "filename": "packages/language-service/ivy/testing/src/buffer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/d1b77747536b4cab945c7c19c0dd183f48f6f6cb/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "raw_url": "https://github.com/angular/angular/raw/d1b77747536b4cab945c7c19c0dd183f48f6f6cb/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts?ref=d1b77747536b4cab945c7c19c0dd183f48f6f6cb",
            "patch": "@@ -80,4 +80,8 @@ export class OpenBuffer {\n   getTcb() {\n     return this.ngLS.getTcb(this.scriptInfo.fileName, this._cursor);\n   }\n+\n+  getQuickInfoAtPosition() {\n+    return this.ngLS.getQuickInfoAtPosition(this.scriptInfo.fileName, this._cursor);\n+  }\n }"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 33,
        "deletions": 32
    }
}