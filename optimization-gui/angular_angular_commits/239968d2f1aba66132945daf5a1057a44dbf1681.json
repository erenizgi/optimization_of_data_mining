{
    "author": "kyliau",
    "message": "feat(compiler): Add keySpan to Variable Node (#38965)\n\nNow that we have `keySpan` for `BoundAttribute` (implemented in\nhttps://github.com/angular/angular/pull/38898) we could do the same\nfor `Variable`.\n\nThis would allow us to distinguish the LHS and RHS from the whole source\nspan.\n\nPR Close #38965",
    "sha": "239968d2f1aba66132945daf5a1057a44dbf1681",
    "files": [
        {
            "sha": "ef2d1a732a4d68bee2164d03c26fe550782b0e3d",
            "filename": "packages/compiler/src/render3/r3_ast.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/239968d2f1aba66132945daf5a1057a44dbf1681/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/239968d2f1aba66132945daf5a1057a44dbf1681/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts?ref=239968d2f1aba66132945daf5a1057a44dbf1681",
            "patch": "@@ -118,7 +118,7 @@ export class Content implements Node {\n export class Variable implements Node {\n   constructor(\n       public name: string, public value: string, public sourceSpan: ParseSourceSpan,\n-      public valueSpan?: ParseSourceSpan) {}\n+      readonly keySpan: ParseSourceSpan, public valueSpan?: ParseSourceSpan) {}\n   visit<Result>(visitor: Visitor<Result>): Result {\n     return visitor.visitVariable(this);\n   }"
        },
        {
            "sha": "0018a68481be9986d96b0e19d5ae45b302bf5971",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/239968d2f1aba66132945daf5a1057a44dbf1681/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/239968d2f1aba66132945daf5a1057a44dbf1681/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=239968d2f1aba66132945daf5a1057a44dbf1681",
            "patch": "@@ -159,7 +159,7 @@ class HtmlAstToIvyAst implements html.Visitor {\n             templateKey, templateValue, attribute.sourceSpan, absoluteValueOffset, [],\n             templateParsedProperties, parsedVariables);\n         templateVariables.push(...parsedVariables.map(\n-            v => new t.Variable(v.name, v.value, v.sourceSpan, v.valueSpan)));\n+            v => new t.Variable(v.name, v.value, v.sourceSpan, v.keySpan, v.valueSpan)));\n       } else {\n         // Check for variables, events, property bindings, interpolation\n         hasBinding = this.parseAttribute(\n@@ -356,7 +356,8 @@ class HtmlAstToIvyAst implements html.Visitor {\n       } else if (bindParts[KW_LET_IDX]) {\n         if (isTemplateElement) {\n           const identifier = bindParts[IDENT_KW_IDX];\n-          this.parseVariable(identifier, value, srcSpan, attribute.valueSpan, variables);\n+          const keySpan = createKeySpan(srcSpan, bindParts[KW_LET_IDX], identifier);\n+          this.parseVariable(identifier, value, srcSpan, keySpan, attribute.valueSpan, variables);\n         } else {\n           this.reportError(`\"let-\" is only supported on ng-template elements.`, srcSpan);\n         }\n@@ -425,15 +426,15 @@ class HtmlAstToIvyAst implements html.Visitor {\n   }\n \n   private parseVariable(\n-      identifier: string, value: string, sourceSpan: ParseSourceSpan,\n+      identifier: string, value: string, sourceSpan: ParseSourceSpan, keySpan: ParseSourceSpan,\n       valueSpan: ParseSourceSpan|undefined, variables: t.Variable[]) {\n     if (identifier.indexOf('-') > -1) {\n       this.reportError(`\"-\" is not allowed in variable names`, sourceSpan);\n     } else if (identifier.length === 0) {\n       this.reportError(`Variable does not have a name`, sourceSpan);\n     }\n \n-    variables.push(new t.Variable(identifier, value, sourceSpan, valueSpan));\n+    variables.push(new t.Variable(identifier, value, sourceSpan, keySpan, valueSpan));\n   }\n \n   private parseReference("
        },
        {
            "sha": "e74722c109157f4a3e8180fa3e3c91b8c8d0449f",
            "filename": "packages/compiler/test/render3/r3_ast_spans_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/239968d2f1aba66132945daf5a1057a44dbf1681/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/239968d2f1aba66132945daf5a1057a44dbf1681/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts?ref=239968d2f1aba66132945daf5a1057a44dbf1681",
            "patch": "@@ -50,8 +50,12 @@ class R3AstSourceSpans implements t.Visitor<void> {\n   }\n \n   visitVariable(variable: t.Variable) {\n-    this.result.push(\n-        ['Variable', humanizeSpan(variable.sourceSpan), humanizeSpan(variable.valueSpan)]);\n+    this.result.push([\n+      'Variable',\n+      humanizeSpan(variable.sourceSpan),\n+      humanizeSpan(variable.keySpan),\n+      humanizeSpan(variable.valueSpan),\n+    ]);\n   }\n \n   visitReference(reference: t.Reference) {\n@@ -233,7 +237,7 @@ describe('R3 AST source spans', () => {\n           'Template', '<ng-template let-a=\"b\"></ng-template>', '<ng-template let-a=\"b\">',\n           '</ng-template>'\n         ],\n-        ['Variable', 'let-a=\"b\"', 'b'],\n+        ['Variable', 'let-a=\"b\"', 'a', 'b'],\n       ]);\n     });\n \n@@ -243,7 +247,7 @@ describe('R3 AST source spans', () => {\n           'Template', '<ng-template data-let-a=\"b\"></ng-template>', '<ng-template data-let-a=\"b\">',\n           '</ng-template>'\n         ],\n-        ['Variable', 'data-let-a=\"b\"', 'b'],\n+        ['Variable', 'data-let-a=\"b\"', 'a', 'b'],\n       ]);\n     });\n \n@@ -282,7 +286,7 @@ describe('R3 AST source spans', () => {\n         ],\n         ['TextAttribute', 'ngFor', '<empty>'],\n         ['BoundAttribute', '*ngFor=\"let item of items\"', 'of', 'items'],\n-        ['Variable', 'let item ', '<empty>'],\n+        ['Variable', 'let item ', 'item', '<empty>'],\n         [\n           'Element', '<div *ngFor=\"let item of items\"></div>', '<div *ngFor=\"let item of items\">',\n           '</div>'\n@@ -314,7 +318,7 @@ describe('R3 AST source spans', () => {\n         [\n           'BoundAttribute', '*ngFor=\"let item of items; trackBy: trackByFn\"', 'trackBy', 'trackByFn'\n         ],\n-        ['Variable', 'let item ', '<empty>'],\n+        ['Variable', 'let item ', 'item', '<empty>'],\n         [\n           'Element', '<div *ngFor=\"let item of items; trackBy: trackByFn\"></div>',\n           '<div *ngFor=\"let item of items; trackBy: trackByFn\">', '</div>'\n@@ -327,7 +331,7 @@ describe('R3 AST source spans', () => {\n       expectFromHtml('<div *ngIf=\"let a=b\"></div>').toEqual([\n         ['Template', '<div *ngIf=\"let a=b\"></div>', '<div *ngIf=\"let a=b\">', '</div>'],\n         ['TextAttribute', 'ngIf', '<empty>'],\n-        ['Variable', 'let a=b', 'b'],\n+        ['Variable', 'let a=b', 'a', 'b'],\n         ['Element', '<div *ngIf=\"let a=b\"></div>', '<div *ngIf=\"let a=b\">', '</div>'],\n       ]);\n     });\n@@ -336,7 +340,7 @@ describe('R3 AST source spans', () => {\n       expectFromHtml('<div *ngIf=\"expr as local\"></div>').toEqual([\n         ['Template', '<div *ngIf=\"expr as local\"></div>', '<div *ngIf=\"expr as local\">', '</div>'],\n         ['BoundAttribute', '*ngIf=\"expr as local\"', 'ngIf', 'expr'],\n-        ['Variable', 'ngIf=\"expr as local', 'ngIf'],\n+        ['Variable', 'ngIf=\"expr as local', 'local', 'ngIf'],\n         ['Element', '<div *ngIf=\"expr as local\"></div>', '<div *ngIf=\"expr as local\">', '</div>'],\n       ]);\n     });"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 18,
        "deletions": 13
    }
}