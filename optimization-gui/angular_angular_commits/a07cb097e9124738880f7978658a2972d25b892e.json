{
    "author": "alxhub",
    "message": "Revert \"Revert \"refactor(migrations): support use of an ESM `@angular/compiler` package (#43627)\"\" (#43637)\n\nThis reverts commit ab3de40ba3e45a0e6df30f62d41cf65ed0b021e2, which is\nitself a revert of the original commit. Thus, this restores the changes\nto schematics in support of ESM.\n\nNow that g3 has a local modification for load_esm, we can restore this\nfunctionality.\n\nPR Close #43637",
    "sha": "a07cb097e9124738880f7978658a2972d25b892e",
    "files": [
        {
            "sha": "0bc9d7a0a9a1054cd8c301822929b82e994dfcbc",
            "filename": "packages/core/schematics/migrations/google3/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FBUILD.bazel?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,6 +6,7 @@ ts_library(\n     tsconfig = \"//packages/core/schematics:tsconfig.json\",\n     visibility = [\"//packages/core/schematics/test/google3:__pkg__\"],\n     deps = [\n+        \"//packages/compiler\",\n         \"//packages/core/schematics/migrations/activated-route-snapshot-fragment\",\n         \"//packages/core/schematics/migrations/can-activate-with-redirect-to\",\n         \"//packages/core/schematics/migrations/dynamic-queries\","
        },
        {
            "sha": "35f9b918c01c5b1af63c508bcafc35e1b9c41fdf",
            "filename": "packages/core/schematics/migrations/google3/explicitQueryTimingRule.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FexplicitQueryTimingRule.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FexplicitQueryTimingRule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FexplicitQueryTimingRule.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import * as compiler from '@angular/compiler';\n import {Replacement, RuleFailure, Rules} from 'tslint';\n import * as ts from 'typescript';\n \n@@ -49,7 +50,7 @@ export class Rule extends Rules.TypedRule {\n     });\n \n     const queries = resolvedQueries.get(sourceFile);\n-    const usageStrategy = new QueryUsageStrategy(classMetadata, typeChecker);\n+    const usageStrategy = new QueryUsageStrategy(classMetadata, typeChecker, compiler);\n \n     // No queries detected for the given source file.\n     if (!queries) {"
        },
        {
            "sha": "c22a34b9b1940e7f709284eb806a2d51d37ec2ac",
            "filename": "packages/core/schematics/migrations/google3/noTemplateVariableAssignmentRule.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FnoTemplateVariableAssignmentRule.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FnoTemplateVariableAssignmentRule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FnoTemplateVariableAssignmentRule.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import * as compiler from '@angular/compiler';\n import {RuleFailure, Rules} from 'tslint';\n import * as ts from 'typescript';\n \n@@ -34,7 +35,7 @@ export class Rule extends Rules.TypedRule {\n     // template variables.\n     resolvedTemplates.forEach(template => {\n       const filePath = template.filePath;\n-      const nodes = analyzeResolvedTemplate(template);\n+      const nodes = analyzeResolvedTemplate(template, compiler);\n       const templateFile =\n           template.inline ? sourceFile : createHtmlSourceFile(filePath, template.content);\n "
        },
        {
            "sha": "85f90eef356d3417df5f1e801c46b173ef0d801e",
            "filename": "packages/core/schematics/migrations/router-link-empty-expression/analyze_template.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fanalyze_template.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fanalyze_template.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fanalyze_template.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,21 +6,23 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {TmplAstBoundAttribute} from '@angular/compiler';\n+import type {TmplAstBoundAttribute} from '@angular/compiler';\n \n import {ResolvedTemplate} from '../../utils/ng_component_template';\n import {parseHtmlGracefully} from '../../utils/parse_html';\n \n import {RouterLinkEmptyExprVisitor} from './angular/html_routerlink_empty_expr_visitor';\n \n-export function analyzeResolvedTemplate(template: ResolvedTemplate): TmplAstBoundAttribute[]|null {\n-  const templateNodes = parseHtmlGracefully(template.content, template.filePath);\n+export function analyzeResolvedTemplate(\n+    template: ResolvedTemplate,\n+    compilerModule: typeof import('@angular/compiler')): TmplAstBoundAttribute[]|null {\n+  const templateNodes = parseHtmlGracefully(template.content, template.filePath, compilerModule);\n \n   if (!templateNodes) {\n     return null;\n   }\n \n-  const visitor = new RouterLinkEmptyExprVisitor();\n+  const visitor = new RouterLinkEmptyExprVisitor(compilerModule);\n \n   // Analyze the Angular Render3 HTML AST and collect all template variable assignments.\n   visitor.visitAll(templateNodes);"
        },
        {
            "sha": "011344aa76f8ba6072f58e5868ac0172048ddfe2",
            "filename": "packages/core/schematics/migrations/router-link-empty-expression/angular/html_routerlink_empty_expr_visitor.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fangular%2Fhtml_routerlink_empty_expr_visitor.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fangular%2Fhtml_routerlink_empty_expr_visitor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Fangular%2Fhtml_routerlink_empty_expr_visitor.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ASTWithSource, EmptyExpr, TmplAstBoundAttribute, TmplAstElement, TmplAstTemplate} from '@angular/compiler';\n+import type {TmplAstBoundAttribute, TmplAstElement, TmplAstTemplate} from '@angular/compiler';\n import {TemplateAstVisitor} from '../../../utils/template_ast_visitor';\n \n /**\n@@ -27,8 +27,8 @@ export class RouterLinkEmptyExprVisitor extends TemplateAstVisitor {\n   }\n \n   override visitBoundAttribute(node: TmplAstBoundAttribute) {\n-    if (node.name === 'routerLink' && node.value instanceof ASTWithSource &&\n-        node.value.ast instanceof EmptyExpr) {\n+    if (node.name === 'routerLink' && node.value instanceof this.compilerModule.ASTWithSource &&\n+        node.value.ast instanceof this.compilerModule.EmptyExpr) {\n       this.emptyRouterLinkExpressions.push(node);\n     }\n   }"
        },
        {
            "sha": "641220f685f648c6166c2e43852b076f1c335d62",
            "filename": "packages/core/schematics/migrations/router-link-empty-expression/index.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 10,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Findex.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -8,8 +8,9 @@\n \n import {logging, normalize} from '@angular-devkit/core';\n import {Rule, SchematicContext, SchematicsException, Tree} from '@angular-devkit/schematics';\n-import {EmptyExpr, TmplAstBoundAttribute} from '@angular/compiler';\n+import type {TmplAstBoundAttribute} from '@angular/compiler';\n import {relative} from 'path';\n+import {loadEsmModule} from '../../utils/load_esm';\n \n import {NgComponentTemplateVisitor, ResolvedTemplate} from '../../utils/ng_component_template';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n@@ -44,8 +45,20 @@ export default function(): Rule {\n           'Could not find any tsconfig file. Cannot check templates for empty routerLinks.');\n     }\n \n+    let compilerModule;\n+    try {\n+      // Load ESM `@angular/compiler` using the TypeScript dynamic import workaround.\n+      // Once TypeScript provides support for keeping the dynamic import this workaround can be\n+      // changed to a direct dynamic import.\n+      compilerModule = await loadEsmModule<typeof import('@angular/compiler')>('@angular/compiler');\n+    } catch (e) {\n+      throw new SchematicsException(\n+          `Unable to load the '@angular/compiler' package. Details: ${e.message}`);\n+    }\n+\n     for (const tsconfigPath of [...buildPaths, ...testPaths]) {\n-      runEmptyRouterLinkExpressionMigration(tree, tsconfigPath, basePath, context.logger);\n+      runEmptyRouterLinkExpressionMigration(\n+          tree, tsconfigPath, basePath, context.logger, compilerModule);\n     }\n   };\n }\n@@ -55,7 +68,8 @@ export default function(): Rule {\n  * which templates received updates.\n  */\n function runEmptyRouterLinkExpressionMigration(\n-    tree: Tree, tsconfigPath: string, basePath: string, logger: Logger) {\n+    tree: Tree, tsconfigPath: string, basePath: string, logger: Logger,\n+    compilerModule: typeof import('@angular/compiler')) {\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n   const templateVisitor = new NgComponentTemplateVisitor(typeChecker);\n@@ -66,13 +80,15 @@ function runEmptyRouterLinkExpressionMigration(\n   sourceFiles.forEach(sourceFile => templateVisitor.visitNode(sourceFile));\n \n   const {resolvedTemplates} = templateVisitor;\n-  fixEmptyRouterlinks(resolvedTemplates, tree, logger);\n+  fixEmptyRouterlinks(resolvedTemplates, tree, logger, compilerModule);\n }\n \n-function fixEmptyRouterlinks(resolvedTemplates: ResolvedTemplate[], tree: Tree, logger: Logger) {\n+function fixEmptyRouterlinks(\n+    resolvedTemplates: ResolvedTemplate[], tree: Tree, logger: Logger,\n+    compilerModule: typeof import('@angular/compiler')) {\n   const basePath = process.cwd();\n   const collectedFixes: string[] = [];\n-  const fixesByFile = getFixesByFile(resolvedTemplates);\n+  const fixesByFile = getFixesByFile(resolvedTemplates, compilerModule);\n \n   for (const [absFilePath, templateFixes] of fixesByFile) {\n     const treeFilePath = relative(normalize(basePath), normalize(absFilePath));\n@@ -116,10 +132,12 @@ function fixEmptyRouterlinks(resolvedTemplates: ResolvedTemplate[], tree: Tree,\n /**\n  * Returns fixes for nodes in templates which contain empty routerLink assignments, grouped by file.\n  */\n-function getFixesByFile(templates: ResolvedTemplate[]): Map<string, FixedTemplate[]> {\n+function getFixesByFile(\n+    templates: ResolvedTemplate[],\n+    compilerModule: typeof import('@angular/compiler')): Map<string, FixedTemplate[]> {\n   const fixesByFile = new Map<string, FixedTemplate[]>();\n   for (const template of templates) {\n-    const templateFix = fixEmptyRouterlinksInTemplate(template);\n+    const templateFix = fixEmptyRouterlinksInTemplate(template, compilerModule);\n     if (templateFix === null) {\n       continue;\n     }\n@@ -141,8 +159,10 @@ function getFixesByFile(templates: ResolvedTemplate[]): Map<string, FixedTemplat\n   return fixesByFile;\n }\n \n-function fixEmptyRouterlinksInTemplate(template: ResolvedTemplate): FixedTemplate|null {\n-  const emptyRouterlinkExpressions = analyzeResolvedTemplate(template);\n+function fixEmptyRouterlinksInTemplate(\n+    template: ResolvedTemplate, compilerModule: typeof import('@angular/compiler')): FixedTemplate|\n+    null {\n+  const emptyRouterlinkExpressions = analyzeResolvedTemplate(template, compilerModule);\n \n   if (!emptyRouterlinkExpressions || emptyRouterlinkExpressions.length === 0) {\n     return null;"
        },
        {
            "sha": "8d447d90335e8322c5b1efa7947a8c6665419a46",
            "filename": "packages/core/schematics/migrations/static-queries/index.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 6,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Findex.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -11,6 +11,7 @@ import {Rule, SchematicContext, SchematicsException, Tree} from '@angular-devkit\n import {relative} from 'path';\n import * as ts from 'typescript';\n \n+import {loadEsmModule} from '../../utils/load_esm';\n import {NgComponentTemplateVisitor} from '../../utils/ng_component_template';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n@@ -69,9 +70,21 @@ async function runMigration(tree: Tree, context: SchematicContext) {\n     }\n   }\n \n+  let compilerModule;\n+  try {\n+    // Load ESM `@angular/compiler` using the TypeScript dynamic import workaround.\n+    // Once TypeScript provides support for keeping the dynamic import this workaround can be\n+    // changed to a direct dynamic import.\n+    compilerModule = await loadEsmModule<typeof import('@angular/compiler')>('@angular/compiler');\n+  } catch (e) {\n+    throw new SchematicsException(\n+        `Unable to load the '@angular/compiler' package. Details: ${e.message}`);\n+  }\n+\n   if (buildProjects.size) {\n     for (let project of Array.from(buildProjects.values())) {\n-      failures.push(...await runStaticQueryMigration(tree, project, strategy, logger));\n+      failures.push(\n+          ...await runStaticQueryMigration(tree, project, strategy, logger, compilerModule));\n     }\n   }\n \n@@ -80,8 +93,8 @@ async function runMigration(tree: Tree, context: SchematicContext) {\n   for (const tsconfigPath of testPaths) {\n     const project = await analyzeProject(tree, tsconfigPath, basePath, analyzedFiles, logger);\n     if (project) {\n-      failures.push(\n-          ...await runStaticQueryMigration(tree, project, SELECTED_STRATEGY.TESTS, logger));\n+      failures.push(...await runStaticQueryMigration(\n+          tree, project, SELECTED_STRATEGY.TESTS, logger, compilerModule));\n     }\n   }\n \n@@ -150,7 +163,8 @@ function analyzeProject(\n  */\n async function runStaticQueryMigration(\n     tree: Tree, project: AnalyzedProject, selectedStrategy: SELECTED_STRATEGY,\n-    logger: logging.LoggerApi): Promise<string[]> {\n+    logger: logging.LoggerApi,\n+    compilerModule: typeof import('@angular/compiler')): Promise<string[]> {\n   const {sourceFiles, typeChecker, host, queryVisitor, tsconfigPath, basePath} = project;\n   const printer = ts.createPrinter();\n   const failureMessages: string[] = [];\n@@ -177,11 +191,11 @@ async function runStaticQueryMigration(\n \n   let strategy: TimingStrategy;\n   if (selectedStrategy === SELECTED_STRATEGY.USAGE) {\n-    strategy = new QueryUsageStrategy(classMetadata, typeChecker);\n+    strategy = new QueryUsageStrategy(classMetadata, typeChecker, compilerModule);\n   } else if (selectedStrategy === SELECTED_STRATEGY.TESTS) {\n     strategy = new QueryTestStrategy();\n   } else {\n-    strategy = new QueryTemplateStrategy(tsconfigPath, classMetadata, host);\n+    strategy = new QueryTemplateStrategy(tsconfigPath, classMetadata, host, compilerModule);\n   }\n \n   try {"
        },
        {
            "sha": "9b1608e984fac80b57188bd3eef8d404eed75e0b",
            "filename": "packages/core/schematics/migrations/static-queries/strategies/template_strategy/template_strategy.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 39,
            "changes": 78,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Ftemplate_strategy%2Ftemplate_strategy.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Ftemplate_strategy%2Ftemplate_strategy.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Ftemplate_strategy%2Ftemplate_strategy.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AotCompiler, CompileDirectiveMetadata, CompileMetadataResolver, CompileNgModuleMetadata, CompileStylesheetMetadata, ElementAst, EmbeddedTemplateAst, NgAnalyzedModules, QueryMatch, StaticSymbol, TemplateAst} from '@angular/compiler';\n+import type {AotCompiler, CompileDirectiveMetadata, CompileMetadataResolver, CompileNgModuleMetadata, CompileStylesheetMetadata, ElementAst, EmbeddedTemplateAst, NgAnalyzedModules, QueryMatch, StaticSymbol, TemplateAst} from '@angular/compiler';\n import {createProgram, Diagnostic, readConfiguration} from '@angular/compiler-cli';\n import {resolve} from 'path';\n import * as ts from 'typescript';\n@@ -25,7 +25,7 @@ export class QueryTemplateStrategy implements TimingStrategy {\n \n   constructor(\n       private projectPath: string, private classMetadata: ClassMetadataMap,\n-      private host: ts.CompilerHost) {}\n+      private host: ts.CompilerHost, private compilerModule: typeof import('@angular/compiler')) {}\n \n   /**\n    * Sets up the template strategy by creating the AngularCompilerProgram. Returns false if\n@@ -54,8 +54,8 @@ export class QueryTemplateStrategy implements TimingStrategy {\n     // breaks the analysis of the project because we instantiate a standalone AOT compiler\n     // program which does not contain the custom logic by the Angular CLI Webpack compiler plugin.\n     const directiveNormalizer = this.metadataResolver!['_directiveNormalizer'];\n-    directiveNormalizer['_normalizeStylesheet'] = function(metadata: CompileStylesheetMetadata) {\n-      return new CompileStylesheetMetadata(\n+    directiveNormalizer['_normalizeStylesheet'] = (metadata: CompileStylesheetMetadata) => {\n+      return new this.compilerModule.CompileStylesheetMetadata(\n           {styles: metadata.styles, styleUrls: [], moduleUrl: metadata.moduleUrl!});\n     };\n \n@@ -83,7 +83,7 @@ export class QueryTemplateStrategy implements TimingStrategy {\n     }\n \n     const parsedTemplate = this._parseTemplate(metadata, ngModule);\n-    const queryTimingMap = findStaticQueryIds(parsedTemplate);\n+    const queryTimingMap = this.findStaticQueryIds(parsedTemplate);\n     const {staticQueryIds} = staticViewQueryIds(queryTimingMap);\n \n     metadata.viewQueries.forEach((query, index) => {\n@@ -187,47 +187,47 @@ export class QueryTemplateStrategy implements TimingStrategy {\n   private _getViewQueryUniqueKey(filePath: string, className: string, propName: string) {\n     return `${resolve(filePath)}#${className}-${propName}`;\n   }\n+\n+  /** Figures out which queries are static and which ones are dynamic. */\n+  private findStaticQueryIds(\n+      nodes: TemplateAst[], result = new Map<TemplateAst, StaticAndDynamicQueryIds>()):\n+      Map<TemplateAst, StaticAndDynamicQueryIds> {\n+    nodes.forEach((node) => {\n+      const staticQueryIds = new Set<number>();\n+      const dynamicQueryIds = new Set<number>();\n+      let queryMatches: QueryMatch[] = undefined!;\n+      if (node instanceof this.compilerModule.ElementAst) {\n+        this.findStaticQueryIds(node.children, result);\n+        node.children.forEach((child) => {\n+          const childData = result.get(child)!;\n+          childData.staticQueryIds.forEach(queryId => staticQueryIds.add(queryId));\n+          childData.dynamicQueryIds.forEach(queryId => dynamicQueryIds.add(queryId));\n+        });\n+        queryMatches = node.queryMatches;\n+      } else if (node instanceof this.compilerModule.EmbeddedTemplateAst) {\n+        this.findStaticQueryIds(node.children, result);\n+        node.children.forEach((child) => {\n+          const childData = result.get(child)!;\n+          childData.staticQueryIds.forEach(queryId => dynamicQueryIds.add(queryId));\n+          childData.dynamicQueryIds.forEach(queryId => dynamicQueryIds.add(queryId));\n+        });\n+        queryMatches = node.queryMatches;\n+      }\n+      if (queryMatches) {\n+        queryMatches.forEach((match) => staticQueryIds.add(match.queryId));\n+      }\n+      dynamicQueryIds.forEach(queryId => staticQueryIds.delete(queryId));\n+      result.set(node, {staticQueryIds, dynamicQueryIds});\n+    });\n+    return result;\n+  }\n }\n \n interface StaticAndDynamicQueryIds {\n   staticQueryIds: Set<number>;\n   dynamicQueryIds: Set<number>;\n }\n \n-/** Figures out which queries are static and which ones are dynamic. */\n-function findStaticQueryIds(\n-    nodes: TemplateAst[], result = new Map<TemplateAst, StaticAndDynamicQueryIds>()):\n-    Map<TemplateAst, StaticAndDynamicQueryIds> {\n-  nodes.forEach((node) => {\n-    const staticQueryIds = new Set<number>();\n-    const dynamicQueryIds = new Set<number>();\n-    let queryMatches: QueryMatch[] = undefined!;\n-    if (node instanceof ElementAst) {\n-      findStaticQueryIds(node.children, result);\n-      node.children.forEach((child) => {\n-        const childData = result.get(child)!;\n-        childData.staticQueryIds.forEach(queryId => staticQueryIds.add(queryId));\n-        childData.dynamicQueryIds.forEach(queryId => dynamicQueryIds.add(queryId));\n-      });\n-      queryMatches = node.queryMatches;\n-    } else if (node instanceof EmbeddedTemplateAst) {\n-      findStaticQueryIds(node.children, result);\n-      node.children.forEach((child) => {\n-        const childData = result.get(child)!;\n-        childData.staticQueryIds.forEach(queryId => dynamicQueryIds.add(queryId));\n-        childData.dynamicQueryIds.forEach(queryId => dynamicQueryIds.add(queryId));\n-      });\n-      queryMatches = node.queryMatches;\n-    }\n-    if (queryMatches) {\n-      queryMatches.forEach((match) => staticQueryIds.add(match.queryId));\n-    }\n-    dynamicQueryIds.forEach(queryId => staticQueryIds.delete(queryId));\n-    result.set(node, {staticQueryIds, dynamicQueryIds});\n-  });\n-  return result;\n-}\n-\n /** Splits queries into static and dynamic. */\n function staticViewQueryIds(nodeStaticQueryIds: Map<TemplateAst, StaticAndDynamicQueryIds>):\n     StaticAndDynamicQueryIds {"
        },
        {
            "sha": "6035592ab7c70c3edd15323b0509805b114c336f",
            "filename": "packages/core/schematics/migrations/static-queries/strategies/usage_strategy/template_usage_visitor.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 28,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Fusage_strategy%2Ftemplate_usage_visitor.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Fusage_strategy%2Ftemplate_usage_visitor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Fusage_strategy%2Ftemplate_usage_visitor.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ImplicitReceiver, ParseSourceSpan, PropertyRead, RecursiveAstVisitor, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstElement, TmplAstNode, TmplAstTemplate} from '@angular/compiler';\n+import type {ParseSourceSpan, PropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstElement, TmplAstNode, TmplAstTemplate} from '@angular/compiler';\n import {TemplateAstVisitor} from '../../../../utils/template_ast_visitor';\n \n /**\n@@ -15,10 +15,33 @@ import {TemplateAstVisitor} from '../../../../utils/template_ast_visitor';\n  */\n export class TemplateUsageVisitor extends TemplateAstVisitor {\n   private hasQueryTemplateReference = false;\n-  private expressionAstVisitor = new ExpressionAstVisitor(this.queryPropertyName);\n-\n-  constructor(public queryPropertyName: string) {\n-    super();\n+  private expressionAstVisitor;\n+\n+  constructor(\n+      public queryPropertyName: string, compilerModule: typeof import('@angular/compiler')) {\n+    super(compilerModule);\n+\n+    // AST visitor that checks if the given expression contains property reads that\n+    // refer to the specified query property name.\n+    // This class must be defined within the template visitor due to the need to extend from a class\n+    // value found within `@angular/compiler` which is dynamically imported and provided to the\n+    // visitor.\n+    this.expressionAstVisitor = new (class extends compilerModule.RecursiveAstVisitor {\n+      hasQueryPropertyRead = false;\n+\n+\n+      override visitPropertyRead(node: PropertyRead, span: ParseSourceSpan): any {\n+        // The receiver of the property read needs to be \"implicit\" as queries are accessed\n+        // from the component instance and not from other objects.\n+        if (node.receiver instanceof compilerModule.ImplicitReceiver &&\n+            node.name === queryPropertyName) {\n+          this.hasQueryPropertyRead = true;\n+          return;\n+        }\n+\n+        super.visitPropertyRead(node, span);\n+      }\n+    })();\n   }\n \n   /** Checks whether the given query is statically accessed within the specified HTML nodes. */\n@@ -69,26 +92,3 @@ export class TemplateUsageVisitor extends TemplateAstVisitor {\n     node.handler.visit(this.expressionAstVisitor, node.handlerSpan);\n   }\n }\n-\n-/**\n- * AST visitor that checks if the given expression contains property reads that\n- * refer to the specified query property name.\n- */\n-class ExpressionAstVisitor extends RecursiveAstVisitor {\n-  hasQueryPropertyRead = false;\n-\n-  constructor(private queryPropertyName: string) {\n-    super();\n-  }\n-\n-  override visitPropertyRead(node: PropertyRead, span: ParseSourceSpan): any {\n-    // The receiver of the property read needs to be \"implicit\" as queries are accessed\n-    // from the component instance and not from other objects.\n-    if (node.receiver instanceof ImplicitReceiver && node.name === this.queryPropertyName) {\n-      this.hasQueryPropertyRead = true;\n-      return;\n-    }\n-\n-    super.visitPropertyRead(node, span);\n-  }\n-}"
        },
        {
            "sha": "d094de00d724a306bb2ac5c7f18fa177461bd1ac",
            "filename": "packages/core/schematics/migrations/static-queries/strategies/usage_strategy/usage_strategy.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Fusage_strategy%2Fusage_strategy.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Fusage_strategy%2Fusage_strategy.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fstatic-queries%2Fstrategies%2Fusage_strategy%2Fusage_strategy.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -35,7 +35,9 @@ const STATIC_QUERY_LIFECYCLE_HOOKS = {\n  * this strategy here: https://hackmd.io/s/Hymvc2OKE\n  */\n export class QueryUsageStrategy implements TimingStrategy {\n-  constructor(private classMetadata: ClassMetadataMap, private typeChecker: ts.TypeChecker) {}\n+  constructor(\n+      private classMetadata: ClassMetadataMap, private typeChecker: ts.TypeChecker,\n+      private compilerModule: typeof import('@angular/compiler')) {}\n \n   setup() {}\n \n@@ -101,8 +103,9 @@ export class QueryUsageStrategy implements TimingStrategy {\n     // can be marked as static.\n     if (classMetadata.template && hasPropertyNameText(query.property!.name)) {\n       const template = classMetadata.template;\n-      const parsedHtml = parseHtmlGracefully(template.content, template.filePath);\n-      const htmlVisitor = new TemplateUsageVisitor(query.property!.name.text);\n+      const parsedHtml =\n+          parseHtmlGracefully(template.content, template.filePath, this.compilerModule);\n+      const htmlVisitor = new TemplateUsageVisitor(query.property!.name.text, this.compilerModule);\n \n       if (parsedHtml && htmlVisitor.isQueryUsedStatically(parsedHtml)) {\n         return ResolvedUsage.SYNCHRONOUS;"
        },
        {
            "sha": "a74aba88d2237f22b1b6f46275da23206607f236",
            "filename": "packages/core/schematics/migrations/template-var-assignment/analyze_template.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fanalyze_template.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fanalyze_template.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fanalyze_template.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {PropertyWrite} from '@angular/compiler';\n+import type {PropertyWrite} from '@angular/compiler';\n import {ResolvedTemplate} from '../../utils/ng_component_template';\n import {parseHtmlGracefully} from '../../utils/parse_html';\n import {HtmlVariableAssignmentVisitor} from './angular/html_variable_assignment_visitor';\n@@ -21,15 +21,16 @@ export interface TemplateVariableAssignment {\n  * Analyzes a given resolved template by looking for property assignments to local\n  * template variables within bound events.\n  */\n-export function analyzeResolvedTemplate(template: ResolvedTemplate): TemplateVariableAssignment[]|\n-    null {\n-  const templateNodes = parseHtmlGracefully(template.content, template.filePath);\n+export function analyzeResolvedTemplate(\n+    template: ResolvedTemplate,\n+    compilerModule: typeof import('@angular/compiler')): TemplateVariableAssignment[]|null {\n+  const templateNodes = parseHtmlGracefully(template.content, template.filePath, compilerModule);\n \n   if (!templateNodes) {\n     return null;\n   }\n \n-  const visitor = new HtmlVariableAssignmentVisitor();\n+  const visitor = new HtmlVariableAssignmentVisitor(compilerModule);\n \n   // Analyze the Angular Render3 HTML AST and collect all template variable assignments.\n   visitor.visitAll(templateNodes);"
        },
        {
            "sha": "afc443e1544852af196a5cd52814966dfcb570b5",
            "filename": "packages/core/schematics/migrations/template-var-assignment/angular/html_variable_assignment_visitor.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 24,
            "changes": 54,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fangular%2Fhtml_variable_assignment_visitor.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fangular%2Fhtml_variable_assignment_visitor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Fangular%2Fhtml_variable_assignment_visitor.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ImplicitReceiver, ParseSourceSpan, PropertyWrite, RecursiveAstVisitor, TmplAstBoundEvent, TmplAstElement, TmplAstTemplate, TmplAstVariable} from '@angular/compiler';\n+import type {ImplicitReceiver, ParseSourceSpan, PropertyWrite, RecursiveAstVisitor, TmplAstBoundEvent, TmplAstElement, TmplAstTemplate, TmplAstVariable} from '@angular/compiler';\n import {TemplateAstVisitor} from '../../../utils/template_ast_visitor';\n \n \n@@ -24,8 +24,35 @@ export class HtmlVariableAssignmentVisitor extends TemplateAstVisitor {\n   variableAssignments: TemplateVariableAssignment[] = [];\n \n   private currentVariables: TmplAstVariable[] = [];\n-  private expressionAstVisitor =\n-      new ExpressionAstVisitor(this.variableAssignments, this.currentVariables);\n+  private expressionAstVisitor;\n+\n+  constructor(compilerModule: typeof import('@angular/compiler')) {\n+    super(compilerModule);\n+\n+    // AST visitor that resolves all variable assignments within a given expression AST.\n+    // This class must be defined within the template visitor due to the need to extend from a class\n+    // value found within `@angular/compiler` which is dynamically imported and provided to the\n+    // visitor.\n+    this.expressionAstVisitor = new (class extends compilerModule.RecursiveAstVisitor {\n+      constructor(\n+          private variableAssignments: TemplateVariableAssignment[],\n+          private currentVariables: TmplAstVariable[]) {\n+        super();\n+      }\n+\n+      override visitPropertyWrite(node: PropertyWrite, span: ParseSourceSpan) {\n+        if (node.receiver instanceof compilerModule.ImplicitReceiver &&\n+            this.currentVariables.some(v => v.name === node.name)) {\n+          this.variableAssignments.push({\n+            node: node,\n+            start: span.start.offset,\n+            end: span.end.offset,\n+          });\n+        }\n+        super.visitPropertyWrite(node, span);\n+      }\n+    })(this.variableAssignments, this.currentVariables);\n+  }\n \n   override visitElement(element: TmplAstElement): void {\n     this.visitAll(element.outputs);\n@@ -57,24 +84,3 @@ export class HtmlVariableAssignmentVisitor extends TemplateAstVisitor {\n     node.handler.visit(this.expressionAstVisitor, node.handlerSpan);\n   }\n }\n-\n-/** AST visitor that resolves all variable assignments within a given expression AST. */\n-class ExpressionAstVisitor extends RecursiveAstVisitor {\n-  constructor(\n-      private variableAssignments: TemplateVariableAssignment[],\n-      private currentVariables: TmplAstVariable[]) {\n-    super();\n-  }\n-\n-  override visitPropertyWrite(node: PropertyWrite, span: ParseSourceSpan) {\n-    if (node.receiver instanceof ImplicitReceiver &&\n-        this.currentVariables.some(v => v.name === node.name)) {\n-      this.variableAssignments.push({\n-        node: node,\n-        start: span.start.offset,\n-        end: span.end.offset,\n-      });\n-    }\n-    super.visitPropertyWrite(node, span);\n-  }\n-}"
        },
        {
            "sha": "4e5a228a3d1e20c75f1a4a8b7a3e105e1fd67b2c",
            "filename": "packages/core/schematics/migrations/template-var-assignment/index.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 3,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Ftemplate-var-assignment%2Findex.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -10,6 +10,7 @@ import {logging, normalize} from '@angular-devkit/core';\n import {Rule, SchematicContext, SchematicsException, Tree} from '@angular-devkit/schematics';\n import {relative} from 'path';\n \n+import {loadEsmModule} from '../../utils/load_esm';\n import {NgComponentTemplateVisitor} from '../../utils/ng_component_template';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n@@ -33,8 +34,20 @@ export default function(): Rule {\n           'assignments.');\n     }\n \n+    let compilerModule;\n+    try {\n+      // Load ESM `@angular/compiler` using the TypeScript dynamic import workaround.\n+      // Once TypeScript provides support for keeping the dynamic import this workaround can be\n+      // changed to a direct dynamic import.\n+      compilerModule = await loadEsmModule<typeof import('@angular/compiler')>('@angular/compiler');\n+    } catch (e) {\n+      throw new SchematicsException(\n+          `Unable to load the '@angular/compiler' package. Details: ${e.message}`);\n+    }\n+\n     for (const tsconfigPath of [...buildPaths, ...testPaths]) {\n-      runTemplateVariableAssignmentCheck(tree, tsconfigPath, basePath, context.logger);\n+      runTemplateVariableAssignmentCheck(\n+          tree, tsconfigPath, basePath, context.logger, compilerModule);\n     }\n   };\n }\n@@ -44,7 +57,8 @@ export default function(): Rule {\n  * if values are assigned to template variables within output bindings.\n  */\n function runTemplateVariableAssignmentCheck(\n-    tree: Tree, tsconfigPath: string, basePath: string, logger: Logger) {\n+    tree: Tree, tsconfigPath: string, basePath: string, logger: Logger,\n+    compilerModule: typeof import('@angular/compiler')) {\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n   const templateVisitor = new NgComponentTemplateVisitor(typeChecker);\n@@ -61,7 +75,7 @@ function runTemplateVariableAssignmentCheck(\n   // template variables.\n   resolvedTemplates.forEach(template => {\n     const filePath = template.filePath;\n-    const nodes = analyzeResolvedTemplate(template);\n+    const nodes = analyzeResolvedTemplate(template, compilerModule);\n \n     if (!nodes) {\n       return;"
        },
        {
            "sha": "502ad8403fb86b549dd35df64964deba1320e1c2",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/create_ngc_program.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fcreate_ngc_program.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fcreate_ngc_program.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fcreate_ngc_program.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AotCompiler} from '@angular/compiler';\n+import type {AotCompiler} from '@angular/compiler';\n import {CompilerHost, createProgram, readConfiguration} from '@angular/compiler-cli';\n import * as ts from 'typescript';\n "
        },
        {
            "sha": "ea17cdfab748dc08fe47f16c999cd6d0c77459cc",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/decorator_rewrite/convert_directive_metadata.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fconvert_directive_metadata.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fconvert_directive_metadata.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fconvert_directive_metadata.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {StaticSymbol} from '@angular/compiler';\n+import type {StaticSymbol} from '@angular/compiler';\n import * as ts from 'typescript';\n \n /** Error that will be thrown if an unexpected value needs to be converted. */\n@@ -17,15 +17,16 @@ export class UnexpectedMetadataValueError extends Error {}\n  * if metadata cannot be cleanly converted.\n  */\n export function convertDirectiveMetadataToExpression(\n-    metadata: any, resolveSymbolImport: (symbol: StaticSymbol) => string | null,\n+    compilerModule: typeof import('@angular/compiler'), metadata: any,\n+    resolveSymbolImport: (symbol: StaticSymbol) => string | null,\n     createImport: (moduleName: string, name: string) => ts.Expression,\n     convertProperty?: (key: string, value: any) => ts.Expression | null): ts.Expression {\n   if (typeof metadata === 'string') {\n     return ts.createStringLiteral(metadata);\n   } else if (Array.isArray(metadata)) {\n     return ts.createArrayLiteral(metadata.map(\n         el => convertDirectiveMetadataToExpression(\n-            el, resolveSymbolImport, createImport, convertProperty)));\n+            compilerModule, el, resolveSymbolImport, createImport, convertProperty)));\n   } else if (typeof metadata === 'number') {\n     return ts.createNumericLiteral(metadata.toString());\n   } else if (typeof metadata === 'boolean') {\n@@ -38,7 +39,7 @@ export function convertDirectiveMetadataToExpression(\n     // In case there is a static symbol object part of the metadata, try to resolve\n     // the import expression of the symbol. If no import path could be resolved, an\n     // error will be thrown as the symbol cannot be converted into TypeScript AST.\n-    if (metadata instanceof StaticSymbol) {\n+    if (metadata instanceof compilerModule.StaticSymbol) {\n       const resolvedImport = resolveSymbolImport(metadata);\n       if (resolvedImport === null) {\n         throw new UnexpectedMetadataValueError();\n@@ -63,7 +64,7 @@ export function convertDirectiveMetadataToExpression(\n       // the resolved metadata value into a TypeScript expression.\n       if (propertyValue === null) {\n         propertyValue = convertDirectiveMetadataToExpression(\n-            metadataValue, resolveSymbolImport, createImport, convertProperty);\n+            compilerModule, metadataValue, resolveSymbolImport, createImport, convertProperty);\n       }\n \n       literalProperties.push(ts.createPropertyAssignment(getPropertyName(key), propertyValue));"
        },
        {
            "sha": "e1daadb17eb82d1fc12f896a3750672496c71d1f",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/decorator_rewrite/decorator_rewriter.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fdecorator_rewriter.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fdecorator_rewriter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fdecorator_rewriter.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,7 +6,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {AotCompiler} from '@angular/compiler';\n+import type {AotCompiler} from '@angular/compiler';\n import {PartialEvaluator} from '@angular/compiler-cli/src/ngtsc/partial_evaluator';\n import * as ts from 'typescript';\n "
        },
        {
            "sha": "4a1fff12daf00e5322343fbaa3e2e5782cad69b2",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/decorator_rewrite/import_rewrite_visitor.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fimport_rewrite_visitor.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fimport_rewrite_visitor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Fdecorator_rewrite%2Fimport_rewrite_visitor.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AotCompilerHost} from '@angular/compiler';\n+import type {AotCompilerHost} from '@angular/compiler';\n import {dirname, resolve} from 'path';\n import * as ts from 'typescript';\n "
        },
        {
            "sha": "ed2ea8b804a6cbd2d6892069bf30063ba722dbed",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/index.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 6,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Findex.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -8,13 +8,14 @@\n \n import {logging} from '@angular-devkit/core';\n import {Rule, SchematicContext, SchematicsException, Tree} from '@angular-devkit/schematics';\n-import {AotCompiler} from '@angular/compiler';\n+import type {AotCompiler} from '@angular/compiler';\n import {Diagnostic as NgDiagnostic} from '@angular/compiler-cli';\n import {PartialEvaluator} from '@angular/compiler-cli/src/ngtsc/partial_evaluator';\n import {TypeScriptReflectionHost} from '@angular/compiler-cli/src/ngtsc/reflection';\n import {relative} from 'path';\n import * as ts from 'typescript';\n \n+import {loadEsmModule} from '../../utils/load_esm';\n import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n import {canMigrateFile, createMigrationCompilerHost} from '../../utils/typescript/compiler_host';\n \n@@ -44,8 +45,20 @@ export default function(): Rule {\n           'undecorated base classes which use DI.');\n     }\n \n+    let compilerModule;\n+    try {\n+      // Load ESM `@angular/compiler` using the TypeScript dynamic import workaround.\n+      // Once TypeScript provides support for keeping the dynamic import this workaround can be\n+      // changed to a direct dynamic import.\n+      compilerModule = await loadEsmModule<typeof import('@angular/compiler')>('@angular/compiler');\n+    } catch (e) {\n+      throw new SchematicsException(\n+          `Unable to load the '@angular/compiler' package. Details: ${e.message}`);\n+    }\n+\n     for (const tsconfigPath of buildPaths) {\n-      const result = runUndecoratedClassesMigration(tree, tsconfigPath, basePath, ctx.logger);\n+      const result =\n+          runUndecoratedClassesMigration(tree, tsconfigPath, basePath, ctx.logger, compilerModule);\n       failures.push(...result.failures);\n       programError = programError || !!result.programError;\n     }\n@@ -70,8 +83,9 @@ export default function(): Rule {\n }\n \n function runUndecoratedClassesMigration(\n-    tree: Tree, tsconfigPath: string, basePath: string,\n-    logger: logging.LoggerApi): {failures: string[], programError?: boolean} {\n+    tree: Tree, tsconfigPath: string, basePath: string, logger: logging.LoggerApi,\n+    compilerModule: typeof import('@angular/compiler')):\n+    {failures: string[], programError?: boolean} {\n   const failures: string[] = [];\n   const programData = gracefullyCreateProgram(tree, basePath, tsconfigPath, logger);\n \n@@ -92,8 +106,8 @@ function runUndecoratedClassesMigration(\n   sourceFiles.forEach(sourceFile => declarationCollector.visitNode(sourceFile));\n \n   const {decoratedDirectives, decoratedProviders, undecoratedDeclarations} = declarationCollector;\n-  const transform =\n-      new UndecoratedClassesTransform(typeChecker, compiler, partialEvaluator, getUpdateRecorder);\n+  const transform = new UndecoratedClassesTransform(\n+      typeChecker, compiler, partialEvaluator, getUpdateRecorder, compilerModule);\n   const updateRecorders = new Map<ts.SourceFile, UpdateRecorder>();\n \n   // Run the migrations for decorated providers and both decorated and undecorated"
        },
        {
            "sha": "3a59ebde011b9e3669f67b664a8f5ed3b8584c5c",
            "filename": "packages/core/schematics/migrations/undecorated-classes-with-di/transform.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Ftransform.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Ftransform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fundecorated-classes-with-di%2Ftransform.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AotCompiler, AotCompilerHost, CompileMetadataResolver, StaticSymbol, StaticSymbolResolver, SummaryResolver} from '@angular/compiler';\n+import type {AotCompiler, AotCompilerHost, CompileMetadataResolver, StaticSymbol, StaticSymbolResolver, SummaryResolver} from '@angular/compiler';\n import {PartialEvaluator} from '@angular/compiler-cli/src/ngtsc/partial_evaluator';\n import {ChangeDetectionStrategy, ViewEncapsulation} from '@angular/core';\n import * as ts from 'typescript';\n@@ -58,7 +58,8 @@ export class UndecoratedClassesTransform {\n   constructor(\n       private typeChecker: ts.TypeChecker, private compiler: AotCompiler,\n       private evaluator: PartialEvaluator,\n-      private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder) {\n+      private getUpdateRecorder: (sf: ts.SourceFile) => UpdateRecorder,\n+      private compilerModule: typeof import('@angular/compiler')) {\n     this.symbolResolver = compiler['_symbolResolver'];\n     this.compilerHost = compiler['_host'];\n     this.metadataResolver = compiler['_metadataResolver'];\n@@ -328,7 +329,7 @@ export class UndecoratedClassesTransform {\n       directiveMetadata: DeclarationMetadata, targetSourceFile: ts.SourceFile): ts.Decorator|null {\n     try {\n       const decoratorExpr = convertDirectiveMetadataToExpression(\n-          directiveMetadata.metadata,\n+          this.compilerModule, directiveMetadata.metadata,\n           staticSymbol =>\n               this.compilerHost\n                   .fileNameToModuleName(staticSymbol.filePath, targetSourceFile.fileName)"
        },
        {
            "sha": "16d3b21189407b8d6ee08f5839582eeff42f9f2a",
            "filename": "packages/core/schematics/utils/load_esm.ts",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Futils%2Fload_esm.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Futils%2Fload_esm.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Futils%2Fload_esm.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -0,0 +1,35 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {URL} from 'url';\n+\n+/**\n+ * This uses a dynamic import to load a module which may be ESM.\n+ * CommonJS code can load ESM code via a dynamic import. Unfortunately, TypeScript\n+ * will currently, unconditionally downlevel dynamic import into a require call.\n+ * require calls cannot load ESM code and will result in a runtime error. To workaround\n+ * this, a Function constructor is used to prevent TypeScript from changing the dynamic import.\n+ * Once TypeScript provides support for keeping the dynamic import this workaround can\n+ * be dropped.\n+ * This is only intended to be used with Angular framework packages.\n+ *\n+ * @param modulePath The path of the module to load.\n+ * @returns A Promise that resolves to the dynamically imported module.\n+ */\n+export async function loadEsmModule<T>(modulePath: string|URL): Promise<T> {\n+  const namespaceObject =\n+      (await new Function('modulePath', `return import(modulePath);`)(modulePath));\n+\n+  // If it is not ESM then the values needed will be stored in the `default` property.\n+  // TODO_ESM: This can be removed once `@angular/*` packages are ESM only.\n+  if (namespaceObject.default) {\n+    return namespaceObject.default;\n+  } else {\n+    return namespaceObject;\n+  }\n+}"
        },
        {
            "sha": "34ddf63b6bc1e7b03b9a9124217c5f05dacf5d7a",
            "filename": "packages/core/schematics/utils/parse_html.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Futils%2Fparse_html.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Futils%2Fparse_html.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Futils%2Fparse_html.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -6,15 +6,17 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {parseTemplate, TmplAstNode} from '@angular/compiler';\n+import type {TmplAstNode} from '@angular/compiler';\n \n /**\n  * Parses the given HTML content using the Angular compiler. In case the parsing\n  * fails, null is being returned.\n  */\n-export function parseHtmlGracefully(htmlContent: string, filePath: string): TmplAstNode[]|null {\n+export function parseHtmlGracefully(\n+    htmlContent: string, filePath: string,\n+    compilerModule: typeof import('@angular/compiler')): TmplAstNode[]|null {\n   try {\n-    return parseTemplate(htmlContent, filePath).nodes;\n+    return compilerModule.parseTemplate(htmlContent, filePath).nodes;\n   } catch {\n     // Do nothing if the template couldn't be parsed. We don't want to throw any\n     // exception if a template is syntactically not valid. e.g. template could be"
        },
        {
            "sha": "c779d88651d78627bdaeb4c9b173f880187743cf",
            "filename": "packages/core/schematics/utils/template_ast_visitor.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Futils%2Ftemplate_ast_visitor.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07cb097e9124738880f7978658a2972d25b892e/packages%2Fcore%2Fschematics%2Futils%2Ftemplate_ast_visitor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Futils%2Ftemplate_ast_visitor.ts?ref=a07cb097e9124738880f7978658a2972d25b892e",
            "patch": "@@ -24,6 +24,15 @@ import type {TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAst\n  * interface `Visitor<T>` is not exported.\n  */\n export class TemplateAstVisitor implements TmplAstRecursiveVisitor {\n+  /**\n+   * Creates a new Render3 Template AST visitor using an instance of the `@angular/compiler`\n+   * package. Passing in the compiler is required due to the need to dynamically import the\n+   * ESM `@angular/compiler` into a CommonJS schematic.\n+   *\n+   * @param compilerModule The compiler instance that should be used within the visitor.\n+   */\n+  constructor(protected readonly compilerModule: typeof import('@angular/compiler')) {}\n+\n   visitElement(element: TmplAstElement): void {}\n   visitTemplate(template: TmplAstTemplate): void {}\n   visitContent(content: TmplAstContent): void {}"
        }
    ],
    "stats": {
        "total": 419,
        "additions": 272,
        "deletions": 147
    }
}