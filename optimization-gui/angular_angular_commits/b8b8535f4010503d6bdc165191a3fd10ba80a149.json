{
    "author": "josephperrott",
    "message": "build: update tools directory for latest changes in rules_nodejs (#40710)\n\nUpdate the scripts/tooling in the tools directory to handle the changes in the latest\nversion of rules_nodejs.\n\nPR Close #40710",
    "sha": "b8b8535f4010503d6bdc165191a3fd10ba80a149",
    "files": [
        {
            "sha": "78ba8b0d7101a2e1fc89ffbcd0311594e3b570cc",
            "filename": "packages/compiler-cli/test/compliance/partial/partial_compliance_goldens.bzl",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b8b8535f4010503d6bdc165191a3fd10ba80a149/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fpartial_compliance_goldens.bzl",
            "raw_url": "https://github.com/angular/angular/raw/b8b8535f4010503d6bdc165191a3fd10ba80a149/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fpartial_compliance_goldens.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fpartial_compliance_goldens.bzl?ref=b8b8535f4010503d6bdc165191a3fd10ba80a149",
            "patch": "@@ -21,6 +21,9 @@ def partial_compliance_golden(filePath):\n         entry_point = \"//packages/compiler-cli/test/compliance/partial:cli.ts\",\n         templated_args = [\n             filePath,\n+            # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n+            # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n+            \"--bazel_patch_module_resolver\",\n         ],\n     )\n \n@@ -31,6 +34,9 @@ def partial_compliance_golden(filePath):\n         visibility = [\":__pkg__\"],\n         entry_point = \"//packages/compiler-cli/test/compliance/partial:cli.ts\",\n         templated_args = [\n+            # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n+            # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n+            \"--bazel_patch_module_resolver\",\n             \"--node_options=--inspect-brk\",\n             filePath,\n         ],"
        },
        {
            "sha": "154e48a9b269c5d0b48109296c5c759063be6890",
            "filename": "tools/defaults.bzl",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fdefaults.bzl",
            "raw_url": "https://github.com/angular/angular/raw/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fdefaults.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fdefaults.bzl?ref=b8b8535f4010503d6bdc165191a3fd10ba80a149",
            "patch": "@@ -3,10 +3,10 @@\n load(\"@bazel_tools//tools/build_defs/pkg:pkg.bzl\", \"pkg_tar\")\n load(\"@build_bazel_rules_nodejs//:index.bzl\", _nodejs_binary = \"nodejs_binary\", _pkg_npm = \"pkg_npm\")\n load(\"@npm//@bazel/jasmine:index.bzl\", _jasmine_node_test = \"jasmine_node_test\")\n-load(\"@npm//@bazel/karma:index.bzl\", _karma_web_test = \"karma_web_test\", _karma_web_test_suite = \"karma_web_test_suite\")\n+load(\"@npm//@bazel/concatjs:index.bzl\", _concatjs_devserver = \"concatjs_devserver\", _karma_web_test = \"karma_web_test\", _karma_web_test_suite = \"karma_web_test_suite\")\n load(\"@npm//@bazel/rollup:index.bzl\", _rollup_bundle = \"rollup_bundle\")\n load(\"@npm//@bazel/terser:index.bzl\", \"terser_minified\")\n-load(\"@npm//@bazel/typescript:index.bzl\", _ts_config = \"ts_config\", _ts_devserver = \"ts_devserver\", _ts_library = \"ts_library\")\n+load(\"@npm//@bazel/typescript:index.bzl\", _ts_config = \"ts_config\", _ts_library = \"ts_library\")\n load(\"@npm//@bazel/protractor:index.bzl\", _protractor_web_test_suite = \"protractor_web_test_suite\")\n load(\"@npm//typescript:index.bzl\", \"tsc\")\n load(\"//packages/bazel:index.bzl\", _ng_module = \"ng_module\", _ng_package = \"ng_package\")\n@@ -88,7 +88,7 @@ def _default_module_name(testonly):\n def ts_devserver(**kwargs):\n     \"\"\"Default values for ts_devserver\"\"\"\n     serving_path = kwargs.pop(\"serving_path\", \"/app_bundle.js\")\n-    _ts_devserver(\n+    _concatjs_devserver(\n         serving_path = serving_path,\n         **kwargs\n     )\n@@ -362,7 +362,10 @@ def jasmine_node_test(bootstrap = [], **kwargs):\n     configuration_env_vars = kwargs.pop(\"configuration_env_vars\", []) + [\n         \"angular_ivy_enabled\",\n     ]\n-    templated_args = kwargs.pop(\"templated_args\", [])\n+\n+    # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n+    # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n+    templated_args = [\"--bazel_patch_module_resolver\"] + kwargs.pop(\"templated_args\", [])\n     for label in bootstrap:\n         deps += [label]\n         templated_args += [\"--node_options=--require=$$(rlocation $(rootpath %s))\" % label]"
        },
        {
            "sha": "45e9bdd03e12794f5fdfe873321384ec22d6b5cb",
            "filename": "tools/postinstall-patches.js",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fpostinstall-patches.js",
            "raw_url": "https://github.com/angular/angular/raw/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fpostinstall-patches.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fpostinstall-patches.js?ref=b8b8535f4010503d6bdc165191a3fd10ba80a149",
            "patch": "@@ -45,13 +45,6 @@ sed('-i', '(\\'response\\' in xhr)', '(\\'response\\' in (xhr as any))',\n     'node_modules/rxjs/src/observable/dom/AjaxObservable.ts');\n */\n \n-// make chrome 74 work on OSX with karma under bazel\n-// remove when we update to the next @bazel/karma release\n-log('\\n# patch: @bazel/karma 0.29.0 to disable chrome sandbox for OSX');\n-sed('-i', 'process.platform !== \\'linux\\'',\n-    'process.platform !== \\'linux\\' && process.platform !== \\'darwin\\'',\n-    'node_modules/@bazel/karma/karma.conf.js');\n-\n // Workaround https://github.com/bazelbuild/rules_nodejs/issues/1033\n // TypeScript doesn't understand typings without \"declare module\" unless\n // they are actually resolved by the @types default mechanism"
        },
        {
            "sha": "cd8c61b21a6bff7830b001ad401d42f85e6dd2bb",
            "filename": "tools/size-tracking/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fsize-tracking%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fsize-tracking%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsize-tracking%2Findex.ts?ref=b8b8535f4010503d6bdc165191a3fd10ba80a149",
            "patch": "@@ -43,7 +43,7 @@ export function main(\n     return true;\n   }\n \n-  const expectedSizeData = <FileSizeData>JSON.parse(readFileSync(goldenSizeMapPath, 'utf8'));\n+  const expectedSizeData = JSON.parse(readFileSync(goldenSizeMapPath, 'utf8')) as FileSizeData;\n   const differences =\n       compareFileSizeData(sizeResult, expectedSizeData, {maxByteDiff, maxPercentageDiff});\n "
        },
        {
            "sha": "fc2e2c25356bff9995fdf1ec8d8a288b0858cbce",
            "filename": "tools/size-tracking/size_tracker.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fsize-tracking%2Fsize_tracker.ts",
            "raw_url": "https://github.com/angular/angular/raw/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fsize-tracking%2Fsize_tracker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsize-tracking%2Fsize_tracker.ts?ref=b8b8535f4010503d6bdc165191a3fd10ba80a149",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {readFileSync} from 'fs';\n-import {SourceMapConsumer} from 'source-map';\n+import {RawSourceMap, SourceMapConsumer} from 'source-map';\n \n import {DirectorySizeEntry, FileSizeData, omitCommonPathPrefix, sortFileSizeData} from './file_size_data';\n \n@@ -23,7 +23,8 @@ export class SizeTracker {\n \n   constructor(private filePath: string, private sourceMapPath: string) {\n     this.fileContent = readFileSync(filePath, 'utf8');\n-    this.consumer = new SourceMapConsumer(JSON.parse(readFileSync(sourceMapPath, 'utf8')));\n+    this.consumer =\n+        new SourceMapConsumer(JSON.parse(readFileSync(sourceMapPath, 'utf8')) as RawSourceMap);\n     this.sizeResult = this._computeSizeResult();\n   }\n "
        },
        {
            "sha": "2af74b76c06babedf6d44abba6e1fe4816a6c693",
            "filename": "tools/symbol-extractor/index.bzl",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fsymbol-extractor%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fsymbol-extractor%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Findex.bzl?ref=b8b8535f4010503d6bdc165191a3fd10ba80a149",
            "patch": "@@ -25,7 +25,9 @@ def js_expected_symbol_test(name, src, golden, data = [], **kwargs):\n         data = all_data,\n         entry_point = entry_point,\n         tags = kwargs.pop(\"tags\", []) + [\"symbol_extractor\"],\n-        templated_args = [\"$(rootpath %s)\" % src, \"$(rootpath %s)\" % golden],\n+        # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n+        # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n+        templated_args = [\"--bazel_patch_module_resolver\", \"$(rootpath %s)\" % src, \"$(rootpath %s)\" % golden],\n         configuration_env_vars = [\"angular_ivy_enabled\"],\n         **kwargs\n     )\n@@ -36,6 +38,8 @@ def js_expected_symbol_test(name, src, golden, data = [], **kwargs):\n         data = all_data,\n         entry_point = entry_point,\n         configuration_env_vars = [\"angular_ivy_enabled\"],\n-        templated_args = [\"$(rootpath %s)\" % src, \"$(rootpath %s)\" % golden, \"--accept\"],\n+        # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n+        # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n+        templated_args = [\"--bazel_patch_module_resolver\", \"$(rootpath %s)\" % src, \"$(rootpath %s)\" % golden, \"--accept\"],\n         **kwargs\n     )"
        },
        {
            "sha": "af5dd854146107ce9033dfdd7998dfdfb48f8616",
            "filename": "tools/symbol-extractor/symbol_extractor.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fsymbol-extractor%2Fsymbol_extractor.ts",
            "raw_url": "https://github.com/angular/angular/raw/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fsymbol-extractor%2Fsymbol_extractor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor.ts?ref=b8b8535f4010503d6bdc165191a3fd10ba80a149",
            "patch": "@@ -74,14 +74,14 @@ export class SymbolExtractor {\n \n   static diff(actual: Symbol[], expected: string|((Symbol | string)[])): {[name: string]: number} {\n     if (typeof expected == 'string') {\n-      expected = JSON.parse(expected);\n+      expected = JSON.parse(expected) as string[];\n     }\n     const diff: {[name: string]: number} = {};\n \n     // All symbols in the golden file start out with a count corresponding to the number of symbols\n     // with that name. Once they are matched with symbols in the actual output, the count should\n     // even out to 0.\n-    (expected as (Symbol | string)[]).forEach((nameOrSymbol) => {\n+    expected.forEach(nameOrSymbol => {\n       const symbolName = typeof nameOrSymbol == 'string' ? nameOrSymbol : nameOrSymbol.name;\n       diff[symbolName] = (diff[symbolName] || 0) + 1;\n     });"
        },
        {
            "sha": "f6ed5b311d3e10f1bf1c71ed8704c4fca2f1e59a",
            "filename": "tools/ts-api-guardian/index.bzl",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fts-api-guardian%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fts-api-guardian%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fts-api-guardian%2Findex.bzl?ref=b8b8535f4010503d6bdc165191a3fd10ba80a149",
            "patch": "@@ -48,8 +48,8 @@ def ts_api_guardian_test(\n         # Needed so that node doesn't walk back to the source directory.\n         # From there, the relative imports would point to .ts files.\n         \"--node_options=--preserve-symlinks\",\n-        # Since version 3, monkey-patch the implementation of require() in NodeJS is opt-in\n-        # https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n+        # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n+        # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n         \"--bazel_patch_module_resolver\",\n     ]\n \n@@ -112,6 +112,9 @@ def ts_api_guardian_test_npm_package(\n         \"--node_options=--preserve-symlinks\",\n         # We automatically discover the enpoints for our NPM package.\n         \"--autoDiscoverEntrypoints\",\n+        # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n+        # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n+        \"--bazel_patch_module_resolver\",\n     ]\n \n     for i in strip_export_pattern:"
        },
        {
            "sha": "d7428ef87c72fc173c2792a384b6ebd86166b1f3",
            "filename": "tools/ts-api-guardian/lib/main.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fts-api-guardian%2Flib%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/b8b8535f4010503d6bdc165191a3fd10ba80a149/tools%2Fts-api-guardian%2Flib%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fts-api-guardian%2Flib%2Fmain.ts?ref=b8b8535f4010503d6bdc165191a3fd10ba80a149",
            "patch": "@@ -86,7 +86,7 @@ export function discoverAllEntrypoints(dirPath: string) {\n \n   // Get all typings file locations from package.json files\n   for (const packageJson of packageJsons) {\n-    const packageJsonObj = JSON.parse(fs.readFileSync(packageJson, {encoding: 'utf8'}));\n+    const packageJsonObj = JSON.parse(fs.readFileSync(packageJson, {encoding: 'utf8'})) as any;\n     const typings = packageJsonObj.typings;\n     if (typings) {\n       entryPoints.push(path.join(path.dirname(packageJson), typings));"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 31,
        "deletions": 21
    }
}