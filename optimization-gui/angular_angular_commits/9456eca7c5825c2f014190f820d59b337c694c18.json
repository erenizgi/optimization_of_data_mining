{
    "author": "devversion",
    "message": "feat(dev-infra): better caching for browser archive contents (#42814)\n\nAdds better caching for browser archives and their extraction.\nThis is done because the archives are currently extracted as a build\naction and these are actions are invalidated frequently, causing\nflakiness on the CI and slow-down in local development.\n\nHere is an example flaky error on the CI (that surfaces often\nwith RBE execution):\n\n```\nERROR:\n/home/circleci/.cache/bazel/_bazel_circleci/9ce5c2144ecf75d11717c0aa41e45a8d/external/npm/@angular/dev-infra-private/bazel/browsers/chromium/BUILD.bazel:22:17:\nExtracting ../org_chromium_chromium_amd64/file/chrome-linux.zip failed:\n(Exit 34): extract.sh failed: error executing command\nexternal/io_bazel_rules_webtesting/web/internal/extract.sh\nexternal/org_chromium_chromium_amd64/file/chrome-linux.zip ...\n(remaining 2 argument(s) skipped). Note: Remote connection/protocol\nfailed with: execution failed\n```\n\nWe fix this by introducing a new rule that downloads a browser\narchive and unpacks it directly into a Bazel repository. Before\nthis change, the archive would just be downloaded but extracted\nlater as part of a build action. This is unnecessary and results\nin less efficient caching as build actions are invalidated more\noften, especially if developers run `bazel clean` in between.\n\nThe root cause on why the extraction often fails in RBE containers\nis unclear. It's unclear why the extacted archive is not cached\nproperly as part of a build action (most likely some hermeticity\nissue within `rules_webtesting`, but it seems more Bazel-idiomatic\nto unpack the archives as part of the repository anyway, and this solves\nthe flakiness issue.\n\nPR Close #42814",
    "sha": "9456eca7c5825c2f014190f820d59b337c694c18",
    "files": [
        {
            "sha": "adf143a33cfe6ef1692b5e33edcec12844e8b36e",
            "filename": "dev-infra/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2FBUILD.bazel?ref=9456eca7c5825c2f014190f820d59b337c694c18",
            "patch": "@@ -57,6 +57,7 @@ pkg_npm(\n     substitutions = {\n         # angular/angular should not consume it's own packages, so we use\n         # substitutions to replace these in the published version of dev-infra.\n+        \"@angular//dev-infra/\": \"@npm//@angular/dev-infra-private/\",\n         \"//dev-infra/\": \"@npm//@angular/dev-infra-private/\",\n         \"//dev-infra:\": \"@npm//@angular/dev-infra-private:\",\n "
        },
        {
            "sha": "0d9cdeb2154ebd941176157a4c83dc739f48661e",
            "filename": "dev-infra/bazel/browsers/browser_archive_repo.bzl",
            "status": "added",
            "additions": 80,
            "deletions": 0,
            "changes": 80,
            "blob_url": "https://github.com/angular/angular/blob/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_archive_repo.bzl",
            "raw_url": "https://github.com/angular/angular/raw/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_archive_repo.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_archive_repo.bzl?ref=9456eca7c5825c2f014190f820d59b337c694c18",
            "patch": "@@ -0,0 +1,80 @@\n+\"\"\"Implementation of the `browser_archive` rule.\"\"\"\n+\n+def _browser_archive_impl(ctx):\n+    ctx.report_progress(\"Downloading browser archive from: %s\" % ctx.attr.url)\n+    ctx.download_and_extract(\n+        url = ctx.attr.url,\n+        sha256 = ctx.attr.sha256,\n+    )\n+\n+    # The browser archive has been downloaded and extracted. We now generate a repository\n+    # `BUILD.bazel` file that exposes the archive files, together with the specified\n+    # named files using the `browser_configure` rule.\n+    ctx.file(\"BUILD.bazel\", content = \"\"\"\n+load(\"@angular//dev-infra/bazel/browsers:browser_configure.bzl\", \"browser_configure\")\n+\n+licenses(%s)\n+\n+browser_configure(\n+  name = \"metadata\",\n+  files = glob([\"**/*\"]),\n+  named_files = %s,\n+  visibility = [\"//visibility:public\"],\n+)\n+\"\"\" % (str(ctx.attr.licenses), str(ctx.attr.named_files)))\n+\n+\"\"\"\n+  Rule that can be used to download and unpack a browser archive in a dedicated Bazel\n+  repository. Additionally, files within the archive can be denoted with an unique name\n+  so that web tests can access browser files in a platform-agnostic way, regardless of\n+  which `browser_archive` repository is added as dependency.\n+\n+  As an example for the concept of denoting archive files with an unique name, consider a case\n+  where a a web test decides conditionally based on the current exec platform which\n+  `browser_archive` repository is used (e.g. mac, windows or linux). The archives are different\n+  for each platform. The test usually would need to determine the current platform, and know how\n+  each archive is structured in order to access the browser binary within the repository. By\n+  defining named files  though, the web test could just pull a named file called `BINARY` that\n+  always resolves to the browser binary in a platform-agnostic way.\n+\n+  Note #1: This rule exists as an alternative to the `platform_http_file` concept\n+  from `rules_webtesting` because the `platform_http_file` rule does not extract the archive\n+  directly, but relies on later build actions to perform the unpacking. This results in less\n+  efficient caching because build actions are invalidated more frequently (e.g. `bazel clean).\n+  We also noticed that the extraction within RBE containers is rather unstable, and extracting\n+  the archives as part of a Bazel repository mitigates this (as extractions happens on the host).\n+\n+  Note #2: Additionally `rules_webtesting` defines a single repository for all platforms,\n+  where only an archive for the current host platform is pulled. This breaks cross-compilation\n+  because the wrong platform archive would be used for web tests that run in the exec platform.\n+\"\"\"\n+browser_archive = repository_rule(\n+    implementation = _browser_archive_impl,\n+    attrs = {\n+        \"url\": attr.string(\n+            doc = \"Browser archive to download and extract.\",\n+            mandatory = True,\n+        ),\n+        \"sha256\": attr.string(\n+            doc = \"SHA256 checksum for the archive.\",\n+            mandatory = True,\n+        ),\n+        \"licenses\": attr.string_list(\n+            mandatory = True,\n+            allow_empty = False,\n+            doc = \"\"\"\n+              Licenses that apply to the archive. Will be passed to a `licenses` invocation\n+              within the repository. https://docs.bazel.build/versions/0.24.0/be/functions.html#licenses.\n+            \"\"\",\n+        ),\n+        \"named_files\": attr.string_dict(\n+            doc = \"\"\"\n+              Dictionary that maps files to unique identifiers. This is useful\n+              if browser archives are different on different platforms and the web\n+              tests would not want to care about archive-specific paths. e.g. targets\n+              expect a `CHROMIUM` key to point to the Chromium browser binary.\n+            \"\"\",\n+            mandatory = True,\n+        ),\n+    },\n+)"
        },
        {
            "sha": "ba184dcdce26e89bdff67196c006ae4411ee9d69",
            "filename": "dev-infra/bazel/browsers/browser_configure.bzl",
            "status": "added",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/angular/angular/blob/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_configure.bzl",
            "raw_url": "https://github.com/angular/angular/raw/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_configure.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_configure.bzl?ref=9456eca7c5825c2f014190f820d59b337c694c18",
            "patch": "@@ -0,0 +1,69 @@\n+load(\"@io_bazel_rules_webtesting//web/internal:metadata.bzl\", \"metadata\")\n+load(\"@io_bazel_rules_webtesting//web/internal:provider.bzl\", \"WebTestInfo\")\n+\n+\"\"\"Converts the specified label to a manifest path\"\"\"\n+\n+def _label_to_manifest_path(label):\n+    if label.package != \"\":\n+        return \"%s/%s\" % (label.workspace_name, label.package)\n+    return label.workspace_name\n+\n+\"\"\"Implementation of the `browser_configure` rule.\"\"\"\n+\n+def _browser_configure_impl(ctx):\n+    named_files = {}\n+    base_dir = _label_to_manifest_path(ctx.label)\n+\n+    # Update the named files to manifest paths that can be resolved\n+    # with Bazel runfile resolution in web tests.\n+    for n, p in ctx.attr.named_files.items():\n+        named_files[n] = base_dir + \"/\" + p\n+\n+    # Create a web test metadata file that will be provided as part of\n+    # the `WebTestInfo` provider.\n+    metadata.create_file(\n+        ctx = ctx,\n+        output = ctx.outputs.web_test_metadata,\n+        web_test_files = [\n+            metadata.web_test_files(ctx = ctx, named_files = named_files),\n+        ],\n+    )\n+\n+    return [\n+        DefaultInfo(runfiles = ctx.runfiles(files = ctx.files.files)),\n+        WebTestInfo(metadata = ctx.outputs.web_test_metadata),\n+    ]\n+\n+\"\"\"\n+  Rule that is used in combination with the `browser_archive` rule. It captures a set\n+  of files which are needed for dealing with a browser. Additionally, specific files\n+  for the browser can be denoted with an unique name so that web tests can access browser\n+  files in a platform-agnostic way, regardless of which browser repository is selected.\n+\n+  The specified browser files are exposed as runfiles of the target defined through this\n+  rule. The unique names with their associated files are captured within a metadata file\n+  that is exposed through a `WebTestInfo` provider. Web tests will be able to deal with\n+  this metadata file to resolve browser files in a platform-agnostic way.\n+\n+  More details on this can be found in the `browser_archive` rule.\n+\"\"\"\n+browser_configure = rule(\n+    attrs = {\n+        \"files\": attr.label_list(\n+            mandatory = True,\n+            allow_files = True,\n+            doc = \"List of files which are needed for the browser.\",\n+        ),\n+        \"named_files\": attr.string_dict(\n+            doc = \"\"\"\n+              Dictionary that maps files to unique identifiers. This is useful\n+              if browser archives are different on different platforms and the web\n+              tests would not want to care about archive-specific paths. e.g. targets\n+              expect a `CHROMIUM` key to point to the Chromium browser binary.\n+            \"\"\",\n+            mandatory = True,\n+        ),\n+    },\n+    outputs = {\"web_test_metadata\": \"%{name}.gen.json\"},\n+    implementation = _browser_configure_impl,\n+)"
        },
        {
            "sha": "cd65f89abc61fbfedb7357ed45f77ca171fe93cb",
            "filename": "dev-infra/bazel/browsers/browser_repositories.bzl",
            "status": "modified",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_repositories.bzl",
            "raw_url": "https://github.com/angular/angular/raw/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_repositories.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_repositories.bzl?ref=9456eca7c5825c2f014190f820d59b337c694c18",
            "patch": "@@ -1,17 +1,3 @@\n-# Copyright 2018 The Bazel Authors. All rights reserved.\n-#\n-# Licensed under the Apache License, Version 2.0 (the \"License\");\n-# you may not use this file except in compliance with the License.\n-# You may obtain a copy of the License at\n-#\n-#    http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \"AS IS\" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-\n \"\"\"Pinned browser versions.\n \n This function is here to make browser repositories work with cross-platform RBE."
        },
        {
            "sha": "6f5d4077eb96a26f1a12e4530da5e981c96b5961",
            "filename": "dev-infra/bazel/browsers/chromium/BUILD.bazel",
            "status": "modified",
            "additions": 15,
            "deletions": 63,
            "changes": 78,
            "blob_url": "https://github.com/angular/angular/blob/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Fchromium%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Fchromium%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fbrowsers%2Fchromium%2FBUILD.bazel?ref=9456eca7c5825c2f014190f820d59b337c694c18",
            "patch": "@@ -1,74 +1,26 @@\n-load(\"@io_bazel_rules_webtesting//web:web.bzl\", \"browser\", \"web_test_archive\")\n+load(\"@io_bazel_rules_webtesting//web:web.bzl\", \"browser\")\n \n-# Copyright Google LLC\n-#\n-# Licensed under the Apache License, Version 2.0 (the \"License\");\n-# you may not use this file except in compliance with the License.\n-# You may obtain a copy of the License at\n-#\n-#      http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \"AS IS\" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-#\n-################################################################################\n-#\n package(default_visibility = [\"//visibility:public\"])\n \n-# Override of chromium web_test_archive so that the archive is selected based on platform\n-web_test_archive(\n-    name = \"chromium_archive\",\n-    testonly = True,\n-    archive = select({\n-        \"@io_bazel_rules_webtesting//common/conditions:linux\": \"@org_chromium_chromium_amd64//file\",\n-        \"@io_bazel_rules_webtesting//common/conditions:mac\": \"@org_chromium_chromium_macos//file\",\n-        \"@io_bazel_rules_webtesting//common/conditions:windows\": \"@org_chromium_chromium_windows//file\",\n-    }),\n-    extract = \"build\",\n-    named_files = select({\n-        \"@io_bazel_rules_webtesting//common/conditions:linux\": {\"CHROMIUM\": \"chrome-linux/chrome\"},\n-        \"@io_bazel_rules_webtesting//common/conditions:mac\": {\"CHROMIUM\": \"chrome-mac/Chromium.app/Contents/MacOS/chromium\"},\n-        \"@io_bazel_rules_webtesting//common/conditions:windows\": {\"CHROMIUM\": \"chrome-win/chrome.exe\"},\n-    }),\n-    visibility = [\"//dev-infra/bazel/browsers:__subpackages__\"],\n-)\n-\n-# Override of chromedriver web_test_archive so that the archive is selected based on platform\n-web_test_archive(\n-    name = \"chromedriver_archive\",\n-    testonly = True,\n-    archive = select({\n-        \"@io_bazel_rules_webtesting//common/conditions:linux\": \"@org_chromium_chromedriver_amd64//file\",\n-        \"@io_bazel_rules_webtesting//common/conditions:mac\": \"@org_chromium_chromedriver_macos//file\",\n-        \"@io_bazel_rules_webtesting//common/conditions:windows\": \"@org_chromium_chromedriver_windows//file\",\n-    }),\n-    extract = \"build\",\n-    named_files = select({\n-        \"@io_bazel_rules_webtesting//common/conditions:linux\": {\n-            \"CHROMEDRIVER\": \"chromedriver_linux64/chromedriver\",\n-        },\n-        \"@io_bazel_rules_webtesting//common/conditions:mac\": {\n-            \"CHROMEDRIVER\": \"chromedriver_mac64/chromedriver\",\n-        },\n-        \"@io_bazel_rules_webtesting//common/conditions:windows\": {\n-            \"CHROMEDRIVER\": \"chromedriver_win32/chromedriver.exe\",\n-        },\n-    }),\n-    visibility = [\"//dev-infra/bazel/browsers:__subpackages__\"],\n-)\n-\n browser(\n     name = \"chromium\",\n     metadata = \"chromium.json\",\n-    visibility = [\"//visibility:public\"],\n     deps = [\n-        \":chromedriver_archive\",\n-        \":chromium_archive\",\n         \"@io_bazel_rules_webtesting//go/wsl\",\n-    ],\n+    ] + select({\n+        \"@io_bazel_rules_webtesting//common/conditions:linux\": [\n+            \"@org_chromium_chromedriver_amd64//:metadata\",\n+            \"@org_chromium_chromium_amd64//:metadata\",\n+        ],\n+        \"@io_bazel_rules_webtesting//common/conditions:mac\": [\n+            \"@org_chromium_chromedriver_macos//:metadata\",\n+            \"@org_chromium_chromium_macos//:metadata\",\n+        ],\n+        \"@io_bazel_rules_webtesting//common/conditions:windows\": [\n+            \"@org_chromium_chromedriver_windows//:metadata\",\n+            \"@org_chromium_chromium_windows//:metadata\",\n+        ],\n+    }),\n )\n \n # Make source files available for distribution via pkg_npm"
        },
        {
            "sha": "2af38af7bb8f35a298c79c936097c9afe54be95d",
            "filename": "dev-infra/bazel/browsers/chromium/chromium.bzl",
            "status": "modified",
            "additions": 31,
            "deletions": 13,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Fchromium%2Fchromium.bzl",
            "raw_url": "https://github.com/angular/angular/raw/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Fchromium%2Fchromium.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fbrowsers%2Fchromium%2Fchromium.bzl?ref=9456eca7c5825c2f014190f820d59b337c694c18",
            "patch": "@@ -1,4 +1,4 @@\n-load(\"//dev-infra/bazel/browsers:platform_http_file.bzl\", \"platform_http_file\")\n+load(\"//dev-infra/bazel/browsers:browser_archive_repo.bzl\", \"browser_archive\")\n \n \"\"\"\n   Defines repositories for Chromium that can be used inside Karma unit tests\n@@ -9,50 +9,68 @@ def define_chromium_repositories():\n     # To update to a newer version of Chromium see instructions in\n     # https://github.com/angular/angular/blob/master/dev-infra/bazel/browsers/README.md.\n \n-    platform_http_file(\n+    browser_archive(\n         name = \"org_chromium_chromium_amd64\",\n         licenses = [\"notice\"],  # BSD 3-clause (maybe more?)\n         sha256 = \"36759ed6d151645d00a3a015200334edc70188b422eec51bcaa5790c8e906e27\",\n         # 87.0.4280\n-        urls = [\"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Linux_x64/812847/chrome-linux.zip\"],\n+        url = \"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Linux_x64/812847/chrome-linux.zip\",\n+        named_files = {\n+            \"CHROMIUM\": \"chrome-linux/chrome\",\n+        },\n     )\n \n-    platform_http_file(\n+    browser_archive(\n         name = \"org_chromium_chromium_macos\",\n         licenses = [\"notice\"],  # BSD 3-clause (maybe more?)\n         sha256 = \"e10533c84ef57232975d6bde9cd28fd0354371e9556dda85e01178e6dcd56b93\",\n         # 87.0.4280\n-        urls = [\"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Mac/812851/chrome-mac.zip\"],\n+        url = \"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Mac/812851/chrome-mac.zip\",\n+        named_files = {\n+            \"CHROMIUM\": \"chrome-mac/Chromium.app/Contents/MacOS/chromium\",\n+        },\n     )\n \n-    platform_http_file(\n+    browser_archive(\n         name = \"org_chromium_chromium_windows\",\n         licenses = [\"notice\"],  # BSD 3-clause (maybe more?)\n         sha256 = \"40d0dec1892d729db2f7d8f27feff762b070a02f04d4e14f4e37b97d6b7c3c8f\",\n         # 87.0.4280\n-        urls = [\"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Win/812822/chrome-win.zip\"],\n+        url = \"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Win/812822/chrome-win.zip\",\n+        named_files = {\n+            \"CHROMIUM\": \"chrome-win/chrome.exe\",\n+        },\n     )\n \n-    platform_http_file(\n+    browser_archive(\n         name = \"org_chromium_chromedriver_amd64\",\n         licenses = [\"reciprocal\"],  # BSD 3-clause, ICU, MPL 1.1, libpng (BSD/MIT-like), Academic Free License v. 2.0, BSD 2-clause, MIT\n         sha256 = \"d859f8ecb21e26d3ddaf3f229da695bc86512f4e6c9fe32533af7a8b36783ec5\",\n         # 87.0.4280\n-        urls = [\"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Linux_x64/812847/chromedriver_linux64.zip\"],\n+        url = \"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Linux_x64/812847/chromedriver_linux64.zip\",\n+        named_files = {\n+            \"CHROMEDRIVER\": \"chromedriver_linux64/chromedriver\",\n+        },\n     )\n \n-    platform_http_file(\n+    browser_archive(\n         name = \"org_chromium_chromedriver_macos\",\n         licenses = [\"reciprocal\"],  # BSD 3-clause, ICU, MPL 1.1, libpng (BSD/MIT-like), Academic Free License v. 2.0, BSD 2-clause, MIT\n         sha256 = \"aa7a99fa23287725d7108cc07baa94e6f0ef4171ff7b134018387a939a67d93d\",\n         # 87.0.4280\n-        urls = [\"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Mac/812851/chromedriver_mac64.zip\"],\n+        url = \"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Mac/812851/chromedriver_mac64.zip\",\n+        named_files = {\n+            \"CHROMEDRIVER\": \"chromedriver_mac64/chromedriver\",\n+        },\n     )\n \n-    platform_http_file(\n+    browser_archive(\n         name = \"org_chromium_chromedriver_windows\",\n         licenses = [\"reciprocal\"],  # BSD 3-clause, ICU, MPL 1.1, libpng (BSD/MIT-like), Academic Free License v. 2.0, BSD 2-clause, MIT\n         sha256 = \"826f2bd0c50b823e7642860ed08cacf69d3756002a71ac30cdd77c68f31d2d24\",\n         # 87.0.4280\n-        urls = [\"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Win/812822/chromedriver_win32.zip\"],\n+        url = \"https://commondatastorage.googleapis.com/chromium-browser-snapshots/Win/812822/chromedriver_win32.zip\",\n+        named_files = {\n+            \"CHROMEDRIVER\": \"chromedriver_win32/chromedriver.exe\",\n+        },\n     )"
        },
        {
            "sha": "4c2ed68df628cae37cc407b9d765b1a94e073e1e",
            "filename": "dev-infra/bazel/browsers/firefox/BUILD.bazel",
            "status": "modified",
            "additions": 12,
            "deletions": 53,
            "changes": 65,
            "blob_url": "https://github.com/angular/angular/blob/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Ffirefox%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Ffirefox%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fbrowsers%2Ffirefox%2FBUILD.bazel?ref=9456eca7c5825c2f014190f820d59b337c694c18",
            "patch": "@@ -1,52 +1,7 @@\n-load(\"@io_bazel_rules_webtesting//web:web.bzl\", \"browser\", \"web_test_archive\")\n+load(\"@io_bazel_rules_webtesting//web:web.bzl\", \"browser\")\n \n-# Copyright Google LLC\n-#\n-# Licensed under the Apache License, Version 2.0 (the \"License\");\n-# you may not use this file except in compliance with the License.\n-# You may obtain a copy of the License at\n-#\n-#      http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \"AS IS\" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-#\n-################################################################################\n-#\n package(default_visibility = [\"//visibility:public\"])\n \n-# Override of firefox web_test_archive so that the archive is selected based on platform.\n-web_test_archive(\n-    name = \"firefox_archive\",\n-    testonly = True,\n-    archive = select({\n-        \"@io_bazel_rules_webtesting//common/conditions:linux\": \"@org_mozilla_firefox_amd64//file\",\n-        \"@io_bazel_rules_webtesting//common/conditions:mac\": \"@org_mozilla_firefox_macos//file\",\n-    }),\n-    extract = \"build\",\n-    named_files = select({\n-        \"@io_bazel_rules_webtesting//common/conditions:linux\": {\"FIREFOX\": \"firefox/firefox\"},\n-        \"@io_bazel_rules_webtesting//common/conditions:mac\": {\"FIREFOX\": \"Firefox.app/Contents/MacOS/firefox\"},\n-    }),\n-    visibility = [\"//dev-infra/bazel/browsers:__subpackages__\"],\n-)\n-\n-# Override of geckodriver web_test_archive so that the archive is selected based on platform.\n-web_test_archive(\n-    name = \"geckodriver_archive\",\n-    testonly = True,\n-    archive = select({\n-        \"@io_bazel_rules_webtesting//common/conditions:linux\": \"@org_mozilla_geckodriver_amd64//file\",\n-        \"@io_bazel_rules_webtesting//common/conditions:mac\": \"@org_mozilla_geckodriver_macos//file\",\n-    }),\n-    extract = \"build\",\n-    named_files = {\"GECKODRIVER\": \"geckodriver\"},\n-    visibility = [\"//dev-infra/bazel/browsers:__subpackages__\"],\n-)\n-\n browser(\n     name = \"firefox\",\n     disabled = select({\n@@ -56,14 +11,18 @@ browser(\n         \"//conditions:default\": None,\n     }),\n     metadata = \"firefox.json\",\n-    visibility = [\"//visibility:public\"],\n-    deps = select({\n-        \"@io_bazel_rules_webtesting//common/conditions:windows\": [],\n-        \"//conditions:default\": [\n-            \"@io_bazel_rules_webtesting//go/wsl\",\n-            \":firefox_archive\",\n-            \":geckodriver_archive\",\n+    deps = [\n+        \"@io_bazel_rules_webtesting//go/wsl\",\n+    ] + select({\n+        \"@io_bazel_rules_webtesting//common/conditions:linux\": [\n+            \"@org_mozilla_firefox_amd64//:metadata\",\n+            \"@org_mozilla_geckodriver_amd64//:metadata\",\n         ],\n+        \"@io_bazel_rules_webtesting//common/conditions:mac\": [\n+            \"@org_mozilla_firefox_macos//:metadata\",\n+            \"@org_mozilla_geckodriver_macos//:metadata\",\n+        ],\n+        \"@io_bazel_rules_webtesting//common/conditions:windows\": [],\n     }),\n )\n "
        },
        {
            "sha": "c959703fec8310ceb0f362ab2120e17cbd5186bf",
            "filename": "dev-infra/bazel/browsers/firefox/firefox.bzl",
            "status": "modified",
            "additions": 21,
            "deletions": 9,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Ffirefox%2Ffirefox.bzl",
            "raw_url": "https://github.com/angular/angular/raw/9456eca7c5825c2f014190f820d59b337c694c18/dev-infra%2Fbazel%2Fbrowsers%2Ffirefox%2Ffirefox.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fbrowsers%2Ffirefox%2Ffirefox.bzl?ref=9456eca7c5825c2f014190f820d59b337c694c18",
            "patch": "@@ -1,4 +1,4 @@\n-load(\"//dev-infra/bazel/browsers:platform_http_file.bzl\", \"platform_http_file\")\n+load(\"//dev-infra/bazel/browsers:browser_archive_repo.bzl\", \"browser_archive\")\n \n \"\"\"\n   Defines repositories for Firefox that can be used inside Karma unit tests\n@@ -9,34 +9,46 @@ def define_firefox_repositories():\n     # Instructions on updating the Firefox version can be found in the `README.md` file\n     # next to this file.\n \n-    platform_http_file(\n+    browser_archive(\n         name = \"org_mozilla_firefox_amd64\",\n         licenses = [\"reciprocal\"],  # MPL 2.0\n         sha256 = \"601e5a9a12ce680ecd82177c7887dae008d8f33690da43be1a690b76563cd992\",\n         # Firefox v84.0\n-        urls = [\"https://ftp.mozilla.org/pub/firefox/releases/84.0/linux-x86_64/en-US/firefox-84.0.tar.bz2\"],\n+        url = \"https://ftp.mozilla.org/pub/firefox/releases/84.0/linux-x86_64/en-US/firefox-84.0.tar.bz2\",\n+        named_files = {\n+            \"FIREFOX\": \"firefox/firefox\",\n+        },\n     )\n \n-    platform_http_file(\n+    browser_archive(\n         name = \"org_mozilla_firefox_macos\",\n         licenses = [\"reciprocal\"],  # MPL 2.0\n         sha256 = \"4c7bca050eb228f4f6f93a9895af0a87473e03c67401d1d2f1ba907faf87fefd\",\n         # Firefox v84.0\n-        urls = [\"https://ftp.mozilla.org/pub/firefox/releases/84.0/mac/en-US/Firefox%2084.0.dmg\"],\n+        url = \"https://ftp.mozilla.org/pub/firefox/releases/84.0/mac/en-US/Firefox%2084.0.dmg\",\n+        named_files = {\n+            \"FIREFOX\": \"Firefox.app/Contents/MacOS/firefox\",\n+        },\n     )\n \n-    platform_http_file(\n+    browser_archive(\n         name = \"org_mozilla_geckodriver_amd64\",\n         licenses = [\"reciprocal\"],  # MPL 2.0\n         sha256 = \"61bfc547a623d7305256611a81ecd24e6bf9dac555529ed6baeafcf8160900da\",\n         # Geckodriver v0.28.0\n-        urls = [\"https://github.com/mozilla/geckodriver/releases/download/v0.28.0/geckodriver-v0.28.0-linux64.tar.gz\"],\n+        url = \"https://github.com/mozilla/geckodriver/releases/download/v0.28.0/geckodriver-v0.28.0-linux64.tar.gz\",\n+        named_files = {\n+            \"GECKODRIVER\": \"geckodriver\",\n+        },\n     )\n \n-    platform_http_file(\n+    browser_archive(\n         name = \"org_mozilla_geckodriver_macos\",\n         licenses = [\"reciprocal\"],  # MPL 2.0\n         sha256 = \"c288ff6db39adfd5eea0e25b4c3e71bfd9fb383eccf521cdd65f67ea78eb1761\",\n         # Geckodriver v0.28.0\n-        urls = [\"https://github.com/mozilla/geckodriver/releases/download/v0.28.0/geckodriver-v0.28.0-macos.tar.gz\"],\n+        url = \"https://github.com/mozilla/geckodriver/releases/download/v0.28.0/geckodriver-v0.28.0-macos.tar.gz\",\n+        named_files = {\n+            \"GECKODRIVER\": \"geckodriver\",\n+        },\n     )"
        },
        {
            "sha": "c5db8d4ac4dc4e93541013142ef3679f7a8ba8e5",
            "filename": "dev-infra/bazel/browsers/platform_http_file.bzl",
            "status": "removed",
            "additions": 0,
            "deletions": 24,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/a524af15a5d231d1cf56780a2180ef2019d385c9/dev-infra%2Fbazel%2Fbrowsers%2Fplatform_http_file.bzl",
            "raw_url": "https://github.com/angular/angular/raw/a524af15a5d231d1cf56780a2180ef2019d385c9/dev-infra%2Fbazel%2Fbrowsers%2Fplatform_http_file.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fbrowsers%2Fplatform_http_file.bzl?ref=a524af15a5d231d1cf56780a2180ef2019d385c9",
            "patch": "@@ -1,24 +0,0 @@\n-load(\n-    \"@io_bazel_rules_webtesting//web/internal:platform_http_file.bzl\",\n-    _platform_http_file = \"platform_http_file\",\n-)\n-\n-def platform_http_file(name, licenses, sha256, urls):\n-    \"\"\"Platform specific browser repository.\n-\n-    This works around a deficiency in io_bazel_rules_webtesting platform_http_file in that\n-    it selects the platform when the repository rule is executed. This limits browsers\n-    tests to run on the local user platform only. For cross-platform RBE we want a repository\n-    to be defined per platform so the correct one can be selected.\n-    \"\"\"\n-\n-    _platform_http_file(\n-        name = name,\n-        amd64_sha256 = sha256,\n-        amd64_urls = urls,\n-        licenses = licenses,\n-        macos_sha256 = sha256,\n-        macos_urls = urls,\n-        windows_sha256 = sha256,\n-        windows_urls = urls,\n-    )"
        }
    ],
    "stats": {
        "total": 405,
        "additions": 229,
        "deletions": 176
    }
}