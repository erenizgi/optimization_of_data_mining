{
    "author": "mgechev",
    "message": "feat(devtools): support trusted types for script injection",
    "sha": "a93cfdca813b8ed0c86816e4ac53fea27a5aae7c",
    "files": [
        {
            "sha": "32817e2968111f258b6bcec0c42157fddf0fcc9b",
            "filename": "projects/shell-chrome/src/inject.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 19,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/a93cfdca813b8ed0c86816e4ac53fea27a5aae7c/projects%2Fshell-chrome%2Fsrc%2Finject.ts",
            "raw_url": "https://github.com/angular/angular/raw/a93cfdca813b8ed0c86816e4ac53fea27a5aae7c/projects%2Fshell-chrome%2Fsrc%2Finject.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fshell-chrome%2Fsrc%2Finject.ts?ref=a93cfdca813b8ed0c86816e4ac53fea27a5aae7c",
            "patch": "@@ -1,28 +1,42 @@\n-export const injectScripts = (scripts: string[], cb?: () => void) => {\n-  let injected = 0;\n-  scripts.forEach(s =>\n-    injectScript(chrome.runtime.getURL(s), () => {\n-      injected++;\n-      if (injected === scripts.length && cb) {\n-        cb();\n-      }\n+const loadScripts = (urls: string[]) => {\n+  return urls\n+    .map((url, idx) => {\n+      return `\n+      const script${idx} = document.constructor.prototype.createElement.call(document, 'script');\n+      script${idx}.src = getScriptName(\"${url}\");\n+      document.documentElement.appendChild(script${idx});\n+      script${idx}.parentNode.removeChild(script${idx});\n+    `;\n     })\n-  );\n+    .join('\\n');\n };\n \n-const injectScript = (scriptName: string, cb: () => void) => {\n-  const src = `\n-    (function() {\n-      var script = document.constructor.prototype.createElement.call(document, 'script');\n-      script.src = \"${scriptName}\";\n-      document.documentElement.appendChild(script);\n-      script.parentNode.removeChild(script);\n-    })()\n+let loaded = false;\n+export const injectScripts = (urls: string[], cb?: () => void) => {\n+  if (loaded) {\n+    // Not throwing a hard error here, because we don't want to stop the\n+    // execution when folks are not using Trusted Types or when they have\n+    // allowed redeclaration of a security policy.\n+    console.error('Trying to reinject scripts');\n+  }\n+  loaded = true;\n+  urls = urls.map((s) => chrome.runtime.getURL(s));\n+  const script = `\n+  (function () {\n+    let policy = null;\n+    if (window.trustedTypes && window.trustedTypes.createPolicy) {\n+      policy = window.trustedTypes.createPolicy('angular#devtools', {\n+        createScriptURL: url => ${JSON.stringify(urls)}.indexOf(url) >= 0 ? url : null\n+      });\n+    }\n+    const getScriptName = name => policy ? policy.createScriptURL(name) : name;\n+    ${loadScripts(urls)}\n+  })();\n   `;\n-  chrome.devtools.inspectedWindow.eval(src, (_, err) => {\n+  chrome.devtools.inspectedWindow.eval(script, (_, err) => {\n     if (err) {\n       console.log(err);\n     }\n-    cb();\n+    cb?.();\n   });\n };"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 33,
        "deletions": 19
    }
}