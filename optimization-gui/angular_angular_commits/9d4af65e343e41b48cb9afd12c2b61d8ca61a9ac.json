{
    "author": "ivanwonder",
    "message": "feat(language-service): Provide plugin to delegate rename requests to Angular (#44696)\n\nWhen the user wants to rename a symbol in the ts file VSCode\nwill ask the rename providers for the answer in turn. If the\nfirst extension returns the result, the VSCode will break the\nloop and apply the result. If the first extension cannot rename\nthe symbol, VSCode will ask the second extension in the\nlist (built-in TS/JS extension, Angular LS extension, etc.).\nIn other words, VSCode takes the result from only one rename provider\nand the order depends on registration timing, scoring.\n\nBecause the built-in ts extension and Angular extension have the\nsame high score, if the built-in ts extension is the\nfirst(depends on the time the extension was registered), the result\nwill be provided by the built-in extension. We want Angular to\nprovide it, so this plugin will delegate rename requests and reject\nthe request for the built-in ts server.\n\nThe Angular LS only provides the rename info when working within\nan Angular project. If we cannot locate Angular sources in the\nproject files, the built-in extension should provide the rename info.\n\nThis plugin will apply to the built-in TS/JS extension and delegate\nrename requests to the Angular LS. It provides the rename info only\nwhen it is an Angular project. Otherwise, it will return info by the\ndefault built-in ts server rename provider.\n\nSee [here][1] for more info.\n\n[1]: https://github.com/microsoft/vscode/issues/115354\n\nPR Close #44696",
    "sha": "9d4af65e343e41b48cb9afd12c2b61d8ca61a9ac",
    "files": [
        {
            "sha": "458591b0c8ab72a77cd4c3243faef6d1c170c9d5",
            "filename": "packages/language-service/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/9d4af65e343e41b48cb9afd12c2b61d8ca61a9ac/packages%2Flanguage-service%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9d4af65e343e41b48cb9afd12c2b61d8ca61a9ac/packages%2Flanguage-service%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2FBUILD.bazel?ref=9d4af65e343e41b48cb9afd12c2b61d8ca61a9ac",
            "patch": "@@ -7,6 +7,7 @@ ts_library(\n     srcs = [\n         \"api.ts\",\n         \"index.ts\",\n+        \"override_rename_ts_plugin.ts\",\n     ],\n     prodmode_module = \"commonjs\",\n     deps = ["
        },
        {
            "sha": "56a98c7bd205141272d484b07073bee19256bd52",
            "filename": "packages/language-service/README.md",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/9d4af65e343e41b48cb9afd12c2b61d8ca61a9ac/packages%2Flanguage-service%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/9d4af65e343e41b48cb9afd12c2b61d8ca61a9ac/packages%2Flanguage-service%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2FREADME.md?ref=9d4af65e343e41b48cb9afd12c2b61d8ca61a9ac",
            "patch": "@@ -0,0 +1,13 @@\n+## Override Rename Ts Plugin\n+\n+When the user wants to rename a symbol in the ts file VSCode will ask the rename providers for the answer in turn. If the first extension returns the result, the VSCode will break the loop and apply the result. If the first extension cannot rename the symbol, VSCode will ask the second extension in the list (built-in TS/JS extension, Angular LS extension, etc.). In other words, VSCode takes the result from only one rename provider and the order depends on registration timing, scoring.\n+\n+Because the built-in ts extension and Angular extension have the same high score, if the built-in ts extension is the first(depends on the time the extension was registered), the result will be provided by the built-in extension. We want Angular to provide it, so this plugin will delegate rename requests and reject the request for the built-in ts server.\n+\n+The Angular LS only provides the rename info when working within an Angular project. If we cannot locate Angular sources in the project files, the built-in extension should provide the rename info.\n+\n+This plugin will apply to the built-in TS/JS extension and delegate rename requests to the Angular LS. It provides the rename info only when it is an Angular project. Otherwise, it will return info by the default built-in ts server rename provider.\n+\n+See [here][1] for more info.\n+\n+[1]: https://github.com/microsoft/vscode/issues/115354\n\\ No newline at end of file"
        },
        {
            "sha": "834394c3594a818792614b48ff9271031b5a7435",
            "filename": "packages/language-service/override_rename_ts_plugin.ts",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/9d4af65e343e41b48cb9afd12c2b61d8ca61a9ac/packages%2Flanguage-service%2Foverride_rename_ts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d4af65e343e41b48cb9afd12c2b61d8ca61a9ac/packages%2Flanguage-service%2Foverride_rename_ts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Foverride_rename_ts_plugin.ts?ref=9d4af65e343e41b48cb9afd12c2b61d8ca61a9ac",
            "patch": "@@ -0,0 +1,58 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript/lib/tsserverlibrary';\n+\n+function isAngularCore(path: string): boolean {\n+  return isExternalAngularCore(path) || isInternalAngularCore(path);\n+}\n+\n+function isExternalAngularCore(path: string): boolean {\n+  return path.endsWith('@angular/core/core.d.ts');\n+}\n+\n+function isInternalAngularCore(path: string): boolean {\n+  return path.endsWith('angular2/rc/packages/core/index.d.ts');\n+}\n+\n+/**\n+ * This factory is used to disable the built-in rename provider,\n+ * see `packages/language-service/README.md#override-rename-ts-plugin` for more info.\n+ */\n+const factory: ts.server.PluginModuleFactory = (): ts.server.PluginModule => {\n+  return {\n+    create(info: ts.server.PluginCreateInfo): ts.LanguageService {\n+      const {project, languageService} = info;\n+      /** A map that indicates whether Angular could be found in the file's project. */\n+      const fileToIsInAngularProjectMap = new Map<string, boolean>();\n+\n+      return {\n+        ...languageService,\n+        getRenameInfo: (fileName, position) => {\n+          let isInAngular: boolean;\n+          if (fileToIsInAngularProjectMap.has(fileName)) {\n+            isInAngular = fileToIsInAngularProjectMap.get(fileName)!;\n+          } else {\n+            isInAngular = project.getFileNames().some(isAngularCore);\n+            fileToIsInAngularProjectMap.set(fileName, isInAngular);\n+          }\n+          if (isInAngular) {\n+            return {\n+              canRename: false,\n+              localizedErrorMessage: 'Delegating rename to the Angular Language Service.',\n+            };\n+          } else {\n+            return languageService.getRenameInfo(fileName, position);\n+          }\n+        },\n+      };\n+    }\n+  };\n+};\n+\n+export {factory};"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 72,
        "deletions": 0
    }
}