{
    "author": "atscott",
    "message": "refactor(compiler-cli): Always wrap RHS of TCB writes in parens (#39768)\n\nThere were two issues with the current TCB:\n\n1. The logic for only wrapping the right hand side of the property write\nif it was not already a parenthesized expression was incorrect. A\nparenthesized expression could still have a trailing comment, and if\nthat were the case, that span comment would still be ambiguous, as explained\nby the comment in the code before `wrapForTypeChecker`.\n2. The right hand side of keyed writes was not wrapped in parens at all\n\nPR Close #39768",
    "sha": "c69e67c9cb1ec2bc16ceaf6fa9e0778f0b2bc4d7",
    "files": [
        {
            "sha": "1ecb5061b8f07451e2e8dab6cb2b00a3a7291b70",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/expression.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/c69e67c9cb1ec2bc16ceaf6fa9e0778f0b2bc4d7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "raw_url": "https://github.com/angular/angular/raw/c69e67c9cb1ec2bc16ceaf6fa9e0778f0b2bc4d7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts?ref=c69e67c9cb1ec2bc16ceaf6fa9e0778f0b2bc4d7",
            "patch": "@@ -8,6 +8,7 @@\n \n import {AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Chain, Conditional, EmptyExpr, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, MethodCall, NonNullAssert, PrefixNot, PropertyRead, PropertyWrite, Quote, SafeMethodCall, SafePropertyRead, ThisReceiver, Unary} from '@angular/compiler';\n import * as ts from 'typescript';\n+\n import {TypeCheckingConfig} from '../api';\n \n import {addParseSpanInfo, wrapForDiagnostics, wrapForTypeChecker} from './diagnostics';\n@@ -164,7 +165,7 @@ class AstTranslator implements AstVisitor {\n     const left = ts.createElementAccess(receiver, this.translate(ast.key));\n     // TODO(joost): annotate `left` with the span of the element access, which is not currently\n     //  available on `ast`.\n-    const right = this.translate(ast.value);\n+    const right = wrapForTypeChecker(this.translate(ast.value));\n     const node = wrapForDiagnostics(ts.createBinary(left, ts.SyntaxKind.EqualsToken, right));\n     addParseSpanInfo(node, ast.sourceSpan);\n     return node;\n@@ -255,14 +256,11 @@ class AstTranslator implements AstVisitor {\n     //     ^     nameSpan\n     const leftWithPath = wrapForDiagnostics(left);\n     addParseSpanInfo(leftWithPath, ast.sourceSpan);\n-    let right = this.translate(ast.value);\n     // The right needs to be wrapped in parens as well or we cannot accurately match its\n     // span to just the RHS. For example, the span in `e = $event /*0,10*/` is ambiguous.\n     // It could refer to either the whole binary expression or just the RHS.\n     // We should instead generate `e = ($event /*0,10*/)` so we know the span 0,10 matches RHS.\n-    if (!ts.isParenthesizedExpression(right)) {\n-      right = wrapForTypeChecker(right);\n-    }\n+    const right = wrapForTypeChecker(this.translate(ast.value));\n     const node =\n         wrapForDiagnostics(ts.createBinary(leftWithPath, ts.SyntaxKind.EqualsToken, right));\n     addParseSpanInfo(node, ast.sourceSpan);"
        },
        {
            "sha": "c485201f294d36b979912220740d273256af520f",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/span_comments_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c69e67c9cb1ec2bc16ceaf6fa9e0778f0b2bc4d7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c69e67c9cb1ec2bc16ceaf6fa9e0778f0b2bc4d7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts?ref=c69e67c9cb1ec2bc16ceaf6fa9e0778f0b2bc4d7",
            "patch": "@@ -91,7 +91,7 @@ describe('type check blocks diagnostics', () => {\n       const TEMPLATE = `<div (click)='a.b.c = d'></div>`;\n       expect(tcbWithSpans(TEMPLATE))\n           .toContain(\n-              '(((((((ctx).a /*14,15*/) /*14,15*/).b /*16,17*/) /*14,17*/).c /*18,19*/) /*14,23*/ = ((ctx).d /*22,23*/) /*22,23*/) /*14,23*/');\n+              '(((((((ctx).a /*14,15*/) /*14,15*/).b /*16,17*/) /*14,17*/).c /*18,19*/) /*14,23*/ = (((ctx).d /*22,23*/) /*22,23*/)) /*14,23*/');\n     });\n \n     it('should $event property writes', () => {\n@@ -110,7 +110,7 @@ describe('type check blocks diagnostics', () => {\n       const TEMPLATE = `<div (click)=\"a[b] = c\"></div>`;\n       expect(tcbWithSpans(TEMPLATE))\n           .toContain(\n-              '((((ctx).a /*14,15*/) /*14,15*/)[((ctx).b /*16,17*/) /*16,17*/] = ((ctx).c /*21,22*/) /*21,22*/) /*14,22*/');\n+              '((((ctx).a /*14,15*/) /*14,15*/)[((ctx).b /*16,17*/) /*16,17*/] = (((ctx).c /*21,22*/) /*21,22*/)) /*14,22*/');\n     });\n \n     it('should annotate safe property access', () => {"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 5,
        "deletions": 7
    }
}