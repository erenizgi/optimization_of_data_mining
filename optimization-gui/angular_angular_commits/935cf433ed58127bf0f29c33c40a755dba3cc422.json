{
    "author": "gkalpak",
    "message": "fix(docs-infra): support recovering from unrecoverable SW states (#39651)\n\nOccasionally, the SW would end up in a broken state where some of the\neagerly cached resources of an older version were available in the local\ncache, but others (such as lazy-loaded bundles) were not. This would\nleave the app in a broken state and a blank screen would be displayed.\nSee #28114 for a more detailed discussion.\n\nThis commit takes advantage of the newly introduced (in v11)\n[SwUpdate#unrecoverable][1] API to detect these bad states and recover\nby doing a full page reload whenever an [UnrecoverableStateEvent][2] is\nemitted.\n\nPartially addresses #28114.\n\nNOTE:\nCurrently, `SwUpdate.unrecoverable` only works if the app has already\nbootstrapped; i.e. if only lazy-loaded bundles have been purged from the\ncache.\nThat should be fine in practice, since the cache entries are removed in\nleast-recently-used order. Thus the eagerly loaded bundles will be the\nlast to be removed from the cache (which rarely happens in practice).\n\n[1]: https://v11.angular.io/api/service-worker/SwUpdate#unrecoverable\n[2]: https://v11.angular.io/api/service-worker/UnrecoverableStateEvent\n\nPR Close #39651",
    "sha": "935cf433ed58127bf0f29c33c40a755dba3cc422",
    "files": [
        {
            "sha": "95c4dd16a105d70fd8c15ce0959127a646be8cfa",
            "filename": "aio/src/app/shared/location.service.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/935cf433ed58127bf0f29c33c40a755dba3cc422/aio%2Fsrc%2Fapp%2Fshared%2Flocation.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/935cf433ed58127bf0f29c33c40a755dba3cc422/aio%2Fsrc%2Fapp%2Fshared%2Flocation.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Flocation.service.ts?ref=935cf433ed58127bf0f29c33c40a755dba3cc422",
            "patch": "@@ -70,6 +70,10 @@ export class LocationService {\n     window.location.replace(url);\n   }\n \n+  reloadPage(): void {\n+    window.location.reload();\n+  }\n+\n   private stripSlashes(url: string) {\n     return url.replace(/^\\/+/, '').replace(/\\/+(\\?|#|$)/, '$1');\n   }"
        },
        {
            "sha": "0cb18910771413af810e857cd11d8bd922bc6c69",
            "filename": "aio/src/app/sw-updates/sw-updates.service.spec.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/935cf433ed58127bf0f29c33c40a755dba3cc422/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/935cf433ed58127bf0f29c33c40a755dba3cc422/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.spec.ts?ref=935cf433ed58127bf0f29c33c40a755dba3cc422",
            "patch": "@@ -119,6 +119,16 @@ describe('SwUpdatesService', () => {\n     expect(location.fullPageNavigationNeeded).toHaveBeenCalledTimes(2);\n   }));\n \n+  it('should request a page reload when an unrecoverable state has been detected', run(() => {\n+    expect(location.reloadPage).toHaveBeenCalledTimes(0);\n+\n+    swu.$$unrecoverableSubj.next({reason: 'Something bad happened'});\n+    expect(location.reloadPage).toHaveBeenCalledTimes(1);\n+\n+    swu.$$unrecoverableSubj.next({reason: 'Something worse happened'});\n+    expect(location.reloadPage).toHaveBeenCalledTimes(2);\n+  }));\n+\n   describe('when `SwUpdate` is not enabled', () => {\n     const runDeactivated = (specFn: VoidFunction) => run(specFn, false);\n \n@@ -150,6 +160,13 @@ describe('SwUpdatesService', () => {\n \n       expect(location.fullPageNavigationNeeded).not.toHaveBeenCalled();\n     }));\n+\n+    it('should never request a page reload', runDeactivated(() => {\n+      swu.$$unrecoverableSubj.next({reason: 'Something bad happened'});\n+      swu.$$unrecoverableSubj.next({reason: 'Something worse happened'});\n+\n+      expect(location.reloadPage).not.toHaveBeenCalled();\n+    }));\n   });\n \n   describe('when destroyed', () => {\n@@ -201,6 +218,17 @@ describe('SwUpdatesService', () => {\n       swu.$$activatedSubj.next({current: {hash: 'qux'}});\n       expect(location.fullPageNavigationNeeded).not.toHaveBeenCalled();\n     }));\n+\n+    it('should stop requesting page reloads when unrecoverable states are detected', run(() => {\n+      swu.$$unrecoverableSubj.next({reason: 'Something bad happened'});\n+      expect(location.reloadPage).toHaveBeenCalledTimes(1);\n+\n+      service.ngOnDestroy();\n+      location.reloadPage.calls.reset();\n+\n+      swu.$$unrecoverableSubj.next({reason: 'Something worse happened'});\n+      expect(location.reloadPage).not.toHaveBeenCalled();\n+    }));\n   });\n });\n \n@@ -212,9 +240,11 @@ class MockApplicationRef {\n class MockSwUpdate {\n   $$availableSubj = new Subject<{available: {hash: string}}>();\n   $$activatedSubj = new Subject<{current: {hash: string}}>();\n+  $$unrecoverableSubj = new Subject<{reason: string}>();\n \n   available = this.$$availableSubj.asObservable();\n   activated = this.$$activatedSubj.asObservable();\n+  unrecoverable = this.$$unrecoverableSubj.asObservable();\n \n   activateUpdate = jasmine.createSpy('MockSwUpdate.activateUpdate')\n                           .and.callFake(() => Promise.resolve());"
        },
        {
            "sha": "1f47e13e437ab95f5cf7670a628c6a0e8a914bd2",
            "filename": "aio/src/app/sw-updates/sw-updates.service.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/935cf433ed58127bf0f29c33c40a755dba3cc422/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/935cf433ed58127bf0f29c33c40a755dba3cc422/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.ts?ref=935cf433ed58127bf0f29c33c40a755dba3cc422",
            "patch": "@@ -51,6 +51,14 @@ export class SwUpdatesService implements OnDestroy {\n             takeUntil(this.onDestroy),\n         )\n         .subscribe(() => location.fullPageNavigationNeeded());\n+\n+    // Request an immediate page reload once an unrecoverable state has been detected.\n+    this.swu.unrecoverable\n+        .pipe(\n+            tap(evt => this.log(`Unrecoverable state: ${evt.reason}\\nReloading...`)),\n+            takeUntil(this.onDestroy),\n+        )\n+        .subscribe(() => location.reloadPage());\n   }\n \n   ngOnDestroy() {"
        },
        {
            "sha": "29915808013813694cdb02cd2dd94327545e8cf5",
            "filename": "aio/src/testing/location.service.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/935cf433ed58127bf0f29c33c40a755dba3cc422/aio%2Fsrc%2Ftesting%2Flocation.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/935cf433ed58127bf0f29c33c40a755dba3cc422/aio%2Fsrc%2Ftesting%2Flocation.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Ftesting%2Flocation.service.ts?ref=935cf433ed58127bf0f29c33c40a755dba3cc422",
            "patch": "@@ -13,6 +13,7 @@ export class MockLocationService {\n               .callFake((url: string) => this.urlSubject.next(url));\n   goExternal = jasmine.createSpy('Location.goExternal');\n   replace = jasmine.createSpy('Location.replace');\n+  reloadPage = jasmine.createSpy('Location.reloadPage');\n   handleAnchorClick = jasmine.createSpy('Location.handleAnchorClick')\n       .and.returnValue(false); // prevent click from causing a browser navigation\n "
        },
        {
            "sha": "c9869baede8b53cd308edf6fc4b601e8902ef052",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/935cf433ed58127bf0f29c33c40a755dba3cc422/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/935cf433ed58127bf0f29c33c40a755dba3cc422/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=935cf433ed58127bf0f29c33c40a755dba3cc422",
            "patch": "@@ -3,7 +3,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3033,\n-        \"main-es2015\": 447565,\n+        \"main-es2015\": 447766,\n         \"polyfills-es2015\": 52343\n       }\n     }\n@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3033,\n-        \"main-es2015\": 447774,\n+        \"main-es2015\": 447975,\n         \"polyfills-es2015\": 52493\n       }\n     }"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 45,
        "deletions": 2
    }
}