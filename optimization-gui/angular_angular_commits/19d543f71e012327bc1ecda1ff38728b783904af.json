{
    "author": "JiaLiPassion",
    "message": "fix(zone.js): disable wrap uncaught promise rejection should handle primitive value (#38476)\n\nClose #38334.\n\nzone.js provides a flag DISABLE_WRAPPING_UNCAUGHT_PROMISE_REJECTION to let zone.js\nthrow the original error instead of wrap it when uncaught promise rejection found.\nBut the rejection value could be anything includes primitive value such as number.\nIn that case, we should not attach any additional properties to the value.\n\nPR Close #38476",
    "sha": "19d543f71e012327bc1ecda1ff38728b783904af",
    "files": [
        {
            "sha": "9103709ac2df96f77527c9a71c74c193a7197dea",
            "filename": "packages/zone.js/lib/common/promise.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 14,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/19d543f71e012327bc1ecda1ff38728b783904af/packages%2Fzone.js%2Flib%2Fcommon%2Fpromise.ts",
            "raw_url": "https://github.com/angular/angular/raw/19d543f71e012327bc1ecda1ff38728b783904af/packages%2Fzone.js%2Flib%2Fcommon%2Fpromise.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fcommon%2Fpromise.ts?ref=19d543f71e012327bc1ecda1ff38728b783904af",
            "patch": "@@ -1,12 +1,12 @@\n-import {patchMethod} from './utils';\n-\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n  *\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {patchMethod} from './utils';\n+\n Zone.__load_patch('ZoneAwarePromise', (global: any, Zone: ZoneType, api: _ZonePrivate) => {\n   const ObjectGetOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;\n   const ObjectDefineProperty = Object.defineProperty;\n@@ -48,6 +48,9 @@ Zone.__load_patch('ZoneAwarePromise', (global: any, Zone: ZoneType, api: _ZonePr\n       const uncaughtPromiseError: UncaughtPromiseError = _uncaughtPromiseErrors.shift()!;\n       try {\n         uncaughtPromiseError.zone.runGuarded(() => {\n+          if (uncaughtPromiseError.throwOriginal) {\n+            throw uncaughtPromiseError.rejection;\n+          }\n           throw uncaughtPromiseError;\n         });\n       } catch (error) {\n@@ -191,20 +194,20 @@ Zone.__load_patch('ZoneAwarePromise', (global: any, Zone: ZoneType, api: _ZonePr\n         if (queue.length == 0 && state == REJECTED) {\n           (promise as any)[symbolState] = REJECTED_NO_CATCH;\n           let uncaughtPromiseError = value;\n-          if (!isDisableWrappingUncaughtPromiseRejection) {\n+          try {\n+            // Here we throws a new Error to print more readable error log\n+            // and if the value is not an error, zone.js builds an `Error`\n+            // Object here to attach the stack information.\n+            throw new Error(\n+                'Uncaught (in promise): ' + readableObjectToString(value) +\n+                (value && value.stack ? '\\n' + value.stack : ''));\n+          } catch (err) {\n+            uncaughtPromiseError = err;\n+          }\n+          if (isDisableWrappingUncaughtPromiseRejection) {\n             // If disable wrapping uncaught promise reject\n-            // and the rejected value is an Error object,\n             // use the value instead of wrapping it.\n-            try {\n-              // Here we throws a new Error to print more readable error log\n-              // and if the value is not an error, zone.js builds an `Error`\n-              // Object here to attach the stack information.\n-              throw new Error(\n-                  'Uncaught (in promise): ' + readableObjectToString(value) +\n-                  (value && value.stack ? '\\n' + value.stack : ''));\n-            } catch (err) {\n-              uncaughtPromiseError = err;\n-            }\n+            uncaughtPromiseError.throwOriginal = true;\n           }\n           uncaughtPromiseError.rejection = value;\n           uncaughtPromiseError.promise = promise;"
        },
        {
            "sha": "86b0949bf3a84c8f68bbde0c563661c3f5b594bb",
            "filename": "packages/zone.js/lib/zone.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/19d543f71e012327bc1ecda1ff38728b783904af/packages%2Fzone.js%2Flib%2Fzone.ts",
            "raw_url": "https://github.com/angular/angular/raw/19d543f71e012327bc1ecda1ff38728b783904af/packages%2Fzone.js%2Flib%2Fzone.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fzone.ts?ref=19d543f71e012327bc1ecda1ff38728b783904af",
            "patch": "@@ -383,6 +383,7 @@ interface UncaughtPromiseError extends Error {\n   task: Task;\n   promise: Promise<any>;\n   rejection: any;\n+  throwOriginal?: boolean;\n }\n \n /**"
        },
        {
            "sha": "c6f88f265e7519a08719681d4404aada69f320d5",
            "filename": "packages/zone.js/test/common/promise-disable-wrap-uncaught-promise-rejection.spec.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 3,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/19d543f71e012327bc1ecda1ff38728b783904af/packages%2Fzone.js%2Ftest%2Fcommon%2Fpromise-disable-wrap-uncaught-promise-rejection.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/19d543f71e012327bc1ecda1ff38728b783904af/packages%2Fzone.js%2Ftest%2Fcommon%2Fpromise-disable-wrap-uncaught-promise-rejection.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fcommon%2Fpromise-disable-wrap-uncaught-promise-rejection.spec.ts?ref=19d543f71e012327bc1ecda1ff38728b783904af",
            "patch": "@@ -42,9 +42,9 @@ describe('disable wrap uncaught promise rejection', () => {\n     setTimeout((): any => null);\n     setTimeout(() => {\n       expect(promiseError).toBe(error);\n-      expect((promiseError as any)['rejection']).toBe(error);\n-      expect((promiseError as any)['zone']).toBe(zone);\n-      expect((promiseError as any)['task']).toBe(task);\n+      expect((promiseError as any)['rejection']).toBe(undefined);\n+      expect((promiseError as any)['zone']).toBe(undefined);\n+      expect((promiseError as any)['task']).toBe(undefined);\n       done();\n     });\n   });\n@@ -76,4 +76,27 @@ describe('disable wrap uncaught promise rejection', () => {\n       done();\n     });\n   });\n+\n+  it('should print original information when a primitive value is used for rejection', (done) => {\n+    let promiseError: number|null = null;\n+    Zone.current\n+        .fork({\n+          name: 'promise-error',\n+          onHandleError: (delegate: ZoneDelegate, current: Zone, target: Zone, error: any):\n+              boolean => {\n+                promiseError = error;\n+                delegate.handleError(target, error);\n+                return false;\n+              }\n+        })\n+        .run(() => {\n+          Promise.reject(42);\n+          expect(promiseError).toBe(null);\n+        });\n+    setTimeout((): any => null);\n+    setTimeout(() => {\n+      expect(promiseError).toBe(42);\n+      done();\n+    });\n+  });\n });"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 44,
        "deletions": 17
    }
}