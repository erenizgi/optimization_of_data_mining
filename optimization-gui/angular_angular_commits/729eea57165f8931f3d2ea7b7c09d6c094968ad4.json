{
    "author": "JoostK",
    "message": "fix(compiler-cli): transform type references in generic type parameter default (#42492)\n\nWhen a component/directive has a generic type parameter, the template\ntype checker attempts to translate the type parameter such that the\ntype parameters can be replicated in the type constructor that is\nemitted into the typecheck file.\n\nType parameters with a default clause would incorrectly be emitted into\nthe typecheck file using the original `ts.TypeNode` for the default\nclause, such that `ts.TypeReferenceNode`s within the default clause\nwould likely be invalid (i.e. referencing a type for which no import is\npresent in the typecheck file). This did not result in user-facing\ntype-check errors as errors reported in type constructors are not\ntranslated into template positions Regardless, this commit ensures that\n`ts.TypeReferenceNode`s within defaults are properly translated into the\ntypecheck file.\n\nPR Close #42492",
    "sha": "729eea57165f8931f3d2ea7b7c09d6c094968ad4",
    "files": [
        {
            "sha": "018b36a3f887a3b79b3330ea00f95c6f4c2cd0d5",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_parameter_emitter.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/729eea57165f8931f3d2ea7b7c09d6c094968ad4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_parameter_emitter.ts",
            "raw_url": "https://github.com/angular/angular/raw/729eea57165f8931f3d2ea7b7c09d6c094968ad4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_parameter_emitter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_parameter_emitter.ts?ref=729eea57165f8931f3d2ea7b7c09d6c094968ad4",
            "patch": "@@ -32,14 +32,18 @@ export class TypeParameterEmitter {\n     }\n \n     return this.typeParameters.every(typeParam => {\n-      if (typeParam.constraint === undefined) {\n-        return true;\n-      }\n-\n-      return canEmitType(typeParam.constraint, type => this.resolveTypeReference(type));\n+      return this.canEmitType(typeParam.constraint) && this.canEmitType(typeParam.default);\n     });\n   }\n \n+  private canEmitType(type: ts.TypeNode|undefined): boolean {\n+    if (type === undefined) {\n+      return true;\n+    }\n+\n+    return canEmitType(type, typeReference => this.resolveTypeReference(typeReference));\n+  }\n+\n   /**\n    * Emits the type parameters using the provided emitter function for `Reference`s.\n    */\n@@ -53,12 +57,14 @@ export class TypeParameterEmitter {\n     return this.typeParameters.map(typeParam => {\n       const constraint =\n           typeParam.constraint !== undefined ? emitter.emitType(typeParam.constraint) : undefined;\n+      const defaultType =\n+          typeParam.default !== undefined ? emitter.emitType(typeParam.default) : undefined;\n \n       return ts.updateTypeParameterDeclaration(\n           /* node */ typeParam,\n           /* name */ typeParam.name,\n           /* constraint */ constraint,\n-          /* defaultType */ typeParam.default);\n+          /* defaultType */ defaultType);\n     });\n   }\n "
        },
        {
            "sha": "48579640571b565d3c8745d802dfb92d83bc15e5",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_parameter_emitter_spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/729eea57165f8931f3d2ea7b7c09d6c094968ad4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_parameter_emitter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/729eea57165f8931f3d2ea7b7c09d6c094968ad4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_parameter_emitter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_parameter_emitter_spec.ts?ref=729eea57165f8931f3d2ea7b7c09d6c094968ad4",
            "patch": "@@ -222,5 +222,32 @@ runInEachFileSystem(() => {\n       expect(emitter.canEmit()).toBe(true);\n       expect(emit(emitter)).toEqual('<T extends test.MyType>');\n     });\n+\n+    it('transforms generic type parameter defaults', () => {\n+      const additionalFiles: TestFile[] = [{\n+        name: absoluteFrom('/node_modules/types/index.d.ts'),\n+        contents: `export declare type MyType = string;`,\n+      }];\n+      const emitter = createEmitter(\n+          `\n+          import {MyType} from 'types';\n+\n+          export class TestClass<T extends MyType = MyType> {}`,\n+          additionalFiles);\n+\n+      expect(emitter.canEmit()).toBe(true);\n+      expect(emit(emitter)).toEqual('<T extends test.MyType = test.MyType>');\n+    });\n+\n+    it('cannot emit when a type parameter default cannot be emitted', () => {\n+      const emitter = createEmitter(`\n+          interface Local {}\n+\n+          export class TestClass<T extends object = Local> {}`);\n+\n+      expect(emitter.canEmit()).toBe(false);\n+      expect(() => emit(emitter))\n+          .toThrowError('A type reference to emit must be imported from an absolute module');\n+    });\n   });\n });"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 39,
        "deletions": 6
    }
}