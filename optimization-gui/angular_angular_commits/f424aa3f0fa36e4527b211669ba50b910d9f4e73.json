{
    "author": "josephperrott",
    "message": "feat(dev-infra): add support for determining if builds should be stamped (#42319)\n\nAdd support for the build process to determine if the generated builds\nshould be stamped for release.\n\nPR Close #42319",
    "sha": "f424aa3f0fa36e4527b211669ba50b910d9f4e73",
    "files": [
        {
            "sha": "e392a8010d8983fd0916de8ef7dda41512a0eaa4",
            "filename": "dev-infra/build-worker.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Fbuild-worker.js",
            "raw_url": "https://github.com/angular/angular/raw/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Fbuild-worker.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbuild-worker.js?ref=f424aa3f0fa36e4527b211669ba50b910d9f4e73",
            "patch": "@@ -704,15 +704,15 @@ function getReleaseConfig(config = getConfig()) {\n  * found in the LICENSE file at https://angular.io/license\n  */\n // Start the release package building.\n-main();\n+main(process.argv[2] === 'true');\n /** Main function for building the release packages. */\n-function main() {\n+function main(stampForRelease) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n         if (process.send === undefined) {\n             throw Error('This script needs to be invoked as a NodeJS worker.');\n         }\n         const config = getReleaseConfig();\n-        const builtPackages = yield config.buildPackages();\n+        const builtPackages = yield config.buildPackages(stampForRelease);\n         // Transfer the built packages back to the parent process.\n         process.send(builtPackages);\n     });"
        },
        {
            "sha": "97d7a9bcecb57956bbe0fc1a259e612d988838c1",
            "filename": "dev-infra/release/build/build-worker.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Frelease%2Fbuild%2Fbuild-worker.ts",
            "raw_url": "https://github.com/angular/angular/raw/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Frelease%2Fbuild%2Fbuild-worker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2Fbuild-worker.ts?ref=f424aa3f0fa36e4527b211669ba50b910d9f4e73",
            "patch": "@@ -16,16 +16,16 @@\n import {getReleaseConfig} from '../config/index';\n \n // Start the release package building.\n-main();\n+main(process.argv[2] === 'true');\n \n /** Main function for building the release packages. */\n-async function main() {\n+async function main(stampForRelease: boolean) {\n   if (process.send === undefined) {\n     throw Error('This script needs to be invoked as a NodeJS worker.');\n   }\n \n   const config = getReleaseConfig();\n-  const builtPackages = await config.buildPackages();\n+  const builtPackages = await config.buildPackages(stampForRelease);\n \n   // Transfer the built packages back to the parent process.\n   process.send(builtPackages);"
        },
        {
            "sha": "1853a665386b060343d31b26dc12f994ac46c178",
            "filename": "dev-infra/release/build/build.spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Frelease%2Fbuild%2Fbuild.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Frelease%2Fbuild%2Fbuild.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2Fbuild.spec.ts?ref=f424aa3f0fa36e4527b211669ba50b910d9f4e73",
            "patch": "@@ -33,7 +33,7 @@ describe('ng-dev release build', () => {\n   async function invokeBuild({json}: {json?: boolean} = {}) {\n     spyOn(releaseConfig, 'getReleaseConfig')\n         .and.returnValue({npmPackages, buildPackages, releaseNotes: {}});\n-    await ReleaseBuildCommandModule.handler({json: !!json, $0: '', _: []});\n+    await ReleaseBuildCommandModule.handler({json: !!json, stampForRelease: true, $0: '', _: []});\n   }\n \n   it('should invoke configured build packages function', async () => {"
        },
        {
            "sha": "9b281c76bce10afe6d89fd894734a34956d8411d",
            "filename": "dev-infra/release/build/cli.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Frelease%2Fbuild%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Frelease%2Fbuild%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2Fcli.ts?ref=f424aa3f0fa36e4527b211669ba50b910d9f4e73",
            "patch": "@@ -17,21 +17,28 @@ import {buildReleaseOutput} from './index';\n /** Command line options for building a release. */\n export interface ReleaseBuildOptions {\n   json: boolean;\n+  stampForRelease: boolean;\n }\n \n /** Yargs command builder for configuring the `ng-dev release build` command. */\n function builder(argv: Argv): Argv<ReleaseBuildOptions> {\n-  return argv.option('json', {\n-    type: 'boolean',\n-    description: 'Whether the built packages should be printed to stdout as JSON.',\n-    default: false,\n-  });\n+  return argv\n+      .option('json', {\n+        type: 'boolean',\n+        description: 'Whether the built packages should be printed to stdout as JSON.',\n+        default: false,\n+      })\n+      .option('stampForRelease', {\n+        type: 'boolean',\n+        description: 'Whether the built packages should be stamped for release.',\n+        default: false,\n+      });\n }\n \n /** Yargs command handler for building a release. */\n async function handler(args: Arguments<ReleaseBuildOptions>) {\n   const {npmPackages} = getReleaseConfig();\n-  let builtPackages = await buildReleaseOutput();\n+  let builtPackages = await buildReleaseOutput(args.stampForRelease);\n \n   // If package building failed, print an error and exit with an error code.\n   if (builtPackages === null) {"
        },
        {
            "sha": "97bf1c38475e245efb488c6c648894756931671b",
            "filename": "dev-infra/release/build/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Frelease%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Frelease%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2Findex.ts?ref=f424aa3f0fa36e4527b211669ba50b910d9f4e73",
            "patch": "@@ -16,9 +16,10 @@ import {BuiltPackage} from '../config/index';\n  * pollute the stdout in such cases, we launch a child process for building the release packages\n  * and redirect all stdout output to the stderr channel (which can be read in the terminal).\n  */\n-export async function buildReleaseOutput(): Promise<BuiltPackage[]|null> {\n+export async function buildReleaseOutput(stampForRelease: boolean = false):\n+    Promise<BuiltPackage[]|null> {\n   return new Promise(resolve => {\n-    const buildProcess = fork(require.resolve('./build-worker'), [], {\n+    const buildProcess = fork(require.resolve('./build-worker'), [`${stampForRelease}`], {\n       // The stdio option is set to redirect any \"stdout\" output directly to the \"stderr\" file\n       // descriptor. An additional \"ipc\" file descriptor is created to support communication with\n       // the build process. https://nodejs.org/api/child_process.html#child_process_options_stdio."
        },
        {
            "sha": "2f4bd12e46acbe91bc8a0b6a01c7932c13da5a68",
            "filename": "dev-infra/release/config/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Frelease%2Fconfig%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/f424aa3f0fa36e4527b211669ba50b910d9f4e73/dev-infra%2Frelease%2Fconfig%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fconfig%2Findex.ts?ref=f424aa3f0fa36e4527b211669ba50b910d9f4e73",
            "patch": "@@ -23,7 +23,7 @@ export interface ReleaseConfig {\n   /** List of NPM packages that are published as part of this project. */\n   npmPackages: string[];\n   /** Builds release packages and returns a list of paths pointing to the output. */\n-  buildPackages: () => Promise<BuiltPackage[]|null>;\n+  buildPackages: (stampForRelease?: boolean) => Promise<BuiltPackage[]|null>;\n   /** The list of github labels to add to the release PRs. */\n   releasePrLabels?: string[];\n   /** Configuration for creating release notes during publishing. */"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 24,
        "deletions": 16
    }
}