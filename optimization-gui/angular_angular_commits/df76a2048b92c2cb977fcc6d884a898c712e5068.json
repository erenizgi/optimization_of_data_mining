{
    "author": "alecvolo",
    "message": "fix(router): restore 'history.state' object for navigations coming from Angular router (#28108) (#28176)\n\nWhen navigations coming from Angular router we may have a payload stored in state property. When this\n exists, set extras's state to the payload.\n\nPR Close #28176",
    "sha": "df76a2048b92c2cb977fcc6d884a898c712e5068",
    "files": [
        {
            "sha": "a4e1dae9fa3ad6112494bc2d9dadb50cccda30bb",
            "filename": "packages/router/src/router.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/df76a2048b92c2cb977fcc6d884a898c712e5068/packages%2Frouter%2Fsrc%2Frouter.ts",
            "raw_url": "https://github.com/angular/angular/raw/df76a2048b92c2cb977fcc6d884a898c712e5068/packages%2Frouter%2Fsrc%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter.ts?ref=df76a2048b92c2cb977fcc6d884a898c712e5068",
            "patch": "@@ -920,7 +920,15 @@ export class Router {\n           // hybrid apps.\n           setTimeout(() => {\n             const {source, state, urlTree} = currentChange;\n-            this.scheduleNavigation(urlTree, source, state, {replaceUrl: true});\n+            const extras: NavigationExtras = {replaceUrl: true};\n+            if (state) {\n+              const stateCopy = {...state};\n+              delete stateCopy.navigationId;\n+              if (Object.keys(stateCopy).length !== 0) {\n+                extras.state = stateCopy;\n+              }\n+            }\n+            this.scheduleNavigation(urlTree, source, state, extras);\n           }, 0);\n         }\n         this.lastLocationChangeInfo = currentChange;"
        },
        {
            "sha": "47d4edbbce183b33dc6eef09b8c79fccceb08f2a",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/df76a2048b92c2cb977fcc6d884a898c712e5068/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/df76a2048b92c2cb977fcc6d884a898c712e5068/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=df76a2048b92c2cb977fcc6d884a898c712e5068",
            "patch": "@@ -159,6 +159,59 @@ describe('Integration', () => {\n          expect(navigation.extras.state).toEqual({foo: 'bar'});\n        })));\n \n+    it('should set history.state when navigation with browser back and forward',\n+       fakeAsync(inject([Router, Location], (router: Router, location: SpyLocation) => {\n+         router.resetConfig([\n+           {path: '', component: SimpleCmp},\n+           {path: 'simple', component: SimpleCmp},\n+         ]);\n+\n+         const fixture = createRoot(router, RootCmp);\n+         let navigation: Navigation = null!;\n+         router.events.subscribe(e => {\n+           if (e instanceof NavigationStart) {\n+             navigation = <Navigation>router.getCurrentNavigation()!;\n+           }\n+         });\n+\n+         const state = {foo: 'bar'};\n+         router.navigateByUrl('/simple', {state});\n+         tick();\n+         location.back();\n+         tick();\n+         location.forward();\n+         tick();\n+\n+         expect(navigation.extras.state).toBeDefined();\n+         expect(navigation.extras.state).toEqual(state);\n+       })));\n+\n+    it('should not error if state is not {[key: string]: any}',\n+       fakeAsync(inject([Router, Location], (router: Router, location: SpyLocation) => {\n+         router.resetConfig([\n+           {path: '', component: SimpleCmp},\n+           {path: 'simple', component: SimpleCmp},\n+         ]);\n+\n+         const fixture = createRoot(router, RootCmp);\n+         let navigation: Navigation = null!;\n+         router.events.subscribe(e => {\n+           if (e instanceof NavigationStart) {\n+             navigation = <Navigation>router.getCurrentNavigation()!;\n+           }\n+         });\n+\n+         location.replaceState('', '', 42);\n+         router.navigateByUrl('/simple');\n+         tick();\n+         location.back();\n+         advance(fixture);\n+\n+         // Angular does not support restoring state to the primitive.\n+         expect(navigation.extras.state).toEqual(undefined);\n+         expect(location.getState()).toEqual({navigationId: 3});\n+       })));\n+\n     it('should not pollute browser history when replaceUrl is set to true',\n        fakeAsync(inject([Router, Location], (router: Router, location: SpyLocation) => {\n          router.resetConfig(["
        }
    ],
    "stats": {
        "total": 63,
        "additions": 62,
        "deletions": 1
    }
}