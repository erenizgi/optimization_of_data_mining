{
    "author": "alxhub",
    "message": "refactor(compiler-cli): identify structural directives (#40032)\n\nThis commit introduces an `isStructural` flag on directive metadata, which\nis `true` if the directive injects `TemplateRef` (and thus is at least\ntheoretically usable as a structural directive). The flag is not used for\nanything currently, but will be utilized by the Language Service to offer\nbetter autocompletion results for structural directives.\n\nPR Close #40032",
    "sha": "c55bf4a4a3127936b6714d9397416086f06df79a",
    "files": [
        {
            "sha": "7ec79625eb002d4cf9ccac80d888162a8b2fec20",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -396,6 +396,7 @@ export class ComponentDecoratorHandler implements\n       baseClass: analysis.baseClass,\n       ...analysis.typeCheckMeta,\n       isPoisoned: analysis.isPoisoned,\n+      isStructural: false,\n     });\n \n     this.resourceRegistry.registerResources(analysis.resources, node);"
        },
        {
            "sha": "c0214ad069f418490cdb4f01f54441d2fd99351a",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/directive.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {compileDeclareDirectiveFromMetadata, compileDirectiveFromMetadata, ConstantPool, Expression, Identifiers, makeBindingParser, ParsedHostBindings, ParseError, parseHostBindings, R3DependencyMetadata, R3DirectiveDef, R3DirectiveMetadata, R3FactoryTarget, R3QueryMetadata, Statement, verifyHostBindings, WrappedNodeExpr} from '@angular/compiler';\n+import {compileDeclareDirectiveFromMetadata, compileDirectiveFromMetadata, ConstantPool, Expression, ExternalExpr, Identifiers, makeBindingParser, ParsedHostBindings, ParseError, parseHostBindings, R3DependencyMetadata, R3DirectiveDef, R3DirectiveMetadata, R3FactoryTarget, R3QueryMetadata, R3ResolvedDependencyType, Statement, verifyHostBindings, WrappedNodeExpr} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {ErrorCode, FatalDiagnosticError} from '../../diagnostics';\n@@ -42,6 +42,7 @@ export interface DirectiveHandlerData {\n   inputs: ClassPropertyMapping;\n   outputs: ClassPropertyMapping;\n   isPoisoned: boolean;\n+  isStructural: boolean;\n }\n \n export class DirectiveDecoratorHandler implements\n@@ -109,6 +110,7 @@ export class DirectiveDecoratorHandler implements\n         typeCheckMeta: extractDirectiveTypeCheckMeta(node, directiveResult.inputs, this.reflector),\n         providersRequiringFactory,\n         isPoisoned: false,\n+        isStructural: directiveResult.isStructural,\n       }\n     };\n   }\n@@ -129,6 +131,7 @@ export class DirectiveDecoratorHandler implements\n       baseClass: analysis.baseClass,\n       ...analysis.typeCheckMeta,\n       isPoisoned: analysis.isPoisoned,\n+      isStructural: analysis.isStructural,\n     });\n \n     this.injectableRegistry.registerInjectable(node);\n@@ -226,6 +229,7 @@ export function extractDirectiveMetadata(\n   metadata: R3DirectiveMetadata,\n   inputs: ClassPropertyMapping,\n   outputs: ClassPropertyMapping,\n+  isStructural: boolean;\n }|undefined {\n   let directive: Map<string, ts.Expression>;\n   if (decorator === null || decorator.args === null || decorator.args.length === 0) {\n@@ -352,6 +356,17 @@ export function extractDirectiveMetadata(\n     ctorDeps = unwrapConstructorDependencies(rawCtorDeps);\n   }\n \n+  const isStructural = ctorDeps !== null && ctorDeps !== 'invalid' && ctorDeps.some(dep => {\n+    if (dep.resolved !== R3ResolvedDependencyType.Token || !(dep.token instanceof ExternalExpr)) {\n+      return false;\n+    }\n+    if (dep.token.value.moduleName !== '@angular/core' || dep.token.value.name !== 'TemplateRef') {\n+      return false;\n+    }\n+\n+    return true;\n+  });\n+\n   // Detect if the component inherits from another class\n   const usesInheritance = reflector.hasBaseClass(clazz);\n   const type = wrapTypeReference(reflector, clazz);\n@@ -386,6 +401,7 @@ export function extractDirectiveMetadata(\n     metadata,\n     inputs,\n     outputs,\n+    isStructural,\n   };\n }\n "
        },
        {
            "sha": "fbe877eea17c062c326755b15519b311476ee142",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/test/directive_spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fdirective_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fdirective_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fdirective_spec.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -105,6 +105,7 @@ runInEachFileSystem(() => {\n         isComponent: false,\n         name: 'Dir',\n         selector: '[dir]',\n+        isStructural: false,\n       };\n       matcher.addSelectables(CssSelector.parse('[dir]'), dirMeta);\n \n@@ -118,6 +119,30 @@ runInEachFileSystem(() => {\n       // and field names.\n       expect(propBindingConsumer).toBe(dirMeta);\n     });\n+\n+    it('should identify a structural directive', () => {\n+      const src = `\n+        import {Directive, TemplateRef} from '@angular/core';\n+\n+        @Directive({selector: 'test-dir'})\n+        export class TestDir {\n+          constructor(private ref: TemplateRef) {}\n+        }\n+      `;\n+      const {program} = makeProgram([\n+        {\n+          name: _('/node_modules/@angular/core/index.d.ts'),\n+          contents: 'export const Directive: any; export declare class TemplateRef {}',\n+        },\n+        {\n+          name: _('/entry.ts'),\n+          contents: src,\n+        },\n+      ]);\n+\n+      const analysis = analyzeDirective(program, 'TestDir');\n+      expect(analysis.isStructural).toBeTrue();\n+    });\n   });\n \n   // Helpers"
        },
        {
            "sha": "0ec5238cb3ebee1f9d5e3c76699a5e452138cabd",
            "filename": "packages/compiler-cli/src/ngtsc/indexer/test/util.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Futil.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -54,6 +54,7 @@ export function getBoundTemplate(\n       inputs: ClassPropertyMapping.fromMappedObject({}),\n       outputs: ClassPropertyMapping.fromMappedObject({}),\n       exportAs: null,\n+      isStructural: false,\n     });\n   });\n   const binder = new R3TargetBinder(matcher);"
        },
        {
            "sha": "0b48090de97bd4ab141ca23ea741fc5968ab08e4",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/api.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fapi.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -114,6 +114,11 @@ export interface DirectiveMeta extends T2DirectiveMeta, DirectiveTypeCheckMeta {\n    * and reliable metadata.\n    */\n   isPoisoned: boolean;\n+\n+  /**\n+   * Whether the directive is likely a structural directive (injects `TemplateRef`).\n+   */\n+  isStructural: boolean;\n }\n \n /**"
        },
        {
            "sha": "d88bf1a2966f42f45b326604e7900cb9df814afc",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/dts.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fdts.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fdts.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fdts.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -9,7 +9,7 @@\n import * as ts from 'typescript';\n \n import {Reference} from '../../imports';\n-import {ClassDeclaration, isNamedClassDeclaration, ReflectionHost} from '../../reflection';\n+import {ClassDeclaration, isNamedClassDeclaration, ReflectionHost, TypeValueReferenceKind} from '../../reflection';\n \n import {DirectiveMeta, MetadataReader, NgModuleMeta, PipeMeta} from './api';\n import {ClassPropertyMapping} from './property_mapping';\n@@ -77,14 +77,27 @@ export class DtsMetadataReader implements MetadataReader {\n       return null;\n     }\n \n+    const isComponent = def.name === 'ɵcmp';\n+\n+    const ctorParams = this.reflector.getConstructorParameters(clazz);\n+\n+    // A directive is considered to be structural if:\n+    // 1) it's a directive, not a component, and\n+    // 2) it injects `TemplateRef`\n+    const isStructural = !isComponent && ctorParams !== null && ctorParams.some(param => {\n+      return param.typeValueReference.kind === TypeValueReferenceKind.IMPORTED &&\n+          param.typeValueReference.moduleName === '@angular/core' &&\n+          param.typeValueReference.importedName === 'TemplateRef';\n+    });\n+\n     const inputs =\n         ClassPropertyMapping.fromMappedObject(readStringMapType(def.type.typeArguments[3]));\n     const outputs =\n         ClassPropertyMapping.fromMappedObject(readStringMapType(def.type.typeArguments[4]));\n     return {\n       ref,\n       name: clazz.name.text,\n-      isComponent: def.name === 'ɵcmp',\n+      isComponent,\n       selector: readStringType(def.type.typeArguments[1]),\n       exportAs: readStringArrayType(def.type.typeArguments[2]),\n       inputs,\n@@ -93,6 +106,7 @@ export class DtsMetadataReader implements MetadataReader {\n       ...extractDirectiveTypeCheckMeta(clazz, inputs, this.reflector),\n       baseClass: readBaseClass(clazz, this.checker, this.reflector),\n       isPoisoned: false,\n+      isStructural,\n     };\n   }\n "
        },
        {
            "sha": "097e1ef4225153b853125256b08bac75ec5bbd19",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/inheritance.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Finheritance.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Finheritance.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Finheritance.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -37,6 +37,7 @@ export function flattenInheritedDirectiveMetadata(\n   let isDynamic = false;\n   let inputs = ClassPropertyMapping.empty();\n   let outputs = ClassPropertyMapping.empty();\n+  let isStructural: boolean = false;\n \n   const addMetadata = (meta: DirectiveMeta): void => {\n     if (meta.baseClass === 'dynamic') {\n@@ -51,6 +52,8 @@ export function flattenInheritedDirectiveMetadata(\n       }\n     }\n \n+    isStructural = isStructural || meta.isStructural;\n+\n     inputs = ClassPropertyMapping.merge(inputs, meta.inputs);\n     outputs = ClassPropertyMapping.merge(outputs, meta.outputs);\n \n@@ -79,5 +82,6 @@ export function flattenInheritedDirectiveMetadata(\n     restrictedInputFields,\n     stringLiteralInputFields,\n     baseClass: isDynamic ? 'dynamic' : null,\n+    isStructural,\n   };\n }"
        },
        {
            "sha": "a1e12f6bd7fb24bac886ab652624f9a42fed2341",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/test/BUILD.bazel",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Ftest%2FBUILD.bazel?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -0,0 +1,35 @@\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"ts_library\")\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+ts_library(\n+    name = \"test_lib\",\n+    testonly = True,\n+    srcs = glob([\n+        \"**/*.ts\",\n+    ]),\n+    deps =\n+        [\n+            \"//packages:types\",\n+            \"//packages/compiler\",\n+            \"//packages/compiler-cli/src/ngtsc/file_system\",\n+            \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+            \"//packages/compiler-cli/src/ngtsc/imports\",\n+            \"//packages/compiler-cli/src/ngtsc/metadata\",\n+            \"//packages/compiler-cli/src/ngtsc/reflection\",\n+            \"//packages/compiler-cli/src/ngtsc/testing\",\n+            \"@npm//typescript\",\n+        ],\n+)\n+\n+jasmine_node_test(\n+    name = \"test\",\n+    bootstrap = [\"//tools/testing:node_no_angular_es5\"],\n+    data = [\n+        \"//packages/compiler-cli/src/ngtsc/testing/fake_core:npm_package\",\n+    ],\n+    deps =\n+        [\n+            \":test_lib\",\n+        ],\n+)"
        },
        {
            "sha": "bb785afa46d4258b993af2309e63ca0aa70bfd7c",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/test/dts_spec.ts",
            "status": "added",
            "additions": 93,
            "deletions": 0,
            "changes": 93,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Ftest%2Fdts_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Ftest%2Fdts_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Ftest%2Fdts_spec.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -0,0 +1,93 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {ExternalExpr} from '@angular/compiler';\n+import * as ts from 'typescript';\n+\n+import {absoluteFrom, getFileSystem, getSourceFileOrError} from '../../file_system';\n+import {runInEachFileSystem} from '../../file_system/testing';\n+import {Reference} from '../../imports';\n+import {isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n+import {loadFakeCore, makeProgram} from '../../testing';\n+\n+import {DtsMetadataReader} from '../src/dts';\n+\n+runInEachFileSystem(() => {\n+  beforeEach(() => {\n+    loadFakeCore(getFileSystem());\n+  });\n+\n+  describe('DtsMetadataReader', () => {\n+    it('should not assume directives are structural', () => {\n+      const mainPath = absoluteFrom('/main.d.ts');\n+      const {program} = makeProgram(\n+          [{\n+            name: mainPath,\n+            contents: `\n+          import {ViewContainerRef} from '@angular/core';\n+          import * as i0 from '@angular/core';\n+\n+          export declare class TestDir {\n+            constructor(p0: ViewContainerRef);\n+            static ɵdir: i0.ɵɵDirectiveDefWithMeta<TestDir, \"[test]\", never, {}, {}, never>\n+          }\n+        `\n+          }],\n+          {\n+            skipLibCheck: true,\n+            lib: ['es6', 'dom'],\n+          });\n+\n+      const sf = getSourceFileOrError(program, mainPath);\n+      const clazz = sf.statements[2];\n+      if (!isNamedClassDeclaration(clazz)) {\n+        return fail('Expected class declaration');\n+      }\n+\n+      const typeChecker = program.getTypeChecker();\n+      const dtsReader =\n+          new DtsMetadataReader(typeChecker, new TypeScriptReflectionHost(typeChecker));\n+\n+      const meta = dtsReader.getDirectiveMetadata(new Reference(clazz))!;\n+      expect(meta.isStructural).toBeFalse();\n+    });\n+\n+    it('should identify a structural directive by its constructor', () => {\n+      const mainPath = absoluteFrom('/main.d.ts');\n+      const {program} = makeProgram(\n+          [{\n+            name: mainPath,\n+            contents: `\n+          import {TemplateRef, ViewContainerRef} from '@angular/core';\n+          import * as i0 from '@angular/core';\n+\n+          export declare class TestDir {\n+            constructor(p0: ViewContainerRef, p1: TemplateRef);\n+            static ɵdir: i0.ɵɵDirectiveDefWithMeta<TestDir, \"[test]\", never, {}, {}, never>\n+          }\n+        `\n+          }],\n+          {\n+            skipLibCheck: true,\n+            lib: ['es6', 'dom'],\n+          });\n+\n+      const sf = getSourceFileOrError(program, mainPath);\n+      const clazz = sf.statements[2];\n+      if (!isNamedClassDeclaration(clazz)) {\n+        return fail('Expected class declaration');\n+      }\n+\n+      const typeChecker = program.getTypeChecker();\n+      const dtsReader =\n+          new DtsMetadataReader(typeChecker, new TypeScriptReflectionHost(typeChecker));\n+\n+      const meta = dtsReader.getDirectiveMetadata(new Reference(clazz))!;\n+      expect(meta.isStructural).toBeTrue();\n+    });\n+  });\n+});"
        },
        {
            "sha": "451d0c9ae3fd8b06d7deb24b1f120bc8269c5186",
            "filename": "packages/compiler-cli/src/ngtsc/reflection/src/typescript.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftypescript.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftypescript.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftypescript.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -36,12 +36,14 @@ export class TypeScriptReflectionHost implements ReflectionHost {\n   getConstructorParameters(clazz: ClassDeclaration): CtorParameter[]|null {\n     const tsClazz = castDeclarationToClassOrDie(clazz);\n \n-    // First, find the constructor with a `body`. The constructors without a `body` are overloads\n-    // whereas we want the implementation since it's the one that'll be executed and which can\n-    // have decorators.\n+    const isDeclaration = tsClazz.getSourceFile().isDeclarationFile;\n+    // For non-declaration files, we want to find the constructor with a `body`. The constructors\n+    // without a `body` are overloads whereas we want the implementation since it's the one that'll\n+    // be executed and which can have decorators. For declaration files, we take the first one that\n+    // we get.\n     const ctor = tsClazz.members.find(\n         (member): member is ts.ConstructorDeclaration =>\n-            ts.isConstructorDeclaration(member) && member.body !== undefined);\n+            ts.isConstructorDeclaration(member) && (isDeclaration || member.body !== undefined));\n     if (ctor === undefined) {\n       return null;\n     }"
        },
        {
            "sha": "38a8ad79dda3fa1528b09aa004df38861a69ca1d",
            "filename": "packages/compiler-cli/src/ngtsc/scope/test/local_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Ftest%2Flocal_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Ftest%2Flocal_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Ftest%2Flocal_spec.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -249,6 +249,7 @@ function fakeDirective(ref: Reference<ClassDeclaration>): DirectiveMeta {\n     isGeneric: false,\n     baseClass: null,\n     isPoisoned: false,\n+    isStructural: false,\n   };\n }\n "
        },
        {
            "sha": "c65016b2848aefb71315ddcc91dfcd4ac8594a9d",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/checker.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -13,7 +13,7 @@ import * as ts from 'typescript';\n import {FullTemplateMapping, TypeCheckableDirectiveMeta} from './api';\n import {GlobalCompletion} from './completion';\n import {DirectiveInScope, PipeInScope} from './scope';\n-import {DirectiveSymbol, ElementSymbol, ShimLocation, Symbol} from './symbols';\n+import {DirectiveSymbol, ElementSymbol, ShimLocation, Symbol, TemplateSymbol} from './symbols';\n \n /**\n  * Interface to the Angular Template Type Checker to extract diagnostics and intelligence from the\n@@ -111,6 +111,7 @@ export interface TemplateTypeChecker {\n    * @see Symbol\n    */\n   getSymbolOfNode(node: TmplAstElement, component: ts.ClassDeclaration): ElementSymbol|null;\n+  getSymbolOfNode(node: TmplAstTemplate, component: ts.ClassDeclaration): TemplateSymbol|null;\n   getSymbolOfNode(node: AST|TmplAstNode, component: ts.ClassDeclaration): Symbol|null;\n \n   /**"
        },
        {
            "sha": "6593d0a63b3e884f4d9f1b85980562c66d3982ac",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/scope.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fscope.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fscope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fscope.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -32,6 +32,11 @@ export interface DirectiveInScope {\n    * `true` if this directive is a component.\n    */\n   isComponent: boolean;\n+\n+  /**\n+   * `true` if this directive is a structural directive.\n+   */\n+  isStructural: boolean;\n }\n \n /**"
        },
        {
            "sha": "0cd7b9de3b44d58e5a7211bef9e361d488318f0a",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -16,7 +16,7 @@ import {ClassDeclaration, isNamedClassDeclaration, ReflectionHost} from '../../r\n import {ComponentScopeReader, TypeCheckScopeRegistry} from '../../scope';\n import {isShim} from '../../shims';\n import {getSourceFileOrNull} from '../../util/src/typescript';\n-import {DirectiveInScope, ElementSymbol, FullTemplateMapping, GlobalCompletion, OptimizeFor, PipeInScope, ProgramTypeCheckAdapter, ShimLocation, Symbol, TemplateId, TemplateTypeChecker, TypeCheckableDirectiveMeta, TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from '../api';\n+import {DirectiveInScope, ElementSymbol, FullTemplateMapping, GlobalCompletion, OptimizeFor, PipeInScope, ProgramTypeCheckAdapter, ShimLocation, Symbol, TemplateId, TemplateSymbol, TemplateTypeChecker, TypeCheckableDirectiveMeta, TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from '../api';\n import {TemplateDiagnostic} from '../diagnostics';\n \n import {CompletionEngine} from './completion';\n@@ -472,6 +472,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     }\n     return this.state.get(path)!;\n   }\n+  getSymbolOfNode(node: TmplAstTemplate, component: ts.ClassDeclaration): TemplateSymbol|null;\n   getSymbolOfNode(node: TmplAstElement, component: ts.ClassDeclaration): ElementSymbol|null;\n   getSymbolOfNode(node: AST|TmplAstNode, component: ts.ClassDeclaration): Symbol|null {\n     const builder = this.getOrCreateSymbolBuilder(component);\n@@ -598,6 +599,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n \n       data.directives.push({\n         isComponent: dir.isComponent,\n+        isStructural: dir.isStructural,\n         selector: dir.selector,\n         tsSymbol,\n         ngModule,"
        },
        {
            "sha": "0342b11066495977efd86e05a702c22f86cd7f21",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/template_symbol_builder.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -140,7 +140,8 @@ export class SymbolBuilder {\n             selector: meta.selector,\n             isComponent,\n             ngModule,\n-            kind: SymbolKind.Directive\n+            kind: SymbolKind.Directive,\n+            isStructural: meta.isStructural,\n           };\n           return directiveSymbol;\n         })\n@@ -281,7 +282,7 @@ export class SymbolBuilder {\n \n   private getDirectiveSymbolForAccessExpression(\n       node: ts.ElementAccessExpression|ts.PropertyAccessExpression,\n-      {isComponent, selector}: TypeCheckableDirectiveMeta): DirectiveSymbol|null {\n+      {isComponent, selector, isStructural}: TypeCheckableDirectiveMeta): DirectiveSymbol|null {\n     // In either case, `_t1[\"index\"]` or `_t1.index`, `node.expression` is _t1.\n     // The retrieved symbol for _t1 will be the variable declaration.\n     const tsSymbol = this.getTypeChecker().getSymbolAtLocation(node.expression);\n@@ -313,6 +314,7 @@ export class SymbolBuilder {\n       tsType: symbol.tsType,\n       shimLocation: symbol.shimLocation,\n       isComponent,\n+      isStructural,\n       selector,\n       ngModule,\n     };"
        },
        {
            "sha": "862c8c2a0caa520c8058ef58334dba890c2926f6",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -505,6 +505,7 @@ function prepareDeclarations(\n       isGeneric: decl.isGeneric ?? false,\n       outputs: ClassPropertyMapping.fromMappedObject(decl.outputs || {}),\n       queries: decl.queries || [],\n+      isStructural: false,\n     };\n     matcher.addSelectables(selector, meta);\n   }\n@@ -567,6 +568,7 @@ function makeScope(program: ts.Program, sf: ts.SourceFile, decls: TestDeclaratio\n         undeclaredInputFields: new Set(decl.undeclaredInputFields ?? []),\n         isGeneric: decl.isGeneric ?? false,\n         isPoisoned: false,\n+        isStructural: false,\n       });\n     } else if (decl.type === 'pipe') {\n       scope.pipes.push({"
        },
        {
            "sha": "7946b3b5a7db53eecde995dff2f52b4e489f2526",
            "filename": "packages/compiler/src/render3/view/t2_api.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ft2_api.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ft2_api.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ft2_api.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -74,6 +74,8 @@ export interface DirectiveMeta {\n    * Null otherwise\n    */\n   exportAs: string[]|null;\n+\n+  isStructural: boolean;\n }\n \n /**"
        },
        {
            "sha": "fe2f98863b4bf12f7ac0865a352bd15002970c4d",
            "filename": "packages/compiler/test/render3/view/binding_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fbinding_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c55bf4a4a3127936b6714d9397416086f06df79a/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fbinding_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fbinding_spec.ts?ref=c55bf4a4a3127936b6714d9397416086f06df79a",
            "patch": "@@ -38,6 +38,7 @@ function makeSelectorMatcher(): SelectorMatcher<DirectiveMeta> {\n     inputs: new IdentityInputMapping(['ngForOf']),\n     outputs: new IdentityInputMapping([]),\n     isComponent: false,\n+    isStructural: true,\n     selector: '[ngFor][ngForOf]',\n   });\n   matcher.addSelectables(CssSelector.parse('[dir]'), {\n@@ -46,6 +47,7 @@ function makeSelectorMatcher(): SelectorMatcher<DirectiveMeta> {\n     inputs: new IdentityInputMapping([]),\n     outputs: new IdentityInputMapping([]),\n     isComponent: false,\n+    isStructural: false,\n     selector: '[dir]'\n   });\n   matcher.addSelectables(CssSelector.parse('[hasOutput]'), {\n@@ -54,6 +56,7 @@ function makeSelectorMatcher(): SelectorMatcher<DirectiveMeta> {\n     inputs: new IdentityInputMapping([]),\n     outputs: new IdentityInputMapping(['outputBinding']),\n     isComponent: false,\n+    isStructural: false,\n     selector: '[hasOutput]'\n   });\n   matcher.addSelectables(CssSelector.parse('[hasInput]'), {\n@@ -62,6 +65,7 @@ function makeSelectorMatcher(): SelectorMatcher<DirectiveMeta> {\n     inputs: new IdentityInputMapping(['inputBinding']),\n     outputs: new IdentityInputMapping([]),\n     isComponent: false,\n+    isStructural: false,\n     selector: '[hasInput]'\n   });\n   return matcher;\n@@ -107,6 +111,7 @@ describe('t2 binding', () => {\n       inputs: new IdentityInputMapping([]),\n       outputs: new IdentityInputMapping([]),\n       isComponent: false,\n+      isStructural: false,\n       selector: 'text[dir]'\n     });\n     const binder = new R3TargetBinder(matcher);"
        }
    ],
    "stats": {
        "total": 238,
        "additions": 227,
        "deletions": 11
    }
}