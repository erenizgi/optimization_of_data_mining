{
    "author": "josephperrott",
    "message": "refactor(dev-infra): set up new method for checking range of commits (#41341)\n\nCheck a range of commits by retrieving the log files to be parsed with the expected\nformat for the parser.\n\nThis change is in part of a larger set of changes making the process for obtaining\nand parsing commits for release note creation and message validation consistent.\nThis consistency will make it easier to debug as well as ease the design of tooling\nwhich is built on top of these processes.\n\nPR Close #41341",
    "sha": "381ea9d7d4c88f75260dcc616822fc334ea700a8",
    "files": [
        {
            "sha": "3b4dddaa3d6b3cf73e831cb54481f94237df84ba",
            "filename": "dev-infra/commit-message/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2FBUILD.bazel?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -12,11 +12,13 @@ ts_library(\n     deps = [\n         \"//dev-infra/utils\",\n         \"@npm//@types/conventional-commits-parser\",\n+        \"@npm//@types/git-raw-commits\",\n         \"@npm//@types/inquirer\",\n         \"@npm//@types/node\",\n         \"@npm//@types/shelljs\",\n         \"@npm//@types/yargs\",\n         \"@npm//conventional-commits-parser\",\n+        \"@npm//git-raw-commits\",\n         \"@npm//inquirer\",\n         \"@npm//shelljs\",\n         \"@npm//yargs\","
        },
        {
            "sha": "53994fae4e72f549ae098d10600f97c14341acc9",
            "filename": "dev-infra/commit-message/config.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Fconfig.ts",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fconfig.ts?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -31,7 +31,7 @@ export function getCommitMessageConfig() {\n   return config as Required<typeof config>;\n }\n \n-/** Scope requirement level to be set for each commit type.  */\n+/** Scope requirement level to be set for each commit type. */\n export enum ScopeRequirement {\n   Required,\n   Optional,"
        },
        {
            "sha": "a630de2ad2f6bd6c009d451615371312c1dbe38f",
            "filename": "dev-infra/commit-message/parse.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 30,
            "changes": 57,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Fparse.ts",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Fparse.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fparse.ts?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -8,8 +8,6 @@\n \n import {Commit as ParsedCommit, Options, sync as parse} from 'conventional-commits-parser';\n \n-import {exec} from '../utils/shelljs';\n-\n \n /** A parsed commit, containing the information needed to validate the commit. */\n export interface Commit {\n@@ -43,6 +41,30 @@ export interface Commit {\n   isRevert: boolean;\n }\n \n+/**\n+ * A list of tuples expressing the fields to extract from each commit log entry. The tuple contains\n+ * two values, the first is the key for the property and the second is the template shortcut for the\n+ * git log command.\n+ */\n+const commitFields = {\n+  hash: '%H',\n+  shortHash: '%h',\n+  author: '%aN',\n+};\n+/** The additional fields to be included in commit log entries for parsing. */\n+export type CommitFields = typeof commitFields;\n+/** The commit fields described as git log format entries for parsing. */\n+export const commitFieldsAsFormat = (fields: CommitFields) => {\n+  return Object.entries(fields).map(([key, value]) => `%n-${key}-%n${value}`).join('');\n+};\n+/**\n+ * The git log format template to create git log entries for parsing.\n+ *\n+ * The conventional commits parser expects to parse the standard git log raw body (%B) into its\n+ * component parts. Additionally it will parse additional fields with keys defined by\n+ * `-{key name}-` separated by new lines.\n+ * */\n+export const gitLogFormatForParsing = `%B${commitFieldsAsFormat(commitFields)}`;\n /** Markers used to denote the start of a note section in a commit. */\n enum NoteSections {\n   BREAKING_CHANGE = 'BREAKING CHANGE',\n@@ -87,7 +109,9 @@ const parseOptions: Options&{notesPattern: (keywords: string) => RegExp} = {\n \n \n /** Parse a full commit message into its composite parts. */\n-export function parseCommitMessage(fullText: string): Commit {\n+export function parseCommitMessage(fullText: string|Buffer): Commit {\n+  // Ensure the fullText symbol is a `string`, even if a Buffer was provided.\n+  fullText = fullText.toString();\n   /** The commit message text with the fixup and squash markers stripped out. */\n   const strippedCommitMsg = fullText.replace(FIXUP_PREFIX_RE, '')\n                                 .replace(SQUASH_PREFIX_RE, '')\n@@ -126,30 +150,3 @@ export function parseCommitMessage(fullText: string): Commit {\n     isRevert: REVERT_PREFIX_RE.test(fullText),\n   };\n }\n-\n-/** Retrieve and parse each commit message in a provide range. */\n-export function parseCommitMessagesForRange(range: string): Commit[] {\n-  /** A random number used as a split point in the git log result. */\n-  const randomValueSeparator = `${Math.random()}`;\n-  /**\n-   * Custom git log format that provides the commit header and body, separated as expected with the\n-   * custom separator as the trailing value.\n-   */\n-  const gitLogFormat = `%s%n%n%b${randomValueSeparator}`;\n-\n-  // Retrieve the commits in the provided range.\n-  const result = exec(`git log --reverse --format=${gitLogFormat} ${range}`);\n-  if (result.code) {\n-    throw new Error(`Failed to get all commits in the range:\\n  ${result.stderr}`);\n-  }\n-\n-  return result\n-      // Separate the commits from a single string into individual commits.\n-      .split(randomValueSeparator)\n-      // Remove extra space before and after each commit message.\n-      .map(l => l.trim())\n-      // Remove any superfluous lines which remain from the split.\n-      .filter(line => !!line)\n-      // Parse each commit message.\n-      .map(commit => parseCommitMessage(commit));\n-}"
        },
        {
            "sha": "785ecaaa77802e515a9b567cac31d35202db0fc6",
            "filename": "dev-infra/commit-message/restore-commit-message/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Frestore-commit-message%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Frestore-commit-message%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Frestore-commit-message%2Fcli.ts?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -50,11 +50,11 @@ async function handler({fileEnvVariable, file, source}: Arguments<RestoreCommitM\n   }\n \n   throw new Error(\n-      'No file path and commit message source provide.  Provide values via positional command ' +\n+      'No file path and commit message source provide. Provide values via positional command ' +\n       'arguments, or via the --file-env-variable flag');\n }\n \n-/** yargs command module describing the command.  */\n+/** yargs command module describing the command. */\n export const RestoreCommitMessageModule: CommandModule<{}, RestoreCommitMessageOptions> = {\n   handler,\n   builder,"
        },
        {
            "sha": "ae3ee5a1a45563d9f8215b9159548cd8393167f2",
            "filename": "dev-infra/commit-message/utils.ts",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Futils.ts?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -0,0 +1,32 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import * as gitCommits_ from 'git-raw-commits';\n+\n+import {Commit, gitLogFormatForParsing, parseCommitMessage} from './parse';\n+\n+// Set `gitCommits` as this imported value to address \"Cannot call a namespace\" error.\n+const gitCommits = gitCommits_;\n+\n+\n+/**\n+ * Find all commits within the given range and return an object describing those.\n+ */\n+export function getCommitsInRange(from: string, to: string = 'HEAD'): Promise<Commit[]> {\n+  return new Promise((resolve, reject) => {\n+    /** List of parsed commit objects. */\n+    const commits: Commit[] = [];\n+    /** Stream of raw git commit strings in the range provided. */\n+    const commitStream = gitCommits({from, to, format: gitLogFormatForParsing});\n+\n+    // Accumulate the parsed commits for each commit from the Readable stream into an array, then\n+    // resolve the promise with the array when the Readable stream ends.\n+    commitStream.on('data', (commit: Buffer) => commits.push(parseCommitMessage(commit)));\n+    commitStream.on('error', (err: Error) => reject(err));\n+    commitStream.on('end', () => resolve(commits));\n+  });\n+}"
        },
        {
            "sha": "82f9800c3e93e36a30387442d5f2534951dca461",
            "filename": "dev-infra/commit-message/validate-file/cli.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Fvalidate-file%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Fvalidate-file%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate-file%2Fcli.ts?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -53,7 +53,7 @@ async function handler({error, file, fileEnvVariable}: Arguments<ValidateFileOpt\n   validateFile(filePath, error);\n }\n \n-/** yargs command module describing the command.  */\n+/** yargs command module describing the command. */\n export const ValidateFileModule: CommandModule<{}, ValidateFileOptions> = {\n   handler,\n   builder,"
        },
        {
            "sha": "2878dc1b7a1cdf97614ea9d1f46b4c8f8a0ede88",
            "filename": "dev-infra/commit-message/validate-range/cli.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 11,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Fvalidate-range%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Fvalidate-range%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate-range%2Fcli.ts?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -14,21 +14,27 @@ import {validateCommitRange} from './validate-range';\n \n \n export interface ValidateRangeOptions {\n-  range: string;\n+  startingRef: string;\n+  endingRef: string;\n }\n \n /** Builds the command. */\n function builder(yargs: Argv) {\n-  return yargs.option('range', {\n-    description: 'The range of commits to check, e.g. --range abc123..xyz456',\n-    demandOption: '  A range must be provided, e.g. --range abc123..xyz456',\n-    type: 'string',\n-    requiresArg: true,\n-  });\n+  return yargs\n+      .positional('startingRef', {\n+        description: 'The first ref in the range to select',\n+        type: 'string',\n+        demandOption: true,\n+      })\n+      .positional('endingRef', {\n+        description: 'The last ref in the range to select',\n+        type: 'string',\n+        default: 'HEAD',\n+      });\n }\n \n /** Handles the command. */\n-async function handler({range}: Arguments<ValidateRangeOptions>) {\n+async function handler({startingRef, endingRef}: Arguments<ValidateRangeOptions>) {\n   // If on CI, and no pull request number is provided, assume the branch\n   // being run on is an upstream branch.\n   if (process.env['CI'] && process.env['CI_PULL_REQUEST'] === 'false') {\n@@ -38,13 +44,13 @@ async function handler({range}: Arguments<ValidateRangeOptions>) {\n     info(`Skipping check of provided commit range`);\n     return;\n   }\n-  validateCommitRange(range);\n+  await validateCommitRange(startingRef, endingRef);\n }\n \n-/** yargs command module describing the command.  */\n+/** yargs command module describing the command. */\n export const ValidateRangeModule: CommandModule<{}, ValidateRangeOptions> = {\n   handler,\n   builder,\n-  command: 'validate-range',\n+  command: 'validate-range <starting-ref> [ending-ref]',\n   describe: 'Validate a range of commit messages',\n };"
        },
        {
            "sha": "5f506b99163239dc346d96bb2b6c137ce705ff5e",
            "filename": "dev-infra/commit-message/validate-range/validate-range.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Fvalidate-range%2Fvalidate-range.ts",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fcommit-message%2Fvalidate-range%2Fvalidate-range.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate-range%2Fvalidate-range.ts?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -5,8 +5,9 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {error, info} from '../../utils/console';\n-import {Commit, parseCommitMessagesForRange} from '../parse';\n+import {error, green, info, red} from '../../utils/console';\n+import {Commit} from '../parse';\n+import {getCommitsInRange} from '../utils';\n import {printValidationErrors, validateCommitMessage, ValidateCommitMessageOptions} from '../validate';\n \n // Whether the provided commit is a fixup commit.\n@@ -16,12 +17,13 @@ const isNonFixup = (commit: Commit) => !commit.isFixup;\n const extractCommitHeader = (commit: Commit) => commit.header;\n \n /** Validate all commits in a provided git commit range. */\n-export function validateCommitRange(range: string) {\n+export async function validateCommitRange(from: string, to: string) {\n   /** A list of tuples of the commit header string and a list of error messages for the commit. */\n   const errors: [commitHeader: string, errors: string[]][] = [];\n+\n   /** A list of parsed commit messages from the range. */\n-  const commits = parseCommitMessagesForRange(range);\n-  info(`Examining ${commits.length} commit(s) in the provided range: ${range}`);\n+  const commits = await getCommitsInRange(from, to);\n+  info(`Examining ${commits.length} commit(s) in the provided range: ${from}..${to}`);\n \n   /**\n    * Whether all commits in the range are valid, commits are allowed to be fixup commits for other\n@@ -32,7 +34,7 @@ export function validateCommitRange(range: string) {\n       disallowSquash: true,\n       nonFixupCommitHeaders: isNonFixup(commit) ?\n           undefined :\n-          commits.slice(0, i).filter(isNonFixup).map(extractCommitHeader)\n+          commits.slice(i + 1).filter(isNonFixup).map(extractCommitHeader)\n     };\n     const {valid, errors: localErrors} = validateCommitMessage(commit, options);\n     if (localErrors.length) {\n@@ -42,9 +44,9 @@ export function validateCommitRange(range: string) {\n   });\n \n   if (allCommitsInRangeValid) {\n-    info('√  All commit messages in range valid.');\n+    info(green('√  All commit messages in range valid.'));\n   } else {\n-    error('✘  Invalid commit message');\n+    error(red('✘  Invalid commit message'));\n     errors.forEach(([header, validationErrors]) => {\n       error.group(header);\n       printValidationErrors(validationErrors);"
        },
        {
            "sha": "e70c96f3b1e07eaf1144b8aa526c91b04a7323d0",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 100,
            "deletions": 73,
            "changes": 173,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -20,6 +20,7 @@ var semver = require('semver');\n var multimatch = require('multimatch');\n var yaml = require('yaml');\n var conventionalCommitsParser = require('conventional-commits-parser');\n+var gitCommits_ = require('git-raw-commits');\n var cliProgress = require('cli-progress');\n var os = require('os');\n var minimatch = require('minimatch');\n@@ -1588,11 +1589,11 @@ function handler$1({ fileEnvVariable, file, source }) {\n             restoreCommitMessage(fileFromEnv, sourceFromEnv);\n             return;\n         }\n-        throw new Error('No file path and commit message source provide.  Provide values via positional command ' +\n+        throw new Error('No file path and commit message source provide. Provide values via positional command ' +\n             'arguments, or via the --file-env-variable flag');\n     });\n }\n-/** yargs command module describing the command.  */\n+/** yargs command module describing the command. */\n const RestoreCommitMessageModule = {\n     handler: handler$1,\n     builder: builder$1,\n@@ -1621,7 +1622,7 @@ function getCommitMessageConfig() {\n     assertNoErrors(errors);\n     return config;\n }\n-/** Scope requirement level to be set for each commit type.  */\n+/** Scope requirement level to be set for each commit type. */\n var ScopeRequirement;\n (function (ScopeRequirement) {\n     ScopeRequirement[ScopeRequirement[\"Required\"] = 0] = \"Required\";\n@@ -1684,6 +1685,28 @@ const COMMIT_TYPES = {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+/**\n+ * A list of tuples expressing the fields to extract from each commit log entry. The tuple contains\n+ * two values, the first is the key for the property and the second is the template shortcut for the\n+ * git log command.\n+ */\n+const commitFields = {\n+    hash: '%H',\n+    shortHash: '%h',\n+    author: '%aN',\n+};\n+/** The commit fields described as git log format entries for parsing. */\n+const commitFieldsAsFormat = (fields) => {\n+    return Object.entries(fields).map(([key, value]) => `%n-${key}-%n${value}`).join('');\n+};\n+/**\n+ * The git log format template to create git log entries for parsing.\n+ *\n+ * The conventional commits parser expects to parse the standard git log raw body (%B) into its\n+ * component parts. Additionally it will parse additional fields with keys defined by\n+ * `-{key name}-` separated by new lines.\n+ * */\n+const gitLogFormatForParsing = `%B${commitFieldsAsFormat(commitFields)}`;\n /** Markers used to denote the start of a note section in a commit. */\n var NoteSections;\n (function (NoteSections) {\n@@ -1728,6 +1751,8 @@ const parseOptions = {\n };\n /** Parse a full commit message into its composite parts. */\n function parseCommitMessage(fullText) {\n+    // Ensure the fullText symbol is a `string`, even if a Buffer was provided.\n+    fullText = fullText.toString();\n     /** The commit message text with the fixup and squash markers stripped out. */\n     const strippedCommitMsg = fullText.replace(FIXUP_PREFIX_RE, '')\n         .replace(SQUASH_PREFIX_RE, '')\n@@ -1764,30 +1789,6 @@ function parseCommitMessage(fullText) {\n         isRevert: REVERT_PREFIX_RE.test(fullText),\n     };\n }\n-/** Retrieve and parse each commit message in a provide range. */\n-function parseCommitMessagesForRange(range) {\n-    /** A random number used as a split point in the git log result. */\n-    const randomValueSeparator = `${Math.random()}`;\n-    /**\n-     * Custom git log format that provides the commit header and body, separated as expected with the\n-     * custom separator as the trailing value.\n-     */\n-    const gitLogFormat = `%s%n%n%b${randomValueSeparator}`;\n-    // Retrieve the commits in the provided range.\n-    const result = exec(`git log --reverse --format=${gitLogFormat} ${range}`);\n-    if (result.code) {\n-        throw new Error(`Failed to get all commits in the range:\\n  ${result.stderr}`);\n-    }\n-    return result\n-        // Separate the commits from a single string into individual commits.\n-        .split(randomValueSeparator)\n-        // Remove extra space before and after each commit message.\n-        .map(l => l.trim())\n-        // Remove any superfluous lines which remain from the split.\n-        .filter(line => !!line)\n-        // Parse each commit message.\n-        .map(commit => parseCommitMessage(commit));\n-}\n \n /**\n  * @license\n@@ -2012,7 +2013,7 @@ function handler$2({ error, file, fileEnvVariable }) {\n         validateFile(filePath, error);\n     });\n }\n-/** yargs command module describing the command.  */\n+/** yargs command module describing the command. */\n const ValidateFileModule = {\n     handler: handler$2,\n     builder: builder$2,\n@@ -2027,48 +2028,69 @@ const ValidateFileModule = {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+// Set `gitCommits` as this imported value to address \"Cannot call a namespace\" error.\n+const gitCommits = gitCommits_;\n+/**\n+ * Find all commits within the given range and return an object describing those.\n+ */\n+function getCommitsInRange(from, to = 'HEAD') {\n+    return new Promise((resolve, reject) => {\n+        /** List of parsed commit objects. */\n+        const commits = [];\n+        /** Stream of raw git commit strings in the range provided. */\n+        const commitStream = gitCommits({ from, to, format: gitLogFormatForParsing });\n+        // Accumulate the parsed commits for each commit from the Readable stream into an array, then\n+        // resolve the promise with the array when the Readable stream ends.\n+        commitStream.on('data', (commit) => commits.push(parseCommitMessage(commit)));\n+        commitStream.on('error', (err) => reject(err));\n+        commitStream.on('end', () => resolve(commits));\n+    });\n+}\n+\n // Whether the provided commit is a fixup commit.\n const isNonFixup = (commit) => !commit.isFixup;\n // Extracts commit header (first line of commit message).\n const extractCommitHeader = (commit) => commit.header;\n /** Validate all commits in a provided git commit range. */\n-function validateCommitRange(range) {\n-    /** A list of tuples of the commit header string and a list of error messages for the commit. */\n-    const errors = [];\n-    /** A list of parsed commit messages from the range. */\n-    const commits = parseCommitMessagesForRange(range);\n-    info(`Examining ${commits.length} commit(s) in the provided range: ${range}`);\n-    /**\n-     * Whether all commits in the range are valid, commits are allowed to be fixup commits for other\n-     * commits in the provided commit range.\n-     */\n-    const allCommitsInRangeValid = commits.every((commit, i) => {\n-        const options = {\n-            disallowSquash: true,\n-            nonFixupCommitHeaders: isNonFixup(commit) ?\n-                undefined :\n-                commits.slice(0, i).filter(isNonFixup).map(extractCommitHeader)\n-        };\n-        const { valid, errors: localErrors } = validateCommitMessage(commit, options);\n-        if (localErrors.length) {\n-            errors.push([commit.header, localErrors]);\n+function validateCommitRange(from, to) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        /** A list of tuples of the commit header string and a list of error messages for the commit. */\n+        const errors = [];\n+        /** A list of parsed commit messages from the range. */\n+        const commits = yield getCommitsInRange(from, to);\n+        info(`Examining ${commits.length} commit(s) in the provided range: ${from}..${to}`);\n+        /**\n+         * Whether all commits in the range are valid, commits are allowed to be fixup commits for other\n+         * commits in the provided commit range.\n+         */\n+        const allCommitsInRangeValid = commits.every((commit, i) => {\n+            const options = {\n+                disallowSquash: true,\n+                nonFixupCommitHeaders: isNonFixup(commit) ?\n+                    undefined :\n+                    commits.slice(i + 1).filter(isNonFixup).map(extractCommitHeader)\n+            };\n+            const { valid, errors: localErrors } = validateCommitMessage(commit, options);\n+            if (localErrors.length) {\n+                errors.push([commit.header, localErrors]);\n+            }\n+            return valid;\n+        });\n+        if (allCommitsInRangeValid) {\n+            info(green('√  All commit messages in range valid.'));\n+        }\n+        else {\n+            error(red('✘  Invalid commit message'));\n+            errors.forEach(([header, validationErrors]) => {\n+                error.group(header);\n+                printValidationErrors(validationErrors);\n+                error.groupEnd();\n+            });\n+            // Exit with a non-zero exit code if invalid commit messages have\n+            // been discovered.\n+            process.exit(1);\n         }\n-        return valid;\n     });\n-    if (allCommitsInRangeValid) {\n-        info('√  All commit messages in range valid.');\n-    }\n-    else {\n-        error('✘  Invalid commit message');\n-        errors.forEach(([header, validationErrors]) => {\n-            error.group(header);\n-            printValidationErrors(validationErrors);\n-            error.groupEnd();\n-        });\n-        // Exit with a non-zero exit code if invalid commit messages have\n-        // been discovered.\n-        process.exit(1);\n-    }\n }\n \n /**\n@@ -2080,15 +2102,20 @@ function validateCommitRange(range) {\n  */\n /** Builds the command. */\n function builder$3(yargs) {\n-    return yargs.option('range', {\n-        description: 'The range of commits to check, e.g. --range abc123..xyz456',\n-        demandOption: '  A range must be provided, e.g. --range abc123..xyz456',\n+    return yargs\n+        .positional('startingRef', {\n+        description: 'The first ref in the range to select',\n         type: 'string',\n-        requiresArg: true,\n+        demandOption: true,\n+    })\n+        .positional('endingRef', {\n+        description: 'The last ref in the range to select',\n+        type: 'string',\n+        default: 'HEAD',\n     });\n }\n /** Handles the command. */\n-function handler$3({ range }) {\n+function handler$3({ startingRef, endingRef }) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n         // If on CI, and no pull request number is provided, assume the branch\n         // being run on is an upstream branch.\n@@ -2099,14 +2126,14 @@ function handler$3({ range }) {\n             info(`Skipping check of provided commit range`);\n             return;\n         }\n-        validateCommitRange(range);\n+        yield validateCommitRange(startingRef, endingRef);\n     });\n }\n-/** yargs command module describing the command.  */\n+/** yargs command module describing the command. */\n const ValidateRangeModule = {\n     handler: handler$3,\n     builder: builder$3,\n-    command: 'validate-range',\n+    command: 'validate-range <starting-ref> [ending-ref]',\n     describe: 'Validate a range of commit messages',\n };\n \n@@ -4210,7 +4237,7 @@ function handler$6(_a) {\n         });\n     });\n }\n-/** yargs command module describing the command.  */\n+/** yargs command module describing the command. */\n var MergeCommandModule = {\n     handler: handler$6,\n     builder: builder$6,\n@@ -4294,7 +4321,7 @@ function rebasePr(prNumber, githubToken, config = getConfig()) {\n             info(`Fetching ${fullBaseRef} to rebase #${prNumber} on`);\n             git.run(['fetch', '-q', baseRefUrl, baseRefName]);\n             const commonAncestorSha = git.run(['merge-base', 'HEAD', 'FETCH_HEAD']).stdout.trim();\n-            const commits = parseCommitMessagesForRange(`${commonAncestorSha}..HEAD`);\n+            const commits = yield getCommitsInRange(commonAncestorSha, 'HEAD');\n             let squashFixups = commits.filter((commit) => commit.isFixup).length === 0 ?\n                 false :\n                 yield promptConfirm(`PR #${prNumber} contains fixup commits, would you like to squash them during rebase?`, true);"
        },
        {
            "sha": "0f1a13c74f219797bc553528778be0cf66c6d76c",
            "filename": "dev-infra/pr/merge/cli.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fpr%2Fmerge%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fpr%2Fmerge%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fcli.ts?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -41,7 +41,7 @@ async function handler({pr, githubToken, branchPrompt}: Arguments<MergeCommandOp\n   await mergePullRequest(pr, githubToken, {branchPrompt});\n }\n \n-/** yargs command module describing the command.  */\n+/** yargs command module describing the command. */\n export const MergeCommandModule: CommandModule<{}, MergeCommandOptions> = {\n   handler,\n   builder,"
        },
        {
            "sha": "5dac748e060d2aa4fc2f231cf3e67c944dec8dba",
            "filename": "dev-infra/pr/rebase/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Frebase%2Findex.ts?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -8,7 +8,8 @@\n \n import {types as graphQLTypes} from 'typed-graphqlify';\n \n-import {Commit, parseCommitMessagesForRange} from '../../commit-message/parse';\n+import {Commit} from '../../commit-message/parse';\n+import {getCommitsInRange} from '../../commit-message/utils';\n import {getConfig, NgDevConfig} from '../../utils/config';\n import {error, info, promptConfirm} from '../../utils/console';\n import {addTokenToGitHttpsUrl} from '../../utils/git/github-urls';\n@@ -93,7 +94,7 @@ export async function rebasePr(\n \n     const commonAncestorSha = git.run(['merge-base', 'HEAD', 'FETCH_HEAD']).stdout.trim();\n \n-    const commits = parseCommitMessagesForRange(`${commonAncestorSha}..HEAD`);\n+    const commits = await getCommitsInRange(commonAncestorSha, 'HEAD');\n \n     let squashFixups = commits.filter((commit: Commit) => commit.isFixup).length === 0 ?\n         false :"
        },
        {
            "sha": "8d89c7228e3d0ab3d42efbf2e968d636dae809e8",
            "filename": "dev-infra/tmpl-package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Ftmpl-package.json",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/dev-infra%2Ftmpl-package.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Ftmpl-package.json?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -17,6 +17,7 @@\n     \"chalk\": \"<from-root>\",\n     \"cli-progress\": \"<from-root>\",\n     \"conventional-commits-parser\": \"<from-root>\",\n+    \"git-raw-commits\": \"<from-root>\",\n     \"glob\": \"<from-root>\",\n     \"inquirer\": \"<from-root>\",\n     \"minimatch\": \"<from-root>\","
        },
        {
            "sha": "3c47fc0f58b86bacdc5efd1932e9c8ddc0b248dc",
            "filename": "package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/package.json",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/package.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/package.json?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -168,6 +168,7 @@\n     \"@octokit/graphql\": \"^4.3.1\",\n     \"@types/cli-progress\": \"^3.4.2\",\n     \"@types/conventional-commits-parser\": \"^3.0.1\",\n+    \"@types/git-raw-commits\": \"^2.0.0\",\n     \"@types/minimist\": \"^1.2.0\",\n     \"@yarnpkg/lockfile\": \"^1.1.0\",\n     \"browserstacktunnel-wrapper\": \"^2.0.4\",\n@@ -182,6 +183,7 @@\n     \"entities\": \"1.1.1\",\n     \"firebase-tools\": \"^7.11.0\",\n     \"firefox-profile\": \"1.0.3\",\n+    \"git-raw-commits\": \"^2.0.10\",\n     \"glob\": \"7.1.2\",\n     \"gulp\": \"^4.0.2\",\n     \"gulp-conventional-changelog\": \"^2.0.35\","
        },
        {
            "sha": "b708f20552b424bc2c5d656995efab966d61645c",
            "filename": "yarn.lock",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/381ea9d7d4c88f75260dcc616822fc334ea700a8/yarn.lock",
            "raw_url": "https://github.com/angular/angular/raw/381ea9d7d4c88f75260dcc616822fc334ea700a8/yarn.lock",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/yarn.lock?ref=381ea9d7d4c88f75260dcc616822fc334ea700a8",
            "patch": "@@ -2495,6 +2495,13 @@\n   dependencies:\n     \"@types/node\" \"*\"\n \n+\"@types/git-raw-commits@^2.0.0\":\n+  version \"2.0.0\"\n+  resolved \"https://registry.yarnpkg.com/@types/git-raw-commits/-/git-raw-commits-2.0.0.tgz#157e9e4709db0748fb1aa623f8927ddd4864bac6\"\n+  integrity sha512-sHXOKjKqu1kQxbxkZiz2s0yx2kc7g20g6tE98LYGq5jQyT9r+GRyTn19NBfPotOlXhGO6oPvYT3tdnPl8MYYyA==\n+  dependencies:\n+    \"@types/node\" \"*\"\n+\n \"@types/glob@*\", \"@types/glob@^7.1.1\":\n   version \"7.1.1\"\n   resolved \"https://registry.yarnpkg.com/@types/glob/-/glob-7.1.1.tgz#aa59a1c6e3fbc421e07ccd31a944c30eba521575\"\n@@ -7647,7 +7654,7 @@ git-raw-commits@2.0.0:\n     split2 \"^2.0.0\"\n     through2 \"^2.0.0\"\n \n-git-raw-commits@^2.0.8:\n+git-raw-commits@^2.0.10, git-raw-commits@^2.0.8:\n   version \"2.0.10\"\n   resolved \"https://registry.yarnpkg.com/git-raw-commits/-/git-raw-commits-2.0.10.tgz#e2255ed9563b1c9c3ea6bd05806410290297bbc1\"\n   integrity sha512-sHhX5lsbG9SOO6yXdlwgEMQ/ljIn7qMpAbJZCGfXX2fq5T8M5SrDnpYk9/4HswTildcIqatsWa91vty6VhWSaQ=="
        }
    ],
    "stats": {
        "total": 337,
        "additions": 207,
        "deletions": 130
    }
}