{
    "author": "devversion",
    "message": "build: wire up integration test rule from shared dev-infra package (#44238)\n\nWires up the integration test rule from the shared dev-infra package,\nwhile also deleting the old integration test rule.\n\nThe readme is updated to reflect the changes that are being made\nto run with the new integration rule. Overall one major difference is\nthat we will declare the integration test targets within each test\ndirectory, making those actual bazel packages. This is more idiomatic\nwithin Bazel and also reduces the computation within Skyframe as less\nglobs need to be evaluated for example.\n\nPR Close #44238",
    "sha": "6c0905d7ab6310c4ad836069c0764c02b0cf882c",
    "files": [
        {
            "sha": "f5d985dc37fbeca6a90a63a7187f54fc4d0e5bef",
            "filename": ".pullapprove.yml",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/6c0905d7ab6310c4ad836069c0764c02b0cf882c/.pullapprove.yml",
            "raw_url": "https://github.com/angular/angular/raw/6c0905d7ab6310c4ad836069c0764c02b0cf882c/.pullapprove.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.pullapprove.yml?ref=6c0905d7ab6310c4ad836069c0764c02b0cf882c",
            "patch": "@@ -1239,7 +1239,6 @@ groups:\n           'tools/gulp-tasks/**',\n           'tools/legacy-saucelabs/**',\n           'tools/npm/**',\n-          'tools/npm_integration_test/**',\n           'tools/rxjs/**',\n           'tools/saucelabs/**',\n           'tools/size-tracking/**',"
        },
        {
            "sha": "496049bd07002791a471ae87739bbc413338e5bb",
            "filename": "WORKSPACE",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/6c0905d7ab6310c4ad836069c0764c02b0cf882c/WORKSPACE",
            "raw_url": "https://github.com/angular/angular/raw/6c0905d7ab6310c4ad836069c0764c02b0cf882c/WORKSPACE",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/WORKSPACE?ref=6c0905d7ab6310c4ad836069c0764c02b0cf882c",
            "patch": "@@ -36,7 +36,7 @@ node_repositories(\n     package_json = [\"//:package.json\"],\n )\n \n-load(\"//integration:angular_integration_test.bzl\", \"npm_package_archives\")\n+load(\"//integration:npm_package_archives.bzl\", \"npm_package_archives\")\n \n yarn_install(\n     name = \"npm\","
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "integration/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 120,
            "changes": 120,
            "blob_url": "https://github.com/angular/angular/blob/6c0905d7ab6310c4ad836069c0764c02b0cf882c/integration%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/6c0905d7ab6310c4ad836069c0764c02b0cf882c/integration%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2FBUILD.bazel?ref=6c0905d7ab6310c4ad836069c0764c02b0cf882c",
            "patch": "@@ -1,120 +0,0 @@\n-load(\":angular_integration_test.bzl\", \"angular_integration_test\")\n-\n-# Some integration ports must be managed manually to be unique and in other\n-# cases the tests are able to select a random free port.\n-#\n-# Where `ng e2e` is used we pass `ng e2e --port 0` which prompts the cli\n-# to select a random free port for the e2e test. The protractor.conf is\n-# automatically updated to use this port.\n-#\n-# Karma automatically finds a free port so no effort is needed there.\n-#\n-# The manually configured ports are as follows:\n-#\n-#   TEST                                PORT        CONFIGURATION\n-#   ====                                ====        =============\n-#   dynamic-compiler                    4201        /e2e/browser.config.json: \"port\": 4201\n-#   hello_world__closure                4202        /e2e/browser.config.json: \"port\": 4202\n-#   i18n                                4204        /e2e/browser.config.json: \"port\": 4204\n-#   ng_elements                         4205        /e2e/browser.config.json: \"port\": 4205\n-#   platform-server                     4206        /src/server.ts: app.listen(4206,...\n-\n-# Map of integration tests to tags.\n-# A subset of these tests fail or are not meant to be run with ivy bundles. These are tagged\n-# \"view-engine-only\".\n-INTEGRATION_TESTS = {\n-    \"bazel\": {\n-        \"tags\": [\n-            # Bazel-in-bazel tests are resource intensive and should not be over-parallized\n-            # as they will compete for the resources of other parallel tests slowing\n-            # everything down. Ask Bazel to allocate multiple CPUs for these tests with \"cpu:n\" tag.\n-            \"cpu:3\",\n-        ],\n-    },\n-    \"cli-elements-universal\": {},\n-    \"cli-hello-world\": {\n-        \"commands\": \"payload_size_tracking\",\n-    },\n-    \"cli-hello-world-ivy-compat\": {\n-        \"commands\": \"payload_size_tracking\",\n-    },\n-    \"cli-hello-world-ivy-i18n\": {\n-        \"commands\": \"payload_size_tracking\",\n-    },\n-    \"cli-hello-world-ivy-minimal\": {\n-        \"commands\": \"payload_size_tracking\",\n-    },\n-    \"cli-hello-world-lazy\": {\n-        \"commands\": \"payload_size_tracking\",\n-    },\n-    \"dynamic-compiler\": {},\n-    \"forms\": {\n-        \"commands\": \"payload_size_tracking\",\n-    },\n-    \"hello_world__closure\": {\n-        # TODO: Re-enable the payload_size_tracking command:\n-        #   We should define ngDevMode to false in Closure, but --define only works in the global scope.\n-        #   With ngDevMode not being set to false, this size tracking test provides little value but a lot of\n-        #   headache to continue updating the size.\n-    },\n-    \"i18n\": {},\n-    \"injectable-def\": {\n-        # This test relies on ESM for running the app in SSR. RxJS added ESM resolution\n-        # support with RXJS v7. We allow the version to be pinned to v7.\n-        # TODO: Remove this and update the test once the project uses RxJS v7, or if rxjs v6 has ESM support.\n-        \"pinned_npm_packages\": [\"rxjs\"],\n-    },\n-    \"ivy-i18n\": {},\n-    \"trusted-types\": {},\n-    \"ng-add-localize\": {},\n-    \"ng_elements\": {},\n-    \"ng_update\": {},\n-    \"ng_update_migrations\": {},\n-    \"ngcc\": {\n-        \"use_view_engine_packages\": [\n-            \"@angular/animations\",\n-            \"@angular/common\",\n-            \"@angular/core\",\n-            \"@angular/forms\",\n-            \"@angular/platform-browser\",\n-            \"@angular/platform-browser-dynamic\",\n-            \"@angular/platform-server\",\n-            \"@angular/router\",\n-        ],\n-    },\n-    \"platform-server\": {},\n-    \"service-worker-schema\": {},\n-    # The `side-effects` test is currently disabled as it does not run the\n-    # Angular linker plugin and therefore partial declarations are retained\n-    # as side-effects. To make this test helpful again, we need to run the linker.\n-    # TODO(devversion): replace this with a solution we maintain that runs the Babel linker plugin.\n-    \"side-effects\": {\"tags\": [\"manual\"]},\n-    \"terser\": {},\n-    \"typings_test_rxjs7\": {\n-        # The project root uses an older version than the one we want to test here.\n-        \"pinned_npm_packages\": [\"rxjs\"],\n-    },\n-    \"typings_test_ts44\": {\n-        # Special case for `typings_test_ts44` test as we want to pin\n-        # `typescript` at version 4.4.x for that test and not link to the\n-        # root @npm//typescript package.\n-        \"pinned_npm_packages\": [\"typescript\"],\n-    },\n-    \"typings_test_ts45\": {\n-        # Special case for `typings_test_ts45` test as we want to pin\n-        # `typescript` at version 4.5.x for that test and not link to the\n-        # root @npm//typescript package.\n-        \"pinned_npm_packages\": [\"typescript\"],\n-    },\n-}\n-\n-[\n-    angular_integration_test(\n-        name = test_folder,\n-        commands = INTEGRATION_TESTS[test_folder].get(\"commands\", \"default\"),\n-        pinned_npm_packages = INTEGRATION_TESTS[test_folder].get(\"pinned_npm_packages\", []),\n-        tags = INTEGRATION_TESTS[test_folder].get(\"tags\", []),\n-        use_view_engine_packages = INTEGRATION_TESTS[test_folder].get(\"use_view_engine_packages\", []),\n-    )\n-    for test_folder in INTEGRATION_TESTS\n-]"
        },
        {
            "sha": "792a06ac1caf5866ee9502fbd6cb1805bd6b735a",
            "filename": "integration/README.md",
            "status": "modified",
            "additions": 32,
            "deletions": 8,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/6c0905d7ab6310c4ad836069c0764c02b0cf882c/integration%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/6c0905d7ab6310c4ad836069c0764c02b0cf882c/integration%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2FREADME.md?ref=6c0905d7ab6310c4ad836069c0764c02b0cf882c",
            "patch": "@@ -90,25 +90,48 @@ The downside of this is that this will apply to all tests and not just the resou\n Two of the integration tests that run Bazel-in-Bazel are particularly resource intensive and are tagged \"manual\" and \"exclusive\". To run these tests use,\n \n ```\n-yarn bazel test //integration:bazel_test\n-yarn bazel test //integration:bazel-schematics_test\n+yarn bazel test //integration/bazel:test\n+yarn bazel test //integration/cli-hello-world-ivy-minimal:test\n ```\n \n ## Adding a new integration test\n \n When adding a new integration test, follow the steps below to add a bazel test target for the new test.\n \n-1. Add new test to `INTEGRATION_TESTS` object in `/integration/BUILD.bazel` (and tag as `\"view-engine-only\"` if not meant to be run against ivy bundles).\n-2. If test requires ports and does not support ethereal ports then make sure the port is unique and add it to the \"manually configured ports\" comment to document which port it is using\n+1. Add a build file using the `ng_integration_test` rule from `//integration:index.bzl`.\n+2. If test requires ports and does not support ethereal ports then make sure the port is unique and add it to the \"manually configured ports\" section to document which port it is using\n 3. Add at least the following two entries `.bazelignore` (as they may contain BUILD files)\n    1. `integration/new_test/node_modules`\n    2. `integration/new_test/.yarn_local_cache`\n 4. Add any other untracked folders to `.bazelignore` that may contain `BUILD` files\n-5. If there are tracked BUILD files in the integration test folder (`integration/bazel` has these for example) add those folders to the `build --deleted_packages` and `query --deleted_packages` lines in `.bazelrc`\n+5. If there are BUILD files in the integration test folder (except for the top-level one defining the test), add those folders to the `--deleted_packages` in the `.bazelrc`. An example is the `bazel` integration test.\n+\n+## Manually configured ports\n+\n+Some integration ports must be managed manually to be unique and in other\n+cases the tests are able to select a random free port.\n+\n+Where `ng e2e` is used we pass `ng e2e --port 0` which prompts the cli\n+to select a random free port for the e2e test. The protractor.conf is\n+automatically updated to use this port.\n+\n+Karma automatically finds a free port so no effort is needed there.\n+\n+The manually configured ports are as follows:\n+\n+| TEST | PORT | CONFIGURATION |\n+| ---------------------------- | ---------------- | -------------------------------------- |\n+| dynamic-compiler             |      4201        | /e2e/browser.config.json: \"port\": 4201 |\n+| hello_world__closure         |      4202        | /e2e/browser.config.json: \"port\": 4202 |\n+| i18n                         |      4204        | /e2e/browser.config.json: \"port\": 4204 |\n+| ng_elements                  |      4205        | /e2e/browser.config.json: \"port\": 4205 |\n+| platform-server              |      4206        | /src/server.ts: app.listen(4206,...    |\n+\n+**Note**: This will become obsolete soon once we start running integration tests with RBE and within a sandbox environment.\n \n ## Browser tests\n \n-For integration tests we use the puppeteer provisioned version of Chrome. For both Karma and Protractor tests we set a number of browser testing flags. To avoid duplication, they will be listed and explained here and the code will reference this file for more information.\n+For integration tests we use the Bazel-managed versions of `chromium`. For both Karma and Protractor tests we set a number of browser testing flags. To avoid duplication, they will be listed and explained here and the code will reference this file for more information.\n \n ### No Sandbox: --no-sandbox\n \n@@ -144,9 +167,10 @@ See: https://stackoverflow.com/questions/50642308/webdriverexception-unknown-err\n \n If size regression occurs, one way to debug is to get a build which shows the code before and after. Here are the steps to do that.\n \n-1. Check out both the `master` branch as well as the your change (let's refer to it as `change` branch) into two different working locations. (A suggested way to do this is using `git worktree`.)\n+1. Check out both the `master` branch as well as your change (let's refer to it as `change` branch) into two different working locations. (A suggested way to do this is using `git worktree`.)\n 2. In both `master` and `change` locations update the failing tests `package.json` with `NG_BUILD_DEBUG_OPTIMIZE=minify` environment variable so that the resulting build would contain a human readable but optimized output. As an example:\n    - Open `integration/cli-hello-world/package.json` and prefix `NG_BUILD_DEBUG_OPTIMIZE=minify` into the `build` rule. Resulting in something like: `\"build\": \"NG_BUILD_DEBUG_OPTIMIZE=minify ng build --prod\",`\n-   - Run `bazel run //integration:cli-hello-world_test.debug` to build the output. (optionally just run `yarn build` in the directory if you want to do a quick rebuild which will only pick up changes to the test application (not framework).)\n+   - Run `bazel test //integration/cli-hello-world:test --test_output=streamed --cache_test_results=no` to run the test.\n+   - Open the test temporary directory as printed out by Bazel.\n    - Diff the `master` vs `change` to see the differences. `myDiffTool change/integration/cli-hello-world/dist/main-es2015.*.js master/integration/cli-hello-world/dist/main-es2015.*.js`\n    - The above should give you a better understanding as to what has changed and what is causing the regression.\n\\ No newline at end of file"
        },
        {
            "sha": "552a32d99ac22874f0a888c825824f875edcf47c",
            "filename": "integration/index.bzl",
            "status": "added",
            "additions": 142,
            "deletions": 0,
            "changes": 142,
            "blob_url": "https://github.com/angular/angular/blob/6c0905d7ab6310c4ad836069c0764c02b0cf882c/integration%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/6c0905d7ab6310c4ad836069c0764c02b0cf882c/integration%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Findex.bzl?ref=6c0905d7ab6310c4ad836069c0764c02b0cf882c",
            "patch": "@@ -0,0 +1,142 @@\n+# Copyright Google LLC All Rights Reserved.\n+#\n+# Use of this source code is governed by an MIT-style license that can be\n+# found in the LICENSE file at https://angular.io/license\n+\"\"\"Angular integration testing\n+\"\"\"\n+\n+load(\"//integration:npm_package_archives.bzl\", \"NPM_PACKAGE_ARCHIVES\", \"npm_package_archive_label\")\n+load(\"@npm//@angular/dev-infra-private/bazel/integration:index.bzl\", \"integration_test\")\n+\n+# The generated npm packages should ALWAYS be replaced in integration tests\n+# so we pass them to the `check_npm_packages` attribute of npm_integration_test\n+FRAMEWORK_PACKAGES = [\n+    \"@angular/animations\",\n+    \"@angular/bazel\",\n+    \"@angular/benchpress\",\n+    \"@angular/common\",\n+    \"@angular/compiler\",\n+    \"@angular/compiler-cli\",\n+    \"@angular/core\",\n+    \"@angular/elements\",\n+    \"@angular/forms\",\n+    \"@angular/language-service\",\n+    \"@angular/localize\",\n+    \"@angular/platform-browser\",\n+    \"@angular/platform-browser-dynamic\",\n+    \"@angular/platform-server\",\n+    \"@angular/router\",\n+    \"@angular/service-worker\",\n+    \"@angular/upgrade\",\n+    \"zone.js\",\n+]\n+\n+def _ng_integration_test(name, setup_chromium = False, **kwargs):\n+    \"Set defaults for the npm_integration_test common to the angular repo\"\n+    payload_size_tracking = kwargs.pop(\"payload_size_tracking\", [])\n+    pinned_npm_packages = kwargs.pop(\"pinned_npm_packages\", [])\n+    use_view_engine_packages = kwargs.pop(\"use_view_engine_packages\", [])\n+    toolchains = kwargs.pop(\"toolchains\", [])\n+    environment = kwargs.pop(\"environment\", {})\n+    data = kwargs.pop(\"data\", [])\n+\n+    data += [\n+        # The Yarn files also need to be part of the integration test as runfiles\n+        # because the `yarn_bin` target is not a self-contained standalone binary.\n+        \"@nodejs//:yarn_files\",\n+    ]\n+\n+    if setup_chromium:\n+        data += [\"@npm//@angular/dev-infra-private/bazel/browsers/chromium\"]\n+        toolchains += [\"@npm//@angular/dev-infra-private/bazel/browsers/chromium:toolchain_alias\"]\n+        environment.update({\n+            \"CHROMEDRIVER_BIN\": \"$(CHROMEDRIVER)\",\n+            \"CHROME_BIN\": \"$(CHROMIUM)\",\n+        })\n+\n+    # By default run `yarn install` followed by `yarn test` using the tools linked\n+    # into the integration tests (using the `tool_mappings` attribute).\n+    commands = [\n+        \"yarn install --cache-folder ./.yarn_local_cache\",\n+        \"yarn test\",\n+    ]\n+\n+    command_type = kwargs.pop(\"commands\", \"default\")\n+\n+    if command_type == \"payload_size_tracking\":\n+        commands += [\n+            \"yarn build\",\n+            # TODO: Replace the track payload-size script with a RBE and Windows-compatible script.\n+            \"$(rootpath //:scripts/ci/track-payload-size.sh) %s dist/*.js true $${RUNFILES}/angular/$(rootpath //goldens:size-tracking/integration-payloads.json)\" % name,\n+        ]\n+        data += [\n+            \"//goldens:size-tracking/integration-payloads.json\",\n+            \"//:scripts/ci/track-payload-size.sh\",\n+            \"//:scripts/ci/payload-size.sh\",\n+            \"//:scripts/ci/payload-size.js\",\n+        ]\n+\n+    # Complete list of npm packages to override in the test's package.json file mapped to\n+    # tgz archive to use for the replacement. This is the full list for all integration\n+    # tests. Any given integration does not need to use all of these packages.\n+    npm_packages = {}\n+    for pkg in NPM_PACKAGE_ARCHIVES:\n+        if pkg not in pinned_npm_packages:\n+            npm_packages[\"@npm//:\" + npm_package_archive_label(pkg)] = pkg\n+    for pkg in FRAMEWORK_PACKAGES:\n+        # If the generated Angular framework package is listed in the `use_view_engine_packages`\n+        # list, we will not use the local-built NPM package, but instead map to the\n+        # corresponding View Engine v12.x package from the `@npm//` workspace.\n+        if pkg in use_view_engine_packages:\n+            npm_packages[\"@npm//:\" + npm_package_archive_label(\"%s-12\" % pkg)] = pkg\n+        else:\n+            last_segment_name = pkg.split(\"/\")[-1]\n+            npm_packages[\"//packages/%s:npm_package_archive\" % last_segment_name] = pkg\n+\n+    integration_test(\n+        name = name,\n+        commands = commands,\n+        npm_packages = npm_packages,\n+        tags = kwargs.pop(\"tags\", []) + [\n+            # `integration` tag is used for filtering out these tests from the normal\n+            # developer workflow\n+            \"integration\",\n+            # Integration tests do not work inside of a sandbox as they may run host applications such\n+            # as chrome (which is run by ng) that require access to files outside of the sandbox.\n+            \"no-sandbox\",\n+            # Remote doesn't work as it needs network access right now\n+            \"no-remote-exec\",\n+        ],\n+        data = data,\n+        environment = environment,\n+        toolchains = toolchains,\n+        tool_mappings = {\n+            \"@nodejs//:yarn_bin\": \"yarn\",\n+            \"@nodejs//:node_bin\": \"node\",\n+        },\n+        # 15-minute timeout\n+        timeout = \"long\",\n+        # Tells bazel that this test should be allocated a large amount of memory.\n+        # See https://docs.bazel.build/versions/2.0.0/be/common-definitions.html#common-attributes-tests.\n+        size = \"enormous\",\n+        **kwargs\n+    )\n+\n+def ng_integration_test(name, **kwargs):\n+    \"Sets up the integration test target based on the test folder name\"\n+\n+    native.filegroup(\n+        name = \"_%s_sources\" % name,\n+        srcs = native.glob(\n+            include = [\"**/*\"],\n+            exclude = [\n+                \"node_modules/**\",\n+                \".yarn_local_cache/**\",\n+            ],\n+        ),\n+    )\n+    _ng_integration_test(\n+        name = name,\n+        srcs = kwargs.pop(\"srcs\", [\"_%s_sources\" % name]),\n+        **kwargs\n+    )"
        },
        {
            "sha": "7819f6993aec732bec4f15397de662220082b1bf",
            "filename": "integration/npm_package_archives.bzl",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/6c0905d7ab6310c4ad836069c0764c02b0cf882c/integration%2Fnpm_package_archives.bzl",
            "raw_url": "https://github.com/angular/angular/raw/6c0905d7ab6310c4ad836069c0764c02b0cf882c/integration%2Fnpm_package_archives.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fnpm_package_archives.bzl?ref=6c0905d7ab6310c4ad836069c0764c02b0cf882c",
            "patch": "@@ -0,0 +1,59 @@\n+# The @npm packages at the root node_modules are used by integration tests\n+# with `file:../../node_modules/foobar` references\n+NPM_PACKAGE_ARCHIVES = [\n+    \"@angular/animations-12\",\n+    \"@angular/common-12\",\n+    \"@angular/core-12\",\n+    \"@angular/forms-12\",\n+    \"@angular/platform-browser-12\",\n+    \"@angular/platform-browser-dynamic-12\",\n+    \"@angular/platform-server-12\",\n+    \"@angular/router-12\",\n+    \"@babel/core\",\n+    \"@rollup/plugin-babel\",\n+    \"@rollup/plugin-node-resolve\",\n+    \"@rollup/plugin-commonjs\",\n+    \"check-side-effects\",\n+    \"core-js\",\n+    \"google-closure-compiler\",\n+    \"jasmine\",\n+    \"typescript\",\n+    \"rxjs\",\n+    \"systemjs\",\n+    \"tsickle\",\n+    \"tslib\",\n+    \"protractor\",\n+    \"terser\",\n+    \"puppeteer\",\n+    \"rollup\",\n+    \"rollup-plugin-sourcemaps\",\n+    \"webdriver-manager\",\n+    \"@angular/cli\",\n+    \"@angular-devkit/build-angular\",\n+    \"@bazel/bazelisk\",\n+    \"@types/jasmine\",\n+    \"@types/jasminewd2\",\n+    \"@types/node\",\n+]\n+\n+def npm_package_archive_label(package_name):\n+    return package_name.replace(\"/\", \"_\").replace(\"@\", \"\") + \"_archive\"\n+\n+def npm_package_archives():\n+    \"\"\"Function to generate pkg_tar definitions for WORKSPACE yarn_install manual_build_file_contents\"\"\"\n+    npm_packages_to_archive = NPM_PACKAGE_ARCHIVES\n+    result = \"\"\"load(\"@rules_pkg//:pkg.bzl\", \"pkg_tar\")\n+\"\"\"\n+    for name in npm_packages_to_archive:\n+        label_name = npm_package_archive_label(name)\n+        last_segment_name = name.split(\"/\")[-1]\n+        result += \"\"\"pkg_tar(\n+    name = \"{label_name}\",\n+    srcs = [\"//{name}:{last_segment_name}__all_files\"],\n+    extension = \"tar.gz\",\n+    strip_prefix = \"/external/npm/node_modules/{name}\",\n+    # should not be built unless it is a dependency of another rule\n+    tags = [\"manual\"],\n+)\n+\"\"\".format(name = name, label_name = label_name, last_segment_name = last_segment_name)\n+    return result"
        },
        {
            "sha": "32087372e7fdc69239a550e01cbde3dc01177d74",
            "filename": "tools/npm_integration_test/BUILD.bazel",
            "status": "removed",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/6add6a097d1b5680e5833bea70906bfededd956b/tools%2Fnpm_integration_test%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/6add6a097d1b5680e5833bea70906bfededd956b/tools%2Fnpm_integration_test%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fnpm_integration_test%2FBUILD.bazel?ref=6add6a097d1b5680e5833bea70906bfededd956b",
            "patch": "@@ -1,3 +0,0 @@\n-package(default_visibility = [\"//visibility:public\"])\n-\n-exports_files([\"test_runner.js\"])"
        },
        {
            "sha": "23ad5ead5901bc54c02d5c20aee051509551007c",
            "filename": "tools/npm_integration_test/npm_integration_test.bzl",
            "status": "removed",
            "additions": 0,
            "deletions": 198,
            "changes": 198,
            "blob_url": "https://github.com/angular/angular/blob/6add6a097d1b5680e5833bea70906bfededd956b/tools%2Fnpm_integration_test%2Fnpm_integration_test.bzl",
            "raw_url": "https://github.com/angular/angular/raw/6add6a097d1b5680e5833bea70906bfededd956b/tools%2Fnpm_integration_test%2Fnpm_integration_test.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fnpm_integration_test%2Fnpm_integration_test.bzl?ref=6add6a097d1b5680e5833bea70906bfededd956b",
            "patch": "@@ -1,198 +0,0 @@\n-\"\"\"Npm integration testing\n-\"\"\"\n-\n-load(\"@build_bazel_rules_nodejs//:index.bzl\", \"nodejs_test\")\n-\n-# Returns the manifest path of a file: `workspace/path/to/file`\n-def _to_manifest_path(ctx, file):\n-    if file.short_path.startswith(\"../\"):\n-        # Strip the ../ from short_path to external repository\n-        return file.short_path[3:]\n-    else:\n-        # Add the repository name for short_path to local repository\n-        return ctx.workspace_name + \"/\" + file.short_path\n-\n-def _npm_integration_test_config_impl(ctx):\n-    if len(ctx.files.test_files) == 0:\n-        fail(\"No files were found to run under integration testing.\")\n-\n-    if ctx.attr.debug:\n-        for f in ctx.files.test_files:\n-            if f.is_directory:\n-                fail(\"In debug mode, directory test_files labels not supported.\")\n-\n-    commands = []\n-    for c in ctx.attr.commands:\n-        commands.append(ctx.expand_location(c, targets = ctx.attr.data))\n-\n-    # pass --define vars to test; these are added to the environment using process.env().\n-    env_vars = {}\n-    for k in ctx.attr.configuration_env_vars:\n-        if k in ctx.var.keys():\n-            env_vars[k] = ctx.var[k]\n-\n-    # Serialize configuration file for test runner\n-    ctx.actions.write(\n-        output = ctx.outputs.config,\n-        content = \"\"\"// npm_integration_test runner config generated by npm_integration_test rule\n-module.exports = {{\n-    testFiles: [ {TMPL_test_files} ],\n-    commands: [ {TMPL_commands} ],\n-    npmPackages: {{ {TMPL_npm_packages} }},\n-    checkNpmPackages: [ {TMPL_check_npm_packages} ],\n-    envVars: {{ {TMPL_env_vars} }},\n-    debug: {TMPL_debug},\n-}};\n-\"\"\".format(\n-            TMPL_test_files = \", \".join([\"'%s'\" % f.short_path for f in ctx.files.test_files]),\n-            TMPL_commands = \", \".join([\"'%s'\" % s for s in commands]),\n-            TMPL_npm_packages = \", \".join([\"'%s': '%s'\" % (ctx.attr.npm_packages[n], n.files.to_list()[0].short_path) for n in ctx.attr.npm_packages]),\n-            TMPL_check_npm_packages = \", \".join([\"'%s'\" % s for s in ctx.attr.check_npm_packages]),\n-            TMPL_env_vars = \", \".join([\"'%s': '%s'\" % (k, env_vars[k]) for k in env_vars]),\n-            TMPL_debug = \"true\" if ctx.attr.debug else \"false\",\n-        ),\n-    )\n-\n-    runfiles = [ctx.outputs.config] + ctx.files.test_files + ctx.files.npm_packages\n-\n-    return [DefaultInfo(runfiles = ctx.runfiles(files = runfiles))]\n-\n-_NPM_INTEGRATION_TEST_CONFIG_ATTRS = {\n-    \"commands\": attr.string_list(\n-        default = [],\n-        mandatory = True,\n-        doc = \"\"\"The list of test commands to run. Defaults to `[]`.\"\"\",\n-    ),\n-    \"configuration_env_vars\": attr.string_list(\n-        doc = \"\"\"Pass these configuration environment variables to the resulting test.\n-        Chooses a subset of the configuration environment variables (taken from `ctx.var`), which also\n-        includes anything specified via the --define flag.\n-        Note, this can lead to different results for the test.\"\"\",\n-        default = [],\n-    ),\n-    \"check_npm_packages\": attr.string_list(\n-        doc = \"\"\"A list of npm packages that should be replaced in this test.\n-\n-This attribute checks that none of the npm packages lists is found in the workspace-under-test's\n-package.json file unlinked to a generated npm package.\n-\n-This can be used to verify that all npm package artifacts that need to be tested against are indeed\n-replaced in all integration tests. For example,\n-```\n-check_npm_packages = [\n-    \"@angular/common\",\n-    \"@angular/compiler\",\n-    \"@angular/compiler-cli\",\n-    \"@angular/core\",\n-],\n-```\n-If an `npm_packages` replacement on any package listed is missed then the test will fail. Since listing all\n-npm packages in `npm_packages` is expensive as any change will result in all integration tests re-running,\n-this attribute allows a fine grained `npm_packages` per integration test with the added safety that none\n-are missed for any one test.\n-\"\"\",\n-    ),\n-    \"data\": attr.label_list(\n-        doc = \"\"\"Data dependencies for test.\"\"\",\n-        allow_files = True,\n-    ),\n-    \"debug\": attr.bool(\n-        doc = \"\"\"Setup the test for debugging.\n-\n-If set to true then the package.json replacement are done in-place instead of a tmp folder\n-and the test is not run. This is used to configure the test folder for local testing and debugging.\n-\"\"\",\n-        default = False,\n-    ),\n-    \"npm_packages\": attr.label_keyed_string_dict(\n-        doc = \"\"\"A label keyed string dictionary of npm package replacements to make in the workspace-under-test's\n-package.json with npm package targets. The targets should be pkg_tar tar.gz archives.\n-\n-For example,\n-```\n-npm_packages = {\n-    \"//packages/common:npm_package_archive\": \"@angular/common\",\n-    \"//packages/compiler:npm_package_archive\": \"@angular/compiler\",\n-    \"//packages/compiler-cli:npm_package_archive\": \"@angular/compiler-cli\",\n-    \"//packages/core:npm_package_archive\": \"@angular/core\",\n-}\n-```\"\"\",\n-        allow_files = True,\n-    ),\n-    \"test_files\": attr.label(\n-        doc = \"\"\"A filegroup of all files necessary to run the test.\"\"\",\n-        allow_files = True,\n-    ),\n-}\n-\n-_npm_integration_test_config = rule(\n-    implementation = _npm_integration_test_config_impl,\n-    doc = \"\"\"Generates an npm_integration_test config.\"\"\",\n-    attrs = _NPM_INTEGRATION_TEST_CONFIG_ATTRS,\n-    outputs = {\n-        \"config\": \"%{name}.js\",\n-    },\n-)\n-\n-def npm_integration_test(name, **kwargs):\n-    \"\"\"Runs an npm integration test.\n-\n-    See _NPM_INTEGRATION_TEST_CONFIG_ATTRS above for configuration arguments.\n-    \"\"\"\n-    commands = kwargs.pop(\"commands\", [])\n-    configuration_env_vars = kwargs.pop(\"configuration_env_vars\", [])\n-    check_npm_packages = kwargs.pop(\"check_npm_packages\", [])\n-    npm_packages = kwargs.pop(\"npm_packages\", {})\n-    test_files = kwargs.pop(\"test_files\", [])\n-    data = kwargs.pop(\"data\", [])\n-\n-    _npm_integration_test_config(\n-        name = name + \".config\",\n-        commands = commands,\n-        configuration_env_vars = configuration_env_vars,\n-        check_npm_packages = check_npm_packages,\n-        data = data,\n-        npm_packages = npm_packages,\n-        test_files = test_files,\n-        visibility = [\"//visibility:private\"],\n-        tags = [\"manual\"],\n-        testonly = True,\n-    )\n-\n-    # Config for debug target below\n-    _npm_integration_test_config(\n-        name = name + \".debug.config\",\n-        commands = commands,\n-        configuration_env_vars = configuration_env_vars,\n-        check_npm_packages = check_npm_packages,\n-        data = data,\n-        npm_packages = npm_packages,\n-        test_files = test_files,\n-        debug = True,\n-        visibility = [\"//visibility:private\"],\n-        tags = [\"manual\"],\n-        testonly = True,\n-    )\n-\n-    tags = kwargs.pop(\"tags\", [])\n-    npm_deps = [\"@npm//tmp\", \"@npm//@bazel/runfiles\"]\n-\n-    nodejs_test(\n-        name = name,\n-        data = data + npm_deps + [\":%s.config\" % name, \":%s.config.js\" % name],\n-        tags = tags,\n-        templated_args = [\"$(rootpath :%s.config.js)\" % name],\n-        entry_point = \"//tools/npm_integration_test:test_runner.js\",\n-        **kwargs\n-    )\n-\n-    # Setup a .debug target that sets the debug attribute to True.\n-    # This target must be run with `bazel run` so it is tagged manual.\n-    nodejs_test(\n-        name = name + \".debug\",\n-        data = data + npm_deps + [\":%s.debug.config\" % name, \":%s.debug.config.js\" % name],\n-        tags = tags + [\"manual\", \"local\"],\n-        templated_args = [\"$(rootpath :%s.debug.config.js)\" % name],\n-        entry_point = \"//tools/npm_integration_test:test_runner.js\",\n-        **kwargs\n-    )"
        },
        {
            "sha": "d676c0274f29f5827ad312c04d19506bed5c3b49",
            "filename": "tools/npm_integration_test/test_runner.js",
            "status": "removed",
            "additions": 0,
            "deletions": 391,
            "changes": 391,
            "blob_url": "https://github.com/angular/angular/blob/6add6a097d1b5680e5833bea70906bfededd956b/tools%2Fnpm_integration_test%2Ftest_runner.js",
            "raw_url": "https://github.com/angular/angular/raw/6add6a097d1b5680e5833bea70906bfededd956b/tools%2Fnpm_integration_test%2Ftest_runner.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fnpm_integration_test%2Ftest_runner.js?ref=6add6a097d1b5680e5833bea70906bfededd956b",
            "patch": "@@ -1,391 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-const spawnSync = require('child_process').spawnSync;\n-const fs = require('fs');\n-const path = require('path');\n-const tmp = require('tmp');\n-const {runfiles} = require('@bazel/runfiles');\n-\n-const VERBOSE_LOGS = !!process.env['VERBOSE_LOGS'];\n-\n-// Set to true if you want the /tmp folder created to persist after running `bazel test`\n-const KEEP_TMP = false;\n-\n-// bazelisk requires a $HOME environment variable for its cache\n-process.env['HOME'] = tmp.dirSync({keep: KEEP_TMP, unsafeCleanup: !KEEP_TMP}).name;\n-\n-function fail(...m) {\n-  console.error();\n-  console.error(`[${path.basename(__filename)}]`);\n-  console.error('error:', ...m);\n-  console.error();\n-  process.exit(1);\n-}\n-\n-function log(...m) {\n-  console.error(`[${path.basename(__filename)}]`, ...m);\n-}\n-\n-function log_verbose(...m) {\n-  if (VERBOSE_LOGS) log(...m);\n-}\n-\n-/**\n- * Create a new directory and any necessary subdirectories\n- * if they do not exist.\n- */\n-function mkdirp(p) {\n-  if (!fs.existsSync(p)) {\n-    mkdirp(path.dirname(p));\n-    fs.mkdirSync(p);\n-  }\n-}\n-\n-/**\n- * Checks if a given path exists and is a file.\n- * Note: fs.statSync() is used which resolves symlinks.\n- */\n-function isFile(p) {\n-  return fs.existsSync(p) && fs.statSync(p).isFile();\n-}\n-\n-/**\n- * Check if a given path is an executable file.\n- */\n-function isExecutable(p) {\n-  try {\n-    fs.accessSync(p, fs.constants.X_OK);\n-    return true;\n-  } catch {\n-    return false;\n-  }\n-}\n-\n-/**\n- * Given two arrays returns the longest common slice.\n- */\n-function commonSlice(a, b) {\n-  const p = a.length < b.length ? [a, b] : [b, a];\n-  for (let i = 0; i < p[0].length; ++i) {\n-    if (p[0][i] !== p[1][i]) {\n-      return p[0].slice(0, i);\n-    }\n-  }\n-  return p[0];\n-}\n-\n-/**\n- * Given a list of files, the root directory is returned\n- */\n-function rootDirectory(files) {\n-  let root = path.dirname(files[0]).replace(/\\\\/g, '/').split('/');\n-  for (f of files) {\n-    root = commonSlice(root, path.dirname(f).replace(/\\\\/g, '/').split('/'));\n-    if (!root.length) break;\n-  }\n-  if (!root.length) {\n-    fail(`not all test files are under the same root!`);\n-  }\n-  return root.join('/');\n-}\n-\n-/**\n- * Utility function to copy a list of files under a common root to a destination folder.\n- */\n-function copy(files, root, to) {\n-  for (src of files) {\n-    if (!src.startsWith(root)) {\n-      fail(`file to copy ${src} is not under root ${root}`);\n-    }\n-    if (isFile(src)) {\n-      const rel = src.slice(root.length + 1);\n-      if (rel.startsWith('node_modules/')) {\n-        // don't copy nested node_modules\n-        continue;\n-      }\n-      const dest = `${to}/${rel}`;\n-      mkdirp(path.dirname(dest));\n-      fs.copyFileSync(src, dest);\n-      // Set file permissions to set for files copied to tmp folders.\n-      // These are needed as files copied out of bazel-bin will have\n-      // restrictive permissions that may break tests.\n-      fs.chmodSync(dest, isExecutable(src) ? '755' : '644');\n-      log_verbose(`copied file ${src} -> ${dest}`);\n-    } else {\n-      fail('directories in test_files not supported');\n-    }\n-  }\n-  return to;\n-}\n-\n-/**\n- * Utility function to copy a list of files to a tmp folder based on their common root.\n- */\n-function copyToTmp(files) {\n-  const resolved = files.map(f => runfiles.resolveWorkspaceRelative(f));\n-  return copy(\n-      resolved, rootDirectory(resolved),\n-      tmp.dirSync({keep: KEEP_TMP, unsafeCleanup: !KEEP_TMP}).name);\n-}\n-\n-/**\n- * Expands environment variables in a string of the form ${FOO_BAR}.\n- */\n-function expandEnv(s) {\n-  if (!s) return s;\n-  const reg = /\\$\\{(\\w+)\\}/g;\n-  return s.replace(reg, (matched) => {\n-    const varName = matched.substring(2, matched.length - 1);\n-    if (process.env.hasOwnProperty(varName)) {\n-      return process.env[varName];\n-    } else {\n-      throw `Failed to expand unbound environment variable '${varName}' in '${s}'`;\n-    }\n-  });\n-}\n-\n-/**\n- * TestRunner handles setting up the integration test and executing\n- * the test commands based on the config.\n- */\n-class TestRunner {\n-  constructor(config) {\n-    this.config = config;\n-    this.successful = 0;\n-    this._setupTestFiles();\n-    this._writeNpmPackageManifest();\n-  }\n-\n-  /**\n-   * Run all test commands in the integration test.\n-   * Returns on first failure.\n-   */\n-  run() {\n-    for (const command of this.config.commands) {\n-      // TODO: handle a quoted binary path that contains a space such as \"/path to/binary\"\n-      //       and quoted arguments that contain spaces\n-      const split = command.split(' ');\n-      let binary = split[0];\n-      const args = split.slice(1).map(a => expandEnv(a));\n-      switch (binary) {\n-        case 'patch-package-json': {\n-          let packageJsonFile = 'package.json';\n-          if (args.length > 0) {\n-            packageJsonFile = args[0];\n-          }\n-          log(`running test command ${this.successful + 1} of ${\n-              this.config.commands.length}: patching '${packageJsonFile}' in '${this.testRoot}'`);\n-          this._patchPackageJson(packageJsonFile);\n-        } break;\n-\n-        default: {\n-          if (binary.startsWith('external/')) {\n-            binary = `../${binary.substring('external/'.length)}`;\n-          }\n-          try {\n-            // Attempt to resolve runfiles location if command is expected to\n-            // be in runfiles. For example, $(rootpath @nodejs//:yarn_bin)\n-            const runfilesBinary = runfiles.resolveWorkspaceRelative(binary);\n-            binary = (runfilesBinary && fs.existsSync(runfilesBinary)) ? runfilesBinary : binary;\n-          } catch (e) {\n-            // If resolveWorkspaceRelative then command is likely a built-in\n-            // such as 'mkdir' or 'rm'\n-          }\n-          log(`running test command ${this.successful + 1} of ${this.config.commands.length}: '${\n-              binary} ${args.join(' ')}' in '${this.testRoot}'`);\n-          const spawnedProcess = spawnSync(binary, args, {cwd: this.testRoot, stdio: 'inherit'});\n-          if (spawnedProcess.error) {\n-            fail(`test command ${testRunner.successful + 1} '${binary} ${\n-                args.join(' ')}' failed with ${spawnedProcess.error.code}`);\n-          }\n-          if (spawnedProcess.status) {\n-            log(`test command ${testRunner.successful + 1} '${binary} ${\n-                args.join(' ')}' failed with status code ${spawnedProcess.status}`);\n-            return spawnedProcess.status;\n-          }\n-        }\n-      }\n-      this.successful++;\n-    }\n-    return 0;\n-  }\n-\n-  /**\n-   * @internal\n-   *\n-   * Patch the specified package.json file with the npmPackages passed in the config.\n-   */\n-  _patchPackageJson(packageJsonFile) {\n-    const packageJson = `${this.testRoot}/${packageJsonFile}`;\n-    if (!isFile(packageJson)) {\n-      fail(`no ${packageJsonFile} file found at test root ${this.testRoot}`);\n-    }\n-    const contents = JSON.parse(fs.readFileSync(packageJson, {encoding: 'utf-8'}));\n-    let replacements = 0;\n-    // replace npm packages\n-    for (const key of Object.keys(this.config.npmPackages)) {\n-      const path = runfiles.resolveWorkspaceRelative(this.config.npmPackages[key]);\n-      const replacement = `file:${path}`;\n-      if (contents.dependencies && contents.dependencies[key]) {\n-        replacements++;\n-        contents.dependencies[key] = replacement;\n-        log(`overriding dependencies['${key}'] npm package with 'file:${\n-            path}' in package.json file`);\n-      }\n-      if (contents.devDependencies && contents.devDependencies[key]) {\n-        replacements++;\n-        contents.devDependencies[key] = replacement;\n-        log(`overriding devDependencies['${key}'] npm package with 'file:${\n-            path}' in package.json file`);\n-      }\n-      if (contents.resolutions && contents.resolutions[key]) {\n-        replacements++;\n-        contents.resolutions[key] = replacement;\n-        log(`overriding resolutions['${key}'] npm package with 'file:${\n-            path}' in package.json file`);\n-      }\n-      // TODO: handle other formats for resolutions such as `some-package/${key}` or\n-      // `some-package/**/${key}`\n-      const altKey = `**/${key}`;\n-      if (contents.resolutions && contents.resolutions[altKey]) {\n-        replacements++;\n-        contents.resolutions[altKey] = replacement;\n-        log(`overriding resolutions['${altKey}'] npm package with 'file:${\n-            path}' in package.json file`);\n-      }\n-    }\n-    // check packages that must be replaced\n-    const failedPackages = [];\n-    for (const key of this.config.checkNpmPackages) {\n-      if (contents.dependencies && contents.dependencies[key] &&\n-          (!contents.dependencies[key].startsWith('file:') ||\n-           contents.dependencies[key].startsWith('file:.'))) {\n-        failedPackages.push(key);\n-      } else if (\n-          contents.devDependencies && contents.devDependencies[key] &&\n-          (!contents.devDependencies[key].startsWith('file:') ||\n-           contents.devDependencies[key].startsWith('file:.'))) {\n-        failedPackages.push(key);\n-      }\n-    }\n-    const contentsEncoded = JSON.stringify(contents, null, 2);\n-    log(`package.json file:\\n${contentsEncoded}`);\n-    if (failedPackages.length) {\n-      fail(`expected replacements of npm packages ${\n-          JSON.stringify(failedPackages)} not found; add these to the npm_packages attribute`);\n-    }\n-    if (replacements) {\n-      fs.writeFileSync(packageJson, contentsEncoded);\n-    }\n-  }\n-\n-  /**\n-   * @internal\n-   *\n-   * Copy all the test files to a tmp folder so they are sandboxed for the test\n-   * and so that changes made to source files such as patching package.json\n-   * do not persist in the user's workspace.\n-   *\n-   * In debug mode, do not copy any file but set the testRoot to the user's workspace.\n-   */\n-  _setupTestFiles() {\n-    if (!this.config.testFiles.length) {\n-      fail(`no test files`);\n-    }\n-    if (this.config.debug) {\n-      // Setup the test in the test files root directory\n-      const root = rootDirectory(this.config.testFiles);\n-      if (path.isAbsolute(root)) {\n-        fail(`root directory of Bazel test files should not be an absolute path but got '${root}'`);\n-      }\n-      if (root.startsWith(`../`)) {\n-        fail(`debug mode only available with test files in the root workspace`);\n-      }\n-      let workspaceDirectory = process.env['BUILD_WORKSPACE_DIRECTORY'];\n-      if (!workspaceDirectory) {\n-        // bazel test\n-        const runfilesPath = process.env['RUNFILES'];\n-        if (!runfilesPath) {\n-          fail(`RUNFILES environment variable is not set`);\n-        }\n-        // read the contents of the output_base/DO_NOT_BUILD_HERE file to get\n-        // the workspace directory\n-        const index = runfilesPath.search(/[\\\\/]execroot[\\\\/]/);\n-        if (index === -1) {\n-          fail(`no /execroot/ in runfiles path`);\n-        }\n-        const outputBase = runfilesPath.substr(0, index);\n-        workspaceDirectory =\n-            fs.readFileSync(`${outputBase}/DO_NOT_BUILD_HERE`, {encoding: 'utf-8'});\n-      }\n-      this.testRoot = `${workspaceDirectory}/${root}`;\n-      log(`configuring test in-place under ${this.testRoot}`);\n-    } else {\n-      this.testRoot = copyToTmp(this.config.testFiles);\n-      log(`test files from '${rootDirectory(this.config.testFiles)}' copied to tmp folder ${\n-          this.testRoot}`);\n-    }\n-  }\n-\n-  /**\n-   * @internal\n-   *\n-   * Write an NPM_PACKAGE_MANIFEST.json file to the test root with a mapping of\n-   * the npm package mappings for this this test. Integration tests can opt\n-   * to use this mappings file instead of the built-in `patch-package-json`\n-   * command.\n-   */\n-  _writeNpmPackageManifest() {\n-    if (!this.testRoot) {\n-      fail(`test files not yet setup`);\n-    }\n-    const manifest = {};\n-    for (const key of Object.keys(this.config.npmPackages)) {\n-      manifest[key] = runfiles.resolveWorkspaceRelative(this.config.npmPackages[key]);\n-    }\n-    const manifestPath = `${this.testRoot}/NPM_PACKAGE_MANIFEST.json`;\n-    fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));\n-    log(`npm package manifest written to ${manifestPath}`);\n-  }\n-}\n-\n-const config = require(runfiles.resolveWorkspaceRelative(process.argv[2]));\n-\n-// set env vars passed from --define\n-for (const k of Object.keys(config.envVars)) {\n-  const v = config.envVars[k];\n-  process.env[k] = v;\n-  log_verbose(`set environment variable ${k}='${v}'`);\n-}\n-\n-log_verbose(`env: ${JSON.stringify(process.env, null, 2)}`);\n-log_verbose(`config: ${JSON.stringify(config, null, 2)}`);\n-log(`running in ${process.cwd()}`);\n-\n-const testRunner = new TestRunner(config);\n-const result = testRunner.run();\n-log(`${testRunner.successful} of ${config.commands.length} test commands successful`);\n-if (result) {\n-  if (!config.debug) {\n-    log(`to run this integration test in debug mode:\n-\n-    bazel run ${process.env['TEST_TARGET']}.debug\n-\n-in debug mode the integration test will be run out of the workspace folder`);\n-  }\n-}\n-if (config.debug) {\n-  log(`this integration test may be re-run manually from the '${testRunner.testRoot}' folder\n-\n-for example,\n-\n-    cd ${testRunner.testRoot}\n-    yarn test`);\n-}\n-process.exit(result);"
        }
    ],
    "stats": {
        "total": 956,
        "additions": 234,
        "deletions": 722
    }
}