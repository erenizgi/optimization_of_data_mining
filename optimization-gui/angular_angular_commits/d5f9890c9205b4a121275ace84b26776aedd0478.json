{
    "author": "ivanwonder",
    "message": "feat(language-service): auto-apply optional chaining on nullable symbol (#42995)\n\nSupport automatically inserts the optional chaining operator (`?.`)\nwhen property access (`.`) is done on a nullable symbol.\n\nFixes https://github.com/angular/vscode-ng-language-service/issues/1094\n\nPR Close #42995",
    "sha": "d5f9890c9205b4a121275ace84b26776aedd0478",
    "files": [
        {
            "sha": "a44a6e73e8162d56f5b1863e9e8ab1bf20fe1045",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/d5f9890c9205b4a121275ace84b26776aedd0478/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/d5f9890c9205b4a121275ace84b26776aedd0478/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=d5f9890c9205b4a121275ace84b26776aedd0478",
            "patch": "@@ -8,7 +8,7 @@\n \n import {AST, BindingPipe, EmptyExpr, ImplicitReceiver, LiteralPrimitive, MethodCall, ParseSourceSpan, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstText, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n-import {CompletionKind, DirectiveInScope, TemplateDeclarationSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import {CompletionKind, DirectiveInScope, SymbolKind, TemplateDeclarationSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import {BoundEvent, TextAttribute} from '@angular/compiler/src/render3/r3_ast';\n import * as ts from 'typescript';\n \n@@ -198,8 +198,8 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n         this.node.receiver instanceof ImplicitReceiver) {\n       return this.getGlobalPropertyExpressionCompletion(options);\n     } else {\n-      const location = this.compiler.getTemplateTypeChecker().getExpressionCompletionLocation(\n-          this.node, this.component);\n+      const location =\n+          this.templateTypeChecker.getExpressionCompletionLocation(this.node, this.component);\n       if (location === null) {\n         return undefined;\n       }\n@@ -211,6 +211,23 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n \n       const replacementSpan = makeReplacementSpanFromAst(this.node);\n \n+      if (!(this.node.receiver instanceof ImplicitReceiver) &&\n+          options?.includeCompletionsWithInsertText &&\n+          options.includeAutomaticOptionalChainCompletions !== false) {\n+        const symbol = this.templateTypeChecker.getSymbolOfNode(this.node.receiver, this.component);\n+        if (symbol?.kind === SymbolKind.Expression) {\n+          const type = symbol.tsType;\n+          const nonNullableType = this.typeChecker.getNonNullableType(type);\n+          if (type !== nonNullableType && replacementSpan !== undefined) {\n+            // Shift the start location back one so it includes the `.` of the property access.\n+            // In combination with the options above, this will indicate to the TS LS to include\n+            // optional chaining completions `?.` for nullable types.\n+            replacementSpan.start--;\n+            replacementSpan.length++;\n+          }\n+        }\n+      }\n+\n       let ngResults: ts.CompletionEntry[] = [];\n       for (const result of tsResults.entries) {\n         ngResults.push({"
        },
        {
            "sha": "af9b3b948eba358f5c3b8b44731a505f52a04fbf",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/d5f9890c9205b4a121275ace84b26776aedd0478/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d5f9890c9205b4a121275ace84b26776aedd0478/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=d5f9890c9205b4a121275ace84b26776aedd0478",
            "patch": "@@ -818,8 +818,41 @@ describe('completions', () => {\n       expectReplacementText(completions, templateFile.contents, '42');\n     });\n   });\n+\n+  describe('auto-apply optional chaining', () => {\n+    it('should be able to complete on nullable symbol', () => {\n+      const {templateFile} = setup('{{article.title}}', `article?: { title: string };`);\n+      templateFile.moveCursorToText('{{article.title¦}}');\n+      const completions = templateFile.getCompletionsAtPosition({\n+        includeCompletionsWithInsertText: true,\n+        includeAutomaticOptionalChainCompletions: true,\n+      });\n+      expectContainInsertText(completions, ts.ScriptElementKind.memberVariableElement, ['?.title']);\n+      expectReplacementText(completions, templateFile.contents, '.title');\n+    });\n+\n+    it('should be able to complete on NonNullable symbol', () => {\n+      const {templateFile} = setup('{{article.title}}', `article: { title: string };`);\n+      templateFile.moveCursorToText('{{article.title¦}}');\n+      const completions = templateFile.getCompletionsAtPosition({\n+        includeCompletionsWithInsertText: true,\n+        includeAutomaticOptionalChainCompletions: true,\n+      });\n+      expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title']);\n+      expectReplacementText(completions, templateFile.contents, 'title');\n+    });\n+  });\n });\n \n+function expectContainInsertText(\n+    completions: ts.CompletionInfo|undefined, kind: ts.ScriptElementKind|DisplayInfoKind,\n+    insertTexts: string[]) {\n+  expect(completions).toBeDefined();\n+  for (const insertText of insertTexts) {\n+    expect(completions!.entries).toContain(jasmine.objectContaining({insertText, kind} as any));\n+  }\n+}\n+\n function expectContain(\n     completions: ts.CompletionInfo|undefined, kind: ts.ScriptElementKind|DisplayInfoKind,\n     names: string[]) {"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 53,
        "deletions": 3
    }
}