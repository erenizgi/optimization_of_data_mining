{
    "author": "crisbeto",
    "message": "fix(compiler): do not error if $any is used inside a listener (#43866)\n\nFixes that `$any` casts weren't being converted to statements inside listeners which resulted in a compiler error.\n\nFixes #43841.\n\nPR Close #43866",
    "sha": "c944fee11b27b5f487927cf23eea4d5f04bb4463",
    "files": [
        {
            "sha": "2ff3f0b9b9d9b1c6ffca4c69128b7325c55b52ac",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/c944fee11b27b5f487927cf23eea4d5f04bb4463/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c944fee11b27b5f487927cf23eea4d5f04bb4463/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=c944fee11b27b5f487927cf23eea4d5f04bb4463",
            "patch": "@@ -3557,6 +3557,23 @@ function allTests(os: string) {\n       expect(trim(jsContents)).toContain(trim(hostBindingsFn));\n     });\n \n+    it('should handle $any used inside a listener', () => {\n+      env.write('test.ts', `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          selector: 'test-cmp',\n+          template: '<div (click)=\"$any(123)\"></div>',\n+        })\n+        export class TestCmp {}\n+    `);\n+\n+      env.driveMain();\n+      expect(env.getContents('test.js'))\n+          .toContain(\n+              `ɵɵlistener(\"click\", function TestCmp_Template_div_click_0_listener() { return 123; });`);\n+    });\n+\n     it('should accept dynamic host attribute bindings', () => {\n       env.write('other.d.ts', `\n       export declare const foo: any;"
        },
        {
            "sha": "211be440aa13a44aac99faa79b79eaf5f2811bca",
            "filename": "packages/compiler/src/compiler_util/expression_converter.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/c944fee11b27b5f487927cf23eea4d5f04bb4463/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "raw_url": "https://github.com/angular/angular/raw/c944fee11b27b5f487927cf23eea4d5f04bb4463/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts?ref=c944fee11b27b5f487927cf23eea4d5f04bb4463",
            "patch": "@@ -610,8 +610,10 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n         throw new Error(`Invalid call to $any, expected 1 argument but received ${\n             convertedArgs.length || 'none'}`);\n       }\n-      return (convertedArgs[0] as o.Expression)\n-          .cast(o.DYNAMIC_TYPE, this.convertSourceSpan(ast.span));\n+      return convertToStatementIfNeeded(\n+          mode,\n+          (convertedArgs[0] as o.Expression)\n+              .cast(o.DYNAMIC_TYPE, this.convertSourceSpan(ast.span)));\n     }\n \n     const leftMostSafe = this.leftMostSafeNode(ast);"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 21,
        "deletions": 2
    }
}