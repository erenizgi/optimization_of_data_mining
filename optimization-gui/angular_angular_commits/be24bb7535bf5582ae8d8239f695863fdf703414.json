{
    "author": "gkalpak",
    "message": "ci: improve angular.io deployment process for the stable branch (#43963)\n\nPreviously, the stable branch was always deployed to the\n`v<X>-angular-io-site` Firebase site, which was connected to the\n`angular.io` domain. Whenever a new major version was released (and\nbecame the new stable version), the `angular.io` domain had to be\ndisconnected from the previous Firebase site and be connected to the new\n`v<Y>-angular-io-site` Firebase site. This was a manual process that\ninvolved making changes in the Firebase console and the DNS records.\n\nThis commit is part of a new process that reduces the manual steps as\nfollows:\n- A new `stable-angular-io-site` Firebase site is created.\n- The `angular.io` domain will be connected to that new Firebase site.\n- When deploying from the stable branch, we will deploy to both\n  `stable-angular-io-site` and `v<X>-angular-io-site`. In addition, the\n  deployment to `v<X>-angular-io-site` will update the Firebase config\n  file to redirect to `angular.io`.\n- When a new major version is released, we will start deploying from the\n  new stable branch to `stable-angular-io-site`, but there will be no\n  need to connect/disconnect the `angular.io` domain. Also,\n  `v<X>.angular.io` will stop redirecting to `angular.io` by means of\n  updating the Firebase config file (without requiring changes in the\n  Firebase console or DNS).\n\nPR Close #43963",
    "sha": "be24bb7535bf5582ae8d8239f695863fdf703414",
    "files": [
        {
            "sha": "a98d377aeaafc946370e4fad454ce7458713421b",
            "filename": "aio/scripts/deploy-to-firebase/index.mjs",
            "status": "modified",
            "additions": 70,
            "deletions": 9,
            "changes": 79,
            "blob_url": "https://github.com/angular/angular/blob/be24bb7535bf5582ae8d8239f695863fdf703414/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "raw_url": "https://github.com/angular/angular/raw/be24bb7535bf5582ae8d8239f695863fdf703414/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs?ref=be24bb7535bf5582ae8d8239f695863fdf703414",
            "patch": "@@ -3,6 +3,45 @@\n // WARNING: `CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN` should NOT be printed.\n //\n \n+/*\n+ * The following table summarizes the deployment targets per branch and RC phase (i.e. what Firebase\n+ * project/site each branch is deployed to and with what config/tweaks).\n+ *\n+ * For more details on each deployment target, see the `deploymentInfoPerTarget` object inside the\n+ * `computeDeploymentsInfo()` function.\n+ * For additional information/terminology, see also:\n+ *   - [Angular Branching and Versioning: A Practical Guide](../../../docs/BRANCHES.md)\n+ *   - [Angular Development Phases](https://docs.google.com/document/d/197kVillDwx-RZtSVOBtPb4BBIAw0E9RT3q3v6DZkykU)\n+ *\n+ * |--------------------|-------------------------------------------------------------------|\n+ * | TABLE:             |                      Is there an active RC?                       |\n+ * | Where should we    |---------------------------------|---------------------------------|\n+ * | deploy to/as?      |               NO                |               YES               |\n+ * |-----------|--------|---------------------------------|---------------------------------|\n+ * |           | LTS    | archive                         | archive                         |\n+ * |           |--------|---------------------------------|---------------------------------|\n+ * |           | PATCH  | stable                          | stable                          |\n+ * | What      |        | redirectVersionDomainToStable   | redirectVersionDomainToStable   |\n+ * | branch    |        | redirectRcToStable              |                                 |\n+ * | are we    |--------|---------------------------------|---------------------------------|\n+ * | deploying | RC     | -                               | rc                              |\n+ * | from?     |        |                                 |                                 |\n+ * |           |--------|---------------------------------|---------------------------------|\n+ * |           | MASTER | next                            | next                            |\n+ * |           |        |                                 |                                 |\n+ * |-----------|--------|---------------------------------|---------------------------------|\n+ *\n+ * NOTES:\n+ *   - When a new major version is released, the deploy CI jobs for the new stable branch (prev. RC\n+ *     or next) and the old stable branch must be run AFTER the new stable version has been\n+ *     published to NPM, because the NPM info is used to determine what the stable version is.\n+ *     In the future, we could make the branch version info retrieval more robust, DRY and\n+ *     future-proof (and independent of NPM releases) by re-using the `ng-dev release info`\n+ *     [implementation](https://github.com/angular/dev-infra/blob/92778223953e029d1723febf282bb265b4e2a56f/ng-dev/release/info/cli.ts).\n+ *     (This would require `ng-dev` to expose an API for requesting the info (instead of printing it\n+ *     in human-readable format to stdout).)\n+ */\n+\n import sh from 'shelljs';\n import {fileURLToPath} from 'url';\n import post from './post-deploy-actions.mjs';\n@@ -118,7 +157,7 @@ function computeDeploymentsInfo(\n       type: 'primary',\n       deployEnv: 'stable',\n       projectId: 'angular-io',\n-      siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n+      siteId: 'stable-angular-io-site',\n       deployedUrl: 'https://angular.io/',\n       preDeployActions: [pre.build, pre.checkPayloadSize],\n       postDeployActions: [post.testPwaScore],\n@@ -140,19 +179,37 @@ function computeDeploymentsInfo(\n     // with small tweaks) to a different project/site.\n     // Unless deployment is skipped, zero or more secondary targets can be used at a time, but they\n     // should all match the primary target's `deployEnv`.\n-\n+    //\n+    // TIP:\n+    // Since there can be multiple secondary deployments (each tweaking the primary one in different\n+    // ways), it is a good idea to ensure that any pre-deploy actions are undone in the post-deploy\n+    // phase.\n+    redirectVersionDomainToStable: {\n+      name: 'redirectVersionDomainToStable',\n+      type: 'secondary',\n+      deployEnv: 'stable',\n+      projectId: 'angular-io',\n+      siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n+      deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n+      preDeployActions: [pre.redirectAllToStable],\n+      postDeployActions: [pre.undo.redirectAllToStable, post.testRedirectToStable],\n+    },\n     // Config for deploying the stable build to the RC Firebase site when there is no active RC.\n     // See https://github.com/angular/angular/issues/39760 for more info on the purpose of this\n     // special deployment.\n-    noActiveRc: {\n-      name: 'stableNoActiveRc',\n+    redirectRcToStable: {\n+      name: 'redirectRcToStable',\n       type: 'secondary',\n       deployEnv: 'stable',\n       projectId: 'angular-io',\n       siteId: 'rc-angular-io-site',\n       deployedUrl: 'https://rc.angular.io/',\n       preDeployActions: [pre.disableServiceWorker, pre.redirectNonFilesToStable],\n-      postDeployActions: [post.testNoActiveRcDeployment],\n+      postDeployActions: [\n+        pre.undo.redirectNonFilesToStable,\n+        pre.undo.disableServiceWorker,\n+        post.testNoActiveRcDeployment,\n+      ],\n     },\n   };\n \n@@ -174,15 +231,19 @@ function computeDeploymentsInfo(\n   // If the current branch is the stable branch, deploy as `stable`.\n   if (currentBranch === stableBranch) {\n     return (rcBranch !== null) ?\n-      // There is an active RC version. Only deploy to the `stable` project/site.\n-      [deploymentInfoPerTarget.stable] :\n-      // There is no active RC version. In addition to deploying to the `stable` project/site,\n+      // There is an active RC version. Only deploy to the `stable` projects/sites.\n+      [\n+        deploymentInfoPerTarget.stable,\n+        deploymentInfoPerTarget.redirectVersionDomainToStable,\n+      ] :\n+      // There is no active RC version. In addition to deploying to the `stable` projects/sites,\n       // deploy to `rc` to ensure it redirects to `stable`.\n       // See https://github.com/angular/angular/issues/39760 for more info on the purpose of this\n       // special deployment.\n       [\n         deploymentInfoPerTarget.stable,\n-        deploymentInfoPerTarget.noActiveRc,\n+        deploymentInfoPerTarget.redirectVersionDomainToStable,\n+        deploymentInfoPerTarget.redirectRcToStable,\n       ];\n   }\n "
        },
        {
            "sha": "6c5025d9b30a17584b405154bc21df8171283113",
            "filename": "aio/scripts/deploy-to-firebase/index.spec.mjs",
            "status": "modified",
            "additions": 30,
            "deletions": 4,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/be24bb7535bf5582ae8d8239f695863fdf703414/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/be24bb7535bf5582ae8d8239f695863fdf703414/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs?ref=be24bb7535bf5582ae8d8239f695863fdf703414",
            "patch": "@@ -132,15 +132,27 @@ describe('deploy-to-firebase:', () => {\n         type: 'primary',\n         deployEnv: 'stable',\n         projectId: 'angular-io',\n-        siteId: 'v4-angular-io-site',\n+        siteId: 'stable-angular-io-site',\n         deployedUrl: 'https://angular.io/',\n         preDeployActions: ['function:build', 'function:checkPayloadSize'],\n         postDeployActions: ['function:testPwaScore'],\n       },\n+      {\n+        name: 'redirectVersionDomainToStable',\n+        type: 'secondary',\n+        deployEnv: 'stable',\n+        projectId: 'angular-io',\n+        siteId: 'v4-angular-io-site',\n+        deployedUrl: 'https://v4.angular.io/',\n+        preDeployActions: ['function:redirectAllToStable'],\n+        postDeployActions: ['function:undoRedirectAllToStable', 'function:testRedirectToStable'],\n+      },\n     ]);\n   });\n \n   it('stable - deploy success - no active RC', () => {\n+    const majorVersion = u.computeMajorVersion(mostRecentMinorBranch);\n+\n     expect(getDeploymentsInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n@@ -154,20 +166,34 @@ describe('deploy-to-firebase:', () => {\n         type: 'primary',\n         deployEnv: 'stable',\n         projectId: 'angular-io',\n-        siteId: `v${u.computeMajorVersion(mostRecentMinorBranch)}-angular-io-site`,\n+        siteId: 'stable-angular-io-site',\n         deployedUrl: 'https://angular.io/',\n         preDeployActions: ['function:build', 'function:checkPayloadSize'],\n         postDeployActions: ['function:testPwaScore'],\n       },\n       {\n-        name: 'stableNoActiveRc',\n+        name: 'redirectVersionDomainToStable',\n+        type: 'secondary',\n+        deployEnv: 'stable',\n+        projectId: 'angular-io',\n+        siteId: `v${majorVersion}-angular-io-site`,\n+        deployedUrl: `https://v${majorVersion}.angular.io/`,\n+        preDeployActions: ['function:redirectAllToStable'],\n+        postDeployActions: ['function:undoRedirectAllToStable', 'function:testRedirectToStable'],\n+      },\n+      {\n+        name: 'redirectRcToStable',\n         type: 'secondary',\n         deployEnv: 'stable',\n         projectId: 'angular-io',\n         siteId: 'rc-angular-io-site',\n         deployedUrl: 'https://rc.angular.io/',\n         preDeployActions: ['function:disableServiceWorker', 'function:redirectNonFilesToStable'],\n-        postDeployActions: ['function:testNoActiveRcDeployment'],\n+        postDeployActions: [\n+          'function:undoRedirectNonFilesToStable',\n+          'function:undoDisableServiceWorker',\n+          'function:testNoActiveRcDeployment',\n+        ],\n       },\n     ]);\n   });"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 100,
        "deletions": 13
    }
}