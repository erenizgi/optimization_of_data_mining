{
    "author": "devversion",
    "message": "refactor(compiler-cli): adjust lock file resolution in ngcc to work with ESM (#43431)\n\nUpdates the lock file resolution logic in ngcc to work with ESM output.\nThe compiler-cli is now shipped in bundles, so the actual module resolution\nneeds to stay to keep the lock file path consistent regardless of where the\nlock file code is bundled into. The ngcc integration test needs to be updated\nthough since the `ngcc` entry-point will always reside in the `bundles/` directory\nnow.\n\nIt has been considered using the top-level `package.json` of the compiler-cli\npackage, but that caused problems in tests down the line because the ngcc\ntests only have the `@angular/compiler-cli/ngcc/...` targets linked into\nthe node modules. It's not worth changing this and reworking tests if ngcc\nis going away in the future anyway (+ it has been like that before!).\n\nPR Close #43431",
    "sha": "d44276447055d3d28489ffd42590d3be598da2a1",
    "files": [
        {
            "sha": "e6895ef66b2fa5a63619bb9149d40dfdf57bbc59",
            "filename": "integration/ngcc/test.sh",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d44276447055d3d28489ffd42590d3be598da2a1/integration%2Fngcc%2Ftest.sh",
            "raw_url": "https://github.com/angular/angular/raw/d44276447055d3d28489ffd42590d3be598da2a1/integration%2Fngcc%2Ftest.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fngcc%2Ftest.sh?ref=d44276447055d3d28489ffd42590d3be598da2a1",
            "patch": "@@ -209,7 +209,7 @@ ngcc --formats fesm2015\n assertFailed \"Expected 'ngcc --formats fesm2015' to fail (since '--formats' is deprecated).\"\n \n # Does it timeout if there is another ngcc process running\n-LOCKFILE=node_modules/@angular/compiler-cli/ngcc/__ngcc_lock_file__\n+LOCKFILE=node_modules/@angular/compiler-cli/bundles/ngcc/__ngcc_lock_file__\n touch $LOCKFILE\n trap \"[[ -f $LOCKFILE ]] && rm $LOCKFILE\" EXIT\n ngcc"
        },
        {
            "sha": "d627e0106a6d37baf35de0e1c9818909e2312570",
            "filename": "packages/compiler-cli/ngcc/src/locking/lock_file.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/d44276447055d3d28489ffd42590d3be598da2a1/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Flock_file.ts",
            "raw_url": "https://github.com/angular/angular/raw/d44276447055d3d28489ffd42590d3be598da2a1/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Flock_file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Flock_file.ts?ref=d44276447055d3d28489ffd42590d3be598da2a1",
            "patch": "@@ -5,10 +5,22 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+\n+import module from 'module';\n+\n import {AbsoluteFsPath, PathManipulation} from '../../../src/ngtsc/file_system';\n \n export function getLockFilePath(fs: PathManipulation) {\n-  return fs.resolve(require.resolve('@angular/compiler-cli/ngcc'), '../__ngcc_lock_file__');\n+  // This is an interop allowing for the unlocking script to be determined in both\n+  // a CommonJS module, or an ES module which does not come with `require` by default.\n+  const requireFn =\n+      typeof require !== 'undefined' ? require : module.createRequire(__ESM_IMPORT_META_URL__);\n+  // The lock file location is resolved based on the location of the `ngcc` entry-point as this\n+  // allows us to have a consistent position for the lock file to reside. We are unable to rely\n+  // on `__dirname` (or equivalent) as this code is being bundled and different entry-points\n+  // will have dedicated bundles where the lock file location would differ then.\n+  const ngccEntryPointFile = requireFn.resolve('@angular/compiler-cli/ngcc');\n+  return fs.resolve(ngccEntryPointFile, '../__ngcc_lock_file__');\n }\n \n export interface LockFile {"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 14,
        "deletions": 2
    }
}