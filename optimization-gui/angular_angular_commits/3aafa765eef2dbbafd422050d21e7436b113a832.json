{
    "author": "atscott",
    "message": "fix(language-service): Correctly parse inputs and selectors with dollar signs (#44268)\n\nWhen we are going to the definition of an input, we find _both_ the\ndefinition of the input _and_ also look for any directives which have\na selector that matches the input. For example:\n\n```\n@Directive({\n  selector: '[greeting]'\n})\nexport class MyDir {\n  @Input() greeting!: string;\n}\n```\n\nWith this commit, we now correctly handle the case where inputs and/or\nselectors have a dollar sign in them. The dollar sign has special\nmeaning in CSS, but when we encounter the dollar in a template, we need\nto escape it when used as a selector so that it is taken as a dollar\nliteral rather than a character with special meaning.\n\nPreviously, we were not escaping the dollar sign and the CSS parsing\nlogic would throw an error. The change in this commit prevents that\nerror from happening, but a `try...catch` is still added in case there\nis another unhandled use-case. If this happens, we do not want the\n`goToDefinition` operation to completely fail.\n\nFixes https://github.com/angular/vscode-ng-language-service/issues/1574\n\nPR Close #44268",
    "sha": "3aafa765eef2dbbafd422050d21e7436b113a832",
    "files": [
        {
            "sha": "1bdb57817ae9b7c1699eaab46fdc3a8d37a33f43",
            "filename": "packages/language-service/src/utils.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 20,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/3aafa765eef2dbbafd422050d21e7436b113a832/packages%2Flanguage-service%2Fsrc%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/3aafa765eef2dbbafd422050d21e7436b113a832/packages%2Flanguage-service%2Fsrc%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Futils.ts?ref=3aafa765eef2dbbafd422050d21e7436b113a832",
            "patch": "@@ -167,14 +167,19 @@ function getFirstComponentForTemplateFile(fileName: string, compiler: NgCompiler\n }\n \n /**\n- * Given an attribute node, converts it to string form.\n+ * Given an attribute node, converts it to string form for use as a CSS selector.\n  */\n-function toAttributeString(attribute: t.TextAttribute|t.BoundAttribute|t.BoundEvent): string {\n+function toAttributeCssSelector(attribute: t.TextAttribute|t.BoundAttribute|t.BoundEvent): string {\n+  let selector: string;\n   if (attribute instanceof t.BoundEvent || attribute instanceof t.BoundAttribute) {\n-    return `[${attribute.name}]`;\n+    selector = `[${attribute.name}]`;\n   } else {\n-    return `[${attribute.name}=${attribute.valueSpan?.toString() ?? ''}]`;\n+    selector = `[${attribute.name}=${attribute.valueSpan?.toString() ?? ''}]`;\n   }\n+  // Any dollar signs that appear in the attribute name and/or value need to be escaped because they\n+  // need to be taken as literal characters rather than special selector behavior of dollar signs in\n+  // CSS.\n+  return selector.replace('$', '\\\\$');\n }\n \n function getNodeName(node: t.Template|t.Element): string {\n@@ -222,7 +227,7 @@ function difference<T>(left: Set<T>, right: Set<T>): Set<T> {\n export function getDirectiveMatchesForElementTag(\n     element: t.Template|t.Element, directives: DirectiveSymbol[]): Set<DirectiveSymbol> {\n   const attributes = getAttributes(element);\n-  const allAttrs = attributes.map(toAttributeString);\n+  const allAttrs = attributes.map(toAttributeCssSelector);\n   const allDirectiveMatches =\n       getDirectiveMatchesForSelector(directives, getNodeName(element) + allAttrs.join(''));\n   const matchesWithoutElement = getDirectiveMatchesForSelector(directives, allAttrs.join(''));\n@@ -232,7 +237,7 @@ export function getDirectiveMatchesForElementTag(\n \n export function makeElementSelector(element: t.Element|t.Template): string {\n   const attributes = getAttributes(element);\n-  const allAttrs = attributes.map(toAttributeString);\n+  const allAttrs = attributes.map(toAttributeCssSelector);\n   return getNodeName(element) + allAttrs.join('');\n }\n \n@@ -251,10 +256,10 @@ export function getDirectiveMatchesForAttribute(\n     name: string, hostNode: t.Template|t.Element,\n     directives: DirectiveSymbol[]): Set<DirectiveSymbol> {\n   const attributes = getAttributes(hostNode);\n-  const allAttrs = attributes.map(toAttributeString);\n+  const allAttrs = attributes.map(toAttributeCssSelector);\n   const allDirectiveMatches =\n       getDirectiveMatchesForSelector(directives, getNodeName(hostNode) + allAttrs.join(''));\n-  const attrsExcludingName = attributes.filter(a => a.name !== name).map(toAttributeString);\n+  const attrsExcludingName = attributes.filter(a => a.name !== name).map(toAttributeCssSelector);\n   const matchesWithoutAttr = getDirectiveMatchesForSelector(\n       directives, getNodeName(hostNode) + attrsExcludingName.join(''));\n   return difference(allDirectiveMatches, matchesWithoutAttr);\n@@ -266,20 +271,26 @@ export function getDirectiveMatchesForAttribute(\n  */\n function getDirectiveMatchesForSelector(\n     directives: DirectiveSymbol[], selector: string): Set<DirectiveSymbol> {\n-  const selectors = CssSelector.parse(selector);\n-  if (selectors.length === 0) {\n+  try {\n+    const selectors = CssSelector.parse(selector);\n+    if (selectors.length === 0) {\n+      return new Set();\n+    }\n+    return new Set(directives.filter((dir: DirectiveSymbol) => {\n+      if (dir.selector === null) {\n+        return false;\n+      }\n+\n+      const matcher = new SelectorMatcher();\n+      matcher.addSelectables(CssSelector.parse(dir.selector));\n+\n+      return selectors.some(selector => matcher.match(selector, null));\n+    }));\n+  } catch {\n+    // An invalid selector may throw an error. There would be no directive matches for an invalid\n+    // selector.\n     return new Set();\n   }\n-  return new Set(directives.filter((dir: DirectiveSymbol) => {\n-    if (dir.selector === null) {\n-      return false;\n-    }\n-\n-    const matcher = new SelectorMatcher();\n-    matcher.addSelectables(CssSelector.parse(dir.selector));\n-\n-    return selectors.some(selector => matcher.match(selector, null));\n-  }));\n }\n \n /**"
        },
        {
            "sha": "75fd473a2af742b7ad8570bb0abc4e8311fa58c9",
            "filename": "packages/language-service/test/definitions_spec.ts",
            "status": "added",
            "additions": 103,
            "deletions": 0,
            "changes": 103,
            "blob_url": "https://github.com/angular/angular/blob/3aafa765eef2dbbafd422050d21e7436b113a832/packages%2Flanguage-service%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3aafa765eef2dbbafd422050d21e7436b113a832/packages%2Flanguage-service%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Fdefinitions_spec.ts?ref=3aafa765eef2dbbafd422050d21e7436b113a832",
            "patch": "@@ -0,0 +1,103 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+\n+import {assertFileNames, assertTextSpans, humanizeDocumentSpanLike, LanguageServiceTestEnv, Project} from '../testing';\n+\n+describe('definitions', () => {\n+  let env: LanguageServiceTestEnv;\n+\n+  describe('when an input has a dollar sign', () => {\n+    const files = {\n+      'app.ts': `\n+\t import {Component, NgModule, Input} from '@angular/core';\n+\n+\t @Component({selector: 'dollar-cmp', template: ''})\n+\t export class DollarCmp {\n+\t   @Input() obs$!: string;\n+\t }\n+ \n+\t @Component({template: '<dollar-cmp [obs$]=\"greeting\"></dollar-cmp>'})\n+\t export class AppCmp {\n+\t   greeting = 'hello';\n+\t }\n+ \n+\t @NgModule({declarations: [AppCmp, DollarCmp]})\n+\t export class AppModule {}\n+       `,\n+    };\n+\n+    beforeEach(() => {\n+      initMockFileSystem('Native');\n+      env = LanguageServiceTestEnv.setup();\n+    });\n+\n+    it('can get definitions for input', () => {\n+      const project = env.addProject('test', files, {strictTemplates: false});\n+      const definitions = getDefinitionsAndAssertBoundSpan(project, 'app.ts', '[o¦bs$]=\"greeting\"');\n+      expect(definitions!.length).toEqual(1);\n+\n+      assertTextSpans(definitions, ['obs$']);\n+      assertFileNames(definitions, ['app.ts']);\n+    });\n+\n+    it('can get definitions for component', () => {\n+      const project = env.addProject('test', files, {strictTemplates: false});\n+      const definitions = getDefinitionsAndAssertBoundSpan(project, 'app.ts', '<dollar-cm¦p');\n+      expect(definitions!.length).toEqual(1);\n+\n+      assertTextSpans(definitions, ['DollarCmp']);\n+      assertFileNames(definitions, ['app.ts']);\n+    });\n+  });\n+\n+  describe('when a selector and input of a directive have a dollar sign', () => {\n+    it('can get definitions', () => {\n+      initMockFileSystem('Native');\n+      env = LanguageServiceTestEnv.setup();\n+      const files = {\n+        'app.ts': `\n+\t import {Component, Directive, NgModule, Input} from '@angular/core';\n+\n+\t @Directive({selector: '[dollar\\\\\\\\$]', template: ''})\n+\t export class DollarDir {\n+\t   @Input() dollar$!: string;\n+\t }\n+ \n+\t @Component({template: '<div [dollar$]=\"greeting\"></div>'})\n+\t export class AppCmp {\n+\t   greeting = 'hello';\n+\t }\n+ \n+\t @NgModule({declarations: [AppCmp, DollarDir]})\n+\t export class AppModule {}\n+       `,\n+      };\n+      const project = env.addProject('test', files, {strictTemplates: false});\n+      const definitions =\n+          getDefinitionsAndAssertBoundSpan(project, 'app.ts', '[dollar¦$]=\"greeting\"');\n+      expect(definitions!.length).toEqual(2);\n+\n+      assertTextSpans(definitions, ['dollar$', 'DollarDir']);\n+      assertFileNames(definitions, ['app.ts']);\n+    });\n+  });\n+\n+  function getDefinitionsAndAssertBoundSpan(project: Project, file: string, targetText: string) {\n+    const template = project.openFile(file);\n+    env.expectNoSourceDiagnostics();\n+    project.expectNoTemplateDiagnostics('app.ts', 'AppCmp');\n+\n+    template.moveCursorToText(targetText);\n+    const defAndBoundSpan = template.getDefinitionAndBoundSpan();\n+    expect(defAndBoundSpan).toBeTruthy();\n+    expect(defAndBoundSpan!.definitions).toBeTruthy();\n+    return defAndBoundSpan!.definitions!.map(d => humanizeDocumentSpanLike(d, env));\n+  }\n+});"
        }
    ],
    "stats": {
        "total": 154,
        "additions": 134,
        "deletions": 20
    }
}