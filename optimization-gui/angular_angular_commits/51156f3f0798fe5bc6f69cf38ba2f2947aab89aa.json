{
    "author": "JoostK",
    "message": "fix(core): allow proper type inference when `ngFor` is used with a `trackBy` function (#42692)\n\nIn #41995 the type of `TrackByFunction` was changed such that the\ndeclaration of a `trackBy` function did not cause the item type to be\nwidened to the `trackBy`'s item type, which may be a supertype of the\niterated type. This has introduced situations where the template type\nchecker is now reporting errors for cases where a `trackBy` function is\nno longer assignable to `TrackByFunction`.\n\nThis commit fixes the error by also including the item type `T` in\naddition to the constrained type parameter `U`, allowing TypeScript to\ninfer an appropriate `T`.\n\nFixes #42609\n\nPR Close #42692",
    "sha": "51156f3f0798fe5bc6f69cf38ba2f2947aab89aa",
    "files": [
        {
            "sha": "8c85de60746c9292cdb5d6333e207eeea536789c",
            "filename": "goldens/public-api/core/core.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/51156f3f0798fe5bc6f69cf38ba2f2947aab89aa/goldens%2Fpublic-api%2Fcore%2Fcore.md",
            "raw_url": "https://github.com/angular/angular/raw/51156f3f0798fe5bc6f69cf38ba2f2947aab89aa/goldens%2Fpublic-api%2Fcore%2Fcore.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcore%2Fcore.md?ref=51156f3f0798fe5bc6f69cf38ba2f2947aab89aa",
            "patch": "@@ -1258,7 +1258,7 @@ export class TestabilityRegistry {\n // @public\n export interface TrackByFunction<T> {\n     // (undocumented)\n-    <U extends T>(index: number, item: U): any;\n+    <U extends T>(index: number, item: T & U): any;\n }\n \n // @public"
        },
        {
            "sha": "07af668366e65bd283ad72931c402331848c73bb",
            "filename": "packages/compiler-cli/src/ngtsc/testing/fake_core/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/51156f3f0798fe5bc6f69cf38ba2f2947aab89aa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Ffake_core%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/51156f3f0798fe5bc6f69cf38ba2f2947aab89aa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Ffake_core%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Ffake_core%2Findex.ts?ref=51156f3f0798fe5bc6f69cf38ba2f2947aab89aa",
            "patch": "@@ -116,5 +116,5 @@ export interface OnDestroy {\n }\n \n export interface TrackByFunction<T> {\n-  <U extends T>(index: number, item: U): any;\n+  <U extends T>(index: number, item: T&U): any;\n }"
        },
        {
            "sha": "1cc1497288081612668f8b73d8bbb67e7fe2d876",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/angular/angular/blob/51156f3f0798fe5bc6f69cf38ba2f2947aab89aa/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/51156f3f0798fe5bc6f69cf38ba2f2947aab89aa/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=51156f3f0798fe5bc6f69cf38ba2f2947aab89aa",
            "patch": "@@ -1086,6 +1086,78 @@ export declare class AnimationEvent {\n       env.driveMain();\n     });\n \n+    // https://github.com/angular/angular/issues/42609\n+    it('should accept NgFor iteration when trackBy is used with an `any` array', () => {\n+      env.tsconfig({strictTemplates: true});\n+      env.write('test.ts', `\n+        import {CommonModule} from '@angular/common';\n+        import {Component, NgModule} from '@angular/core';\n+\n+        interface ItemType {\n+          id: string;\n+        }\n+\n+        @Component({\n+          selector: 'test',\n+          template: '<div *ngFor=\"let item of anyList; trackBy: trackByBase\">{{item.name}}</div>',\n+        })\n+        class TestCmp {\n+          anyList!: any[];\n+\n+          trackByBase(index: number, item: ItemType): string {\n+            return item.id;\n+          }\n+        }\n+\n+        @NgModule({\n+          declarations: [TestCmp],\n+          imports: [CommonModule],\n+        })\n+        class Module {}\n+    `);\n+\n+      env.driveMain();\n+    });\n+\n+    it('should reject NgFor iteration when trackBy is incompatible with item type', () => {\n+      env.tsconfig({strictTemplates: true});\n+      env.write('test.ts', `\n+        import {CommonModule} from '@angular/common';\n+        import {Component, NgModule} from '@angular/core';\n+\n+        interface ItemType {\n+          id: string;\n+        }\n+\n+        interface UnrelatedType {\n+          name: string;\n+        }\n+\n+        @Component({\n+          selector: 'test',\n+          template: '<div *ngFor=\"let item of unrelatedList; trackBy: trackByBase\">{{item.name}}</div>',\n+        })\n+        class TestCmp {\n+          unrelatedList!: UnrelatedType[];\n+\n+          trackByBase(index: number, item: ItemType): string {\n+            return item.id;\n+          }\n+        }\n+\n+        @NgModule({\n+          declarations: [TestCmp],\n+          imports: [CommonModule],\n+        })\n+        class Module {}\n+    `);\n+\n+      const diags = env.driveDiagnostics();\n+      expect(diags.length).toBe(1);\n+      expect(diags[0].messageText)\n+          .toContain(`is not assignable to type 'TrackByFunction<UnrelatedType>'.`);\n+    });\n+\n     it('should infer the context of NgFor', () => {\n       env.tsconfig({strictTemplates: true});\n       env.write('test.ts', `"
        },
        {
            "sha": "5a5fe7bb94e235b05a74763ea3424ca7f891bde1",
            "filename": "packages/core/src/change_detection/differs/iterable_differs.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/51156f3f0798fe5bc6f69cf38ba2f2947aab89aa/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fiterable_differs.ts",
            "raw_url": "https://github.com/angular/angular/raw/51156f3f0798fe5bc6f69cf38ba2f2947aab89aa/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fiterable_differs.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fiterable_differs.ts?ref=51156f3f0798fe5bc6f69cf38ba2f2947aab89aa",
            "patch": "@@ -167,7 +167,7 @@ export interface TrackByFunction<T> {\n    * @param index The index of the item within the iterable.\n    * @param item The item in the iterable.\n    */\n-  <U extends T>(index: number, item: U): any;\n+  <U extends T>(index: number, item: T&U): any;\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 75,
        "deletions": 3
    }
}