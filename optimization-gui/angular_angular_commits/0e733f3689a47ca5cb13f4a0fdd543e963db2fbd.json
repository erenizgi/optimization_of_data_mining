{
    "author": "crisbeto",
    "message": "feat(core): add automated migration to replace ViewEncapsulation.Native (#38882)\n\nAdds an automated migration that replaces any usages of the deprecated\n`ViewEncapsulation.Native` with `ViewEncapsulation.ShadowDom`.\n\nPR Close #38882",
    "sha": "0e733f3689a47ca5cb13f4a0fdd543e963db2fbd",
    "files": [
        {
            "sha": "bcf0d6ecb3681a00aa560547ac350bcc25596006",
            "filename": "packages/core/schematics/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2FBUILD.bazel?ref=0e733f3689a47ca5cb13f4a0fdd543e963db2fbd",
            "patch": "@@ -15,6 +15,7 @@ pkg_npm(\n         \"//packages/core/schematics/migrations/missing-injectable\",\n         \"//packages/core/schematics/migrations/module-with-providers\",\n         \"//packages/core/schematics/migrations/move-document\",\n+        \"//packages/core/schematics/migrations/native-view-encapsulation\",\n         \"//packages/core/schematics/migrations/navigation-extras-omissions\",\n         \"//packages/core/schematics/migrations/relative-link-resolution\",\n         \"//packages/core/schematics/migrations/renderer-to-renderer2\","
        },
        {
            "sha": "2ba3e201010ff575d464f6a59857c0d56acf295a",
            "filename": "packages/core/schematics/migrations.json",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "raw_url": "https://github.com/angular/angular/raw/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations.json?ref=0e733f3689a47ca5cb13f4a0fdd543e963db2fbd",
            "patch": "@@ -59,6 +59,11 @@\n       \"version\": \"11.0.0-beta\",\n       \"description\": \"In Angular version 11, the type of `AbstractControl.parent` can be `null` to reflect the runtime value more accurately. This migration automatically adds non-null assertions to existing accesses of the `parent` property on types like `FormControl`, `FormArray` and `FormGroup`.\",\n       \"factory\": \"./migrations/abstract-control-parent/index\"\n+    },\n+    \"migration-v11-native-view-encapsulation\": {\n+      \"version\": \"11.0.0-beta\",\n+      \"description\": \"ViewEncapsulation.Native has been removed as of Angular version 11. This migration replaces any usages with ViewEncapsulation.ShadowDom.\",\n+      \"factory\": \"./migrations/native-view-encapsulation/index\"\n     }\n   }\n }"
        },
        {
            "sha": "4c08ab63bf66a092936c385ac028bca1d4514d16",
            "filename": "packages/core/schematics/migrations/native-view-encapsulation/BUILD.bazel",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2FBUILD.bazel?ref=0e733f3689a47ca5cb13f4a0fdd543e963db2fbd",
            "patch": "@@ -0,0 +1,18 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"native-view-encapsulation\",\n+    srcs = glob([\"**/*.ts\"]),\n+    tsconfig = \"//packages/core/schematics:tsconfig.json\",\n+    visibility = [\n+        \"//packages/core/schematics:__pkg__\",\n+        \"//packages/core/schematics/migrations/google3:__pkg__\",\n+        \"//packages/core/schematics/test:__pkg__\",\n+    ],\n+    deps = [\n+        \"//packages/core/schematics/utils\",\n+        \"@npm//@angular-devkit/schematics\",\n+        \"@npm//@types/node\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "0a9ab191a05859cc5cff59fbf7bffd9aa42f18fc",
            "filename": "packages/core/schematics/migrations/native-view-encapsulation/README.md",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2FREADME.md?ref=0e733f3689a47ca5cb13f4a0fdd543e963db2fbd",
            "patch": "@@ -0,0 +1,34 @@\n+## `ViewEncapsulation.Native` migration\n+\n+Automatically migrates usages of `ViewEncapsulation.Native` to `ViewEncapsulation.ShadowDom`.\n+For most practical purposes the `Native` mode is compatible with the `ShadowDom` mode.\n+\n+The migration covers any reference to the `Native` value that can be traced to `@angular/core`.\n+Some examples:\n+* Inside the `encapsulation` property of `Component` decorators.\n+* In property assignments for the `COMPILER_OPTIONS` provider.\n+* In variables.\n+\n+#### Before\n+```ts\n+import { Component, ViewEncapsulation } from '@angular/core';\n+\n+@Component({\n+  template: '...',\n+  encapsulation: ViewEncapsulation.Native\n+})\n+export class App {\n+}\n+```\n+\n+#### After\n+```ts\n+import { Component, ViewEncapsulation } from '@angular/core';\n+\n+@Component({\n+  template: '...',\n+  encapsulation: ViewEncapsulation.ShadowDom\n+})\n+export class App {\n+}\n+```"
        },
        {
            "sha": "766e8c4ca25cad2ad9850759f232ebbb207de3b1",
            "filename": "packages/core/schematics/migrations/native-view-encapsulation/index.ts",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2Findex.ts?ref=0e733f3689a47ca5cb13f4a0fdd543e963db2fbd",
            "patch": "@@ -0,0 +1,52 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Rule, SchematicsException, Tree} from '@angular-devkit/schematics';\n+import {relative} from 'path';\n+\n+import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n+import {createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {findNativeEncapsulationNodes} from './util';\n+\n+\n+/** Migration that switches from `ViewEncapsulation.Native` to `ViewEncapsulation.ShadowDom`. */\n+export default function(): Rule {\n+  return (tree: Tree) => {\n+    const {buildPaths, testPaths} = getProjectTsConfigPaths(tree);\n+    const basePath = process.cwd();\n+    const allPaths = [...buildPaths, ...testPaths];\n+\n+    if (!allPaths.length) {\n+      throw new SchematicsException(\n+          'Could not find any tsconfig file. Cannot migrate away from Native view encapsulation.');\n+    }\n+\n+    for (const tsconfigPath of allPaths) {\n+      runNativeViewEncapsulationMigration(tree, tsconfigPath, basePath);\n+    }\n+  };\n+}\n+\n+function runNativeViewEncapsulationMigration(tree: Tree, tsconfigPath: string, basePath: string) {\n+  const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n+  const typeChecker = program.getTypeChecker();\n+  const sourceFiles = program.getSourceFiles().filter(\n+      f => !f.isDeclarationFile && !program.isSourceFileFromExternalLibrary(f));\n+\n+  sourceFiles.forEach(sourceFile => {\n+    const update = tree.beginUpdate(relative(basePath, sourceFile.fileName));\n+    const identifiers = findNativeEncapsulationNodes(typeChecker, sourceFile);\n+\n+    identifiers.forEach(node => {\n+      update.remove(node.getStart(), node.getWidth());\n+      update.insertRight(node.getStart(), 'ShadowDom');\n+    });\n+\n+    tree.commitUpdate(update);\n+  });\n+}"
        },
        {
            "sha": "c7188b01d7e62fc357c4345bb1b047394b9b7ce7",
            "filename": "packages/core/schematics/migrations/native-view-encapsulation/util.ts",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fnative-view-encapsulation%2Futil.ts?ref=0e733f3689a47ca5cb13f4a0fdd543e963db2fbd",
            "patch": "@@ -0,0 +1,38 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript';\n+\n+import {getImportOfIdentifier} from '../../utils/typescript/imports';\n+\n+/** Finds all the Identifier nodes in a file that refer to `Native` view encapsulation. */\n+export function findNativeEncapsulationNodes(\n+    typeChecker: ts.TypeChecker, sourceFile: ts.SourceFile): Set<ts.Identifier> {\n+  const results = new Set<ts.Identifier>();\n+\n+  sourceFile.forEachChild(function walkNode(node: ts.Node) {\n+    // Note that we look directly for nodes in the form of `<something>.Native`, rather than going\n+    // for `Component` class decorators, because it's much simpler and it allows us to handle cases\n+    // where `ViewEncapsulation.Native` might be used in a different context (e.g. a variable).\n+    // Using the encapsulation outside of a decorator is an edge case, but we do have public APIs\n+    // where it can be passed in (see the `defaultViewEncapsulation` property on the\n+    // `COMPILER_OPTIONS` provider).\n+    if (ts.isPropertyAccessExpression(node) && ts.isIdentifier(node.name) &&\n+        node.name.text === 'Native' && ts.isIdentifier(node.expression)) {\n+      const expressionImport = getImportOfIdentifier(typeChecker, node.expression);\n+      if (expressionImport && expressionImport.name === 'ViewEncapsulation' &&\n+          expressionImport.importModule === '@angular/core') {\n+        results.add(node.name);\n+      }\n+    } else {\n+      node.forEachChild(walkNode);\n+    }\n+  });\n+\n+  return results;\n+}"
        },
        {
            "sha": "0a8fd5d13d9024459545eeaf878990b81a42a8c5",
            "filename": "packages/core/schematics/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel?ref=0e733f3689a47ca5cb13f4a0fdd543e963db2fbd",
            "patch": "@@ -13,6 +13,7 @@ ts_library(\n         \"//packages/core/schematics/migrations/missing-injectable\",\n         \"//packages/core/schematics/migrations/module-with-providers\",\n         \"//packages/core/schematics/migrations/move-document\",\n+        \"//packages/core/schematics/migrations/native-view-encapsulation\",\n         \"//packages/core/schematics/migrations/navigation-extras-omissions\",\n         \"//packages/core/schematics/migrations/relative-link-resolution\",\n         \"//packages/core/schematics/migrations/renderer-to-renderer2\","
        },
        {
            "sha": "e3cdd6a24e2d03a8b77b19c5cc5a1615b45dd792",
            "filename": "packages/core/schematics/test/native_view_encapsulation_migration_spec.ts",
            "status": "added",
            "additions": 169,
            "deletions": 0,
            "changes": 169,
            "blob_url": "https://github.com/angular/angular/blob/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Ftest%2Fnative_view_encapsulation_migration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0e733f3689a47ca5cb13f4a0fdd543e963db2fbd/packages%2Fcore%2Fschematics%2Ftest%2Fnative_view_encapsulation_migration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Fnative_view_encapsulation_migration_spec.ts?ref=0e733f3689a47ca5cb13f4a0fdd543e963db2fbd",
            "patch": "@@ -0,0 +1,169 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {getSystemPath, normalize, virtualFs} from '@angular-devkit/core';\n+import {TempScopedNodeJsSyncHost} from '@angular-devkit/core/node/testing';\n+import {HostTree} from '@angular-devkit/schematics';\n+import {SchematicTestRunner, UnitTestTree} from '@angular-devkit/schematics/testing';\n+import * as shx from 'shelljs';\n+\n+describe('ViewEncapsulation.Native migration', () => {\n+  let runner: SchematicTestRunner;\n+  let host: TempScopedNodeJsSyncHost;\n+  let tree: UnitTestTree;\n+  let tmpDirPath: string;\n+  let previousWorkingDir: string;\n+\n+  beforeEach(() => {\n+    runner = new SchematicTestRunner('test', require.resolve('../migrations.json'));\n+    host = new TempScopedNodeJsSyncHost();\n+    tree = new UnitTestTree(new HostTree(host));\n+\n+    writeFile('/tsconfig.json', JSON.stringify({\n+      compilerOptions: {\n+        lib: ['es2015'],\n+        strictNullChecks: true,\n+      },\n+    }));\n+    writeFile('/angular.json', JSON.stringify({\n+      projects: {t: {architect: {build: {options: {tsConfig: './tsconfig.json'}}}}}\n+    }));\n+\n+    previousWorkingDir = shx.pwd();\n+    tmpDirPath = getSystemPath(host.root);\n+\n+    // Switch into the temporary directory path. This allows us to run\n+    // the schematic against our custom unit test tree.\n+    shx.cd(tmpDirPath);\n+  });\n+\n+  afterEach(() => {\n+    shx.cd(previousWorkingDir);\n+    shx.rm('-r', tmpDirPath);\n+  });\n+\n+  it('should change Native view encapsulation usages to ShadowDom', async () => {\n+    writeFile('/index.ts', `\n+      import {Component, ViewEncapsulation} from '@angular/core';\n+\n+      @Component({\n+        template: 'hello',\n+        encapsulation: ViewEncapsulation.Native\n+      })\n+      class App {}\n+    `);\n+\n+    await runMigration();\n+\n+    const content = tree.readContent('/index.ts');\n+    expect(content).toContain('encapsulation: ViewEncapsulation.ShadowDom');\n+  });\n+\n+  it('should change Native view encapsulation usages if the enum is aliased', async () => {\n+    writeFile('/index.ts', `\n+      import {Component, ViewEncapsulation as Encapsulation} from '@angular/core';\n+\n+      @Component({\n+        template: 'hello',\n+        encapsulation: Encapsulation.Native\n+      })\n+      class App {}\n+    `);\n+\n+    await runMigration();\n+\n+    const content = tree.readContent('/index.ts');\n+    expect(content).toContain('encapsulation: Encapsulation.ShadowDom');\n+  });\n+\n+  it('should change Native view encapsulation usages inside a variable', async () => {\n+    writeFile('/index.ts', `\n+      import {Component, ViewEncapsulation} from '@angular/core';\n+\n+      const encapsulation = ViewEncapsulation.Native;\n+\n+      @Component({template: 'hello', encapsulation})\n+      class App {}\n+\n+      @Component({template: 'click me', encapsulation})\n+      class Button {}\n+    `);\n+\n+    await runMigration();\n+\n+    const content = tree.readContent('/index.ts');\n+    expect(content).toContain('const encapsulation = ViewEncapsulation.ShadowDom;');\n+  });\n+\n+  it('should not change components that do not set an encapsulation', async () => {\n+    const source = `\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        template: 'hello'\n+      })\n+      class App {}\n+    `;\n+\n+    writeFile('/index.ts', source);\n+\n+    await runMigration();\n+\n+    const content = tree.readContent('/index.ts');\n+    expect(content).toBe(source);\n+  });\n+\n+  it('should not change components that use an encapsulation different from Native', async () => {\n+    const source = `\n+      import {Component, ViewEncapsulation} from '@angular/core';\n+\n+      @Component({\n+        template: 'hello',\n+        encapsulation: ViewEncapsulation.None\n+      })\n+      class App {}\n+    `;\n+\n+    writeFile('/index.ts', source);\n+\n+    await runMigration();\n+\n+    const content = tree.readContent('/index.ts');\n+    expect(content).toBe(source);\n+  });\n+\n+  it('should not change cases where ViewEncapsulation does not come from @angular/core',\n+     async () => {\n+       const source = `\n+        import {Component} from '@angular/core';\n+        import {ViewEncapsulation} from '@not-angular/core';\n+\n+        @Component({\n+          template: 'hello',\n+          encapsulation: ViewEncapsulation.Native\n+        })\n+        class App {}\n+      `;\n+\n+       writeFile('/index.ts', source);\n+\n+       await runMigration();\n+\n+       const content = tree.readContent('/index.ts');\n+       expect(content).toBe(source);\n+     });\n+\n+  function writeFile(filePath: string, contents: string) {\n+    host.sync.write(normalize(filePath), virtualFs.stringToFileBuffer(contents));\n+  }\n+\n+  function runMigration() {\n+    return runner.runSchematicAsync('migration-v11-native-view-encapsulation', {}, tree)\n+        .toPromise();\n+  }\n+});"
        }
    ],
    "stats": {
        "total": 318,
        "additions": 318,
        "deletions": 0
    }
}