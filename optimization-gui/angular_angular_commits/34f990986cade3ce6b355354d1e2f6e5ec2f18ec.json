{
    "author": "AndrewKushnir",
    "message": "feat(upgrade): support NgModule class as an argument of the `downgradeModule` function (#43973)\n\nThis commit extends the logic of the `downgradeModule` function to support NgModule class as an argument. This is needed to simplify the API surface to avoid the need to resolve NgModule factory before invoking the `downgradeModule` method.\n\nPR Close #43973",
    "sha": "34f990986cade3ce6b355354d1e2f6e5ec2f18ec",
    "files": [
        {
            "sha": "57b205c33b7082f120eccadd4e1fd60f40a413b8",
            "filename": "goldens/public-api/upgrade/static/static.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/34f990986cade3ce6b355354d1e2f6e5ec2f18ec/goldens%2Fpublic-api%2Fupgrade%2Fstatic%2Fstatic.md",
            "raw_url": "https://github.com/angular/angular/raw/34f990986cade3ce6b355354d1e2f6e5ec2f18ec/goldens%2Fpublic-api%2Fupgrade%2Fstatic%2Fstatic.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fupgrade%2Fstatic%2Fstatic.md?ref=34f990986cade3ce6b355354d1e2f6e5ec2f18ec",
            "patch": "@@ -34,7 +34,7 @@ export function downgradeComponent(info: {\n export function downgradeInjectable(token: any, downgradedModule?: string): Function;\n \n // @public\n-export function downgradeModule<T>(moduleFactoryOrBootstrapFn: NgModuleFactory<T> | ((extraProviders: StaticProvider[]) => Promise<NgModuleRef<T>>)): string;\n+export function downgradeModule<T>(moduleOrBootstrapFn: Type<T> | NgModuleFactory<T> | ((extraProviders: StaticProvider[]) => Promise<NgModuleRef<T>>)): string;\n \n // @public\n export function getAngularJSGlobal(): any;"
        },
        {
            "sha": "0e4200348eef3879221d860d7a9f0c5f63419163",
            "filename": "packages/upgrade/src/common/src/util.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/34f990986cade3ce6b355354d1e2f6e5ec2f18ec/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/34f990986cade3ce6b355354d1e2f6e5ec2f18ec/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fsrc%2Fcommon%2Fsrc%2Futil.ts?ref=34f990986cade3ce6b355354d1e2f6e5ec2f18ec",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Injector, Type} from '@angular/core';\n+import {Injector, Type, ɵNG_MOD_DEF} from '@angular/core';\n \n import {element as angularElement, IAugmentedJQuery, IInjectorService, INgModelController, IRootScopeService} from './angular1';\n import {$ROOT_ELEMENT, $ROOT_SCOPE, DOWNGRADED_MODULE_COUNT_KEY, UPGRADE_APP_TYPE_KEY} from './constants';\n@@ -89,6 +89,11 @@ export function isFunction(value: any): value is Function {\n   return typeof value === 'function';\n }\n \n+export function isNgModuleType(value: any): value is Type<unknown> {\n+  // NgModule class should have the `ɵmod` static property attached by AOT or JIT compiler.\n+  return isFunction(value) && !!value[ɵNG_MOD_DEF];\n+}\n+\n function isParentNode(node: Node|ParentNode): node is ParentNode {\n   return isFunction((node as unknown as ParentNode).querySelectorAll);\n }"
        },
        {
            "sha": "fb30138bcfa81c06e39fca9970324712a16a0987",
            "filename": "packages/upgrade/static/src/downgrade_module.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 8,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/34f990986cade3ce6b355354d1e2f6e5ec2f18ec/packages%2Fupgrade%2Fstatic%2Fsrc%2Fdowngrade_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/34f990986cade3ce6b355354d1e2f6e5ec2f18ec/packages%2Fupgrade%2Fstatic%2Fsrc%2Fdowngrade_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fstatic%2Fsrc%2Fdowngrade_module.ts?ref=34f990986cade3ce6b355354d1e2f6e5ec2f18ec",
            "patch": "@@ -6,12 +6,12 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Injector, NgModuleFactory, NgModuleRef, PlatformRef, StaticProvider} from '@angular/core';\n+import {Injector, NgModuleFactory, NgModuleRef, PlatformRef, StaticProvider, Type} from '@angular/core';\n import {platformBrowser} from '@angular/platform-browser';\n \n import {IInjectorService, IProvideService, module_ as angularModule} from '../../src/common/src/angular1';\n import {$INJECTOR, $PROVIDE, DOWNGRADED_MODULE_COUNT_KEY, INJECTOR_KEY, LAZY_MODULE_REF, UPGRADE_APP_TYPE_KEY, UPGRADE_MODULE_NAME} from '../../src/common/src/constants';\n-import {destroyApp, getDowngradedModuleCount, isFunction, LazyModuleRef, UpgradeAppType} from '../../src/common/src/util';\n+import {destroyApp, getDowngradedModuleCount, isFunction, isNgModuleType, LazyModuleRef, UpgradeAppType} from '../../src/common/src/util';\n \n import {angular1Providers, setTempInjectorRef} from './angular1_providers';\n import {NgAdapterInjector} from './util';\n@@ -37,9 +37,11 @@ let moduleUid = 0;\n  * The Angular module will be bootstrapped once (when requested for the first time) and the same\n  * reference will be used from that point onwards.\n  *\n- * `downgradeModule()` requires either an `NgModuleFactory` or a function:\n+ * `downgradeModule()` requires either an `NgModuleFactory`, `NgModule` class or a function:\n  * - `NgModuleFactory`: If you pass an `NgModuleFactory`, it will be used to instantiate a module\n  *   using `platformBrowser`'s {@link PlatformRef#bootstrapModuleFactory bootstrapModuleFactory()}.\n+ * - `NgModule` class: If you pass an NgModule class, it will be used to instantiate a module\n+ *   using `platformBrowser`'s {@link PlatformRef#bootstrapModule bootstrapModule()}.\n  * - `Function`: If you pass a function, it is expected to return a promise resolving to an\n  *   `NgModuleRef`. The function is called with an array of extra {@link StaticProvider Providers}\n  *   that are expected to be available from the returned `NgModuleRef`'s `Injector`.\n@@ -128,16 +130,25 @@ let moduleUid = 0;\n  *\n  * @publicApi\n  */\n-export function downgradeModule<T>(moduleFactoryOrBootstrapFn: NgModuleFactory<T>|(\n+export function downgradeModule<T>(moduleOrBootstrapFn: Type<T>|NgModuleFactory<T>|(\n     (extraProviders: StaticProvider[]) => Promise<NgModuleRef<T>>)): string {\n   const lazyModuleName = `${UPGRADE_MODULE_NAME}.lazy${++moduleUid}`;\n   const lazyModuleRefKey = `${LAZY_MODULE_REF}${lazyModuleName}`;\n   const lazyInjectorKey = `${INJECTOR_KEY}${lazyModuleName}`;\n \n-  const bootstrapFn = isFunction(moduleFactoryOrBootstrapFn) ?\n-      moduleFactoryOrBootstrapFn :\n-      (extraProviders: StaticProvider[]) =>\n-          platformBrowser(extraProviders).bootstrapModuleFactory(moduleFactoryOrBootstrapFn);\n+  let bootstrapFn: (extraProviders: StaticProvider[]) => Promise<NgModuleRef<T>>;\n+  if (isNgModuleType(moduleOrBootstrapFn)) {\n+    // NgModule class\n+    bootstrapFn = (extraProviders: StaticProvider[]) =>\n+        platformBrowser(extraProviders).bootstrapModule(moduleOrBootstrapFn);\n+  } else if (!isFunction(moduleOrBootstrapFn)) {\n+    // NgModule factory\n+    bootstrapFn = (extraProviders: StaticProvider[]) =>\n+        platformBrowser(extraProviders).bootstrapModuleFactory(moduleOrBootstrapFn);\n+  } else {\n+    // bootstrap function\n+    bootstrapFn = moduleOrBootstrapFn;\n+  }\n \n   let injector: Injector;\n "
        },
        {
            "sha": "0ff990486e40dac2996ac9c31fb69d84ddad2e6b",
            "filename": "packages/upgrade/static/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/34f990986cade3ce6b355354d1e2f6e5ec2f18ec/packages%2Fupgrade%2Fstatic%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/34f990986cade3ce6b355354d1e2f6e5ec2f18ec/packages%2Fupgrade%2Fstatic%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fstatic%2Ftest%2FBUILD.bazel?ref=34f990986cade3ce6b355354d1e2f6e5ec2f18ec",
            "patch": "@@ -19,6 +19,7 @@ ts_library(\n         \"//packages/platform-browser\",\n         \"//packages/platform-browser-dynamic\",\n         \"//packages/platform-browser/testing\",\n+        \"//packages/private/testing\",\n         \"//packages/upgrade/src/common\",\n         \"//packages/upgrade/src/common/test/helpers\",\n         \"//packages/upgrade/static\","
        },
        {
            "sha": "bdec6cc3e4a2167bf6828fa80dee3104fc976f4a",
            "filename": "packages/upgrade/static/test/integration/downgrade_module_spec.ts",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/34f990986cade3ce6b355354d1e2f6e5ec2f18ec/packages%2Fupgrade%2Fstatic%2Ftest%2Fintegration%2Fdowngrade_module_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/34f990986cade3ce6b355354d1e2f6e5ec2f18ec/packages%2Fupgrade%2Fstatic%2Ftest%2Fintegration%2Fdowngrade_module_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fupgrade%2Fstatic%2Ftest%2Fintegration%2Fdowngrade_module_spec.ts?ref=34f990986cade3ce6b355354d1e2f6e5ec2f18ec",
            "patch": "@@ -11,6 +11,7 @@ import {fakeAsync, tick, waitForAsync} from '@angular/core/testing';\n import {BrowserModule} from '@angular/platform-browser';\n import {platformBrowserDynamic} from '@angular/platform-browser-dynamic';\n import {browserDetection} from '@angular/platform-browser/testing/src/browser_util';\n+import {onlyInIvy} from '@angular/private/testing';\n import {downgradeComponent, downgradeModule, UpgradeComponent} from '@angular/upgrade/static';\n \n import * as angular from '../../../src/common/src/angular1';\n@@ -80,6 +81,56 @@ withEachNg1Version(() => {\n            setTimeout(() => expect(element.textContent).toBe('a | b'));\n          }));\n \n+      onlyInIvy('Factory-less API of the `downgradeModule` is supported only in Ivy')\n+          .it('should support downgrading modules by providing NgModule class to `downgradeModule` call',\n+              waitForAsync(() => {\n+                @Component({selector: 'ng2A', template: 'a'})\n+                class Ng2ComponentA {\n+                }\n+\n+                @Component({selector: 'ng2B', template: 'b'})\n+                class Ng2ComponentB {\n+                }\n+\n+                @NgModule({\n+                  declarations: [Ng2ComponentA],\n+                  entryComponents: [Ng2ComponentA],\n+                  imports: [BrowserModule],\n+                })\n+                class Ng2ModuleA {\n+                  ngDoBootstrap() {}\n+                }\n+\n+                @NgModule({\n+                  declarations: [Ng2ComponentB],\n+                  entryComponents: [Ng2ComponentB],\n+                  imports: [BrowserModule],\n+                })\n+                class Ng2ModuleB {\n+                  ngDoBootstrap() {}\n+                }\n+\n+                const downModA = downgradeModule(Ng2ModuleA);\n+                const downModB = downgradeModule(Ng2ModuleB);\n+                const ng1Module = angular.module_('ng1', [downModA, downModB])\n+                                      .directive('ng2A', downgradeComponent({\n+                                                   component: Ng2ComponentA,\n+                                                   downgradedModule: downModA,\n+                                                   propagateDigest,\n+                                                 }))\n+                                      .directive('ng2B', downgradeComponent({\n+                                                   component: Ng2ComponentB,\n+                                                   downgradedModule: downModB,\n+                                                   propagateDigest,\n+                                                 }));\n+\n+                const element = html('<ng2-a></ng2-a> | <ng2-b></ng2-b>');\n+                angular.bootstrap(element, [ng1Module.name]);\n+\n+                // Wait for the module to be bootstrapped.\n+                setTimeout(() => expect(element.textContent).toBe('a | b'));\n+              }));\n+\n       it('should support nesting components from different downgraded modules', waitForAsync(() => {\n            @Directive({selector: 'ng1A'})\n            class Ng1ComponentA extends UpgradeComponent {"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 78,
        "deletions": 10
    }
}