{
    "author": "mgechev",
    "message": "fix(core): invoke profiler around ngOnDestroy lifecycle hooks (#41969)\n\nInvoke the profiler for `ngOnDestroy` lifecycle hooks for services,\ncomponents, directives, and pipes.\n\nPR Close #41969",
    "sha": "544e6a5ca15c6e7be3e113dca4e2f789cc91c53a",
    "files": [
        {
            "sha": "f260a7616204961ac818d53591b028940a16a7b2",
            "filename": "packages/core/src/render3/node_manipulation.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/544e6a5ca15c6e7be3e113dca4e2f789cc91c53a/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "raw_url": "https://github.com/angular/angular/raw/544e6a5ca15c6e7be3e113dca4e2f789cc91c53a/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts?ref=544e6a5ca15c6e7be3e113dca4e2f789cc91c53a",
            "patch": "@@ -26,6 +26,7 @@ import {RComment, RElement, RNode, RText} from './interfaces/renderer_dom';\n import {isLContainer, isLView} from './interfaces/type_checks';\n import {CHILD_HEAD, CLEANUP, DECLARATION_COMPONENT_VIEW, DECLARATION_LCONTAINER, DestroyHookData, FLAGS, HookData, HookFn, HOST, LView, LViewFlags, NEXT, PARENT, QUERIES, RENDERER, T_HOST, TVIEW, TView, TViewType, unusedValueExportToPlacateAjd as unused5} from './interfaces/view';\n import {assertTNodeType} from './node_assert';\n+import {profiler, ProfilerEvent} from './profiler';\n import {getLViewParent} from './util/view_traversal_utils';\n import {getNativeByTNode, unwrapRNode, updateTransplantedViewCount} from './util/view_utils';\n \n@@ -506,10 +507,22 @@ function executeOnDestroys(tView: TView, lView: LView): void {\n \n         if (Array.isArray(toCall)) {\n           for (let j = 0; j < toCall.length; j += 2) {\n-            (toCall[j + 1] as HookFn).call(context[toCall[j] as number]);\n+            const callContext = context[toCall[j] as number];\n+            const hook = toCall[j + 1] as HookFn;\n+            profiler(ProfilerEvent.LifecycleHookStart, callContext, hook);\n+            try {\n+              hook.call(callContext);\n+            } finally {\n+              profiler(ProfilerEvent.LifecycleHookEnd, callContext, hook);\n+            }\n           }\n         } else {\n-          toCall.call(context);\n+          profiler(ProfilerEvent.LifecycleHookStart, context, toCall);\n+          try {\n+            toCall.call(context);\n+          } finally {\n+            profiler(ProfilerEvent.LifecycleHookEnd, context, toCall);\n+          }\n         }\n       }\n     }"
        },
        {
            "sha": "c9b4177af41899ad056e3f945f788b5a251afe1f",
            "filename": "packages/core/test/acceptance/profiler_spec.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 3,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/544e6a5ca15c6e7be3e113dca4e2f789cc91c53a/packages%2Fcore%2Ftest%2Facceptance%2Fprofiler_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/544e6a5ca15c6e7be3e113dca4e2f789cc91c53a/packages%2Fcore%2Ftest%2Facceptance%2Fprofiler_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fprofiler_spec.ts?ref=544e6a5ca15c6e7be3e113dca4e2f789cc91c53a",
            "patch": "@@ -11,7 +11,7 @@ import {TestBed} from '@angular/core/testing';\n import {expect} from '@angular/core/testing/src/testing_internal';\n import {onlyInIvy} from '@angular/private/testing';\n \n-import {AfterContentChecked, AfterContentInit, AfterViewChecked, AfterViewInit, Component, DoCheck, ErrorHandler, EventEmitter, Input, OnChanges, OnInit, Output, ViewChild} from '../../src/core';\n+import {AfterContentChecked, AfterContentInit, AfterViewChecked, AfterViewInit, Component, DoCheck, ErrorHandler, EventEmitter, Input, OnChanges, OnDestroy, OnInit, Output, ViewChild} from '../../src/core';\n \n \n onlyInIvy('Ivy-specific functionality').describe('profiler', () => {\n@@ -187,13 +187,19 @@ onlyInIvy('Ivy-specific functionality').describe('profiler', () => {\n \n   describe('lifecycle hooks', () => {\n     it('should call the profiler on lifecycle execution', () => {\n-      @Component({selector: 'my-comp', template: '{{prop}}'})\n+      class Service implements OnDestroy {\n+        ngOnDestroy() {}\n+      }\n+      @Component({selector: 'my-comp', template: '{{prop}}', providers: [Service]})\n       class MyComponent implements OnInit, AfterViewInit, AfterViewChecked, AfterContentInit,\n-                                   AfterContentChecked, OnChanges, DoCheck {\n+                                   AfterContentChecked, OnChanges, DoCheck, OnDestroy {\n         @Input() prop = 1;\n \n+        constructor(private service: Service) {}\n+\n         ngOnInit() {}\n         ngDoCheck() {}\n+        ngOnDestroy() {}\n         ngOnChanges() {}\n         ngAfterViewInit() {}\n         ngAfterViewChecked() {}\n@@ -293,6 +299,27 @@ onlyInIvy('Ivy-specific functionality').describe('profiler', () => {\n       expect(onChangesSpy).toHaveBeenCalled();\n       expect(ngOnChangesStart).toBeTruthy();\n       expect(ngOnChangesEnd).toBeTruthy();\n+\n+      fixture.destroy();\n+      const ngOnDestroyStart = findProfilerCall(\n+          (args: any[]) =>\n+              args[0] === ProfilerEvent.LifecycleHookStart && args[2] === myComp.ngOnDestroy);\n+      const ngOnDestroyEnd = findProfilerCall(\n+          (args: any[]) =>\n+              args[0] === ProfilerEvent.LifecycleHookEnd && args[2] === myComp.ngOnDestroy);\n+\n+      expect(ngOnDestroyStart).toBeTruthy();\n+      expect(ngOnDestroyEnd).toBeTruthy();\n+\n+      const serviceNgOnDestroyStart = findProfilerCall(\n+          (args: any[]) => args[0] === ProfilerEvent.LifecycleHookStart &&\n+              args[2] === Service.prototype.ngOnDestroy);\n+      const serviceNgOnDestroyEnd = findProfilerCall(\n+          (args: any[]) => args[0] === ProfilerEvent.LifecycleHookEnd &&\n+              args[2] === Service.prototype.ngOnDestroy);\n+\n+      expect(serviceNgOnDestroyStart).toBeTruthy();\n+      expect(serviceNgOnDestroyEnd).toBeTruthy();\n     });\n   });\n "
        }
    ],
    "stats": {
        "total": 50,
        "additions": 45,
        "deletions": 5
    }
}