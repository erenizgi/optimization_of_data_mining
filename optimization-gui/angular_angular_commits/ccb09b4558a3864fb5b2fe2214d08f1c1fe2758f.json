{
    "author": "atscott",
    "message": "fix(router): null/undefined routerLink should disable navigation (#43087)\n\nThe current behavior of `routerLink` for `null` and `undefined` inputs is to treat\nthe input the same as `[]`. This creates several unresolvable issues with\ncorrectly disabling the links because `commands = []` does _not_ behave the same\nas disabling a link. Instead, it navigates to the current page, but will also\nclear any fragment and/or query params.\n\nThe new behavior of the `routerLink` input will be to completely disable navigation\nfor `null` and `undefined` inputs. For HTML Anchor elements, this will also mean\nremoving the `href` attribute.\n\nFixes #21457\nFixes #13980\nFixes #31154\n\nBREAKING CHANGE:\nPreviously `null` and `undefined` inputs for `routerLink` were\nequaivalent to empty string and there was no way to disable the link's\nnavigation.\nIn addition, the `href` is changed from a property `HostBinding()` to an\nattribute binding (`HostBinding('attr.href')`). The effect of this\nchange is that `DebugElement.properties['href']` will now return the\n`href` value returned by the native element which will be the full URL\nrather than the internal value of the `RouterLink` `href` property.\n\nPR Close #43087",
    "sha": "ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f",
    "files": [
        {
            "sha": "cd9ea88b9ab9a9dae7775c1fc2288e38dc4d9b36",
            "filename": "goldens/public-api/router/router.md",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f/goldens%2Fpublic-api%2Frouter%2Frouter.md",
            "raw_url": "https://github.com/angular/angular/raw/ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f/goldens%2Fpublic-api%2Frouter%2Frouter.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Frouter%2Frouter.md?ref=ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f",
            "patch": "@@ -524,7 +524,7 @@ export class RouterEvent {\n \n // @public\n export class RouterLink implements OnChanges {\n-    constructor(router: Router, route: ActivatedRoute, tabIndex: string, renderer: Renderer2, el: ElementRef);\n+    constructor(router: Router, route: ActivatedRoute, tabIndexAttribute: string | null | undefined, renderer: Renderer2, el: ElementRef);\n     fragment?: string;\n     // (undocumented)\n     ngOnChanges(changes: SimpleChanges): void;\n@@ -541,7 +541,7 @@ export class RouterLink implements OnChanges {\n         [k: string]: any;\n     };\n     // (undocumented)\n-    get urlTree(): UrlTree;\n+    get urlTree(): UrlTree | null;\n }\n \n // @public\n@@ -571,7 +571,7 @@ export class RouterLinkWithHref implements OnChanges, OnDestroy {\n     constructor(router: Router, route: ActivatedRoute, locationStrategy: LocationStrategy);\n     fragment?: string;\n     // (undocumented)\n-    href: string;\n+    href: string | null;\n     // (undocumented)\n     ngOnChanges(changes: SimpleChanges): any;\n     // (undocumented)\n@@ -591,7 +591,7 @@ export class RouterLinkWithHref implements OnChanges, OnDestroy {\n     // (undocumented)\n     target: string;\n     // (undocumented)\n-    get urlTree(): UrlTree;\n+    get urlTree(): UrlTree | null;\n }\n \n // @public"
        },
        {
            "sha": "0a1b487361dcc63525a07876e79e20da302a1b69",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f",
            "patch": "@@ -1427,9 +1427,6 @@\n   {\n     \"name\": \"getSelectedIndex\"\n   },\n-  {\n-    \"name\": \"getSelectedTNode\"\n-  },\n   {\n     \"name\": \"getSimpleChangesStore\"\n   },\n@@ -1517,9 +1514,6 @@\n   {\n     \"name\": \"invokeHostBindingsInCreationMode\"\n   },\n-  {\n-    \"name\": \"isAnimationProp\"\n-  },\n   {\n     \"name\": \"isArray\"\n   },\n@@ -1907,9 +1901,6 @@\n   {\n     \"name\": \"setInjectImplementation\"\n   },\n-  {\n-    \"name\": \"setInputsForProperty\"\n-  },\n   {\n     \"name\": \"setInputsFromAttrs\"\n   },\n@@ -2096,9 +2087,6 @@\n   {\n     \"name\": \"ɵɵelementStart\"\n   },\n-  {\n-    \"name\": \"ɵɵhostProperty\"\n-  },\n   {\n     \"name\": \"ɵɵinject\"\n   },"
        },
        {
            "sha": "4221edfe6901428dc01783fdce043c609ad1fd39",
            "filename": "packages/router/src/directives/router_link.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 18,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link.ts",
            "raw_url": "https://github.com/angular/angular/raw/ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link.ts?ref=ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f",
            "patch": "@@ -180,17 +180,32 @@ export class RouterLink implements OnChanges {\n    */\n   @Input() relativeTo?: ActivatedRoute|null;\n \n-  private commands: any[] = [];\n-  private preserve!: boolean;\n+  private commands: any[]|null = null;\n \n   /** @internal */\n   onChanges = new Subject<RouterLink>();\n \n   constructor(\n       private router: Router, private route: ActivatedRoute,\n-      @Attribute('tabindex') tabIndex: string, renderer: Renderer2, el: ElementRef) {\n-    if (tabIndex == null) {\n-      renderer.setAttribute(el.nativeElement, 'tabindex', '0');\n+      @Attribute('tabindex') private readonly tabIndexAttribute: string|null|undefined,\n+      private readonly renderer: Renderer2, private readonly el: ElementRef) {\n+    this.setTabIndexIfNotOnNativeEl('0');\n+  }\n+\n+  /**\n+   * Modifies the tab index if there was not a tabindex attribute on the element during\n+   * instantiation.\n+   */\n+  private setTabIndexIfNotOnNativeEl(newTabIndex: string|null) {\n+    if (this.tabIndexAttribute != null /* both `null` and `undefined` */) {\n+      return;\n+    }\n+    const renderer = this.renderer;\n+    const nativeElement = this.el.nativeElement;\n+    if (newTabIndex !== null) {\n+      renderer.setAttribute(nativeElement, 'tabindex', newTabIndex);\n+    } else {\n+      renderer.removeAttribute(nativeElement, 'tabindex');\n     }\n   }\n \n@@ -205,21 +220,27 @@ export class RouterLink implements OnChanges {\n    * Commands to pass to {@link Router#createUrlTree Router#createUrlTree}.\n    *   - **array**: commands to pass to {@link Router#createUrlTree Router#createUrlTree}.\n    *   - **string**: shorthand for array of commands with just the string, i.e. `['/route']`\n-   *   - **null|undefined**: shorthand for an empty array of commands, i.e. `[]`\n+   *   - **null|undefined**: effectively disables the `routerLink`\n    * @see {@link Router#createUrlTree Router#createUrlTree}\n    */\n   @Input()\n   set routerLink(commands: any[]|string|null|undefined) {\n     if (commands != null) {\n       this.commands = Array.isArray(commands) ? commands : [commands];\n+      this.setTabIndexIfNotOnNativeEl('0');\n     } else {\n-      this.commands = [];\n+      this.commands = null;\n+      this.setTabIndexIfNotOnNativeEl(null);\n     }\n   }\n \n   /** @nodoc */\n   @HostListener('click')\n   onClick(): boolean {\n+    if (this.urlTree === null) {\n+      return true;\n+    }\n+\n     const extras = {\n       skipLocationChange: attrBoolValue(this.skipLocationChange),\n       replaceUrl: attrBoolValue(this.replaceUrl),\n@@ -229,7 +250,10 @@ export class RouterLink implements OnChanges {\n     return true;\n   }\n \n-  get urlTree(): UrlTree {\n+  get urlTree(): UrlTree|null {\n+    if (this.commands === null) {\n+      return null;\n+    }\n     return this.router.createUrlTree(this.commands, {\n       // If the `relativeTo` input is not defined, we want to use `this.route` by default.\n       // Otherwise, we should use the value provided by the user in the input.\n@@ -320,14 +344,13 @@ export class RouterLinkWithHref implements OnChanges, OnDestroy {\n    */\n   @Input() relativeTo?: ActivatedRoute|null;\n \n-  private commands: any[] = [];\n+  private commands: any[]|null = null;\n   private subscription: Subscription;\n-  // TODO(issue/24571): remove '!'.\n-  private preserve!: boolean;\n \n   // the url displayed on the anchor element.\n-  // TODO(issue/24571): remove '!'.\n-  @HostBinding() href!: string;\n+  // @HostBinding('attr.href') is used rather than @HostBinding() because it removes the\n+  // href attribute when it becomes `null`.\n+  @HostBinding('attr.href') href: string|null = null;\n \n   /** @internal */\n   onChanges = new Subject<RouterLinkWithHref>();\n@@ -346,15 +369,15 @@ export class RouterLinkWithHref implements OnChanges, OnDestroy {\n    * Commands to pass to {@link Router#createUrlTree Router#createUrlTree}.\n    *   - **array**: commands to pass to {@link Router#createUrlTree Router#createUrlTree}.\n    *   - **string**: shorthand for array of commands with just the string, i.e. `['/route']`\n-   *   - **null|undefined**: shorthand for an empty array of commands, i.e. `[]`\n+   *   - **null|undefined**: Disables the link by removing the `href`\n    * @see {@link Router#createUrlTree Router#createUrlTree}\n    */\n   @Input()\n   set routerLink(commands: any[]|string|null|undefined) {\n     if (commands != null) {\n       this.commands = Array.isArray(commands) ? commands : [commands];\n     } else {\n-      this.commands = [];\n+      this.commands = null;\n     }\n   }\n \n@@ -378,7 +401,7 @@ export class RouterLinkWithHref implements OnChanges, OnDestroy {\n       return true;\n     }\n \n-    if (typeof this.target === 'string' && this.target != '_self') {\n+    if (typeof this.target === 'string' && this.target != '_self' || this.urlTree === null) {\n       return true;\n     }\n \n@@ -392,10 +415,15 @@ export class RouterLinkWithHref implements OnChanges, OnDestroy {\n   }\n \n   private updateTargetUrlAndHref(): void {\n-    this.href = this.locationStrategy.prepareExternalUrl(this.router.serializeUrl(this.urlTree));\n+    this.href = this.urlTree !== null ?\n+        this.locationStrategy.prepareExternalUrl(this.router.serializeUrl(this.urlTree)) :\n+        null;\n   }\n \n-  get urlTree(): UrlTree {\n+  get urlTree(): UrlTree|null {\n+    if (this.commands === null) {\n+      return null;\n+    }\n     return this.router.createUrlTree(this.commands, {\n       // If the `relativeTo` input is not defined, we want to use `this.route` by default.\n       // Otherwise, we should use the value provided by the user in the input."
        },
        {
            "sha": "6e9c260537cc8d0e1af1f0f95c24025d46f769ca",
            "filename": "packages/router/src/directives/router_link_active.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts",
            "raw_url": "https://github.com/angular/angular/raw/ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts?ref=ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f",
            "patch": "@@ -173,7 +173,8 @@ export class RouterLinkActive implements OnChanges, OnDestroy, AfterContentInit\n         this.routerLinkActiveOptions :\n         // While the types should disallow `undefined` here, it's possible without strict inputs\n         (this.routerLinkActiveOptions.exact || false);\n-    return (link: RouterLink|RouterLinkWithHref) => router.isActive(link.urlTree, options);\n+    return (link: RouterLink|RouterLinkWithHref) =>\n+               link.urlTree ? router.isActive(link.urlTree, options) : false;\n   }\n \n   private hasActiveLinks(): boolean {"
        },
        {
            "sha": "bbdb6d35423cf706fc423ea9e4fed79416eb7845",
            "filename": "packages/router/test/router_link_spec.ts",
            "status": "added",
            "additions": 104,
            "deletions": 0,
            "changes": 104,
            "blob_url": "https://github.com/angular/angular/blob/ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f/packages%2Frouter%2Ftest%2Frouter_link_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f/packages%2Frouter%2Ftest%2Frouter_link_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Frouter_link_spec.ts?ref=ccb09b4558a3864fb5b2fe2214d08f1c1fe2758f",
            "patch": "@@ -0,0 +1,104 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Component} from '@angular/core';\n+import {ComponentFixture, TestBed} from '@angular/core/testing';\n+import {By} from '@angular/platform-browser';\n+import {Router} from '@angular/router';\n+import {RouterTestingModule} from '@angular/router/testing';\n+\n+describe('RouterLink', () => {\n+  it('does not modify tabindex if already set on non-anchor element', () => {\n+    @Component({template: `<div [routerLink]=\"link\" tabindex=\"1\"></div>`})\n+    class LinkComponent {\n+      link: string|null|undefined = '/';\n+    }\n+    TestBed.configureTestingModule({imports: [RouterTestingModule], declarations: [LinkComponent]});\n+    const fixture = TestBed.createComponent(LinkComponent);\n+    fixture.detectChanges();\n+    const link = fixture.debugElement.query(By.css('div')).nativeElement;\n+    expect(link.tabIndex).toEqual(1);\n+\n+    fixture.nativeElement.link = null;\n+    fixture.detectChanges();\n+    expect(link.tabIndex).toEqual(1);\n+  });\n+\n+  describe('on a non-anchor', () => {\n+    @Component({template: `<div [routerLink]=\"link\"></div>`})\n+    class LinkComponent {\n+      link: string|null|undefined = '/';\n+    }\n+    let fixture: ComponentFixture<LinkComponent>;\n+    let link: HTMLDivElement;\n+    let router: Router;\n+\n+    beforeEach(() => {\n+      TestBed.configureTestingModule(\n+          {imports: [RouterTestingModule], declarations: [LinkComponent]});\n+      fixture = TestBed.createComponent(LinkComponent);\n+      fixture.detectChanges();\n+      link = fixture.debugElement.query(By.css('div')).nativeElement;\n+      router = TestBed.inject(Router);\n+\n+      spyOn(router, 'navigateByUrl');\n+      link.click();\n+      expect(router.navigateByUrl).toHaveBeenCalled();\n+      (router.navigateByUrl as jasmine.Spy).calls.reset();\n+    });\n+\n+    it('null, removes tabIndex and does not navigate', () => {\n+      fixture.componentInstance.link = null;\n+      fixture.detectChanges();\n+      expect(link.tabIndex).toEqual(-1);\n+\n+      link.click();\n+      expect(router.navigateByUrl).not.toHaveBeenCalled();\n+    });\n+\n+    it('undefined, removes tabIndex and does not navigate', () => {\n+      fixture.componentInstance.link = undefined;\n+      fixture.detectChanges();\n+      expect(link.tabIndex).toEqual(-1);\n+\n+      link.click();\n+      expect(router.navigateByUrl).not.toHaveBeenCalled();\n+    });\n+  });\n+\n+  describe('RouterLinkWithHref', () => {\n+    @Component({template: `<a [routerLink]=\"link\"></a>`})\n+    class LinkComponent {\n+      link: string|null|undefined = '/';\n+    }\n+    let fixture: ComponentFixture<LinkComponent>;\n+    let link: HTMLAnchorElement;\n+\n+    beforeEach(() => {\n+      TestBed.configureTestingModule(\n+          {imports: [RouterTestingModule], declarations: [LinkComponent]});\n+      fixture = TestBed.createComponent(LinkComponent);\n+      fixture.detectChanges();\n+      link = fixture.debugElement.query(By.css('a')).nativeElement;\n+    });\n+\n+    it('null, removes href', () => {\n+      expect(link.outerHTML).toContain('href');\n+      fixture.componentInstance.link = null;\n+      fixture.detectChanges();\n+      expect(link.outerHTML).not.toContain('href');\n+    });\n+\n+    it('undefined, removes href', () => {\n+      expect(link.outerHTML).toContain('href');\n+      fixture.componentInstance.link = undefined;\n+      fixture.detectChanges();\n+      expect(link.outerHTML).not.toContain('href');\n+    });\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 191,
        "additions": 156,
        "deletions": 35
    }
}