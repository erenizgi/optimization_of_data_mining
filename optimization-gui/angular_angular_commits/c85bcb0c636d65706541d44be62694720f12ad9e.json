{
    "author": "petebacondarwin",
    "message": "feat(compiler): reference ICU message IDs from their placeholders (#43534)\n\nWhen extracting i18n messages from templates, ICU messages are split out from the\nmessage that contains them. This can make it difficult in the translation files to match up\nthe two messages, especially if the ICU is reused in multiple placeholders.\n\nThis commit builds on top of the previous one to expose the message ID of ICU messages\nfrom the ICU placeholders as additional metadata in the `$localize` tagged strings.\nNow the metablock following any placeholder can also contain the associated ID\ndelimited from the placeholder name by `@@`.\n\nFixes #17506\n\nPR Close #43534",
    "sha": "c85bcb0c636d65706541d44be62694720f12ad9e",
    "files": [
        {
            "sha": "8bf37b79aaa3ac23362622864e19caf3ffcf6bd0",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2FGOLDEN_PARTIAL.js?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -10,14 +10,14 @@ export class MyComponent {\n }\n MyComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });\n MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: `\n-  <div i18n>{gender, select, male {male} female {female} other {other}}</div>\n+  <div i18n>before {gender, select, male {male} female {female} other {other}} after</div>\n `, isInline: true });\n i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyComponent, decorators: [{\n             type: Component,\n             args: [{\n                     selector: 'my-component',\n                     template: `\n-  <div i18n>{gender, select, male {male} female {female} other {other}}</div>\n+  <div i18n>before {gender, select, male {male} female {female} other {other}} after</div>\n `\n                 }]\n         }] });"
        },
        {
            "sha": "2d327eec3c45502913fc0f56c3407e62cbf05333",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/TEST_CASES.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2FTEST_CASES.json?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -4,7 +4,7 @@\n     {\n       \"description\": \"should handle single icus\",\n       \"inputFiles\": [\n-        \"single_icu\"\n+        \"single_icu.ts\"\n       ],\n       \"expectations\": [\n         {"
        },
        {
            "sha": "41d3cad9c15e74e02ede86937f10b927ec408944",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/different_contexts.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fdifferent_contexts.js",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fdifferent_contexts.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fdifferent_contexts.js?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -17,7 +17,7 @@ vars: 2,\n consts: function() {\n   __i18nIcuMsg__('{VAR_SELECT, select, male {male} female {female} other {other}}', [['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`]])\n   __i18nIcuMsg__('{VAR_SELECT, select, 10 {ten} 20 {twenty} 30 {thirty} other {other}}', [['VAR_SELECT', String.raw`\\uFFFD0:1\\uFFFD`]])\n-  __i18nMsg__(' {$icu} {$startTagSpan} {$icu_1} {$closeTagSpan}', [['startTagSpan', String.raw`\\uFFFD*2:1\\uFFFD\\uFFFD#1:1\\uFFFD`], ['closeTagSpan', String.raw`\\uFFFD/#1:1\\uFFFD\\uFFFD/*2:1\\uFFFD`], ['icu', '$i18n_0$'], ['icu_1', '$i18n_1$']], {})\n+  __i18nMsg__(' {$icu} {$startTagSpan} {$icu_1} {$closeTagSpan}', [['startTagSpan', String.raw`\\uFFFD*2:1\\uFFFD\\uFFFD#1:1\\uFFFD`], ['closeTagSpan', String.raw`\\uFFFD/#1:1\\uFFFD\\uFFFD/*2:1\\uFFFD`], ['icu', '$i18n_0$', '7670372064920373295'], ['icu_1', '$i18n_1$', '4590395557003415341']], {})\n   return [\n     $i18n_2$,\n     [__AttributeMarker.Template__, \"ngIf\"]"
        },
        {
            "sha": "0940368f642c42f4f4daf296a5a89bbb549a5fc4",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/html_content.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fhtml_content.js",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fhtml_content.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fhtml_content.js?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -2,7 +2,7 @@ decls: 5,\n vars: 1,\n consts: function() {\n   __i18nIcuMsg__('{VAR_SELECT, select, male {male - {START_BOLD_TEXT}male{CLOSE_BOLD_TEXT}} female {female {START_BOLD_TEXT}female{CLOSE_BOLD_TEXT}} other {{START_TAG_DIV}{START_ITALIC_TEXT}other{CLOSE_ITALIC_TEXT}{CLOSE_TAG_DIV}}}', [['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`], ['START_BOLD_TEXT', '<b>'], ['CLOSE_BOLD_TEXT', '</b>'], ['START_ITALIC_TEXT', '<i>'], ['CLOSE_ITALIC_TEXT', '</i>'], ['START_TAG_DIV', '<div class=\\\\\"other\\\\\">'], ['CLOSE_TAG_DIV', '</div>'],])\n-  __i18nMsg__(' {$icu} {$startBoldText}Other content{$closeBoldText}{$startTagDiv}{$startItalicText}Another content{$closeItalicText}{$closeTagDiv}', [['startBoldText', String.raw`\\uFFFD#2\\uFFFD`], ['closeBoldText', String.raw`\\uFFFD/#2\\uFFFD`], ['startTagDiv', String.raw`\\uFFFD#3\\uFFFD`], ['startItalicText', String.raw`\\uFFFD#4\\uFFFD`], ['closeItalicText', String.raw`\\uFFFD/#4\\uFFFD`], ['closeTagDiv', String.raw`\\uFFFD/#3\\uFFFD`], ['icu', '$I18N_1$']], {})\n+  __i18nMsg__(' {$icu} {$startBoldText}Other content{$closeBoldText}{$startTagDiv}{$startItalicText}Another content{$closeItalicText}{$closeTagDiv}', [['startBoldText', String.raw`\\uFFFD#2\\uFFFD`], ['closeBoldText', String.raw`\\uFFFD/#2\\uFFFD`], ['startTagDiv', String.raw`\\uFFFD#3\\uFFFD`], ['startItalicText', String.raw`\\uFFFD#4\\uFFFD`], ['closeItalicText', String.raw`\\uFFFD/#4\\uFFFD`], ['closeTagDiv', String.raw`\\uFFFD/#3\\uFFFD`], ['icu', '$I18N_1$', '4731057199984078679']], {})\n   return [\n     $i18n_1$,\n     [__AttributeMarker.Classes__, \"other\"]"
        },
        {
            "sha": "01f94d0a4b17c00651706084f2f6ebe89182dd06",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/icu_with_interpolations.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Ficu_with_interpolations.js",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Ficu_with_interpolations.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Ficu_with_interpolations.js?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -17,7 +17,7 @@ vars: 4,\n consts: function() {\n   __i18nIcuMsg__('{VAR_SELECT, select, male {male {INTERPOLATION}} female {female {INTERPOLATION_1}} other {other}}',[ ['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`], ['INTERPOLATION', String.raw`\\uFFFD1\\uFFFD`], ['INTERPOLATION_1', String.raw`\\uFFFD2\\uFFFD`]])\n   __i18nIcuMsg__('{VAR_SELECT, select, 10 {ten} 20 {twenty} 30 {thirty} other {other: {INTERPOLATION}}}', [['VAR_SELECT', String.raw`\\uFFFD0:1\\uFFFD`], ['INTERPOLATION', String.raw`\\uFFFD1:1\\uFFFD`]])\n-  __i18nMsg__(' {$icu} {$startTagSpan} {$icu_1} {$closeTagSpan}', [['startTagSpan', String.raw`\\uFFFD*2:1\\uFFFD\\uFFFD#1:1\\uFFFD`], ['closeTagSpan', String.raw`\\uFFFD/#1:1\\uFFFD\\uFFFD/*2:1\\uFFFD`], ['icu', '$i18n_0$'], ['icu_1', '$i18n_1$']], {})\n+  __i18nMsg__(' {$icu} {$startTagSpan} {$icu_1} {$closeTagSpan}', [['startTagSpan', String.raw`\\uFFFD*2:1\\uFFFD\\uFFFD#1:1\\uFFFD`], ['closeTagSpan', String.raw`\\uFFFD/#1:1\\uFFFD\\uFFFD/*2:1\\uFFFD`], ['icu', '$i18n_0$', '567200399523107034'], ['icu_1', '$i18n_1$', '5762277079421427850']], {})\n   return [\n     $i18n_2$,\n     [__AttributeMarker.Template__, \"ngIf\"]"
        },
        {
            "sha": "b222ec51c00c183f47afc18f9e49ee6ea886ed03",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/multiple_icus.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fmultiple_icus.js",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fmultiple_icus.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fmultiple_icus.js?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -3,7 +3,7 @@ vars: 2,\n consts: function() {\n   __i18nIcuMsg__('{VAR_SELECT, select, male {male} female {female} other {other}}', [['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`]])\n   __i18nIcuMsg__('{VAR_SELECT, select, 10 {ten} 20 {twenty} 30 {thirty} other {other}}', [['VAR_SELECT', String.raw`\\uFFFD1\\uFFFD`]])\n-  __i18nMsg__(' {$icu} {$icu_1} ', [['icu', '$i18n_0$'], ['icu_1', '$i18n_1$']], {})\n+  __i18nMsg__(' {$icu} {$icu_1} ', [['icu', '$i18n_0$', '7670372064920373295'], ['icu_1', '$i18n_1$', '4590395557003415341']], {})\n   return [\n     $i18n_2$\n   ];"
        },
        {
            "sha": "5bbf6193f7956fd8979341ed0889aaed383c8f52",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/nested_icus.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fnested_icus.js",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fnested_icus.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fnested_icus.js?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -2,7 +2,7 @@ decls: 2,\n vars: 2,\n consts: function() {\n   __i18nIcuMsg__('{VAR_SELECT_1, select, male {male of age: {VAR_SELECT, select, 10 {ten} 20 {twenty} 30 {thirty} other {other}}} female {female} other {other}}', [['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`], ['VAR_SELECT_1', String.raw`\\uFFFD1\\uFFFD`]])\n-  __i18nMsg__(' {$icu} ', [['icu', '$i18n_0$']], {})\n+  __i18nMsg__(' {$icu} ', [['icu', '$i18n_0$', '2960440207608193372']], {})\n   return [\n     $i18n_1$\n   ];"
        },
        {
            "sha": "0fa9fc336f8496afe2dd3eccd40269db2e9e936d",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/shared_placeholder.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fshared_placeholder.js",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fshared_placeholder.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fshared_placeholder.js?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -63,7 +63,7 @@ consts: function() {\n       $I18N_0$ = $MSG_APP_SPEC_TS_0$;\n   }\n   else {\n-      $I18N_0$ = $localize ` ${\"\\uFFFDI18N_EXP_ICU\\uFFFD\"}:ICU: ${\"\\uFFFD#2\\uFFFD\"}:START_TAG_DIV: ${\"\\uFFFDI18N_EXP_ICU\\uFFFD\"}:ICU: ${\"[\\uFFFD/#2\\uFFFD|\\uFFFD/#1:1\\uFFFD\\uFFFD/*3:1\\uFFFD]\"}:CLOSE_TAG_DIV:${\"\\uFFFD*3:1\\uFFFD\\uFFFD#1:1\\uFFFD\"}:START_TAG_DIV_1: ${\"\\uFFFDI18N_EXP_ICU\\uFFFD\"}:ICU: ${\"[\\uFFFD/#2\\uFFFD|\\uFFFD/#1:1\\uFFFD\\uFFFD/*3:1\\uFFFD]\"}:CLOSE_TAG_DIV:`;\n+      $I18N_0$ = $localize ` ${\"\\uFFFDI18N_EXP_ICU\\uFFFD\"}:ICU@@7670372064920373295: ${\"\\uFFFD#2\\uFFFD\"}:START_TAG_DIV: ${\"\\uFFFDI18N_EXP_ICU\\uFFFD\"}:ICU@@7670372064920373295: ${\"[\\uFFFD/#2\\uFFFD|\\uFFFD/#1:1\\uFFFD\\uFFFD/*3:1\\uFFFD]\"}:CLOSE_TAG_DIV:${\"\\uFFFD*3:1\\uFFFD\\uFFFD#1:1\\uFFFD\"}:START_TAG_DIV_1: ${\"\\uFFFDI18N_EXP_ICU\\uFFFD\"}:ICU@@7670372064920373295: ${\"[\\uFFFD/#2\\uFFFD|\\uFFFD/#1:1\\uFFFD\\uFFFD/*3:1\\uFFFD]\"}:CLOSE_TAG_DIV:`;\n   }\n \n   $I18N_0$ = $r3$.ɵɵi18nPostprocess($I18N_0$, {"
        },
        {
            "sha": "19073b2db8f66583fe1751dadf3b28707c9e1c03",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/single_icu.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fsingle_icu.js",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fsingle_icu.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fsingle_icu.js?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -2,9 +2,8 @@ decls: 2,\n vars: 1,\n consts: function() {\n   __i18nIcuMsg__('{VAR_SELECT, select, male {male} female {female} other {other}}',[['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`]])\n-  return [\n-    $i18n_0$\n-  ];\n+  __i18nMsg__('before {$icu} after', [['icu', '$i18n_0$', '7670372064920373295']], {})\n+  return [$i18n_1$];\n },\n template: function MyComponent_Template(rf, ctx) {\n   if (rf & 1) {"
        },
        {
            "sha": "26df5be3e61018f552e1db02332767fe8ff8d99f",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/single_icu.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fsingle_icu.ts",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fsingle_icu.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fsingle_icu.ts?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -3,7 +3,7 @@ import {Component, NgModule} from '@angular/core';\n @Component({\n   selector: 'my-component',\n   template: `\n-  <div i18n>{gender, select, male {male} female {female} other {other}}</div>\n+  <div i18n>before {gender, select, male {male} female {female} other {other}} after</div>\n `\n })\n export class MyComponent {"
        },
        {
            "sha": "21fe2510915633438bc86a9a5f55641b4ec9c4e6",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/line_ending_normalization/external_template_non_legacy.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fline_ending_normalization%2Fexternal_template_non_legacy.js",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fline_ending_normalization%2Fexternal_template_non_legacy.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fline_ending_normalization%2Fexternal_template_non_legacy.js?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -4,4 +4,4 @@ def`;\n $I18N_4$ = $localize `{VAR_SELECT, select, =0 {zero\n     }}`\n …\n-$I18N_3$ = $localize ` Some Message ${$I18N_4$}:ICU:`;\n+$I18N_3$ = $localize ` Some Message ${$I18N_4$}:ICU@@2416068396348331473:`;"
        },
        {
            "sha": "96918e9fd686ae353a87c655768f577442609169",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/line_ending_normalization/inline_template_non_legacy.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fline_ending_normalization%2Finline_template_non_legacy.js",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fline_ending_normalization%2Finline_template_non_legacy.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Fline_ending_normalization%2Finline_template_non_legacy.js?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -6,4 +6,4 @@ $I18N_4$ = $localize `{VAR_SELECT, select, =0 {zero\n …\n $I18N_3$ = $localize `\n Some Message\n-${$I18N_4$}:ICU:`;\n+${$I18N_4$}:ICU@@7530413425895265894:`;"
        },
        {
            "sha": "af2a6ed7714c173e182cc1bea77c69edaf1ff1bd",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/expected_file_macros.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fexpected_file_macros.ts",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fexpected_file_macros.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fexpected_file_macros.ts?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -59,9 +59,11 @@ function parsePlaceholders(str: string): Placeholder[] {\n   const placeholders = eval(`(${str})`);\n   if (!Array.isArray(placeholders) ||\n       !placeholders.every(\n-          p => Array.isArray(p) && p.length === 2 && typeof p[0] === 'string' &&\n-              typeof p[1] === 'string')) {\n-    throw new Error('Expected an array of Placeholder arrays (`[string, string]`) but got ' + str);\n+          p => Array.isArray(p) && p.length >= 2 && typeof p[0] === 'string' &&\n+              typeof p[1] === 'string' && (p.length === 2 || typeof p[2] === 'string'))) {\n+    throw new Error(\n+        'Expected an array of Placeholder arrays (`[name: string, identifier: string, associatedId?: string]`) but got ' +\n+        str);\n   }\n   return placeholders;\n }"
        },
        {
            "sha": "03c15cdfa2af5c0886047b010108d2edde87a717",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/i18n_helpers.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fi18n_helpers.ts",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fi18n_helpers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fi18n_helpers.ts?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -60,10 +60,12 @@ export function i18nIcuMsg(message: string, placeholders: Placeholder[]): string\n /**\n  * Describes placeholder type used in tests.\n  *\n- * Note: the type is an array (not an object), since it's important to preserve the order of\n- * placeholders (so that we can compare it with generated output).\n+ * - The first item is the placeholder name.\n+ * - The second item is the identifier of the variable that contains the placeholder.\n+ * - The third (optional) items is the id of the message that this placeholder references.\n+ *   This is used for matching ICU placeholders to ICU messages.\n  */\n-export type Placeholder = [string, string];\n+export type Placeholder = [name: string, indentifier: string, associatedId: string];\n \n /**\n  * Describes message metadata object.\n@@ -80,7 +82,7 @@ interface Meta {\n  */\n function i18nPlaceholdersToString(placeholders: Placeholder[]): string {\n   if (placeholders.length === 0) return '';\n-  const result = placeholders.map(([key, value]) => `\"${key}\": ${quotedValue(value)}`);\n+  const result = placeholders.map(([name, identifier]) => `\"${name}\": ${quotedValue(identifier)}`);\n   return `, { ${result.join(',')} }`;\n }\n \n@@ -90,11 +92,12 @@ function i18nPlaceholdersToString(placeholders: Placeholder[]): string {\n function i18nMsgInsertLocalizePlaceholders(message: string, placeholders: Placeholder[]): string {\n   if (placeholders.length > 0) {\n     message = message.replace(/{\\$(.*?)}/g, function(_, name) {\n-      const value = placeholders.find(([k, _]) => k === name)![1];\n+      const placeholder = placeholders.find((p) => p[0] === name)!;\n       // e.g. startDivTag -> START_DIV_TAG\n       const key = name.replace(/[A-Z]/g, (ch: string) => '_' + ch).toUpperCase();\n+      const associated = placeholder.length === 3 ? `@@${placeholder[2]}` : '';\n       return '$' +\n-          `{${quotedValue(value)}}:${key}:`;\n+          `{${quotedValue(placeholder[1])}}:${key}${associated}:`;\n     });\n   }\n   return message;"
        },
        {
            "sha": "4443c3d0a4f998b51afc78ec9fefe9d2923b123e",
            "filename": "packages/compiler/src/i18n/i18n_ast.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_ast.ts?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -26,6 +26,8 @@ export class Message {\n   /** The ids to use if there are no custom id and if `i18nLegacyMessageIdFormat` is not empty */\n   legacyIds: string[] = [];\n \n+  messageString = serializeMessage(this.nodes);\n+\n   /**\n    * @param nodes message AST\n    * @param placeholders maps placeholder names to static content and their source spans\n@@ -200,3 +202,42 @@ export class RecurseVisitor implements Visitor {\n \n   visitIcuPlaceholder(ph: IcuPlaceholder, context?: any): any {}\n }\n+\n+\n+/**\n+ * Serialize the message to the Localize backtick string format that would appear in compiled code.\n+ */\n+function serializeMessage(messageNodes: Node[]): string {\n+  const visitor = new LocalizeMessageStringVisitor();\n+  const str = messageNodes.map(n => n.visit(visitor)).join('');\n+  return str;\n+}\n+\n+class LocalizeMessageStringVisitor implements Visitor {\n+  visitText(text: Text): any {\n+    return text.value;\n+  }\n+\n+  visitContainer(container: Container): any {\n+    return container.children.map(child => child.visit(this)).join('');\n+  }\n+\n+  visitIcu(icu: Icu): any {\n+    const strCases =\n+        Object.keys(icu.cases).map((k: string) => `${k} {${icu.cases[k].visit(this)}}`);\n+    return `{${icu.expressionPlaceholder}, ${icu.type}, ${strCases.join(' ')}}`;\n+  }\n+\n+  visitTagPlaceholder(ph: TagPlaceholder): any {\n+    const children = ph.children.map(child => child.visit(this)).join('');\n+    return `{$${ph.startName}}${children}{$${ph.closeName}}`;\n+  }\n+\n+  visitPlaceholder(ph: Placeholder): any {\n+    return `{$${ph.name}}`;\n+  }\n+\n+  visitIcuPlaceholder(ph: IcuPlaceholder): any {\n+    return `{$${ph.name}}`;\n+  }\n+}"
        },
        {
            "sha": "81a325a1e3dc7d38bd59ecc75ab1c92fe439edfb",
            "filename": "packages/compiler/src/output/output_ast.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 11,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -6,6 +6,8 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {computeMsgId} from '../i18n/digest';\n+import {Message} from '../i18n/i18n_ast';\n import {ParseSourceSpan} from '../parse_util';\n import {I18nMeta} from '../render3/view/i18n/meta';\n \n@@ -524,11 +526,29 @@ export class TemplateLiteralElement {\n   }\n }\n \n-export abstract class MessagePiece {\n+export class LiteralPiece {\n   constructor(public text: string, public sourceSpan: ParseSourceSpan) {}\n }\n-export class LiteralPiece extends MessagePiece {}\n-export class PlaceholderPiece extends MessagePiece {}\n+export class PlaceholderPiece {\n+  /**\n+   * Create a new instance of a `PlaceholderPiece`.\n+   *\n+   * @param text the name of this placeholder (e.g. `PH_1`).\n+   * @param sourceSpan the location of this placeholder in its localized message the source code.\n+   * @param associatedMessage reference to another message that this placeholder is associated with.\n+   * The `associatedMessage` is mainly used to provide a relationship to an ICU message that has\n+   * been extracted out from the message containing the placeholder.\n+   */\n+  constructor(\n+      public text: string, public sourceSpan: ParseSourceSpan, public associatedMessage?: Message) {\n+  }\n+}\n+\n+export type MessagePiece = LiteralPiece|PlaceholderPiece;\n+\n+const MEANING_SEPARATOR = '|';\n+const ID_SEPARATOR = '@@';\n+const LEGACY_ID_INDICATOR = '␟';\n \n export class LocalizedString extends Expression {\n   constructor(\n@@ -560,10 +580,6 @@ export class LocalizedString extends Expression {\n    * @param messagePart The first part of the tagged string\n    */\n   serializeI18nHead(): CookedRawString {\n-    const MEANING_SEPARATOR = '|';\n-    const ID_SEPARATOR = '@@';\n-    const LEGACY_ID_INDICATOR = '␟';\n-\n     let metaBlock = this.metaBlock.description || '';\n     if (this.metaBlock.meaning) {\n       metaBlock = `${this.metaBlock.meaning}${MEANING_SEPARATOR}${metaBlock}`;\n@@ -593,14 +609,24 @@ export class LocalizedString extends Expression {\n    * Serialize the given `placeholderName` and `messagePart` into \"cooked\" and \"raw\" strings that\n    * can be used in a `$localize` tagged string.\n    *\n-   * @param placeholderName The placeholder name to serialize\n-   * @param messagePart The following message string after this placeholder\n+   * The format is `:<placeholder-name>[@@<associated-id>]:`.\n+   *\n+   * The `associated-id` is the message id of the (usually an ICU) message to which this placeholder\n+   * refers.\n+   *\n+   * @param partIndex The index of the message part to serialize.\n    */\n   serializeI18nTemplatePart(partIndex: number): CookedRawString {\n-    const placeholderName = this.placeHolderNames[partIndex - 1].text;\n+    const placeholder = this.placeHolderNames[partIndex - 1];\n     const messagePart = this.messageParts[partIndex];\n+    let metaBlock = placeholder.text;\n+    if (placeholder.associatedMessage?.legacyIds.length === 0) {\n+      metaBlock += `${ID_SEPARATOR}${\n+          computeMsgId(\n+              placeholder.associatedMessage.messageString, placeholder.associatedMessage.meaning)}`;\n+    }\n     return createCookedRawString(\n-        placeholderName, messagePart.text, this.getMessagePartSourceSpan(partIndex));\n+        metaBlock, messagePart.text, this.getMessagePartSourceSpan(partIndex));\n   }\n }\n "
        },
        {
            "sha": "436e353dd57ffed876bed5b5d5b37d82cea374d9",
            "filename": "packages/compiler/src/render3/view/i18n/localize_utils.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 21,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -30,50 +30,57 @@ export function createLocalizeStatements(\n  * The result can be used for generating the `$localize` tagged template literals.\n  */\n class LocalizeSerializerVisitor implements i18n.Visitor {\n-  visitText(text: i18n.Text, context: o.MessagePiece[]): any {\n-    if (context[context.length - 1] instanceof o.LiteralPiece) {\n+  constructor(\n+      private placeholderToMessage: {[phName: string]: i18n.Message},\n+      private pieces: o.MessagePiece[]) {}\n+\n+  visitText(text: i18n.Text): any {\n+    if (this.pieces[this.pieces.length - 1] instanceof o.LiteralPiece) {\n       // Two literal pieces in a row means that there was some comment node in-between.\n-      context[context.length - 1].text += text.value;\n+      this.pieces[this.pieces.length - 1].text += text.value;\n     } else {\n       const sourceSpan = new ParseSourceSpan(\n           text.sourceSpan.fullStart, text.sourceSpan.end, text.sourceSpan.fullStart,\n           text.sourceSpan.details);\n-      context.push(new o.LiteralPiece(text.value, sourceSpan));\n+      this.pieces.push(new o.LiteralPiece(text.value, sourceSpan));\n     }\n   }\n \n-  visitContainer(container: i18n.Container, context: o.MessagePiece[]): any {\n-    container.children.forEach(child => child.visit(this, context));\n+  visitContainer(container: i18n.Container): any {\n+    container.children.forEach(child => child.visit(this));\n   }\n \n-  visitIcu(icu: i18n.Icu, context: o.MessagePiece[]): any {\n-    context.push(new o.LiteralPiece(serializeIcuNode(icu), icu.sourceSpan));\n+  visitIcu(icu: i18n.Icu): any {\n+    this.pieces.push(new o.LiteralPiece(serializeIcuNode(icu), icu.sourceSpan));\n   }\n \n-  visitTagPlaceholder(ph: i18n.TagPlaceholder, context: o.MessagePiece[]): any {\n-    context.push(this.createPlaceholderPiece(ph.startName, ph.startSourceSpan ?? ph.sourceSpan));\n+  visitTagPlaceholder(ph: i18n.TagPlaceholder): any {\n+    this.pieces.push(\n+        this.createPlaceholderPiece(ph.startName, ph.startSourceSpan ?? ph.sourceSpan));\n     if (!ph.isVoid) {\n-      ph.children.forEach(child => child.visit(this, context));\n-      context.push(this.createPlaceholderPiece(ph.closeName, ph.endSourceSpan ?? ph.sourceSpan));\n+      ph.children.forEach(child => child.visit(this));\n+      this.pieces.push(\n+          this.createPlaceholderPiece(ph.closeName, ph.endSourceSpan ?? ph.sourceSpan));\n     }\n   }\n \n-  visitPlaceholder(ph: i18n.Placeholder, context: o.MessagePiece[]): any {\n-    context.push(this.createPlaceholderPiece(ph.name, ph.sourceSpan));\n+  visitPlaceholder(ph: i18n.Placeholder): any {\n+    this.pieces.push(this.createPlaceholderPiece(ph.name, ph.sourceSpan));\n   }\n \n-  visitIcuPlaceholder(ph: i18n.IcuPlaceholder, context?: any): any {\n-    context.push(this.createPlaceholderPiece(ph.name, ph.sourceSpan));\n+  visitIcuPlaceholder(ph: i18n.IcuPlaceholder): any {\n+    this.pieces.push(\n+        this.createPlaceholderPiece(ph.name, ph.sourceSpan, this.placeholderToMessage[ph.name]));\n   }\n \n-  private createPlaceholderPiece(name: string, sourceSpan: ParseSourceSpan): o.PlaceholderPiece {\n+  private createPlaceholderPiece(\n+      name: string, sourceSpan: ParseSourceSpan,\n+      associatedMessage?: i18n.Message): o.PlaceholderPiece {\n     return new o.PlaceholderPiece(\n-        formatI18nPlaceholderName(name, /* useCamelCase */ false), sourceSpan);\n+        formatI18nPlaceholderName(name, /* useCamelCase */ false), sourceSpan, associatedMessage);\n   }\n }\n \n-const serializerVisitor = new LocalizeSerializerVisitor();\n-\n /**\n  * Serialize an i18n message into two arrays: messageParts and placeholders.\n  *\n@@ -85,7 +92,8 @@ const serializerVisitor = new LocalizeSerializerVisitor();\n export function serializeI18nMessageForLocalize(message: i18n.Message):\n     {messageParts: o.LiteralPiece[], placeHolders: o.PlaceholderPiece[]} {\n   const pieces: o.MessagePiece[] = [];\n-  message.nodes.forEach(node => node.visit(serializerVisitor, pieces));\n+  const serializerVisitor = new LocalizeSerializerVisitor(message.placeholderToMessage, pieces);\n+  message.nodes.forEach(node => node.visit(serializerVisitor));\n   return processMessagePieces(pieces);\n }\n "
        },
        {
            "sha": "d4e229eb35c89b4a6d74ae624d150c5a19ef7868",
            "filename": "packages/compiler/src/render3/view/i18n/meta.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -74,6 +74,8 @@ export class I18nMetaVisitor implements html.Visitor {\n   }\n \n   visitElement(element: html.Element): any {\n+    let message: i18n.Message|undefined = undefined;\n+\n     if (hasI18nAttrs(element)) {\n       this.hasI18nMeta = true;\n       const attrs: html.Attribute[] = [];\n@@ -83,12 +85,13 @@ export class I18nMetaVisitor implements html.Visitor {\n         if (attr.name === I18N_ATTR) {\n           // root 'i18n' node attribute\n           const i18n = element.i18n || attr.value;\n-          const message = this._generateI18nMessage(element.children, i18n, setI18nRefs);\n-          // do not assign empty i18n meta\n-          if (message.nodes.length) {\n-            element.i18n = message;\n+          message = this._generateI18nMessage(element.children, i18n, setI18nRefs);\n+          if (message.nodes.length === 0) {\n+            // Ignore the message if it is empty.\n+            message = undefined;\n           }\n-\n+          // Store the message on the element\n+          element.i18n = message;\n         } else if (attr.name.startsWith(I18N_ATTR_PREFIX)) {\n           // 'i18n-*' attributes\n           const name = attr.name.slice(I18N_ATTR_PREFIX.length);\n@@ -121,11 +124,11 @@ export class I18nMetaVisitor implements html.Visitor {\n         element.attrs = attrs;\n       }\n     }\n-    html.visitAll(this, element.children, element.i18n);\n+    html.visitAll(this, element.children, message);\n     return element;\n   }\n \n-  visitExpansion(expansion: html.Expansion, currentMessage: i18n.Message|undefined): any {\n+  visitExpansion(expansion: html.Expansion, currentMessage: i18n.Message|null): any {\n     let message;\n     const meta = expansion.i18n;\n     this.hasI18nMeta = true;\n@@ -137,6 +140,10 @@ export class I18nMetaVisitor implements html.Visitor {\n       message = this._generateI18nMessage([expansion], meta);\n       const icu = icuFromI18nMessage(message);\n       icu.name = name;\n+      if (currentMessage !== null) {\n+        // Also update the placeholderToMessage map with this new message\n+        currentMessage.placeholderToMessage[name] = message;\n+      }\n     } else {\n       // ICU is a top level message, try to use metadata from container element if provided via\n       // `context` argument. Note: context may not be available for standalone ICUs (without"
        },
        {
            "sha": "7b1e5cda3b7582ef5ec22047a34243be714b573e",
            "filename": "packages/compiler/test/i18n/digest_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Ftest%2Fi18n%2Fdigest_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Ftest%2Fi18n%2Fdigest_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fi18n%2Fdigest_spec.ts?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -22,6 +22,7 @@ import {computeMsgId, digest, sha1} from '../../src/i18n/digest';\n           description: '',\n           sources: [],\n           customId: 'i',\n+          messageString: '',\n         })).toEqual('i');\n       });\n     });"
        },
        {
            "sha": "0ef344da2a2c86ae6a92b0f0f2faa6869211f2f8",
            "filename": "packages/compiler/test/i18n/i18n_ast_spec.ts",
            "status": "added",
            "additions": 71,
            "deletions": 0,
            "changes": 71,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Ftest%2Fi18n%2Fi18n_ast_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Ftest%2Fi18n%2Fi18n_ast_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fi18n%2Fi18n_ast_spec.ts?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -0,0 +1,71 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {createI18nMessageFactory} from '../../src/i18n/i18n_parser';\n+import {Node} from '../../src/ml_parser/ast';\n+import {HtmlParser} from '../../src/ml_parser/html_parser';\n+import {DEFAULT_INTERPOLATION_CONFIG} from '../../src/ml_parser/interpolation_config';\n+\n+describe('Message', () => {\n+  const messageFactory = createI18nMessageFactory(DEFAULT_INTERPOLATION_CONFIG);\n+  describe('messageText()', () => {\n+    it('should serialize simple text', () => {\n+      const message = messageFactory(parseHtml('abc\\ndef'), '', '', '');\n+      expect(message.messageString).toEqual('abc\\ndef');\n+    });\n+\n+    it('should serialize text with interpolations', () => {\n+      const message = messageFactory(parseHtml('abc {{ 123 }}{{ 456 }} def'), '', '', '');\n+      expect(message.messageString).toEqual('abc {$INTERPOLATION}{$INTERPOLATION_1} def');\n+    });\n+\n+    it('should serialize HTML elements', () => {\n+      const message =\n+          messageFactory(parseHtml('abc <span>foo</span><span>bar</span> def'), '', '', '');\n+      expect(message.messageString)\n+          .toEqual(\n+              'abc {$START_TAG_SPAN}foo{$CLOSE_TAG_SPAN}{$START_TAG_SPAN}bar{$CLOSE_TAG_SPAN} def');\n+    });\n+\n+    it('should serialize ICU placeholders', () => {\n+      const message = messageFactory(\n+          parseHtml('abc {value, select, case1 {value1} case2 {value2} case3 {value3}} def'), '',\n+          '', '');\n+      expect(message.messageString).toEqual('abc {$ICU} def');\n+    });\n+\n+    it('should serialize ICU expressions', () => {\n+      const message = messageFactory(\n+          parseHtml('{value, select, case1 {value1} case2 {value2} case3 {value3}}'), '', '', '');\n+      expect(message.messageString)\n+          .toEqual('{VAR_SELECT, select, case1 {value1} case2 {value2} case3 {value3}}');\n+    });\n+\n+    it('should serialize nested ICU expressions', () => {\n+      const message = messageFactory(\n+          parseHtml(`{gender, select,\n+            male {male of age: {age, select, 10 {ten} 20 {twenty} 30 {thirty} other {other}}}\n+            female {female}\n+            other {other}\n+          }`),\n+          '', '', '');\n+      expect(message.messageString)\n+          .toEqual(\n+              `{VAR_SELECT_1, select, male {male of age: {VAR_SELECT, select, 10 {ten} 20 {twenty} 30 {thirty} other {other}}} female {female} other {other}}`);\n+    });\n+  });\n+});\n+\n+export function parseHtml(html: string): Node[] {\n+  const htmlParser = new HtmlParser();\n+  const parseResult = htmlParser.parse(html, 'i18n_ast spec', {tokenizeExpansionForms: true});\n+  if (parseResult.errors.length > 0) {\n+    throw Error(`unexpected parse errors: ${parseResult.errors.join('\\n')}`);\n+  }\n+  return parseResult.rootNodes;\n+}"
        },
        {
            "sha": "71cc38a32aa2fd1e237f17934126060c3cdc2633",
            "filename": "packages/compiler/test/render3/view/i18n_spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c85bcb0c636d65706541d44be62694720f12ad9e/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts?ref=c85bcb0c636d65706541d44be62694720f12ad9e",
            "patch": "@@ -570,15 +570,14 @@ describe('serializeI18nMessageForLocalize', () => {\n   });\n \n   it('should serialize ICU with nested HTML containing further ICUs for `$localize()`', () => {\n+    const icu = placeholder('ICU');\n+    icu.associatedMessage = jasmine.any(i18n.Message) as unknown as i18n.Message;\n     expect(\n         serialize(\n             '{gender, select, male {male} female {female} other {other}}<div>{gender, select, male {male} female {female} other {other}}</div>'))\n         .toEqual({\n           messageParts: [literal(''), literal(''), literal(''), literal(''), literal('')],\n-          placeHolders: [\n-            placeholder('ICU'), placeholder('START_TAG_DIV'), placeholder('ICU'),\n-            placeholder('CLOSE_TAG_DIV')\n-          ]\n+          placeHolders: [icu, placeholder('START_TAG_DIV'), icu, placeholder('CLOSE_TAG_DIV')],\n         });\n   });\n "
        }
    ],
    "stats": {
        "total": 291,
        "additions": 224,
        "deletions": 67
    }
}