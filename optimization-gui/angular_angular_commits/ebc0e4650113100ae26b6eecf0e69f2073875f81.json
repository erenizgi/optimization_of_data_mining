{
    "author": "devversion",
    "message": "refactor(dev-infra): improve error message for unexpected version branches (#38622)\n\nCurrently the merge script default branch configuration throws an error\nif an unexpected version branch is discovered. The error right now\nassumes to much knowledge of the logic and the document outlining\nthe release trains conceptually.\n\nWe change it to something more easy to understand that doesn't require\nfull understanding of the versioning/labeling/branching document that\nhas been created for the Angular organization.\n\nPR Close #38622",
    "sha": "ebc0e4650113100ae26b6eecf0e69f2073875f81",
    "files": [
        {
            "sha": "293df1f0e030b38bb5ca773ceb87208a2011438c",
            "filename": "dev-infra/pr/merge/defaults/branches.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 7,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/ebc0e4650113100ae26b6eecf0e69f2073875f81/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fbranches.ts",
            "raw_url": "https://github.com/angular/angular/raw/ebc0e4650113100ae26b6eecf0e69f2073875f81/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fbranches.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fbranches.ts?ref=ebc0e4650113100ae26b6eecf0e69f2073875f81",
            "patch": "@@ -165,6 +165,11 @@ export async function findActiveVersionBranches(\n   latestVersionBranch: string | null,\n   releaseCandidateBranch: string | null,\n }> {\n+  // Version representing the release-train currently in the next phase. Note that we ignore\n+  // patch and pre-release segments in order to be able to compare the next release train to\n+  // other release trains from version branches (which follow the `N.N.x` pattern).\n+  const nextReleaseTrainVersion = semver.parse(`${nextVersion.major}.${nextVersion.minor}.0`)!;\n+\n   let latestVersionBranch: string|null = null;\n   let releaseCandidateBranch: string|null = null;\n \n@@ -177,15 +182,21 @@ export async function findActiveVersionBranches(\n   // next version-branch as that one is supposed to be the latest active version-branch. If it\n   // is not, then an error will be thrown due to two FF/RC branches existing at the same time.\n   for (const {name, parsed} of branches) {\n-    // It can happen that version branches that are more recent than the version in the next\n-    // branch (i.e. `master`) have been created. We could ignore such branches silently, but\n-    // it might actually be symptomatic for an outdated version in the `next` branch, or an\n+    // It can happen that version branches have been accidentally created which are more recent\n+    // than the release-train in the next branch (i.e. `master`). We could ignore such branches\n+    // silently, but it might be symptomatic for an outdated version in the `next` branch, or an\n     // accidentally created branch by the caretaker. In either way we want to raise awareness.\n-    if (semver.gte(parsed, nextVersion)) {\n+    if (semver.gt(parsed, nextReleaseTrainVersion)) {\n+      throw Error(\n+          `Discovered unexpected version-branch \"${name}\" for a release-train that is ` +\n+          `more recent than the release-train currently in the \"${nextBranchName}\" branch. ` +\n+          `Please either delete the branch if created by accident, or update the outdated ` +\n+          `version in the next branch (${nextBranchName}).`);\n+    } else if (semver.eq(parsed, nextReleaseTrainVersion)) {\n       throw Error(\n-          `Discovered unexpected version-branch that is representing a minor ` +\n-          `version more recent than the one in the \"${nextBranchName}\" branch. Consider ` +\n-          `deleting the branch, or check if the version in \"${nextBranchName}\" is outdated.`);\n+          `Discovered unexpected version-branch \"${name}\" for a release-train that is already ` +\n+          `active in the \"${nextBranchName}\" branch. Please either delete the branch if ` +\n+          `created by accident, or update the version in the next branch (${nextBranchName}).`);\n     }\n \n     const version = await getVersionOfBranch(repo, name);"
        },
        {
            "sha": "71d8318c14e85c43706a4ffa7f82389a5277cbf3",
            "filename": "dev-infra/pr/merge/defaults/integration.spec.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/ebc0e4650113100ae26b6eecf0e69f2073875f81/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ebc0e4650113100ae26b6eecf0e69f2073875f81/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts?ref=ebc0e4650113100ae26b6eecf0e69f2073875f81",
            "patch": "@@ -280,17 +280,31 @@ describe('default target labels', () => {\n         .toBeRejectedWithError('Invalid version detected in following branch: 11.1.x.');\n   });\n \n-  it('should error if branch more recent than version in \"next\" branch is found', async () => {\n+  it('should error if version-branch more recent than \"next\" is discovered', async () => {\n+    interceptBranchVersionRequest('master', '11.2.0-next.0');\n+    interceptBranchVersionRequest('11.3.x', '11.3.0-next.0');\n+    interceptBranchVersionRequest('11.1.x', '11.1.5');\n+    interceptBranchesListRequest(['11.1.x', '11.3.x']);\n+\n+    await expectAsync(getBranchesForLabel('target: lts', '10.2.x'))\n+        .toBeRejectedWithError(\n+            'Discovered unexpected version-branch \"11.3.x\" for a release-train that is ' +\n+            'more recent than the release-train currently in the \"master\" branch. Please ' +\n+            'either delete the branch if created by accident, or update the outdated version ' +\n+            'in the next branch (master).');\n+  });\n+\n+  it('should error if branch is matching with release-train in the \"next\" branch', async () => {\n     interceptBranchVersionRequest('master', '11.2.0-next.0');\n     interceptBranchVersionRequest('11.2.x', '11.2.0-next.0');\n     interceptBranchVersionRequest('11.1.x', '11.1.5');\n     interceptBranchesListRequest(['11.1.x', '11.2.x']);\n \n     await expectAsync(getBranchesForLabel('target: lts', '10.2.x'))\n         .toBeRejectedWithError(\n-            'Discovered unexpected version-branch that is representing a minor version more ' +\n-            'recent than the one in the \"master\" branch. Consider deleting the branch, or check ' +\n-            'if the version in \"master\" is outdated.');\n+            'Discovered unexpected version-branch \"11.2.x\" for a release-train that is already ' +\n+            'active in the \"master\" branch. Please either delete the branch if created by ' +\n+            'accident, or update the version in the next branch (master).');\n   });\n \n   it('should allow merging PR only into patch branch with \"target: patch\"', async () => {"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 36,
        "deletions": 11
    }
}