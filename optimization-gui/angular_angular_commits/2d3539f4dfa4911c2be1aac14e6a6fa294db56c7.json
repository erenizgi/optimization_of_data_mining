{
    "author": "josephperrott",
    "message": "refactor(dev-infra): use graphql to query PRs in merge tooling (#41459)\n\nMigrate to use graqhql to query for PR information during the validation and\npreperation portions of the pr merge tooling.\n\nPR Close #41459",
    "sha": "2d3539f4dfa4911c2be1aac14e6a6fa294db56c7",
    "files": [
        {
            "sha": "b25d50922420865befb4e669f2433bd5b485ad16",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 41,
            "deletions": 23,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/2d3539f4dfa4911c2be1aac14e6a6fa294db56c7/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/2d3539f4dfa4911c2be1aac14e6a6fa294db56c7/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=2d3539f4dfa4911c2be1aac14e6a6fa294db56c7",
            "patch": "@@ -3396,7 +3396,7 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n                     if (prData === null) {\n                         return [2 /*return*/, PullRequestFailure.notFound()];\n                     }\n-                    labels = prData.labels.map(function (l) { return l.name; });\n+                    labels = prData.labels.nodes.map(function (l) { return l.name; });\n                     if (!labels.some(function (name) { return matchesPattern(name, config.mergeReadyLabel); })) {\n                         return [2 /*return*/, PullRequestFailure.notMergeReady()];\n                     }\n@@ -3412,36 +3412,34 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n                         }\n                         throw error;\n                     }\n-                    return [4 /*yield*/, git.github.repos.getCombinedStatusForRef(tslib.__assign(tslib.__assign({}, git.remoteParams), { ref: prData.head.sha }))];\n-                case 2:\n-                    state = (_b.sent()).data.state;\n-                    if (state === 'failure' && !ignoreNonFatalFailures) {\n+                    state = prData.commits.nodes.slice(-1)[0].commit.status.state;\n+                    if (state === 'FAILURE' && !ignoreNonFatalFailures) {\n                         return [2 /*return*/, PullRequestFailure.failingCiJobs()];\n                     }\n-                    if (state === 'pending' && !ignoreNonFatalFailures) {\n+                    if (state === 'PENDING' && !ignoreNonFatalFailures) {\n                         return [2 /*return*/, PullRequestFailure.pendingCiJobs()];\n                     }\n-                    githubTargetBranch = prData.base.ref;\n+                    githubTargetBranch = prData.baseRefOid;\n                     requiredBaseSha = config.requiredBaseCommits && config.requiredBaseCommits[githubTargetBranch];\n                     needsCommitMessageFixup = !!config.commitMessageFixupLabel &&\n                         labels.some(function (name) { return matchesPattern(name, config.commitMessageFixupLabel); });\n                     hasCaretakerNote = !!config.caretakerNoteLabel &&\n                         labels.some(function (name) { return matchesPattern(name, config.caretakerNoteLabel); });\n-                    _b.label = 3;\n-                case 3:\n-                    _b.trys.push([3, 5, , 6]);\n+                    _b.label = 2;\n+                case 2:\n+                    _b.trys.push([2, 4, , 5]);\n                     return [4 /*yield*/, getBranchesFromTargetLabel(targetLabel, githubTargetBranch)];\n-                case 4:\n+                case 3:\n                     targetBranches = _b.sent();\n-                    return [3 /*break*/, 6];\n-                case 5:\n+                    return [3 /*break*/, 5];\n+                case 4:\n                     error_1 = _b.sent();\n                     if (error_1 instanceof InvalidTargetBranchError || error_1 instanceof InvalidTargetLabelError) {\n                         return [2 /*return*/, new PullRequestFailure(error_1.failureMessage)];\n                     }\n                     throw error_1;\n-                case 6: return [2 /*return*/, {\n-                        url: prData.html_url,\n+                case 5: return [2 /*return*/, {\n+                        url: prData.url,\n                         prNumber: prNumber,\n                         labels: labels,\n                         requiredBaseSha: requiredBaseSha,\n@@ -3450,24 +3448,44 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n                         hasCaretakerNote: hasCaretakerNote,\n                         targetBranches: targetBranches,\n                         title: prData.title,\n-                        commitCount: prData.commits,\n+                        commitCount: prData.commits.nodes.length,\n                     }];\n             }\n         });\n     });\n }\n+/* GraphQL schema for the response body the requested PR. */\n+var PR_SCHEMA$2 = {\n+    url: typedGraphqlify.types.string,\n+    number: typedGraphqlify.types.number,\n+    commits: typedGraphqlify.params({ first: 100 }, {\n+        nodes: [{\n+                commit: {\n+                    status: {\n+                        state: typedGraphqlify.types.oneOf(['FAILURE', 'PENDING', 'SUCCESS']),\n+                    },\n+                    message: typedGraphqlify.types.string,\n+                },\n+            }],\n+    }),\n+    baseRefOid: typedGraphqlify.types.string,\n+    title: typedGraphqlify.types.string,\n+    labels: typedGraphqlify.params({ first: 100 }, {\n+        nodes: [{\n+                name: typedGraphqlify.types.string,\n+            }]\n+    }),\n+};\n /** Fetches a pull request from Github. Returns null if an error occurred. */\n function fetchPullRequestFromGithub(git, prNumber) {\n     return tslib.__awaiter(this, void 0, void 0, function () {\n-        var result, e_1;\n+        var e_1;\n         return tslib.__generator(this, function (_a) {\n             switch (_a.label) {\n                 case 0:\n                     _a.trys.push([0, 2, , 3]);\n-                    return [4 /*yield*/, git.github.pulls.get(tslib.__assign(tslib.__assign({}, git.remoteParams), { pull_number: prNumber }))];\n-                case 1:\n-                    result = _a.sent();\n-                    return [2 /*return*/, result.data];\n+                    return [4 /*yield*/, getPr(PR_SCHEMA$2, prNumber, git)];\n+                case 1: return [2 /*return*/, _a.sent()];\n                 case 2:\n                     e_1 = _a.sent();\n                     // If the pull request could not be found, we want to return `null` so\n@@ -4315,7 +4333,7 @@ var MergeCommandModule = {\n  * found in the LICENSE file at https://angular.io/license\n  */\n /* GraphQL schema for the response body for each pending PR. */\n-const PR_SCHEMA$2 = {\n+const PR_SCHEMA$3 = {\n     state: typedGraphqlify.types.string,\n     maintainerCanModify: typedGraphqlify.types.boolean,\n     viewerDidAuthor: typedGraphqlify.types.boolean,\n@@ -4353,7 +4371,7 @@ function rebasePr(prNumber, githubToken, config = getConfig()) {\n          */\n         const previousBranchOrRevision = git.getCurrentBranchOrRevision();\n         /* Get the PR information from Github. */\n-        const pr = yield getPr(PR_SCHEMA$2, prNumber, git);\n+        const pr = yield getPr(PR_SCHEMA$3, prNumber, git);\n         const headRefName = pr.headRef.name;\n         const baseRefName = pr.baseRef.name;\n         const fullHeadRef = `${pr.headRef.repository.nameWithOwner}:${headRefName}`;"
        },
        {
            "sha": "db52d4b19549fefc4d2dc76b15ace06b1826dc44",
            "filename": "dev-infra/pr/merge/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/2d3539f4dfa4911c2be1aac14e6a6fa294db56c7/dev-infra%2Fpr%2Fmerge%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/2d3539f4dfa4911c2be1aac14e6a6fa294db56c7/dev-infra%2Fpr%2Fmerge%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2FBUILD.bazel?ref=2d3539f4dfa4911c2be1aac14e6a6fa294db56c7",
            "patch": "@@ -24,6 +24,7 @@ ts_library(\n         \"@npm//@types/semver\",\n         \"@npm//@types/yargs\",\n         \"@npm//chalk\",\n+        \"@npm//typed-graphqlify\",\n     ],\n )\n "
        },
        {
            "sha": "b1f7ef877a29bace5a122fafbc451d4d4d6348bc",
            "filename": "dev-infra/pr/merge/pull-request.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 12,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/2d3539f4dfa4911c2be1aac14e6a6fa294db56c7/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "raw_url": "https://github.com/angular/angular/raw/2d3539f4dfa4911c2be1aac14e6a6fa294db56c7/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts?ref=2d3539f4dfa4911c2be1aac14e6a6fa294db56c7",
            "patch": "@@ -6,9 +6,10 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import * as Octokit from '@octokit/rest';\n+import {params, types as graphQLTypes} from 'typed-graphqlify';\n \n import {GitClient} from '../../utils/git/index';\n+import {getPr} from '../../utils/github';\n import {TargetLabel} from './config';\n \n import {PullRequestFailure} from './failures';\n@@ -53,7 +54,7 @@ export async function loadAndValidatePullRequest(\n     return PullRequestFailure.notFound();\n   }\n \n-  const labels = prData.labels.map(l => l.name);\n+  const labels = prData.labels.nodes.map(l => l.name);\n \n   if (!labels.some(name => matchesPattern(name, config.mergeReadyLabel))) {\n     return PullRequestFailure.notMergeReady();\n@@ -72,17 +73,16 @@ export async function loadAndValidatePullRequest(\n     throw error;\n   }\n \n-  const {data: {state}} =\n-      await git.github.repos.getCombinedStatusForRef({...git.remoteParams, ref: prData.head.sha});\n \n-  if (state === 'failure' && !ignoreNonFatalFailures) {\n+  const state = prData.commits.nodes.slice(-1)[0].commit.status.state;\n+  if (state === 'FAILURE' && !ignoreNonFatalFailures) {\n     return PullRequestFailure.failingCiJobs();\n   }\n-  if (state === 'pending' && !ignoreNonFatalFailures) {\n+  if (state === 'PENDING' && !ignoreNonFatalFailures) {\n     return PullRequestFailure.pendingCiJobs();\n   }\n \n-  const githubTargetBranch = prData.base.ref;\n+  const githubTargetBranch = prData.baseRefOid;\n   const requiredBaseSha =\n       config.requiredBaseCommits && config.requiredBaseCommits[githubTargetBranch];\n   const needsCommitMessageFixup = !!config.commitMessageFixupLabel &&\n@@ -105,7 +105,7 @@ export async function loadAndValidatePullRequest(\n   }\n \n   return {\n-    url: prData.html_url,\n+    url: prData.url,\n     prNumber,\n     labels,\n     requiredBaseSha,\n@@ -114,16 +114,40 @@ export async function loadAndValidatePullRequest(\n     hasCaretakerNote,\n     targetBranches,\n     title: prData.title,\n-    commitCount: prData.commits,\n+    commitCount: prData.commits.nodes.length,\n   };\n }\n \n+/* GraphQL schema for the response body the requested PR. */\n+const PR_SCHEMA = {\n+  url: graphQLTypes.string,\n+  number: graphQLTypes.number,\n+  commits: params({first: 100}, {\n+    nodes: [{\n+      commit: {\n+        status: {\n+          state: graphQLTypes.oneOf(['FAILURE' as const, 'PENDING' as const, 'SUCCESS' as const]),\n+        },\n+        message: graphQLTypes.string,\n+      },\n+    }],\n+  }),\n+  baseRefOid: graphQLTypes.string,\n+  title: graphQLTypes.string,\n+  labels: params({first: 100}, {\n+    nodes: [{\n+      name: graphQLTypes.string,\n+    }]\n+  }),\n+};\n+\n+\n+\n /** Fetches a pull request from Github. Returns null if an error occurred. */\n async function fetchPullRequestFromGithub(\n-    git: GitClient, prNumber: number): Promise<Octokit.PullsGetResponse|null> {\n+    git: GitClient, prNumber: number): Promise<typeof PR_SCHEMA|null> {\n   try {\n-    const result = await git.github.pulls.get({...git.remoteParams, pull_number: prNumber});\n-    return result.data;\n+    return await getPr(PR_SCHEMA, prNumber, git);\n   } catch (e) {\n     // If the pull request could not be found, we want to return `null` so\n     // that the error can be handled gracefully."
        }
    ],
    "stats": {
        "total": 113,
        "additions": 78,
        "deletions": 35
    }
}