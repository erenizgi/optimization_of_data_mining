{
    "author": "arturovt",
    "message": "fix(http): complete the request on timeout (#39807)\n\nWhen using the [timeout attribute](https://xhr.spec.whatwg.org/#the-timeout-attribute) and an XHR\nrequest times out, browsers trigger the `timeout` event (and execute the XHR's `ontimeout`\ncallback). Additionally, Safari 9 handles timed-out requests in the same way, even if no `timeout`\nhas been explicitly set on the XHR.\n\nIn the above cases, `HttpClient` would fail to capture the XHR's completing (with an error), so\nthe corresponding `Observable` would never complete.\n\nPR Close #26453\n\nPR Close #39807",
    "sha": "61a0b6de6d17aa5e761dd02876f6e1537dcf3895",
    "files": [
        {
            "sha": "eeb66d1dc419c593a35be87ec26fac15c67e6492",
            "filename": "packages/common/http/src/xhr.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/61a0b6de6d17aa5e761dd02876f6e1537dcf3895/packages%2Fcommon%2Fhttp%2Fsrc%2Fxhr.ts",
            "raw_url": "https://github.com/angular/angular/raw/61a0b6de6d17aa5e761dd02876f6e1537dcf3895/packages%2Fcommon%2Fhttp%2Fsrc%2Fxhr.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fhttp%2Fsrc%2Fxhr.ts?ref=61a0b6de6d17aa5e761dd02876f6e1537dcf3895",
            "patch": "@@ -311,6 +311,7 @@ export class HttpXhrBackend implements HttpBackend {\n       // By default, register for load and error events.\n       xhr.addEventListener('load', onLoad);\n       xhr.addEventListener('error', onError);\n+      xhr.addEventListener('timeout', onError);\n \n       // Progress events are only enabled if requested.\n       if (req.reportProgress) {\n@@ -333,6 +334,7 @@ export class HttpXhrBackend implements HttpBackend {\n         // On a cancellation, remove all registered event listeners.\n         xhr.removeEventListener('error', onError);\n         xhr.removeEventListener('load', onLoad);\n+        xhr.removeEventListener('timeout', onError);\n         if (req.reportProgress) {\n           xhr.removeEventListener('progress', onDownProgress);\n           if (reqBody !== null && xhr.upload) {"
        },
        {
            "sha": "26766ffa4b36c91f1c7a85a0cfff44c4ff67c4b9",
            "filename": "packages/common/http/test/xhr_mock.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/61a0b6de6d17aa5e761dd02876f6e1537dcf3895/packages%2Fcommon%2Fhttp%2Ftest%2Fxhr_mock.ts",
            "raw_url": "https://github.com/angular/angular/raw/61a0b6de6d17aa5e761dd02876f6e1537dcf3895/packages%2Fcommon%2Fhttp%2Ftest%2Fxhr_mock.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fhttp%2Ftest%2Fxhr_mock.ts?ref=61a0b6de6d17aa5e761dd02876f6e1537dcf3895",
            "patch": "@@ -54,6 +54,7 @@ export class MockXMLHttpRequest {\n \n   listeners: {\n     error?: (event: ErrorEvent) => void,\n+    timeout?: (event: ErrorEvent) => void,\n     load?: () => void,\n     progress?: (event: ProgressEvent) => void,\n     uploadProgress?: (event: ProgressEvent) => void,\n@@ -70,11 +71,12 @@ export class MockXMLHttpRequest {\n     this.body = body;\n   }\n \n-  addEventListener(event: 'error'|'load'|'progress'|'uploadProgress', handler: Function): void {\n+  addEventListener(event: 'error'|'timeout'|'load'|'progress'|'uploadProgress', handler: Function):\n+      void {\n     this.listeners[event] = handler as any;\n   }\n \n-  removeEventListener(event: 'error'|'load'|'progress'|'uploadProgress'): void {\n+  removeEventListener(event: 'error'|'timeout'|'load'|'progress'|'uploadProgress'): void {\n     delete this.listeners[event];\n   }\n \n@@ -129,6 +131,12 @@ export class MockXMLHttpRequest {\n     }\n   }\n \n+  mockTimeoutEvent(error: any): void {\n+    if (this.listeners.timeout) {\n+      this.listeners.timeout(error);\n+    }\n+  }\n+\n   abort() {\n     this.mockAborted = true;\n   }"
        },
        {
            "sha": "b422b20f6ba58911a507b09b1c1fa00aedccf128",
            "filename": "packages/common/http/test/xhr_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/61a0b6de6d17aa5e761dd02876f6e1537dcf3895/packages%2Fcommon%2Fhttp%2Ftest%2Fxhr_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/61a0b6de6d17aa5e761dd02876f6e1537dcf3895/packages%2Fcommon%2Fhttp%2Ftest%2Fxhr_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fhttp%2Ftest%2Fxhr_spec.ts?ref=61a0b6de6d17aa5e761dd02876f6e1537dcf3895",
            "patch": "@@ -9,7 +9,7 @@\n import {HttpRequest} from '@angular/common/http/src/request';\n import {HttpDownloadProgressEvent, HttpErrorResponse, HttpEvent, HttpEventType, HttpHeaderResponse, HttpResponse, HttpResponseBase, HttpStatusCode, HttpUploadProgressEvent} from '@angular/common/http/src/response';\n import {HttpXhrBackend} from '@angular/common/http/src/xhr';\n-import {describe, it} from '@angular/core/testing/src/testing_internal';\n+import {describe, expect, it} from '@angular/core/testing/src/testing_internal';\n import {Observable} from 'rxjs';\n import {toArray} from 'rxjs/operators';\n \n@@ -151,6 +151,17 @@ const XSSI_PREFIX = ')]}\\'\\n';\n       });\n       factory.mock.mockErrorEvent(new Error('blah'));\n     });\n+    it('emits timeout if the request times out', done => {\n+      backend.handle(TEST_POST).subscribe({\n+        error: (error: HttpErrorResponse) => {\n+          expect(error instanceof HttpErrorResponse).toBeTrue();\n+          expect(error.error instanceof Error).toBeTrue();\n+          expect(error.url).toBe('/test');\n+          done();\n+        },\n+      });\n+      factory.mock.mockTimeoutEvent(new Error('timeout'));\n+    });\n     it('avoids abort a request when fetch operation is completed', done => {\n       const abort = jasmine.createSpy('abort');\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 24,
        "deletions": 3
    }
}