{
    "author": "devversion",
    "message": "fix(migrations): prevent migrations from updating external templates multiple times (#44013)\n\nThe `NgComponentTemplateVisitor` helper was always referring back to the original source file on disk\nrather than the virtual file in the migration. This meant that some template migrations could attempt\nto modify the template multiple times resulting in invalid output.\n\nAs an example the `migration-v13-router-link-empty-expression` migrates the following template:\n\n```\n<div [routerLink]></div>\n```\n\nto\n\n```\n<div [routerLink]=\"[]\"></div>\n```\n\nBut if the template was referenced multiple times in the program, such as when the component was\nreferenced in the source and test entry-points, the migration would result in things like:\n\n```\n<div [routerLink]=\"[]\"=\"[]\"></div>\n```\n\nFixes #44005.\n\nPR Close #44013",
    "sha": "8d308dc4ec45bfbd8388932326d11e9abe0c700f",
    "files": [
        {
            "sha": "1859bc544f43a22a914e4825a27aca489aaf204b",
            "filename": "packages/core/schematics/migrations/router-link-empty-expression/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8d308dc4ec45bfbd8388932326d11e9abe0c700f/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d308dc4ec45bfbd8388932326d11e9abe0c700f/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Findex.ts?ref=8d308dc4ec45bfbd8388932326d11e9abe0c700f",
            "patch": "@@ -72,7 +72,7 @@ function runEmptyRouterLinkExpressionMigration(\n     compilerModule: typeof import('@angular/compiler')) {\n   const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n   const typeChecker = program.getTypeChecker();\n-  const templateVisitor = new NgComponentTemplateVisitor(typeChecker);\n+  const templateVisitor = new NgComponentTemplateVisitor(typeChecker, basePath, tree);\n   const sourceFiles =\n       program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n "
        },
        {
            "sha": "bb8d22929bed61058e2ff4c07eb5bdd05be08df3",
            "filename": "packages/core/schematics/test/routerlink_empty_expr_migration_spec.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/8d308dc4ec45bfbd8388932326d11e9abe0c700f/packages%2Fcore%2Fschematics%2Ftest%2Frouterlink_empty_expr_migration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d308dc4ec45bfbd8388932326d11e9abe0c700f/packages%2Fcore%2Fschematics%2Ftest%2Frouterlink_empty_expr_migration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Frouterlink_empty_expr_migration_spec.ts?ref=8d308dc4ec45bfbd8388932326d11e9abe0c700f",
            "patch": "@@ -241,4 +241,32 @@ describe('routerlink emptyExpr assignment migration', () => {\n     const content = tree.readContent('/index.ts');\n     expect(content).toContain(`\\r\\n\\r\\n\\r\\n<div [routerLink]=\"[]\">{{1}}</div>`);\n   });\n+\n+\n+  it('should avoid duplicated transforms if files are part of multiple targets', async () => {\n+    writeFile('/angular.json', JSON.stringify({\n+      version: 1,\n+      projects: {\n+        build: {\n+          architect: {\n+            build: {options: {tsConfig: './tsconfig.json'}},\n+            test: {options: {tsConfig: './tsconfig.json'}}\n+          }\n+        },\n+      }\n+    }));\n+\n+    writeFile('/tmpl.html', `<some-comp [routerLink]=\"\"></some-comp>`);\n+    writeFile('/index.ts', `\n+      import {Component} from '@angular/core';\n+\n+      @Component({templateUrl: './tmpl.html'})\n+      export class MyComp {}\n+    `);\n+\n+    await runMigration();\n+\n+    const content = tree.readContent('/tmpl.html');\n+    expect(content).toContain(`<some-comp [routerLink]=\"[]\"></some-comp>`);\n+  });\n });"
        },
        {
            "sha": "cf38ffbdc1358b8c09ab285e6e28a609287c057e",
            "filename": "packages/core/schematics/utils/ng_component_template.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 8,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/8d308dc4ec45bfbd8388932326d11e9abe0c700f/packages%2Fcore%2Fschematics%2Futils%2Fng_component_template.ts",
            "raw_url": "https://github.com/angular/angular/raw/8d308dc4ec45bfbd8388932326d11e9abe0c700f/packages%2Fcore%2Fschematics%2Futils%2Fng_component_template.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Futils%2Fng_component_template.ts?ref=8d308dc4ec45bfbd8388932326d11e9abe0c700f",
            "patch": "@@ -6,8 +6,9 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {Tree} from '@angular-devkit/schematics';\n import {existsSync, readFileSync} from 'fs';\n-import {dirname, resolve} from 'path';\n+import {dirname, relative, resolve} from 'path';\n import ts from 'typescript';\n \n import {computeLineStartsMap, getLineAndCharacterFromPosition} from './line_mappings';\n@@ -43,7 +44,7 @@ export interface ResolvedTemplate {\n export class NgComponentTemplateVisitor {\n   resolvedTemplates: ResolvedTemplate[] = [];\n \n-  constructor(public typeChecker: ts.TypeChecker) {}\n+  constructor(public typeChecker: ts.TypeChecker, private _basePath: string, private _tree: Tree) {}\n \n   visitNode(node: ts.Node) {\n     if (node.kind === ts.SyntaxKind.ClassDeclaration) {\n@@ -106,9 +107,8 @@ export class NgComponentTemplateVisitor {\n         // `content` and `start` values accordingly.\n         const content = property.initializer.getText().slice(1, -1);\n         const start = property.initializer.getStart() + 1;\n-        const filePath = resolve(sourceFileName);\n         this.resolvedTemplates.push({\n-          filePath: filePath,\n+          filePath: sourceFileName,\n           container: node,\n           content,\n           inline: true,\n@@ -118,19 +118,25 @@ export class NgComponentTemplateVisitor {\n         });\n       }\n       if (propertyName === 'templateUrl' && ts.isStringLiteralLike(property.initializer)) {\n-        const templatePath = resolve(dirname(sourceFileName), property.initializer.text);\n+        const templateDiskPath = resolve(dirname(sourceFileName), property.initializer.text);\n+        // TODO(devversion): Remove this when the TypeScript compiler host is fully virtual\n+        // relying on the devkit virtual tree and not dealing with disk paths. This is blocked on\n+        // providing common utilities for schematics/migrations, given this is done in the\n+        // Angular CDK already:\n+        // https://github.com/angular/components/blob/3704400ee67e0190c9783e16367587489c803ebc/src/cdk/schematics/update-tool/utils/virtual-host.ts.\n+        const templateDevkitPath = relative(this._basePath, templateDiskPath);\n \n         // In case the template does not exist in the file system, skip this\n         // external template.\n-        if (!existsSync(templatePath)) {\n+        if (!this._tree.exists(templateDevkitPath)) {\n           return;\n         }\n \n-        const fileContent = readFileSync(templatePath, 'utf8');\n+        const fileContent = this._tree.read(templateDevkitPath)!.toString();\n         const lineStartsMap = computeLineStartsMap(fileContent);\n \n         this.resolvedTemplates.push({\n-          filePath: templatePath,\n+          filePath: templateDiskPath,\n           container: node,\n           content: fileContent,\n           inline: false,"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 43,
        "deletions": 9
    }
}