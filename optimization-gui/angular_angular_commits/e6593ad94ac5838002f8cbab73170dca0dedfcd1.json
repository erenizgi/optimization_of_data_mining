{
    "author": "devversion",
    "message": "fix(dev-infra): transitive targets cannot be resolved by API extractor (#42828)\n\nFor API golden tests not running against a NPM package, we extract\nall transitive declarations of the specified `data` targets. This is\nnecessary because API extractor needs to resolve other targets that have\nbeen linked by the Bazel NodeJS rules. The linker by default only\nprovides access to JavaScript sources, but the API extractor is\nspecifically concerned with type definitions that we need to manually\nextract.\n\nPR Close #42828",
    "sha": "e6593ad94ac5838002f8cbab73170dca0dedfcd1",
    "files": [
        {
            "sha": "9b854c9f77d9f37b075ef3b34eaf8133de5883c9",
            "filename": "dev-infra/bazel/api-golden/index.bzl",
            "status": "modified",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/e6593ad94ac5838002f8cbab73170dca0dedfcd1/dev-infra%2Fbazel%2Fapi-golden%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/e6593ad94ac5838002f8cbab73170dca0dedfcd1/dev-infra%2Fbazel%2Fapi-golden%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2Findex.bzl?ref=e6593ad94ac5838002f8cbab73170dca0dedfcd1",
            "patch": "@@ -1,3 +1,4 @@\n+load(\"//dev-infra/bazel:extract_js_module_output.bzl\", \"extract_js_module_output\")\n load(\"@build_bazel_rules_nodejs//:index.bzl\", \"nodejs_binary\", \"nodejs_test\")\n \n nodejs_test_args = [\n@@ -32,9 +33,24 @@ def api_golden_test(\n \n     kwargs[\"tags\"] = kwargs.get(\"tags\", []) + [\"api_guard\"]\n \n+    # For API golden tests not running against a NPM package, we extract all transitive\n+    # declarations of the specified `data` targets. This is necessary because API extractor\n+    # needs to resolve other targets that have been linked by the Bazel NodeJS rules. The\n+    # linker by default only provides access to JavaScript sources, but the API extractor is\n+    # specifically concerned with type definitions that we can extract manually here.\n+    extract_js_module_output(\n+        name = \"%s_data_typings\" % name,\n+        deps = data,\n+        provider = \"JSModuleInfo\",\n+        include_declarations = True,\n+        include_default_files = False,\n+    )\n+\n+    test_data = [\"//dev-infra/bazel/api-golden\", \"//:package.json\", \":%s_data_typings\" % name] + data\n+\n     nodejs_test(\n         name = name,\n-        data = [\"//dev-infra/bazel/api-golden\", \"//:package.json\"] + data,\n+        data = test_data,\n         entry_point = \"//dev-infra/bazel/api-golden:index.ts\",\n         templated_args = nodejs_test_args + [golden, entry_point, \"false\", quoted_export_pattern],\n         **kwargs\n@@ -43,7 +59,7 @@ def api_golden_test(\n     nodejs_binary(\n         name = name + \".accept\",\n         testonly = True,\n-        data = [\"//dev-infra/bazel/api-golden\", \"//:package.json\"] + data,\n+        data = test_data,\n         entry_point = \"//dev-infra/bazel/api-golden:index.ts\",\n         templated_args = nodejs_test_args + [golden, entry_point, \"true\", quoted_export_pattern],\n         **kwargs"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 18,
        "deletions": 2
    }
}