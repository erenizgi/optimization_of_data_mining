{
    "author": "mgechev",
    "message": "refactor(devtools): move the profiler subscription to the native profiler",
    "sha": "8a0861cfb70626e460780b7e8a14c7570fa0a374",
    "files": [
        {
            "sha": "7ec522570b8b5b3235e75ad6693318d12e558ef4",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/profiler/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/8a0861cfb70626e460780b7e8a14c7570fa0a374/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fprofiler%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/8a0861cfb70626e460780b7e8a14c7570fa0a374/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fprofiler%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fprofiler%2Findex.ts?ref=8a0861cfb70626e460780b7e8a14c7570fa0a374",
            "patch": "@@ -1,7 +1,6 @@\n-import { ɵProfilerEvent } from '@angular/core';\n import { NgProfiler } from './native';\n import { PatchingProfiler } from './polyfill';\n-import { Profiler, ngProfilerCallbacks } from './shared';\n+import { Profiler } from './shared';\n \n export { Profiler, Hooks } from './shared';\n \n@@ -12,11 +11,7 @@ export { Profiler, Hooks } from './shared';\n export const selectProfilerStrategy = (): Profiler => {\n   const ng = (window as any).ng;\n   if (typeof ng?.ɵsetProfiler === 'function') {\n-    ng.ɵsetProfiler((event: ɵProfilerEvent, instanceOrLView: {}, hookOrListener: any) =>\n-      ngProfilerCallbacks.forEach((cb) => cb(event, instanceOrLView, hookOrListener))\n-    );\n     return new NgProfiler();\n   }\n-\n   return new PatchingProfiler();\n };"
        },
        {
            "sha": "eed434008a6860ef2f2127c3f66fd2f7bbf5f539",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/profiler/native.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 5,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/8a0861cfb70626e460780b7e8a14c7570fa0a374/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fprofiler%2Fnative.ts",
            "raw_url": "https://github.com/angular/angular/raw/8a0861cfb70626e460780b7e8a14c7570fa0a374/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fprofiler%2Fnative.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fprofiler%2Fnative.ts?ref=8a0861cfb70626e460780b7e8a14c7570fa0a374",
            "patch": "@@ -2,25 +2,36 @@ import { ɵProfilerEvent } from '@angular/core';\n import { getDirectiveHostElement } from '../../directive-forest';\n import { runOutsideAngular } from '../../utils';\n import { IdentityTracker, NodeArray } from '../identity-tracker';\n-import { getLifeCycleName, Hooks, ngProfilerCallbacks, Profiler } from './shared';\n+import { getLifeCycleName, Hooks, Profiler } from './shared';\n \n-const setProfilerCallback = (cb: (event: ɵProfilerEvent, instanceOrLView: {}, hookOrListener: any) => void) => {\n-  ngProfilerCallbacks.push(cb);\n-};\n+type ProfilerCallback = (event: ɵProfilerEvent, instanceOrLView: {}, hookOrListener: any) => void;\n \n /** Implementation of Profiler that utilizes framework APIs fire profiler hooks. */\n export class NgProfiler extends Profiler {\n   private _tracker = IdentityTracker.getInstance();\n+  private _callbacks: ProfilerCallback[] = [];\n \n   constructor(config: Partial<Hooks> = {}) {\n     super(config);\n-    setProfilerCallback((event: ɵProfilerEvent, instanceOrLView: {}, hookOrListener: any) => {\n+    this._setProfilerCallback((event: ɵProfilerEvent, instanceOrLView: {}, hookOrListener: any) => {\n       if (this[event] === undefined) {\n         return;\n       }\n \n       this[event](instanceOrLView, hookOrListener);\n     });\n+    this._initialize();\n+  }\n+\n+  private _initialize() {\n+    const ng = (window as any).ng;\n+    ng.ɵsetProfiler((event: ɵProfilerEvent, instanceOrLView: {}, hookOrListener: any) =>\n+      this._callbacks.forEach((cb) => cb(event, instanceOrLView, hookOrListener))\n+    );\n+  }\n+\n+  private _setProfilerCallback(callback: ProfilerCallback) {\n+    this._callbacks.push(callback);\n   }\n \n   destroy(): void {"
        },
        {
            "sha": "b85178910fa3b979a7ab5dd0b47b117281086619",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/profiler/shared.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/8a0861cfb70626e460780b7e8a14c7570fa0a374/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fprofiler%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/8a0861cfb70626e460780b7e8a14c7570fa0a374/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fprofiler%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fprofiler%2Fshared.ts?ref=8a0861cfb70626e460780b7e8a14c7570fa0a374",
            "patch": "@@ -1,7 +1,6 @@\n-import { ɵProfilerEvent } from '@angular/core';\n import { ElementPosition, LifecycleProfile } from 'protocol';\n import { Subject } from 'rxjs';\n-import { IdentityTracker, NodeArray } from '../identity-tracker';\n+import { NodeArray } from '../identity-tracker';\n \n type CreationHook = (\n   componentOrDirective: any,\n@@ -48,8 +47,6 @@ export interface Hooks {\n   onLifecycleHookEnd: LifecycleEndHook;\n }\n \n-export const ngProfilerCallbacks: ((event: ɵProfilerEvent, instanceOrLView: {}, hookOrListener: any) => void)[] = [];\n-\n /**\n  *  Class for profiling angular applications. Handles hook subscriptions and emitting change detection events.\n  */"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 18,
        "deletions": 15
    }
}