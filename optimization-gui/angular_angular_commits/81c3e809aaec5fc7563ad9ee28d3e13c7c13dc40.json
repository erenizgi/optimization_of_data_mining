{
    "author": "petebacondarwin",
    "message": "fix(localize): render ICU placeholders in extracted translation files (#38484)\n\nPreviously placeholders were only rendered for dynamic interpolation\nexpressons in `$localize` tagged strings. But there are also potentially\ndynamic values in ICU expressions too, so we need to render these as\nplaceholders when extracting i18n messages into translation files.\n\nPR Close #38484",
    "sha": "81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
    "files": [
        {
            "sha": "b2e00f85f524ad0a8754c2de6d12d06a66f64e90",
            "filename": "packages/localize/src/tools/src/extract/translation_files/icu_parsing.ts",
            "status": "added",
            "additions": 216,
            "deletions": 0,
            "changes": 216,
            "blob_url": "https://github.com/angular/angular/blob/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Ficu_parsing.ts",
            "raw_url": "https://github.com/angular/angular/raw/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Ficu_parsing.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Ficu_parsing.ts?ref=81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
            "patch": "@@ -0,0 +1,216 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * Split the given `text` into an array of \"static strings\" and ICU \"placeholder names\".\n+ *\n+ * This is required because ICU expressions in `$localize` tagged messages may contain \"dynamic\"\n+ * piece (e.g. interpolations or element markers). These markers need to be translated to\n+ * placeholders in extracted translation files. So we must parse ICUs to identify them and separate\n+ * them out so that the translation serializers can render them appropriately.\n+ *\n+ * An example of an ICU with interpolations:\n+ *\n+ * ```\n+ * {VAR_PLURAL, plural, one {{INTERPOLATION}} other {{INTERPOLATION_1} post}}\n+ * ```\n+ *\n+ * In this ICU, `INTERPOLATION` and `INTERPOLATION_1` are actually placeholders that will be\n+ * replaced with dynamic content at runtime.\n+ *\n+ * Such placeholders are identifiable as text wrapped in curly braces, within an ICU case\n+ * expression.\n+ *\n+ * To complicate matters, it is possible for ICUs to be nested indefinitely within each other. In\n+ * such cases, the nested ICU expression appears enclosed in a set of curly braces in the same way\n+ * as a placeholder. The nested ICU expressions can be differentiated from placeholders as they\n+ * contain a comma `,`, which separates the ICU value from the ICU type.\n+ *\n+ * Furthermore, nested ICUs can have placeholders of their own, which need to be extracted.\n+ *\n+ * An example of a nested ICU containing its own placeholders:\n+ *\n+ * ```\n+ * {VAR_SELECT_1, select,\n+ *   invoice {Invoice for {INTERPOLATION}}\n+ *   payment {{VAR_SELECT, select,\n+ *     processor {Payment gateway}\n+ *     other {{INTERPOLATION_1}}\n+ *   }}\n+ * ```\n+ *\n+ * @param text Text to be broken.\n+ * @returns an array of strings, where\n+ *  - even values are static strings (e.g. 0, 2, 4, etc)\n+ *  - odd values are placeholder names (e.g. 1, 3, 5, etc)\n+ */\n+export function extractIcuPlaceholders(text: string): string[] {\n+  const state = new StateStack();\n+  const pieces = new IcuPieces();\n+  const braces = /[{}]/g;\n+\n+  let lastPos = 0;\n+  let match: RegExpMatchArray|null;\n+  while (match = braces.exec(text)) {\n+    if (match[0] == '{') {\n+      state.enterBlock();\n+    } else {\n+      // We must have hit a `}`\n+      state.leaveBlock();\n+    }\n+\n+    if (state.getCurrent() === 'placeholder') {\n+      const name = tryParsePlaceholder(text, braces.lastIndex);\n+      if (name) {\n+        // We found a placeholder so store it in the pieces;\n+        // store the current static text (minus the opening curly brace);\n+        // skip the closing brace and leave the placeholder block.\n+        pieces.addText(text.substring(lastPos, braces.lastIndex - 1));\n+        pieces.addPlaceholder(name);\n+        braces.lastIndex += name.length + 1;\n+        state.leaveBlock();\n+      } else {\n+        // This is not a placeholder, so it must be a nested ICU;\n+        // store the current static text (including the opening curly brace).\n+        pieces.addText(text.substring(lastPos, braces.lastIndex));\n+        state.nestedIcu();\n+      }\n+    } else {\n+      pieces.addText(text.substring(lastPos, braces.lastIndex));\n+    }\n+    lastPos = braces.lastIndex;\n+  }\n+\n+  // Capture the last piece of text after the ICUs (if any).\n+  pieces.addText(text.substring(lastPos));\n+  return pieces.toArray();\n+}\n+\n+/**\n+ * A helper class to store the pieces (\"static text\" or \"placeholder name\") in an ICU.\n+ */\n+class IcuPieces {\n+  private pieces: string[] = [''];\n+\n+  /**\n+   * Add the given `text` to the current \"static text\" piece.\n+   *\n+   * Sequential calls to `addText()` will append to the current text piece.\n+   */\n+  addText(text: string): void {\n+    this.pieces[this.pieces.length - 1] += text;\n+  }\n+\n+  /**\n+   * Add the given placeholder `name` to the stored pieces.\n+   */\n+  addPlaceholder(name: string): void {\n+    this.pieces.push(name);\n+    this.pieces.push('');\n+  }\n+\n+  /**\n+   * Return the stored pieces as an array of strings.\n+   *\n+   * Even values are static strings (e.g. 0, 2, 4, etc)\n+   * Odd values are placeholder names (e.g. 1, 3, 5, etc)\n+   */\n+  toArray(): string[] {\n+    return this.pieces;\n+  }\n+}\n+\n+/**\n+ * A helper class to track the current state of parsing the strings for ICU placeholders.\n+ *\n+ * State changes happen when we enter or leave a curly brace block.\n+ * Since ICUs can be nested the state is stored as a stack.\n+ */\n+class StateStack {\n+  private stack: ParserState[] = [];\n+\n+  /**\n+   * Update the state upon entering a block.\n+   *\n+   * The new state is computed from the current state and added to the stack.\n+   */\n+  enterBlock(): void {\n+    const current = this.getCurrent();\n+    switch (current) {\n+      case 'icu':\n+        this.stack.push('case');\n+        break;\n+      case 'case':\n+        this.stack.push('placeholder');\n+        break;\n+      case 'placeholder':\n+        this.stack.push('case');\n+        break;\n+      default:\n+        this.stack.push('icu');\n+        break;\n+    }\n+  }\n+\n+  /**\n+   * Update the state upon leaving a block.\n+   *\n+   * The previous state is popped off the stack.\n+   */\n+  leaveBlock(): ParserState {\n+    return this.stack.pop();\n+  }\n+\n+  /**\n+   * Update the state upon arriving at a nested ICU.\n+   *\n+   * In this case, the current state of \"placeholder\" is incorrect, so this is popped off and the\n+   * correct \"icu\" state is stored.\n+   */\n+  nestedIcu(): void {\n+    const current = this.stack.pop();\n+    assert(current === 'placeholder', 'A nested ICU must replace a placeholder but got ' + current);\n+    this.stack.push('icu');\n+  }\n+\n+  /**\n+   * Get the current (most recent) state from the stack.\n+   */\n+  getCurrent() {\n+    return this.stack[this.stack.length - 1];\n+  }\n+}\n+type ParserState = 'icu'|'case'|'placeholder'|undefined;\n+\n+/**\n+ * Attempt to parse a simple placeholder name from a curly braced block.\n+ *\n+ * If the block contains a comma `,` then it cannot be a placeholder - and is probably a nest ICU\n+ * instead.\n+ *\n+ * @param text the whole string that is being parsed.\n+ * @param start the index of the character in the `text` string where this placeholder may start.\n+ * @returns the placeholder name or `null` if it is not a placeholder.\n+ */\n+function tryParsePlaceholder(text: string, start: number): string|null {\n+  for (let i = start; i < text.length; i++) {\n+    if (text[i] === ',') {\n+      break;\n+    }\n+    if (text[i] === '}') {\n+      return text.substring(start, i);\n+    }\n+  }\n+  return null;\n+}\n+\n+function assert(test: boolean, message: string): void {\n+  if (!test) {\n+    throw new Error('Assertion failure: ' + message);\n+  }\n+}"
        },
        {
            "sha": "cd0b13ba5d5912243ba771bdfa79e4d8664545fe",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff1_translation_serializer.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts?ref=81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
            "patch": "@@ -8,6 +8,7 @@\n import {AbsoluteFsPath, relative} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n+import {extractIcuPlaceholders} from './icu_parsing';\n import {TranslationSerializer} from './translation_serializer';\n import {XmlFile} from './xml_file';\n \n@@ -63,11 +64,22 @@ export class Xliff1TranslationSerializer implements TranslationSerializer {\n   }\n \n   private serializeMessage(xml: XmlFile, message: ɵParsedMessage): void {\n-    xml.text(message.messageParts[0]);\n-    for (let i = 1; i < message.messageParts.length; i++) {\n-      xml.startTag('x', {id: message.placeholderNames[i - 1]}, {selfClosing: true});\n-      xml.text(message.messageParts[i]);\n+    const length = message.messageParts.length - 1;\n+    for (let i = 0; i < length; i++) {\n+      this.serializeTextPart(xml, message.messageParts[i]);\n+      xml.startTag('x', {id: message.placeholderNames[i]}, {selfClosing: true});\n     }\n+    this.serializeTextPart(xml, message.messageParts[length]);\n+  }\n+\n+  private serializeTextPart(xml: XmlFile, text: string): void {\n+    const pieces = extractIcuPlaceholders(text);\n+    const length = pieces.length - 1;\n+    for (let i = 0; i < length; i += 2) {\n+      xml.text(pieces[i]);\n+      xml.startTag('x', {id: pieces[i + 1]}, {selfClosing: true});\n+    }\n+    xml.text(pieces[length]);\n   }\n \n   private serializeNote(xml: XmlFile, name: string, value: string): void {"
        },
        {
            "sha": "d3aa29d5fce39c38c4afc9cdb9880f8d65de19da",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff2_translation_serializer.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 15,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts?ref=81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
            "patch": "@@ -8,6 +8,7 @@\n import {AbsoluteFsPath, relative} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage} from '@angular/localize';\n \n+import {extractIcuPlaceholders} from './icu_parsing';\n import {TranslationSerializer} from './translation_serializer';\n import {XmlFile} from './xml_file';\n \n@@ -22,6 +23,7 @@ const MAX_LEGACY_XLIFF_2_MESSAGE_LENGTH = 20;\n  * @see Xliff2TranslationParser\n  */\n export class Xliff2TranslationSerializer implements TranslationSerializer {\n+  private currentPlaceholderId = 0;\n   constructor(\n       private sourceLocale: string, private basePath: AbsoluteFsPath,\n       private useLegacyIds: boolean) {}\n@@ -74,21 +76,38 @@ export class Xliff2TranslationSerializer implements TranslationSerializer {\n   }\n \n   private serializeMessage(xml: XmlFile, message: ɵParsedMessage): void {\n-    xml.text(message.messageParts[0]);\n-    for (let i = 1; i < message.messageParts.length; i++) {\n-      const placeholderName = message.placeholderNames[i - 1];\n-      if (placeholderName.startsWith('START_')) {\n-        xml.startTag('pc', {\n-          id: `${i}`,\n-          equivStart: placeholderName,\n-          equivEnd: placeholderName.replace(/^START/, 'CLOSE')\n-        });\n-      } else if (placeholderName.startsWith('CLOSE_')) {\n-        xml.endTag('pc');\n-      } else {\n-        xml.startTag('ph', {id: `${i}`, equiv: placeholderName}, {selfClosing: true});\n-      }\n-      xml.text(message.messageParts[i]);\n+    this.currentPlaceholderId = 0;\n+    const length = message.messageParts.length - 1;\n+    for (let i = 0; i < length; i++) {\n+      this.serializeTextPart(xml, message.messageParts[i]);\n+      this.serializePlaceholder(xml, message.placeholderNames[i]);\n+    }\n+    this.serializeTextPart(xml, message.messageParts[length]);\n+  }\n+\n+  private serializeTextPart(xml: XmlFile, text: string): void {\n+    const pieces = extractIcuPlaceholders(text);\n+    const length = pieces.length - 1;\n+    for (let i = 0; i < length; i += 2) {\n+      xml.text(pieces[i]);\n+      this.serializePlaceholder(xml, pieces[i + 1]);\n+    }\n+    xml.text(pieces[length]);\n+  }\n+\n+  private serializePlaceholder(xml: XmlFile, placeholderName: string): void {\n+    if (placeholderName.startsWith('START_')) {\n+      xml.startTag('pc', {\n+        id: `${this.currentPlaceholderId++}`,\n+        equivStart: placeholderName,\n+        equivEnd: placeholderName.replace(/^START/, 'CLOSE')\n+      });\n+    } else if (placeholderName.startsWith('CLOSE_')) {\n+      xml.endTag('pc');\n+    } else {\n+      xml.startTag(\n+          'ph', {id: `${this.currentPlaceholderId++}`, equiv: placeholderName},\n+          {selfClosing: true});\n     }\n   }\n "
        },
        {
            "sha": "574173ed5668ff12d64e1f92da89a56556b19e25",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xmb_translation_serializer.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer.ts?ref=81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
            "patch": "@@ -8,6 +8,7 @@\n import {AbsoluteFsPath, relative} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n+import {extractIcuPlaceholders} from './icu_parsing';\n import {TranslationSerializer} from './translation_serializer';\n import {XmlFile} from './xml_file';\n \n@@ -77,11 +78,22 @@ export class XmbTranslationSerializer implements TranslationSerializer {\n   }\n \n   private serializeMessage(xml: XmlFile, message: ɵParsedMessage): void {\n-    xml.text(message.messageParts[0]);\n-    for (let i = 1; i < message.messageParts.length; i++) {\n-      xml.startTag('ph', {name: message.placeholderNames[i - 1]}, {selfClosing: true});\n-      xml.text(message.messageParts[i]);\n+    const length = message.messageParts.length - 1;\n+    for (let i = 0; i < length; i++) {\n+      this.serializeTextPart(xml, message.messageParts[i]);\n+      xml.startTag('ph', {name: message.placeholderNames[i]}, {selfClosing: true});\n     }\n+    this.serializeTextPart(xml, message.messageParts[length]);\n+  }\n+\n+  private serializeTextPart(xml: XmlFile, text: string): void {\n+    const pieces = extractIcuPlaceholders(text);\n+    const length = pieces.length - 1;\n+    for (let i = 0; i < length; i += 2) {\n+      xml.text(pieces[i]);\n+      xml.startTag('ph', {name: pieces[i + 1]}, {selfClosing: true});\n+    }\n+    xml.text(pieces[length]);\n   }\n \n   /**"
        },
        {
            "sha": "ae2d27dd160d30252d756411f990c738bd71b010",
            "filename": "packages/localize/src/tools/test/extract/integration/main_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts?ref=81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
            "patch": "@@ -175,12 +175,12 @@ runInEachFileSystem(() => {\n         `  <file>`,\n         `    <unit id=\"3291030485717846467\">`,\n         `      <segment>`,\n-        `        <source>Hello, <ph id=\"1\" equiv=\"PH\"/>!</source>`,\n+        `        <source>Hello, <ph id=\"0\" equiv=\"PH\"/>!</source>`,\n         `      </segment>`,\n         `    </unit>`,\n         `    <unit id=\"8669027859022295761\">`,\n         `      <segment>`,\n-        `        <source>try<ph id=\"1\" equiv=\"PH\"/>me</source>`,\n+        `        <source>try<ph id=\"0\" equiv=\"PH\"/>me</source>`,\n         `      </segment>`,\n         `    </unit>`,\n         `  </file>`,"
        },
        {
            "sha": "092cdf6bc5711df09aeb5965d71ac8edd4c5924c",
            "filename": "packages/localize/src/tools/test/extract/translation_files/icu_parsing_spec.ts",
            "status": "added",
            "additions": 76,
            "deletions": 0,
            "changes": 76,
            "blob_url": "https://github.com/angular/angular/blob/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Ficu_parsing_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Ficu_parsing_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Ficu_parsing_spec.ts?ref=81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
            "patch": "@@ -0,0 +1,76 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {extractIcuPlaceholders} from '../../../src/extract/translation_files/icu_parsing';\n+\n+describe('extractIcuPlaceholders()', () => {\n+  it('should return a single string if there is no ICU', () => {\n+    expect(extractIcuPlaceholders('')).toEqual(['']);\n+    expect(extractIcuPlaceholders('some text')).toEqual(['some text']);\n+    expect(extractIcuPlaceholders('some } text')).toEqual(['some } text']);\n+    expect(extractIcuPlaceholders('this is {not an ICU}')).toEqual(['this is {not an ICU}']);\n+  });\n+\n+  it('should return a single string if there are no ICU placeholders', () => {\n+    expect(extractIcuPlaceholders('{VAR_PLURAL, plural, one {SOME} few {FEW} other {OTHER}}'))\n+        .toEqual(['{VAR_PLURAL, plural, one {SOME} few {FEW} other {OTHER}}']);\n+    expect(extractIcuPlaceholders('{VAR_SELECT, select, male {HE} female {SHE} other {XE}}'))\n+        .toEqual(['{VAR_SELECT, select, male {HE} female {SHE} other {XE}}']);\n+  });\n+\n+  it('should split out simple interpolation placeholders', () => {\n+    expect(\n+        extractIcuPlaceholders(\n+            '{VAR_PLURAL, plural, one {{INTERPOLATION}} few {pre {INTERPOLATION_1}} other {{INTERPOLATION_2} post}}'))\n+        .toEqual([\n+          '{VAR_PLURAL, plural, one {',\n+          'INTERPOLATION',\n+          '} few {pre ',\n+          'INTERPOLATION_1',\n+          '} other {',\n+          'INTERPOLATION_2',\n+          ' post}}',\n+        ]);\n+  });\n+\n+  it('should split out element placeholders', () => {\n+    expect(\n+        extractIcuPlaceholders(\n+            '{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}'))\n+        .toEqual([\n+          '{VAR_PLURAL, plural, one {',\n+          'START_BOLD_TEXT',\n+          'something bold',\n+          'CLOSE_BOLD_TEXT',\n+          '} other {pre ',\n+          'START_TAG_SPAN',\n+          'middle',\n+          'CLOSE_TAG_SPAN',\n+          ' post}}',\n+        ]);\n+  });\n+\n+  it('should handle nested ICUs', () => {\n+    expect(extractIcuPlaceholders([\n+      '{VAR_SELECT_1, select,',\n+      '  invoice {Invoice for {INTERPOLATION}}',\n+      '  payment {{VAR_SELECT, select,',\n+      '    processor {Payment gateway}',\n+      '    other {{INTERPOLATION_1}}',\n+      '  }}',\n+      '}',\n+    ].join('\\n')))\n+        .toEqual([\n+          '{VAR_SELECT_1, select,\\n  invoice {Invoice for ',\n+          'INTERPOLATION',\n+          '}\\n  payment {{VAR_SELECT, select,\\n    processor {Payment gateway}\\n    other {',\n+          'INTERPOLATION_1',\n+          '}\\n  }}\\n}',\n+        ]);\n+  });\n+});\n\\ No newline at end of file"
        },
        {
            "sha": "bd4bb50e8810cb9dd126e3ab43cea0e0f690c1ef",
            "filename": "packages/localize/src/tools/test/extract/translation_files/json_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fjson_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fjson_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fjson_translation_serializer_spec.ts?ref=81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
            "patch": "@@ -22,6 +22,19 @@ describe('JsonTranslationSerializer', () => {\n         mockMessage('13579', ['', 'b', ''], ['START_BOLD_TEXT', 'CLOSE_BOLD_TEXT'], {}),\n         mockMessage('24680', ['a'], [], {meaning: 'meaning', description: 'and description'}),\n         mockMessage('80808', ['multi\\nlines'], [], {}),\n+        mockMessage('90000', ['<escape', 'me>'], ['double-quotes-\"'], {}),\n+        mockMessage(\n+            '100000',\n+            [\n+              'pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU'\n+            ],\n+            [], {}),\n+        mockMessage(\n+            '100001',\n+            [\n+              '{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}'\n+            ],\n+            [], {}),\n       ];\n       const serializer = new SimpleJsonTranslationSerializer('xx');\n       const output = serializer.serialize(messages);\n@@ -33,7 +46,10 @@ describe('JsonTranslationSerializer', () => {\n         `    \"13579\": \"{$START_BOLD_TEXT}b{$CLOSE_BOLD_TEXT}\",`,\n         `    \"24680\": \"a\",`,\n         `    \"67890\": \"a{$START_TAG_SPAN}{$CLOSE_TAG_SPAN}c\",`,\n-        `    \"80808\": \"multi\\\\nlines\"`,\n+        `    \"80808\": \"multi\\\\nlines\",`,\n+        `    \"90000\": \"<escape{$double-quotes-\\\\\"}me>\",`,\n+        `    \"100000\": \"pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU\",`,\n+        `    \"100001\": \"{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}\"`,\n         `  }`,\n         `}`,\n       ].join('\\n'));"
        },
        {
            "sha": "a0e832ffb07a86e366f044c01b6eddac276882e5",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xliff1_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts?ref=81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
            "patch": "@@ -34,7 +34,19 @@ runInEachFileSystem(() => {\n             mockMessage('13579', ['', 'b', ''], ['START_BOLD_TEXT', 'CLOSE_BOLD_TEXT'], {}),\n             mockMessage('24680', ['a'], [], {meaning: 'meaning', description: 'and description'}),\n             mockMessage('80808', ['multi\\nlines'], [], {}),\n-            mockMessage('90000', ['<escape', 'me>'], ['double-quotes-\"'], {})\n+            mockMessage('90000', ['<escape', 'me>'], ['double-quotes-\"'], {}),\n+            mockMessage(\n+                '100000',\n+                [\n+                  'pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU'\n+                ],\n+                [], {}),\n+            mockMessage(\n+                '100001',\n+                [\n+                  '{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}'\n+                ],\n+                [], {}),\n           ];\n           const serializer =\n               new Xliff1TranslationSerializer('xx', absoluteFrom('/project'), useLegacyIds);\n@@ -73,6 +85,12 @@ runInEachFileSystem(() => {\n             `      <trans-unit id=\"90000\" datatype=\"html\">`,\n             `        <source>&lt;escape<x id=\"double-quotes-&quot;\"/>me&gt;</source>`,\n             `      </trans-unit>`,\n+            `      <trans-unit id=\"100000\" datatype=\"html\">`,\n+            `        <source>pre-ICU {VAR_SELECT, select, a {a} b {<x id=\"INTERPOLATION\"/>} c {pre <x id=\"INTERPOLATION_1\"/> post}} post-ICU</source>`,\n+            `      </trans-unit>`,\n+            `      <trans-unit id=\"100001\" datatype=\"html\">`,\n+            `        <source>{VAR_PLURAL, plural, one {<x id=\"START_BOLD_TEXT\"/>something bold<x id=\"CLOSE_BOLD_TEXT\"/>} other {pre <x id=\"START_TAG_SPAN\"/>middle<x id=\"CLOSE_TAG_SPAN\"/> post}}</source>`,\n+            `      </trans-unit>`,\n             `    </body>`,\n             `  </file>`,\n             `</xliff>\\n`,"
        },
        {
            "sha": "a634d2a42c41e975f38bc5bef4bbfa52e2cc8f5e",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xliff2_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 5,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts?ref=81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
            "patch": "@@ -40,7 +40,19 @@ runInEachFileSystem(() => {\n             mockMessage('13579', ['', 'b', ''], ['START_BOLD_TEXT', 'CLOSE_BOLD_TEXT'], {}),\n             mockMessage('24680', ['a'], [], {meaning: 'meaning', description: 'and description'}),\n             mockMessage('80808', ['multi\\nlines'], [], {}),\n-            mockMessage('90000', ['<escape', 'me>'], ['double-quotes-\"'], {})\n+            mockMessage('90000', ['<escape', 'me>'], ['double-quotes-\"'], {}),\n+            mockMessage(\n+                '100000',\n+                [\n+                  'pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU'\n+                ],\n+                [], {}),\n+            mockMessage(\n+                '100001',\n+                [\n+                  '{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}'\n+                ],\n+                [], {}),\n           ];\n           const serializer =\n               new Xliff2TranslationSerializer('xx', absoluteFrom('/project'), useLegacyIds);\n@@ -55,7 +67,7 @@ runInEachFileSystem(() => {\n             `        <note category=\"meaning\">some meaning</note>`,\n             `      </notes>`,\n             `      <segment>`,\n-            `        <source>a<ph id=\"1\" equiv=\"PH\"/>b<ph id=\"2\" equiv=\"PH_1\"/>c</source>`,\n+            `        <source>a<ph id=\"0\" equiv=\"PH\"/>b<ph id=\"1\" equiv=\"PH_1\"/>c</source>`,\n             `      </segment>`,\n             `    </unit>`,\n             `    <unit id=\"67890\">`,\n@@ -64,12 +76,12 @@ runInEachFileSystem(() => {\n             `        <note category=\"description\">some description</note>`,\n             `      </notes>`,\n             `      <segment>`,\n-            `        <source>a<pc id=\"1\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\"></pc>c</source>`,\n+            `        <source>a<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\"></pc>c</source>`,\n             `      </segment>`,\n             `    </unit>`,\n             `    <unit id=\"13579\">`,\n             `      <segment>`,\n-            `        <source><pc id=\"1\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\">b</pc></source>`,\n+            `        <source><pc id=\"0\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\">b</pc></source>`,\n             `      </segment>`,\n             `    </unit>`,\n             `    <unit id=\"24680\">`,\n@@ -89,7 +101,17 @@ runInEachFileSystem(() => {\n             `    </unit>`,\n             `    <unit id=\"90000\">`,\n             `      <segment>`,\n-            `        <source>&lt;escape<ph id=\"1\" equiv=\"double-quotes-&quot;\"/>me&gt;</source>`,\n+            `        <source>&lt;escape<ph id=\"0\" equiv=\"double-quotes-&quot;\"/>me&gt;</source>`,\n+            `      </segment>`,\n+            `    </unit>`,\n+            `    <unit id=\"100000\">`,\n+            `      <segment>`,\n+            `        <source>pre-ICU {VAR_SELECT, select, a {a} b {<ph id=\"0\" equiv=\"INTERPOLATION\"/>} c {pre <ph id=\"1\" equiv=\"INTERPOLATION_1\"/> post}} post-ICU</source>`,\n+            `      </segment>`,\n+            `    </unit>`,\n+            `    <unit id=\"100001\">`,\n+            `      <segment>`,\n+            `        <source>{VAR_PLURAL, plural, one {<pc id=\"0\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\">something bold</pc>} other {pre <pc id=\"1\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\">middle</pc> post}}</source>`,\n             `      </segment>`,\n             `    </unit>`,\n             `  </file>`,"
        },
        {
            "sha": "b7ce9f41b6a3c9f784dadf17d8e8c858fba9512e",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xmb_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer_spec.ts?ref=81c3e809aaec5fc7563ad9ee28d3e13c7c13dc40",
            "patch": "@@ -30,6 +30,18 @@ runInEachFileSystem(() => {\n             mockMessage('24680', ['a'], [], {meaning: 'meaning', description: 'and description'}),\n             mockMessage('80808', ['multi\\nlines'], [], {}),\n             mockMessage('90000', ['<escape', 'me>'], ['double-quotes-\"'], {}),\n+            mockMessage(\n+                '100000',\n+                [\n+                  'pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU'\n+                ],\n+                [], {}),\n+            mockMessage(\n+                '100001',\n+                [\n+                  '{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}'\n+                ],\n+                [], {}),\n           ];\n           const serializer = new XmbTranslationSerializer(absoluteFrom('/project'), useLegacyIds);\n           const output = serializer.serialize(messages);\n@@ -44,6 +56,8 @@ runInEachFileSystem(() => {\n             `  <msg id=\"24680\" desc=\"and description\" meaning=\"meaning\">a</msg>`,\n             `  <msg id=\"80808\">multi`, `lines</msg>`,\n             `  <msg id=\"90000\">&lt;escape<ph name=\"double-quotes-&quot;\"/>me&gt;</msg>`,\n+            `  <msg id=\"100000\">pre-ICU {VAR_SELECT, select, a {a} b {<ph name=\"INTERPOLATION\"/>} c {pre <ph name=\"INTERPOLATION_1\"/> post}} post-ICU</msg>`,\n+            `  <msg id=\"100001\">{VAR_PLURAL, plural, one {<ph name=\"START_BOLD_TEXT\"/>something bold<ph name=\"CLOSE_BOLD_TEXT\"/>} other {pre <ph name=\"START_TAG_SPAN\"/>middle<ph name=\"CLOSE_TAG_SPAN\"/> post}}</msg>`,\n             `</messagebundle>\\n`\n           ].join('\\n'));\n         });"
        }
    ],
    "stats": {
        "total": 469,
        "additions": 437,
        "deletions": 32
    }
}