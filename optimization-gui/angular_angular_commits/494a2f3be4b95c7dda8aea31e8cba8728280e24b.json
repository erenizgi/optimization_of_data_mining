{
    "author": "mhevery",
    "message": "refactor(core): Create `NodeInjectorOffset` type which better describes NodeInjector (#38707)\n\n`NodeInjector` is store in expando as a list of values in an array. The\noffset constant into the array have been brought together into a single\n`NodeInjectorOffset` enum with better documentation explaining their usage.\n\nPR Close #38707",
    "sha": "494a2f3be4b95c7dda8aea31e8cba8728280e24b",
    "files": [
        {
            "sha": "32c0c57c2fce7d47f7709d06201c14dd0f88ea05",
            "filename": "packages/core/src/render3/assert.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Fassert.ts",
            "raw_url": "https://github.com/angular/angular/raw/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Fassert.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fassert.ts?ref=494a2f3be4b95c7dda8aea31e8cba8728280e24b",
            "patch": "@@ -10,7 +10,7 @@ import {assertDefined, assertEqual, assertNumber, throwError} from '../util/asse\n import {getComponentDef, getNgModuleDef} from './definition';\n import {LContainer} from './interfaces/container';\n import {DirectiveDef} from './interfaces/definition';\n-import {PARENT_INJECTOR} from './interfaces/injector';\n+import {NodeInjectorOffset} from './interfaces/injector';\n import {TNode} from './interfaces/node';\n import {isLContainer, isLView} from './interfaces/type_checks';\n import {HEADER_OFFSET, LView, TVIEW, TView} from './interfaces/view';\n@@ -136,7 +136,7 @@ export function assertBetween(lower: number, upper: number, index: number) {\n  */\n export function assertNodeInjector(lView: LView, injectorIndex: number) {\n   assertIndexInExpandoRange(lView, injectorIndex);\n-  assertIndexInExpandoRange(lView, injectorIndex + PARENT_INJECTOR);\n+  assertIndexInExpandoRange(lView, injectorIndex + NodeInjectorOffset.PARENT);\n   assertNumber(lView[injectorIndex + 0], 'injectorIndex should point to a bloom filter');\n   assertNumber(lView[injectorIndex + 1], 'injectorIndex should point to a bloom filter');\n   assertNumber(lView[injectorIndex + 2], 'injectorIndex should point to a bloom filter');\n@@ -146,6 +146,6 @@ export function assertNodeInjector(lView: LView, injectorIndex: number) {\n   assertNumber(lView[injectorIndex + 6], 'injectorIndex should point to a bloom filter');\n   assertNumber(lView[injectorIndex + 7], 'injectorIndex should point to a bloom filter');\n   assertNumber(\n-      lView[injectorIndex + 8 /*PARENT_INJECTOR*/],\n+      lView[injectorIndex + NodeInjectorOffset.PARENT],\n       'injectorIndex should point to parent injector');\n }"
        },
        {
            "sha": "cf924e82b8f8073cc61f720236a45577d435b61b",
            "filename": "packages/core/src/render3/context_discovery.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Fcontext_discovery.ts",
            "raw_url": "https://github.com/angular/angular/raw/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Fcontext_discovery.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fcontext_discovery.ts?ref=494a2f3be4b95c7dda8aea31e8cba8728280e24b",
            "patch": "@@ -207,7 +207,7 @@ function traverseNextElement(tNode: TNode): TNode|null {\n   if (tNode.child && tNode.child.parent === tNode) {\n     // FIXME(misko): checking if `tNode.child.parent === tNode` should not be necessary\n     // We have added it here because i18n creates TNode's which are not valid, so this is a work\n-    // around. The i18n code is being refactored in #??? and once it lands this extra check can be\n+    // around. The i18n code will be refactored in #39003 and once it lands this extra check can be\n     // deleted.\n     return tNode.child;\n   } else if (tNode.next) {"
        },
        {
            "sha": "4b225ba50839d5a60fdcaad5c62579c76de722ff",
            "filename": "packages/core/src/render3/di.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 9,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Fdi.ts",
            "raw_url": "https://github.com/angular/angular/raw/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Fdi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fdi.ts?ref=494a2f3be4b95c7dda8aea31e8cba8728280e24b",
            "patch": "@@ -21,7 +21,7 @@ import {getFactoryDef} from './definition';\n import {NG_ELEMENT_ID, NG_FACTORY_DEF} from './fields';\n import {registerPreOrderHooks} from './hooks';\n import {DirectiveDef, FactoryFn} from './interfaces/definition';\n-import {isFactory, NO_PARENT_INJECTOR, NodeInjectorFactory, PARENT_INJECTOR, RelativeInjectorLocation, RelativeInjectorLocationFlags, TNODE} from './interfaces/injector';\n+import {isFactory, NO_PARENT_INJECTOR, NodeInjectorFactory, NodeInjectorOffset, RelativeInjectorLocation, RelativeInjectorLocationFlags} from './interfaces/injector';\n import {AttributeMarker, TContainerNode, TDirectiveHostNode, TElementContainerNode, TElementNode, TNode, TNodeProviderIndexes, TNodeType} from './interfaces/node';\n import {isComponentDef, isComponentHost} from './interfaces/type_checks';\n import {DECLARATION_COMPONENT_VIEW, DECLARATION_VIEW, INJECTOR, LView, T_HOST, TData, TVIEW, TView, TViewType} from './interfaces/view';\n@@ -170,12 +170,12 @@ export function getOrCreateNodeInjectorForNode(\n     const parentData = parentLView[TVIEW].data as any;\n     // Creates a cumulative bloom filter that merges the parent's bloom filter\n     // and its own cumulative bloom (which contains tokens for all ancestors)\n-    for (let i = 0; i < 8; i++) {\n+    for (let i = 0; i < NodeInjectorOffset.BLOOM_SIZE; i++) {\n       lView[injectorIndex + i] = parentLView[parentIndex + i] | parentData[parentIndex + i];\n     }\n   }\n \n-  lView[injectorIndex + PARENT_INJECTOR] = parentLoc;\n+  lView[injectorIndex + NodeInjectorOffset.PARENT] = parentLoc;\n   return injectorIndex;\n }\n \n@@ -191,7 +191,7 @@ export function getInjectorIndex(tNode: TNode, lView: LView): number {\n       (tNode.parent && tNode.parent.injectorIndex === tNode.injectorIndex) ||\n       // After the first template pass, the injector index might exist but the parent values\n       // might not have been calculated yet for this instance\n-      lView[tNode.injectorIndex + PARENT_INJECTOR] == null) {\n+      lView[tNode.injectorIndex + NodeInjectorOffset.PARENT] === null) {\n     return -1;\n   } else {\n     ngDevMode && assertIndexInRange(lView, tNode.injectorIndex);\n@@ -402,7 +402,7 @@ export function getOrCreateInjectable<T>(\n       // searching the parent injector.\n       if (injectorIndex === -1 || flags & InjectFlags.SkipSelf) {\n         parentLocation = injectorIndex === -1 ? getParentInjectorLocation(tNode, lView) :\n-                                                lView[injectorIndex + PARENT_INJECTOR];\n+                                                lView[injectorIndex + NodeInjectorOffset.PARENT];\n \n         if (parentLocation === NO_PARENT_INJECTOR || !shouldSearchParent(flags, false)) {\n           injectorIndex = -1;\n@@ -420,7 +420,9 @@ export function getOrCreateInjectable<T>(\n \n         // Check the current injector. If it matches, see if it contains token.\n         const tView = lView[TVIEW];\n-        ngDevMode && assertTNodeForLView(tView.data[injectorIndex + TNODE] as TNode, lView);\n+        ngDevMode &&\n+            assertTNodeForLView(\n+                tView.data[injectorIndex + NodeInjectorOffset.TNODE] as TNode, lView);\n         if (bloomHasToken(bloomHash, injectorIndex, tView.data)) {\n           // At this point, we have an injector which *may* contain the token, so we step through\n           // the providers and directives associated with the injector's corresponding node to get\n@@ -431,10 +433,11 @@ export function getOrCreateInjectable<T>(\n             return instance;\n           }\n         }\n-        parentLocation = lView[injectorIndex + PARENT_INJECTOR];\n+        parentLocation = lView[injectorIndex + NodeInjectorOffset.PARENT];\n         if (parentLocation !== NO_PARENT_INJECTOR &&\n             shouldSearchParent(\n-                flags, lView[TVIEW].data[injectorIndex + TNODE] === hostTElementNode) &&\n+                flags,\n+                lView[TVIEW].data[injectorIndex + NodeInjectorOffset.TNODE] === hostTElementNode) &&\n             bloomHasToken(bloomHash, injectorIndex, lView)) {\n           // The def wasn't found anywhere on this node, so it was a false positive.\n           // Traverse up the tree and continue searching.\n@@ -485,7 +488,7 @@ function searchTokensOnInjector<T>(\n     injectorIndex: number, lView: LView, token: Type<T>|InjectionToken<T>,\n     previousTView: TView|null, flags: InjectFlags, hostTElementNode: TNode|null) {\n   const currentTView = lView[TVIEW];\n-  const tNode = currentTView.data[injectorIndex + TNODE] as TNode;\n+  const tNode = currentTView.data[injectorIndex + NodeInjectorOffset.TNODE] as TNode;\n   // First, we need to determine if view providers can be accessed by the starting element.\n   // There are two possibilities\n   const canAccessViewProviders = previousTView == null ?"
        },
        {
            "sha": "17f6d56c9de97d42758bb3c657159b4ada41a9ee",
            "filename": "packages/core/src/render3/instructions/lview_debug.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts",
            "raw_url": "https://github.com/angular/angular/raw/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts?ref=494a2f3be4b95c7dda8aea31e8cba8728280e24b",
            "patch": "@@ -16,7 +16,7 @@ import {assertNodeInjector} from '../assert';\n import {getInjectorIndex} from '../di';\n import {CONTAINER_HEADER_OFFSET, HAS_TRANSPLANTED_VIEWS, LContainer, MOVED_VIEWS, NATIVE} from '../interfaces/container';\n import {ComponentTemplate, DirectiveDef, DirectiveDefList, PipeDefList, ViewQueriesFunction} from '../interfaces/definition';\n-import {NO_PARENT_INJECTOR, PARENT_INJECTOR, TNODE} from '../interfaces/injector';\n+import {NO_PARENT_INJECTOR, NodeInjectorOffset} from '../interfaces/injector';\n import {AttributeMarker, PropertyAliases, TConstants, TContainerNode, TElementNode, TNode as ITNode, TNodeFlags, TNodeProviderIndexes, TNodeType, TNodeTypeAsString} from '../interfaces/node';\n import {SelectorFlags} from '../interfaces/projection';\n import {LQueries, TQueries} from '../interfaces/query';\n@@ -218,9 +218,9 @@ class TNode implements ITNode {\n     let injectorIndex = getInjectorIndex(this, lView);\n     ngDevMode && assertNodeInjector(lView, injectorIndex);\n     while (injectorIndex !== -1) {\n-      const tNode = lView[TVIEW].data[injectorIndex + TNODE] as TNode;\n+      const tNode = lView[TVIEW].data[injectorIndex + NodeInjectorOffset.TNODE] as TNode;\n       path.push(buildDebugNode(tNode, lView));\n-      const parentLocation = lView[injectorIndex + PARENT_INJECTOR];\n+      const parentLocation = lView[injectorIndex + NodeInjectorOffset.PARENT];\n       if (parentLocation === NO_PARENT_INJECTOR) {\n         injectorIndex = -1;\n       } else {"
        },
        {
            "sha": "39242c4a388347b0424e1c29c8b4cc28d8fff327",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=494a2f3be4b95c7dda8aea31e8cba8728280e24b",
            "patch": "@@ -25,7 +25,7 @@ import {throwMultipleComponentError} from '../errors';\n import {executeCheckHooks, executeInitAndCheckHooks, incrementInitPhaseFlags} from '../hooks';\n import {CONTAINER_HEADER_OFFSET, HAS_TRANSPLANTED_VIEWS, LContainer, MOVED_VIEWS} from '../interfaces/container';\n import {ComponentDef, ComponentTemplate, DirectiveDef, DirectiveDefListOrFactory, PipeDefListOrFactory, RenderFlags, ViewQueriesFunction} from '../interfaces/definition';\n-import {INJECTOR_BLOOM_PARENT_SIZE, NodeInjectorFactory} from '../interfaces/injector';\n+import {NodeInjectorFactory, NodeInjectorOffset} from '../interfaces/injector';\n import {AttributeMarker, InitialInputData, InitialInputs, LocalRefExtractor, PropertyAliases, PropertyAliasValue, TAttributes, TConstantsOrFactory, TContainerNode, TDirectiveHostNode, TElementContainerNode, TElementNode, TIcuContainerNode, TNode, TNodeFlags, TNodeProviderIndexes, TNodeType, TProjectionNode} from '../interfaces/node';\n import {isProceduralRenderer, RComment, RElement, Renderer3, RendererFactory3, RNode, RText} from '../interfaces/renderer';\n import {SanitizerFn} from '../interfaces/sanitization';\n@@ -88,7 +88,7 @@ export function setHostBindingsByExecutingExpandoInstructions(tView: TView, lVie\n \n             // Injector block and providers are taken into account.\n             const providerCount = (expandoInstructions[++i] as number);\n-            bindingRootIndex += INJECTOR_BLOOM_PARENT_SIZE + providerCount;\n+            bindingRootIndex += NodeInjectorOffset.SIZE + providerCount;\n \n             currentDirectiveIndex = bindingRootIndex;\n           } else {"
        },
        {
            "sha": "67625626518038542302225b0a8a8b10dfc6e92d",
            "filename": "packages/core/src/render3/interfaces/injector.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 6,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Finjector.ts",
            "raw_url": "https://github.com/angular/angular/raw/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Finjector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Finjector.ts?ref=494a2f3be4b95c7dda8aea31e8cba8728280e24b",
            "patch": "@@ -15,13 +15,49 @@ import {TDirectiveHostNode} from './node';\n import {LView, TData} from './view';\n \n /**\n- * Offset from 'injectorIndex' where:\n- * - `TViewData[injectorIndex + TNODE]` => `TNode` associated with the current injector.\n- * - `LView[injectorIndex + TNODE]` => index to the parent injector.\n+ * Offsets of the `NodeInjector` data structure in the expando.\n+ *\n+ * `NodeInjector` is stored in both `LView` as well as `TView.data`. All storage requires 9 words.\n+ * First 8 are reserved for bloom filter and the 9th is reserved for the associated `TNode` as well\n+ * as parent `NodeInjector` pointer. All indexes are starting with `index` and have an offset as\n+ * shown.\n+ *\n+ * `LView` layout:\n+ * ```\n+ * index + 0: cumulative bloom filter\n+ * index + 1: cumulative bloom filter\n+ * index + 2: cumulative bloom filter\n+ * index + 3: cumulative bloom filter\n+ * index + 4: cumulative bloom filter\n+ * index + 5: cumulative bloom filter\n+ * index + 6: cumulative bloom filter\n+ * index + 7: cumulative bloom filter\n+ * index + 8: cumulative bloom filter\n+ * index + PARENT: Index to the parent injector. See `RelativeInjectorLocation`\n+ *                 `const parent = lView[index + NodeInjectorOffset.PARENT]`\n+ * ```\n+ *\n+ * `TViewData` layout:\n+ * ```\n+ * index + 0: cumulative bloom filter\n+ * index + 1: cumulative bloom filter\n+ * index + 2: cumulative bloom filter\n+ * index + 3: cumulative bloom filter\n+ * index + 4: cumulative bloom filter\n+ * index + 5: cumulative bloom filter\n+ * index + 6: cumulative bloom filter\n+ * index + 7: cumulative bloom filter\n+ * index + 8: cumulative bloom filter\n+ * index + TNODE: TNode associated with this `NodeInjector`\n+ *                `canst tNode = tView.data[index + NodeInjectorOffset.TNODE]`\n+ * ```\n  */\n-export const TNODE = 8;\n-export const PARENT_INJECTOR = 8;\n-export const INJECTOR_BLOOM_PARENT_SIZE = 9;\n+export const enum NodeInjectorOffset {\n+  TNODE = 8,\n+  PARENT = 8,\n+  BLOOM_SIZE = 8,\n+  SIZE = 9,\n+}\n \n /**\n  * Represents a relative location of parent injector."
        },
        {
            "sha": "7a29718943237aeb565e0dd9c7bf738fe56a2b18",
            "filename": "packages/core/src/render3/view_engine_compatibility.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "raw_url": "https://github.com/angular/angular/raw/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts?ref=494a2f3be4b95c7dda8aea31e8cba8728280e24b",
            "patch": "@@ -22,7 +22,7 @@ import {assertLContainer, assertNodeInjector} from './assert';\n import {getParentInjectorLocation, NodeInjector} from './di';\n import {addToViewTree, createLContainer, createLView, renderView} from './instructions/shared';\n import {CONTAINER_HEADER_OFFSET, LContainer, NATIVE, VIEW_REFS} from './interfaces/container';\n-import {TNODE} from './interfaces/injector';\n+import {NodeInjectorOffset} from './interfaces/injector';\n import {TContainerNode, TDirectiveHostNode, TElementContainerNode, TElementNode, TNode, TNodeType} from './interfaces/node';\n import {isProceduralRenderer, RComment, RElement} from './interfaces/renderer';\n import {isComponentHost, isLContainer, isLView, isRootView} from './interfaces/type_checks';\n@@ -190,7 +190,8 @@ export function createContainerRef(\n           const parentView = getParentInjectorView(parentLocation, this._hostView);\n           const injectorIndex = getParentInjectorIndex(parentLocation);\n           ngDevMode && assertNodeInjector(parentView, injectorIndex);\n-          const parentTNode = parentView[TVIEW].data[injectorIndex + TNODE] as TElementNode;\n+          const parentTNode =\n+              parentView[TVIEW].data[injectorIndex + NodeInjectorOffset.TNODE] as TElementNode;\n           return new NodeInjector(parentTNode, parentView);\n         } else {\n           return new NodeInjector(null, this._hostView);"
        },
        {
            "sha": "bd0585da29453fcdb96eacba68bf0b50d589b6cb",
            "filename": "packages/core/test/render3/di_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Ftest%2Frender3%2Fdi_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/494a2f3be4b95c7dda8aea31e8cba8728280e24b/packages%2Fcore%2Ftest%2Frender3%2Fdi_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fdi_spec.ts?ref=494a2f3be4b95c7dda8aea31e8cba8728280e24b",
            "patch": "@@ -9,11 +9,11 @@\n import {InjectFlags, Optional, Renderer2, Self} from '@angular/core';\n import {createLView, createTView, getOrCreateTNode} from '@angular/core/src/render3/instructions/shared';\n import {RenderFlags} from '@angular/core/src/render3/interfaces/definition';\n+import {NodeInjectorOffset} from '@angular/core/src/render3/interfaces/injector';\n \n import {ɵɵdefineComponent} from '../../src/render3/definition';\n import {bloomAdd, bloomHashBitOrFactory as bloomHash, bloomHasToken, getOrCreateNodeInjectorForNode} from '../../src/render3/di';\n import {ɵɵdefineDirective, ɵɵdirectiveInject, ɵɵelement, ɵɵelementEnd, ɵɵelementStart, ɵɵtext} from '../../src/render3/index';\n-import {TNODE} from '../../src/render3/interfaces/injector';\n import {TNodeType} from '../../src/render3/interfaces/node';\n import {isProceduralRenderer} from '../../src/render3/interfaces/renderer';\n import {LViewFlags, TVIEW, TViewType} from '../../src/render3/interfaces/view';\n@@ -150,7 +150,7 @@ describe('di', () => {\n       });\n \n       function bloomState() {\n-        return mockTView.data.slice(0, TNODE).reverse();\n+        return mockTView.data.slice(0, NodeInjectorOffset.TNODE).reverse();\n       }\n \n       class Dir0 {"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 68,
        "deletions": 28
    }
}