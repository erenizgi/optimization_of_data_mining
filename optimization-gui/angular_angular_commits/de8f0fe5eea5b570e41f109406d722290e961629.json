{
    "author": "zarend",
    "message": "test(language-service): convert ivy diagnostics tests from legacy (#39957)\n\nThis commit updates the tests for the diagnostics in the ivy language\nservice to use the new in-memory test environment.\n\nPR Close #39957",
    "sha": "de8f0fe5eea5b570e41f109406d722290e961629",
    "files": [
        {
            "sha": "00316734506f307646f24c446a7d7af5eccb6aac",
            "filename": "packages/language-service/ivy/test/diagnostic_spec.ts",
            "status": "added",
            "additions": 108,
            "deletions": 0,
            "changes": 108,
            "blob_url": "https://github.com/angular/angular/blob/de8f0fe5eea5b570e41f109406d722290e961629/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/de8f0fe5eea5b570e41f109406d722290e961629/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts?ref=de8f0fe5eea5b570e41f109406d722290e961629",
            "patch": "@@ -0,0 +1,108 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {LanguageServiceTestEnvironment} from '@angular/language-service/ivy/test/env';\n+import * as ts from 'typescript';\n+import {createModuleWithDeclarations} from './test_utils';\n+\n+describe('getSemanticDiagnostics', () => {\n+  let env: LanguageServiceTestEnvironment;\n+\n+  beforeEach(() => {\n+    initMockFileSystem('Native');\n+  });\n+\n+  it('should not produce error for a minimal component defintion', () => {\n+    const appFile = {\n+      name: absoluteFrom('/app.ts'),\n+      contents: `\n+      import {Component, NgModule} from '@angular/core';\n+\n+      @Component({\n+        template: ''\n+      })\n+      export class AppComponent {}\n+    `\n+    };\n+    env = createModuleWithDeclarations([appFile]);\n+\n+    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.ts'));\n+    expect(diags.length).toEqual(0);\n+  });\n+\n+  it('should report member does not exist', () => {\n+    const appFile = {\n+      name: absoluteFrom('/app.ts'),\n+      contents: `\n+      import {Component, NgModule} from '@angular/core';\n+\n+      @Component({\n+        template: '{{nope}}'\n+      })\n+      export class AppComponent {}\n+    `\n+    };\n+    env = createModuleWithDeclarations([appFile]);\n+\n+    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.ts'));\n+    expect(diags.length).toBe(1);\n+    const {category, file, start, length, messageText} = diags[0];\n+    expect(category).toBe(ts.DiagnosticCategory.Error);\n+    expect(file?.fileName).toBe('/app.ts');\n+    expect(messageText).toBe(`Property 'nope' does not exist on type 'AppComponent'.`);\n+  });\n+\n+  it('should process external template', () => {\n+    const appFile = {\n+      name: absoluteFrom('/app.ts'),\n+      contents: `\n+      import {Component, NgModule} from '@angular/core';\n+\n+      @Component({\n+        templateUrl: './app.html'\n+      })\n+      export class AppComponent {}\n+    `\n+    };\n+    const templateFile = {\n+      name: absoluteFrom('/app.html'),\n+      contents: `\n+      Hello world!\n+    `\n+    };\n+\n+    env = createModuleWithDeclarations([appFile], [templateFile]);\n+    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.html'));\n+    expect(diags).toEqual([]);\n+  });\n+\n+  it('should report member does not exist in external template', () => {\n+    const appFile = {\n+      name: absoluteFrom('/app.ts'),\n+      contents: `\n+      import {Component, NgModule} from '@angular/core';\n+\n+      @Component({\n+        templateUrl: './app.html'\n+      })\n+      export class AppComponent {}\n+    `\n+    };\n+    const templateFile = {name: absoluteFrom('/app.html'), contents: `{{nope}}`};\n+\n+    env = createModuleWithDeclarations([appFile], [templateFile]);\n+    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.html'));\n+    expect(diags.length).toBe(1);\n+    const {category, file, start, length, messageText} = diags[0];\n+    expect(category).toBe(ts.DiagnosticCategory.Error);\n+    expect(file?.fileName).toBe('/app.html');\n+    expect(messageText).toBe(`Property 'nope' does not exist on type 'AppComponent'.`);\n+  });\n+});"
        },
        {
            "sha": "f3da97fc390fa9e9b36ffda3450e21e63903de8b",
            "filename": "packages/language-service/ivy/test/legacy/daignostic_spec.ts",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/de8f0fe5eea5b570e41f109406d722290e961629/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdaignostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/de8f0fe5eea5b570e41f109406d722290e961629/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdaignostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdaignostic_spec.ts?ref=de8f0fe5eea5b570e41f109406d722290e961629",
            "patch": "@@ -0,0 +1,41 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {LanguageService} from '../../language_service';\n+\n+import {MockService, setup, TEST_TEMPLATE} from './mock_host';\n+\n+describe('getSemanticDiagnostics', () => {\n+  let service: MockService;\n+  let ngLS: LanguageService;\n+\n+  beforeAll(() => {\n+    const {project, service: _service, tsLS} = setup();\n+    service = _service;\n+    ngLS = new LanguageService(project, tsLS);\n+  });\n+\n+  beforeEach(() => {\n+    service.reset();\n+  });\n+\n+  it('should retrieve external template from latest snapshot', () => {\n+    // This test is to make sure we are reading from snapshot instead of disk\n+    // if content from snapshot is newer. It also makes sure the internal cache\n+    // of the resource loader is invalidated on content change.\n+    service.overwrite(TEST_TEMPLATE, `{{ foo }}`);\n+    const d1 = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n+    expect(d1.length).toBe(1);\n+    expect(d1[0].messageText).toBe(`Property 'foo' does not exist on type 'TemplateReference'.`);\n+\n+    service.overwrite(TEST_TEMPLATE, `{{ bar }}`);\n+    const d2 = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n+    expect(d2.length).toBe(1);\n+    expect(d2[0].messageText).toBe(`Property 'bar' does not exist on type 'TemplateReference'.`);\n+  });\n+});"
        },
        {
            "sha": "1d8f6c4ef31308568e89c1ca72f28e5caebd88c6",
            "filename": "packages/language-service/ivy/test/legacy/diagnostic_spec.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 75,
            "changes": 75,
            "blob_url": "https://github.com/angular/angular/blob/65651b094d3259960542374e9ddc170289491110/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdiagnostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/65651b094d3259960542374e9ddc170289491110/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdiagnostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdiagnostic_spec.ts?ref=65651b094d3259960542374e9ddc170289491110",
            "patch": "@@ -1,75 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import * as ts from 'typescript/lib/tsserverlibrary';\n-\n-import {LanguageService} from '../../language_service';\n-\n-import {APP_COMPONENT, MockService, setup, TEST_TEMPLATE} from './mock_host';\n-\n-describe('getSemanticDiagnostics', () => {\n-  let service: MockService;\n-  let ngLS: LanguageService;\n-\n-  beforeAll(() => {\n-    const {project, service: _service, tsLS} = setup();\n-    service = _service;\n-    ngLS = new LanguageService(project, tsLS);\n-  });\n-\n-  beforeEach(() => {\n-    service.reset();\n-  });\n-\n-  it('should not produce error for AppComponent', () => {\n-    const diags = ngLS.getSemanticDiagnostics(APP_COMPONENT);\n-    expect(diags).toEqual([]);\n-  });\n-\n-  it('should report member does not exist', () => {\n-    const {text} = service.overwriteInlineTemplate(APP_COMPONENT, '{{ nope }}');\n-    const diags = ngLS.getSemanticDiagnostics(APP_COMPONENT);\n-    expect(diags.length).toBe(1);\n-    const {category, file, start, length, messageText} = diags[0];\n-    expect(category).toBe(ts.DiagnosticCategory.Error);\n-    expect(file?.fileName).toBe(APP_COMPONENT);\n-    expect(text.substring(start!, start! + length!)).toBe('nope');\n-    expect(messageText).toBe(`Property 'nope' does not exist on type 'AppComponent'.`);\n-  });\n-\n-  it('should process external template', () => {\n-    const diags = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n-    expect(diags).toEqual([]);\n-  });\n-\n-  it('should report member does not exist in external template', () => {\n-    const {text} = service.overwrite(TEST_TEMPLATE, `{{ nope }}`);\n-    const diags = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n-    expect(diags.length).toBe(1);\n-    const {category, file, start, length, messageText} = diags[0];\n-    expect(category).toBe(ts.DiagnosticCategory.Error);\n-    expect(file?.fileName).toBe(TEST_TEMPLATE);\n-    expect(text.substring(start!, start! + length!)).toBe('nope');\n-    expect(messageText).toBe(`Property 'nope' does not exist on type 'TemplateReference'.`);\n-  });\n-\n-  it('should retrieve external template from latest snapshot', () => {\n-    // This test is to make sure we are reading from snapshot instead of disk\n-    // if content from snapshot is newer. It also makes sure the internal cache\n-    // of the resource loader is invalidated on content change.\n-    service.overwrite(TEST_TEMPLATE, `{{ foo }}`);\n-    const d1 = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n-    expect(d1.length).toBe(1);\n-    expect(d1[0].messageText).toBe(`Property 'foo' does not exist on type 'TemplateReference'.`);\n-\n-    service.overwrite(TEST_TEMPLATE, `{{ bar }}`);\n-    const d2 = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n-    expect(d2.length).toBe(1);\n-    expect(d2[0].messageText).toBe(`Property 'bar' does not exist on type 'TemplateReference'.`);\n-  });\n-});"
        },
        {
            "sha": "b56e3ca8ff3911431ab475e6c87e5a53b24df6af",
            "filename": "packages/language-service/ivy/test/references_spec.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 59,
            "changes": 85,
            "blob_url": "https://github.com/angular/angular/blob/de8f0fe5eea5b570e41f109406d722290e961629/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/de8f0fe5eea5b570e41f109406d722290e961629/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts?ref=de8f0fe5eea5b570e41f109406d722290e961629",
            "patch": "@@ -11,7 +11,7 @@ import {initMockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {extractCursorInfo, LanguageServiceTestEnvironment} from './env';\n-import {getText} from './test_utils';\n+import {createModuleWithDeclarations, getText} from './test_utils';\n \n describe('find references', () => {\n   let env: LanguageServiceTestEnvironment;\n@@ -30,7 +30,7 @@ describe('find references', () => {\n           }`);\n     const appFile = {name: _('/app.ts'), contents: text};\n     const templateFile = {name: _('/app.html'), contents: '{{myProp}}'};\n-    createModuleWithDeclarations([appFile], [templateFile]);\n+    env = createModuleWithDeclarations([appFile], [templateFile]);\n     const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n     expect(refs.length).toBe(2);\n     assertFileNames(refs, ['app.html', 'app.ts']);\n@@ -46,7 +46,7 @@ describe('find references', () => {\n             myP¦rop!: string;\n           }`);\n     const appFile = {name: _('/app.ts'), contents: text};\n-    createModuleWithDeclarations([appFile]);\n+    env = createModuleWithDeclarations([appFile]);\n     const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n     expect(refs.length).toBe(2);\n     assertFileNames(refs, ['app.ts']);\n@@ -66,7 +66,7 @@ describe('find references', () => {\n     };\n     const {text, cursor} = extractCursorInfo('{{myP¦rop}}');\n     const templateFile = {name: _('/app.html'), contents: text};\n-    createModuleWithDeclarations([appFile], [templateFile]);\n+    env = createModuleWithDeclarations([appFile], [templateFile]);\n     const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n     expect(refs.length).toBe(2);\n     assertFileNames(refs, ['app.html', 'app.ts']);\n@@ -82,7 +82,7 @@ describe('find references', () => {\n             setTitle(s: number) {}\n           }`);\n     const appFile = {name: _('/app.ts'), contents: text};\n-    createModuleWithDeclarations([appFile]);\n+    env = createModuleWithDeclarations([appFile]);\n     const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n     expect(refs.length).toBe(2);\n \n@@ -100,7 +100,7 @@ describe('find references', () => {\n             setTitle(s: string) {}\n           }`);\n     const appFile = {name: _('/app.ts'), contents: text};\n-    createModuleWithDeclarations([appFile]);\n+    env = createModuleWithDeclarations([appFile]);\n     const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n     expect(refs.length).toBe(2);\n \n@@ -121,7 +121,7 @@ describe('find references', () => {\n     const templateFileWithCursor = `<div (click)=\"ti¦tle = 'newtitle'\"></div>`;\n     const {text, cursor} = extractCursorInfo(templateFileWithCursor);\n     const templateFile = {name: _('/app.html'), contents: text};\n-    createModuleWithDeclarations([appFile], [templateFile]);\n+    env = createModuleWithDeclarations([appFile], [templateFile]);\n     const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n     expect(refs.length).toBe(2);\n \n@@ -142,7 +142,7 @@ describe('find references', () => {\n       name: _('/app.ts'),\n       contents: text,\n     };\n-    createModuleWithDeclarations([appFile]);\n+    env = createModuleWithDeclarations([appFile]);\n     const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n     expect(refs.length).toBe(2);\n \n@@ -162,7 +162,7 @@ describe('find references', () => {\n       name: _('/app.ts'),\n       contents: text,\n     };\n-    createModuleWithDeclarations([appFile]);\n+    env = createModuleWithDeclarations([appFile]);\n     const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n     // 3 references: the type definition, the value assignment, and the read in the template\n     expect(refs.length).toBe(3);\n@@ -191,7 +191,7 @@ describe('find references', () => {\n     const templateFileWithCursor = `<div (click)=\"hero['name'] = bat¦man\"></div>`;\n     const {text, cursor} = extractCursorInfo(templateFileWithCursor);\n     const templateFile = {name: _('/app.html'), contents: text};\n-    createModuleWithDeclarations([appFile], [templateFile]);\n+    env = createModuleWithDeclarations([appFile], [templateFile]);\n     const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n     expect(refs.length).toBe(2);\n \n@@ -209,7 +209,7 @@ describe('find references', () => {\n             title = '';\n           }`);\n       const appFile = {name: _('/app.ts'), contents: text};\n-      createModuleWithDeclarations([appFile]);\n+      env = createModuleWithDeclarations([appFile]);\n       const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n       expect(refs.length).toBe(2);\n       assertTextSpans(refs, ['myInput']);\n@@ -236,7 +236,7 @@ describe('find references', () => {\n       };\n       const {text, cursor} = extractCursorInfo(templateWithCursor);\n       const templateFile = {name: _('/app.html'), contents: text};\n-      createModuleWithDeclarations([appFile], [templateFile]);\n+      env = createModuleWithDeclarations([appFile], [templateFile]);\n       const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n       expect(refs.length).toBe(2);\n       assertTextSpans(refs, ['myTemplate']);\n@@ -274,7 +274,7 @@ describe('find references', () => {\n         const templateWithCursor = '<div [dir] #dirRef=\"myDir\"></div> {{ dirR¦ef }}';\n         const {text, cursor} = extractCursorInfo(templateWithCursor);\n         const templateFile = {name: _('/app.html'), contents: text};\n-        createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n+        env = createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n         const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n         expect(refs.length).toBe(2);\n         assertFileNames(refs, ['app.html']);\n@@ -285,7 +285,7 @@ describe('find references', () => {\n         const fileWithCursor = '<div [dir] #dirRef=\"myDir\"></div> {{ dirRef.dirV¦alue }}';\n         const {text, cursor} = extractCursorInfo(fileWithCursor);\n         const templateFile = {name: _('/app.html'), contents: text};\n-        createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n+        env = createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n         const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n         expect(refs.length).toBe(2);\n         assertFileNames(refs, ['dir.ts', 'app.html']);\n@@ -296,7 +296,7 @@ describe('find references', () => {\n         const fileWithCursor = '<div [dir] #dirRef=\"myDir\"></div> {{ dirRef?.dirV¦alue }}';\n         const {text, cursor} = extractCursorInfo(fileWithCursor);\n         const templateFile = {name: _('/app.html'), contents: text};\n-        createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n+        env = createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n         const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n         expect(refs.length).toBe(2);\n         assertFileNames(refs, ['dir.ts', 'app.html']);\n@@ -307,7 +307,7 @@ describe('find references', () => {\n         const fileWithCursor = '<div [dir] #dirRef=\"myDir\"></div> {{ dirRef?.doSometh¦ing() }}';\n         const {text, cursor} = extractCursorInfo(fileWithCursor);\n         const templateFile = {name: _('/app.html'), contents: text};\n-        createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n+        env = createModuleWithDeclarations([appFile, dirFile], [templateFile]);\n         const refs = getReferencesAtPosition(_('/app.html'), cursor)!;\n         expect(refs.length).toBe(2);\n         assertFileNames(refs, ['dir.ts', 'app.html']);\n@@ -326,7 +326,7 @@ describe('find references', () => {\n             heroes: string[] = [];\n           }`);\n       const appFile = {name: _('/app.ts'), contents: text};\n-      createModuleWithDeclarations([appFile]);\n+      env = createModuleWithDeclarations([appFile]);\n       const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n       expect(refs.length).toBe(2);\n       assertFileNames(refs, ['app.ts']);\n@@ -347,7 +347,7 @@ describe('find references', () => {\n             heroes: string[] = [];\n           }`);\n       const appFile = {name: _('/app.ts'), contents: text};\n-      createModuleWithDeclarations([appFile]);\n+      env = createModuleWithDeclarations([appFile]);\n       const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n       expect(refs.length).toBe(2);\n       assertFileNames(refs, ['app.ts']);\n@@ -408,7 +408,7 @@ describe('find references', () => {\n               heroes: Array<{name: string}> = [];\n             }`);\n       const appFile = {name: _('/app.ts'), contents: text};\n-      createModuleWithDeclarations([appFile]);\n+      env = createModuleWithDeclarations([appFile]);\n       const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n       expect(refs.length).toBe(2);\n       assertFileNames(refs, ['app.ts']);\n@@ -444,7 +444,7 @@ describe('find references', () => {\n       `;\n       const {text, cursor} = extractCursorInfo(appContentsWithCursor);\n       const appFile = {name: _('/app.ts'), contents: text};\n-      createModuleWithDeclarations([appFile, prefixPipeFile]);\n+      env = createModuleWithDeclarations([appFile, prefixPipeFile]);\n       const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n       expect(refs.length).toBe(5);\n       assertFileNames(refs, ['index.d.ts', 'prefix-pipe.ts', 'app.ts']);\n@@ -463,7 +463,7 @@ describe('find references', () => {\n       `;\n       const {text, cursor} = extractCursorInfo(appContentsWithCursor);\n       const appFile = {name: _('/app.ts'), contents: text};\n-      createModuleWithDeclarations([appFile, prefixPipeFile]);\n+      env = createModuleWithDeclarations([appFile, prefixPipeFile]);\n       const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n       expect(refs.length).toBe(2);\n       assertFileNames(refs, ['app.ts']);\n@@ -490,7 +490,7 @@ describe('find references', () => {\n           title = 'title';\n         }`);\n       const appFile = {name: _('/app.ts'), contents: text};\n-      createModuleWithDeclarations([appFile, stringModelTestFile]);\n+      env = createModuleWithDeclarations([appFile, stringModelTestFile]);\n       const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n       expect(refs.length).toEqual(2);\n       assertFileNames(refs, ['string-model.ts', 'app.ts']);\n@@ -507,7 +507,7 @@ describe('find references', () => {\n           title = 'title';\n         }`);\n       const appFile = {name: _('/app.ts'), contents: text};\n-      createModuleWithDeclarations([appFile, stringModelTestFile]);\n+      env = createModuleWithDeclarations([appFile, stringModelTestFile]);\n       const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n       expect(refs.length).toEqual(2);\n       assertFileNames(refs, ['string-model.ts', 'app.ts']);\n@@ -534,7 +534,7 @@ describe('find references', () => {\n           title = 'title';\n         }`,\n       };\n-      createModuleWithDeclarations([appFile, stringModelTestFile]);\n+      env = createModuleWithDeclarations([appFile, stringModelTestFile]);\n       const refs = getReferencesAtPosition(_('/string-model.ts'), cursor)!;\n       expect(refs.length).toEqual(2);\n       assertFileNames(refs, ['app.ts', 'string-model.ts']);\n@@ -576,7 +576,7 @@ describe('find references', () => {\n           title = 'title';\n         }`,\n       };\n-      createModuleWithDeclarations([appFile, stringModelTestFile, otherDirFile]);\n+      env = createModuleWithDeclarations([appFile, stringModelTestFile, otherDirFile]);\n       const refs = getReferencesAtPosition(_('/other-dir.ts'), cursor)!;\n       expect(refs.length).toEqual(3);\n       assertFileNames(refs, ['app.ts', 'string-model.ts', 'other-dir.ts']);\n@@ -593,7 +593,7 @@ describe('find references', () => {\n           title = 'title';\n         }`);\n       const appFile = {name: _('/app.ts'), contents: text};\n-      createModuleWithDeclarations([appFile, stringModelTestFile]);\n+      env = createModuleWithDeclarations([appFile, stringModelTestFile]);\n       const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n       expect(refs.length).toEqual(2);\n       assertFileNames(refs, ['string-model.ts', 'app.ts']);\n@@ -703,39 +703,6 @@ describe('find references', () => {\n           entry.originalContextSpan ? getText(fileContents, entry.originalContextSpan) : undefined,\n     };\n   }\n-\n-  function getFirstClassDeclaration(declaration: string) {\n-    const matches = declaration.match(/(?:export class )(\\w+)(?:\\s|\\{)/);\n-    if (matches === null || matches.length !== 2) {\n-      throw new Error(`Did not find exactly one exported class in: ${declaration}`);\n-    }\n-    return matches[1].trim();\n-  }\n-\n-  function createModuleWithDeclarations(\n-      filesWithClassDeclarations: TestFile[], externalResourceFiles: TestFile[] = []): void {\n-    const externalClasses =\n-        filesWithClassDeclarations.map(file => getFirstClassDeclaration(file.contents));\n-    const externalImports = filesWithClassDeclarations.map(file => {\n-      const className = getFirstClassDeclaration(file.contents);\n-      const fileName = last(file.name.split('/')).replace('.ts', '');\n-      return `import {${className}} from './${fileName}';`;\n-    });\n-    const contents = `\n-        import {NgModule} from '@angular/core';\n-        import {CommonModule} from '@angular/common';\n-        ${externalImports.join('\\n')}\n-\n-        @NgModule({\n-          declarations: [${externalClasses.join(',')}],\n-          imports: [CommonModule],\n-        })\n-        export class AppModule {}\n-      `;\n-    const moduleFile = {name: _('/app-module.ts'), contents, isRoot: true};\n-    env = LanguageServiceTestEnvironment.setup(\n-        [moduleFile, ...filesWithClassDeclarations, ...externalResourceFiles]);\n-  }\n });\n \n function assertFileNames(refs: Array<{fileName: string}>, expectedFileNames: string[]) {"
        },
        {
            "sha": "2d7253f91b622290a84c59b0794f2702b061dd92",
            "filename": "packages/language-service/ivy/test/test_utils.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/de8f0fe5eea5b570e41f109406d722290e961629/packages%2Flanguage-service%2Fivy%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/de8f0fe5eea5b570e41f109406d722290e961629/packages%2Flanguage-service%2Fivy%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Ftest_utils.ts?ref=de8f0fe5eea5b570e41f109406d722290e961629",
            "patch": "@@ -6,7 +6,48 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {absoluteFrom as _} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {LanguageServiceTestEnvironment} from '@angular/language-service/ivy/test/env';\n \n export function getText(contents: string, textSpan: ts.TextSpan) {\n   return contents.substr(textSpan.start, textSpan.length);\n }\n+\n+function last<T>(array: T[]): T {\n+  return array[array.length - 1];\n+}\n+\n+function getFirstClassDeclaration(declaration: string) {\n+  const matches = declaration.match(/(?:export class )(\\w+)(?:\\s|\\{)/);\n+  if (matches === null || matches.length !== 2) {\n+    throw new Error(`Did not find exactly one exported class in: ${declaration}`);\n+  }\n+  return matches[1].trim();\n+}\n+\n+export function createModuleWithDeclarations(\n+    filesWithClassDeclarations: TestFile[],\n+    externalResourceFiles: TestFile[] = []): LanguageServiceTestEnvironment {\n+  const externalClasses =\n+      filesWithClassDeclarations.map(file => getFirstClassDeclaration(file.contents));\n+  const externalImports = filesWithClassDeclarations.map(file => {\n+    const className = getFirstClassDeclaration(file.contents);\n+    const fileName = last(file.name.split('/')).replace('.ts', '');\n+    return `import {${className}} from './${fileName}';`;\n+  });\n+  const contents = `\n+        import {NgModule} from '@angular/core';\n+        import {CommonModule} from '@angular/common';\n+        ${externalImports.join('\\n')}\n+\n+        @NgModule({\n+          declarations: [${externalClasses.join(',')}],\n+          imports: [CommonModule],\n+        })\n+        export class AppModule {}\n+      `;\n+  const moduleFile = {name: _('/app-module.ts'), contents, isRoot: true};\n+  return LanguageServiceTestEnvironment.setup(\n+      [moduleFile, ...filesWithClassDeclarations, ...externalResourceFiles]);\n+}"
        }
    ],
    "stats": {
        "total": 350,
        "additions": 216,
        "deletions": 134
    }
}