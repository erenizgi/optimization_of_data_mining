{
    "author": "amirrustam",
    "message": "ci(devtools): fix flaky tests using cypress orb (rangle/angular-devtools#733)\n\n* ci: refactor circle config to use cypress orb\r\n\r\n* ci: skipping unit tests while validating e2e runs\r\n\r\n* ci: fix karma chrome launches\r\n\r\n* ci: investigating karma headless failure\r\n\r\n* ci: iterating on failure\r\n\r\n* ci: move environment to executor\r\n\r\n* build: revert karma config changes\r\n\r\n* ci: update karma config\r\n\r\nCo-authored-by: mgechev <mgechev@gmail.com>",
    "sha": "5b0d3356a64c35f6308b95501ad81e89fe3ad7a7",
    "files": [
        {
            "sha": "7afa68bef23c0b0535e763ff536d6fcecd5189da",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 88,
            "deletions": 56,
            "changes": 144,
            "blob_url": "https://github.com/angular/angular/blob/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=5b0d3356a64c35f6308b95501ad81e89fe3ad7a7",
            "patch": "@@ -1,59 +1,91 @@\n-# JavaScript Node CircleCI 2.0 configuration file\n-#\n-# Check https://circleci.com/docs/2.0/language-javascript/ for more details\n-#\n-version: 2\n-jobs:\n-  build:\n+version: 2.1\n+orbs:\n+  cypress: cypress-io/cypress@1.28.0\n+executors:\n+  node-and-browsers:\n     docker:\n-      # specify the version you desire here\n-      - image: circleci/node:14.15.1-browsers\n-\n-    working_directory: ~/repo\n-\n+      - image: cypress/browsers:node14.16.0-chrome89-ff86\n     environment:\n       - CHROME_BIN: /usr/bin/google-chrome\n-      - CYPRESS_CACHE_FOLDER: /home/circleci/.cache/Cypress\n-\n-    steps:\n-      - checkout\n-\n-      # Download and cache dependencies\n-      - restore_cache:\n-          keys:\n-            - v2-dependencies-{{ checksum \"package.json\" }}\n-            # fallback to using the latest cache if no exact match is found\n-            - v2-dependencies-\n-\n-      - run: yarn install\n-      - run: yarn cy:verify\n-\n-      - save_cache:\n-          paths:\n-            - node_modules\n-            - /home/circleci/.cache/Cypress\n-          key: v2-dependencies-{{ checksum \"package.json\" }}\n-\n-      - run:\n-          name: 'Run linting'\n-          command: yarn lint\n-      # run tests!\n-      - run:\n-          name: 'Run Unit tests'\n-          command: yarn test:ci\n-\n-      - run:\n-          name: 'Run Cypress tests'\n-          command: yarn cy:ci\n-          no_output_timeout: '10m'\n-\n-      - run:\n-          name: 'Test Chrome Build'\n-          command: yarn build:chrome\n-\n-    artifacts:\n-      when: always\n-      paths:\n-        - cypress/videos/**/*.mp4\n-        - cypress/screenshots/**/*.png\n-      expire_in: 1 day\n+workflows:\n+  test-and-build:\n+    jobs:\n+      - cypress/install:\n+          name: Setup\n+          yarn: true\n+          executor: node-and-browsers\n+          post-steps:\n+            - run:\n+                name: Run Linting\n+                command: yarn lint\n+            - run:\n+                name: Run Unit Tests\n+                command: yarn test:ci\n+      - cypress/run:\n+          name: 'E2E Tests - Chrome'\n+          browser: chrome\n+          executor: node-and-browsers\n+          yarn: true\n+          start: yarn start\n+          wait-on: 'http://localhost:4200'\n+          requires:\n+            - Setup\n+          post-steps:\n+            - run:\n+                name: Test Chrome Build\n+                command: yarn build:chrome\n+# version: 2\n+# jobs:\n+#   build:\n+#     docker:\n+#       # specify the version you desire here\n+#       - image: circleci/node:14.15.1-browsers\n+\n+#     working_directory: ~/repo\n+\n+#     environment:\n+#       - CHROME_BIN: /usr/bin/google-chrome\n+#       - CYPRESS_CACHE_FOLDER: /home/circleci/.cache/Cypress\n+\n+#     steps:\n+#       - checkout\n+\n+#       # Download and cache dependencies\n+#       - restore_cache:\n+#           keys:\n+#             - v2-dependencies-{{ checksum \"package.json\" }}\n+#             # fallback to using the latest cache if no exact match is found\n+#             - v2-dependencies-\n+\n+#       - run: yarn install\n+#       - run: yarn cy:verify\n+\n+#       - save_cache:\n+#           paths:\n+#             - node_modules\n+#             - /home/circleci/.cache/Cypress\n+#           key: v2-dependencies-{{ checksum \"package.json\" }}\n+\n+#       - run:\n+#           name: 'Run linting'\n+#           command: yarn lint\n+#       # run tests!\n+#       - run:\n+#           name: 'Run Unit tests'\n+#           command: yarn test:ci\n+\n+#       - run:\n+#           name: 'Run Cypress tests'\n+#           command: yarn cy:ci\n+#           no_output_timeout: '10m'\n+\n+#       - run:\n+#           name: 'Test Chrome Build'\n+#           command: yarn build:chrome\n+\n+#     artifacts:\n+#       when: always\n+#       paths:\n+#         - cypress/videos/**/*.mp4\n+#         - cypress/screenshots/**/*.png\n+#       expire_in: 1 day"
        },
        {
            "sha": "e0813af37cf214a00ce81bd25b31c718ab642073",
            "filename": "karma.conf.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/karma.conf.js",
            "raw_url": "https://github.com/angular/angular/raw/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/karma.conf.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/karma.conf.js?ref=5b0d3356a64c35f6308b95501ad81e89fe3ad7a7",
            "patch": "@@ -25,7 +25,13 @@ module.exports = function (config) {\n     colors: true,\n     logLevel: config.LOG_INFO,\n     autoWatch: true,\n-    browsers: ['Chrome'],\n+    browsers: ['ChromeHeadlessNoSandbox'],\n+    customLaunchers: {\n+      ChromeHeadlessNoSandbox: {\n+        base: 'ChromeHeadless',\n+        flags: ['--no-sandbox'],\n+      },\n+    },\n     singleRun: false,\n     restartOnFileChange: true,\n   });"
        },
        {
            "sha": "aaea4e49b4edd89da19d8f0c4b205076695e1a80",
            "filename": "projects/demo-no-zone/karma.conf.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fdemo-no-zone%2Fkarma.conf.js",
            "raw_url": "https://github.com/angular/angular/raw/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fdemo-no-zone%2Fkarma.conf.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fdemo-no-zone%2Fkarma.conf.js?ref=5b0d3356a64c35f6308b95501ad81e89fe3ad7a7",
            "patch": "@@ -25,7 +25,13 @@ module.exports = function (config) {\n     colors: true,\n     logLevel: config.LOG_INFO,\n     autoWatch: true,\n-    browsers: ['Chrome'],\n+    browsers: ['ChromeHeadlessNoSandbox'],\n+    customLaunchers: {\n+      ChromeHeadlessNoSandbox: {\n+        base: 'ChromeHeadless',\n+        flags: ['--no-sandbox'],\n+      },\n+    },\n     singleRun: false,\n     restartOnFileChange: true,\n   });"
        },
        {
            "sha": "b7bf2df04499669e7310a2adc3809f183ee0f7ea",
            "filename": "projects/ng-devtools-backend/karma.conf.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fng-devtools-backend%2Fkarma.conf.js",
            "raw_url": "https://github.com/angular/angular/raw/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fng-devtools-backend%2Fkarma.conf.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fkarma.conf.js?ref=5b0d3356a64c35f6308b95501ad81e89fe3ad7a7",
            "patch": "@@ -25,7 +25,13 @@ module.exports = function (config) {\n     colors: true,\n     logLevel: config.LOG_INFO,\n     autoWatch: true,\n-    browsers: ['Chrome'],\n+    browsers: ['ChromeHeadlessNoSandbox'],\n+    customLaunchers: {\n+      ChromeHeadlessNoSandbox: {\n+        base: 'ChromeHeadless',\n+        flags: ['--no-sandbox'],\n+      },\n+    },\n     singleRun: false,\n     restartOnFileChange: true,\n   });"
        },
        {
            "sha": "858868f6761e26d05b3d2652f97013ad06bf0c39",
            "filename": "projects/ng-devtools/karma.conf.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fng-devtools%2Fkarma.conf.js",
            "raw_url": "https://github.com/angular/angular/raw/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fng-devtools%2Fkarma.conf.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fkarma.conf.js?ref=5b0d3356a64c35f6308b95501ad81e89fe3ad7a7",
            "patch": "@@ -25,7 +25,13 @@ module.exports = function (config) {\n     colors: true,\n     logLevel: config.LOG_INFO,\n     autoWatch: true,\n-    browsers: ['Chrome'],\n+    browsers: ['ChromeHeadlessNoSandbox'],\n+    customLaunchers: {\n+      ChromeHeadlessNoSandbox: {\n+        base: 'ChromeHeadless',\n+        flags: ['--no-sandbox'],\n+      },\n+    },\n     singleRun: false,\n     restartOnFileChange: true,\n   });"
        },
        {
            "sha": "b95ab9785a96b0a51ca1bfc549e2e271c61142e0",
            "filename": "projects/protocol/karma.conf.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fprotocol%2Fkarma.conf.js",
            "raw_url": "https://github.com/angular/angular/raw/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fprotocol%2Fkarma.conf.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fprotocol%2Fkarma.conf.js?ref=5b0d3356a64c35f6308b95501ad81e89fe3ad7a7",
            "patch": "@@ -25,7 +25,13 @@ module.exports = function (config) {\n     colors: true,\n     logLevel: config.LOG_INFO,\n     autoWatch: true,\n-    browsers: ['Chrome'],\n+    browsers: ['ChromeHeadlessNoSandbox'],\n+    customLaunchers: {\n+      ChromeHeadlessNoSandbox: {\n+        base: 'ChromeHeadless',\n+        flags: ['--no-sandbox'],\n+      },\n+    },\n     singleRun: false,\n     restartOnFileChange: true,\n   });"
        },
        {
            "sha": "6e4f45fb75297d511222ee6efd09ebc79f4640a6",
            "filename": "projects/shared-utils/karma.conf.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fshared-utils%2Fkarma.conf.js",
            "raw_url": "https://github.com/angular/angular/raw/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fshared-utils%2Fkarma.conf.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fshared-utils%2Fkarma.conf.js?ref=5b0d3356a64c35f6308b95501ad81e89fe3ad7a7",
            "patch": "@@ -25,7 +25,13 @@ module.exports = function (config) {\n     colors: true,\n     logLevel: config.LOG_INFO,\n     autoWatch: true,\n-    browsers: ['Chrome'],\n+    browsers: ['ChromeHeadlessNoSandbox'],\n+    customLaunchers: {\n+      ChromeHeadlessNoSandbox: {\n+        base: 'ChromeHeadless',\n+        flags: ['--no-sandbox'],\n+      },\n+    },\n     singleRun: false,\n     restartOnFileChange: true,\n   });"
        },
        {
            "sha": "0bb918336da129f2cb618a3d631aea3a6dab8411",
            "filename": "projects/shell-chrome/karma.conf.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fshell-chrome%2Fkarma.conf.js",
            "raw_url": "https://github.com/angular/angular/raw/5b0d3356a64c35f6308b95501ad81e89fe3ad7a7/projects%2Fshell-chrome%2Fkarma.conf.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fshell-chrome%2Fkarma.conf.js?ref=5b0d3356a64c35f6308b95501ad81e89fe3ad7a7",
            "patch": "@@ -25,7 +25,13 @@ module.exports = function (config) {\n     colors: true,\n     logLevel: config.LOG_INFO,\n     autoWatch: true,\n-    browsers: ['Chrome'],\n+    browsers: ['ChromeHeadlessNoSandbox'],\n+    customLaunchers: {\n+      ChromeHeadlessNoSandbox: {\n+        base: 'ChromeHeadless',\n+        flags: ['--no-sandbox'],\n+      },\n+    },\n     singleRun: false,\n     restartOnFileChange: true,\n   });"
        }
    ],
    "stats": {
        "total": 200,
        "additions": 137,
        "deletions": 63
    }
}