{
    "author": "josephperrott",
    "message": "feat(dev-infra): support --mode flag for building environment stamp (#40095)\n\nWhen building the environment stamp, support two modes: release and snapshot\n\nThe release mode will always stamp using the current version of in the root package.json\nand in snapshot mode will use a version stamp expressing a version based on the tag and\nthe number of commits from the tag.\n\nPR Close #40095",
    "sha": "c44baa4c5ce319da73f448b99778aeb736d30b26",
    "files": [
        {
            "sha": "3c464e170a92bd74b2a2bc54eb43893ecef0a4d8",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 47,
            "deletions": 7,
            "changes": 54,
            "blob_url": "https://github.com/angular/angular/blob/c44baa4c5ce319da73f448b99778aeb736d30b26/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/c44baa4c5ce319da73f448b99778aeb736d30b26/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=c44baa4c5ce319da73f448b99778aeb736d30b26",
            "patch": "@@ -6540,13 +6540,13 @@ const ReleaseSetDistTagCommand = {\n  * Note: git operations, especially git status, take a long time inside mounted docker volumes\n  * in Windows or OSX hosts (https://github.com/docker/for-win/issues/188).\n  */\n-function buildEnvStamp() {\n+function buildEnvStamp(mode) {\n     console.info(`BUILD_SCM_BRANCH ${getCurrentBranch()}`);\n     console.info(`BUILD_SCM_COMMIT_SHA ${getCurrentSha()}`);\n     console.info(`BUILD_SCM_HASH ${getCurrentSha()}`);\n     console.info(`BUILD_SCM_LOCAL_CHANGES ${hasLocalChanges()}`);\n     console.info(`BUILD_SCM_USER ${getCurrentGitUser()}`);\n-    console.info(`BUILD_SCM_VERSION ${getSCMVersion()}`);\n+    console.info(`BUILD_SCM_VERSION ${getSCMVersion(mode)}`);\n     process.exit(0);\n }\n /** Run the exec command and return the stdout as a trimmed string. */\n@@ -6557,10 +6557,23 @@ function exec$1(cmd) {\n function hasLocalChanges() {\n     return !!exec$1(`git status --untracked-files=no --porcelain`);\n }\n-/** Get the version based on the most recent semver tag. */\n-function getSCMVersion() {\n-    const version = exec$1(`git describe --match [0-9]*.[0-9]*.[0-9]* --abbrev=7 --tags HEAD`);\n-    return `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${(hasLocalChanges() ? '.with-local-changes' : '')}`;\n+/**\n+ * Get the version for generated packages.\n+ *\n+ * In snapshot mode, the version is based on the most recent semver tag.\n+ * In release mode, the version is based on the base package.json version.\n+ */\n+function getSCMVersion(mode) {\n+    if (mode === 'release') {\n+        const packageJsonPath = path.join(getRepoBaseDir(), 'package.json');\n+        const { version } = require(packageJsonPath);\n+        return version;\n+    }\n+    if (mode === 'snapshot') {\n+        const version = exec$1(`git describe --match [0-9]*.[0-9]*.[0-9]* --abbrev=7 --tags HEAD`);\n+        return `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${(hasLocalChanges() ? '.with-local-changes' : '')}`;\n+    }\n+    return '0.0.0';\n }\n /** Get the current SHA of HEAD. */\n function getCurrentSha() {\n@@ -6577,6 +6590,33 @@ function getCurrentGitUser() {\n     return `${userName} <${userEmail}>`;\n }\n \n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+function builder$a(args) {\n+    return args.option('mode', {\n+        demandOption: true,\n+        description: 'Whether the env-stamp should be built for a snapshot or release',\n+        choices: ['snapshot', 'release']\n+    });\n+}\n+function handler$a({ mode }) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        buildEnvStamp(mode);\n+    });\n+}\n+/** CLI command module for building the environment stamp. */\n+const BuildEnvStampCommand = {\n+    builder: builder$a,\n+    handler: handler$a,\n+    command: 'build-env-stamp',\n+    describe: 'Build the environment stamping information',\n+};\n+\n /** Build the parser for the release commands. */\n function buildReleaseParser(localYargs) {\n     return localYargs.help()\n@@ -6585,7 +6625,7 @@ function buildReleaseParser(localYargs) {\n         .command(ReleasePublishCommandModule)\n         .command(ReleaseBuildCommandModule)\n         .command(ReleaseSetDistTagCommand)\n-        .command('build-env-stamp', 'Build the environment stamping information', {}, () => buildEnvStamp());\n+        .command(BuildEnvStampCommand);\n }\n \n /**"
        },
        {
            "sha": "316d39a62717db0cd81e329edc62f79976946c4c",
            "filename": "dev-infra/release/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c44baa4c5ce319da73f448b99778aeb736d30b26/dev-infra%2Frelease%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/c44baa4c5ce319da73f448b99778aeb736d30b26/dev-infra%2Frelease%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2FBUILD.bazel?ref=c44baa4c5ce319da73f448b99778aeb736d30b26",
            "patch": "@@ -12,6 +12,7 @@ ts_library(\n         \"//dev-infra/release/publish\",\n         \"//dev-infra/release/set-dist-tag\",\n         \"//dev-infra/utils\",\n+        \"@npm//@types/node\",\n         \"@npm//@types/yargs\",\n         \"@npm//yargs\",\n     ],"
        },
        {
            "sha": "4e8531cf3bb66b62f59edc678897a2dbf41865f5",
            "filename": "dev-infra/release/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/c44baa4c5ce319da73f448b99778aeb736d30b26/dev-infra%2Frelease%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/c44baa4c5ce319da73f448b99778aeb736d30b26/dev-infra%2Frelease%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fcli.ts?ref=c44baa4c5ce319da73f448b99778aeb736d30b26",
            "patch": "@@ -10,7 +10,7 @@ import * as yargs from 'yargs';\n import {ReleaseBuildCommandModule} from './build/cli';\n import {ReleasePublishCommandModule} from './publish/cli';\n import {ReleaseSetDistTagCommand} from './set-dist-tag/cli';\n-import {buildEnvStamp} from './stamping/env-stamp';\n+import {BuildEnvStampCommand} from './stamping/cli';\n \n /** Build the parser for the release commands. */\n export function buildReleaseParser(localYargs: yargs.Argv) {\n@@ -20,7 +20,5 @@ export function buildReleaseParser(localYargs: yargs.Argv) {\n       .command(ReleasePublishCommandModule)\n       .command(ReleaseBuildCommandModule)\n       .command(ReleaseSetDistTagCommand)\n-      .command(\n-          'build-env-stamp', 'Build the environment stamping information', {},\n-          () => buildEnvStamp());\n+      .command(BuildEnvStampCommand);\n }"
        },
        {
            "sha": "f6343df956003bfbd7027530ed9652fa9248681f",
            "filename": "dev-infra/release/stamping/cli.ts",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/c44baa4c5ce319da73f448b99778aeb736d30b26/dev-infra%2Frelease%2Fstamping%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/c44baa4c5ce319da73f448b99778aeb736d30b26/dev-infra%2Frelease%2Fstamping%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fstamping%2Fcli.ts?ref=c44baa4c5ce319da73f448b99778aeb736d30b26",
            "patch": "@@ -0,0 +1,36 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Arguments, Argv, CommandModule} from 'yargs';\n+\n+import {buildEnvStamp, EnvStampMode} from './env-stamp';\n+\n+\n+export interface Options {\n+  mode: EnvStampMode;\n+}\n+\n+function builder(args: Argv): Argv<Options> {\n+  return args.option('mode', {\n+    demandOption: true,\n+    description: 'Whether the env-stamp should be built for a snapshot or release',\n+    choices: ['snapshot' as const, 'release' as const]\n+  });\n+}\n+\n+async function handler({mode}: Arguments<Options>) {\n+  buildEnvStamp(mode);\n+}\n+\n+/** CLI command module for building the environment stamp. */\n+export const BuildEnvStampCommand: CommandModule<{}, Options> = {\n+  builder,\n+  handler,\n+  command: 'build-env-stamp',\n+  describe: 'Build the environment stamping information',\n+};"
        },
        {
            "sha": "5e6e993be02600b47b1adb0c45ca96e605a15b65",
            "filename": "dev-infra/release/stamping/env-stamp.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 7,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/c44baa4c5ce319da73f448b99778aeb736d30b26/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts",
            "raw_url": "https://github.com/angular/angular/raw/c44baa4c5ce319da73f448b99778aeb736d30b26/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts?ref=c44baa4c5ce319da73f448b99778aeb736d30b26",
            "patch": "@@ -6,8 +6,13 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {join} from 'path';\n+\n+import {getRepoBaseDir} from '../../utils/config';\n import {exec as _exec} from '../../utils/shelljs';\n \n+export type EnvStampMode = 'snapshot'|'release';\n+\n /**\n  * Log the environment variables expected by bazel for stamping.\n  *\n@@ -18,13 +23,13 @@ import {exec as _exec} from '../../utils/shelljs';\n  * Note: git operations, especially git status, take a long time inside mounted docker volumes\n  * in Windows or OSX hosts (https://github.com/docker/for-win/issues/188).\n  */\n-export function buildEnvStamp() {\n+export function buildEnvStamp(mode: EnvStampMode) {\n   console.info(`BUILD_SCM_BRANCH ${getCurrentBranch()}`);\n   console.info(`BUILD_SCM_COMMIT_SHA ${getCurrentSha()}`);\n   console.info(`BUILD_SCM_HASH ${getCurrentSha()}`);\n   console.info(`BUILD_SCM_LOCAL_CHANGES ${hasLocalChanges()}`);\n   console.info(`BUILD_SCM_USER ${getCurrentGitUser()}`);\n-  console.info(`BUILD_SCM_VERSION ${getSCMVersion()}`);\n+  console.info(`BUILD_SCM_VERSION ${getSCMVersion(mode)}`);\n   process.exit(0);\n }\n \n@@ -38,11 +43,24 @@ function hasLocalChanges() {\n   return !!exec(`git status --untracked-files=no --porcelain`);\n }\n \n-/** Get the version based on the most recent semver tag. */\n-function getSCMVersion() {\n-  const version = exec(`git describe --match [0-9]*.[0-9]*.[0-9]* --abbrev=7 --tags HEAD`);\n-  return `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${\n-      (hasLocalChanges() ? '.with-local-changes' : '')}`;\n+/**\n+ * Get the version for generated packages.\n+ *\n+ * In snapshot mode, the version is based on the most recent semver tag.\n+ * In release mode, the version is based on the base package.json version.\n+ */\n+function getSCMVersion(mode: EnvStampMode) {\n+  if (mode === 'release') {\n+    const packageJsonPath = join(getRepoBaseDir(), 'package.json');\n+    const {version} = require(packageJsonPath);\n+    return version;\n+  }\n+  if (mode === 'snapshot') {\n+    const version = exec(`git describe --match [0-9]*.[0-9]*.[0-9]* --abbrev=7 --tags HEAD`);\n+    return `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${\n+        (hasLocalChanges() ? '.with-local-changes' : '')}`;\n+  }\n+  return '0.0.0';\n }\n \n /** Get the current SHA of HEAD. */"
        }
    ],
    "stats": {
        "total": 129,
        "additions": 111,
        "deletions": 18
    }
}