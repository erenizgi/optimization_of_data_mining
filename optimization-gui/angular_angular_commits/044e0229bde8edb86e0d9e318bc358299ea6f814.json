{
    "author": "devversion",
    "message": "build: generate alias locale data for closure locale (#42230)\n\nWithin Google, closure compiler is used for dealing with translations.\nWe generate a closure-compatible locale file that allows for\nregistration within Angular, so that Closure i18n works well together\nwith Angular applications. Closure compiler does not limit its\nlocales to BCP47-canonical locale identifiers. This commit updates\nthe generation logic so that we also support deprecated (but aliased)\nlocale identifiers, or other aliases which are likely used within\nClosure. We use CLDR's alias supplemental data for this. It instructs\nus to alias `iw` to `he` for example. `iw` is still supported in Closure.\n\nNote that we do not manually extract all locales supported in Closure;\ninstead we only support the CLDR canonical locales (as done before) +\ncommon aliases that CLDR provides data for. We are not aware of other\nlocale aliases within Closure that wouldn't be part of the CLDR aliases.\nIf there would be, then Angular/Closure would fail accordingly.\n\nPR Close #42230",
    "sha": "044e0229bde8edb86e0d9e318bc358299ea6f814",
    "files": [
        {
            "sha": "65782d4f72653f21a85084cbf1fade8c188a68f7",
            "filename": "packages/common/locales/closure-locale.ts",
            "status": "modified",
            "additions": 4967,
            "deletions": 1171,
            "changes": 6138,
            "blob_url": "https://github.com/angular/angular/blob/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fclosure-locale.ts",
            "raw_url": "https://github.com/angular/angular/raw/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fclosure-locale.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fclosure-locale.ts?ref=044e0229bde8edb86e0d9e318bc358299ea6f814"
        },
        {
            "sha": "d865ceb6528a7bfb780e7a7983ef1bdb65bb3543",
            "filename": "packages/common/locales/generate-locales-tool/cldr-data.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fcldr-data.ts",
            "raw_url": "https://github.com/angular/angular/raw/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fcldr-data.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fcldr-data.ts?ref=044e0229bde8edb86e0d9e318bc358299ea6f814",
            "patch": "@@ -31,6 +31,9 @@ const CLDR_DATA_GLOBS = [\n /** Path to the CLDR available locales file. */\n const CLDR_AVAILABLE_LOCALES_PATH = 'cldr-core-37.0.0/availableLocales.json';\n \n+/** Path to the CLDR locale aliases file. */\n+const CLDR_LOCALE_ALIASES_PATH = 'cldr-core-37.0.0/supplemental/aliases.json';\n+\n /**\n  * Instance providing access to a locale's CLDR data. This type extends the `cldrjs`\n  * instance type with the missing `bundle` attribute property.\n@@ -45,6 +48,13 @@ export type CldrLocaleData = CldrStatic&{\n   }\n };\n \n+/**\n+ * Possible reasons for an alias in the CLDR supplemental data. See:\n+ * https://unicode.org/reports/tr35/tr35-info.html#Appendix_Supplemental_Metadata.\n+ */\n+export type CldrLocaleAliasReason =\n+    'deprecated'|'overlong'|'macrolanguage'|'legacy'|'bibliographic';\n+\n /**\n  * Class that provides access to the CLDR data downloaded as part of\n  * the `@cldr_data` Bazel repository.\n@@ -77,6 +87,16 @@ export class CldrData {\n     return localeData;\n   }\n \n+  /**\n+   * Gets the CLDR language aliases.\n+   * http://cldr.unicode.org/index/cldr-spec/language-tag-equivalences.\n+   */\n+  getLanguageAliases():\n+      {[localeName: string]: {_reason: CldrLocaleAliasReason, _replacement: string}} {\n+    return require(`${this.cldrDataDir}/${CLDR_LOCALE_ALIASES_PATH}`)\n+        .supplemental.metadata.alias.languageAlias;\n+  }\n+\n   /** Gets a list of all locales CLDR provides data for. */\n   private _getAvailableLocales(): CldrLocaleData[] {\n     const allLocales ="
        },
        {
            "sha": "40d687991d60abc136358784f2dc6ba03073443c",
            "filename": "packages/common/locales/generate-locales-tool/closure-locale-file.ts",
            "status": "modified",
            "additions": 45,
            "deletions": 19,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fclosure-locale-file.ts",
            "raw_url": "https://github.com/angular/angular/raw/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fclosure-locale-file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fclosure-locale-file.ts?ref=044e0229bde8edb86e0d9e318bc358299ea6f814",
            "patch": "@@ -6,35 +6,45 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {CldrStatic} from 'cldrjs';\n-\n-import {CldrData} from './cldr-data';\n+import {CldrData, CldrLocaleData} from './cldr-data';\n import {fileHeader} from './file-header';\n import {BaseCurrencies} from './locale-base-currencies';\n import {generateLocale} from './locale-file';\n \n+interface ClosureLocale {\n+  /** Locale name to match with a Closure-supported locale. */\n+  closureLocaleName: string;\n+  /** Locale data. Can have a different locale name if this captures an aliased locale. */\n+  data: CldrLocaleData;\n+}\n+\n /**\n  * Generate a file that contains all locale to import for closure.\n  * Tree shaking will only keep the data for the `goog.LOCALE` locale.\n  */\n export function generateClosureLocaleFile(cldrData: CldrData, baseCurrencies: BaseCurrencies) {\n-  const locales = cldrData.availableLocales;\n+  const locales: ClosureLocale[] =\n+      [...cldrData.availableLocales.map(data => ({closureLocaleName: data.locale, data}))];\n+  const aliases = cldrData.getLanguageAliases();\n \n-  function generateLocaleConstant(localeData: CldrStatic): string {\n-    const locale = localeData.locale;\n-    const localeNameFormattedForJs = formatLocale(locale);\n-    return generateLocale(locale, localeData, baseCurrencies)\n-        .replace(`${fileHeader}\\n`, '')\n-        .replace('export default ', `export const locale_${localeNameFormattedForJs} = `)\n-        .replace('function plural', `function plural_${localeNameFormattedForJs}`)\n-        .replace(/,\\s+plural/, `, plural_${localeNameFormattedForJs}`)\n-        .replace(/\\s*const u = undefined;\\s*/, '');\n-  }\n+  // We also generate locale data for aliases known within CLDR. Closure compiler does not\n+  // limit its locale identifiers to CLDR-canonical identifiers/or BCP47 identifiers.\n+  // To ensure deprecated/historical locale identifiers which are supported by Closure\n+  // can work with closure-compiled Angular applications, we respect CLDR locale aliases.\n+  for (const [aliasName, data] of Object.entries(aliases)) {\n+    // We skip bibliographic aliases as those have never been supported by Closure compiler.\n+    if (data._reason === 'bibliographic') {\n+      continue;\n+    }\n \n-  function generateCase(localeName: string) {\n-    return `case '${localeName}':\\n` +\n-        `l = locale_${formatLocale(localeName)};\\n` +\n-        `break;\\n`;\n+    const localeData = cldrData.getLocaleData(data._replacement);\n+\n+    // If CLDR does not provide data for the replacement locale, we skip this alias.\n+    if (localeData === null) {\n+      continue;\n+    }\n+\n+    locales.push({closureLocaleName: aliasName, data: localeData});\n   }\n \n   return `${fileHeader}\n@@ -48,12 +58,28 @@ ${locales.map(locale => `${generateLocaleConstant(locale)}`).join('\\n')}\n let l: any;\n \n switch (goog.LOCALE) {\n-${locales.map(localeData => generateCase(localeData.locale)).join('')}}\n+${locales.map(locale => generateCase(locale)).join('')}}\n \n if (l) {\n   registerLocaleData(l);\n }\n `;\n+\n+  function generateLocaleConstant(locale: ClosureLocale): string {\n+    const localeNameFormattedForJs = formatLocale(locale.closureLocaleName);\n+    return generateLocale(locale.closureLocaleName, locale.data, baseCurrencies)\n+        .replace(`${fileHeader}\\n`, '')\n+        .replace('export default ', `export const locale_${localeNameFormattedForJs} = `)\n+        .replace('function plural', `function plural_${localeNameFormattedForJs}`)\n+        .replace(/,\\s+plural/, `, plural_${localeNameFormattedForJs}`)\n+        .replace(/\\s*const u = undefined;\\s*/, '');\n+  }\n+\n+  function generateCase(locale: ClosureLocale) {\n+    return `case '${locale.closureLocaleName}':\\n` +\n+        `l = locale_${formatLocale(locale.closureLocaleName)};\\n` +\n+        `break;\\n`;\n+  }\n }\n \n function formatLocale(locale: string): string {"
        },
        {
            "sha": "459f37660d65194c6cce236cc7ea6ffdaa9a67b2",
            "filename": "packages/common/locales/generate-locales-tool/locale-file.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Flocale-file.ts",
            "raw_url": "https://github.com/angular/angular/raw/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Flocale-file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Flocale-file.ts?ref=044e0229bde8edb86e0d9e318bc358299ea6f814",
            "patch": "@@ -23,7 +23,7 @@ export function generateLocale(\n   return `${fileHeader}\n const u = undefined;\n \n-${getPluralFunction(locale)}\n+${getPluralFunction(localeData)}\n \n export default ${generateBasicLocaleString(locale, localeData, baseCurrencies)};\n `;"
        },
        {
            "sha": "03bf212586e899df1e81ffed9155dedc30c6fb16",
            "filename": "packages/common/locales/generate-locales-tool/locale-global-file.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Flocale-global-file.ts",
            "raw_url": "https://github.com/angular/angular/raw/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Flocale-global-file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Flocale-global-file.ts?ref=044e0229bde8edb86e0d9e318bc358299ea6f814",
            "patch": "@@ -27,7 +27,7 @@ export function generateLocaleGlobalFile(\n     global.ng.common = global.ng.common || {};\n     global.ng.common.locales = global.ng.common.locales || {};\n     const u = undefined;\n-    ${getPluralFunction(locale, false)}\n+    ${getPluralFunction(localeData, false)}\n     global.ng.common.locales['${normalizeLocale(locale)}'] = ${data};\n   })(typeof globalThis !== 'undefined' && globalThis || typeof global !== 'undefined' && global || typeof window !== 'undefined' && window);\n     `;"
        },
        {
            "sha": "07c61895741a80c70d016d9788d7f92a2b84437b",
            "filename": "packages/common/locales/generate-locales-tool/plural-function.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fplural-function.ts",
            "raw_url": "https://github.com/angular/angular/raw/044e0229bde8edb86e0d9e318bc358299ea6f814/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fplural-function.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fplural-function.ts?ref=044e0229bde8edb86e0d9e318bc358299ea6f814",
            "patch": "@@ -5,6 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {CldrLocaleData} from './cldr-data';\n \n // There are no types available for `cldr`.\n const cldr = require('cldr');\n@@ -14,8 +15,13 @@ const cldr = require('cldr');\n  * TODO(ocombe): replace \"cldr\" extractPluralRuleFunction with our own extraction using \"CldrJS\"\n  * because the 2 libs can become out of sync if they use different versions of the cldr database\n  */\n-export function getPluralFunction(locale: string, withTypes = true) {\n-  let fn = cldr.extractPluralRuleFunction(locale).toString();\n+export function getPluralFunction(localeData: CldrLocaleData, withTypes = true) {\n+  // We use the resolved bundle for extracting the plural function. This matches with the\n+  // lookup logic used by other extractions in the tool (using `cldrjs`), and also ensures\n+  // we follow the CLDR-specified bundle lookup algorithm. A language does not necessarily\n+  // resolve directly to a bundle CLDR provides data for.\n+  const bundleName = localeData.attributes.bundle;\n+  let fn = cldr.extractPluralRuleFunction(bundleName).toString();\n \n   const numberType = withTypes ? ': number' : '';\n   fn ="
        }
    ],
    "stats": {
        "total": 6236,
        "additions": 5042,
        "deletions": 1194
    }
}