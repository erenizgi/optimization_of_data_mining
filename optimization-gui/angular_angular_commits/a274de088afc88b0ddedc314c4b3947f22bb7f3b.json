{
    "author": "devversion",
    "message": "build: make bazel integrations compatible with windows (#43431)\n\nThe bazel integration tests are currently not compatible with Windows.\nTests never get to run because the created tar packages for NPM packages\nare built using an outdated `pkg_tar` rule that creates invalid\ntarballs. We fix this by using the non-deprecated windows-compatible\n`rules_pkg` implementation.\n\nAdditionally, we copy all `package.json` files of integration tests to\nthe bazel bin directory as otherwise the file would be accidentally\nmodified as a source on Windows.\n\nPR Close #43431",
    "sha": "a274de088afc88b0ddedc314c4b3947f22bb7f3b",
    "files": [
        {
            "sha": "a0c1701565a23ff91ef70965a47a86218e34a2df",
            "filename": "WORKSPACE",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/a274de088afc88b0ddedc314c4b3947f22bb7f3b/WORKSPACE",
            "raw_url": "https://github.com/angular/angular/raw/a274de088afc88b0ddedc314c4b3947f22bb7f3b/WORKSPACE",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/WORKSPACE?ref=a274de088afc88b0ddedc314c4b3947f22bb7f3b",
            "patch": "@@ -12,6 +12,17 @@ http_archive(\n     urls = [\"https://github.com/bazelbuild/rules_nodejs/releases/download/4.3.0/rules_nodejs-4.3.0.tar.gz\"],\n )\n \n+# The PKG rules are needed to build tar packages for integration tests. The builtin\n+# rule in `@bazel_tools` is not Windows compatible and outdated.\n+http_archive(\n+    name = \"rules_pkg\",\n+    sha256 = \"a89e203d3cf264e564fcb96b6e06dd70bc0557356eb48400ce4b5d97c2c3720d\",\n+    urls = [\n+        \"https://mirror.bazel.build/github.com/bazelbuild/rules_pkg/releases/download/0.5.1/rules_pkg-0.5.1.tar.gz\",\n+        \"https://github.com/bazelbuild/rules_pkg/releases/download/0.5.1/rules_pkg-0.5.1.tar.gz\",\n+    ],\n+)\n+\n # Check the rules_nodejs version and download npm dependencies\n # Note: bazel (version 2 and after) will check the .bazelversion file so we don't need to\n # assert on that.\n@@ -52,6 +63,10 @@ load(\"@build_bazel_rules_nodejs//toolchains/esbuild:esbuild_repositories.bzl\", \"\n \n esbuild_repositories()\n \n+load(\"@rules_pkg//:deps.bzl\", \"rules_pkg_dependencies\")\n+\n+rules_pkg_dependencies()\n+\n load(\"//packages/common/locales/generate-locales-tool:cldr-data.bzl\", \"cldr_data_repository\")\n \n cldr_data_repository("
        },
        {
            "sha": "938cb64402c1df3363a8ba40e72e0f6763763239",
            "filename": "integration/angular_integration_test.bzl",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/a274de088afc88b0ddedc314c4b3947f22bb7f3b/integration%2Fangular_integration_test.bzl",
            "raw_url": "https://github.com/angular/angular/raw/a274de088afc88b0ddedc314c4b3947f22bb7f3b/integration%2Fangular_integration_test.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fangular_integration_test.bzl?ref=a274de088afc88b0ddedc314c4b3947f22bb7f3b",
            "patch": "@@ -6,6 +6,7 @@\n \"\"\"\n \n load(\"//tools/npm_integration_test:npm_integration_test.bzl\", \"npm_integration_test\")\n+load(\"@build_bazel_rules_nodejs//:index.bzl\", \"copy_to_bin\")\n \n # The @npm packages at the root node_modules are used by integration tests\n # with `file:../../node_modules/foobar` references\n@@ -68,7 +69,7 @@ FRAMEWORK_PACKAGES = [\n def npm_package_archives():\n     \"\"\"Function to generate pkg_tar definitions for WORKSPACE yarn_install manual_build_file_contents\"\"\"\n     npm_packages_to_archive = NPM_PACKAGE_ARCHIVES\n-    result = \"\"\"load(\"@bazel_tools//tools/build_defs/pkg:pkg.bzl\", \"pkg_tar\")\n+    result = \"\"\"load(\"@rules_pkg//:pkg.bzl\", \"pkg_tar\")\n \"\"\"\n     for name in npm_packages_to_archive:\n         label_name = _npm_package_archive_label(name)\n@@ -77,7 +78,7 @@ def npm_package_archives():\n     name = \"{label_name}\",\n     srcs = [\"//{name}:{last_segment_name}__all_files\"],\n     extension = \"tar.gz\",\n-    strip_prefix = \"./node_modules/{name}\",\n+    strip_prefix = \"/external/npm/node_modules/{name}\",\n     # should not be built unless it is a dependency of another rule\n     tags = [\"manual\"],\n )\n@@ -168,11 +169,20 @@ def _angular_integration_test(name, **kwargs):\n \n def angular_integration_test(name, **kwargs):\n     \"Sets up the integration test target based on the test folder name\"\n+\n+    # Note: We copy the `package.json` file to the `bazel-bin` as otherwise\n+    # the actual source file `package.json` file would be modified on Windows.\n+    copy_to_bin(\n+        name = \"%s_package_json\" % name,\n+        srcs = [\"%s/package.json\" % name],\n+    )\n+\n     native.filegroup(\n         name = \"_%s_sources\" % name,\n-        srcs = native.glob(\n+        srcs = [\"%s_package_json\" % name] + native.glob(\n             include = [\"%s/**\" % name],\n             exclude = [\n+                \"%s/package.json\",\n                 \"%s/node_modules/**\" % name,\n                 \"%s/.yarn_local_cache/**\" % name,\n             ],"
        },
        {
            "sha": "ca3b20bd46ac04f5eda44ff43b80d6c6084f1644",
            "filename": "tools/defaults.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a274de088afc88b0ddedc314c4b3947f22bb7f3b/tools%2Fdefaults.bzl",
            "raw_url": "https://github.com/angular/angular/raw/a274de088afc88b0ddedc314c4b3947f22bb7f3b/tools%2Fdefaults.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fdefaults.bzl?ref=a274de088afc88b0ddedc314c4b3947f22bb7f3b",
            "patch": "@@ -1,6 +1,6 @@\n \"\"\"Re-export of some bazel rules with repository-wide defaults.\"\"\"\n \n-load(\"@bazel_tools//tools/build_defs/pkg:pkg.bzl\", \"pkg_tar\")\n+load(\"@rules_pkg//:pkg.bzl\", \"pkg_tar\")\n load(\"@build_bazel_rules_nodejs//:index.bzl\", _nodejs_binary = \"nodejs_binary\", _pkg_npm = \"pkg_npm\")\n load(\"@npm//@bazel/jasmine:index.bzl\", _jasmine_node_test = \"jasmine_node_test\")\n load(\"@npm//@bazel/concatjs:index.bzl\", _concatjs_devserver = \"concatjs_devserver\", _karma_web_test = \"karma_web_test\", _karma_web_test_suite = \"karma_web_test_suite\")"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 29,
        "deletions": 4
    }
}