{
    "author": "gkalpak",
    "message": "fix(docs-infra): fix redirecting `rc.angular.io` to `angular.io` when no active RC (#39853)\n\nCurrently there is an issue with redirecting `rc.angular.io` to\n`angular.io` when there is no active RC. If a user has visited\n`rc.angular.io` before and has a ServiceWorker registered for that\nsubdomain, they will never \"see\" the redirect to `angular.io`.\n\nThis commit fixes the problem by doing an additional deployment from the\nstable branch to the `rc-angular-io-site` Firebase site when there is no\nactive RC. This additional deployment will ensure that:\n1. Users will be temporarily redirected from `rc.angular.io` to\n   `angular.io`.\n2. Users with a registered ServiceWorker (who don't see the redirect)\n   will have their ServiceWorker unregistered on the next visit.\n3. The content on both sites is identical.\n\nSee #39760 for more details on the problem and the solution.\n\nNOTE:\nAs mentioned in #39760, for this fix to take affect, we need to remove\nthe redirect from `rc.angular.io` to `angular.io` in the Firebase\nconsole for site `rc-angular-io-site`.\n\nFixes #39760\n\nPR Close #39853",
    "sha": "cf1f5a1e37e053cdea44483336d2a976f45968cd",
    "files": [
        {
            "sha": "a0fd9f4dc9fe173ede605a2850ac7484feacce97",
            "filename": "aio/scripts/deploy-to-firebase.js",
            "status": "modified",
            "additions": 74,
            "deletions": 2,
            "changes": 76,
            "blob_url": "https://github.com/angular/angular/blob/cf1f5a1e37e053cdea44483336d2a976f45968cd/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "raw_url": "https://github.com/angular/angular/raw/cf1f5a1e37e053cdea44483336d2a976f45968cd/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.js?ref=cf1f5a1e37e053cdea44483336d2a976f45968cd",
            "patch": "@@ -4,7 +4,7 @@\n //\n 'use strict';\n \n-const {cd, cp, exec, set} = require('shelljs');\n+const {cd, cp, exec, mv, sed, set} = require('shelljs');\n \n set('-e');\n \n@@ -17,6 +17,7 @@ const NG_REMOTE_URL = `https://github.com/${REPO_SLUG}.git`;\n module.exports = {\n   computeDeploymentsInfo,\n   computeInputVars,\n+  computeMajorVersion,\n   getLatestCommit,\n   getMostRecentMinorBranch,\n };\n@@ -122,6 +123,17 @@ function computeDeploymentsInfo(\n       preDeployActions: [build, checkPayloadSize],\n       postDeployActions: [testPwaScore],\n     },\n+    // Config for deploying the stable build to the RC Firebase site when there is no active RC.\n+    // See https://github.com/angular/angular/issues/39760 for more info on the purpose of this\n+    // special deployment.\n+    noActiveRc: {\n+      deployEnv: 'stable',\n+      projectId: 'angular-io',\n+      siteId: 'rc-angular-io-site',\n+      deployedUrl: 'https://rc.angular.io/',\n+      preDeployActions: [removeServiceWorker, redirectToAngularIo],\n+      postDeployActions: [testNoActiveRcDeployment],\n+    },\n     archive: {\n       deployEnv: 'archive',\n       projectId: 'angular-io',\n@@ -149,7 +161,17 @@ function computeDeploymentsInfo(\n \n   // If the current branch is the stable branch, deploy as `stable`.\n   if (currentBranch === stableBranch) {\n-    return [deploymentInfoPerTarget.stable];\n+    return (rcBranch !== null) ?\n+      // There is an active RC version. Only deploy to the `stable` project/site.\n+      [deploymentInfoPerTarget.stable] :\n+      // There is no active RC version. In addition to deploying to the `stable` project/site,\n+      // deploy to `rc` to ensure it redirects to `stable`.\n+      // See https://github.com/angular/angular/issues/39760 for more info on the purpose of this\n+      // special deployment.\n+      [\n+        deploymentInfoPerTarget.stable,\n+        deploymentInfoPerTarget.noActiveRc,\n+      ];\n   }\n \n   // If we get here, it means that the current branch is neither `master`, nor the RC or stable\n@@ -263,6 +285,21 @@ function getLatestCommit(branchName, remote = undefined) {\n   return getRemoteRefs(branchName, remote)[0].slice(0, 40);\n }\n \n+function redirectToAngularIo() {\n+  // Update the Firebase hosting configuration redirect all non-file requests (i.e. requests that do\n+  // not contain a dot in their last path segment) to `angular.io`.\n+  // See https://firebase.google.com/docs/hosting/full-config#redirects.\n+  const redirectRule =\n+      '{\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"https://angular.io:1\"}';\n+  sed('-i', /(\\s*)\"redirects\": \\[/, `$&\\n$1  ${redirectRule},\\n`, 'firebase.json');\n+}\n+\n+function removeServiceWorker() {\n+  // Rename the SW manifest (`ngsw.json`). This will cause the ServiceWorker to unregister itself.\n+  // See https://angular.io/guide/service-worker-devops#fail-safe.\n+  mv('dist/ngsw.json', 'dist/ngsw.json.bak');\n+}\n+\n function serializeActions(actions) {\n   return actions.map(fn => fn.name).join(', ');\n }\n@@ -271,6 +308,41 @@ function skipDeployment(reason) {\n   return {reason, skipped: true};\n }\n \n+function testNoActiveRcDeployment({deployedUrl}) {\n+  const deployedOrigin = deployedUrl.replace(/\\/$/, '');\n+\n+  // Ensure a request for `ngsw.json` returns 404.\n+  const ngswJsonUrl = `${deployedOrigin}/ngsw.json`;\n+  const ngswJsonScript = `https.get('${ngswJsonUrl}', res => console.log(res.statusCode))`;\n+  const ngswJsonActualStatusCode = exec(`node --eval \"${ngswJsonScript}\"`, {silent: true}).trim();\n+  const ngswJsonExpectedStatusCode = '404';\n+\n+  if (ngswJsonActualStatusCode !== ngswJsonExpectedStatusCode) {\n+    throw new Error(\n+        `Expected '${ngswJsonUrl}' to return a status code of '${ngswJsonExpectedStatusCode}', ` +\n+        `but it returned '${ngswJsonActualStatusCode}'.`);\n+  }\n+\n+  // Ensure a request for `foo/bar` is redirected to `https://angular.io/foo/bar`.\n+  const fooBarUrl = `${deployedOrigin}/foo/bar?baz=qux`;\n+  const fooBarScript =\n+      `https.get('${fooBarUrl}', res => console.log(res.statusCode, res.headers.location))`;\n+  const [fooBarActualStatusCode, fooBarActualRedirectUrl] =\n+      exec(`node --eval \"${fooBarScript}\"`, {silent: true}).trim().split(' ');\n+  const fooBarExpectedStatusCode = '302';\n+  const fooBarExpectedRedirectUrl = 'https://angular.io/foo/bar?baz=qux';\n+\n+  if (fooBarActualStatusCode !== fooBarExpectedStatusCode) {\n+    throw new Error(\n+        `Expected '${fooBarUrl}' to return a status code of '${fooBarExpectedStatusCode}', but ` +\n+        `it returned '${fooBarActualStatusCode}'.`);\n+  } else if (fooBarActualRedirectUrl !== fooBarExpectedRedirectUrl) {\n+    throw new Error(\n+        `Expected '${fooBarUrl}' to be redirected to '${fooBarExpectedRedirectUrl}', but it was ` +\n+        `but it was redirected to '${fooBarActualRedirectUrl}'.`);\n+  }\n+}\n+\n function testPwaScore({deployedUrl, minPwaScore}) {\n   console.log('\\n\\n\\n==== Run PWA-score tests. ====\\n');\n   yarn(`test-pwa-score \"${deployedUrl}\" \"${minPwaScore}\"`);"
        },
        {
            "sha": "c434f8b0a278389f9584f916437cb6fed0713904",
            "filename": "aio/scripts/deploy-to-firebase.spec.js",
            "status": "modified",
            "additions": 30,
            "deletions": 1,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/cf1f5a1e37e053cdea44483336d2a976f45968cd/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/cf1f5a1e37e053cdea44483336d2a976f45968cd/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.spec.js?ref=cf1f5a1e37e053cdea44483336d2a976f45968cd",
            "patch": "@@ -5,6 +5,7 @@ const {execSync} = require('child_process');\n const {\n   computeDeploymentsInfo,\n   computeInputVars,\n+  computeMajorVersion,\n   getLatestCommit,\n   getMostRecentMinorBranch,\n } = require('./deploy-to-firebase');\n@@ -104,7 +105,7 @@ describe('deploy-to-firebase:', () => {\n     ]);\n   });\n \n-  it('stable - deploy success', () => {\n+  it('stable - deploy success - active RC', () => {\n     expect(getDeploymentsInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n@@ -124,6 +125,34 @@ describe('deploy-to-firebase:', () => {\n     ]);\n   });\n \n+  it('stable - deploy success - no active RC', () => {\n+    expect(getDeploymentsInfoFor({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: mostRecentMinorBranch,\n+      CI_STABLE_BRANCH: mostRecentMinorBranch,\n+      CI_COMMIT: latestCommits[mostRecentMinorBranch],\n+    })).toEqual([\n+      {\n+        deployEnv: 'stable',\n+        projectId: 'angular-io',\n+        siteId: `v${computeMajorVersion(mostRecentMinorBranch)}-angular-io-site`,\n+        deployedUrl: 'https://angular.io/',\n+        preDeployActions: ['function:build', 'function:checkPayloadSize'],\n+        postDeployActions: ['function:testPwaScore'],\n+      },\n+      {\n+        deployEnv: 'stable',\n+        projectId: 'angular-io',\n+        siteId: 'rc-angular-io-site',\n+        deployedUrl: 'https://rc.angular.io/',\n+        preDeployActions: ['function:removeServiceWorker', 'function:redirectToAngularIo'],\n+        postDeployActions: ['function:testNoActiveRcDeployment'],\n+      },\n+    ]);\n+  });\n+\n   it('stable - skip deploy - commit not HEAD', () => {\n     expect(getDeploymentsInfoFor({\n       CI_REPO_OWNER: 'angular',"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 104,
        "deletions": 3
    }
}