{
    "author": "kyliau",
    "message": "fix(language-service): Add plugin option to force strictTemplates (#41062)\n\nThis commit adds a new configuration option, `forceStrictTemplates` to the\nlanguage service plugin to allow users to force enable `strictTemplates`.\n\nThis is needed so that the Angular extension can be used inside Google without\nchanging the underlying compiler options in the `ng_module` build rule.\n\nPR Close #41062",
    "sha": "e9e7c33f3c170648ec8c86d859980c7fe78fba39",
    "files": [
        {
            "sha": "9424f5cde6b1f9a754a876bb3b10782f9d63ab89",
            "filename": "packages/language-service/api.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fapi.ts?ref=e9e7c33f3c170648ec8c86d859980c7fe78fba39",
            "patch": "@@ -14,7 +14,7 @@\n \n import * as ts from 'typescript';\n \n-export interface NgLanguageServiceConfig {\n+export interface PluginConfig {\n   /**\n    * If true, return only Angular results. Otherwise, return Angular + TypeScript\n    * results.\n@@ -25,6 +25,11 @@ export interface NgLanguageServiceConfig {\n    * Otherwise return factory function for View Engine LS.\n    */\n   ivy: boolean;\n+  /**\n+   * If true, enable `strictTemplates` in Angular compiler options regardless\n+   * of its value in tsconfig.json.\n+   */\n+  forceStrictTemplates?: true;\n }\n \n export type GetTcbResponse = {"
        },
        {
            "sha": "6b02ff5ca933c6dc63d7cd95fe2721bad4436cda",
            "filename": "packages/language-service/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Findex.ts?ref=e9e7c33f3c170648ec8c86d859980c7fe78fba39",
            "patch": "@@ -7,29 +7,29 @@\n  */\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n-import {NgLanguageService, NgLanguageServiceConfig} from './api';\n+import {NgLanguageService, PluginConfig} from './api';\n \n export * from './api';\n \n interface PluginModule extends ts.server.PluginModule {\n   create(createInfo: ts.server.PluginCreateInfo): NgLanguageService;\n-  onConfigurationChanged?(config: NgLanguageServiceConfig): void;\n+  onConfigurationChanged?(config: PluginConfig): void;\n }\n \n const factory: ts.server.PluginModuleFactory = (tsModule): PluginModule => {\n   let plugin: PluginModule;\n \n   return {\n     create(info: ts.server.PluginCreateInfo): NgLanguageService {\n-      const config: NgLanguageServiceConfig = info.config;\n+      const config: PluginConfig = info.config;\n       const bundleName = config.ivy ? 'ivy.js' : 'language-service.js';\n       plugin = require(`./bundles/${bundleName}`)(tsModule);\n       return plugin.create(info);\n     },\n     getExternalFiles(project: ts.server.Project): string[] {\n       return plugin?.getExternalFiles?.(project) ?? [];\n     },\n-    onConfigurationChanged(config: NgLanguageServiceConfig): void {\n+    onConfigurationChanged(config: PluginConfig): void {\n       plugin?.onConfigurationChanged?.(config);\n     },\n   };"
        },
        {
            "sha": "55131b02a4eee82480a259b6a3e8be2461203b12",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 4,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=e9e7c33f3c170648ec8c86d859980c7fe78fba39",
            "patch": "@@ -29,6 +29,14 @@ import {getTargetAtPosition, TargetContext, TargetNodeKind} from './template_tar\n import {findTightestNode, getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n import {getTemplateInfoAtPosition, isTypeScriptFile} from './utils';\n \n+interface LanguageServiceConfig {\n+  /**\n+   * If true, enable `strictTemplates` in Angular compiler options regardless\n+   * of its value in tsconfig.json.\n+   */\n+  forceStrictTemplates?: true;\n+}\n+\n export class LanguageService {\n   private options: CompilerOptions;\n   readonly compilerFactory: CompilerFactory;\n@@ -37,9 +45,12 @@ export class LanguageService {\n   private readonly parseConfigHost: LSParseConfigHost;\n \n   constructor(\n-      private readonly project: ts.server.Project, private readonly tsLS: ts.LanguageService) {\n+      private readonly project: ts.server.Project,\n+      private readonly tsLS: ts.LanguageService,\n+      private readonly config: LanguageServiceConfig,\n+  ) {\n     this.parseConfigHost = new LSParseConfigHost(project.projectService.host);\n-    this.options = parseNgCompilerOptions(project, this.parseConfigHost);\n+    this.options = parseNgCompilerOptions(project, this.parseConfigHost, config);\n     logCompilerOptions(project, this.options);\n     this.strategy = createTypeCheckingProgramStrategy(project);\n     this.adapter = new LanguageServiceAdapter(project);\n@@ -340,7 +351,7 @@ export class LanguageService {\n         project.getConfigFilePath(), (fileName: string, eventKind: ts.FileWatcherEventKind) => {\n           project.log(`Config file changed: ${fileName}`);\n           if (eventKind === ts.FileWatcherEventKind.Changed) {\n-            this.options = parseNgCompilerOptions(project, this.parseConfigHost);\n+            this.options = parseNgCompilerOptions(project, this.parseConfigHost, this.config);\n             logCompilerOptions(project, this.options);\n           }\n         });\n@@ -354,7 +365,8 @@ function logCompilerOptions(project: ts.server.Project, options: CompilerOptions\n }\n \n function parseNgCompilerOptions(\n-    project: ts.server.Project, host: ConfigurationHost): CompilerOptions {\n+    project: ts.server.Project, host: ConfigurationHost,\n+    config: LanguageServiceConfig): CompilerOptions {\n   if (!(project instanceof ts.server.ConfiguredProject)) {\n     return {};\n   }\n@@ -375,6 +387,12 @@ function parseNgCompilerOptions(\n   // and only the real component declaration is used.\n   options.compileNonExportedClasses = false;\n \n+  // If `forceStrictTemplates` is true, always enable `strictTemplates`\n+  // regardless of its value in tsconfig.json.\n+  if (config.forceStrictTemplates === true) {\n+    options.strictTemplates = true;\n+  }\n+\n   return options;\n }\n "
        },
        {
            "sha": "f5fc2b40cec70a023cfcfb06dce6bc6951256161",
            "filename": "packages/language-service/ivy/test/legacy/definitions_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdefinitions_spec.ts?ref=e9e7c33f3c170648ec8c86d859980c7fe78fba39",
            "patch": "@@ -18,7 +18,7 @@ describe('definitions', () => {\n   beforeAll(() => {\n     const {project, service: _service, tsLS} = setup();\n     service = _service;\n-    ngLS = new LanguageService(project, tsLS);\n+    ngLS = new LanguageService(project, tsLS, {});\n   });\n \n   beforeEach(() => {"
        },
        {
            "sha": "728deb23dc91209cf93851971545c626c798a55f",
            "filename": "packages/language-service/ivy/test/legacy/diagnostic_spec.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdiagnostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdiagnostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fdiagnostic_spec.ts?ref=e9e7c33f3c170648ec8c86d859980c7fe78fba39",
            "patch": "@@ -17,7 +17,7 @@ describe('getSemanticDiagnostics', () => {\n   beforeAll(() => {\n     const {project, service: _service, tsLS} = setup();\n     service = _service;\n-    ngLS = new LanguageService(project, tsLS);\n+    ngLS = new LanguageService(project, tsLS, {});\n   });\n \n   beforeEach(() => {",
            "previous_filename": "packages/language-service/ivy/test/legacy/daignostic_spec.ts"
        },
        {
            "sha": "65361603ac922dd5d98983c624e7f625c033bba1",
            "filename": "packages/language-service/ivy/test/legacy/language_service_spec.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 1,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts?ref=e9e7c33f3c170648ec8c86d859980c7fe78fba39",
            "patch": "@@ -23,7 +23,7 @@ describe('language service adapter', () => {\n     const {project: _project, tsLS, service: _service, configFileFs: _configFileFs} = setup();\n     project = _project;\n     service = _service;\n-    ngLS = new LanguageService(project, tsLS);\n+    ngLS = new LanguageService(project, tsLS, {});\n     configFileFs = _configFileFs;\n   });\n \n@@ -57,6 +57,33 @@ describe('language service adapter', () => {\n         strictTemplates: false,\n       }));\n     });\n+\n+    it('should always enable strictTemplates if forceStrictTemplates is true', () => {\n+      const {project, tsLS, configFileFs} = setup();\n+      const ngLS = new LanguageService(project, tsLS, {\n+        forceStrictTemplates: true,\n+      });\n+\n+      // First make sure the default for strictTemplates is true\n+      expect(ngLS.getCompilerOptions()).toEqual(jasmine.objectContaining({\n+        enableIvy: true,  // default for ivy is true\n+        strictTemplates: true,\n+        strictInjectionParameters: true,\n+      }));\n+\n+      // Change strictTemplates to false\n+      configFileFs.overwriteConfigFile(TSCONFIG, {\n+        angularCompilerOptions: {\n+          strictTemplates: false,\n+        }\n+      });\n+\n+      // Make sure strictTemplates is still true because forceStrictTemplates\n+      // is enabled.\n+      expect(ngLS.getCompilerOptions()).toEqual(jasmine.objectContaining({\n+        strictTemplates: true,\n+      }));\n+    });\n   });\n \n   describe('compiler options diagnostics', () => {"
        },
        {
            "sha": "88599ccf1ce1e212785c2a65c5d615c77a39164b",
            "filename": "packages/language-service/ivy/test/legacy/ts_plugin_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fts_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fts_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fts_plugin_spec.ts?ref=e9e7c33f3c170648ec8c86d859980c7fe78fba39",
            "patch": "@@ -19,7 +19,7 @@ describe('getExternalFiles()', () => {\n     // a global analysis\n     expect(externalFiles).toEqual([]);\n     // Trigger global analysis\n-    const ngLS = new LanguageService(project, tsLS);\n+    const ngLS = new LanguageService(project, tsLS, {});\n     ngLS.getSemanticDiagnostics(APP_COMPONENT);\n     // Now that global analysis is run, we should have all the typecheck files\n     externalFiles = getExternalFiles(project);"
        },
        {
            "sha": "821bb725b5911fc0985c4d34cb52247a3daf6882",
            "filename": "packages/language-service/ivy/test/legacy/type_definitions_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftype_definitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftype_definitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftype_definitions_spec.ts?ref=e9e7c33f3c170648ec8c86d859980c7fe78fba39",
            "patch": "@@ -18,7 +18,7 @@ describe('type definitions', () => {\n   beforeAll(() => {\n     const {project, service: _service, tsLS} = setup();\n     service = _service;\n-    ngLS = new LanguageService(project, tsLS);\n+    ngLS = new LanguageService(project, tsLS, {});\n   });\n \n   const possibleArrayDefFiles = new Set(["
        },
        {
            "sha": "5f2ca942039b4bed2bd9619d231b858b8824e284",
            "filename": "packages/language-service/ivy/testing/src/project.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "raw_url": "https://github.com/angular/angular/raw/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts?ref=e9e7c33f3c170648ec8c86d859980c7fe78fba39",
            "patch": "@@ -92,7 +92,7 @@ export class Project {\n \n     // The following operation forces a ts.Program to be created.\n     this.tsLS = tsProject.getLanguageService();\n-    this.ngLS = new LanguageService(tsProject, this.tsLS);\n+    this.ngLS = new LanguageService(tsProject, this.tsLS, {});\n   }\n \n   openFile(projectFileName: string): OpenBuffer {\n@@ -188,4 +188,4 @@ function getClassOrError(sf: ts.SourceFile, name: string): ts.ClassDeclaration {\n     }\n   }\n   throw new Error(`Class ${name} not found in file: ${sf.fileName}: ${sf.text}`);\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "5d964b1db4960e10d00180b14c0d2b0dde32855a",
            "filename": "packages/language-service/ivy/ts_plugin.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/e9e7c33f3c170648ec8c86d859980c7fe78fba39/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts?ref=e9e7c33f3c170648ec8c86d859980c7fe78fba39",
            "patch": "@@ -16,7 +16,7 @@ export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n   const {project, languageService: tsLS, config} = info;\n   const angularOnly = config?.angularOnly === true;\n \n-  const ngLS = new LanguageService(project, tsLS);\n+  const ngLS = new LanguageService(project, tsLS, config);\n \n   function getSemanticDiagnostics(fileName: string): ts.Diagnostic[] {\n     const diagnostics: ts.Diagnostic[] = [];"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 67,
        "deletions": 17
    }
}