{
    "author": "JoostK",
    "message": "refactor(compiler-cli): more accurate reporting of complex function call (#37587)\n\nThis commit introduces a dedicated `DynamicValue` kind to indicate that a value\ncannot be evaluated statically as the function body is not just a single return\nstatement. This allows more accurate reporting of why a function call failed\nto be evaluated, i.e. we now include a reference to the function declaration\nand have a tailor-made diagnostic message.\n\nPR Close #37587",
    "sha": "ce879fc4160e9b12db5d58fd20caf30fc05e8832",
    "files": [
        {
            "sha": "e270cb213cba260cd6e5f31f90bb68a86a3594bd",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/src/diagnostics.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/ce879fc4160e9b12db5d58fd20caf30fc05e8832/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Fdiagnostics.ts",
            "raw_url": "https://github.com/angular/angular/raw/ce879fc4160e9b12db5d58fd20caf30fc05e8832/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Fdiagnostics.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Fdiagnostics.ts?ref=ce879fc4160e9b12db5d58fd20caf30fc05e8832",
            "patch": "@@ -10,6 +10,7 @@ import * as ts from 'typescript';\n \n import {makeRelatedInformation} from '../../diagnostics';\n import {Reference} from '../../imports';\n+import {FunctionDefinition} from '../../reflection';\n import {DynamicValue, DynamicValueVisitor} from './dynamic';\n import {EnumValue, KnownFn, ResolvedModule, ResolvedValue} from './result';\n \n@@ -104,6 +105,16 @@ class TraceDynamicValueVisitor implements DynamicValueVisitor<ts.DiagnosticRelat\n             description} cannot be determined statically, as it is an external declaration.`)];\n   }\n \n+  visitComplexFunctionCall(value: DynamicValue<FunctionDefinition>):\n+      ts.DiagnosticRelatedInformation[] {\n+    return [\n+      makeRelatedInformation(\n+          value.node,\n+          'Unable to evaluate function call of complex function. A function must have exactly one return statement.'),\n+      makeRelatedInformation(value.reason.node, 'Function is declared here.')\n+    ];\n+  }\n+\n   visitInvalidExpressionType(value: DynamicValue): ts.DiagnosticRelatedInformation[] {\n     return [makeRelatedInformation(value.node, 'Unable to evaluate an invalid expression.')];\n   }"
        },
        {
            "sha": "c19bfa3e3df013213fa56cb4e0b8d57e229af68d",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/src/dynamic.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/ce879fc4160e9b12db5d58fd20caf30fc05e8832/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Fdynamic.ts",
            "raw_url": "https://github.com/angular/angular/raw/ce879fc4160e9b12db5d58fd20caf30fc05e8832/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Fdynamic.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Fdynamic.ts?ref=ce879fc4160e9b12db5d58fd20caf30fc05e8832",
            "patch": "@@ -9,6 +9,7 @@\n import * as ts from 'typescript';\n \n import {Reference} from '../../imports';\n+import {FunctionDefinition} from '../../reflection';\n \n /**\n  * The reason why a value cannot be determined statically.\n@@ -55,6 +56,11 @@ export const enum DynamicValueReason {\n    */\n   INVALID_EXPRESSION_TYPE,\n \n+  /**\n+   * A function call could not be evaluated as the function's body is not a single return statement.\n+   */\n+  COMPLEX_FUNCTION_CALL,\n+\n   /**\n    * A value could not be determined statically for any reason other the above.\n    */\n@@ -93,6 +99,11 @@ export class DynamicValue<R = unknown> {\n     return new DynamicValue(node, value, DynamicValueReason.INVALID_EXPRESSION_TYPE);\n   }\n \n+  static fromComplexFunctionCall(node: ts.Node, fn: FunctionDefinition):\n+      DynamicValue<FunctionDefinition> {\n+    return new DynamicValue(node, fn, DynamicValueReason.COMPLEX_FUNCTION_CALL);\n+  }\n+\n   static fromUnknown(node: ts.Node): DynamicValue {\n     return new DynamicValue(node, undefined, DynamicValueReason.UNKNOWN);\n   }\n@@ -121,6 +132,10 @@ export class DynamicValue<R = unknown> {\n     return this.code === DynamicValueReason.INVALID_EXPRESSION_TYPE;\n   }\n \n+  isFromComplexFunctionCall(this: DynamicValue<R>): this is DynamicValue<FunctionDefinition> {\n+    return this.code === DynamicValueReason.COMPLEX_FUNCTION_CALL;\n+  }\n+\n   isFromUnknown(this: DynamicValue<R>): this is DynamicValue {\n     return this.code === DynamicValueReason.UNKNOWN;\n   }\n@@ -140,6 +155,9 @@ export class DynamicValue<R = unknown> {\n         return visitor.visitUnknownIdentifier(this);\n       case DynamicValueReason.INVALID_EXPRESSION_TYPE:\n         return visitor.visitInvalidExpressionType(this);\n+      case DynamicValueReason.COMPLEX_FUNCTION_CALL:\n+        return visitor.visitComplexFunctionCall(\n+            this as unknown as DynamicValue<FunctionDefinition>);\n       case DynamicValueReason.UNKNOWN:\n         return visitor.visitUnknown(this);\n     }\n@@ -153,5 +171,6 @@ export interface DynamicValueVisitor<R> {\n   visitUnsupportedSyntax(value: DynamicValue): R;\n   visitUnknownIdentifier(value: DynamicValue): R;\n   visitInvalidExpressionType(value: DynamicValue): R;\n+  visitComplexFunctionCall(value: DynamicValue<FunctionDefinition>): R;\n   visitUnknown(value: DynamicValue): R;\n }"
        },
        {
            "sha": "af2034229725eaac8349f10e2e35b982296aa4eb",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/src/interpreter.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/ce879fc4160e9b12db5d58fd20caf30fc05e8832/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts",
            "raw_url": "https://github.com/angular/angular/raw/ce879fc4160e9b12db5d58fd20caf30fc05e8832/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts?ref=ce879fc4160e9b12db5d58fd20caf30fc05e8832",
            "patch": "@@ -490,8 +490,10 @@ export class StaticInterpreter {\n \n   private visitFunctionBody(node: ts.CallExpression, fn: FunctionDefinition, context: Context):\n       ResolvedValue {\n-    if (fn.body === null || fn.body.length !== 1 || !ts.isReturnStatement(fn.body[0])) {\n+    if (fn.body === null) {\n       return DynamicValue.fromUnknown(node);\n+    } else if (fn.body.length !== 1 || !ts.isReturnStatement(fn.body[0])) {\n+      return DynamicValue.fromComplexFunctionCall(node, fn);\n     }\n     const ret = fn.body[0] as ts.ReturnStatement;\n "
        },
        {
            "sha": "e8bf6de5a0eb24690fb2179ab854c2e9b0ab090e",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/test/diagnostics_spec.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/ce879fc4160e9b12db5d58fd20caf30fc05e8832/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fdiagnostics_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ce879fc4160e9b12db5d58fd20caf30fc05e8832/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fdiagnostics_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fdiagnostics_spec.ts?ref=ce879fc4160e9b12db5d58fd20caf30fc05e8832",
            "patch": "@@ -199,10 +199,16 @@ runInEachFileSystem(() => {\n           }`,\n             'complex()');\n \n-        expect(trace.length).toBe(1);\n-        expect(trace[0].messageText).toBe('Unable to evaluate statically.');\n+        expect(trace.length).toBe(2);\n+        expect(trace[0].messageText)\n+            .toBe(\n+                'Unable to evaluate function call of complex function. A function must have exactly one return statement.');\n         expect(trace[0].file!.fileName).toBe(_('/entry.ts'));\n         expect(getSourceCode(trace[0])).toBe('complex()');\n+\n+        expect(trace[1].messageText).toBe('Function is declared here.');\n+        expect(trace[1].file!.fileName).toBe(_('/entry.ts'));\n+        expect(getSourceCode(trace[1])).toContain(`console.log('test');`);\n       });\n \n       it('should trace object destructuring of external reference', () => {"
        },
        {
            "sha": "7c8d53e9257ca9765d9db7177c8198126b3afd77",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/test/evaluator_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/ce879fc4160e9b12db5d58fd20caf30fc05e8832/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fevaluator_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ce879fc4160e9b12db5d58fd20caf30fc05e8832/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fevaluator_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fevaluator_spec.ts?ref=ce879fc4160e9b12db5d58fd20caf30fc05e8832",
            "patch": "@@ -622,15 +622,18 @@ runInEachFileSystem(() => {\n       expect(id.text).toEqual('Target');\n     });\n \n-    it('should resolve functions with more than one statement to an unknown value', () => {\n+    it('should resolve functions with more than one statement to a complex function call', () => {\n       const value = evaluate(`function foo(bar) { const b = bar; return b; }`, 'foo(\"test\")');\n \n       if (!(value instanceof DynamicValue)) {\n         return fail(`Should have resolved to a DynamicValue`);\n       }\n-\n-      expect(value.isFromUnknown()).toBe(true);\n+      if (!value.isFromComplexFunctionCall()) {\n+        return fail('Expected DynamicValue to be from complex function call');\n+      }\n       expect((value.node as ts.CallExpression).expression.getText()).toBe('foo');\n+      expect((value.reason.node as ts.FunctionDeclaration).getText())\n+          .toContain('const b = bar; return b;');\n     });\n \n     describe('(with imported TypeScript helpers)', () => {"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 47,
        "deletions": 6
    }
}