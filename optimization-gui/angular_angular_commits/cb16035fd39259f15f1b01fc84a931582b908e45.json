{
    "author": "gkalpak",
    "message": "fix(docs-infra): correctly display event dates on all timezones (#41053)\n\nPreviously, the event dates displayed on the angular.io \"Events\" page\n(`/events`) was off by one day on timezones with a negative offset from\nUTC. See\nhttps://github.com/angular/angular/pull/41050#issuecomment-788958888.\n\nThis commit fixes it by using the `getUTC*` methods of the `Date` object\nto extract the date info, which are not affected by the user's timezone.\n\nPR Close #41053",
    "sha": "cb16035fd39259f15f1b01fc84a931582b908e45",
    "files": [
        {
            "sha": "3938a2a2daba90ef40e7f59e1e3dc37b43ae38e1",
            "filename": "aio/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/cb16035fd39259f15f1b01fc84a931582b908e45/aio%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/cb16035fd39259f15f1b01fc84a931582b908e45/aio%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fpackage.json?ref=cb16035fd39259f15f1b01fc84a931582b908e45",
            "patch": "@@ -161,6 +161,7 @@\n     \"rimraf\": \"^2.6.1\",\n     \"semver\": \"^5.3.0\",\n     \"shelljs\": \"^0.8.4\",\n+    \"timezone-mock\": \"^1.1.3\",\n     \"tree-kill\": \"^1.1.0\",\n     \"ts-node\": \"^8.4.1\",\n     \"tslint\": \"~6.1.0\","
        },
        {
            "sha": "a2e436fcefa8a455d08c56955fbe62bc05ccf8a0",
            "filename": "aio/src/app/custom-elements/events/events.component.spec.ts",
            "status": "modified",
            "additions": 98,
            "deletions": 76,
            "changes": 174,
            "blob_url": "https://github.com/angular/angular/blob/cb16035fd39259f15f1b01fc84a931582b908e45/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fevents%2Fevents.component.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb16035fd39259f15f1b01fc84a931582b908e45/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fevents%2Fevents.component.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fevents%2Fevents.component.spec.ts?ref=cb16035fd39259f15f1b01fc84a931582b908e45",
            "patch": "@@ -1,5 +1,6 @@\n import { Injector } from '@angular/core';\n import { Subject } from 'rxjs';\n+import * as tzMock from 'timezone-mock';\n import { Duration, Event, EventsComponent } from './events.component';\n import { EventsService } from './events.service';\n \n@@ -132,86 +133,107 @@ describe('EventsComponent', () => {\n   });\n \n   describe('getEventDates()', () => {\n-    describe('(without workshops)', () => {\n-      it('should correctly format the main event date', () => {\n-        const testEvent = createMockEvent('Test', {start: '2020-06-20', end: '2020-06-20'});\n-        expect(component.getEventDates(testEvent)).toBe('June 20, 2020');\n-      });\n-\n-      it('should correctly format the main event date spanning mupliple days', () => {\n-        const testEvent = createMockEvent('Test', {start: '2019-09-19', end: '2019-09-21'});\n-        expect(component.getEventDates(testEvent)).toBe('September 19-21, 2019');\n-      });\n-\n-      it('should correctly format the main event date spanning mupliple months', () => {\n-        const testEvent = createMockEvent('Test', {start: '2019-10-30', end: '2019-11-01'});\n-        expect(component.getEventDates(testEvent)).toBe('October 30 - November 1, 2019');\n-      });\n-    });\n-\n-    describe('(with workshops)', () => {\n-      it('should correctly format event dates with workshops after main event', () => {\n-        const testEvent = createMockEvent(\n-            'Test',\n-            {start: '2020-07-25', end: '2020-07-26'},\n-            {start: '2020-07-27', end: '2020-07-27'});\n-\n-        expect(component.getEventDates(testEvent))\n-            .toBe('July 25-26 (conference), July 27 (workshops), 2020');\n-      });\n-\n-      it('should correctly format event dates with workshops before main event', () => {\n-        const testEvent = createMockEvent(\n-            'Test',\n-            {start: '2019-10-07', end: '2019-10-07'},\n-            {start: '2019-10-06', end: '2019-10-06'});\n-\n-        expect(component.getEventDates(testEvent))\n-            .toBe('October 6 (workshops), October 7 (conference), 2019');\n-      });\n-\n-      it('should correctly format event dates spanning multiple days', () => {\n-        const testEvent = createMockEvent(\n-            'Test',\n-            {start: '2019-08-30', end: '2019-08-31'},\n-            {start: '2019-08-28', end: '2019-08-29'});\n-\n-        expect(component.getEventDates(testEvent))\n-            .toBe('August 28-29 (workshops), August 30-31 (conference), 2019');\n-      });\n-\n-      it('should correctly format event dates with workshops on different month before the main event',\n-        () => {\n-          const testEvent = createMockEvent(\n-              'Test',\n-              {start: '2020-08-01', end: '2020-08-02'},\n-              {start: '2020-07-30', end: '2020-07-31'});\n-\n-          expect(component.getEventDates(testEvent))\n-              .toBe('July 30-31 (workshops), August 1-2 (conference), 2020');\n+    // Test on different timezones to ensure that event dates are processed correctly regardless of\n+    // the user's local time.\n+    const timezones: tzMock.TimeZone[] = [\n+      'Australia/Adelaide',  // UTC+9.5/10.5\n+      'Brazil/East',         // UTC-3\n+      'UTC',                 // UTC\n+    ];\n+\n+    for (const tz of timezones) {\n+      describe(`on timezone ${tz}`, () => {\n+        // NOTE: `timezone-mock` does not work correctly if used together with Jasmine's mock clock.\n+        beforeEach(() => tzMock.register(tz));\n+        afterEach(() => tzMock.unregister());\n+\n+        describe('(without workshops)', () => {\n+          it('should correctly format the main event date', () => {\n+            const testEvent = createMockEvent('Test', {start: '2020-06-20', end: '2020-06-20'});\n+            expect(component.getEventDates(testEvent)).toBe('June 20, 2020');\n+          });\n+\n+          it('should correctly format the main event date spanning mupliple days', () => {\n+            const testEvent = createMockEvent('Test', {start: '2019-09-19', end: '2019-09-21'});\n+            expect(component.getEventDates(testEvent)).toBe('September 19-21, 2019');\n+          });\n+\n+          it('should correctly format the main event date spanning mupliple months', () => {\n+            const testEvent = createMockEvent('Test', {start: '2019-10-30', end: '2019-11-01'});\n+            expect(component.getEventDates(testEvent)).toBe('October 30 - November 1, 2019');\n+          });\n+\n+          it('should correctly format event dates at the beginning/end of the year', () => {\n+            const testEvent = createMockEvent('Test', {start: '2021-01-01', end: '2021-12-31'});\n+            expect(component.getEventDates(testEvent)).toBe('January 1 - December 31, 2021');\n+          });\n         });\n \n-      it('should correctly format event dates with workshops on different month after the main event',\n-        () => {\n-          const testEvent = createMockEvent(\n-              'Test',\n-              {start: '2020-07-30', end: '2020-07-31'},\n-              {start: '2020-08-01', end: '2020-08-02'});\n-\n-          expect(component.getEventDates(testEvent))\n-              .toBe('July 30-31 (conference), August 1-2 (workshops), 2020');\n+        describe('(with workshops)', () => {\n+          it('should correctly format event dates with workshops after main event', () => {\n+            const testEvent = createMockEvent(\n+                'Test',\n+                {start: '2020-07-25', end: '2020-07-26'},\n+                {start: '2020-07-27', end: '2020-07-27'});\n+\n+            expect(component.getEventDates(testEvent))\n+                .toBe('July 25-26 (conference), July 27 (workshops), 2020');\n+          });\n+\n+          it('should correctly format event dates with workshops before main event', () => {\n+            const testEvent = createMockEvent(\n+                'Test',\n+                {start: '2019-10-07', end: '2019-10-07'},\n+                {start: '2019-10-06', end: '2019-10-06'});\n+\n+            expect(component.getEventDates(testEvent))\n+                .toBe('October 6 (workshops), October 7 (conference), 2019');\n+          });\n+\n+          it('should correctly format event dates spanning multiple days', () => {\n+            const testEvent = createMockEvent(\n+                'Test',\n+                {start: '2019-08-30', end: '2019-08-31'},\n+                {start: '2019-08-28', end: '2019-08-29'});\n+\n+            expect(component.getEventDates(testEvent))\n+                .toBe('August 28-29 (workshops), August 30-31 (conference), 2019');\n+          });\n+\n+          it('should correctly format event dates with workshops on different month before the main event',\n+            () => {\n+              const testEvent = createMockEvent(\n+                  'Test',\n+                  {start: '2020-08-01', end: '2020-08-02'},\n+                  {start: '2020-07-30', end: '2020-07-31'});\n+\n+              expect(component.getEventDates(testEvent))\n+                  .toBe('July 30-31 (workshops), August 1-2 (conference), 2020');\n+            });\n+\n+          it('should correctly format event dates with workshops on different month after the main event',\n+            () => {\n+              const testEvent = createMockEvent(\n+                  'Test',\n+                  {start: '2020-07-30', end: '2020-07-31'},\n+                  {start: '2020-08-01', end: '2020-08-02'});\n+\n+              expect(component.getEventDates(testEvent))\n+                  .toBe('July 30-31 (conference), August 1-2 (workshops), 2020');\n+            });\n+\n+          it('should correctly format event dates spanning multiple months', () => {\n+            const testEvent = createMockEvent(\n+                'Test',\n+                {start: '2020-07-31', end: '2020-08-01'},\n+                {start: '2020-07-30', end: '2020-08-01'});\n+\n+            expect(component.getEventDates(testEvent))\n+                .toBe('July 30 - August 1 (workshops), July 31 - August 1 (conference), 2020');\n+          });\n         });\n-\n-      it('should correctly format event dates spanning multiple months', () => {\n-        const testEvent = createMockEvent(\n-            'Test',\n-            {start: '2020-07-31', end: '2020-08-01'},\n-            {start: '2020-07-30', end: '2020-08-01'});\n-\n-        expect(component.getEventDates(testEvent))\n-            .toBe('July 30 - August 1 (workshops), July 31 - August 1 (conference), 2020');\n       });\n-    });\n+    }\n   });\n \n   // Helpers"
        },
        {
            "sha": "f3343ee9e1639e095876fa2467fb622f8e073f46",
            "filename": "aio/src/app/custom-elements/events/events.component.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/cb16035fd39259f15f1b01fc84a931582b908e45/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fevents%2Fevents.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/cb16035fd39259f15f1b01fc84a931582b908e45/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fevents%2Fevents.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fevents%2Fevents.component.ts?ref=cb16035fd39259f15f1b01fc84a931582b908e45",
            "patch": "@@ -72,7 +72,7 @@ export class EventsComponent implements OnInit {\n       // If no work shop date create conference date string\n       dateString = processDate(event.date);\n     }\n-    dateString = `${dateString}, ${new Date(event.date.end).getFullYear()}`;\n+    dateString = `${dateString}, ${new Date(event.date.end).getUTCFullYear()}`;\n     return dateString;\n   }\n }\n@@ -83,14 +83,14 @@ function processDate(dates: Duration) {\n   const endDate = new Date(dates.end);\n \n   // Create a date string in the start like January 31\n-  let processedDate = `${MONTHS[startDate.getMonth()]} ${startDate.getDate()}`;\n+  let processedDate = `${MONTHS[startDate.getUTCMonth()]} ${startDate.getUTCDate()}`;\n \n   // If they are in different months add the string '- February 2' Making the final string January 31 - February 2\n-  if (startDate.getMonth() !== endDate.getMonth()) {\n-    processedDate = `${processedDate} - ${MONTHS[endDate.getMonth()]} ${endDate.getDate()}`;\n-  } else if (startDate.getDate() !== endDate.getDate()) {\n+  if (startDate.getUTCMonth() !== endDate.getUTCMonth()) {\n+    processedDate = `${processedDate} - ${MONTHS[endDate.getUTCMonth()]} ${endDate.getUTCDate()}`;\n+  } else if (startDate.getUTCDate() !== endDate.getUTCDate()) {\n     // If not add - date eg it will make // January 30-31\n-    processedDate = `${processedDate}-${endDate.getDate()}`;\n+    processedDate = `${processedDate}-${endDate.getUTCDate()}`;\n   }\n \n   return processedDate;"
        },
        {
            "sha": "eab85d307d5b398f7330aca8613f95aa4b32219c",
            "filename": "aio/yarn.lock",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/cb16035fd39259f15f1b01fc84a931582b908e45/aio%2Fyarn.lock",
            "raw_url": "https://github.com/angular/angular/raw/cb16035fd39259f15f1b01fc84a931582b908e45/aio%2Fyarn.lock",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fyarn.lock?ref=cb16035fd39259f15f1b01fc84a931582b908e45",
            "patch": "@@ -13168,6 +13168,11 @@ timers-ext@^0.1.5:\n     es5-ext \"~0.10.46\"\n     next-tick \"1\"\n \n+timezone-mock@^1.1.3:\n+  version \"1.1.3\"\n+  resolved \"https://registry.yarnpkg.com/timezone-mock/-/timezone-mock-1.1.3.tgz#f5ca25befec2cdd2d64c07ee7a5293275c06b97e\"\n+  integrity sha512-r+fz9M1tflNkF6mJK0DwmlFyNWeSCXxZ68pu2Bv+DddIHK/czOZwnasEql17VfHqP/OcZRuPq/qi6wm7eQmQow==\n+\n timsort@^0.3.0:\n   version \"0.3.0\"\n   resolved \"https://registry.yarnpkg.com/timsort/-/timsort-0.3.0.tgz#405411a8e7e6339fe64db9a234de11dc31e02bd4\""
        }
    ],
    "stats": {
        "total": 192,
        "additions": 110,
        "deletions": 82
    }
}