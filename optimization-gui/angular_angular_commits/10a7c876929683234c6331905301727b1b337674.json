{
    "author": "petebacondarwin",
    "message": "refactor(compiler): implement `ngDeclareInjectable()` (#41316)\n\nThis commit changes the partial compilation so that it outputs declarations\nrather than definitions for injectables.\n\nThe JIT compiler and the linker are updated to be able to handle these\nnew declarations.\n\nPR Close #41316",
    "sha": "10a7c876929683234c6331905301727b1b337674",
    "files": [
        {
            "sha": "f97b03c396933ecfb298046f8525f2644c8c364b",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_component_linker_1.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 41,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -18,6 +18,7 @@ import {LinkerEnvironment} from '../linker_environment';\n \n import {toR3DirectiveMeta} from './partial_directive_linker_1';\n import {PartialLinker} from './partial_linker';\n+import {extractForwardRef} from './util';\n \n /**\n  * A `PartialLinker` that is designed to process `ɵɵngDeclareComponent()` call expressions.\n@@ -81,10 +82,8 @@ export class PartialComponentLinkerVersion1<TStatement, TExpression> implements\n             const type = directiveExpr.getValue('type');\n             const selector = directiveExpr.getString('selector');\n \n-            let typeExpr = type.getOpaque();\n-            const forwardRefType = extractForwardRef(type);\n-            if (forwardRefType !== null) {\n-              typeExpr = forwardRefType;\n+            const {expression: typeExpr, isForwardRef} = extractForwardRef(type);\n+            if (isForwardRef) {\n               declarationListEmitMode = DeclarationListEmitMode.Closure;\n             }\n \n@@ -115,13 +114,11 @@ export class PartialComponentLinkerVersion1<TStatement, TExpression> implements\n     let pipes = new Map<string, o.Expression>();\n     if (metaObj.has('pipes')) {\n       pipes = metaObj.getObject('pipes').toMap(pipe => {\n-        const forwardRefType = extractForwardRef(pipe);\n-        if (forwardRefType !== null) {\n+        const {expression: pipeType, isForwardRef} = extractForwardRef(pipe);\n+        if (isForwardRef) {\n           declarationListEmitMode = DeclarationListEmitMode.Closure;\n-          return forwardRefType;\n-        } else {\n-          return pipe.getOpaque();\n         }\n+        return pipeType;\n       });\n     }\n \n@@ -277,35 +274,3 @@ function parseChangeDetectionStrategy<TExpression>(\n   }\n   return enumValue;\n }\n-\n-/**\n- * Extract the type reference expression from a `forwardRef` function call. For example, the\n- * expression `forwardRef(function() { return FooDir; })` returns `FooDir`. Note that this\n- * expression is required to be wrapped in a closure, as otherwise the forward reference would be\n- * resolved before initialization.\n- */\n-function extractForwardRef<TExpression>(expr: AstValue<unknown, TExpression>):\n-    o.WrappedNodeExpr<TExpression>|null {\n-  if (!expr.isCallExpression()) {\n-    return null;\n-  }\n-\n-  const callee = expr.getCallee();\n-  if (callee.getSymbolName() !== 'forwardRef') {\n-    throw new FatalLinkerError(\n-        callee.expression, 'Unsupported directive type, expected forwardRef or a type reference');\n-  }\n-\n-  const args = expr.getArguments();\n-  if (args.length !== 1) {\n-    throw new FatalLinkerError(expr, 'Unsupported forwardRef call, expected a single argument');\n-  }\n-\n-  const wrapperFn = args[0] as AstValue<Function, TExpression>;\n-  if (!wrapperFn.isFunction()) {\n-    throw new FatalLinkerError(\n-        wrapperFn, 'Unsupported forwardRef call, expected a function argument');\n-  }\n-\n-  return wrapperFn.getFunctionReturnValue().getOpaque();\n-}"
        },
        {
            "sha": "a2eb3c4e52a704ba6bc7de133ad780774b7d554f",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_factory_linker_1.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 27,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_factory_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_factory_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_factory_linker_1.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -5,14 +5,14 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {compileFactoryFunction, ConstantPool, FactoryTarget, R3DeclareDependencyMetadata, R3DeclareFactoryMetadata, R3DependencyMetadata, R3FactoryMetadata, R3PartialDeclaration} from '@angular/compiler';\n+import {compileFactoryFunction, ConstantPool, FactoryTarget, R3DeclareFactoryMetadata, R3DependencyMetadata, R3FactoryMetadata, R3PartialDeclaration} from '@angular/compiler';\n import * as o from '@angular/compiler/src/output/output_ast';\n \n import {AstObject} from '../../ast/ast_value';\n import {FatalLinkerError} from '../../fatal_linker_error';\n \n import {PartialLinker} from './partial_linker';\n-import {parseEnum, wrapReference} from './util';\n+import {getDependency, parseEnum, wrapReference} from './util';\n \n /**\n  * A `PartialLinker` that is designed to process `ɵɵngDeclareFactory()` call expressions.\n@@ -45,44 +45,22 @@ export function toR3FactoryMeta<TExpression>(\n     internalType: metaObj.getOpaque('type'),\n     typeArgumentCount: 0,\n     target: parseEnum(metaObj.getValue('target'), FactoryTarget),\n-    deps: getDeps(metaObj, 'deps'),\n+    deps: getDependencies(metaObj, 'deps'),\n   };\n }\n \n-function getDeps<TExpression>(\n+function getDependencies<TExpression>(\n     metaObj: AstObject<R3DeclareFactoryMetadata, TExpression>,\n     propName: keyof R3DeclareFactoryMetadata): R3DependencyMetadata[]|null|'invalid' {\n   if (!metaObj.has(propName)) {\n     return null;\n   }\n   const deps = metaObj.getValue(propName);\n   if (deps.isArray()) {\n-    return deps.getArray().map(dep => getDep(dep.getObject()));\n+    return deps.getArray().map(dep => getDependency(dep.getObject()));\n   }\n   if (deps.isString()) {\n     return 'invalid';\n   }\n   return null;\n }\n-\n-function getDep<TExpression>(depObj: AstObject<R3DeclareDependencyMetadata, TExpression>):\n-    R3DependencyMetadata {\n-  const isAttribute = depObj.has('attribute') && depObj.getBoolean('attribute');\n-  const token = depObj.getOpaque('token');\n-  // Normally `attribute` is a string literal and so its `attributeNameType` is the same string\n-  // literal. If the `attribute` is some other expression, the `attributeNameType` would be the\n-  // `unknown` type. It is not possible to generate this when linking, since it only deals with JS\n-  // and not typings. When linking the existence of the `attributeNameType` only acts as a marker to\n-  // change the injection instruction that is generated, so we just pass the literal string\n-  // `\"unknown\"`.\n-  const attributeNameType = isAttribute ? o.literal('unknown') : null;\n-  const dep: R3DependencyMetadata = {\n-    token,\n-    attributeNameType,\n-    host: depObj.has('host') && depObj.getBoolean('host'),\n-    optional: depObj.has('optional') && depObj.getBoolean('optional'),\n-    self: depObj.has('self') && depObj.getBoolean('self'),\n-    skipSelf: depObj.has('skipSelf') && depObj.getBoolean('skipSelf'),\n-  };\n-  return dep;\n-}"
        },
        {
            "sha": "33510cfe5485bb22b44aff95f8562aeb5fafe36c",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_injectable_linker_1.ts",
            "status": "added",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_injectable_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_injectable_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_injectable_linker_1.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -0,0 +1,69 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {compileInjectable, ConstantPool, createR3ProviderExpression, R3DeclareInjectableMetadata, R3InjectableMetadata, R3PartialDeclaration} from '@angular/compiler';\n+import * as o from '@angular/compiler/src/output/output_ast';\n+\n+import {AstObject} from '../../ast/ast_value';\n+import {FatalLinkerError} from '../../fatal_linker_error';\n+\n+import {PartialLinker} from './partial_linker';\n+import {extractForwardRef, getDependency, wrapReference} from './util';\n+\n+/**\n+ * A `PartialLinker` that is designed to process `ɵɵngDeclareInjectable()` call expressions.\n+ */\n+export class PartialInjectableLinkerVersion1<TExpression> implements PartialLinker<TExpression> {\n+  linkPartialDeclaration(\n+      constantPool: ConstantPool,\n+      metaObj: AstObject<R3PartialDeclaration, TExpression>): o.Expression {\n+    const meta = toR3InjectableMeta(metaObj);\n+    const def = compileInjectable(meta, /* resolveForwardRefs */ false);\n+    return def.expression;\n+  }\n+}\n+\n+/**\n+ * Derives the `R3InjectableMetadata` structure from the AST object.\n+ */\n+export function toR3InjectableMeta<TExpression>(\n+    metaObj: AstObject<R3DeclareInjectableMetadata, TExpression>): R3InjectableMetadata {\n+  const typeExpr = metaObj.getValue('type');\n+  const typeName = typeExpr.getSymbolName();\n+  if (typeName === null) {\n+    throw new FatalLinkerError(\n+        typeExpr.expression, 'Unsupported type, its name could not be determined');\n+  }\n+\n+  const meta: R3InjectableMetadata = {\n+    name: typeName,\n+    type: wrapReference(typeExpr.getOpaque()),\n+    internalType: typeExpr.getOpaque(),\n+    typeArgumentCount: 0,\n+    providedIn: metaObj.has('providedIn') ? extractForwardRef(metaObj.getValue('providedIn')) :\n+                                            createR3ProviderExpression(o.literal(null), false),\n+  };\n+\n+  if (metaObj.has('useClass')) {\n+    meta.useClass = extractForwardRef(metaObj.getValue('useClass'));\n+  }\n+  if (metaObj.has('useFactory')) {\n+    meta.useFactory = metaObj.getOpaque('useFactory');\n+  }\n+  if (metaObj.has('useExisting')) {\n+    meta.useExisting = extractForwardRef(metaObj.getValue('useExisting'));\n+  }\n+  if (metaObj.has('useValue')) {\n+    meta.useValue = extractForwardRef(metaObj.getValue('useValue'));\n+  }\n+\n+  if (metaObj.has('deps')) {\n+    meta.deps = metaObj.getArray('deps').map(dep => getDependency(dep.getObject()));\n+  }\n+\n+  return meta;\n+}"
        },
        {
            "sha": "771c14e8cb0d3b96b2b24f9fe28b48ac64b7f46d",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_linker_selector.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -14,6 +14,7 @@ import {LinkerEnvironment} from '../linker_environment';\n import {PartialComponentLinkerVersion1} from './partial_component_linker_1';\n import {PartialDirectiveLinkerVersion1} from './partial_directive_linker_1';\n import {PartialFactoryLinkerVersion1} from './partial_factory_linker_1';\n+import {PartialInjectableLinkerVersion1} from './partial_injectable_linker_1';\n import {PartialInjectorLinkerVersion1} from './partial_injector_linker_1';\n import {PartialLinker} from './partial_linker';\n import {PartialNgModuleLinkerVersion1} from './partial_ng_module_linker_1';\n@@ -22,12 +23,13 @@ import {PartialPipeLinkerVersion1} from './partial_pipe_linker_1';\n export const ɵɵngDeclareDirective = 'ɵɵngDeclareDirective';\n export const ɵɵngDeclareComponent = 'ɵɵngDeclareComponent';\n export const ɵɵngDeclareFactory = 'ɵɵngDeclareFactory';\n+export const ɵɵngDeclareInjectable = 'ɵɵngDeclareInjectable';\n export const ɵɵngDeclareInjector = 'ɵɵngDeclareInjector';\n export const ɵɵngDeclareNgModule = 'ɵɵngDeclareNgModule';\n export const ɵɵngDeclarePipe = 'ɵɵngDeclarePipe';\n export const declarationFunctions = [\n-  ɵɵngDeclareDirective, ɵɵngDeclareComponent, ɵɵngDeclareFactory, ɵɵngDeclareInjector,\n-  ɵɵngDeclareNgModule, ɵɵngDeclarePipe\n+  ɵɵngDeclareDirective, ɵɵngDeclareComponent, ɵɵngDeclareFactory, ɵɵngDeclareInjectable,\n+  ɵɵngDeclareInjector, ɵɵngDeclareNgModule, ɵɵngDeclarePipe\n ];\n \n interface LinkerRange<TExpression> {\n@@ -93,6 +95,7 @@ export class PartialLinkerSelector<TStatement, TExpression> {\n         environment, createGetSourceFile(sourceUrl, code, environment.sourceFileLoader), sourceUrl,\n         code);\n     const partialFactoryLinkerVersion1 = new PartialFactoryLinkerVersion1();\n+    const partialInjectableLinkerVersion1 = new PartialInjectableLinkerVersion1();\n     const partialInjectorLinkerVersion1 = new PartialInjectorLinkerVersion1();\n     const partialNgModuleLinkerVersion1 =\n         new PartialNgModuleLinkerVersion1(environment.options.linkerJitMode);\n@@ -111,6 +114,10 @@ export class PartialLinkerSelector<TStatement, TExpression> {\n       {range: '0.0.0-PLACEHOLDER', linker: partialFactoryLinkerVersion1},\n       {range: '>=11.1.0-next.1', linker: partialFactoryLinkerVersion1},\n     ]);\n+    linkers.set(ɵɵngDeclareInjectable, [\n+      {range: '0.0.0-PLACEHOLDER', linker: partialInjectableLinkerVersion1},\n+      {range: '>=11.1.0-next.1', linker: partialInjectableLinkerVersion1},\n+    ]);\n     linkers.set(ɵɵngDeclareInjector, [\n       {range: '0.0.0-PLACEHOLDER', linker: partialInjectorLinkerVersion1},\n       {range: '>=11.1.0-next.1', linker: partialInjectorLinkerVersion1},"
        },
        {
            "sha": "bf0f1efd0fd81f1d97ee164c578b542ceef59256",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/util.ts",
            "status": "modified",
            "additions": 66,
            "deletions": 2,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Futil.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -5,9 +5,10 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {R3Reference} from '@angular/compiler';\n+import {createR3ProviderExpression, R3DeclareDependencyMetadata, R3DependencyMetadata, R3ProviderExpression, R3Reference} from '@angular/compiler';\n import * as o from '@angular/compiler/src/output/output_ast';\n-import {AstValue} from '../../ast/ast_value';\n+\n+import {AstObject, AstValue} from '../../ast/ast_value';\n import {FatalLinkerError} from '../../fatal_linker_error';\n \n export function wrapReference<TExpression>(wrapped: o.WrappedNodeExpr<TExpression>): R3Reference {\n@@ -29,3 +30,66 @@ export function parseEnum<TExpression, TEnum>(\n   }\n   return enumValue;\n }\n+\n+/**\n+ * Parse a dependency structure from an AST object.\n+ */\n+export function getDependency<TExpression>(\n+    depObj: AstObject<R3DeclareDependencyMetadata, TExpression>): R3DependencyMetadata {\n+  const isAttribute = depObj.has('attribute') && depObj.getBoolean('attribute');\n+  const token = depObj.getOpaque('token');\n+  // Normally `attribute` is a string literal and so its `attributeNameType` is the same string\n+  // literal. If the `attribute` is some other expression, the `attributeNameType` would be the\n+  // `unknown` type. It is not possible to generate this when linking, since it only deals with JS\n+  // and not typings. When linking the existence of the `attributeNameType` only acts as a marker to\n+  // change the injection instruction that is generated, so we just pass the literal string\n+  // `\"unknown\"`.\n+  const attributeNameType = isAttribute ? o.literal('unknown') : null;\n+  return {\n+    token,\n+    attributeNameType,\n+    host: depObj.has('host') && depObj.getBoolean('host'),\n+    optional: depObj.has('optional') && depObj.getBoolean('optional'),\n+    self: depObj.has('self') && depObj.getBoolean('self'),\n+    skipSelf: depObj.has('skipSelf') && depObj.getBoolean('skipSelf'),\n+  };\n+}\n+\n+\n+/**\n+ * Return an `R3ProviderExpression` that represents either the extracted type reference expression\n+ * from a `forwardRef` function call, or the type itself.\n+ *\n+ * For example, the expression `forwardRef(function() { return FooDir; })` returns `FooDir`. Note\n+ * that this expression is required to be wrapped in a closure, as otherwise the forward reference\n+ * would be resolved before initialization.\n+ *\n+ * If there is no forwardRef call expression then we just return the opaque type.\n+ */\n+export function extractForwardRef<TExpression>(expr: AstValue<unknown, TExpression>):\n+    R3ProviderExpression<o.WrappedNodeExpr<TExpression>> {\n+  if (!expr.isCallExpression()) {\n+    return createR3ProviderExpression(expr.getOpaque(), /* isForwardRef */ false);\n+  }\n+\n+  const callee = expr.getCallee();\n+  if (callee.getSymbolName() !== 'forwardRef') {\n+    throw new FatalLinkerError(\n+        callee.expression,\n+        'Unsupported expression, expected a `forwardRef()` call or a type reference');\n+  }\n+\n+  const args = expr.getArguments();\n+  if (args.length !== 1) {\n+    throw new FatalLinkerError(\n+        expr, 'Unsupported `forwardRef(fn)` call, expected a single argument');\n+  }\n+\n+  const wrapperFn = args[0] as AstValue<Function, TExpression>;\n+  if (!wrapperFn.isFunction()) {\n+    throw new FatalLinkerError(\n+        wrapperFn, 'Unsupported `forwardRef(fn)` call, expected its argument to be a function');\n+  }\n+\n+  return createR3ProviderExpression(wrapperFn.getFunctionReturnValue().getOpaque(), true);\n+}"
        },
        {
            "sha": "2aecd76dc07cefeaaf93f4f106982503d6028194",
            "filename": "packages/compiler-cli/linker/test/file_linker/partial_linkers/partial_linker_selector_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector_spec.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -17,6 +17,7 @@ import {LinkerEnvironment} from '../../../src/file_linker/linker_environment';\n import {PartialComponentLinkerVersion1} from '../../../src/file_linker/partial_linkers/partial_component_linker_1';\n import {PartialDirectiveLinkerVersion1} from '../../../src/file_linker/partial_linkers/partial_directive_linker_1';\n import {PartialFactoryLinkerVersion1} from '../../../src/file_linker/partial_linkers/partial_factory_linker_1';\n+import {PartialInjectableLinkerVersion1} from '../../../src/file_linker/partial_linkers/partial_injectable_linker_1';\n import {PartialInjectorLinkerVersion1} from '../../../src/file_linker/partial_linkers/partial_injector_linker_1';\n import {PartialLinkerSelector} from '../../../src/file_linker/partial_linkers/partial_linker_selector';\n import {PartialNgModuleLinkerVersion1} from '../../../src/file_linker/partial_linkers/partial_ng_module_linker_1';\n@@ -43,6 +44,7 @@ describe('PartialLinkerSelector', () => {\n          expect(selector.supportsDeclaration('ɵɵngDeclareDirective')).toBe(true);\n          expect(selector.supportsDeclaration('ɵɵngDeclareComponent')).toBe(true);\n          expect(selector.supportsDeclaration('ɵɵngDeclareFactory')).toBe(true);\n+         expect(selector.supportsDeclaration('ɵɵngDeclareInjectable')).toBe(true);\n          expect(selector.supportsDeclaration('ɵɵngDeclareInjector')).toBe(true);\n          expect(selector.supportsDeclaration('ɵɵngDeclareNgModule')).toBe(true);\n          expect(selector.supportsDeclaration('ɵɵngDeclarePipe')).toBe(true);\n@@ -66,6 +68,8 @@ describe('PartialLinkerSelector', () => {\n           .toBeInstanceOf(PartialComponentLinkerVersion1);\n       expect(selector.getLinker('ɵɵngDeclareFactory', '0.0.0-PLACEHOLDER'))\n           .toBeInstanceOf(PartialFactoryLinkerVersion1);\n+      expect(selector.getLinker('ɵɵngDeclareInjectable', '0.0.0-PLACEHOLDER'))\n+          .toBeInstanceOf(PartialInjectableLinkerVersion1);\n       expect(selector.getLinker('ɵɵngDeclareInjector', '0.0.0-PLACEHOLDER'))\n           .toBeInstanceOf(PartialInjectorLinkerVersion1);\n       expect(selector.getLinker('ɵɵngDeclareNgModule', '0.0.0-PLACEHOLDER'))"
        },
        {
            "sha": "5209aad0a8a48269a1a88e62c6ee71ffeb0cf9ee",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/directive.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -24,7 +24,7 @@ import {AnalysisOutput, CompileResult, DecoratorHandler, DetectResult, HandlerFl\n import {createValueHasWrongTypeError, getDirectiveDiagnostics, getProviderDiagnostics, getUndecoratedClassWithAngularFeaturesDiagnostic} from './diagnostics';\n import {compileDeclareFactory, compileNgFactoryDefField} from './factory';\n import {generateSetClassMetadataCall} from './metadata';\n-import {compileResults, createSourceSpan, findAngularDecorator, getConstructorDependencies, isAngularDecorator, readBaseClass, resolveProvidersRequiringFactory, toFactoryMetadata, unwrapConstructorDependencies, unwrapExpression, unwrapForwardRef, validateConstructorDependencies, wrapFunctionExpressionsInParens, wrapTypeReference} from './util';\n+import {compileResults, createSourceSpan, findAngularDecorator, getConstructorDependencies, isAngularDecorator, readBaseClass, resolveProvidersRequiringFactory, toFactoryMetadata, tryUnwrapForwardRef, unwrapConstructorDependencies, unwrapExpression, validateConstructorDependencies, wrapFunctionExpressionsInParens, wrapTypeReference} from './util';\n \n const EMPTY_OBJECT: {[key: string]: string} = {};\n const FIELD_DECORATORS = [\n@@ -528,7 +528,7 @@ export function extractQueryMetadata(\n         ErrorCode.DECORATOR_ARITY_WRONG, exprNode, `@${name} must have arguments`);\n   }\n   const first = name === 'ViewChild' || name === 'ContentChild';\n-  const node = unwrapForwardRef(args[0], reflector);\n+  const node = tryUnwrapForwardRef(args[0], reflector) ?? args[0];\n   const arg = evaluator.evaluate(node);\n \n   /** Whether or not this query should collect only static results (see view/api.ts)  */"
        },
        {
            "sha": "d20c307f4ecec3c6c18351096d9fbcbf6685e74a",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/factory.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Ffactory.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Ffactory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Ffactory.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -10,6 +10,8 @@ import {compileDeclareFactoryFunction, compileFactoryFunction, R3FactoryMetadata\n \n import {CompileResult} from '../../transform';\n \n+export type CompileFactoryFn = (metadata: R3FactoryMetadata) => CompileResult;\n+\n export function compileNgFactoryDefField(metadata: R3FactoryMetadata): CompileResult {\n   const res = compileFactoryFunction(metadata);\n   return {name: 'ɵfac', initializer: res.expression, statements: res.statements, type: res.type};"
        },
        {
            "sha": "e400bef4f815a17084a7235d41b1ab5be24a7784",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/injectable.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 82,
            "changes": 130,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {compileInjectable as compileIvyInjectable, Expression, FactoryTarget, LiteralExpr, R3DependencyMetadata, R3FactoryMetadata, R3InjectableMetadata, Statement, WrappedNodeExpr} from '@angular/compiler';\n+import {compileDeclareInjectableFromMetadata, compileInjectable, createR3ProviderExpression, Expression, FactoryTarget, LiteralExpr, R3CompiledExpression, R3DependencyMetadata, R3InjectableMetadata, R3ProviderExpression, Statement, WrappedNodeExpr} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {ErrorCode, FatalDiagnosticError} from '../../diagnostics';\n@@ -16,9 +16,9 @@ import {PerfEvent, PerfRecorder} from '../../perf';\n import {ClassDeclaration, Decorator, ReflectionHost, reflectObjectLiteral} from '../../reflection';\n import {AnalysisOutput, CompileResult, DecoratorHandler, DetectResult, HandlerPrecedence} from '../../transform';\n \n-import {compileDeclareFactory, compileNgFactoryDefField} from './factory';\n+import {compileDeclareFactory, CompileFactoryFn, compileNgFactoryDefField} from './factory';\n import {generateSetClassMetadataCall} from './metadata';\n-import {findAngularDecorator, getConstructorDependencies, getValidConstructorDependencies, isAngularCore, toFactoryMetadata, unwrapConstructorDependencies, unwrapForwardRef, validateConstructorDependencies, wrapTypeReference} from './util';\n+import {findAngularDecorator, getConstructorDependencies, getValidConstructorDependencies, isAngularCore, toFactoryMetadata, tryUnwrapForwardRef, unwrapConstructorDependencies, validateConstructorDependencies, wrapTypeReference} from './util';\n \n export interface InjectableHandlerData {\n   meta: R3InjectableMetadata;\n@@ -28,7 +28,7 @@ export interface InjectableHandlerData {\n }\n \n /**\n- * Adapts the `compileIvyInjectable` compiler for `@Injectable` decorators to the Ivy compiler.\n+ * Adapts the `compileInjectable` compiler for `@Injectable` decorators to the Ivy compiler.\n  */\n export class InjectableDecoratorHandler implements\n     DecoratorHandler<Decorator, InjectableHandlerData, null, unknown> {\n@@ -95,45 +95,25 @@ export class InjectableDecoratorHandler implements\n   }\n \n   compileFull(node: ClassDeclaration, analysis: Readonly<InjectableHandlerData>): CompileResult[] {\n-    const res = compileIvyInjectable(analysis.meta);\n-    const statements = res.statements;\n-    const results: CompileResult[] = [];\n-\n-    if (analysis.needsFactory) {\n-      const meta = analysis.meta;\n-      const factoryRes = compileNgFactoryDefField(\n-          toFactoryMetadata({...meta, deps: analysis.ctorDeps}, FactoryTarget.Injectable));\n-      if (analysis.metadataStmt !== null) {\n-        factoryRes.statements.push(analysis.metadataStmt);\n-      }\n-      results.push(factoryRes);\n-    }\n-\n-    const ɵprov = this.reflector.getMembersOfClass(node).find(member => member.name === 'ɵprov');\n-    if (ɵprov !== undefined && this.errorOnDuplicateProv) {\n-      throw new FatalDiagnosticError(\n-          ErrorCode.INJECTABLE_DUPLICATE_PROV, ɵprov.nameNode || ɵprov.node || node,\n-          'Injectables cannot contain a static ɵprov property, because the compiler is going to generate one.');\n-    }\n-\n-    if (ɵprov === undefined) {\n-      // Only add a new ɵprov if there is not one already\n-      results.push({name: 'ɵprov', initializer: res.expression, statements, type: res.type});\n-    }\n-\n-\n-    return results;\n+    return this.compile(\n+        compileNgFactoryDefField, meta => compileInjectable(meta, false), node, analysis);\n   }\n \n   compilePartial(node: ClassDeclaration, analysis: Readonly<InjectableHandlerData>):\n       CompileResult[] {\n-    const res = compileIvyInjectable(analysis.meta);\n-    const statements = res.statements;\n+    return this.compile(\n+        compileDeclareFactory, compileDeclareInjectableFromMetadata, node, analysis);\n+  }\n+\n+  private compile(\n+      compileFactoryFn: CompileFactoryFn,\n+      compileInjectableFn: (meta: R3InjectableMetadata) => R3CompiledExpression,\n+      node: ClassDeclaration, analysis: Readonly<InjectableHandlerData>): CompileResult[] {\n     const results: CompileResult[] = [];\n \n     if (analysis.needsFactory) {\n       const meta = analysis.meta;\n-      const factoryRes = compileDeclareFactory(\n+      const factoryRes = compileFactoryFn(\n           toFactoryMetadata({...meta, deps: analysis.ctorDeps}, FactoryTarget.Injectable));\n       if (analysis.metadataStmt !== null) {\n         factoryRes.statements.push(analysis.metadataStmt);\n@@ -150,7 +130,9 @@ export class InjectableDecoratorHandler implements\n \n     if (ɵprov === undefined) {\n       // Only add a new ɵprov if there is not one already\n-      results.push({name: 'ɵprov', initializer: res.expression, statements, type: res.type});\n+      const res = compileInjectableFn(analysis.meta);\n+      results.push(\n+          {name: 'ɵprov', initializer: res.expression, statements: res.statements, type: res.type});\n     }\n \n     return results;\n@@ -159,7 +141,7 @@ export class InjectableDecoratorHandler implements\n \n /**\n  * Read metadata from the `@Injectable` decorator and produce the `IvyInjectableMetadata`, the\n- * input metadata needed to run `compileIvyInjectable`.\n+ * input metadata needed to run `compileInjectable`.\n  *\n  * A `null` return value indicates this is @Injectable has invalid data.\n  */\n@@ -181,7 +163,7 @@ function extractInjectableMetadata(\n       type,\n       typeArgumentCount,\n       internalType,\n-      providedIn: new LiteralExpr(null),\n+      providedIn: createR3ProviderExpression(new LiteralExpr(null), false),\n     };\n   } else if (decorator.args.length === 1) {\n     const metaNode = decorator.args[0];\n@@ -196,71 +178,55 @@ function extractInjectableMetadata(\n \n     // Resolve the fields of the literal into a map of field name to expression.\n     const meta = reflectObjectLiteral(metaNode);\n-    let providedIn: Expression = new LiteralExpr(null);\n-    if (meta.has('providedIn')) {\n-      providedIn = new WrappedNodeExpr(meta.get('providedIn')!);\n-    }\n \n-    let userDeps: R3DependencyMetadata[]|undefined = undefined;\n+    const providedIn = meta.has('providedIn') ?\n+        getProviderExpression(meta.get('providedIn')!, reflector) :\n+        createR3ProviderExpression(new LiteralExpr(null), false);\n+\n+    let deps: R3DependencyMetadata[]|undefined = undefined;\n     if ((meta.has('useClass') || meta.has('useFactory')) && meta.has('deps')) {\n       const depsExpr = meta.get('deps')!;\n       if (!ts.isArrayLiteralExpression(depsExpr)) {\n         throw new FatalDiagnosticError(\n             ErrorCode.VALUE_NOT_LITERAL, depsExpr,\n             `@Injectable deps metadata must be an inline array`);\n       }\n-      userDeps = depsExpr.elements.map(dep => getDep(dep, reflector));\n+      deps = depsExpr.elements.map(dep => getDep(dep, reflector));\n     }\n \n+    const result: R3InjectableMetadata = {name, type, typeArgumentCount, internalType, providedIn};\n     if (meta.has('useValue')) {\n-      return {\n-        name,\n-        type,\n-        typeArgumentCount,\n-        internalType,\n-        providedIn,\n-        useValue: new WrappedNodeExpr(unwrapForwardRef(meta.get('useValue')!, reflector)),\n-      };\n+      result.useValue = getProviderExpression(meta.get('useValue')!, reflector);\n     } else if (meta.has('useExisting')) {\n-      return {\n-        name,\n-        type,\n-        typeArgumentCount,\n-        internalType,\n-        providedIn,\n-        useExisting: new WrappedNodeExpr(unwrapForwardRef(meta.get('useExisting')!, reflector)),\n-      };\n+      result.useExisting = getProviderExpression(meta.get('useExisting')!, reflector);\n     } else if (meta.has('useClass')) {\n-      return {\n-        name,\n-        type,\n-        typeArgumentCount,\n-        internalType,\n-        providedIn,\n-        useClass: new WrappedNodeExpr(unwrapForwardRef(meta.get('useClass')!, reflector)),\n-        userDeps,\n-      };\n+      result.useClass = getProviderExpression(meta.get('useClass')!, reflector);\n+      result.deps = deps;\n     } else if (meta.has('useFactory')) {\n-      // useFactory is special - the 'deps' property must be analyzed.\n-      const factory = new WrappedNodeExpr(meta.get('useFactory')!);\n-      return {\n-        name,\n-        type,\n-        typeArgumentCount,\n-        internalType,\n-        providedIn,\n-        useFactory: factory,\n-        userDeps,\n-      };\n-    } else {\n-      return {name, type, typeArgumentCount, internalType, providedIn};\n+      result.useFactory = new WrappedNodeExpr(meta.get('useFactory')!);\n+      result.deps = deps;\n     }\n+    return result;\n   } else {\n     throw new FatalDiagnosticError(\n         ErrorCode.DECORATOR_ARITY_WRONG, decorator.args[2], 'Too many arguments to @Injectable');\n   }\n }\n \n+/**\n+ * Get the `R3ProviderExpression` for this `expression`.\n+ *\n+ * The `useValue`, `useExisting` and `useClass` properties might be wrapped in a `ForwardRef`, which\n+ * needs to be unwrapped. This function will do that unwrapping and set a flag on the returned\n+ * object to indicate whether the value needed unwrapping.\n+ */\n+function getProviderExpression(\n+    expression: ts.Expression, reflector: ReflectionHost): R3ProviderExpression {\n+  const forwardRefValue = tryUnwrapForwardRef(expression, reflector);\n+  return createR3ProviderExpression(\n+      new WrappedNodeExpr(forwardRefValue ?? expression), forwardRefValue !== null);\n+}\n+\n function extractInjectableCtorDeps(\n     clazz: ClassDeclaration, meta: R3InjectableMetadata, decorator: Decorator,\n     reflector: ReflectionHost, defaultImportRecorder: DefaultImportRecorder, isCore: boolean,"
        },
        {
            "sha": "098b18391d595111040f9836949b27cffdef2d9f",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/util.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 10,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -332,36 +332,40 @@ function expandForwardRef(arg: ts.Expression): ts.Expression|null {\n   }\n }\n \n+\n /**\n- * Possibly resolve a forwardRef() expression into the inner value.\n+ * If the given `node` is a forwardRef() expression then resolve its inner value, otherwise return\n+ * `null`.\n  *\n  * @param node the forwardRef() expression to resolve\n  * @param reflector a ReflectionHost\n- * @returns the resolved expression, if the original expression was a forwardRef(), or the original\n- * expression otherwise\n+ * @returns the resolved expression, if the original expression was a forwardRef(), or `null`\n+ *     otherwise.\n  */\n-export function unwrapForwardRef(node: ts.Expression, reflector: ReflectionHost): ts.Expression {\n+export function tryUnwrapForwardRef(node: ts.Expression, reflector: ReflectionHost): ts.Expression|\n+    null {\n   node = unwrapExpression(node);\n   if (!ts.isCallExpression(node) || node.arguments.length !== 1) {\n-    return node;\n+    return null;\n   }\n \n   const fn =\n       ts.isPropertyAccessExpression(node.expression) ? node.expression.name : node.expression;\n   if (!ts.isIdentifier(fn)) {\n-    return node;\n+    return null;\n   }\n \n   const expr = expandForwardRef(node.arguments[0]);\n   if (expr === null) {\n-    return node;\n+    return null;\n   }\n+\n   const imp = reflector.getImportOfIdentifier(fn);\n   if (imp === null || imp.from !== '@angular/core' || imp.name !== 'forwardRef') {\n-    return node;\n-  } else {\n-    return expr;\n+    return null;\n   }\n+\n+  return expr;\n }\n \n /**"
        },
        {
            "sha": "796ca1b0a7070eea3fa1f88f035438a5365f7409",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/ng_modules/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fng_modules%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fng_modules%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fng_modules%2FGOLDEN_PARTIAL.js?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -167,7 +167,7 @@ import * as i0 from \"@angular/core\";\n export class Thing {\n }\n Thing.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Thing, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-Thing.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: Thing, factory: Thing.ɵfac });\n+Thing.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Thing });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(Thing, [{\n         type: Injectable\n     }], null, null); })();\n@@ -178,14 +178,14 @@ export class BaseService {\n     ;\n }\n BaseService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: BaseService, deps: [{ token: Thing }], target: i0.ɵɵFactoryTarget.Injectable });\n-BaseService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: BaseService, factory: BaseService.ɵfac });\n+BaseService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: BaseService });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(BaseService, [{\n         type: Injectable\n     }], function () { return [{ type: Thing }]; }, null); })();\n export class ChildService extends BaseService {\n }\n ChildService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: ChildService, deps: null, target: i0.ɵɵFactoryTarget.Injectable });\n-ChildService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: ChildService, factory: ChildService.ɵfac });\n+ChildService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: ChildService });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(ChildService, [{\n         type: Injectable\n     }], null, null); })();\n@@ -469,7 +469,7 @@ import * as i0 from \"@angular/core\";\n export class Service {\n }\n Service.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Service, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-Service.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: Service, factory: Service.ɵfac });\n+Service.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Service });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(Service, [{\n         type: Injectable\n     }], null, null); })();"
        },
        {
            "sha": "5ecfc3b03b6c83a96391ad7da5fe5caf2b44bf4a",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_di/di/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 63,
            "deletions": 24,
            "changes": 87,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2FGOLDEN_PARTIAL.js?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -6,7 +6,7 @@ import * as i0 from \"@angular/core\";\n export class MyService {\n }\n MyService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-MyService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyService, factory: MyService.ɵfac });\n+MyService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyService, [{\n         type: Injectable\n     }], null, null); })();\n@@ -80,7 +80,7 @@ export class MyService {\n     constructor(dep) { }\n }\n MyService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, deps: [{ token: MyDependency }], target: i0.ɵɵFactoryTarget.Injectable });\n-MyService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyService, factory: MyService.ɵfac });\n+MyService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyService, [{\n         type: Injectable\n     }], function () { return [{ type: MyDependency }]; }, null); })();\n@@ -111,7 +111,7 @@ export class MyService {\n     constructor(dep, optionalDep) { }\n }\n MyService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, deps: [{ token: MyDependency }, { token: MyOptionalDependency, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });\n-MyService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyService, factory: MyService.ɵfac });\n+MyService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyService, [{\n         type: Injectable\n     }], function () { return [{ type: MyDependency }, { type: MyOptionalDependency, decorators: [{\n@@ -144,7 +144,7 @@ function alternateFactory() {\n export class MyService {\n }\n MyService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-MyService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyService, factory: function () { return alternateFactory(); }, providedIn: 'root' });\n+MyService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, providedIn: 'root', useFactory: alternateFactory });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyService, [{\n         type: Injectable,\n         args: [{ providedIn: 'root', useFactory: alternateFactory }]\n@@ -171,12 +171,7 @@ class MyAlternateService {\n export class MyService {\n }\n MyService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-MyService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyService, factory: function MyService_Factory(t) { let r = null; if (t) {\n-        r = new t();\n-    }\n-    else {\n-        r = (() => new MyAlternateService())(i0.ɵɵinject(SomeDep));\n-    } return r; }, providedIn: 'root' });\n+MyService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, providedIn: 'root', useFactory: () => new MyAlternateService(), deps: [{ token: SomeDep }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyService, [{\n         type: Injectable,\n         args: [{ providedIn: 'root', useFactory: () => new MyAlternateService(), deps: [SomeDep] }]\n@@ -199,14 +194,14 @@ import * as i0 from \"@angular/core\";\n class MyAlternateService {\n }\n MyAlternateService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyAlternateService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-MyAlternateService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyAlternateService, factory: MyAlternateService.ɵfac });\n+MyAlternateService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyAlternateService });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyAlternateService, [{\n         type: Injectable\n     }], null, null); })();\n export class MyService {\n }\n MyService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-MyService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyService, factory: function (t) { return MyAlternateService.ɵfac(t); }, providedIn: 'root' });\n+MyService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, providedIn: 'root', useClass: MyAlternateService });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyService, [{\n         type: Injectable,\n         args: [{ providedIn: 'root', useClass: MyAlternateService }]\n@@ -231,19 +226,14 @@ class SomeDep {\n class MyAlternateService {\n }\n MyAlternateService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyAlternateService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-MyAlternateService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyAlternateService, factory: MyAlternateService.ɵfac });\n+MyAlternateService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyAlternateService });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyAlternateService, [{\n         type: Injectable\n     }], null, null); })();\n export class MyService {\n }\n MyService.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-MyService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyService, factory: function MyService_Factory(t) { let r = null; if (t) {\n-        r = new t();\n-    }\n-    else {\n-        r = new MyAlternateService(i0.ɵɵinject(SomeDep));\n-    } return r; }, providedIn: 'root' });\n+MyService.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyService, providedIn: 'root', useClass: MyAlternateService, deps: [{ token: SomeDep }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyService, [{\n         type: Injectable,\n         args: [{ providedIn: 'root', useClass: MyAlternateService, deps: [SomeDep] }]\n@@ -266,15 +256,15 @@ import * as i0 from \"@angular/core\";\n class SomeProvider {\n }\n SomeProvider.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: SomeProvider, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-SomeProvider.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: SomeProvider, factory: function (t) { return SomeProviderImpl.ɵfac(t); }, providedIn: 'root' });\n+SomeProvider.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: SomeProvider, providedIn: 'root', useClass: i0.forwardRef(function () { return SomeProviderImpl; }) });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(SomeProvider, [{\n         type: Injectable,\n         args: [{ providedIn: 'root', useClass: forwardRef(() => SomeProviderImpl) }]\n     }], null, null); })();\n class SomeProviderImpl extends SomeProvider {\n }\n SomeProviderImpl.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: SomeProviderImpl, deps: null, target: i0.ɵɵFactoryTarget.Injectable });\n-SomeProviderImpl.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: SomeProviderImpl, factory: SomeProviderImpl.ɵfac });\n+SomeProviderImpl.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: SomeProviderImpl });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(SomeProviderImpl, [{\n         type: Injectable\n     }], null, null); })();\n@@ -284,6 +274,55 @@ SomeProviderImpl.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: SomePro\n  ****************************************************************************************************/\n export {};\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: providedin_forwardref.js\n+ ****************************************************************************************************/\n+import { forwardRef, Injectable, NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class Dep {\n+}\n+Dep.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Dep, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n+Dep.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Dep });\n+(function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(Dep, [{\n+        type: Injectable\n+    }], null, null); })();\n+export class Service {\n+    constructor(dep) { }\n+}\n+Service.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Service, deps: [{ token: Dep }], target: i0.ɵɵFactoryTarget.Injectable });\n+Service.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Service, providedIn: i0.forwardRef(function () { return Mod; }) });\n+(function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(Service, [{\n+        type: Injectable,\n+        args: [{ providedIn: forwardRef(() => Mod) }]\n+    }], function () { return [{ type: Dep }]; }, null); })();\n+export class Mod {\n+}\n+Mod.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Mod, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\n+Mod.ɵmod = i0.ɵɵngDeclareNgModule({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Mod });\n+Mod.ɵinj = i0.ɵɵngDeclareInjector({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Mod });\n+(function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(Mod, [{\n+        type: NgModule\n+    }], null, null); })();\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: providedin_forwardref.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class Dep {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<Dep, never>;\n+    static ɵprov: i0.ɵɵInjectableDeclaration<Dep>;\n+}\n+export declare class Service {\n+    constructor(dep: Dep);\n+    static ɵfac: i0.ɵɵFactoryDeclaration<Service, never>;\n+    static ɵprov: i0.ɵɵInjectableDeclaration<Service>;\n+}\n+export declare class Mod {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<Mod, never>;\n+    static ɵmod: i0.ɵɵNgModuleDeclaration<Mod, never, never, never>;\n+    static ɵinj: i0.ɵɵInjectorDeclaration<Mod>;\n+}\n+\n /****************************************************************************************************\n  * PARTIAL FILE: pipe_and_injectable.js\n  ****************************************************************************************************/\n@@ -292,7 +331,7 @@ import * as i0 from \"@angular/core\";\n class Service {\n }\n Service.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Service, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\n-Service.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: Service, factory: Service.ɵfac });\n+Service.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: Service });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(Service, [{\n         type: Injectable\n     }], null, null); })();\n@@ -304,7 +343,7 @@ export class MyPipe {\n }\n MyPipe.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyPipe, deps: [{ token: Service }], target: i0.ɵɵFactoryTarget.Pipe });\n MyPipe.ɵpipe = i0.ɵɵngDeclarePipe({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyPipe, name: \"myPipe\" });\n-MyPipe.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyPipe, factory: MyPipe.ɵfac });\n+MyPipe.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyPipe });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyPipe, [{\n         type: Injectable\n     }, {\n@@ -319,7 +358,7 @@ export class MyOtherPipe {\n }\n MyOtherPipe.ɵfac = i0.ɵɵngDeclareFactory({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyOtherPipe, deps: [{ token: Service }], target: i0.ɵɵFactoryTarget.Pipe });\n MyOtherPipe.ɵpipe = i0.ɵɵngDeclarePipe({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyOtherPipe, name: \"myOtherPipe\" });\n-MyOtherPipe.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: MyOtherPipe, factory: MyOtherPipe.ɵfac });\n+MyOtherPipe.ɵprov = i0.ɵɵngDeclareInjectable({ version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyOtherPipe });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyOtherPipe, [{\n         type: Pipe,\n         args: [{ name: 'myOtherPipe' }]"
        },
        {
            "sha": "33a537c242d62da47e1ab2a65a37b1bc55e5eaca",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_di/di/TEST_CASES.json",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2FTEST_CASES.json?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -137,6 +137,20 @@\n         }\n       ]\n     },\n+    {\n+      \"description\": \"should support forward refs in a providedIn clause\",\n+      \"inputFiles\": [\n+        \"providedin_forwardref.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"failureMessage\": \"Incorrect factory definition\",\n+          \"files\": [\n+            \"providedin_forwardref.js\"\n+          ]\n+        }\n+      ]\n+    },\n     {\n       \"description\": \"should have the pipe factory take precedence over the injectable factory, if a class has multiple decorators\",\n       \"inputFiles\": ["
        },
        {
            "sha": "7af903b521b86d861114af3ae3cb40033de768a0",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_di/di/providedin_forwardref.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fprovidedin_forwardref.js",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fprovidedin_forwardref.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fprovidedin_forwardref.js?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -0,0 +1,8 @@\n+Service.ɵfac = function Service_Factory(t) { return new (t || Service)($i0$.ɵɵinject(Dep)); };\n+Service.ɵprov = /*@__PURE__*/ $i0$.ɵɵdefineInjectable({ token: Service, factory: Service.ɵfac, providedIn: $i0$.forwardRef(function () { return Mod; }) });\n+(function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && $i0$.ɵsetClassMetadata(Service, [{\n+  type: Injectable,\n+  args: [{ providedIn: forwardRef(() => Mod) }]\n+}], function () { return [{ type: Dep }]; }, null); })();\n+export class Mod {\n+}"
        },
        {
            "sha": "03669fca444fb0a288e7e75dd11467d167515c46",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_di/di/providedin_forwardref.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fprovidedin_forwardref.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fprovidedin_forwardref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_di%2Fdi%2Fprovidedin_forwardref.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -0,0 +1,12 @@\n+import {forwardRef, Injectable, NgModule} from '@angular/core';\n+\n+@Injectable()\n+export class Dep {\n+}\n+@Injectable({providedIn: forwardRef(() => Mod)})\n+export class Service {\n+  constructor(dep: Dep) {}\n+}\n+@NgModule()\n+export class Mod {\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "cf8700ab67d199d2b9d507471941bd148ceb8d9a",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -208,11 +208,11 @@ function allTests(os: string) {\n       expect(jsContents)\n           .toContain(\n               'Service.ɵfac = function Service_Factory(t) { return new (t || Service)(i0.ɵɵinject(Dep)); };');\n-      expect(jsContents).toContain('providedIn: forwardRef(function () { return Mod; }) })');\n+      expect(jsContents).toContain('providedIn: i0.forwardRef(function () { return Mod; }) })');\n       expect(jsContents).not.toContain('__decorate');\n       const dtsContents = env.getContents('test.d.ts');\n-      expect(dtsContents).toContain('static ɵprov: i0.ɵɵInjectableDef<Dep>;');\n-      expect(dtsContents).toContain('static ɵprov: i0.ɵɵInjectableDef<Service>;');\n+      expect(dtsContents).toContain('static ɵprov: i0.ɵɵInjectableDeclaration<Dep>;');\n+      expect(dtsContents).toContain('static ɵprov: i0.ɵɵInjectableDeclaration<Service>;');\n       expect(dtsContents).toContain('static ɵfac: i0.ɵɵFactoryDeclaration<Dep, never>;');\n       expect(dtsContents).toContain('static ɵfac: i0.ɵɵFactoryDeclaration<Service, never>;');\n       expect(dtsContents).toContain('i0.ɵɵFactoryDeclaration<Mod, never>;');"
        },
        {
            "sha": "b111371da61b11412c95c479dfe49da67601413a",
            "filename": "packages/compiler/src/compile_metadata.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Fcompile_metadata.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Fcompile_metadata.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompile_metadata.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -36,6 +36,11 @@ export function identifierName(compileIdentifier: CompileIdentifierMetadata|null\n   if (ref['__anonymousType']) {\n     return ref['__anonymousType'];\n   }\n+  if (ref['__forward_ref__']) {\n+    // We do not want to try to stringify a `forwardRef()` function because that would cause the\n+    // inner function to be evaluated too early, defeating the whole point of the `forwardRef`.\n+    return '__forward_ref__';\n+  }\n   let identifier = stringify(ref);\n   if (identifier.indexOf('(') >= 0) {\n     // case: anonymous functions!"
        },
        {
            "sha": "89668ee82e845b20c58221a10cd900bc94766db2",
            "filename": "packages/compiler/src/compiler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -107,6 +107,7 @@ export {compileComponentFromMetadata, compileDirectiveFromMetadata, parseHostBin\n export {compileDeclareComponentFromMetadata} from './render3/partial/component';\n export {compileDeclareDirectiveFromMetadata} from './render3/partial/directive';\n export {compileDeclareFactoryFunction} from './render3/partial/factory';\n+export {compileDeclareInjectableFromMetadata} from './render3/partial/injectable';\n export {compileDeclareInjectorFromMetadata} from './render3/partial/injector';\n export {compileDeclareNgModuleFromMetadata} from './render3/partial/ng_module';\n export {compileDeclarePipeFromMetadata} from './render3/partial/pipe';"
        },
        {
            "sha": "3bfb7d2fc1682d9921a9c4f4a0d22ef62076e285",
            "filename": "packages/compiler/src/compiler_facade_interface.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 28,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -33,6 +33,8 @@ export interface CompilerFacade {\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, declaration: R3DeclarePipeFacade): any;\n   compileInjectable(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3InjectableMetadataFacade): any;\n+  compileInjectableDeclaration(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3DeclareInjectableFacade): any;\n   compileInjector(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3InjectorMetadataFacade): any;\n   compileInjectorDeclaration(\n@@ -80,7 +82,9 @@ export type StringMapWithRename = {\n   [key: string]: string|[string, string];\n };\n \n-export type Provider = any;\n+export type Provider = unknown;\n+export type Type = Function;\n+export type OpaqueValue = unknown;\n \n export enum FactoryTarget {\n   Directive = 0,\n@@ -91,7 +95,7 @@ export enum FactoryTarget {\n }\n \n export interface R3DependencyMetadataFacade {\n-  token: unknown;\n+  token: OpaqueValue;\n   attribute: string|null;\n   host: boolean;\n   optional: boolean;\n@@ -100,7 +104,7 @@ export interface R3DependencyMetadataFacade {\n }\n \n export interface R3DeclareDependencyMetadataFacade {\n-  token: unknown;\n+  token: OpaqueValue;\n   attribute?: boolean;\n   host?: boolean;\n   optional?: boolean;\n@@ -110,25 +114,25 @@ export interface R3DeclareDependencyMetadataFacade {\n \n export interface R3PipeMetadataFacade {\n   name: string;\n-  type: any;\n+  type: Type;\n   pipeName: string;\n   pure: boolean;\n }\n \n export interface R3InjectableMetadataFacade {\n   name: string;\n-  type: any;\n+  type: Type;\n   typeArgumentCount: number;\n-  providedIn: any;\n-  useClass?: any;\n-  useFactory?: any;\n-  useExisting?: any;\n-  useValue?: any;\n-  userDeps?: R3DependencyMetadataFacade[];\n+  providedIn?: Type|'root'|'platform'|'any'|null;\n+  useClass?: OpaqueValue;\n+  useFactory?: OpaqueValue;\n+  useExisting?: OpaqueValue;\n+  useValue?: OpaqueValue;\n+  deps?: R3DependencyMetadataFacade[];\n }\n \n export interface R3NgModuleMetadataFacade {\n-  type: any;\n+  type: Type;\n   bootstrap: Function[];\n   declarations: Function[];\n   imports: Function[];\n@@ -139,19 +143,19 @@ export interface R3NgModuleMetadataFacade {\n \n export interface R3InjectorMetadataFacade {\n   name: string;\n-  type: any;\n-  providers: any[];\n-  imports: any[];\n+  type: Type;\n+  providers: Provider[];\n+  imports: OpaqueValue[];\n }\n \n export interface R3DirectiveMetadataFacade {\n   name: string;\n-  type: any;\n+  type: Type;\n   typeSourceSpan: ParseSourceSpan;\n   selector: string|null;\n   queries: R3QueryMetadataFacade[];\n   host: {[key: string]: string};\n-  propMetadata: {[key: string]: any[]};\n+  propMetadata: {[key: string]: OpaqueValue[]};\n   lifecycle: {usesOnChanges: boolean;};\n   inputs: string[];\n   outputs: string[];\n@@ -164,7 +168,7 @@ export interface R3DirectiveMetadataFacade {\n export interface R3ComponentMetadataFacade extends R3DirectiveMetadataFacade {\n   template: string;\n   preserveWhitespaces: boolean;\n-  animations: any[]|undefined;\n+  animations: OpaqueValue[]|undefined;\n   pipes: Map<string, any>;\n   directives: R3UsedDirectiveMetadata[];\n   styles: string[];\n@@ -174,11 +178,9 @@ export interface R3ComponentMetadataFacade extends R3DirectiveMetadataFacade {\n   changeDetection?: ChangeDetectionStrategy;\n }\n \n-export type OpaqueValue = unknown;\n-\n export interface R3DeclareDirectiveFacade {\n   selector?: string;\n-  type: Function;\n+  type: Type;\n   inputs?: {[classPropertyName: string]: string|[string, string]};\n   outputs?: {[classPropertyName: string]: string};\n   host?: {\n@@ -229,18 +231,28 @@ export interface R3UsedDirectiveMetadata {\n \n export interface R3FactoryDefMetadataFacade {\n   name: string;\n-  type: any;\n+  type: Type;\n   typeArgumentCount: number;\n   deps: R3DependencyMetadataFacade[]|null;\n   target: FactoryTarget;\n }\n \n export interface R3DeclareFactoryFacade {\n-  type: Function;\n+  type: Type;\n   deps: R3DeclareDependencyMetadataFacade[]|null;\n   target: FactoryTarget;\n }\n \n+export interface R3DeclareInjectableFacade {\n+  type: Type;\n+  providedIn?: Type|'root'|'platform'|'any'|null;\n+  useClass?: OpaqueValue;\n+  useFactory?: OpaqueValue;\n+  useExisting?: OpaqueValue;\n+  useValue?: OpaqueValue;\n+  deps?: R3DeclareDependencyMetadataFacade[];\n+}\n+\n export enum ViewEncapsulation {\n   Emulated = 0,\n   // Historically the 1 value was for `Native` encapsulation which has been removed as of v11.\n@@ -253,10 +265,10 @@ export type ChangeDetectionStrategy = number;\n export interface R3QueryMetadataFacade {\n   propertyName: string;\n   first: boolean;\n-  predicate: any|string[];\n+  predicate: OpaqueValue|string[];\n   descendants: boolean;\n   emitDistinctChangesOnly: boolean;\n-  read: any|null;\n+  read: OpaqueValue|null;\n   static: boolean;\n }\n \n@@ -271,13 +283,13 @@ export interface R3DeclareQueryMetadataFacade {\n }\n \n export interface R3DeclareInjectorFacade {\n-  type: Function;\n+  type: Type;\n   imports?: OpaqueValue[];\n   providers?: OpaqueValue[];\n }\n \n export interface R3DeclareNgModuleFacade {\n-  type: Function;\n+  type: Type;\n   bootstrap?: OpaqueValue[]|(() => OpaqueValue[]);\n   declarations?: OpaqueValue[]|(() => OpaqueValue[]);\n   imports?: OpaqueValue[]|(() => OpaqueValue[]);\n@@ -287,7 +299,7 @@ export interface R3DeclareNgModuleFacade {\n }\n \n export interface R3DeclarePipeFacade {\n-  type: Function;\n+  type: Type;\n   name: string;\n   pure?: boolean;\n }"
        },
        {
            "sha": "1855614334b7022c81e12d64c64c659232da1222",
            "filename": "packages/compiler/src/identifiers.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Fidentifiers.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Fidentifiers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fidentifiers.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -66,9 +66,6 @@ export class Identifiers {\n   static directiveInject: o.ExternalReference = {name: 'ɵɵdirectiveInject', moduleName: CORE};\n   static INJECTOR: o.ExternalReference = {name: 'INJECTOR', moduleName: CORE};\n   static Injector: o.ExternalReference = {name: 'Injector', moduleName: CORE};\n-  static ɵɵdefineInjectable: o.ExternalReference = {name: 'ɵɵdefineInjectable', moduleName: CORE};\n-  static InjectableDeclaration:\n-      o.ExternalReference = {name: 'ɵɵInjectableDeclaration', moduleName: CORE};\n   static ViewEncapsulation: o.ExternalReference = {\n     name: 'ViewEncapsulation',\n     moduleName: CORE,"
        },
        {
            "sha": "533577a6ddb0c7e790b12aafabc312048cdb5c68",
            "filename": "packages/compiler/src/injectable_compiler.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Finjectable_compiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Finjectable_compiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Finjectable_compiler.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -7,16 +7,14 @@\n  */\n \n import {StaticSymbol} from './aot/static_symbol';\n-import {CompileInjectableMetadata, CompileNgModuleMetadata, CompileProviderMetadata, identifierName} from './compile_metadata';\n+import {CompileInjectableMetadata, identifierName} from './compile_metadata';\n import {CompileReflector} from './compile_reflector';\n-import {InjectFlags, NodeFlags} from './core';\n+import {InjectFlags} from './core';\n import {Identifiers} from './identifiers';\n import * as o from './output/output_ast';\n import {convertValueToOutputAst} from './output/value_util';\n-import {typeSourceSpan} from './parse_util';\n-import {NgModuleProviderAnalyzer} from './provider_analyzer';\n+import {Identifiers as R3} from './render3/r3_identifiers';\n import {OutputContext} from './util';\n-import {componentFactoryResolverProviderDef, depDef, providerDef} from './view_compiler/provider_compiler';\n \n type MapEntry = {\n   key: string,\n@@ -116,8 +114,7 @@ export class InjectableCompiler {\n       mapEntry('token', ctx.importExpr(injectable.type.reference)),\n       mapEntry('providedIn', providedIn),\n     ];\n-    return o.importExpr(Identifiers.ɵɵdefineInjectable)\n-        .callFn([o.literalMap(def)], undefined, true);\n+    return o.importExpr(R3.ɵɵdefineInjectable).callFn([o.literalMap(def)], undefined, true);\n   }\n \n   compile(injectable: CompileInjectableMetadata, ctx: OutputContext): void {"
        },
        {
            "sha": "d845e7e56f9a8973d54e3f1582bbc1d8a221e0a4",
            "filename": "packages/compiler/src/injectable_compiler_2.ts",
            "status": "modified",
            "additions": 109,
            "deletions": 44,
            "changes": 153,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Finjectable_compiler_2.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Finjectable_compiler_2.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Finjectable_compiler_2.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -6,32 +6,62 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Identifiers} from './identifiers';\n import * as o from './output/output_ast';\n+import {generateForwardRef} from './render3/partial/util';\n import {compileFactoryFunction, FactoryTarget, R3DependencyMetadata, R3FactoryDelegateType, R3FactoryMetadata} from './render3/r3_factory';\n-import {R3Reference, typeWithParameters} from './render3/util';\n+import {Identifiers} from './render3/r3_identifiers';\n+import {R3CompiledExpression, R3Reference, typeWithParameters} from './render3/util';\n import {DefinitionMap} from './render3/view/util';\n \n-export interface InjectableDef {\n-  expression: o.Expression;\n-  type: o.Type;\n-  statements: o.Statement[];\n-}\n-\n export interface R3InjectableMetadata {\n   name: string;\n   type: R3Reference;\n   internalType: o.Expression;\n   typeArgumentCount: number;\n-  providedIn: o.Expression;\n-  useClass?: o.Expression;\n+  providedIn: R3ProviderExpression;\n+  useClass?: R3ProviderExpression;\n   useFactory?: o.Expression;\n-  useExisting?: o.Expression;\n-  useValue?: o.Expression;\n-  userDeps?: R3DependencyMetadata[];\n+  useExisting?: R3ProviderExpression;\n+  useValue?: R3ProviderExpression;\n+  deps?: R3DependencyMetadata[];\n+}\n+\n+/**\n+ * An expression used when instantiating an injectable.\n+ *\n+ * This is the type of the `useClass`, `useExisting` and `useValue` properties of\n+ * `R3InjectableMetadata` since those can refer to types that may eagerly reference types that have\n+ * not yet been defined.\n+ */\n+export interface R3ProviderExpression<T extends o.Expression = o.Expression> {\n+  /**\n+   * The expression that is used to instantiate the Injectable.\n+   */\n+  expression: T;\n+  /**\n+   * If true, then the `expression` contains a reference to something that has not yet been\n+   * defined.\n+   *\n+   * This means that the expression must not be eagerly evaluated. Instead it must be wrapped in a\n+   * function closure that will be evaluated lazily to allow the definition of the expression to be\n+   * evaluated first.\n+   *\n+   * In some cases the expression will naturally be placed inside such a function closure, such as\n+   * in a fully compiled factory function. In those case nothing more needs to be done.\n+   *\n+   * But in other cases, such as partial-compilation the expression will be located in top level\n+   * code so will need to be wrapped in a function that is passed to a `forwardRef()` call.\n+   */\n+  isForwardRef: boolean;\n }\n \n-export function compileInjectable(meta: R3InjectableMetadata): InjectableDef {\n+export function createR3ProviderExpression<T extends o.Expression>(\n+    expression: T, isForwardRef: boolean): R3ProviderExpression<T> {\n+  return {expression, isForwardRef};\n+}\n+\n+export function compileInjectable(\n+    meta: R3InjectableMetadata, resolveForwardRefs: boolean): R3CompiledExpression {\n   let result: {expression: o.Expression, statements: o.Statement[]}|null = null;\n \n   const factoryMeta: R3FactoryMetadata = {\n@@ -51,32 +81,36 @@ export function compileInjectable(meta: R3InjectableMetadata): InjectableDef {\n     // A special case exists for useClass: Type where Type is the injectable type itself and no\n     // deps are specified, in which case 'useClass' is effectively ignored.\n \n-    const useClassOnSelf = meta.useClass.isEquivalent(meta.internalType);\n+    const useClassOnSelf = meta.useClass.expression.isEquivalent(meta.internalType);\n     let deps: R3DependencyMetadata[]|undefined = undefined;\n-    if (meta.userDeps !== undefined) {\n-      deps = meta.userDeps;\n+    if (meta.deps !== undefined) {\n+      deps = meta.deps;\n     }\n \n     if (deps !== undefined) {\n       // factory: () => new meta.useClass(...deps)\n       result = compileFactoryFunction({\n         ...factoryMeta,\n-        delegate: meta.useClass,\n+        delegate: meta.useClass.expression,\n         delegateDeps: deps,\n         delegateType: R3FactoryDelegateType.Class,\n       });\n     } else if (useClassOnSelf) {\n       result = compileFactoryFunction(factoryMeta);\n     } else {\n-      result = delegateToFactory(\n-          meta.type.value as o.WrappedNodeExpr<any>, meta.useClass as o.WrappedNodeExpr<any>);\n+      result = {\n+        statements: [],\n+        expression: delegateToFactory(\n+            meta.type.value as o.WrappedNodeExpr<any>,\n+            meta.useClass.expression as o.WrappedNodeExpr<any>, resolveForwardRefs)\n+      };\n     }\n   } else if (meta.useFactory !== undefined) {\n-    if (meta.userDeps !== undefined) {\n+    if (meta.deps !== undefined) {\n       result = compileFactoryFunction({\n         ...factoryMeta,\n         delegate: meta.useFactory,\n-        delegateDeps: meta.userDeps || [],\n+        delegateDeps: meta.deps || [],\n         delegateType: R3FactoryDelegateType.Function,\n       });\n     } else {\n@@ -91,17 +125,21 @@ export function compileInjectable(meta: R3InjectableMetadata): InjectableDef {\n     // value is undefined.\n     result = compileFactoryFunction({\n       ...factoryMeta,\n-      expression: meta.useValue,\n+      expression: meta.useValue.expression,\n     });\n   } else if (meta.useExisting !== undefined) {\n     // useExisting is an `inject` call on the existing token.\n     result = compileFactoryFunction({\n       ...factoryMeta,\n-      expression: o.importExpr(Identifiers.inject).callFn([meta.useExisting]),\n+      expression: o.importExpr(Identifiers.inject).callFn([meta.useExisting.expression]),\n     });\n   } else {\n-    result = delegateToFactory(\n-        meta.type.value as o.WrappedNodeExpr<any>, meta.internalType as o.WrappedNodeExpr<any>);\n+    result = {\n+      statements: [],\n+      expression: delegateToFactory(\n+          meta.type.value as o.WrappedNodeExpr<any>, meta.internalType as o.WrappedNodeExpr<any>,\n+          resolveForwardRefs)\n+    };\n   }\n \n   const token = meta.internalType;\n@@ -112,32 +150,59 @@ export function compileInjectable(meta: R3InjectableMetadata): InjectableDef {\n   injectableProps.set('factory', result.expression);\n \n   // Only generate providedIn property if it has a non-null value\n-  if ((meta.providedIn as o.LiteralExpr).value !== null) {\n-    injectableProps.set('providedIn', meta.providedIn);\n+  if ((meta.providedIn.expression as o.LiteralExpr).value !== null) {\n+    injectableProps.set(\n+        'providedIn',\n+        meta.providedIn.isForwardRef ? generateForwardRef(meta.providedIn.expression) :\n+                                       meta.providedIn.expression);\n   }\n \n   const expression = o.importExpr(Identifiers.ɵɵdefineInjectable)\n                          .callFn([injectableProps.toLiteralMap()], undefined, true);\n-  const type = new o.ExpressionType(o.importExpr(\n-      Identifiers.InjectableDeclaration,\n-      [typeWithParameters(meta.type.type, meta.typeArgumentCount)]));\n-\n   return {\n     expression,\n-    type,\n+    type: createInjectableType(meta),\n     statements: result.statements,\n   };\n }\n \n-function delegateToFactory(type: o.WrappedNodeExpr<any>, internalType: o.WrappedNodeExpr<any>) {\n-  return {\n-    statements: [],\n-    // If types are the same, we can generate `factory: type.ɵfac`\n-    // If types are different, we have to generate a wrapper function to ensure\n-    // the internal type has been resolved (`factory: function(t) { return type.ɵfac(t); }`)\n-    expression: type.node === internalType.node ?\n-        internalType.prop('ɵfac') :\n-        o.fn([new o.FnParam('t', o.DYNAMIC_TYPE)], [new o.ReturnStatement(internalType.callMethod(\n-                                                       'ɵfac', [o.variable('t')]))])\n-  };\n+export function createInjectableType(meta: R3InjectableMetadata) {\n+  return new o.ExpressionType(o.importExpr(\n+      Identifiers.InjectableDeclaration,\n+      [typeWithParameters(meta.type.type, meta.typeArgumentCount)]));\n+}\n+\n+function delegateToFactory(\n+    type: o.WrappedNodeExpr<any>, internalType: o.WrappedNodeExpr<any>,\n+    unwrapForwardRefs: boolean): o.Expression {\n+  if (type.node === internalType.node) {\n+    // The types are the same, so we can simply delegate directly to the type's factory.\n+    // ```\n+    // factory: type.ɵfac\n+    // ```\n+    return internalType.prop('ɵfac');\n+  }\n+\n+  if (!unwrapForwardRefs) {\n+    // The type is not wrapped in a `forwardRef()`, so we create a simple factory function that\n+    // accepts a sub-type as an argument.\n+    // ```\n+    // factory: function(t) { return internalType.ɵfac(t); }\n+    // ```\n+    return createFactoryFunction(internalType);\n+  }\n+\n+  // The internalType is actually wrapped in a `forwardRef()` so we need to resolve that before\n+  // calling its factory.\n+  // ```\n+  // factory: function(t) { return core.resolveForwardRef(type).ɵfac(t); }\n+  // ```\n+  const unwrappedType = o.importExpr(Identifiers.resolveForwardRef).callFn([internalType]);\n+  return createFactoryFunction(unwrappedType);\n+}\n+\n+function createFactoryFunction(type: o.Expression): o.FunctionExpr {\n+  return o.fn(\n+      [new o.FnParam('t', o.DYNAMIC_TYPE)],\n+      [new o.ReturnStatement(type.callMethod('ɵfac', [o.variable('t')]))]);\n }"
        },
        {
            "sha": "9e4033cffe155816f333778be0bddaa3f3f333c4",
            "filename": "packages/compiler/src/jit_compiler_facade.ts",
            "status": "modified",
            "additions": 60,
            "deletions": 21,
            "changes": 81,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -7,10 +7,10 @@\n  */\n \n \n-import {CompilerFacade, CoreEnvironment, ExportedCompilerFacade, OpaqueValue, R3ComponentMetadataFacade, R3DeclareComponentFacade, R3DeclareDependencyMetadataFacade, R3DeclareDirectiveFacade, R3DeclareFactoryFacade, R3DeclareInjectorFacade, R3DeclareNgModuleFacade, R3DeclarePipeFacade, R3DeclareQueryMetadataFacade, R3DeclareUsedDirectiveFacade, R3DependencyMetadataFacade, R3DirectiveMetadataFacade, R3FactoryDefMetadataFacade, R3InjectableMetadataFacade, R3InjectorMetadataFacade, R3NgModuleMetadataFacade, R3PipeMetadataFacade, R3QueryMetadataFacade, StringMap, StringMapWithRename} from './compiler_facade_interface';\n+import {CompilerFacade, CoreEnvironment, ExportedCompilerFacade, OpaqueValue, R3ComponentMetadataFacade, R3DeclareComponentFacade, R3DeclareDependencyMetadataFacade, R3DeclareDirectiveFacade, R3DeclareFactoryFacade, R3DeclareInjectableFacade, R3DeclareInjectorFacade, R3DeclareNgModuleFacade, R3DeclarePipeFacade, R3DeclareQueryMetadataFacade, R3DeclareUsedDirectiveFacade, R3DependencyMetadataFacade, R3DirectiveMetadataFacade, R3FactoryDefMetadataFacade, R3InjectableMetadataFacade, R3InjectorMetadataFacade, R3NgModuleMetadataFacade, R3PipeMetadataFacade, R3QueryMetadataFacade, StringMap, StringMapWithRename} from './compiler_facade_interface';\n import {ConstantPool} from './constant_pool';\n-import {ChangeDetectionStrategy, HostBinding, HostListener, Input, Output, Type, ViewEncapsulation} from './core';\n-import {compileInjectable} from './injectable_compiler_2';\n+import {ChangeDetectionStrategy, HostBinding, HostListener, Input, Output, ViewEncapsulation} from './core';\n+import {compileInjectable, createR3ProviderExpression, R3ProviderExpression} from './injectable_compiler_2';\n import {DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig} from './ml_parser/interpolation_config';\n import {DeclareVarStmt, Expression, literal, LiteralExpr, Statement, StmtModifier, WrappedNodeExpr} from './output/output_ast';\n import {JitEvaluator} from './output/output_jit';\n@@ -60,18 +60,41 @@ export class CompilerFacadeImpl implements CompilerFacade {\n   compileInjectable(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string,\n       facade: R3InjectableMetadataFacade): any {\n-    const {expression, statements} = compileInjectable({\n-      name: facade.name,\n-      type: wrapReference(facade.type),\n-      internalType: new WrappedNodeExpr(facade.type),\n-      typeArgumentCount: facade.typeArgumentCount,\n-      providedIn: computeProvidedIn(facade.providedIn),\n-      useClass: wrapExpression(facade, USE_CLASS),\n-      useFactory: wrapExpression(facade, USE_FACTORY),\n-      useValue: wrapExpression(facade, USE_VALUE),\n-      useExisting: wrapExpression(facade, USE_EXISTING),\n-      userDeps: convertR3DependencyMetadataArray(facade.userDeps) || undefined,\n-    });\n+    const {expression, statements} = compileInjectable(\n+        {\n+          name: facade.name,\n+          type: wrapReference(facade.type),\n+          internalType: new WrappedNodeExpr(facade.type),\n+          typeArgumentCount: facade.typeArgumentCount,\n+          providedIn: computeProvidedIn(facade.providedIn),\n+          useClass: convertToProviderExpression(facade, USE_CLASS),\n+          useFactory: wrapExpression(facade, USE_FACTORY),\n+          useValue: convertToProviderExpression(facade, USE_VALUE),\n+          useExisting: convertToProviderExpression(facade, USE_EXISTING),\n+          deps: facade.deps?.map(convertR3DependencyMetadata),\n+        },\n+        /* resolveForwardRefs */ true);\n+\n+    return this.jitExpression(expression, angularCoreEnv, sourceMapUrl, statements);\n+  }\n+\n+  compileInjectableDeclaration(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string,\n+      facade: R3DeclareInjectableFacade): any {\n+    const {expression, statements} = compileInjectable(\n+        {\n+          name: facade.type.name,\n+          type: wrapReference(facade.type),\n+          internalType: new WrappedNodeExpr(facade.type),\n+          typeArgumentCount: 0,\n+          providedIn: computeProvidedIn(facade.providedIn),\n+          useClass: convertToProviderExpression(facade, USE_CLASS),\n+          useFactory: wrapExpression(facade, USE_FACTORY),\n+          useValue: convertToProviderExpression(facade, USE_VALUE),\n+          useExisting: convertToProviderExpression(facade, USE_EXISTING),\n+          deps: facade.deps?.map(convertR3DeclareDependencyMetadata),\n+        },\n+        /* resolveForwardRefs */ true);\n \n     return this.jitExpression(expression, angularCoreEnv, sourceMapUrl, statements);\n   }\n@@ -446,22 +469,38 @@ function parseJitTemplate(\n type R3DirectiveMetadataFacadeNoPropAndWhitespace =\n     Pick<R3DirectiveMetadataFacade, Exclude<keyof R3DirectiveMetadataFacade, 'propMetadata'>>;\n \n-function wrapExpression(obj: any, property: string): WrappedNodeExpr<any>|undefined {\n+/**\n+ * Convert the expression, if present to an `R3ProviderExpression`.\n+ *\n+ * In JIT mode we do not want the compiler to wrap the expression in a `forwardRef()` call because,\n+ * if it is referencing a type that has not yet been defined, it will have already been wrapped in\n+ * a `forwardRef()` - either by the application developer or during partial-compilation. Thus we can\n+ * set `isForwardRef` to `false`.\n+ */\n+function convertToProviderExpression(obj: any, property: string): R3ProviderExpression|undefined {\n   if (obj.hasOwnProperty(property)) {\n-    return new WrappedNodeExpr(obj[property]);\n+    return createR3ProviderExpression(new WrappedNodeExpr(obj[property]), /* isForwardRef */ false);\n   } else {\n     return undefined;\n   }\n }\n \n-function computeProvidedIn(providedIn: Type|string|null|undefined): Expression {\n-  if (providedIn == null || typeof providedIn === 'string') {\n-    return new LiteralExpr(providedIn);\n+function wrapExpression(obj: any, property: string): WrappedNodeExpr<any>|undefined {\n+  if (obj.hasOwnProperty(property)) {\n+    return new WrappedNodeExpr(obj[property]);\n   } else {\n-    return new WrappedNodeExpr(providedIn);\n+    return undefined;\n   }\n }\n \n+function computeProvidedIn(providedIn: Function|string|null|undefined): R3ProviderExpression {\n+  const expression = (providedIn == null || typeof providedIn === 'string') ?\n+      new LiteralExpr(providedIn ?? null) :\n+      new WrappedNodeExpr(providedIn);\n+  // See `convertToProviderExpression()` for why `isForwardRef` is false.\n+  return createR3ProviderExpression(expression, /* isForwardRef */ false);\n+}\n+\n function convertR3DependencyMetadataArray(facades: R3DependencyMetadataFacade[]|null|\n                                           undefined): R3DependencyMetadata[]|null {\n   return facades == null ? null : facades.map(convertR3DependencyMetadata);"
        },
        {
            "sha": "5ea35f5e725f6afae23efe98c6f812db1b130364",
            "filename": "packages/compiler/src/render3/partial/api.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -367,6 +367,53 @@ export enum FactoryTarget {\n   NgModule = 4,\n }\n \n+/**\n+ * Describes the shape of the object that the `ɵɵngDeclareInjectable()` function accepts.\n+ *\n+ * This interface serves primarily as documentation, as conformance to this interface is not\n+ * enforced during linking.\n+ */\n+export interface R3DeclareInjectableMetadata extends R3PartialDeclaration {\n+  /**\n+   * If provided, specifies that the declared injectable belongs to a particular injector:\n+   * - `InjectorType` such as `NgModule`,\n+   * - `'root'` the root injector\n+   * - `'any'` all injectors.\n+   * If not provided, then it does not belong to any injector. Must be explicitly listed in the\n+   * providers of an injector.\n+   */\n+  providedIn?: o.Expression;\n+\n+  /**\n+   * If provided, an expression that evaluates to a class to use when creating an instance of this\n+   * injectable.\n+   */\n+  useClass?: o.Expression;\n+\n+  /**\n+   * If provided, an expression that evaluates to a function to use when creating an instance of\n+   * this injectable.\n+   */\n+  useFactory?: o.Expression;\n+\n+  /**\n+   * If provided, an expression that evaluates to a token of another injectable that this injectable\n+   * aliases.\n+   */\n+  useExisting?: o.Expression;\n+\n+  /**\n+   * If provided, an expression that evaluates to the value of the instance of this injectable.\n+   */\n+  useValue?: o.Expression;\n+\n+  /**\n+   * An array of dependencies to support instantiating this injectable via `useClass` or\n+   * `useFactory`.\n+   */\n+  deps?: R3DeclareDependencyMetadata[];\n+}\n+\n /**\n  * Metadata indicating how a dependency should be injected into a factory.\n  */"
        },
        {
            "sha": "693af7ed6232baf0e560194c2dd4653bff6090ea",
            "filename": "packages/compiler/src/render3/partial/component.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -18,7 +18,7 @@ import {DefinitionMap} from '../view/util';\n \n import {R3DeclareComponentMetadata, R3DeclareUsedDirectiveMetadata} from './api';\n import {createDirectiveDefinitionMap} from './directive';\n-import {toOptionalLiteralArray} from './util';\n+import {generateForwardRef, toOptionalLiteralArray} from './util';\n \n \n /**\n@@ -163,7 +163,3 @@ function compileUsedPipeMetadata(meta: R3ComponentMetadata): o.LiteralMapExpr|nu\n   }\n   return o.literalMap(entries);\n }\n-\n-function generateForwardRef(expr: o.Expression): o.Expression {\n-  return o.importExpr(R3.forwardRef).callFn([o.fn([], [new o.ReturnStatement(expr)])]);\n-}"
        },
        {
            "sha": "52654e46d6e07d4654a9198090702f0a933ff27b",
            "filename": "packages/compiler/src/render3/partial/factory.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 34,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Ffactory.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Ffactory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Ffactory.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -6,12 +6,13 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as o from '../../output/output_ast';\n-import {createFactoryType, FactoryTarget, R3DependencyMetadata, R3FactoryMetadata} from '../r3_factory';\n+import {createFactoryType, FactoryTarget, R3FactoryMetadata} from '../r3_factory';\n import {Identifiers as R3} from '../r3_identifiers';\n import {R3CompiledExpression} from '../util';\n import {DefinitionMap} from '../view/util';\n \n-import {R3DeclareDependencyMetadata, R3DeclareFactoryMetadata} from './api';\n+import {R3DeclareFactoryMetadata} from './api';\n+import {compileDependencies} from './util';\n \n export function compileDeclareFactoryFunction(meta: R3FactoryMetadata): R3CompiledExpression {\n   const definitionMap = new DefinitionMap<R3DeclareFactoryMetadata>();\n@@ -27,35 +28,3 @@ export function compileDeclareFactoryFunction(meta: R3FactoryMetadata): R3Compil\n     type: createFactoryType(meta),\n   };\n }\n-\n-function compileDependencies(deps: R3DependencyMetadata[]|'invalid'|null): o.LiteralExpr|\n-    o.LiteralArrayExpr {\n-  if (deps === 'invalid') {\n-    return o.literal('invalid');\n-  } else if (deps === null) {\n-    return o.literal(null);\n-  } else {\n-    return o.literalArr(deps.map(compileDependency));\n-  }\n-}\n-\n-function compileDependency(dep: R3DependencyMetadata): o.LiteralMapExpr {\n-  const depMeta = new DefinitionMap<R3DeclareDependencyMetadata>();\n-  depMeta.set('token', dep.token);\n-  if (dep.attributeNameType !== null) {\n-    depMeta.set('attribute', o.literal(true));\n-  }\n-  if (dep.host) {\n-    depMeta.set('host', o.literal(true));\n-  }\n-  if (dep.optional) {\n-    depMeta.set('optional', o.literal(true));\n-  }\n-  if (dep.self) {\n-    depMeta.set('self', o.literal(true));\n-  }\n-  if (dep.skipSelf) {\n-    depMeta.set('skipSelf', o.literal(true));\n-  }\n-  return depMeta.toLiteralMap();\n-}"
        },
        {
            "sha": "d7b3f47ed2c9167b9e8fe1bcb29ea9ccaeca671a",
            "filename": "packages/compiler/src/render3/partial/injectable.ts",
            "status": "added",
            "additions": 93,
            "deletions": 0,
            "changes": 93,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Finjectable.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Finjectable.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Finjectable.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -0,0 +1,93 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {createInjectableType, R3InjectableMetadata, R3ProviderExpression} from '../../injectable_compiler_2';\n+import * as o from '../../output/output_ast';\n+import {Identifiers as R3} from '../r3_identifiers';\n+import {R3CompiledExpression} from '../util';\n+import {DefinitionMap} from '../view/util';\n+\n+import {R3DeclareInjectableMetadata} from './api';\n+import {compileDependency, generateForwardRef} from './util';\n+\n+/**\n+ * Compile a Injectable declaration defined by the `R3InjectableMetadata`.\n+ */\n+export function compileDeclareInjectableFromMetadata(meta: R3InjectableMetadata):\n+    R3CompiledExpression {\n+  const definitionMap = createInjectableDefinitionMap(meta);\n+\n+  const expression = o.importExpr(R3.declareInjectable).callFn([definitionMap.toLiteralMap()]);\n+  const type = createInjectableType(meta);\n+\n+  return {expression, type, statements: []};\n+}\n+\n+/**\n+ * Gathers the declaration fields for a Injectable into a `DefinitionMap`.\n+ */\n+export function createInjectableDefinitionMap(meta: R3InjectableMetadata):\n+    DefinitionMap<R3DeclareInjectableMetadata> {\n+  const definitionMap = new DefinitionMap<R3DeclareInjectableMetadata>();\n+\n+  definitionMap.set('version', o.literal('0.0.0-PLACEHOLDER'));\n+  definitionMap.set('ngImport', o.importExpr(R3.core));\n+  definitionMap.set('type', meta.internalType);\n+\n+  // Only generate providedIn property if it has a non-null value\n+  if (meta.providedIn !== undefined) {\n+    const providedIn = convertFromProviderExpression(meta.providedIn);\n+    if ((providedIn as o.LiteralExpr).value !== null) {\n+      definitionMap.set('providedIn', providedIn);\n+    }\n+  }\n+\n+  if (meta.useClass !== undefined) {\n+    definitionMap.set('useClass', convertFromProviderExpression(meta.useClass));\n+  }\n+  if (meta.useExisting !== undefined) {\n+    definitionMap.set('useExisting', convertFromProviderExpression(meta.useExisting));\n+  }\n+  if (meta.useValue !== undefined) {\n+    definitionMap.set('useValue', convertFromProviderExpression(meta.useValue));\n+  }\n+  // Factories do not contain `ForwardRef`s since any types are already wrapped in a function call\n+  // so the types will not be eagerly evaluated. Therefore we do not need to process this expression\n+  // with `convertFromProviderExpression()`.\n+  if (meta.useFactory !== undefined) {\n+    definitionMap.set('useFactory', meta.useFactory);\n+  }\n+\n+  if (meta.deps !== undefined) {\n+    definitionMap.set('deps', o.literalArr(meta.deps.map(compileDependency)));\n+  }\n+\n+  return definitionMap;\n+}\n+\n+/**\n+ * Convert an `R3ProviderExpression` to an `Expression`, possibly wrapping its expression in a\n+ * `forwardRef()` call.\n+ *\n+ * If `R3ProviderExpression.isForwardRef` is true then the expression was originally wrapped in a\n+ * `forwardRef()` call to prevent the value from being eagerly evaluated in the code.\n+ *\n+ * Normally, the linker will statically process the code, putting the `expression` inside a factory\n+ * function so the `forwardRef()` wrapper is not evaluated before it has been defined. But if the\n+ * partial declaration is evaluated by the JIT compiler the `forwardRef()` call is still needed to\n+ * prevent eager evaluation of the `expression`.\n+ *\n+ * So in partial declarations, expressions that could be forward-refs are wrapped in `forwardRef()`\n+ * calls, and this is then unwrapped in the linker as necessary.\n+ *\n+ * See `packages/compiler-cli/src/ngtsc/annotations/src/injectable.ts` and\n+ * `packages/compiler/src/jit_compiler_facade.ts` for more information.\n+ */\n+function convertFromProviderExpression({expression, isForwardRef}: R3ProviderExpression):\n+    o.Expression {\n+  return isForwardRef ? generateForwardRef(expression) : expression;\n+}"
        },
        {
            "sha": "1f9db81f7bdbcf74ecf86a6135e21a5eb7f73e3e",
            "filename": "packages/compiler/src/render3/partial/injector.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Finjector.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Finjector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Finjector.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -22,6 +22,9 @@ export function compileDeclareInjectorFromMetadata(meta: R3InjectorMetadata): R3\n   return {expression, type, statements: []};\n }\n \n+/**\n+ * Gathers the declaration fields for an Injector into a `DefinitionMap`.\n+ */\n function createInjectorDefinitionMap(meta: R3InjectorMetadata):\n     DefinitionMap<R3DeclareInjectorMetadata> {\n   const definitionMap = new DefinitionMap<R3DeclareInjectorMetadata>();"
        },
        {
            "sha": "85e3d84a77932e0a35c4adfc6c0dc8516344cd2b",
            "filename": "packages/compiler/src/render3/partial/ng_module.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fng_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fng_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fng_module.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -23,6 +23,9 @@ export function compileDeclareNgModuleFromMetadata(meta: R3NgModuleMetadata): R3\n   return {expression, type, statements: []};\n }\n \n+/**\n+ * Gathers the declaration fields for an NgModule into a `DefinitionMap`.\n+ */\n function createNgModuleDefinitionMap(meta: R3NgModuleMetadata):\n     DefinitionMap<R3DeclareNgModuleMetadata> {\n   const definitionMap = new DefinitionMap<R3DeclareNgModuleMetadata>();"
        },
        {
            "sha": "8cad26992ff0e7837d4c22c681b5f6dda9a82e7d",
            "filename": "packages/compiler/src/render3/partial/pipe.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fpipe.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fpipe.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fpipe.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -26,8 +26,7 @@ export function compileDeclarePipeFromMetadata(meta: R3PipeMetadata): R3Compiled\n }\n \n /**\n- * Gathers the declaration fields for a Pipe into a `DefinitionMap`. This allows for reusing\n- * this logic for components, as they extend the Pipe metadata.\n+ * Gathers the declaration fields for a Pipe into a `DefinitionMap`.\n  */\n export function createPipeDefinitionMap(meta: R3PipeMetadata):\n     DefinitionMap<R3DeclarePipeMetadata> {"
        },
        {
            "sha": "3be414b160630784410ac76a9cf6dd6ff92cecbf",
            "filename": "packages/compiler/src/render3/partial/util.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Futil.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -6,6 +6,10 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as o from '../../output/output_ast';\n+import {R3DependencyMetadata} from '../r3_factory';\n+import {Identifiers} from '../r3_identifiers';\n+import {DefinitionMap} from '../view/util';\n+import {R3DeclareDependencyMetadata} from './api';\n \n /**\n  * Creates an array literal expression from the given array, mapping all values to an expression\n@@ -46,3 +50,48 @@ export function toOptionalLiteralMap<T>(\n     return null;\n   }\n }\n+\n+export function compileDependencies(deps: R3DependencyMetadata[]|'invalid'|null): o.LiteralExpr|\n+    o.LiteralArrayExpr {\n+  if (deps === 'invalid') {\n+    // The `deps` can be set to the string \"invalid\"  by the `unwrapConstructorDependencies()`\n+    // function, which tries to convert `ConstructorDeps` into `R3DependencyMetadata[]`.\n+    return o.literal('invalid');\n+  } else if (deps === null) {\n+    return o.literal(null);\n+  } else {\n+    return o.literalArr(deps.map(compileDependency));\n+  }\n+}\n+\n+export function compileDependency(dep: R3DependencyMetadata): o.LiteralMapExpr {\n+  const depMeta = new DefinitionMap<R3DeclareDependencyMetadata>();\n+  depMeta.set('token', dep.token);\n+  if (dep.attributeNameType !== null) {\n+    depMeta.set('attribute', o.literal(true));\n+  }\n+  if (dep.host) {\n+    depMeta.set('host', o.literal(true));\n+  }\n+  if (dep.optional) {\n+    depMeta.set('optional', o.literal(true));\n+  }\n+  if (dep.self) {\n+    depMeta.set('self', o.literal(true));\n+  }\n+  if (dep.skipSelf) {\n+    depMeta.set('skipSelf', o.literal(true));\n+  }\n+  return depMeta.toLiteralMap();\n+}\n+\n+/**\n+ * Generate an expression that has the given `expr` wrapped in the following form:\n+ *\n+ * ```\n+ * forwardRef(() => expr)\n+ * ```\n+ */\n+export function generateForwardRef(expr: o.Expression): o.Expression {\n+  return o.importExpr(Identifiers.forwardRef).callFn([o.fn([], [new o.ReturnStatement(expr)])]);\n+}"
        },
        {
            "sha": "f0636178dfac82205d76b70700664988feeeea94",
            "filename": "packages/compiler/src/render3/r3_identifiers.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_identifiers.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_identifiers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_identifiers.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -229,6 +229,11 @@ export class Identifiers {\n   static forwardRef: o.ExternalReference = {name: 'forwardRef', moduleName: CORE};\n   static resolveForwardRef: o.ExternalReference = {name: 'resolveForwardRef', moduleName: CORE};\n \n+  static ɵɵdefineInjectable: o.ExternalReference = {name: 'ɵɵdefineInjectable', moduleName: CORE};\n+  static declareInjectable: o.ExternalReference = {name: 'ɵɵngDeclareInjectable', moduleName: CORE};\n+  static InjectableDeclaration:\n+      o.ExternalReference = {name: 'ɵɵInjectableDeclaration', moduleName: CORE};\n+\n   static resolveWindow: o.ExternalReference = {name: 'ɵɵresolveWindow', moduleName: CORE};\n   static resolveDocument: o.ExternalReference = {name: 'ɵɵresolveDocument', moduleName: CORE};\n   static resolveBody: o.ExternalReference = {name: 'ɵɵresolveBody', moduleName: CORE};"
        },
        {
            "sha": "69cb4be6ae44c068ebe138d76f16316b731f70d0",
            "filename": "packages/compiler/test/compiler_facade_interface_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -76,6 +76,11 @@ const coreR3InjectableMetadataFacade: core.R3InjectableMetadataFacade =\n const compilerR3InjectableMetadataFacade: compiler.R3InjectableMetadataFacade =\n     null! as core.R3InjectableMetadataFacade;\n \n+const coreR3DeclareInjectableFacade: core.R3DeclareInjectableFacade =\n+    null! as compiler.R3DeclareInjectableFacade;\n+const compilerR3DeclareInjectableFacade: compiler.R3DeclareInjectableFacade =\n+    null! as core.R3DeclareInjectableFacade;\n+\n const coreR3NgModuleMetadataFacade: core.R3NgModuleMetadataFacade =\n     null! as compiler.R3NgModuleMetadataFacade;\n const compilerR3NgModuleMetadataFacade: compiler.R3NgModuleMetadataFacade ="
        },
        {
            "sha": "3bfb7d2fc1682d9921a9c4f4a0d22ef62076e285",
            "filename": "packages/core/src/compiler/compiler_facade_interface.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 28,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -33,6 +33,8 @@ export interface CompilerFacade {\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, declaration: R3DeclarePipeFacade): any;\n   compileInjectable(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3InjectableMetadataFacade): any;\n+  compileInjectableDeclaration(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3DeclareInjectableFacade): any;\n   compileInjector(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3InjectorMetadataFacade): any;\n   compileInjectorDeclaration(\n@@ -80,7 +82,9 @@ export type StringMapWithRename = {\n   [key: string]: string|[string, string];\n };\n \n-export type Provider = any;\n+export type Provider = unknown;\n+export type Type = Function;\n+export type OpaqueValue = unknown;\n \n export enum FactoryTarget {\n   Directive = 0,\n@@ -91,7 +95,7 @@ export enum FactoryTarget {\n }\n \n export interface R3DependencyMetadataFacade {\n-  token: unknown;\n+  token: OpaqueValue;\n   attribute: string|null;\n   host: boolean;\n   optional: boolean;\n@@ -100,7 +104,7 @@ export interface R3DependencyMetadataFacade {\n }\n \n export interface R3DeclareDependencyMetadataFacade {\n-  token: unknown;\n+  token: OpaqueValue;\n   attribute?: boolean;\n   host?: boolean;\n   optional?: boolean;\n@@ -110,25 +114,25 @@ export interface R3DeclareDependencyMetadataFacade {\n \n export interface R3PipeMetadataFacade {\n   name: string;\n-  type: any;\n+  type: Type;\n   pipeName: string;\n   pure: boolean;\n }\n \n export interface R3InjectableMetadataFacade {\n   name: string;\n-  type: any;\n+  type: Type;\n   typeArgumentCount: number;\n-  providedIn: any;\n-  useClass?: any;\n-  useFactory?: any;\n-  useExisting?: any;\n-  useValue?: any;\n-  userDeps?: R3DependencyMetadataFacade[];\n+  providedIn?: Type|'root'|'platform'|'any'|null;\n+  useClass?: OpaqueValue;\n+  useFactory?: OpaqueValue;\n+  useExisting?: OpaqueValue;\n+  useValue?: OpaqueValue;\n+  deps?: R3DependencyMetadataFacade[];\n }\n \n export interface R3NgModuleMetadataFacade {\n-  type: any;\n+  type: Type;\n   bootstrap: Function[];\n   declarations: Function[];\n   imports: Function[];\n@@ -139,19 +143,19 @@ export interface R3NgModuleMetadataFacade {\n \n export interface R3InjectorMetadataFacade {\n   name: string;\n-  type: any;\n-  providers: any[];\n-  imports: any[];\n+  type: Type;\n+  providers: Provider[];\n+  imports: OpaqueValue[];\n }\n \n export interface R3DirectiveMetadataFacade {\n   name: string;\n-  type: any;\n+  type: Type;\n   typeSourceSpan: ParseSourceSpan;\n   selector: string|null;\n   queries: R3QueryMetadataFacade[];\n   host: {[key: string]: string};\n-  propMetadata: {[key: string]: any[]};\n+  propMetadata: {[key: string]: OpaqueValue[]};\n   lifecycle: {usesOnChanges: boolean;};\n   inputs: string[];\n   outputs: string[];\n@@ -164,7 +168,7 @@ export interface R3DirectiveMetadataFacade {\n export interface R3ComponentMetadataFacade extends R3DirectiveMetadataFacade {\n   template: string;\n   preserveWhitespaces: boolean;\n-  animations: any[]|undefined;\n+  animations: OpaqueValue[]|undefined;\n   pipes: Map<string, any>;\n   directives: R3UsedDirectiveMetadata[];\n   styles: string[];\n@@ -174,11 +178,9 @@ export interface R3ComponentMetadataFacade extends R3DirectiveMetadataFacade {\n   changeDetection?: ChangeDetectionStrategy;\n }\n \n-export type OpaqueValue = unknown;\n-\n export interface R3DeclareDirectiveFacade {\n   selector?: string;\n-  type: Function;\n+  type: Type;\n   inputs?: {[classPropertyName: string]: string|[string, string]};\n   outputs?: {[classPropertyName: string]: string};\n   host?: {\n@@ -229,18 +231,28 @@ export interface R3UsedDirectiveMetadata {\n \n export interface R3FactoryDefMetadataFacade {\n   name: string;\n-  type: any;\n+  type: Type;\n   typeArgumentCount: number;\n   deps: R3DependencyMetadataFacade[]|null;\n   target: FactoryTarget;\n }\n \n export interface R3DeclareFactoryFacade {\n-  type: Function;\n+  type: Type;\n   deps: R3DeclareDependencyMetadataFacade[]|null;\n   target: FactoryTarget;\n }\n \n+export interface R3DeclareInjectableFacade {\n+  type: Type;\n+  providedIn?: Type|'root'|'platform'|'any'|null;\n+  useClass?: OpaqueValue;\n+  useFactory?: OpaqueValue;\n+  useExisting?: OpaqueValue;\n+  useValue?: OpaqueValue;\n+  deps?: R3DeclareDependencyMetadataFacade[];\n+}\n+\n export enum ViewEncapsulation {\n   Emulated = 0,\n   // Historically the 1 value was for `Native` encapsulation which has been removed as of v11.\n@@ -253,10 +265,10 @@ export type ChangeDetectionStrategy = number;\n export interface R3QueryMetadataFacade {\n   propertyName: string;\n   first: boolean;\n-  predicate: any|string[];\n+  predicate: OpaqueValue|string[];\n   descendants: boolean;\n   emitDistinctChangesOnly: boolean;\n-  read: any|null;\n+  read: OpaqueValue|null;\n   static: boolean;\n }\n \n@@ -271,13 +283,13 @@ export interface R3DeclareQueryMetadataFacade {\n }\n \n export interface R3DeclareInjectorFacade {\n-  type: Function;\n+  type: Type;\n   imports?: OpaqueValue[];\n   providers?: OpaqueValue[];\n }\n \n export interface R3DeclareNgModuleFacade {\n-  type: Function;\n+  type: Type;\n   bootstrap?: OpaqueValue[]|(() => OpaqueValue[]);\n   declarations?: OpaqueValue[]|(() => OpaqueValue[]);\n   imports?: OpaqueValue[]|(() => OpaqueValue[]);\n@@ -287,7 +299,7 @@ export interface R3DeclareNgModuleFacade {\n }\n \n export interface R3DeclarePipeFacade {\n-  type: Function;\n+  type: Type;\n   name: string;\n   pure?: boolean;\n }"
        },
        {
            "sha": "b7aba6b5fa8b026fa9ed3b029c19ae553ba2af6b",
            "filename": "packages/core/src/core_render3_private_export.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -272,6 +272,7 @@ export {\n   ɵɵngDeclareComponent,\n   ɵɵngDeclareDirective,\n   ɵɵngDeclareFactory,\n+  ɵɵngDeclareInjectable,\n   ɵɵngDeclareInjector,\n   ɵɵngDeclareNgModule,\n   ɵɵngDeclarePipe,"
        },
        {
            "sha": "d1402174ebbdeb21a78a5d7f8c17b4357f49b144",
            "filename": "packages/core/src/di/jit/environment.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Fsrc%2Fdi%2Fjit%2Fenvironment.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Fsrc%2Fdi%2Fjit%2Fenvironment.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fdi%2Fjit%2Fenvironment.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -5,6 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {resolveForwardRef} from '../forward_ref';\n import {ɵɵinject, ɵɵinvalidFactoryDep} from '../injector_compatibility';\n import {ɵɵdefineInjectable, ɵɵdefineInjector} from '../interface/defs';\n \n@@ -18,4 +19,5 @@ export const angularCoreDiEnv: {[name: string]: Function} = {\n   'ɵɵdefineInjector': ɵɵdefineInjector,\n   'ɵɵinject': ɵɵinject,\n   'ɵɵinvalidFactoryDep': ɵɵinvalidFactoryDep,\n+  'resolveForwardRef': resolveForwardRef,\n };"
        },
        {
            "sha": "f88f5bec1ae7f44db3d14cea0f4ea7f1aa8f0e07",
            "filename": "packages/core/src/di/jit/injectable.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 16,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Fsrc%2Fdi%2Fjit%2Finjectable.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Fsrc%2Fdi%2Fjit%2Finjectable.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fdi%2Fjit%2Finjectable.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -24,7 +24,7 @@ import {convertDependencies, reflectDependencies} from './util';\n  * Compile an Angular injectable according to its `Injectable` metadata, and patch the resulting\n  * injectable def (`ɵprov`) onto the injectable type.\n  */\n-export function compileInjectable(type: Type<any>, srcMeta?: Injectable): void {\n+export function compileInjectable(type: Type<any>, meta?: Injectable): void {\n   let ngInjectableDef: any = null;\n   let ngFactoryDef: any = null;\n \n@@ -34,8 +34,7 @@ export function compileInjectable(type: Type<any>, srcMeta?: Injectable): void {\n       get: () => {\n         if (ngInjectableDef === null) {\n           ngInjectableDef = getCompilerFacade().compileInjectable(\n-              angularCoreDiEnv, `ng:///${type.name}/ɵprov.js`,\n-              getInjectableMetadata(type, srcMeta));\n+              angularCoreDiEnv, `ng:///${type.name}/ɵprov.js`, getInjectableMetadata(type, meta));\n         }\n         return ngInjectableDef;\n       },\n@@ -47,12 +46,11 @@ export function compileInjectable(type: Type<any>, srcMeta?: Injectable): void {\n     Object.defineProperty(type, NG_FACTORY_DEF, {\n       get: () => {\n         if (ngFactoryDef === null) {\n-          const metadata = getInjectableMetadata(type, srcMeta);\n           const compiler = getCompilerFacade();\n           ngFactoryDef = compiler.compileFactory(angularCoreDiEnv, `ng:///${type.name}/ɵfac.js`, {\n-            name: metadata.name,\n-            type: metadata.type,\n-            typeArgumentCount: metadata.typeArgumentCount,\n+            name: type.name,\n+            type,\n+            typeArgumentCount: 0,  // In JIT mode types are not available nor used.\n             deps: reflectDependencies(type),\n             target: compiler.FactoryTarget.Injectable\n           });\n@@ -94,23 +92,19 @@ function getInjectableMetadata(type: Type<any>, srcMeta?: Injectable): R3Injecta\n     type: type,\n     typeArgumentCount: 0,\n     providedIn: meta.providedIn,\n-    userDeps: undefined,\n   };\n   if ((isUseClassProvider(meta) || isUseFactoryProvider(meta)) && meta.deps !== undefined) {\n-    compilerMeta.userDeps = convertDependencies(meta.deps);\n+    compilerMeta.deps = convertDependencies(meta.deps);\n   }\n+  // Check to see if the user explicitly provided a `useXxxx` property.\n   if (isUseClassProvider(meta)) {\n-    // The user explicitly specified useClass, and may or may not have provided deps.\n-    compilerMeta.useClass = resolveForwardRef(meta.useClass);\n+    compilerMeta.useClass = meta.useClass;\n   } else if (isUseValueProvider(meta)) {\n-    // The user explicitly specified useValue.\n-    compilerMeta.useValue = resolveForwardRef(meta.useValue);\n+    compilerMeta.useValue = meta.useValue;\n   } else if (isUseFactoryProvider(meta)) {\n-    // The user explicitly specified useFactory.\n     compilerMeta.useFactory = meta.useFactory;\n   } else if (isUseExistingProvider(meta)) {\n-    // The user explicitly specified useExisting.\n-    compilerMeta.useExisting = resolveForwardRef(meta.useExisting);\n+    compilerMeta.useExisting = meta.useExisting;\n   }\n   return compilerMeta;\n }"
        },
        {
            "sha": "840ef31f1b9ef6381370e89ca74888b91aa60822",
            "filename": "packages/core/src/render3/jit/partial.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {getCompilerFacade, R3DeclareComponentFacade, R3DeclareDirectiveFacade, R3DeclareFactoryFacade, R3DeclareInjectorFacade, R3DeclareNgModuleFacade, R3DeclarePipeFacade} from '../../compiler/compiler_facade';\n+import {getCompilerFacade, R3DeclareComponentFacade, R3DeclareDirectiveFacade, R3DeclareFactoryFacade, R3DeclareInjectableFacade, R3DeclareInjectorFacade, R3DeclareNgModuleFacade, R3DeclarePipeFacade} from '../../compiler/compiler_facade';\n import {angularCoreEnv} from './environment';\n \n /**\n@@ -42,6 +42,17 @@ export function ɵɵngDeclareFactory(decl: R3DeclareFactoryFacade): unknown {\n       angularCoreEnv, `ng:///${decl.type.name}/ɵfac.js`, decl);\n }\n \n+/**\n+ * Compiles a partial injectable declaration object into a full injectable definition object.\n+ *\n+ * @codeGenApi\n+ */\n+export function ɵɵngDeclareInjectable(decl: R3DeclareInjectableFacade): unknown {\n+  const compiler = getCompilerFacade();\n+  return compiler.compileInjectableDeclaration(\n+      angularCoreEnv, `ng:///${decl.type.name}/ɵprov.js`, decl);\n+}\n+\n /**\n  * These enums are used in the partial factory declaration calls.\n  */"
        },
        {
            "sha": "b2f0f043cc744d91cf6bbd4effc4c8f4074598ab",
            "filename": "packages/core/test/acceptance/providers_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Ftest%2Facceptance%2Fproviders_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Ftest%2Facceptance%2Fproviders_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fproviders_spec.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -657,8 +657,10 @@ describe('providers', () => {\n         constructor(public foo: SomeProvider) {}\n       }\n \n-      TestBed.configureTestingModule(\n-          {declarations: [App], providers: [{provide: SomeProvider, useClass: SomeProviderImpl}]});\n+      // We don't configure the `SomeProvider` in the TestingModule so that it uses the\n+      // tree-shakable provider given in the `@Injectable` decorator above, which makes use of the\n+      // `forwardRef()`.\n+      TestBed.configureTestingModule({declarations: [App]});\n       const fixture = TestBed.createComponent(App);\n       fixture.detectChanges();\n "
        },
        {
            "sha": "f4d0b312a799905c3f656c9916a4ed40ec420327",
            "filename": "packages/core/test/render3/jit/declare_injectable_spec.ts",
            "status": "added",
            "additions": 157,
            "deletions": 0,
            "changes": 157,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_injectable_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_injectable_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_injectable_spec.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -0,0 +1,157 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {forwardRef, InjectionToken, Injector, ɵcreateInjector, ɵsetCurrentInjector, ɵɵdefineInjector, ɵɵInjectableDeclaration, ɵɵngDeclareInjectable, ɵɵngDeclareInjector, ɵɵngDeclareNgModule} from '@angular/core';\n+\n+describe('Injectable declaration jit compilation', () => {\n+  let previousInjector: Injector|null|undefined;\n+  beforeEach(() => previousInjector = ɵsetCurrentInjector(ɵcreateInjector(TestInjector)));\n+  afterEach(() => ɵsetCurrentInjector(previousInjector));\n+\n+  it('should compile a minimal injectable declaration that delegates to `ɵfac`', () => {\n+    const provider = Minimal.ɵprov as ɵɵInjectableDeclaration<Minimal>;\n+    expect((provider.token as any).name).toEqual('Minimal');\n+    expect(provider.factory).toBe(Minimal.ɵfac);\n+    const instance = provider.factory();\n+    expect(instance).toBeInstanceOf(Minimal);\n+  });\n+\n+  it('should compile a simple `useClass` injectable declaration', () => {\n+    const provider = UseClass.ɵprov as ɵɵInjectableDeclaration<UseClass>;\n+    expect((provider.token as any).name).toEqual('UseClass');\n+    const instance = provider.factory();\n+    expect(instance).toBeInstanceOf(UseClass);\n+  });\n+\n+  it('should compile a simple `useFactory` injectable declaration', () => {\n+    const provider = UseFactory.ɵprov as ɵɵInjectableDeclaration<UseFactory>;\n+    expect((provider.token as any).name).toEqual('UseFactory');\n+    const instance = provider.factory();\n+    expect(instance).toBeInstanceOf(UseFactory);\n+    expect(instance.msg).toEqual('from factory');\n+  });\n+\n+  it('should compile a simple `useValue` injectable declaration', () => {\n+    const provider = UseValue.ɵprov as ɵɵInjectableDeclaration<string>;\n+    expect((provider.token as any).name).toEqual('UseValue');\n+    const instance = provider.factory();\n+    expect(instance).toEqual('a value');\n+  });\n+\n+  it('should compile a simple `useExisting` injectable declaration', () => {\n+    const provider = UseExisting.ɵprov as ɵɵInjectableDeclaration<string>;\n+    expect((provider.token as any).name).toEqual('UseExisting');\n+    const instance = provider.factory();\n+    expect(instance).toEqual('existing');\n+  });\n+\n+  it('should compile a `useClass` injectable declaration with dependencies', () => {\n+    const provider = DependingClass.ɵprov as ɵɵInjectableDeclaration<DependingClass>;\n+    expect((provider.token as any).name).toEqual('DependingClass');\n+    const instance = provider.factory();\n+    expect(instance).toBeInstanceOf(DependingClass);\n+    expect(instance.testClass).toBeInstanceOf(UseClass);\n+  });\n+\n+  it('should compile a `useFactory` injectable declaration with dependencies', () => {\n+    const provider = DependingFactory.ɵprov as ɵɵInjectableDeclaration<DependingFactory>;\n+    expect((provider.token as any).name).toEqual('DependingFactory');\n+    const instance = provider.factory();\n+    expect(instance).toBeInstanceOf(DependingFactory);\n+    expect(instance.testClass).toBeInstanceOf(UseClass);\n+  });\n+\n+  it('should unwrap a `ForwardRef` `useClass` injectable declaration', () => {\n+    class TestClass {\n+      static ɵprov = ɵɵngDeclareInjectable({\n+        type: TestClass,\n+        useClass: forwardRef(function() {\n+          return FutureClass;\n+        })\n+      });\n+    }\n+    class FutureClass {\n+      static ɵfac = () => new FutureClass();\n+    }\n+    const provider = TestClass.ɵprov as ɵɵInjectableDeclaration<FutureClass>;\n+    const instance = provider.factory();\n+    expect(instance).toBeInstanceOf(FutureClass);\n+  });\n+\n+  it('should unwrap a `ForwardRef` `providedIn` injectable declaration', () => {\n+    const expected = {};\n+    class TestClass {\n+      static ɵprov = ɵɵngDeclareInjectable({\n+        type: TestClass,\n+        providedIn: forwardRef(() => FutureModule),\n+        useValue: expected,\n+      });\n+    }\n+    class FutureModule {\n+      static ɵinj = ɵɵngDeclareInjector({type: FutureModule});\n+    }\n+\n+    const injector = ɵcreateInjector(FutureModule);\n+    const actual = injector.get(TestClass);\n+    expect(actual).toBe(expected);\n+  });\n+});\n+\n+class Minimal {\n+  static ɵfac = () => new Minimal();\n+  static ɵprov = ɵɵngDeclareInjectable({type: Minimal});\n+}\n+\n+class UseClass {\n+  static ɵprov = ɵɵngDeclareInjectable({type: UseClass, useClass: UseClass});\n+}\n+\n+class UseFactory {\n+  constructor(readonly msg: string) {}\n+  static ɵprov =\n+      ɵɵngDeclareInjectable({type: UseFactory, useFactory: () => new UseFactory('from factory')});\n+}\n+\n+class UseValue {\n+  constructor(readonly msg: string) {}\n+  static ɵprov = ɵɵngDeclareInjectable({type: UseValue, useValue: 'a value'});\n+}\n+\n+const UseExistingToken = new InjectionToken('UseExistingToken');\n+\n+class UseExisting {\n+  static ɵprov = ɵɵngDeclareInjectable({type: UseExisting, useExisting: UseExistingToken});\n+}\n+\n+class DependingClass {\n+  constructor(readonly testClass: UseClass) {}\n+  static ɵprov = ɵɵngDeclareInjectable(\n+      {type: DependingClass, useClass: DependingClass, deps: [{token: UseClass}]});\n+}\n+\n+class DependingFactory {\n+  constructor(readonly testClass: UseClass) {}\n+  static ɵprov = ɵɵngDeclareInjectable({\n+    type: DependingFactory,\n+    useFactory: (dep: UseClass) => new DependingFactory(dep),\n+    deps: [{token: UseClass}]\n+  });\n+}\n+\n+class TestInjector {\n+  static ɵinj = ɵɵdefineInjector({\n+    providers: [\n+      UseClass,\n+      UseFactory,\n+      UseValue,\n+      UseExisting,\n+      DependingClass,\n+      {provide: UseExistingToken, useValue: 'existing'},\n+    ],\n+  });\n+}"
        },
        {
            "sha": "dba42a636207cbba4f53061f05e010c8114cf1da",
            "filename": "packages/core/test/render3/jit_environment_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Ftest%2Frender3%2Fjit_environment_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcore%2Ftest%2Frender3%2Fjit_environment_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fjit_environment_spec.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -14,6 +14,7 @@ import {angularCoreEnv} from '../../src/render3/jit/environment';\n const INTERFACE_EXCEPTIONS = new Set<string>([\n   'ɵɵComponentDeclaration',\n   'ɵɵDirectiveDeclaration',\n+  'ɵɵInjectableDeclaration',\n   'ɵɵInjectorDeclaration',\n   'ɵɵInjectorDef',\n   'ɵɵNgModuleDeclaration',\n@@ -30,6 +31,7 @@ const PARTIAL_ONLY = new Set<string>([\n   'ɵɵngDeclareDirective',\n   'ɵɵngDeclareComponent',\n   'ɵɵngDeclareFactory',\n+  'ɵɵngDeclareInjectable',\n   'ɵɵngDeclareInjector',\n   'ɵɵngDeclareNgModule',\n   'ɵɵngDeclarePipe',"
        }
    ],
    "stats": {
        "total": 1374,
        "additions": 986,
        "deletions": 388
    }
}