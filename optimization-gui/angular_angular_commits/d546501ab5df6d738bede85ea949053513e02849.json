{
    "author": "codingnuclei",
    "message": "feat(service-worker): add `openWindow`, `focusLastFocusedOrOpen` and `navigateLastFocusedOrOpen` (#42520)\n\nAdd `openWindow`, `focusLastFocusedOrOpen` and `navigateLastFocusedOrOpen` abilty to the notificationclick handler such that when either a notification or notification action is clicked the service-worker can act accordinly without the need for the app to be open\n\nPR Close #26907\n\nPR Close #42520",
    "sha": "d546501ab5df6d738bede85ea949053513e02849",
    "files": [
        {
            "sha": "2f1d22fb801a77d2f95ccf0aa393cb7514e8bb60",
            "filename": ".pullapprove.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d546501ab5df6d738bede85ea949053513e02849/.pullapprove.yml",
            "raw_url": "https://github.com/angular/angular/raw/d546501ab5df6d738bede85ea949053513e02849/.pullapprove.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.pullapprove.yml?ref=d546501ab5df6d738bede85ea949053513e02849",
            "patch": "@@ -617,6 +617,7 @@ groups:\n           'aio/content/guide/service-worker-config.md',\n           'aio/content/guide/service-worker-devops.md',\n           'aio/content/guide/service-worker-intro.md',\n+          'aio/content/guide/service-worker-notifications.md',\n           'aio/content/images/guide/service-worker/**'\n           ])\n     reviewers:"
        },
        {
            "sha": "953b42c2bc3488a015d6e44d1b33f1d2d6d9d7ef",
            "filename": "aio/content/guide/service-worker-communications.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d546501ab5df6d738bede85ea949053513e02849/aio%2Fcontent%2Fguide%2Fservice-worker-communications.md",
            "raw_url": "https://github.com/angular/angular/raw/d546501ab5df6d738bede85ea949053513e02849/aio%2Fcontent%2Fguide%2Fservice-worker-communications.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fservice-worker-communications.md?ref=d546501ab5df6d738bede85ea949053513e02849",
            "patch": "@@ -95,4 +95,4 @@ You can subscribe to `SwUpdate#unrecoverable` to be notified and handle these er\n ## More on Angular service workers\n \n You may also be interested in the following:\n-* [Service Worker in Production](guide/service-worker-devops).\n+* [Service Worker Notifications](guide/service-worker-notifications).\n\\ No newline at end of file"
        },
        {
            "sha": "b3fe86ccba1fb578b7a47733fb55fdb4df1aeb80",
            "filename": "aio/content/guide/service-worker-intro.md",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d546501ab5df6d738bede85ea949053513e02849/aio%2Fcontent%2Fguide%2Fservice-worker-intro.md",
            "raw_url": "https://github.com/angular/angular/raw/d546501ab5df6d738bede85ea949053513e02849/aio%2Fcontent%2Fguide%2Fservice-worker-intro.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fservice-worker-intro.md?ref=d546501ab5df6d738bede85ea949053513e02849",
            "patch": "@@ -66,6 +66,7 @@ The rest of the articles in this section specifically address the Angular implem\n \n * [App Shell](guide/app-shell)\n * [Service Worker Communication](guide/service-worker-communications)\n+* [Service Worker Notifications](guide/service-worker-notifications)\n * [Service Worker in Production](guide/service-worker-devops)\n * [Service Worker Configuration](guide/service-worker-config)\n "
        },
        {
            "sha": "4575e337c61d49d0dfb101f6f104dcedbe35cf94",
            "filename": "aio/content/guide/service-worker-notifications.md",
            "status": "added",
            "additions": 106,
            "deletions": 0,
            "changes": 106,
            "blob_url": "https://github.com/angular/angular/blob/d546501ab5df6d738bede85ea949053513e02849/aio%2Fcontent%2Fguide%2Fservice-worker-notifications.md",
            "raw_url": "https://github.com/angular/angular/raw/d546501ab5df6d738bede85ea949053513e02849/aio%2Fcontent%2Fguide%2Fservice-worker-notifications.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fservice-worker-notifications.md?ref=d546501ab5df6d738bede85ea949053513e02849",
            "patch": "@@ -0,0 +1,106 @@\n+# Service worker notifications\n+\n+Push notifications are a compelling way to engage users. Through the power of service workers, notifications can be delivered to a device even when your application is not in focus.\n+\n+The Angular service worker enables the display of push notifications and the handling of notification click events.\n+\n+<div class=\"alert is-helpful\">\n+\n+  When using the Angular service worker, push notification interactions are handled using the `SwPush` service.\n+  To learn more about the native APIs involved see [Push API](https://developer.mozilla.org/en-US/docs/Web/API/Push_API) and [Using the Notifications API](https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API/Using_the_Notifications_API).\n+\n+</div>\n+\n+#### Prerequisites\n+\n+We recommend you have a basic understanding of the following:\n+\n+- [Getting Started with Service Workers](guide/service-worker-getting-started).\n+\n+## Notification payload\n+\n+Invoke push notifications by pushing a message with a valid payload. See `SwPush` for guidance.\n+\n+<div class=\"alert is-helpful\">\n+\n+  In Chrome, you can test push notifications without a backend.\n+  Open Devtools -> Application -> Service Workers and use the `Push` input to send a JSON notification payload.\n+\n+</div>\n+\n+## Notification click handling\n+\n+The default behavior for the `notificationclick` event is to close the notification and notify `SwPush.notificationClicks`.\n+\n+You can specify an additional operation to be executed on `notificationclick` by adding an `onActionClick` property to the `data` object, and providing a `default` entry. This is especially useful for when there are no open clients when a notification is clicked.\n+\n+```json\n+{\n+  \"notification\": {\n+    \"title\": \"New Notification!\",\n+    \"data\": {\n+      \"onActionClick\": {\n+        \"default\": {\"operation\": \"openWindow\", \"url\": \"foo\"}\n+      }\n+    }\n+  }\n+}\n+```\n+\n+### Operations\n+\n+The Angular service worker supports the following operations:\n+\n+- `openWindow`: Opens a new tab at the specified URL, which is resolved relative to the service worker scope.\n+\n+- `focusLastFocusedOrOpen`: Focuses the last focused client. If there is no client open, then it opens a new tab at the specified URL, which is resolved relative to the service worker scope.\n+\n+- `navigateLastFocusedOrOpen`: Focuses the last focused client and navigates it to the specified URL, which is resolved relative to the service worker scope. If there is no client open, then it opens a new tab at the specified URL.\n+\n+<div class=\"alert is-important\">\n+\n+  If an `onActionClick` item does not define a `url`, then the service worker's registration scope is used.\n+  \n+</div>\n+\n+### Actions\n+\n+Actions offer a way to customize how the user can interact with a notification.\n+\n+Using the `actions` property, you can define a set of available actions. Each action is represented as an action button that the user can click to interact with the notification.\n+\n+In addition, using the `onActionClick` property on the `data` object, you can tie each action to an operation to be performed when the corresponding action button is clicked:\n+\n+```ts\n+{\n+  \"notification\": {\n+    \"title\": \"New Notification!\",\n+    \"actions\": [\n+      {\"action\": \"foo\", \"title\": \"Open new tab\"},\n+      {\"action\": \"bar\", \"title\": \"Focus last\"},\n+      {\"action\": \"baz\", \"title\": \"Navigate last\"},\n+      {\"action\": \"qux\", \"title\": \"Just notify existing clients\"}\n+    ],\n+    \"data\": {\n+      \"onActionClick\": {\n+        \"default\": {\"operation\": \"openWindow\"},\n+        \"foo\": {\"operation\": \"openWindow\", \"url\": \"/absolute/path\"},\n+        \"bar\": {\"operation\": \"focusLastFocusedOrOpen\", \"url\": \"relative/path\"},\n+        \"baz\": {\"operation\": \"navigateLastFocusedOrOpen\", \"url\": \"https://other.domain.com/\"}\n+      }\n+    }\n+  }\n+}\n+```\n+\n+<div class=\"alert is-important\">\n+\n+  If an action does not have a corresponding `onActionClick` entry, then the notification is closed and `SwPush.notificationClicks` is notified on existing clients.\n+\n+</div>\n+\n+## More on Angular service workers\n+\n+You may also be interested in the following:\n+\n+- [Service Worker in Production](guide/service-worker-devops)."
        },
        {
            "sha": "c04a75cf01bb9b627f8a4b57afc8327b83c12adb",
            "filename": "aio/content/navigation.json",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/d546501ab5df6d738bede85ea949053513e02849/aio%2Fcontent%2Fnavigation.json",
            "raw_url": "https://github.com/angular/angular/raw/d546501ab5df6d738bede85ea949053513e02849/aio%2Fcontent%2Fnavigation.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fnavigation.json?ref=d546501ab5df6d738bede85ea949053513e02849",
            "patch": "@@ -435,6 +435,11 @@\n               \"title\": \"Service Worker Communication\",\n               \"tooltip\": \"Services that enable you to interact with an Angular service worker.\"\n             },\n+            {\n+              \"url\": \"guide/service-worker-notifications\",\n+              \"title\": \"Service Worker Notifications\",\n+              \"tooltip\": \"Configuring service worker notification behavior.\"\n+            },\n             {\n               \"url\": \"guide/service-worker-devops\",\n               \"title\": \"Service Worker in Production\","
        },
        {
            "sha": "a9e90928d96ca8ed12bb608eba8192afc0b4c374",
            "filename": "packages/service-worker/src/push.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/d546501ab5df6d738bede85ea949053513e02849/packages%2Fservice-worker%2Fsrc%2Fpush.ts",
            "raw_url": "https://github.com/angular/angular/raw/d546501ab5df6d738bede85ea949053513e02849/packages%2Fservice-worker%2Fsrc%2Fpush.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fsrc%2Fpush.ts?ref=d546501ab5df6d738bede85ea949053513e02849",
            "patch": "@@ -81,6 +81,9 @@ import {ERR_SW_NOT_SUPPORTED, NgswCommChannel, PushEvent} from './low_level';\n  * <code-example path=\"service-worker/push/module.ts\" region=\"subscribe-to-notification-clicks\"\n  * header=\"app.component.ts\"></code-example>\n  *\n+ * You can read more on handling notification clicks in the [Service worker notifications\n+ * guide](guide/service-worker-notifications).\n+ *\n  * @see [Push Notifications](https://developers.google.com/web/fundamentals/codelabs/push-notifications/)\n  * @see [Angular Push Notifications](https://blog.angular-university.io/angular-push-notifications/)\n  * @see [MDN: Push API](https://developer.mozilla.org/en-US/docs/Web/API/Push_API)"
        },
        {
            "sha": "8c1a8c93b578455d15d05c32e10a451445bd70a4",
            "filename": "packages/service-worker/worker/src/driver.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/d546501ab5df6d738bede85ea949053513e02849/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "raw_url": "https://github.com/angular/angular/raw/d546501ab5df6d738bede85ea949053513e02849/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts?ref=d546501ab5df6d738bede85ea949053513e02849",
            "patch": "@@ -348,12 +348,52 @@ export class Driver implements Debuggable, UpdateSource {\n     NOTIFICATION_OPTION_NAMES.filter(name => name in notification)\n         .forEach(name => options[name] = notification[name]);\n \n+    const notificationAction = action === '' || action === undefined ? 'default' : action;\n+\n+    const onActionClick = notification?.data?.onActionClick[notificationAction];\n+\n+    const urlToOpen = new URL(onActionClick?.url ?? '', this.scope.registration.scope).href;\n+\n+    switch (onActionClick?.operation) {\n+      case 'openWindow':\n+        await this.scope.clients.openWindow(urlToOpen);\n+        break;\n+      case 'focusLastFocusedOrOpen': {\n+        let matchingClient = await this.getLastFocusedMatchingClient(this.scope);\n+        if (matchingClient) {\n+          await matchingClient?.focus();\n+        } else {\n+          await this.scope.clients.openWindow(urlToOpen);\n+        }\n+        break;\n+      }\n+      case 'navigateLastFocusedOrOpen': {\n+        let matchingClient = await this.getLastFocusedMatchingClient(this.scope);\n+        if (matchingClient) {\n+          matchingClient = await matchingClient.navigate(urlToOpen);\n+          await matchingClient?.focus();\n+        } else {\n+          await this.scope.clients.openWindow(urlToOpen);\n+        }\n+        break;\n+      }\n+      default:\n+        break;\n+    }\n+\n     await this.broadcast({\n       type: 'NOTIFICATION_CLICK',\n       data: {action, notification: options},\n     });\n   }\n \n+  private async getLastFocusedMatchingClient(scope: ServiceWorkerGlobalScope):\n+      Promise<WindowClient|null> {\n+    const windowClients = await scope.clients.matchAll({type: 'window'});\n+\n+    // As per the spec windowClients are `sorted in the most recently focused order`\n+    return windowClients[0];\n+  }\n   private async reportStatus(client: Client, promise: Promise<void>, nonce: number): Promise<void> {\n     const response = {type: 'STATUS', nonce, status: true};\n     try {"
        },
        {
            "sha": "1b2a1de010bd83a476a7f099be0ff10f59de4937",
            "filename": "packages/service-worker/worker/src/service-worker.d.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/d546501ab5df6d738bede85ea949053513e02849/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/d546501ab5df6d738bede85ea949053513e02849/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts?ref=d546501ab5df6d738bede85ea949053513e02849",
            "patch": "@@ -36,21 +36,25 @@ declare class Client {\n }\n \n interface Clients {\n-  claim(): Promise<any>;\n+  claim(): Promise<void>;\n   get(id: string): Promise<Client>;\n-  matchAll(options?: ClientMatchOptions): Promise<Array<Client>>;\n+  matchAll<T extends ClientMatchOptions>(\n+    options?: T\n+  ): Promise<ReadonlyArray<T['type'] extends 'window' ? WindowClient : Client>>;\n+  openWindow(url: string): Promise<WindowClient | null>;\n }\n \n interface ClientMatchOptions {\n   includeUncontrolled?: boolean;\n   type?: ClientMatchTypes;\n }\n \n-interface WindowClient {\n-  focused: boolean;\n-  visibilityState: WindowClientState;\n+interface WindowClient extends Client {\n+  readonly ancestorOrigins: ReadonlyArray<string>;\n+  readonly focused: boolean;\n+  readonly visibilityState: VisibilityState;\n   focus(): Promise<WindowClient>;\n-  navigate(url: string): Promise<WindowClient>;\n+  navigate(url: string): Promise<WindowClient | null>;\n }\n \n type ClientFrameType = 'auxiliary'|'top-level'|'nested'|'none';"
        },
        {
            "sha": "8abef977256e5f751cc97b6a4e2db36cdb4c7776",
            "filename": "packages/service-worker/worker/test/happy_spec.ts",
            "status": "modified",
            "additions": 358,
            "deletions": 24,
            "changes": 382,
            "blob_url": "https://github.com/angular/angular/blob/d546501ab5df6d738bede85ea949053513e02849/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d546501ab5df6d738bede85ea949053513e02849/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts?ref=d546501ab5df6d738bede85ea949053513e02849",
            "patch": "@@ -14,7 +14,7 @@ import {sha1} from '../src/sha1';\n import {clearAllCaches, MockCache} from '../testing/cache';\n import {MockRequest, MockResponse} from '../testing/fetch';\n import {MockFileSystem, MockFileSystemBuilder, MockServerState, MockServerStateBuilder, tmpHashTableForFs} from '../testing/mock';\n-import {SwTestHarness, SwTestHarnessBuilder} from '../testing/scope';\n+import {MockClient, SwTestHarness, SwTestHarnessBuilder, WindowClientImpl} from '../testing/scope';\n \n (function() {\n // Skip environments that don't support the minimum APIs needed to run the SW tests.\n@@ -721,30 +721,364 @@ describe('Driver', () => {\n     }]);\n   });\n \n-  it('broadcasts notification click events with action', async () => {\n-    expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n-    await driver.initialized;\n-    await scope.handleClick(\n-        {title: 'This is a test with action', body: 'Test body with action'}, 'button');\n-    const message: any = scope.clients.getMock('default')!.messages[0];\n-\n-    expect(message.type).toEqual('NOTIFICATION_CLICK');\n-    expect(message.data.action).toEqual('button');\n-    expect(message.data.notification.title).toEqual('This is a test with action');\n-    expect(message.data.notification.body).toEqual('Test body with action');\n-  });\n+  describe('notification click events', () => {\n+    it('broadcasts notification click events with action', async () => {\n+      expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+      await driver.initialized;\n+      await scope.handleClick(\n+          {title: 'This is a test with action', body: 'Test body with action'}, 'button');\n+      const message: any = scope.clients.getMock('default')!.messages[0];\n+\n+      expect(message.type).toEqual('NOTIFICATION_CLICK');\n+      expect(message.data.action).toEqual('button');\n+      expect(message.data.notification.title).toEqual('This is a test with action');\n+      expect(message.data.notification.body).toEqual('Test body with action');\n+    });\n \n-  it('broadcasts notification click events without action', async () => {\n-    expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n-    await driver.initialized;\n-    await scope.handleClick(\n-        {title: 'This is a test without action', body: 'Test body without action'});\n-    const message: any = scope.clients.getMock('default')!.messages[0];\n-\n-    expect(message.type).toEqual('NOTIFICATION_CLICK');\n-    expect(message.data.action).toBeUndefined();\n-    expect(message.data.notification.title).toEqual('This is a test without action');\n-    expect(message.data.notification.body).toEqual('Test body without action');\n+    it('broadcasts notification click events without action', async () => {\n+      expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+      await driver.initialized;\n+      await scope.handleClick({\n+        title: 'This is a test without action',\n+        body: 'Test body without action',\n+      });\n+      const message: any = scope.clients.getMock('default')!.messages[0];\n+\n+      expect(message.type).toEqual('NOTIFICATION_CLICK');\n+      expect(message.data.action).toBeUndefined();\n+      expect(message.data.notification.title).toEqual('This is a test without action');\n+      expect(message.data.notification.body).toEqual('Test body without action');\n+    });\n+\n+    describe('Client interactions', () => {\n+      describe('`openWindow` operation', () => {\n+        it('opens a new client window at url', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+\n+          spyOn(scope.clients, 'openWindow');\n+          const url = 'foo';\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with url',\n+                body: 'Test body with url',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'openWindow', url},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(scope.clients.openWindow)\n+              .toHaveBeenCalledWith(`${scope.registration.scope}${url}`);\n+        });\n+\n+        it('opens a new client window with `/` when no `url`', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+\n+          spyOn(scope.clients, 'openWindow');\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test without url',\n+                body: 'Test body without url',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'openWindow'},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(scope.clients.openWindow).toHaveBeenCalledWith(`${scope.registration.scope}`);\n+        });\n+      });\n+\n+      describe('`focusLastFocusedOrOpen` operation', () => {\n+        it('focuses last client keeping previous url', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+          const mockClient = new WindowClientImpl('fooBar');\n+          spyOn(scope.clients, 'matchAll').and.returnValue(Promise.resolve([mockClient]));\n+          spyOn(mockClient, 'focus');\n+          spyOn(mockClient, 'navigate');\n+          const url = 'foo';\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with operation focusLastFocusedOrOpen',\n+                body: 'Test body with operation focusLastFocusedOrOpen',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'focusLastFocusedOrOpen', url},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(mockClient.navigate).not.toHaveBeenCalled();\n+          expect(mockClient.url).toEqual('http://localhost/unique');\n+          expect(mockClient.focus).toHaveBeenCalled();\n+        });\n+\n+        it('falls back to openWindow at url when no last client to focus', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+          spyOn(scope.clients, 'openWindow');\n+          spyOn(scope.clients, 'matchAll').and.returnValue(Promise.resolve([]));\n+          const url = 'foo';\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with operation focusLastFocusedOrOpen',\n+                body: 'Test body with operation focusLastFocusedOrOpen',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'focusLastFocusedOrOpen', url},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(scope.clients.openWindow)\n+              .toHaveBeenCalledWith(`${scope.registration.scope}${url}`);\n+        });\n+\n+        it('falls back to openWindow at `/` when no last client and no `url`', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+          spyOn(scope.clients, 'openWindow');\n+          spyOn(scope.clients, 'matchAll').and.returnValue(Promise.resolve([]));\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with operation focusLastFocusedOrOpen',\n+                body: 'Test body with operation focusLastFocusedOrOpen',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'focusLastFocusedOrOpen'},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(scope.clients.openWindow).toHaveBeenCalledWith(`${scope.registration.scope}`);\n+        });\n+      });\n+\n+      describe('`navigateLastFocusedOrOpen` operation', () => {\n+        it('navigates last client to `url`', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+          const mockClient = new WindowClientImpl('fooBar');\n+          spyOn(scope.clients, 'matchAll').and.returnValue(Promise.resolve([mockClient]));\n+          spyOn(mockClient, 'focus');\n+          spyOn(mockClient, 'navigate').and.returnValue(Promise.resolve(mockClient));\n+          const url = 'foo';\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with operation navigateLastFocusedOrOpen',\n+                body: 'Test body with operation navigateLastFocusedOrOpen',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'navigateLastFocusedOrOpen', url},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(mockClient.navigate).toHaveBeenCalledWith(`${scope.registration.scope}${url}`);\n+          expect(mockClient.focus).toHaveBeenCalled();\n+        });\n+\n+        it('navigates last client to `/` if no `url', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+          const mockClient = new WindowClientImpl('fooBar');\n+          spyOn(scope.clients, 'matchAll').and.returnValue(Promise.resolve([mockClient]));\n+          spyOn(mockClient, 'focus');\n+          spyOn(mockClient, 'navigate').and.returnValue(Promise.resolve(mockClient));\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with operation navigateLastFocusedOrOpen',\n+                body: 'Test body with operation navigateLastFocusedOrOpen',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'navigateLastFocusedOrOpen'},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(mockClient.navigate).toHaveBeenCalledWith(`${scope.registration.scope}`);\n+          expect(mockClient.focus).toHaveBeenCalled();\n+        });\n+\n+        it('falls back to openWindow at url when no last client to focus', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+          spyOn(scope.clients, 'openWindow');\n+          spyOn(scope.clients, 'matchAll').and.returnValue(Promise.resolve([]));\n+          const url = 'foo';\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with operation navigateLastFocusedOrOpen',\n+                body: 'Test body with operation navigateLastFocusedOrOpen',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'navigateLastFocusedOrOpen', url},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(scope.clients.openWindow)\n+              .toHaveBeenCalledWith(`${scope.registration.scope}${url}`);\n+        });\n+\n+        it('falls back to openWindow at `/` when no last client and no `url`', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+          spyOn(scope.clients, 'openWindow');\n+          spyOn(scope.clients, 'matchAll').and.returnValue(Promise.resolve([]));\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with operation navigateLastFocusedOrOpen',\n+                body: 'Test body with operation navigateLastFocusedOrOpen',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'navigateLastFocusedOrOpen'},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(scope.clients.openWindow).toHaveBeenCalledWith(`${scope.registration.scope}`);\n+        });\n+      });\n+\n+      describe('No matching onActionClick field', () => {\n+        it('no client interaction', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+          spyOn(scope.clients, 'openWindow');\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test without onActionClick field',\n+                body: 'Test body without onActionClick field',\n+                data: {\n+                  onActionClick: {\n+                    fooz: {operation: 'focusLastFocusedOrOpen', url: 'fooz'},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(scope.clients.openWindow).not.toHaveBeenCalled();\n+        });\n+      });\n+\n+      describe('no action', () => {\n+        it('uses onActionClick default when no specific action is clicked', async () => {\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+          spyOn(scope.clients, 'openWindow');\n+          const url = 'fooz';\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test without action',\n+                body: 'Test body without action',\n+                data: {\n+                  onActionClick: {\n+                    default: {operation: 'openWindow', url},\n+                  },\n+                },\n+              },\n+              '');\n+          expect(scope.clients.openWindow)\n+              .toHaveBeenCalledWith(`${scope.registration.scope}${url}`);\n+        });\n+\n+        describe('no onActionClick default', () => {\n+          it('has no client interaction', async () => {\n+            expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+            spyOn(scope.clients, 'openWindow');\n+\n+            await driver.initialized;\n+            await scope.handleClick(\n+                {title: 'This is a test without action', body: 'Test body without action'});\n+            expect(scope.clients.openWindow).not.toHaveBeenCalled();\n+          });\n+        });\n+      });\n+\n+      describe('URL resolution', () => {\n+        it('should resolve relative to service worker scope', async () => {\n+          (scope.registration.scope as string) = 'http://localhost/foo/bar/';\n+\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+\n+          spyOn(scope.clients, 'openWindow');\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with a relative url',\n+                body: 'Test body with a relative url',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'openWindow', url: 'baz/qux'},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(scope.clients.openWindow).toHaveBeenCalledWith('http://localhost/foo/bar/baz/qux');\n+        });\n+\n+        it('should resolve with an absolute path', async () => {\n+          (scope.registration.scope as string) = 'http://localhost/foo/bar/';\n+\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+\n+          spyOn(scope.clients, 'openWindow');\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with an absolute path url',\n+                body: 'Test body with an absolute path url',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'openWindow', url: '/baz/qux'},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(scope.clients.openWindow).toHaveBeenCalledWith('http://localhost/baz/qux');\n+        });\n+\n+        it('should resolve other origins', async () => {\n+          (scope.registration.scope as string) = 'http://localhost/foo/bar/';\n+\n+          expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n+\n+          spyOn(scope.clients, 'openWindow');\n+\n+          await driver.initialized;\n+          await scope.handleClick(\n+              {\n+                title: 'This is a test with external origin',\n+                body: 'Test body with external origin',\n+                data: {\n+                  onActionClick: {\n+                    foo: {operation: 'openWindow', url: 'http://other.host/baz/qux'},\n+                  },\n+                },\n+              },\n+              'foo');\n+          expect(scope.clients.openWindow).toHaveBeenCalledWith('http://other.host/baz/qux');\n+        });\n+      });\n+    });\n   });\n \n   it('prefetches updates to lazy cache when set', async () => {"
        },
        {
            "sha": "e865db5c2a9ee5ccc0cf5b389b7901c05abff029",
            "filename": "packages/service-worker/worker/testing/scope.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 2,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/d546501ab5df6d738bede85ea949053513e02849/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "raw_url": "https://github.com/angular/angular/raw/d546501ab5df6d738bede85ea949053513e02849/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts?ref=d546501ab5df6d738bede85ea949053513e02849",
            "patch": "@@ -31,6 +31,24 @@ export class MockClient {\n     this.queue.next(message);\n   }\n }\n+export class WindowClientImpl extends MockClient implements WindowClient {\n+  readonly ancestorOrigins: ReadonlyArray<string> = [];\n+  readonly focused: boolean = false;\n+  readonly visibilityState: VisibilityState = 'hidden';\n+  frameType: ClientFrameType = 'top-level';\n+  url = 'http://localhost/unique';\n+\n+  constructor(readonly id: string) {\n+    super(id);\n+  }\n+\n+  async focus(): Promise<WindowClient> {\n+    return this;\n+  }\n+  async navigate(url: string): Promise<WindowClient|null> {\n+    return this;\n+  }\n+}\n \n export class SwTestHarnessBuilder {\n   private origin = parseUrl(this.scopeUrl).origin;\n@@ -76,8 +94,12 @@ export class MockClients implements Clients {\n     return this.clients.get(id);\n   }\n \n-  async matchAll(): Promise<Client[]> {\n-    return Array.from(this.clients.values()) as any[] as Client[];\n+  async matchAll<T extends ClientQueryOptions>(options?: T):\n+      Promise<ReadonlyArray<T['type'] extends 'window'? WindowClient : Client>> {\n+    return Array.from(this.clients.values()) as any[];\n+  }\n+  async openWindow(url: string): Promise<WindowClient|null> {\n+    return null;\n   }\n \n   async claim(): Promise<any> {}"
        }
    ],
    "stats": {
        "total": 582,
        "additions": 549,
        "deletions": 33
    }
}