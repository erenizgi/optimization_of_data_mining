{
    "author": "bjarkler",
    "message": "feat(compiler): support tagged template literals in code generator (#39122)\n\nAdd a TaggedTemplateExpr to represent tagged template literals in\nAngular's syntax tree (more specifically Expression in output_ast.ts).\nAlso update classes that implement ExpressionVisitor to add support for\ntagged template literals in different contexts, such as JIT compilation\nand conversion to JS.\n\nPartial support for tagged template literals had already been\nimplemented to support the $localize tag used by Angular's i18n\nframework. Where applicable, this code was refactored to support\narbitrary tags, although completely replacing the i18n-specific support\nfor the $localize tag with the new generic support for tagged template\nliterals may not be completely trivial, and is left as future work.\n\nPR Close #39122",
    "sha": "ef892743ec523a431a10b1232647bc30e8d9f3f9",
    "files": [
        {
            "sha": "2f5fdc4b5f91ee2777a37cb70dad3a8b0f71ea5a",
            "filename": "packages/compiler-cli/ngcc/src/rendering/esm5_rendering_formatter.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fesm5_rendering_formatter.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fesm5_rendering_formatter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fesm5_rendering_formatter.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -65,8 +65,7 @@ export class Esm5RenderingFormatter extends EsmRenderingFormatter {\n    */\n   printStatement(stmt: Statement, sourceFile: ts.SourceFile, importManager: ImportManager): string {\n     const node = translateStatement(\n-        stmt, importManager,\n-        {downlevelLocalizedStrings: true, downlevelVariableDeclarations: true});\n+        stmt, importManager, {downlevelTaggedTemplates: true, downlevelVariableDeclarations: true});\n     const code = this.printer.printNode(ts.EmitHint.Unspecified, node, sourceFile);\n \n     return code;"
        },
        {
            "sha": "95ad53d67574480c6683b0be6b42803b091c0940",
            "filename": "packages/compiler-cli/ngcc/test/rendering/renderer_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Frenderer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Frenderer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Frenderer_spec.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -66,7 +66,7 @@ class TestRenderingFormatter implements RenderingFormatter {\n   printStatement(stmt: Statement, sourceFile: ts.SourceFile, importManager: ImportManager): string {\n     const node = translateStatement(\n         stmt, importManager,\n-        {downlevelLocalizedStrings: this.isEs5, downlevelVariableDeclarations: this.isEs5});\n+        {downlevelTaggedTemplates: this.isEs5, downlevelVariableDeclarations: this.isEs5});\n     const code = this.printer.printNode(ts.EmitHint.Unspecified, node, sourceFile);\n \n     return `// TRANSPILED\\n${code}`;"
        },
        {
            "sha": "76ebcef30feb79c0943bb725d31967155c355702",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/transform.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Ftransform.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Ftransform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Ftransform.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -280,7 +280,7 @@ function transformIvySourceFile(\n   const constants =\n       constantPool.statements.map(stmt => translateStatement(stmt, importManager, {\n                                     recordWrappedNodeExpr,\n-                                    downlevelLocalizedStrings: downlevelTranslatedCode,\n+                                    downlevelTaggedTemplates: downlevelTranslatedCode,\n                                     downlevelVariableDeclarations: downlevelTranslatedCode,\n                                   }));\n "
        },
        {
            "sha": "be45c203408975788c1b0d8f7d688a872ef468d5",
            "filename": "packages/compiler-cli/src/ngtsc/translator/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Findex.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -12,5 +12,5 @@ export {Context} from './src/context';\n export {ImportManager} from './src/import_manager';\n export {ExpressionTranslatorVisitor, RecordWrappedNodeExprFn, TranslatorOptions} from './src/translator';\n export {translateType} from './src/type_translator';\n-export {attachComments, TypeScriptAstFactory} from './src/typescript_ast_factory';\n+export {attachComments, createTemplateMiddle, createTemplateTail, TypeScriptAstFactory} from './src/typescript_ast_factory';\n export {translateExpression, translateStatement} from './src/typescript_translator';"
        },
        {
            "sha": "9f9a37c1e18e2b1dad71d65eabdd03091918c258",
            "filename": "packages/compiler-cli/src/ngtsc/translator/src/translator.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 9,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftranslator.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftranslator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftranslator.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as o from '@angular/compiler';\n+import {createTaggedTemplate} from 'typescript';\n \n import {AstFactory, BinaryOperator, ObjectLiteralProperty, SourceMapRange, TemplateElement, TemplateLiteral, UnaryOperator} from './api/ast_factory';\n import {ImportGenerator} from './api/import_generator';\n@@ -38,21 +39,21 @@ const BINARY_OPERATORS = new Map<o.BinaryOperator, BinaryOperator>([\n export type RecordWrappedNodeExprFn<TExpression> = (expr: TExpression) => void;\n \n export interface TranslatorOptions<TExpression> {\n-  downlevelLocalizedStrings?: boolean;\n+  downlevelTaggedTemplates?: boolean;\n   downlevelVariableDeclarations?: boolean;\n   recordWrappedNodeExpr?: RecordWrappedNodeExprFn<TExpression>;\n }\n \n export class ExpressionTranslatorVisitor<TStatement, TExpression> implements o.ExpressionVisitor,\n                                                                              o.StatementVisitor {\n-  private downlevelLocalizedStrings: boolean;\n+  private downlevelTaggedTemplates: boolean;\n   private downlevelVariableDeclarations: boolean;\n   private recordWrappedNodeExpr: RecordWrappedNodeExprFn<TExpression>;\n \n   constructor(\n       private factory: AstFactory<TStatement, TExpression>,\n       private imports: ImportGenerator<TExpression>, options: TranslatorOptions<TExpression>) {\n-    this.downlevelLocalizedStrings = options.downlevelLocalizedStrings === true;\n+    this.downlevelTaggedTemplates = options.downlevelTaggedTemplates === true;\n     this.downlevelVariableDeclarations = options.downlevelVariableDeclarations === true;\n     this.recordWrappedNodeExpr = options.recordWrappedNodeExpr || (() => {});\n   }\n@@ -168,6 +169,19 @@ export class ExpressionTranslatorVisitor<TStatement, TExpression> implements o.E\n         ast.sourceSpan);\n   }\n \n+  visitTaggedTemplateExpr(ast: o.TaggedTemplateExpr, context: Context): TExpression {\n+    return this.setSourceMapRange(\n+        this.createTaggedTemplateExpression(ast.tag.visitExpression(this, context), {\n+          elements: ast.template.elements.map(e => createTemplateElement({\n+                                                cooked: e.text,\n+                                                raw: e.rawText,\n+                                                range: e.sourceSpan ?? ast.sourceSpan,\n+                                              })),\n+          expressions: ast.template.expressions.map(e => e.visitExpression(this, context))\n+        }),\n+        ast.sourceSpan);\n+  }\n+\n   visitInstantiateExpr(ast: o.InstantiateExpr, context: Context): TExpression {\n     return this.factory.createNewExpression(\n         ast.classExpr.visitExpression(this, context),\n@@ -202,13 +216,14 @@ export class ExpressionTranslatorVisitor<TStatement, TExpression> implements o.E\n     }\n \n     const localizeTag = this.factory.createIdentifier('$localize');\n+    return this.setSourceMapRange(\n+        this.createTaggedTemplateExpression(localizeTag, {elements, expressions}), ast.sourceSpan);\n+  }\n \n-    // Now choose which implementation to use to actually create the necessary AST nodes.\n-    const localizeCall = this.downlevelLocalizedStrings ?\n-        this.createES5TaggedTemplateFunctionCall(localizeTag, {elements, expressions}) :\n-        this.factory.createTaggedTemplate(localizeTag, {elements, expressions});\n-\n-    return this.setSourceMapRange(localizeCall, ast.sourceSpan);\n+  private createTaggedTemplateExpression(tag: TExpression, template: TemplateLiteral<TExpression>):\n+      TExpression {\n+    return this.downlevelTaggedTemplates ? this.createES5TaggedTemplateFunctionCall(tag, template) :\n+                                           this.factory.createTaggedTemplate(tag, template);\n   }\n \n   /**"
        },
        {
            "sha": "15d2f9c6bdb3cccc961ae00169e99f576c21fd89",
            "filename": "packages/compiler-cli/src/ngtsc/translator/src/type_translator.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftype_translator.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftype_translator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftype_translator.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -98,6 +98,10 @@ export class TypeTranslatorVisitor implements o.ExpressionVisitor, o.TypeVisitor\n     throw new Error('Method not implemented.');\n   }\n \n+  visitTaggedTemplateExpr(ast: o.TaggedTemplateExpr, context: Context): never {\n+    throw new Error('Method not implemented.');\n+  }\n+\n   visitInstantiateExpr(ast: o.InstantiateExpr, context: Context): never {\n     throw new Error('Method not implemented.');\n   }"
        },
        {
            "sha": "ae9df7a952bd4c5bb8ee63f4e8f4a7acfaee7f8f",
            "filename": "packages/compiler-cli/src/transformers/node_emitter.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fnode_emitter.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fnode_emitter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fnode_emitter.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AssertNotNull, BinaryOperator, BinaryOperatorExpr, BuiltinMethod, BuiltinVar, CastExpr, ClassStmt, CommaExpr, ConditionalExpr, DeclareFunctionStmt, DeclareVarStmt, ExpressionStatement, ExpressionVisitor, ExternalExpr, ExternalReference, FunctionExpr, IfStmt, InstantiateExpr, InvokeFunctionExpr, InvokeMethodExpr, LeadingComment, leadingComment, LiteralArrayExpr, LiteralExpr, LiteralMapExpr, LocalizedString, NotExpr, ParseSourceFile, ParseSourceSpan, PartialModule, ReadKeyExpr, ReadPropExpr, ReadVarExpr, ReturnStatement, Statement, StatementVisitor, StmtModifier, ThrowStmt, TryCatchStmt, TypeofExpr, UnaryOperator, UnaryOperatorExpr, WrappedNodeExpr, WriteKeyExpr, WritePropExpr, WriteVarExpr} from '@angular/compiler';\n+import {AssertNotNull, BinaryOperator, BinaryOperatorExpr, BuiltinMethod, BuiltinVar, CastExpr, ClassStmt, CommaExpr, ConditionalExpr, DeclareFunctionStmt, DeclareVarStmt, ExpressionStatement, ExpressionVisitor, ExternalExpr, ExternalReference, FunctionExpr, IfStmt, InstantiateExpr, InvokeFunctionExpr, InvokeMethodExpr, LeadingComment, leadingComment, LiteralArrayExpr, LiteralExpr, LiteralMapExpr, LocalizedString, NotExpr, ParseSourceFile, ParseSourceSpan, PartialModule, ReadKeyExpr, ReadPropExpr, ReadVarExpr, ReturnStatement, Statement, StatementVisitor, StmtModifier, TaggedTemplateExpr, ThrowStmt, TryCatchStmt, TypeofExpr, UnaryOperator, UnaryOperatorExpr, WrappedNodeExpr, WriteKeyExpr, WritePropExpr, WriteVarExpr} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {attachComments} from '../ngtsc/translator';\n@@ -544,6 +544,10 @@ export class NodeEmitterVisitor implements StatementVisitor, ExpressionVisitor {\n             expr.args.map(arg => arg.visitExpression(this, null))));\n   }\n \n+  visitTaggedTemplateExpr(expr: TaggedTemplateExpr): RecordedNode<ts.TaggedTemplateExpression> {\n+    throw new Error('tagged templates are not supported in pre-ivy mode.');\n+  }\n+\n   visitInstantiateExpr(expr: InstantiateExpr): RecordedNode<ts.NewExpression> {\n     return this.postProcess(\n         expr,"
        },
        {
            "sha": "ae5f1aae668f3130d8174d7f29d36d0c03b39b62",
            "filename": "packages/compiler/src/compiler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -78,7 +78,7 @@ export * from './ml_parser/tags';\n export {LexerRange} from './ml_parser/lexer';\n export * from './ml_parser/xml_parser';\n export {NgModuleCompiler} from './ng_module_compiler';\n-export {ArrayType, AssertNotNull, DYNAMIC_TYPE, BinaryOperator, BinaryOperatorExpr, BuiltinMethod, BuiltinType, BuiltinTypeName, BuiltinVar, CastExpr, ClassField, ClassMethod, ClassStmt, CommaExpr, ConditionalExpr, DeclareFunctionStmt, DeclareVarStmt, Expression, ExpressionStatement, ExpressionType, ExpressionVisitor, ExternalExpr, ExternalReference, literalMap, FunctionExpr, IfStmt, InstantiateExpr, InvokeFunctionExpr, InvokeMethodExpr, LiteralArrayExpr, LiteralExpr, LiteralMapExpr, MapType, NotExpr, NONE_TYPE, ReadKeyExpr, ReadPropExpr, ReadVarExpr, ReturnStatement, StatementVisitor, ThrowStmt, TryCatchStmt, Type, TypeVisitor, WrappedNodeExpr, WriteKeyExpr, WritePropExpr, WriteVarExpr, StmtModifier, Statement, STRING_TYPE, TypeofExpr, collectExternalReferences, jsDocComment, leadingComment, LeadingComment, JSDocComment, UnaryOperator, UnaryOperatorExpr, LocalizedString} from './output/output_ast';\n+export {ArrayType, AssertNotNull, DYNAMIC_TYPE, BinaryOperator, BinaryOperatorExpr, BuiltinMethod, BuiltinType, BuiltinTypeName, BuiltinVar, CastExpr, ClassField, ClassMethod, ClassStmt, CommaExpr, ConditionalExpr, DeclareFunctionStmt, DeclareVarStmt, Expression, ExpressionStatement, ExpressionType, ExpressionVisitor, ExternalExpr, ExternalReference, literalMap, FunctionExpr, IfStmt, InstantiateExpr, InvokeFunctionExpr, InvokeMethodExpr, LiteralArrayExpr, LiteralExpr, LiteralMapExpr, MapType, NotExpr, NONE_TYPE, ReadKeyExpr, ReadPropExpr, ReadVarExpr, ReturnStatement, StatementVisitor, TaggedTemplateExpr, TemplateLiteral, TemplateLiteralElement, ThrowStmt, TryCatchStmt, Type, TypeVisitor, WrappedNodeExpr, WriteKeyExpr, WritePropExpr, WriteVarExpr, StmtModifier, Statement, STRING_TYPE, TypeofExpr, collectExternalReferences, jsDocComment, leadingComment, LeadingComment, JSDocComment, UnaryOperator, UnaryOperatorExpr, LocalizedString} from './output/output_ast';\n export {EmitterVisitorContext} from './output/abstract_emitter';\n export {JitEvaluator} from './output/output_jit';\n export * from './output/ts_emitter';"
        },
        {
            "sha": "af5f2f2f4f02f4a12ad1929dfbf456d8a3367cf1",
            "filename": "packages/compiler/src/constant_pool.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Fconstant_pool.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Fconstant_pool.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fconstant_pool.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -324,6 +324,7 @@ class KeyVisitor implements o.ExpressionVisitor {\n   visitWritePropExpr = invalid;\n   visitInvokeMethodExpr = invalid;\n   visitInvokeFunctionExpr = invalid;\n+  visitTaggedTemplateExpr = invalid;\n   visitInstantiateExpr = invalid;\n   visitConditionalExpr = invalid;\n   visitNotExpr = invalid;"
        },
        {
            "sha": "388cb3e8aa34861ec30ce92ff2d7ffb9f93cecc6",
            "filename": "packages/compiler/src/output/abstract_emitter.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_emitter.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_emitter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_emitter.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -344,6 +344,17 @@ export abstract class AbstractEmitterVisitor implements o.StatementVisitor, o.Ex\n     ctx.print(expr, `)`);\n     return null;\n   }\n+  visitTaggedTemplateExpr(expr: o.TaggedTemplateExpr, ctx: EmitterVisitorContext): any {\n+    expr.tag.visitExpression(this, ctx);\n+    ctx.print(expr, '`' + expr.template.elements[0].rawText);\n+    for (let i = 1; i < expr.template.elements.length; i++) {\n+      ctx.print(expr, '${');\n+      expr.template.expressions[i - 1].visitExpression(this, ctx);\n+      ctx.print(expr, `}${expr.template.elements[i].rawText}`);\n+    }\n+    ctx.print(expr, '`');\n+    return null;\n+  }\n   visitWrappedNodeExpr(ast: o.WrappedNodeExpr<any>, ctx: EmitterVisitorContext): any {\n     throw new Error('Abstract emitter cannot visit WrappedNodeExpr.');\n   }"
        },
        {
            "sha": "b0054f02db803e1e021f8fa561ba1220caff66e1",
            "filename": "packages/compiler/src/output/abstract_js_emitter.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 13,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_js_emitter.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_js_emitter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Foutput%2Fabstract_js_emitter.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -10,6 +10,21 @@\n import {AbstractEmitterVisitor, CATCH_ERROR_VAR, CATCH_STACK_VAR, EmitterVisitorContext, escapeIdentifier} from './abstract_emitter';\n import * as o from './output_ast';\n \n+/**\n+ * In TypeScript, tagged template functions expect a \"template object\", which is an array of\n+ * \"cooked\" strings plus a `raw` property that contains an array of \"raw\" strings. This is\n+ * typically constructed with a function called `__makeTemplateObject(cooked, raw)`, but it may not\n+ * be available in all environments.\n+ *\n+ * This is a JavaScript polyfill that uses __makeTemplateObject when it's available, but otherwise\n+ * creates an inline helper with the same functionality.\n+ *\n+ * In the inline function, if `Object.defineProperty` is available we use that to attach the `raw`\n+ * array.\n+ */\n+const makeTemplateObjectPolyfill =\n+    '(this&&this.__makeTemplateObject||function(e,t){return Object.defineProperty?Object.defineProperty(e,\"raw\",{value:t}):e.raw=t,e})';\n+\n export abstract class AbstractJsEmitterVisitor extends AbstractEmitterVisitor {\n   constructor() {\n     super(false);\n@@ -115,6 +130,27 @@ export abstract class AbstractJsEmitterVisitor extends AbstractEmitterVisitor {\n     }\n     return null;\n   }\n+  visitTaggedTemplateExpr(ast: o.TaggedTemplateExpr, ctx: EmitterVisitorContext): any {\n+    // The following convoluted piece of code is effectively the downlevelled equivalent of\n+    // ```\n+    // tag`...`\n+    // ```\n+    // which is effectively like:\n+    // ```\n+    // tag(__makeTemplateObject(cooked, raw), expression1, expression2, ...);\n+    // ```\n+    const elements = ast.template.elements;\n+    ast.tag.visitExpression(this, ctx);\n+    ctx.print(ast, `(${makeTemplateObjectPolyfill}(`);\n+    ctx.print(ast, `[${elements.map(part => escapeIdentifier(part.text, false)).join(', ')}], `);\n+    ctx.print(ast, `[${elements.map(part => escapeIdentifier(part.rawText, false)).join(', ')}])`);\n+    ast.template.expressions.forEach(expression => {\n+      ctx.print(ast, ', ');\n+      expression.visitExpression(this, ctx);\n+    });\n+    ctx.print(ast, ')');\n+    return null;\n+  }\n   visitFunctionExpr(ast: o.FunctionExpr, ctx: EmitterVisitorContext): any {\n     ctx.print(ast, `function${ast.name ? ' ' + ast.name : ''}(`);\n     this._visitParams(ast.params, ctx);\n@@ -161,19 +197,7 @@ export abstract class AbstractJsEmitterVisitor extends AbstractEmitterVisitor {\n     // ```\n     // $localize(__makeTemplateObject(cooked, raw), expression1, expression2, ...);\n     // ```\n-    //\n-    // The `$localize` function expects a \"template object\", which is an array of \"cooked\" strings\n-    // plus a `raw` property that contains an array of \"raw\" strings.\n-    //\n-    // In some environments a helper function called `__makeTemplateObject(cooked, raw)` might be\n-    // available, in which case we use that. Otherwise we must create our own helper function\n-    // inline.\n-    //\n-    // In the inline function, if `Object.defineProperty` is available we use that to attach the\n-    // `raw` array.\n-    ctx.print(\n-        ast,\n-        '$localize((this&&this.__makeTemplateObject||function(e,t){return Object.defineProperty?Object.defineProperty(e,\"raw\",{value:t}):e.raw=t,e})(');\n+    ctx.print(ast, `$localize(${makeTemplateObjectPolyfill}(`);\n     const parts = [ast.serializeI18nHead()];\n     for (let i = 1; i < ast.messageParts.length; i++) {\n       parts.push(ast.serializeI18nTemplatePart(i));"
        },
        {
            "sha": "bf14072310da7d4317f3231a77bde8ca6db82f95",
            "filename": "packages/compiler/src/output/output_ast.ts",
            "status": "modified",
            "additions": 77,
            "deletions": 7,
            "changes": 84,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_ast.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -126,20 +126,26 @@ export function nullSafeIsEquivalent<T extends {isEquivalent(other: T): boolean}\n   return base.isEquivalent(other);\n }\n \n-export function areAllEquivalent<T extends {isEquivalent(other: T): boolean}>(\n-    base: T[], other: T[]) {\n+function areAllEquivalentPredicate<T>(\n+    base: T[], other: T[], equivalentPredicate: (baseElement: T, otherElement: T) => boolean) {\n   const len = base.length;\n   if (len !== other.length) {\n     return false;\n   }\n   for (let i = 0; i < len; i++) {\n-    if (!base[i].isEquivalent(other[i])) {\n+    if (!equivalentPredicate(base[i], other[i])) {\n       return false;\n     }\n   }\n   return true;\n }\n \n+export function areAllEquivalent<T extends {isEquivalent(other: T): boolean}>(\n+    base: T[], other: T[]) {\n+  return areAllEquivalentPredicate(\n+      base, other, (baseElement: T, otherElement: T) => baseElement.isEquivalent(otherElement));\n+}\n+\n export abstract class Expression {\n   public type: Type|null;\n   public sourceSpan: ParseSourceSpan|null;\n@@ -468,6 +474,30 @@ export class InvokeFunctionExpr extends Expression {\n }\n \n \n+export class TaggedTemplateExpr extends Expression {\n+  constructor(\n+      public tag: Expression, public template: TemplateLiteral, type?: Type|null,\n+      sourceSpan?: ParseSourceSpan|null) {\n+    super(type, sourceSpan);\n+  }\n+\n+  isEquivalent(e: Expression): boolean {\n+    return e instanceof TaggedTemplateExpr && this.tag.isEquivalent(e.tag) &&\n+        areAllEquivalentPredicate(\n+               this.template.elements, e.template.elements, (a, b) => a.text === b.text) &&\n+        areAllEquivalent(this.template.expressions, e.template.expressions);\n+  }\n+\n+  isConstant() {\n+    return false;\n+  }\n+\n+  visitExpression(visitor: ExpressionVisitor, context: any): any {\n+    return visitor.visitTaggedTemplateExpr(this, context);\n+  }\n+}\n+\n+\n export class InstantiateExpr extends Expression {\n   constructor(\n       public classExpr: Expression, public args: Expression[], type?: Type|null,\n@@ -510,6 +540,23 @@ export class LiteralExpr extends Expression {\n   }\n }\n \n+export class TemplateLiteral {\n+  constructor(public elements: TemplateLiteralElement[], public expressions: Expression[]) {}\n+}\n+export class TemplateLiteralElement {\n+  rawText: string;\n+  constructor(public text: string, public sourceSpan?: ParseSourceSpan, rawText?: string) {\n+    // If `rawText` is not provided, try to extract the raw string from its\n+    // associated `sourceSpan`. If that is also not available, \"fake\" the raw\n+    // string instead by escaping the following control sequences:\n+    // - \"\\\" would otherwise indicate that the next character is a control character.\n+    // - \"`\" and \"${\" are template string control sequences that would otherwise prematurely\n+    // indicate the end of the template literal element.\n+    this.rawText =\n+        rawText ?? sourceSpan?.toString() ?? escapeForTemplateLiteral(escapeSlashes(text));\n+  }\n+}\n+\n export abstract class MessagePiece {\n   constructor(public text: string, public sourceSpan: ParseSourceSpan) {}\n }\n@@ -603,7 +650,7 @@ export interface CookedRawString {\n const escapeSlashes = (str: string): string => str.replace(/\\\\/g, '\\\\\\\\');\n const escapeStartingColon = (str: string): string => str.replace(/^:/, '\\\\:');\n const escapeColons = (str: string): string => str.replace(/:/g, '\\\\:');\n-const escapeForMessagePart = (str: string): string =>\n+const escapeForTemplateLiteral = (str: string): string =>\n     str.replace(/`/g, '\\\\`').replace(/\\${/g, '$\\\\{');\n \n /**\n@@ -625,13 +672,13 @@ function createCookedRawString(\n   if (metaBlock === '') {\n     return {\n       cooked: messagePart,\n-      raw: escapeForMessagePart(escapeStartingColon(escapeSlashes(messagePart))),\n+      raw: escapeForTemplateLiteral(escapeStartingColon(escapeSlashes(messagePart))),\n       range,\n     };\n   } else {\n     return {\n       cooked: `:${metaBlock}:${messagePart}`,\n-      raw: escapeForMessagePart(\n+      raw: escapeForTemplateLiteral(\n           `:${escapeColons(escapeSlashes(metaBlock))}:${escapeSlashes(messagePart)}`),\n       range,\n     };\n@@ -953,6 +1000,7 @@ export interface ExpressionVisitor {\n   visitWritePropExpr(expr: WritePropExpr, context: any): any;\n   visitInvokeMethodExpr(ast: InvokeMethodExpr, context: any): any;\n   visitInvokeFunctionExpr(ast: InvokeFunctionExpr, context: any): any;\n+  visitTaggedTemplateExpr(ast: TaggedTemplateExpr, context: any): any;\n   visitInstantiateExpr(ast: InstantiateExpr, context: any): any;\n   visitLiteralExpr(ast: LiteralExpr, context: any): any;\n   visitLocalizedString(ast: LocalizedString, context: any): any;\n@@ -1275,6 +1323,17 @@ export class AstTransformer implements StatementVisitor, ExpressionVisitor {\n         context);\n   }\n \n+  visitTaggedTemplateExpr(ast: TaggedTemplateExpr, context: any): any {\n+    return this.transformExpr(\n+        new TaggedTemplateExpr(\n+            ast.tag.visitExpression(this, context),\n+            new TemplateLiteral(\n+                ast.template.elements,\n+                ast.template.expressions.map((e) => e.visitExpression(this, context))),\n+            ast.type, ast.sourceSpan),\n+        context);\n+  }\n+\n   visitInstantiateExpr(ast: InstantiateExpr, context: any): any {\n     return this.transformExpr(\n         new InstantiateExpr(\n@@ -1378,7 +1437,7 @@ export class AstTransformer implements StatementVisitor, ExpressionVisitor {\n     return this.transformExpr(\n         new CommaExpr(this.visitAllExpressions(ast.parts, context), ast.sourceSpan), context);\n   }\n-  visitAllExpressions(exprs: Expression[], context: any): Expression[] {\n+  visitAllExpressions<T extends Expression>(exprs: T[], context: any): T[] {\n     return exprs.map(expr => expr.visitExpression(this, context));\n   }\n \n@@ -1524,6 +1583,11 @@ export class RecursiveAstVisitor implements StatementVisitor, ExpressionVisitor\n     this.visitAllExpressions(ast.args, context);\n     return this.visitExpression(ast, context);\n   }\n+  visitTaggedTemplateExpr(ast: TaggedTemplateExpr, context: any): any {\n+    ast.tag.visitExpression(this, context);\n+    this.visitAllExpressions(ast.template.expressions, context);\n+    return this.visitExpression(ast, context);\n+  }\n   visitInstantiateExpr(ast: InstantiateExpr, context: any): any {\n     ast.classExpr.visitExpression(this, context);\n     this.visitAllExpressions(ast.args, context);\n@@ -1808,6 +1872,12 @@ export function ifStmt(\n   return new IfStmt(condition, thenClause, elseClause, sourceSpan, leadingComments);\n }\n \n+export function taggedTemplate(\n+    tag: Expression, template: TemplateLiteral, type?: Type|null,\n+    sourceSpan?: ParseSourceSpan|null): TaggedTemplateExpr {\n+  return new TaggedTemplateExpr(tag, template, type, sourceSpan);\n+}\n+\n export function literal(\n     value: any, type?: Type|null, sourceSpan?: ParseSourceSpan|null): LiteralExpr {\n   return new LiteralExpr(value, type, sourceSpan);"
        },
        {
            "sha": "22d7dbec8366e2eddef1bfb528bb54e18a644184",
            "filename": "packages/compiler/src/output/output_interpreter.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_interpreter.ts",
            "raw_url": "https://github.com/angular/angular/raw/ef892743ec523a431a10b1232647bc30e8d9f3f9/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_interpreter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Foutput%2Foutput_interpreter.ts?ref=ef892743ec523a431a10b1232647bc30e8d9f3f9",
            "patch": "@@ -197,6 +197,15 @@ class StatementInterpreter implements o.StatementVisitor, o.ExpressionVisitor {\n       return fn.apply(null, args);\n     }\n   }\n+  visitTaggedTemplateExpr(expr: o.TaggedTemplateExpr, ctx: _ExecutionContext): any {\n+    const templateElements = expr.template.elements.map((e) => e.text);\n+    Object.defineProperty(\n+        templateElements, 'raw', {value: expr.template.elements.map((e) => e.rawText)});\n+    const args = this.visitAllExpressions(expr.template.expressions, ctx);\n+    args.unshift(templateElements);\n+    const tag = expr.tag.visitExpression(this, ctx);\n+    return tag.apply(null, args);\n+  }\n   visitReturnStmt(stmt: o.ReturnStatement, ctx: _ExecutionContext): any {\n     return new ReturnValue(stmt.value.visitExpression(this, ctx));\n   }"
        }
    ],
    "stats": {
        "total": 209,
        "additions": 173,
        "deletions": 36
    }
}