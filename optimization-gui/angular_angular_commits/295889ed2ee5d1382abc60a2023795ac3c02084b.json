{
    "author": "gkalpak",
    "message": "ci: prevent CI cache from growing indefinitely (#41814)\n\nPreviously, the fallback key used for the CircleCI cache could match a\ncache indefinitely (as long as `.bazelversion` didn't change). This\nwould allow the cache to grow quite large, which in turn would lead to\nslow-down in CI jobs. See, also, angular/angular-cli#17533 for more\ndetails of the impact of a growing CircleCI cache.\n\nUnfortunately, using something like the lockfile checksum in the\nfallback cache key would cause too many cache misses (esp. with\nautomatic updates via Renovate), again slowing CI down.\n\n(The problem was originally discussed [here][2].)\n\nThis commit uses the technique described in [this blogpost][1] to\ninvalidate the cache monthly. This keeps the extra cache misses low\n(essentially once per month per fork), while also preventing the cache\nfrom growing indefinitely.\n\n[1]: https://support.circleci.com/hc/en-us/articles/360012618473-Creating-a-daily-cache\n[2]: https://github.com/angular/angular/pull/41467#discussion_r607818494\n\nPR Close #41814",
    "sha": "295889ed2ee5d1382abc60a2023795ac3c02084b",
    "files": [
        {
            "sha": "095aa39b90be109d37363dd81c527f582adacc04",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 19,
            "deletions": 8,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/295889ed2ee5d1382abc60a2023795ac3c02084b/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/295889ed2ee5d1382abc60a2023795ac3c02084b/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=295889ed2ee5d1382abc60a2023795ac3c02084b",
            "patch": "@@ -19,23 +19,25 @@ version: 2.1\n # 1) yarn lock file changes --> cached \"node_modules\" are different.\n # 2) bazel repository definitions change --> cached bazel repositories are different.\n # Windows needs its own cache key because binaries in node_modules are different.\n-# **NOTE 1 **: If you change the cache key prefix, also sync the cache_key_fallback to match.\n-# **NOTE 2 **: Keep the static part of the cache key as prefix to enable correct fallbacks.\n+# **NOTE 1 **: In order to avoid the cache from growing indefinitely and causing slow-downs, we invalidate the cache monthly.\n+#              (See https://support.circleci.com/hc/en-us/articles/360012618473-Creating-a-daily-cache.)\n+# **NOTE 2 **: If you change the cache key prefix, also sync the cache_key_fallback to match.\n+# **NOTE 3 **: Keep the static part of the cache key as prefix to enable correct fallbacks.\n # See https://circleci.com/docs/2.0/caching/#restoring-cache for how prefixes work in CircleCI.\n-var_3: &cache_key v4-angular-node-14-{{ checksum \".bazelversion\" }}-{{ checksum \"yarn.lock\" }}-{{ checksum \"WORKSPACE\" }}-{{ checksum \"packages/bazel/package.bzl\" }}-{{ checksum \"aio/yarn.lock\" }}\n+var_3: &cache_key v4-angular-node-14-{{ checksum \"month.txt\" }}-{{ checksum \".bazelversion\" }}-{{ checksum \"yarn.lock\" }}-{{ checksum \"WORKSPACE\" }}-{{ checksum \"packages/bazel/package.bzl\" }}-{{ checksum \"aio/yarn.lock\" }}\n # We invalidate the cache if the Bazel version changes because otherwise the `bazelisk` cache\n # folder will contain all previously used versions and ultimately cause the cache restoring to\n # be slower due to its growing size.\n-var_4: &cache_key_fallback v4-angular-node-14-{{ checksum \".bazelversion\" }}\n+var_4: &cache_key_fallback v4-angular-node-14-{{ checksum \"month.txt\" }}-{{ checksum \".bazelversion\" }}\n \n # Windows needs its own cache key because binaries in node_modules are different.\n-var_3_win: &cache_key_win v4-angular-win-node-14-{{ checksum \".bazelversion\" }}-{{ checksum \"yarn.lock\" }}-{{ checksum \"WORKSPACE\" }}-{{ checksum \"packages/bazel/package.bzl\" }}-{{ checksum \"aio/yarn.lock\" }}\n-var_4_win: &cache_key_win_fallback v4-angular-win-node-14-{{ checksum \".bazelversion\" }}\n+var_3_win: &cache_key_win v4-angular-win-node-14-{{ checksum \"month.txt\" }}-{{ checksum \".bazelversion\" }}-{{ checksum \"yarn.lock\" }}-{{ checksum \"WORKSPACE\" }}-{{ checksum \"packages/bazel/package.bzl\" }}-{{ checksum \"aio/yarn.lock\" }}\n+var_4_win: &cache_key_win_fallback v4-angular-win-node-14-{{ checksum \"month.txt\" }}-{{ checksum \".bazelversion\" }}\n \n # Cache key for the `components-repo-unit-tests` job. **Note** when updating the SHA in the\n # cache keys also update the SHA for the \"COMPONENTS_REPO_COMMIT\" environment variable.\n-var_5: &components_repo_unit_tests_cache_key v1-angular-components-09e68db8ed5b1253f2fe38ff954ef0df019fc25a\n-var_6: &components_repo_unit_tests_cache_key_fallback v1-angular-components-\n+var_5: &components_repo_unit_tests_cache_key v1-angular-components-{{ checksum \"month.txt\" }}-09e68db8ed5b1253f2fe38ff954ef0df019fc25a\n+var_6: &components_repo_unit_tests_cache_key_fallback v1-angular-components-{{ checksum \"month.txt\" }}\n \n # Workspace initially persisted by the `setup` job, and then enhanced by `build-npm-packages` and\n # `build-ivy-npm-packages`.\n@@ -180,13 +182,21 @@ commands:\n           name: Setting up alias domain for local host.\n           command: echo \"127.0.0.1 $SAUCE_LOCALHOST_ALIAS_DOMAIN\" | sudo tee -a /etc/hosts\n \n+  save_month_to_file:\n+    description: Store the current year and month in a file, so that it can be used for computing the cache key.\n+    steps:\n+      - run:\n+          name: Save month to file\n+          command: date +%Y-%m > month.txt\n+\n   # Normally this would be an individual job instead of a command.\n   # But startup and setup time for each individual windows job are high enough to discourage\n   # many small jobs, so instead we use a command for setup unless the gain becomes significant.\n   setup_win:\n     description: Setup windows node environment\n     steps:\n       - checkout\n+      - save_month_to_file\n       # Install Bazel pre-requisites that aren't in the preconfigured CircleCI Windows VM.\n       - run: ./.circleci/windows-env.ps1\n       - run: node --version\n@@ -220,6 +230,7 @@ jobs:\n     executor: default-executor\n     steps:\n       - checkout\n+      - save_month_to_file\n       - init_environment\n       - run:\n           name: Rebase PR on target branch"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 19,
        "deletions": 8
    }
}