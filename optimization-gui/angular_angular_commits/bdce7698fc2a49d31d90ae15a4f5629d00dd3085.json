{
    "author": "gkalpak",
    "message": "fix(elements): update the view of an `OnPush` component when inputs change (#39452)\n\nAs with regular Angular components, Angular elements are expected to\nhave their views update when inputs change.\n\nPreviously, Angular Elements views were not updated if the underlying\ncomponent used the `OnPush` change detection strategy.\n\nThis commit fixes this by calling `markForCheck()` on the component\nview's `ChangeDetectorRef`.\n\nNOTE:\nThis is similar to how `@angular/upgrade` does it:\nhttps://github.com/angular/angular/blob/3236ae0ee118d0734c90fa9f3767435396213470/packages/upgrade/src/common/src/downgrade_component_adapter.ts#L146.\n\nFixes #38948\n\nPR Close #39452",
    "sha": "bdce7698fc2a49d31d90ae15a4f5629d00dd3085",
    "files": [
        {
            "sha": "f92c20b32d6e8cdfb38b15213f611d48a10c9075",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=bdce7698fc2a49d31d90ae15a4f5629d00dd3085",
            "patch": "@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3037,\n-        \"main-es2015\": 448615,\n+        \"main-es2015\": 448922,\n         \"polyfills-es2015\": 52415\n       }\n     }\n@@ -21,7 +21,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 3157,\n-        \"main-es2015\": 431750,\n+        \"main-es2015\": 432199,\n         \"polyfills-es2015\": 52415\n       }\n     }"
        },
        {
            "sha": "0d7e65ffbcef7ca8d9b8d80a496db0734b211169",
            "filename": "integration/ng_elements/e2e/app.e2e-spec.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/integration%2Fng_elements%2Fe2e%2Fapp.e2e-spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/integration%2Fng_elements%2Fe2e%2Fapp.e2e-spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fng_elements%2Fe2e%2Fapp.e2e-spec.ts?ref=bdce7698fc2a49d31d90ae15a4f5629d00dd3085",
            "patch": "@@ -5,7 +5,7 @@ describe('Element E2E Tests', function () {\n   describe('Hello World Elements', () => {\n     beforeEach(() => browser.get('hello-world.html'));\n \n-    describe('(with default view encapsulation)', () => {\n+    describe('(with default CD strategy and view encapsulation)', () => {\n       const helloWorldEl = element(by.css('hello-world-el'));\n \n       it('should display \"Hello World!\"', function () {\n@@ -21,6 +21,22 @@ describe('Element E2E Tests', function () {\n       });\n     });\n \n+    describe('(with `OnPush` CD strategy)', () => {\n+      const helloWorldOnpushEl = element(by.css('hello-world-onpush-el'));\n+\n+      it('should display \"Hello World!\"', function () {\n+        expect(helloWorldOnpushEl.getText()).toBe('Hello World!');\n+      });\n+\n+      it('should display \"Hello Foo!\" via name attribute', function () {\n+        const input = element(by.css('input[type=text]'));\n+        input.sendKeys('Foo');\n+\n+        // Make tests less flaky on CI by waiting up to 5s for the element text to be updated.\n+        browser.wait(EC.textToBePresentInElement(helloWorldOnpushEl, 'Hello Foo!'), 5000);\n+      });\n+    });\n+\n     describe('(with `ShadowDom` view encapsulation)', () => {\n       const helloWorldShadowEl = element(by.css('hello-world-shadow-el'));\n       const getShadowDomText = (el: ElementFinder) =>"
        },
        {
            "sha": "8064cce22f596a1214bd4062013c30b68787e8b1",
            "filename": "integration/ng_elements/src/app.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/integration%2Fng_elements%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/angular/angular/raw/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/integration%2Fng_elements%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fng_elements%2Fsrc%2Fapp.ts?ref=bdce7698fc2a49d31d90ae15a4f5629d00dd3085",
            "patch": "@@ -2,17 +2,29 @@ import {Injector, NgModule} from '@angular/core';\n import {createCustomElement} from '@angular/elements';\n import {BrowserModule} from '@angular/platform-browser';\n \n-import {HelloWorldComponent, HelloWorldShadowComponent, TestCardComponent} from './elements';\n+import {HelloWorldComponent, HelloWorldOnpushComponent, HelloWorldShadowComponent, TestCardComponent} from './elements';\n \n \n @NgModule({\n-  declarations: [HelloWorldComponent, HelloWorldShadowComponent, TestCardComponent],\n-  entryComponents: [HelloWorldComponent, HelloWorldShadowComponent, TestCardComponent],\n+  declarations: [\n+    HelloWorldComponent,\n+    HelloWorldOnpushComponent,\n+    HelloWorldShadowComponent,\n+    TestCardComponent,\n+  ],\n+  entryComponents: [\n+    HelloWorldComponent,\n+    HelloWorldOnpushComponent,\n+    HelloWorldShadowComponent,\n+    TestCardComponent,\n+  ],\n   imports: [BrowserModule],\n })\n export class AppModule {\n   constructor(injector: Injector) {\n     customElements.define('hello-world-el', createCustomElement(HelloWorldComponent, {injector}));\n+    customElements.define(\n+        'hello-world-onpush-el', createCustomElement(HelloWorldOnpushComponent, {injector}));\n     customElements.define(\n         'hello-world-shadow-el', createCustomElement(HelloWorldShadowComponent, {injector}));\n     customElements.define('test-card', createCustomElement(TestCardComponent, {injector}));"
        },
        {
            "sha": "e3252e7761c6973dd8939a436c885238de673aee",
            "filename": "integration/ng_elements/src/elements.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/integration%2Fng_elements%2Fsrc%2Felements.ts",
            "raw_url": "https://github.com/angular/angular/raw/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/integration%2Fng_elements%2Fsrc%2Felements.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fng_elements%2Fsrc%2Felements.ts?ref=bdce7698fc2a49d31d90ae15a4f5629d00dd3085",
            "patch": "@@ -1,4 +1,4 @@\n-import {Component, Input, ViewEncapsulation} from '@angular/core';\n+import {ChangeDetectionStrategy, Component, Input, ViewEncapsulation} from '@angular/core';\n \n @Component({\n   selector: 'hello-world-el',\n@@ -8,6 +8,15 @@ export class HelloWorldComponent {\n   @Input() name: string = 'World';\n }\n \n+@Component({\n+  selector: 'hello-world-onpush-el',\n+  template: 'Hello {{name}}!',\n+  changeDetection: ChangeDetectionStrategy.OnPush,\n+})\n+export class HelloWorldOnpushComponent {\n+  @Input() name: string = 'World';\n+}\n+\n @Component({\n   selector: 'hello-world-shadow-el',\n   template: 'Hello {{name}}!',"
        },
        {
            "sha": "d9b2136e25aca423ea14b94654e394ab743c3036",
            "filename": "integration/ng_elements/src/hello-world.html",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/integration%2Fng_elements%2Fsrc%2Fhello-world.html",
            "raw_url": "https://github.com/angular/angular/raw/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/integration%2Fng_elements%2Fsrc%2Fhello-world.html",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fng_elements%2Fsrc%2Fhello-world.html?ref=bdce7698fc2a49d31d90ae15a4f5629d00dd3085",
            "patch": "@@ -10,6 +10,7 @@\n <body>\n   <input type=\"text\">\n   <hello-world-el></hello-world-el>\n+  <hello-world-onpush-el></hello-world-onpush-el>\n   <hello-world-shadow-el></hello-world-shadow-el>\n   <script src=\"dist/bundle.js\"></script>\n </body>"
        },
        {
            "sha": "608f5bd5aa2fcbb7b3241bfb11e8eef5312bba9e",
            "filename": "integration/ng_elements/src/main.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/integration%2Fng_elements%2Fsrc%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/integration%2Fng_elements%2Fsrc%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fng_elements%2Fsrc%2Fmain.ts?ref=bdce7698fc2a49d31d90ae15a4f5629d00dd3085",
            "patch": "@@ -5,9 +5,11 @@ platformBrowser().bootstrapModuleFactory(AppModuleNgFactory, {ngZone: 'noop'});\n \n const input = document.querySelector('input')!;\n const helloWorld = document.querySelector('hello-world-el')!;\n+const helloWorldOnpush = document.querySelector('hello-world-onpush-el')!;\n const helloWorldShadow = document.querySelector('hello-world-shadow-el')!;\n \n input.addEventListener('input', () => {\n   helloWorld.setAttribute('name', input.value);\n+  helloWorldOnpush.setAttribute('name', input.value);\n   helloWorldShadow.setAttribute('name', input.value);\n });"
        },
        {
            "sha": "0d013c26b5c0ee3edc737f9b0f7493fb09722234",
            "filename": "packages/elements/src/component-factory-strategy.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 17,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/packages%2Felements%2Fsrc%2Fcomponent-factory-strategy.ts",
            "raw_url": "https://github.com/angular/angular/raw/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/packages%2Felements%2Fsrc%2Fcomponent-factory-strategy.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Felements%2Fsrc%2Fcomponent-factory-strategy.ts?ref=bdce7698fc2a49d31d90ae15a4f5629d00dd3085",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ApplicationRef, ComponentFactory, ComponentFactoryResolver, ComponentRef, EventEmitter, Injector, NgZone, OnChanges, SimpleChange, SimpleChanges, Type} from '@angular/core';\n+import {ApplicationRef, ChangeDetectorRef, ComponentFactory, ComponentFactoryResolver, ComponentRef, EventEmitter, Injector, NgZone, OnChanges, SimpleChange, SimpleChanges, Type} from '@angular/core';\n import {merge, Observable, ReplaySubject} from 'rxjs';\n import {map, switchMap} from 'rxjs/operators';\n \n@@ -52,10 +52,19 @@ export class ComponentNgElementStrategy implements NgElementStrategy {\n   /** Reference to the component that was created on connect. */\n   private componentRef: ComponentRef<any>|null = null;\n \n-  /** Changes that have been made to the component ref since the last time onChanges was called. */\n+  /** Reference to the component view's `ChangeDetectorRef`. */\n+  private viewChangeDetectorRef: ChangeDetectorRef|null = null;\n+\n+  /**\n+   * Changes that have been made to component inputs since the last change detection run.\n+   * (NOTE: These are only recorded if the component implements the `OnChanges` interface.)\n+   */\n   private inputChanges: SimpleChanges|null = null;\n \n-  /** Whether the created component implements the onChanges function. */\n+  /** Whether changes have been made to component inputs since the last change detection run. */\n+  private hasInputChanges = false;\n+\n+  /** Whether the created component implements the `OnChanges` interface. */\n   private implementsOnChanges = false;\n \n   /** Whether a change detection has been scheduled to run on the component. */\n@@ -68,10 +77,12 @@ export class ComponentNgElementStrategy implements NgElementStrategy {\n   private readonly initialInputValues = new Map<string, any>();\n \n   /**\n-   * Set of component inputs that have not yet changed, i.e. for which `ngOnChanges()` has not\n-   * fired. (This is used to determine the value of `fistChange` in `SimpleChange` instances.)\n+   * Set of component inputs that have not yet changed, i.e. for which `recordInputChange()` has not\n+   * fired.\n+   * (This helps detect the first change of an input, even if it is explicitly set to `undefined`.)\n    */\n-  private readonly unchangedInputs = new Set<string>();\n+  private readonly unchangedInputs =\n+      new Set<string>(this.componentFactory.inputs.map(({propName}) => propName));\n \n   /** Service for setting zone context. */\n   private readonly ngZone = this.injector.get<NgZone>(NgZone);\n@@ -119,6 +130,7 @@ export class ComponentNgElementStrategy implements NgElementStrategy {\n         if (this.componentRef !== null) {\n           this.componentRef.destroy();\n           this.componentRef = null;\n+          this.viewChangeDetectorRef = null;\n         }\n       }, DESTROY_DELAY);\n     });\n@@ -157,7 +169,13 @@ export class ComponentNgElementStrategy implements NgElementStrategy {\n         return;\n       }\n \n+      // Record the changed value and update internal state to reflect the fact that this input has\n+      // changed.\n       this.recordInputChange(property, value);\n+      this.unchangedInputs.delete(property);\n+      this.hasInputChanges = true;\n+\n+      // Update the component instance and schedule change detection.\n       this.componentRef.instance[property] = value;\n       this.scheduleDetectChanges();\n     });\n@@ -172,6 +190,7 @@ export class ComponentNgElementStrategy implements NgElementStrategy {\n     const projectableNodes =\n         extractProjectableNodes(element, this.componentFactory.ngContentSelectors);\n     this.componentRef = this.componentFactory.create(childInjector, projectableNodes, element);\n+    this.viewChangeDetectorRef = this.componentRef.injector.get(ChangeDetectorRef);\n \n     this.implementsOnChanges = isFunction((this.componentRef.instance as OnChanges).ngOnChanges);\n \n@@ -187,12 +206,6 @@ export class ComponentNgElementStrategy implements NgElementStrategy {\n   /** Set any stored initial inputs on the component's properties. */\n   protected initializeInputs(): void {\n     this.componentFactory.inputs.forEach(({propName}) => {\n-      if (this.implementsOnChanges) {\n-        // If the component implements `ngOnChanges()`, keep track of which inputs have never\n-        // changed so far.\n-        this.unchangedInputs.add(propName);\n-      }\n-\n       if (this.initialInputValues.has(propName)) {\n         // Call `setInputValue()` now that the component has been instantiated to update its\n         // properties and fire `ngOnChanges()`.\n@@ -227,6 +240,17 @@ export class ComponentNgElementStrategy implements NgElementStrategy {\n     (componentRef.instance as OnChanges).ngOnChanges(inputChanges);\n   }\n \n+  /**\n+   * Marks the component view for check, if necessary.\n+   * (NOTE: This is required when the `ChangeDetectionStrategy` is set to `OnPush`.)\n+   */\n+  protected markViewForCheck(viewChangeDetectorRef: ChangeDetectorRef): void {\n+    if (this.hasInputChanges) {\n+      this.hasInputChanges = false;\n+      viewChangeDetectorRef.markForCheck();\n+    }\n+  }\n+\n   /**\n    * Schedules change detection to run on the component.\n    * Ignores subsequent calls if already scheduled.\n@@ -247,8 +271,7 @@ export class ComponentNgElementStrategy implements NgElementStrategy {\n    */\n   protected recordInputChange(property: string, currentValue: any): void {\n     // Do not record the change if the component does not implement `OnChanges`.\n-    // (We can only determine that after the component has been instantiated.)\n-    if (this.componentRef !== null && !this.implementsOnChanges) {\n+    if (!this.implementsOnChanges) {\n       return;\n     }\n \n@@ -257,16 +280,14 @@ export class ComponentNgElementStrategy implements NgElementStrategy {\n     }\n \n     // If there already is a change, modify the current value to match but leave the values for\n-    // previousValue and isFirstChange.\n+    // `previousValue` and `isFirstChange`.\n     const pendingChange = this.inputChanges[property];\n     if (pendingChange) {\n       pendingChange.currentValue = currentValue;\n       return;\n     }\n \n     const isFirstChange = this.unchangedInputs.has(property);\n-    this.unchangedInputs.delete(property);\n-\n     const previousValue = isFirstChange ? undefined : this.getInputValue(property);\n     this.inputChanges[property] = new SimpleChange(previousValue, currentValue, isFirstChange);\n   }\n@@ -278,6 +299,7 @@ export class ComponentNgElementStrategy implements NgElementStrategy {\n     }\n \n     this.callNgOnChanges(this.componentRef);\n+    this.markViewForCheck(this.viewChangeDetectorRef!);\n     this.componentRef.changeDetectorRef.detectChanges();\n   }\n "
        },
        {
            "sha": "00bcb97a50a58d54a1dce84c29a86a29fded9e0d",
            "filename": "packages/elements/test/component-factory-strategy_spec.ts",
            "status": "modified",
            "additions": 104,
            "deletions": 1,
            "changes": 105,
            "blob_url": "https://github.com/angular/angular/blob/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/packages%2Felements%2Ftest%2Fcomponent-factory-strategy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bdce7698fc2a49d31d90ae15a4f5629d00dd3085/packages%2Felements%2Ftest%2Fcomponent-factory-strategy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Felements%2Ftest%2Fcomponent-factory-strategy_spec.ts?ref=bdce7698fc2a49d31d90ae15a4f5629d00dd3085",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ApplicationRef, ComponentFactory, ComponentFactoryResolver, ComponentRef, Injector, NgModuleRef, NgZone, SimpleChange, SimpleChanges, Type} from '@angular/core';\n+import {ApplicationRef, ChangeDetectorRef, ComponentFactory, ComponentFactoryResolver, ComponentRef, Injector, NgModuleRef, NgZone, SimpleChange, SimpleChanges, Type} from '@angular/core';\n import {fakeAsync, tick} from '@angular/core/testing';\n import {Subject} from 'rxjs';\n \n@@ -180,8 +180,11 @@ describe('ComponentFactoryNgElementStrategy', () => {\n   });\n \n   describe('when inputs change and is connected', () => {\n+    let viewChangeDetectorRef: ChangeDetectorRef;\n+\n     beforeEach(() => {\n       strategy.connect(document.createElement('div'));\n+      viewChangeDetectorRef = componentRef.injector.get(ChangeDetectorRef);\n     });\n \n     it('should be set on the component instance', () => {\n@@ -209,6 +212,22 @@ describe('ComponentFactoryNgElementStrategy', () => {\n          expect(componentRef.changeDetectorRef.detectChanges).toHaveBeenCalledTimes(2);\n        }));\n \n+    it('should not detect changes if the input is set to the same value', fakeAsync(() => {\n+         (componentRef.changeDetectorRef.detectChanges as jasmine.Spy).calls.reset();\n+\n+         strategy.setInputValue('fooFoo', 'fooFoo-1');\n+         strategy.setInputValue('barBar', 'barBar-1');\n+         tick(16);  // scheduler waits 16ms if RAF is unavailable\n+         expect(componentRef.changeDetectorRef.detectChanges).toHaveBeenCalledTimes(1);\n+\n+         (componentRef.changeDetectorRef.detectChanges as jasmine.Spy).calls.reset();\n+\n+         strategy.setInputValue('fooFoo', 'fooFoo-1');\n+         strategy.setInputValue('barBar', 'barBar-1');\n+         tick(16);  // scheduler waits 16ms if RAF is unavailable\n+         expect(componentRef.changeDetectorRef.detectChanges).not.toHaveBeenCalled();\n+       }));\n+\n     it('should call ngOnChanges', fakeAsync(() => {\n          strategy.setInputValue('fooFoo', 'fooFoo-1');\n          tick(16);  // scheduler waits 16ms if RAF is unavailable\n@@ -246,6 +265,22 @@ describe('ComponentFactoryNgElementStrategy', () => {\n          });\n        }));\n \n+    it('should not call ngOnChanges if the inout is set to the same value', fakeAsync(() => {\n+         const ngOnChangesSpy = spyOn(componentRef.instance, 'ngOnChanges');\n+\n+         strategy.setInputValue('fooFoo', 'fooFoo-1');\n+         strategy.setInputValue('barBar', 'barBar-1');\n+         tick(16);  // scheduler waits 16ms if RAF is unavailable\n+         expect(ngOnChangesSpy).toHaveBeenCalledTimes(1);\n+\n+         ngOnChangesSpy.calls.reset();\n+\n+         strategy.setInputValue('fooFoo', 'fooFoo-1');\n+         strategy.setInputValue('barBar', 'barBar-1');\n+         tick(16);  // scheduler waits 16ms if RAF is unavailable\n+         expect(ngOnChangesSpy).not.toHaveBeenCalled();\n+       }));\n+\n     it('should not try to call ngOnChanges if not present on the component', fakeAsync(() => {\n          const factory2 = new FakeComponentFactory(FakeComponentWithoutNgOnChanges);\n          const strategy2 = new ComponentNgElementStrategy(factory2, injector);\n@@ -261,6 +296,71 @@ describe('ComponentFactoryNgElementStrategy', () => {\n          // been thrown and `changeDetectorRef2.detectChanges()` would not have been called.\n          expect(changeDetectorRef2.detectChanges).toHaveBeenCalledTimes(1);\n        }));\n+\n+    it('should mark the view for check', fakeAsync(() => {\n+         expect(viewChangeDetectorRef.markForCheck).not.toHaveBeenCalled();\n+\n+         strategy.setInputValue('fooFoo', 'fooFoo-1');\n+         tick(16);  // scheduler waits 16ms if RAF is unavailable\n+\n+         expect(viewChangeDetectorRef.markForCheck).toHaveBeenCalledTimes(1);\n+       }));\n+\n+    it('should mark the view for check once for multiple input changes', fakeAsync(() => {\n+         strategy.setInputValue('fooFoo', 'fooFoo-1');\n+         strategy.setInputValue('barBar', 'barBar-1');\n+         tick(16);  // scheduler waits 16ms if RAF is unavailable\n+\n+         expect(viewChangeDetectorRef.markForCheck).toHaveBeenCalledTimes(1);\n+       }));\n+\n+    it('should mark the view for check twice for changes in different rounds with previous values',\n+       fakeAsync(() => {\n+         strategy.setInputValue('fooFoo', 'fooFoo-1');\n+         strategy.setInputValue('barBar', 'barBar-1');\n+         tick(16);  // scheduler waits 16ms if RAF is unavailable\n+\n+         expect(viewChangeDetectorRef.markForCheck).toHaveBeenCalledTimes(1);\n+\n+         strategy.setInputValue('fooFoo', 'fooFoo-2');\n+         strategy.setInputValue('barBar', 'barBar-2');\n+         tick(16);  // scheduler waits 16ms if RAF is unavailable\n+\n+         expect(viewChangeDetectorRef.markForCheck).toHaveBeenCalledTimes(2);\n+       }));\n+\n+    it('should mark the view for check even if ngOnChanges is not present on the component',\n+       fakeAsync(() => {\n+         const factory2 = new FakeComponentFactory(FakeComponentWithoutNgOnChanges);\n+         const strategy2 = new ComponentNgElementStrategy(factory2, injector);\n+         const viewChangeDetectorRef2 = factory2.componentRef.injector.get(ChangeDetectorRef);\n+\n+         strategy2.connect(document.createElement('div'));\n+         (viewChangeDetectorRef2.markForCheck as jasmine.Spy).calls.reset();\n+\n+         strategy2.setInputValue('fooFoo', 'fooFoo-1');\n+         expect(() => tick(16)).not.toThrow();  // scheduler waits 16ms if RAF is unavailable\n+\n+         // If the strategy would have tried to call `component.ngOnChanges()`, an error would have\n+         // been thrown and `viewChangeDetectorRef2.markForCheck()` would not have been called.\n+         expect(viewChangeDetectorRef2.markForCheck).toHaveBeenCalledTimes(1);\n+       }));\n+\n+    it('should not mark the view for check if the input is set to the same value', fakeAsync(() => {\n+         (viewChangeDetectorRef.markForCheck as jasmine.Spy).calls.reset();\n+\n+         strategy.setInputValue('fooFoo', 'fooFoo-1');\n+         strategy.setInputValue('barBar', 'barBar-1');\n+         tick(16);  // scheduler waits 16ms if RAF is unavailable\n+         expect(viewChangeDetectorRef.markForCheck).toHaveBeenCalledTimes(1);\n+\n+         (viewChangeDetectorRef.markForCheck as jasmine.Spy).calls.reset();\n+\n+         strategy.setInputValue('fooFoo', 'fooFoo-1');\n+         strategy.setInputValue('barBar', 'barBar-1');\n+         tick(16);  // scheduler waits 16ms if RAF is unavailable\n+         expect(viewChangeDetectorRef.markForCheck).not.toHaveBeenCalled();\n+       }));\n   });\n \n   describe('disconnect', () => {\n@@ -345,6 +445,9 @@ export class FakeComponentFactory<T extends Type<any>> extends ComponentFactory<\n       {\n         changeDetectorRef: jasmine.createSpyObj('changeDetectorRef', ['detectChanges']),\n         hostView: {},\n+        injector: jasmine.createSpyObj('injector', {\n+          get: jasmine.createSpyObj('viewChangeDetectorRef', ['markForCheck']),\n+        }),\n         instance: new this.ComponentClass(),\n       });\n "
        }
    ],
    "stats": {
        "total": 215,
        "additions": 190,
        "deletions": 25
    }
}