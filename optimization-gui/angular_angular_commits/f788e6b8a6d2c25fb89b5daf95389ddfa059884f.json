{
    "author": "petebacondarwin",
    "message": "refactor(docs-infra): prepare DocumentService to handle new disambiguated URLs (#42509)\n\nA subsequent commit is going to change disambiguated URLs.\nThis commit prepares the AIO application to attempt the new URLs\nif the old URLs fail. This will help to mitigate problems that may occur\nduring the period between deployment of the new version and the\nservice-worker not being updated.\n\nPR Close #42509",
    "sha": "f788e6b8a6d2c25fb89b5daf95389ddfa059884f",
    "files": [
        {
            "sha": "4acddefe7caa2a40c0930d5bfe144cd2f4ab0c70",
            "filename": "aio/src/app/documents/document.service.spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/f788e6b8a6d2c25fb89b5daf95389ddfa059884f/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f788e6b8a6d2c25fb89b5daf95389ddfa059884f/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.spec.ts?ref=f788e6b8a6d2c25fb89b5daf95389ddfa059884f",
            "patch": "@@ -67,6 +67,30 @@ describe('DocumentService', () => {\n       expect(latestDocument).toEqual(doc1);\n     });\n \n+    // HACK: PREPARE FOR CHANGING TO CASE-INSENSITIVE URLS\n+    it('should attempt disambiguated document paths if the document is not found on the server', () => {\n+      let currentDocument: DocumentContents|undefined;\n+      const notFoundDoc = { id: FILE_NOT_FOUND_ID, contents: '<h1>Page Not Found</h1>' };\n+      const { docService, logger } = getServices('missing/Doc-1');\n+      docService.currentDocument.subscribe(doc => currentDocument = doc);\n+\n+      // Initial request return 404.\n+      httpMock.expectOne({url: 'generated/docs/missing/Doc-1.json'}).flush(null, {status: 404, statusText: 'NOT FOUND'});\n+      httpMock.expectOne({url: 'generated/docs/missing/d_oc-1.json'}).flush(null, {status: 404, statusText: 'NOT FOUND'});\n+      httpMock.expectOne({url: 'generated/docs/missing/d_oc.json'}).flush(null, {status: 404, statusText: 'NOT FOUND'});\n+      expect(logger.output.error).toEqual([\n+        [jasmine.any(Error)]\n+      ]);\n+      expect(logger.output.error[0][0].message).toEqual(`Document file not found at 'missing/Doc-1'`);\n+\n+      // Subsequent request for not-found document.\n+      logger.output.error = [];\n+      httpMock.expectOne(CONTENT_URL_PREFIX + 'file-not-found.json').flush(notFoundDoc);\n+      expect(logger.output.error).toEqual([]); // does not report repeated errors\n+      expect(currentDocument).toEqual(notFoundDoc);\n+    });\n+    // END HACK: PREPARE FOR CHANGING TO CASE-INSENSITIVE URLS\n+\n     it('should emit the not-found document if the document is not found on the server', () => {\n       let currentDocument: DocumentContents|undefined;\n       const notFoundDoc = { id: FILE_NOT_FOUND_ID, contents: '<h1>Page Not Found</h1>' };\n@@ -83,7 +107,7 @@ describe('DocumentService', () => {\n       // Subsequent request for not-found document.\n       logger.output.error = [];\n       httpMock.expectOne(CONTENT_URL_PREFIX + 'file-not-found.json').flush(notFoundDoc);\n-      expect(logger.output.error).toEqual([]); // does not report repeate errors\n+      expect(logger.output.error).toEqual([]); // does not report repeated errors\n       expect(currentDocument).toEqual(notFoundDoc);\n     });\n "
        },
        {
            "sha": "9d521f32326175e776ddc553bbd49d92a26067c9",
            "filename": "aio/src/app/documents/document.service.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 1,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/f788e6b8a6d2c25fb89b5daf95389ddfa059884f/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/f788e6b8a6d2c25fb89b5daf95389ddfa059884f/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.ts?ref=f788e6b8a6d2c25fb89b5daf95389ddfa059884f",
            "patch": "@@ -1,7 +1,7 @@\n import { Injectable } from '@angular/core';\n import { HttpClient, HttpErrorResponse } from '@angular/common/http';\n \n-import { AsyncSubject, Observable, of } from 'rxjs';\n+import { AsyncSubject, Observable, of, throwError } from 'rxjs';\n import { catchError, switchMap, tap } from 'rxjs/operators';\n \n import { DocumentContents } from './document-contents';\n@@ -66,6 +66,20 @@ export class DocumentService {\n             throw Error('Invalid data');\n           }\n         }),\n+        // HACK: PREPARE FOR CHANGING TO CASE-INSENSITIVE URLS\n+        catchError((error: HttpErrorResponse) => {\n+          const encodedPath = encodeToLowercase(requestPath);\n+          return error.status === 404 && encodedPath !== requestPath ?\n+              this.http.get<DocumentContents>(encodedPath) :\n+              throwError(error);\n+        }),\n+        catchError((error: HttpErrorResponse) => {\n+          const disambiguatedPath = convertDisambiguatedPath(requestPath);\n+          return error.status === 404 && disambiguatedPath !== requestPath ?\n+              this.http.get<DocumentContents>(disambiguatedPath) :\n+              throwError(error);\n+        }),\n+        // END HACK: PREPARE FOR CHANGING TO CASE-INSENSITIVE URLS\n         catchError((error: HttpErrorResponse) => {\n           return error.status === 404 ? this.getFileNotFoundDoc(id) : this.getErrorDoc(id, error);\n         }),\n@@ -97,3 +111,30 @@ export class DocumentService {\n     });\n   }\n }\n+\n+/**\n+ * Encode the path to the content in a deterministic, reversible, case-insensitive form.\n+ *\n+ * This avoids collisions on case-insensitive file-systems.\n+ *\n+ * - Escape underscores (_) to double underscores (__).\n+ * - Convert all uppercase letters to lowercase followed by an underscore.\n+ */\n+function encodeToLowercase(str: string): string {\n+  return str.replace(/[A-Z_]/g, char => char.toLowerCase() + '_');\n+}\n+\n+/**\n+ * A temporary function to deal with a future change to URL disambiguation.\n+ *\n+ * Currently there are disambiguated URLs such as `INJECTOR-0` and `Injector-1`, which\n+ * will attempt to load their document contents from `injector-0.json` and `injector-1.json`\n+ * respectively. In a future version of the AIO app, the disambiguation will be changed to\n+ * escape the upper-case characters instead.\n+ *\n+ * This function will be called if the current AIO is trying to request documents from a\n+ * server that has been updated to use the new disambiguated URLs.\n+ */\n+function convertDisambiguatedPath(str: string): string {\n+  return encodeToLowercase(str.replace(/-\\d+\\.json$/, '.json'));\n+}"
        },
        {
            "sha": "94291ad9551ab6eafedd20b867eef477aca2158b",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/f788e6b8a6d2c25fb89b5daf95389ddfa059884f/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/f788e6b8a6d2c25fb89b5daf95389ddfa059884f/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=f788e6b8a6d2c25fb89b5daf95389ddfa059884f",
            "patch": "@@ -3,7 +3,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 4619,\n-        \"main-es2015\": 453172,\n+        \"main-es2015\": 453855,\n         \"polyfills-es2015\": 55210\n       }\n     }\n@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 4619,\n-        \"main-es2015\": 453394,\n+        \"main-es2015\": 453981,\n         \"polyfills-es2015\": 55291\n       }\n     }"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 69,
        "deletions": 4
    }
}