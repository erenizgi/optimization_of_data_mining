{
    "author": "dario-piotrowicz",
    "message": "fix(animations): normalize final styles in buildStyles (#42763)\n\nthe final styles created in buildStyles lack normalization, meaning that pixel values remain as numbers (without \"px\") and so such properties fail to be correctly set/applied\n\nExample: \"width: 300\" is applies as \"width\": \"300\" (and thus ignored) instead of the correct \"width\": \"300px\"\n\nPR Close #42763",
    "sha": "f12c53342c433eb8ef5650c78f0115f82f5b1567",
    "files": [
        {
            "sha": "02d3a2f43a49a29c32c200be0f44aa99077023e1",
            "filename": "packages/animations/browser/src/dsl/animation_transition_factory.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Fsrc%2Fdsl%2Fanimation_transition_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Fsrc%2Fdsl%2Fanimation_transition_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Fsrc%2Fdsl%2Fanimation_transition_factory.ts?ref=f12c53342c433eb8ef5650c78f0115f82f5b1567",
            "patch": "@@ -16,6 +16,7 @@ import {buildAnimationTimelines} from './animation_timeline_builder';\n import {TransitionMatcherFn} from './animation_transition_expr';\n import {AnimationTransitionInstruction, createTransitionInstruction} from './animation_transition_instruction';\n import {ElementInstructionMap} from './element_instruction_map';\n+import {AnimationStyleNormalizer} from './style_normalization/animation_style_normalizer';\n \n const EMPTY_OBJECT = {};\n \n@@ -99,7 +100,9 @@ function oneOrMoreTransitionsMatch(\n }\n \n export class AnimationStateStyles {\n-  constructor(private styles: StyleAst, private defaultParams: {[key: string]: any}) {}\n+  constructor(\n+      private styles: StyleAst, private defaultParams: {[key: string]: any},\n+      private normalizer: AnimationStyleNormalizer) {}\n \n   buildStyles(params: {[key: string]: any}, errors: string[]): ɵStyleData {\n     const finalStyles: ɵStyleData = {};\n@@ -118,7 +121,9 @@ export class AnimationStateStyles {\n           if (val.length > 1) {\n             val = interpolateParams(val, combinedParams, errors);\n           }\n-          finalStyles[prop] = val;\n+          const normalizedProp = this.normalizer.normalizePropertyName(prop, errors);\n+          val = this.normalizer.normalizeStyleValue(prop, normalizedProp, val, errors);\n+          finalStyles[normalizedProp] = val;\n         });\n       }\n     });"
        },
        {
            "sha": "fcaafbe057ebef7f488c1cfb05ce606da8d3919a",
            "filename": "packages/animations/browser/src/dsl/animation_trigger.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Fsrc%2Fdsl%2Fanimation_trigger.ts",
            "raw_url": "https://github.com/angular/angular/raw/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Fsrc%2Fdsl%2Fanimation_trigger.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Fsrc%2Fdsl%2Fanimation_trigger.ts?ref=f12c53342c433eb8ef5650c78f0115f82f5b1567",
            "patch": "@@ -11,14 +11,16 @@ import {copyStyles, interpolateParams} from '../util';\n \n import {SequenceAst, StyleAst, TransitionAst, TriggerAst} from './animation_ast';\n import {AnimationStateStyles, AnimationTransitionFactory} from './animation_transition_factory';\n+import {AnimationStyleNormalizer} from './style_normalization/animation_style_normalizer';\n \n \n \n /**\n  * @publicApi\n  */\n-export function buildTrigger(name: string, ast: TriggerAst): AnimationTrigger {\n-  return new AnimationTrigger(name, ast);\n+export function buildTrigger(\n+    name: string, ast: TriggerAst, normalizer: AnimationStyleNormalizer): AnimationTrigger {\n+  return new AnimationTrigger(name, ast, normalizer);\n }\n \n /**\n@@ -29,10 +31,11 @@ export class AnimationTrigger {\n   public fallbackTransition: AnimationTransitionFactory;\n   public states: {[stateName: string]: AnimationStateStyles} = {};\n \n-  constructor(public name: string, public ast: TriggerAst) {\n+  constructor(\n+      public name: string, public ast: TriggerAst, private _normalizer: AnimationStyleNormalizer) {\n     ast.states.forEach(ast => {\n       const defaultParams = (ast.options && ast.options.params) || {};\n-      this.states[ast.name] = new AnimationStateStyles(ast.style, defaultParams);\n+      this.states[ast.name] = new AnimationStateStyles(ast.style, defaultParams, _normalizer);\n     });\n \n     balanceProperties(this.states, 'true', '1');\n@@ -42,7 +45,7 @@ export class AnimationTrigger {\n       this.transitionFactories.push(new AnimationTransitionFactory(name, ast, this.states));\n     });\n \n-    this.fallbackTransition = createFallbackTransition(name, this.states);\n+    this.fallbackTransition = createFallbackTransition(name, this.states, this._normalizer);\n   }\n \n   get containsQueries() {\n@@ -62,8 +65,8 @@ export class AnimationTrigger {\n }\n \n function createFallbackTransition(\n-    triggerName: string,\n-    states: {[stateName: string]: AnimationStateStyles}): AnimationTransitionFactory {\n+    triggerName: string, states: {[stateName: string]: AnimationStateStyles},\n+    normalizer: AnimationStyleNormalizer): AnimationTransitionFactory {\n   const matchers = [(fromState: any, toState: any) => true];\n   const animation: SequenceAst = {type: AnimationMetadataType.Sequence, steps: [], options: null};\n   const transition: TransitionAst = {"
        },
        {
            "sha": "cd839df20c5c9d17b80c4dbd7adc885ccc531ef6",
            "filename": "packages/animations/browser/src/render/animation_engine_next.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Fanimation_engine_next.ts",
            "raw_url": "https://github.com/angular/angular/raw/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Fanimation_engine_next.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Fanimation_engine_next.ts?ref=f12c53342c433eb8ef5650c78f0115f82f5b1567",
            "patch": "@@ -27,9 +27,9 @@ export class AnimationEngine {\n \n   constructor(\n       private bodyNode: any, private _driver: AnimationDriver,\n-      normalizer: AnimationStyleNormalizer) {\n-    this._transitionEngine = new TransitionAnimationEngine(bodyNode, _driver, normalizer);\n-    this._timelineEngine = new TimelineAnimationEngine(bodyNode, _driver, normalizer);\n+      private _normalizer: AnimationStyleNormalizer) {\n+    this._transitionEngine = new TransitionAnimationEngine(bodyNode, _driver, _normalizer);\n+    this._timelineEngine = new TimelineAnimationEngine(bodyNode, _driver, _normalizer);\n \n     this._transitionEngine.onRemovalComplete = (element: any, context: any) =>\n         this.onRemovalComplete(element, context);\n@@ -48,7 +48,7 @@ export class AnimationEngine {\n         throw new Error(`The animation trigger \"${\n             name}\" has failed to build due to the following errors:\\n - ${errors.join('\\n - ')}`);\n       }\n-      trigger = buildTrigger(name, ast);\n+      trigger = buildTrigger(name, ast, this._normalizer);\n       this._triggerCache[cacheKey] = trigger;\n     }\n     this._transitionEngine.registerTrigger(namespaceId, name, trigger);"
        },
        {
            "sha": "6563de310c2c0d5430aa74d36786f05608d91a0e",
            "filename": "packages/animations/browser/test/dsl/animation_trigger_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Ftest%2Fdsl%2Fanimation_trigger_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Ftest%2Fdsl%2Fanimation_trigger_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Ftest%2Fdsl%2Fanimation_trigger_spec.ts?ref=f12c53342c433eb8ef5650c78f0115f82f5b1567",
            "patch": "@@ -72,7 +72,6 @@ import {makeTrigger} from '../shared';\n           transition('off => on', animate(1000))\n         ]);\n \n-\n         expect(result.states['on'].buildStyles({}, [])).toEqual({width: 50});\n         expect(result.states['off'].buildStyles({}, [])).toEqual({width: 50});\n       });"
        },
        {
            "sha": "64ecbdafec372aca89e637df214c6e51ac6e800b",
            "filename": "packages/animations/browser/test/render/transition_animation_engine_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Ftest%2Frender%2Ftransition_animation_engine_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Ftest%2Frender%2Ftransition_animation_engine_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Ftest%2Frender%2Ftransition_animation_engine_spec.ts?ref=f12c53342c433eb8ef5650c78f0115f82f5b1567",
            "patch": "@@ -736,7 +736,7 @@ function registerTrigger(\n   const ast = buildAnimationAst(driver, metadata as AnimationMetadata, errors) as TriggerAst;\n   if (errors.length) {\n   }\n-  const trigger = buildTrigger(name, ast);\n+  const trigger = buildTrigger(name, ast, new NoopAnimationStyleNormalizer());\n   engine.register(id, element);\n   engine.registerTrigger(id, name, trigger);\n }"
        },
        {
            "sha": "a2a072acb76367d0108b570823bacca4a843bda2",
            "filename": "packages/animations/browser/test/shared.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Ftest%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fanimations%2Fbrowser%2Ftest%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Ftest%2Fshared.ts?ref=f12c53342c433eb8ef5650c78f0115f82f5b1567",
            "patch": "@@ -11,6 +11,7 @@ import {trigger} from '@angular/animations';\n import {TriggerAst} from '../src/dsl/animation_ast';\n import {buildAnimationAst} from '../src/dsl/animation_ast_builder';\n import {AnimationTrigger, buildTrigger} from '../src/dsl/animation_trigger';\n+import {NoopAnimationStyleNormalizer} from '../src/dsl/style_normalization/animation_style_normalizer';\n import {MockAnimationDriver} from '../testing/src/mock_animation_driver';\n \n export function makeTrigger(\n@@ -24,5 +25,5 @@ export function makeTrigger(\n     throw new Error(`Animation parsing for the ${name} trigger have failed:${LINE_START}${\n         errors.join(LINE_START)}`);\n   }\n-  return buildTrigger(name, triggerAst);\n+  return buildTrigger(name, triggerAst, new NoopAnimationStyleNormalizer());\n }"
        },
        {
            "sha": "a4f1f526654b4853c3dfa265f07dcd81f36f77a2",
            "filename": "packages/core/test/animation/animations_with_web_animations_integration_spec.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fcore%2Ftest%2Fanimation%2Fanimations_with_web_animations_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f12c53342c433eb8ef5650c78f0115f82f5b1567/packages%2Fcore%2Ftest%2Fanimation%2Fanimations_with_web_animations_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fanimation%2Fanimations_with_web_animations_integration_spec.ts?ref=f12c53342c433eb8ef5650c78f0115f82f5b1567",
            "patch": "@@ -512,6 +512,48 @@ describe('animation integration tests using web animations', function() {\n        expect(elm.style.getPropertyValue('display')).toEqual('inline-block');\n        expect(elm.style.getPropertyValue('position')).toEqual('fixed');\n      });\n+\n+  it('should set normalized style property values on animation end', () => {\n+    @Component({\n+      selector: 'ani-cmp',\n+      template: `\n+          <div #elm [@myAnimation]=\"myAnimationExp\" style=\"width: 100%; font-size: 2rem\"></div>\n+        `,\n+      animations: [\n+        trigger(\n+            'myAnimation',\n+            [\n+              state('go', style({width: 300, 'font-size': 14})),\n+              transition('* => go', [animate('1s')])\n+            ]),\n+      ]\n+    })\n+    class Cmp {\n+      @ViewChild('elm', {static: true}) public element: any;\n+\n+      public myAnimationExp = '';\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [Cmp]});\n+\n+    const engine = TestBed.inject(ɵAnimationEngine);\n+    const fixture = TestBed.createComponent(Cmp);\n+    const cmp = fixture.componentInstance;\n+\n+    const elm = cmp.element.nativeElement;\n+    expect(elm.style.getPropertyValue('width')).toEqual('100%');\n+    expect(elm.style.getPropertyValue('font-size')).toEqual('2rem');\n+\n+    cmp.myAnimationExp = 'go';\n+    fixture.detectChanges();\n+\n+    const player = engine.players.pop()!;\n+    player.finish();\n+    player.destroy();\n+\n+    expect(elm.style.getPropertyValue('width')).toEqual('300px');\n+    expect(elm.style.getPropertyValue('font-size')).toEqual('14px');\n+  });\n });\n })();\n "
        }
    ],
    "stats": {
        "total": 82,
        "additions": 66,
        "deletions": 16
    }
}