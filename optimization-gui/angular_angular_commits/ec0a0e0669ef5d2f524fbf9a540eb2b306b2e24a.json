{
    "author": "gkalpak",
    "message": "feat(service-worker): add `cacheOpaqueResponses` option for data-groups (#44723)\n\nAdd a new option for configuring data-groups, `cacheOpaqueResponses`,\nthat determines whether opaque responses are cached or not. This allows\ngreater flexibility in configuring the behavior of data-groups, while\nstill keeping the current defaults as fallbacks.\n\nFixes #44246\n\nPR Close #44723",
    "sha": "ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a",
    "files": [
        {
            "sha": "a0b879c464a33d7580deb9cc61134a05b8b91d19",
            "filename": "aio/content/guide/service-worker-config.md",
            "status": "modified",
            "additions": 15,
            "deletions": 10,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/aio%2Fcontent%2Fguide%2Fservice-worker-config.md",
            "raw_url": "https://github.com/angular/angular/raw/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/aio%2Fcontent%2Fguide%2Fservice-worker-config.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fservice-worker-config.md?ref=ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a",
            "patch": "@@ -247,23 +247,28 @@ This essentially does the following:\n \n </div>\n \n+#### `cacheOpaqueResponses`\n+\n+Whether the Angular service worker should cache opaque responses or not.\n+\n+If not specified, the default value depends on the data group's configured strategy:\n+\n+- For groups with the `freshness` strategy, the default value is `true` (cache opaque responses).\n+  These groups will request the data anew every time, only falling back to the cached response when offline or on a slow network.\n+  Therefore, it doesn't matter if the service worker caches an error response.\n+\n+- For groups with the `performance` strategy, the default value is `false` (do not cache opaque responses).\n+  These groups would continue to return a cached response until `maxAge` expires, even if the error was due to a temporary network or server issue.\n+  Therefore, it would be problematic for the service worker to cache an error response.\n+\n <div class=\"callout is-important\">\n \n   <header>Note on opaque responses</header>\n \n-  [Opaque responses][opaque-response] are handled differently depending on the used strategy:\n-  Data-groups with the `freshness` strategy cache such responses normally.\n-  Data-groups with the `performance` strategy, however, do not cache opaque responses.\n-\n-  In case you are not familiar, an opaque response is a special type of response returned when requesting a resource that is on a different origin which doesn't return CORS headers.\n+  In case you are not familiar, an [opaque response][opaque-response] is a special type of response returned when requesting a resource that is on a different origin which doesn't return CORS headers.\n   One of the characteristics of an opaque response is that the service worker is not allowed to read its status, meaning it can't check if the request was successful or not.\n   See [Introduction to fetch()][response-types] for more details.\n \n-  For data-groups with the `freshness` strategy, it doesn't matter if the service worker caches an error response.\n-  The data will be requested anew every time, only falling back to the cached response when offline or on a slow network.\n-\n-  For data-groups with the `performance` strategy on the other hand, caching an error response would be quite problematic.\n-  The service worker would continue to serve the error response until `maxAge` expired, even if the error was due to a temporary network or server issue.\n \n   If you are not able to implement CORS&mdash;for example, if you don't control the origin&mdash;prefer using the `freshness` strategy for resources that result in opaque responses.\n "
        },
        {
            "sha": "bd5a35187d1d24a1cf20a3339727a876abaeab9d",
            "filename": "goldens/public-api/service-worker/config/config.md",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/goldens%2Fpublic-api%2Fservice-worker%2Fconfig%2Fconfig.md",
            "raw_url": "https://github.com/angular/angular/raw/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/goldens%2Fpublic-api%2Fservice-worker%2Fconfig%2Fconfig.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fservice-worker%2Fconfig%2Fconfig.md?ref=ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a",
            "patch": "@@ -45,6 +45,7 @@ export interface DataGroup {\n         maxAge: Duration;\n         timeout?: Duration;\n         strategy?: 'freshness' | 'performance';\n+        cacheOpaqueResponses?: boolean;\n     };\n     // (undocumented)\n     cacheQueryOptions?: Pick<CacheQueryOptions, 'ignoreSearch'>;\n@@ -78,14 +79,12 @@ class Generator_2 {\n     readonly fs: Filesystem;\n     // (undocumented)\n     process(config: Config): Promise<Object>;\n-    }\n-\n+}\n export { Generator_2 as Generator }\n \n // @public (undocumented)\n export type Glob = string;\n \n-\n // (No @packageDocumentation comment for this package)\n \n ```"
        },
        {
            "sha": "4b02f9772baf3d24612dc62e053842f0180dcaca",
            "filename": "packages/service-worker/config/schema.json",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fconfig%2Fschema.json",
            "raw_url": "https://github.com/angular/angular/raw/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fconfig%2Fschema.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fconfig%2Fschema.json?ref=ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a",
            "patch": "@@ -126,6 +126,10 @@\n                 ],\n                 \"default\": \"performance\",\n                 \"description\": \"The Angular service worker can use either of two caching strategies for data resources. 'performance', the default, optimizes for responses that are as fast as possible. If a resource exists in the cache, the cached version is used. This allows for some staleness, depending on the 'maxAge', in exchange for better performance. This is suitable for resources that don't change often; for example, user avatar images. 'freshness' optimizes for currency of data, preferentially fetching requested data from the network. Only if the network times out, according to 'timeout', does the request fall back to the cache. This is useful for resources that change frequently; for example, account balances.\"\n+              },\n+              \"cacheOpaqueResponses\": {\n+                \"type\": \"boolean\",\n+                \"description\": \"Whether to cache opaque responses or not. The default value is 'false' for groups with the 'performance' strategy and 'true' for groups with the 'freshness' strategy. Opaque responses are special in that it is not possible for the service worker to distinguish successful responses from errors. Therefore, be careful with caching opaque responses, especially when combined with a strategy/configuration that could result in a response being retained in the cache for a long time.\"\n               }\n             },\n             \"required\": ["
        },
        {
            "sha": "b8ae94efe5e52ef06fcf3465e469d4efb2e75892",
            "filename": "packages/service-worker/config/src/generator.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fgenerator.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fgenerator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fgenerator.ts?ref=ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a",
            "patch": "@@ -94,6 +94,7 @@ export class Generator {\n         maxSize: group.cacheConfig.maxSize,\n         maxAge: parseDurationToMs(group.cacheConfig.maxAge),\n         timeoutMs: group.cacheConfig.timeout && parseDurationToMs(group.cacheConfig.timeout),\n+        cacheOpaqueResponses: group.cacheConfig.cacheOpaqueResponses,\n         cacheQueryOptions: buildCacheQueryOptions(group.cacheQueryOptions),\n         version: group.version !== undefined ? group.version : 1,\n       };"
        },
        {
            "sha": "55ebf53615ffb94c9c2ba68d57e0713cef074419",
            "filename": "packages/service-worker/config/src/in.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fin.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fconfig%2Fsrc%2Fin.ts?ref=ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a",
            "patch": "@@ -56,6 +56,7 @@ export interface DataGroup {\n     maxSize: number; maxAge: Duration;\n     timeout?: Duration;\n     strategy?: 'freshness' | 'performance';\n+    cacheOpaqueResponses?: boolean;\n   };\n   cacheQueryOptions?: Pick<CacheQueryOptions, 'ignoreSearch'>;\n }"
        },
        {
            "sha": "c62e213d060ee2e101a96ca52ef98944709c8960",
            "filename": "packages/service-worker/config/test/generator_spec.ts",
            "status": "modified",
            "additions": 169,
            "deletions": 1,
            "changes": 170,
            "blob_url": "https://github.com/angular/angular/blob/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fconfig%2Ftest%2Fgenerator_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fconfig%2Ftest%2Fgenerator_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fconfig%2Ftest%2Fgenerator_spec.ts?ref=ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a",
            "patch": "@@ -106,6 +106,7 @@ describe('Generator', () => {\n         maxAge: 259200000,\n         timeoutMs: 60000,\n         version: 1,\n+        cacheOpaqueResponses: undefined,\n         cacheQueryOptions: {ignoreVary: true}\n       }],\n       navigationUrls: [\n@@ -282,7 +283,173 @@ describe('Generator', () => {\n     }\n   });\n \n-  it('generates a correct config with cacheQueryOptions', async () => {\n+  it('generates a correct config with `cacheOpaqueResponses`', async () => {\n+    const fs = new MockFilesystem({\n+      '/index.html': 'This is a test',\n+    });\n+    const gen = new Generator(fs, '/');\n+    const config = await gen.process({\n+      index: '/index.html',\n+      dataGroups: [\n+        {\n+          name: 'freshness-undefined',\n+          urls: ['/api/1/**'],\n+          cacheConfig: {\n+            maxAge: '3d',\n+            maxSize: 100,\n+            strategy: 'freshness',\n+          },\n+        },\n+        {\n+          name: 'freshness-false',\n+          urls: ['/api/2/**'],\n+          cacheConfig: {\n+            cacheOpaqueResponses: false,\n+            maxAge: '3d',\n+            maxSize: 100,\n+            strategy: 'freshness',\n+          },\n+        },\n+        {\n+          name: 'freshness-true',\n+          urls: ['/api/3/**'],\n+          cacheConfig: {\n+            cacheOpaqueResponses: true,\n+            maxAge: '3d',\n+            maxSize: 100,\n+            strategy: 'freshness',\n+          },\n+        },\n+        {\n+          name: 'performance-undefined',\n+          urls: ['/api/4/**'],\n+          cacheConfig: {\n+            maxAge: '3d',\n+            maxSize: 100,\n+            strategy: 'performance',\n+          },\n+        },\n+        {\n+          name: 'performance-false',\n+          urls: ['/api/5/**'],\n+          cacheConfig: {\n+            cacheOpaqueResponses: false,\n+            maxAge: '3d',\n+            maxSize: 100,\n+            strategy: 'performance',\n+          },\n+        },\n+        {\n+          name: 'performance-true',\n+          urls: ['/api/6/**'],\n+          cacheConfig: {\n+            cacheOpaqueResponses: true,\n+            maxAge: '3d',\n+            maxSize: 100,\n+            strategy: 'performance',\n+          },\n+        },\n+      ],\n+    });\n+\n+    expect(config).toEqual({\n+      configVersion: 1,\n+      appData: undefined,\n+      timestamp: 1234567890123,\n+      index: '/index.html',\n+      assetGroups: [],\n+      dataGroups: [\n+        {\n+          name: 'freshness-undefined',\n+          patterns: [\n+            '\\\\/api\\\\/1\\\\/.*',\n+          ],\n+          strategy: 'freshness',\n+          maxSize: 100,\n+          maxAge: 259200000,\n+          timeoutMs: undefined,\n+          version: 1,\n+          cacheOpaqueResponses: undefined,\n+          cacheQueryOptions: {ignoreVary: true},\n+        },\n+        {\n+          name: 'freshness-false',\n+          patterns: [\n+            '\\\\/api\\\\/2\\\\/.*',\n+          ],\n+          strategy: 'freshness',\n+          maxSize: 100,\n+          maxAge: 259200000,\n+          timeoutMs: undefined,\n+          version: 1,\n+          cacheOpaqueResponses: false,\n+          cacheQueryOptions: {ignoreVary: true},\n+        },\n+        {\n+          name: 'freshness-true',\n+          patterns: [\n+            '\\\\/api\\\\/3\\\\/.*',\n+          ],\n+          strategy: 'freshness',\n+          maxSize: 100,\n+          maxAge: 259200000,\n+          timeoutMs: undefined,\n+          version: 1,\n+          cacheOpaqueResponses: true,\n+          cacheQueryOptions: {ignoreVary: true},\n+        },\n+        {\n+          name: 'performance-undefined',\n+          patterns: [\n+            '\\\\/api\\\\/4\\\\/.*',\n+          ],\n+          strategy: 'performance',\n+          maxSize: 100,\n+          maxAge: 259200000,\n+          timeoutMs: undefined,\n+          version: 1,\n+          cacheOpaqueResponses: undefined,\n+          cacheQueryOptions: {ignoreVary: true},\n+        },\n+        {\n+          name: 'performance-false',\n+          patterns: [\n+            '\\\\/api\\\\/5\\\\/.*',\n+          ],\n+          strategy: 'performance',\n+          maxSize: 100,\n+          maxAge: 259200000,\n+          timeoutMs: undefined,\n+          version: 1,\n+          cacheOpaqueResponses: false,\n+          cacheQueryOptions: {ignoreVary: true},\n+        },\n+        {\n+          name: 'performance-true',\n+          patterns: [\n+            '\\\\/api\\\\/6\\\\/.*',\n+          ],\n+          strategy: 'performance',\n+          maxSize: 100,\n+          maxAge: 259200000,\n+          timeoutMs: undefined,\n+          version: 1,\n+          cacheOpaqueResponses: true,\n+          cacheQueryOptions: {ignoreVary: true},\n+        },\n+      ],\n+      navigationUrls: [\n+        {positive: true, regex: '^\\\\/.*$'},\n+        {positive: false, regex: '^\\\\/(?:.+\\\\/)?[^/]*\\\\.[^/]*$'},\n+        {positive: false, regex: '^\\\\/(?:.+\\\\/)?[^/]*__[^/]*$'},\n+        {positive: false, regex: '^\\\\/(?:.+\\\\/)?[^/]*__[^/]*\\\\/.*$'},\n+      ],\n+      navigationRequestStrategy: 'performance',\n+      hashTable: {},\n+    });\n+  });\n+\n+  it('generates a correct config with `cacheQueryOptions`', async () => {\n     const fs = new MockFilesystem({\n       '/index.html': 'This is a test',\n       '/main.js': 'This is a JS file',\n@@ -339,6 +506,7 @@ describe('Generator', () => {\n         maxAge: 259200000,\n         timeoutMs: 60000,\n         version: 1,\n+        cacheOpaqueResponses: undefined,\n         cacheQueryOptions: {ignoreSearch: false, ignoreVary: true}\n       }],\n       navigationUrls: ["
        },
        {
            "sha": "22475bc9544f6612499e55615b516b9895bc921f",
            "filename": "packages/service-worker/worker/src/data.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts?ref=ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a",
            "patch": "@@ -339,6 +339,10 @@ export class DataGroup {\n \n   private async handleFetchWithPerformance(req: Request, event: ExtendableEvent, lru: LruList):\n       Promise<Response|null> {\n+    // The 'performance' strategy prioritizes cached response. Prefer to avoid caching opaque\n+    // responses to avoid caching an error response.\n+    const okToCacheOpaque = this.config.cacheOpaqueResponses ?? false;\n+\n     let res: Response|null|undefined = null;\n \n     // Check the cache first. If the resource exists there (and is not expired), the cached\n@@ -348,7 +352,7 @@ export class DataGroup {\n       res = fromCache.res;\n       // Check the age of the resource.\n       if (this.config.refreshAheadMs !== undefined && fromCache.age >= this.config.refreshAheadMs) {\n-        event.waitUntil(this.safeCacheResponse(req, this.safeFetch(req), lru));\n+        event.waitUntil(this.safeCacheResponse(req, this.safeFetch(req), lru, okToCacheOpaque));\n       }\n     }\n \n@@ -367,17 +371,21 @@ export class DataGroup {\n       res = this.adapter.newResponse(null, {status: 504, statusText: 'Gateway Timeout'});\n \n       // Cache the network response eventually.\n-      event.waitUntil(this.safeCacheResponse(req, networkFetch, lru));\n+      event.waitUntil(this.safeCacheResponse(req, networkFetch, lru, okToCacheOpaque));\n     } else {\n       // The request completed in time, so cache it inline with the response flow.\n-      await this.safeCacheResponse(req, res, lru);\n+      await this.safeCacheResponse(req, res, lru, okToCacheOpaque);\n     }\n \n     return res;\n   }\n \n   private async handleFetchWithFreshness(req: Request, event: ExtendableEvent, lru: LruList):\n       Promise<Response|null> {\n+    // The 'freshness' strategy prioritizes responses from the network. Therefore, it is OK to cache\n+    // an opaque response, even if it is an error response.\n+    const okToCacheOpaque = this.config.cacheOpaqueResponses ?? true;\n+\n     // Start with a network fetch.\n     const [timeoutFetch, networkFetch] = this.networkFetchWithTimeout(req);\n     let res: Response|null|undefined;\n@@ -392,14 +400,14 @@ export class DataGroup {\n \n     // If the network fetch times out or errors, fall back on the cache.\n     if (res === undefined) {\n-      event.waitUntil(this.safeCacheResponse(req, networkFetch, lru, true));\n+      event.waitUntil(this.safeCacheResponse(req, networkFetch, lru, okToCacheOpaque));\n \n       // Ignore the age, the network response will be cached anyway due to the\n       // behavior of freshness.\n       const fromCache = await this.loadFromCache(req, lru);\n       res = (fromCache !== null) ? fromCache.res : null;\n     } else {\n-      await this.safeCacheResponse(req, res, lru, true);\n+      await this.safeCacheResponse(req, res, lru, okToCacheOpaque);\n     }\n \n     // Either the network fetch didn't time out, or the cache yielded a usable response."
        },
        {
            "sha": "7500332dd32ee825e0e35ea52f011931ee2c7e7b",
            "filename": "packages/service-worker/worker/src/manifest.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fmanifest.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fmanifest.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fmanifest.ts?ref=ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a",
            "patch": "@@ -37,9 +37,10 @@ export interface DataGroupConfig {\n   strategy: 'freshness'|'performance';\n   patterns: string[];\n   maxSize: number;\n+  maxAge: number;\n   timeoutMs?: number;\n   refreshAheadMs?: number;\n-  maxAge: number;\n+  cacheOpaqueResponses?: boolean;\n   cacheQueryOptions?: CacheQueryOptions;\n }\n "
        },
        {
            "sha": "32ffdf3435ca8e4e61bddac2867c4f632d1bdbed",
            "filename": "packages/service-worker/worker/test/data_spec.ts",
            "status": "modified",
            "additions": 60,
            "deletions": 2,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fworker%2Ftest%2Fdata_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a/packages%2Fservice-worker%2Fworker%2Ftest%2Fdata_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fdata_spec.ts?ref=ec0a0e0669ef5d2f524fbf9a540eb2b306b2e24a",
            "patch": "@@ -32,6 +32,8 @@ const dist = new MockFileSystemBuilder()\n                  .addFile('/api/e', 'version E')\n                  .addFile('/fresh/data', 'this is fresh data')\n                  .addFile('/refresh/data', 'this is some data')\n+                 .addFile('/fresh-opaque/data', 'this is some fresh data')\n+                 .addFile('/perf-opaque/data', 'this is some perf data')\n                  .build();\n \n \n@@ -92,6 +94,28 @@ const manifest: Manifest = {\n       version: 1,\n       cacheQueryOptions: {ignoreVary: true},\n     },\n+    {\n+      name: 'testFreshOpaque',\n+      maxSize: 3,\n+      strategy: 'freshness',\n+      patterns: ['^/fresh-opaque/.*$'],\n+      timeoutMs: 1000,\n+      maxAge: 5000,\n+      version: 1,\n+      cacheOpaqueResponses: false,\n+      cacheQueryOptions: {ignoreVary: true},\n+    },\n+    {\n+      name: 'testPerfOpaque',\n+      maxSize: 3,\n+      strategy: 'performance',\n+      patterns: ['^/perf-opaque/.*$'],\n+      timeoutMs: 1000,\n+      maxAge: 5000,\n+      version: 1,\n+      cacheOpaqueResponses: true,\n+      cacheQueryOptions: {ignoreVary: true},\n+    },\n   ],\n   navigationUrls: [],\n   navigationRequestStrategy: 'performance',\n@@ -157,14 +181,22 @@ describe('data cache', () => {\n       server.assertNoOtherRequests();\n     });\n \n-    it('does not cache opaque responses', async () => {\n+    it('does not cache opaque responses by default', async () => {\n       expect(await makeNoCorsRequest(scope, '/api/test')).toBe('');\n       server.assertSawRequestFor('/api/test');\n \n       expect(await makeNoCorsRequest(scope, '/api/test')).toBe('');\n       server.assertSawRequestFor('/api/test');\n     });\n \n+    it('caches opaque responses when configured to do so', async () => {\n+      expect(await makeNoCorsRequest(scope, '/perf-opaque/data')).toBe('');\n+      server.assertSawRequestFor('/perf-opaque/data');\n+\n+      expect(await makeNoCorsRequest(scope, '/perf-opaque/data')).toBe('');\n+      server.assertNoOtherRequests();\n+    });\n+\n     it('refreshes after awhile', async () => {\n       expect(await makeRequest(scope, '/api/test')).toEqual('version 1');\n       server.clearRequests();\n@@ -289,7 +321,7 @@ describe('data cache', () => {\n       serverUpdate.assertNoOtherRequests();\n     });\n \n-    it('caches opaque responses on refresh', async () => {\n+    it('caches opaque responses on refresh by default', async () => {\n       // Make the initial request and populate the cache.\n       expect(await makeRequest(scope, '/fresh/data')).toBe('this is fresh data');\n       server.assertSawRequestFor('/fresh/data');\n@@ -319,6 +351,32 @@ describe('data cache', () => {\n       expect(await res2).toBe('');\n     });\n \n+    it('does not cache opaque responses when configured not to do so', async () => {\n+      // Make an initial no-cors request.\n+      expect(await makeNoCorsRequest(scope, '/fresh-opaque/data')).toBe('');\n+      server.assertSawRequestFor('/fresh-opaque/data');\n+\n+      // Pause the server, so the next request times out.\n+      server.pause();\n+      const [res] = makePendingRequest(scope, '/fresh-opaque/data');\n+\n+      // The network request should time out after 1,000ms and thus return a cached response if\n+      // available. Since there is no cached response, however, the promise will not be resolved\n+      // until the server returns a response.\n+      let resolved = false;\n+      res.then(() => resolved = true);\n+\n+      await server.nextRequest;\n+      scope.advance(2000);\n+      await new Promise(resolve => setTimeout(resolve));  // Drain the microtask queue.\n+      expect(resolved).toBe(false);\n+\n+      // Unpause the server, to allow the network request to complete.\n+      server.unpause();\n+      await new Promise(resolve => setTimeout(resolve));  // Drain the microtask queue.\n+      expect(resolved).toBe(true);\n+    });\n+\n     it('CacheQueryOptions are passed through when falling back to cache', async () => {\n       const matchSpy = spyOn(MockCache.prototype, 'match').and.callThrough();\n       await makeRequest(scope, '/fresh/data');"
        }
    ],
    "stats": {
        "total": 289,
        "additions": 267,
        "deletions": 22
    }
}