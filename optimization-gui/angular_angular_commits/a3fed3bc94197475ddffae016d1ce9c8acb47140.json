{
    "author": "mgechev",
    "message": "refactor(devtools): implement view extraction strategies",
    "sha": "a3fed3bc94197475ddffae016d1ce9c8acb47140",
    "files": [
        {
            "sha": "7a3250d49935545f2d1c2b62175962a5f80a9982",
            "filename": "projects/ng-devtools-backend/src/lib/client-event-subscribers.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -142,8 +142,8 @@ const getNestedPropertiesCallback = (messageBus: MessageBus<Events>) => (\n const getRoutes = (messageBus: MessageBus<Events>) => {\n   const node = queryDirectiveForest([0], initializeOrGetDirectiveForestHooks().getIndexedDirectiveForest());\n   let routes: Route[] = [];\n-  if (node?.component?.instance.router) {\n-    routes = [parseRoutes(node?.component?.instance.router)];\n+  if (node?.component?.instance?.router) {\n+    routes = [parseRoutes(node?.component?.instance?.router)];\n   }\n   messageBus.emit('updateRouterTree', [routes]);\n };"
        },
        {
            "sha": "3582c319ad47f1142a14a6056f89770708e71e10",
            "filename": "projects/ng-devtools-backend/src/lib/component-tree.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 12,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fcomponent-tree.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fcomponent-tree.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fcomponent-tree.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -9,7 +9,7 @@ import {\n   PropertyQueryTypes,\n   UpdatedStateData,\n } from 'protocol';\n-import { buildDirectiveTree, getLViewFromDirectiveOrElementInstance } from './lview-transform';\n+import { buildDirectiveTree, getLViewFromDirectiveOrElementInstance } from './directive-forest';\n \n const ngDebug = () => (window as any).ng;\n \n@@ -106,20 +106,23 @@ const getRootLViewsHelper = (element: Element, rootLViews = new Set<any>()): Set\n   return rootLViews;\n };\n \n-// To get all roots, we first get all elements with ng-version attribute.\n-// This includes all app roots plus Angular Elements.\n-// We may also have overlays which are on the same level as the top-level\n-// app. We get these by traversing the DOM starting from the root DOM\n-// element and stopping once we hit a node which is not HTMLElement or\n-// has lView data associated with it.\n-const getRootLViews = (element: Element): Set<any> => {\n-  const roots = element.querySelectorAll('[ng-version]');\n-  return getRootLViewsHelper(element, new Set(Array.from(roots).map(getLViewFromDirectiveOrElementInstance)));\n+const getRoots = () => {\n+  const roots = Array.from(document.documentElement.querySelectorAll('[ng-version]'));\n+  const isTopLevel = (element: HTMLElement) => {\n+    let parent: HTMLElement | null = element;\n+    while ((parent = parent.parentElement)) {\n+      if (parent.hasAttribute('ng-version')) {\n+        return false;\n+      }\n+    }\n+    return true;\n+  };\n+  return roots.filter(isTopLevel);\n };\n \n export const buildDirectiveForest = (): ComponentTreeNode[] => {\n-  const roots = getRootLViews(document.documentElement);\n-  return Array.prototype.concat.apply([], [...roots].map(buildDirectiveTree));\n+  const roots = getRoots();\n+  return Array.prototype.concat.apply([], Array.from(roots).map(buildDirectiveTree));\n };\n \n // Based on an ElementID we return a specific component node."
        },
        {
            "sha": "5f657f71fd18bc4e8ad6712a07a147d506c7734c",
            "filename": "projects/ng-devtools-backend/src/lib/directive-forest/index.ts",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Findex.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -0,0 +1,31 @@\n+import { LViewBuilder } from './lview';\n+import { DebugNodeTreeBuilder } from './lview-debug';\n+\n+export { getLViewFromDirectiveOrElementInstance, getDirectiveHostElement, METADATA_PROPERTY_NAME } from './lview';\n+\n+const builders = [new DebugNodeTreeBuilder(), new LViewBuilder()];\n+\n+let strategy: null | DebugNodeTreeBuilder | LViewBuilder = null;\n+\n+const selectStrategy = (lView: any) => {\n+  for (const builder of builders) {\n+    if (builder.supports(lView)) {\n+      return builder;\n+    }\n+  }\n+  return null;\n+};\n+\n+export const buildDirectiveTree = (element: Element) => {\n+  if (!strategy) {\n+    strategy = selectStrategy(element);\n+  }\n+  if (!strategy) {\n+    console.error('Unable to parse the component tree');\n+    return [];\n+  }\n+  console.time('tree-start');\n+  const result = strategy.build(element);\n+  console.timeEnd('tree-start');\n+  return result;\n+};"
        },
        {
            "sha": "ddcbe91199a7b028272a3d759bc71e7eecb407f2",
            "filename": "projects/ng-devtools-backend/src/lib/directive-forest/lview-debug.ts",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Flview-debug.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Flview-debug.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Flview-debug.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -0,0 +1,59 @@\n+import { DebugNode as ngDebugNode, DebugElement as ngDebugElement } from '@angular/core';\n+import { ComponentInstanceType, DirectiveInstanceType, ComponentTreeNode } from '../component-tree';\n+import { getDirectiveName } from '../highlighter';\n+import { isCustomElement } from '../utils';\n+\n+interface DebugNode extends ngDebugNode {\n+  isHost: boolean;\n+  directives: any[];\n+}\n+interface DebugElement extends ngDebugElement, DebugNode {}\n+\n+const extractViewTree = (element: DebugElement | DebugNode, result: ComponentTreeNode[] = []): ComponentTreeNode[] => {\n+  const { isHost, directives } = element;\n+  if (!isHost && !directives.length) {\n+    ((element as any).childNodes || []).forEach((node) => extractViewTree(node, result));\n+    return result;\n+  }\n+  const node: ComponentTreeNode = {\n+    children: [],\n+    component: null,\n+    directives: [],\n+    element: element.nativeNode.nodeName.toLowerCase(),\n+    nativeElement: element.nativeNode,\n+  };\n+  if (isHost) {\n+    node.component = {\n+      instance: element.componentInstance,\n+      isElement: isCustomElement(element.nativeNode),\n+      name: element?.componentInstance?.constructor?.name,\n+    };\n+  }\n+  if (directives.length) {\n+    node.directives = element.directives.map((dir) => {\n+      return {\n+        instance: dir,\n+        name: dir.constructor.name,\n+      };\n+    });\n+  }\n+  if (node.component || node.directives.length) {\n+    result.push(node);\n+    ((element as any).childNodes || []).forEach((n) => extractViewTree(n, node.children));\n+  } else {\n+    ((element as any).childNodes || []).forEach((n) => extractViewTree(n, result));\n+  }\n+  return result;\n+};\n+\n+export class DebugNodeTreeBuilder {\n+  supports(_: any) {\n+    const { asDebugNode, getDirectiveMetadata } = (window as any).ng;\n+    return typeof asDebugNode === 'function' && typeof getDirectiveMetadata === 'function';\n+  }\n+\n+  build(element: Element): ComponentTreeNode[] {\n+    const result = extractViewTree((window as any).ng.asDebugNode(element));\n+    return result;\n+  }\n+}"
        },
        {
            "sha": "87e1f8a7b55f93fb8e164f3ed62208b282a3be90",
            "filename": "projects/ng-devtools-backend/src/lib/directive-forest/lview.ts",
            "status": "added",
            "additions": 124,
            "deletions": 0,
            "changes": 124,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Flview.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Flview.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fdirective-forest%2Flview.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -0,0 +1,124 @@\n+import { ComponentTreeNode, ComponentInstanceType, DirectiveInstanceType } from '../component-tree';\n+import { isCustomElement } from '../utils';\n+import { getDirectiveName } from '../highlighter';\n+import { SemVerDSL } from 'semver-dsl';\n+import { VERSION } from '../version';\n+\n+let HEADER_OFFSET = 19;\n+\n+const latest = () => {\n+  HEADER_OFFSET = 20;\n+};\n+\n+SemVerDSL(VERSION).gte('10.0.0-next.4', latest);\n+\n+// In g3 everyone has version 0.0.0, using HEAD from master.\n+SemVerDSL(VERSION).eq('0.0.0', latest);\n+\n+const TYPE = 1;\n+const ELEMENT = 0;\n+const LVIEW_TVIEW = 1;\n+\n+export const isLContainer = (value: any): boolean => {\n+  return Array.isArray(value) && value[TYPE] === true;\n+};\n+\n+const isLView = (value: any): boolean => {\n+  return Array.isArray(value) && typeof value[TYPE] === 'object';\n+};\n+\n+export const METADATA_PROPERTY_NAME = '__ngContext__';\n+export const getLViewFromDirectiveOrElementInstance = (dir: any): null | {} => {\n+  if (!dir) {\n+    return null;\n+  }\n+  const context = dir[METADATA_PROPERTY_NAME];\n+  if (!context) {\n+    return null;\n+  }\n+  if (isLView(context)) {\n+    return context;\n+  }\n+  return context.lView;\n+};\n+\n+export const getDirectiveHostElement = (dir: any) => {\n+  if (!dir) {\n+    return false;\n+  }\n+  const ctx = dir[METADATA_PROPERTY_NAME];\n+  if (ctx[0] !== null) {\n+    return ctx[0];\n+  }\n+  const components = ctx[LVIEW_TVIEW].components;\n+  if (!components || components.length !== 1) {\n+    return false;\n+  }\n+  return ctx[components[0]][0];\n+};\n+\n+export class LViewBuilder {\n+  supports(element: Element) {\n+    return (element as any).__ngContext__;\n+  }\n+\n+  private _getNode(lView: any, data: any, idx: number): ComponentTreeNode {\n+    const directives: DirectiveInstanceType[] = [];\n+    let component: ComponentInstanceType | null = null;\n+    const tNode = data[idx];\n+    const node = lView[idx][ELEMENT];\n+    const element = (node.tagName || node.nodeName).toLowerCase();\n+    for (let i = tNode.directiveStart; i < tNode.directiveEnd; i++) {\n+      const instance = lView[i];\n+      const dirMeta = data[i];\n+      if (dirMeta && dirMeta.template) {\n+        component = {\n+          name: element,\n+          isElement: isCustomElement(node),\n+          instance,\n+        };\n+      } else if (dirMeta) {\n+        directives.push({\n+          name: getDirectiveName(instance),\n+          instance,\n+        });\n+      }\n+    }\n+    return {\n+      nativeElement: lView[idx][ELEMENT],\n+      children: [],\n+      element,\n+      directives,\n+      component,\n+    };\n+  }\n+\n+  private _extract(lViewOrLContainer: any, nodes: ComponentTreeNode[] = []) {\n+    if (isLContainer(lViewOrLContainer)) {\n+      for (let i = 9; i < lViewOrLContainer.length; i++) {\n+        if (lViewOrLContainer[i]) {\n+          this._extract(lViewOrLContainer[i], nodes);\n+        }\n+      }\n+      return nodes;\n+    }\n+    const lView = lViewOrLContainer;\n+    const tView = lView[LVIEW_TVIEW];\n+    for (let i = HEADER_OFFSET; i < lView.length; i++) {\n+      if (lView[i] && tView.data && lView[i][ELEMENT] instanceof Node) {\n+        const node = this._getNode(lView, tView.data, i);\n+\n+        // TODO(mgechev): verify if this won't make us skip projected content.\n+        if (node.component || node.directives.length) {\n+          nodes.push(node);\n+          this._extract(lView[i], node.children);\n+        }\n+      }\n+    }\n+    return nodes;\n+  }\n+\n+  build(element: Element, nodes: ComponentTreeNode[] = []): ComponentTreeNode[] {\n+    return this._extract((element as any).__ngContext__);\n+  }\n+}"
        },
        {
            "sha": "1cd4219f0fbdcb8553aabb02421dfc9c51378ef1",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/hooks.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fhooks.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fhooks.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fhooks.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -6,7 +6,7 @@ import {\n   getLViewFromDirectiveOrElementInstance,\n   getDirectiveHostElement,\n   METADATA_PROPERTY_NAME,\n-} from '../lview-transform';\n+} from '../directive-forest';\n import { Subject } from 'rxjs';\n \n export type CreationHook = ("
        },
        {
            "sha": "304e50526cc8029c565177e2ab844dc6128e5bad",
            "filename": "projects/ng-devtools-backend/src/lib/lview-transform.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 113,
            "changes": 113,
            "blob_url": "https://github.com/angular/angular/blob/b199ca1e1ad0c9c5a3ec3ebc27fb48cf4f45794e/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Flview-transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/b199ca1e1ad0c9c5a3ec3ebc27fb48cf4f45794e/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Flview-transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Flview-transform.ts?ref=b199ca1e1ad0c9c5a3ec3ebc27fb48cf4f45794e",
            "patch": "@@ -1,113 +0,0 @@\n-import { ComponentTreeNode, ComponentInstanceType, DirectiveInstanceType } from './component-tree';\n-import { isCustomElement } from './utils';\n-import { getDirectiveName } from './highlighter';\n-import { SemVerDSL } from 'semver-dsl';\n-import { VERSION } from './version';\n-\n-let HEADER_OFFSET = 19;\n-\n-const latest = () => {\n-  HEADER_OFFSET = 20;\n-};\n-\n-SemVerDSL(VERSION).gte('10.0.0-next.4', latest);\n-\n-// In g3 everyone has version 0.0.0, using HEAD from master.\n-SemVerDSL(VERSION).eq('0.0.0', latest);\n-\n-const TYPE = 1;\n-const ELEMENT = 0;\n-const LVIEW_TVIEW = 1;\n-export const METADATA_PROPERTY_NAME = '__ngContext__';\n-\n-const isLContainer = (value: any): boolean => {\n-  return Array.isArray(value) && value[TYPE] === true;\n-};\n-\n-const isLView = (value: any): boolean => {\n-  return Array.isArray(value) && typeof value[TYPE] === 'object';\n-};\n-\n-export const getLViewFromDirectiveOrElementInstance = (dir: any): null | {} => {\n-  if (!dir) {\n-    return null;\n-  }\n-  const context = dir[METADATA_PROPERTY_NAME];\n-  if (!context) {\n-    return null;\n-  }\n-  if (isLView(context)) {\n-    return context;\n-  }\n-  return context.lView;\n-};\n-\n-export const getDirectiveHostElement = (dir: any) => {\n-  const ctx = dir[METADATA_PROPERTY_NAME];\n-  if (ctx[0] !== null) {\n-    return ctx[0];\n-  }\n-  const components = ctx[LVIEW_TVIEW].components;\n-  if (!components || components.length !== 1) {\n-    return false;\n-  }\n-  return ctx[components[0]][0];\n-};\n-\n-const getNode = (lView: any, data: any, idx: number): ComponentTreeNode => {\n-  const directives: DirectiveInstanceType[] = [];\n-  let component: ComponentInstanceType | null = null;\n-  const tNode = data[idx];\n-  const node = lView[idx][ELEMENT];\n-  const elementName = (node.tagName || node.nodeName).toLowerCase();\n-  for (let i = tNode.directiveStart; i < tNode.directiveEnd; i++) {\n-    const dir = lView[i];\n-    const dirMeta = data[i];\n-    if (dirMeta && dirMeta.template) {\n-      component = {\n-        name: elementName,\n-        instance: dir,\n-        isElement: isCustomElement(node),\n-      };\n-    } else if (dirMeta) {\n-      directives.push({\n-        name: getDirectiveName(dir),\n-        instance: dir,\n-      });\n-    }\n-  }\n-  return {\n-    element: elementName,\n-    nativeElement: lView[idx][ELEMENT],\n-    directives,\n-    component,\n-    children: [],\n-  };\n-};\n-\n-const extractNodes = (lViewOrLContainer: any, nodes: ComponentTreeNode[] = []): ComponentTreeNode[] => {\n-  if (isLContainer(lViewOrLContainer)) {\n-    for (let i = 9; i < lViewOrLContainer.length; i++) {\n-      if (lViewOrLContainer[i]) {\n-        extractNodes(lViewOrLContainer[i], nodes);\n-      }\n-    }\n-    return nodes;\n-  }\n-  const lView = lViewOrLContainer;\n-  const tView = lView[LVIEW_TVIEW];\n-  for (let i = HEADER_OFFSET; i < lView.length; i++) {\n-    if (lView[i] && tView.data && lView[i][ELEMENT] instanceof Node) {\n-      const node = getNode(lView, tView.data, i);\n-\n-      // TODO(mgechev): verify if this won't make us skip projected content.\n-      if (node.component || node.directives.length) {\n-        nodes.push(node);\n-        extractNodes(lView[i], node.children);\n-      }\n-    }\n-  }\n-  return nodes;\n-};\n-\n-export const buildDirectiveTree = (lView: any) => extractNodes(lView);"
        },
        {
            "sha": "62455e29c634cbd9ea8c9b1365dce94438af2592",
            "filename": "projects/ng-devtools-backend/src/lib/state-serializer/serialized-descriptor-factory.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fstate-serializer%2Fserialized-descriptor-factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fstate-serializer%2Fserialized-descriptor-factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fstate-serializer%2Fserialized-descriptor-factory.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -1,5 +1,5 @@\n import { Descriptor, NestedProp, PropType } from 'protocol';\n-import { METADATA_PROPERTY_NAME } from '../lview-transform';\n+import { METADATA_PROPERTY_NAME } from '../directive-forest';\n \n export interface CompositeType {\n   type: Extract<PropType, PropType.Array | PropType.Object>;\n@@ -179,7 +179,7 @@ const getNestedDescriptorValue = (\n \n   switch (type) {\n     case PropType.Array:\n-      return nodes.map(nestedProp => nestedSerializer(prop[nestedProp.name], nestedProp.children, currentLevel + 1));\n+      return nodes.map((nestedProp) => nestedSerializer(prop[nestedProp.name], nestedProp.children, currentLevel + 1));\n     case PropType.Object:\n       return nodes.reduce((accumulator, nestedProp) => {\n         if ("
        },
        {
            "sha": "703204886ffe7a79d1c56d8667be5f71409bf5c9",
            "filename": "projects/ng-devtools-backend/src/lib/state-serializer/state-serializer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fstate-serializer%2Fstate-serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fstate-serializer%2Fstate-serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fstate-serializer%2Fstate-serializer.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -5,7 +5,7 @@ import {\n   createShallowSerializedDescriptor,\n   PropertyData,\n } from './serialized-descriptor-factory';\n-import { METADATA_PROPERTY_NAME } from '../lview-transform';\n+import { METADATA_PROPERTY_NAME } from '../directive-forest';\n \n const ignoreList = new Set([METADATA_PROPERTY_NAME, '__ngSimpleChanges__']);\n \n@@ -81,7 +81,7 @@ const nestedSerializerContinuation = (nodes: NestedProp[], level: number) => (\n   propName: string | number | undefined,\n   nestedLevel: number\n ) => {\n-  const idx = nodes.findIndex(v => v.name === propName);\n+  const idx = nodes.findIndex((v) => v.name === propName);\n   if (idx < 0) {\n     // The property is not specified in the query.\n     return nestedSerializer(nestedProp, [], nestedLevel, level);\n@@ -123,11 +123,11 @@ export const deeplySerializeSelectedProperties = (\n   props: NestedProp[]\n ): { [name: string]: Descriptor } => {\n   const result = {};\n-  Object.keys(instance).forEach(propName => {\n+  Object.keys(instance).forEach((propName) => {\n     if (ignoreList.has(propName)) {\n       return;\n     }\n-    const idx = props.findIndex(v => v.name === propName);\n+    const idx = props.findIndex((v) => v.name === propName);\n     if (idx < 0) {\n       result[propName] = levelSerializer(instance[propName]);\n     } else {"
        },
        {
            "sha": "894242e5d2ca31dd2768829ff219cdcfbd384378",
            "filename": "projects/ng-devtools-backend/src/lib/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Futils.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -11,7 +11,7 @@ export const runOutsideAngular = (f: () => any): void => {\n   w.Zone.current._parent.run(f);\n };\n \n-export const componentMetadata = (instance: any) => instance.constructor.ɵcmp;\n+export const componentMetadata = (instance: any) => instance?.constructor?.ɵcmp;\n \n export const isCustomElement = (node: Node) => {\n   if (typeof customElements === 'undefined') {"
        },
        {
            "sha": "183e74feb342fbf83cf3781fc0462e94a7ae86c0",
            "filename": "projects/shell-adventure/src/index.html",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fshell-adventure%2Fsrc%2Findex.html",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/projects%2Fshell-adventure%2Fsrc%2Findex.html",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fshell-adventure%2Fsrc%2Findex.html?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html lang=\"en\">\n+  <head>\n+    <meta charset=\"utf-8\" />\n+    <title>ShellAdventure</title>\n+    <base href=\"/\" />\n+    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n+    <link rel=\"icon\" type=\"image/x-icon\" href=\"favicon.ico\" />\n+  </head>\n+  <body>\n+    <app-root></app-root>\n+    <iframe></iframe>\n+  </body>\n+</html>"
        },
        {
            "sha": "30215e142d886e0cc10e9b9507aadff5c5803097",
            "filename": "src/app/demo-app/demo-app.component.html",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/src%2Fapp%2Fdemo-app%2Fdemo-app.component.html",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/src%2Fapp%2Fdemo-app%2Fdemo-app.component.html",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/src%2Fapp%2Fdemo-app%2Fdemo-app.component.html?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -1,4 +1,16 @@\n <router-outlet></router-outlet>\n <app-zippy [title]=\"getTitle()\">This is my content</app-zippy>\n-<app-heavy></app-heavy>\n+<app-heavy>\n+  <button mat-button>Button</button>\n+</app-heavy>\n <div #elementReference>HTMLElement</div>\n+\n+<h2>The portal outlet is below:</h2>\n+<div class=\"example-portal-outlet\">\n+  <ng-template [cdkPortalOutlet]=\"selectedPortal\"></ng-template>\n+</div>\n+<ng-template #templatePortalContent>Hello, this is a template portal</ng-template>\n+\n+<button (click)=\"selectedPortal = componentPortal\">Render component portal</button>\n+\n+<div #domPortalContent>Hello, this is a DOM portal</div>"
        },
        {
            "sha": "66a85cfe63d0aa627089602bcfd2a54454fe6c5e",
            "filename": "src/app/demo-app/demo-app.component.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/src%2Fapp%2Fdemo-app%2Fdemo-app.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/src%2Fapp%2Fdemo-app%2Fdemo-app.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/src%2Fapp%2Fdemo-app%2Fdemo-app.component.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -1,4 +1,5 @@\n-import { Component, ElementRef, ViewChild, ViewEncapsulation } from '@angular/core';\n+import { ComponentPortal, DomPortal, Portal, TemplatePortal } from '@angular/cdk/portal';\n+import { Component, ElementRef, TemplateRef, ViewChild, ViewContainerRef, ViewEncapsulation } from '@angular/core';\n import { ZippyComponent } from './zippy/zippy.component';\n \n @Component({\n@@ -16,4 +17,26 @@ export class DemoAppComponent {\n     }\n     return '▼ Click to collapse';\n   }\n+\n+  @ViewChild('templatePortalContent') templatePortalContent: TemplateRef<unknown>;\n+  @ViewChild('domPortalContent') domPortalContent: ElementRef<HTMLElement>;\n+\n+  selectedPortal: Portal<any>;\n+  componentPortal: ComponentPortal<ComponentPortalExample>;\n+  templatePortal: TemplatePortal<any>;\n+  domPortal: DomPortal<any>;\n+\n+  constructor(private _viewContainerRef: ViewContainerRef) {}\n+\n+  ngAfterViewInit() {\n+    this.componentPortal = new ComponentPortal(ComponentPortalExample);\n+    this.templatePortal = new TemplatePortal(this.templatePortalContent, this._viewContainerRef);\n+    this.domPortal = new DomPortal(this.domPortalContent);\n+  }\n }\n+\n+@Component({\n+  selector: 'component-portal-example',\n+  template: 'Hello, this is a component portal',\n+})\n+export class ComponentPortalExample {}"
        },
        {
            "sha": "36d4ea8ccb25188466bbfa76957da0229ed6f0b1",
            "filename": "src/app/demo-app/demo-app.module.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/src%2Fapp%2Fdemo-app%2Fdemo-app.module.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/src%2Fapp%2Fdemo-app%2Fdemo-app.module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/src%2Fapp%2Fdemo-app%2Fdemo-app.module.ts?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -7,12 +7,16 @@ import { ZippyComponent } from './zippy/zippy.component';\n import { ZoneUnawareIFrameMessageBus } from 'src/zone-unaware-iframe-message-bus';\n import { HeavyComponent } from './heavy/heavy.component';\n import { createCustomElement } from '@angular/elements';\n+import { MatButtonModule } from '@angular/material/button';\n+import { PortalModule } from '@angular/cdk/portal';\n \n @NgModule({\n   declarations: [DemoAppComponent, HeavyComponent],\n   schemas: [CUSTOM_ELEMENTS_SCHEMA],\n   exports: [DemoAppComponent],\n   imports: [\n+    PortalModule,\n+    MatButtonModule,\n     RouterModule.forChild([\n       {\n         path: '',"
        },
        {
            "sha": "f792bd46730bfe0b4538a2bf5c21af6c95f926df",
            "filename": "src/app/demo-app/heavy/heavy.component.html",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a3fed3bc94197475ddffae016d1ce9c8acb47140/src%2Fapp%2Fdemo-app%2Fheavy%2Fheavy.component.html",
            "raw_url": "https://github.com/angular/angular/raw/a3fed3bc94197475ddffae016d1ce9c8acb47140/src%2Fapp%2Fdemo-app%2Fheavy%2Fheavy.component.html",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/src%2Fapp%2Fdemo-app%2Fheavy%2Fheavy.component.html?ref=a3fed3bc94197475ddffae016d1ce9c8acb47140",
            "patch": "@@ -1 +1,3 @@\n <h1>{{ calculate() }}</h1>\n+\n+<ng-content></ng-content>"
        }
    ],
    "stats": {
        "total": 433,
        "additions": 296,
        "deletions": 137
    }
}