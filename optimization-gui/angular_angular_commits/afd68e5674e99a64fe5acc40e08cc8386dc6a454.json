{
    "author": "crisbeto",
    "message": "feat(compiler): emit diagnostic for shadow dom components with an invalid selector (#42245)\n\nThis is based on a discussion we had a few weeks ago. Currently if a component uses `ViewEncapsulation.ShadowDom` and its selector doesn't meet the requirements for a custom element tag name, a vague error will be thrown at runtime saying something like \"Element does not support attachShadowRoot\".\n\nThese changes add a new diagnostic to the compiler that validates the component selector and gives a better error message during compilation.\n\nPR Close #42245",
    "sha": "afd68e5674e99a64fe5acc40e08cc8386dc6a454",
    "files": [
        {
            "sha": "3f9d535be7a5227559ec89ed70b0a8a7c23152bb",
            "filename": "aio/content/errors/NG2009.md",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/afd68e5674e99a64fe5acc40e08cc8386dc6a454/aio%2Fcontent%2Ferrors%2FNG2009.md",
            "raw_url": "https://github.com/angular/angular/raw/afd68e5674e99a64fe5acc40e08cc8386dc6a454/aio%2Fcontent%2Ferrors%2FNG2009.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Ferrors%2FNG2009.md?ref=afd68e5674e99a64fe5acc40e08cc8386dc6a454",
            "patch": "@@ -0,0 +1,32 @@\n+@name Invalid Shadow DOM selector\n+@category compiler\n+@shortDescription Component selector does not match shadow DOM requirements\n+\n+@description\n+The selector of a component using `ViewEncapsulation.ShadowDom` doesn't match the custom element tag name requirements.\n+\n+In order for a tag name to be considered a valid custom element name, it has to:\n+* Be in lower case.\n+* Contain a hyphen.\n+* Start with a letter (a-z).\n+\n+@debugging\n+Rename your component's selector so that it matches the requirements.\n+\n+**Before:**\n+```typescript\n+@Component({\n+  selector: 'comp',\n+  encapsulation: ViewEncapsulation.ShadowDom\n+  ...\n+})\n+```\n+\n+**After:**\n+```typescript\n+@Component({\n+  selector: 'app-comp',\n+  encapsulation: ViewEncapsulation.ShadowDom\n+  ...\n+})\n+```"
        },
        {
            "sha": "25154c5c60885396a8b9b05ecbc315d5a4b0c063",
            "filename": "goldens/public-api/compiler-cli/error_code.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/afd68e5674e99a64fe5acc40e08cc8386dc6a454/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/afd68e5674e99a64fe5acc40e08cc8386dc6a454/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts?ref=afd68e5674e99a64fe5acc40e08cc8386dc6a454",
            "patch": "@@ -15,6 +15,7 @@ export declare enum ErrorCode {\n     DIRECTIVE_INHERITS_UNDECORATED_CTOR = 2006,\n     UNDECORATED_CLASS_USING_ANGULAR_FEATURES = 2007,\n     COMPONENT_RESOURCE_NOT_FOUND = 2008,\n+    COMPONENT_INVALID_SHADOW_DOM_SELECTOR = 2009,\n     SYMBOL_NOT_EXPORTED = 3001,\n     SYMBOL_EXPORTED_UNDER_DIFFERENT_NAME = 3002,\n     IMPORT_CYCLE_DETECTED = 3003,"
        },
        {
            "sha": "c497ab6564057ed96a1bf6f65eff62309d610c10",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 12,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/afd68e5674e99a64fe5acc40e08cc8386dc6a454/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/afd68e5674e99a64fe5acc40e08cc8386dc6a454/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=afd68e5674e99a64fe5acc40e08cc8386dc6a454",
            "patch": "@@ -7,10 +7,11 @@\n  */\n \n import {compileClassMetadata, compileComponentFromMetadata, compileDeclareClassMetadata, compileDeclareComponentFromMetadata, ConstantPool, CssSelector, DeclarationListEmitMode, DeclareComponentTemplateInfo, DEFAULT_INTERPOLATION_CONFIG, DomElementSchemaRegistry, Expression, ExternalExpr, FactoryTarget, InterpolationConfig, LexerRange, makeBindingParser, ParsedTemplate, ParseSourceFile, parseTemplate, R3ClassMetadata, R3ComponentMetadata, R3TargetBinder, R3UsedDirectiveMetadata, SelectorMatcher, Statement, TmplAstNode, WrappedNodeExpr} from '@angular/compiler';\n+import {ViewEncapsulation} from '@angular/compiler/src/core';\n import * as ts from 'typescript';\n \n import {Cycle, CycleAnalyzer, CycleHandlingStrategy} from '../../cycles';\n-import {ErrorCode, FatalDiagnosticError, makeRelatedInformation} from '../../diagnostics';\n+import {ErrorCode, FatalDiagnosticError, makeDiagnostic, makeRelatedInformation} from '../../diagnostics';\n import {absoluteFrom, relative} from '../../file_system';\n import {ImportedFile, ModuleResolver, Reference, ReferenceEmitter} from '../../imports';\n import {DependencyTracker} from '../../incremental/api';\n@@ -338,6 +339,16 @@ export class ComponentDecoratorHandler implements\n \n     // Next, read the `@Component`-specific fields.\n     const {decorator: component, metadata, inputs, outputs} = directiveResult;\n+    const encapsulation: number =\n+        this._resolveEnumValue(component, 'encapsulation', 'ViewEncapsulation') ??\n+        ViewEncapsulation.Emulated;\n+    const changeDetection: number|null =\n+        this._resolveEnumValue(component, 'changeDetection', 'ChangeDetectionStrategy');\n+\n+    let animations: Expression|null = null;\n+    if (component.has('animations')) {\n+      animations = new WrappedNodeExpr(component.get('animations')!);\n+    }\n \n     // Go through the root directories for this project, and select the one with the smallest\n     // relative path representation.\n@@ -426,6 +437,18 @@ export class ComponentDecoratorHandler implements\n       }\n     }\n \n+    if (encapsulation === ViewEncapsulation.ShadowDom && metadata.selector !== null) {\n+      const selectorError = checkCustomElementSelectorForErrors(metadata.selector);\n+      if (selectorError !== null) {\n+        if (diagnostics === undefined) {\n+          diagnostics = [];\n+        }\n+        diagnostics.push(makeDiagnostic(\n+            ErrorCode.COMPONENT_INVALID_SHADOW_DOM_SELECTOR, component.get('selector')!,\n+            selectorError));\n+      }\n+    }\n+\n     // If inline styles were preprocessed use those\n     let inlineStyles: string[]|null = null;\n     if (this.preanalyzeStylesCache.has(node)) {\n@@ -455,17 +478,6 @@ export class ComponentDecoratorHandler implements\n       styles.push(...template.styles);\n     }\n \n-    const encapsulation: number =\n-        this._resolveEnumValue(component, 'encapsulation', 'ViewEncapsulation') || 0;\n-\n-    const changeDetection: number|null =\n-        this._resolveEnumValue(component, 'changeDetection', 'ChangeDetectionStrategy');\n-\n-    let animations: Expression|null = null;\n-    if (component.has('animations')) {\n-      animations = new WrappedNodeExpr(component.get('animations')!);\n-    }\n-\n     const output: AnalysisOutput<ComponentAnalysisData> = {\n       analysis: {\n         baseClass: readBaseClass(node, this.reflector, this.evaluator),\n@@ -1431,3 +1443,31 @@ function makeCyclicImportInfo(\n       `The ${type} '${name}' is used in the template but importing it would create a cycle: `;\n   return makeRelatedInformation(ref.node, message + path);\n }\n+\n+\n+/**\n+ * Checks whether a selector is a valid custom element tag name.\n+ * Based loosely on https://github.com/sindresorhus/validate-element-name.\n+ */\n+function checkCustomElementSelectorForErrors(selector: string): string|null {\n+  // Avoid flagging components with an attribute or class selector. This isn't bulletproof since it\n+  // won't catch cases like `foo[]bar`, but we don't need it to be. This is mainly to avoid flagging\n+  // something like `foo-bar[baz]` incorrectly.\n+  if (selector.includes('.') || (selector.includes('[') && selector.includes(']'))) {\n+    return null;\n+  }\n+\n+  if (!(/^[a-z]/.test(selector))) {\n+    return 'Selector of a ShadowDom-encapsulated component must start with a lower case letter.';\n+  }\n+\n+  if (/[A-Z]/.test(selector)) {\n+    return 'Selector of a ShadowDom-encapsulated component must all be in lower case.';\n+  }\n+\n+  if (!selector.includes('-')) {\n+    return 'Selector of a component that uses ViewEncapsulation.ShadowDom must contain a hyphen.';\n+  }\n+\n+  return null;\n+}"
        },
        {
            "sha": "a0dc5e3f5af31fc64ef894ca87467314c0dd8a9f",
            "filename": "packages/compiler-cli/src/ngtsc/diagnostics/src/error_code.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/afd68e5674e99a64fe5acc40e08cc8386dc6a454/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "raw_url": "https://github.com/angular/angular/raw/afd68e5674e99a64fe5acc40e08cc8386dc6a454/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts?ref=afd68e5674e99a64fe5acc40e08cc8386dc6a454",
            "patch": "@@ -50,6 +50,12 @@ export enum ErrorCode {\n    */\n   COMPONENT_RESOURCE_NOT_FOUND = 2008,\n \n+  /**\n+   * Raised when a component uses `ShadowDom` view encapsulation, but its selector\n+   * does not match the shadow DOM tag name requirements.\n+   */\n+  COMPONENT_INVALID_SHADOW_DOM_SELECTOR = 2009,\n+\n   SYMBOL_NOT_EXPORTED = 3001,\n   SYMBOL_EXPORTED_UNDER_DIFFERENT_NAME = 3002,\n   /**\n@@ -215,6 +221,7 @@ export const COMPILER_ERRORS_WITH_GUIDES = new Set([\n   ErrorCode.SCHEMA_INVALID_ELEMENT,\n   ErrorCode.SCHEMA_INVALID_ATTRIBUTE,\n   ErrorCode.MISSING_REFERENCE_TARGET,\n+  ErrorCode.COMPONENT_INVALID_SHADOW_DOM_SELECTOR,\n ]);\n \n /**"
        },
        {
            "sha": "1b179a25c63f1f827d9167cf52dd4b878346cff7",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 105,
            "deletions": 0,
            "changes": 105,
            "blob_url": "https://github.com/angular/angular/blob/afd68e5674e99a64fe5acc40e08cc8386dc6a454/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/afd68e5674e99a64fe5acc40e08cc8386dc6a454/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=afd68e5674e99a64fe5acc40e08cc8386dc6a454",
            "patch": "@@ -7864,6 +7864,111 @@ export const Foo = Foo__PRE_R3__;\n         });\n       });\n \n+      describe('shadow DOM selector diagnostics', () => {\n+        it('should emit a diagnostic when a selector does not include a hyphen', () => {\n+          env.write('test.ts', `\n+            import {Component, ViewEncapsulation} from '@angular/core';\n+            @Component({\n+              template: '',\n+              selector: 'cmp',\n+              encapsulation: ViewEncapsulation.ShadowDom\n+            })\n+            export class TestCmp {}\n+          `);\n+          const diags = env.driveDiagnostics();\n+\n+          expect(diags.length).toBe(1);\n+          expect(diags[0].messageText)\n+              .toBe(\n+                  'Selector of a component that uses ViewEncapsulation.ShadowDom must contain a hyphen.');\n+          expect(getDiagnosticSourceCode(diags[0])).toBe(`'cmp'`);\n+        });\n+\n+        it('should emit a diagnostic when a selector includes uppercase letters', () => {\n+          env.write('test.ts', `\n+            import {Component, ViewEncapsulation} from '@angular/core';\n+            @Component({\n+              template: '',\n+              selector: 'my-Comp',\n+              encapsulation: ViewEncapsulation.ShadowDom\n+            })\n+            export class TestCmp {}\n+          `);\n+          const diags = env.driveDiagnostics();\n+\n+          expect(diags.length).toBe(1);\n+          expect(diags[0].messageText)\n+              .toBe('Selector of a ShadowDom-encapsulated component must all be in lower case.');\n+          expect(getDiagnosticSourceCode(diags[0])).toBe(`'my-Comp'`);\n+        });\n+\n+        it('should emit a diagnostic when a selector starts with a digit', () => {\n+          env.write('test.ts', `\n+            import {Component, ViewEncapsulation} from '@angular/core';\n+            @Component({\n+              template: '',\n+              selector: '123-comp',\n+              encapsulation: ViewEncapsulation.ShadowDom\n+            })\n+            export class TestCmp {}\n+          `);\n+          const diags = env.driveDiagnostics();\n+\n+          expect(diags.length).toBe(1);\n+          expect(diags[0].messageText)\n+              .toBe(\n+                  'Selector of a ShadowDom-encapsulated component must start with a lower case letter.');\n+          expect(getDiagnosticSourceCode(diags[0])).toBe(`'123-comp'`);\n+        });\n+\n+        it('should emit a diagnostic when a selector starts with a hyphen', () => {\n+          env.write('test.ts', `\n+            import {Component, ViewEncapsulation} from '@angular/core';\n+            @Component({\n+              template: '',\n+              selector: '-comp',\n+              encapsulation: ViewEncapsulation.ShadowDom\n+            })\n+            export class TestCmp {}\n+          `);\n+          const diags = env.driveDiagnostics();\n+\n+          expect(diags.length).toBe(1);\n+          expect(diags[0].messageText)\n+              .toBe(\n+                  'Selector of a ShadowDom-encapsulated component must start with a lower case letter.');\n+          expect(getDiagnosticSourceCode(diags[0])).toBe(`'-comp'`);\n+        });\n+\n+        it('should not emit a diagnostic for a component using an attribute selector', () => {\n+          env.write('test.ts', `\n+            import {Component, ViewEncapsulation} from '@angular/core';\n+            @Component({\n+              template: '',\n+              selector: '[button]',\n+              encapsulation: ViewEncapsulation.ShadowDom\n+            })\n+            export class TestCmp {}\n+          `);\n+          const diags = env.driveDiagnostics();\n+          expect(diags.length).toBe(0);\n+        });\n+\n+        it('should not emit a diagnostic for a component using a class selector', () => {\n+          env.write('test.ts', `\n+            import {Component, ViewEncapsulation} from '@angular/core';\n+            @Component({\n+              template: '',\n+              selector: '.button',\n+              encapsulation: ViewEncapsulation.ShadowDom\n+            })\n+            export class TestCmp {}\n+          `);\n+          const diags = env.driveDiagnostics();\n+          expect(diags.length).toBe(0);\n+        });\n+      });\n+\n       describe('i18n errors', () => {\n         it('reports a diagnostics on nested i18n sections', () => {\n           env.write('test.ts', `"
        }
    ],
    "stats": {
        "total": 209,
        "additions": 197,
        "deletions": 12
    }
}