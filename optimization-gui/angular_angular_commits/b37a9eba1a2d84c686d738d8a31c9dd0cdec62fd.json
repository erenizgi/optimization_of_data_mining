{
    "author": "martinsik",
    "message": "fix(router): lazy loaded modules without RouterModule.forChild() won't cause an infinite loop (#36605)\n\nWhen loading a module that doesn't provide `RouterModule.forChild()` preloader will get stuck\nin an infinite loop and throw `ERROR Error: Maximum call stack size exceeded.`\nThe issue is that child module's `Injector` will look to its parent `Injector` when it doesn't\nfind any `ROUTES` so it will return routes for it's parent module instead. This will load the\nchild again that returns its parent's routes and so on.\n\nCloses #29164\n\nPR Close #36605",
    "sha": "b37a9eba1a2d84c686d738d8a31c9dd0cdec62fd",
    "files": [
        {
            "sha": "e9d21974eeea8e45fdc79df6b7012c65ac8c6941",
            "filename": "packages/router/src/router_config_loader.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/b37a9eba1a2d84c686d738d8a31c9dd0cdec62fd/packages%2Frouter%2Fsrc%2Frouter_config_loader.ts",
            "raw_url": "https://github.com/angular/angular/raw/b37a9eba1a2d84c686d738d8a31c9dd0cdec62fd/packages%2Frouter%2Fsrc%2Frouter_config_loader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter_config_loader.ts?ref=b37a9eba1a2d84c686d738d8a31c9dd0cdec62fd",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Compiler, InjectionToken, Injector, NgModuleFactory, NgModuleFactoryLoader} from '@angular/core';\n+import {Compiler, InjectFlags, InjectionToken, Injector, NgModuleFactory, NgModuleFactoryLoader} from '@angular/core';\n import {from, Observable, of} from 'rxjs';\n import {map, mergeMap} from 'rxjs/operators';\n \n@@ -41,8 +41,13 @@ export class RouterConfigLoader {\n \n       const module = factory.create(parentInjector);\n \n+      // When loading a module that doesn't provide `RouterModule.forChild()` preloader will get\n+      // stuck in an infinite loop. The child module's Injector will look to its parent `Injector`\n+      // when it doesn't find any ROUTES so it will return routes for it's parent module instead.\n       return new LoadedRouterConfig(\n-          flatten(module.injector.get(ROUTES)).map(standardizeConfig), module);\n+          flatten(module.injector.get(ROUTES, undefined, InjectFlags.Self | InjectFlags.Optional))\n+              .map(standardizeConfig),\n+          module);\n     }));\n   }\n "
        },
        {
            "sha": "4bec29733c1361668de2db19bc9bd04bab585feb",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/b37a9eba1a2d84c686d738d8a31c9dd0cdec62fd/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b37a9eba1a2d84c686d738d8a31c9dd0cdec62fd/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=b37a9eba1a2d84c686d738d8a31c9dd0cdec62fd",
            "patch": "@@ -5291,6 +5291,10 @@ describe('Integration', () => {\n       class LoadedModule1 {\n       }\n \n+      @NgModule({})\n+      class EmptyModule {\n+      }\n+\n       beforeEach(() => {\n         log.length = 0;\n         TestBed.configureTestingModule({\n@@ -5355,6 +5359,19 @@ describe('Integration', () => {\n            expect(firstConfig).toBeUndefined();\n            expect(log.length).toBe(0);\n          }));\n+\n+      it('should allow navigation to modules with no routes', fakeAsync(() => {\n+           (TestBed.inject(NgModuleFactoryLoader) as SpyNgModuleFactoryLoader).stubbedModules = {\n+             empty: EmptyModule,\n+           };\n+           const router = TestBed.inject(Router);\n+           const fixture = createRoot(router, RootCmp);\n+\n+           router.resetConfig([{path: 'lazy', loadChildren: 'empty'}]);\n+\n+           router.navigateByUrl('/lazy');\n+           advance(fixture);\n+         }));\n     });\n \n     describe('custom url handling strategies', () => {"
        },
        {
            "sha": "db4edfbd3829a38694d0cfe9cb28deaad49d834c",
            "filename": "packages/router/test/router_preloader.spec.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/b37a9eba1a2d84c686d738d8a31c9dd0cdec62fd/packages%2Frouter%2Ftest%2Frouter_preloader.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b37a9eba1a2d84c686d738d8a31c9dd0cdec62fd/packages%2Frouter%2Ftest%2Frouter_preloader.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Frouter_preloader.spec.ts?ref=b37a9eba1a2d84c686d738d8a31c9dd0cdec62fd",
            "patch": "@@ -261,4 +261,35 @@ describe('RouterPreloader', () => {\n              expect(c[0]._loadedConfig!.routes[0].component).toBe(configs[0].component);\n            })));\n   });\n+\n+  describe(\n+      'should work with lazy loaded modules that don\\'t provide RouterModule.forChild()', () => {\n+        @NgModule({\n+          declarations: [LazyLoadedCmp],\n+          imports: [RouterModule.forChild([{path: 'LoadedModule1', component: LazyLoadedCmp}])]\n+        })\n+        class LoadedModule {\n+        }\n+\n+        @NgModule({})\n+        class EmptyModule {\n+        }\n+\n+        beforeEach(() => {\n+          TestBed.configureTestingModule({\n+            imports: [RouterTestingModule.withRoutes(\n+                [{path: 'lazyEmptyModule', loadChildren: 'expected2'}])],\n+            providers: [{provide: PreloadingStrategy, useExisting: PreloadAllModules}]\n+          });\n+        });\n+\n+        it('should work',\n+           fakeAsync(inject(\n+               [NgModuleFactoryLoader, RouterPreloader],\n+               (loader: SpyNgModuleFactoryLoader, preloader: RouterPreloader) => {\n+                 loader.stubbedModules = {expected2: EmptyModule};\n+\n+                 preloader.preload().subscribe();\n+               })));\n+      });\n });"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 55,
        "deletions": 2
    }
}