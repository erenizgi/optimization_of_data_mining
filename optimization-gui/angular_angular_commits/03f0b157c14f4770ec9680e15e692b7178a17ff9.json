{
    "author": "abarghoud",
    "message": "fix(common): date is not correctly formatted when year is between 0 and 99 (#40448)\n\nuse setFullYear method when parsing date to avoid javascript date factory behaviour\n\nFixes #40377\n\nPR Close #40448",
    "sha": "03f0b157c14f4770ec9680e15e692b7178a17ff9",
    "files": [
        {
            "sha": "9e2b9c9a38a869b7c4eff3bbe960d36ceec97558",
            "filename": "packages/common/src/i18n/format_date.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 4,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/03f0b157c14f4770ec9680e15e692b7178a17ff9/packages%2Fcommon%2Fsrc%2Fi18n%2Fformat_date.ts",
            "raw_url": "https://github.com/angular/angular/raw/03f0b157c14f4770ec9680e15e692b7178a17ff9/packages%2Fcommon%2Fsrc%2Fi18n%2Fformat_date.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Fi18n%2Fformat_date.ts?ref=03f0b157c14f4770ec9680e15e692b7178a17ff9",
            "patch": "@@ -101,6 +101,38 @@ export function formatDate(\n   return text;\n }\n \n+/**\n+ * Create a new Date object with the given date value, and the time set to midnight.\n+ *\n+ * We cannot use `new Date(year, month, date)` because it maps years between 0 and 99 to 1900-1999.\n+ * See: https://github.com/angular/angular/issues/40377\n+ *\n+ * Note that this function returns a Date object whose time is midnight in the current locale's\n+ * timezone. In the future we might want to change this to be midnight in UTC, but this would be a\n+ * considerable breaking change.\n+ */\n+function createDate(year: number, month: number, date: number): Date {\n+  // The `newDate` is set to midnight (UTC) on January 1st 1970.\n+  // - In PST this will be December 31st 1969 at 4pm.\n+  // - In GMT this will be January 1st 1970 at 1am.\n+  // Note that they even have different years, dates and months!\n+  const newDate = new Date(0);\n+\n+  // `setFullYear()` allows years like 0001 to be set correctly. This function does not\n+  // change the internal time of the date.\n+  // Consider calling `setFullYear(2019, 8, 20)` (September 20, 2019).\n+  // - In PST this will now be September 20, 2019 at 4pm\n+  // - In GMT this will now be September 20, 2019 at 1am\n+\n+  newDate.setFullYear(year, month, date);\n+  // We want the final date to be at local midnight, so we reset the time.\n+  // - In PST this will now be September 20, 2019 at 12am\n+  // - In GMT this will now be September 20, 2019 at 12am\n+  newDate.setHours(0, 0, 0);\n+\n+  return newDate;\n+}\n+\n function getNamedFormat(locale: string, format: string): string {\n   const localeId = getLocaleId(locale);\n   NAMED_FORMATS[localeId] = NAMED_FORMATS[localeId] || {};\n@@ -362,13 +394,13 @@ function timeZoneGetter(width: ZoneWidth): DateFormatter {\n const JANUARY = 0;\n const THURSDAY = 4;\n function getFirstThursdayOfYear(year: number) {\n-  const firstDayOfYear = (new Date(year, JANUARY, 1)).getDay();\n-  return new Date(\n+  const firstDayOfYear = createDate(year, JANUARY, 1).getDay();\n+  return createDate(\n       year, 0, 1 + ((firstDayOfYear <= THURSDAY) ? THURSDAY : THURSDAY + 7) - firstDayOfYear);\n }\n \n function getThursdayThisWeek(datetime: Date) {\n-  return new Date(\n+  return createDate(\n       datetime.getFullYear(), datetime.getMonth(),\n       datetime.getDate() + (THURSDAY - datetime.getDay()));\n }\n@@ -720,7 +752,7 @@ export function toDate(value: string|number|Date): Date {\n       is applied.\n       Note: ISO months are 0 for January, 1 for February, ... */\n       const [y, m = 1, d = 1] = value.split('-').map((val: string) => +val);\n-      return new Date(y, m - 1, d);\n+      return createDate(y, m - 1, d);\n     }\n \n     const parsedNb = parseFloat(value);"
        },
        {
            "sha": "3109d9f77b6f45e12f503e9eaad9fd850c4db4f5",
            "filename": "packages/common/src/pipes/date_pipe.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/03f0b157c14f4770ec9680e15e692b7178a17ff9/packages%2Fcommon%2Fsrc%2Fpipes%2Fdate_pipe.ts",
            "raw_url": "https://github.com/angular/angular/raw/03f0b157c14f4770ec9680e15e692b7178a17ff9/packages%2Fcommon%2Fsrc%2Fpipes%2Fdate_pipe.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Fpipes%2Fdate_pipe.ts?ref=03f0b157c14f4770ec9680e15e692b7178a17ff9",
            "patch": "@@ -114,7 +114,6 @@ import {invalidPipeArgumentError} from './invalid_pipe_argument_error';\n  *  |                    | O, OO & OOO | Short localized GMT format                                    | GMT-8                                                      |\n  *  |                    | OOOO        | Long localized GMT format                                     | GMT-08:00                                                  |\n  *\n- * Note that timezone correction is not applied to an ISO string that has no time component, such as \"2016-09-19\"\n  *\n  * ### Format examples\n  *"
        },
        {
            "sha": "56d16197f9200c21ae1983fb1220695fff658cc9",
            "filename": "packages/common/test/i18n/format_date_spec.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/03f0b157c14f4770ec9680e15e692b7178a17ff9/packages%2Fcommon%2Ftest%2Fi18n%2Fformat_date_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/03f0b157c14f4770ec9680e15e692b7178a17ff9/packages%2Fcommon%2Ftest%2Fi18n%2Fformat_date_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Ftest%2Fi18n%2Fformat_date_spec.ts?ref=03f0b157c14f4770ec9680e15e692b7178a17ff9",
            "patch": "@@ -347,6 +347,32 @@ describe('Format date', () => {\n           .toEqual('10:14 AM');\n     });\n \n+    // The following test is disabled because backwards compatibility requires that date-only ISO\n+    // strings are parsed with the local timezone.\n+\n+    // it('should create UTC date objects when an ISO string is passed with no time components',\n+    //    () => {\n+    //      expect(formatDate('2019-09-20', `MMM d, y, h:mm:ss a ZZZZZ`, ɵDEFAULT_LOCALE_ID))\n+    //          .toEqual('Sep 20, 2019, 12:00:00 AM Z');\n+    //    });\n+\n+    // This test is to ensure backward compatibility for parsing date-only ISO strings.\n+    it('should create local timezone date objects when an ISO string is passed with no time components',\n+       () => {\n+         // Dates created with individual components are evaluated against the local timezone. See\n+         // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/Date#Individual_date_and_time_component_values\n+         const localDate = new Date(2019, 8, 20, 0, 0, 0, 0);\n+         expect(formatDate('2019-09-20', `MMM d, y, h:mm:ss a ZZZZZ`, ɵDEFAULT_LOCALE_ID))\n+             .toEqual(formatDate(localDate, `MMM d, y, h:mm:ss a ZZZZZ`, ɵDEFAULT_LOCALE_ID));\n+       });\n+\n+    it('should create local timezone date objects when an ISO string is passed with time components',\n+       () => {\n+         const localDate = new Date(2019, 8, 20, 0, 0, 0, 0);\n+         expect(formatDate('2019-09-20T00:00:00', `MMM d, y, h:mm:ss a ZZZZZ`, ɵDEFAULT_LOCALE_ID))\n+             .toEqual(formatDate(localDate, `MMM d, y, h:mm:ss a ZZZZZ`, ɵDEFAULT_LOCALE_ID));\n+       });\n+\n     it('should remove bidi control characters',\n        () => expect(formatDate(date, 'MM/dd/yyyy', ɵDEFAULT_LOCALE_ID)!.length).toEqual(10));\n \n@@ -389,6 +415,17 @@ describe('Format date', () => {\n          expect(formatDate('2013-12-29', 'YYYY', 'en')).toEqual('2014');\n          expect(formatDate('2010-01-02', 'YYYY', 'en')).toEqual('2009');\n          expect(formatDate('2010-01-04', 'YYYY', 'en')).toEqual('2010');\n+         expect(formatDate('0049-01-01', 'YYYY', 'en')).toEqual('0048');\n+         expect(formatDate('0049-01-04', 'YYYY', 'en')).toEqual('0049');\n        });\n+\n+    // https://github.com/angular/angular/issues/40377\n+    it('should format date with year between 0 and 99 correctly', () => {\n+      expect(formatDate('0098-01-11', 'YYYY', ɵDEFAULT_LOCALE_ID)).toEqual('0098');\n+      expect(formatDate('0099-01-11', 'YYYY', ɵDEFAULT_LOCALE_ID)).toEqual('0099');\n+      expect(formatDate('0100-01-11', 'YYYY', ɵDEFAULT_LOCALE_ID)).toEqual('0100');\n+      expect(formatDate('0001-01-11', 'YYYY', ɵDEFAULT_LOCALE_ID)).toEqual('0001');\n+      expect(formatDate('0000-01-11', 'YYYY', ɵDEFAULT_LOCALE_ID)).toEqual('0000');\n+    });\n   });\n });"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 73,
        "deletions": 5
    }
}