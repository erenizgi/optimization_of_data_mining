{
    "author": "josephperrott",
    "message": "ci: migrate rebase-pr CI script to the circleci directory (#39592)\n\nMigrate the rebase-pr script used on CI out of tools and into the circleci\ndirectory.  Additionally removes its support for running in the local\nrepository as this is now better handled by `ng-dev pr rebase <pr-number>`.\n\nPR Close #39592",
    "sha": "726d7c123cfd1fb821f38e20a2fbddec2f84d6c1",
    "files": [
        {
            "sha": "ed6f77d7002b2876642af8d3d220178fd5f1c1c5",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/726d7c123cfd1fb821f38e20a2fbddec2f84d6c1/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/726d7c123cfd1fb821f38e20a2fbddec2f84d6c1/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=726d7c123cfd1fb821f38e20a2fbddec2f84d6c1",
            "patch": "@@ -220,7 +220,7 @@ jobs:\n               git config user.name \"angular-ci\"\n               git config user.email \"angular-ci\"\n               # Rebase PR on top of target branch.\n-              node tools/rebase-pr.js\n+              node .circleci/rebase-pr.js\n             else\n               echo \"This build is not over a PR, nothing to do.\"\n             fi"
        },
        {
            "sha": "085ab4398dbeaca7c53be5d57ef9efa7a522960d",
            "filename": ".circleci/rebase-pr.js",
            "status": "added",
            "additions": 207,
            "deletions": 0,
            "changes": 207,
            "blob_url": "https://github.com/angular/angular/blob/726d7c123cfd1fb821f38e20a2fbddec2f84d6c1/.circleci%2Frebase-pr.js",
            "raw_url": "https://github.com/angular/angular/raw/726d7c123cfd1fb821f38e20a2fbddec2f84d6c1/.circleci%2Frebase-pr.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Frebase-pr.js?ref=726d7c123cfd1fb821f38e20a2fbddec2f84d6c1",
            "patch": "@@ -0,0 +1,207 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * Rebases the current branch on top of the GitHub PR target branch.\n+ *\n+ * **Context:**\n+ * Since a GitHub PR is not necessarily up to date with its target branch, it is useful to rebase\n+ * prior to testing it on CI to ensure more up to date test results.\n+ *\n+ * **NOTE:**\n+ * This script cannot use external dependencies or be compiled because it needs to run before the\n+ * environment is setup.\n+ * Use only features supported by the NodeJS versions used in the environment.\n+ */\n+// tslint:disable:no-console\n+const {execSync} = require('child_process');\n+\n+\n+/** A regex to select a ref that matches our semver refs. */\n+const semverRegex = /^(\\d+)\\.(\\d+)\\.x$/;\n+\n+// Run\n+_main().catch(err => {\n+  console.log('Failed to rebase on top of target branch.\\n');\n+  console.error(err);\n+  process.exitCode = 1;\n+});\n+\n+// Helpers\n+async function _main() {\n+  const refs = await getRefsAndShasForChange();\n+\n+  // Log known refs and shas\n+  console.log(`--------------------------------`);\n+  console.log(`    Target Branch:                   ${refs.base.ref}`);\n+  console.log(`    Latest Commit for Target Branch: ${refs.target.latestSha}`);\n+  console.log(`    Latest Commit for PR:            ${refs.base.latestSha}`);\n+  console.log(`    First Common Ancestor SHA:       ${refs.commonAncestorSha}`);\n+  console.log(`--------------------------------`);\n+  console.log();\n+\n+  // Get the count of commits between the latest commit from origin and the common ancestor SHA.\n+  const commitCount =\n+      exec(`git rev-list --count origin/${refs.base.ref}...${refs.commonAncestorSha}`);\n+  console.log(`Checking ${commitCount} commits for changes in the CircleCI config file.`);\n+\n+  // Check if the files changed between the latest commit from origin and the common ancestor SHA\n+  // includes the CircleCI config.\n+  const circleCIConfigChanged = exec(`git diff --name-only origin/${refs.base.ref} ${\n+      refs.commonAncestorSha} -- .circleci/config.yml`);\n+\n+  if (!!circleCIConfigChanged) {\n+    throw Error(`\n+        CircleCI config on ${refs.base.ref} has been modified since commit\n+        ${refs.commonAncestorSha.slice(0, 7)}, which this PR is based on.\n+\n+        Please rebase the PR on ${refs.base.ref} after fetching from upstream.\n+\n+        Rebase instructions for PR Author, please run the following commands:\n+\n+          git fetch upstream ${refs.base.ref};\n+          git checkout ${refs.target.ref};\n+          git rebase upstream/${refs.base.ref};\n+          git push --force-with-lease;\n+        `);\n+  } else {\n+    console.log('No change found in the CircleCI config file, continuing.');\n+  }\n+  console.log();\n+\n+  // Rebase the PR.\n+  exec(`git rebase origin/${refs.base.ref}`);\n+  console.log(`Rebased current branch onto ${refs.base.ref}.`);\n+}\n+\n+\n+\n+/**\n+ * Sort a list of fullpath refs into a list and then provide the first entry.\n+ *\n+ * The sort order will first find master ref, and then any semver ref, followed\n+ * by the rest of the refs in the order provided.\n+ *\n+ * Branches are sorted in this order as work is primarily done on master, and\n+ * otherwise on a semver branch. If neither of those were to match, the most\n+ * likely correct branch will be the first one encountered in the list.\n+ */\n+function getRefFromBranchList(gitOutput) {\n+  const branches = gitOutput.split('\\n').map(b => b.split('/').slice(1).join('').trim());\n+  return branches.sort((a, b) => {\n+    if (a === 'master') {\n+      return -1;\n+    }\n+    if (b === 'master') {\n+      return 1;\n+    }\n+    const aIsSemver = semverRegex.test(a);\n+    const bIsSemver = semverRegex.test(b);\n+    if (aIsSemver && bIsSemver) {\n+      const [, aMajor, aMinor] = a.match(semverRegex);\n+      const [, bMajor, bMinor] = b.match(semverRegex);\n+      return parseInt(bMajor, 10) - parseInt(aMajor, 10) ||\n+          parseInt(aMinor, 10) - parseInt(bMinor, 10) || 0;\n+    }\n+    if (aIsSemver) {\n+      return -1;\n+    }\n+    if (bIsSemver) {\n+      return 1;\n+    }\n+    return 0;\n+  })[0];\n+}\n+\n+/**\n+ * Get the full sha of the ref provided.\n+ *\n+ * example: 1bc0c1a6c01ede7168f22fa9b3508ba51f1f464e\n+ */\n+function getShaFromRef(ref) {\n+  return exec(`git rev-parse ${ref}`);\n+}\n+\n+/**\n+ * Get the list of branches which contain the provided sha, sorted in descending order\n+ * by committerdate.\n+ *\n+ * example:\n+ *   upstream/master\n+ *   upstream/9.0.x\n+ *   upstream/test\n+ *   upstream/1.1.x\n+ */\n+function getBranchListForSha(sha, remote) {\n+  return exec(`git branch -r '${remote}/*' --sort=-committerdate --contains ${sha}`);\n+}\n+\n+/** Get the common ancestor sha of the two provided shas. */\n+function getCommonAncestorSha(sha1, sha2) {\n+  return exec(`git merge-base ${sha1} ${sha2}`);\n+}\n+\n+/**\n+ * Adds the remote to git, if it doesn't already exist. Returns a boolean indicating\n+ * whether the remote was added by the command.\n+ */\n+function addAndFetchRemote(owner, name) {\n+  const remoteName = `${owner}_${name}`;\n+  exec(`git remote add ${remoteName} https://github.com/${owner}/${name}.git`, false);\n+  exec(`git fetch ${remoteName}`);\n+  return remoteName;\n+}\n+\n+\n+/** Get the ref and latest shas for the provided sha on a specific remote. */\n+function getRefAndShas(sha, owner, name) {\n+  const remoteName = addAndFetchRemote(owner, name);\n+\n+  // Get the ref on the remote for the sha provided.\n+  const branches = getBranchListForSha(sha, remoteName);\n+  const ref = getRefFromBranchList(branches);\n+\n+  // Get the latest sha on the discovered remote ref.\n+  const latestSha = getShaFromRef(`${remoteName}/${ref}`);\n+\n+  return {remote: remoteName, ref, latestSha, sha};\n+}\n+\n+\n+/** Gets the refs and shas for the base and target of the current environment. */\n+function getRefsAndShasForChange() {\n+  const base = getRefAndShas(\n+      process.env['CI_GIT_BASE_REVISION'], process.env['CI_REPO_OWNER'],\n+      process.env['CI_REPO_NAME']);\n+  const target = getRefAndShas(\n+      process.env['CI_GIT_REVISION'], process.env['CI_PR_USERNAME'], process.env['CI_PR_REPONAME']);\n+  const commonAncestorSha = getCommonAncestorSha(base.sha, target.sha);\n+  return {\n+    base,\n+    target,\n+    commonAncestorSha,\n+  };\n+}\n+\n+\n+/**\n+ * Synchronously executes the command.\n+ *\n+ * Return the trimmed stdout as a string, with an added attribute of the exit code.\n+ */\n+function exec(command, allowStderr = true) {\n+  let output = new String();\n+  output.code = 0;\n+  try {\n+    output += execSync(command, {stdio: ['pipe', 'pipe', 'pipe']}).toString().trim();\n+  } catch (err) {\n+    allowStderr && console.error(err.stderr.toString());\n+    output.code = err.status;\n+  }\n+  return output;\n+}"
        },
        {
            "sha": "fe8cf75f7343b72cad823ad6f1c4402036054d63",
            "filename": "tools/rebase-pr.js",
            "status": "removed",
            "additions": 0,
            "deletions": 102,
            "changes": 102,
            "blob_url": "https://github.com/angular/angular/blob/938abc03bcc69925f88b64245f26df3d597ef7f3/tools%2Frebase-pr.js",
            "raw_url": "https://github.com/angular/angular/raw/938abc03bcc69925f88b64245f26df3d597ef7f3/tools%2Frebase-pr.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Frebase-pr.js?ref=938abc03bcc69925f88b64245f26df3d597ef7f3",
            "patch": "@@ -1,102 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-/**\n- * **Usage:**\n- * ```\n- * node rebase-pr <github-repository> <pull-request-number>\n- * ```\n- * **Example:**\n- * ```\n- * node rebase-pr angular/angular 123\n- * ```\n- *\n- * Rebases the current branch on top of the GitHub PR target branch.\n- *\n- * **Context:**\n- * Since a GitHub PR is not necessarily up to date with its target branch, it is useful to rebase\n- * prior to testing it on CI to ensure more up to date test results.\n- *\n- * **Implementation details:**\n- * This script obtains the base for a GitHub PR via the\n- * [GitHub PR API](https://developer.github.com/v3/pulls/#get-a-single-pull-request), then\n- * fetches that branch, and rebases the current branch on top of it.\n- *\n- * **NOTE:**\n- * This script cannot use external dependencies or be compiled because it needs to run before the\n- * environment is setup.\n- * Use only features supported by the NodeJS versions used in the environment.\n- */\n-\n-// This script uses `console` to print messages to the user.\n-// tslint:disable:no-console\n-\n-// Imports\n-const util = require('util');\n-const child_process = require('child_process');\n-const exec = util.promisify(child_process.exec);\n-const getRefsAndShasForChange = require('./utils/git-get-changeset-refs');\n-\n-\n-// Run\n-_main().catch(err => {\n-  console.log('Failed to rebase on top of target branch.\\n');\n-  console.error(err);\n-  process.exitCode = 1;\n-});\n-\n-// Helpers\n-async function _main() {\n-  const refs = await getRefsAndShasForChange();\n-\n-  // Log known refs and shas\n-  console.log(`--------------------------------`);\n-  console.log(`    Target Branch:                   ${refs.base.ref}`);\n-  console.log(`    Latest Commit for Target Branch: ${refs.target.latestSha}`);\n-  console.log(`    Latest Commit for PR:            ${refs.base.latestSha}`);\n-  console.log(`    First Common Ancestor SHA:       ${refs.commonAncestorSha}`);\n-  console.log(`--------------------------------`);\n-  console.log();\n-\n-\n-\n-  // Get the count of commits between the latest commit from origin and the common ancestor SHA.\n-  const {stdout: commitCount} =\n-      await exec(`git rev-list --count origin/${refs.base.ref}...${refs.commonAncestorSha}`);\n-  console.log(`Checking ${commitCount.trim()} commits for changes in the CircleCI config file.`);\n-\n-  // Check if the files changed between the latest commit from origin and the common ancestor SHA\n-  // includes the CircleCI config.\n-  const {stdout: circleCIConfigChanged} = await exec(`git diff --name-only origin/${\n-      refs.base.ref} ${refs.commonAncestorSha} -- .circleci/config.yml`);\n-\n-  if (!!circleCIConfigChanged) {\n-    throw Error(`\n-        CircleCI config on ${refs.base.ref} has been modified since commit ${\n-        refs.commonAncestorSha.slice(0, 7)},\n-        which this PR is based on.\n-\n-        Please rebase the PR on ${refs.base.ref} after fetching from upstream.\n-\n-        Rebase instructions for PR Author, please run the following commands:\n-\n-          git fetch upstream ${refs.base.ref};\n-          git checkout ${refs.target.ref};\n-          git rebase upstream/${refs.base.ref};\n-          git push --force-with-lease;\n-        `);\n-  } else {\n-    console.log('No change found in the CircleCI config file, continuing.');\n-  }\n-  console.log();\n-\n-  // Rebase the PR.\n-  console.log(`Rebasing current branch on ${refs.base.ref}.`);\n-  await exec(`git rebase origin/${refs.base.ref}`);\n-  console.log('Rebase successful.');\n-}"
        },
        {
            "sha": "a72e5fd798adf7b616bd56a11d19efc071219b5c",
            "filename": "tools/utils/git-get-changeset-refs.js",
            "status": "removed",
            "additions": 0,
            "deletions": 181,
            "changes": 181,
            "blob_url": "https://github.com/angular/angular/blob/938abc03bcc69925f88b64245f26df3d597ef7f3/tools%2Futils%2Fgit-get-changeset-refs.js",
            "raw_url": "https://github.com/angular/angular/raw/938abc03bcc69925f88b64245f26df3d597ef7f3/tools%2Futils%2Fgit-get-changeset-refs.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Futils%2Fgit-get-changeset-refs.js?ref=938abc03bcc69925f88b64245f26df3d597ef7f3",
            "patch": "@@ -1,181 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-const {execSync} = require('child_process');\n-\n-/** A regex to select a ref that matches our semver refs. */\n-const semverRegex = /^(\\d+)\\.(\\d+)\\.x$/;\n-\n-/**\n- * Synchronously executes the command.\n- *\n- * Return the trimmed stdout as a string, with an added attribute of the exit code.\n- */\n-function exec(command, allowStderr = true) {\n-  let output = new String();\n-  output.code = 0;\n-  try {\n-    output += execSync(command, {stdio: ['pipe', 'pipe', 'pipe']}).toString().trim();\n-  } catch (err) {\n-    allowStderr && console.error(err.stderr.toString());\n-    output.code = err.status;\n-  }\n-  return output;\n-}\n-\n-/**\n- * Sort a list of fullpath refs into a list and then provide the first entry.\n- *\n- * The sort order will first find master ref, and then any semver ref, followed\n- * by the rest of the refs in the order provided.\n- *\n- * Branches are sorted in this order as work is primarily done on master, and\n- * otherwise on a semver branch. If neither of those were to match, the most\n- * likely correct branch will be the first one encountered in the list.\n- */\n-function getRefFromBranchList(gitOutput, remote) {\n-  const branches = gitOutput.split('\\n').map(b => b.split('/').slice(1).join('').trim());\n-  return branches.sort((a, b) => {\n-    if (a === 'master') {\n-      return -1;\n-    }\n-    if (b === 'master') {\n-      return 1;\n-    }\n-    const aIsSemver = semverRegex.test(a);\n-    const bIsSemver = semverRegex.test(b);\n-    if (aIsSemver && bIsSemver) {\n-      const [, aMajor, aMinor] = a.match(semverRegex);\n-      const [, bMajor, bMinor] = b.match(semverRegex);\n-      return parseInt(bMajor, 10) - parseInt(aMajor, 10) ||\n-          parseInt(aMinor, 10) - parseInt(bMinor, 10) || 0;\n-    }\n-    if (aIsSemver) {\n-      return -1;\n-    }\n-    if (bIsSemver) {\n-      return 1;\n-    }\n-    return 0;\n-  })[0];\n-}\n-\n-/**\n- * Get the full sha of the ref provided.\n- *\n- * example: 1bc0c1a6c01ede7168f22fa9b3508ba51f1f464e\n- */\n-function getShaFromRef(ref) {\n-  return exec(`git rev-parse ${ref}`);\n-}\n-\n-/**\n- * Get the list of branches which contain the provided sha, sorted in descending order\n- * by committerdate.\n- *\n- * example:\n- *   upstream/master\n- *   upstream/9.0.x\n- *   upstream/test\n- *   upstream/1.1.x\n- */\n-function getBranchListForSha(sha, remote) {\n-  return exec(`git branch -r '${remote}/*' --sort=-committerdate --contains ${sha}`);\n-}\n-\n-/** Get the common ancestor sha of the two provided shas. */\n-function getCommonAncestorSha(sha1, sha2) {\n-  return exec(`git merge-base ${sha1} ${sha2}`);\n-}\n-\n-/** Removes the remote from git. */\n-function removeRemote(remote) {\n-  exec(`git remote remove ${remote}`);\n-}\n-\n-/**\n- * Adds the remote to git, if it doesn't already exist. Returns a boolean indicating\n- * whether the remote was added by the command.\n- */\n-function addRemote(remote) {\n-  return !exec(`git remote add ${remote} https://github.com/${remote}/angular.git`, false).code;\n-}\n-\n-/** Fetch latest from the remote. */\n-function fetchRemote(remote) {\n-  exec(`git fetch ${remote}`);\n-}\n-\n-/**\n- * Get the nearest ref which the HEAD has a parent commit.\n- *\n- * Checks up to a limit of 100 previous shas.\n- */\n-function getParentBranchForHead(remote) {\n-  // Get the latest for the remote.\n-  fetchRemote(remote);\n-\n-  let headCount = 0;\n-  while (headCount < 100) {\n-    // Attempt to get the ref on the remote for the sha.\n-    const branches = getBranchListForSha(`HEAD~${headCount}`, remote);\n-    const ref = getRefFromBranchList(branches, remote);\n-    // If the ref exists, get the sha and latest sha for the remote ref.\n-    if (ref) {\n-      const sha = getShaFromRef(`HEAD~${headCount}`);\n-      const latestSha = getShaFromRef(`${remote}/${ref}`);\n-      return {ref, sha, latestSha, remote};\n-    }\n-    headCount++;\n-  }\n-  return {ref: '', latestSha: '', sha, remote};\n-}\n-\n-/** Get the ref and latest shas for the provided sha on a specific remote. */\n-function getRefAndShas(sha, remote) {\n-  // Ensure the remote is defined in git.\n-  let markRemoteForClean = addRemote(remote);\n-  // Get the latest from the remote.\n-  fetchRemote(remote);\n-\n-  // Get the ref on the remote for the sha provided.\n-  const branches = getBranchListForSha(sha, remote);\n-  const ref = getRefFromBranchList(branches, remote);\n-\n-  // Get the latest sha on the discovered remote ref.\n-  const latestSha = getShaFromRef(`${remote}/${ref}`);\n-\n-  // Clean up the remote if it didn't exist before execution.\n-  if (markRemoteForClean) {\n-    removeRemote(remote);\n-  }\n-\n-  return {remote, ref, latestSha, sha};\n-}\n-\n-\n-/** Gets the refs and shas for the base and target of the current environment. */\n-function getRefsAndShasForChange() {\n-  let base, target;\n-  if (process.env['CI']) {\n-    base = getRefAndShas(process.env['CI_GIT_BASE_REVISION'], process.env['CI_REPO_OWNER']);\n-    target = getRefAndShas(process.env['CI_GIT_REVISION'], process.env['CI_PR_USERNAME']);\n-  } else {\n-    const originSha = getShaFromRef(`HEAD`);\n-    target = getRefAndShas(originSha, 'origin');\n-    base = getParentBranchForHead('upstream');\n-  }\n-  const commonAncestorSha = getCommonAncestorSha(base.sha, target.sha);\n-  return {\n-    base,\n-    target,\n-    commonAncestorSha,\n-  };\n-}\n-\n-module.exports = getRefsAndShasForChange;"
        }
    ],
    "stats": {
        "total": 492,
        "additions": 208,
        "deletions": 284
    }
}