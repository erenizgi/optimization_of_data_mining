{
    "author": "petebacondarwin",
    "message": "build(docs-infra): capture all decorators in doc-gen (#41091)\n\nIn 6cff877 we broke the decorator docs because the\ndoc-gen no longer knew how to identify them.\n\nThis commit updates the dgeni processor responsible\nfor identifying the decorators in the code and ensures\nthat the docs are now generated correctly.\n\nFixes #40851\n\nPR Close #41091",
    "sha": "2893b925c3efc2226efd4bf4b8328de2c1dc1876",
    "files": [
        {
            "sha": "3ee25a8cb01de1c79ef43e8294387d1bbb066b2b",
            "filename": "aio/tools/transforms/angular-api-package/processors/mergeDecoratorDocs.js",
            "status": "modified",
            "additions": 39,
            "deletions": 13,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/2893b925c3efc2226efd4bf4b8328de2c1dc1876/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeDecoratorDocs.js",
            "raw_url": "https://github.com/angular/angular/raw/2893b925c3efc2226efd4bf4b8328de2c1dc1876/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeDecoratorDocs.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeDecoratorDocs.js?ref=2893b925c3efc2226efd4bf4b8328de2c1dc1876",
            "patch": "@@ -56,7 +56,6 @@ module.exports = function mergeDecoratorDocs(log) {\n       {type: 'Param', description: 'parameter', functionName: 'makeParamDecorator'},\n     ],\n     $process(docs) {\n-\n       const decoratorDocs = Object.create(null);\n \n       // find all the decorators, signified by a call to `make...Decorator<Decorator>(metadata)`\n@@ -69,7 +68,8 @@ module.exports = function mergeDecoratorDocs(log) {\n               // For example the `X` of `createDecorator<X>(...)`.\n               const decoratorType = initializer.arguments[0].text;\n \n-              log.debug('mergeDecoratorDocs: found decorator', doc.docType, doc.name, decoratorType);\n+              log.debug(\n+                  'mergeDecoratorDocs: found decorator', doc.docType, doc.name, decoratorType);\n \n               doc.docType = 'decorator';\n               doc.decoratorLocation = call.description;\n@@ -84,8 +84,8 @@ module.exports = function mergeDecoratorDocs(log) {\n       // merge the info from the associated metadata interfaces into the decorator docs\n       docs = docs.filter(doc => {\n         if (decoratorDocs[doc.name]) {\n-\n-          // We have found an `XxxDecorator` document that will hold the call signature of the decorator\n+          // We have found an `XxxDecorator` document that will hold the call signature of the\n+          // decorator\n           var decoratorDoc = decoratorDocs[doc.name];\n           var callMember = doc.members.find(member => member.isCallMember);\n \n@@ -109,18 +109,44 @@ module.exports = function mergeDecoratorDocs(log) {\n };\n \n function getInitializer(doc) {\n-  var initializer = doc.symbol && doc.symbol.valueDeclaration && doc.symbol.valueDeclaration.initializer;\n+  const declaration = doc.symbol && doc.symbol.valueDeclaration;\n+  if (!declaration || !declaration.initializer || !declaration.initializer.expression) {\n+    return;\n+  }\n+\n+  let initializer = declaration.initializer;\n+\n   // There appear to be two forms of initializer:\n-  //    export var Injectable: InjectableFactory =\n-  //    <InjectableFactory>makeDecorator(InjectableMetadata);\n+  //\n+  // ```\n+  // export const Injectable: InjectableFactory =\n+  //       <InjectableFactory>makeDecorator(InjectableMetadata);\n+  // ```\n+  //\n   // and\n-  //    export var RouteConfig: (configs: RouteDefinition[]) => ClassDecorator =\n-  //    makeDecorator(RouteConfigAnnotation);\n-  // In the first case, the type assertion `<InjectableFactory>` causes the AST to contain an\n-  // extra level of expression\n-  // to hold the new type of the expression.\n-  if (initializer && initializer.expression && initializer.expression.expression) {\n+  //\n+  // ```\n+  // export const RouteConfig: (configs: RouteDefinition[]) => ClassDecorator =\n+  //       makeDecorator(RouteConfigAnnotation);\n+  // ```\n+  //\n+  // In the first case, the type assertion `<InjectableFactory>` causes the AST to contain an extra\n+  // level of expression to hold the new type of the expression.\n+  if (initializer.type && initializer.expression.expression) {\n     initializer = initializer.expression;\n   }\n+\n+  // It is also possible that the decorator call is wrapped in a call to `attachInjectFlag()`:\n+  //\n+  // ```\n+  // const Optional: OptionalDecorator =\n+  //       attachInjectFlag(makeParamDecorator('Optional'), InternalInjectFlags.Optional);\n+  // ```\n+  //\n+  // If so, use the first argument of the call.\n+  if (initializer.arguments && initializer.expression.text === 'attachInjectFlag') {\n+    initializer = initializer.arguments[0];\n+  }\n+\n   return initializer;\n }"
        },
        {
            "sha": "9940fb9d9eafe6cbfcbded64353ab9c85a7d62a8",
            "filename": "aio/tools/transforms/angular-api-package/processors/mergeDecoratorDocs.spec.js",
            "status": "modified",
            "additions": 33,
            "deletions": 15,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/2893b925c3efc2226efd4bf4b8328de2c1dc1876/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeDecoratorDocs.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/2893b925c3efc2226efd4bf4b8328de2c1dc1876/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeDecoratorDocs.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FmergeDecoratorDocs.spec.js?ref=2893b925c3efc2226efd4bf4b8328de2c1dc1876",
            "patch": "@@ -1,5 +1,5 @@\n-var testPackage = require('../../helpers/test-package');\n-var Dgeni = require('dgeni');\n+const testPackage = require('../../helpers/test-package');\n+const Dgeni = require('dgeni');\n \n describe('mergeDecoratorDocs processor', () => {\n   let processor, moduleDoc, decoratorDoc, metadataDoc, otherDoc;\n@@ -20,11 +20,10 @@ describe('mergeDecoratorDocs processor', () => {\n       shortDescription: 'decorator - short description',\n       description: 'decorator - description',\n       symbol: {\n-        valueDeclaration: { initializer: { expression: { text: 'makeDecorator' }, arguments: [{ text: 'X' }] } }\n+        valueDeclaration:\n+            {initializer: {expression: {text: 'makeDecorator'}, arguments: [{text: 'X'}]}}\n       },\n-      members: [\n-        { name: 'templateUrl', description: 'templateUrl - description' }\n-      ],\n+      members: [{name: 'templateUrl', description: 'templateUrl - description'}],\n       moduleDoc\n     };\n \n@@ -38,9 +37,7 @@ describe('mergeDecoratorDocs processor', () => {\n           description: 'call interface - call member - description',\n           usageNotes: 'call interface - call member - usageNotes',\n         },\n-        {\n-          description: 'call interface - non call member - description'\n-        }\n+        {description: 'call interface - non call member - description'}\n       ],\n       moduleDoc\n     };\n@@ -49,7 +46,8 @@ describe('mergeDecoratorDocs processor', () => {\n       name: 'Y',\n       docType: 'const',\n       symbol: {\n-        valueDeclaration: { initializer: { expression: { text: 'otherCall' }, arguments: [{ text: 'param1' }] } }\n+        valueDeclaration:\n+            {initializer: {expression: {text: 'otherCall'}, arguments: [{text: 'param1'}]}}\n       },\n       moduleDoc\n     };\n@@ -58,11 +56,12 @@ describe('mergeDecoratorDocs processor', () => {\n   });\n \n \n-  it('should change the docType of only the docs that are initialized by a call to makeDecorator', () => {\n-    processor.$process([decoratorDoc, metadataDoc, otherDoc]);\n-    expect(decoratorDoc.docType).toEqual('decorator');\n-    expect(otherDoc.docType).toEqual('const');\n-  });\n+  it('should change the docType of only the docs that are initialized by a call to makeDecorator',\n+     () => {\n+       processor.$process([decoratorDoc, metadataDoc, otherDoc]);\n+       expect(decoratorDoc.docType).toEqual('decorator');\n+       expect(otherDoc.docType).toEqual('const');\n+     });\n \n   it('should extract the \"type\" of the decorator meta data', () => {\n     processor.$process([decoratorDoc, metadataDoc, otherDoc]);\n@@ -88,4 +87,23 @@ describe('mergeDecoratorDocs processor', () => {\n     processor.$process([decoratorDoc, metadataDoc, otherDoc]);\n     expect(decoratorDoc.docType).toEqual('decorator');\n   });\n+\n+  it('should handle a type cast before the \"make decorator\" call', () => {\n+    decoratorDoc.symbol.valueDeclaration.initializer = {\n+      expression: decoratorDoc.symbol.valueDeclaration.initializer,\n+      type: {},\n+    };\n+    processor.$process([decoratorDoc, metadataDoc, otherDoc]);\n+    expect(decoratorDoc.docType).toEqual('decorator');\n+  });\n+\n+  it('should handle the \"make decorator\" call being wrapped in a call to `attachInjectFlag()`',\n+     () => {\n+       decoratorDoc.symbol.valueDeclaration.initializer = {\n+         expression: {text: 'attachInjectFlag'},\n+         arguments: [decoratorDoc.symbol.valueDeclaration.initializer]\n+       };\n+       processor.$process([decoratorDoc, metadataDoc, otherDoc]);\n+       expect(decoratorDoc.docType).toEqual('decorator');\n+     });\n });"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 72,
        "deletions": 28
    }
}