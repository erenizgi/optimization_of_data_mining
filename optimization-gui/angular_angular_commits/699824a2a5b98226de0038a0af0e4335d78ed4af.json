{
    "author": "gkalpak",
    "message": "refactor(docs-infra): break up `deploy-to-firebase.js` script into functions (#39470)\n\nThis commit breaks up the code in `deploy-to-firebase.js` script, that\nwe use for deploying angular.io to production, to smaller functions\n(instead of a monolithic block). This makes the script easier to\nmaintain and also makes testing individual operations easier.\n\nThe commit also updates the `deploy-to-firebase.spec.js` spec file to\ntake advantage of the standalone functions to speed up testing by\ncalling the corresponding function instead of having to spawn a new\nprocess and run the `deploy-to-firebase.js` script with the `--dry-run`\nflag.\n\nNOTE: Before updating the tests, I verified that the updated\n      `deploy-to-firebase.js` script passed the old tests.\n\nPR Close #39470",
    "sha": "699824a2a5b98226de0038a0af0e4335d78ed4af",
    "files": [
        {
            "sha": "973987cbf56b70964bfb6cef4f0439bc4b55a566",
            "filename": "aio/scripts/deploy-to-firebase.js",
            "status": "modified",
            "additions": 168,
            "deletions": 131,
            "changes": 299,
            "blob_url": "https://github.com/angular/angular/blob/699824a2a5b98226de0038a0af0e4335d78ed4af/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "raw_url": "https://github.com/angular/angular/raw/699824a2a5b98226de0038a0af0e4335d78ed4af/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.js?ref=699824a2a5b98226de0038a0af0e4335d78ed4af",
            "patch": "@@ -9,165 +9,202 @@ const {cd, cp, exec: _exec, set} = require('shelljs');\n set('-e');\n \n \n-// Arguments, environment variables and constants.\n-const args = process.argv.slice(2);\n-const dryRun = args[0] === '--dry-run';\n-\n-const {\n-  CI_AIO_MIN_PWA_SCORE,\n-  CI_BRANCH,\n-  CI_COMMIT,\n-  CI_PULL_REQUEST,\n-  CI_REPO_NAME,\n-  CI_REPO_OWNER,\n-  CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN,\n-  CI_STABLE_BRANCH,\n-} = process.env;\n-\n+// Constants\n const REPO_SLUG = 'angular/angular';\n const NG_REMOTE_URL = `https://github.com/${REPO_SLUG}.git`;\n \n-// Do not deploy if we are running in a fork.\n-if (`${CI_REPO_OWNER}/${CI_REPO_NAME}` !== REPO_SLUG) {\n-  console.log(`Skipping deploy because this is not ${REPO_SLUG}.`);\n-  process.exit(0);\n-}\n+// Exports\n+module.exports = {\n+  computeDeploymentInfo,\n+  computeInputVars,\n+  getLatestCommit,\n+};\n \n-// Do not deploy if this is a PR. PRs are deployed in the `aio_preview` CircleCI job.\n-if (CI_PULL_REQUEST !== 'false') {\n-  console.log('Skipping deploy because this is a PR build.');\n-  process.exit(0);\n-}\n+// Run\n+if (require.main === module) {\n+  const isDryRun = process.argv[2] === '--dry-run';\n+  const inputVars = computeInputVars(process.env);\n+  const deploymentInfo = computeDeploymentInfo(inputVars);\n \n-// Do not deploy if the current commit is not the latest on its branch.\n-const latestCommit = exec(`git ls-remote ${NG_REMOTE_URL} ${CI_BRANCH}`).slice(0, 40);\n-if (CI_COMMIT !== latestCommit) {\n-  console.log(`Skipping deploy because ${CI_COMMIT} is not the latest commit (${latestCommit}).`);\n-  process.exit(0);\n+  if (deploymentInfo.skipped) {\n+    console.log(deploymentInfo.reason);\n+  } else {\n+    console.log(\n+        `Git branch        : ${currentBranch}\\n` +\n+        `Build/deploy mode : ${deploymentInfo.deployEnv}\\n` +\n+        `Firebase project  : ${deploymentInfo.projectId}\\n` +\n+        `Firebase site     : ${deploymentInfo.siteId}\\n` +\n+        `Deployment URLs   : ${deploymentInfo.deployedUrl}\\n`);\n+\n+    if (!isDryRun) {\n+      deploy({...inputVars, ...deploymentInfo});\n+    }\n+  }\n }\n \n-// The deployment mode is computed based on the branch we are building.\n-const currentBranchMajorVersion = computeMajorVersion(CI_BRANCH);\n-// Special-case v9, because it is piloting the Firebase hosting \"multisites\" setup.\n-// See https://angular-team.atlassian.net/browse/DEV-125 for more info.\n-const isV9 = currentBranchMajorVersion === 9;\n-const deployInfoPerTarget = {\n-  next: {\n-    deployEnv: 'next',\n-    projectId: 'aio-staging',\n-    siteId: 'aio-staging',\n-    deployedUrl: 'https://next.angular.io/',\n-  },\n-  rc: {\n-    deployEnv: 'rc',\n-    projectId: 'angular-io',\n-    siteId: 'rc-angular-io-site',\n-    deployedUrl: 'https://rc.angular.io/',\n-  },\n-  stable: {\n-    deployEnv: 'stable',\n-    projectId: 'angular-io',\n-    siteId: 'angular-io',\n-    deployedUrl: 'https://angular.io/',\n-  },\n-  archive: {\n-    deployEnv: 'archive',\n-    projectId: isV9 ? 'aio-staging' : `v${currentBranchMajorVersion}-angular-io`,\n-    siteId: isV9 ? 'v9-angular-io' : `v${currentBranchMajorVersion}-angular-io`,\n-    deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n-  },\n-};\n-let deployInfo = null;\n-\n-if (CI_BRANCH === 'master') {\n-  deployInfo = deployInfoPerTarget.next;\n-} else if (CI_BRANCH === CI_STABLE_BRANCH) {\n-  deployInfo = deployInfoPerTarget.stable;\n-} else {\n-  const stableBranchMajorVersion = computeMajorVersion(CI_STABLE_BRANCH);\n-\n-  // Find the branch that has highest minor version for the given `currentBranchMajorVersion`.\n-  const mostRecentMinorVersionBranch =\n-    // List the branches that start with the major version.\n-    exec(`git ls-remote ${NG_REMOTE_URL} refs/heads/${currentBranchMajorVersion}.*.x`).split('\\n')\n-        // Extract the version number.\n-        .map(line => line.split('/')[2])\n-        // Sort by the minor version.\n-        .sort((a, b) => a.split('.')[1] - b.split('.')[1])\n-        // Get the highest version.\n-        .pop();\n-\n-  // Do not deploy if it is not the latest branch for the given major version.\n-  // NOTE: At this point, we know the current branch is not the stable branch.\n-  if (CI_BRANCH !== mostRecentMinorVersionBranch) {\n-    console.log(\n-        `Skipping deploy of branch \"${CI_BRANCH}\" to Firebase.\\n` +\n-        'There is a more recent branch with the same major version: ' +\n-        `\"${mostRecentMinorVersionBranch}\"`);\n-    process.exit(0);\n+// Helpers\n+function computeDeploymentInfo(\n+    {currentBranch, currentCommit, isPullRequest, repoName, repoOwner, stableBranch}) {\n+  // Do not deploy if we are running in a fork.\n+  if (`${repoOwner}/${repoName}` !== REPO_SLUG) {\n+    return skipDeployment(`Skipping deploy because this is not ${REPO_SLUG}.`);\n   }\n \n-  deployInfo = (currentBranchMajorVersion < stableBranchMajorVersion) ?\n-      // This is the latest minor version for a major that is less than the stable major version:\n-      // Deploy as `archive`.\n-      deployInfoPerTarget.archive :\n-      // This is the latest minor version for a major that is equal or greater than the stable major\n-      // version, but not the stable version itself:\n-      // Deploy as `rc`.\n-      deployInfoPerTarget.rc;\n-}\n+  // Do not deploy if this is a PR. PRs are deployed in the `aio_preview` CircleCI job.\n+  if (isPullRequest) {\n+    return skipDeployment('Skipping deploy because this is a PR build.');\n+  }\n \n-const {deployEnv, projectId, siteId, deployedUrl} = deployInfo;\n-console.log(\n-    `Git branch        : ${CI_BRANCH}\\n` +\n-    `Build/deploy mode : ${deployEnv}\\n` +\n-    `Firebase project  : ${projectId}\\n` +\n-    `Firebase site     : ${siteId}\\n` +\n-    `Deployment URL    : ${deployedUrl}\\n`);\n+  // Do not deploy if the current commit is not the latest on its branch.\n+  const latestCommit = getLatestCommit(currentBranch);\n+  if (currentCommit !== latestCommit) {\n+    return skipDeployment(\n+        `Skipping deploy because ${currentCommit} is not the latest commit (${latestCommit}).`);\n+  }\n \n-if (dryRun) {\n-  process.exit(0);\n-}\n+  // The deployment mode is computed based on the branch we are building.\n+  const currentBranchMajorVersion = computeMajorVersion(currentBranch);\n+  // Special-case v9, because it is piloting the Firebase hosting \"multisites\" setup.\n+  // See https://angular-team.atlassian.net/browse/DEV-125 for more info.\n+  const isV9 = currentBranchMajorVersion === 9;\n+  const deploymentInfoPerTarget = {\n+    next: {\n+      deployEnv: 'next',\n+      projectId: 'aio-staging',\n+      siteId: 'aio-staging',\n+      deployedUrl: 'https://next.angular.io/',\n+    },\n+    rc: {\n+      deployEnv: 'rc',\n+      projectId: 'angular-io',\n+      siteId: 'rc-angular-io-site',\n+      deployedUrl: 'https://rc.angular.io/',\n+    },\n+    stable: {\n+      deployEnv: 'stable',\n+      projectId: 'angular-io',\n+      siteId: 'angular-io',\n+      deployedUrl: 'https://angular.io/',\n+    },\n+    archive: {\n+      deployEnv: 'archive',\n+      projectId: isV9 ? 'aio-staging' : `v${currentBranchMajorVersion}-angular-io`,\n+      siteId: isV9 ? 'v9-angular-io' : `v${currentBranchMajorVersion}-angular-io`,\n+      deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n+    },\n+  };\n+\n+  if (currentBranch === 'master') {\n+    return deploymentInfoPerTarget.next;\n+  } else if (currentBranch === stableBranch) {\n+    return deploymentInfoPerTarget.stable;\n+  } else {\n+    const stableBranchMajorVersion = computeMajorVersion(stableBranch);\n+\n+    // Find the branch that has highest minor version for the given `currentBranchMajorVersion`.\n+    const mostRecentMinorVersionBranch =\n+      // List the branches that start with the major version.\n+      getRemoteRefs(`refs/heads/${currentBranchMajorVersion}.*.x`)\n+          // Extract the version number.\n+          .map(line => line.split('/')[2])\n+          // Sort by the minor version.\n+          .sort((a, b) => a.split('.')[1] - b.split('.')[1])\n+          // Get the highest version.\n+          .pop();\n+\n+    // Do not deploy if it is not the latest branch for the given major version.\n+    // NOTE: At this point, we know the current branch is not the stable branch.\n+    if (currentBranch !== mostRecentMinorVersionBranch) {\n+      return skipDeployment(\n+          `Skipping deploy of branch \"${currentBranch}\" to Firebase.\\n` +\n+          'There is a more recent branch with the same major version: ' +\n+          `\"${mostRecentMinorVersionBranch}\"`);\n+    }\n+\n+    return (currentBranchMajorVersion < stableBranchMajorVersion) ?\n+        // This is the latest minor version for a major that is less than the stable major version:\n+        // Deploy as `archive`.\n+        deploymentInfoPerTarget.archive :\n+        // This is the latest minor version for a major that is equal or greater than the stable\n+        // major version, but not the stable version itself:\n+        // Deploy as `rc`.\n+        deploymentInfoPerTarget.rc;\n+  }\n \n-// Deploy\n-cd(`${__dirname}/..`);\n+  // We should never get here.\n+  throw new Error('Failed to determine deployment info.');\n+}\n \n-console.log('\\n\\n\\n==== Build the AIO app. ====\\n');\n-yarn(`build --configuration=${deployEnv} --progress=false`);\n+function computeInputVars({\n+  CI_AIO_MIN_PWA_SCORE: minPwaScore,\n+  CI_BRANCH: currentBranch,\n+  CI_COMMIT: currentCommit,\n+  CI_PULL_REQUEST,\n+  CI_REPO_NAME: repoName,\n+  CI_REPO_OWNER: repoOwner,\n+  CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: firebaseToken,\n+  CI_STABLE_BRANCH: stableBranch,\n+}) {\n+  return {\n+    currentBranch,\n+    currentCommit,\n+    firebaseToken,\n+    isPullRequest: CI_PULL_REQUEST !== 'false',\n+    minPwaScore,\n+    repoName,\n+    repoOwner,\n+    stableBranch,\n+  };\n+}\n \n-console.log('\\n\\n\\n==== Add any mode-specific files into the AIO distribution. ====\\n');\n-cp('-rf', `src/extra-files/${deployEnv}/.`, 'dist/');\n+function computeMajorVersion(branchName) {\n+  return +branchName.split('.', 1)[0];\n+}\n \n+function deploy(\n+    {currentCommit, deployedUrl, deployEnv, firebaseToken, minPwaScore, projectId, siteId}) {\n+  cd(`${__dirname}/..`);\n \n-console.log('\\n\\n\\n==== Update opensearch descriptor for AIO with `deployedUrl`. ====\\n');\n-yarn(`set-opensearch-url ${deployedUrl.replace(/[^/]$/, '$&/')}`);  // The URL must end with `/`.\n+  console.log('\\n\\n\\n==== Build the AIO app. ====\\n');\n+  yarn(`build --configuration=${deployEnv} --progress=false`);\n \n-console.log('\\n\\n\\n==== Check payload size and upload the numbers to Firebase DB. ====\\n');\n-yarn('payload-size');\n+  console.log('\\n\\n\\n==== Add any mode-specific files into the AIO distribution. ====\\n');\n+  cp('-rf', `src/extra-files/${deployEnv}/.`, 'dist/');\n \n-console.log('\\n\\n\\n==== Deploy AIO to Firebase hosting. ====\\n');\n-yarn(`firebase use \"${projectId}\" --token \"${CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN}\"`);\n-yarn(\n-    `firebase target:apply hosting aio \"${siteId}\" --token ` +\n-    `\"${CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN}\"`);\n-yarn(\n-    `firebase deploy --only hosting:aio --message \"Commit: ${CI_COMMIT}\" --non-interactive ` +\n-    `--token ${CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN}`);\n+  console.log('\\n\\n\\n==== Update opensearch descriptor for AIO with `deployedUrl`. ====\\n');\n+  yarn(`set-opensearch-url ${deployedUrl.replace(/[^/]$/, '$&/')}`);  // The URL must end with `/`.\n \n-console.log('\\n\\n\\n==== Run PWA-score tests. ====\\n');\n-yarn(`test-pwa-score \"${deployedUrl}\" \"${CI_AIO_MIN_PWA_SCORE}\"`);\n+  console.log('\\n\\n\\n==== Check payload size and upload the numbers to Firebase DB. ====\\n');\n+  yarn('payload-size');\n \n+  console.log('\\n\\n\\n==== Deploy AIO to Firebase hosting. ====\\n');\n+  yarn(`firebase use \"${projectId}\" --token \"${firebaseToken}\"`);\n+  yarn(`firebase target:apply hosting aio \"${siteId}\" --token \"${firebaseToken}\"`);\n+  yarn(\n+      `firebase deploy --only hosting:aio --message \"Commit: ${currentCommit}\" --non-interactive ` +\n+      `--token \"${firebaseToken}\"`);\n \n-// Helpers\n-function computeMajorVersion(branchName) {\n-  return +branchName.split('.', 1)[0];\n+  console.log('\\n\\n\\n==== Run PWA-score tests. ====\\n');\n+  yarn(`test-pwa-score \"${deployedUrl}\" \"${minPwaScore}\"`);\n }\n \n function exec(cmd, opts) {\n   // Using `silent: true` to ensure no secret env variables are printed.\n   return _exec(cmd, {silent: true, ...opts}).trim();\n }\n \n+function getRemoteRefs(refOrPattern, remote = NG_REMOTE_URL) {\n+  return exec(`git ls-remote ${remote} ${refOrPattern}`).split('\\n');\n+}\n+\n+function getLatestCommit(branchName, remote = undefined) {\n+  return getRemoteRefs(branchName, remote)[0].slice(0, 40);\n+}\n+\n+function skipDeployment(reason) {\n+  return {reason, skipped: true};\n+}\n+\n function yarn(cmd) {\n   // Using `--silent` to ensure no secret env variables are printed.\n   return exec(`yarn --silent ${cmd}`);"
        },
        {
            "sha": "6889a30d7d5ce84f246342cdf4ca1d69cf18ac70",
            "filename": "aio/scripts/deploy-to-firebase.spec.js",
            "status": "modified",
            "additions": 124,
            "deletions": 112,
            "changes": 236,
            "blob_url": "https://github.com/angular/angular/blob/699824a2a5b98226de0038a0af0e4335d78ed4af/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/699824a2a5b98226de0038a0af0e4335d78ed4af/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.spec.js?ref=699824a2a5b98226de0038a0af0e4335d78ed4af",
            "patch": "@@ -1,248 +1,260 @@\n #!/usr/bin/env node\n 'use strict';\n \n-const {execSync} = require('child_process');\n+const {computeDeploymentInfo, computeInputVars, getLatestCommit} = require('./deploy-to-firebase');\n \n \n describe('deploy-to-firebase:', () => {\n-  const deployToFirebaseCmd = `\"${process.execPath}\" \"${__dirname}/deploy-to-firebase\" --dry-run`;\n-  const ngRemoteUrl = 'https://github.com/angular/angular.git';\n-\n-  // Helpers\n-  const deployToFirebaseDryRun =\n-      env => execSync(deployToFirebaseCmd, {encoding: 'utf8', env}).toString().trim();\n-  const getLatestCommitForBranch =\n-      branch => execSync(`git ls-remote ${ngRemoteUrl} ${branch}`).slice(0, 40);\n-\n   it('master - skip deploy - not angular', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'notangular',\n-    })).toBe('Skipping deploy because this is not angular/angular.');\n+    }))).toEqual({\n+      skipped: true,\n+      reason: 'Skipping deploy because this is not angular/angular.',\n+    });\n   });\n \n   it('master - skip deploy - angular fork', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'notangular',\n       CI_REPO_NAME: 'angular',\n-    })).toBe('Skipping deploy because this is not angular/angular.');\n+    }))).toEqual({\n+      skipped: true,\n+      reason: 'Skipping deploy because this is not angular/angular.',\n+    });\n   });\n \n   it('master - skip deploy - pull request', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'true',\n-    })).toBe('Skipping deploy because this is a PR build.');\n+    }))).toEqual({\n+      skipped: true,\n+      reason: 'Skipping deploy because this is a PR build.',\n+    });\n   });\n \n   it('master - deploy success', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: 'master',\n-      CI_COMMIT: getLatestCommitForBranch('master'),\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Git branch        : master\\n' +\n-        'Build/deploy mode : next\\n' +\n-        'Firebase project  : aio-staging\\n' +\n-        'Firebase site     : aio-staging\\n' +\n-        'Deployment URL    : https://next.angular.io/');\n+      CI_COMMIT: getLatestCommit('master'),\n+    }))).toEqual({\n+      deployEnv: 'next',\n+      projectId: 'aio-staging',\n+      siteId: 'aio-staging',\n+      deployedUrl: 'https://next.angular.io/',\n+    });\n   });\n \n   it('master - skip deploy - commit not HEAD', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: 'master',\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n-    })).toBe(\n-        'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n-        `(${getLatestCommitForBranch('master')}).`);\n+    }))).toEqual({\n+      skipped: true,\n+      reason:\n+          'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n+          `(${getLatestCommit('master')}).`,\n+    });\n   });\n \n   it('stable - deploy success', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.3.x',\n       CI_STABLE_BRANCH: '4.3.x',\n-      CI_COMMIT: getLatestCommitForBranch('4.3.x'),\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Git branch        : 4.3.x\\n' +\n-        'Build/deploy mode : stable\\n' +\n-        'Firebase project  : angular-io\\n' +\n-        'Firebase site     : angular-io\\n' +\n-        'Deployment URL    : https://angular.io/');\n+      CI_COMMIT: getLatestCommit('4.3.x'),\n+    }))).toEqual({\n+      deployEnv: 'stable',\n+      projectId: 'angular-io',\n+      siteId: 'angular-io',\n+      deployedUrl: 'https://angular.io/',\n+    });\n   });\n \n   it('stable - skip deploy - commit not HEAD', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.3.x',\n       CI_STABLE_BRANCH: '4.3.x',\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n-    })).toBe(\n-        'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n-        `(${getLatestCommitForBranch('4.3.x')}).`);\n+    }))).toEqual({\n+      skipped: true,\n+      reason:\n+          'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n+          `(${getLatestCommit('4.3.x')}).`,\n+    });\n   });\n \n   it('archive - deploy success', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.4.x',\n       CI_STABLE_BRANCH: '4.3.x',\n-      CI_COMMIT: getLatestCommitForBranch('2.4.x'),\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Git branch        : 2.4.x\\n' +\n-        'Build/deploy mode : archive\\n' +\n-        'Firebase project  : v2-angular-io\\n' +\n-        'Firebase site     : v2-angular-io\\n' +\n-        'Deployment URL    : https://v2.angular.io/');\n+      CI_COMMIT: getLatestCommit('2.4.x'),\n+    }))).toEqual({\n+      deployEnv: 'archive',\n+      projectId: 'v2-angular-io',\n+      siteId: 'v2-angular-io',\n+      deployedUrl: 'https://v2.angular.io/',\n+    });\n   });\n \n   it('archive - v9-angular-io multisite special case - deploy success', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '9.1.x',\n       CI_STABLE_BRANCH: '10.0.x',\n-      CI_COMMIT: getLatestCommitForBranch('9.1.x'),\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Git branch        : 9.1.x\\n' +\n-        'Build/deploy mode : archive\\n' +\n-        'Firebase project  : aio-staging\\n' +\n-        'Firebase site     : v9-angular-io\\n' +\n-        'Deployment URL    : https://v9.angular.io/');\n+      CI_COMMIT: getLatestCommit('9.1.x'),\n+    }))).toEqual({\n+      deployEnv: 'archive',\n+      projectId: 'aio-staging',\n+      siteId: 'v9-angular-io',\n+      deployedUrl: 'https://v9.angular.io/',\n+    });\n   });\n \n   it('archive - skip deploy - commit not HEAD', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.4.x',\n       CI_STABLE_BRANCH: '4.3.x',\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n-        `(${getLatestCommitForBranch('2.4.x')}).`);\n+    }))).toEqual({\n+      skipped: true,\n+      reason:\n+          'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n+          `(${getLatestCommit('2.4.x')}).`,\n+    });\n   });\n \n   it('archive - skip deploy - major same as stable, minor less than stable', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.1.x',\n       CI_STABLE_BRANCH: '2.2.x',\n-      CI_COMMIT: getLatestCommitForBranch('2.1.x'),\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n-        'There is a more recent branch with the same major version: \"2.4.x\"');\n+      CI_COMMIT: getLatestCommit('2.1.x'),\n+    }))).toEqual({\n+      skipped: true,\n+      reason:\n+          'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n+          'There is a more recent branch with the same major version: \"2.4.x\"',\n+    });\n   });\n \n   it('archive - skip deploy - major lower than stable, minor not latest', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.1.x',\n       CI_STABLE_BRANCH: '4.3.x',\n-      CI_COMMIT: getLatestCommitForBranch('2.1.x'),\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n-        'There is a more recent branch with the same major version: \"2.4.x\"');\n+      CI_COMMIT: getLatestCommit('2.1.x'),\n+    }))).toEqual({\n+      skipped: true,\n+      reason:\n+          'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n+          'There is a more recent branch with the same major version: \"2.4.x\"',\n+    });\n   });\n \n   it('rc - deploy success - major higher than stable', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.4.x',\n       CI_STABLE_BRANCH: '2.2.x',\n-      CI_COMMIT: getLatestCommitForBranch('4.4.x'),\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Git branch        : 4.4.x\\n' +\n-        'Build/deploy mode : rc\\n' +\n-        'Firebase project  : angular-io\\n' +\n-        'Firebase site     : rc-angular-io-site\\n' +\n-        'Deployment URL    : https://rc.angular.io/');\n+      CI_COMMIT: getLatestCommit('4.4.x'),\n+    }))).toEqual({\n+      deployEnv: 'rc',\n+      projectId: 'angular-io',\n+      siteId: 'rc-angular-io-site',\n+      deployedUrl: 'https://rc.angular.io/',\n+    });\n   });\n \n   it('rc - deploy success - major same as stable, minor higher', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.4.x',\n       CI_STABLE_BRANCH: '2.2.x',\n-      CI_COMMIT: getLatestCommitForBranch('2.4.x'),\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Git branch        : 2.4.x\\n' +\n-        'Build/deploy mode : rc\\n' +\n-        'Firebase project  : angular-io\\n' +\n-        'Firebase site     : rc-angular-io-site\\n' +\n-        'Deployment URL    : https://rc.angular.io/');\n+      CI_COMMIT: getLatestCommit('2.4.x'),\n+    }))).toEqual({\n+      deployEnv: 'rc',\n+      projectId: 'angular-io',\n+      siteId: 'rc-angular-io-site',\n+      deployedUrl: 'https://rc.angular.io/',\n+    });\n   });\n \n   it('rc - skip deploy - commit not HEAD', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.4.x',\n       CI_STABLE_BRANCH: '2.2.x',\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n-        `(${getLatestCommitForBranch('2.4.x')}).`);\n+    }))).toEqual({\n+      skipped: true,\n+      reason:\n+          'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n+          `(${getLatestCommit('2.4.x')}).`,\n+    });\n   });\n \n   it('rc - skip deploy - major same as stable, minor not latest', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.1.x',\n       CI_STABLE_BRANCH: '2.0.x',\n-      CI_COMMIT: getLatestCommitForBranch('2.1.x'),\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n-        'There is a more recent branch with the same major version: \"2.4.x\"');\n+      CI_COMMIT: getLatestCommit('2.1.x'),\n+    }))).toEqual({\n+      skipped: true,\n+      reason:\n+          'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n+          'There is a more recent branch with the same major version: \"2.4.x\"',\n+    });\n   });\n \n   it('rc - skip deploy - major higher than stable, minor not latest', () => {\n-    expect(deployToFirebaseDryRun({\n+    expect(computeDeploymentInfo(computeInputVars({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.3.x',\n       CI_STABLE_BRANCH: '2.4.x',\n-      CI_COMMIT: getLatestCommitForBranch('4.3.x'),\n-      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n-    })).toBe(\n-        'Skipping deploy of branch \"4.3.x\" to Firebase.\\n' +\n-        'There is a more recent branch with the same major version: \"4.4.x\"');\n+      CI_COMMIT: getLatestCommit('4.3.x'),\n+    }))).toEqual({\n+      skipped: true,\n+      reason:\n+          'Skipping deploy of branch \"4.3.x\" to Firebase.\\n' +\n+          'There is a more recent branch with the same major version: \"4.4.x\"',\n+    });\n   });\n });"
        }
    ],
    "stats": {
        "total": 535,
        "additions": 292,
        "deletions": 243
    }
}