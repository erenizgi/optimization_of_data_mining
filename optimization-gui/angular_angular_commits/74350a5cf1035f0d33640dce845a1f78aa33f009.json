{
    "author": "ivanwonder",
    "message": "fix(compiler-cli): return directives for an element on a microsyntax template (#42640)\n\nWhen the template type checker try to get a symbol of a template node, it will\nnot return the directives intended for an element on a microsyntax template,\nfor example, `<div *ngFor=\"let user of users;\" dir>`, the `dir` will be skipped,\nbut it's needed in language service.\n\nFixes https://github.com/angular/vscode-ng-language-service/issues/1420\n\nPR Close #42640",
    "sha": "74350a5cf1035f0d33640dce845a1f78aa33f009",
    "files": [
        {
            "sha": "87520a37bac0b1da8fe773ab8024d474fda76665",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/template_symbol_builder.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 2,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/74350a5cf1035f0d33640dce845a1f78aa33f009/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "raw_url": "https://github.com/angular/angular/raw/74350a5cf1035f0d33640dce845a1f78aa33f009/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts?ref=74350a5cf1035f0d33640dce845a1f78aa33f009",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, ASTWithSource, BindingPipe, MethodCall, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n+import {AST, ASTWithSource, BindingPipe, MethodCall, ParseSourceSpan, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {AbsoluteFsPath} from '../../file_system';\n@@ -150,7 +150,24 @@ export class SymbolBuilder {\n   private getDirectiveMeta(\n       host: TmplAstTemplate|TmplAstElement,\n       directiveDeclaration: ts.Declaration): TypeCheckableDirectiveMeta|null {\n-    const directives = this.templateData.boundTarget.getDirectivesOfNode(host);\n+    let directives = this.templateData.boundTarget.getDirectivesOfNode(host);\n+\n+    // `getDirectivesOfNode` will not return the directives intended for an element\n+    // on a microsyntax template, for example `<div *ngFor=\"let user of users;\" dir>`,\n+    // the `dir` will be skipped, but it's needed in language service.\n+    const firstChild = host.children[0];\n+    if (firstChild instanceof TmplAstElement) {\n+      const isMicrosyntaxTemplate = host instanceof TmplAstTemplate &&\n+          sourceSpanEqual(firstChild.sourceSpan, host.sourceSpan);\n+      if (isMicrosyntaxTemplate) {\n+        const firstChildDirectives = this.templateData.boundTarget.getDirectivesOfNode(firstChild);\n+        if (firstChildDirectives !== null && directives !== null) {\n+          directives = directives.concat(firstChildDirectives);\n+        } else {\n+          directives = directives ?? firstChildDirectives;\n+        }\n+      }\n+    }\n     if (directives === null) {\n       return null;\n     }\n@@ -577,3 +594,7 @@ export class SymbolBuilder {\n function anyNodeFilter(n: ts.Node): n is ts.Node {\n   return true;\n }\n+\n+function sourceSpanEqual(a: ParseSourceSpan, b: ParseSourceSpan) {\n+  return a.start.offset === b.start.offset && a.end.offset === b.end.offset;\n+}"
        },
        {
            "sha": "d510ecf5b0919b0d4fdf7c5a16302ebf77af36a2",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker__get_symbol_of_template_node_spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 2,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/74350a5cf1035f0d33640dce845a1f78aa33f009/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/74350a5cf1035f0d33640dce845a1f78aa33f009/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts?ref=74350a5cf1035f0d33640dce845a1f78aa33f009",
            "patch": "@@ -223,8 +223,9 @@ runInEachFileSystem(() => {\n \n         beforeEach(() => {\n           const fileName = absoluteFrom('/main.ts');\n+          const dirFile = absoluteFrom('/dir.ts');\n           const templateString = `\n-              <div *ngFor=\"let user of users; let i = index;\">\n+              <div *ngFor=\"let user of users; let i = index;\" dir>\n                 {{user.name}} {{user.streetNumber}}\n                 <div [tabIndex]=\"i\"></div>\n               </div>`;\n@@ -239,9 +240,23 @@ runInEachFileSystem(() => {\n             }\n             export class Cmp { users: User[]; }\n             `,\n-              declarations: [ngForDeclaration()],\n+              declarations: [\n+                ngForDeclaration(),\n+                {\n+                  name: 'TestDir',\n+                  selector: '[dir]',\n+                  file: dirFile,\n+                  type: 'directive',\n+                  inputs: {name: 'name'}\n+                },\n+              ],\n             },\n             ngForTypeCheckTarget(),\n+            {\n+              fileName: dirFile,\n+              source: `export class TestDir {name:string}`,\n+              templates: {},\n+            },\n           ]);\n           templateTypeChecker = testValues.templateTypeChecker;\n           program = testValues.program;\n@@ -250,6 +265,13 @@ runInEachFileSystem(() => {\n           templateNode = getAstTemplates(templateTypeChecker, cmp)[0];\n         });\n \n+        it('should retrieve a symbol for a directive on a microsyntax template', () => {\n+          const symbol = templateTypeChecker.getSymbolOfNode(templateNode, cmp);\n+          const testDir = symbol?.directives.find(dir => dir.selector === '[dir]');\n+          expect(testDir).toBeDefined();\n+          expect(program.getTypeChecker().symbolToString(testDir!.tsSymbol)).toEqual('TestDir');\n+        });\n+\n         it('should retrieve a symbol for an expression inside structural binding', () => {\n           const ngForOfBinding =\n               templateNode.templateAttrs.find(a => a.name === 'ngForOf')! as TmplAstBoundAttribute;"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 47,
        "deletions": 4
    }
}