{
    "author": "devversion",
    "message": "feat(bazel): expose `esm2020` and `es2020` conditions in APF package exports (#43740)\n\nIn addition to the existing `exports` conditional exports we ship\nas part of APF v13, we want to expose the non-bundled ESM2020 output\nthrough the `esm2020` conditional name. Additionally we will expose\nthe flat ES2020 files through the `es2020` conditional field, allowing\nconsumers (like the CLI) to prioritize certain formats.\n\ne.g. consider the case with RXJS where it currently defaults to\nthe ESM5 output. The CLI could now set `es2015` as the conditional\nto leverage the ES2015 output of RXJS. This unveils a problem though\nsince this would also mean that `ES2015` output of the framework Angular\npackages would be used instead of the available ES2020 output. Here is\nthe additional `es2020` conditional helpful as it allows the CLI to\nprioritize `es2020`, fallback to `es2015` and lastly fallback to `default`.\nif none do match for a certain package.\n\nPR Close #43740",
    "sha": "cd1b52483e886f6e2ad6cde23ff8a2225cafa219",
    "files": [
        {
            "sha": "b37f0691b2d27f5baf7dff4a755de8957e03d87c",
            "filename": "packages/bazel/src/ng_package/packager.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts",
            "raw_url": "https://github.com/angular/angular/raw/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_package%2Fpackager.ts?ref=cd1b52483e886f6e2ad6cde23ff8a2225cafa219",
            "patch": "@@ -62,10 +62,12 @@ type KnownPackageJsonFormatFields = typeof knownFormatPackageJsonFormatFields[nu\n  * https://nodejs.org/api/packages.html#packages_conditional_exports\n  */\n type ConditionalExport = {\n-  default?: string,\n-  types?: string,\n   node?: string;\n+  types?: string;\n+  esm2020?: string;\n+  es2020?: string;\n   es2015?: string;\n+  default?: string;\n };\n \n /** Type describing a `package.json` the packager deals with. */\n@@ -430,6 +432,7 @@ function main(args: string[]): void {\n     for (const [moduleName, entryPoint] of Object.entries(metadata.entryPoints)) {\n       const subpath =\n           isSecondaryEntryPoint(moduleName) ? `./${getEntryPointSubpath(moduleName)}` : '.';\n+      const esm2020IndexOutRelativePath = getEsm2020OutputRelativePath(entryPoint.index);\n       const fesm2020OutRelativePath = getFlatEsmOutputRelativePath(entryPoint.fesm2020Bundle);\n       const fesm2015OutRelativePath = getFlatEsmOutputRelativePath(entryPoint.fesm2015Bundle);\n       const typesOutRelativePath = getTypingOutputRelativePath(entryPoint.typings);\n@@ -439,6 +442,8 @@ function main(args: string[]): void {\n       // https://github.com/microsoft/TypeScript/pull/45884.\n       insertExportMappingOrError(newPackageJson, subpath, {\n         types: normalizePath(typesOutRelativePath),\n+        esm2020: normalizePath(esm2020IndexOutRelativePath),\n+        es2020: normalizePath(fesm2020OutRelativePath),\n         // We also expose a non-standard condition that would allow consumers to resolve\n         // to the `ES2015` output outside of NodeJS, if desired.\n         // TODO(devversion): remove/replace this if NodeJS v12 is no longer supported."
        },
        {
            "sha": "9cb522aa9967fe375591b400eac7bf1c2191b4e9",
            "filename": "packages/bazel/test/ng_package/BUILD.bazel",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2FBUILD.bazel?ref=cd1b52483e886f6e2ad6cde23ff8a2225cafa219",
            "patch": "@@ -6,11 +6,21 @@ exports_files([\"package.json\"])\n # working directory and therefore have mutable global state that causes test\n # isolation failures.\n \n+ts_library(\n+    name = \"test_utils_lib\",\n+    testonly = True,\n+    srcs = [\"test_utils.ts\"],\n+    deps = [\n+        \"//packages:types\",\n+    ],\n+)\n+\n ts_library(\n     name = \"core_spec_lib\",\n     testonly = True,\n     srcs = [\"core_package.spec.ts\"],\n     deps = [\n+        \":test_utils_lib\",\n         \"//packages:types\",\n         \"@npm//@bazel/runfiles\",\n         \"@npm//@types/shelljs\",\n@@ -32,6 +42,7 @@ ts_library(\n     testonly = True,\n     srcs = [\"common_package.spec.ts\"],\n     deps = [\n+        \":test_utils_lib\",\n         \"//packages:types\",\n         \"@npm//@bazel/runfiles\",\n         \"@npm//@types/shelljs\","
        },
        {
            "sha": "612e8f9fe84779254d92ebb8ac5f992c954279da",
            "filename": "packages/bazel/test/ng_package/common_package.spec.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 11,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2Fcommon_package.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2Fcommon_package.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fcommon_package.spec.ts?ref=cd1b52483e886f6e2ad6cde23ff8a2225cafa219",
            "patch": "@@ -10,6 +10,7 @@ import {runfiles} from '@bazel/runfiles';\n import * as fs from 'fs';\n import * as path from 'path';\n import * as shx from 'shelljs';\n+import {matchesObjectWithOrder} from './test_utils';\n \n // Resolve the \"npm_package\" directory by using the runfile resolution. Note that we need to\n // resolve the \"package.json\" of the package since otherwise NodeJS would resolve the \"main\"\n@@ -82,41 +83,51 @@ describe('@angular/common ng_package', () => {\n         fesm2020: `./fesm2020/common.mjs`,\n         fesm2015: `./fesm2015/common.mjs`,\n         typings: `./common.d.ts`,\n-        exports: {\n+        exports: matchesObjectWithOrder({\n+          './locales/global/*': {default: './locales/global/*.js'},\n+          './locales/*': {default: './locales/*.mjs'},\n+          './package.json': {default: './package.json'},\n           '.': {\n             types: './common.d.ts',\n+            esm2020: './esm2020/common.mjs',\n+            es2020: './fesm2020/common.mjs',\n             es2015: './fesm2015/common.mjs',\n             node: './fesm2015/common.mjs',\n-            default: './fesm2020/common.mjs',\n+            default: './fesm2020/common.mjs'\n           },\n-          './package.json': {default: './package.json'},\n           './http': {\n             types: './http/http.d.ts',\n+            esm2020: './esm2020/http/http.mjs',\n+            es2020: './fesm2020/http.mjs',\n             es2015: './fesm2015/http.mjs',\n             node: './fesm2015/http.mjs',\n-            default: './fesm2020/http.mjs',\n+            default: './fesm2020/http.mjs'\n           },\n           './http/testing': {\n             types: './http/testing/testing.d.ts',\n+            esm2020: './esm2020/http/testing/testing.mjs',\n+            es2020: './fesm2020/http/testing.mjs',\n             es2015: './fesm2015/http/testing.mjs',\n             node: './fesm2015/http/testing.mjs',\n-            default: './fesm2020/http/testing.mjs',\n+            default: './fesm2020/http/testing.mjs'\n           },\n           './testing': {\n             types: './testing/testing.d.ts',\n+            esm2020: './esm2020/testing/testing.mjs',\n+            es2020: './fesm2020/testing.mjs',\n             es2015: './fesm2015/testing.mjs',\n             node: './fesm2015/testing.mjs',\n-            default: './fesm2020/testing.mjs',\n+            default: './fesm2020/testing.mjs'\n           },\n           './upgrade': {\n             types: './upgrade/upgrade.d.ts',\n+            esm2020: './esm2020/upgrade/upgrade.mjs',\n+            es2020: './fesm2020/upgrade.mjs',\n             es2015: './fesm2015/upgrade.mjs',\n             node: './fesm2015/upgrade.mjs',\n-            default: './fesm2020/upgrade.mjs',\n-          },\n-          './locales/global/*': {default: './locales/global/*.js'},\n-          './locales/*': {default: './locales/*.mjs'},\n-        }\n+            default: './fesm2020/upgrade.mjs'\n+          }\n+        }),\n       }));\n     });\n     // https://github.com/angular/common-builds/blob/master/http/package.json"
        },
        {
            "sha": "da4de9a9cbe47299ffcfbcc092b5709f4f257194",
            "filename": "packages/bazel/test/ng_package/core_package.spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 8,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2Fcore_package.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2Fcore_package.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fcore_package.spec.ts?ref=cd1b52483e886f6e2ad6cde23ff8a2225cafa219",
            "patch": "@@ -9,6 +9,7 @@\n import {runfiles} from '@bazel/runfiles';\n import * as path from 'path';\n import * as shx from 'shelljs';\n+import {matchesObjectWithOrder} from './test_utils';\n \n // Resolve the \"npm_package\" directory by using the runfile resolution. Note that we need to\n // resolve the \"package.json\" of the package since otherwise NodeJS would resolve the \"main\"\n@@ -58,24 +59,26 @@ describe('@angular/core ng_package', () => {\n           fesm2020: `./fesm2020/core.mjs`,\n           fesm2015: `./fesm2015/core.mjs`,\n           typings: `./core.d.ts`,\n-          exports: {\n+          exports: matchesObjectWithOrder({\n+            './schematics/*': {default: './schematics/*.js'},\n+            './package.json': {default: './package.json'},\n             '.': {\n               types: './core.d.ts',\n+              esm2020: './esm2020/core.mjs',\n+              es2020: './fesm2020/core.mjs',\n               es2015: './fesm2015/core.mjs',\n               node: './fesm2015/core.mjs',\n               default: './fesm2020/core.mjs'\n             },\n-            './package.json': {default: './package.json'},\n             './testing': {\n               types: './testing/testing.d.ts',\n+              esm2020: './esm2020/testing/testing.mjs',\n+              es2020: './fesm2020/testing.mjs',\n               es2015: './fesm2015/testing.mjs',\n               node: './fesm2015/testing.mjs',\n-              default: './fesm2020/testing.mjs',\n-            },\n-            './schematics/*': {\n-              'default': './schematics/*.js',\n-            },\n-          }\n+              default: './fesm2020/testing.mjs'\n+            }\n+          }),\n         }));\n       });\n "
        },
        {
            "sha": "fb2df70564780dc4a708b3a5478518523677d264",
            "filename": "packages/bazel/test/ng_package/example_package.golden",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_package.golden",
            "raw_url": "https://github.com/angular/angular/raw/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_package.golden",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_package.golden?ref=cd1b52483e886f6e2ad6cde23ff8a2225cafa219",
            "patch": "@@ -786,24 +786,32 @@ export { }\n     },\n     \".\": {\n       \"types\": \"./example.d.ts\",\n+      \"esm2020\": \"./esm2020/example.mjs\",\n+      \"es2020\": \"./fesm2020/waffels.mjs\",\n       \"es2015\": \"./fesm2015/waffels.mjs\",\n       \"node\": \"./fesm2015/waffels.mjs\",\n       \"default\": \"./fesm2020/waffels.mjs\"\n     },\n     \"./a11y\": {\n       \"types\": \"./a11y/a11y.d.ts\",\n+      \"esm2020\": \"./esm2020/a11y/a11y.mjs\",\n+      \"es2020\": \"./fesm2020/a11y.mjs\",\n       \"es2015\": \"./fesm2015/a11y.mjs\",\n       \"node\": \"./fesm2015/a11y.mjs\",\n       \"default\": \"./fesm2020/a11y.mjs\"\n     },\n     \"./imports\": {\n       \"types\": \"./imports/imports.d.ts\",\n+      \"esm2020\": \"./esm2020/imports/imports.mjs\",\n+      \"es2020\": \"./fesm2020/imports.mjs\",\n       \"es2015\": \"./fesm2015/imports.mjs\",\n       \"node\": \"./fesm2015/imports.mjs\",\n       \"default\": \"./fesm2020/imports.mjs\"\n     },\n     \"./secondary\": {\n       \"types\": \"./secondary/secondary.d.ts\",\n+      \"esm2020\": \"./esm2020/secondary/secondary.mjs\",\n+      \"es2020\": \"./fesm2020/secondary.mjs\",\n       \"es2015\": \"./fesm2015/secondary.mjs\",\n       \"node\": \"./fesm2015/secondary.mjs\",\n       \"default\": \"./fesm2020/secondary.mjs\""
        },
        {
            "sha": "25cf1bb6f1a85702c463972ec811a87d0b14bdca",
            "filename": "packages/bazel/test/ng_package/example_with_ts_library_package.golden",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_with_ts_library_package.golden",
            "raw_url": "https://github.com/angular/angular/raw/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_with_ts_library_package.golden",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Fexample_with_ts_library_package.golden?ref=cd1b52483e886f6e2ad6cde23ff8a2225cafa219",
            "patch": "@@ -351,18 +351,24 @@ export declare const VERSION = \"0.0.0\";\n     },\n     \".\": {\n       \"types\": \"./index.d.ts\",\n+      \"esm2020\": \"./esm2020/index.mjs\",\n+      \"es2020\": \"./fesm2020/example-with-ts-library.mjs\",\n       \"es2015\": \"./fesm2015/example-with-ts-library.mjs\",\n       \"node\": \"./fesm2015/example-with-ts-library.mjs\",\n       \"default\": \"./fesm2020/example-with-ts-library.mjs\"\n     },\n     \"./portal\": {\n       \"types\": \"./portal/portal.d.ts\",\n+      \"esm2020\": \"./esm2020/portal/portal.mjs\",\n+      \"es2020\": \"./fesm2020/portal.mjs\",\n       \"es2015\": \"./fesm2015/portal.mjs\",\n       \"node\": \"./fesm2015/portal.mjs\",\n       \"default\": \"./fesm2020/portal.mjs\"\n     },\n     \"./utils\": {\n       \"types\": \"./utils/index.d.ts\",\n+      \"esm2020\": \"./esm2020/utils/index.mjs\",\n+      \"es2020\": \"./fesm2020/utils.mjs\",\n       \"es2015\": \"./fesm2015/utils.mjs\",\n       \"node\": \"./fesm2015/utils.mjs\",\n       \"default\": \"./fesm2020/utils.mjs\""
        },
        {
            "sha": "46bc386c502c8ee7f35e4d782442e8ef3e6019fb",
            "filename": "packages/bazel/test/ng_package/test_utils.ts",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/cd1b52483e886f6e2ad6cde23ff8a2225cafa219/packages%2Fbazel%2Ftest%2Fng_package%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fng_package%2Ftest_utils.ts?ref=cd1b52483e886f6e2ad6cde23ff8a2225cafa219",
            "patch": "@@ -0,0 +1,25 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * Jasmine asymmetric matcher that compares a given object ensuring that it matches deep\n+ * with the other while also respecting the order of keys. This is useful when comparing\n+ * the NodeJS `package.json` `exports` field where order matters.\n+ */\n+export function matchesObjectWithOrder(expected: any): jasmine.AsymmetricMatcher<any> {\n+  return {\n+    asymmetricMatch(actual: any): boolean {\n+      // Use JSON stringify to compare the object with respect to the order of keys\n+      // in the object, and its nested objects.\n+      return JSON.stringify(actual) === JSON.stringify(expected);\n+    },\n+    jasmineToString(prettyPrint: typeof jasmine.pp): string {\n+      return prettyPrint(expected);\n+    }\n+  };\n+}"
        }
    ],
    "stats": {
        "total": 111,
        "additions": 90,
        "deletions": 21
    }
}