{
    "author": "alxhub",
    "message": "feat(language-service): implement signature help (#41581)\n\nThis commit implements signature help in the Language Service, on top of\nTypeScript's implementation within the TCB.\n\nA separate PR adds support for translation of signature help data from TS'\nAPI to the LSP in the Language Service extension.\n\nPR Close #41581",
    "sha": "c7f9516ab920baee755d61ce0deea502e88a58ba",
    "files": [
        {
            "sha": "1f6ffa50a39aa44ede16fc45d586787cd3c3bd08",
            "filename": "packages/compiler-cli/src/ngtsc/perf/src/api.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fperf%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fperf%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fperf%2Fsrc%2Fapi.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -144,6 +144,11 @@ export enum PerfPhase {\n    */\n   LsComponentLocations,\n \n+  /**\n+   * Time spent by the Angular Language Service calculating signature help.\n+   */\n+  LsSignatureHelp,\n+\n   /**\n    * Tracks the number of `PerfPhase`s, and must appear at the end of the list.\n    */"
        },
        {
            "sha": "1b57a408f41eb7e029b660e535b22b51dfaed694",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/expression.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -69,7 +69,9 @@ class AstTranslator implements AstVisitor {\n \n     // The `EmptyExpr` doesn't have a dedicated method on `AstVisitor`, so it's special cased here.\n     if (ast instanceof EmptyExpr) {\n-      return UNDEFINED;\n+      const res = ts.factory.createIdentifier('undefined');\n+      addParseSpanInfo(res, ast.sourceSpan);\n+      return res;\n     }\n \n     // First attempt to let any custom resolution logic provide a translation for the given node."
        },
        {
            "sha": "23d1c7e07e9c696775a8ca1728b18600a23690d4",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -27,6 +27,7 @@ import {CompletionBuilder, CompletionNodeContext} from './completions';\n import {DefinitionBuilder} from './definitions';\n import {QuickInfoBuilder} from './quick_info';\n import {ReferencesAndRenameBuilder} from './references';\n+import {getSignatureHelp} from './signature_help';\n import {getTargetAtPosition, TargetContext, TargetNodeKind} from './template_target';\n import {findTightestNode, getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n import {getTemplateInfoAtPosition, isTypeScriptFile} from './utils';\n@@ -254,6 +255,19 @@ export class LanguageService {\n     });\n   }\n \n+  getSignatureHelpItems(fileName: string, position: number, options?: ts.SignatureHelpItemsOptions):\n+      ts.SignatureHelpItems|undefined {\n+    return this.withCompilerAndPerfTracing(PerfPhase.LsSignatureHelp, compiler => {\n+      if (!isTemplateContext(compiler.getCurrentProgram(), fileName, position)) {\n+        return undefined;\n+      }\n+\n+      return getSignatureHelp(compiler, this.tsLS, fileName, position, options);\n+\n+      return undefined;\n+    });\n+  }\n+\n   getCompletionEntrySymbol(fileName: string, position: number, entryName: string): ts.Symbol\n       |undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsCompletions, (compiler) => {"
        },
        {
            "sha": "a294163d1f39acfdfb2d40813c5994c9efd7b8ed",
            "filename": "packages/language-service/ivy/signature_help.ts",
            "status": "added",
            "additions": 135,
            "deletions": 0,
            "changes": 135,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fivy%2Fsignature_help.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fivy%2Fsignature_help.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fsignature_help.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -0,0 +1,135 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {MethodCall, SafeMethodCall} from '@angular/compiler';\n+import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n+import {getSourceFileOrError} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {SymbolKind} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import * as ts from 'typescript/lib/tsserverlibrary';\n+\n+import {getTargetAtPosition, TargetNodeKind} from './template_target';\n+import {findTightestNode} from './ts_utils';\n+import {getTemplateInfoAtPosition} from './utils';\n+\n+/**\n+ * Queries the TypeScript Language Service to get signature help for a template position.\n+ */\n+export function getSignatureHelp(\n+    compiler: NgCompiler, tsLS: ts.LanguageService, fileName: string, position: number,\n+    options: ts.SignatureHelpItemsOptions|undefined): ts.SignatureHelpItems|undefined {\n+  const templateInfo = getTemplateInfoAtPosition(fileName, position, compiler);\n+  if (templateInfo === undefined) {\n+    return undefined;\n+  }\n+\n+  const targetInfo = getTargetAtPosition(templateInfo.template, position);\n+  if (targetInfo === null) {\n+    return undefined;\n+  }\n+\n+  if (targetInfo.context.kind !== TargetNodeKind.RawExpression &&\n+      targetInfo.context.kind !== TargetNodeKind.MethodCallExpressionInArgContext) {\n+    // Signature completions are only available in expressions.\n+    return undefined;\n+  }\n+\n+  const symbol = compiler.getTemplateTypeChecker().getSymbolOfNode(\n+      targetInfo.context.node, templateInfo.component);\n+  if (symbol === null || symbol.kind !== SymbolKind.Expression) {\n+    return undefined;\n+  }\n+\n+  // Determine a shim position to use in the request to the TypeScript Language Service.\n+  // Additionally, extract the `MethodCall` or `SafeMethodCall` node for which signature help is\n+  // being queried, as this is needed to construct the correct span for the results later.\n+  let shimPosition: number;\n+  let expr: MethodCall|SafeMethodCall;\n+  switch (targetInfo.context.kind) {\n+    case TargetNodeKind.RawExpression:\n+      // For normal expressions, just use the primary TCB position of the expression.\n+      shimPosition = symbol.shimLocation.positionInShimFile;\n+\n+      // Walk up the parents of this expression and try to find a `MethodCall` or `SafeMethodCall`\n+      // for which signature information is being fetched.\n+      let callExpr: MethodCall|SafeMethodCall|null = null;\n+      const parents = targetInfo.context.parents;\n+      for (let i = parents.length - 1; i >= 0; i--) {\n+        const parent = parents[i];\n+        if (parent instanceof MethodCall || parent instanceof SafeMethodCall) {\n+          callExpr = parent;\n+          break;\n+        }\n+      }\n+\n+      // If no MethodCall or SafeMethodCall node could be found, then this query cannot be safely\n+      // answered as a correct span for the results will not be obtainable.\n+      if (callExpr === null) {\n+        return undefined;\n+      }\n+\n+      expr = callExpr;\n+      break;\n+    case TargetNodeKind.MethodCallExpressionInArgContext:\n+      // The `Symbol` points to a `MethodCall` or `SafeMethodCall` expression in the TCB (where it\n+      // will be represented as a `ts.CallExpression`) *and* the template position was within the\n+      // argument list of the method call. This happens when there was no narrower expression inside\n+      // the argument list that matched the template position, such as when the call has no\n+      // arguments: `foo(|)`.\n+      //\n+      // The `Symbol`'s shim position is to the start of the call expression (`|foo()`) and\n+      // therefore wouldn't return accurate signature help from the TS language service. For that, a\n+      // position within the argument list for the `ts.CallExpression` in the TCB will need to be\n+      // determined. This is done by finding that call expression and extracting a viable position\n+      // from it directly.\n+      //\n+      // First, use `findTightestNode` to locate the `ts.Node` at `symbol`'s location.\n+      const shimSf =\n+          getSourceFileOrError(compiler.getCurrentProgram(), symbol.shimLocation.shimPath);\n+      let shimNode: ts.Node|null =\n+          findTightestNode(shimSf, symbol.shimLocation.positionInShimFile) ?? null;\n+\n+      // This node should be somewhere inside a `ts.CallExpression`. Walk up the AST to find it.\n+      while (shimNode !== null) {\n+        if (ts.isCallExpression(shimNode)) {\n+          break;\n+        }\n+        shimNode = shimNode.parent ?? null;\n+      }\n+\n+      // If one couldn't be found, something is wrong, so bail rather than report incorrect results.\n+      if (shimNode === null || !ts.isCallExpression(shimNode)) {\n+        return undefined;\n+      }\n+\n+      // Position the cursor in the TCB at the start of the argument list for the\n+      // `ts.CallExpression`. This will allow us to get the correct signature help, even though the\n+      // template itself doesn't have an expression inside the argument list.\n+      shimPosition = shimNode.arguments.pos;\n+\n+      // In this case, getting the right call AST node is easy.\n+      expr = targetInfo.context.node;\n+      break;\n+  }\n+\n+  const res = tsLS.getSignatureHelpItems(symbol.shimLocation.shimPath, shimPosition, options);\n+  if (res === undefined) {\n+    return undefined;\n+  }\n+\n+  // The TS language service results are almost returnable as-is. However, they contain an\n+  // `applicableSpan` which marks the entire argument list, and that span is in the context of the\n+  // TCB's `ts.CallExpression`. It needs to be replaced with the span for the `MethodCall` (or\n+  // `SafeMethodCall`) argument list.\n+  return {\n+    ...res,\n+    applicableSpan: {\n+      start: expr.argumentSpan.start,\n+      length: expr.argumentSpan.end - expr.argumentSpan.start,\n+    },\n+  };\n+}"
        },
        {
            "sha": "bd3657d9203f167c8ca4263907abc39f3af9c0ba",
            "filename": "packages/language-service/ivy/test/signature_help_spec.ts",
            "status": "added",
            "additions": 142,
            "deletions": 0,
            "changes": 142,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fivy%2Ftest%2Fsignature_help_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fivy%2Ftest%2Fsignature_help_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fsignature_help_spec.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -0,0 +1,142 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {getText} from '@angular/language-service/ivy/testing/src/util';\n+\n+import {LanguageServiceTestEnv, OpenBuffer} from '../testing';\n+\n+describe('signature help', () => {\n+  beforeEach(() => {\n+    initMockFileSystem('Native');\n+  });\n+\n+  it('should handle an empty argument list', () => {\n+    const main = setup(`\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        template: '{{ foo() }}',\n+      })\n+      export class MainCmp {\n+        foo(alpha: string, beta: number): string {\n+          return 'blah';\n+        }\n+      }\n+    `);\n+    main.moveCursorToText('foo(¦)');\n+\n+    const items = main.getSignatureHelpItems()!;\n+    expect(items).toBeDefined();\n+    expect(items.applicableSpan.start).toEqual(main.cursor);\n+    expect(items.applicableSpan.length).toEqual(0);\n+    expect(items.argumentCount).toEqual(0);\n+    expect(items.argumentIndex).toEqual(0);\n+    expect(items.items.length).toEqual(1);\n+  });\n+\n+  it('should handle a single argument', () => {\n+    const main = setup(`\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        template: '{{ foo(\"test\") }}',\n+      })\n+      export class MainCmp {\n+        foo(alpha: string, beta: number): string {\n+          return 'blah';\n+        }\n+      }\n+    `);\n+    main.moveCursorToText('foo(\"test\"¦)');\n+\n+    const items = main.getSignatureHelpItems()!;\n+    expect(items).toBeDefined();\n+    expect(getText(main.contents, items.applicableSpan)).toEqual('\"test\"');\n+    expect(items.argumentCount).toEqual(1);\n+    expect(items.argumentIndex).toEqual(0);\n+    expect(items.items.length).toEqual(1);\n+  });\n+\n+  it('should handle a position within the first of two arguments', () => {\n+    const main = setup(`\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        template: '{{ foo(\"test\", 3) }}',\n+      })\n+      export class MainCmp {\n+        foo(alpha: string, beta: number): string {\n+          return 'blah';\n+        }\n+      }\n+    `);\n+    main.moveCursorToText('foo(\"te¦st\", 3)');\n+\n+    const items = main.getSignatureHelpItems()!;\n+    expect(items).toBeDefined();\n+    expect(getText(main.contents, items.applicableSpan)).toEqual('\"test\", 3');\n+    expect(items.argumentCount).toEqual(2);\n+    expect(items.argumentIndex).toEqual(0);\n+    expect(items.items.length).toEqual(1);\n+  });\n+\n+  it('should handle a position within the second of two arguments', () => {\n+    const main = setup(`\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        template: '{{ foo(\"test\", 1 + 2) }}',\n+      })\n+      export class MainCmp {\n+        foo(alpha: string, beta: number): string {\n+          return 'blah';\n+        }\n+      }\n+    `);\n+    main.moveCursorToText('foo(\"test\", 1 +¦ 2)');\n+\n+    const items = main.getSignatureHelpItems()!;\n+    expect(items).toBeDefined();\n+    expect(getText(main.contents, items.applicableSpan)).toEqual('\"test\", 1 + 2');\n+    expect(items.argumentCount).toEqual(2);\n+    expect(items.argumentIndex).toEqual(1);\n+    expect(items.items.length).toEqual(1);\n+  });\n+\n+  it('should handle a position within a new, EmptyExpr argument', () => {\n+    const main = setup(`\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        template: '{{ foo(\"test\", ) }}',\n+      })\n+      export class MainCmp {\n+        foo(alpha: string, beta: number): string {\n+          return 'blah';\n+        }\n+      }\n+    `);\n+    main.moveCursorToText('foo(\"test\", ¦)');\n+\n+    const items = main.getSignatureHelpItems()!;\n+    expect(items).toBeDefined();\n+    expect(getText(main.contents, items.applicableSpan)).toEqual('\"test\", ');\n+    expect(items.argumentCount).toEqual(2);\n+    expect(items.argumentIndex).toEqual(1);\n+    expect(items.items.length).toEqual(1);\n+  });\n+});\n+\n+function setup(mainTs: string): OpenBuffer {\n+  const env = LanguageServiceTestEnv.setup();\n+  const project = env.addProject('test', {\n+    'main.ts': mainTs,\n+  });\n+  return project.openFile('main.ts');\n+}"
        },
        {
            "sha": "78453739ee108d26c94104d5001360b36f3b23f1",
            "filename": "packages/language-service/ivy/testing/src/buffer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -98,6 +98,10 @@ export class OpenBuffer {\n   getRenameInfo() {\n     return this.ngLS.getRenameInfo(this.scriptInfo.fileName, this._cursor);\n   }\n+\n+  getSignatureHelpItems() {\n+    return this.ngLS.getSignatureHelpItems(this.scriptInfo.fileName, this._cursor);\n+  }\n }\n \n /**"
        },
        {
            "sha": "e8c6c9084a2932ea9304c5aaba70b106a76f6384",
            "filename": "packages/language-service/ivy/ts_plugin.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -130,6 +130,17 @@ export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n     return diagnostics;\n   }\n \n+  function getSignatureHelpItems(\n+      fileName: string, position: number,\n+      options: ts.SignatureHelpItemsOptions): ts.SignatureHelpItems|undefined {\n+    if (angularOnly) {\n+      return ngLS.getSignatureHelpItems(fileName, position, options);\n+    } else {\n+      return tsLS.getSignatureHelpItems(fileName, position, options) ??\n+          ngLS.getSignatureHelpItems(fileName, position, options);\n+    }\n+  }\n+\n   function getTcb(fileName: string, position: number): GetTcbResponse|undefined {\n     return ngLS.getTcb(fileName, position);\n   }\n@@ -157,6 +168,7 @@ export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n     getTcb,\n     getCompilerOptionsDiagnostics,\n     getComponentLocationsForTemplate,\n+    getSignatureHelpItems,\n   };\n }\n "
        },
        {
            "sha": "d6050d7465615f7c1a5b66f634380308780e8bca",
            "filename": "packages/language-service/src/ts_plugin.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/c7f9516ab920baee755d61ce0deea502e88a58ba/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts?ref=c7f9516ab920baee755d61ce0deea502e88a58ba",
            "patch": "@@ -136,6 +136,13 @@ export function create(info: tss.server.PluginCreateInfo): NgLanguageService {\n     return undefined;\n   }\n \n+  function getSignatureHelpItems(\n+      fileName: string, position: number,\n+      options: ts.SignatureHelpItemsOptions|undefined): ts.SignatureHelpItems|undefined {\n+    // not implemented in VE Language Service\n+    return undefined;\n+  }\n+\n   function getTcb(fileName: string, position: number) {\n     // Not implemented in VE Language Service\n     return undefined;\n@@ -157,6 +164,7 @@ export function create(info: tss.server.PluginCreateInfo): NgLanguageService {\n     getDefinitionAndBoundSpan,\n     getTypeDefinitionAtPosition,\n     getReferencesAtPosition,\n+    getSignatureHelpItems,\n     findRenameLocations,\n     getTcb,\n     getComponentLocationsForTemplate,"
        }
    ],
    "stats": {
        "total": 324,
        "additions": 323,
        "deletions": 1
    }
}