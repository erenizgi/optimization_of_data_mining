{
    "author": "petebacondarwin",
    "message": "fix(compiler): skipping leading whitespace should not break placeholder source-spans (#39486)\n\nTokenized text node may have leading whitespace skipped from their\nsource-span. But the source-span is used to compute where there are\ninterpolated blocks, resulting in placeholder nodes whose source-spans\nare offset by the amount of skipped characters.\n\nThis fix uses the `fullStart` location of text source-spans for computing\nthe source-span of placeholders, so that they are accurate.\n\nFixes #39195\n\nPR Close #39486",
    "sha": "1f956184c426814be8fcbdab03396c910e29d935",
    "files": [
        {
            "sha": "c22941f16f6867ff90270e9e7abccaecce31464a",
            "filename": "packages/compiler/src/i18n/i18n_parser.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1f956184c426814be8fcbdab03396c910e29d935/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/1f956184c426814be8fcbdab03396c910e29d935/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts?ref=1f956184c426814be8fcbdab03396c910e29d935",
            "patch": "@@ -203,7 +203,7 @@ class _I18nVisitor implements html.Visitor {\n \n function getOffsetSourceSpan(\n     sourceSpan: ParseSourceSpan, {start, end}: {start: number, end: number}): ParseSourceSpan {\n-  return new ParseSourceSpan(sourceSpan.start.moveBy(start), sourceSpan.start.moveBy(end));\n+  return new ParseSourceSpan(sourceSpan.fullStart.moveBy(start), sourceSpan.fullStart.moveBy(end));\n }\n \n const _CUSTOM_PH_EXP ="
        },
        {
            "sha": "126c9702121a65c79ea566ae87d657c34c60f40a",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1f956184c426814be8fcbdab03396c910e29d935/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/1f956184c426814be8fcbdab03396c910e29d935/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=1f956184c426814be8fcbdab03396c910e29d935",
            "patch": "@@ -55,7 +55,7 @@ const EVENT_BINDING_SCOPE_GLOBALS = new Set<string>(['$event']);\n const GLOBAL_TARGET_RESOLVERS = new Map<string, o.ExternalReference>(\n     [['window', R3.resolveWindow], ['document', R3.resolveDocument], ['body', R3.resolveBody]]);\n \n-const LEADING_TRIVIA_CHARS = [' ', '\\n', '\\r', '\\t'];\n+export const LEADING_TRIVIA_CHARS = [' ', '\\n', '\\r', '\\t'];\n \n //  if (rf & flags) { .. }\n export function renderFlagCheckIfStmt("
        },
        {
            "sha": "b6fca34b7758aaf984c7e0422dd20d37a12e7e37",
            "filename": "packages/compiler/test/render3/view/i18n_spec.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 2,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/1f956184c426814be8fcbdab03396c910e29d935/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1f956184c426814be8fcbdab03396c910e29d935/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts?ref=1f956184c426814be8fcbdab03396c910e29d935",
            "patch": "@@ -18,6 +18,7 @@ import {serializeIcuNode} from '../../../src/render3/view/i18n/icu_serializer';\n import {serializeI18nMessageForLocalize} from '../../../src/render3/view/i18n/localize_utils';\n import {I18nMeta, parseI18nMeta} from '../../../src/render3/view/i18n/meta';\n import {formatI18nPlaceholderName} from '../../../src/render3/view/i18n/util';\n+import {LEADING_TRIVIA_CHARS} from '../../../src/render3/view/template';\n \n import {parseR3 as parse} from './util';\n \n@@ -386,7 +387,7 @@ describe('serializeI18nMessageForGetMsg', () => {\n \n describe('serializeI18nMessageForLocalize', () => {\n   const serialize = (input: string) => {\n-    const tree = parse(`<div i18n>${input}</div>`);\n+    const tree = parse(`<div i18n>${input}</div>`, {leadingTriviaChars: LEADING_TRIVIA_CHARS});\n     const root = tree.nodes[0] as t.Element;\n     return serializeI18nMessageForLocalize(root.i18n as i18n.Message);\n   };\n@@ -477,7 +478,7 @@ describe('serializeI18nMessageForLocalize', () => {\n        expect(messageParts[3].text).toEqual('');\n        expect(messageParts[3].sourceSpan.toString()).toEqual('');\n        expect(messageParts[4].text).toEqual(' D');\n-       expect(messageParts[4].sourceSpan.toString()).toEqual(' D');\n+       expect(messageParts[4].sourceSpan.toString()).toEqual('D');\n \n        expect(placeHolders[0].text).toEqual('START_TAG_SPAN');\n        expect(placeHolders[0].sourceSpan.toString()).toEqual('<span>');\n@@ -509,6 +510,26 @@ describe('serializeI18nMessageForLocalize', () => {\n        expect(humanizeSourceSpan(placeHolders[2].sourceSpan)).toEqual('\"</b>\" (22-26)');\n      });\n \n+  it('should create the correct placeholder source-spans when there is skipped leading whitespace',\n+     () => {\n+       const {messageParts, placeHolders} = serialize('<b>   {{value}}</b>');\n+       expect(messageParts[0].text).toEqual('');\n+       expect(humanizeSourceSpan(messageParts[0].sourceSpan)).toEqual('\"\" (10-10)');\n+       expect(messageParts[1].text).toEqual('   ');\n+       expect(humanizeSourceSpan(messageParts[1].sourceSpan)).toEqual('\"   \" (13-16)');\n+       expect(messageParts[2].text).toEqual('');\n+       expect(humanizeSourceSpan(messageParts[2].sourceSpan)).toEqual('\"\" (25-25)');\n+       expect(messageParts[3].text).toEqual('');\n+       expect(humanizeSourceSpan(messageParts[3].sourceSpan)).toEqual('\"\" (29-29)');\n+\n+       expect(placeHolders[0].text).toEqual('START_BOLD_TEXT');\n+       expect(humanizeSourceSpan(placeHolders[0].sourceSpan)).toEqual('\"<b>   \" (10-16)');\n+       expect(placeHolders[1].text).toEqual('INTERPOLATION');\n+       expect(humanizeSourceSpan(placeHolders[1].sourceSpan)).toEqual('\"{{value}}\" (16-25)');\n+       expect(placeHolders[2].text).toEqual('CLOSE_BOLD_TEXT');\n+       expect(humanizeSourceSpan(placeHolders[2].sourceSpan)).toEqual('\"</b>\" (25-29)');\n+     });\n+\n   it('should serialize simple ICU for `$localize()`', () => {\n     expect(serialize('{age, plural, 10 {ten} other {other}}')).toEqual({\n       messageParts: [literal('{VAR_PLURAL, plural, 10 {ten} other {other}}')],"
        },
        {
            "sha": "e974e0e155cfc8e0f1d04901e2b9119330fcd2c0",
            "filename": "packages/compiler/test/render3/view/util.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/1f956184c426814be8fcbdab03396c910e29d935/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/1f956184c426814be8fcbdab03396c910e29d935/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Futil.ts?ref=1f956184c426814be8fcbdab03396c910e29d935",
            "patch": "@@ -78,11 +78,13 @@ export function toStringExpression(expr: e.AST): string {\n \n // Parse an html string to IVY specific info\n export function parseR3(\n-    input: string, options: {preserveWhitespaces?: boolean} = {}): Render3ParseResult {\n+    input: string, options: {preserveWhitespaces?: boolean, leadingTriviaChars?: string[]} = {}):\n+    Render3ParseResult {\n   const htmlParser = new HtmlParser();\n \n-  const parseResult =\n-      htmlParser.parse(input, 'path:://to/template', {tokenizeExpansionForms: true});\n+  const parseResult = htmlParser.parse(\n+      input, 'path:://to/template',\n+      {tokenizeExpansionForms: true, leadingTriviaChars: options.leadingTriviaChars});\n \n   if (parseResult.errors.length > 0) {\n     const msg = parseResult.errors.map(e => e.toString()).join('\\n');"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 30,
        "deletions": 7
    }
}