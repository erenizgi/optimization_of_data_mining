{
    "author": "alxhub",
    "message": "refactor(compiler-cli): support `ts.SourceFile` versioning (#41475)\n\nGenerally, the compiler assumes that `ts.SourceFile`s are immutable objects.\nIf a new `ts.Program` is compared to an old one, and a `ts.SourceFile`\nwithin that program has not changed its object identity, the compiler will\nassume that its prior analysis and understanding of that source file is\nstill valid.\n\nHowever, not all TypeScript workflows uphold this assumption. For\n`ts.Program`s that originate from the `ts.LanguageService`, some source\nfiles may be re-parsed or otherwise undergo mutations without changing their\nobject identity. This breaks the compiler's incremental workflow.\n\nWithin such environments, it's necessary to track source file changes\ndifferently. In addition to object identity, it's necessary to compare a\n\"version\" string associated with each source file, between when that file is\nanalyzed originally and when a new program is presented that still contains\nit. It's possible for the object identity of the source file to be the same,\nbut the version string to have changed, indicating that the source file\nshould be treated as changed.\n\nThis commit adds an optional method `getSourceFileVersion` to the\n`ProgramDriver`, to provide access to version information if available. When\nthis method is present, the compiler will build a map of source file version\nstrings, and use this map to augment identity comparison during incremental\ncompilation.\n\nPR Close #41475",
    "sha": "dee95994b8e5def7c7880038d64968da93fc04b4",
    "files": [
        {
            "sha": "90352bf11cea66533b958e08890666f608b8cf0f",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 5,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=dee95994b8e5def7c7880038d64968da93fc04b4",
            "patch": "@@ -13,7 +13,7 @@ import {ComponentDecoratorHandler, DirectiveDecoratorHandler, InjectableDecorato\n import {CycleAnalyzer, CycleHandlingStrategy, ImportGraph} from '../../cycles';\n import {COMPILER_ERRORS_WITH_GUIDES, ERROR_DETAILS_PAGE_BASE_URL, ErrorCode, ngErrorCode} from '../../diagnostics';\n import {checkForPrivateExports, ReferenceGraph} from '../../entry_point';\n-import {AbsoluteFsPath, LogicalFileSystem, resolve} from '../../file_system';\n+import {absoluteFromSourceFile, AbsoluteFsPath, LogicalFileSystem, resolve} from '../../file_system';\n import {AbsoluteModuleStrategy, AliasingHost, AliasStrategy, DefaultImportTracker, ImportRewriter, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, NoopImportRewriter, PrivateExportAliasingHost, R3SymbolsImportRewriter, Reference, ReferenceEmitStrategy, ReferenceEmitter, RelativePathStrategy, UnifiedModulesAliasingHost, UnifiedModulesStrategy} from '../../imports';\n import {IncrementalBuildStrategy, IncrementalCompilation, IncrementalState} from '../../incremental';\n import {SemanticSymbol} from '../../incremental/semantic_graph';\n@@ -32,7 +32,7 @@ import {ivySwitchTransform} from '../../switch';\n import {aliasTransformFactory, CompilationMode, declarationTransformFactory, DecoratorHandler, DtsTransformRegistry, ivyTransformFactory, TraitCompiler} from '../../transform';\n import {TemplateTypeCheckerImpl} from '../../typecheck';\n import {OptimizeFor, TemplateTypeChecker, TypeCheckingConfig} from '../../typecheck/api';\n-import {getSourceFileOrNull, isDtsPath, resolveModuleName} from '../../util/src/typescript';\n+import {getSourceFileOrNull, isDtsPath, resolveModuleName, toUnredirectedSourceFile} from '../../util/src/typescript';\n import {LazyRoute, NgCompilerAdapter, NgCompilerOptions} from '../api';\n \n import {compileUndecoratedClassesWithAngularFeatures} from './config';\n@@ -159,7 +159,8 @@ export function incrementalFromCompilerTicket(\n   }\n \n   const incrementalCompilation = IncrementalCompilation.incremental(\n-      newProgram, oldProgram, oldState, modifiedResourceFiles, perfRecorder);\n+      newProgram, versionMapFromProgram(newProgram, programDriver), oldProgram, oldState,\n+      modifiedResourceFiles, perfRecorder);\n \n   return {\n     kind: CompilationTicketKind.IncrementalTypeScript,\n@@ -188,7 +189,8 @@ export function incrementalFromStateTicket(\n     perfRecorder = ActivePerfRecorder.zeroedToNow();\n   }\n   const incrementalCompilation = IncrementalCompilation.incremental(\n-      newProgram, oldProgram, oldState, modifiedResourceFiles, perfRecorder);\n+      newProgram, versionMapFromProgram(newProgram, programDriver), oldProgram, oldState,\n+      modifiedResourceFiles, perfRecorder);\n   return {\n     kind: CompilationTicketKind.IncrementalTypeScript,\n     newProgram,\n@@ -282,7 +284,8 @@ export class NgCompiler {\n             ticket.tsProgram,\n             ticket.programDriver,\n             ticket.incrementalBuildStrategy,\n-            IncrementalCompilation.fresh(ticket.tsProgram),\n+            IncrementalCompilation.fresh(\n+                ticket.tsProgram, versionMapFromProgram(ticket.tsProgram, ticket.programDriver)),\n             ticket.enableTemplateTypeChecker,\n             ticket.usePoisonedData,\n             ticket.perfRecorder,\n@@ -1175,4 +1178,20 @@ class NotifyingProgramDriverWrapper implements ProgramDriver {\n     this.delegate.updateFiles(contents, updateMode);\n     this.notifyNewProgram(this.delegate.getProgram());\n   }\n+\n+  getSourceFileVersion = this.delegate.getSourceFileVersion?.bind(this);\n }\n+\n+function versionMapFromProgram(\n+    program: ts.Program, driver: ProgramDriver): Map<AbsoluteFsPath, string>|null {\n+  if (driver.getSourceFileVersion === undefined) {\n+    return null;\n+  }\n+\n+  const versions = new Map<AbsoluteFsPath, string>();\n+  for (const possiblyRedirectedSourceFile of program.getSourceFiles()) {\n+    const sf = toUnredirectedSourceFile(possiblyRedirectedSourceFile);\n+    versions.set(absoluteFromSourceFile(sf), driver.getSourceFileVersion(sf));\n+  }\n+  return versions;\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "e0ef06c46375072875fa8a1697622e873ecccc94",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/incremental.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 11,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fincremental.ts",
            "raw_url": "https://github.com/angular/angular/raw/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fincremental.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fincremental.ts?ref=dee95994b8e5def7c7880038d64968da93fc04b4",
            "patch": "@@ -76,7 +76,7 @@ export class IncrementalCompilation implements IncrementalBuild<ClassRecord, Fil\n \n   private constructor(\n       state: IncrementalState, readonly depGraph: FileDependencyGraph,\n-      private step: IncrementalStep|null) {\n+      private versions: Map<AbsoluteFsPath, string>|null, private step: IncrementalStep|null) {\n     this._state = state;\n \n     // The compilation begins in analysis phase.\n@@ -90,26 +90,29 @@ export class IncrementalCompilation implements IncrementalBuild<ClassRecord, Fil\n   /**\n    * Begin a fresh `IncrementalCompilation`.\n    */\n-  static fresh(program: ts.Program): IncrementalCompilation {\n+  static fresh(program: ts.Program, versions: Map<AbsoluteFsPath, string>|null):\n+      IncrementalCompilation {\n     const state: IncrementalState = {\n       kind: IncrementalStateKind.Fresh,\n     };\n-    return new IncrementalCompilation(state, new FileDependencyGraph(), /* reuse */ null);\n+    return new IncrementalCompilation(state, new FileDependencyGraph(), versions, /* reuse */ null);\n   }\n \n   static incremental(\n-      program: ts.Program, oldProgram: ts.Program, oldState: IncrementalState,\n-      modifiedResourceFiles: Set<AbsoluteFsPath>|null, perf: PerfRecorder): IncrementalCompilation {\n+      program: ts.Program, newVersions: Map<AbsoluteFsPath, string>|null, oldProgram: ts.Program,\n+      oldState: IncrementalState, modifiedResourceFiles: Set<AbsoluteFsPath>|null,\n+      perf: PerfRecorder): IncrementalCompilation {\n     return perf.inPhase(PerfPhase.Reconciliation, () => {\n-      let priorAnalysis: AnalyzedIncrementalState;\n       const physicallyChangedTsFiles = new Set<AbsoluteFsPath>();\n       const changedResourceFiles = new Set<AbsoluteFsPath>(modifiedResourceFiles ?? []);\n \n+\n+      let priorAnalysis: AnalyzedIncrementalState;\n       switch (oldState.kind) {\n         case IncrementalStateKind.Fresh:\n           // Since this line of program has never been successfully analyzed to begin with, treat\n           // this as a fresh compilation.\n-          return IncrementalCompilation.fresh(program);\n+          return IncrementalCompilation.fresh(program, newVersions);\n         case IncrementalStateKind.Analyzed:\n           // The most recent program was analyzed successfully, so we can use that as our prior\n           // state and don't need to consider any other deltas except changes in the most recent\n@@ -129,6 +132,8 @@ export class IncrementalCompilation implements IncrementalBuild<ClassRecord, Fil\n           break;\n       }\n \n+      const oldVersions = priorAnalysis.versions;\n+\n       const oldFilesArray = oldProgram.getSourceFiles().map(sf => toUnredirectedSourceFile(sf));\n       const oldFiles = new Set(oldFilesArray);\n       const deletedTsFiles = new Set(oldFilesArray.map(sf => absoluteFromSourceFile(sf)));\n@@ -141,14 +146,31 @@ export class IncrementalCompilation implements IncrementalBuild<ClassRecord, Fil\n         deletedTsFiles.delete(sfPath);\n \n         if (oldFiles.has(sf)) {\n-          // This file hasn't changed.\n-          continue;\n+          // This source file has the same object identity as in the previous program. We need to\n+          // determine if it's really the same file, or if it might have changed versions since the\n+          // last program without changing its identity.\n+\n+          // If there's no version information available, then this is the same file, and we can\n+          // skip it.\n+          if (oldVersions === null || newVersions === null) {\n+            continue;\n+          }\n+\n+          // If a version is available for the file from both the prior and the current program, and\n+          // that version is the same, then this is the same file, and we can skip it.\n+          if (oldVersions.has(sfPath) && newVersions.has(sfPath) &&\n+              oldVersions.get(sfPath)! === newVersions.get(sfPath)!) {\n+            continue;\n+          }\n+\n+          // Otherwise, assume that the file has changed. Either its versions didn't match, or we\n+          // were missing version information about it on one side for some reason.\n         }\n \n         // Bail out if a .d.ts file changes - the semantic dep graph is not able to process such\n         // changes correctly yet.\n         if (sf.isDeclarationFile) {\n-          return IncrementalCompilation.fresh(program);\n+          return IncrementalCompilation.fresh(program, newVersions);\n         }\n \n         // The file has changed physically, so record it.\n@@ -182,7 +204,7 @@ export class IncrementalCompilation implements IncrementalBuild<ClassRecord, Fil\n         lastAnalyzedState: priorAnalysis,\n       };\n \n-      return new IncrementalCompilation(state, depGraph, {\n+      return new IncrementalCompilation(state, depGraph, newVersions, {\n         priorState: priorAnalysis,\n         logicallyChangedTsFiles,\n       });\n@@ -234,6 +256,7 @@ export class IncrementalCompilation implements IncrementalBuild<ClassRecord, Fil\n     // could use this state as a starting point.\n     this._state = {\n       kind: IncrementalStateKind.Analyzed,\n+      versions: this.versions,\n       depGraph: this.depGraph,\n       semanticDepGraph: newGraph,\n       traitCompiler,"
        },
        {
            "sha": "bda9a28527a09afda0f2ca1fca8ab2390a3f9881",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/state.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts",
            "raw_url": "https://github.com/angular/angular/raw/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts?ref=dee95994b8e5def7c7880038d64968da93fc04b4",
            "patch": "@@ -66,6 +66,11 @@ export interface AnalyzedIncrementalState {\n    * carried forward from a prior one.\n    */\n   emitted: Set<AbsoluteFsPath>;\n+\n+  /**\n+   * Map of source file paths to the version of this file as seen in the compilation.\n+   */\n+  versions: Map<AbsoluteFsPath, string>|null;\n }\n \n /**"
        },
        {
            "sha": "333aff06051119487047d9a7451e7b7e8c3ebd46",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/test/BUILD.bazel",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2FBUILD.bazel?ref=dee95994b8e5def7c7880038d64968da93fc04b4",
            "patch": "@@ -0,0 +1,29 @@\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"ts_library\")\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+ts_library(\n+    name = \"test_lib\",\n+    testonly = True,\n+    srcs = glob([\n+        \"**/*.ts\",\n+    ]),\n+    deps = [\n+        \"//packages:types\",\n+        \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/incremental\",\n+        \"//packages/compiler-cli/src/ngtsc/perf\",\n+        \"//packages/compiler-cli/src/ngtsc/testing\",\n+        \"@npm//typescript\",\n+    ],\n+)\n+\n+jasmine_node_test(\n+    name = \"test\",\n+    bootstrap = [\"//tools/testing:node_no_angular_es5\"],\n+    deps = [\n+        \":test_lib\",\n+    ],\n+)"
        },
        {
            "sha": "cd2b92676fce1cda948a8a79f61a6737fcf7ce8d",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/test/incremental_spec.ts",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2Fincremental_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2Fincremental_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2Fincremental_spec.ts?ref=dee95994b8e5def7c7880038d64968da93fc04b4",
            "patch": "@@ -0,0 +1,41 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {absoluteFrom, getSourceFileOrError} from '../../file_system';\n+import {runInEachFileSystem} from '../../file_system/testing';\n+import {NOOP_PERF_RECORDER} from '../../perf';\n+import {makeProgram} from '../../testing';\n+import {IncrementalCompilation} from '../src/incremental';\n+\n+runInEachFileSystem(() => {\n+  describe('incremental reconciliation', () => {\n+    it('should treat source files with changed versions as changed', () => {\n+      const FOO_PATH = absoluteFrom('/foo.ts');\n+      const {program} = makeProgram([\n+        {name: FOO_PATH, contents: `export const FOO = true;`},\n+      ]);\n+      const fooSf = getSourceFileOrError(program, FOO_PATH);\n+\n+      const versionMapFirst = new Map([[FOO_PATH, 'version.1']]);\n+      const firstCompilation = IncrementalCompilation.fresh(\n+          program,\n+          versionMapFirst,\n+      );\n+      firstCompilation.recordSuccessfulAnalysis(null!);\n+      firstCompilation.recordSuccessfulEmit(fooSf);\n+\n+      const versionMapSecond = new Map([[FOO_PATH, 'version.2']]);\n+      const secondCompilation = IncrementalCompilation.incremental(\n+          program, versionMapSecond, program, firstCompilation.state, new Set(),\n+          NOOP_PERF_RECORDER);\n+\n+      secondCompilation.recordSuccessfulAnalysis(null!);\n+      expect(secondCompilation.safeToSkipEmit(fooSf)).toBeFalse();\n+    });\n+  });\n+});\n\\ No newline at end of file"
        },
        {
            "sha": "a2a0989bd3b6590da527e2d0aa04947919421281",
            "filename": "packages/compiler-cli/src/ngtsc/program_driver/src/api.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/dee95994b8e5def7c7880038d64968da93fc04b4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fapi.ts?ref=dee95994b8e5def7c7880038d64968da93fc04b4",
            "patch": "@@ -26,6 +26,17 @@ export interface ProgramDriver {\n    * included in the type-checking program.\n    */\n   updateFiles(contents: Map<AbsoluteFsPath, string>, updateMode: UpdateMode): void;\n+\n+  /**\n+   * Retrieve a string version for a given `ts.SourceFile`, which much change when the contents of\n+   * the file have changed.\n+   *\n+   * If this method is present, the compiler will use these versions in addition to object identity\n+   * for `ts.SourceFile`s to determine what's changed between two incremental programs. This is\n+   * valuable for some clients (such as the Language Service) that treat `ts.SourceFile`s as mutable\n+   * objects.\n+   */\n+  getSourceFileVersion?(sf: ts.SourceFile): string;\n }\n \n export enum UpdateMode {"
        }
    ],
    "stats": {
        "total": 160,
        "additions": 144,
        "deletions": 16
    }
}