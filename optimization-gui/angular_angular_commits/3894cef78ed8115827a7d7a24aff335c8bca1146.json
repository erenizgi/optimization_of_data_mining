{
    "author": "gkalpak",
    "message": "refactor(docs-infra): add `name` and `type` to deployment info (#43963)\n\nThis commit adds two new properties, `name` and `type`, to deployment\ninfo data. This will make it easier to differentiate between deployment\ntargets (e.g. primary vs secondary) and will provide more informative\nlog messages.\n\nIn a subsequent commit, this new data can be used to validate the\ncomputed deployments list.\n\nPR Close #43963",
    "sha": "3894cef78ed8115827a7d7a24aff335c8bca1146",
    "files": [
        {
            "sha": "7b4f2d01e9ded3c72ba1621fed0c96dea927169a",
            "filename": "aio/scripts/deploy-to-firebase/index.js",
            "status": "modified",
            "additions": 40,
            "deletions": 14,
            "changes": 54,
            "blob_url": "https://github.com/angular/angular/blob/3894cef78ed8115827a7d7a24aff335c8bca1146/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.js",
            "raw_url": "https://github.com/angular/angular/raw/3894cef78ed8115827a7d7a24aff335c8bca1146/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.js?ref=3894cef78ed8115827a7d7a24aff335c8bca1146",
            "patch": "@@ -30,14 +30,13 @@ if (require.main === module) {\n   const deploymentsInfo = computeDeploymentsInfo(inputVars);\n   const totalDeployments = deploymentsInfo.length;\n \n-  console.log(`Total deployments: ${totalDeployments}`);\n+  console.log(`Deployments (${totalDeployments}): ${listDeployTargetNames(deploymentsInfo)}`);\n \n   deploymentsInfo.forEach((deploymentInfo, idx) => {\n-    console.log(\n-        `\\n\\n\\nDeployment ${idx + 1} of ${totalDeployments}\\n` +\n-        '-----------------');\n+    const logLine1 = `Deployment ${idx + 1} of ${totalDeployments}: ${deploymentInfo.name}`;\n+    console.log(`\\n\\n\\n${logLine1}\\n${'-'.repeat(logLine1.length)}`);\n \n-    if (deploymentInfo.skipped) {\n+    if (deploymentInfo.type === 'skipped') {\n       console.log(deploymentInfo.reason);\n     } else {\n       console.log(\n@@ -99,7 +98,14 @@ function computeDeploymentsInfo(\n   // The deployment mode is computed based on the branch we are building.\n   const currentBranchMajorVersion = computeMajorVersion(currentBranch);\n   const deploymentInfoPerTarget = {\n+    // PRIMARY DEPLOY TARGETS\n+    //\n+    // These targets are responsible for building the app (and setting the theme/mode).\n+    // Unless deployment is skipped, exactly one primary target should be used at a time and it\n+    // should be the first item of the returned deploy target list.\n     next: {\n+      name: 'next',\n+      type: 'primary',\n       deployEnv: 'next',\n       projectId: 'angular-io',\n       siteId: 'next-angular-io-site',\n@@ -108,6 +114,8 @@ function computeDeploymentsInfo(\n       postDeployActions: [testPwaScore],\n     },\n     rc: {\n+      name: 'rc',\n+      type: 'primary',\n       deployEnv: 'rc',\n       projectId: 'angular-io',\n       siteId: 'rc-angular-io-site',\n@@ -116,32 +124,46 @@ function computeDeploymentsInfo(\n       postDeployActions: [testPwaScore],\n     },\n     stable: {\n+      name: 'stable',\n+      type: 'primary',\n       deployEnv: 'stable',\n       projectId: 'angular-io',\n       siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n       deployedUrl: 'https://angular.io/',\n       preDeployActions: [build, checkPayloadSize],\n       postDeployActions: [testPwaScore],\n     },\n+    archive: {\n+      name: 'archive',\n+      type: 'primary',\n+      deployEnv: 'archive',\n+      projectId: 'angular-io',\n+      siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n+      deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n+      preDeployActions: [build, checkPayloadSize],\n+      postDeployActions: [testPwaScore],\n+    },\n+\n+    // SECONDARY DEPLOY TARGETS\n+    //\n+    // These targets can be used to re-deploy the build artifacts from a primary target (potentially\n+    // with small tweaks) to a different project/site.\n+    // Unless deployment is skipped, zero or more secondary targets can be used at a time, but they\n+    // should all match the primary target's `deployEnv`.\n+\n     // Config for deploying the stable build to the RC Firebase site when there is no active RC.\n     // See https://github.com/angular/angular/issues/39760 for more info on the purpose of this\n     // special deployment.\n     noActiveRc: {\n+      name: 'stableNoActiveRc',\n+      type: 'secondary',\n       deployEnv: 'stable',\n       projectId: 'angular-io',\n       siteId: 'rc-angular-io-site',\n       deployedUrl: 'https://rc.angular.io/',\n       preDeployActions: [removeServiceWorker, redirectToAngularIo],\n       postDeployActions: [testNoActiveRcDeployment],\n     },\n-    archive: {\n-      deployEnv: 'archive',\n-      projectId: 'angular-io',\n-      siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n-      deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n-      preDeployActions: [build, checkPayloadSize],\n-      postDeployActions: [testPwaScore],\n-    },\n   };\n \n   // If the current branch is `master`, deploy as `next`.\n@@ -301,6 +323,10 @@ function getLatestCommit(branchName, options = undefined) {\n   return getRemoteRefs(branchName, options)[0].slice(0, 40);\n }\n \n+function listDeployTargetNames(deploymentsList) {\n+  return deploymentsList.map(({name = '<no name>'}) => name).join(', ') || '-';\n+}\n+\n function redirectToAngularIo() {\n   // Update the Firebase hosting configuration redirect all non-file requests (i.e. requests that do\n   // not contain a dot in their last path segment) to `angular.io`.\n@@ -321,7 +347,7 @@ function serializeActions(actions) {\n }\n \n function skipDeployment(reason) {\n-  return {reason, skipped: true};\n+  return {name: 'skipped', type: 'skipped', reason};\n }\n \n function testNoActiveRcDeployment({deployedUrl}) {"
        },
        {
            "sha": "1e0fe765694c8744032ae91a96b24925db44eefe",
            "filename": "aio/scripts/deploy-to-firebase/index.spec.js",
            "status": "modified",
            "additions": 43,
            "deletions": 15,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/3894cef78ed8115827a7d7a24aff335c8bca1146/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/3894cef78ed8115827a7d7a24aff335c8bca1146/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.js?ref=3894cef78ed8115827a7d7a24aff335c8bca1146",
            "patch": "@@ -38,7 +38,8 @@ describe('deploy-to-firebase:', () => {\n       CI_REPO_NAME: 'notangular',\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason: 'Skipping deploy because this is not angular/angular.',\n       },\n     ]);\n@@ -50,7 +51,8 @@ describe('deploy-to-firebase:', () => {\n       CI_REPO_NAME: 'angular',\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason: 'Skipping deploy because this is not angular/angular.',\n       },\n     ]);\n@@ -63,7 +65,8 @@ describe('deploy-to-firebase:', () => {\n       CI_PULL_REQUEST: 'true',\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason: 'Skipping deploy because this is a PR build.',\n       },\n     ]);\n@@ -78,6 +81,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits.master,\n     })).toEqual([\n       {\n+        name: 'next',\n+        type: 'primary',\n         deployEnv: 'next',\n         projectId: 'angular-io',\n         siteId: 'next-angular-io-site',\n@@ -97,7 +102,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason:\n             'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n             `(${latestCommits.master}).`,\n@@ -115,6 +121,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits['4.3.x'],\n     })).toEqual([\n       {\n+        name: 'stable',\n+        type: 'primary',\n         deployEnv: 'stable',\n         projectId: 'angular-io',\n         siteId: 'v4-angular-io-site',\n@@ -135,6 +143,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits[mostRecentMinorBranch],\n     })).toEqual([\n       {\n+        name: 'stable',\n+        type: 'primary',\n         deployEnv: 'stable',\n         projectId: 'angular-io',\n         siteId: `v${computeMajorVersion(mostRecentMinorBranch)}-angular-io-site`,\n@@ -143,6 +153,8 @@ describe('deploy-to-firebase:', () => {\n         postDeployActions: ['function:testPwaScore'],\n       },\n       {\n+        name: 'stableNoActiveRc',\n+        type: 'secondary',\n         deployEnv: 'stable',\n         projectId: 'angular-io',\n         siteId: 'rc-angular-io-site',\n@@ -163,7 +175,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason:\n             'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n             `(${latestCommits['4.3.x']}).`,\n@@ -181,6 +194,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits['2.4.x'],\n     })).toEqual([\n       {\n+        name: 'archive',\n+        type: 'primary',\n         deployEnv: 'archive',\n         projectId: 'angular-io',\n         siteId: 'v2-angular-io-site',\n@@ -203,6 +218,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits['9.1.x'],\n     })).toEqual([\n       {\n+        name: 'archive',\n+        type: 'primary',\n         deployEnv: 'archive',\n         projectId: 'angular-io',\n         siteId: 'v9-angular-io-site',\n@@ -223,7 +240,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason:\n             'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n             `(${latestCommits['2.4.x']}).`,\n@@ -241,7 +259,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits['2.1.x'],\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason:\n             'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n             'There is a more recent branch with the same major version: \"2.4.x\"',\n@@ -259,7 +278,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits['2.1.x'],\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason:\n             'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n             'There is a more recent branch with the same major version: \"2.4.x\"',\n@@ -277,6 +297,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits[mostRecentMinorBranch],\n     })).toEqual([\n       {\n+        name: 'rc',\n+        type: 'primary',\n         deployEnv: 'rc',\n         projectId: 'angular-io',\n         siteId: 'rc-angular-io-site',\n@@ -304,6 +326,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits[mostRecentMinorBranch],\n     })).toEqual([\n       {\n+        name: 'rc',\n+        type: 'primary',\n         deployEnv: 'rc',\n         projectId: 'angular-io',\n         siteId: 'rc-angular-io-site',\n@@ -324,7 +348,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason:\n             'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n             `(${latestCommits[mostRecentMinorBranch]}).`,\n@@ -342,7 +367,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits['2.1.x'],\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason:\n             'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n             'There is a more recent branch with the same major version: \"2.4.x\"',\n@@ -360,7 +386,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits['4.3.x'],\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason:\n             'Skipping deploy of branch \"4.3.x\" to Firebase.\\n' +\n             'There is a more recent branch with the same major version: \"4.4.x\"',\n@@ -378,7 +405,8 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: latestCommits['4.4.x'],\n     })).toEqual([\n       {\n-        skipped: true,\n+        name: 'skipped',\n+        type: 'skipped',\n         reason:\n             'Skipping deploy of branch \"4.4.x\" to Firebase.\\n' +\n             'This branch has an equal or higher major version than the stable branch (\"2.4.x\") ' +\n@@ -403,12 +431,12 @@ describe('deploy-to-firebase:', () => {\n     };\n     const result = execSync(cmd, {encoding: 'utf8', env}).trim();\n     expect(result).toBe(\n-        'Total deployments: 1\\n' +\n+        'Deployments (1): next\\n' +\n         '\\n' +\n         '\\n' +\n         '\\n' +\n-        'Deployment 1 of 1\\n' +\n-        '-----------------\\n' +\n+        'Deployment 1 of 1: next\\n' +\n+        '-----------------------\\n' +\n         'Git branch          : master\\n' +\n         `Git commit          : ${latestCommitOnMaster}\\n` +\n         'Build/deploy mode   : next\\n' +"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 83,
        "deletions": 29
    }
}