{
    "author": "crisbeto",
    "message": "fix(compiler): incorrectly inferring content type of SVG-specific title tag (#40259)\n\nThe parser has a list of tag definitions that it uses when parsing the template. Each tag has a\n`contentType` which tells the parser what kind of content the tag should contain. The problem is\nthat the browser has two separate `title` tags (`HTMLTitleElement` and `SVGTitleElement`) and each\nof them has to have a different `contentType`, otherwise the parser will throw an error further down\nthe pipeline.\n\nThese changes update the tag definitions so that each tag name can have multiple content types\nassociated with it and the correct one can be returned based on the element's prefix.\n\nFixes #31503.\n\nPR Close #40259",
    "sha": "66c27ffdfc0e4f0a37a375a453d368c8ef13e326",
    "files": [
        {
            "sha": "ed827dcb3d545ed7716e922ac97969defa7c5e71",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=66c27ffdfc0e4f0a37a375a453d368c8ef13e326",
            "patch": "@@ -4312,6 +4312,29 @@ runInEachFileSystem(os => {\n       expect(jsContents).toMatch(setClassMetadataRegExp('type: i1.Other'));\n     });\n \n+    it('should not throw when using an SVG-specific `title` tag', () => {\n+      env.write('test.ts', `\n+        import {Component, NgModule} from '@angular/core';\n+        @Component({\n+          template: \\`\n+            <svg>\n+              <rect>\n+                <svg:title>I'm a title tag</svg:title>\n+              </rect>\n+            </svg>\n+          \\`,\n+        })\n+        export class SvgCmp {}\n+        @NgModule({\n+          declarations: [SvgCmp],\n+        })\n+        export class SvgModule {}\n+      `);\n+\n+      const diags = env.driveDiagnostics();\n+      expect(diags.length).toBe(0);\n+    });\n+\n     describe('namespace support', () => {\n       it('should generate correct imports for type references to namespaced symbols using a namespace import',\n          () => {"
        },
        {
            "sha": "ffde2b76792f4fede8d1fc4c98370d3bd56f2600",
            "filename": "packages/compiler/src/ml_parser/html_tags.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 3,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fhtml_tags.ts",
            "raw_url": "https://github.com/angular/angular/raw/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fhtml_tags.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fhtml_tags.ts?ref=66c27ffdfc0e4f0a37a375a453d368c8ef13e326",
            "patch": "@@ -10,10 +10,11 @@ import {TagContentType, TagDefinition} from './tags';\n \n export class HtmlTagDefinition implements TagDefinition {\n   private closedByChildren: {[key: string]: boolean} = {};\n+  private contentType: TagContentType|\n+      {default: TagContentType, [namespace: string]: TagContentType};\n \n   closedByParent: boolean = false;\n   implicitNamespacePrefix: string|null;\n-  contentType: TagContentType;\n   isVoid: boolean;\n   ignoreFirstLf: boolean;\n   canSelfClose: boolean = false;\n@@ -31,7 +32,7 @@ export class HtmlTagDefinition implements TagDefinition {\n     closedByChildren?: string[],\n     closedByParent?: boolean,\n     implicitNamespacePrefix?: string,\n-    contentType?: TagContentType,\n+    contentType?: TagContentType|{default: TagContentType, [namespace: string]: TagContentType},\n     isVoid?: boolean,\n     ignoreFirstLf?: boolean,\n     preventNamespaceInheritance?: boolean\n@@ -50,6 +51,14 @@ export class HtmlTagDefinition implements TagDefinition {\n   isClosedByChild(name: string): boolean {\n     return this.isVoid || name.toLowerCase() in this.closedByChildren;\n   }\n+\n+  getContentType(prefix?: string): TagContentType {\n+    if (typeof this.contentType === 'object') {\n+      const overrideType = prefix == null ? undefined : this.contentType[prefix];\n+      return overrideType ?? this.contentType.default;\n+    }\n+    return this.contentType;\n+  }\n }\n \n let _DEFAULT_TAG_DEFINITION!: HtmlTagDefinition;\n@@ -121,7 +130,11 @@ export function getHtmlTagDefinition(tagName: string): HtmlTagDefinition {\n       'listing': new HtmlTagDefinition({ignoreFirstLf: true}),\n       'style': new HtmlTagDefinition({contentType: TagContentType.RAW_TEXT}),\n       'script': new HtmlTagDefinition({contentType: TagContentType.RAW_TEXT}),\n-      'title': new HtmlTagDefinition({contentType: TagContentType.ESCAPABLE_RAW_TEXT}),\n+      'title': new HtmlTagDefinition({\n+        // The browser supports two separate `title` tags which have to use\n+        // a different content type: `HTMLTitleElement` and `SVGTitleElement`\n+        contentType: {default: TagContentType.ESCAPABLE_RAW_TEXT, svg: TagContentType.PARSABLE_DATA}\n+      }),\n       'textarea': new HtmlTagDefinition(\n           {contentType: TagContentType.ESCAPABLE_RAW_TEXT, ignoreFirstLf: true}),\n     };"
        },
        {
            "sha": "09d976a7b5a19a7d71f172fff0177b5515bd4e4f",
            "filename": "packages/compiler/src/ml_parser/lexer.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts",
            "raw_url": "https://github.com/angular/angular/raw/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts?ref=66c27ffdfc0e4f0a37a375a453d368c8ef13e326",
            "patch": "@@ -550,7 +550,7 @@ class _Tokenizer {\n       throw e;\n     }\n \n-    const contentTokenType = this._getTagDefinition(tagName).contentType;\n+    const contentTokenType = this._getTagDefinition(tagName).getContentType(prefix);\n \n     if (contentTokenType === TagContentType.RAW_TEXT) {\n       this._consumeRawTextWithTagClose(prefix, tagName, false);\n@@ -560,7 +560,7 @@ class _Tokenizer {\n   }\n \n   private _consumeRawTextWithTagClose(prefix: string, tagName: string, decodeEntities: boolean) {\n-    const textToken = this._consumeRawText(decodeEntities, () => {\n+    this._consumeRawText(decodeEntities, () => {\n       if (!this._attemptCharCode(chars.$LT)) return false;\n       if (!this._attemptCharCode(chars.$SLASH)) return false;\n       this._attemptCharCodeUntilFn(isNotWhitespace);"
        },
        {
            "sha": "8c2f4a65fcb76d0c710e0d9ef30a24fca7455082",
            "filename": "packages/compiler/src/ml_parser/tags.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler%2Fsrc%2Fml_parser%2Ftags.ts",
            "raw_url": "https://github.com/angular/angular/raw/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler%2Fsrc%2Fml_parser%2Ftags.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Ftags.ts?ref=66c27ffdfc0e4f0a37a375a453d368c8ef13e326",
            "patch": "@@ -15,13 +15,13 @@ export enum TagContentType {\n export interface TagDefinition {\n   closedByParent: boolean;\n   implicitNamespacePrefix: string|null;\n-  contentType: TagContentType;\n   isVoid: boolean;\n   ignoreFirstLf: boolean;\n   canSelfClose: boolean;\n   preventNamespaceInheritance: boolean;\n \n   isClosedByChild(name: string): boolean;\n+  getContentType(prefix?: string): TagContentType;\n }\n \n export function splitNsName(elementName: string): [string|null, string] {"
        },
        {
            "sha": "d36bf684d67a2f433b03bea4e439b90b47b17636",
            "filename": "packages/compiler/src/ml_parser/xml_tags.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fxml_tags.ts",
            "raw_url": "https://github.com/angular/angular/raw/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fxml_tags.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Fxml_tags.ts?ref=66c27ffdfc0e4f0a37a375a453d368c8ef13e326",
            "patch": "@@ -16,7 +16,6 @@ export class XmlTagDefinition implements TagDefinition {\n   parentToAdd!: string;\n   // TODO(issue/24571): remove '!'.\n   implicitNamespacePrefix!: string;\n-  contentType: TagContentType = TagContentType.PARSABLE_DATA;\n   isVoid: boolean = false;\n   ignoreFirstLf: boolean = false;\n   canSelfClose: boolean = true;\n@@ -29,6 +28,10 @@ export class XmlTagDefinition implements TagDefinition {\n   isClosedByChild(name: string): boolean {\n     return false;\n   }\n+\n+  getContentType(): TagContentType {\n+    return TagContentType.PARSABLE_DATA;\n+  }\n }\n \n const _TAG_DEFINITION = new XmlTagDefinition();"
        },
        {
            "sha": "179b49f01d24206d49ec3c1bb14b25e923622038",
            "filename": "packages/compiler/test/ml_parser/lexer_spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts?ref=66c27ffdfc0e4f0a37a375a453d368c8ef13e326",
            "patch": "@@ -789,6 +789,31 @@ import {ParseLocation, ParseSourceFile, ParseSourceSpan} from '../../src/parse_u\n       });\n     });\n \n+    describe('parsable data', () => {\n+      it('should parse an SVG <title> tag', () => {\n+        expect(tokenizeAndHumanizeParts(`<svg:title>test</svg:title>`)).toEqual([\n+          [lex.TokenType.TAG_OPEN_START, 'svg', 'title'],\n+          [lex.TokenType.TAG_OPEN_END],\n+          [lex.TokenType.TEXT, 'test'],\n+          [lex.TokenType.TAG_CLOSE, 'svg', 'title'],\n+          [lex.TokenType.EOF],\n+        ]);\n+      });\n+\n+      it('should parse an SVG <title> tag with children', () => {\n+        expect(tokenizeAndHumanizeParts(`<svg:title><f>test</f></svg:title>`)).toEqual([\n+          [lex.TokenType.TAG_OPEN_START, 'svg', 'title'],\n+          [lex.TokenType.TAG_OPEN_END],\n+          [lex.TokenType.TAG_OPEN_START, '', 'f'],\n+          [lex.TokenType.TAG_OPEN_END],\n+          [lex.TokenType.TEXT, 'test'],\n+          [lex.TokenType.TAG_CLOSE, '', 'f'],\n+          [lex.TokenType.TAG_CLOSE, 'svg', 'title'],\n+          [lex.TokenType.EOF],\n+        ]);\n+      });\n+    });\n+\n     describe('expansion forms', () => {\n       it('should parse an expansion form', () => {\n         expect("
        },
        {
            "sha": "97077bb6b5faab4ac6ebbea20f62012b46216a38",
            "filename": "packages/language-service/src/completions.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Flanguage-service%2Fsrc%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/66c27ffdfc0e4f0a37a375a453d368c8ef13e326/packages%2Flanguage-service%2Fsrc%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fcompletions.ts?ref=66c27ffdfc0e4f0a37a375a453d368c8ef13e326",
            "patch": "@@ -196,7 +196,7 @@ class HtmlVisitor implements Visitor {\n     // any test cases for it.\n     const element = this.htmlPath.first(Element);\n     if (element &&\n-        getHtmlTagDefinition(element.name).contentType !== TagContentType.PARSABLE_DATA) {\n+        getHtmlTagDefinition(element.name).getContentType() !== TagContentType.PARSABLE_DATA) {\n       return [];\n     }\n     // This is to account for cases like <h1> <a> text | </h1> where the"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 72,
        "deletions": 8
    }
}