{
    "author": "gkalpak",
    "message": "fix(ngcc): correctly resolve UMD dependencies (#44381)\n\nPreviously, when processing UMD, ngcc assumed that the `exports`\nargument of the CommonJS factory call (if present) would be the first\nargument of the call. This is generally true for the supported UMD\nformats, but can change if ngcc prepends more imports (and thus factory\narguments) while processing the module. This could lead to errors when\ntrying to collect dependencies of an already processed module.\n(This was accidentally broken in #44245 (commit 2bc3522e167).)\n\nThis commit fixes it by not making any assumptions about the position of\nan `exports` argument in the CommonJS factory call.\n\nFixes #44380\n\nPR Close #44381",
    "sha": "41265919aa90415911169057ef016e2f9b78aafd",
    "files": [
        {
            "sha": "c48b191c6db9461960f1947d2fbcd326d929762b",
            "filename": "packages/compiler-cli/ngcc/src/host/umd_host.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 22,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/41265919aa90415911169057ef016e2f9b78aafd/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/41265919aa90415911169057ef016e2f9b78aafd/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts?ref=41265919aa90415911169057ef016e2f9b78aafd",
            "patch": "@@ -835,17 +835,22 @@ function isTypeOf(node: ts.Expression, ...types: string[]): boolean {\n export function getImportsOfUmdModule(umdModule: UmdModule):\n     {parameter: ts.ParameterDeclaration, path: string}[] {\n   const imports: {parameter: ts.ParameterDeclaration, path: string}[] = [];\n-  const cjsFactoryCall = umdModule.factoryCalls.cjsCallForImports;\n-\n-  // Some UMD formats pass `exports` as the first argument to the factory call, while others don't.\n-  // Compute the index at which the dependencies start (i.e. the index of the first `require` call).\n-  const depStartIndex = cjsFactoryCall.arguments.findIndex(arg => isRequireCall(arg));\n-\n-  if (depStartIndex !== -1) {\n-    for (let i = depStartIndex; i < umdModule.factoryFn.parameters.length; i++) {\n+  const factoryFnParams = umdModule.factoryFn.parameters;\n+  const cjsFactoryCallArgs = umdModule.factoryCalls.cjsCallForImports.arguments;\n+\n+  for (let i = 0; i < factoryFnParams.length; i++) {\n+    const arg = cjsFactoryCallArgs[i];\n+\n+    // In some UMD formats, the CommonJS factory call may include arguments that are not `require()`\n+    // calls (such as an `exports` argument). Also, since a previous ngcc invocation may have added\n+    // new imports (and thus new `require()` call arguments), these non-`require()` arguments can be\n+    // interspersed among the `require()` calls.\n+    // To remain robust against various UMD formats, we ignore arguments that are not `require()`\n+    // calls when looking for imports.\n+    if (arg !== undefined && isRequireCall(arg)) {\n       imports.push({\n-        parameter: umdModule.factoryFn.parameters[i],\n-        path: getRequiredModulePath(cjsFactoryCall, i),\n+        parameter: factoryFnParams[i],\n+        path: arg.arguments[0].text,\n       });\n     }\n   }\n@@ -872,18 +877,6 @@ interface UmdConditionalFactoryCall {\n   factoryCall: ts.CallExpression;\n }\n \n-function getRequiredModulePath(cjsFactoryCall: ts.CallExpression, paramIndex: number): string {\n-  const requireCall = cjsFactoryCall.arguments[paramIndex];\n-\n-  if (requireCall !== undefined && !isRequireCall(requireCall)) {\n-    throw new Error(\n-        `Argument at index ${paramIndex} of UMD factory call is not a \\`require\\` call with a ` +\n-        'single string argument:\\n' + cjsFactoryCall.getText());\n-  }\n-\n-  return requireCall.arguments[0].text;\n-}\n-\n /**\n  * Is the `node` an identifier with the name \"exports\"?\n  */"
        },
        {
            "sha": "c30b5e04a7143c2a3e884ca8ed62900e0ee4e4a8",
            "filename": "packages/compiler-cli/ngcc/test/dependencies/umd_dependency_host_spec.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 3,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/41265919aa90415911169057ef016e2f9b78aafd/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/41265919aa90415911169057ef016e2f9b78aafd/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fdependencies%2Fumd_dependency_host_spec.ts?ref=41265919aa90415911169057ef016e2f9b78aafd",
            "patch": "@@ -13,7 +13,7 @@ import {loadTestFiles} from '../../../src/ngtsc/testing';\n import {createDependencyInfo} from '../../src/dependencies/dependency_host';\n import {ModuleResolver} from '../../src/dependencies/module_resolver';\n import {UmdDependencyHost} from '../../src/dependencies/umd_dependency_host';\n-import {testForEachUmdFormat} from '../helpers/umd_utils';\n+import {AdditionalFormatOptions, testForEachUmdFormat} from '../helpers/umd_utils';\n \n runInEachFileSystem(() => {\n   describe(\n@@ -57,6 +57,17 @@ runInEachFileSystem(() => {\n             expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n           });\n \n+          it('should resolve imports preceeding the `exports` parameter', () => {\n+            const {dependencies, missing, deepImports} = createDependencyInfo();\n+            host.collectDependencies(\n+                _('/external/preceeding/index.js'), {dependencies, missing, deepImports});\n+            expect(dependencies.size).toBe(2);\n+            expect(missing.size).toBe(0);\n+            expect(deepImports.size).toBe(0);\n+            expect(dependencies.has(_('/node_modules/lib_1'))).toBe(true);\n+            expect(dependencies.has(_('/node_modules/lib_1/sub_1'))).toBe(true);\n+          });\n+\n           it('should resolve all the external re-exports of the source file', () => {\n             const {dependencies, missing, deepImports} = createDependencyInfo();\n             host.collectDependencies(\n@@ -195,6 +206,13 @@ runInEachFileSystem(() => {\n             },\n             {name: _('/external/imports/package.json'), contents: '{\"main\": \"./index.js\"}'},\n             {name: _('/external/imports/index.metadata.json'), contents: 'MOCK METADATA'},\n+            {\n+              name: _('/external/preceeding/index.js'),\n+              contents:\n+                  umd('imports_index', ['lib_1', 'lib_1/sub_1'], undefined, {exportsParamIndex: 1})\n+            },\n+            {name: _('/external/preceeding/package.json'), contents: '{\"main\": \"./index.js\"}'},\n+            {name: _('/external/preceeding/index.metadata.json'), contents: 'MOCK METADATA'},\n             {\n               name: _('/external/re-exports/index.js'),\n               contents: umd('imports_index', ['lib_1', 'lib_1/sub_1'], ['lib_1.X', 'lib_1sub_1.Y'])\n@@ -293,10 +311,12 @@ runInEachFileSystem(() => {\n           ]);\n         }\n \n-        function umd(moduleName: string, importPaths: string[], exportNames: string[] = []) {\n+        function umd(\n+            moduleName: string, importPaths: string[], exportNames: string[] = [],\n+            additionalOptions?: AdditionalFormatOptions) {\n           const exportStatements =\n               exportNames.map(e => `  exports.${e.replace(/.+\\./, '')} = ${e};`).join('\\n');\n-          return createUmdModule(moduleName, importPaths, exportStatements);\n+          return createUmdModule(moduleName, importPaths, exportStatements, additionalOptions);\n         }\n       }));\n });"
        },
        {
            "sha": "c1aafdb7e65551606ee6fc5d8f04d17cc4dfff90",
            "filename": "packages/compiler-cli/ngcc/test/helpers/umd_utils.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 7,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/41265919aa90415911169057ef016e2f9b78aafd/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Fumd_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/41265919aa90415911169057ef016e2f9b78aafd/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Fumd_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Fumd_utils.ts?ref=41265919aa90415911169057ef016e2f9b78aafd",
            "patch": "@@ -7,8 +7,33 @@\n  */\n \n export interface AdditionalFormatOptions {\n+  /**\n+   * The index of the `exports` parameter in the factory function (and thus the corresponding\n+   * argument in the various factory calls). Passing -1 will cause the `exports` parameter/argument\n+   * to be omitted altogether.\n+   * (This option only affects the `Rollup` format.)\n+   *\n+   * Defaults to `0` (i.e. `exports` being the first argument).\n+   */\n+  exportsParamIndex?: number;\n+\n+  /**\n+   * Whether to include an initializer for the `global` variable (`global = global || self`) before\n+   * the global factory call.\n+   * (This option only affects the `Rollup` format.)\n+   *\n+   * Defaults to `false` (i.e. not include an initialier for `global`).\n+   */\n   hasGlobalInitializer?: boolean;\n-  omitExports?: boolean;\n+\n+  /**\n+   * A set of dependencies that are not used in the factory function (i.e. for which factory\n+   * function parameters are omitted).\n+   * Unused dependencies must always follow used ones (if any). In other words, unused dependencies\n+   * can only appear at the end of the dependency list.\n+   *\n+   * Defaults to an empty set (i.e. all dependencies are used).\n+   */\n   unusedDependencies?: Set<String>;\n }\n \n@@ -27,7 +52,7 @@ export function createUmdModuleFactory(\n     parenthesisFormat: ParenthesisFormat = ParenthesisFormat.AroundIife) {\n   return function createUmdModule(\n       moduleName: string, dependencies: string[], factoryBody: string,\n-      {hasGlobalInitializer = false, omitExports = false, unusedDependencies = new Set()}:\n+      {exportsParamIndex = 0, hasGlobalInitializer = false, unusedDependencies = new Set()}:\n           AdditionalFormatOptions = {}) {\n     // Ensure that any unused dependencies are at the end.\n     const firstUnusedDepIndex = dependencies.findIndex(dep => unusedDependencies.has(dep));\n@@ -48,14 +73,16 @@ export function createUmdModuleFactory(\n                    .replace(/[-/](.?)/g, (_, g1) => g1.toUpperCase()));\n     const depsParamNames = dependencies.filter(dep => !unusedDependencies.has(dep))\n                                .map((dep, i) => depsIdentifiers[i].replace(/^.*\\./, ''));\n-    const maybePrepend = (item: string, arr: string[]) => omitExports ? arr : [item, ...arr];\n+    const insertItem = (item: string, arr: string[]) => (exportsParamIndex < 0) ?\n+        arr :\n+        [...arr.slice(0, exportsParamIndex), item, ...arr.slice(exportsParamIndex)];\n \n     switch (wrapperFunctionFormat) {\n       case WrapperFunctionFormat.Rollup:\n-        const cjsArgs = maybePrepend('exports', dependencies.map(d => `require('${d}')`));\n-        const amdArgs = maybePrepend('exports', dependencies).map(d => `'${d}'`);\n-        const globalArgs = maybePrepend(moduleName, depsIdentifiers).map(id => `global.${id}`);\n-        const factoryParams = maybePrepend('exports', depsParamNames);\n+        const cjsArgs = insertItem('exports', dependencies.map(d => `require('${d}')`));\n+        const amdArgs = insertItem('exports', dependencies).map(d => `'${d}'`);\n+        const globalArgs = insertItem(moduleName, depsIdentifiers).map(id => `global.${id}`);\n+        const factoryParams = insertItem('exports', depsParamNames);\n \n         wrapperFunctionDeclaration = stripIndentation(`\n           function (global, factory) {"
        },
        {
            "sha": "7bef6b92d55fcda616226f8988067e7402114585",
            "filename": "packages/compiler-cli/ngcc/test/rendering/umd_rendering_formatter_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/41265919aa90415911169057ef016e2f9b78aafd/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/41265919aa90415911169057ef016e2f9b78aafd/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts?ref=41265919aa90415911169057ef016e2f9b78aafd",
            "patch": "@@ -351,7 +351,7 @@ exports.BadIife = BadIife;\n                 factoryBody: `\n                     var index = '';\n                     return index;`,\n-                additionalOptions: {omitExports: true},\n+                additionalOptions: {exportsParamIndex: -1},\n               },\n             });\n             const {renderer, program} = setup(PROGRAM);"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 73,
        "deletions": 33
    }
}