{
    "author": "petebacondarwin",
    "message": "docs(http): add custom JSONParser example (#40645)\n\nUpdate the HTTP guide and associated example to demonstrate\nhow an interceptor can be used to provide a custom JSON parser.\n\nResolves #21079\n\nPR Close #40645",
    "sha": "529f0a83cba1d68d351b3c46a4ddfbaae3ced154",
    "files": [
        {
            "sha": "6a5e78e24d8e551f833d405e377a0504a18de834",
            "filename": "aio/content/examples/http/e2e/src/app.e2e-spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fe2e%2Fsrc%2Fapp.e2e-spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fe2e%2Fsrc%2Fapp.e2e-spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fhttp%2Fe2e%2Fsrc%2Fapp.e2e-spec.ts?ref=529f0a83cba1d68d351b3c46a4ddfbaae3ced154",
            "patch": "@@ -66,6 +66,7 @@ describe('Http Tests', () => {\n       await checkLogForMessage('GET \"assets/config.json\"');\n       expect(await page.configSpan.getText()).toContain('Heroes API URL is \"api/heroes\"');\n       expect(await page.configSpan.getText()).toContain('Textfile URL is \"assets/textfile.txt\"');\n+      expect(await page.configSpan.getText()).toContain('Date is \"Wed Jan 29 2020\" (date)');\n     });\n \n     it('can fetch the configuration JSON file with headers', async () => {"
        },
        {
            "sha": "8c2416e39eaa60635c974ba77db45ceabfc08743",
            "filename": "aio/content/examples/http/src/app/config/config.component.html",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fconfig%2Fconfig.component.html",
            "raw_url": "https://github.com/angular/angular/raw/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fconfig%2Fconfig.component.html",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fconfig%2Fconfig.component.html?ref=529f0a83cba1d68d351b3c46a4ddfbaae3ced154",
            "patch": "@@ -7,6 +7,7 @@ <h3>Get configuration from JSON file</h3>\n   <span *ngIf=\"config\">\n     <p>Heroes API URL is \"{{config.heroesUrl}}\"</p>\n     <p>Textfile URL is \"{{config.textfile}}\"</p>\n+    <p>Date is \"{{config.date.toDateString()}}\" ({{getType(config.date)}})</p>\n     <div *ngIf=\"headers\">\n       Response headers:\n       <ul>"
        },
        {
            "sha": "c78efe8490e481ebf3f52d816522541e1643c382",
            "filename": "aio/content/examples/http/src/app/config/config.component.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fconfig%2Fconfig.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fconfig%2Fconfig.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fconfig%2Fconfig.component.ts?ref=529f0a83cba1d68d351b3c46a4ddfbaae3ced154",
            "patch": "@@ -2,7 +2,6 @@\n // #docregion\n import { Component } from '@angular/core';\n import { Config, ConfigService } from './config.service';\n-import { MessageService } from '../message.service';\n \n @Component({\n   selector: 'app-config',\n@@ -40,7 +39,8 @@ export class ConfigComponent {\n   // #docregion v1\n       .subscribe((data: Config) => this.config = {\n           heroesUrl: data.heroesUrl,\n-          textfile:  data.textfile\n+          textfile:  data.textfile,\n+          date: data.date,\n       });\n   }\n   // #enddocregion v1\n@@ -71,5 +71,9 @@ export class ConfigComponent {\n   makeError() {\n     this.configService.makeIntentionalError().subscribe(null, error => this.error = error );\n   }\n+\n+  getType(val: any): string {\n+    return val instanceof Date ? 'date' : Array.isArray(val) ? 'array' : typeof val;\n+  }\n }\n // #enddocregion"
        },
        {
            "sha": "7d81ef7281bdfc5899fe06701a9ea5ea29d0748d",
            "filename": "aio/content/examples/http/src/app/config/config.service.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fconfig%2Fconfig.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fconfig%2Fconfig.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fconfig%2Fconfig.service.ts?ref=529f0a83cba1d68d351b3c46a4ddfbaae3ced154",
            "patch": "@@ -14,6 +14,7 @@ import { catchError, retry } from 'rxjs/operators';\n export interface Config {\n   heroesUrl: string;\n   textfile: string;\n+  date: any;\n }\n // #enddocregion config-interface\n // #docregion proto"
        },
        {
            "sha": "42e63b25c88b9d36da36057327f2ec3a670ef6b3",
            "filename": "aio/content/examples/http/src/app/http-interceptors/custom-json-interceptor.ts",
            "status": "added",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fhttp-interceptors%2Fcustom-json-interceptor.ts",
            "raw_url": "https://github.com/angular/angular/raw/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fhttp-interceptors%2Fcustom-json-interceptor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fhttp-interceptors%2Fcustom-json-interceptor.ts?ref=529f0a83cba1d68d351b3c46a4ddfbaae3ced154",
            "patch": "@@ -0,0 +1,62 @@\n+import { HttpEvent, HttpHandler, HttpInterceptor, HttpRequest, HttpResponse } from '@angular/common/http';\n+import { Injectable } from '@angular/core';\n+import { map } from 'rxjs/operators';\n+\n+// #docregion custom-json-interceptor\n+@Injectable()\n+export class CustomJsonInterceptor implements HttpInterceptor {\n+  constructor(private jsonParser: JsonParser) {}\n+\n+  intercept(httpRequest: HttpRequest<any>, next: HttpHandler) {\n+    if (httpRequest.responseType === 'json') {\n+      // If the expected response type is JSON then handle it here.\n+      return this.handleJsonResponse(httpRequest, next);\n+    } else {\n+      return next.handle(httpRequest);\n+    }\n+  }\n+\n+  private handleJsonResponse(httpRequest: HttpRequest<any>, next: HttpHandler) {\n+    // Override the responseType to disable the default JSON parsing.\n+    httpRequest = httpRequest.clone({responseType: 'text'});\n+    // Handle the response using the custom parser.\n+    return next.handle(httpRequest).pipe(map(event => this.parseJsonResponse(event)));\n+  }\n+\n+  private parseJsonResponse(event: HttpEvent<any>) {\n+    if (event instanceof HttpResponse && typeof event.body === 'string') {\n+      return event.clone({body: this.jsonParser.parse(event.body)});\n+    } else {\n+      return event;\n+    }\n+  }\n+}\n+\n+// The JsonParser class acts as a base class for custom parsers and as the DI token.\n+@Injectable()\n+export abstract class JsonParser {\n+  abstract parse(text: string): any;\n+}\n+// #enddocregion custom-json-interceptor\n+\n+// #docregion custom-json-parser\n+@Injectable()\n+export class CustomJsonParser implements JsonParser {\n+  parse(text: string): any {\n+    return JSON.parse(text, dateReviver);\n+  }\n+}\n+\n+function dateReviver(key: string, value: any) {\n+  // #enddocregion custom-json-parser\n+  if (typeof value !== 'string') {\n+    return value;\n+  }\n+  const match = /^(\\d{4})-(\\d{1,2})-(\\d{1,2})$/.exec(value);\n+  if (!match) {\n+    return value;\n+  }\n+  return new Date(+match[1], +match[2] - 1, +match[3]);\n+  // #docregion custom-json-parser\n+}\n+// #enddocregion custom-json-parser"
        },
        {
            "sha": "6a1a7450bcda87eabbc8792a7be2ff6383def9de",
            "filename": "aio/content/examples/http/src/app/http-interceptors/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fhttp-interceptors%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fhttp-interceptors%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fapp%2Fhttp-interceptors%2Findex.ts?ref=529f0a83cba1d68d351b3c46a4ddfbaae3ced154",
            "patch": "@@ -6,6 +6,7 @@ import { HTTP_INTERCEPTORS } from '@angular/common/http';\n // #enddocregion interceptor-providers\n import { AuthInterceptor } from './auth-interceptor';\n import { CachingInterceptor } from './caching-interceptor';\n+import { CustomJsonInterceptor , CustomJsonParser, JsonParser} from './custom-json-interceptor';\n import { EnsureHttpsInterceptor } from './ensure-https-interceptor';\n import { LoggingInterceptor } from './logging-interceptor';\n // #docregion interceptor-providers\n@@ -21,6 +22,10 @@ export const httpInterceptorProviders = [\n   // #docregion noop-provider\n   { provide: HTTP_INTERCEPTORS, useClass: NoopInterceptor, multi: true },\n   // #enddocregion noop-provider, interceptor-providers\n+  // #docregion custom-json-interceptor\n+  { provide: HTTP_INTERCEPTORS, useClass: CustomJsonInterceptor, multi: true },\n+  { provide: JsonParser, useClass: CustomJsonParser },\n+  // #enddocregion custom-json-interceptor\n \n   { provide: HTTP_INTERCEPTORS, useClass: EnsureHttpsInterceptor, multi: true },\n   { provide: HTTP_INTERCEPTORS, useClass: TrimNameInterceptor, multi: true },"
        },
        {
            "sha": "b5f75452ce06675991de064277a53594803c2335",
            "filename": "aio/content/examples/http/src/assets/config.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fassets%2Fconfig.json",
            "raw_url": "https://github.com/angular/angular/raw/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fassets%2Fconfig.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fhttp%2Fsrc%2Fassets%2Fconfig.json?ref=529f0a83cba1d68d351b3c46a4ddfbaae3ced154",
            "patch": "@@ -1,4 +1,5 @@\n {\n   \"heroesUrl\": \"api/heroes\",\n-  \"textfile\": \"assets/textfile.txt\"\n+  \"textfile\": \"assets/textfile.txt\",\n+  \"date\": \"2020-01-29\"\n }"
        },
        {
            "sha": "bced5a64b61354007d429ae9fd510f42ea68f975",
            "filename": "aio/content/guide/http.md",
            "status": "modified",
            "additions": 40,
            "deletions": 3,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fguide%2Fhttp.md",
            "raw_url": "https://github.com/angular/angular/raw/529f0a83cba1d68d351b3c46a4ddfbaae3ced154/aio%2Fcontent%2Fguide%2Fhttp.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fhttp.md?ref=529f0a83cba1d68d351b3c46a4ddfbaae3ced154",
            "patch": "@@ -741,6 +741,10 @@ To do this, set the cloned request body to `null`.\n   newReq = req.clone({ body: null }); // clear the body\n ```\n \n+## Http interceptor use-cases\n+\n+Below are a number of common uses for interceptors.\n+\n ### Setting default headers\n \n Apps often use an interceptor to set default headers on outgoing requests.\n@@ -768,7 +772,7 @@ An interceptor that alters headers can be used for a number of different operati\n * Caching behavior; for example, `If-Modified-Since`\n * XSRF protection\n \n-### Using interceptors for logging\n+### Logging request and response pairs\n \n Because interceptors can process the request and response _together_, they can perform tasks such as timing and logging an entire HTTP operation.\n \n@@ -788,9 +792,42 @@ and reports the outcome to the `MessageService`.\n \n Neither `tap` nor `finalize` touch the values of the observable stream returned to the caller.\n \n-{@a caching}\n+{@a custom-json-parser}\n+\n+### Custom JSON parsing\n+\n+Interceptors can be used to replace the built-in JSON parsing with a custom implementation.\n+\n+The `CustomJsonInterceptor` in the following example demonstrates how to achieve this.\n+If the intercepted request expects a `'json'` response, the `reponseType` is changed to `'text'`\n+to disable the built-in JSON parsing. Then the response is parsed via the injected `JsonParser`.\n \n-### Using interceptors for caching\n+<code-example\n+  path=\"http/src/app/http-interceptors/custom-json-interceptor.ts\"\n+  region=\"custom-json-interceptor\"\n+  header=\"app/http-interceptors/custom-json-interceptor.ts\">\n+</code-example>\n+\n+You can then implement your own custom `JsonParser`.\n+Here is a custom JsonParser that has a special date reviver.\n+\n+<code-example\n+  path=\"http/src/app/http-interceptors/custom-json-interceptor.ts\"\n+  region=\"custom-json-parser\"\n+  header=\"app/http-interceptors/custom-json-interceptor.ts\">\n+</code-example>\n+\n+You provide the `CustomParser` along with the `CustomJsonInterceptor`.\n+\n+<code-example\n+  path=\"http/src/app/http-interceptors/index.ts\"\n+  region=\"custom-json-interceptor\"\n+  header=\"app/http-interceptors/index.ts\">\n+</code-example>\n+\n+\n+{@a caching}\n+### Caching requests\n \n Interceptors can handle requests by themselves, without forwarding to `next.handle()`.\n "
        }
    ],
    "stats": {
        "total": 124,
        "additions": 118,
        "deletions": 6
    }
}