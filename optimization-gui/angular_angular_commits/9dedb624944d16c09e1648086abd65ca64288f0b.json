{
    "author": "zarend",
    "message": "test(compiler-cli): fix i18n error tests (#40026)\n\nRefactors the i18n error tests to be unit tests in ngtsc_spec.ts. There\nis two reasons for doing this.\n\nFirst is that the tests in compliace_old expected an expection to be be\nthrown but did not fail the test if no exception was thrown. That means\nthat this test could miss catching a bug. It is also a big hacky to call\ncompile directly and expect an exception to be thrown for diagnostics.\n\nAlso, this can easily be unit tested and an end-to-end test is not\nnecessary since we are not making use of the goldfiles for these tests.\n\nIt is easier to maintain and less hacky to validate that we get helpful\nerror messages when nesting i18n sections by calling getDiagnostics\ndirectly.\n\nPR Close #40026",
    "sha": "9dedb624944d16c09e1648086abd65ca64288f0b",
    "files": [
        {
            "sha": "8b137891791fe96927ad78e64b0aad7bded08bdc",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/errors/GOLDEN_PARTIAL.js",
            "status": "removed",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2FGOLDEN_PARTIAL.js?ref=973bb403a51245dd3dca939fd9eb2c377e9004bb",
            "patch": "@@ -1 +0,0 @@\n-"
        },
        {
            "sha": "ef9628442d7d29ff782d2e5eca32066ce0f917ce",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/errors/TEST_CASES.json",
            "status": "removed",
            "additions": 0,
            "deletions": 62,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2FTEST_CASES.json?ref=973bb403a51245dd3dca939fd9eb2c377e9004bb",
            "patch": "@@ -1,62 +0,0 @@\n-{\n-  \"$schema\": \"../../test_case_schema.json\",\n-  \"cases\": [\n-    {\n-      \"description\": \"should throw on nested i18n sections\",\n-      \"inputFiles\": [\n-        \"nested_i18n_msg.ts\"\n-      ],\n-      \"compilationModeFilter\": [\n-        \"full compile\"\n-      ],\n-      \"expectations\": [\n-        {\n-          \"expectedErrors\": [\n-            {\n-              \"message\": \"Cannot mark an element as translatable inside of a translatable section\\\\. Please remove the nested i18n marker\\\\.\",\n-              \"location\": \"nested_i18n_msg\\\\.ts \\\\(7,5\\\\)\"\n-            }\n-          ]\n-        }\n-      ]\n-    },\n-    {\n-      \"description\": \"should throw on nested i18n sections with tags in between\",\n-      \"inputFiles\": [\n-        \"nested_i18n_msg_with_tags.ts\"\n-      ],\n-      \"compilationModeFilter\": [\n-        \"full compile\"\n-      ],\n-      \"expectations\": [\n-        {\n-          \"expectedErrors\": [\n-            {\n-              \"message\": \"Cannot mark an element as translatable inside of a translatable section\\\\. Please remove the nested i18n marker\\\\.\",\n-              \"location\": \"nested_i18n_msg_with_tags\\\\.ts \\\\(8,7\\\\)\"\n-            }\n-          ]\n-        }\n-      ]\n-    },\n-    {\n-      \"description\": \"should throw on nested i18n sections represented with <ng-container>s\",\n-      \"inputFiles\": [\n-        \"nested_i18n_msg_with_ng-containers.ts\"\n-      ],\n-      \"compilationModeFilter\": [\n-        \"full compile\"\n-      ],\n-      \"expectations\": [\n-        {\n-          \"expectedErrors\": [\n-            {\n-              \"message\": \"Cannot mark an element as translatable inside of a translatable section\\\\. Please remove the nested i18n marker\\\\.\",\n-              \"location\": \"nested_i18n_msg_with_ng-containers\\\\.ts \\\\(8,7\\\\)\"\n-            }\n-          ]\n-        }\n-      ]\n-    }\n-  ]\n-}"
        },
        {
            "sha": "533f1f90603dc086c258e559077716bc66ba9e91",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/errors/nested_i18n_msg.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 16,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2Fnested_i18n_msg.ts",
            "raw_url": "https://github.com/angular/angular/raw/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2Fnested_i18n_msg.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2Fnested_i18n_msg.ts?ref=973bb403a51245dd3dca939fd9eb2c377e9004bb",
            "patch": "@@ -1,16 +0,0 @@\n-import {Component, NgModule} from '@angular/core';\n-\n-@Component({\n-  selector: 'my-component',\n-  template: `\n-  <div i18n>\n-    <div i18n>Some content</div>\n-  </div>\n-`,\n-})\n-export class MyComponent {\n-}\n-\n-@NgModule({declarations: [MyComponent]})\n-export class MyModule {\n-}\n\\ No newline at end of file"
        },
        {
            "sha": "e5690686f256cb9788beaa17e947ee79cc7e4f1a",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/errors/nested_i18n_msg_with_ng-containers.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 18,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2Fnested_i18n_msg_with_ng-containers.ts",
            "raw_url": "https://github.com/angular/angular/raw/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2Fnested_i18n_msg_with_ng-containers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2Fnested_i18n_msg_with_ng-containers.ts?ref=973bb403a51245dd3dca939fd9eb2c377e9004bb",
            "patch": "@@ -1,18 +0,0 @@\n-import {Component, NgModule} from '@angular/core';\n-\n-@Component({\n-  selector: 'my-component',\n-  template: `\n-  <ng-container i18n>\n-    <div>\n-      <ng-container i18n>Some content</ng-container>\n-    </div>\n-  </ng-container>\n-`,\n-})\n-export class MyComponent {\n-}\n-\n-@NgModule({declarations: [MyComponent]})\n-export class MyModule {\n-}\n\\ No newline at end of file"
        },
        {
            "sha": "e8942340c2d85632af7dc3bcc1e77b0c635d448c",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/errors/nested_i18n_msg_with_tags.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 18,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2Fnested_i18n_msg_with_tags.ts",
            "raw_url": "https://github.com/angular/angular/raw/973bb403a51245dd3dca939fd9eb2c377e9004bb/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2Fnested_i18n_msg_with_tags.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ferrors%2Fnested_i18n_msg_with_tags.ts?ref=973bb403a51245dd3dca939fd9eb2c377e9004bb",
            "patch": "@@ -1,18 +0,0 @@\n-import {Component, NgModule} from '@angular/core';\n-\n-@Component({\n-  selector: 'my-component',\n-  template: `\n-  <div i18n>\n-    <div>\n-      <div i18n>Some content</div>\n-    </div>\n-  </div>\n-`,\n-})\n-export class MyComponent {\n-}\n-\n-@NgModule({declarations: [MyComponent]})\n-export class MyModule {\n-}\n\\ No newline at end of file"
        },
        {
            "sha": "f0cf9ac3a560b12d3628218f56c0c164a3ca2d9f",
            "filename": "packages/compiler-cli/test/compliance_old/r3_view_compiler_i18n_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 55,
            "changes": 55,
            "blob_url": "https://github.com/angular/angular/blob/9dedb624944d16c09e1648086abd65ca64288f0b/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fr3_view_compiler_i18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dedb624944d16c09e1648086abd65ca64288f0b/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fr3_view_compiler_i18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fr3_view_compiler_i18n_spec.ts?ref=9dedb624944d16c09e1648086abd65ca64288f0b",
            "patch": "@@ -3325,61 +3325,6 @@ $` + String.raw`{$I18N_4$}:ICU:\\`;\n     });\n   });\n \n-  describe('errors', () => {\n-    const verifyNestedSectionsError = (errorThrown: any, expectedErrorText: string) => {\n-      expect(errorThrown.ngParseErrors.length).toBe(1);\n-      const msg = errorThrown.ngParseErrors[0].toString();\n-      expect(msg).toContain(\n-          'Cannot mark an element as translatable inside of a translatable section. Please remove the nested i18n marker.');\n-      expect(msg).toContain(expectedErrorText);\n-      expect(msg).toMatch(/app\\/spec\\.ts\\@\\d+\\:\\d+/);\n-    };\n-\n-    it('should throw on nested i18n sections', () => {\n-      const files = getAppFilesWithTemplate(`\n-        <div i18n>\n-          <div i18n>Some content</div>\n-        </div>\n-      `);\n-      try {\n-        compile(files, angularFiles);\n-      } catch (error) {\n-        verifyNestedSectionsError(error, '[ERROR ->]<div i18n>Some content</div>');\n-      }\n-    });\n-\n-    it('should throw on nested i18n sections with tags in between', () => {\n-      const files = getAppFilesWithTemplate(`\n-        <div i18n>\n-          <div>\n-            <div i18n>Some content</div>\n-          </div>\n-        </div>\n-      `);\n-      try {\n-        compile(files, angularFiles);\n-      } catch (error) {\n-        verifyNestedSectionsError(error, '[ERROR ->]<div i18n>Some content</div>');\n-      }\n-    });\n-\n-    it('should throw on nested i18n sections represented with <ng-container>s', () => {\n-      const files = getAppFilesWithTemplate(`\n-        <ng-container i18n>\n-          <div>\n-            <ng-container i18n>Some content</ng-container>\n-          </div>\n-        </ng-container>\n-      `);\n-      try {\n-        compile(files, angularFiles);\n-      } catch (error) {\n-        verifyNestedSectionsError(\n-            error, '[ERROR ->]<ng-container i18n>Some content</ng-container>');\n-      }\n-    });\n-  });\n-\n   describe('namespaces', () => {\n     it('should handle namespaces inside i18n blocks', () => {\n       const input = `"
        },
        {
            "sha": "b44016d0706a51bdf52ece0c8de2f5f73171912b",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/9dedb624944d16c09e1648086abd65ca64288f0b/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9dedb624944d16c09e1648086abd65ca64288f0b/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=9dedb624944d16c09e1648086abd65ca64288f0b",
            "patch": "@@ -7601,6 +7601,74 @@ export const Foo = Foo__PRE_R3__;\n           expect(getDiagnosticSourceCode(diags[0])).toBe('\\'');\n         });\n       });\n+\n+      describe('i18n errors', () => {\n+        it('should report helpful error message on nested i18n sections', () => {\n+          env.write('test.ts', `\n+            import {Component} from '@angular/core';\n+            @Component({\n+              selector: 'test-component',\n+              template: '<div i18n><div i18n>Content</div></div>'\n+            })\n+            class TestComponent {}\n+            `);\n+\n+          const diags = env.driveDiagnostics();\n+\n+          expect(diags.length).toEqual(1);\n+          expect(diags[0].messageText)\n+              .toEqual(\n+                  'Cannot mark an element as translatable inside of a translatable section.' +\n+                  ' Please remove the nested i18n marker.');\n+          expect(diags[0].file?.fileName).toEqual(absoluteFrom('/test.ts'));\n+          expect(diags[0].file?.text.substr(diags[0].start!, diags[0].length))\n+              .toEqual('<div i18n>Content</div>');\n+        });\n+\n+        it('report a diagnostic on nested i18n sections with tags in between', () => {\n+          env.write('test.ts', `\n+            import {Component} from '@angular/core';\n+            @Component({\n+              selector: 'test-component',\n+              template: '<div i18n><div><div i18n>Content</div></div></div>'\n+            })\n+            class TestComponent {}\n+          `);\n+\n+          const diags = env.driveDiagnostics();\n+\n+          expect(diags.length).toEqual(1);\n+          expect(diags[0].messageText)\n+              .toEqual(\n+                  'Cannot mark an element as translatable inside of a translatable section.' +\n+                  ' Please remove the nested i18n marker.');\n+          expect(diags[0].file?.fileName).toEqual(absoluteFrom('/test.ts'));\n+          expect(diags[0].file?.text.substr(diags[0].start!, diags[0].length))\n+              .toEqual('<div i18n>Content</div>');\n+        });\n+\n+        it('report a diagnostic on nested i18n sections represented with <ng-continers>s', () => {\n+          env.write('test.ts', `\n+            import {Component} from '@angular/core';\n+            @Component({\n+              selector: 'test-component',\n+              template: '<div i18n><div><ng-container i18n>Content</ng-container></div></div>'\n+            })\n+            class TestComponent {}\n+          `);\n+\n+          const diags = env.driveDiagnostics();\n+\n+          expect(diags.length).toEqual(1);\n+          expect(diags[0].messageText)\n+              .toEqual(\n+                  'Cannot mark an element as translatable inside of a translatable section.' +\n+                  ' Please remove the nested i18n marker.');\n+          expect(diags[0].file?.fileName).toEqual(absoluteFrom('/test.ts'));\n+          expect(diags[0].file?.text.substr(diags[0].start!, diags[0].length))\n+              .toEqual('<ng-container i18n>Content</ng-container>');\n+        });\n+      });\n     });\n   });\n "
        }
    ],
    "stats": {
        "total": 238,
        "additions": 68,
        "deletions": 170
    }
}