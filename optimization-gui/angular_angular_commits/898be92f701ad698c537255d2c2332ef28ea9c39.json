{
    "author": "JoostK",
    "message": "perf(ngcc): do not rescan program source files when referenced from multiple root files (#39254)\n\nWhen ngcc is configured to run with the `--use-program-dependencies`\nflag, as is the case in the CLI's asynchronous processing, it will scan\nall source files in the program, starting from the program's root files\nas configured in the tsconfig. Each individual root file could\npotentially rescan files that had already been scanned for an earlier\nroot file, causing a severe performance penalty if the number of root\nfiles is large. This would be the case if glob patterns are used in the\n\"include\" specification of a tsconfig file.\n\nThis commit avoids the performance penalty by keeping track of the files\nthat have been scanned across all root files, such that no source file\nis scanned multiple times.\n\nFixes #39240\n\nPR Close #39254",
    "sha": "898be92f701ad698c537255d2c2332ef28ea9c39",
    "files": [
        {
            "sha": "1913bf871f164347daaa5adb8baee623ffe9863a",
            "filename": "packages/compiler-cli/ngcc/src/dependencies/dependency_host.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 6,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/898be92f701ad698c537255d2c2332ef28ea9c39/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fdependencies%2Fdependency_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/898be92f701ad698c537255d2c2332ef28ea9c39/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fdependencies%2Fdependency_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fdependencies%2Fdependency_host.ts?ref=898be92f701ad698c537255d2c2332ef28ea9c39",
            "patch": "@@ -53,6 +53,22 @@ export abstract class DependencyHostBase implements DependencyHost {\n     }\n   }\n \n+  /**\n+   * Find all the dependencies for the provided paths.\n+   *\n+   * @param files The list of absolute paths of JavaScript files to scan for dependencies.\n+   * @param dependencyInfo An object containing information about the dependencies of the\n+   * entry-point, including those that were missing or deep imports into other entry-points. The\n+   * sets in this object will be updated with new information about the entry-point's dependencies.\n+   */\n+  collectDependenciesInFiles(\n+      files: AbsoluteFsPath[], {dependencies, missing, deepImports}: DependencyInfo): void {\n+    const alreadySeen = new Set<AbsoluteFsPath>();\n+    for (const file of files) {\n+      this.processFile(file, dependencies, missing, deepImports, alreadySeen);\n+    }\n+  }\n+\n   /**\n    * Compute the dependencies of the given file.\n    *\n@@ -102,17 +118,26 @@ export abstract class DependencyHostBase implements DependencyHost {\n       return false;\n     }\n     if (resolvedModule instanceof ResolvedRelativeModule) {\n-      const internalDependency = resolvedModule.modulePath;\n-      if (!alreadySeen.has(internalDependency)) {\n-        alreadySeen.add(internalDependency);\n-        this.recursivelyCollectDependencies(\n-            internalDependency, dependencies, missing, deepImports, alreadySeen);\n-      }\n+      this.processFile(resolvedModule.modulePath, dependencies, missing, deepImports, alreadySeen);\n     } else if (resolvedModule instanceof ResolvedDeepImport) {\n       deepImports.add(resolvedModule.importPath);\n     } else {\n       dependencies.add(resolvedModule.entryPointPath);\n     }\n     return true;\n   }\n+\n+  /**\n+   * Processes the file if it has not already been seen. This will also recursively process\n+   * all files that are imported from the file, while taking the set of already seen files\n+   * into account.\n+   */\n+  protected processFile(\n+      file: AbsoluteFsPath, dependencies: Set<AbsoluteFsPath>, missing: Set<string>,\n+      deepImports: Set<string>, alreadySeen: Set<AbsoluteFsPath>): void {\n+    if (!alreadySeen.has(file)) {\n+      alreadySeen.add(file);\n+      this.recursivelyCollectDependencies(file, dependencies, missing, deepImports, alreadySeen);\n+    }\n+  }\n }"
        },
        {
            "sha": "7c9f1b67c207e3cd7195ae1650e5035423517cc8",
            "filename": "packages/compiler-cli/ngcc/src/entry_point_finder/program_based_entry_point_finder.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/898be92f701ad698c537255d2c2332ef28ea9c39/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fentry_point_finder%2Fprogram_based_entry_point_finder.ts",
            "raw_url": "https://github.com/angular/angular/raw/898be92f701ad698c537255d2c2332ef28ea9c39/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fentry_point_finder%2Fprogram_based_entry_point_finder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fentry_point_finder%2Fprogram_based_entry_point_finder.ts?ref=898be92f701ad698c537255d2c2332ef28ea9c39",
            "patch": "@@ -48,14 +48,12 @@ export class ProgramBasedEntryPointFinder extends TracingEntryPointFinder {\n     const moduleResolver = new ModuleResolver(this.fs, this.pathMappings, ['', '.ts', '/index.ts']);\n     const host = new EsmDependencyHost(this.fs, moduleResolver);\n     const dependencies = createDependencyInfo();\n+    const rootFiles = this.tsConfig.rootNames.map(rootName => this.fs.resolve(rootName));\n     this.logger.debug(\n         `Using the program from ${this.tsConfig.project} to seed the entry-point finding.`);\n     this.logger.debug(\n-        `Collecting dependencies from the following files:` +\n-        this.tsConfig.rootNames.map(file => `\\n- ${file}`));\n-    this.tsConfig.rootNames.forEach(rootName => {\n-      host.collectDependencies(this.fs.resolve(rootName), dependencies);\n-    });\n+        `Collecting dependencies from the following files:` + rootFiles.map(file => `\\n- ${file}`));\n+    host.collectDependenciesInFiles(rootFiles, dependencies);\n     return Array.from(dependencies.dependencies);\n   }\n "
        },
        {
            "sha": "af847efcb99c4093491f23b0dc2d0de3d47d1a15",
            "filename": "packages/compiler-cli/ngcc/test/entry_point_finder/program_based_entry_point_finder_spec.ts",
            "status": "modified",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/angular/angular/blob/898be92f701ad698c537255d2c2332ef28ea9c39/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fentry_point_finder%2Fprogram_based_entry_point_finder_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/898be92f701ad698c537255d2c2332ef28ea9c39/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fentry_point_finder%2Fprogram_based_entry_point_finder_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fentry_point_finder%2Fprogram_based_entry_point_finder_spec.ts?ref=898be92f701ad698c537255d2c2332ef28ea9c39",
            "patch": "@@ -59,6 +59,75 @@ runInEachFileSystem(() => {\n         ]);\n       });\n \n+      it('should scan source files only once, even if they are referenced from multiple root files',\n+         () => {\n+           // https://github.com/angular/angular/issues/39240\n+           // When scanning the program for imports to determine which entry-points to process, the\n+           // root files as configured in the tsconfig file are used to start scanning from. This\n+           // test asserts that a file is not scanned multiple times even if it is referenced from\n+           // multiple root files.\n+           loadTestFiles([\n+             {\n+               name: _Abs(`${projectPath}/package.json`),\n+               contents: '',\n+             },\n+             {\n+               name: _Abs(`${projectPath}/tsconfig.json`),\n+               contents: `{\n+                 \"files\": [\n+                   \"root-one.ts\",\n+                   \"root-two.ts\",\n+                 ],\n+                 \"compilerOptions\": {\n+                   \"baseUrl\": \".\",\n+                   \"paths\": {\n+                     \"lib/*\": [\"lib/*\"]\n+                   }\n+                 }\n+               }`,\n+             },\n+             {\n+               name: _Abs(`${projectPath}/root-one.ts`),\n+               contents: `\n+                 import './root-two';\n+                 import './not-root';\n+               `,\n+             },\n+             {\n+               name: _Abs(`${projectPath}/root-two.ts`),\n+               contents: `\n+                 import './not-root';\n+               `,\n+             },\n+             {\n+               name: _Abs(`${projectPath}/not-root.ts`),\n+               contents: `\n+              import {Component} from '@angular/core';\n+              `,\n+             },\n+             ...createPackage(angularNamespacePath, 'core'),\n+           ]);\n+\n+           const extractImportsSpy =\n+               spyOn(EsmDependencyHost.prototype, 'extractImports' as any).and.callThrough();\n+\n+           const finder = createFinder();\n+           const {entryPoints} = finder.findEntryPoints();\n+           expect(dumpEntryPointPaths(basePath, entryPoints)).toEqual([\n+             ['@angular/core', '@angular/core'],\n+           ]);\n+\n+           // Three `extractImports` calls should have been made corresponding with the three\n+           // distinct source files in the project.\n+           const extractImportFiles =\n+               extractImportsSpy.calls.all().map((call: jasmine.CallInfo<any>) => call.args[0]);\n+           expect(extractImportFiles).toEqual([\n+             _Abs(`${projectPath}/root-one.ts`),\n+             _Abs(`${projectPath}/root-two.ts`),\n+             _Abs(`${projectPath}/not-root.ts`),\n+           ]);\n+         });\n+\n       function createFinder(): ProgramBasedEntryPointFinder {\n         const tsConfig = readConfiguration(`${projectPath}/tsconfig.json`);\n         const baseUrl = fs.resolve(projectPath, tsConfig.options.basePath!);"
        }
    ],
    "stats": {
        "total": 114,
        "additions": 103,
        "deletions": 11
    }
}