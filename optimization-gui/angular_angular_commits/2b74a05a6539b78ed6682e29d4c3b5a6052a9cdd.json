{
    "author": "atscott",
    "message": "refactor(compiler-cli): Enable pipe information when checkTypeOfPipes=false (#39555)\n\nWhen `checkTypeOfPipes` is set to `false`, the configuration is meant to\nignore the signature of the pipe's `transform` method for diagnostics.\nHowever, we still should produce some information about the pipe for the\n`TemplateTypeChecker`. This change refactors the returned symbol for\npipes so that it also includes information about the pipe's class\ninstance as it appears in the TCB.\n\nPR Close #39555",
    "sha": "2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
    "files": [
        {
            "sha": "f6b3cf92c60bdb7487b1ca18f8d383522fd027c9",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/symbols.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 1,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fsymbols.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fsymbols.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fsymbols.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -24,13 +24,14 @@ export enum SymbolKind {\n   Template,\n   Expression,\n   DomBinding,\n+  Pipe,\n }\n \n /**\n  * A representation of an entity in the `TemplateAst`.\n  */\n export type Symbol = InputBindingSymbol|OutputBindingSymbol|ElementSymbol|ReferenceSymbol|\n-    VariableSymbol|ExpressionSymbol|DirectiveSymbol|TemplateSymbol|DomBindingSymbol;\n+    VariableSymbol|ExpressionSymbol|DirectiveSymbol|TemplateSymbol|DomBindingSymbol|PipeSymbol;\n \n /**\n  * A `Symbol` which declares a new named entity in the template scope.\n@@ -276,3 +277,37 @@ export interface DomBindingSymbol {\n   /** The symbol for the element or template of the text attribute. */\n   host: ElementSymbol|TemplateSymbol;\n }\n+\n+/**\n+ * A representation for a call to a pipe's transform method in the TCB.\n+ */\n+export interface PipeSymbol {\n+  kind: SymbolKind.Pipe;\n+\n+  /** The `ts.Type` of the transform node. */\n+  tsType: ts.Type;\n+\n+  /**\n+   * The `ts.Symbol` for the transform call. This could be `null` when `checkTypeOfPipes` is set to\n+   * `false` because the transform call would be of the form `(_pipe1 as any).transform()`\n+   */\n+  tsSymbol: ts.Symbol|null;\n+\n+  /** The position of the transform call in the template. */\n+  shimLocation: ShimLocation;\n+\n+  /** The symbol for the pipe class as an instance that appears in the TCB. */\n+  classSymbol: ClassSymbol;\n+}\n+\n+/** Represents an instance of a class found in the TCB, i.e. `var _pipe1: MyPipe = null!; */\n+export interface ClassSymbol {\n+  /** The `ts.Type` of class. */\n+  tsType: ts.Type;\n+\n+  /** The `ts.Symbol` for class. */\n+  tsSymbol: ts.Symbol;\n+\n+  /** The position for the variable declaration for the class instance. */\n+  shimLocation: ShimLocation;\n+}"
        },
        {
            "sha": "c9c0cc772378cfc069b8b608433d9871db3f5f1a",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/context.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -257,7 +257,7 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n       boundTarget,\n     });\n \n-    const tcbRequiresInline = requiresInlineTypeCheckBlock(ref.node);\n+    const tcbRequiresInline = requiresInlineTypeCheckBlock(ref.node, pipes);\n \n     // If inlining is not supported, but is required for either the TCB or one of its directive\n     // dependencies, then exit here with an error."
        },
        {
            "sha": "43b944d4e24f5457641cff7428c3aa96f226d549",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/tcb_util.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftcb_util.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftcb_util.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftcb_util.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -10,6 +10,7 @@ import {AbsoluteSourceSpan, ParseSourceSpan} from '@angular/compiler';\n import {ClassDeclaration} from '@angular/compiler-cli/src/ngtsc/reflection';\n import * as ts from 'typescript';\n \n+import {Reference} from '../../imports';\n import {getTokenAtPosition} from '../../util/src/typescript';\n import {FullTemplateMapping, SourceLocation, TemplateId, TemplateSourceMapping} from '../api';\n \n@@ -37,7 +38,9 @@ export interface TemplateSourceResolver {\n   toParseSourceSpan(id: TemplateId, span: AbsoluteSourceSpan): ParseSourceSpan|null;\n }\n \n-export function requiresInlineTypeCheckBlock(node: ClassDeclaration<ts.ClassDeclaration>): boolean {\n+export function requiresInlineTypeCheckBlock(\n+    node: ClassDeclaration<ts.ClassDeclaration>,\n+    usedPipes: Map<string, Reference<ClassDeclaration<ts.ClassDeclaration>>>): boolean {\n   // In order to qualify for a declared TCB (not inline) two conditions must be met:\n   // 1) the class must be exported\n   // 2) it must not have constrained generic types\n@@ -47,6 +50,11 @@ export function requiresInlineTypeCheckBlock(node: ClassDeclaration<ts.ClassDecl\n   } else if (!checkIfGenericTypesAreUnbound(node)) {\n     // Condition 2 is false, the class has constrained generic types\n     return true;\n+  } else if (Array.from(usedPipes.values())\n+                 .some(pipeRef => !checkIfClassIsExported(pipeRef.node))) {\n+    // If one of the pipes used by the component is not exported, a non-inline TCB will not be able\n+    // to import it, so this requires an inline TCB.\n+    return true;\n   } else {\n     return false;\n   }"
        },
        {
            "sha": "a3c2e51336b0601f717230be07be08fe100d4559",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/template_symbol_builder.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 5,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -13,7 +13,7 @@ import {AbsoluteFsPath} from '../../file_system';\n import {ClassDeclaration} from '../../reflection';\n import {ComponentScopeReader} from '../../scope';\n import {isAssignment} from '../../util/src/typescript';\n-import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ExpressionSymbol, InputBindingSymbol, OutputBindingSymbol, ReferenceSymbol, ShimLocation, Symbol, SymbolKind, TemplateSymbol, TsNodeSymbolInfo, TypeCheckableDirectiveMeta, VariableSymbol} from '../api';\n+import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ExpressionSymbol, InputBindingSymbol, OutputBindingSymbol, PipeSymbol, ReferenceSymbol, ShimLocation, Symbol, SymbolKind, TemplateSymbol, TsNodeSymbolInfo, TypeCheckableDirectiveMeta, VariableSymbol} from '../api';\n \n import {ExpressionIdentifier, findAllMatchingNodes, findFirstMatchingNode, hasExpressionIdentifier} from './comments';\n import {TemplateData} from './context';\n@@ -61,6 +61,8 @@ export class SymbolBuilder {\n       symbol = this.getSymbolOfVariable(node);\n     } else if (node instanceof TmplAstReference) {\n       symbol = this.getSymbolOfReference(node);\n+    } else if (node instanceof BindingPipe) {\n+      symbol = this.getSymbolOfPipe(node);\n     } else if (node instanceof AST) {\n       symbol = this.getSymbolOfTemplateExpression(node);\n     } else {\n@@ -397,6 +399,45 @@ export class SymbolBuilder {\n     }\n   }\n \n+  private getSymbolOfPipe(expression: BindingPipe): PipeSymbol|null {\n+    const node = findFirstMatchingNode(\n+        this.typeCheckBlock, {withSpan: expression.sourceSpan, filter: ts.isCallExpression});\n+    if (node === null || !ts.isPropertyAccessExpression(node.expression)) {\n+      return null;\n+    }\n+\n+    const methodAccess = node.expression;\n+    // Find the node for the pipe variable from the transform property access. This will be one of\n+    // two forms: `_pipe1.transform` or `(_pipe1 as any).transform`.\n+    const pipeVariableNode = ts.isParenthesizedExpression(methodAccess.expression) &&\n+            ts.isAsExpression(methodAccess.expression.expression) ?\n+        methodAccess.expression.expression.expression :\n+        methodAccess.expression;\n+    const pipeDeclaration = this.getTypeChecker().getSymbolAtLocation(pipeVariableNode);\n+    if (pipeDeclaration === undefined || pipeDeclaration.valueDeclaration === undefined) {\n+      return null;\n+    }\n+\n+    const pipeInstance = this.getSymbolOfTsNode(pipeDeclaration.valueDeclaration);\n+    if (pipeInstance === null || pipeInstance.tsSymbol === null) {\n+      return null;\n+    }\n+\n+    const symbolInfo = this.getSymbolOfTsNode(methodAccess);\n+    if (symbolInfo === null) {\n+      return null;\n+    }\n+\n+    return {\n+      kind: SymbolKind.Pipe,\n+      ...symbolInfo,\n+      classSymbol: {\n+        ...pipeInstance,\n+        tsSymbol: pipeInstance.tsSymbol,\n+      },\n+    };\n+  }\n+\n   private getSymbolOfTemplateExpression(expression: AST): VariableSymbol|ReferenceSymbol\n       |ExpressionSymbol|null {\n     if (expression instanceof ASTWithSource) {\n@@ -446,10 +487,6 @@ export class SymbolBuilder {\n         // still get the type of the whole conditional expression to include `|undefined`.\n         tsType: this.getTypeChecker().getTypeAtLocation(node)\n       };\n-    } else if (expression instanceof BindingPipe && ts.isCallExpression(node)) {\n-      // TODO(atscott): Create a PipeSymbol to include symbol for the Pipe class\n-      const symbolInfo = this.getSymbolOfTsNode(node.expression);\n-      return symbolInfo === null ? null : {...symbolInfo, kind: SymbolKind.Expression};\n     } else {\n       const symbolInfo = this.getSymbolOfTsNode(node);\n       return symbolInfo === null ? null : {...symbolInfo, kind: SymbolKind.Expression};"
        },
        {
            "sha": "3db0a4eacfdfeda5b57f1e5688222056bc824a3b",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -1599,7 +1599,8 @@ class TcbExpressionTranslator {\n         pipe = this.tcb.env.pipeInst(pipeRef);\n       } else {\n         // Use an 'any' value when not checking the type of the pipe.\n-        pipe = NULL_AS_ANY;\n+        pipe = ts.createAsExpression(\n+            this.tcb.env.pipeInst(pipeRef), ts.createKeywordTypeNode(ts.SyntaxKind.AnyKeyword));\n       }\n       const args = ast.args.map(arg => this.translate(arg));\n       const methodAccess = ts.createPropertyAccess(pipe, 'transform');"
        },
        {
            "sha": "6de3126cb0e064568a6f5c9594bc2a65492e0cca",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_check_block_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -973,7 +973,8 @@ describe('type check blocks', () => {\n       it('should not check types of pipes when disabled', () => {\n         const DISABLED_CONFIG: TypeCheckingConfig = {...BASE_CONFIG, checkTypeOfPipes: false};\n         const block = tcb(TEMPLATE, PIPES, DISABLED_CONFIG);\n-        expect(block).toContain('(null as any).transform(((ctx).a), ((ctx).b), ((ctx).c))');\n+        expect(block).toContain(\n+            '((null as TestPipe) as any).transform(((ctx).a), ((ctx).b), ((ctx).c))');\n       });\n     });\n "
        },
        {
            "sha": "effba31830647eb66fb318210bdf05ac54eaf8e5",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker__get_symbol_of_template_node_spec.ts",
            "status": "modified",
            "additions": 58,
            "deletions": 36,
            "changes": 94,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -12,7 +12,7 @@ import * as ts from 'typescript';\n import {absoluteFrom, AbsoluteFsPath, getSourceFileOrError} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n import {ClassDeclaration} from '../../reflection';\n-import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ExpressionSymbol, InputBindingSymbol, OutputBindingSymbol, ReferenceSymbol, Symbol, SymbolKind, TemplateSymbol, TemplateTypeChecker, TypeCheckingConfig, VariableSymbol} from '../api';\n+import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ExpressionSymbol, InputBindingSymbol, OutputBindingSymbol, PipeSymbol, ReferenceSymbol, Symbol, SymbolKind, TemplateSymbol, TemplateTypeChecker, TypeCheckingConfig, VariableSymbol} from '../api';\n \n import {getClass, ngForDeclaration, ngForTypeCheckTarget, setup as baseTestSetup, TypeCheckingTarget} from './test_utils';\n \n@@ -710,73 +710,91 @@ runInEachFileSystem(() => {\n         });\n       });\n \n-\n       describe('pipes', () => {\n         let templateTypeChecker: TemplateTypeChecker;\n         let cmp: ClassDeclaration<ts.ClassDeclaration>;\n         let binding: BindingPipe;\n         let program: ts.Program;\n \n-        beforeEach(() => {\n+        function setupPipesTest(checkTypeOfPipes = true) {\n           const fileName = absoluteFrom('/main.ts');\n           const templateString = `<div [inputA]=\"a | test:b:c\"></div>`;\n-          const testValues = setup([\n-            {\n-              fileName,\n-              templates: {'Cmp': templateString},\n-              source: `\n+          const testValues = setup(\n+              [\n+                {\n+                  fileName,\n+                  templates: {'Cmp': templateString},\n+                  source: `\n             export class Cmp { a: string; b: number; c: boolean }\n             export class TestPipe {\n               transform(value: string, repeat: number, commaSeparate: boolean): string[] {\n               }\n             }\n             `,\n-              declarations: [{\n-                type: 'pipe',\n-                name: 'TestPipe',\n-                pipeName: 'test',\n-              }],\n-            },\n-          ]);\n+                  declarations: [{\n+                    type: 'pipe',\n+                    name: 'TestPipe',\n+                    pipeName: 'test',\n+                  }],\n+                },\n+              ],\n+              {checkTypeOfPipes});\n           program = testValues.program;\n           templateTypeChecker = testValues.templateTypeChecker;\n           const sf = getSourceFileOrError(testValues.program, fileName);\n           cmp = getClass(sf, 'Cmp');\n           binding =\n               (getAstElements(templateTypeChecker, cmp)[0].inputs[0].value as ASTWithSource).ast as\n               BindingPipe;\n-        });\n+        }\n \n         it('should get symbol for pipe', () => {\n+          setupPipesTest();\n           const pipeSymbol = templateTypeChecker.getSymbolOfNode(binding, cmp)!;\n-          assertExpressionSymbol(pipeSymbol);\n+          assertPipeSymbol(pipeSymbol);\n           expect(program.getTypeChecker().symbolToString(pipeSymbol.tsSymbol!))\n               .toEqual('transform');\n-          expect(\n-              (pipeSymbol.tsSymbol!.declarations[0].parent as ts.ClassDeclaration).name!.getText())\n+          expect(program.getTypeChecker().symbolToString(pipeSymbol.classSymbol.tsSymbol))\n               .toEqual('TestPipe');\n-          expect(program.getTypeChecker().typeToString(pipeSymbol.tsType))\n+          expect(program.getTypeChecker().typeToString(pipeSymbol.tsType!))\n               .toEqual('(value: string, repeat: number, commaSeparate: boolean) => string[]');\n         });\n \n-        it('should get symbols for pipe expression and args', () => {\n-          const aSymbol = templateTypeChecker.getSymbolOfNode(binding.exp, cmp)!;\n-          assertExpressionSymbol(aSymbol);\n-          expect(program.getTypeChecker().symbolToString(aSymbol.tsSymbol!)).toEqual('a');\n-          expect(program.getTypeChecker().typeToString(aSymbol.tsType)).toEqual('string');\n-\n-          const bSymbol = templateTypeChecker.getSymbolOfNode(binding.args[0], cmp)!;\n-          assertExpressionSymbol(bSymbol);\n-          expect(program.getTypeChecker().symbolToString(bSymbol.tsSymbol!)).toEqual('b');\n-          expect(program.getTypeChecker().typeToString(bSymbol.tsType)).toEqual('number');\n-\n-          const cSymbol = templateTypeChecker.getSymbolOfNode(binding.args[1], cmp)!;\n-          assertExpressionSymbol(cSymbol);\n-          expect(program.getTypeChecker().symbolToString(cSymbol.tsSymbol!)).toEqual('c');\n-          expect(program.getTypeChecker().typeToString(cSymbol.tsType)).toEqual('boolean');\n+        it('should get symbol for pipe, checkTypeOfPipes: false', () => {\n+          setupPipesTest(false);\n+          const pipeSymbol = templateTypeChecker.getSymbolOfNode(binding, cmp)!;\n+          assertPipeSymbol(pipeSymbol);\n+          expect(pipeSymbol.tsSymbol).toBeNull();\n+          expect(program.getTypeChecker().typeToString(pipeSymbol.tsType!)).toEqual('any');\n+          expect(program.getTypeChecker().symbolToString(pipeSymbol.classSymbol.tsSymbol))\n+              .toEqual('TestPipe');\n+          expect(program.getTypeChecker().typeToString(pipeSymbol.classSymbol.tsType))\n+              .toEqual('TestPipe');\n         });\n-      });\n \n+        for (const checkTypeOfPipes of [true, false]) {\n+          describe(`checkTypeOfPipes: ${checkTypeOfPipes}`, () => {\n+            // Because the args are property reads, we still need information about them.\n+            it(`should get symbols for pipe expression and args`, () => {\n+              setupPipesTest(checkTypeOfPipes);\n+              const aSymbol = templateTypeChecker.getSymbolOfNode(binding.exp, cmp)!;\n+              assertExpressionSymbol(aSymbol);\n+              expect(program.getTypeChecker().symbolToString(aSymbol.tsSymbol!)).toEqual('a');\n+              expect(program.getTypeChecker().typeToString(aSymbol.tsType)).toEqual('string');\n+\n+              const bSymbol = templateTypeChecker.getSymbolOfNode(binding.args[0], cmp)!;\n+              assertExpressionSymbol(bSymbol);\n+              expect(program.getTypeChecker().symbolToString(bSymbol.tsSymbol!)).toEqual('b');\n+              expect(program.getTypeChecker().typeToString(bSymbol.tsType)).toEqual('number');\n+\n+              const cSymbol = templateTypeChecker.getSymbolOfNode(binding.args[1], cmp)!;\n+              assertExpressionSymbol(cSymbol);\n+              expect(program.getTypeChecker().symbolToString(cSymbol.tsSymbol!)).toEqual('c');\n+              expect(program.getTypeChecker().typeToString(cSymbol.tsType)).toEqual('boolean');\n+            });\n+          });\n+        }\n+      });\n \n       it('should get a symbol for PropertyWrite expressions', () => {\n         const fileName = absoluteFrom('/main.ts');\n@@ -1515,6 +1533,10 @@ function assertExpressionSymbol(tSymbol: Symbol): asserts tSymbol is ExpressionS\n   expect(tSymbol.kind).toEqual(SymbolKind.Expression);\n }\n \n+function assertPipeSymbol(tSymbol: Symbol): asserts tSymbol is PipeSymbol {\n+  expect(tSymbol.kind).toEqual(SymbolKind.Pipe);\n+}\n+\n function assertElementSymbol(tSymbol: Symbol): asserts tSymbol is ElementSymbol {\n   expect(tSymbol.kind).toEqual(SymbolKind.Element);\n }"
        },
        {
            "sha": "ca8861e1d7e30a4b2a261ccd343376e90679674c",
            "filename": "packages/language-service/ivy/definitions.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -67,6 +67,15 @@ export class DefinitionBuilder {\n         // LS users to \"go to definition\" on an item in the template that maps to a class and be\n         // taken to the directive or HTML class.\n         return this.getTypeDefinitionsForTemplateInstance(symbol, node);\n+      case SymbolKind.Pipe: {\n+        if (symbol.tsSymbol !== null) {\n+          return this.getDefinitionsForSymbols(symbol);\n+        } else {\n+          // If there is no `ts.Symbol` for the pipe transform, we want to return the\n+          // type definition (the pipe class).\n+          return this.getTypeDefinitionsForSymbols(symbol.classSymbol);\n+        }\n+      }\n       case SymbolKind.Output:\n       case SymbolKind.Input: {\n         const bindingDefs = this.getDefinitionsForSymbols(...symbol.bindings);\n@@ -135,6 +144,15 @@ export class DefinitionBuilder {\n             node, definitionMeta.parent, templateInfo.component);\n         return [...bindingDefs, ...directiveDefs];\n       }\n+      case SymbolKind.Pipe: {\n+        if (symbol.tsSymbol !== null) {\n+          return this.getTypeDefinitionsForSymbols(symbol);\n+        } else {\n+          // If there is no `ts.Symbol` for the pipe transform, we want to return the\n+          // type definition (the pipe class).\n+          return this.getTypeDefinitionsForSymbols(symbol.classSymbol);\n+        }\n+      }\n       case SymbolKind.Reference:\n         return this.getTypeDefinitionsForSymbols({shimLocation: symbol.targetLocation});\n       case SymbolKind.Expression:"
        },
        {
            "sha": "fb40c07dcbadf0e32405d6013667e4424b555e8e",
            "filename": "packages/language-service/ivy/quick_info.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 10,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Fquick_info.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Fquick_info.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fquick_info.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -5,13 +5,13 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {AST, BindingPipe, ImplicitReceiver, MethodCall, ThisReceiver, TmplAstBoundAttribute, TmplAstNode, TmplAstTextAttribute} from '@angular/compiler';\n+import {AST, ImplicitReceiver, MethodCall, ThisReceiver, TmplAstBoundAttribute, TmplAstNode, TmplAstTextAttribute} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n-import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ExpressionSymbol, InputBindingSymbol, OutputBindingSymbol, ReferenceSymbol, ShimLocation, Symbol, SymbolKind, VariableSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, InputBindingSymbol, OutputBindingSymbol, PipeSymbol, ReferenceSymbol, ShimLocation, Symbol, SymbolKind, VariableSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript';\n \n import {createDisplayParts, DisplayInfoKind, SYMBOL_PUNC, SYMBOL_SPACE, SYMBOL_TEXT, unsafeCastDisplayInfoKindToScriptElementKind} from './display_parts';\n-import {filterAliasImports, getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getTemplateInfoAtPosition, getTextSpanOfNode} from './utils';\n+import {filterAliasImports, getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getTextSpanOfNode} from './utils';\n \n export class QuickInfoBuilder {\n   private readonly typeChecker = this.compiler.getNextProgram().getTypeChecker();\n@@ -47,10 +47,10 @@ export class QuickInfoBuilder {\n         return this.getQuickInfoForDomBinding(symbol);\n       case SymbolKind.Directive:\n         return this.getQuickInfoAtShimLocation(symbol.shimLocation);\n+      case SymbolKind.Pipe:\n+        return this.getQuickInfoForPipeSymbol(symbol);\n       case SymbolKind.Expression:\n-        return this.node instanceof BindingPipe ?\n-            this.getQuickInfoForPipeSymbol(symbol) :\n-            this.getQuickInfoAtShimLocation(symbol.shimLocation);\n+        return this.getQuickInfoAtShimLocation(symbol.shimLocation);\n     }\n   }\n \n@@ -93,10 +93,16 @@ export class QuickInfoBuilder {\n         undefined /* containerName */, this.typeChecker.typeToString(symbol.tsType), documentation);\n   }\n \n-  private getQuickInfoForPipeSymbol(symbol: ExpressionSymbol): ts.QuickInfo|undefined {\n-    const quickInfo = this.getQuickInfoAtShimLocation(symbol.shimLocation);\n-    return quickInfo === undefined ? undefined :\n-                                     updateQuickInfoKind(quickInfo, DisplayInfoKind.PIPE);\n+  private getQuickInfoForPipeSymbol(symbol: PipeSymbol): ts.QuickInfo|undefined {\n+    if (symbol.tsSymbol !== null) {\n+      const quickInfo = this.getQuickInfoAtShimLocation(symbol.shimLocation);\n+      return quickInfo === undefined ? undefined :\n+                                       updateQuickInfoKind(quickInfo, DisplayInfoKind.PIPE);\n+    } else {\n+      return createQuickInfo(\n+          this.typeChecker.typeToString(symbol.classSymbol.tsType), DisplayInfoKind.PIPE,\n+          getTextSpanOfNode(this.node));\n+    }\n   }\n \n   private getQuickInfoForDomBinding(symbol: DomBindingSymbol) {"
        },
        {
            "sha": "661a77c2d72a3250118174ee64a265d922e84176",
            "filename": "packages/language-service/ivy/references.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -95,6 +95,7 @@ export class ReferenceBuilder {\n         const {shimPath, positionInShimFile} = symbol.bindings[0].shimLocation;\n         return this.getReferencesAtTypescriptPosition(shimPath, positionInShimFile);\n       }\n+      case SymbolKind.Pipe:\n       case SymbolKind.Expression: {\n         const {shimPath, positionInShimFile} = symbol.shimLocation;\n         return this.getReferencesAtTypescriptPosition(shimPath, positionInShimFile);"
        },
        {
            "sha": "80eadd2bcaa0e521628f86c9cd0be4b943d8af23",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "added",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -0,0 +1,68 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {initMockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+\n+import {LanguageServiceTestEnvironment} from './env';\n+import {humanizeDefinitionInfo} from './test_utils';\n+\n+describe('definitions', () => {\n+  let env: LanguageServiceTestEnvironment;\n+\n+  it('returns the pipe class as definition when checkTypeOfPipes is false', () => {\n+    initMockFileSystem('Native');\n+    const testFiles: TestFile[] = [\n+      {\n+        name: absoluteFrom('/app.ts'),\n+        contents: `\n+        import {Component, NgModule} from '@angular/core';\n+        import {CommonModule} from '@angular/common';\n+\n+        @Component({templateUrl: 'app.html'})\n+        export class AppCmp {}\n+\n+        @NgModule({declarations: [AppCmp], imports: [CommonModule]})\n+        export class AppModule {}\n+      `,\n+        isRoot: true\n+      },\n+      {\n+        name: absoluteFrom('/app.html'),\n+        contents: `Will be overridden`,\n+      }\n+    ];\n+    // checkTypeOfPipes is set to false when strict templates is false\n+    env = LanguageServiceTestEnvironment.setup(testFiles, {strictTemplates: false});\n+    const definitions = getDefinitionsAndAssertBoundSpan(\n+        {templateOverride: '{{\"1/1/2020\" | dat¦e}}', expectedSpanText: 'date'});\n+    expect(definitions!.length).toEqual(1);\n+\n+    const [def] = definitions;\n+    expect(def.textSpan).toContain('DatePipe');\n+    expect(def.contextSpan).toContain('DatePipe');\n+  });\n+\n+  function getDefinitionsAndAssertBoundSpan(\n+      {templateOverride, expectedSpanText}: {templateOverride: string, expectedSpanText: string}):\n+      Array<{textSpan: string, contextSpan: string | undefined, fileName: string}> {\n+    const {cursor, text} =\n+        env.overrideTemplateWithCursor(absoluteFrom('/app.ts'), 'AppCmp', templateOverride);\n+    env.expectNoSourceDiagnostics();\n+    env.expectNoTemplateDiagnostics(absoluteFrom('/app.ts'), 'AppCmp');\n+    const definitionAndBoundSpan =\n+        env.ngLS.getDefinitionAndBoundSpan(absoluteFrom('/app.html'), cursor);\n+    const {textSpan, definitions} = definitionAndBoundSpan!;\n+    expect(text.substring(textSpan.start, textSpan.start + textSpan.length))\n+        .toEqual(expectedSpanText);\n+    expect(definitions).toBeTruthy();\n+    const overrides = new Map<string, string>();\n+    overrides.set(absoluteFrom('/app.ts'), text);\n+    return definitions!.map(d => humanizeDefinitionInfo(d, env.host, overrides));\n+  }\n+});"
        },
        {
            "sha": "8a23f4b5a9e90b0b3d31b36ae68b678795df4943",
            "filename": "packages/language-service/ivy/test/quick_info_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -507,6 +507,15 @@ describe('quick info', () => {\n         expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<string>'\n       });\n     });\n+\n+    it('should work for pipes even if checkTypeOfPipes is false', () => {\n+      initMockFileSystem('Native');\n+      // checkTypeOfPipes is set to false when strict templates is false\n+      env = LanguageServiceTestEnvironment.setup(quickInfoSkeleton(), {strictTemplates: false});\n+      const templateOverride = `<p>The hero's birthday is {{birthday | da¦te: \"MM/dd/yy\"}}</p>`;\n+      expectQuickInfo(\n+          {templateOverride, expectedSpanText: 'date', expectedDisplayString: '(pipe) DatePipe'});\n+    });\n   });\n \n   function expectQuickInfo("
        },
        {
            "sha": "6c414ed064d6d37f51350fdf85f6bc21b09325d3",
            "filename": "packages/language-service/ivy/test/test_utils.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Ftest_utils.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -10,6 +10,8 @@ import {absoluteFrom as _} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {LanguageServiceTestEnvironment} from '@angular/language-service/ivy/test/env';\n \n+import {MockServerHost} from './mock_host';\n+\n export function getText(contents: string, textSpan: ts.TextSpan) {\n   return contents.substr(textSpan.start, textSpan.length);\n }\n@@ -51,3 +53,25 @@ export function createModuleWithDeclarations(\n   return LanguageServiceTestEnvironment.setup(\n       [moduleFile, ...filesWithClassDeclarations, ...externalResourceFiles]);\n }\n+\n+export interface HumanizedDefinitionInfo {\n+  fileName: string;\n+  textSpan: string;\n+  contextSpan: string|undefined;\n+}\n+\n+export function humanizeDefinitionInfo(\n+    def: ts.DefinitionInfo, host: MockServerHost,\n+    overrides: Map<string, string> = new Map()): HumanizedDefinitionInfo {\n+  const contents = (overrides.get(def.fileName) !== undefined ? overrides.get(def.fileName) :\n+                                                                host.readFile(def.fileName)) ??\n+      '';\n+\n+  return {\n+    fileName: def.fileName,\n+    textSpan: contents.substr(def.textSpan.start, def.textSpan.start + def.textSpan.length),\n+    contextSpan: def.contextSpan ?\n+        contents.substr(def.contextSpan.start, def.contextSpan.start + def.contextSpan.length) :\n+        undefined,\n+  };\n+}"
        },
        {
            "sha": "0fbe43830cfa3cb14a3757365729ee5f1f7e2130",
            "filename": "packages/language-service/ivy/test/type_definitions_spec.ts",
            "status": "added",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/angular/angular/blob/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Ftest%2Ftype_definitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd/packages%2Flanguage-service%2Fivy%2Ftest%2Ftype_definitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Ftype_definitions_spec.ts?ref=2b74a05a6539b78ed6682e29d4c3b5a6052a9cdd",
            "patch": "@@ -0,0 +1,63 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {initMockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+\n+import {LanguageServiceTestEnvironment} from './env';\n+import {HumanizedDefinitionInfo, humanizeDefinitionInfo} from './test_utils';\n+\n+describe('type definitions', () => {\n+  let env: LanguageServiceTestEnvironment;\n+\n+  it('returns the pipe class as definition when checkTypeOfPipes is false', () => {\n+    initMockFileSystem('Native');\n+    const testFiles: TestFile[] = [\n+      {\n+        name: absoluteFrom('/app.ts'),\n+        contents: `\n+        import {Component, NgModule} from '@angular/core';\n+        import {CommonModule} from '@angular/common';\n+\n+        @Component({templateUrl: 'app.html'})\n+        export class AppCmp {}\n+\n+        @NgModule({declarations: [AppCmp], imports: [CommonModule]})\n+        export class AppModule {}\n+      `,\n+        isRoot: true\n+      },\n+      {\n+        name: absoluteFrom('/app.html'),\n+        contents: `Will be overridden`,\n+      }\n+    ];\n+    // checkTypeOfPipes is set to false when strict templates is false\n+    env = LanguageServiceTestEnvironment.setup(testFiles, {strictTemplates: false});\n+    const definitions =\n+        getTypeDefinitionsAndAssertBoundSpan({templateOverride: '{{\"1/1/2020\" | dat¦e}}'});\n+    expect(definitions!.length).toEqual(1);\n+\n+    const [def] = definitions;\n+    expect(def.textSpan).toContain('DatePipe');\n+    expect(def.contextSpan).toContain('DatePipe');\n+  });\n+\n+  function getTypeDefinitionsAndAssertBoundSpan({templateOverride}: {templateOverride: string}):\n+      HumanizedDefinitionInfo[] {\n+    const {cursor, text} =\n+        env.overrideTemplateWithCursor(absoluteFrom('/app.ts'), 'AppCmp', templateOverride);\n+    env.expectNoSourceDiagnostics();\n+    env.expectNoTemplateDiagnostics(absoluteFrom('/app.ts'), 'AppCmp');\n+    const defs = env.ngLS.getTypeDefinitionAtPosition(absoluteFrom('/app.html'), cursor);\n+    expect(defs).toBeTruthy();\n+    const overrides = new Map<string, string>();\n+    overrides.set(absoluteFrom('/app.html'), text);\n+    return defs!.map(d => humanizeDefinitionInfo(d, env.host, overrides));\n+  }\n+});"
        }
    ],
    "stats": {
        "total": 405,
        "additions": 349,
        "deletions": 56
    }
}