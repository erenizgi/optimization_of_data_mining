{
    "author": "mgechev",
    "message": "test(devtools): add tests for the frame merge algorithm",
    "sha": "224cc433ddee38bfae5810addb6a8f9353d54bf7",
    "files": [
        {
            "sha": "d8b41908b94f32a03f1077eeb448a19752709b6e",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/profiler/recording/timeline/frame-selector/frame-selector.component.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/224cc433ddee38bfae5810addb6a8f9353d54bf7/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Fframe-selector%2Fframe-selector.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/224cc433ddee38bfae5810addb6a8f9353d54bf7/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Fframe-selector%2Fframe-selector.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Fframe-selector%2Fframe-selector.component.ts?ref=224cc433ddee38bfae5810addb6a8f9353d54bf7",
            "patch": "@@ -3,7 +3,6 @@ import { GraphNode } from '../record-formatter/record-formatter';\n import { Observable, Subscription } from 'rxjs';\n import { CdkVirtualScrollViewport } from '@angular/cdk/scrolling';\n import { TabUpdate } from '../../../../tab-update';\n-import { map, tap } from 'rxjs/operators';\n \n const ITEM_WIDTH = 29;\n "
        },
        {
            "sha": "ac7a6ba804fbe883279258c5037723e7eac00ff9",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/profiler/recording/timeline/record-formatter/frame-merger.spec.ts",
            "status": "added",
            "additions": 161,
            "deletions": 0,
            "changes": 161,
            "blob_url": "https://github.com/angular/angular/blob/224cc433ddee38bfae5810addb6a8f9353d54bf7/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecord-formatter%2Fframe-merger.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/224cc433ddee38bfae5810addb6a8f9353d54bf7/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecord-formatter%2Fframe-merger.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecord-formatter%2Fframe-merger.spec.ts?ref=224cc433ddee38bfae5810addb6a8f9353d54bf7",
            "patch": "@@ -0,0 +1,161 @@\n+import { mergeFrames } from './frame-merger';\n+import { ProfilerFrame } from 'protocol';\n+\n+describe('mergeFrames', () => {\n+  it('should work with empty frames', () => {\n+    expect(mergeFrames([])).toBeNull();\n+  });\n+\n+  it('should work with a single frame', () => {\n+    const frame = {\n+      directives: [\n+        {\n+          children: [],\n+          directives: [\n+            {\n+              isComponent: false,\n+              isElement: false,\n+              lifecycle: {},\n+              name: 'Foo',\n+            },\n+          ],\n+        },\n+      ],\n+      duration: 5,\n+      source: 'foo',\n+    };\n+    const result = mergeFrames([frame]);\n+\n+    expect(result).toEqual(frame);\n+\n+    // Should be different reference\n+    expect(result).not.toBe(frame);\n+  });\n+\n+  it('should merge frames when nesting matches', () => {\n+    const frame = {\n+      directives: [\n+        {\n+          children: [],\n+          directives: [\n+            {\n+              isComponent: false,\n+              isElement: false,\n+              lifecycle: {},\n+              changeDetection: 10,\n+              name: 'Foo',\n+            },\n+          ],\n+        },\n+      ],\n+      duration: 5,\n+      source: 'foo',\n+    };\n+    const result = mergeFrames([frame, frame]);\n+\n+    expect(result).toEqual({\n+      directives: [\n+        {\n+          children: [],\n+          directives: [\n+            {\n+              isComponent: false,\n+              isElement: false,\n+              lifecycle: {},\n+              changeDetection: 20,\n+              name: 'Foo',\n+            },\n+          ],\n+        },\n+      ],\n+      duration: 10,\n+      source: '',\n+    });\n+  });\n+\n+  it('should merge frames when nesting does not match', () => {\n+    const frame = {\n+      directives: [\n+        {\n+          children: [],\n+          directives: [\n+            {\n+              isComponent: false,\n+              isElement: false,\n+              lifecycle: {},\n+              changeDetection: 10,\n+              name: 'Foo',\n+            },\n+          ],\n+        },\n+      ],\n+      duration: 5,\n+      source: 'foo',\n+    };\n+\n+    const frame2: ProfilerFrame = {\n+      directives: [\n+        {\n+          children: [\n+            {\n+              children: [],\n+              directives: [\n+                {\n+                  isComponent: false,\n+                  isElement: false,\n+                  lifecycle: {},\n+                  changeDetection: 10,\n+                  name: 'Foo',\n+                },\n+              ],\n+            },\n+          ],\n+          directives: [\n+            {\n+              isComponent: false,\n+              isElement: false,\n+              lifecycle: {},\n+              changeDetection: 10,\n+              name: 'Foo',\n+            },\n+          ],\n+        },\n+      ],\n+      duration: 5,\n+      source: 'foo',\n+    };\n+    const result = mergeFrames([frame, frame2]);\n+\n+    expect(result).toEqual({\n+      directives: [\n+        {\n+          children: [\n+            {\n+              children: [],\n+              directives: [\n+                {\n+                  isComponent: false,\n+                  isElement: false,\n+                  lifecycle: {},\n+                  changeDetection: 10,\n+                  name: 'Foo',\n+                },\n+              ],\n+            },\n+          ],\n+          directives: [\n+            {\n+              isComponent: false,\n+              isElement: false,\n+              lifecycle: {},\n+              changeDetection: 20,\n+              name: 'Foo',\n+            },\n+          ],\n+        },\n+      ],\n+      duration: 10,\n+      source: '',\n+    });\n+  });\n+});"
        },
        {
            "sha": "8508e5e6a73a6812779fc30609ede37e2b6ef99e",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/profiler/recording/timeline/record-formatter/frame-merger.ts",
            "status": "added",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/angular/angular/blob/224cc433ddee38bfae5810addb6a8f9353d54bf7/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecord-formatter%2Fframe-merger.ts",
            "raw_url": "https://github.com/angular/angular/raw/224cc433ddee38bfae5810addb6a8f9353d54bf7/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecord-formatter%2Fframe-merger.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecord-formatter%2Fframe-merger.ts?ref=224cc433ddee38bfae5810addb6a8f9353d54bf7",
            "patch": "@@ -0,0 +1,55 @@\n+import { ProfilerFrame, DirectiveProfile, ElementProfile } from 'protocol';\n+\n+const mergeProperty = (mergeInProp: number | undefined, value: number | undefined) => {\n+  if (mergeInProp === undefined) {\n+    return value;\n+  }\n+  if (value === undefined) {\n+    return mergeInProp;\n+  }\n+  return mergeInProp + value;\n+};\n+\n+const mergeDirective = (mergeIn: DirectiveProfile, second: DirectiveProfile) => {\n+  mergeIn.changeDetection = mergeProperty(mergeIn.changeDetection, second.changeDetection);\n+  Object.keys(mergeIn.lifecycle).forEach((hook) => {\n+    mergeIn.lifecycle[hook] = mergeProperty(mergeIn.lifecycle[hook], second.lifecycle[hook]);\n+  });\n+};\n+\n+const mergeDirectives = (mergeIn: ElementProfile[], second: ElementProfile[]) => {\n+  for (let i = 0; i < second.length; i++) {\n+    if (!mergeIn[i]) {\n+      mergeIn[i] = {\n+        children: [],\n+        directives: [],\n+      };\n+    }\n+    second[i].directives.forEach((d, idx) => {\n+      const mergeInDirective = mergeIn[i].directives[idx];\n+      if (mergeInDirective && mergeInDirective.name === d.name) {\n+        mergeDirective(mergeInDirective, d);\n+      } else {\n+        mergeIn[i].directives.push(d);\n+      }\n+    });\n+    mergeDirectives(mergeIn[i].children, second[i].children);\n+  }\n+};\n+\n+const mergeFrame = (mergeIn: ProfilerFrame, second: ProfilerFrame) => {\n+  mergeIn.duration += second.duration;\n+  mergeIn.source = '';\n+  mergeDirectives(mergeIn.directives, second.directives);\n+};\n+\n+export const mergeFrames = (frames: ProfilerFrame[]): ProfilerFrame | null => {\n+  if (!frames || !frames.length) {\n+    return null;\n+  }\n+  const first = JSON.parse(JSON.stringify(frames[0]));\n+  for (let i = 1; i < frames.length; i++) {\n+    mergeFrame(first, frames[i]);\n+  }\n+  return first;\n+};"
        },
        {
            "sha": "600c5f8f06379427e7d0b0f9fb95eaba847e11db",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/profiler/recording/timeline/record-formatter/record-formatter.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 55,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/224cc433ddee38bfae5810addb6a8f9353d54bf7/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecord-formatter%2Frecord-formatter.ts",
            "raw_url": "https://github.com/angular/angular/raw/224cc433ddee38bfae5810addb6a8f9353d54bf7/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecord-formatter%2Frecord-formatter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecord-formatter%2Frecord-formatter.ts?ref=224cc433ddee38bfae5810addb6a8f9353d54bf7",
            "patch": "@@ -1,4 +1,4 @@\n-import { ElementProfile, DirectiveProfile, ProfilerFrame, ElementPosition } from 'protocol';\n+import { ElementProfile, DirectiveProfile, ProfilerFrame } from 'protocol';\n \n export interface TimelineView<T> {\n   timeline: AppEntry<T>[];\n@@ -52,57 +52,3 @@ export abstract class RecordFormatter<T> {\n     return result;\n   }\n }\n-\n-const mergeProperty = (mergeInProp: number | undefined, value: number | undefined) => {\n-  if (mergeInProp === undefined) {\n-    return value;\n-  }\n-  if (value === undefined) {\n-    return mergeInProp;\n-  }\n-  return mergeInProp + value;\n-};\n-\n-const mergeDirective = (mergeIn: DirectiveProfile, second: DirectiveProfile) => {\n-  mergeIn.changeDetection = mergeProperty(mergeIn.changeDetection, second.changeDetection);\n-  Object.keys(mergeIn.lifecycle).forEach((hook) => {\n-    mergeIn.lifecycle[hook] = mergeProperty(mergeIn.lifecycle[hook], second.lifecycle[hook]);\n-  });\n-};\n-\n-const mergeDirectives = (mergeIn: ElementProfile[], second: ElementProfile[]) => {\n-  for (let i = 0; i < second.length; i++) {\n-    if (!mergeIn[i]) {\n-      mergeIn[i] = {\n-        children: [],\n-        directives: [],\n-      };\n-    }\n-    second[i].directives.forEach((d, idx) => {\n-      const mergeInDirective = mergeIn[i].directives[idx];\n-      if (mergeInDirective && mergeInDirective.name === d.name) {\n-        mergeDirective(mergeInDirective, d);\n-      } else {\n-        mergeIn[i].directives.push(d);\n-      }\n-    });\n-    mergeDirectives(mergeIn[i].children, second[i].children);\n-  }\n-};\n-\n-const mergeFrame = (mergeIn: ProfilerFrame, second: ProfilerFrame) => {\n-  mergeIn.duration += second.duration;\n-  mergeIn.source = '';\n-  mergeDirectives(mergeIn.directives, second.directives);\n-};\n-\n-export const mergeFrames = (frames: ProfilerFrame[]): ProfilerFrame | null => {\n-  if (!frames || !frames.length) {\n-    return null;\n-  }\n-  const first = JSON.parse(JSON.stringify(frames[0]));\n-  for (let i = 1; i < frames.length; i++) {\n-    mergeFrame(first, frames[i]);\n-  }\n-  return first;\n-};"
        },
        {
            "sha": "97da3f72fa5af185e991c1fa4e98746c6f541db5",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/profiler/recording/timeline/timeline.component.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/224cc433ddee38bfae5810addb6a8f9353d54bf7/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Ftimeline.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/224cc433ddee38bfae5810addb6a8f9353d54bf7/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Ftimeline.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Ftimeline.component.ts?ref=224cc433ddee38bfae5810addb6a8f9353d54bf7",
            "patch": "@@ -1,8 +1,9 @@\n import { Component, EventEmitter, Input, Output, OnDestroy } from '@angular/core';\n import { ProfilerFrame } from 'protocol';\n-import { GraphNode, mergeFrames } from './record-formatter/record-formatter';\n+import { GraphNode } from './record-formatter/record-formatter';\n import { Observable, Subscription, BehaviorSubject } from 'rxjs';\n import { share } from 'rxjs/operators';\n+import { mergeFrames } from './record-formatter/frame-merger';\n \n export enum VisualizationMode {\n   FlameGraph,"
        }
    ],
    "stats": {
        "total": 276,
        "additions": 219,
        "deletions": 57
    }
}