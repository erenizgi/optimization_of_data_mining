{
    "author": "atscott",
    "message": "fix(language-service): Always attempt HTML AST to template AST conversion for LS (#41068)\n\nThe current logic in the compiler is to bail when there are errors when\nparsing a template into an HTML AST or when there are errors in the i18n\nmetadata. As a result, a template with these types of parse errors\n_will not have any information for the language service_. This is because we\nnever attempt to conver the HTML AST to a template AST in these\nscenarios, so there are no template AST nodes for the language service\nto look at for information. In addition, this also means that the errors\nare never displayed in the template to the user because there are no\nnodes to map the error to.\n\nThis commit adds an option to the template parser to temporarily ignore\nthe html parse and i18n meta errors and always perform the template AST\nconversion. At the end, the i18n and HTML parse errors are appended to\nthe returned errors list. While this seems risky, it at least provides\nus with more information than we had before (which was 0) and it's only\ndone in the context of the language service, when the compiler is\nconfigured to use poisoned data (HTML parse and i18n meta errors can be\ninterpreted as a \"poisoned\" template).\n\nfixes angular/vscode-ng-language-service#1140\n\nPR Close #41068",
    "sha": "0847a0353b87cd181ef2a257e36126a888f02d75",
    "files": [
        {
            "sha": "55c9597c9a3bdb0a8453ac733eea359e2e60bf26",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=0847a0353b87cd181ef2a257e36126a888f02d75",
            "patch": "@@ -975,6 +975,7 @@ export class ComponentDecoratorHandler implements\n       enableI18nLegacyMessageIdFormat: this.enableI18nLegacyMessageIdFormat,\n       i18nNormalizeLineEndingsInICUs,\n       isInline: template.isInline,\n+      alwaysAttemptHtmlToR3AstConversion: this.usePoisonedData,\n     });\n \n     // Unfortunately, the primary parse of the template above may not contain accurate source map\n@@ -1002,6 +1003,7 @@ export class ComponentDecoratorHandler implements\n       i18nNormalizeLineEndingsInICUs,\n       leadingTriviaChars: [],\n       isInline: template.isInline,\n+      alwaysAttemptHtmlToR3AstConversion: this.usePoisonedData,\n     });\n \n     return {"
        },
        {
            "sha": "4103a3f06b3c8ad35a45b5921e3bcee256201c88",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 4,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=0847a0353b87cd181ef2a257e36126a888f02d75",
            "patch": "@@ -2096,6 +2096,22 @@ export interface ParseTemplateOptions {\n    * Whether the template was inline.\n    */\n   isInline?: boolean;\n+\n+  /**\n+   * Whether to always attempt to convert the parsed HTML AST to an R3 AST, despite HTML or i18n\n+   * Meta parse errors.\n+   *\n+   *\n+   * This option is useful in the context of the language service, where we want to get as much\n+   * information as possible, despite any errors in the HTML. As an example, a user may be adding\n+   * a new tag and expecting autocomplete on that tag. In this scenario, the HTML is in an errored\n+   * state, as there is an incomplete open tag. However, we're still able to convert the HTML AST\n+   * nodes to R3 AST nodes in order to provide information for the language service.\n+   *\n+   * Note that even when `true` the HTML parse and i18n errors are still appended to the errors\n+   * output, but this is done after converting the HTML AST to R3 AST.\n+   */\n+  alwaysAttemptHtmlToR3AstConversion?: boolean;\n }\n \n /**\n@@ -2115,9 +2131,8 @@ export function parseTemplate(\n       template, templateUrl,\n       {leadingTriviaChars: LEADING_TRIVIA_CHARS, ...options, tokenizeExpansionForms: true});\n \n-  if (parseResult.errors && parseResult.errors.length > 0) {\n-    // TODO(ayazhafiz): we may not always want to bail out at this point (e.g. in\n-    // the context of a language service).\n+  if (!options.alwaysAttemptHtmlToR3AstConversion && parseResult.errors &&\n+      parseResult.errors.length > 0) {\n     return {\n       interpolationConfig,\n       preserveWhitespaces,\n@@ -2143,7 +2158,8 @@ export function parseTemplate(\n       enableI18nLegacyMessageIdFormat);\n   const i18nMetaResult = i18nMetaVisitor.visitAllWithErrors(rootNodes);\n \n-  if (i18nMetaResult.errors && i18nMetaResult.errors.length > 0) {\n+  if (!options.alwaysAttemptHtmlToR3AstConversion && i18nMetaResult.errors &&\n+      i18nMetaResult.errors.length > 0) {\n     return {\n       interpolationConfig,\n       preserveWhitespaces,\n@@ -2175,6 +2191,7 @@ export function parseTemplate(\n \n   const {nodes, errors, styleUrls, styles, ngContentSelectors} =\n       htmlAstToRender3Ast(rootNodes, bindingParser);\n+  errors.push(...parseResult.errors, ...i18nMetaResult.errors);\n \n   return {\n     interpolationConfig,"
        },
        {
            "sha": "d27e7e51d429c222bd7214d9830395eb40b74205",
            "filename": "packages/compiler/test/render3/r3_template_transform_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_template_transform_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_template_transform_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_template_transform_spec.ts?ref=0847a0353b87cd181ef2a257e36126a888f02d75",
            "patch": "@@ -116,6 +116,19 @@ describe('R3 template transform', () => {\n   });\n \n   describe('Nodes without binding', () => {\n+    it('should parse incomplete tags terminated by EOF', () => {\n+      expectFromHtml('<a', true /* ignoreError */).toEqual([\n+        ['Element', 'a'],\n+      ]);\n+    });\n+\n+    it('should parse incomplete tags terminated by another tag', () => {\n+      expectFromHtml('<a <span></span>', true /* ignoreError */).toEqual([\n+        ['Element', 'a'],\n+        ['Element', 'span'],\n+      ]);\n+    });\n+\n     it('should parse text nodes', () => {\n       expectFromHtml('a').toEqual([\n         ['Text', 'a'],"
        },
        {
            "sha": "62d4139decace9d7d4f3a5815111b1ed31b7e406",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=0847a0353b87cd181ef2a257e36126a888f02d75",
            "patch": "@@ -353,6 +353,23 @@ describe('completions', () => {\n       expect(ts.displayPartsToString(details.documentation!)).toEqual('This is another component.');\n     });\n \n+    it('should return completions for an incomplete tag', () => {\n+      const OTHER_CMP = {\n+        'OtherCmp': `\n+            /** This is another component. */\n+            @Component({selector: 'other-cmp', template: 'unimportant'})\n+            export class OtherCmp {}\n+          `,\n+      };\n+      const {templateFile} = setup(`<other`, '', OTHER_CMP);\n+      templateFile.moveCursorToText('<other¦');\n+\n+      const completions = templateFile.getCompletionsAtPosition();\n+      expectContain(\n+          completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.COMPONENT),\n+          ['other-cmp']);\n+    });\n+\n     it('should return completions with a blank open tag', () => {\n       const OTHER_CMP = {\n         'OtherCmp': `\n@@ -397,6 +414,10 @@ describe('completions', () => {\n \n       const completions = templateFile.getCompletionsAtPosition();\n       expect(completions).toBeUndefined();\n+\n+\n+      const details = templateFile.getCompletionEntryDetails('other-cmp')!;\n+      expect(details).toBeUndefined();\n     });\n \n     describe('element attribute scope', () => {"
        },
        {
            "sha": "5288e068145cafe34efc2ef04f45945903d84b09",
            "filename": "packages/language-service/ivy/test/diagnostic_spec.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 1,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts?ref=0847a0353b87cd181ef2a257e36126a888f02d75",
            "patch": "@@ -19,7 +19,7 @@ describe('getSemanticDiagnostics', () => {\n     env = LanguageServiceTestEnv.setup();\n   });\n \n-  it('should not produce error for a minimal component defintion', () => {\n+  it('should not produce error for a minimal component definition', () => {\n     const files = {\n       'app.ts': `\n       import {Component, NgModule} from '@angular/core';\n@@ -124,6 +124,34 @@ describe('getSemanticDiagnostics', () => {\n             `Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = true}}]`);\n   });\n \n+  it('reports html parse errors along with typecheck errors as diagnostics', () => {\n+    const files = {\n+      'app.ts': `\n+      import {Component, NgModule} from '@angular/core';\n+\n+      @Component({\n+        templateUrl: './app.html'\n+      })\n+      export class AppComponent {\n+        nope = false;\n+      }\n+    `,\n+      'app.html': '<dne'\n+    };\n+\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const diags = project.getDiagnosticsForFile('app.html');\n+    expect(diags.length).toBe(2);\n+\n+    expect(diags[0].category).toBe(ts.DiagnosticCategory.Error);\n+    expect(diags[0].file?.fileName).toBe('/test/app.html');\n+    expect(diags[0].messageText).toContain(`'dne' is not a known element`);\n+\n+    expect(diags[1].category).toBe(ts.DiagnosticCategory.Error);\n+    expect(diags[1].file?.fileName).toBe('/test/app.html');\n+    expect(diags[1].messageText).toContain(`Opening tag \"dne\" not terminated.`);\n+  });\n+\n   it('should report parse errors of components defined in the same ts file', () => {\n     const files = {\n       'app.ts': `"
        },
        {
            "sha": "01623e9d7cd14e355e083718b3fc2b0d24f4a4a2",
            "filename": "packages/language-service/ivy/test/legacy/template_target_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftemplate_target_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0847a0353b87cd181ef2a257e36126a888f02d75/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftemplate_target_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftemplate_target_spec.ts?ref=0847a0353b87cd181ef2a257e36126a888f02d75",
            "patch": "@@ -35,12 +35,23 @@ function parse(template: string): ParseResult {\n       // `ComponentDecoratorHandler._parseTemplate`.\n       leadingTriviaChars: [],\n       preserveWhitespaces: true,\n+      alwaysAttemptHtmlToR3AstConversion: true,\n     }),\n     position,\n   };\n }\n \n describe('getTargetAtPosition for template AST', () => {\n+  it('should locate incomplete tag', () => {\n+    const {errors, nodes, position} = parse(`<div¦`);\n+    expect(errors?.length).toBe(1);\n+    expect(errors![0].msg).toContain('Opening tag \"div\" not terminated.');\n+    const {context} = getTargetAtPosition(nodes, position)!;\n+    const {node} = context as SingleNodeTarget;\n+    expect(isTemplateNode(node!)).toBe(true);\n+    expect(node).toBeInstanceOf(t.Element);\n+  });\n+\n   it('should locate element in opening tag', () => {\n     const {errors, nodes, position} = parse(`<di¦v></div>`);\n     expect(errors).toBe(null);"
        }
    ],
    "stats": {
        "total": 102,
        "additions": 97,
        "deletions": 5
    }
}