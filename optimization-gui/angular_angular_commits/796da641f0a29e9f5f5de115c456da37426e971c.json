{
    "author": "atscott",
    "message": "fix(router): Do not modify parts of URL excluded from with 'eager' updates (#43421)\n\nThe previous code would set the browser URL to be only the part that's\nextracted by the `UrlHandlingStrategy`. However, there may be parts of\nthe URL which are _should not_ be handled by the Angular Router. This\nchange updates the code to set the browser URL in the same way that's\ndone with `'deferred'`: Merging the extracted URL after redirects with\nthe whole raw URL of the navigation, which includes parts not handled by\nthe `UrlHandlingStrategy`.\n\nPR Close #43421",
    "sha": "796da641f0a29e9f5f5de115c456da37426e971c",
    "files": [
        {
            "sha": "791e2dd91ec5b8d00ccffb3fe9dc3c97554d3dbf",
            "filename": "packages/router/src/router.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/796da641f0a29e9f5f5de115c456da37426e971c/packages%2Frouter%2Fsrc%2Frouter.ts",
            "raw_url": "https://github.com/angular/angular/raw/796da641f0a29e9f5f5de115c456da37426e971c/packages%2Frouter%2Fsrc%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter.ts?ref=796da641f0a29e9f5f5de115c456da37426e971c",
            "patch": "@@ -715,14 +715,9 @@ export class Router {\n                              tap(t => {\n                                if (this.urlUpdateStrategy === 'eager') {\n                                  if (!t.extras.skipLocationChange) {\n-                                   this.setBrowserUrl(t.urlAfterRedirects, t);\n-                                   // TODO(atscott): The above line is incorrect. It sets the url to\n-                                   // only the part that is handled by the router. It should merge\n-                                   // that with the rawUrl so the url includes segments not handled\n-                                   // by the router:\n-                                   //  const rawUrl = this.urlHandlingStrategy.merge(\n-                                   //      t.urlAfterRedirects, t.rawUrl);\n-                                   //  this.setBrowserUrl(rawUrl, t);\n+                                   const rawUrl = this.urlHandlingStrategy.merge(\n+                                       t.urlAfterRedirects, t.rawUrl);\n+                                   this.setBrowserUrl(rawUrl, t);\n                                  }\n                                  this.browserUrlTree = t.urlAfterRedirects;\n                                }"
        },
        {
            "sha": "8260192a160f214ca2311384a61500395dbe9b80",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 14,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/796da641f0a29e9f5f5de115c456da37426e971c/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/796da641f0a29e9f5f5de115c456da37426e971c/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=796da641f0a29e9f5f5de115c456da37426e971c",
            "patch": "@@ -5647,28 +5647,23 @@ describe('Integration', () => {\n            ]);\n          })));\n \n-      it('should not reset parts of the URL not handled by the router', fakeAsync(() => {\n-           const location = TestBed.inject(Location) as SpyLocation;\n+      it('should not remove parts of the URL that are not handled by the router when \"eager\"',\n+         fakeAsync(() => {\n            const router = TestBed.inject(Router);\n+           router.urlUpdateStrategy = 'eager';\n+           const location = TestBed.inject(Location) as SpyLocation;\n            const fixture = createRoot(router, RootCmp);\n \n            router.resetConfig([{\n              path: 'include',\n              component: TeamCmp,\n-             children:\n-                 [{path: 'user/:name', component: UserCmp}, {path: 'simple', component: SimpleCmp}]\n+             children: [{path: 'user/:name', component: UserCmp}]\n            }]);\n \n-           try {\n-             location.simulateHashChange('/include/butThisPartNotFound(aux:excluded)');\n-             advance(fixture);\n-           } catch (e) {\n-           }\n-           // The router only handled the primary URL. So it processes the navigation and then\n-           // cannot match the `butThisPartNotFound` part to a URL, throws an error, and then\n-           // resets the state in the `catchError` block. The excluded part of the URL _should not_\n-           // be reset because it might be handled by another application.\n-           expect(location.path()).toEqual('/(aux:excluded)');\n+           location.simulateHashChange('/include/user/kate(aux:excluded)');\n+           advance(fixture);\n+\n+           expect(location.path()).toEqual('/include/user/kate(aux:excluded)');\n          }));\n     });\n "
        }
    ],
    "stats": {
        "total": 34,
        "additions": 12,
        "deletions": 22
    }
}