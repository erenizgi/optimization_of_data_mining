{
    "author": "alxhub",
    "message": "refactor(compiler-cli): make `TypeCheckingScopeRegistry` a general utility (#40032)\n\nThe `annotations` package in the compiler previously contained a registry\nwhich tracks NgModule scopes for template type-checking, including unifying\nall type-checking metadata across class inheritance lines.\n\nThis commit generalizes this utility and prepares it for use in the\n`TemplateTypeChecker` as well, to back APIs used by the language service.\n\nPR Close #40032",
    "sha": "a543e6949781b4dbfba04e73b3e26922a479861a",
    "files": [
        {
            "sha": "aa4a619fd827eecd69c0ec12f906ca5f1e469edf",
            "filename": "packages/compiler-cli/ngcc/src/analysis/decoration_analyzer.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "raw_url": "https://github.com/angular/angular/raw/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts?ref=a543e6949781b4dbfba04e73b3e26922a479861a",
            "patch": "@@ -16,7 +16,7 @@ import {absoluteFrom, absoluteFromSourceFile, dirname, FileSystem, LogicalFileSy\n import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, NOOP_DEFAULT_IMPORT_RECORDER, PrivateExportAliasingHost, Reexport, ReferenceEmitter} from '../../../src/ngtsc/imports';\n import {CompoundMetadataReader, CompoundMetadataRegistry, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry, ResourceRegistry} from '../../../src/ngtsc/metadata';\n import {PartialEvaluator} from '../../../src/ngtsc/partial_evaluator';\n-import {LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver} from '../../../src/ngtsc/scope';\n+import {LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver, TypeCheckScopeRegistry} from '../../../src/ngtsc/scope';\n import {DecoratorHandler} from '../../../src/ngtsc/transform';\n import {NgccReflectionHost} from '../host/ngcc_host';\n import {Migration} from '../migrations/migration';\n@@ -91,11 +91,13 @@ export class DecorationAnalyzer {\n   importGraph = new ImportGraph(this.moduleResolver);\n   cycleAnalyzer = new CycleAnalyzer(this.importGraph);\n   injectableRegistry = new InjectableClassRegistry(this.reflectionHost);\n+  typeCheckScopeRegistry = new TypeCheckScopeRegistry(this.scopeRegistry, this.fullMetaReader);\n   handlers: DecoratorHandler<unknown, unknown, unknown>[] = [\n     new ComponentDecoratorHandler(\n         this.reflectionHost, this.evaluator, this.fullRegistry, this.fullMetaReader,\n-        this.scopeRegistry, this.scopeRegistry, new ResourceRegistry(), this.isCore,\n-        this.resourceManager, this.rootDirs, !!this.compilerOptions.preserveWhitespaces,\n+        this.scopeRegistry, this.scopeRegistry, this.typeCheckScopeRegistry, new ResourceRegistry(),\n+        this.isCore, this.resourceManager, this.rootDirs,\n+        !!this.compilerOptions.preserveWhitespaces,\n         /* i18nUseExternalIds */ true, this.bundle.enableI18nLegacyMessageIdFormat,\n         /* usePoisonedData */ false,\n         /* i18nNormalizeLineEndingsInICUs */ false, this.moduleResolver, this.cycleAnalyzer,"
        },
        {
            "sha": "172276dee0736c1bafa34e6b58faa75d0e7da8e9",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 18,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=a543e6949781b4dbfba04e73b3e26922a479861a",
            "patch": "@@ -18,7 +18,7 @@ import {IndexingContext} from '../../indexer';\n import {ClassPropertyMapping, ComponentResources, DirectiveMeta, DirectiveTypeCheckMeta, extractDirectiveTypeCheckMeta, InjectableClassRegistry, MetadataReader, MetadataRegistry, Resource, ResourceRegistry} from '../../metadata';\n import {EnumValue, PartialEvaluator} from '../../partial_evaluator';\n import {ClassDeclaration, DeclarationNode, Decorator, ReflectionHost, reflectObjectLiteral} from '../../reflection';\n-import {ComponentScopeReader, LocalModuleScopeRegistry} from '../../scope';\n+import {ComponentScopeReader, LocalModuleScopeRegistry, TypeCheckScopeRegistry} from '../../scope';\n import {AnalysisOutput, CompileResult, DecoratorHandler, DetectResult, HandlerFlags, HandlerPrecedence, ResolveResult} from '../../transform';\n import {TemplateSourceMapping, TypeCheckContext} from '../../typecheck/api';\n import {getTemplateId, makeTemplateDiagnostic} from '../../typecheck/diagnostics';\n@@ -30,7 +30,6 @@ import {createValueHasWrongTypeError, getDirectiveDiagnostics, getProviderDiagno\n import {extractDirectiveMetadata, parseFieldArrayValue} from './directive';\n import {compileNgFactoryDefField} from './factory';\n import {generateSetClassMetadataCall} from './metadata';\n-import {TypeCheckScopes} from './typecheck_scopes';\n import {findAngularDecorator, isAngularCoreReference, isExpressionForwardReference, readBaseClass, resolveProvidersRequiringFactory, unwrapExpression, wrapFunctionExpressionsInParens} from './util';\n \n const EMPTY_MAP = new Map<string, Expression>();\n@@ -87,6 +86,7 @@ export class ComponentDecoratorHandler implements\n       private reflector: ReflectionHost, private evaluator: PartialEvaluator,\n       private metaRegistry: MetadataRegistry, private metaReader: MetadataReader,\n       private scopeReader: ComponentScopeReader, private scopeRegistry: LocalModuleScopeRegistry,\n+      private typeCheckScopeRegistry: TypeCheckScopeRegistry,\n       private resourceRegistry: ResourceRegistry, private isCore: boolean,\n       private resourceLoader: ResourceLoader, private rootDirs: ReadonlyArray<string>,\n       private defaultPreserveWhitespaces: boolean, private i18nUseExternalIds: boolean,\n@@ -100,7 +100,6 @@ export class ComponentDecoratorHandler implements\n \n   private literalCache = new Map<Decorator, ts.ObjectLiteralExpression>();\n   private elementSchemaRegistry = new DomElementSchemaRegistry();\n-  private typeCheckScopes = new TypeCheckScopes(this.scopeReader, this.metaReader);\n \n   /**\n    * During the asynchronous preanalyze phase, it's necessary to parse the template to extract\n@@ -440,15 +439,14 @@ export class ComponentDecoratorHandler implements\n \n   typeCheck(ctx: TypeCheckContext, node: ClassDeclaration, meta: Readonly<ComponentAnalysisData>):\n       void {\n-    if (!ts.isClassDeclaration(node)) {\n+    if (this.typeCheckScopeRegistry === null || !ts.isClassDeclaration(node)) {\n       return;\n     }\n \n     if (meta.isPoisoned && !this.usePoisonedData) {\n       return;\n     }\n-\n-    const scope = this.typeCheckScopes.getTypeCheckScope(node);\n+    const scope = this.typeCheckScopeRegistry.getTypeCheckScope(node);\n     if (scope.isPoisoned && !this.usePoisonedData) {\n       // Don't type-check components that had errors in their scopes, unless requested.\n       return;\n@@ -492,17 +490,17 @@ export class ComponentDecoratorHandler implements\n       // Determining this is challenging, because the TemplateDefinitionBuilder is responsible for\n       // matching directives and pipes in the template; however, that doesn't run until the actual\n       // compile() step. It's not possible to run template compilation sooner as it requires the\n-      // ConstantPool for the overall file being compiled (which isn't available until the transform\n-      // step).\n+      // ConstantPool for the overall file being compiled (which isn't available until the\n+      // transform step).\n       //\n-      // Instead, directives/pipes are matched independently here, using the R3TargetBinder. This is\n-      // an alternative implementation of template matching which is used for template type-checking\n-      // and will eventually replace matching in the TemplateDefinitionBuilder.\n+      // Instead, directives/pipes are matched independently here, using the R3TargetBinder. This\n+      // is an alternative implementation of template matching which is used for template\n+      // type-checking and will eventually replace matching in the TemplateDefinitionBuilder.\n \n \n-      // Set up the R3TargetBinder, as well as a 'directives' array and a 'pipes' map that are later\n-      // fed to the TemplateDefinitionBuilder. First, a SelectorMatcher is constructed to match\n-      // directives that are in scope.\n+      // Set up the R3TargetBinder, as well as a 'directives' array and a 'pipes' map that are\n+      // later fed to the TemplateDefinitionBuilder. First, a SelectorMatcher is constructed to\n+      // match directives that are in scope.\n       type MatchedDirective = DirectiveMeta&{selector: string};\n       const matcher = new SelectorMatcher<MatchedDirective>();\n \n@@ -563,8 +561,8 @@ export class ComponentDecoratorHandler implements\n         }\n \n         // Check whether the directive/pipe arrays in Éµcmp need to be wrapped in closures.\n-        // This is required if any directive/pipe reference is to a declaration in the same file but\n-        // declared after this component.\n+        // This is required if any directive/pipe reference is to a declaration in the same file\n+        // but declared after this component.\n         const wrapDirectivesAndPipesInClosure =\n             usedDirectives.some(\n                 dir => isExpressionForwardReference(dir.type, node.name, context)) ||\n@@ -890,8 +888,8 @@ export class ComponentDecoratorHandler implements\n     // 2. By default, the template parser strips leading trivia characters (like spaces, tabs, and\n     //    newlines). This also destroys source mapping information.\n     //\n-    // In order to guarantee the correctness of diagnostics, templates are parsed a second time with\n-    // the above options set to preserve source mappings.\n+    // In order to guarantee the correctness of diagnostics, templates are parsed a second time\n+    // with the above options set to preserve source mappings.\n \n     const {nodes: diagNodes} = parseTemplate(templateStr, templateUrl, {\n       preserveWhitespaces: true,"
        },
        {
            "sha": "51d139cee7bb4897cf4f56b504c2ce74b4ce1daa",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/test/component_spec.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 7,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts?ref=a543e6949781b4dbfba04e73b3e26922a479861a",
            "patch": "@@ -5,6 +5,9 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+\n+import * as ts from 'typescript';\n+\n import {CycleAnalyzer, ImportGraph} from '../../cycles';\n import {ErrorCode, FatalDiagnosticError} from '../../diagnostics';\n import {absoluteFrom} from '../../file_system';\n@@ -13,7 +16,7 @@ import {ModuleResolver, NOOP_DEFAULT_IMPORT_RECORDER, ReferenceEmitter} from '..\n import {CompoundMetadataReader, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry, ResourceRegistry} from '../../metadata';\n import {PartialEvaluator} from '../../partial_evaluator';\n import {isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n-import {LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver} from '../../scope';\n+import {LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver, TypeCheckScopeRegistry} from '../../scope';\n import {getDeclaration, makeProgram} from '../../testing';\n import {ResourceLoader} from '../src/api';\n import {ComponentDecoratorHandler} from '../src/component';\n@@ -48,17 +51,33 @@ function setup(program: ts.Program, options: ts.CompilerOptions, host: ts.Compil\n   const refEmitter = new ReferenceEmitter([]);\n   const injectableRegistry = new InjectableClassRegistry(reflectionHost);\n   const resourceRegistry = new ResourceRegistry();\n+  const typeCheckScopeRegistry = new TypeCheckScopeRegistry(scopeRegistry, metaReader);\n \n   const handler = new ComponentDecoratorHandler(\n-      reflectionHost, evaluator, metaRegistry, metaReader, scopeRegistry, scopeRegistry,\n+      reflectionHost,\n+      evaluator,\n+      metaRegistry,\n+      metaReader,\n+      scopeRegistry,\n+      scopeRegistry,\n+      typeCheckScopeRegistry,\n       resourceRegistry,\n-      /* isCore */ false, new StubResourceLoader(), /* rootDirs */['/'],\n-      /* defaultPreserveWhitespaces */ false, /* i18nUseExternalIds */ true,\n+      /* isCore */ false,\n+      new StubResourceLoader(),\n+      /* rootDirs */['/'],\n+      /* defaultPreserveWhitespaces */ false,\n+      /* i18nUseExternalIds */ true,\n       /* enableI18nLegacyMessageIdFormat */ false,\n       /* usePoisonedData */ false,\n-      /* i18nNormalizeLineEndingsInICUs */ undefined, moduleResolver, cycleAnalyzer, refEmitter,\n-      NOOP_DEFAULT_IMPORT_RECORDER, /* depTracker */ null, injectableRegistry,\n-      /* annotateForClosureCompiler */ false);\n+      /* i18nNormalizeLineEndingsInICUs */ undefined,\n+      moduleResolver,\n+      cycleAnalyzer,\n+      refEmitter,\n+      NOOP_DEFAULT_IMPORT_RECORDER,\n+      /* depTracker */ null,\n+      injectableRegistry,\n+      /* annotateForClosureCompiler */ false,\n+  );\n   return {reflectionHost, handler};\n }\n "
        },
        {
            "sha": "a7ebb7c1431a2b851e25fb7c93a35b6360c2fb6d",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=a543e6949781b4dbfba04e73b3e26922a479861a",
            "patch": "@@ -24,7 +24,7 @@ import {NOOP_PERF_RECORDER, PerfRecorder} from '../../perf';\n import {DeclarationNode, isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {AdapterResourceLoader} from '../../resource';\n import {entryPointKeyFor, NgModuleRouteAnalyzer} from '../../routing';\n-import {ComponentScopeReader, LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver} from '../../scope';\n+import {ComponentScopeReader, LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver, TypeCheckScopeRegistry} from '../../scope';\n import {generatedFactoryTransform} from '../../shims';\n import {ivySwitchTransform} from '../../switch';\n import {aliasTransformFactory, CompilationMode, declarationTransformFactory, DecoratorHandler, DtsTransformRegistry, ivyTransformFactory, TraitCompiler} from '../../transform';\n@@ -44,6 +44,7 @@ interface LazyCompilationState {\n   reflector: TypeScriptReflectionHost;\n   metaReader: MetadataReader;\n   scopeRegistry: LocalModuleScopeRegistry;\n+  typeCheckScopeRegistry: TypeCheckScopeRegistry;\n   exportReferenceGraph: ReferenceGraph|null;\n   routeAnalyzer: NgModuleRouteAnalyzer;\n   dtsTransforms: DtsTransformRegistry;\n@@ -732,6 +733,7 @@ export class NgCompiler {\n     const injectableRegistry = new InjectableClassRegistry(reflector);\n \n     const metaReader = new CompoundMetadataReader([localMetaReader, dtsReader]);\n+    const typeCheckScopeRegistry = new TypeCheckScopeRegistry(scopeReader, metaReader);\n \n \n     // If a flat module entrypoint was specified, then track references via a `ReferenceGraph` in\n@@ -761,8 +763,9 @@ export class NgCompiler {\n     const handlers: DecoratorHandler<unknown, unknown, unknown>[] = [\n       new ComponentDecoratorHandler(\n           reflector, evaluator, metaRegistry, metaReader, scopeReader, scopeRegistry,\n-          resourceRegistry, isCore, this.resourceManager, this.adapter.rootDirs,\n-          this.options.preserveWhitespaces || false, this.options.i18nUseExternalIds !== false,\n+          typeCheckScopeRegistry, resourceRegistry, isCore, this.resourceManager,\n+          this.adapter.rootDirs, this.options.preserveWhitespaces || false,\n+          this.options.i18nUseExternalIds !== false,\n           this.options.enableI18nLegacyMessageIdFormat !== false, this.usePoisonedData,\n           this.options.i18nNormalizeLineEndingsInICUs, this.moduleResolver, this.cycleAnalyzer,\n           refEmitter, defaultImportTracker, this.incrementalDriver.depGraph, injectableRegistry,\n@@ -814,6 +817,7 @@ export class NgCompiler {\n       routeAnalyzer,\n       mwpScanner,\n       metaReader,\n+      typeCheckScopeRegistry,\n       defaultImportTracker,\n       aliasingHost,\n       refEmitter,"
        },
        {
            "sha": "920f8dba8a500e101d011d3a07571156017e99b2",
            "filename": "packages/compiler-cli/src/ngtsc/scope/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Findex.ts?ref=a543e6949781b4dbfba04e73b3e26922a479861a",
            "patch": "@@ -10,3 +10,4 @@ export {ExportScope, ScopeData} from './src/api';\n export {ComponentScopeReader, CompoundComponentScopeReader} from './src/component_scope';\n export {DtsModuleScopeResolver, MetadataDtsModuleScopeResolver} from './src/dependency';\n export {DeclarationData, LocalModuleScope, LocalModuleScopeRegistry, LocalNgModuleData} from './src/local';\n+export {TypeCheckScope, TypeCheckScopeRegistry} from './src/typecheck';\n\\ No newline at end of file"
        },
        {
            "sha": "a162a9a7284e4915898b8e525da6eb4bdc1155d4",
            "filename": "packages/compiler-cli/src/ngtsc/scope/src/typecheck.ts",
            "status": "renamed",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Ftypecheck.ts",
            "raw_url": "https://github.com/angular/angular/raw/a543e6949781b4dbfba04e73b3e26922a479861a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Ftypecheck.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Ftypecheck.ts?ref=a543e6949781b4dbfba04e73b3e26922a479861a",
            "patch": "@@ -12,7 +12,8 @@ import * as ts from 'typescript';\n import {Reference} from '../../imports';\n import {DirectiveMeta, flattenInheritedDirectiveMetadata, MetadataReader} from '../../metadata';\n import {ClassDeclaration} from '../../reflection';\n-import {ComponentScopeReader} from '../../scope';\n+\n+import {ComponentScopeReader} from './component_scope';\n \n /**\n  * The scope that is used for type-check code generation of a component template.\n@@ -24,6 +25,11 @@ export interface TypeCheckScope {\n    */\n   matcher: SelectorMatcher<DirectiveMeta>;\n \n+  /**\n+   * All of the directives available in the compilation scope of the declaring NgModule.\n+   */\n+  directives: DirectiveMeta[];\n+\n   /**\n    * The pipes that are available in the compilation scope.\n    */\n@@ -44,7 +50,7 @@ export interface TypeCheckScope {\n /**\n  * Computes scope information to be used in template type checking.\n  */\n-export class TypeCheckScopes {\n+export class TypeCheckScopeRegistry {\n   /**\n    * Cache of flattened directive metadata. Because flattened metadata is scope-invariant it's\n    * cached individually, such that all scopes refer to the same flattened metadata.\n@@ -65,12 +71,14 @@ export class TypeCheckScopes {\n    */\n   getTypeCheckScope(node: ClassDeclaration): TypeCheckScope {\n     const matcher = new SelectorMatcher<DirectiveMeta>();\n+    const directives: DirectiveMeta[] = [];\n     const pipes = new Map<string, Reference<ClassDeclaration<ts.ClassDeclaration>>>();\n \n     const scope = this.scopeReader.getScopeForComponent(node);\n     if (scope === null) {\n       return {\n         matcher,\n+        directives,\n         pipes,\n         schemas: [],\n         isPoisoned: false,\n@@ -83,8 +91,9 @@ export class TypeCheckScopes {\n \n     for (const meta of scope.compilation.directives) {\n       if (meta.selector !== null) {\n-        const extMeta = this.getInheritedDirectiveMetadata(meta.ref);\n+        const extMeta = this.getTypeCheckDirectiveMetadata(meta.ref);\n         matcher.addSelectables(CssSelector.parse(meta.selector), extMeta);\n+        directives.push(extMeta);\n       }\n     }\n \n@@ -98,6 +107,7 @@ export class TypeCheckScopes {\n \n     const typeCheckScope: TypeCheckScope = {\n       matcher,\n+      directives,\n       pipes,\n       schemas: scope.schemas,\n       isPoisoned: scope.compilation.isPoisoned || scope.exported.isPoisoned,\n@@ -106,7 +116,7 @@ export class TypeCheckScopes {\n     return typeCheckScope;\n   }\n \n-  private getInheritedDirectiveMetadata(ref: Reference<ClassDeclaration>): DirectiveMeta {\n+  getTypeCheckDirectiveMetadata(ref: Reference<ClassDeclaration>): DirectiveMeta {\n     const clazz = ref.node;\n     if (this.flattenedDirectiveMetaCache.has(clazz)) {\n       return this.flattenedDirectiveMetaCache.get(clazz)!;",
            "previous_filename": "packages/compiler-cli/src/ngtsc/annotations/src/typecheck_scopes.ts"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 69,
        "deletions": 35
    }
}