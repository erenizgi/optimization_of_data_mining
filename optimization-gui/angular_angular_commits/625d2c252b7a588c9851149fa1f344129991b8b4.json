{
    "author": "kyliau",
    "message": "fix(language-service): diagnostic and definition should work for absolute url (#40406)\n\nThis commit fixes a bug in the **View Engine** implementation of\n`getSemanticDiagnostics` and `getDefinitionAndBoundSpan` for node in the\ndecorator metadata that represents an external URL\n(`templateUrl` or `styleUrls`).\n\nThe URL could be either relative or absolute, but the latter was not taken\ninto account.\n\nFix https://github.com/angular/vscode-ng-language-service/issues/1055\n\nPR Close #40406",
    "sha": "625d2c252b7a588c9851149fa1f344129991b8b4",
    "files": [
        {
            "sha": "6a2653b50e1c7ae95378fa978dfa440a4531b7d3",
            "filename": "packages/language-service/src/definitions.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/625d2c252b7a588c9851149fa1f344129991b8b4/packages%2Flanguage-service%2Fsrc%2Fdefinitions.ts",
            "raw_url": "https://github.com/angular/angular/raw/625d2c252b7a588c9851149fa1f344129991b8b4/packages%2Flanguage-service%2Fsrc%2Fdefinitions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fdefinitions.ts?ref=625d2c252b7a588c9851149fa1f344129991b8b4",
            "patch": "@@ -6,12 +6,12 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import * as path from 'path';\n import * as ts from 'typescript';  // used as value and is provided at runtime\n \n import {locateSymbols} from './locate_symbol';\n import {findTightestNode, getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n import {AstResult, Span} from './types';\n+import {extractAbsoluteFilePath} from './utils';\n \n /**\n  * Convert Angular Span to TypeScript TextSpan. Angular Span has 'start' and\n@@ -59,10 +59,9 @@ function getUrlFromProperty(\n     return;\n   }\n \n-  const sf = urlNode.getSourceFile();\n   // Extract url path specified by the url node, which is relative to the TypeScript source file\n   // the url node is defined in.\n-  const url = path.join(path.dirname(sf.fileName), urlNode.text);\n+  const url = extractAbsoluteFilePath(urlNode);\n \n   // If the file does not exist, bail. It is possible that the TypeScript language service host\n   // does not have a `fileExists` method, in which case optimistically assume the file exists."
        },
        {
            "sha": "342a3585d79f52e291e19b94e7a729fb268eae54",
            "filename": "packages/language-service/src/diagnostics.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/625d2c252b7a588c9851149fa1f344129991b8b4/packages%2Flanguage-service%2Fsrc%2Fdiagnostics.ts",
            "raw_url": "https://github.com/angular/angular/raw/625d2c252b7a588c9851149fa1f344129991b8b4/packages%2Flanguage-service%2Fsrc%2Fdiagnostics.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fdiagnostics.ts?ref=625d2c252b7a588c9851149fa1f344129991b8b4",
            "patch": "@@ -7,15 +7,14 @@\n  */\n \n import {NgAnalyzedModules} from '@angular/compiler';\n-import * as path from 'path';\n import * as ts from 'typescript';\n \n import {createDiagnostic, Diagnostic} from './diagnostic_messages';\n import {getTemplateExpressionDiagnostics} from './expression_diagnostics';\n import {findPropertyValueOfType, findTightestNode} from './ts_utils';\n import * as ng from './types';\n import {TypeScriptServiceHost} from './typescript_host';\n-import {offsetSpan, spanOf} from './utils';\n+import {extractAbsoluteFilePath, offsetSpan, spanOf} from './utils';\n \n /**\n  * Return diagnostic information for the parsed AST of the template.\n@@ -161,8 +160,8 @@ function validateUrls(\n       // picked up by the TS Language Server.\n       continue;\n     }\n-    const curPath = urlNode.getSourceFile().fileName;\n-    const url = path.join(path.dirname(curPath), urlNode.text);\n+\n+    const url = extractAbsoluteFilePath(urlNode);\n     if (tsLsHost.fileExists(url)) continue;\n \n     // Exclude opening and closing quotes in the url span."
        },
        {
            "sha": "70ca4caa384bb7a58753e4e8c4c5e9fdaf74da2a",
            "filename": "packages/language-service/src/utils.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/625d2c252b7a588c9851149fa1f344129991b8b4/packages%2Flanguage-service%2Fsrc%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/625d2c252b7a588c9851149fa1f344129991b8b4/packages%2Flanguage-service%2Fsrc%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Futils.ts?ref=625d2c252b7a588c9851149fa1f344129991b8b4",
            "patch": "@@ -7,7 +7,8 @@\n  */\n \n import {AstPath, BoundEventAst, CompileDirectiveSummary, CompileTypeMetadata, CssSelector, DirectiveAst, ElementAst, EmbeddedTemplateAst, HtmlAstPath, identifierName, Identifiers, Node, ParseSourceSpan, RecursiveTemplateAstVisitor, RecursiveVisitor, TemplateAst, TemplateAstPath, templateVisitAll, visitAll} from '@angular/compiler';\n-import {getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n+import * as path from 'path';\n+\n import {AstResult, DiagnosticTemplateInfo, SelectorInfo, Span, Symbol, SymbolQuery} from './types';\n \n interface SpanHolder {\n@@ -204,3 +205,13 @@ export function findOutputBinding(\n     }\n   }\n }\n+\n+/**\n+ * Returns an absolute path from the text in `node`. If the text is already\n+ * an absolute path, return it as is, otherwise join the path with the filename\n+ * of the source file.\n+ */\n+export function extractAbsoluteFilePath(node: ts.StringLiteralLike) {\n+  const url = node.text;\n+  return path.isAbsolute(url) ? url : path.join(path.dirname(node.getSourceFile().fileName), url);\n+}"
        },
        {
            "sha": "0a754d12fc004e66523735ce7b19a050183d27fc",
            "filename": "packages/language-service/test/definitions_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/625d2c252b7a588c9851149fa1f344129991b8b4/packages%2Flanguage-service%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/625d2c252b7a588c9851149fa1f344129991b8b4/packages%2Flanguage-service%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Fdefinitions_spec.ts?ref=625d2c252b7a588c9851149fa1f344129991b8b4",
            "patch": "@@ -420,6 +420,19 @@ describe('definitions', () => {\n     expect(def.textSpan).toEqual({start: 0, length: 0});\n   });\n \n+  it('should be able to find a template from an absolute url', () => {\n+    const fileName = mockHost.addCode(`\n+      @Component({\n+        templateUrl: '${TEST_TEMPLATE}',\n+      })\n+      export class MyComponent {}`);\n+\n+    const marker = mockHost.readFile(fileName)!.indexOf(TEST_TEMPLATE);\n+    const result = ngService.getDefinitionAndBoundSpan(fileName, marker);\n+\n+    expect(result?.definitions?.[0].fileName).toBe(TEST_TEMPLATE);\n+  });\n+\n   it('should be able to find a stylesheet from a url', () => {\n     const fileName = mockHost.addCode(`\n \t      @Component({"
        },
        {
            "sha": "99b2ce9bb0f732de8d11e5459988b34780055c8e",
            "filename": "packages/language-service/test/diagnostics_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/625d2c252b7a588c9851149fa1f344129991b8b4/packages%2Flanguage-service%2Ftest%2Fdiagnostics_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/625d2c252b7a588c9851149fa1f344129991b8b4/packages%2Flanguage-service%2Ftest%2Fdiagnostics_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Fdiagnostics_spec.ts?ref=625d2c252b7a588c9851149fa1f344129991b8b4",
            "patch": "@@ -89,6 +89,19 @@ describe('diagnostics', () => {\n     }\n   });\n \n+  it('should not produce diagnostics for absolute template url', () => {\n+    mockHost.override(APP_COMPONENT, `\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        templateUrl: '${TEST_TEMPLATE}',\n+      })\n+      export class AppComponent {}\n+    `);\n+    const diags = ngLS.getSemanticDiagnostics(APP_COMPONENT);\n+    expect(diags).toEqual([]);\n+  });\n+\n   it('should not produce diagnostics for slice pipe with arguments', () => {\n     mockHost.override(TEST_TEMPLATE, `\n       <div *ngFor=\"let h of heroes | slice:0:1\">"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 43,
        "deletions": 8
    }
}