{
    "author": "JoostK",
    "message": "refactor(compiler-cli): remove Ivy switch transform (#43891)\n\nNow that the core package has been cleaned up to no longer contain Ivy\nswitch code, the transform to switch the `PRE_R3` markers to become\n`POST_R3` is deleted as well.\n\nPR Close #43891",
    "sha": "b2ac81d1472d118a2a03629139b6e724a730b982",
    "files": [
        {
            "sha": "0f348a408b253dd593a8a6e479ecf7390d236d89",
            "filename": "packages/compiler-cli/src/ngtsc/core/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/b2ac81d1472d118a2a03629139b6e724a730b982/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b2ac81d1472d118a2a03629139b6e724a730b982/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel?ref=b2ac81d1472d118a2a03629139b6e724a730b982",
            "patch": "@@ -31,7 +31,6 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/scope\",\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/shims:api\",\n-        \"//packages/compiler-cli/src/ngtsc/switch\",\n         \"//packages/compiler-cli/src/ngtsc/transform\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\","
        },
        {
            "sha": "f8b101166b1d569ef8fba916718f45778b7b91dc",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b2ac81d1472d118a2a03629139b6e724a730b982/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/b2ac81d1472d118a2a03629139b6e724a730b982/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=b2ac81d1472d118a2a03629139b6e724a730b982",
            "patch": "@@ -25,7 +25,6 @@ import {DeclarationNode, isNamedClassDeclaration, TypeScriptReflectionHost} from\n import {AdapterResourceLoader} from '../../resource';\n import {ComponentScopeReader, LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver, TypeCheckScopeRegistry} from '../../scope';\n import {generatedFactoryTransform} from '../../shims';\n-import {ivySwitchTransform} from '../../switch';\n import {aliasTransformFactory, CompilationMode, declarationTransformFactory, DecoratorHandler, DtsTransformRegistry, ivyTransformFactory, TraitCompiler} from '../../transform';\n import {TemplateTypeCheckerImpl} from '../../typecheck';\n import {OptimizeFor, TemplateTypeChecker, TypeCheckingConfig} from '../../typecheck/api';\n@@ -647,7 +646,6 @@ export class NgCompiler {\n       before.push(\n           generatedFactoryTransform(this.adapter.factoryTracker.sourceInfo, importRewriter));\n     }\n-    before.push(ivySwitchTransform);\n \n     return {transformers: {before, afterDeclarations} as ts.CustomTransformers};\n   }"
        },
        {
            "sha": "7ceb4ad96ee9dd2ee6e5e9b3e2b1975bf6443567",
            "filename": "packages/compiler-cli/src/ngtsc/switch/BUILD.bazel",
            "status": "removed",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/b06e3981bc1fa2b80465275cb657f0537b2c7385/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fswitch%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b06e3981bc1fa2b80465275cb657f0537b2c7385/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fswitch%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fswitch%2FBUILD.bazel?ref=b06e3981bc1fa2b80465275cb657f0537b2c7385",
            "patch": "@@ -1,14 +0,0 @@\n-load(\"//tools:defaults.bzl\", \"ts_library\")\n-\n-package(default_visibility = [\"//visibility:public\"])\n-\n-ts_library(\n-    name = \"switch\",\n-    srcs = [\"index.ts\"] + glob([\n-        \"src/**/*.ts\",\n-    ]),\n-    deps = [\n-        \"//packages/compiler\",\n-        \"@npm//typescript\",\n-    ],\n-)"
        },
        {
            "sha": "1733176e35971a50eab8ac0f6959ecca85b3509f",
            "filename": "packages/compiler-cli/src/ngtsc/switch/index.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/b06e3981bc1fa2b80465275cb657f0537b2c7385/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fswitch%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/b06e3981bc1fa2b80465275cb657f0537b2c7385/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fswitch%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fswitch%2Findex.ts?ref=b06e3981bc1fa2b80465275cb657f0537b2c7385",
            "patch": "@@ -1,9 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-export {ivySwitchTransform} from './src/switch';"
        },
        {
            "sha": "985bf676e807efed001216a9d26aacd7b36c14d0",
            "filename": "packages/compiler-cli/src/ngtsc/switch/src/switch.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 139,
            "changes": 139,
            "blob_url": "https://github.com/angular/angular/blob/b06e3981bc1fa2b80465275cb657f0537b2c7385/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fswitch%2Fsrc%2Fswitch.ts",
            "raw_url": "https://github.com/angular/angular/raw/b06e3981bc1fa2b80465275cb657f0537b2c7385/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fswitch%2Fsrc%2Fswitch.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fswitch%2Fsrc%2Fswitch.ts?ref=b06e3981bc1fa2b80465275cb657f0537b2c7385",
            "patch": "@@ -1,139 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import ts from 'typescript';\n-\n-const IVY_SWITCH_PRE_SUFFIX = '__PRE_R3__';\n-const IVY_SWITCH_POST_SUFFIX = '__POST_R3__';\n-\n-export function ivySwitchTransform(_: ts.TransformationContext): ts.Transformer<ts.SourceFile> {\n-  return flipIvySwitchInFile;\n-}\n-\n-function flipIvySwitchInFile(sf: ts.SourceFile): ts.SourceFile {\n-  // To replace the statements array, it must be copied. This only needs to happen if a statement\n-  // must actually be replaced within the array, so the newStatements array is lazily initialized.\n-  let newStatements: ts.Statement[]|undefined = undefined;\n-\n-  // Iterate over the statements in the file.\n-  for (let i = 0; i < sf.statements.length; i++) {\n-    const statement = sf.statements[i];\n-\n-    // Skip over everything that isn't a variable statement.\n-    if (!ts.isVariableStatement(statement) || !hasIvySwitches(statement)) {\n-      continue;\n-    }\n-\n-    // This statement needs to be replaced. Check if the newStatements array needs to be lazily\n-    // initialized to a copy of the original statements.\n-    if (newStatements === undefined) {\n-      newStatements = [...sf.statements];\n-    }\n-\n-    // Flip any switches in the VariableStatement. If there were any, a new statement will be\n-    // returned; otherwise the old statement will be.\n-    newStatements[i] = flipIvySwitchesInVariableStatement(statement, sf.statements);\n-  }\n-\n-  // Only update the statements in the SourceFile if any have changed.\n-  if (newStatements !== undefined) {\n-    return ts.updateSourceFileNode(sf, newStatements);\n-  }\n-  return sf;\n-}\n-\n-/**\n- * Look for the ts.Identifier of a ts.Declaration with this name.\n- *\n- * The real identifier is needed (rather than fabricating one) as TypeScript decides how to\n- * reference this identifier based on information stored against its node in the AST, which a\n- * synthetic node would not have. In particular, since the post-switch variable is often exported,\n- * TypeScript needs to know this so it can write `exports.VAR` instead of just `VAR` when emitting\n- * code.\n- *\n- * Only variable, function, and class declarations are currently searched.\n- */\n-function findPostSwitchIdentifier(\n-    statements: ReadonlyArray<ts.Statement>, name: string): ts.Identifier|null {\n-  for (const stmt of statements) {\n-    if (ts.isVariableStatement(stmt)) {\n-      const decl = stmt.declarationList.declarations.find(\n-          decl => ts.isIdentifier(decl.name) && decl.name.text === name);\n-      if (decl !== undefined) {\n-        return decl.name as ts.Identifier;\n-      }\n-    } else if (ts.isFunctionDeclaration(stmt) || ts.isClassDeclaration(stmt)) {\n-      if (stmt.name !== undefined && ts.isIdentifier(stmt.name) && stmt.name.text === name) {\n-        return stmt.name;\n-      }\n-    }\n-  }\n-  return null;\n-}\n-\n-/**\n- * Flip any Ivy switches which are discovered in the given ts.VariableStatement.\n- */\n-function flipIvySwitchesInVariableStatement(\n-    stmt: ts.VariableStatement, statements: ReadonlyArray<ts.Statement>): ts.VariableStatement {\n-  // Build a new list of variable declarations. Specific declarations that are initialized to a\n-  // pre-switch identifier will be replaced with a declaration initialized to the post-switch\n-  // identifier.\n-  const newDeclarations = [...stmt.declarationList.declarations];\n-  for (let i = 0; i < newDeclarations.length; i++) {\n-    const decl = newDeclarations[i];\n-\n-    // Skip declarations that aren't initialized to an identifier.\n-    if (decl.initializer === undefined || !ts.isIdentifier(decl.initializer)) {\n-      continue;\n-    }\n-\n-    // Skip declarations that aren't Ivy switches.\n-    if (!decl.initializer.text.endsWith(IVY_SWITCH_PRE_SUFFIX)) {\n-      continue;\n-    }\n-\n-    // Determine the name of the post-switch variable.\n-    const postSwitchName =\n-        decl.initializer.text.replace(IVY_SWITCH_PRE_SUFFIX, IVY_SWITCH_POST_SUFFIX);\n-\n-    // Find the post-switch variable identifier. If one can't be found, it's an error. This is\n-    // reported as a thrown error and not a diagnostic as transformers cannot output diagnostics.\n-    const newIdentifier = findPostSwitchIdentifier(statements, postSwitchName);\n-    if (newIdentifier === null) {\n-      throw new Error(`Unable to find identifier ${postSwitchName} in ${\n-          stmt.getSourceFile().fileName} for the Ivy switch.`);\n-    }\n-\n-    newDeclarations[i] = ts.updateVariableDeclaration(\n-        /* node */ decl,\n-        /* name */ decl.name,\n-        /* type */ decl.type,\n-        /* initializer */ newIdentifier);\n-  }\n-\n-  const newDeclList = ts.updateVariableDeclarationList(\n-      /* declarationList */ stmt.declarationList,\n-      /* declarations */ newDeclarations);\n-\n-  const newStmt = ts.updateVariableStatement(\n-      /* statement */ stmt,\n-      /* modifiers */ stmt.modifiers,\n-      /* declarationList */ newDeclList);\n-\n-  return newStmt;\n-}\n-\n-/**\n- * Check whether the given VariableStatement has any Ivy switch variables.\n- */\n-function hasIvySwitches(stmt: ts.VariableStatement) {\n-  return stmt.declarationList.declarations.some(\n-      decl => decl.initializer !== undefined && ts.isIdentifier(decl.initializer) &&\n-          decl.initializer.text.endsWith(IVY_SWITCH_PRE_SUFFIX));\n-}"
        },
        {
            "sha": "b3f3a415200bae88f84ac9bb05d63fe935bcd779",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 31,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/b2ac81d1472d118a2a03629139b6e724a730b982/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b2ac81d1472d118a2a03629139b6e724a730b982/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=b2ac81d1472d118a2a03629139b6e724a730b982",
            "patch": "@@ -6254,37 +6254,6 @@ function allTests(os: string) {\n          });\n     });\n \n-    describe('ivy switch mode', () => {\n-      it('should allow for symbols to be renamed when they use a SWITCH_IVY naming mechanism',\n-         () => {\n-           env.write('test.ts', `\n-export const FooCmp__POST_R3__ = 1;\n-export const FooCmp__PRE_R3__ = 2;\n-export const FooCmp = FooCmp__PRE_R3__;`);\n-           env.driveMain();\n-\n-           const source = env.getContents('test.js');\n-           expect(source).toContain(`export var FooCmp = FooCmp__POST_R3__`);\n-           expect(source).not.toContain(`export var FooCmp = FooCmp__PRE_R3__`);\n-         });\n-\n-      it('should allow for SWITCH_IVY naming even even if it occurs outside of core', () => {\n-        const content = `\n-export const Foo__POST_R3__ = 1;\n-export const Foo__PRE_R3__ = 2;\n-export const Foo = Foo__PRE_R3__;\n-`;\n-        env.write('test_outside_angular_core.ts', content);\n-        env.write(\n-            'test_inside_angular_core.ts', content + '\\nexport const ITS_JUST_ANGULAR = true;');\n-        env.driveMain();\n-\n-        const sourceTestOutsideAngularCore = env.getContents('test_outside_angular_core.js');\n-        const sourceTestInsideAngularCore = env.getContents('test_inside_angular_core.js');\n-        expect(sourceTestInsideAngularCore).toContain(sourceTestOutsideAngularCore);\n-      });\n-    });\n-\n     describe('NgModule export aliasing', () => {\n       it('should use an alias to import a directive from a deep dependency', () => {\n         env.tsconfig({'_useHostForImportGeneration': true});"
        }
    ],
    "stats": {
        "total": 196,
        "additions": 0,
        "deletions": 196
    }
}