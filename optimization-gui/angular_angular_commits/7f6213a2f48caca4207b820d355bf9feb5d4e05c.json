{
    "author": "alan-agius4",
    "message": "fix(migrations): add migration to replace `/deep/` with `::ng-deep` (#42214)\n\nWith this change we add a migration to replace the deprecated shadow-piercing selector from `/deep/` with deprecated but recommended `::ng-deep`.\n\nThe main motivation for this change is that the CSS optimizer CSSNano which is used by the Angular CLI no longer supports this non standard selector and causes build time errors due to the selector being minified incorrectly. However, CSSNano does support the recommended deprecated `::ng-deep` selector.\n\nCloses: #42196\n\nPR Close #42214",
    "sha": "7f6213a2f48caca4207b820d355bf9feb5d4e05c",
    "files": [
        {
            "sha": "6f99228d7af7a654f72cb7fc0e3264be6a5b9365",
            "filename": "packages/core/schematics/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2FBUILD.bazel?ref=7f6213a2f48caca4207b820d355bf9feb5d4e05c",
            "patch": "@@ -13,6 +13,7 @@ pkg_npm(\n         \"//packages/core/schematics/migrations/abstract-control-parent\",\n         \"//packages/core/schematics/migrations/activated-route-snapshot-fragment\",\n         \"//packages/core/schematics/migrations/can-activate-with-redirect-to\",\n+        \"//packages/core/schematics/migrations/deep-shadow-piercing-selector\",\n         \"//packages/core/schematics/migrations/dynamic-queries\",\n         \"//packages/core/schematics/migrations/initial-navigation\",\n         \"//packages/core/schematics/migrations/missing-injectable\","
        },
        {
            "sha": "a077e0fd386189119129e02cb4403052d4b03377",
            "filename": "packages/core/schematics/migrations.json",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "raw_url": "https://github.com/angular/angular/raw/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations.json?ref=7f6213a2f48caca4207b820d355bf9feb5d4e05c",
            "patch": "@@ -94,6 +94,11 @@\n       \"version\": \"12.0.0-next.6\",\n       \"description\": \"`XhrFactory` has been moved from `@angular/common/http` to `@angular/common`.\",\n       \"factory\": \"./migrations/xhr-factory/index\"\n+    },\n+    \"migration-v12-deep-shadow-piercing-selector\": {\n+      \"version\": \"12.0.2\",\n+      \"description\": \"Automatically migrates shadow-piercing selector from `/deep/` to the recommanded alternative `::ng-deep`.\",\n+      \"factory\": \"./migrations/deep-shadow-piercing-selector/index\"\n     }\n   }\n }"
        },
        {
            "sha": "00f141fcd4a2aef46c6383cff6f2137ccf3f8940",
            "filename": "packages/core/schematics/migrations/deep-shadow-piercing-selector/BUILD.bazel",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Fmigrations%2Fdeep-shadow-piercing-selector%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Fmigrations%2Fdeep-shadow-piercing-selector%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fdeep-shadow-piercing-selector%2FBUILD.bazel?ref=7f6213a2f48caca4207b820d355bf9feb5d4e05c",
            "patch": "@@ -0,0 +1,16 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"deep-shadow-piercing-selector\",\n+    srcs = glob([\"**/*.ts\"]),\n+    tsconfig = \"//packages/core/schematics:tsconfig.json\",\n+    visibility = [\n+        \"//packages/core/schematics:__pkg__\",\n+        \"//packages/core/schematics/migrations/google3:__pkg__\",\n+        \"//packages/core/schematics/test:__pkg__\",\n+    ],\n+    deps = [\n+        \"@npm//@angular-devkit/core\",\n+        \"@npm//@angular-devkit/schematics\",\n+    ],\n+)"
        },
        {
            "sha": "4215e54ec533321da8661f60ae7c0dc75cb6a09b",
            "filename": "packages/core/schematics/migrations/deep-shadow-piercing-selector/README.md",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Fmigrations%2Fdeep-shadow-piercing-selector%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Fmigrations%2Fdeep-shadow-piercing-selector%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fdeep-shadow-piercing-selector%2FREADME.md?ref=7f6213a2f48caca4207b820d355bf9feb5d4e05c",
            "patch": "@@ -0,0 +1,17 @@\n+## shadow-piercing selector `/deep/` to `::ng-deep`\n+\n+Automatically migrates shadow-piercing selector from `/deep/` to `::ng-deep`.\n+\n+#### Before\n+```css\n+:host /deep/ * {\n+  cursor: pointer;\n+}\n+```\n+\n+#### After\n+```css\n+:host ::ng-deep * {\n+  cursor: pointer;\n+}\n+```"
        },
        {
            "sha": "0e84ebbfeffa14637c8477b809fc37219058243b",
            "filename": "packages/core/schematics/migrations/deep-shadow-piercing-selector/index.ts",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Fmigrations%2Fdeep-shadow-piercing-selector%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Fmigrations%2Fdeep-shadow-piercing-selector%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fdeep-shadow-piercing-selector%2Findex.ts?ref=7f6213a2f48caca4207b820d355bf9feb5d4e05c",
            "patch": "@@ -0,0 +1,41 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {extname, join} from '@angular-devkit/core';\n+import {DirEntry, Rule} from '@angular-devkit/schematics';\n+\n+const VALID_EXTENSIONS = ['.scss', '.sass', '.css', '.styl', '.less', '.ts'];\n+\n+function* visitFiles(directory: DirEntry): IterableIterator<string> {\n+  for (const path of directory.subfiles) {\n+    const extension = extname(path);\n+    if (VALID_EXTENSIONS.includes(extension)) {\n+      yield join(directory.path, path);\n+    }\n+  }\n+\n+  for (const path of directory.subdirs) {\n+    if (path === 'node_modules' || path.startsWith('.') || path === 'dist') {\n+      continue;\n+    }\n+\n+    yield* visitFiles(directory.dir(path));\n+  }\n+}\n+\n+export default function(): Rule {\n+  return (tree) => {\n+    // Visit all files in an Angular workspace monorepo.\n+    for (const file of visitFiles(tree.root)) {\n+      const content = tree.read(file)?.toString();\n+      if (content?.includes('/deep/ ')) {\n+        tree.overwrite(file, content.replace(/\\/deep\\/ /g, '::ng-deep '));\n+      }\n+    }\n+  };\n+}"
        },
        {
            "sha": "0904e31590c2a94507b19c754ac8b44e146f3c9e",
            "filename": "packages/core/schematics/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel?ref=7f6213a2f48caca4207b820d355bf9feb5d4e05c",
            "patch": "@@ -11,6 +11,7 @@ ts_library(\n         \"//packages/core/schematics/migrations/abstract-control-parent\",\n         \"//packages/core/schematics/migrations/activated-route-snapshot-fragment\",\n         \"//packages/core/schematics/migrations/can-activate-with-redirect-to\",\n+        \"//packages/core/schematics/migrations/deep-shadow-piercing-selector\",\n         \"//packages/core/schematics/migrations/dynamic-queries\",\n         \"//packages/core/schematics/migrations/initial-navigation\",\n         \"//packages/core/schematics/migrations/missing-injectable\","
        },
        {
            "sha": "912642c5a4fa0966b04059a4afbb4c1bfe2d399d",
            "filename": "packages/core/schematics/test/deep-shadow-piercing-selector_spec.ts",
            "status": "added",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/angular/angular/blob/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Ftest%2Fdeep-shadow-piercing-selector_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7f6213a2f48caca4207b820d355bf9feb5d4e05c/packages%2Fcore%2Fschematics%2Ftest%2Fdeep-shadow-piercing-selector_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Fdeep-shadow-piercing-selector_spec.ts?ref=7f6213a2f48caca4207b820d355bf9feb5d4e05c",
            "patch": "@@ -0,0 +1,69 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {tags} from '@angular-devkit/core';\n+import {EmptyTree} from '@angular-devkit/schematics';\n+import {SchematicTestRunner, UnitTestTree} from '@angular-devkit/schematics/testing';\n+\n+describe('`/deep/` to `::ng-deep` migration', () => {\n+  let tree: UnitTestTree;\n+  const runner = new SchematicTestRunner('test', require.resolve('../migrations.json'));\n+\n+  beforeEach(() => {\n+    tree = new UnitTestTree(new EmptyTree());\n+  });\n+\n+  it(`should replace '/deep/' with '::ng-deep' in inline component styles`, async () => {\n+    const fileName = '/index.ts';\n+    const getFileContent = (contentToReplace: string) => tags.stripIndents`\n+      import { Component } from '@angular/core';\n+\n+      @Component({\n+        selector: 'app-root',\n+        template: '<router-outlet></router-outlet>',\n+        styles: ['` +\n+        contentToReplace + `'],\n+      })\n+      export class AppComponent { }\n+   `;\n+\n+    tree.create(fileName, getFileContent(':host /deep/ * { cursor: pointer; }'));\n+    await runMigration();\n+    expect(tree.readContent(fileName))\n+        .toBe(getFileContent(':host ::ng-deep * { cursor: pointer; }'));\n+  });\n+\n+  for (const styleExtension of ['scss', 'sass', 'css', 'styl', 'less']) {\n+    it(`should replace '/deep/' with '::ng-deep' in ${styleExtension} file`, async () => {\n+      const fileName = `/index.${styleExtension}`;\n+      tree.create(fileName, ':host /deep/ * { cursor: pointer; }');\n+      await runMigration();\n+      expect(tree.readContent(fileName)).toBe(':host ::ng-deep * { cursor: pointer; }');\n+    });\n+  }\n+\n+  it(`should replace '/deep/' with '::ng-deep' when used as root selector`, async () => {\n+    const fileName = '/index.css';\n+    tree.create(fileName, '/deep/ * { cursor: pointer; }');\n+    await runMigration();\n+    expect(tree.readContent(fileName)).toBe('::ng-deep * { cursor: pointer; }');\n+  });\n+\n+  it(`should not replace '/deep/' with '::ng-deep' in unknown file extension`, async () => {\n+    const fileName = '/index.foo';\n+    const content = 'this is a not /deep/ selector';\n+    tree.create(fileName, content);\n+    await runMigration();\n+    expect(tree.readContent(fileName)).toBe(content);\n+  });\n+\n+  async function runMigration(): Promise<void> {\n+    await runner.runSchematicAsync('migration-v12-deep-shadow-piercing-selector', {}, tree)\n+        .toPromise();\n+  }\n+});"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 150,
        "deletions": 0
    }
}