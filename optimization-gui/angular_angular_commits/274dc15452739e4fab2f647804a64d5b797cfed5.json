{
    "author": "JoostK",
    "message": "fix(core): detect synthesized constructors that have been downleveled using TS 4.2 (#41305)\n\nTypeScript 4.2 has changed its emitted syntax for synthetic constructors\nwhen using `downlevelIteration`, which affects ES5 bundles that have\nbeen downleveled from ES2015 bundles. This is typically the case for UMD\nbundles in the APF spec, as they are generated by downleveling the\nESM2015 bundle into ES5. The reflection capabilities in the runtime need\nto recognize this new form to correctly deal with synthesized\nconstructors, as otherwise JIT compilation could generate invalid\nfactory functions.\n\nFixes #41298\n\nPR Close #41305",
    "sha": "274dc15452739e4fab2f647804a64d5b797cfed5",
    "files": [
        {
            "sha": "c4ad36405b45265a1e228d94627f4e22286cb339",
            "filename": "packages/core/src/reflection/reflection_capabilities.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/274dc15452739e4fab2f647804a64d5b797cfed5/packages%2Fcore%2Fsrc%2Freflection%2Freflection_capabilities.ts",
            "raw_url": "https://github.com/angular/angular/raw/274dc15452739e4fab2f647804a64d5b797cfed5/packages%2Fcore%2Fsrc%2Freflection%2Freflection_capabilities.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Freflection%2Freflection_capabilities.ts?ref=274dc15452739e4fab2f647804a64d5b797cfed5",
            "patch": "@@ -34,15 +34,22 @@ import {GetterFn, MethodFn, SetterFn} from './types';\n  *     var _this = _super.apply(this, arguments) || this;\n  * ```\n  *\n+ * downleveled to ES5 with `downlevelIteration` for TypeScript < 4.2:\n  * ```\n  *   function MyClass() {\n  *     var _this = _super.apply(this, __spread(arguments)) || this;\n  * ```\n  *\n+ * or downleveled to ES5 with `downlevelIteration` for TypeScript >= 4.2:\n+ * ```\n+ *   function MyClass() {\n+ *     var _this = _super.apply(this, __spreadArray([], __read(arguments))) || this;\n+ * ```\n+ *\n  * More details can be found in: https://github.com/angular/angular/issues/38453.\n  */\n export const ES5_DELEGATE_CTOR =\n-    /^function\\s+\\S+\\(\\)\\s*{[\\s\\S]+\\.apply\\(this,\\s*(arguments|[^()]+\\(arguments\\))\\)/;\n+    /^function\\s+\\S+\\(\\)\\s*{[\\s\\S]+\\.apply\\(this,\\s*(arguments|(?:[^()]+\\(\\[\\],)?[^()]+\\(arguments\\))\\)/;\n /** Regular expression that detects ES2015 classes which extend from other classes. */\n export const ES2015_INHERITED_CLASS = /^class\\s+[A-Za-z\\d$_]*\\s*extends\\s+[^{]+{/;\n /**"
        },
        {
            "sha": "746631ca2702cdb2009aab26537c76d69abd17f9",
            "filename": "packages/core/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/274dc15452739e4fab2f647804a64d5b797cfed5/packages%2Fcore%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/274dc15452739e4fab2f647804a64d5b797cfed5/packages%2Fcore%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2FBUILD.bazel?ref=274dc15452739e4fab2f647804a64d5b797cfed5",
            "patch": "@@ -27,7 +27,7 @@ genrule(\n         $(execpath @npm//typescript/bin:tsc) $< --outDir $$es2015_out_dir --target ES2015 \\\n             --types --module umd\n         $(execpath @npm//typescript/bin:tsc) --outFile $@ $$es2015_out_file --allowJs \\\n-            --types --target ES5\n+            --types --target ES5 --downlevelIteration\n     \"\"\",\n     tools = [\"@npm//typescript/bin:tsc\"],\n )"
        },
        {
            "sha": "137edb7f88e6453bb8a967a222aa3180fd7c4d56",
            "filename": "packages/core/test/reflection/reflector_spec.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 6,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/274dc15452739e4fab2f647804a64d5b797cfed5/packages%2Fcore%2Ftest%2Freflection%2Freflector_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/274dc15452739e4fab2f647804a64d5b797cfed5/packages%2Fcore%2Ftest%2Freflection%2Freflector_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Freflection%2Freflector_spec.ts?ref=274dc15452739e4fab2f647804a64d5b797cfed5",
            "patch": "@@ -202,13 +202,48 @@ class TestObj {\n       });\n \n       // See: https://github.com/angular/angular/issues/38453\n-      it('should support ES2015 downleveled classes', () => {\n-        const {ChildNoCtor, ChildNoCtorPrivateProps, ChildWithCtor} =\n-            require('./es5_downleveled_inheritance_fixture');\n+      it('should support ES2015 downleveled classes (workspace TypeScript version) (downlevelIteration=true)',\n+         () => {\n+           const {ChildNoCtor, ChildNoCtorPrivateProps, ChildWithCtor} =\n+               require('./es5_downleveled_inheritance_fixture');\n+\n+           expect(isDelegateCtor(ChildNoCtor.toString())).toBe(true);\n+           expect(isDelegateCtor(ChildNoCtorPrivateProps.toString())).toBe(true);\n+           expect(isDelegateCtor(ChildWithCtor.toString())).toBe(false);\n+         });\n+\n+      it('should support ES2015 downleveled classes (<TS4.2) (downlevelIteration=true)', () => {\n+        const ChildNoCtor = `function ChildNoCtor() {\n+          return _super !== null && _super.apply(this, arguments) || this;\n+        }`;\n+        const ChildNoCtorPrivateProps = `function ChildNoCtorPrivateProps() {\n+          var _this = _super.apply(this, __spread(arguments)) || this;\n+          _this.x = 10;\n+          return _this;\n+        }`;\n+        const ChildWithCtor = `function ChildWithCtor() {\n+          return _super.call(this) || this;\n+        }`;\n+        expect(isDelegateCtor(ChildNoCtor)).toBe(true);\n+        expect(isDelegateCtor(ChildNoCtorPrivateProps)).toBe(true);\n+        expect(isDelegateCtor(ChildWithCtor)).toBe(false);\n+      });\n \n-        expect(isDelegateCtor(ChildNoCtor.toString())).toBe(true);\n-        expect(isDelegateCtor(ChildNoCtorPrivateProps.toString())).toBe(true);\n-        expect(isDelegateCtor(ChildWithCtor.toString())).toBe(false);\n+      it('should support ES2015 downleveled classes (>=TS4.2) (downlevelIteration=true)', () => {\n+        const ChildNoCtor = `function ChildNoCtor() {\n+          return _super !== null && _super.apply(this, arguments) || this;\n+        }`;\n+        const ChildNoCtorPrivateProps = `function ChildNoCtorPrivateProps() {\n+          var _this = _super.apply(this, __spreadArray([], __read(arguments))) || this;\n+          _this.x = 10;\n+          return _this;\n+        }`;\n+        const ChildWithCtor = `function ChildWithCtor() {\n+          return _super.call(this) || this;\n+        }`;\n+        expect(isDelegateCtor(ChildNoCtor)).toBe(true);\n+        expect(isDelegateCtor(ChildNoCtorPrivateProps)).toBe(true);\n+        expect(isDelegateCtor(ChildWithCtor)).toBe(false);\n       });\n \n       it('should support ES2015 classes when minified', () => {"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 50,
        "deletions": 8
    }
}