{
    "author": "gkalpak",
    "message": "build(docs-infra): add support for RC deployments to deployment script (#39470)\n\nThis commit updates the angular.io deployment script\n(`deploy-to-firebase.js`) to support deploying release-candidate\nversions.\n\nThis is part of the work needed to prepare angular.io for our\n[new versioning/branching process][1] (also tracked in #39366).\n\n[1]: https://docs.google.com/document/d/197kVillDwx-RZtSVOBtPb4BBIAw0E9RT3q3v6DZkykU\n\nPR Close #39470",
    "sha": "1aaf556815af4a151ead8f8503e664286119d9e7",
    "files": [
        {
            "sha": "4e26bad9ddc021d908b209a8b8f33494a24bd84d",
            "filename": "aio/scripts/deploy-to-firebase.js",
            "status": "modified",
            "additions": 20,
            "deletions": 14,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/1aaf556815af4a151ead8f8503e664286119d9e7/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "raw_url": "https://github.com/angular/angular/raw/1aaf556815af4a151ead8f8503e664286119d9e7/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.js?ref=1aaf556815af4a151ead8f8503e664286119d9e7",
            "patch": "@@ -58,6 +58,12 @@ const deployInfoPerTarget = {\n     siteId: 'aio-staging',\n     deployedUrl: 'https://next.angular.io/',\n   },\n+  rc: {\n+    deployEnv: 'rc',\n+    projectId: 'angular-io',\n+    siteId: 'rc-angular-io-site',\n+    deployedUrl: 'https://rc.angular.io/',\n+  },\n   stable: {\n     deployEnv: 'stable',\n     projectId: 'angular-io',\n@@ -80,17 +86,8 @@ if (CI_BRANCH === 'master') {\n } else {\n   const stableBranchMajorVersion = computeMajorVersion(CI_STABLE_BRANCH);\n \n-  // Do not deploy if the major version is not less than the stable branch major version.\n-  if (currentBranchMajorVersion >= stableBranchMajorVersion) {\n-    console.log(\n-        `Skipping deploy of branch \"${CI_BRANCH}\" to Firebase.\\n` +\n-        'We only deploy archive branches with the major version less than the stable branch: ' +\n-        `\"${CI_STABLE_BRANCH}\"`);\n-    process.exit(0);\n-  }\n-\n   // Find the branch that has highest minor version for the given `currentBranchMajorVersion`.\n-  const mostRecentMinorVersion =\n+  const mostRecentMinorVersionBranch =\n     // List the branches that start with the major version.\n     exec(`git ls-remote ${NG_REMOTE_URL} refs/heads/${currentBranchMajorVersion}.*.x`).split('\\n')\n         // Extract the version number.\n@@ -100,15 +97,24 @@ if (CI_BRANCH === 'master') {\n         // Get the highest version.\n         .pop();\n \n-  // Do not deploy as it is not the latest branch for the given major version.\n-  if (CI_BRANCH !== mostRecentMinorVersion) {\n+  // Do not deploy if it is not the latest branch for the given major version.\n+  // NOTE: At this point, we know the current branch is not the stable branch.\n+  if (CI_BRANCH !== mostRecentMinorVersionBranch) {\n     console.log(\n         `Skipping deploy of branch \"${CI_BRANCH}\" to Firebase.\\n` +\n-        `There is a more recent branch with the same major version: \"${mostRecentMinorVersion}\"`);\n+        'There is a more recent branch with the same major version: ' +\n+        `\"${mostRecentMinorVersionBranch}\"`);\n     process.exit(0);\n   }\n \n-  deployInfo = deployInfoPerTarget.archive;\n+  deployInfo = (currentBranchMajorVersion < stableBranchMajorVersion) ?\n+      // This is the latest minor version for a major that is less than the stable major version:\n+      // Deploy as `archive`.\n+      deployInfoPerTarget.archive :\n+      // This is the latest minor version for a major that is equal or greater than the stable major\n+      // version, but not the stable version itself:\n+      // Deploy as `rc`.\n+      deployInfoPerTarget.rc;\n }\n \n const {deployEnv, projectId, siteId, deployedUrl} = deployInfo;"
        },
        {
            "sha": "e4022e29a64fd9495d16d795ee7f5a5a6ae88005",
            "filename": "aio/scripts/deploy-to-firebase.spec.js",
            "status": "modified",
            "additions": 69,
            "deletions": 9,
            "changes": 78,
            "blob_url": "https://github.com/angular/angular/blob/1aaf556815af4a151ead8f8503e664286119d9e7/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/1aaf556815af4a151ead8f8503e664286119d9e7/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.spec.js?ref=1aaf556815af4a151ead8f8503e664286119d9e7",
            "patch": "@@ -142,7 +142,7 @@ describe('deploy-to-firebase:', () => {\n         `(${getLatestCommitForBranch('2.4.x')}).`);\n   });\n \n-  it('archive - skip deploy - major version too high, lower minor', () => {\n+  it('archive - skip deploy - major same as stable, minor less than stable', () => {\n     expect(deployToFirebaseDryRun({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n@@ -153,11 +153,41 @@ describe('deploy-to-firebase:', () => {\n       CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n     })).toBe(\n         'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n-        'We only deploy archive branches with the major version less than the stable branch: ' +\n-        '\"2.2.x\"');\n+        'There is a more recent branch with the same major version: \"2.4.x\"');\n   });\n \n-  it('archive - skip deploy - major version too high, higher minor', () => {\n+  it('archive - skip deploy - major lower than stable, minor not latest', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '2.1.x',\n+      CI_STABLE_BRANCH: '4.3.x',\n+      CI_COMMIT: getLatestCommitForBranch('2.1.x'),\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n+        'There is a more recent branch with the same major version: \"2.4.x\"');\n+  });\n+\n+  it('rc - deploy success - major higher than stable', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '4.4.x',\n+      CI_STABLE_BRANCH: '2.2.x',\n+      CI_COMMIT: getLatestCommitForBranch('4.4.x'),\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Git branch        : 4.4.x\\n' +\n+        'Build/deploy mode : rc\\n' +\n+        'Firebase project  : angular-io\\n' +\n+        'Firebase site     : rc-angular-io-site\\n' +\n+        'Deployment URL    : https://rc.angular.io/');\n+  });\n+\n+  it('rc - deploy success - major same as stable, minor higher', () => {\n     expect(deployToFirebaseDryRun({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n@@ -167,22 +197,52 @@ describe('deploy-to-firebase:', () => {\n       CI_COMMIT: getLatestCommitForBranch('2.4.x'),\n       CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n     })).toBe(\n-        'Skipping deploy of branch \"2.4.x\" to Firebase.\\n' +\n-        'We only deploy archive branches with the major version less than the stable branch: ' +\n-        '\"2.2.x\"');\n+        'Git branch        : 2.4.x\\n' +\n+        'Build/deploy mode : rc\\n' +\n+        'Firebase project  : angular-io\\n' +\n+        'Firebase site     : rc-angular-io-site\\n' +\n+        'Deployment URL    : https://rc.angular.io/');\n+  });\n+\n+  it('rc - skip deploy - commit not HEAD', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '2.4.x',\n+      CI_STABLE_BRANCH: '2.2.x',\n+      CI_COMMIT: 'DUMMY_TEST_COMMIT',\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n+        `(${getLatestCommitForBranch('2.4.x')}).`);\n   });\n \n-  it('archive - skip deploy - minor version too low', () => {\n+  it('rc - skip deploy - major same as stable, minor not latest', () => {\n     expect(deployToFirebaseDryRun({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.1.x',\n-      CI_STABLE_BRANCH: '4.3.x',\n+      CI_STABLE_BRANCH: '2.0.x',\n       CI_COMMIT: getLatestCommitForBranch('2.1.x'),\n       CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n     })).toBe(\n         'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n         'There is a more recent branch with the same major version: \"2.4.x\"');\n   });\n+\n+  it('rc - skip deploy - major higher than stable, minor not latest', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '4.3.x',\n+      CI_STABLE_BRANCH: '2.4.x',\n+      CI_COMMIT: getLatestCommitForBranch('4.3.x'),\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Skipping deploy of branch \"4.3.x\" to Firebase.\\n' +\n+        'There is a more recent branch with the same major version: \"4.4.x\"');\n+  });\n });"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 89,
        "deletions": 23
    }
}