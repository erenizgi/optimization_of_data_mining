{
    "author": "petebacondarwin",
    "message": "refactor(localize): run the translate plugin tests in mock FileSystems (#38536)\n\nThis commit is a tidy up of the translate plugin unit tests, but also ensures\nthat the tests are run in the context of a mock FileSystem. This ensures\nthat the tests are resilient to future refactors of the plugins that will\nrequire a FileSystem to be initialized.\n\nPR Close #38536",
    "sha": "81053d316036cd6c16b9a620908d89adca75b2e8",
    "files": [
        {
            "sha": "5206ee47f24dd13112c6a65987d933445c168476",
            "filename": "packages/localize/src/tools/test/translate/source_files/es2015_translate_plugin_spec.ts",
            "status": "modified",
            "additions": 159,
            "deletions": 171,
            "changes": 330,
            "blob_url": "https://github.com/angular/angular/blob/81053d316036cd6c16b9a620908d89adca75b2e8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes2015_translate_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/81053d316036cd6c16b9a620908d89adca75b2e8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes2015_translate_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes2015_translate_plugin_spec.ts?ref=81053d316036cd6c16b9a620908d89adca75b2e8",
            "patch": "@@ -5,188 +5,176 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {ɵcomputeMsgId, ɵparseTranslation} from '@angular/localize';\n+import {ɵParsedTranslation} from '@angular/localize/private';\n import {transformSync} from '@babel/core';\n \n import {Diagnostics} from '../../../src/diagnostics';\n+import {TranslatePluginOptions} from '../../../src/source_file_utils';\n import {makeEs2015TranslatePlugin} from '../../../src/translate/source_files/es2015_translate_plugin';\n \n-describe('makeEs2015Plugin', () => {\n-  describe('(no translations)', () => {\n-    it('should transform `$localize` tags with binary expression', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'const b = 10;\\n$localize`try\\\\n${40 + b}\\\\n  me`;';\n-      const output = transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('const b = 10;\\n\"try\\\\n\" + (40 + b) + \"\\\\n  me\";');\n-    });\n-\n-    it('should strip meta blocks', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'const b = 10;\\n$localize `:description:try\\\\n${40 + b}\\\\n  me`;';\n-      const output = transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('const b = 10;\\n\"try\\\\n\" + (40 + b) + \"\\\\n  me\";');\n-    });\n-\n-    it('should not strip escaped meta blocks', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'const b = 10;\\n$localize `\\\\:description:try\\\\n${40 + b}\\\\n  me`;';\n-      const output = transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('const b = 10;\\n\":description:try\\\\n\" + (40 + b) + \"\\\\n  me\";');\n-    });\n-\n-\n-    it('should transform nested `$localize` tags', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = '$localize`a${1}b${$localize`x${5}y${6}z`}c`;';\n-      const output = transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('\"a\" + 1 + \"b\" + (\"x\" + 5 + \"y\" + 6 + \"z\") + \"c\";');\n-    });\n-\n-    it('should transform tags inside functions', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'function foo() { $localize`a${1}b${2}c`; }';\n-      const output = transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('function foo() {\\n  \"a\" + 1 + \"b\" + 2 + \"c\";\\n}');\n-    });\n-\n-    it('should ignore tags with the wrong name', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'other`a${1}b${2}c`;';\n-      const output = transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('other`a${1}b${2}c`;');\n-    });\n-\n-    it('should transform tags with different tag name configured', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'other`a${1}b${2}c`;';\n-      const output = transformSync(\n-          input, {plugins: [makeEs2015TranslatePlugin(diagnostics, {}, {localizeName: 'other'})]})!;\n-      expect(output.code).toEqual('\"a\" + 1 + \"b\" + 2 + \"c\";');\n-    });\n-\n-    it('should ignore tags if the identifier is not global', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'function foo($localize) { $localize`a${1}b${2}c`; }';\n-      const output = transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('function foo($localize) {\\n  $localize`a${1}b${2}c`;\\n}');\n-    });\n-\n-    it('should add missing translation to diagnostic errors if missingTranslation is set to \"error\"',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = 'const b = 10;\\n$localize `try\\\\n${40 + b}\\\\n  me`;';\n-         transformSync(input, {\n-           plugins: [makeEs2015TranslatePlugin(diagnostics, {}, {missingTranslation: 'error'})]\n-         })!;\n-         expect(diagnostics.hasErrors).toBe(true);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'error',\n-           message: `No translation found for \"${\n-               ɵcomputeMsgId('try\\n{$PH}\\n  me')}\" (\"try\\n{$PH}\\n  me\").`\n-         });\n-       });\n-\n-    it('should add missing translation to diagnostic errors if missingTranslation is set to \"warning\"',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = 'const b = 10;\\n$localize `try\\\\n${40 + b}\\\\n  me`;';\n-         transformSync(input, {\n-           plugins: [makeEs2015TranslatePlugin(diagnostics, {}, {missingTranslation: 'warning'})]\n-         })!;\n-         expect(diagnostics.hasErrors).toBe(false);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'warning',\n-           message: `No translation found for \"${\n-               ɵcomputeMsgId('try\\n{$PH}\\n  me')}\" (\"try\\n{$PH}\\n  me\").`\n+runInEachFileSystem(() => {\n+  describe('makeEs2015Plugin', () => {\n+    describe('(no translations)', () => {\n+      it('should transform `$localize` tags with binary expression', () => {\n+        const input = 'const b = 10;\\n$localize`try\\\\n${40 + b}\\\\n  me`;';\n+        const output = transformCode(input);\n+        expect(output).toEqual('const b = 10;\\n\"try\\\\n\" + (40 + b) + \"\\\\n  me\";');\n+      });\n+\n+      it('should strip meta blocks', () => {\n+        const input = 'const b = 10;\\n$localize `:description:try\\\\n${40 + b}\\\\n  me`;';\n+        const output = transformCode(input);\n+        expect(output).toEqual('const b = 10;\\n\"try\\\\n\" + (40 + b) + \"\\\\n  me\";');\n+      });\n+\n+      it('should not strip escaped meta blocks', () => {\n+        const input = 'const b = 10;\\n$localize `\\\\:description:try\\\\n${40 + b}\\\\n  me`;';\n+        const output = transformCode(input);\n+        expect(output).toEqual('const b = 10;\\n\":description:try\\\\n\" + (40 + b) + \"\\\\n  me\";');\n+      });\n+\n+      it('should transform nested `$localize` tags', () => {\n+        const input = '$localize`a${1}b${$localize`x${5}y${6}z`}c`;';\n+        const output = transformCode(input);\n+        expect(output).toEqual('\"a\" + 1 + \"b\" + (\"x\" + 5 + \"y\" + 6 + \"z\") + \"c\";');\n+      });\n+\n+      it('should transform tags inside functions', () => {\n+        const input = 'function foo() { $localize`a${1}b${2}c`; }';\n+        const output = transformCode(input);\n+        expect(output).toEqual('function foo() {\\n  \"a\" + 1 + \"b\" + 2 + \"c\";\\n}');\n+      });\n+\n+      it('should ignore tags with the wrong name', () => {\n+        const input = 'other`a${1}b${2}c`;';\n+        const output = transformCode(input);\n+        expect(output).toEqual('other`a${1}b${2}c`;');\n+      });\n+\n+      it('should transform tags with different tag name configured', () => {\n+        const input = 'other`a${1}b${2}c`;';\n+        const output = transformCode(input, {}, {localizeName: 'other'});\n+        expect(output).toEqual('\"a\" + 1 + \"b\" + 2 + \"c\";');\n+      });\n+\n+      it('should ignore tags if the identifier is not global', () => {\n+        const input = 'function foo($localize) { $localize`a${1}b${2}c`; }';\n+        const output = transformCode(input);\n+        expect(output).toEqual('function foo($localize) {\\n  $localize`a${1}b${2}c`;\\n}');\n+      });\n+\n+      it('should add missing translation to diagnostic errors if missingTranslation is set to \"error\"',\n+         () => {\n+           const input = 'const b = 10;\\n$localize `try\\\\n${40 + b}\\\\n  me`;';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {missingTranslation: 'error'}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(true);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'error',\n+             message: `No translation found for \"${\n+                 ɵcomputeMsgId('try\\n{$PH}\\n  me')}\" (\"try\\n{$PH}\\n  me\").`\n+           });\n          });\n-       });\n-\n-    it('should add missing translation to diagnostic errors if missingTranslation is set to \"ignore\"',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = 'const b = 10;\\n$localize `try\\\\n${40 + b}\\\\n  me`;';\n-         transformSync(input, {\n-           plugins: [makeEs2015TranslatePlugin(diagnostics, {}, {missingTranslation: 'ignore'})]\n-         })!;\n-         expect(diagnostics.hasErrors).toBe(false);\n-         expect(diagnostics.messages).toEqual([]);\n-       });\n-  });\n \n-  describe('(with translations)', () => {\n-    it('should translate message parts (identity translations)', () => {\n-      const diagnostics = new Diagnostics();\n-      const translations = {\n-        [ɵcomputeMsgId('abc')]: ɵparseTranslation('abc'),\n-        [ɵcomputeMsgId('abc{$PH}')]: ɵparseTranslation('abc{$PH}'),\n-        [ɵcomputeMsgId('abc{$PH}def')]: ɵparseTranslation('abc{$PH}def'),\n-        [ɵcomputeMsgId('abc{$PH}def{$PH_1}')]: ɵparseTranslation('abc{$PH}def{$PH_1}'),\n-        [ɵcomputeMsgId('Hello, {$PH}!')]: ɵparseTranslation('Hello, {$PH}!'),\n-      };\n-      const input = '$localize `abc`;\\n' +\n-          '$localize `abc${1 + 2 + 3}`;\\n' +\n-          '$localize `abc${1 + 2 + 3}def`;\\n' +\n-          '$localize `abc${1 + 2 + 3}def${4 + 5 + 6}`;\\n' +\n-          '$localize `Hello, ${getName()}!`;';\n-      const output =\n-          transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, translations)]})!;\n-      expect(output.code)\n-          .toEqual(\n-              '\"abc\";\\n' +\n-              '\"abc\" + (1 + 2 + 3) + \"\";\\n' +\n-              '\"abc\" + (1 + 2 + 3) + \"def\";\\n' +\n-              '\"abc\" + (1 + 2 + 3) + \"def\" + (4 + 5 + 6) + \"\";\\n' +\n-              '\"Hello, \" + getName() + \"!\";');\n-    });\n-\n-    it('should translate message parts (uppercase translations)', () => {\n-      const diagnostics = new Diagnostics();\n-      const translations = {\n-        [ɵcomputeMsgId('abc')]: ɵparseTranslation('ABC'),\n-        [ɵcomputeMsgId('abc{$PH}')]: ɵparseTranslation('ABC{$PH}'),\n-        [ɵcomputeMsgId('abc{$PH}def')]: ɵparseTranslation('ABC{$PH}DEF'),\n-        [ɵcomputeMsgId('abc{$PH}def{$PH_1}')]: ɵparseTranslation('ABC{$PH}DEF{$PH_1}'),\n-        [ɵcomputeMsgId('Hello, {$PH}!')]: ɵparseTranslation('HELLO, {$PH}!'),\n-      };\n-      const input = '$localize `abc`;\\n' +\n-          '$localize `abc${1 + 2 + 3}`;\\n' +\n-          '$localize `abc${1 + 2 + 3}def`;\\n' +\n-          '$localize `abc${1 + 2 + 3}def${4 + 5 + 6}`;\\n' +\n-          '$localize `Hello, ${getName()}!`;';\n-      const output =\n-          transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, translations)]})!;\n-      expect(output.code)\n-          .toEqual(\n-              '\"ABC\";\\n' +\n-              '\"ABC\" + (1 + 2 + 3) + \"\";\\n' +\n-              '\"ABC\" + (1 + 2 + 3) + \"DEF\";\\n' +\n-              '\"ABC\" + (1 + 2 + 3) + \"DEF\" + (4 + 5 + 6) + \"\";\\n' +\n-              '\"HELLO, \" + getName() + \"!\";');\n-    });\n+      it('should add missing translation to diagnostic errors if missingTranslation is set to \"warning\"',\n+         () => {\n+           const input = 'const b = 10;\\n$localize `try\\\\n${40 + b}\\\\n  me`;';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {missingTranslation: 'warning'}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(false);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'warning',\n+             message: `No translation found for \"${\n+                 ɵcomputeMsgId('try\\n{$PH}\\n  me')}\" (\"try\\n{$PH}\\n  me\").`\n+           });\n+         });\n \n-    it('should translate message parts (reversing placeholders)', () => {\n-      const diagnostics = new Diagnostics();\n-      const translations = {\n-        [ɵcomputeMsgId('abc{$PH}def{$PH_1} - Hello, {$PH_2}!')]:\n-            ɵparseTranslation('abc{$PH_2}def{$PH_1} - Hello, {$PH}!'),\n-      };\n-      const input = '$localize `abc${1 + 2 + 3}def${4 + 5 + 6} - Hello, ${getName()}!`;';\n-      const output =\n-          transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, translations)]})!;\n-      expect(output.code)\n-          .toEqual('\"abc\" + getName() + \"def\" + (4 + 5 + 6) + \" - Hello, \" + (1 + 2 + 3) + \"!\";');\n+      it('should add missing translation to diagnostic errors if missingTranslation is set to \"ignore\"',\n+         () => {\n+           const input = 'const b = 10;\\n$localize `try\\\\n${40 + b}\\\\n  me`;';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {missingTranslation: 'ignore'}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(false);\n+           expect(diagnostics.messages).toEqual([]);\n+         });\n     });\n \n-    it('should translate message parts (removing placeholders)', () => {\n-      const diagnostics = new Diagnostics();\n-      const translations = {\n-        [ɵcomputeMsgId('abc{$PH}def{$PH_1} - Hello, {$PH_2}!')]:\n-            ɵparseTranslation('abc{$PH} - Hello, {$PH_2}!'),\n-      };\n-      const input = '$localize `abc${1 + 2 + 3}def${4 + 5 + 6} - Hello, ${getName()}!`;';\n-      const output =\n-          transformSync(input, {plugins: [makeEs2015TranslatePlugin(diagnostics, translations)]})!;\n-      expect(output.code).toEqual('\"abc\" + (1 + 2 + 3) + \" - Hello, \" + getName() + \"!\";');\n+    describe('(with translations)', () => {\n+      it('should translate message parts (identity translations)', () => {\n+        const translations = {\n+          [ɵcomputeMsgId('abc')]: ɵparseTranslation('abc'),\n+          [ɵcomputeMsgId('abc{$PH}')]: ɵparseTranslation('abc{$PH}'),\n+          [ɵcomputeMsgId('abc{$PH}def')]: ɵparseTranslation('abc{$PH}def'),\n+          [ɵcomputeMsgId('abc{$PH}def{$PH_1}')]: ɵparseTranslation('abc{$PH}def{$PH_1}'),\n+          [ɵcomputeMsgId('Hello, {$PH}!')]: ɵparseTranslation('Hello, {$PH}!'),\n+        };\n+        const input = '$localize `abc`;\\n' +\n+            '$localize `abc${1 + 2 + 3}`;\\n' +\n+            '$localize `abc${1 + 2 + 3}def`;\\n' +\n+            '$localize `abc${1 + 2 + 3}def${4 + 5 + 6}`;\\n' +\n+            '$localize `Hello, ${getName()}!`;';\n+        const output = transformCode(input, translations);\n+        expect(output).toEqual(\n+            '\"abc\";\\n' +\n+            '\"abc\" + (1 + 2 + 3) + \"\";\\n' +\n+            '\"abc\" + (1 + 2 + 3) + \"def\";\\n' +\n+            '\"abc\" + (1 + 2 + 3) + \"def\" + (4 + 5 + 6) + \"\";\\n' +\n+            '\"Hello, \" + getName() + \"!\";');\n+      });\n+\n+      it('should translate message parts (uppercase translations)', () => {\n+        const translations = {\n+          [ɵcomputeMsgId('abc')]: ɵparseTranslation('ABC'),\n+          [ɵcomputeMsgId('abc{$PH}')]: ɵparseTranslation('ABC{$PH}'),\n+          [ɵcomputeMsgId('abc{$PH}def')]: ɵparseTranslation('ABC{$PH}DEF'),\n+          [ɵcomputeMsgId('abc{$PH}def{$PH_1}')]: ɵparseTranslation('ABC{$PH}DEF{$PH_1}'),\n+          [ɵcomputeMsgId('Hello, {$PH}!')]: ɵparseTranslation('HELLO, {$PH}!'),\n+        };\n+        const input = '$localize `abc`;\\n' +\n+            '$localize `abc${1 + 2 + 3}`;\\n' +\n+            '$localize `abc${1 + 2 + 3}def`;\\n' +\n+            '$localize `abc${1 + 2 + 3}def${4 + 5 + 6}`;\\n' +\n+            '$localize `Hello, ${getName()}!`;';\n+        const output = transformCode(input, translations);\n+        expect(output).toEqual(\n+            '\"ABC\";\\n' +\n+            '\"ABC\" + (1 + 2 + 3) + \"\";\\n' +\n+            '\"ABC\" + (1 + 2 + 3) + \"DEF\";\\n' +\n+            '\"ABC\" + (1 + 2 + 3) + \"DEF\" + (4 + 5 + 6) + \"\";\\n' +\n+            '\"HELLO, \" + getName() + \"!\";');\n+      });\n+\n+      it('should translate message parts (reversing placeholders)', () => {\n+        const translations = {\n+          [ɵcomputeMsgId('abc{$PH}def{$PH_1} - Hello, {$PH_2}!')]:\n+              ɵparseTranslation('abc{$PH_2}def{$PH_1} - Hello, {$PH}!'),\n+        };\n+        const input = '$localize `abc${1 + 2 + 3}def${4 + 5 + 6} - Hello, ${getName()}!`;';\n+        const output = transformCode(input, translations);\n+        expect(output).toEqual(\n+            '\"abc\" + getName() + \"def\" + (4 + 5 + 6) + \" - Hello, \" + (1 + 2 + 3) + \"!\";');\n+      });\n+\n+      it('should translate message parts (removing placeholders)', () => {\n+        const translations = {\n+          [ɵcomputeMsgId('abc{$PH}def{$PH_1} - Hello, {$PH_2}!')]:\n+              ɵparseTranslation('abc{$PH} - Hello, {$PH_2}!'),\n+        };\n+        const input = '$localize `abc${1 + 2 + 3}def${4 + 5 + 6} - Hello, ${getName()}!`;';\n+        const output = transformCode(input, translations);\n+        expect(output).toEqual('\"abc\" + (1 + 2 + 3) + \" - Hello, \" + getName() + \"!\";');\n+      });\n     });\n   });\n });\n+\n+function transformCode(\n+    input: string, translations: Record<string, ɵParsedTranslation> = {},\n+    pluginOptions?: TranslatePluginOptions, diagnostics = new Diagnostics()): string {\n+  return transformSync(input, {\n+           plugins: [makeEs2015TranslatePlugin(diagnostics, translations, pluginOptions)],\n+           filename: '/app/dist/test.js'\n+         })!.code!;\n+}"
        },
        {
            "sha": "99c815d11afbf48e2903009a7ac3828cfa4b5afa",
            "filename": "packages/localize/src/tools/test/translate/source_files/es5_translate_plugin_spec.ts",
            "status": "modified",
            "additions": 288,
            "deletions": 319,
            "changes": 607,
            "blob_url": "https://github.com/angular/angular/blob/81053d316036cd6c16b9a620908d89adca75b2e8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes5_translate_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/81053d316036cd6c16b9a620908d89adca75b2e8/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes5_translate_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Fsource_files%2Fes5_translate_plugin_spec.ts?ref=81053d316036cd6c16b9a620908d89adca75b2e8",
            "patch": "@@ -5,107 +5,96 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {ɵcomputeMsgId, ɵparseTranslation} from '@angular/localize';\n+import {ɵParsedTranslation} from '@angular/localize/private';\n import {transformSync} from '@babel/core';\n \n import {Diagnostics} from '../../../src/diagnostics';\n+import {TranslatePluginOptions} from '../../../src/source_file_utils';\n import {makeEs5TranslatePlugin} from '../../../src/translate/source_files/es5_translate_plugin';\n \n-describe('makeEs5Plugin', () => {\n-  describe('(no translations)', () => {\n-    it('should transform `$localize` calls with binary expression', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'const b = 10;\\n$localize([\"try\\\\n\", \"\\\\n  me\"], 40 + b);';\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('const b = 10;\\n\"try\\\\n\" + (40 + b) + \"\\\\n  me\";');\n-    });\n+runInEachFileSystem(() => {\n+  describe('makeEs5Plugin', () => {\n+    describe('(no translations)', () => {\n+      it('should transform `$localize` calls with binary expression', () => {\n+        const input = 'const b = 10;\\n$localize([\"try\\\\n\", \"\\\\n  me\"], 40 + b);';\n+        const output = transformCode(input);\n+        expect(output).toEqual('const b = 10;\\n\"try\\\\n\" + (40 + b) + \"\\\\n  me\";');\n+      });\n \n-    it('should strip meta blocks', () => {\n-      const diagnostics = new Diagnostics();\n-      const input =\n-          'const b = 10;\\n$localize([\":description:try\\\\n\", \":placeholder:\\\\n  me\"], 40 + b);';\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('const b = 10;\\n\"try\\\\n\" + (40 + b) + \"\\\\n  me\";');\n-    });\n+      it('should strip meta blocks', () => {\n+        const input =\n+            'const b = 10;\\n$localize([\":description:try\\\\n\", \":placeholder:\\\\n  me\"], 40 + b);';\n+        const output = transformCode(input);\n+        expect(output).toEqual('const b = 10;\\n\"try\\\\n\" + (40 + b) + \"\\\\n  me\";');\n+      });\n \n-    it('should not strip escaped meta blocks', () => {\n-      const diagnostics = new Diagnostics();\n-      const input =\n-          `$localize(__makeTemplateObject([':desc:try', 'me'], ['\\\\\\\\\\\\:desc:try', 'me']), 40 + 2);`;\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('\":desc:try\" + (40 + 2) + \"me\";');\n-    });\n+      it('should not strip escaped meta blocks', () => {\n+        const input =\n+            `$localize(__makeTemplateObject([':desc:try', 'me'], ['\\\\\\\\\\\\:desc:try', 'me']), 40 + 2);`;\n+        const output = transformCode(input);\n+        expect(output).toEqual('\":desc:try\" + (40 + 2) + \"me\";');\n+      });\n \n-    it('should transform nested `$localize` calls', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = '$localize([\"a\", \"b\", \"c\"], 1, $localize([\"x\", \"y\", \"z\"], 5, 6));';\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('\"a\" + 1 + \"b\" + (\"x\" + 5 + \"y\" + 6 + \"z\") + \"c\";');\n-    });\n+      it('should transform nested `$localize` calls', () => {\n+        const input = '$localize([\"a\", \"b\", \"c\"], 1, $localize([\"x\", \"y\", \"z\"], 5, 6));';\n+        const output = transformCode(input);\n+        expect(output).toEqual('\"a\" + 1 + \"b\" + (\"x\" + 5 + \"y\" + 6 + \"z\") + \"c\";');\n+      });\n \n-    it('should transform calls inside functions', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'function foo() { $localize([\"a\", \"b\", \"c\"], 1, 2); }';\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('function foo() {\\n  \"a\" + 1 + \"b\" + 2 + \"c\";\\n}');\n-    });\n+      it('should transform calls inside functions', () => {\n+        const input = 'function foo() { $localize([\"a\", \"b\", \"c\"], 1, 2); }';\n+        const output = transformCode(input);\n+        expect(output).toEqual('function foo() {\\n  \"a\" + 1 + \"b\" + 2 + \"c\";\\n}');\n+      });\n \n-    it('should ignore tags with the wrong name', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'other([\"a\", \"b\", \"c\"], 1, 2);';\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('other([\"a\", \"b\", \"c\"], 1, 2);');\n-    });\n+      it('should ignore tags with the wrong name', () => {\n+        const input = 'other([\"a\", \"b\", \"c\"], 1, 2);';\n+        const output = transformCode(input);\n+        expect(output).toEqual('other([\"a\", \"b\", \"c\"], 1, 2);');\n+      });\n \n-    it('should transform calls with different function name configured', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'other([\"a\", \"b\", \"c\"], 1, 2);';\n-      const output = transformSync(\n-          input, {plugins: [makeEs5TranslatePlugin(diagnostics, {}, {localizeName: 'other'})]})!;\n-      expect(output.code).toEqual('\"a\" + 1 + \"b\" + 2 + \"c\";');\n-    });\n+      it('should transform calls with different function name configured', () => {\n+        const input = 'other([\"a\", \"b\", \"c\"], 1, 2);';\n+        const output = transformCode(input, {}, {localizeName: 'other'});\n+        expect(output).toEqual('\"a\" + 1 + \"b\" + 2 + \"c\";');\n+      });\n \n-    it('should ignore tags if the identifier is not global', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'function foo($localize) { $localize([\"a\", \"b\", \"c\"], 1, 2); }';\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code)\n-          .toEqual('function foo($localize) {\\n  $localize([\"a\", \"b\", \"c\"], 1, 2);\\n}');\n-    });\n+      it('should ignore tags if the identifier is not global', () => {\n+        const input = 'function foo($localize) { $localize([\"a\", \"b\", \"c\"], 1, 2); }';\n+        const output = transformCode(input);\n+        expect(output).toEqual('function foo($localize) {\\n  $localize([\"a\", \"b\", \"c\"], 1, 2);\\n}');\n+      });\n \n-    it('should handle template object helper calls', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = `$localize(__makeTemplateObject(['try', 'me'], ['try', 'me']), 40 + 2);`;\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('\"try\" + (40 + 2) + \"me\";');\n-    });\n+      it('should handle template object helper calls', () => {\n+        const input = `$localize(__makeTemplateObject(['try', 'me'], ['try', 'me']), 40 + 2);`;\n+        const output = transformCode(input);\n+        expect(output).toEqual('\"try\" + (40 + 2) + \"me\";');\n+      });\n \n-    it('should handle template object aliased helper calls', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = `$localize(m(['try', 'me'], ['try', 'me']), 40 + 2);`;\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('\"try\" + (40 + 2) + \"me\";');\n-    });\n+      it('should handle template object aliased helper calls', () => {\n+        const input = `$localize(m(['try', 'me'], ['try', 'me']), 40 + 2);`;\n+        const output = transformCode(input);\n+        expect(output).toEqual('\"try\" + (40 + 2) + \"me\";');\n+      });\n \n-    it('should handle template object inline helper calls', () => {\n-      const diagnostics = new Diagnostics();\n-      const input =\n-          `$localize((this&&this.__makeTemplateObject||function(e,t){return Object.defineProperty?Object.defineProperty(e,\"raw\",{value:t}):e.raw=t,e})(['try', 'me'], ['try', 'me']), 40 + 2);`;\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('\"try\" + (40 + 2) + \"me\";');\n-    });\n+      it('should handle template object inline helper calls', () => {\n+        const input =\n+            `$localize((this&&this.__makeTemplateObject||function(e,t){return Object.defineProperty?Object.defineProperty(e,\"raw\",{value:t}):e.raw=t,e})(['try', 'me'], ['try', 'me']), 40 + 2);`;\n+        const output = transformCode(input);\n+        expect(output).toEqual('\"try\" + (40 + 2) + \"me\";');\n+      });\n \n-    it('should handle cached helper calls', () => {\n-      const diagnostics = new Diagnostics();\n-      const input =\n-          `$localize(cachedObj||(cachedObj=__makeTemplateObject(['try', 'me'],['try', 'me'])),40 + 2)`;\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('\"try\" + (40 + 2) + \"me\";');\n-    });\n+      it('should handle cached helper calls', () => {\n+        const input =\n+            `$localize(cachedObj||(cachedObj=__makeTemplateObject(['try', 'me'],['try', 'me'])),40 + 2)`;\n+        const output = transformCode(input);\n+        expect(output).toEqual('\"try\" + (40 + 2) + \"me\";');\n+      });\n \n-    it('should handle minified code', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = `$localize(\n+      it('should handle minified code', () => {\n+        const input = `$localize(\n         cachedObj||\n         (\n           cookedParts=['try', 'me'],\n@@ -115,13 +104,12 @@ describe('makeEs5Plugin', () => {\n             cookedParts.raw=rawParts,\n           cachedObj=cookedParts\n         ),40 + 2)`;\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toEqual('\"try\" + (40 + 2) + \"me\";');\n-    });\n+        const output = transformCode(input);\n+        expect(output).toEqual('\"try\" + (40 + 2) + \"me\";');\n+      });\n \n-    it('should handle lazy-load helper calls', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = `\n+      it('should handle lazy-load helper calls', () => {\n+        const input = `\n       function _templateObject2() {\n         var e = _taggedTemplateLiteral([':escaped-colons:Welcome to the i18n app.'], ['\\\\\\\\\\\\:escaped-colons:Welcome to the i18n app.']);\n         return _templateObject2 = function() { return e }, e\n@@ -139,262 +127,243 @@ describe('makeEs5Plugin', () => {\n         console.log($localize(_templateObject(), '\\ufffd0\\ufffd'));\n       }\n       `;\n-      const output = transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, {})]})!;\n-      expect(output.code).toContain('const message = \":escaped-colons:Welcome to the i18n app.\"');\n-      expect(output.code).toContain('console.log(\" Hello \" + \\'\\ufffd0\\ufffd\\' + \"! \");');\n-      expect(output.code).not.toContain('templateObject');\n-      expect(output.code).not.toContain('templateObject2');\n-    });\n+        const output = transformCode(input);\n+        expect(output).toContain('const message = \":escaped-colons:Welcome to the i18n app.\"');\n+        expect(output).toContain('console.log(\" Hello \" + \\'\\ufffd0\\ufffd\\' + \"! \");');\n+        expect(output).not.toContain('templateObject');\n+        expect(output).not.toContain('templateObject2');\n+      });\n \n-    it('should add diagnostic error with code-frame information if the arguments to `$localize` are missing',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = '$localize()';\n-         transformSync(\n-             input,\n-             {plugins: [makeEs5TranslatePlugin(diagnostics, {})], filename: '/app/dist/test.js'});\n-         expect(diagnostics.hasErrors).toBe(true);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'error',\n-           message: '/app/dist/test.js: `$localize` called without any arguments.\\n' +\n-               '> 1 | $localize()\\n' +\n-               '    | ^^^^^^^^^^^',\n+      it('should add diagnostic error with code-frame information if the arguments to `$localize` are missing',\n+         () => {\n+           const input = '$localize()';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(true);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'error',\n+             message: '/app/dist/test.js: `$localize` called without any arguments.\\n' +\n+                 '> 1 | $localize()\\n' +\n+                 '    | ^^^^^^^^^^^',\n+           });\n          });\n-       });\n \n-    it('should add diagnostic error with code-frame information if the arguments to `$localize` are invalid',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = '$localize(...x)';\n-         transformSync(\n-             input,\n-             {plugins: [makeEs5TranslatePlugin(diagnostics, {})], filename: '/app/dist/test.js'});\n-         expect(diagnostics.hasErrors).toBe(true);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'error',\n-           message: '/app/dist/test.js: Unexpected argument to `$localize` (expected an array).\\n' +\n-               '> 1 | $localize(...x)\\n' +\n-               '    |           ^^^^',\n+      it('should add diagnostic error with code-frame information if the arguments to `$localize` are invalid',\n+         () => {\n+           const input = '$localize(...x)';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(true);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'error',\n+             message:\n+                 '/app/dist/test.js: Unexpected argument to `$localize` (expected an array).\\n' +\n+                 '> 1 | $localize(...x)\\n' +\n+                 '    |           ^^^^',\n+           });\n          });\n-       });\n \n-    it('should add diagnostic error with code-frame information if the first argument to `$localize` is not an array',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = '$localize(null, [])';\n-         transformSync(\n-             input,\n-             {plugins: [makeEs5TranslatePlugin(diagnostics, {})], filename: '/app/dist/test.js'});\n-         expect(diagnostics.hasErrors).toBe(true);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'error',\n-           message:\n-               '/app/dist/test.js: Unexpected messageParts for `$localize` (expected an array of strings).\\n' +\n-               '> 1 | $localize(null, [])\\n' +\n-               '    |           ^^^^',\n+      it('should add diagnostic error with code-frame information if the first argument to `$localize` is not an array',\n+         () => {\n+           const input = '$localize(null, [])';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(true);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'error',\n+             message:\n+                 '/app/dist/test.js: Unexpected messageParts for `$localize` (expected an array of strings).\\n' +\n+                 '> 1 | $localize(null, [])\\n' +\n+                 '    |           ^^^^',\n+           });\n          });\n-       });\n \n-    it('should add diagnostic error with code-frame information if raw message parts are not an expression',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = '$localize(__makeTemplateObject([], ...[]))';\n-         transformSync(\n-             input,\n-             {plugins: [makeEs5TranslatePlugin(diagnostics, {})], filename: '/app/dist/test.js'});\n-         expect(diagnostics.hasErrors).toBe(true);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'error',\n-           message:\n-               '/app/dist/test.js: Unexpected `raw` argument to the \"makeTemplateObject()\" function (expected an expression).\\n' +\n-               '> 1 | $localize(__makeTemplateObject([], ...[]))\\n' +\n-               '    |                                    ^^^^^',\n+      it('should add diagnostic error with code-frame information if raw message parts are not an expression',\n+         () => {\n+           const input = '$localize(__makeTemplateObject([], ...[]))';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(true);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'error',\n+             message:\n+                 '/app/dist/test.js: Unexpected `raw` argument to the \"makeTemplateObject()\" function (expected an expression).\\n' +\n+                 '> 1 | $localize(__makeTemplateObject([], ...[]))\\n' +\n+                 '    |                                    ^^^^^',\n+           });\n          });\n-       });\n \n-    it('should add diagnostic error with code-frame information if cooked message parts are not an expression',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = '$localize(__makeTemplateObject(...[], []))';\n-         transformSync(\n-             input,\n-             {plugins: [makeEs5TranslatePlugin(diagnostics, {})], filename: '/app/dist/test.js'});\n-         expect(diagnostics.hasErrors).toBe(true);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'error',\n-           message:\n-               '/app/dist/test.js: Unexpected `cooked` argument to the \"makeTemplateObject()\" function (expected an expression).\\n' +\n-               '> 1 | $localize(__makeTemplateObject(...[], []))\\n' +\n-               '    |                                ^^^^^',\n+      it('should add diagnostic error with code-frame information if cooked message parts are not an expression',\n+         () => {\n+           const input = '$localize(__makeTemplateObject(...[], []))';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(true);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'error',\n+             message:\n+                 '/app/dist/test.js: Unexpected `cooked` argument to the \"makeTemplateObject()\" function (expected an expression).\\n' +\n+                 '> 1 | $localize(__makeTemplateObject(...[], []))\\n' +\n+                 '    |                                ^^^^^',\n+           });\n          });\n-       });\n \n-    it('should add diagnostic error with code-frame information if not all cooked message parts are strings',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = '$localize(__makeTemplateObject([\"a\", 12, \"b\"], [\"a\", \"12\", \"b\"]))';\n-         transformSync(\n-             input,\n-             {plugins: [makeEs5TranslatePlugin(diagnostics, {})], filename: '/app/dist/test.js'});\n-         expect(diagnostics.hasErrors).toBe(true);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'error',\n-           message:\n-               '/app/dist/test.js: Unexpected messageParts for `$localize` (expected an array of strings).\\n' +\n-               '> 1 | $localize(__makeTemplateObject([\"a\", 12, \"b\"], [\"a\", \"12\", \"b\"]))\\n' +\n-               '    |                                ^^^^^^^^^^^^^^',\n+      it('should add diagnostic error with code-frame information if not all cooked message parts are strings',\n+         () => {\n+           const input = '$localize(__makeTemplateObject([\"a\", 12, \"b\"], [\"a\", \"12\", \"b\"]))';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(true);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'error',\n+             message:\n+                 '/app/dist/test.js: Unexpected messageParts for `$localize` (expected an array of strings).\\n' +\n+                 '> 1 | $localize(__makeTemplateObject([\"a\", 12, \"b\"], [\"a\", \"12\", \"b\"]))\\n' +\n+                 '    |                                ^^^^^^^^^^^^^^',\n+           });\n          });\n-       });\n \n-    it('should add diagnostic error with code-frame information if not all raw message parts are strings',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = '$localize(__makeTemplateObject([\"a\", \"12\", \"b\"], [\"a\", 12, \"b\"]))';\n-         transformSync(\n-             input,\n-             {plugins: [makeEs5TranslatePlugin(diagnostics, {})], filename: '/app/dist/test.js'});\n-         expect(diagnostics.hasErrors).toBe(true);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'error',\n-           message:\n-               '/app/dist/test.js: Unexpected messageParts for `$localize` (expected an array of strings).\\n' +\n-               '> 1 | $localize(__makeTemplateObject([\"a\", \"12\", \"b\"], [\"a\", 12, \"b\"]))\\n' +\n-               '    |                                                  ^^^^^^^^^^^^^^',\n+      it('should add diagnostic error with code-frame information if not all raw message parts are strings',\n+         () => {\n+           const input = '$localize(__makeTemplateObject([\"a\", \"12\", \"b\"], [\"a\", 12, \"b\"]))';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(true);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'error',\n+             message:\n+                 '/app/dist/test.js: Unexpected messageParts for `$localize` (expected an array of strings).\\n' +\n+                 '> 1 | $localize(__makeTemplateObject([\"a\", \"12\", \"b\"], [\"a\", 12, \"b\"]))\\n' +\n+                 '    |                                                  ^^^^^^^^^^^^^^',\n+           });\n          });\n-       });\n \n-    it('should add diagnostic error with code-frame information if not all substitutions are expressions',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = '$localize(__makeTemplateObject([\"a\", \"b\"], [\"a\", \"b\"]), ...[])';\n-         transformSync(\n-             input,\n-             {plugins: [makeEs5TranslatePlugin(diagnostics, {})], filename: '/app/dist/test.js'});\n-         expect(diagnostics.hasErrors).toBe(true);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'error',\n-           message:\n-               '/app/dist/test.js: Invalid substitutions for `$localize` (expected all substitution arguments to be expressions).\\n' +\n-               '> 1 | $localize(__makeTemplateObject([\"a\", \"b\"], [\"a\", \"b\"]), ...[])\\n' +\n-               '    |                                                         ^^^^^',\n+      it('should add diagnostic error with code-frame information if not all substitutions are expressions',\n+         () => {\n+           const input = '$localize(__makeTemplateObject([\"a\", \"b\"], [\"a\", \"b\"]), ...[])';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(true);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'error',\n+             message:\n+                 '/app/dist/test.js: Invalid substitutions for `$localize` (expected all substitution arguments to be expressions).\\n' +\n+                 '> 1 | $localize(__makeTemplateObject([\"a\", \"b\"], [\"a\", \"b\"]), ...[])\\n' +\n+                 '    |                                                         ^^^^^',\n+           });\n          });\n-       });\n \n-    it('should add missing translation to diagnostic errors if missingTranslation is set to \"error\"',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = 'const b = 10;\\n$localize([\"try\\\\n\", \"\\\\n  me\"], 40 + b);';\n-         transformSync(\n-             input,\n-             {plugins: [makeEs5TranslatePlugin(diagnostics, {}, {missingTranslation: 'error'})]});\n-         expect(diagnostics.hasErrors).toBe(true);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'error',\n-           message: `No translation found for \"${\n-               ɵcomputeMsgId('try\\n{$PH}\\n  me')}\" (\"try\\n{$PH}\\n  me\").`\n+      it('should add missing translation to diagnostic errors if missingTranslation is set to \"error\"',\n+         () => {\n+           const input = 'const b = 10;\\n$localize([\"try\\\\n\", \"\\\\n  me\"], 40 + b);';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {missingTranslation: 'error'}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(true);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'error',\n+             message: `No translation found for \"${\n+                 ɵcomputeMsgId('try\\n{$PH}\\n  me')}\" (\"try\\n{$PH}\\n  me\").`\n+           });\n          });\n-       });\n \n-    it('should add missing translation to diagnostic warnings if missingTranslation is set to \"warning\"',\n-       () => {\n-         const diagnostics = new Diagnostics();\n-         const input = 'const b = 10;\\n$localize([\"try\\\\n\", \"\\\\n  me\"], 40 + b);';\n-         transformSync(\n-             input,\n-             {plugins: [makeEs5TranslatePlugin(diagnostics, {}, {missingTranslation: 'warning'})]});\n-         expect(diagnostics.hasErrors).toBe(false);\n-         expect(diagnostics.messages[0]).toEqual({\n-           type: 'warning',\n-           message: `No translation found for \"${\n-               ɵcomputeMsgId('try\\n{$PH}\\n  me')}\" (\"try\\n{$PH}\\n  me\").`\n+      it('should add missing translation to diagnostic warnings if missingTranslation is set to \"warning\"',\n+         () => {\n+           const input = 'const b = 10;\\n$localize([\"try\\\\n\", \"\\\\n  me\"], 40 + b);';\n+           const diagnostics = new Diagnostics();\n+           transformCode(input, {}, {missingTranslation: 'warning'}, diagnostics);\n+           expect(diagnostics.hasErrors).toBe(false);\n+           expect(diagnostics.messages[0]).toEqual({\n+             type: 'warning',\n+             message: `No translation found for \"${\n+                 ɵcomputeMsgId('try\\n{$PH}\\n  me')}\" (\"try\\n{$PH}\\n  me\").`\n+           });\n          });\n-       });\n \n-    it('should ignore missing translations if missingTranslation is set to \"ignore\"', () => {\n-      const diagnostics = new Diagnostics();\n-      const input = 'const b = 10;\\n$localize([\"try\\\\n\", \"\\\\n  me\"], 40 + b);';\n-      transformSync(\n-          input,\n-          {plugins: [makeEs5TranslatePlugin(diagnostics, {}, {missingTranslation: 'ignore'})]});\n-      expect(diagnostics.hasErrors).toBe(false);\n-      expect(diagnostics.messages).toEqual([]);\n+      it('should ignore missing translations if missingTranslation is set to \"ignore\"', () => {\n+        const input = 'const b = 10;\\n$localize([\"try\\\\n\", \"\\\\n  me\"], 40 + b);';\n+        const diagnostics = new Diagnostics();\n+        transformCode(input, {}, {missingTranslation: 'ignore'}, diagnostics);\n+        expect(diagnostics.hasErrors).toBe(false);\n+        expect(diagnostics.messages).toEqual([]);\n+      });\n     });\n   });\n-});\n \n-describe('(with translations)', () => {\n-  it('should translate message parts (identity translations)', () => {\n-    const diagnostics = new Diagnostics();\n-    const translations = {\n-      [ɵcomputeMsgId('abc')]: ɵparseTranslation('abc'),\n-      [ɵcomputeMsgId('abc{$PH}')]: ɵparseTranslation('abc{$PH}'),\n-      [ɵcomputeMsgId('abc{$PH}def')]: ɵparseTranslation('abc{$PH}def'),\n-      [ɵcomputeMsgId('abc{$PH}def{$PH_1}')]: ɵparseTranslation('abc{$PH}def{$PH_1}'),\n-      [ɵcomputeMsgId('Hello, {$PH}!')]: ɵparseTranslation('Hello, {$PH}!'),\n-    };\n-    const input = '$localize([\"abc\"]);\\n' +\n-        '$localize([\"abc\", \"\"], 1 + 2 + 3);\\n' +\n-        '$localize([\"abc\", \"def\"], 1 + 2 + 3);\\n' +\n-        '$localize([\"abc\", \"def\", \"\"], 1 + 2 + 3, 4 + 5 + 6);\\n' +\n-        '$localize([\"Hello, \", \"!\"], getName());';\n-    const output =\n-        transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, translations)]})!;\n-    expect(output.code)\n-        .toEqual(\n-            '\"abc\";\\n' +\n-            '\"abc\" + (1 + 2 + 3) + \"\";\\n' +\n-            '\"abc\" + (1 + 2 + 3) + \"def\";\\n' +\n-            '\"abc\" + (1 + 2 + 3) + \"def\" + (4 + 5 + 6) + \"\";\\n' +\n-            '\"Hello, \" + getName() + \"!\";');\n-  });\n+  describe('(with translations)', () => {\n+    it('should translate message parts (identity translations)', () => {\n+      const translations = {\n+        [ɵcomputeMsgId('abc')]: ɵparseTranslation('abc'),\n+        [ɵcomputeMsgId('abc{$PH}')]: ɵparseTranslation('abc{$PH}'),\n+        [ɵcomputeMsgId('abc{$PH}def')]: ɵparseTranslation('abc{$PH}def'),\n+        [ɵcomputeMsgId('abc{$PH}def{$PH_1}')]: ɵparseTranslation('abc{$PH}def{$PH_1}'),\n+        [ɵcomputeMsgId('Hello, {$PH}!')]: ɵparseTranslation('Hello, {$PH}!'),\n+      };\n+      const input = '$localize([\"abc\"]);\\n' +\n+          '$localize([\"abc\", \"\"], 1 + 2 + 3);\\n' +\n+          '$localize([\"abc\", \"def\"], 1 + 2 + 3);\\n' +\n+          '$localize([\"abc\", \"def\", \"\"], 1 + 2 + 3, 4 + 5 + 6);\\n' +\n+          '$localize([\"Hello, \", \"!\"], getName());';\n+      const output = transformCode(input, translations);\n+      expect(output).toEqual(\n+          '\"abc\";\\n' +\n+          '\"abc\" + (1 + 2 + 3) + \"\";\\n' +\n+          '\"abc\" + (1 + 2 + 3) + \"def\";\\n' +\n+          '\"abc\" + (1 + 2 + 3) + \"def\" + (4 + 5 + 6) + \"\";\\n' +\n+          '\"Hello, \" + getName() + \"!\";');\n+    });\n \n-  it('should translate message parts (uppercase translations)', () => {\n-    const diagnostics = new Diagnostics();\n-    const translations = {\n-      [ɵcomputeMsgId('abc')]: ɵparseTranslation('ABC'),\n-      [ɵcomputeMsgId('abc{$PH}')]: ɵparseTranslation('ABC{$PH}'),\n-      [ɵcomputeMsgId('abc{$PH}def')]: ɵparseTranslation('ABC{$PH}DEF'),\n-      [ɵcomputeMsgId('abc{$PH}def{$PH_1}')]: ɵparseTranslation('ABC{$PH}DEF{$PH_1}'),\n-      [ɵcomputeMsgId('Hello, {$PH}!')]: ɵparseTranslation('HELLO, {$PH}!'),\n-    };\n-    const input = '$localize([\"abc\"]);\\n' +\n-        '$localize([\"abc\", \"\"], 1 + 2 + 3);\\n' +\n-        '$localize([\"abc\", \"def\"], 1 + 2 + 3);\\n' +\n-        '$localize([\"abc\", \"def\", \"\"], 1 + 2 + 3, 4 + 5 + 6);\\n' +\n-        '$localize([\"Hello, \", \"!\"], getName());';\n-    const output =\n-        transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, translations)]})!;\n-    expect(output.code)\n-        .toEqual(\n-            '\"ABC\";\\n' +\n-            '\"ABC\" + (1 + 2 + 3) + \"\";\\n' +\n-            '\"ABC\" + (1 + 2 + 3) + \"DEF\";\\n' +\n-            '\"ABC\" + (1 + 2 + 3) + \"DEF\" + (4 + 5 + 6) + \"\";\\n' +\n-            '\"HELLO, \" + getName() + \"!\";');\n-  });\n+    it('should translate message parts (uppercase translations)', () => {\n+      const translations = {\n+        [ɵcomputeMsgId('abc')]: ɵparseTranslation('ABC'),\n+        [ɵcomputeMsgId('abc{$PH}')]: ɵparseTranslation('ABC{$PH}'),\n+        [ɵcomputeMsgId('abc{$PH}def')]: ɵparseTranslation('ABC{$PH}DEF'),\n+        [ɵcomputeMsgId('abc{$PH}def{$PH_1}')]: ɵparseTranslation('ABC{$PH}DEF{$PH_1}'),\n+        [ɵcomputeMsgId('Hello, {$PH}!')]: ɵparseTranslation('HELLO, {$PH}!'),\n+      };\n+      const input = '$localize([\"abc\"]);\\n' +\n+          '$localize([\"abc\", \"\"], 1 + 2 + 3);\\n' +\n+          '$localize([\"abc\", \"def\"], 1 + 2 + 3);\\n' +\n+          '$localize([\"abc\", \"def\", \"\"], 1 + 2 + 3, 4 + 5 + 6);\\n' +\n+          '$localize([\"Hello, \", \"!\"], getName());';\n+      const output = transformCode(input, translations);\n+      expect(output).toEqual(\n+          '\"ABC\";\\n' +\n+          '\"ABC\" + (1 + 2 + 3) + \"\";\\n' +\n+          '\"ABC\" + (1 + 2 + 3) + \"DEF\";\\n' +\n+          '\"ABC\" + (1 + 2 + 3) + \"DEF\" + (4 + 5 + 6) + \"\";\\n' +\n+          '\"HELLO, \" + getName() + \"!\";');\n+    });\n \n-  it('should translate message parts (reversing placeholders)', () => {\n-    const diagnostics = new Diagnostics();\n-    const translations = {\n-      [ɵcomputeMsgId('abc{$PH}def{$PH_1} - Hello, {$PH_2}!')]:\n-          ɵparseTranslation('abc{$PH_2}def{$PH_1} - Hello, {$PH}!'),\n-    };\n-    const input = '$localize([\"abc\", \"def\", \" - Hello, \", \"!\"], 1 + 2 + 3, 4 + 5 + 6, getName());';\n-    const output =\n-        transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, translations)]})!;\n-    expect(output.code)\n-        .toEqual('\"abc\" + getName() + \"def\" + (4 + 5 + 6) + \" - Hello, \" + (1 + 2 + 3) + \"!\";');\n-  });\n+    it('should translate message parts (reversing placeholders)', () => {\n+      const translations = {\n+        [ɵcomputeMsgId('abc{$PH}def{$PH_1} - Hello, {$PH_2}!')]:\n+            ɵparseTranslation('abc{$PH_2}def{$PH_1} - Hello, {$PH}!'),\n+      };\n+      const input =\n+          '$localize([\"abc\", \"def\", \" - Hello, \", \"!\"], 1 + 2 + 3, 4 + 5 + 6, getName());';\n+      const output = transformCode(input, translations);\n+      expect(output).toEqual(\n+          '\"abc\" + getName() + \"def\" + (4 + 5 + 6) + \" - Hello, \" + (1 + 2 + 3) + \"!\";');\n+    });\n \n-  it('should translate message parts (removing placeholders)', () => {\n-    const diagnostics = new Diagnostics();\n-    const translations = {\n-      [ɵcomputeMsgId('abc{$PH}def{$PH_1} - Hello, {$PH_2}!')]:\n-          ɵparseTranslation('abc{$PH} - Hello, {$PH_2}!'),\n-    };\n-    const input = '$localize([\"abc\", \"def\", \" - Hello, \", \"!\"], 1 + 2 + 3, 4 + 5 + 6, getName());';\n-    const output =\n-        transformSync(input, {plugins: [makeEs5TranslatePlugin(diagnostics, translations)]})!;\n-    expect(output.code).toEqual('\"abc\" + (1 + 2 + 3) + \" - Hello, \" + getName() + \"!\";');\n+    it('should translate message parts (removing placeholders)', () => {\n+      const translations = {\n+        [ɵcomputeMsgId('abc{$PH}def{$PH_1} - Hello, {$PH_2}!')]:\n+            ɵparseTranslation('abc{$PH} - Hello, {$PH_2}!'),\n+      };\n+      const input =\n+          '$localize([\"abc\", \"def\", \" - Hello, \", \"!\"], 1 + 2 + 3, 4 + 5 + 6, getName());';\n+      const output = transformCode(input, translations);\n+      expect(output).toEqual('\"abc\" + (1 + 2 + 3) + \" - Hello, \" + getName() + \"!\";');\n+    });\n   });\n });\n+\n+function transformCode(\n+    input: string, translations: Record<string, ɵParsedTranslation> = {},\n+    pluginOptions?: TranslatePluginOptions, diagnostics = new Diagnostics()): string {\n+  return transformSync(input, {\n+           plugins: [makeEs5TranslatePlugin(diagnostics, translations, pluginOptions)],\n+           filename: '/app/dist/test.js'\n+         })!.code!;\n+}"
        }
    ],
    "stats": {
        "total": 937,
        "additions": 447,
        "deletions": 490
    }
}