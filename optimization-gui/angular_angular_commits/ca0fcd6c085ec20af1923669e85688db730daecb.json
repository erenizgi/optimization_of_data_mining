{
    "author": "alan-agius4",
    "message": "ci: only run `publish_snapshot` when not PR (#41877)\n\nCurrently, the non forked PRs such as Renovate will run `publish_snapshot` because `CIRCLE_PR_NUMBER` is not defined for PRs which are opened from non forked repos. Instead we add a filter to only run `publish_snapshot` on releasable branches.\n\nExample of run were the mentioned variable is not defined https://app.circleci.com/pipelines/github/angular/angular/32093/workflows/7c8c4cfc-e6f6-44fc-a6dc-a82a6ac862db/jobs/976611\n\nPR Close #41877",
    "sha": "ca0fcd6c085ec20af1923669e85688db730daecb",
    "files": [
        {
            "sha": "1b6e51fb0b3309cc05c6df7ed820f14c76bd88b4",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 9,
            "deletions": 16,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/ca0fcd6c085ec20af1923669e85688db730daecb/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/ca0fcd6c085ec20af1923669e85688db730daecb/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=ca0fcd6c085ec20af1923669e85688db730daecb",
            "patch": "@@ -66,6 +66,14 @@ var_10: &only_on_master\n       only:\n         - master\n \n+# Filter to run a job on all releasable branches.\n+var_11: &only_release_branches\n+  filters:\n+    branches:\n+      only:\n+        - master\n+        - /\\d+\\.\\d+\\.x/\n+\n # Executor Definitions\n # https://circleci.com/docs/2.0/reusing-config/#authoring-reusable-executors\n # **NOTE 1**: Pin to exact images using an ID (SHA). See https://circleci.com/docs/2.0/circleci-images/#using-a-docker-image-id-to-pin-an-image-to-a-fixed-version.\n@@ -587,18 +595,6 @@ jobs:\n   publish_snapshot:\n     executor: default-executor\n     steps:\n-      # See below - ideally this job should not trigger for non-upstream builds.\n-      # But since it does, we have to check this condition.\n-      - run:\n-          name: Skip this job for Pull Requests and Fork builds\n-          # Note: Using `CIRCLE_*` env variables (instead of those defined in `env.sh` so that this\n-          #       step can be run before `init_environment`.\n-          command: >\n-            if [[ -n \"${CIRCLE_PR_NUMBER}\" ]] ||\n-                [[ \"$CIRCLE_PROJECT_USERNAME\" != \"angular\" ]] ||\n-                [[ \"$CIRCLE_PROJECT_REPONAME\" != \"angular\" ]]; then\n-              circleci step halt\n-            fi\n       - custom_attach_workspace\n       - init_environment\n       # CircleCI has a config setting to force SSH for all github connections\n@@ -854,10 +850,7 @@ workflows:\n           requires:\n             - build-npm-packages\n       - publish_snapshot:\n-          # Note: no filters on this job because we want it to run for all upstream branches\n-          # We'd really like to filter out pull requests here, but not yet available:\n-          # https://discuss.circleci.com/t/workflows-pull-request-filter/14396/4\n-          # Instead, the job just exits immediately at the first step.\n+          <<: *only_release_branches\n           requires:\n             # Only publish if tests and integration tests pass\n             - test"
        },
        {
            "sha": "54c8499e0f3d993a0aa11d8b6ea08f41e16f0fd8",
            "filename": ".github/angular-robot.yml",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/ca0fcd6c085ec20af1923669e85688db730daecb/.github%2Fangular-robot.yml",
            "raw_url": "https://github.com/angular/angular/raw/ca0fcd6c085ec20af1923669e85688db730daecb/.github%2Fangular-robot.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.github%2Fangular-robot.yml?ref=ca0fcd6c085ec20af1923669e85688db730daecb",
            "patch": "@@ -117,7 +117,6 @@ merge:\n     requiredStatuses:\n       - \"ci/circleci: build\"\n       - \"ci/circleci: lint\"\n-      - \"ci/circleci: publish_snapshot\"\n       - \"ci/angular: size\"\n       - \"cla/google\"\n       - \"google3\""
        }
    ],
    "stats": {
        "total": 26,
        "additions": 9,
        "deletions": 17
    }
}