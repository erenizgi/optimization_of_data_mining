{
    "author": "danieltre23",
    "message": "refactor(compiler-cli): add `NullishCoalescingNotNullableCheck` (#43232)\n\nAdd a template check that returns diagnostics if the left side of a\nnullish coalescing operation is not nullable.\n\nRefs #42966\n\nPR Close #43232",
    "sha": "0802b59a7bfb1f30d8fd17307a50926aa44ef1e6",
    "files": [
        {
            "sha": "52aba50642c8e6d7723d911283fefd89a3f112b4",
            "filename": "goldens/public-api/compiler-cli/error_code.md",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.md",
            "raw_url": "https://github.com/angular/angular/raw/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.md?ref=0802b59a7bfb1f30d8fd17307a50926aa44ef1e6",
            "patch": "@@ -45,6 +45,7 @@ export enum ErrorCode {\n     NGMODULE_MODULE_WITH_PROVIDERS_MISSING_GENERIC = 6005,\n     NGMODULE_REEXPORT_NAME_COLLISION = 6006,\n     NGMODULE_VE_DEPENDENCY_ON_IVY_LIB = 6999,\n+    NULLISH_COALESCING_NOT_NULLABLE = 8102,\n     // (undocumented)\n     PARAM_MISSING_TOKEN = 2003,\n     // (undocumented)"
        },
        {
            "sha": "28e3501ed2efd5be29fb0c7995fdb90bbd54b363",
            "filename": "packages/compiler-cli/src/ngtsc/core/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel?ref=0802b59a7bfb1f30d8fd17307a50926aa44ef1e6",
            "patch": "@@ -40,6 +40,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/typecheck/extended\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/extended/api\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/extended/checks/invalid_banana_in_box\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/extended/checks/nullish_coalescing_not_nullable\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"//packages/compiler-cli/src/ngtsc/xi18n\",\n         \"@npm//typescript\","
        },
        {
            "sha": "bb4724e6f0942cb415011f9f85d58b7d7058d207",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=0802b59a7bfb1f30d8fd17307a50926aa44ef1e6",
            "patch": "@@ -31,8 +31,9 @@ import {aliasTransformFactory, CompilationMode, declarationTransformFactory, Dec\n import {TemplateTypeCheckerImpl} from '../../typecheck';\n import {OptimizeFor, TemplateTypeChecker, TypeCheckingConfig} from '../../typecheck/api';\n import {ExtendedTemplateCheckerImpl} from '../../typecheck/extended';\n-import {ExtendedTemplateChecker} from '../../typecheck/extended/api';\n+import {ExtendedTemplateChecker, TemplateCheck} from '../../typecheck/extended/api';\n import {InvalidBananaInBoxCheck} from '../../typecheck/extended/checks/invalid_banana_in_box';\n+import {NullishCoalescingNotNullableCheck} from '../../typecheck/extended/checks/nullish_coalescing_not_nullable';\n import {getSourceFileOrNull, isDtsPath, resolveModuleName, toUnredirectedSourceFile} from '../../util/src/typescript';\n import {Xi18nContext} from '../../xi18n';\n import {LazyRoute, NgCompilerAdapter, NgCompilerOptions} from '../api';\n@@ -1109,7 +1110,10 @@ export class NgCompiler {\n         reflector, this.adapter, this.incrementalCompilation, scopeRegistry, typeCheckScopeRegistry,\n         this.delegatingPerfRecorder);\n \n-    const templateChecks = [new InvalidBananaInBoxCheck()];\n+    const templateChecks: TemplateCheck<ErrorCode>[] = [new InvalidBananaInBoxCheck()];\n+    if (this.options.strictNullChecks) {\n+      templateChecks.push(new NullishCoalescingNotNullableCheck());\n+    }\n     const extendedTemplateChecker =\n         new ExtendedTemplateCheckerImpl(templateTypeChecker, checker, templateChecks);\n "
        },
        {
            "sha": "0adb4704db205fc2a8239ccd47bd2233e170b81a",
            "filename": "packages/compiler-cli/src/ngtsc/diagnostics/src/error_code.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "raw_url": "https://github.com/angular/angular/raw/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts?ref=0802b59a7bfb1f30d8fd17307a50926aa44ef1e6",
            "patch": "@@ -182,6 +182,16 @@ export enum ErrorCode {\n    */\n   INVALID_BANANA_IN_BOX = 8101,\n \n+  /**\n+   * The left side of a nullish coalescing operation is not nullable.\n+   *\n+   * ```\n+   * {{ foo ?? bar }}\n+   * ```\n+   * When the type of foo doesn't include `null` or `undefined`.\n+   */\n+  NULLISH_COALESCING_NOT_NULLABLE = 8102,\n+\n   /**\n    * The template type-checking engine would need to generate an inline type check block for a\n    * component, but the current type-checking environment doesn't support it."
        },
        {
            "sha": "b687a466cff5ece52e513bdb541f36d692cf5f17",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/checks/nullish_coalescing_not_nullable/BUILD.bazel",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2FBUILD.bazel?ref=0802b59a7bfb1f30d8fd17307a50926aa44ef1e6",
            "patch": "@@ -0,0 +1,14 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"nullish_coalescing_not_nullable\",\n+    srcs = [\"index.ts\"],\n+    visibility = [\"//packages/compiler-cli/src/ngtsc:__subpackages__\"],\n+    deps = [\n+        \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/diagnostics\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/extended/api\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "0e7415ab3ad961713539a152d35ab72a8a685455",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/checks/nullish_coalescing_not_nullable/index.ts",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/0802b59a7bfb1f30d8fd17307a50926aa44ef1e6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Fnullish_coalescing_not_nullable%2Findex.ts?ref=0802b59a7bfb1f30d8fd17307a50926aa44ef1e6",
            "patch": "@@ -0,0 +1,51 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {AST, Binary, TmplAstNode} from '@angular/compiler';\n+import * as ts from 'typescript';\n+\n+import {ErrorCode} from '../../../../diagnostics';\n+import {NgTemplateDiagnostic, SymbolKind} from '../../../api';\n+import {TemplateCheckWithVisitor, TemplateContext} from '../../api';\n+\n+/**\n+ * Ensures the left side of a nullish coalescing operation is nullable.\n+ * Returns diagnostics for the cases where the operator is useless.\n+ * This check should only be use if `strictNullChecks` is enabled,\n+ * otherwise it would produce inaccurate results.\n+ */\n+export class NullishCoalescingNotNullableCheck extends\n+    TemplateCheckWithVisitor<ErrorCode.NULLISH_COALESCING_NOT_NULLABLE> {\n+  override code = ErrorCode.NULLISH_COALESCING_NOT_NULLABLE as const;\n+\n+  override visitNode(ctx: TemplateContext, component: ts.ClassDeclaration, node: TmplAstNode|AST):\n+      NgTemplateDiagnostic<ErrorCode.NULLISH_COALESCING_NOT_NULLABLE>[] {\n+    if (!(node instanceof Binary) || node.operation !== '??') return [];\n+\n+    const symbolLeft = ctx.templateTypeChecker.getSymbolOfNode(node.left, component)!;\n+    if (symbolLeft.kind !== SymbolKind.Expression) {\n+      return [];\n+    }\n+    const typeLeft = symbolLeft.tsType;\n+    // If the left operand's type is different from its non-nullable self, then it must\n+    // contain a null or undefined so this nullish coalescing operator is useful. No diagnostic to\n+    // report.\n+    if (typeLeft.getNonNullableType() !== typeLeft) return [];\n+\n+    const symbol = ctx.templateTypeChecker.getSymbolOfNode(node, component)!;\n+    if (symbol.kind !== SymbolKind.Expression) {\n+      return [];\n+    }\n+    const span =\n+        ctx.templateTypeChecker.getTemplateMappingAtShimLocation(symbol.shimLocation)!.span;\n+    const diagnostic = ctx.templateTypeChecker.makeTemplateDiagnostic(\n+        component, span, ts.DiagnosticCategory.Warning, ErrorCode.NULLISH_COALESCING_NOT_NULLABLE,\n+        `The left side of this nullish coalescing operation does not include 'null' or 'undefined' in its type, therefore the '??' operator can be safely removed.`);\n+    return [diagnostic];\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 83,
        "deletions": 2
    }
}