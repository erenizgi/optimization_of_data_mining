{
    "author": "crisbeto",
    "message": "fix(compiler): preserve @page rules in encapsulated styles (#41915)\n\nCurrently the compiler treats `@page` rules in the same way as `@media`, however that is incorrect and it results in invalid CSS, because `@page` allows style declarations at the root (e.g. `@page (margin: 50%) {}`) and it only allows a limited set of at-rules to be nested into it. Given these restrictions, we can't really encapsulate the styles since they apply at the document level when the user tries to print.\n\nThese changes make it so that `@page` rules are preserved so that we don't break the user's CSS.\n\nMore information: https://www.w3.org/TR/css-page-3\n\nFixes #26269.\n\nPR Close #41915",
    "sha": "abcd4bbfaa79969da46aed1aeaf79abe5bb05b50",
    "files": [
        {
            "sha": "0cbf8c8b14af898e193ec4b92d98bac332037d91",
            "filename": "packages/compiler/src/shadow_css.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/abcd4bbfaa79969da46aed1aeaf79abe5bb05b50/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts",
            "raw_url": "https://github.com/angular/angular/raw/abcd4bbfaa79969da46aed1aeaf79abe5bb05b50/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts?ref=abcd4bbfaa79969da46aed1aeaf79abe5bb05b50",
            "patch": "@@ -135,8 +135,6 @@\n export class ShadowCss {\n   strictStyling: boolean = true;\n \n-  constructor() {}\n-\n   /*\n    * Shim some cssText with the given selector. Returns cssText that can\n    * be included in the document via WebComponents.ShadowCSS.addCssToDocument(css).\n@@ -367,15 +365,15 @@ export class ShadowCss {\n     return processRules(cssText, (rule: CssRule) => {\n       let selector = rule.selector;\n       let content = rule.content;\n-      if (rule.selector[0] != '@') {\n+      if (rule.selector[0] !== '@') {\n         selector =\n             this._scopeSelector(rule.selector, scopeSelector, hostSelector, this.strictStyling);\n       } else if (\n           rule.selector.startsWith('@media') || rule.selector.startsWith('@supports') ||\n-          rule.selector.startsWith('@page') || rule.selector.startsWith('@document')) {\n+          rule.selector.startsWith('@document')) {\n         content = this._scopeSelectors(rule.content, scopeSelector, hostSelector);\n-      } else if (rule.selector.startsWith('@font-face')) {\n-        content = this._stripScopingSelectors(rule.content, scopeSelector, hostSelector);\n+      } else if (rule.selector.startsWith('@font-face') || rule.selector.startsWith('@page')) {\n+        content = this._stripScopingSelectors(rule.content);\n       }\n       return new CssRule(selector, content);\n     });\n@@ -396,15 +394,17 @@ export class ShadowCss {\n    * :host ::ng-deep {\n    *   import 'some/lib/containing/font-face';\n    * }\n+   *\n+   * Similar logic applies to `@page` rules which can contain a particular set of properties,\n+   * as well as some specific at-rules. Since they can't be encapsulated, we have to strip\n+   * any scoping selectors from them. For more information: https://www.w3.org/TR/css-page-3\n    * ```\n    */\n-  private _stripScopingSelectors(cssText: string, scopeSelector: string, hostSelector: string):\n-      string {\n+  private _stripScopingSelectors(cssText: string): string {\n     return processRules(cssText, rule => {\n       const selector = rule.selector.replace(_shadowDeepSelectors, ' ')\n                            .replace(_polyfillHostNoCombinatorRe, ' ');\n-      const content = this._scopeSelectors(rule.content, scopeSelector, hostSelector);\n-      return new CssRule(selector, content);\n+      return new CssRule(selector, rule.content);\n     });\n   }\n \n@@ -792,7 +792,7 @@ function combineHostContextSelectors(contextSelectors: string[], otherSelectors:\n  *     in-place.\n  * @param multiples The number of times the current groups should appear.\n  */\n-export function repeatGroups<T>(groups: string[][], multiples: number): void {\n+export function repeatGroups(groups: string[][], multiples: number): void {\n   const length = groups.length;\n   for (let i = 1; i < multiples; i++) {\n     for (let j = 0; j < length; j++) {"
        },
        {
            "sha": "1526da8b51599d9bbbf51abbd738d1619611e521",
            "filename": "packages/compiler/test/ng_module_resolver_spec.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/abcd4bbfaa79969da46aed1aeaf79abe5bb05b50/packages%2Fcompiler%2Ftest%2Fng_module_resolver_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/abcd4bbfaa79969da46aed1aeaf79abe5bb05b50/packages%2Fcompiler%2Ftest%2Fng_module_resolver_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fng_module_resolver_spec.ts?ref=abcd4bbfaa79969da46aed1aeaf79abe5bb05b50",
            "patch": "@@ -7,15 +7,28 @@\n  */\n \n import {NgModuleResolver} from '@angular/compiler/src/ng_module_resolver';\n-import {ɵstringify as stringify} from '@angular/core';\n-import {NgModule} from '@angular/core/src/metadata';\n+import {Component, Directive, Injectable, NgModule, ɵstringify as stringify} from '@angular/core';\n import {JitReflector} from '@angular/platform-browser-dynamic/src/compiler_reflector';\n \n-class SomeClass1 {}\n-class SomeClass2 {}\n-class SomeClass3 {}\n-class SomeClass4 {}\n-class SomeClass5 {}\n+@Directive()\n+class SomeClass1 {\n+}\n+\n+@NgModule()\n+class SomeClass2 {\n+}\n+\n+@NgModule()\n+class SomeClass3 {\n+}\n+\n+@Injectable()\n+class SomeClass4 {\n+}\n+\n+@Component({template: ''})\n+class SomeClass5 {\n+}\n \n @NgModule({\n   declarations: [SomeClass1],"
        },
        {
            "sha": "574815ec5c36c31b7e88127387e28ceeeb762d68",
            "filename": "packages/compiler/test/shadow_css_spec.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 6,
            "changes": 54,
            "blob_url": "https://github.com/angular/angular/blob/abcd4bbfaa79969da46aed1aeaf79abe5bb05b50/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/abcd4bbfaa79969da46aed1aeaf79abe5bb05b50/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts?ref=abcd4bbfaa79969da46aed1aeaf79abe5bb05b50",
            "patch": "@@ -14,8 +14,11 @@ import {normalizeCSS} from '@angular/platform-browser/testing/src/browser_util';\n     function s(css: string, contentAttr: string, hostAttr: string = '') {\n       const shadowCss = new ShadowCss();\n       const shim = shadowCss.shimCssText(css, contentAttr, hostAttr);\n-      const nlRegexp = /\\n/g;\n-      return normalizeCSS(shim.replace(nlRegexp, ''));\n+      return normalize(shim);\n+    }\n+\n+    function normalize(value: string): string {\n+      return normalizeCSS(value.replace(/\\n/g, '')).trim();\n     }\n \n     it('should handle empty string', () => {\n@@ -53,10 +56,49 @@ import {normalizeCSS} from '@angular/platform-browser/testing/src/browser_util';\n       expect(s(css, 'contenta')).toEqual(expected);\n     });\n \n-    it('should handle page rules', () => {\n-      const css = '@page {div {font-size:50px;}}';\n-      const expected = '@page {div[contenta] {font-size:50px;}}';\n-      expect(s(css, 'contenta')).toEqual(expected);\n+    // @page rules use a special set of at-rules and selectors and they can't be scoped.\n+    // See: https://www.w3.org/TR/css-page-3\n+    it('should preserve @page rules', () => {\n+      const contentAttr = 'contenta';\n+      const css = `\n+        @page {\n+          margin-right: 4in;\n+\n+          @top-left {\n+            content: \"Hamlet\";\n+          }\n+\n+          @top-right {\n+            content: \"Page \" counter(page);\n+          }\n+        }\n+\n+        @page main {\n+          margin-left: 4in;\n+        }\n+\n+        @page :left {\n+          margin-left: 3cm;\n+          margin-right: 4cm;\n+        }\n+\n+        @page :right {\n+          margin-left: 4cm;\n+          margin-right: 3cm;\n+        }\n+      `;\n+      const result = s(css, contentAttr);\n+      expect(result).toEqual(normalize(css));\n+      expect(result).not.toContain(contentAttr);\n+    });\n+\n+    it('should strip ::ng-deep and :host from within @page rules', () => {\n+      expect(s('@page { margin-right: 4in; }', 'contenta', 'h'))\n+          .toEqual('@page { margin-right:4in;}');\n+      expect(s('@page { ::ng-deep @top-left { content: \"Hamlet\";}}', 'contenta', 'h'))\n+          .toEqual('@page { @top-left { content:\"Hamlet\";}}');\n+      expect(s('@page { :host ::ng-deep @top-left { content:\"Hamlet\";}}', 'contenta', 'h'))\n+          .toEqual('@page { @top-left { content:\"Hamlet\";}}');\n     });\n \n     it('should handle document rules', () => {"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 79,
        "deletions": 24
    }
}