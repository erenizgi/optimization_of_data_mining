{
    "author": "JoostK",
    "message": "perf(core): do not recurse into modules that have already been registered (#39514)\n\nWhen registering an NgModule based on its id, all transitively imported\nNgModules are also registered. This commit introduces a visited set to\navoid traversing into NgModules that are reachable from multiple import\npaths multiple times.\n\nFixes #39487\n\nPR Close #39514",
    "sha": "8317042483c52b9b5035c49d76fecc4b43a23090",
    "files": [
        {
            "sha": "b47e635778c810802d26ce74043612d597294f76",
            "filename": "packages/core/src/linker/ng_module_factory_registration.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 14,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/8317042483c52b9b5035c49d76fecc4b43a23090/packages%2Fcore%2Fsrc%2Flinker%2Fng_module_factory_registration.ts",
            "raw_url": "https://github.com/angular/angular/raw/8317042483c52b9b5035c49d76fecc4b43a23090/packages%2Fcore%2Fsrc%2Flinker%2Fng_module_factory_registration.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Fng_module_factory_registration.ts?ref=8317042483c52b9b5035c49d76fecc4b43a23090",
            "patch": "@@ -8,8 +8,9 @@\n \n \n import {Type} from '../interface/type';\n-import {autoRegisterModuleById} from '../render3/definition';\n+import {autoRegisterModuleById, getNgModuleDef} from '../render3/definition';\n import {NgModuleType} from '../render3/ng_module_ref';\n+import {maybeUnwrapFn} from '../render3/util/misc_utils';\n import {stringify} from '../util/stringify';\n \n import {NgModuleFactory} from './ng_module_factory';\n@@ -39,20 +40,27 @@ function assertSameOrNotExisting(id: string, type: Type<any>|null, incoming: Typ\n   }\n }\n \n-export function registerNgModuleType(ngModuleType: NgModuleType) {\n-  if (ngModuleType.ɵmod.id !== null) {\n-    const id = ngModuleType.ɵmod.id;\n-    const existing = modules.get(id) as NgModuleType | null;\n-    assertSameOrNotExisting(id, existing, ngModuleType);\n-    modules.set(id, ngModuleType);\n-  }\n+export function registerNgModuleType(ngModuleType: NgModuleType): void {\n+  const visited = new Set<NgModuleType>();\n+  recurse(ngModuleType);\n+  function recurse(ngModuleType: NgModuleType): void {\n+    // The imports array of an NgModule must refer to other NgModules,\n+    // so an error is thrown if no module definition is available.\n+    const def = getNgModuleDef(ngModuleType, /* throwNotFound */ true);\n+    const id = def.id;\n+    if (id !== null) {\n+      const existing = modules.get(id) as NgModuleType | null;\n+      assertSameOrNotExisting(id, existing, ngModuleType);\n+      modules.set(id, ngModuleType);\n+    }\n \n-  let imports = ngModuleType.ɵmod.imports;\n-  if (imports instanceof Function) {\n-    imports = imports();\n-  }\n-  if (imports) {\n-    imports.forEach(i => registerNgModuleType(i as NgModuleType));\n+    const imports = maybeUnwrapFn(def.imports) as NgModuleType[];\n+    for (const i of imports) {\n+      if (!visited.has(i)) {\n+        visited.add(i);\n+        recurse(i);\n+      }\n+    }\n   }\n }\n "
        },
        {
            "sha": "5d2f6f5077975de0ee575210dcb3b5767f39e628",
            "filename": "packages/core/test/render3/providers_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/8317042483c52b9b5035c49d76fecc4b43a23090/packages%2Fcore%2Ftest%2Frender3%2Fproviders_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8317042483c52b9b5035c49d76fecc4b43a23090/packages%2Fcore%2Ftest%2Frender3%2Fproviders_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fproviders_spec.ts?ref=8317042483c52b9b5035c49d76fecc4b43a23090",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Component as _Component, ComponentFactoryResolver, ElementRef, Injectable as _Injectable, InjectFlags, InjectionToken, InjectorType, Provider, RendererFactory2, Type, ViewContainerRef, ɵNgModuleDef as NgModuleDef, ɵɵdefineInjectable, ɵɵdefineInjector, ɵɵinject} from '../../src/core';\n+import {Component as _Component, ComponentFactoryResolver, ElementRef, Injectable as _Injectable, InjectFlags, InjectionToken, InjectorType, Provider, RendererFactory2, Type, ViewContainerRef, ɵɵdefineInjectable, ɵɵdefineInjector, ɵɵdefineNgModule, ɵɵinject} from '../../src/core';\n import {forwardRef} from '../../src/di/forward_ref';\n import {createInjector} from '../../src/di/r3_injector';\n import {injectComponentFactoryResolver, ɵɵdefineComponent, ɵɵdefineDirective, ɵɵdirectiveInject, ɵɵelement, ɵɵelementEnd, ɵɵelementStart, ɵɵgetInheritedFactory, ɵɵProvidersFeature, ɵɵtext, ɵɵtextInterpolate1} from '../../src/render3/index';\n@@ -1092,7 +1092,7 @@ describe('providers', () => {\n                    {provide: String, useValue: 'From module injector'}\n                  ]\n            });\n-           static ɵmod: NgModuleDef<any> = {bootstrap: []} as any;\n+           static ɵmod = ɵɵdefineNgModule({type: MyAppModule});\n          }\n          const myAppModuleFactory = new NgModuleFactory(MyAppModule);\n          const ngModuleRef = myAppModuleFactory.create(null);"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 24,
        "deletions": 16
    }
}