{
    "author": "alxhub",
    "message": "test(language-service): update compiler_spec to use the new testing env (#40679)\n\nThis commit updates compiler_spec.ts in the Ivy LS suite to utilize the new\ntesting environment which was introduced in the previous commit. Eventually\nall specs should be converted, but converting one right now helps ensure\nthat the new testing env is working properly and able to support real tests.\n\nPR Close #40679",
    "sha": "53c65f468f6f7270a00b2b606a4a41e91be8a0c2",
    "files": [
        {
            "sha": "2ffce0d65a599333e1ff45bb7cd09532c1d016cc",
            "filename": "packages/language-service/ivy/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/53c65f468f6f7270a00b2b606a4a41e91be8a0c2/packages%2Flanguage-service%2Fivy%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/53c65f468f6f7270a00b2b606a4a41e91be8a0c2/packages%2Flanguage-service%2Fivy%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2FBUILD.bazel?ref=53c65f468f6f7270a00b2b606a4a41e91be8a0c2",
            "patch": "@@ -12,6 +12,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/testing\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/language-service/ivy\",\n+        \"//packages/language-service/ivy/testing\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "4838441e0cb743896df6238ac4fbaa5bd1647cb9",
            "filename": "packages/language-service/ivy/test/compiler_spec.ts",
            "status": "modified",
            "additions": 80,
            "deletions": 121,
            "changes": 201,
            "blob_url": "https://github.com/angular/angular/blob/53c65f468f6f7270a00b2b606a4a41e91be8a0c2/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/53c65f468f6f7270a00b2b606a4a41e91be8a0c2/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts?ref=53c65f468f6f7270a00b2b606a4a41e91be8a0c2",
            "patch": "@@ -6,10 +6,10 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom, getSourceFileOrError} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n-import {OptimizeFor} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n \n+import {isNgSpecificDiagnostic, LanguageServiceTestEnv} from '../testing';\n import {LanguageServiceTestEnvironment} from './env';\n \n describe('language-service/compiler integration', () => {\n@@ -50,66 +50,43 @@ describe('language-service/compiler integration', () => {\n   });\n \n   it('should not produce errors from inline test declarations mixing with those of the app', () => {\n-    const appCmpFile = absoluteFrom('/test.cmp.ts');\n-    const appModuleFile = absoluteFrom('/test.mod.ts');\n-    const testFile = absoluteFrom('/test_spec.ts');\n-\n-    const env = LanguageServiceTestEnvironment.setup([\n-      {\n-        name: appCmpFile,\n-        contents: `\n-          import {Component} from '@angular/core';\n-\n-          @Component({\n-            selector: 'app-cmp',\n-            template: 'Some template',\n-          })\n-          export class AppCmp {}\n-        `,\n-        isRoot: true,\n-      },\n-      {\n-        name: appModuleFile,\n-        contents: `\n-          import {NgModule} from '@angular/core';\n-          import {AppCmp} from './test.cmp';\n-\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = env.addProject('test', {\n+      'cmp.ts': `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          selector: 'app-cmp',\n+          template: 'Some template',\n+        })\n+        export class AppCmp {}\n+      `,\n+      'mod.ts': `\n+        import {NgModule} from '@angular/core';\n+        import {AppCmp} from './cmp';\n+\n+        @NgModule({\n+          declarations: [AppCmp],\n+        })\n+        export class AppModule {}\n+      `,\n+      'test_spec.ts': `\n+        import {NgModule} from '@angular/core';\n+        import {AppCmp} from './cmp';\n+\n+        export function test(): void {\n           @NgModule({\n             declarations: [AppCmp],\n           })\n-          export class AppModule {}\n-        `,\n-        isRoot: true,\n-      },\n-      {\n-        name: testFile,\n-        contents: `\n-          import {NgModule} from '@angular/core';\n-          import {AppCmp} from './test.cmp';\n-\n-          export function test(): void {\n-            @NgModule({\n-              declarations: [AppCmp],\n-            })\n-            class TestModule {}\n-          }\n-        `,\n-        isRoot: true,\n-      }\n-    ]);\n+          class TestModule {}\n+        }\n+      `,\n+    });\n \n     // Expect that this program is clean diagnostically.\n-    const ngCompiler = env.ngLS.compilerFactory.getOrCreate();\n-    const program = ngCompiler.getNextProgram();\n-    expect(ngCompiler.getDiagnosticsForFile(\n-               getSourceFileOrError(program, appCmpFile), OptimizeFor.WholeProgram))\n-        .toEqual([]);\n-    expect(ngCompiler.getDiagnosticsForFile(\n-               getSourceFileOrError(program, appModuleFile), OptimizeFor.WholeProgram))\n-        .toEqual([]);\n-    expect(ngCompiler.getDiagnosticsForFile(\n-               getSourceFileOrError(program, testFile), OptimizeFor.WholeProgram))\n-        .toEqual([]);\n+    expect(project.getDiagnosticsForFile('cmp.ts')).toEqual([]);\n+    expect(project.getDiagnosticsForFile('mod.ts')).toEqual([]);\n+    expect(project.getDiagnosticsForFile('test_spec.ts')).toEqual([]);\n   });\n \n   it('should show type-checking errors from components with poisoned scopes', () => {\n@@ -122,39 +99,36 @@ describe('language-service/compiler integration', () => {\n     // that a component declared in an NgModule with a faulty import still generates template\n     // diagnostics.\n \n-    const file = absoluteFrom('/test.ts');\n-    const env = LanguageServiceTestEnvironment.setup([{\n-      name: file,\n-      contents: `\n-          import {Component, Directive, Input, NgModule} from '@angular/core';\n-\n-          @Component({\n-            selector: 'test-cmp',\n-            template: '<div [dir]=\"3\"></div>',\n-          })\n-          export class Cmp {}\n-\n-          @Directive({\n-            selector: '[dir]',\n-          })\n-          export class Dir {\n-            @Input() dir!: string;\n-          }\n-\n-          export class NotAModule {}\n-\n-          @NgModule({\n-            declarations: [Cmp, Dir],\n-            imports: [NotAModule],\n-          })\n-          export class Mod {}\n-        `,\n-      isRoot: true,\n-    }]);\n-\n-    const diags = env.ngLS.getSemanticDiagnostics(file);\n-    expect(diags.map(diag => diag.messageText))\n-        .toContain(`Type 'number' is not assignable to type 'string'.`);\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = env.addProject('test', {\n+      'test.ts': `\n+        import {Component, Directive, Input, NgModule} from '@angular/core';\n+\n+        @Component({\n+          selector: 'test-cmp',\n+          template: '<div [dir]=\"3\"></div>',\n+        })\n+        export class Cmp {}\n+\n+        @Directive({\n+          selector: '[dir]',\n+        })\n+        export class Dir {\n+          @Input() dir!: string;\n+        }\n+\n+        export class NotAModule {}\n+\n+        @NgModule({\n+          declarations: [Cmp, Dir],\n+          imports: [NotAModule],\n+        })\n+        export class Mod {}\n+      `,\n+    });\n+\n+    const diags = project.getDiagnosticsForFile('test.ts').map(diag => diag.messageText);\n+    expect(diags).toContain(`Type 'number' is not assignable to type 'string'.`);\n   });\n \n   it('should handle broken imports during incremental build steps', () => {\n@@ -174,9 +148,6 @@ describe('language-service/compiler integration', () => {\n     // build step is performed. The compiler should recognize that the module's previous analysis\n     // is stale, even though it was not able to fully understand the import during the first pass.\n \n-    const moduleFile = absoluteFrom('/mod.ts');\n-    const componentFile = absoluteFrom('/cmp.ts');\n-\n     const componentSource = (isExported: boolean): string => `\n       import {Component} from '@angular/core';\n \n@@ -187,43 +158,31 @@ describe('language-service/compiler integration', () => {\n       ${isExported ? 'export' : ''} class Cmp {}\n     `;\n \n-    const env = LanguageServiceTestEnvironment.setup([\n-      {\n-        name: moduleFile,\n-        contents: `\n-          import {NgModule} from '@angular/core';\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = env.addProject('test', {\n+      'mod.ts': `\n+        import {NgModule} from '@angular/core';\n \n-          import {Cmp} from './cmp';\n+        import {Cmp} from './cmp';\n \n-          @NgModule({\n-            declarations: [Cmp],\n-          })\n-          export class Mod {}\n-        `,\n-        isRoot: true,\n-      },\n-      {\n-        name: componentFile,\n-        contents: componentSource(/* start with component not exported */ false),\n-        isRoot: true,\n-      }\n-    ]);\n+        @NgModule({\n+          declarations: [Cmp],\n+        })\n+        export class Mod {}\n+      `,\n+      'cmp.ts': componentSource(/* start with component not exported */ false),\n+    });\n \n     // Angular should be complaining about the module not being understandable.\n-    const programBefore = env.tsLS.getProgram()!;\n-    const moduleSfBefore = programBefore.getSourceFile(moduleFile)!;\n-    const ngDiagsBefore = env.ngLS.compilerFactory.getOrCreate().getDiagnosticsForFile(\n-        moduleSfBefore, OptimizeFor.SingleFile);\n+    const ngDiagsBefore = project.getDiagnosticsForFile('mod.ts').filter(isNgSpecificDiagnostic);\n     expect(ngDiagsBefore.length).toBe(1);\n \n     // Fix the import.\n-    env.updateFile(componentFile, componentSource(/* properly export the component */ true));\n+    const file = project.openFile('cmp.ts');\n+    file.contents = componentSource(/* properly export the component */ true);\n \n     // Angular should stop complaining about the NgModule.\n-    const programAfter = env.tsLS.getProgram()!;\n-    const moduleSfAfter = programAfter.getSourceFile(moduleFile)!;\n-    const ngDiagsAfter = env.ngLS.compilerFactory.getOrCreate().getDiagnosticsForFile(\n-        moduleSfAfter, OptimizeFor.SingleFile);\n+    const ngDiagsAfter = project.getDiagnosticsForFile('mod.ts').filter(isNgSpecificDiagnostic);\n     expect(ngDiagsAfter.length).toBe(0);\n   });\n });"
        },
        {
            "sha": "442ee374fcb4170a6e6d5314baf901432d991071",
            "filename": "packages/language-service/ivy/testing/src/buffer.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/53c65f468f6f7270a00b2b606a4a41e91be8a0c2/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "raw_url": "https://github.com/angular/angular/raw/53c65f468f6f7270a00b2b606a4a41e91be8a0c2/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts?ref=53c65f468f6f7270a00b2b606a4a41e91be8a0c2",
            "patch": "@@ -7,8 +7,8 @@\n  */\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n+import {LanguageService} from '../../language_service';\n \n-import {Project} from './project';\n import {extractCursorInfo} from './util';\n \n /**\n@@ -18,7 +18,7 @@ export class OpenBuffer {\n   private _cursor: number = 0;\n \n   constructor(\n-      private project: Project, private projectFileName: string,\n+      private ngLS: LanguageService, private projectFileName: string,\n       private scriptInfo: ts.server.ScriptInfo) {}\n \n   get cursor(): number {\n@@ -49,7 +49,10 @@ export class OpenBuffer {\n     const {text: snippet, cursor} = extractCursorInfo(snippetWithCursor);\n     const snippetIndex = this.contents.indexOf(snippet);\n     if (snippetIndex === -1) {\n-      throw new Error(`Snippet ${snippet} not found in ${this.projectFileName}`);\n+      throw new Error(`Snippet '${snippet}' not found in ${this.projectFileName}`);\n+    }\n+    if (this.contents.indexOf(snippet, snippetIndex + 1) !== -1) {\n+      throw new Error(`Snippet '${snippet}' is not unique within ${this.projectFileName}`);\n     }\n     this._cursor = snippetIndex + cursor;\n   }\n@@ -59,6 +62,6 @@ export class OpenBuffer {\n    * location in this buffer.\n    */\n   getDefinitionAndBoundSpan(): ts.DefinitionInfoAndBoundSpan|undefined {\n-    return this.project.ngLS.getDefinitionAndBoundSpan(this.scriptInfo.fileName, this._cursor);\n+    return this.ngLS.getDefinitionAndBoundSpan(this.scriptInfo.fileName, this._cursor);\n   }\n }"
        },
        {
            "sha": "e080c280ca70bc4de4ef7d6aec82eca54524c91a",
            "filename": "packages/language-service/ivy/testing/src/project.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/53c65f468f6f7270a00b2b606a4a41e91be8a0c2/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "raw_url": "https://github.com/angular/angular/raw/53c65f468f6f7270a00b2b606a4a41e91be8a0c2/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts?ref=53c65f468f6f7270a00b2b606a4a41e91be8a0c2",
            "patch": "@@ -50,15 +50,15 @@ export class Project {\n   readonly ngLS: LanguageService;\n   private buffers = new Map<string, OpenBuffer>();\n \n-  static initialize(name: string, projectService: ts.server.ProjectService, files: ProjectFiles):\n-      Project {\n+  static initialize(\n+      projectName: string, projectService: ts.server.ProjectService, files: ProjectFiles): Project {\n     const fs = getFileSystem();\n-    const tsConfigPath = absoluteFrom(`/${name}/tsconfig.json`);\n+    const tsConfigPath = absoluteFrom(`/${projectName}/tsconfig.json`);\n \n     const entryFiles: AbsoluteFsPath[] = [];\n     for (const projectFilePath of Object.keys(files)) {\n       const contents = files[projectFilePath];\n-      const filePath = absoluteFrom(`/${name}/${projectFilePath}`);\n+      const filePath = absoluteFrom(`/${projectName}/${projectFilePath}`);\n       const dirPath = fs.dirname(filePath);\n       fs.ensureDir(dirPath);\n       fs.writeFile(filePath, contents);\n@@ -73,7 +73,7 @@ export class Project {\n     projectService.openClientFile(entryFiles[0]);\n     projectService.closeClientFile(entryFiles[0]);\n \n-    return new Project(name, projectService, tsConfigPath);\n+    return new Project(projectName, projectService, tsConfigPath);\n   }\n \n   constructor(\n@@ -102,7 +102,7 @@ export class Project {\n         throw new Error(\n             `Unable to open ScriptInfo for ${projectFileName} in project ${this.tsConfigPath}`);\n       }\n-      this.buffers.set(projectFileName, new OpenBuffer(this, projectFileName, scriptInfo));\n+      this.buffers.set(projectFileName, new OpenBuffer(this.ngLS, projectFileName, scriptInfo));\n     }\n \n     return this.buffers.get(projectFileName)!;"
        },
        {
            "sha": "8b1bd99cd246457e10e8bffaaab6aa9ab2d9fdf0",
            "filename": "packages/language-service/ivy/testing/src/util.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/53c65f468f6f7270a00b2b606a4a41e91be8a0c2/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/53c65f468f6f7270a00b2b606a4a41e91be8a0c2/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts?ref=53c65f468f6f7270a00b2b606a4a41e91be8a0c2",
            "patch": "@@ -23,6 +23,9 @@ export function extractCursorInfo(textWithCursor: string): {cursor: number, text\n }\n \n function last<T>(array: T[]): T {\n+  if (array.length === 0) {\n+    throw new Error(`last() called on empty array`);\n+  }\n   return array[array.length - 1];\n }\n "
        }
    ],
    "stats": {
        "total": 228,
        "additions": 97,
        "deletions": 131
    }
}