{
    "author": "ivanwonder",
    "message": "fix(language-service): exclude the `SafePropertyRead` when applying the optional chaining (#43321)\n\nWhen providing the completion for `SafePropertyRead`, the ts server\nwill not apply the optional chaining. So no need to shift the start\nlocation of `replacementSpan` back.\n\nPR Close #43321",
    "sha": "fc3b50e4275c84a1cd3f75e4b52ee2dc4b65c35c",
    "files": [
        {
            "sha": "44e50f9f468f07b10bf88cb3f39637414d53bedc",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/fc3b50e4275c84a1cd3f75e4b52ee2dc4b65c35c/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/fc3b50e4275c84a1cd3f75e4b52ee2dc4b65c35c/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=fc3b50e4275c84a1cd3f75e4b52ee2dc4b65c35c",
            "patch": "@@ -212,7 +212,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       const replacementSpan = makeReplacementSpanFromAst(this.node);\n \n       if (!(this.node.receiver instanceof ImplicitReceiver) &&\n-          options?.includeCompletionsWithInsertText &&\n+          !(this.node instanceof SafePropertyRead) && options?.includeCompletionsWithInsertText &&\n           options.includeAutomaticOptionalChainCompletions !== false) {\n         const symbol = this.templateTypeChecker.getSymbolOfNode(this.node.receiver, this.component);\n         if (symbol?.kind === SymbolKind.Expression) {"
        },
        {
            "sha": "8c8f677c594118eba4cb6aee277c46b49140a554",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/fc3b50e4275c84a1cd3f75e4b52ee2dc4b65c35c/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/fc3b50e4275c84a1cd3f75e4b52ee2dc4b65c35c/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=fc3b50e4275c84a1cd3f75e4b52ee2dc4b65c35c",
            "patch": "@@ -841,6 +841,17 @@ describe('completions', () => {\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title']);\n       expectReplacementText(completions, templateFile.contents, 'title');\n     });\n+\n+    it('should not shift the start location when the user has input the optional chaining', () => {\n+      const {templateFile} = setup('{{article?.title}}', `article?: { title: string };`);\n+      templateFile.moveCursorToText('{{article?.titleÂ¦}}');\n+      const completions = templateFile.getCompletionsAtPosition({\n+        includeCompletionsWithInsertText: true,\n+        includeAutomaticOptionalChainCompletions: true,\n+      });\n+      expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title']);\n+      expectReplacementText(completions, templateFile.contents, 'title');\n+    });\n   });\n });\n "
        }
    ],
    "stats": {
        "total": 13,
        "additions": 12,
        "deletions": 1
    }
}