{
    "author": "gkalpak",
    "message": "fix(docs-infra): apply custom `autoLinkCode` filters to single-word `<code>` elements (#41709)\n\nPreviously, the `autoLinkCode` Dgeni post-processor would not apply the\ncustom filters when matching the whole contents of a `<code>` element.\nThis meant that custom filters would not be applied to single-word\n`<code>` elements.\n\nYou can see occurrences of this issue in the following sections of the\n\"Reactive forms\" guide:\n- [Creating nested form groups][1]\n  (look for `street, city, state, and zip controls`)\n- [Using the FormBuilder service to generate controls][2]\n  (look for `group method`)\n\nThis commit fixes this by also applying the custom filters when\nprocessing the whole contents of a `<code>` element.\n\nThis commit also updates the `filterPipes` custom filter to allow\nmatching a pipe's name in a single-word `<code>` element (where there is\nno preceeding `|` character).\n\n[1]: https://v10.angular.io/guide/reactive-forms#creating-nested-form-groups\n[2]: https://v10.angular.io/guide/reactive-forms#using-the-formbuilder-service-to-generate-controls\n\nPR Close #41709",
    "sha": "a938849148660f2353aa27c64138f59ef122f95f",
    "files": [
        {
            "sha": "c0a370c2940e471d7bf17695133a174d09ee79d2",
            "filename": "aio/tools/transforms/angular-base-package/post-processors/auto-link-code.js",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/a938849148660f2353aa27c64138f59ef122f95f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.js",
            "raw_url": "https://github.com/angular/angular/raw/a938849148660f2353aa27c64138f59ef122f95f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.js?ref=a938849148660f2353aa27c64138f59ef122f95f",
            "patch": "@@ -55,7 +55,7 @@ module.exports = function autoLinkCode(getDocFromAlias) {\n           const index = parent.children.indexOf(node);\n \n           // Can we convert the whole text node into a doc link?\n-          const docs = getDocFromAlias(node.value);\n+          const docs = getFilteredDocsFromAlias([node.value], 0);\n           if (foundValidDoc(docs, node.value, file)) {\n             parent.children.splice(index, 1, createLinkNode(docs[0], node.value));\n           } else {\n@@ -89,14 +89,18 @@ module.exports = function autoLinkCode(getDocFromAlias) {\n     return ancestors.some(ancestor => is(ancestor, 'a'));\n   }\n \n+  function getFilteredDocsFromAlias(words, index) {\n+    // Remove docs that fail the custom filter tests.\n+    return autoLinkCodeImpl.customFilters.reduce(\n+        (docs, filter) => filter(docs, words, index), getDocFromAlias(words[index]));\n+  }\n+\n   function getNodes(node, file) {\n     return textContent(node)\n         .split(/([A-Za-z0-9_.-]+)/)\n         .filter(word => word.length)\n         .map((word, index, words) => {\n-          // remove docs that fail the custom filter tests\n-          const filteredDocs = autoLinkCodeImpl.customFilters.reduce(\n-              (docs, filter) => filter(docs, words, index), getDocFromAlias(word));\n+          const filteredDocs = getFilteredDocsFromAlias(words, index);\n \n           return foundValidDoc(filteredDocs, word, file) ?\n               // Create a link wrapping the text node."
        },
        {
            "sha": "f90572265c3be107c5f4913b3c03dc480925d9e5",
            "filename": "aio/tools/transforms/angular-base-package/post-processors/auto-link-code.spec.js",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/a938849148660f2353aa27c64138f59ef122f95f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/a938849148660f2353aa27c64138f59ef122f95f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.spec.js?ref=a938849148660f2353aa27c64138f59ef122f95f",
            "patch": "@@ -89,7 +89,7 @@ describe('autoLinkCode post-processor', () => {\n        expect(doc.renderedContent).toEqual('<code>xyz-MyClass</code>');\n      });\n \n-  it('should ignore code items that are filtered out by custom filters', () => {\n+  it('should ignore code items that are filtered out by custom filters (multiple words)', () => {\n     autoLinkCode.customFilters = [filterPipes];\n     aliasMap.addDoc({\n       docType: 'pipe',\n@@ -115,6 +115,27 @@ describe('autoLinkCode post-processor', () => {\n             '</code>');\n   });\n \n+  it('should ignore code items that are filtered out by custom filters (single word)', () => {\n+    const filterAnchors = (docs, words, index) => (words[index].toLowerCase() === 'a') ? [] : docs;\n+    autoLinkCode.customFilters = [filterAnchors];\n+    autoLinkCode.docTypes = ['directive'];\n+\n+    aliasMap.addDoc({\n+      docType: 'directive',\n+      id: 'MyAnchorDirective',\n+      aliases: ['MyAnchorDirective', 'a'],\n+      path: 'a/b/my-anchor-directive',\n+    });\n+    const doc = {\n+      docType: 'test-doc',\n+      renderedContent: '<code>a</code>',\n+    };\n+\n+    processor.$process([doc]);\n+\n+    expect(doc.renderedContent).toBe('<code>a</code>');\n+  });\n+\n   it('should ignore generated nodes', () => {\n     const filterAnchors = (docs, words, index) => (words[index].toLowerCase() === 'a') ? [] : docs;\n     autoLinkCode.customFilters = [filterAnchors];"
        },
        {
            "sha": "3f3b6b738e5c31851a06e46f1a1900cf6468362a",
            "filename": "aio/tools/transforms/angular-base-package/services/auto-link-filters/filterPipes.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/a938849148660f2353aa27c64138f59ef122f95f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fservices%2Fauto-link-filters%2FfilterPipes.js",
            "raw_url": "https://github.com/angular/angular/raw/a938849148660f2353aa27c64138f59ef122f95f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fservices%2Fauto-link-filters%2FfilterPipes.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fservices%2Fauto-link-filters%2FfilterPipes.js?ref=a938849148660f2353aa27c64138f59ef122f95f",
            "patch": "@@ -8,5 +8,6 @@ module.exports = function filterPipes() {\n     docs.filter(doc =>\n       doc.docType !== 'pipe' ||\n       doc.pipeOptions.name !== '\\'' + words[index] + '\\'' ||\n-      index > 0 && words[index - 1].trim() === '|');\n+      index === 0 ||\n+      words[index - 1].trim() === '|');\n };"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 32,
        "deletions": 6
    }
}