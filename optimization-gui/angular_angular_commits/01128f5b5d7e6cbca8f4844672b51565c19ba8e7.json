{
    "author": "gkalpak",
    "message": "fix(service-worker): ensure caches are cleaned up when failing to load state (#42622)\n\nPreviously, obsolete caches were only cleaned up when successfully\nloading the stored state. When the state failed to be loaded, cleaning\nup the caches would be skipped until the next SW initialization.\n\nThis commit changes this, ensuring that the caches are cleaned up\nregardless if the stored state was loaded successfully or not.\n\nPR Close #42622",
    "sha": "01128f5b5d7e6cbca8f4844672b51565c19ba8e7",
    "files": [
        {
            "sha": "ea3f0798abb052e6eefc8ed621114c516aa2ea01",
            "filename": "packages/service-worker/worker/src/driver.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/01128f5b5d7e6cbca8f4844672b51565c19ba8e7/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "raw_url": "https://github.com/angular/angular/raw/01128f5b5d7e6cbca8f4844672b51565c19ba8e7/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts?ref=01128f5b5d7e6cbca8f4844672b51565c19ba8e7",
            "patch": "@@ -542,14 +542,8 @@ export class Driver implements Debuggable, UpdateSource {\n \n       // Successfully loaded from saved state. This implies a manifest exists, so\n       // the update check needs to happen in the background.\n-      this.idle.schedule('init post-load (update, cleanup)', async () => {\n+      this.idle.schedule('init post-load (update)', async () => {\n         await this.checkForUpdate();\n-        try {\n-          await this.cleanupCaches();\n-        } catch (err) {\n-          // Nothing to do - cleanup failed. Just log it.\n-          this.debugger.log(err, 'cleanupCaches @ init post-load');\n-        }\n       });\n     } catch (_) {\n       // Something went wrong. Try to start over by fetching a new manifest from the\n@@ -572,6 +566,16 @@ export class Driver implements Debuggable, UpdateSource {\n     // with a new copy of the manifest has been produced. At this point, the `Driver`\n     // can have its internals hydrated from the state.\n \n+    // Schedule cleaning up obsolete caches in the background.\n+    this.idle.schedule('init post-load (cleanup)', async () => {\n+      try {\n+        await this.cleanupCaches();\n+      } catch (err) {\n+        // Nothing to do - cleanup failed. Just log it.\n+        this.debugger.log(err, 'cleanupCaches @ init post-load');\n+      }\n+    });\n+\n     // Initialize the `versions` map by setting each hash to a new `AppVersion` instance\n     // for that manifest.\n     Object.keys(manifests).forEach((hash: ManifestHash) => {"
        },
        {
            "sha": "7e15572fc8eb8042744ef15e944033c385d17ac0",
            "filename": "packages/service-worker/worker/test/happy_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/01128f5b5d7e6cbca8f4844672b51565c19ba8e7/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/01128f5b5d7e6cbca8f4844672b51565c19ba8e7/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts?ref=01128f5b5d7e6cbca8f4844672b51565c19ba8e7",
            "patch": "@@ -402,7 +402,8 @@ describe('Driver', () => {\n     expect(driver['latestHash']).toBeNull();\n \n     // Pushing a message initializes the driver (fetches assets).\n-    await scope.handleMessage({action: 'foo'}, 'someClient');\n+    scope.handleMessage({action: 'foo'}, 'someClient');\n+    await new Promise(resolve => setTimeout(resolve));  // Wait for async operations to complete.\n     expect(driver['latestHash']).toEqual(jasmine.any(String));\n     server.assertSawRequestFor('/ngsw.json');\n     server.assertSawRequestFor('/foo.txt');"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 13,
        "deletions": 8
    }
}