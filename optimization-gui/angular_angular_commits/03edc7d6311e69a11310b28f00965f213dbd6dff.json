{
    "author": "JoostK",
    "message": "test(compiler-cli): properly support symlinks in `MockFileSystem` (#44587)\n\nThis commit fixes an issue with symlink handling in `MockFileSystem`,\nwhere entries within a symlink would fail to resolve.\n\nPR Close #44587",
    "sha": "03edc7d6311e69a11310b28f00965f213dbd6dff",
    "files": [
        {
            "sha": "3193d4aad3cfb45da0038c2ced122d04673db6b7",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/testing/src/mock_file_system.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/03edc7d6311e69a11310b28f00965f213dbd6dff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Fsrc%2Fmock_file_system.ts",
            "raw_url": "https://github.com/angular/angular/raw/03edc7d6311e69a11310b28f00965f213dbd6dff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Fsrc%2Fmock_file_system.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Fsrc%2Fmock_file_system.ts?ref=03edc7d6311e69a11310b28f00965f213dbd6dff",
            "patch": "@@ -284,9 +284,18 @@ export abstract class MockFileSystem implements FileSystem {\n       if (current === undefined) {\n         return {path, entity: null};\n       }\n-      if (segments.length > 0 && (!isFolder(current))) {\n-        current = null;\n-        break;\n+      if (segments.length > 0) {\n+        if (isFile(current)) {\n+          // Reaching a file when there's still remaining segments means that the requested path\n+          // does not actually exist.\n+          current = null;\n+          break;\n+        }\n+        if (isSymLink(current)) {\n+          // Intermediate directories that are themselves symlinks should always be followed\n+          // regardless of `followSymLinks`, as otherwise the remaining segments would not be found.\n+          return this.findFromPath(resolve(current.path, ...segments), {followSymLinks});\n+        }\n       }\n       if (isFile(current)) {\n         break;"
        },
        {
            "sha": "0de7deb0d382bc39813187a3d9cfc3afd2ceec9d",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/testing/test/BUILD.bazel",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/03edc7d6311e69a11310b28f00965f213dbd6dff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/03edc7d6311e69a11310b28f00965f213dbd6dff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Ftest%2FBUILD.bazel?ref=03edc7d6311e69a11310b28f00965f213dbd6dff",
            "patch": "@@ -0,0 +1,23 @@\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"ts_library\")\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+ts_library(\n+    name = \"test_lib\",\n+    testonly = True,\n+    srcs = glob([\n+        \"**/*.ts\",\n+    ]),\n+    deps = [\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+    ],\n+)\n+\n+jasmine_node_test(\n+    name = \"test\",\n+    bootstrap = [\"//tools/testing:node_no_angular_es5\"],\n+    deps = [\n+        \":test_lib\",\n+    ],\n+)"
        },
        {
            "sha": "4bc1c3b23f37a1c0fc18c9f454061adc66eb0e60",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/testing/test/mock_file_system_spec.ts",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/03edc7d6311e69a11310b28f00965f213dbd6dff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Ftest%2Fmock_file_system_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/03edc7d6311e69a11310b28f00965f213dbd6dff/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Ftest%2Fmock_file_system_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftesting%2Ftest%2Fmock_file_system_spec.ts?ref=03edc7d6311e69a11310b28f00965f213dbd6dff",
            "patch": "@@ -0,0 +1,46 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {getFileSystem} from '../../src/helpers';\n+import {FileSystem} from '../../src/types';\n+import {runInEachFileSystem} from '../src/test_helper';\n+\n+runInEachFileSystem(() => {\n+  describe('MockFileSystem', () => {\n+    let fs: FileSystem;\n+\n+    beforeEach(() => {\n+      fs = getFileSystem();\n+    });\n+\n+    it('should support symlinks', () => {\n+      const targetPath = fs.resolve('/link/target');\n+      const symlinkPath = fs.resolve('/src/symlink');\n+      const packageJsonInTarget = fs.resolve(targetPath, 'package.json');\n+      const packageJsonUsingSymlink = fs.resolve(symlinkPath, 'package.json');\n+\n+      fs.ensureDir(targetPath);\n+      fs.ensureDir(fs.resolve('/src'));\n+      fs.writeFile(packageJsonInTarget, '{}');\n+      fs.symlink(targetPath, symlinkPath);\n+\n+      expect(fs.exists(packageJsonUsingSymlink)).toBe(true);\n+      expect(fs.exists(fs.resolve(symlinkPath, 'unknown.json'))).toBe(false);\n+      expect(fs.readFile(packageJsonInTarget)).toBe('{}');\n+\n+      expect(fs.realpath(packageJsonUsingSymlink)).toBe(packageJsonInTarget);\n+      expect(fs.realpath(packageJsonInTarget)).toBe(packageJsonInTarget);\n+\n+      expect(fs.stat(symlinkPath).isSymbolicLink()).toBe(false);\n+      expect(fs.lstat(symlinkPath).isSymbolicLink()).toBe(true);\n+\n+      expect(fs.stat(packageJsonUsingSymlink).isSymbolicLink()).toBe(false);\n+      expect(fs.lstat(packageJsonUsingSymlink).isSymbolicLink()).toBe(false);\n+    });\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 81,
        "deletions": 3
    }
}