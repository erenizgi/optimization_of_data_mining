{
    "author": "devversion",
    "message": "fix(core): detect DI parameters in JIT mode for downleveled ES2015 classes (#38463)\n\nIn the Angular Package Format, we always shipped UMD bundles and previously even ES5 module output.\nWith V10, we removed the ES5 module output but kept the UMD ES5 output.\n\nFor this, we were able to remove our second TypeScript transpilation. Instead we started only\nbuilding ES2015 output and then downleveled it to ES5 UMD for the NPM packages. This worked\nas expected but unveiled an issue in the `@angular/core` reflection capabilities.\n\nIn JIT mode, Angular determines constructor parameters (for DI) using the `ReflectionCapabilities`. The\nreflection capabilities basically read runtime metadata of classes to determine the DI parameters. Such\nmetadata can be either stored in static class properties like `ctorParameters` or within TypeScript's `design:params`.\n\nIf Angular comes across a class that does not have any parameter metadata, it tries to detect if the\ngiven class is actually delegating to an inherited class. It does this naively in JIT by checking if the\nstringified class (function in ES5) matches a certain pattern. e.g.\n\n```js\nfunction MatTable() {\n  var _this = _super.apply(this, arguments) || this;\n```\n\nThese patterns are reluctant to changes of the class output. If a class is not recognized properly, the\nDI parameters will be assumed empty and the class is **incorrectly** constructed without arguments.\n\nThis actually happened as part of v10 now. Since we downlevel ES2015 to ES5 (instead of previously\ncompiling sources directly to ES5), the class output changed slightly so that Angular no longer detects\nit. e.g.\n\n```js\nvar _this = _super.apply(this, __spread(arguments)) || this;\n```\n\nThis happens because the ES2015 output will receive an auto-generated constructor if the class\ndefines class properties. This constructor is then already containing an explicit `super` call.\n\n```js\nexport class MatTable extends CdkTable {\n    constructor() {\n        super(...arguments);\n        this.disabled = true;\n    }\n}\n```\n\nIf we then downlevel this file to ES5 with `--downlevelIteration`, TypeScript adjusts the `super` call so that\nthe spread operator is no longer used (not supported in ES5). The resulting super call is different to the\nsuper call that would have been emitted if we would directly transpile to ES5. Ultimately, Angular no\nlonger detects such classes as having an delegate constructor -> and DI breaks.\n\nWe fix this by expanding the rather naive RegExp patterns used for the reflection capabilities\nso that downleveled pass-through/delegate constructors are properly detected. There is a risk\nof a false-positive as we cannot detect whether `__spread` is actually the TypeScript spread\nhelper, but given the reflection patterns already make lots of assumptions (e.g. that `super` is\nactually the superclass, we should be fine making this assumption too. The false-positive would\nnot result in a broken app, but rather in unnecessary providers being injected (as a noop).\n\nFixes #38453\n\nPR Close #38463",
    "sha": "ca07da4563ada2fe30ecc50c7fa49834d569776e",
    "files": [
        {
            "sha": "7da0ae353667b4214b93a34a5ccf2a73be8d30ec",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/ca07da4563ada2fe30ecc50c7fa49834d569776e/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/ca07da4563ada2fe30ecc50c7fa49834d569776e/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=ca07da4563ada2fe30ecc50c7fa49834d569776e",
            "patch": "@@ -656,6 +656,18 @@ jobs:\n       - run: yarn tsc -p packages\n       - run: yarn tsc -p modules\n       - run: yarn bazel build //packages/zone.js:npm_package\n+      # Build test fixtures for a test that rely on Bazel-generated fixtures. Note that disabling\n+      # specific tests which are reliant on such generated fixtures is not an option as SystemJS\n+      # in the Saucelabs legacy job always fetches referenced files, even if the imports would be\n+      # guarded by an check to skip in the Saucelabs legacy job. We should be good running such\n+      # test in all supported browsers on Saucelabs anyway until this job can be removed.\n+      - run:\n+          name: Preparing Bazel-generated fixtures required in legacy tests\n+          command: |\n+            yarn bazel build //packages/core/test:downleveled_es5_fixture\n+            # Needed for the ES5 downlevel reflector test in `packages/core/test/reflection`.\n+            cp dist/bin/packages/core/test/reflection/es5_downleveled_inheritance_fixture.js \\\n+              dist/all/@angular/core/test/reflection/es5_downleveled_inheritance_fixture.js\n       - run:\n           # Waiting on ready ensures that we don't run tests too early without Saucelabs not being ready.\n           name: Waiting for Saucelabs tunnel to connect"
        },
        {
            "sha": "6f97a611f84ce7551ef7e9e99666053dcf015e76",
            "filename": "karma-js.conf.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/ca07da4563ada2fe30ecc50c7fa49834d569776e/karma-js.conf.js",
            "raw_url": "https://github.com/angular/angular/raw/ca07da4563ada2fe30ecc50c7fa49834d569776e/karma-js.conf.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/karma-js.conf.js?ref=ca07da4563ada2fe30ecc50c7fa49834d569776e",
            "patch": "@@ -37,6 +37,9 @@ module.exports = function(config) {\n \n       'node_modules/core-js/client/core.js',\n       'node_modules/jasmine-ajax/lib/mock-ajax.js',\n+\n+      // Dependencies built by Bazel. See `config.yml` for steps running before\n+      // the legacy Saucelabs tests run.\n       'dist/bin/packages/zone.js/npm_package/bundles/zone.umd.js',\n       'dist/bin/packages/zone.js/npm_package/bundles/zone-testing.umd.js',\n       'dist/bin/packages/zone.js/npm_package/bundles/task-tracking.umd.js',"
        },
        {
            "sha": "b4880c4188d20fdd4bf0a04b9fd3f419fbd64a7f",
            "filename": "packages/core/src/reflection/reflection_capabilities.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 7,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/ca07da4563ada2fe30ecc50c7fa49834d569776e/packages%2Fcore%2Fsrc%2Freflection%2Freflection_capabilities.ts",
            "raw_url": "https://github.com/angular/angular/raw/ca07da4563ada2fe30ecc50c7fa49834d569776e/packages%2Fcore%2Fsrc%2Freflection%2Freflection_capabilities.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Freflection%2Freflection_capabilities.ts?ref=ca07da4563ada2fe30ecc50c7fa49834d569776e",
            "patch": "@@ -17,14 +17,45 @@ import {GetterFn, MethodFn, SetterFn} from './types';\n \n \n \n+/*\n+ * #########################\n+ * Attention: These Regular expressions have to hold even if the code is minified!\n+ * ##########################\n+ */\n+\n /**\n- * Attention: These regex has to hold even if the code is minified!\n+ * Regular expression that detects pass-through constructors for ES5 output. This Regex\n+ * intends to capture the common delegation pattern emitted by TypeScript and Babel. Also\n+ * it intends to capture the pattern where existing constructors have been downleveled from\n+ * ES2015 to ES5 using TypeScript w/ downlevel iteration. e.g.\n+ *\n+ *  * ```\n+ *   function MyClass() {\n+ *     var _this = _super.apply(this, arguments) || this;\n+ * ```\n+ *\n+ * ```\n+ *   function MyClass() {\n+ *     var _this = _super.apply(this, __spread(arguments)) || this;\n+ * ```\n+ *\n+ * More details can be found in: https://github.com/angular/angular/issues/38453.\n  */\n-export const DELEGATE_CTOR = /^function\\s+\\S+\\(\\)\\s*{[\\s\\S]+\\.apply\\(this,\\s*arguments\\)/;\n-export const INHERITED_CLASS = /^class\\s+[A-Za-z\\d$_]*\\s*extends\\s+[^{]+{/;\n-export const INHERITED_CLASS_WITH_CTOR =\n+export const ES5_DELEGATE_CTOR =\n+    /^function\\s+\\S+\\(\\)\\s*{[\\s\\S]+\\.apply\\(this,\\s*(arguments|[^()]+\\(arguments\\))\\)/;\n+/** Regular expression that detects ES2015 classes which extend from other classes. */\n+export const ES2015_INHERITED_CLASS = /^class\\s+[A-Za-z\\d$_]*\\s*extends\\s+[^{]+{/;\n+/**\n+ * Regular expression that detects ES2015 classes which extend from other classes and\n+ * have an explicit constructor defined.\n+ */\n+export const ES2015_INHERITED_CLASS_WITH_CTOR =\n     /^class\\s+[A-Za-z\\d$_]*\\s*extends\\s+[^{]+{[\\s\\S]*constructor\\s*\\(/;\n-export const INHERITED_CLASS_WITH_DELEGATE_CTOR =\n+/**\n+ * Regular expression that detects ES2015 classes which extend from other classes\n+ * and inherit a constructor.\n+ */\n+export const ES2015_INHERITED_CLASS_WITH_DELEGATE_CTOR =\n     /^class\\s+[A-Za-z\\d$_]*\\s*extends\\s+[^{]+{[\\s\\S]*constructor\\s*\\(\\)\\s*{\\s*super\\(\\.\\.\\.arguments\\)/;\n \n /**\n@@ -36,8 +67,9 @@ export const INHERITED_CLASS_WITH_DELEGATE_CTOR =\n  * an initialized instance property.\n  */\n export function isDelegateCtor(typeStr: string): boolean {\n-  return DELEGATE_CTOR.test(typeStr) || INHERITED_CLASS_WITH_DELEGATE_CTOR.test(typeStr) ||\n-      (INHERITED_CLASS.test(typeStr) && !INHERITED_CLASS_WITH_CTOR.test(typeStr));\n+  return ES5_DELEGATE_CTOR.test(typeStr) ||\n+      ES2015_INHERITED_CLASS_WITH_DELEGATE_CTOR.test(typeStr) ||\n+      (ES2015_INHERITED_CLASS.test(typeStr) && !ES2015_INHERITED_CLASS_WITH_CTOR.test(typeStr));\n }\n \n export class ReflectionCapabilities implements PlatformReflectionCapabilities {"
        },
        {
            "sha": "88274929366bb5672100114f29802b45a84227ae",
            "filename": "packages/core/test/BUILD.bazel",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/ca07da4563ada2fe30ecc50c7fa49834d569776e/packages%2Fcore%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/ca07da4563ada2fe30ecc50c7fa49834d569776e/packages%2Fcore%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2FBUILD.bazel?ref=ca07da4563ada2fe30ecc50c7fa49834d569776e",
            "patch": "@@ -15,13 +15,31 @@ circular_dependency_test(\n     deps = [\"//packages/core/testing\"],\n )\n \n+genrule(\n+    name = \"downleveled_es5_fixture\",\n+    srcs = [\"reflection/es2015_inheritance_fixture.ts\"],\n+    outs = [\"reflection/es5_downleveled_inheritance_fixture.js\"],\n+    cmd = \"\"\"\n+        es2015_out_dir=\"/tmp/downleveled_es5_fixture/\"\n+        es2015_out_file=\"$$es2015_out_dir/es2015_inheritance_fixture.js\"\n+\n+        # Build the ES2015 output and then downlevel it to ES5.\n+        $(execpath @npm//typescript/bin:tsc) $< --outDir $$es2015_out_dir --target ES2015 \\\n+            --types --module umd\n+        $(execpath @npm//typescript/bin:tsc) --outFile $@ $$es2015_out_file --allowJs \\\n+            --types --target ES5\n+    \"\"\",\n+    tools = [\"@npm//typescript/bin:tsc\"],\n+)\n+\n ts_library(\n     name = \"test_lib\",\n     testonly = True,\n     srcs = glob(\n         [\"**/*.ts\"],\n         exclude = [\n             \"**/*_node_only_spec.ts\",\n+            \"reflection/es2015_inheritance_fixture.ts\",\n         ],\n     ),\n     # Visible to //:saucelabs_unit_tests_poc target\n@@ -73,6 +91,9 @@ ts_library(\n jasmine_node_test(\n     name = \"test\",\n     bootstrap = [\"//tools/testing:node_es5\"],\n+    data = [\n+        \":downleveled_es5_fixture\",\n+    ],\n     shard_count = 4,\n     deps = [\n         \":test_lib\",\n@@ -87,6 +108,7 @@ jasmine_node_test(\n \n karma_web_test_suite(\n     name = \"test_web\",\n+    runtime_deps = [\":downleveled_es5_fixture\"],\n     deps = [\n         \":test_lib\",\n     ],"
        },
        {
            "sha": "d9ba165acefa63871a0feef9f85f31c76ee853ce",
            "filename": "packages/core/test/reflection/es2015_inheritance_fixture.ts",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/ca07da4563ada2fe30ecc50c7fa49834d569776e/packages%2Fcore%2Ftest%2Freflection%2Fes2015_inheritance_fixture.ts",
            "raw_url": "https://github.com/angular/angular/raw/ca07da4563ada2fe30ecc50c7fa49834d569776e/packages%2Fcore%2Ftest%2Freflection%2Fes2015_inheritance_fixture.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Freflection%2Fes2015_inheritance_fixture.ts?ref=ca07da4563ada2fe30ecc50c7fa49834d569776e",
            "patch": "@@ -0,0 +1,22 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+// AMD module name is required so that this file can be loaded in the Karma tests.\n+/// <amd-module name=\"angular/packages/core/test/reflection/es5_downleveled_inheritance_fixture\" />\n+\n+class Parent {}\n+\n+export class ChildNoCtor extends Parent {}\n+export class ChildWithCtor extends Parent {\n+  constructor() {\n+    super();\n+  }\n+}\n+export class ChildNoCtorPrivateProps extends Parent {\n+  x = 10;\n+}"
        },
        {
            "sha": "87123b708769c206cae8307a3bf05437bee40cc9",
            "filename": "packages/core/test/reflection/reflector_spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/ca07da4563ada2fe30ecc50c7fa49834d569776e/packages%2Fcore%2Ftest%2Freflection%2Freflector_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ca07da4563ada2fe30ecc50c7fa49834d569776e/packages%2Fcore%2Ftest%2Freflection%2Freflector_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Freflection%2Freflector_spec.ts?ref=ca07da4563ada2fe30ecc50c7fa49834d569776e",
            "patch": "@@ -201,6 +201,16 @@ class TestObj {\n         expect(isDelegateCtor(ChildWithCtor.toString())).toBe(false);\n       });\n \n+      // See: https://github.com/angular/angular/issues/38453\n+      it('should support ES2015 downleveled classes', () => {\n+        const {ChildNoCtor, ChildNoCtorPrivateProps, ChildWithCtor} =\n+            require('./es5_downleveled_inheritance_fixture');\n+\n+        expect(isDelegateCtor(ChildNoCtor.toString())).toBe(true);\n+        expect(isDelegateCtor(ChildNoCtorPrivateProps.toString())).toBe(true);\n+        expect(isDelegateCtor(ChildWithCtor.toString())).toBe(false);\n+      });\n+\n       it('should support ES2015 classes when minified', () => {\n         // These classes are ES2015 in minified form\n         const ChildNoCtorMinified = 'class ChildNoCtor extends Parent{}';"
        }
    ],
    "stats": {
        "total": 115,
        "additions": 108,
        "deletions": 7
    }
}