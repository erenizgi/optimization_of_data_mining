{
    "author": "petebacondarwin",
    "message": "fix(compiler): include leading whitespace in source-spans of i18n messages (#42062)\n\nPreviously, the way templates were tokenized meant that we lost information\nabout the location of interpolations if the template contained encoded HTML\nentities. This meant that the mapping back to the source interpolated strings\ncould be offset incorrectly.\n\nAlso, the source-span assigned to an i18n message did not include leading\nwhitespace. This confused the output source-mappings so that the first text\nnodes of the message stopped at the first non-whitespace character.\n\nThis commit makes use of the previous refactorings, where more fine grain\ninformation was provided in text tokens, to enable the parser to identify\nthe location of the interpolations in the original source more accurately.\n\nFixes #41034\n\nPR Close #42062",
    "sha": "f08516db09df64c075f273159a15f80c792c96f0",
    "files": [
        {
            "sha": "9fd906166aee9c031b71c82b73f838a504cf1961",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/external_templates/escaped_chars_partial.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Fexternal_templates%2Fescaped_chars_partial.js",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Fexternal_templates%2Fescaped_chars_partial.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Fexternal_templates%2Fescaped_chars_partial.js?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -1,6 +1,6 @@\n .ÉµÉµelementStart(0, \"div\") // SOURCE: \"/escaped_chars.html\" \"<div>\\r\\n  \"\n â€¦\n // NOTE: the `\\\\r\\\\n` at the end of the next line will be unescaped to `\\r\\n`. If it was just `\\r\\n` it would get unescaped to the actual characters.\n-.ÉµÉµtext(1, \" Some Message Encoded character: \\uD83D\\uDE80\\\\n\") // SOURCE: \"/escaped_chars.html\" \"Some Message\\r\\n  Encoded character: ðŸš€\\\\r\\\\n\"\n+.ÉµÉµtext(1, \" Some Message Encoded character: \\uD83D\\uDE80\\\\n\") // SOURCE: \"/escaped_chars.html\" \"Some Message\\r\\n  Encoded character: ðŸš€\\r\\n\"\n â€¦\n .ÉµÉµelementEnd() // SOURCE: \"/escaped_chars.html\" \"</div>\""
        },
        {
            "sha": "37a59af4fbc9d1ce1ebdc3ba670988f312205809",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/inline_templates/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2FGOLDEN_PARTIAL.js?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -1652,6 +1652,78 @@ export declare class TestCmp {\n     static Éµcmp: i0.ÉµÉµComponentDeclaration<TestCmp, \"test-cmp\", never, {}, {}, never, never>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: i18n_message_placeholder_entities.js\n+ ****************************************************************************************************/\n+import { Component } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class TestCmp {\n+    constructor() {\n+        this.one = 1;\n+        this.two = 2;\n+    }\n+}\n+TestCmp.Éµfac = i0.ÉµÉµngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: TestCmp, deps: [], target: i0.ÉµÉµFactoryTarget.Component });\n+TestCmp.Éµcmp = i0.ÉµÉµngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: TestCmp, selector: \"test-cmp\", ngImport: i0, template: '<div i18n>Interpolation: {{ one }}&nbsp;Interpolation: {{ two }}</div>', isInline: true });\n+i0.ÉµÉµngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: TestCmp, decorators: [{\n+            type: Component,\n+            args: [{\n+                    selector: 'test-cmp',\n+                    template: '<div i18n>Interpolation: {{ one }}&nbsp;Interpolation: {{ two }}</div>',\n+                }]\n+        }] });\n+//# sourceMappingURL=i18n_message_placeholder_entities.js.map\n+/****************************************************************************************************\n+ * PARTIAL FILE: i18n_message_placeholder_entities.js.map\n+ ****************************************************************************************************/\n+{\"version\":3,\"file\":\"i18n_message_placeholder_entities.js\",\"sourceRoot\":\"\",\"sources\":[\"../i18n_message_placeholder_entities.ts\"],\"names\":[],\"mappings\":\"AAAA,OAAO,EAAC,SAAS,EAAC,MAAM,eAAe,CAAC;;AAMxC,MAAM,OAAO,OAAO;IAJpB;QAKE,QAAG,GAAG,CAAC,CAAC;QACR,QAAG,GAAG,CAAC,CAAC;KACT;;+GAHY,OAAO;mGAAP,OAAO,gDAFR,wEAAwE;sGAEvE,OAAO;kBAJnB,SAAS;mBAAC;oBACT,QAAQ,EAAE,UAAU;oBACpB,QAAQ,EAAE,wEAAwE;iBACnF\"}\n+/****************************************************************************************************\n+ * PARTIAL FILE: i18n_message_placeholder_entities.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class TestCmp {\n+    one: number;\n+    two: number;\n+    static Éµfac: i0.ÉµÉµFactoryDeclaration<TestCmp, never>;\n+    static Éµcmp: i0.ÉµÉµComponentDeclaration<TestCmp, \"test-cmp\", never, {}, {}, never, never>;\n+}\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: i18n_message_placeholder_entities.js\n+ ****************************************************************************************************/\n+import { Component } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class TestCmp {\n+    constructor() {\n+        this.one = 1;\n+        this.two = 2;\n+    }\n+}\n+TestCmp.Éµfac = i0.ÉµÉµngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: TestCmp, deps: [], target: i0.ÉµÉµFactoryTarget.Component });\n+TestCmp.Éµcmp = i0.ÉµÉµngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: TestCmp, selector: \"test-cmp\", ngImport: i0, template: '<div i18n>Interpolation: {{ one }}&nbsp;Interpolation: {{ two }}</div>', isInline: true });\n+i0.ÉµÉµngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: TestCmp, decorators: [{\n+            type: Component,\n+            args: [{\n+                    selector: 'test-cmp',\n+                    template: '<div i18n>Interpolation: {{ one }}&nbsp;Interpolation: {{ two }}</div>',\n+                }]\n+        }] });\n+//# sourceMappingURL=i18n_message_placeholder_entities.js.map\n+/****************************************************************************************************\n+ * PARTIAL FILE: i18n_message_placeholder_entities.js.map\n+ ****************************************************************************************************/\n+{\"version\":3,\"file\":\"i18n_message_placeholder_entities.js\",\"sourceRoot\":\"\",\"sources\":[\"../i18n_message_placeholder_entities.ts\"],\"names\":[],\"mappings\":\"AAAA,OAAO,EAAC,SAAS,EAAC,MAAM,eAAe,CAAC;;AAMxC,MAAM,OAAO,OAAO;IAJpB;QAKE,QAAG,GAAG,CAAC,CAAC;QACR,QAAG,GAAG,CAAC,CAAC;KACT;;+GAHY,OAAO;mGAAP,OAAO,gDAFR,wEAAwE;sGAEvE,OAAO;kBAJnB,SAAS;mBAAC;oBACT,QAAQ,EAAE,UAAU;oBACpB,QAAQ,EAAE,wEAAwE;iBACnF\"}\n+/****************************************************************************************************\n+ * PARTIAL FILE: i18n_message_placeholder_entities.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class TestCmp {\n+    one: number;\n+    two: number;\n+    static Éµfac: i0.ÉµÉµFactoryDeclaration<TestCmp, never>;\n+    static Éµcmp: i0.ÉµÉµComponentDeclaration<TestCmp, \"test-cmp\", never, {}, {}, never, never>;\n+}\n+\n /****************************************************************************************************\n  * PARTIAL FILE: i18n_message_interpolation_whitespace.js\n  ****************************************************************************************************/"
        },
        {
            "sha": "65f597bec5db5875c59a79a86f676c71ba7a8de6",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/inline_templates/TEST_CASES.json",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2FTEST_CASES.json?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -749,6 +749,40 @@\n         \"sourceMap\": true\n       }\n     },\n+    {\n+      \"description\": \"should handle encoded entities in i18n message source-mappings (full compile)\",\n+      \"inputFiles\": [\n+        \"i18n_message_placeholder_entities.ts\"\n+      ],\n+      \"compilationModeFilter\": [\n+        \"full compile\"\n+      ],\n+      \"compilerOptions\": {\n+        \"sourceMap\": true\n+      }\n+    },\n+    {\n+      \"description\": \"should handle encoded entities in i18n message source-mappings (partial compile)\",\n+      \"inputFiles\": [\n+        \"i18n_message_placeholder_entities.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"files\": [\n+            {\n+              \"generated\": \"i18n_message_placeholder_entities.js\",\n+              \"expected\": \"i18n_message_placeholder_entities_partial.js\"\n+            }\n+          ]\n+        }\n+      ],\n+      \"compilationModeFilter\": [\n+        \"linked compile\"\n+      ],\n+      \"compilerOptions\": {\n+        \"sourceMap\": true\n+      }\n+    },\n     {\n       \"description\": \"should correctly handle collapsed whitespace in interpolation placeholder i18n message source-mappings (full compile)\",\n       \"inputFiles\": ["
        },
        {
            "sha": "c396b26efecf67957825940ad9aec17918c22fa1",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/inline_templates/i18n_message_element_whitespace.js",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace.js",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace.js?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -1,19 +1,19 @@\n-` pre-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"pre-p\\\\n  \"\n+` pre-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n  pre-p\\\\n  \"\n â€¦\n-\"\\uFFFD#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\\\\n    \"\n+\"\\uFFFD#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\"\n â€¦\n-}:START_PARAGRAPH: in-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"in-p\\\\n  \"\n+}:START_PARAGRAPH: in-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n    in-p\\\\n  \"\n â€¦\n \"\\uFFFD/#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"</p>\"\n â€¦\n-}:CLOSE_PARAGRAPH: post-p\\n` // SOURCE: \"/i18n_message_element_whitespace.ts\" \"post-p\\\\n\"\n+}:CLOSE_PARAGRAPH: post-p\\n` // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n  post-p\\\\n\"\n â€¦\n \n i0.ÉµÉµelementStart(0, \"div\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\"\n â€¦\n i0.ÉµÉµi18nStart(1, 0) // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\"\n â€¦\n-i0.ÉµÉµelement(2, \"p\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\\\\n    \"\n+i0.ÉµÉµelement(2, \"p\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\"\n â€¦\n i0.ÉµÉµi18nEnd() // SOURCE: \"/i18n_message_element_whitespace.ts\" \"</div>\"\n â€¦"
        },
        {
            "sha": "ccdff3a1e4dbb673e5e6ca98bc6371cc33092a8c",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/inline_templates/i18n_message_element_whitespace_partial.js",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace_partial.js",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace_partial.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace_partial.js?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -1,19 +1,19 @@\n-$localize` pre-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"pre-p\\\\n  \"\n+$localize` pre-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n  pre-p\\\\n  \"\n â€¦\n-\"\\uFFFD#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\\\\n    \"\n+\"\\uFFFD#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\"\n â€¦\n-}:START_PARAGRAPH: in-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"in-p\\\\n  \"\n+}:START_PARAGRAPH: in-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n    in-p\\\\n  \"\n â€¦\n-\"\\uFFFD/#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"</p>\\\\n  \"\n+\"\\uFFFD/#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"</p>\"\n â€¦\n-}:CLOSE_PARAGRAPH: post-p\\n` // SOURCE: \"/i18n_message_element_whitespace.ts\" \"post-p\\\\n\"\n+}:CLOSE_PARAGRAPH: post-p\\n` // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n  post-p\\\\n\"\n â€¦\n \n-.ÉµÉµelementStart(0, \"div\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\\\\n  \"\n+.ÉµÉµelementStart(0, \"div\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\"\n â€¦\n-.ÉµÉµi18nStart(1, 0) // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\\\\n  \"\n+.ÉµÉµi18nStart(1, 0) // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\"\n â€¦\n-.ÉµÉµelement(2, \"p\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\\\\n    \"\n+.ÉµÉµelement(2, \"p\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\"\n â€¦\n .ÉµÉµi18nEnd() // SOURCE: \"/i18n_message_element_whitespace.ts\" \"</div>'\"\n â€¦"
        },
        {
            "sha": "288aa5d216201c1014d7c1f7220dd2287405a222",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/inline_templates/i18n_message_placeholder_entities.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_placeholder_entities.js",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_placeholder_entities.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_placeholder_entities.js?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -0,0 +1,9 @@\n+`Interpolation: ${ // SOURCE: \"/i18n_message_placeholder_entities.ts\" \"Interpolation: \"\n+â€¦\n+\"\\uFFFD0\\uFFFD\" // SOURCE: \"/i18n_message_placeholder_entities.ts\" \"{{ one }}\"\n+â€¦\n+}:INTERPOLATION:Â Interpolation: ${ // SOURCE: \"/i18n_message_placeholder_entities.ts\" \"&nbsp;Interpolation: \"\n+â€¦\n+\"\\uFFFD1\\uFFFD\" // SOURCE: \"/i18n_message_placeholder_entities.ts\" \"{{ two }}\"\n+â€¦\n+}:INTERPOLATION_1:` // SOURCE: \"/i18n_message_placeholder_entities.ts\" \"</div>\""
        },
        {
            "sha": "df517b7f48b9ba756144d35e910a254448605e18",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/inline_templates/i18n_message_placeholder_entities.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_placeholder_entities.ts",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_placeholder_entities.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_placeholder_entities.ts?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -0,0 +1,10 @@\n+import {Component} from '@angular/core';\n+\n+@Component({\n+  selector: 'test-cmp',\n+  template: '<div i18n>Interpolation: {{ one }}&nbsp;Interpolation: {{ two }}</div>',\n+})\n+export class TestCmp {\n+  one = 1;\n+  two = 2;\n+}"
        },
        {
            "sha": "1002ce6fcd13afb87d408570fa3dd97e0e151eb8",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/inline_templates/i18n_message_placeholder_entities_partial.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_placeholder_entities_partial.js",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_placeholder_entities_partial.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_placeholder_entities_partial.js?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -0,0 +1,9 @@\n+$localize`Interpolation: ${ // SOURCE: \"/i18n_message_placeholder_entities.ts\" \"Interpolation: \"\n+â€¦\n+\"\\uFFFD0\\uFFFD\" // SOURCE: \"/i18n_message_placeholder_entities.ts\" \"{{ one }}\"\n+â€¦\n+}:INTERPOLATION:Â Interpolation: ${ // SOURCE: \"/i18n_message_placeholder_entities.ts\" \"&nbsp;Interpolation: \"\n+â€¦\n+\"\\uFFFD1\\uFFFD\" // SOURCE: \"/i18n_message_placeholder_entities.ts\" \"{{ two }}\"\n+â€¦\n+}:INTERPOLATION_1:` // SOURCE: \"/i18n_message_placeholder_entities.ts\" \"</div>'\""
        },
        {
            "sha": "f8f70c1acddaf23dc44ed23fa1eb3b353841f51e",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/inline_templates/update_mode_partial.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fupdate_mode_partial.js",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fupdate_mode_partial.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fupdate_mode_partial.js?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -10,7 +10,7 @@\n .ÉµÉµtext(3) // SOURCE: \"/update_mode.ts\" \"{{ 1 + 2 }}\"\n â€¦\n // TODO: Work out how to fix the broken segment for the last item in a template\n-.ÉµÉµelem // SOURCE: \"/update_mode.ts\" \"</div>\"'\n+.ÉµÉµelem // SOURCE: \"/update_mode.ts\" \"</div>'\"\n â€¦\n // NOTE: Update mode\n .ÉµÉµtextInterpolate(1 + 2) // SOURCE: \"/update_mode.ts\" \"{{ 1 + 2 }}\""
        },
        {
            "sha": "02cfcede57a425dbd85d8f58d8af1b2d205b95d0",
            "filename": "packages/compiler-cli/test/ngtsc/template_mapping_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -464,27 +464,27 @@ runInEachFileSystem((os) => {\n              // $localize expressions\n              expectMapping(mappings, {\n                sourceUrl: '../test.ts',\n-               source: 'pre-p\\n  ',\n+               source: '\\n  pre-p\\n  ',\n                generated: '` pre-p ${',\n              });\n              expectMapping(mappings, {\n                sourceUrl: '../test.ts',\n-               source: '<p>\\n    ',\n+               source: '<p>',\n                generated: '\"\\\\uFFFD#2\\\\uFFFD\"',\n              });\n              expectMapping(mappings, {\n                sourceUrl: '../test.ts',\n-               source: 'in-p\\n  ',\n+               source: '\\n    in-p\\n  ',\n                generated: '}:START_PARAGRAPH: in-p ${',\n              });\n              expectMapping(mappings, {\n                sourceUrl: '../test.ts',\n-               source: '</p>\\n  ',\n+               source: '</p>',\n                generated: '\"\\\\uFFFD/#2\\\\uFFFD\"',\n              });\n              expectMapping(mappings, {\n                sourceUrl: '../test.ts',\n-               source: 'post-p\\n',\n+               source: '\\n  post-p\\n',\n                generated: '}:CLOSE_PARAGRAPH: post-p\\n`',\n              });\n              // ivy instructions"
        },
        {
            "sha": "dda395f873fbd1a84676b03e01247d0134c69d6a",
            "filename": "packages/compiler/src/i18n/i18n_parser.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 63,
            "changes": 94,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -7,10 +7,11 @@\n  */\n \n import {Lexer as ExpressionLexer} from '../expression_parser/lexer';\n-import {InterpolationPiece, Parser as ExpressionParser} from '../expression_parser/parser';\n+import {Parser as ExpressionParser} from '../expression_parser/parser';\n import * as html from '../ml_parser/ast';\n import {getHtmlTagDefinition} from '../ml_parser/html_tags';\n import {InterpolationConfig} from '../ml_parser/interpolation_config';\n+import {Token, TokenType} from '../ml_parser/lexer';\n import {ParseSourceSpan} from '../parse_util';\n \n import * as i18n from './i18n_ast';\n@@ -105,13 +106,18 @@ class _I18nVisitor implements html.Visitor {\n   }\n \n   visitAttribute(attribute: html.Attribute, context: I18nMessageVisitorContext): i18n.Node {\n-    const node = this._visitTextWithInterpolation(\n-        attribute.value, attribute.valueSpan || attribute.sourceSpan, context, attribute.i18n);\n+    const node = attribute.valueTokens === undefined || attribute.valueTokens.length === 1 ?\n+        new i18n.Text(attribute.value, attribute.valueSpan || attribute.sourceSpan) :\n+        this._visitTextWithInterpolation(\n+            attribute.valueTokens, attribute.valueSpan || attribute.sourceSpan, context,\n+            attribute.i18n);\n     return context.visitNodeFn(attribute, node);\n   }\n \n   visitText(text: html.Text, context: I18nMessageVisitorContext): i18n.Node {\n-    const node = this._visitTextWithInterpolation(text.value, text.sourceSpan, context, text.i18n);\n+    const node = text.tokens.length === 1 ?\n+        new i18n.Text(text.value, text.sourceSpan) :\n+        this._visitTextWithInterpolation(text.tokens, text.sourceSpan, context, text.i18n);\n     return context.visitNodeFn(text, node);\n   }\n \n@@ -165,66 +171,36 @@ class _I18nVisitor implements html.Visitor {\n    * @param previousI18n Any i18n metadata associated with this `text` from a previous pass.\n    */\n   private _visitTextWithInterpolation(\n-      text: string, sourceSpan: ParseSourceSpan, context: I18nMessageVisitorContext,\n+      tokens: Token[], sourceSpan: ParseSourceSpan, context: I18nMessageVisitorContext,\n       previousI18n: i18n.I18nMeta|undefined): i18n.Node {\n-    const {strings, expressions} = this._expressionParser.splitInterpolation(\n-        text, sourceSpan.start.toString(), this._interpolationConfig);\n-\n-    // No expressions, return a single text.\n-    if (expressions.length === 0) {\n-      return new i18n.Text(text, sourceSpan);\n-    }\n-\n     // Return a sequence of `Text` and `Placeholder` nodes grouped in a `Container`.\n     const nodes: i18n.Node[] = [];\n-    for (let i = 0; i < strings.length - 1; i++) {\n-      this._addText(nodes, strings[i], sourceSpan);\n-      this._addPlaceholder(nodes, context, expressions[i], sourceSpan);\n+    for (const token of tokens) {\n+      switch (token.type) {\n+        case TokenType.INTERPOLATION:\n+        case TokenType.ATTR_VALUE_INTERPOLATION:\n+          const expression = token.parts[1];\n+          const baseName = extractPlaceholderName(expression) || 'INTERPOLATION';\n+          const phName = context.placeholderRegistry.getPlaceholderName(baseName, expression);\n+          context.placeholderToContent[phName] = {\n+            text: token.parts.join(''),\n+            sourceSpan: token.sourceSpan\n+          };\n+          nodes.push(new i18n.Placeholder(expression, phName, token.sourceSpan));\n+          break;\n+        default:\n+          if (token.parts[0].length > 0) {\n+            nodes.push(new i18n.Text(token.parts[0], token.sourceSpan));\n+          }\n+          break;\n+      }\n     }\n-    // The last index contains no expression\n-    this._addText(nodes, strings[strings.length - 1], sourceSpan);\n \n     // Whitespace removal may have invalidated the interpolation source-spans.\n     reusePreviousSourceSpans(nodes, previousI18n);\n \n     return new i18n.Container(nodes, sourceSpan);\n   }\n-\n-  /**\n-   * Create a new `Text` node from the `textPiece` and add it to the `nodes` collection.\n-   *\n-   * @param nodes The nodes to which the created `Text` node should be added.\n-   * @param textPiece The text and relative span information for this `Text` node.\n-   * @param interpolationSpan The span of the whole interpolated text.\n-   */\n-  private _addText(\n-      nodes: i18n.Node[], textPiece: InterpolationPiece, interpolationSpan: ParseSourceSpan): void {\n-    if (textPiece.text.length > 0) {\n-      // No need to add empty strings\n-      const stringSpan = getOffsetSourceSpan(interpolationSpan, textPiece);\n-      nodes.push(new i18n.Text(textPiece.text, stringSpan));\n-    }\n-  }\n-\n-  /**\n-   * Create a new `Placeholder` node from the `expression` and add it to the `nodes` collection.\n-   *\n-   * @param nodes The nodes to which the created `Text` node should be added.\n-   * @param context The current context of the visitor, used to compute and store placeholders.\n-   * @param expression The expression text and relative span information for this `Placeholder`\n-   *     node.\n-   * @param interpolationSpan The span of the whole interpolated text.\n-   */\n-  private _addPlaceholder(\n-      nodes: i18n.Node[], context: I18nMessageVisitorContext, expression: InterpolationPiece,\n-      interpolationSpan: ParseSourceSpan): void {\n-    const sourceSpan = getOffsetSourceSpan(interpolationSpan, expression);\n-    const baseName = extractPlaceholderName(expression.text) || 'INTERPOLATION';\n-    const phName = context.placeholderRegistry.getPlaceholderName(baseName, expression.text);\n-    const text = this._interpolationConfig.start + expression.text + this._interpolationConfig.end;\n-    context.placeholderToContent[phName] = {text, sourceSpan};\n-    nodes.push(new i18n.Placeholder(expression.text, phName, sourceSpan));\n-  }\n }\n \n /**\n@@ -247,7 +223,7 @@ function reusePreviousSourceSpans(nodes: i18n.Node[], previousI18n: i18n.I18nMet\n \n   if (previousI18n instanceof i18n.Container) {\n     // The `previousI18n` is a `Container`, which means that this is a second i18n extraction pass\n-    // after whitespace has been removed from the AST ndoes.\n+    // after whitespace has been removed from the AST nodes.\n     assertEquivalentNodes(previousI18n.children, nodes);\n \n     // Reuse the source-spans from the first pass.\n@@ -282,14 +258,6 @@ function assertEquivalentNodes(previousNodes: i18n.Node[], nodes: i18n.Node[]):\n   }\n }\n \n-/**\n- * Create a new `ParseSourceSpan` from the `sourceSpan`, offset by the `start` and `end` values.\n- */\n-function getOffsetSourceSpan(\n-    sourceSpan: ParseSourceSpan, {start, end}: InterpolationPiece): ParseSourceSpan {\n-  return new ParseSourceSpan(sourceSpan.fullStart.moveBy(start), sourceSpan.fullStart.moveBy(end));\n-}\n-\n const _CUSTOM_PH_EXP =\n     /\\/\\/[\\s\\S]*i18n[\\s\\S]*\\([\\s\\S]*ph[\\s\\S]*=[\\s\\S]*(\"|')([\\s\\S]*?)\\1[\\s\\S]*\\)/g;\n "
        },
        {
            "sha": "3c95825e3426965fd344474cccd633329fb8dbda",
            "filename": "packages/compiler/src/ml_parser/lexer.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 10,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -230,8 +230,11 @@ class _Tokenizer {\n             this._consumeTagOpen(start);\n           }\n         } else if (!(this._tokenizeIcu && this._tokenizeExpansionForm())) {\n+          // In (possibly interpolated) text the end of the text is given by `isTextEnd()`, while\n+          // the premature end of an interpolation is given by the start of a new HTML element.\n           this._consumeWithInterpolation(\n-              TokenType.TEXT, TokenType.INTERPOLATION, () => this._isTextEnd());\n+              TokenType.TEXT, TokenType.INTERPOLATION, () => this._isTextEnd(),\n+              () => this._isTagStart());\n         }\n       } catch (e) {\n         this.handleError(e);\n@@ -608,14 +611,18 @@ class _Tokenizer {\n     if (this._cursor.peek() === chars.$SQ || this._cursor.peek() === chars.$DQ) {\n       const quoteChar = this._cursor.peek();\n       this._consumeQuote(quoteChar);\n+      // In an attribute then end of the attribute value and the premature end to an interpolation\n+      // are both triggered by the `quoteChar`.\n+      const endPredicate = () => this._cursor.peek() === quoteChar;\n       this._consumeWithInterpolation(\n-          TokenType.ATTR_VALUE_TEXT, TokenType.ATTR_VALUE_INTERPOLATION,\n-          () => this._cursor.peek() === quoteChar);\n+          TokenType.ATTR_VALUE_TEXT, TokenType.ATTR_VALUE_INTERPOLATION, endPredicate,\n+          endPredicate);\n       this._consumeQuote(quoteChar);\n     } else {\n       const endPredicate = () => isNameEnd(this._cursor.peek());\n       this._consumeWithInterpolation(\n-          TokenType.ATTR_VALUE_TEXT, TokenType.ATTR_VALUE_INTERPOLATION, endPredicate);\n+          TokenType.ATTR_VALUE_TEXT, TokenType.ATTR_VALUE_INTERPOLATION, endPredicate,\n+          endPredicate);\n     }\n   }\n \n@@ -705,15 +712,21 @@ class _Tokenizer {\n \n   /**\n    * Consume a string that may contain interpolation expressions.\n+   *\n    * The first token consumed will be of `tokenType` and then there will be alternating\n    * `interpolationTokenType` and `tokenType` tokens until the `endPredicate()` returns true.\n    *\n+   * If an interpolation token ends prematurely it will have no end marker in its `parts` array.\n+   *\n    * @param textTokenType the kind of tokens to interleave around interpolation tokens.\n    * @param interpolationTokenType the kind of tokens that contain interpolation.\n    * @param endPredicate a function that should return true when we should stop consuming.\n+   * @param endInterpolation a function that should return true if there is a premature end to an\n+   *     interpolation expression - i.e. before we get to the normal interpolation closing marker.\n    */\n   private _consumeWithInterpolation(\n-      textTokenType: TokenType, interpolationTokenType: TokenType, endPredicate: () => boolean) {\n+      textTokenType: TokenType, interpolationTokenType: TokenType, endPredicate: () => boolean,\n+      endInterpolation: () => boolean) {\n     this._beginToken(textTokenType);\n     const parts: string[] = [];\n \n@@ -722,7 +735,7 @@ class _Tokenizer {\n       if (this._interpolationConfig && this._attemptStr(this._interpolationConfig.start)) {\n         this._endToken([this._processCarriageReturns(parts.join(''))], current);\n         parts.length = 0;\n-        this._consumeInterpolation(interpolationTokenType, current);\n+        this._consumeInterpolation(interpolationTokenType, current, endInterpolation);\n         this._beginToken(textTokenType);\n       } else if (this._cursor.peek() === chars.$AMPERSAND) {\n         this._endToken([this._processCarriageReturns(parts.join(''))]);\n@@ -741,8 +754,17 @@ class _Tokenizer {\n     this._endToken([this._processCarriageReturns(parts.join(''))]);\n   }\n \n+  /**\n+   * Consume a block of text that has been interpreted as an Angular interpolation.\n+   *\n+   * @param interpolationTokenType the type of the interpolation token to generate.\n+   * @param interpolationStart a cursor that points to the start of this interpolation.\n+   * @param prematureEndPredicate a function that should return true if the next characters indicate\n+   *     an end to the interpolation before its normal closing marker.\n+   */\n   private _consumeInterpolation(\n-      interpolationTokenType: TokenType, interpolationStart: CharacterCursor) {\n+      interpolationTokenType: TokenType, interpolationStart: CharacterCursor,\n+      prematureEndPredicate: (() => boolean)|null) {\n     const parts: string[] = [];\n     this._beginToken(interpolationTokenType, interpolationStart);\n     parts.push(this._interpolationConfig.start);\n@@ -751,7 +773,8 @@ class _Tokenizer {\n     const expressionStart = this._cursor.clone();\n     let inQuote: number|null = null;\n     let inComment = false;\n-    while (this._cursor.peek() !== chars.$EOF) {\n+    while (this._cursor.peek() !== chars.$EOF &&\n+           (prematureEndPredicate === null || !prematureEndPredicate())) {\n       const current = this._cursor.clone();\n \n       if (this._isTagStart()) {\n@@ -783,7 +806,7 @@ class _Tokenizer {\n       } else if (char === inQuote) {\n         // Exiting the current quoted string\n         inQuote = null;\n-      } else if (!inComment && chars.isQuote(char)) {\n+      } else if (!inComment && inQuote === null && chars.isQuote(char)) {\n         // Entering a new quoted string\n         inQuote = char;\n       }\n@@ -795,7 +818,7 @@ class _Tokenizer {\n   }\n \n   private _getProcessedChars(start: CharacterCursor, end: CharacterCursor): string {\n-    return this._processCarriageReturns(end.getChars(start))\n+    return this._processCarriageReturns(end.getChars(start));\n   }\n \n   private _isTextEnd(): boolean {"
        },
        {
            "sha": "7579d3ebb8894fca56ba581f18302e1a5b970b46",
            "filename": "packages/compiler/src/render3/view/i18n/localize_utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -35,7 +35,10 @@ class LocalizeSerializerVisitor implements i18n.Visitor {\n       // Two literal pieces in a row means that there was some comment node in-between.\n       context[context.length - 1].text += text.value;\n     } else {\n-      context.push(new o.LiteralPiece(text.value, text.sourceSpan));\n+      const sourceSpan = new ParseSourceSpan(\n+          text.sourceSpan.fullStart, text.sourceSpan.end, text.sourceSpan.fullStart,\n+          text.sourceSpan.details);\n+      context.push(new o.LiteralPiece(text.value, sourceSpan));\n     }\n   }\n \n@@ -90,7 +93,7 @@ function getSourceSpan(message: i18n.Message): ParseSourceSpan {\n   const startNode = message.nodes[0];\n   const endNode = message.nodes[message.nodes.length - 1];\n   return new ParseSourceSpan(\n-      startNode.sourceSpan.start, endNode.sourceSpan.end, startNode.sourceSpan.fullStart,\n+      startNode.sourceSpan.fullStart, endNode.sourceSpan.end, startNode.sourceSpan.fullStart,\n       startNode.sourceSpan.details);\n }\n "
        },
        {
            "sha": "c0302a3345493ae843130b0208147e1c800986d0",
            "filename": "packages/compiler/test/ml_parser/lexer_spec.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 2,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -316,6 +316,32 @@ import {ParseLocation, ParseSourceFile, ParseSourceSpan} from '../../src/parse_u\n         ]);\n       });\n \n+      it('should end interpolation on an unescaped matching quote', () => {\n+        expect(tokenizeAndHumanizeParts('<t a=\"{{ a \\\\\" \\' b \">')).toEqual([\n+          [lex.TokenType.TAG_OPEN_START, '', 't'],\n+          [lex.TokenType.ATTR_NAME, '', 'a'],\n+          [lex.TokenType.ATTR_QUOTE, '\"'],\n+          [lex.TokenType.ATTR_VALUE_TEXT, ''],\n+          [lex.TokenType.ATTR_VALUE_INTERPOLATION, '{{', ' a \\\\\" \\' b '],\n+          [lex.TokenType.ATTR_VALUE_TEXT, ''],\n+          [lex.TokenType.ATTR_QUOTE, '\"'],\n+          [lex.TokenType.TAG_OPEN_END],\n+          [lex.TokenType.EOF],\n+        ]);\n+\n+        expect(tokenizeAndHumanizeParts('<t a=\\'{{ a \" \\\\\\' b \\'>')).toEqual([\n+          [lex.TokenType.TAG_OPEN_START, '', 't'],\n+          [lex.TokenType.ATTR_NAME, '', 'a'],\n+          [lex.TokenType.ATTR_QUOTE, '\\''],\n+          [lex.TokenType.ATTR_VALUE_TEXT, ''],\n+          [lex.TokenType.ATTR_VALUE_INTERPOLATION, '{{', ' a \" \\\\\\' b '],\n+          [lex.TokenType.ATTR_VALUE_TEXT, ''],\n+          [lex.TokenType.ATTR_QUOTE, '\\''],\n+          [lex.TokenType.TAG_OPEN_END],\n+          [lex.TokenType.EOF],\n+        ]);\n+      });\n+\n       it('should parse attributes with prefix', () => {\n         expect(tokenizeAndHumanizeParts('<t ns1:a>')).toEqual([\n           [lex.TokenType.TAG_OPEN_START, '', 't'],\n@@ -593,14 +619,15 @@ import {ParseLocation, ParseSourceFile, ParseSourceSpan} from '../../src/parse_u\n       });\n \n       it('should parse interpolation', () => {\n-        expect(tokenizeAndHumanizeParts('{{ a }}b{{ c // comment }}d{{ e \"}}\" f }}g{{ h // \" i }}'))\n+        expect(tokenizeAndHumanizeParts(\n+                   '{{ a }}b{{ c // comment }}d{{ e \"}} \\' \" f }}g{{ h // \" i }}'))\n             .toEqual([\n               [lex.TokenType.TEXT, ''],\n               [lex.TokenType.INTERPOLATION, '{{', ' a ', '}}'],\n               [lex.TokenType.TEXT, 'b'],\n               [lex.TokenType.INTERPOLATION, '{{', ' c // comment ', '}}'],\n               [lex.TokenType.TEXT, 'd'],\n-              [lex.TokenType.INTERPOLATION, '{{', ' e \"}}\" f ', '}}'],\n+              [lex.TokenType.INTERPOLATION, '{{', ' e \"}} \\' \" f ', '}}'],\n               [lex.TokenType.TEXT, 'g'],\n               [lex.TokenType.INTERPOLATION, '{{', ' h // \" i ', '}}'],\n               [lex.TokenType.TEXT, ''],\n@@ -735,6 +762,18 @@ import {ParseLocation, ParseSourceFile, ParseSourceSpan} from '../../src/parse_u\n         ]);\n       });\n \n+      it('should end interpolation on a valid closing tag', () => {\n+        expect(tokenizeAndHumanizeParts('<p>{{ a </p>')).toEqual([\n+          [lex.TokenType.TAG_OPEN_START, '', 'p'],\n+          [lex.TokenType.TAG_OPEN_END],\n+          [lex.TokenType.TEXT, ''],\n+          [lex.TokenType.INTERPOLATION, '{{', ' a '],\n+          [lex.TokenType.TEXT, ''],\n+          [lex.TokenType.TAG_CLOSE, '', 'p'],\n+          [lex.TokenType.EOF],\n+        ]);\n+      });\n+\n       it('should break out of interpolation in text token on valid CDATA', () => {\n         expect(tokenizeAndHumanizeParts('{{ a }<![CDATA[]]>}')).toEqual([\n           [lex.TokenType.TEXT, ''],"
        },
        {
            "sha": "25a1a9c0d87549ec92a40c2ea77c47abbe2e79cc",
            "filename": "packages/compiler/test/render3/view/i18n_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f08516db09df64c075f273159a15f80c792c96f0/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts?ref=f08516db09df64c075f273159a15f80c792c96f0",
            "patch": "@@ -478,7 +478,7 @@ describe('serializeI18nMessageForLocalize', () => {\n        expect(messageParts[3].text).toEqual('');\n        expect(messageParts[3].sourceSpan.toString()).toEqual('');\n        expect(messageParts[4].text).toEqual(' D');\n-       expect(messageParts[4].sourceSpan.toString()).toEqual('D');\n+       expect(messageParts[4].sourceSpan.toString()).toEqual(' D');\n \n        expect(placeHolders[0].text).toEqual('START_TAG_SPAN');\n        expect(placeHolders[0].sourceSpan.toString()).toEqual('<span>');"
        }
    ],
    "stats": {
        "total": 363,
        "additions": 265,
        "deletions": 98
    }
}