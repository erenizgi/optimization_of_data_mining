{
    "author": "petebacondarwin",
    "message": "fix(compiler): ensure that partially compiled queries can handle forward references (#44113)\n\nWhen a partially compiled component or directive is \"linked\" in JIT mode, the body\nof its declaration is evaluated by the JavaScript runtime. If a class is referenced\nin a query (e.g. `ViewQuery` or `ContentQuery`) but its definition is later in the\nfile, then the reference must be wrapped in a `forwardRef()` call.\n\nPreviously, query predicates were not wrapped correctly in partial declarations\ncausing the code to crash at runtime. In AOT mode, this code is never evaluated\nbut instead transformed as part of the build, so this bug did not become apparent\nuntil Angular Material started running JIT mode tests on its distributable output.\n\nThis change fixes this problem by noting when queries are wrapped in `forwardRef()`\ncalls and ensuring that this gets passed through to partial compilation declarations\nand then suitably stripped during linking.\n\nSee https://github.com/angular/components/pull/23882 and https://github.com/angular/components/issues/23907\n\nPR Close #44113",
    "sha": "393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
    "files": [
        {
            "sha": "cc278cb6efcb345a9432a6c775fc55aa23a88682",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_component_linker_1.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {ChangeDetectionStrategy, compileComponentFromMetadata, ConstantPool, DeclarationListEmitMode, DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig, makeBindingParser, outputAst as o, parseTemplate, R3ComponentMetadata, R3DeclareComponentMetadata, R3DeclareUsedDirectiveMetadata, R3PartialDeclaration, R3UsedDirectiveMetadata, ViewEncapsulation} from '@angular/compiler';\n+import {ChangeDetectionStrategy, compileComponentFromMetadata, ConstantPool, DeclarationListEmitMode, DEFAULT_INTERPOLATION_CONFIG, ForwardRefHandling, InterpolationConfig, makeBindingParser, outputAst as o, parseTemplate, R3ComponentMetadata, R3DeclareComponentMetadata, R3DeclareUsedDirectiveMetadata, R3PartialDeclaration, R3UsedDirectiveMetadata, ViewEncapsulation} from '@angular/compiler';\n \n import {AbsoluteFsPath} from '../../../../src/ngtsc/file_system';\n import {Range} from '../../ast/ast_host';\n@@ -69,8 +69,8 @@ export class PartialComponentLinkerVersion1<TStatement, TExpression> implements\n             const type = directiveExpr.getValue('type');\n             const selector = directiveExpr.getString('selector');\n \n-            const {expression: typeExpr, isForwardRef} = extractForwardRef(type);\n-            if (isForwardRef) {\n+            const {expression: typeExpr, forwardRef} = extractForwardRef(type);\n+            if (forwardRef === ForwardRefHandling.Unwrapped) {\n               declarationListEmitMode = DeclarationListEmitMode.Closure;\n             }\n \n@@ -101,8 +101,8 @@ export class PartialComponentLinkerVersion1<TStatement, TExpression> implements\n     let pipes = new Map<string, o.Expression>();\n     if (metaObj.has('pipes')) {\n       pipes = metaObj.getObject('pipes').toMap(pipe => {\n-        const {expression: pipeType, isForwardRef} = extractForwardRef(pipe);\n-        if (isForwardRef) {\n+        const {expression: pipeType, forwardRef} = extractForwardRef(pipe);\n+        if (forwardRef === ForwardRefHandling.Unwrapped) {\n           declarationListEmitMode = DeclarationListEmitMode.Closure;\n         }\n         return pipeType;"
        },
        {
            "sha": "41bbe07199c3452f74e06891112259430b005f0f",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_directive_linker_1.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_directive_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_directive_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_directive_linker_1.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -13,7 +13,7 @@ import {AstObject, AstValue} from '../../ast/ast_value';\n import {FatalLinkerError} from '../../fatal_linker_error';\n \n import {PartialLinker} from './partial_linker';\n-import {wrapReference} from './util';\n+import {extractForwardRef, wrapReference} from './util';\n \n /**\n  * A `PartialLinker` that is designed to process `ɵɵngDeclareDirective()` call expressions.\n@@ -140,7 +140,7 @@ function toQueryMetadata<TExpression>(obj: AstObject<R3DeclareQueryMetadata, TEx\n   if (predicateExpr.isArray()) {\n     predicate = predicateExpr.getArray().map(entry => entry.getString());\n   } else {\n-    predicate = predicateExpr.getOpaque();\n+    predicate = extractForwardRef(predicateExpr);\n   }\n   return {\n     propertyName: obj.getString('propertyName'),"
        },
        {
            "sha": "d1c11ccab066a11eb5d79cc292acecf79cd057c8",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_injectable_linker_1.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_injectable_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_injectable_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_injectable_linker_1.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {compileInjectable, ConstantPool, createMayBeForwardRefExpression, outputAst as o, R3DeclareInjectableMetadata, R3InjectableMetadata, R3PartialDeclaration} from '@angular/compiler';\n+import {compileInjectable, ConstantPool, createMayBeForwardRefExpression, ForwardRefHandling, outputAst as o, R3DeclareInjectableMetadata, R3InjectableMetadata, R3PartialDeclaration} from '@angular/compiler';\n \n import {AstObject} from '../../ast/ast_value';\n import {FatalLinkerError} from '../../fatal_linker_error';\n@@ -43,8 +43,9 @@ export function toR3InjectableMeta<TExpression>(\n     type: wrapReference(typeExpr.getOpaque()),\n     internalType: typeExpr.getOpaque(),\n     typeArgumentCount: 0,\n-    providedIn: metaObj.has('providedIn') ? extractForwardRef(metaObj.getValue('providedIn')) :\n-                                            createMayBeForwardRefExpression(o.literal(null), false),\n+    providedIn: metaObj.has('providedIn') ?\n+        extractForwardRef(metaObj.getValue('providedIn')) :\n+        createMayBeForwardRefExpression(o.literal(null), ForwardRefHandling.None),\n   };\n \n   if (metaObj.has('useClass')) {"
        },
        {
            "sha": "c2e4e30c1b979a5f53d21c5e8ce3075a6e7af32b",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/util.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Futil.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {createMayBeForwardRefExpression, MaybeForwardRefExpression, outputAst as o, R3DeclareDependencyMetadata, R3DependencyMetadata, R3Reference} from '@angular/compiler';\n+import {createMayBeForwardRefExpression, ForwardRefHandling, MaybeForwardRefExpression, outputAst as o, R3DeclareDependencyMetadata, R3DependencyMetadata, R3Reference} from '@angular/compiler';\n \n import {AstObject, AstValue} from '../../ast/ast_value';\n import {FatalLinkerError} from '../../fatal_linker_error';\n@@ -68,7 +68,7 @@ export function getDependency<TExpression>(\n export function extractForwardRef<TExpression>(expr: AstValue<unknown, TExpression>):\n     MaybeForwardRefExpression<o.WrappedNodeExpr<TExpression>> {\n   if (!expr.isCallExpression()) {\n-    return createMayBeForwardRefExpression(expr.getOpaque(), /* isForwardRef */ false);\n+    return createMayBeForwardRefExpression(expr.getOpaque(), ForwardRefHandling.None);\n   }\n \n   const callee = expr.getCallee();\n@@ -90,5 +90,6 @@ export function extractForwardRef<TExpression>(expr: AstValue<unknown, TExpressi\n         wrapperFn, 'Unsupported `forwardRef(fn)` call, expected its argument to be a function');\n   }\n \n-  return createMayBeForwardRefExpression(wrapperFn.getFunctionReturnValue().getOpaque(), true);\n+  return createMayBeForwardRefExpression(\n+      wrapperFn.getFunctionReturnValue().getOpaque(), ForwardRefHandling.Unwrapped);\n }"
        },
        {
            "sha": "93beba0793c2ce7c2d4d24b6ff29d2efec08b620",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/directive.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {compileClassMetadata, compileDeclareClassMetadata, compileDeclareDirectiveFromMetadata, compileDirectiveFromMetadata, ConstantPool, emitDistinctChangesOnlyDefaultValue, Expression, ExternalExpr, FactoryTarget, getSafePropertyAccessString, makeBindingParser, ParsedHostBindings, ParseError, parseHostBindings, R3ClassMetadata, R3DirectiveMetadata, R3FactoryMetadata, R3QueryMetadata, Statement, verifyHostBindings, WrappedNodeExpr} from '@angular/compiler';\n+import {compileClassMetadata, compileDeclareClassMetadata, compileDeclareDirectiveFromMetadata, compileDirectiveFromMetadata, ConstantPool, createMayBeForwardRefExpression, emitDistinctChangesOnlyDefaultValue, Expression, ExternalExpr, FactoryTarget, ForwardRefHandling, getSafePropertyAccessString, makeBindingParser, MaybeForwardRefExpression, ParsedHostBindings, ParseError, parseHostBindings, R3ClassMetadata, R3DirectiveMetadata, R3FactoryMetadata, R3QueryMetadata, Statement, verifyHostBindings, WrappedNodeExpr} from '@angular/compiler';\n import ts from 'typescript';\n \n import {ErrorCode, FatalDiagnosticError} from '../../diagnostics';\n@@ -531,17 +531,21 @@ export function extractQueryMetadata(\n         ErrorCode.DECORATOR_ARITY_WRONG, exprNode, `@${name} must have arguments`);\n   }\n   const first = name === 'ViewChild' || name === 'ContentChild';\n-  const node = tryUnwrapForwardRef(args[0], reflector) ?? args[0];\n+  const forwardReferenceTarget = tryUnwrapForwardRef(args[0], reflector);\n+  const node = forwardReferenceTarget ?? args[0];\n+\n   const arg = evaluator.evaluate(node);\n \n   /** Whether or not this query should collect only static results (see view/api.ts)  */\n   let isStatic: boolean = false;\n \n   // Extract the predicate\n-  let predicate: Expression|string[]|null = null;\n+  let predicate: MaybeForwardRefExpression|string[]|null = null;\n   if (arg instanceof Reference || arg instanceof DynamicValue) {\n     // References and predicates that could not be evaluated statically are emitted as is.\n-    predicate = new WrappedNodeExpr(node);\n+    predicate = createMayBeForwardRefExpression(\n+        new WrappedNodeExpr(node),\n+        forwardReferenceTarget !== null ? ForwardRefHandling.Unwrapped : ForwardRefHandling.None);\n   } else if (typeof arg === 'string') {\n     predicate = [arg];\n   } else if (isStringArrayOrDie(arg, `@${name} predicate`, node)) {"
        },
        {
            "sha": "0dee3ae91940fbc18beab8a3c2a8a5aa82f6657b",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/injectable.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {compileClassMetadata, CompileClassMetadataFn, compileDeclareClassMetadata, compileDeclareInjectableFromMetadata, compileInjectable, createMayBeForwardRefExpression, FactoryTarget, LiteralExpr, MaybeForwardRefExpression, R3ClassMetadata, R3CompiledExpression, R3DependencyMetadata, R3InjectableMetadata, WrappedNodeExpr} from '@angular/compiler';\n+import {compileClassMetadata, CompileClassMetadataFn, compileDeclareClassMetadata, compileDeclareInjectableFromMetadata, compileInjectable, createMayBeForwardRefExpression, FactoryTarget, ForwardRefHandling, LiteralExpr, MaybeForwardRefExpression, R3ClassMetadata, R3CompiledExpression, R3DependencyMetadata, R3InjectableMetadata, WrappedNodeExpr} from '@angular/compiler';\n import ts from 'typescript';\n \n import {ErrorCode, FatalDiagnosticError} from '../../diagnostics';\n@@ -162,7 +162,7 @@ function extractInjectableMetadata(\n       type,\n       typeArgumentCount,\n       internalType,\n-      providedIn: createMayBeForwardRefExpression(new LiteralExpr(null), false),\n+      providedIn: createMayBeForwardRefExpression(new LiteralExpr(null), ForwardRefHandling.None),\n     };\n   } else if (decorator.args.length === 1) {\n     const metaNode = decorator.args[0];\n@@ -180,7 +180,7 @@ function extractInjectableMetadata(\n \n     const providedIn = meta.has('providedIn') ?\n         getProviderExpression(meta.get('providedIn')!, reflector) :\n-        createMayBeForwardRefExpression(new LiteralExpr(null), false);\n+        createMayBeForwardRefExpression(new LiteralExpr(null), ForwardRefHandling.None);\n \n     let deps: R3DependencyMetadata[]|undefined = undefined;\n     if ((meta.has('useClass') || meta.has('useFactory')) && meta.has('deps')) {\n@@ -223,7 +223,8 @@ function getProviderExpression(\n     expression: ts.Expression, reflector: ReflectionHost): MaybeForwardRefExpression {\n   const forwardRefValue = tryUnwrapForwardRef(expression, reflector);\n   return createMayBeForwardRefExpression(\n-      new WrappedNodeExpr(forwardRefValue ?? expression), forwardRefValue !== null);\n+      new WrappedNodeExpr(forwardRefValue ?? expression),\n+      forwardRefValue !== null ? ForwardRefHandling.Unwrapped : ForwardRefHandling.None);\n }\n \n function extractInjectableCtorDeps("
        },
        {
            "sha": "02788be8e6a1f3a61d35796815adccf1e010c966",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/queries/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 176,
            "deletions": 0,
            "changes": 176,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2FGOLDEN_PARTIAL.js?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -79,6 +79,92 @@ export declare class MyModule {\n     static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: view_query_forward_ref.js\n+ ****************************************************************************************************/\n+import { Component, Directive, forwardRef, NgModule, ViewChild, ViewChildren } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class ViewQueryComponent {\n+}\n+ViewQueryComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: ViewQueryComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+ViewQueryComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: ViewQueryComponent, selector: \"view-query-component\", viewQueries: [{ propertyName: \"someDir\", first: true, predicate: i0.forwardRef(function () { return SomeDirective; }), descendants: true }, { propertyName: \"someDirList\", predicate: i0.forwardRef(function () { return SomeDirective; }), descendants: true }], ngImport: i0, template: `\n+    <div someDir></div>\n+  `, isInline: true, directives: [{ type: i0.forwardRef(function () { return SomeDirective; }), selector: \"[someDir]\" }] });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: ViewQueryComponent, decorators: [{\n+            type: Component,\n+            args: [{\n+                    selector: 'view-query-component',\n+                    template: `\n+    <div someDir></div>\n+  `\n+                }]\n+        }], propDecorators: { someDir: [{\n+                type: ViewChild,\n+                args: [forwardRef(() => SomeDirective)]\n+            }], someDirList: [{\n+                type: ViewChildren,\n+                args: [forwardRef(() => SomeDirective)]\n+            }] } });\n+export class MyApp {\n+}\n+MyApp.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: `\n+    <view-query-component></view-query-component>\n+  `, isInline: true, components: [{ type: ViewQueryComponent, selector: \"view-query-component\" }] });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, decorators: [{\n+            type: Component,\n+            args: [{\n+                    selector: 'my-app',\n+                    template: `\n+    <view-query-component></view-query-component>\n+  `\n+                }]\n+        }] });\n+export class SomeDirective {\n+}\n+SomeDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: SomeDirective, deps: [], target: i0.ɵɵFactoryTarget.Directive });\n+SomeDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: SomeDirective, selector: \"[someDir]\", ngImport: i0 });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: SomeDirective, decorators: [{\n+            type: Directive,\n+            args: [{\n+                    selector: '[someDir]',\n+                }]\n+        }] });\n+export class MyModule {\n+}\n+MyModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\n+MyModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, declarations: [SomeDirective, ViewQueryComponent, MyApp] });\n+MyModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{ declarations: [SomeDirective, ViewQueryComponent, MyApp] }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: view_query_forward_ref.d.ts\n+ ****************************************************************************************************/\n+import { QueryList } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export declare class ViewQueryComponent {\n+    someDir: SomeDirective;\n+    someDirList: QueryList<SomeDirective>;\n+    static ɵfac: i0.ɵɵFactoryDeclaration<ViewQueryComponent, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<ViewQueryComponent, \"view-query-component\", never, {}, {}, never, never>;\n+}\n+export declare class MyApp {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyApp, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<MyApp, \"my-app\", never, {}, {}, never, never>;\n+}\n+export declare class SomeDirective {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<SomeDirective, never>;\n+    static ɵdir: i0.ɵɵDirectiveDeclaration<SomeDirective, \"[someDir]\", never, {}, {}, never>;\n+}\n+export declare class MyModule {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyModule, never>;\n+    static ɵmod: i0.ɵɵNgModuleDeclaration<MyModule, [typeof SomeDirective, typeof ViewQueryComponent, typeof MyApp], never, never>;\n+    static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n+}\n+\n /****************************************************************************************************\n  * PARTIAL FILE: view_query_for_local_ref.js\n  ****************************************************************************************************/\n@@ -410,6 +496,96 @@ export declare class MyModule {\n     static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: content_query_forward_ref.js\n+ ****************************************************************************************************/\n+import { Component, ContentChild, ContentChildren, Directive, forwardRef, NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class ContentQueryComponent {\n+}\n+ContentQueryComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: ContentQueryComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+ContentQueryComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: ContentQueryComponent, selector: \"content-query-component\", queries: [{ propertyName: \"someDir\", first: true, predicate: i0.forwardRef(function () { return SomeDirective; }), descendants: true }, { propertyName: \"someDirList\", predicate: i0.forwardRef(function () { return SomeDirective; }) }], ngImport: i0, template: `\n+    <div><ng-content></ng-content></div>\n+  `, isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: ContentQueryComponent, decorators: [{\n+            type: Component,\n+            args: [{\n+                    selector: 'content-query-component',\n+                    template: `\n+    <div><ng-content></ng-content></div>\n+  `\n+                }]\n+        }], propDecorators: { someDir: [{\n+                type: ContentChild,\n+                args: [forwardRef(() => SomeDirective)]\n+            }], someDirList: [{\n+                type: ContentChildren,\n+                args: [forwardRef(() => SomeDirective)]\n+            }] } });\n+export class MyApp {\n+}\n+MyApp.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: `\n+    <content-query-component>\n+      <div someDir></div>\n+    </content-query-component>\n+  `, isInline: true, components: [{ type: i0.forwardRef(function () { return ContentQueryComponent; }), selector: \"content-query-component\" }], directives: [{ type: i0.forwardRef(function () { return SomeDirective; }), selector: \"[someDir]\" }] });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, decorators: [{\n+            type: Component,\n+            args: [{\n+                    selector: 'my-app',\n+                    template: `\n+    <content-query-component>\n+      <div someDir></div>\n+    </content-query-component>\n+  `\n+                }]\n+        }] });\n+export class SomeDirective {\n+}\n+SomeDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: SomeDirective, deps: [], target: i0.ɵɵFactoryTarget.Directive });\n+SomeDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: SomeDirective, selector: \"[someDir]\", ngImport: i0 });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: SomeDirective, decorators: [{\n+            type: Directive,\n+            args: [{\n+                    selector: '[someDir]',\n+                }]\n+        }] });\n+export class MyModule {\n+}\n+MyModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\n+MyModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, declarations: [SomeDirective, ContentQueryComponent, MyApp] });\n+MyModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{ declarations: [SomeDirective, ContentQueryComponent, MyApp] }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: content_query_forward_ref.d.ts\n+ ****************************************************************************************************/\n+import { QueryList } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export declare class ContentQueryComponent {\n+    someDir: SomeDirective;\n+    someDirList: QueryList<SomeDirective>;\n+    static ɵfac: i0.ɵɵFactoryDeclaration<ContentQueryComponent, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<ContentQueryComponent, \"content-query-component\", never, {}, {}, [\"someDir\", \"someDirList\"], [\"*\"]>;\n+}\n+export declare class MyApp {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyApp, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<MyApp, \"my-app\", never, {}, {}, never, never>;\n+}\n+export declare class SomeDirective {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<SomeDirective, never>;\n+    static ɵdir: i0.ɵɵDirectiveDeclaration<SomeDirective, \"[someDir]\", never, {}, {}, never>;\n+}\n+export declare class MyModule {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyModule, never>;\n+    static ɵmod: i0.ɵɵNgModuleDeclaration<MyModule, [typeof SomeDirective, typeof ContentQueryComponent, typeof MyApp], never, never>;\n+    static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n+}\n+\n /****************************************************************************************************\n  * PARTIAL FILE: content_query_for_local_ref.js\n  ****************************************************************************************************/"
        },
        {
            "sha": "8978b21dc51abda1f70122c0c532282b1118a8f1",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/queries/TEST_CASES.json",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2FTEST_CASES.json?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -16,6 +16,20 @@\n         }\n       ]\n     },\n+    {\n+      \"description\": \"should support view queries with forwardRefs\",\n+      \"inputFiles\": [\n+        \"view_query_forward_ref.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"failureMessage\": \"Invalid ViewQuery declaration\",\n+          \"files\": [\n+            \"view_query_forward_ref.js\"\n+          ]\n+        }\n+      ]\n+    },\n     {\n       \"description\": \"should support view queries with local refs\",\n       \"inputFiles\": [\n@@ -75,6 +89,20 @@\n         }\n       ]\n     },\n+    {\n+      \"description\": \"should support content queries with forwardRefs\",\n+      \"inputFiles\": [\n+        \"content_query_forward_ref.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"failureMessage\": \"Invalid ContentQuery declaration\",\n+          \"files\": [\n+            \"content_query_forward_ref.js\"\n+          ]\n+        }\n+      ]\n+    },\n     {\n       \"description\": \"should support content queries with local refs\",\n       \"inputFiles\": ["
        },
        {
            "sha": "a5fb6aa5c19ade0fb9b8c6886377c9415ca74039",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/queries/content_query_forward_ref.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fcontent_query_forward_ref.js",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fcontent_query_forward_ref.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fcontent_query_forward_ref.js?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -0,0 +1,27 @@\n+ContentQueryComponent.ɵcmp = /*@__PURE__*/ $r3$.ɵɵdefineComponent({\n+  type: ContentQueryComponent,\n+  selectors: [[\"content-query-component\"]],\n+  contentQueries: function ContentQueryComponent_ContentQueries(rf, ctx, dirIndex) {\n+    if (rf & 1) {\n+      $r3$.ɵɵcontentQuery(dirIndex, SomeDirective, __QueryFlags.descendants__|__QueryFlags.emitDistinctChangesOnly__);\n+      $r3$.ɵɵcontentQuery(dirIndex, SomeDirective, __QueryFlags.emitDistinctChangesOnly__);\n+    }\n+    if (rf & 2) {\n+      let $tmp$;\n+      $r3$.ɵɵqueryRefresh($tmp$ = $r3$.ɵɵloadQuery()) && (ctx.someDir = $tmp$.first);\n+      $r3$.ɵɵqueryRefresh($tmp$ = $r3$.ɵɵloadQuery()) && (ctx.someDirList = $tmp$);\n+    }\n+  },\n+  ngContentSelectors: _c0,\n+  decls: 2,\n+  vars: 0,\n+  template: function ContentQueryComponent_Template(rf, ctx) {\n+    if (rf & 1) {\n+      $r3$.ɵɵprojectionDef();\n+      $r3$.ɵɵelementStart(0, \"div\");\n+      $r3$.ɵɵprojection(1);\n+      $r3$.ɵɵelementEnd();\n+    }\n+  },\n+  encapsulation: 2\n+});"
        },
        {
            "sha": "73fe0170ea8e58cea373e27d65d3ece7c2e98bb1",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/queries/content_query_forward_ref.ts",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fcontent_query_forward_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fcontent_query_forward_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fcontent_query_forward_ref.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -0,0 +1,34 @@\n+import {Component, ContentChild, ContentChildren, Directive, forwardRef, NgModule, QueryList} from '@angular/core';\n+\n+@Component({\n+  selector: 'content-query-component',\n+  template: `\n+    <div><ng-content></ng-content></div>\n+  `\n+})\n+export class ContentQueryComponent {\n+  @ContentChild(forwardRef(() => SomeDirective)) someDir!: SomeDirective;\n+  @ContentChildren(forwardRef(() => SomeDirective)) someDirList!: QueryList<SomeDirective>;\n+}\n+\n+@Component({\n+  selector: 'my-app',\n+  template: `\n+    <content-query-component>\n+      <div someDir></div>\n+    </content-query-component>\n+  `\n+})\n+export class MyApp {\n+}\n+\n+\n+@Directive({\n+  selector: '[someDir]',\n+})\n+export class SomeDirective {\n+}\n+\n+@NgModule({declarations: [SomeDirective, ContentQueryComponent, MyApp]})\n+export class MyModule {\n+}"
        },
        {
            "sha": "6f04af70e9cbe934887437bf3b4c79073d3b8e89",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/queries/view_query_forward_ref.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fview_query_forward_ref.js",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fview_query_forward_ref.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fview_query_forward_ref.js?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -0,0 +1,16 @@\n+ViewQueryComponent.ɵcmp = /*@__PURE__*/ $r3$.ɵɵdefineComponent({\n+  type: ViewQueryComponent,\n+  selectors: [[\"view-query-component\"]],\n+  viewQuery: function ViewQueryComponent_Query(rf, ctx) {\n+    if (rf & 1) {\n+      $r3$.ɵɵviewQuery(SomeDirective, __QueryFlags.descendants__|__QueryFlags.emitDistinctChangesOnly__);\n+      $r3$.ɵɵviewQuery(SomeDirective, __QueryFlags.descendants__|__QueryFlags.emitDistinctChangesOnly__);\n+    }\n+    if (rf & 2) {\n+      let $tmp$;\n+      $r3$.ɵɵqueryRefresh($tmp$ = $r3$.ɵɵloadQuery()) && (ctx.someDir = $tmp$.first);\n+      $r3$.ɵɵqueryRefresh($tmp$ = $r3$.ɵɵloadQuery()) && (ctx.someDirList = $tmp$);\n+    }\n+  },\n+  // ...\n+});"
        },
        {
            "sha": "c6acd8409dbaad7df4eeda68a33e3ce48073327e",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/queries/view_query_forward_ref.ts",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fview_query_forward_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fview_query_forward_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2Fview_query_forward_ref.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -0,0 +1,32 @@\n+import {Component, Directive, forwardRef, NgModule, QueryList, ViewChild, ViewChildren} from '@angular/core';\n+\n+@Component({\n+  selector: 'view-query-component',\n+  template: `\n+    <div someDir></div>\n+  `\n+})\n+export class ViewQueryComponent {\n+  @ViewChild(forwardRef(() => SomeDirective)) someDir!: SomeDirective;\n+  @ViewChildren(forwardRef(() => SomeDirective)) someDirList!: QueryList<SomeDirective>;\n+}\n+\n+@Component({\n+  selector: 'my-app',\n+  template: `\n+    <view-query-component></view-query-component>\n+  `\n+})\n+export class MyApp {\n+}\n+\n+\n+@Directive({\n+  selector: '[someDir]',\n+})\n+export class SomeDirective {\n+}\n+\n+@NgModule({declarations: [SomeDirective, ViewQueryComponent, MyApp]})\n+export class MyModule {\n+}"
        },
        {
            "sha": "01db7147834318bc97ebeb2be5d5e7759a0b74fb",
            "filename": "packages/compiler/src/compiler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -103,7 +103,7 @@ export {compileNgModule, R3NgModuleMetadata} from './render3/r3_module_compiler'\n export {compileInjector, R3InjectorMetadata} from './render3/r3_injector_compiler';\n export {compilePipeFromMetadata, R3PipeMetadata} from './render3/r3_pipe_compiler';\n export {makeBindingParser, ParsedTemplate, parseTemplate, ParseTemplateOptions} from './render3/view/template';\n-export {MaybeForwardRefExpression, R3CompiledExpression, R3Reference, createMayBeForwardRefExpression, devOnlyGuardedExpression, getSafePropertyAccessString} from './render3/util';\n+export {ForwardRefHandling, MaybeForwardRefExpression, R3CompiledExpression, R3Reference, createMayBeForwardRefExpression, devOnlyGuardedExpression, getSafePropertyAccessString} from './render3/util';\n export {compileComponentFromMetadata, compileDirectiveFromMetadata, parseHostBindings, ParsedHostBindings, verifyHostBindings} from './render3/view/compiler';\n export {compileDeclareClassMetadata} from './render3/partial/class_metadata';\n export {compileDeclareComponentFromMetadata, DeclareComponentTemplateInfo} from './render3/partial/component';"
        },
        {
            "sha": "897a2134fc45b266c70864a25cadad53ab69c4ca",
            "filename": "packages/compiler/src/injectable_compiler_2.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Finjectable_compiler_2.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Finjectable_compiler_2.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Finjectable_compiler_2.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -9,7 +9,7 @@\n import * as o from './output/output_ast';\n import {compileFactoryFunction, FactoryTarget, R3DependencyMetadata, R3FactoryDelegateType, R3FactoryMetadata} from './render3/r3_factory';\n import {Identifiers} from './render3/r3_identifiers';\n-import {generateForwardRef, MaybeForwardRefExpression, R3CompiledExpression, R3Reference, typeWithParameters} from './render3/util';\n+import {convertFromMaybeForwardRefExpression, ForwardRefHandling, generateForwardRef, MaybeForwardRefExpression, R3CompiledExpression, R3Reference, typeWithParameters} from './render3/util';\n import {DefinitionMap} from './render3/view/util';\n \n export interface R3InjectableMetadata {\n@@ -116,10 +116,7 @@ export function compileInjectable(\n \n   // Only generate providedIn property if it has a non-null value\n   if ((meta.providedIn.expression as o.LiteralExpr).value !== null) {\n-    injectableProps.set(\n-        'providedIn',\n-        meta.providedIn.isForwardRef ? generateForwardRef(meta.providedIn.expression) :\n-                                       meta.providedIn.expression);\n+    injectableProps.set('providedIn', convertFromMaybeForwardRefExpression(meta.providedIn));\n   }\n \n   const expression = o.importExpr(Identifiers.ɵɵdefineInjectable)"
        },
        {
            "sha": "527583e0d790e9307ca3e1d21f0a3fcf09e91eae",
            "filename": "packages/compiler/src/jit_compiler_facade.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 9,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -20,12 +20,13 @@ import {compileInjector, R3InjectorMetadata} from './render3/r3_injector_compile\n import {R3JitReflector} from './render3/r3_jit';\n import {compileNgModule, compileNgModuleDeclarationExpression, R3NgModuleMetadata} from './render3/r3_module_compiler';\n import {compilePipeFromMetadata, R3PipeMetadata} from './render3/r3_pipe_compiler';\n-import {createMayBeForwardRefExpression, getSafePropertyAccessString, MaybeForwardRefExpression, wrapReference} from './render3/util';\n+import {createMayBeForwardRefExpression, ForwardRefHandling, getSafePropertyAccessString, MaybeForwardRefExpression, wrapReference} from './render3/util';\n import {DeclarationListEmitMode, R3ComponentMetadata, R3DirectiveMetadata, R3HostMetadata, R3QueryMetadata, R3UsedDirectiveMetadata} from './render3/view/api';\n import {compileComponentFromMetadata, compileDirectiveFromMetadata, ParsedHostBindings, parseHostBindings, verifyHostBindings} from './render3/view/compiler';\n import {makeBindingParser, parseTemplate} from './render3/view/template';\n import {ResourceLoader} from './resource_loader';\n import {DomElementSchemaRegistry} from './schema/dom_element_schema_registry';\n+import {resolveForwardRef} from './util';\n \n export class CompilerFacadeImpl implements CompilerFacade {\n   FactoryTarget = FactoryTarget as any;\n@@ -293,8 +294,7 @@ const USE_EXISTING = Object.keys({useExisting: null})[0];\n function convertToR3QueryMetadata(facade: R3QueryMetadataFacade): R3QueryMetadata {\n   return {\n     ...facade,\n-    predicate: Array.isArray(facade.predicate) ? facade.predicate :\n-                                                 new WrappedNodeExpr(facade.predicate),\n+    predicate: convertQueryPredicate(facade.predicate),\n     read: facade.read ? new WrappedNodeExpr(facade.read) : null,\n     static: facade.static,\n     emitDistinctChangesOnly: facade.emitDistinctChangesOnly,\n@@ -306,15 +306,23 @@ function convertQueryDeclarationToMetadata(declaration: R3DeclareQueryMetadataFa\n   return {\n     propertyName: declaration.propertyName,\n     first: declaration.first ?? false,\n-    predicate: Array.isArray(declaration.predicate) ? declaration.predicate :\n-                                                      new WrappedNodeExpr(declaration.predicate),\n+    predicate: convertQueryPredicate(declaration.predicate),\n     descendants: declaration.descendants ?? false,\n     read: declaration.read ? new WrappedNodeExpr(declaration.read) : null,\n     static: declaration.static ?? false,\n     emitDistinctChangesOnly: declaration.emitDistinctChangesOnly ?? true,\n   };\n }\n \n+function convertQueryPredicate(predicate: OpaqueValue|string[]): MaybeForwardRefExpression|\n+    string[] {\n+  return Array.isArray(predicate) ?\n+      // The predicate is an array of strings so pass it through.\n+      predicate :\n+      // The predicate is a type - assume that we will need to unwrap any `forwardRef()` calls.\n+      createMayBeForwardRefExpression(new WrappedNodeExpr(predicate), ForwardRefHandling.Wrapped);\n+}\n+\n function convertDirectiveFacadeToMetadata(facade: R3DirectiveMetadataFacade): R3DirectiveMetadata {\n   const inputsFromMetadata = parseInputOutputs(facade.inputs || []);\n   const outputsFromMetadata = parseInputOutputs(facade.outputs || []);\n@@ -475,13 +483,13 @@ type R3DirectiveMetadataFacadeNoPropAndWhitespace =\n  * In JIT mode we do not want the compiler to wrap the expression in a `forwardRef()` call because,\n  * if it is referencing a type that has not yet been defined, it will have already been wrapped in\n  * a `forwardRef()` - either by the application developer or during partial-compilation. Thus we can\n- * set `isForwardRef` to `false`.\n+ * use `ForwardRefHandling.None`.\n  */\n function convertToProviderExpression(obj: any, property: string): MaybeForwardRefExpression|\n     undefined {\n   if (obj.hasOwnProperty(property)) {\n     return createMayBeForwardRefExpression(\n-        new WrappedNodeExpr(obj[property]), /* isForwardRef */ false);\n+        new WrappedNodeExpr(obj[property]), ForwardRefHandling.None);\n   } else {\n     return undefined;\n   }\n@@ -498,8 +506,8 @@ function wrapExpression(obj: any, property: string): WrappedNodeExpr<any>|undefi\n function computeProvidedIn(providedIn: Function|string|null|undefined): MaybeForwardRefExpression {\n   const expression = typeof providedIn === 'function' ? new WrappedNodeExpr(providedIn) :\n                                                         new LiteralExpr(providedIn ?? null);\n-  // See `convertToProviderExpression()` for why `isForwardRef` is false.\n-  return createMayBeForwardRefExpression(expression, /* isForwardRef */ false);\n+  // See `convertToProviderExpression()` for why this uses `ForwardRefHandling.None`.\n+  return createMayBeForwardRefExpression(expression, ForwardRefHandling.None);\n }\n \n function convertR3DependencyMetadataArray(facades: R3DependencyMetadataFacade[]|null|"
        },
        {
            "sha": "3009c773715bcba97afcc3ec1eecb5e89ee5b9d2",
            "filename": "packages/compiler/src/render3/partial/api.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -233,8 +233,8 @@ export interface R3DeclareQueryMetadata {\n   first?: boolean;\n \n   /**\n-   * Either an expression representing a type or `InjectionToken` for the query\n-   * predicate, or a set of string selectors.\n+   * Either an expression representing a type (possibly wrapped in a `forwardRef()`) or\n+   * `InjectionToken` for the query predicate, or a set of string selectors.\n    */\n   predicate: o.Expression|string[];\n "
        },
        {
            "sha": "1ffac2e8b6aca7e4d4aa768e7a16234db68be10b",
            "filename": "packages/compiler/src/render3/partial/directive.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fdirective.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fdirective.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fdirective.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -7,7 +7,7 @@\n  */\n import * as o from '../../output/output_ast';\n import {Identifiers as R3} from '../r3_identifiers';\n-import {R3CompiledExpression} from '../util';\n+import {convertFromMaybeForwardRefExpression, R3CompiledExpression} from '../util';\n import {R3DirectiveMetadata, R3HostMetadata, R3QueryMetadata} from '../view/api';\n import {createDirectiveType} from '../view/compiler';\n import {asLiteral, conditionallyCreateMapObjectLiteral, DefinitionMap} from '../view/util';\n@@ -96,7 +96,9 @@ function compileQuery(query: R3QueryMetadata): o.LiteralMapExpr {\n     meta.set('first', o.literal(true));\n   }\n   meta.set(\n-      'predicate', Array.isArray(query.predicate) ? asLiteral(query.predicate) : query.predicate);\n+      'predicate',\n+      Array.isArray(query.predicate) ? asLiteral(query.predicate) :\n+                                       convertFromMaybeForwardRefExpression(query.predicate));\n   if (!query.emitDistinctChangesOnly) {\n     // `emitDistinctChangesOnly` is special because we expect it to be `true`.\n     // Therefore we explicitly emit the field, and explicitly place it only when it's `false`."
        },
        {
            "sha": "a7c30c3fe9cd9d49939d11f0debb62461e7f5a40",
            "filename": "packages/compiler/src/render3/util.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 24,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Frender3%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Frender3%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Futil.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -94,48 +94,52 @@ export interface MaybeForwardRefExpression<T extends o.Expression = o.Expression\n    */\n   expression: T;\n   /**\n-   * If true, then the `expression` contains a reference to something that has not yet been\n-   * defined.\n+   * Specified whether the `expression` contains a reference to something that has not yet been\n+   * defined, and whether the expression is still wrapped in a `forwardRef()` call.\n    *\n-   * This means that the expression must not be eagerly evaluated. Instead it must be wrapped in a\n-   * function closure that will be evaluated lazily to allow the definition of the expression to be\n-   * evaluated first.\n+   * If this value is `ForwardRefHandling.None` then the `expression` is safe to use as-is.\n    *\n-   * In some cases the expression will naturally be placed inside such a function closure, such as\n-   * in a fully compiled factory function. In those cases nothing more needs to be done.\n+   * Otherwise the `expression` was wrapped in a call to `forwardRef()` and must not be eagerly\n+   * evaluated. Instead it must be wrapped in a function closure that will be evaluated lazily to\n+   * allow the definition of the expression to be evaluated first.\n+   *\n+   * In full AOT compilation it can be safe to unwrap the `forwardRef()` call up front if the\n+   * expression will actually be evaluated lazily inside a function call after the value of\n+   * `expression` has been defined.\n+   *\n+   * But in other cases, such as partial AOT compilation or JIT compilation the expression will be\n+   * evaluated eagerly in top level code so will need to continue to be wrapped in a `forwardRef()`\n+   * call.\n    *\n-   * But in other cases, such as partial-compilation the expression will be located in top level\n-   * code so will need to be wrapped in a function that is passed to a `forwardRef()` call.\n    */\n-  isForwardRef: boolean;\n+  forwardRef: ForwardRefHandling;\n }\n \n export function createMayBeForwardRefExpression<T extends o.Expression>(\n-    expression: T, isForwardRef: boolean): MaybeForwardRefExpression<T> {\n-  return {expression, isForwardRef};\n+    expression: T, forwardRef: ForwardRefHandling): MaybeForwardRefExpression<T> {\n+  return {expression, forwardRef};\n }\n \n /**\n  * Convert a `MaybeForwardRefExpression` to an `Expression`, possibly wrapping its expression in a\n  * `forwardRef()` call.\n  *\n- * If `MaybeForwardRefExpression.isForwardRef` is true then the expression was originally wrapped in\n- * a `forwardRef()` call to prevent the value from being eagerly evaluated in the code.\n- *\n- * Normally, the linker will statically process the code, putting the `expression` inside a factory\n- * function so the `forwardRef()` wrapper is not evaluated before it has been defined. But if the\n- * partial declaration is evaluated by the JIT compiler the `forwardRef()` call is still needed to\n- * prevent eager evaluation of the `expression`.\n- *\n- * So in partial declarations, expressions that could be forward-refs are wrapped in `forwardRef()`\n- * calls, and this is then unwrapped in the linker as necessary.\n+ * If `MaybeForwardRefExpression.forwardRef` is `ForwardRefHandling.Unwrapped` then the expression\n+ * was originally wrapped in a `forwardRef()` call to prevent the value from being eagerly evaluated\n+ * in the code.\n  *\n  * See `packages/compiler-cli/src/ngtsc/annotations/src/injectable.ts` and\n  * `packages/compiler/src/jit_compiler_facade.ts` for more information.\n  */\n export function convertFromMaybeForwardRefExpression(\n-    {expression, isForwardRef}: MaybeForwardRefExpression): o.Expression {\n-  return isForwardRef ? generateForwardRef(expression) : expression;\n+    {expression, forwardRef}: MaybeForwardRefExpression): o.Expression {\n+  switch (forwardRef) {\n+    case ForwardRefHandling.None:\n+    case ForwardRefHandling.Wrapped:\n+      return expression;\n+    case ForwardRefHandling.Unwrapped:\n+      return generateForwardRef(expression);\n+  }\n }\n \n /**\n@@ -148,3 +152,15 @@ export function convertFromMaybeForwardRefExpression(\n export function generateForwardRef(expr: o.Expression): o.Expression {\n   return o.importExpr(Identifiers.forwardRef).callFn([o.fn([], [new o.ReturnStatement(expr)])]);\n }\n+\n+/**\n+ * Specifies how a forward ref has been handled in a MaybeForwardRefExpression\n+ */\n+export const enum ForwardRefHandling {\n+  /** The expression was not wrapped in a `forwardRef()` call in the first place. */\n+  None,\n+  /** The expression is still wrapped in a `forwardRef()` call. */\n+  Wrapped,\n+  /** The expression was wrapped in a `forwardRef()` call but has since been unwrapped. */\n+  Unwrapped,\n+}"
        },
        {
            "sha": "64c7cc29efe8b76baf5414b7a9c019da698550dd",
            "filename": "packages/compiler/src/render3/view/api.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fapi.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -12,7 +12,7 @@ import * as o from '../../output/output_ast';\n import {ParseSourceSpan} from '../../parse_util';\n import * as t from '../r3_ast';\n import {R3DependencyMetadata} from '../r3_factory';\n-import {R3Reference} from '../util';\n+import {MaybeForwardRefExpression, R3Reference} from '../util';\n \n \n /**\n@@ -302,7 +302,7 @@ export interface R3QueryMetadata {\n    * Either an expression representing a type or `InjectionToken` for the query\n    * predicate, or a set of string selectors.\n    */\n-  predicate: o.Expression|string[];\n+  predicate: MaybeForwardRefExpression|string[];\n \n   /**\n    * Whether to include only direct children or all descendants."
        },
        {
            "sha": "f9685832bfc301bf2cf927cd9bd0269e6d50641f",
            "filename": "packages/compiler/src/render3/view/util.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Futil.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -12,6 +12,8 @@ import * as o from '../../output/output_ast';\n import {ParseSourceSpan} from '../../parse_util';\n import {splitAtColon} from '../../util';\n import * as t from '../r3_ast';\n+import {Identifiers as R3} from '../r3_identifiers';\n+import {ForwardRefHandling} from '../util';\n \n import {R3QueryMetadata} from './api';\n import {isI18nAttribute} from './i18n/util';\n@@ -148,7 +150,14 @@ export function getQueryPredicate(\n     });\n     return constantPool.getConstLiteral(o.literalArr(predicate), true);\n   } else {\n-    return query.predicate;\n+    // The original predicate may have been wrapped in a `forwardRef()` call.\n+    switch (query.predicate.forwardRef) {\n+      case ForwardRefHandling.None:\n+      case ForwardRefHandling.Unwrapped:\n+        return query.predicate.expression;\n+      case ForwardRefHandling.Wrapped:\n+        return o.importExpr(R3.resolveForwardRef).callFn([query.predicate.expression]);\n+    }\n   }\n }\n "
        },
        {
            "sha": "1567bd58d8f8af60706b5c5843e390b1c07fe95f",
            "filename": "packages/core/test/render3/jit/declare_directive_spec.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 1,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_directive_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/393efa54e669c4ae1e479fd59fc4f9ea69ab77e9/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_directive_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_directive_spec.ts?ref=393efa54e669c4ae1e479fd59fc4f9ea69ab77e9",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ElementRef, ɵɵngDeclareDirective} from '@angular/core';\n+import {ElementRef, forwardRef, ɵɵngDeclareDirective} from '@angular/core';\n import {AttributeMarker, DirectiveDef} from '../../../src/render3';\n import {functionContaining} from './matcher';\n \n@@ -116,6 +116,27 @@ describe('directive declaration jit compilation', () => {\n     });\n   });\n \n+  it('should compile content queries with forwardRefs', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                  queries: [\n+                    {\n+                      propertyName: 'byRef',\n+                      predicate: forwardRef(() => Child),\n+                    },\n+                  ],\n+                }) as DirectiveDef<TestClass>;\n+\n+    class Child {}\n+\n+    expectDirectiveDef(def, {\n+      contentQueries: functionContaining([\n+        /contentQuery[^(]*\\(dirIndex,[^,]*resolveForwardRef[^,]*forward_ref[^,]*,[\\s]*4\\)/,\n+        '(ctx.byRef = _t)',\n+      ]),\n+    });\n+  });\n+\n   it('should compile view queries', () => {\n     const def = ɵɵngDeclareDirective({\n                   type: TestClass,\n@@ -152,6 +173,27 @@ describe('directive declaration jit compilation', () => {\n     });\n   });\n \n+  it('should compile view queries with forwardRefs', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                  viewQueries: [\n+                    {\n+                      propertyName: 'byRef',\n+                      predicate: forwardRef(() => Child),\n+                    },\n+                  ],\n+                }) as DirectiveDef<TestClass>;\n+\n+    class Child {}\n+\n+    expectDirectiveDef(def, {\n+      viewQuery: functionContaining([\n+        /viewQuery[^(]*\\([^,]*resolveForwardRef[^,]*forward_ref[^,]*,[\\s]*4\\)/,\n+        '(ctx.byRef = _t)',\n+      ]),\n+    });\n+  });\n+\n   it('should compile host bindings', () => {\n     const def = ɵɵngDeclareDirective({\n                   type: TestClass,"
        }
    ],
    "stats": {
        "total": 530,
        "additions": 462,
        "deletions": 68
    }
}