{
    "author": "petebacondarwin",
    "message": "build(docs-infra): fail if there are unused example regions (#40479)\n\nWe can define regions in our examples that can be referenced\nand rendered in guides as code snippets. It is quite hard to ensure\nthat these regions are maintained correctly. One reason for this is\nit is hard to know whether a region is being used or not.\n\nThis commit adds a new processor that checks for unused named\nregions in examples and fails if any are found.\n\nFixes #19761\n\nPR Close #40479",
    "sha": "fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5",
    "files": [
        {
            "sha": "890b48066888ef66ace6d2def8358e6d3f05dcab",
            "filename": "aio/tools/transforms/angular-base-package/index.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js",
            "raw_url": "https://github.com/angular/angular/raw/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js?ref=fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5",
            "patch": "@@ -53,10 +53,11 @@ module.exports = new Package('angular-base', [\n     inlineTagProcessor.inlineTagDefinitions.push(require('./inline-tag-defs/custom-search-defs/'));\n   })\n \n-  .config(function(checkAnchorLinksProcessor) {\n-    // This is disabled here to prevent false negatives for the `docs-watch` task.\n+  .config(function(checkAnchorLinksProcessor, checkForUnusedExampleRegions) {\n+    // These are disabled here to prevent false negatives for the `docs-watch` task.\n     // It is re-enabled in the main `angular.io-package`\n     checkAnchorLinksProcessor.$enabled = false;\n+    checkForUnusedExampleRegions.$enabled = false;\n   })\n \n   // Where do we get the source files?"
        },
        {
            "sha": "dd53e65985a1e484cc45c05802cf3a0278d8eea3",
            "filename": "aio/tools/transforms/angular.io-package/index.js",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fangular.io-package%2Findex.js",
            "raw_url": "https://github.com/angular/angular/raw/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fangular.io-package%2Findex.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular.io-package%2Findex.js?ref=fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5",
            "patch": "@@ -29,6 +29,12 @@ module.exports = new Package('angular.io', [gitPackage, apiPackage, contentPacka\n     renderDocsProcessor.extraData.versionInfo = versionInfo;\n   })\n \n+  .config(function(checkForUnusedExampleRegions) {\n+    // Re-enable this processor that was disabled in the `angular-base` package to\n+    // avoid running it during `serve-and-sync` runs.\n+    checkForUnusedExampleRegions.$enabled = true;\n+  })\n+\n   .config(function(checkAnchorLinksProcessor, linkInlineTagDef, renderExamples) {\n \n     // Fail the processing if there is an invalid link"
        },
        {
            "sha": "39da1cb346c61f4ee59d42fc0ed958a06bdbfcb9",
            "filename": "aio/tools/transforms/examples-package/index.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fexamples-package%2Findex.js",
            "raw_url": "https://github.com/angular/angular/raw/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fexamples-package%2Findex.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fexamples-package%2Findex.js?ref=fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5",
            "patch": "@@ -13,6 +13,7 @@ module.exports =\n \n         .processor(require('./processors/collect-examples'))\n         .processor(require('./processors/render-examples'))\n+        .processor(require('./processors/check-for-unused-example-regions'))\n \n         .config(function(readFilesProcessor, exampleFileReader) {\n           readFilesProcessor.fileReaders.push(exampleFileReader);"
        },
        {
            "sha": "f94b4d78c7351441b9b0da6c0950c64b4512a5c9",
            "filename": "aio/tools/transforms/examples-package/processors/check-for-unused-example-regions.js",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fprocessors%2Fcheck-for-unused-example-regions.js",
            "raw_url": "https://github.com/angular/angular/raw/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fprocessors%2Fcheck-for-unused-example-regions.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fprocessors%2Fcheck-for-unused-example-regions.js?ref=fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5",
            "patch": "@@ -0,0 +1,38 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * A processor that will fail if there are named example regions that are not used in any docs.\n+ *\n+ * @param {*} exampleMap - contains all the regions extracted from example files.\n+ */\n+module.exports = function checkForUnusedExampleRegions(exampleMap) {\n+  return {\n+    $runAfter: ['renderExamples'],\n+    $runBefore: ['writing-files'],\n+    $process() {\n+      const unusedExampleRegions = [];\n+      for (const exampleFolder of Object.values(exampleMap)) {\n+        for (const exampleFile of Object.values(exampleFolder)) {\n+          for (const [regionName, region] of Object.entries(exampleFile.regions)) {\n+            if (regionName === '' || region.usedInDoc) continue;\n+            unusedExampleRegions.push(region);\n+          }\n+        }\n+      }\n+\n+      if (unusedExampleRegions.length > 0) {\n+        const message = (unusedExampleRegions.length === 1 ?\n+                             'There is 1 unused example region:\\n' :\n+                             `There are ${unusedExampleRegions.length} unused example regions:\\n`) +\n+            unusedExampleRegions.map(region => ` - ${region.id}`).join('\\n');\n+        throw new Error(message);\n+      }\n+    },\n+  };\n+};"
        },
        {
            "sha": "56021e38b2ef44f0a3da9278366ccb2180492263",
            "filename": "aio/tools/transforms/examples-package/processors/check-for-unused-example-regions.spec.js",
            "status": "added",
            "additions": 77,
            "deletions": 0,
            "changes": 77,
            "blob_url": "https://github.com/angular/angular/blob/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fprocessors%2Fcheck-for-unused-example-regions.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fprocessors%2Fcheck-for-unused-example-regions.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fprocessors%2Fcheck-for-unused-example-regions.spec.js?ref=fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5",
            "patch": "@@ -0,0 +1,77 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+const testPackage = require('../../helpers/test-package');\n+const Dgeni = require('dgeni');\n+\n+describe('checkForUnusedExampleRegions', () => {\n+  var processor, exampleMap;\n+\n+  beforeEach(function() {\n+    const dgeni = new Dgeni([testPackage('examples-package', true)]);\n+    const injector = dgeni.configureInjector();\n+    exampleMap = injector.get('exampleMap');\n+    processor = injector.get('checkForUnusedExampleRegions');\n+  });\n+\n+  describe('$process()', () => {\n+    it('should error if there is a named example region which has not been used', () => {\n+      exampleMap['examples'] = {\n+        'some/file': {\n+          regions: {\n+            '': {id: 'some/file#'},\n+            'used': {id: 'some/file#used', usedInDoc: {}},\n+            'not-used': {id: 'some/file#not-used'},\n+          }\n+        }\n+      };\n+      expect(() => processor.$process())\n+          .toThrowError('There is 1 unused example region:\\n - some/file#not-used');\n+    });\n+\n+    it('should not error if there are no example folders', () => {\n+      expect(() => processor.$process()).not.toThrowError();\n+    });\n+\n+    it('should not error if there are no example files', () => {\n+      exampleMap['examples'] = {};\n+      expect(() => processor.$process()).not.toThrowError();\n+    });\n+\n+    it('should not error if there are no example regions', () => {\n+      exampleMap['examples'] = {\n+        'some/file': {\n+          regions: {},\n+        },\n+      };\n+      expect(() => processor.$process()).not.toThrowError();\n+    });\n+\n+    it('should not error if there are no named example regions', () => {\n+      exampleMap['examples'] = {\n+        'some/file': {\n+          regions: {\n+            '': {id: 'some/file#'},\n+          },\n+        },\n+      };\n+      expect(() => processor.$process()).not.toThrowError();\n+    });\n+\n+    it('should not error if there are no unused named example regions', () => {\n+      exampleMap['examples'] = {\n+        'some/file': {\n+          regions: {\n+            '': {id: 'some/file#'},\n+            'used': {id: 'some/file#used', usedInDoc: {}},\n+          }\n+        }\n+      };\n+      expect(() => processor.$process()).not.toThrowError();\n+    });\n+  });\n+});"
        },
        {
            "sha": "94fd9274f91d6c3cfa64edde008c5875b32bc25b",
            "filename": "aio/tools/transforms/examples-package/services/getExampleRegion.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fservices%2FgetExampleRegion.js",
            "raw_url": "https://github.com/angular/angular/raw/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fservices%2FgetExampleRegion.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fservices%2FgetExampleRegion.js?ref=fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5",
            "patch": "@@ -1,4 +1,4 @@\n-module.exports = function getExampleRegion(exampleMap, createDocMessage, collectExamples) {\n+module.exports = function getExampleRegion(exampleMap, createDocMessage, collectExamples, log) {\n   return function getExampleRegionImpl(doc, relativePath, regionName) {\n     const EXAMPLES_FOLDERS = collectExamples.exampleFolders;\n \n@@ -29,10 +29,12 @@ module.exports = function getExampleRegion(exampleMap, createDocMessage, collect\n     var sourceCodeDoc = exampleFile.regions[regionName || ''];\n     if (!sourceCodeDoc) {\n       const message = createDocMessage('Missing example region... relativePath: \"' + relativePath + '\", region: \"' + regionName + '\".', doc) + '\\n' +\n-                      'Regions available are: ' + Object.keys(exampleFile.regions).map(function(region) { return '\"' + region + '\"'; }).join(', ');\n+      'Regions available are: ' + Object.keys(exampleFile.regions).map(function(region) { return '\"' + region + '\"'; }).join(', ');\n       throw new Error(message);\n     }\n \n+    sourceCodeDoc.usedInDoc = doc;\n+    log.debug(`Example region ${sourceCodeDoc.id} used in ${doc.id}`);\n     return sourceCodeDoc.renderedContent;\n   };\n };"
        },
        {
            "sha": "362ff0a2cc440915cecca586c02c88668c0517bc",
            "filename": "aio/tools/transforms/examples-package/services/getExampleRegion.spec.js",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fservices%2FgetExampleRegion.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fservices%2FgetExampleRegion.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fexamples-package%2Fservices%2FgetExampleRegion.spec.js?ref=fb97e67fcb4a546a9f8f734ed4f19a4e71ef40e5",
            "patch": "@@ -43,4 +43,15 @@ describe('getExampleRegion', () => {\n     }).toThrowError('Ignored example file... relativePath: \"filtered/path\" - doc\\n' +\n                     'This example file exists but has been ignored by a rule, in \"some/gitignore\".');\n   });\n+\n+  it('should mark the example as having been \"used\"', () => {\n+    const doc1 = {};\n+    const doc2 = {};\n+    expect(exampleMap['examples']['test/url'].regions['region-1'].usedInDoc).toBeUndefined();\n+    getExampleRegion(doc1, 'test/url', 'region-1');\n+    expect(exampleMap['examples']['test/url'].regions['region-1'].usedInDoc).toBe(doc1);\n+    expect(exampleMap['examples']['test/url'].regions[''].usedInDoc).toBeUndefined();\n+    getExampleRegion(doc2, 'test/url');\n+    expect(exampleMap['examples']['test/url'].regions[''].usedInDoc).toBe(doc2);\n+  });\n });"
        }
    ],
    "stats": {
        "total": 144,
        "additions": 140,
        "deletions": 4
    }
}