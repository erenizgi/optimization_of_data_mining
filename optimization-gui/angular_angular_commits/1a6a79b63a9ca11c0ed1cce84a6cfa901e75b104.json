{
    "author": "gkalpak",
    "message": "refactor(docs-infra): provide `local-/sessionStorage` via DI (#42259)\n\nPreviously, we had the same logic in a couple of places to safely access\nthe `Window`'s `local-/sessionStorage` and provide a no-op fallback if\nnecessary. Soon, we will need the same logic for the cookies popup\n(see #42209).\n\nThis commit reduces code duplication by providing\n`local-/sessionStorage` as injectables and sharing the logic for\naccessing them safely. This also makes it easier to mock the storage in\ntests without having to mess with the actual `Window` object.\n\nNOTE:\nThis commit actually decreases the payload size in the `main` bundle by\n40B.\n\nPR Close #42259",
    "sha": "1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
    "files": [
        {
            "sha": "17e8bdba11297e3958b7ac3c15bc7c76492f48a2",
            "filename": "aio/src/app/app.module.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fapp.module.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fapp.module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fapp.module.ts?ref=1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
            "patch": "@@ -21,6 +21,7 @@ import { ModeBannerComponent } from 'app/layout/mode-banner/mode-banner.componen\n import { GaService } from 'app/shared/ga.service';\n import { Logger } from 'app/shared/logger.service';\n import { LocationService } from 'app/shared/location.service';\n+import { STORAGE_PROVIDERS } from 'app/shared/storage.service';\n import { NavigationService } from 'app/navigation/navigation.service';\n import { DocumentService } from 'app/documents/document.service';\n import { SearchService } from 'app/search/search.service';\n@@ -187,6 +188,7 @@ export const svgIconProviders = [\n     ScrollService,\n     ScrollSpyService,\n     SearchService,\n+    STORAGE_PROVIDERS,\n     svgIconProviders,\n     TocService,\n     { provide: CurrentDateToken, useFactory: currentDateProvider },"
        },
        {
            "sha": "7aa622abdab4ddad0f061b35009c8e121069482a",
            "filename": "aio/src/app/layout/notification/notification.component.spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 25,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Flayout%2Fnotification%2Fnotification.component.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Flayout%2Fnotification%2Fnotification.component.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Flayout%2Fnotification%2Fnotification.component.spec.ts?ref=1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
            "patch": "@@ -3,8 +3,8 @@ import { Component, NO_ERRORS_SCHEMA } from '@angular/core';\n import { ComponentFixture, TestBed } from '@angular/core/testing';\n import { By } from '@angular/platform-browser';\n import { CurrentDateToken } from 'app/shared/current-date';\n+import { LocalStorage, NoopStorage } from 'app/shared/storage.service';\n import { NotificationComponent } from './notification.component';\n-import { WindowToken } from 'app/shared/window';\n \n describe('NotificationComponent', () => {\n   let component: NotificationComponent;\n@@ -14,7 +14,7 @@ describe('NotificationComponent', () => {\n     TestBed.configureTestingModule({\n       declarations: [TestComponent, NotificationComponent],\n       providers: [\n-        { provide: WindowToken, useClass: MockWindow },\n+        { provide: LocalStorage, useValue: new NoopStorage() },\n         { provide: CurrentDateToken, useValue: now },\n       ],\n       imports: [NoopAnimationsModule],\n@@ -92,7 +92,8 @@ describe('NotificationComponent', () => {\n   it('should update localStorage key when dismiss is called', () => {\n     configTestingModule();\n     createComponent();\n-    const setItemSpy: jasmine.Spy = (TestBed.inject(WindowToken) as MockWindow).localStorage.setItem;\n+    const localStorage = TestBed.inject(LocalStorage);\n+    const setItemSpy = spyOn(localStorage, 'setItem');\n     component.dismiss();\n     expect(setItemSpy).toHaveBeenCalledWith('aio-notification/survey-january-2018', 'hide');\n   });\n@@ -105,28 +106,12 @@ describe('NotificationComponent', () => {\n \n   it('should not show the notification if the there is a \"hide\" flag in localStorage', () => {\n     configTestingModule();\n-    const getItemSpy: jasmine.Spy = (TestBed.inject(WindowToken) as MockWindow).localStorage.getItem;\n-    getItemSpy.and.returnValue('hide');\n+    const localStorage = TestBed.inject(LocalStorage);\n+    const getItemSpy = spyOn(localStorage, 'getItem').and.returnValue('hide');\n     createComponent();\n     expect(getItemSpy).toHaveBeenCalledWith('aio-notification/survey-january-2018');\n     expect(component.showNotification).toBe('hide');\n   });\n-\n-  it('should not break when cookies are disabled in the browser', () => {\n-    configTestingModule();\n-\n-    // Simulate `window.localStorage` being inaccessible, when cookies are disabled.\n-    const mockWindow: MockWindow = TestBed.inject(WindowToken);\n-    Object.defineProperty(mockWindow, 'localStorage', {\n-      get() { throw new Error('The operation is insecure'); },\n-    });\n-\n-    expect(() => createComponent()).not.toThrow();\n-    expect(component.showNotification).toBe('show');\n-\n-    component.dismiss();\n-    expect(component.showNotification).toBe('hide');\n-  });\n });\n \n @Component({\n@@ -145,7 +130,3 @@ describe('NotificationComponent', () => {\n })\n class TestComponent {\n }\n-\n-class MockWindow {\n-  localStorage = jasmine.createSpyObj('localStorage', ['getItem', 'setItem']);\n-}"
        },
        {
            "sha": "f8ce4270d9f41ad7b809cd02bb8f537d46ea3c4b",
            "filename": "aio/src/app/layout/notification/notification.component.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 22,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Flayout%2Fnotification%2Fnotification.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Flayout%2Fnotification%2Fnotification.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Flayout%2Fnotification%2Fnotification.component.ts?ref=1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
            "patch": "@@ -1,7 +1,7 @@\n import { animate, state, style, trigger, transition } from '@angular/animations';\n import { Component, EventEmitter, HostBinding, Inject, Input, OnInit, Output } from '@angular/core';\n import { CurrentDateToken } from 'app/shared/current-date';\n-import { WindowToken } from 'app/shared/window';\n+import { LocalStorage } from 'app/shared/storage.service';\n \n const LOCAL_STORAGE_NAMESPACE = 'aio-notification/';\n \n@@ -20,8 +20,6 @@ const LOCAL_STORAGE_NAMESPACE = 'aio-notification/';\n   ]\n })\n export class NotificationComponent implements OnInit {\n-  private storage: Storage;\n-\n   @Input() dismissOnContentClick: boolean;\n   @Input() notificationId: string;\n   @Input() expirationDate: string;\n@@ -30,25 +28,7 @@ export class NotificationComponent implements OnInit {\n   @HostBinding('@hideAnimation')\n   showNotification: 'show'|'hide';\n \n-  constructor(\n-    @Inject(WindowToken) window: Window,\n-    @Inject(CurrentDateToken) private currentDate: Date\n-  ) {\n-    try {\n-      this.storage = window.localStorage;\n-    } catch {\n-      // When cookies are disabled in the browser, even trying to access\n-      // `window.localStorage` throws an error. Use a no-op storage.\n-      this.storage = {\n-        length: 0,\n-        clear: () => undefined,\n-        getItem: () => null,\n-        key: () => null,\n-        removeItem: () => undefined,\n-        setItem: () => undefined\n-      };\n-    }\n-  }\n+  constructor(@Inject(LocalStorage) private storage: Storage, @Inject(CurrentDateToken) private currentDate: Date) {}\n \n   ngOnInit() {\n     const previouslyHidden = this.storage.getItem(LOCAL_STORAGE_NAMESPACE + this.notificationId) === 'hide';"
        },
        {
            "sha": "7aeaedb78af94fab545b903f387bdbe9ea7feda4",
            "filename": "aio/src/app/shared/scroll.service.spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 31,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.spec.ts?ref=1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
            "patch": "@@ -5,6 +5,7 @@ import {Injector} from '@angular/core';\n import {fakeAsync, tick} from '@angular/core/testing';\n \n import {ScrollService, topMargin} from './scroll.service';\n+import {SessionStorage, NoopStorage} from './storage.service';\n \n describe('ScrollService', () => {\n   const scrollServiceInstances: ScrollService[] = [];\n@@ -20,6 +21,7 @@ describe('ScrollService', () => {\n   let platformLocation: MockPlatformLocation;\n   let scrollService: ScrollService;\n   let location: SpyLocation;\n+  let sessionStorage: Storage;\n \n   class MockPlatformLocation {\n     hash: string;\n@@ -46,27 +48,28 @@ describe('ScrollService', () => {\n         {\n           provide: ScrollService,\n           useFactory: createScrollService,\n-          deps: [DOCUMENT, PlatformLocation, ViewportScroller, Location],\n+          deps: [DOCUMENT, PlatformLocation, ViewportScroller, Location, SessionStorage],\n         },\n-        {provide: Location, useClass: SpyLocation, deps: [] },\n+        {provide: Location, useClass: SpyLocation, deps: []},\n         {provide: DOCUMENT, useClass: MockDocument, deps: []},\n         {provide: PlatformLocation, useClass: MockPlatformLocation, deps: []},\n         {provide: ViewportScroller, useValue: viewportScrollerStub},\n-        {provide: LocationStrategy, useClass: MockLocationStrategy, deps: []}\n+        {provide: LocationStrategy, useClass: MockLocationStrategy, deps: []},\n+        {provide: SessionStorage, useValue: new NoopStorage()},\n       ]\n     });\n \n     platformLocation = injector.get(PlatformLocation);\n     document = injector.get(DOCUMENT) as unknown as MockDocument;\n     scrollService = injector.get(ScrollService);\n     location = injector.get(Location) as unknown as SpyLocation;\n+    sessionStorage = injector.get(SessionStorage);\n \n     spyOn(window, 'scrollBy');\n   });\n \n   afterEach(() => {\n     scrollServiceInstances.forEach(instance => instance.ngOnDestroy());\n-    window.sessionStorage.clear();\n   });\n \n   it('should debounce `updateScrollPositonInHistory()`', fakeAsync(() => {\n@@ -92,7 +95,8 @@ describe('ScrollService', () => {\n         configurable: true,\n       });\n       scrollService = createScrollService(\n-          document, platformLocation as PlatformLocation, viewportScrollerStub, location);\n+          document, platformLocation as PlatformLocation, viewportScrollerStub, location,\n+          sessionStorage);\n \n       expect(scrollService.supportManualScrollRestoration).toBe(false);\n     } finally {\n@@ -112,32 +116,6 @@ describe('ScrollService', () => {\n     }\n   });\n \n-  it('should not break when cookies are disabled in the browser', () => {\n-    expect(() => {\n-      const originalSessionStorage = Object.getOwnPropertyDescriptor(window, 'sessionStorage') as PropertyDescriptor;\n-\n-      try {\n-        // Simulate `window.sessionStorage` being inaccessible, when cookies are disabled.\n-        Object.defineProperty(window, 'sessionStorage', {\n-          get() {\n-            throw new Error('The operation is insecure');\n-          },\n-        });\n-\n-        const platformLoc = platformLocation as PlatformLocation;\n-        const service = createScrollService(document, platformLoc, viewportScrollerStub, location);\n-\n-        service.updateScrollLocationHref();\n-        expect(service.getStoredScrollLocationHref()).toBeNull();\n-\n-        service.removeStoredScrollInfo();\n-        expect(service.getStoredScrollPosition()).toBeNull();\n-      } finally {\n-        Object.defineProperty(window, 'sessionStorage', originalSessionStorage);\n-      }\n-    }).not.toThrow();\n-  });\n-\n   describe('#topOffset', () => {\n     it('should query for the top-bar by CSS selector', () => {\n       expect(document.querySelector).not.toHaveBeenCalled();"
        },
        {
            "sha": "43155f1c987fc8fddf06745e2da63a9a5f54b88a",
            "filename": "aio/src/app/shared/scroll.service.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 17,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Fscroll.service.ts?ref=1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
            "patch": "@@ -2,6 +2,7 @@ import {DOCUMENT, Location, PlatformLocation, PopStateEvent, ViewportScroller} f\n import {Inject, Injectable, OnDestroy} from '@angular/core';\n import {fromEvent, Subject} from 'rxjs';\n import {debounceTime, takeUntil} from 'rxjs/operators';\n+import {SessionStorage} from './storage.service';\n \n type ScrollPosition = [number, number];\n interface ScrollPositionPopStateEvent extends PopStateEvent {\n@@ -18,7 +19,6 @@ export class ScrollService implements OnDestroy {\n   private _topOffset: number|null;\n   private _topOfPageElement: Element;\n   private onDestroy = new Subject<void>();\n-  private storage: Storage;\n \n   // The scroll position which has to be restored, after a `popstate` event.\n   poppedStateScrollPosition: ScrollPosition|null = null;\n@@ -45,22 +45,8 @@ export class ScrollService implements OnDestroy {\n \n   constructor(\n       @Inject(DOCUMENT) private document: any, private platformLocation: PlatformLocation,\n-      private viewportScroller: ViewportScroller, private location: Location) {\n-    try {\n-      this.storage = window.sessionStorage;\n-    } catch {\n-      // When cookies are disabled in the browser, even trying to access\n-      // `window.sessionStorage` throws an error. Use a no-op storage.\n-      this.storage = {\n-        length: 0,\n-        clear: () => undefined,\n-        getItem: () => null,\n-        key: () => null,\n-        removeItem: () => undefined,\n-        setItem: () => undefined\n-      };\n-    }\n-\n+      private viewportScroller: ViewportScroller, private location: Location,\n+      @Inject(SessionStorage) private storage: Storage) {\n     // On resize, the toolbar might change height, so \"invalidate\" the top offset.\n     fromEvent(window, 'resize')\n         .pipe(takeUntil(this.onDestroy))"
        },
        {
            "sha": "5f39dd6bf9565efbe7d5b07a8210d26818e086bf",
            "filename": "aio/src/app/shared/storage.service.spec.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Fstorage.service.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Fstorage.service.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Fstorage.service.spec.ts?ref=1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
            "patch": "@@ -0,0 +1,37 @@\n+import { Injector } from '@angular/core';\n+import { LocalStorage, NoopStorage, SessionStorage, STORAGE_PROVIDERS } from './storage.service';\n+import { WindowToken } from './window';\n+\n+[\n+  ['localStorage', LocalStorage] as const,\n+  ['sessionStorage', SessionStorage] as const,\n+].forEach(([storagePropName, storageToken]) => {\n+  let getStorageSpy: jasmine.Spy;\n+  let injector: Injector;\n+\n+  beforeEach(() => {\n+    getStorageSpy = jasmine.createSpy(`get ${storagePropName}`);\n+    injector = Injector.create({\n+      providers: [\n+        STORAGE_PROVIDERS,\n+        {\n+          provide: WindowToken,\n+          useValue: Object.defineProperty({}, storagePropName, { get: getStorageSpy }),\n+        },\n+      ],\n+    });\n+  });\n+\n+  it('should return the storage from `window`', () => {\n+    const mockStorage = { mock: true } as unknown as Storage;\n+    getStorageSpy.and.returnValue(mockStorage);\n+\n+    expect(injector.get(storageToken)).toBe(mockStorage);\n+  });\n+\n+  it('should return a no-op storage if accessing the storage on `window` errors', () => {\n+    getStorageSpy.and.throwError('Can\\'t touch this!');\n+\n+    expect(injector.get(storageToken)).toBeInstanceOf(NoopStorage);\n+  });\n+});"
        },
        {
            "sha": "e96f90da211d45d03ecfad1bb1d38522cb8725e6",
            "filename": "aio/src/app/shared/storage.service.ts",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Fstorage.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Fstorage.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Fstorage.service.ts?ref=1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
            "patch": "@@ -0,0 +1,29 @@\n+import { InjectionToken, StaticProvider } from '@angular/core';\n+import { WindowToken } from './window';\n+\n+export const LocalStorage = new InjectionToken<Storage>('LocalStorage');\n+export const SessionStorage = new InjectionToken<Storage>('SessionStorage');\n+\n+export const STORAGE_PROVIDERS: StaticProvider[] = [\n+  { provide: LocalStorage, useFactory: (win: Window) => getStorage(win, 'localStorage'), deps: [WindowToken] },\n+  { provide: SessionStorage, useFactory: (win: Window) => getStorage(win, 'sessionStorage'), deps: [WindowToken] },\n+];\n+\n+export class NoopStorage implements Storage {\n+  length = 0;\n+  clear() {}\n+  getItem() { return null; }\n+  key() { return null; }\n+  removeItem() {}\n+  setItem() {}\n+}\n+\n+function getStorage(win: Window, storageType: 'localStorage' | 'sessionStorage'): Storage {\n+  // When cookies are disabled in the browser, even trying to access `window[storageType]` throws an\n+  // error. If so, return a no-op storage.\n+  try {\n+    return win[storageType];\n+  } catch {\n+    return new NoopStorage();\n+  }\n+}"
        },
        {
            "sha": "60cf965a00e48f7cfe5fb8184e7e735ef3ca5987",
            "filename": "aio/src/app/shared/theme-picker/theme-toggle.component.spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 37,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Ftheme-picker%2Ftheme-toggle.component.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Ftheme-picker%2Ftheme-toggle.component.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Ftheme-picker%2Ftheme-toggle.component.spec.ts?ref=1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
            "patch": "@@ -1,43 +1,8 @@\n import { ComponentFixture, TestBed } from '@angular/core/testing';\n import { MatIconModule } from '@angular/material/icon';\n import { By } from '@angular/platform-browser';\n-import { ThemeStorage, ThemeToggleComponent } from './theme-toggle.component';\n-\n-class FakeThemeStorage implements ThemeStorage {\n-  fakeStorage: string | null = null;\n-\n-  getThemePreference(): string | null {\n-    return this.fakeStorage;\n-  }\n-\n-  setThemePreference(isDark: boolean): void {\n-    this.fakeStorage = String(isDark);\n-  }\n-}\n-\n-// Verify that FakeThemeStorage behaves like ThemeStorage would\n-describe('FakeThemeStorage', () => {\n-  let themeStorage: ThemeStorage;\n-\n-  beforeEach(() => {\n-    themeStorage = new FakeThemeStorage();\n-  });\n-\n-  it('should have null stored initially', () => {\n-    expect(themeStorage.getThemePreference()).toBeNull();\n-  });\n-\n-  it('should store true as a string if isDark is true', () => {\n-    themeStorage.setThemePreference(true);\n-    expect(themeStorage.getThemePreference()).toBe('true');\n-  });\n-\n-  it('should store false as a string if isDark is false', () => {\n-    themeStorage.setThemePreference(false);\n-    expect(themeStorage.getThemePreference()).toBe('false');\n-  });\n-});\n-\n+import { LocalStorage, NoopStorage } from '../storage.service';\n+import { storageKey as themeStorageKey, ThemeToggleComponent } from './theme-toggle.component';\n \n describe('ThemeToggleComponent', () => {\n   let component: ThemeToggleComponent;\n@@ -47,6 +12,7 @@ describe('ThemeToggleComponent', () => {\n     TestBed.configureTestingModule({\n       declarations: [ ThemeToggleComponent ],\n       imports: [ MatIconModule ],\n+      providers: [ { provide: LocalStorage, useValue: new NoopStorage() } ],\n     });\n \n     fixture = TestBed.createComponent(ThemeToggleComponent);\n@@ -82,6 +48,30 @@ describe('ThemeToggleComponent', () => {\n     expect(component.getToggleLabel()).toBe('Switch to light mode');\n   });\n \n+  it('should store the theme in `localStorage`', () => {\n+    const storage = TestBed.inject(LocalStorage);\n+    const setItemSpy = spyOn(storage, 'setItem');\n+\n+    component.toggleTheme();\n+    expect(setItemSpy).toHaveBeenCalledWith(themeStorageKey, 'true');\n+\n+    component.toggleTheme();\n+    expect(setItemSpy).toHaveBeenCalledWith(themeStorageKey, 'false');\n+  });\n+\n+  it('should initialize the theme from `localStorage`', () => {\n+    const storage = TestBed.inject(LocalStorage);\n+    const getItemSpy = spyOn(storage, 'getItem').withArgs(themeStorageKey);\n+\n+    getItemSpy.and.returnValue('false');\n+    const component1 = TestBed.createComponent(ThemeToggleComponent).componentInstance;\n+    expect(component1.isDark).toBe(false);\n+\n+    getItemSpy.and.returnValue('true');\n+    const component2 = TestBed.createComponent(ThemeToggleComponent).componentInstance;\n+    expect(component2.isDark).toBe(true);\n+  });\n+\n   // Helpers\n   function getToggleButton(): HTMLButtonElement {\n     return fixture.debugElement.query(By.css('button')).nativeElement;"
        },
        {
            "sha": "daabcd127b083bf68767dab54d621533abb9da3a",
            "filename": "aio/src/app/shared/theme-picker/theme-toggle.component.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 25,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Ftheme-picker%2Ftheme-toggle.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/aio%2Fsrc%2Fapp%2Fshared%2Ftheme-picker%2Ftheme-toggle.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Ftheme-picker%2Ftheme-toggle.component.ts?ref=1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
            "patch": "@@ -1,27 +1,8 @@\n import { DOCUMENT } from '@angular/common';\n-import { Component, Inject, Injectable } from '@angular/core';\n+import { Component, Inject } from '@angular/core';\n+import { LocalStorage } from 'app/shared/storage.service';\n \n-/** Injectable facade around localStorage for theme preference to make testing easier. */\n-@Injectable({ providedIn: 'root' })\n-export class ThemeStorage {\n-  getThemePreference(): string | null {\n-    // Wrap localStorage access in try/catch because user agents can block localStorage. If it is\n-    // blocked, we treat it as if no preference was previously stored.\n-    try {\n-      return localStorage.getItem('aio-theme');\n-    } catch {\n-      return null;\n-    }\n-  }\n-\n-  setThemePreference(isDark: boolean): void {\n-    // Wrap localStorage access in try/catch because user agents can block localStorage. If it\n-    // fails, we persist nothing.\n-    try {\n-      localStorage.setItem('aio-theme', String(isDark));\n-    } catch { }\n-  }\n-}\n+export const storageKey = 'aio-theme';\n \n @Component({\n   selector: 'aio-theme-toggle',\n@@ -37,7 +18,7 @@ export class ThemeStorage {\n export class ThemeToggleComponent {\n   isDark = false;\n \n-  constructor(@Inject(DOCUMENT) private document: Document, private readonly themeStorage: ThemeStorage) {\n+  constructor(@Inject(DOCUMENT) private document: Document, @Inject(LocalStorage) private storage: Storage) {\n     this.initializeThemeFromPreferences();\n   }\n \n@@ -48,7 +29,7 @@ export class ThemeToggleComponent {\n \n   private initializeThemeFromPreferences(): void {\n     // Check whether there's an explicit preference in localStorage.\n-    const storedPreference = this.themeStorage.getThemePreference();\n+    const storedPreference = this.storage.getItem(storageKey);\n \n     // If we do have a preference in localStorage, use that. Otherwise,\n     // initialize based on the prefers-color-scheme media query.\n@@ -86,6 +67,6 @@ export class ThemeToggleComponent {\n       customLinkElement.href = `${this.getThemeName()}-theme.css`;\n     }\n \n-    this.themeStorage.setThemePreference(this.isDark);\n+    this.storage.setItem(storageKey, String(this.isDark));\n   }\n }"
        },
        {
            "sha": "fa92ee0f9c4f6c2fe9868b439915a2fce0064f00",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=1a6a79b63a9ca11c0ed1cce84a6cfa901e75b104",
            "patch": "@@ -3,7 +3,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2017\": 4619,\n-        \"main-es2017\": 454043,\n+        \"main-es2017\": 454003,\n         \"polyfills-es2017\": 55210\n       }\n     }\n@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2017\": 4619,\n-        \"main-es2017\": 454178,\n+        \"main-es2017\": 454138,\n         \"polyfills-es2017\": 55348\n       }\n     }"
        }
    ],
    "stats": {
        "total": 282,
        "additions": 123,
        "deletions": 159
    }
}