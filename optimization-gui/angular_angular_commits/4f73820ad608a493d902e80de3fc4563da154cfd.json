{
    "author": "crisbeto",
    "message": "fix(core): memory leak if view container host view is destroyed while view ref is not (#40219)\n\nWhen we attach a `ViewRef` to a `ViewContainerRef`, we save a reference to the container\nonto the `ViewRef` so that we can remove it when the ref is destroyed. The problem is\nthat if the container's `hostView` is destroyed first, the `ViewRef` has no way of knowing\nthat it should stop referencing the container.\n\nThese changes remove the leak by not saving a reference at all. Instead, when a `ViewRef`\nis destroyed, we clean it up through the `LContainer` directly. We don't need to worry\nabout the case where the container is destroyed before the view, because containers\nautomatically clean up all of their views upon destruction.\n\nFixes #38648.\n\nPR Close #40219",
    "sha": "4f73820ad608a493d902e80de3fc4563da154cfd",
    "files": [
        {
            "sha": "06e4b0d60b330c924ad1992218c1c5b703c07eb8",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 17,
            "deletions": 48,
            "changes": 65,
            "blob_url": "https://github.com/angular/angular/blob/4f73820ad608a493d902e80de3fc4563da154cfd/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/4f73820ad608a493d902e80de3fc4563da154cfd/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=4f73820ad608a493d902e80de3fc4563da154cfd",
            "patch": "@@ -108,45 +108,6 @@\n     \"packages/compiler/src/render3/view/styling_builder.ts\",\n     \"packages/compiler/src/render3/view/template.ts\"\n   ],\n-  [\n-    \"packages/core/src/change_detection/change_detection.ts\",\n-    \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_ref.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n-    \"packages/core/src/linker/component_factory.ts\"\n-  ],\n-  [\n-    \"packages/core/src/change_detection/change_detection.ts\",\n-    \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_ref.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n-    \"packages/core/src/linker/ng_module_factory.ts\",\n-    \"packages/core/src/linker/component_factory_resolver.ts\",\n-    \"packages/core/src/linker/component_factory.ts\"\n-  ],\n-  [\n-    \"packages/core/src/change_detection/change_detection.ts\",\n-    \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_ref.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n-    \"packages/core/src/render3/instructions/shared.ts\",\n-    \"packages/core/src/error_handler.ts\",\n-    \"packages/core/src/errors.ts\",\n-    \"packages/core/src/view/types.ts\",\n-    \"packages/core/src/linker/component_factory.ts\"\n-  ],\n-  [\n-    \"packages/core/src/change_detection/change_detection.ts\",\n-    \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_ref.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n-    \"packages/core/src/render3/instructions/shared.ts\",\n-    \"packages/core/src/error_handler.ts\",\n-    \"packages/core/src/errors.ts\",\n-    \"packages/core/src/view/types.ts\",\n-    \"packages/core/src/linker/component_factory.ts\"\n-  ],\n   [\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n@@ -164,8 +125,6 @@\n   [\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\",\n-    \"packages/core/src/linker/template_ref.ts\",\n     \"packages/core/src/linker/view_ref.ts\"\n   ],\n   [\n@@ -206,17 +165,27 @@\n     \"packages/core/src/view/types.ts\"\n   ],\n   [\n-    \"packages/core/src/linker/component_factory_resolver.ts\",\n-    \"packages/core/src/linker/ng_module_factory.ts\"\n-  ],\n-  [\n+    \"packages/core/src/error_handler.ts\",\n+    \"packages/core/src/errors.ts\",\n+    \"packages/core/src/view/types.ts\",\n     \"packages/core/src/linker/template_ref.ts\",\n-    \"packages/core/src/render3/view_ref.ts\",\n-    \"packages/core/src/linker/view_container_ref.ts\"\n+    \"packages/core/src/render3/instructions/shared.ts\"\n   ],\n   [\n+    \"packages/core/src/error_handler.ts\",\n+    \"packages/core/src/errors.ts\",\n+    \"packages/core/src/view/types.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n-    \"packages/core/src/render3/view_ref.ts\"\n+    \"packages/core/src/render3/instructions/shared.ts\"\n+  ],\n+  [\n+    \"packages/core/src/linker/component_factory_resolver.ts\",\n+    \"packages/core/src/linker/component_factory.ts\",\n+    \"packages/core/src/linker/ng_module_factory.ts\"\n+  ],\n+  [\n+    \"packages/core/src/linker/component_factory_resolver.ts\",\n+    \"packages/core/src/linker/ng_module_factory.ts\"\n   ],\n   [\n     \"packages/core/src/metadata/directives.ts\","
        },
        {
            "sha": "b37e423efc24868f309d8b3b62fb240c0feb4869",
            "filename": "packages/core/src/linker/view_container_ref.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/4f73820ad608a493d902e80de3fc4563da154cfd/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f73820ad608a493d902e80de3fc4563da154cfd/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Fview_container_ref.ts?ref=4f73820ad608a493d902e80de3fc4563da154cfd",
            "patch": "@@ -307,7 +307,7 @@ const R3ViewContainerRef = class ViewContainerRef extends VE_ViewContainerRef {\n       addViewToContainer(tView, lContainer[T_HOST], renderer, lView, parentRNode, beforeNode);\n     }\n \n-    (viewRef as R3ViewRef<any>).attachToViewContainerRef(this);\n+    (viewRef as R3ViewRef<any>).attachToViewContainerRef();\n     addToArray(getOrCreateViewRefs(lContainer), adjustedIdx, viewRef);\n \n     return viewRef;"
        },
        {
            "sha": "b88e8b51ba802cd0bea906ff5c2c5931ff697ac8",
            "filename": "packages/core/src/render3/view_ref.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 14,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/4f73820ad608a493d902e80de3fc4563da154cfd/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f73820ad608a493d902e80de3fc4563da154cfd/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts?ref=4f73820ad608a493d902e80de3fc4563da154cfd",
            "patch": "@@ -7,12 +7,15 @@\n  */\n \n import {ChangeDetectorRef as viewEngine_ChangeDetectorRef} from '../change_detection/change_detector_ref';\n-import {ViewContainerRef as viewEngine_ViewContainerRef} from '../linker/view_container_ref';\n import {EmbeddedViewRef as viewEngine_EmbeddedViewRef, InternalViewRef as viewEngine_InternalViewRef, ViewRefTracker} from '../linker/view_ref';\n+import {removeFromArray} from '../util/array_utils';\n+import {assertEqual} from '../util/assert';\n import {collectNativeNodes} from './collect_native_nodes';\n import {checkNoChangesInRootView, checkNoChangesInternal, detectChangesInRootView, detectChangesInternal, markViewDirty, storeCleanupWithContext} from './instructions/shared';\n-import {CONTEXT, FLAGS, LView, LViewFlags, TVIEW} from './interfaces/view';\n-import {destroyLView, renderDetachView} from './node_manipulation';\n+import {CONTAINER_HEADER_OFFSET, VIEW_REFS} from './interfaces/container';\n+import {isLContainer} from './interfaces/type_checks';\n+import {CONTEXT, FLAGS, LView, LViewFlags, PARENT, TVIEW} from './interfaces/view';\n+import {destroyLView, detachView, renderDetachView} from './node_manipulation';\n \n \n \n@@ -24,7 +27,7 @@ export interface viewEngine_ChangeDetectorRef_interface extends viewEngine_Chang\n export class ViewRef<T> implements viewEngine_EmbeddedViewRef<T>, viewEngine_InternalViewRef,\n                                    viewEngine_ChangeDetectorRef_interface {\n   private _appRef: ViewRefTracker|null = null;\n-  private _viewContainerRef: viewEngine_ViewContainerRef|null = null;\n+  private _attachedToViewContainer = false;\n \n   get rootNodes(): any[] {\n     const lView = this._lView;\n@@ -65,14 +68,21 @@ export class ViewRef<T> implements viewEngine_EmbeddedViewRef<T>, viewEngine_Int\n   destroy(): void {\n     if (this._appRef) {\n       this._appRef.detachView(this);\n-    } else if (this._viewContainerRef) {\n-      const index = this._viewContainerRef.indexOf(this);\n-\n-      if (index > -1) {\n-        this._viewContainerRef.detach(index);\n+    } else if (this._attachedToViewContainer) {\n+      const parent = this._lView[PARENT];\n+      if (isLContainer(parent)) {\n+        const viewRefs = parent[VIEW_REFS] as ViewRef<unknown>[] | null;\n+        const index = viewRefs ? viewRefs.indexOf(this) : -1;\n+        if (index > -1) {\n+          ngDevMode &&\n+              assertEqual(\n+                  index, parent.indexOf(this._lView) - CONTAINER_HEADER_OFFSET,\n+                  'An attached view should be in the same position within its container as its ViewRef in the VIEW_REFS array.');\n+          detachView(parent, index);\n+          removeFromArray(viewRefs!, index);\n+        }\n       }\n-\n-      this._viewContainerRef = null;\n+      this._attachedToViewContainer = false;\n     }\n     destroyLView(this._lView[TVIEW], this._lView);\n   }\n@@ -271,11 +281,11 @@ export class ViewRef<T> implements viewEngine_EmbeddedViewRef<T>, viewEngine_Int\n     checkNoChangesInternal(this._lView[TVIEW], this._lView, this.context);\n   }\n \n-  attachToViewContainerRef(vcRef: viewEngine_ViewContainerRef) {\n+  attachToViewContainerRef() {\n     if (this._appRef) {\n       throw new Error('This view is already attached directly to the ApplicationRef!');\n     }\n-    this._viewContainerRef = vcRef;\n+    this._attachedToViewContainer = true;\n   }\n \n   detachFromAppRef() {\n@@ -284,7 +294,7 @@ export class ViewRef<T> implements viewEngine_EmbeddedViewRef<T>, viewEngine_Int\n   }\n \n   attachToAppRef(appRef: ViewRefTracker) {\n-    if (this._viewContainerRef) {\n+    if (this._attachedToViewContainer) {\n       throw new Error('This view is already attached to a ViewContainer!');\n     }\n     this._appRef = appRef;"
        },
        {
            "sha": "3c3f6bd8c13efb79b7b5d5f43d1670db183c2788",
            "filename": "packages/core/test/acceptance/view_ref_spec.ts",
            "status": "modified",
            "additions": 77,
            "deletions": 1,
            "changes": 78,
            "blob_url": "https://github.com/angular/angular/blob/4f73820ad608a493d902e80de3fc4563da154cfd/packages%2Fcore%2Ftest%2Facceptance%2Fview_ref_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4f73820ad608a493d902e80de3fc4563da154cfd/packages%2Fcore%2Ftest%2Facceptance%2Fview_ref_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fview_ref_spec.ts?ref=4f73820ad608a493d902e80de3fc4563da154cfd",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ApplicationRef, ChangeDetectorRef, Component, ComponentFactoryResolver, ComponentRef, ElementRef, Injector, NgModule} from '@angular/core';\n+import {ApplicationRef, ChangeDetectorRef, Component, ComponentFactoryResolver, ComponentRef, ElementRef, EmbeddedViewRef, Injector, NgModule, TemplateRef, ViewChild, ViewContainerRef} from '@angular/core';\n import {InternalViewRef} from '@angular/core/src/linker/view_ref';\n import {TestBed} from '@angular/core/testing';\n \n@@ -72,4 +72,80 @@ describe('ViewRef', () => {\n \n     expect(called).toBe(true);\n   });\n+\n+  it('should remove view ref from view container when destroyed', () => {\n+    @Component({template: ''})\n+    class DynamicComponent {\n+      constructor(public viewContainerRef: ViewContainerRef) {}\n+    }\n+\n+    @Component({template: `<ng-template>Hello</ng-template>`})\n+    class App {\n+      @ViewChild(TemplateRef) templateRef!: TemplateRef<any>;\n+      componentRef!: ComponentRef<DynamicComponent>;\n+      viewRef!: EmbeddedViewRef<any>;\n+      constructor(\n+          private _viewContainerRef: ViewContainerRef,\n+          private _componentFactoryResolver: ComponentFactoryResolver) {}\n+\n+      create() {\n+        const factory = this._componentFactoryResolver.resolveComponentFactory(DynamicComponent);\n+        this.viewRef = this.templateRef.createEmbeddedView(null);\n+        this.componentRef = this._viewContainerRef.createComponent(factory);\n+        this.componentRef.instance.viewContainerRef.insert(this.viewRef);\n+      }\n+    }\n+\n+    @NgModule({declarations: [App, DynamicComponent], entryComponents: [DynamicComponent]})\n+    class MyTestModule {\n+    }\n+\n+    TestBed.configureTestingModule({imports: [MyTestModule]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+    fixture.componentInstance.create();\n+    const viewContainerRef = fixture.componentInstance.componentRef.instance.viewContainerRef;\n+\n+    expect(viewContainerRef.length).toBe(1);\n+    fixture.componentInstance.viewRef.destroy();\n+    expect(viewContainerRef.length).toBe(0);\n+  });\n+\n+  it('should mark a ViewRef as destroyed when the host view is destroyed', () => {\n+    @Component({template: ''})\n+    class DynamicComponent {\n+      constructor(public viewContainerRef: ViewContainerRef) {}\n+    }\n+\n+    @Component({template: `<ng-template>Hello</ng-template>`})\n+    class App {\n+      @ViewChild(TemplateRef) templateRef!: TemplateRef<any>;\n+      componentRef!: ComponentRef<DynamicComponent>;\n+      viewRef!: EmbeddedViewRef<any>;\n+      constructor(\n+          private _viewContainerRef: ViewContainerRef,\n+          private _componentFactoryResolver: ComponentFactoryResolver) {}\n+\n+      create() {\n+        const factory = this._componentFactoryResolver.resolveComponentFactory(DynamicComponent);\n+        this.viewRef = this.templateRef.createEmbeddedView(null);\n+        this.componentRef = this._viewContainerRef.createComponent(factory);\n+        this.componentRef.instance.viewContainerRef.insert(this.viewRef);\n+      }\n+    }\n+\n+    @NgModule({declarations: [App, DynamicComponent], entryComponents: [DynamicComponent]})\n+    class MyTestModule {\n+    }\n+\n+    TestBed.configureTestingModule({imports: [MyTestModule]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+    fixture.componentInstance.create();\n+    const {componentRef, viewRef} = fixture.componentInstance;\n+\n+    expect(viewRef.destroyed).toBe(false);\n+    componentRef.hostView.destroy();\n+    expect(viewRef.destroyed).toBe(true);\n+  });\n });"
        }
    ],
    "stats": {
        "total": 183,
        "additions": 119,
        "deletions": 64
    }
}