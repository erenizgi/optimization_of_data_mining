{
    "author": "petebacondarwin",
    "message": "fix(compiler-cli): use `Map` rather than `object` for map of partial linkers (#40563)\n\nPreviously, we were naïvely checking whether a function name was a partial linker\ndeclaration call by testing the map of linkers with `linkers[name]`. Since\n`linkers` was a plain object, it also matched function names like `toString`!\n\nThis has been refactored as a `Map` to avoid the problem.\n\nPR Close #40563",
    "sha": "b630b09c7ed8c55ea010b0ea588327c5e2dcde2b",
    "files": [
        {
            "sha": "461e2522f973b3520f47962b03e5115dce7527c9",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_linker_selector.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 15,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/b630b09c7ed8c55ea010b0ea588327c5e2dcde2b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "raw_url": "https://github.com/angular/angular/raw/b630b09c7ed8c55ea010b0ea588327c5e2dcde2b/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts?ref=b630b09c7ed8c55ea010b0ea588327c5e2dcde2b",
            "patch": "@@ -19,6 +19,11 @@ export const ɵɵngDeclareDirective = 'ɵɵngDeclareDirective';\n export const ɵɵngDeclareComponent = 'ɵɵngDeclareComponent';\n export const declarationFunctions = [ɵɵngDeclareDirective, ɵɵngDeclareComponent];\n \n+interface LinkerRange<TExpression> {\n+  range: string;\n+  linker: PartialLinker<TExpression>;\n+}\n+\n /**\n  * A helper that selects the appropriate `PartialLinker` for a given declaration.\n  *\n@@ -35,7 +40,7 @@ export const declarationFunctions = [ɵɵngDeclareDirective, ɵɵngDeclareCompon\n  * allows the linker to work on local builds effectively.\n  */\n export class PartialLinkerSelector<TStatement, TExpression> {\n-  private readonly linkers: Record<string, {range: string, linker: PartialLinker<TExpression>}[]>;\n+  private readonly linkers: Map<string, LinkerRange<TExpression>[]>;\n \n   constructor(\n       environment: LinkerEnvironment<TStatement, TExpression>, sourceUrl: AbsoluteFsPath,\n@@ -47,18 +52,18 @@ export class PartialLinkerSelector<TStatement, TExpression> {\n    * Returns true if there are `PartialLinker` classes that can handle functions with this name.\n    */\n   supportsDeclaration(functionName: string): boolean {\n-    return this.linkers[functionName] !== undefined;\n+    return this.linkers.has(functionName);\n   }\n \n   /**\n    * Returns the `PartialLinker` that can handle functions with the given name and version.\n    * Throws an error if there is none.\n    */\n   getLinker(functionName: string, version: string): PartialLinker<TExpression> {\n-    const versions = this.linkers[functionName];\n-    if (versions === undefined) {\n+    if (!this.linkers.has(functionName)) {\n       throw new Error(`Unknown partial declaration function ${functionName}.`);\n     }\n+    const versions = this.linkers.get(functionName)!;\n     for (const {range, linker} of versions) {\n       if (satisfies(version, range, {includePrerelease: true})) {\n         return linker;\n@@ -71,21 +76,21 @@ export class PartialLinkerSelector<TStatement, TExpression> {\n \n   private createLinkerMap(\n       environment: LinkerEnvironment<TStatement, TExpression>, sourceUrl: AbsoluteFsPath,\n-      code: string) {\n+      code: string): Map<string, LinkerRange<TExpression>[]> {\n     const partialDirectiveLinkerVersion1 = new PartialDirectiveLinkerVersion1(sourceUrl, code);\n     const partialComponentLinkerVersion1 = new PartialComponentLinkerVersion1(\n         environment, createGetSourceFile(sourceUrl, code, environment.sourceFileLoader), sourceUrl,\n         code);\n \n-    return {\n-      [ɵɵngDeclareDirective]: [\n-        {range: '0.0.0-PLACEHOLDER', linker: partialDirectiveLinkerVersion1},\n-        {range: '>=11.1.0-next.1', linker: partialDirectiveLinkerVersion1},\n-      ],\n-      [ɵɵngDeclareComponent]: [\n-        {range: '0.0.0-PLACEHOLDER', linker: partialComponentLinkerVersion1},\n-        {range: '>=11.1.0-next.1', linker: partialComponentLinkerVersion1},\n-      ],\n-    };\n+    const linkers = new Map<string, LinkerRange<TExpression>[]>();\n+    linkers.set(ɵɵngDeclareDirective, [\n+      {range: '0.0.0-PLACEHOLDER', linker: partialDirectiveLinkerVersion1},\n+      {range: '>=11.1.0-next.1', linker: partialDirectiveLinkerVersion1},\n+    ]);\n+    linkers.set(ɵɵngDeclareComponent, [\n+      {range: '0.0.0-PLACEHOLDER', linker: partialComponentLinkerVersion1},\n+      {range: '>=11.1.0-next.1', linker: partialComponentLinkerVersion1},\n+    ]);\n+    return linkers;\n   }\n }"
        },
        {
            "sha": "773f4867fae8e6e4c3b36c94dfd9e7eb30a4999a",
            "filename": "packages/compiler-cli/linker/test/file_linker/partial_linkers/partial_linker_selector_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b630b09c7ed8c55ea010b0ea588327c5e2dcde2b/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b630b09c7ed8c55ea010b0ea588327c5e2dcde2b/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector_spec.ts?ref=b630b09c7ed8c55ea010b0ea588327c5e2dcde2b",
            "patch": "@@ -44,6 +44,12 @@ describe('PartialLinkerSelector', () => {\n          expect(selector.supportsDeclaration('ɵɵngDeclareComponent')).toBe(true);\n          expect(selector.supportsDeclaration('$foo')).toBe(false);\n        });\n+\n+    it('should return false for methods on `Object`', () => {\n+      const selector = new PartialLinkerSelector(\n+          environment, fs.resolve('/some/path/to/file.js'), 'some file contents');\n+      expect(selector.supportsDeclaration('toString')).toBe(false);\n+    });\n   });\n \n   describe('getLinker()', () => {"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 26,
        "deletions": 15
    }
}