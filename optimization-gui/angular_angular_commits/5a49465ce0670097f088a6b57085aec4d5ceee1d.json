{
    "author": "josephperrott",
    "message": "fix(dev-infra): verify the version of generated build artifacts (#39789)\n\nVerify the version of the generated build artifacts to ensure that\nthe version published to NPM is the version we expect.\n\nPR Close #39789",
    "sha": "5a49465ce0670097f088a6b57085aec4d5ceee1d",
    "files": [
        {
            "sha": "39e9f71014db182f93be0d564d3c32be3ce10829",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/5a49465ce0670097f088a6b57085aec4d5ceee1d/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/5a49465ce0670097f088a6b57085aec4d5ceee1d/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=5a49465ce0670097f088a6b57085aec4d5ceee1d",
            "patch": "@@ -5807,6 +5807,8 @@ class ReleaseAction {\n             // so we cannot build and publish it.\n             yield invokeYarnInstallCommand(this.projectDir);\n             const builtPackages = yield invokeReleaseBuildCommand();\n+            // Verify the packages built are the correct version.\n+            yield this._verifyPackageVersions(newVersion, builtPackages);\n             // Create a Github release for the new version.\n             yield this._createGithubReleaseForVersion(newVersion, versionBumpCommitSha);\n             // Walk through all built packages and publish them to NPM.\n@@ -5841,6 +5843,20 @@ class ReleaseAction {\n             return data.commit.message.startsWith(getCommitMessageForRelease(version));\n         });\n     }\n+    /** Verify the version of each generated package exact matches the specified version. */\n+    _verifyPackageVersions(version, packages) {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            for (const pkg of packages) {\n+                const { version: packageJsonVersion } = JSON.parse(yield fs.promises.readFile(path.join(pkg.outputPath, 'package.json'), 'utf8'));\n+                if (version.compare(packageJsonVersion) !== 0) {\n+                    error(red('The built package version does not match the version being released.'));\n+                    error(`  Release Version:   ${version.version}`);\n+                    error(`  Generated Version: ${packageJsonVersion}`);\n+                    throw new FatalReleaseActionError();\n+                }\n+            }\n+        });\n+    }\n }\n \n /**"
        },
        {
            "sha": "3b22e81feb6afb242a5a99523f1b96efc363838b",
            "filename": "dev-infra/release/publish/actions.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/5a49465ce0670097f088a6b57085aec4d5ceee1d/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "raw_url": "https://github.com/angular/angular/raw/5a49465ce0670097f088a6b57085aec4d5ceee1d/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions.ts?ref=5a49465ce0670097f088a6b57085aec4d5ceee1d",
            "patch": "@@ -503,6 +503,9 @@ export abstract class ReleaseAction {\n     await invokeYarnInstallCommand(this.projectDir);\n     const builtPackages = await invokeReleaseBuildCommand();\n \n+    // Verify the packages built are the correct version.\n+    await this._verifyPackageVersions(newVersion, builtPackages);\n+\n     // Create a Github release for the new version.\n     await this._createGithubReleaseForVersion(newVersion, versionBumpCommitSha);\n \n@@ -537,4 +540,18 @@ export abstract class ReleaseAction {\n         await this.git.github.repos.getCommit({...this.git.remoteParams, ref: commitSha});\n     return data.commit.message.startsWith(getCommitMessageForRelease(version));\n   }\n+\n+  /** Verify the version of each generated package exact matches the specified version. */\n+  private async _verifyPackageVersions(version: semver.SemVer, packages: BuiltPackage[]) {\n+    for (const pkg of packages) {\n+      const {version: packageJsonVersion} =\n+          JSON.parse(await fs.readFile(join(pkg.outputPath, 'package.json'), 'utf8'));\n+      if (version.compare(packageJsonVersion) !== 0) {\n+        error(red('The built package version does not match the version being released.'));\n+        error(`  Release Version:   ${version.version}`);\n+        error(`  Generated Version: ${packageJsonVersion}`);\n+        throw new FatalReleaseActionError();\n+      }\n+    }\n+  }\n }"
        },
        {
            "sha": "8225a309809cda9063ea3e36c49aa1072e57419e",
            "filename": "dev-infra/release/publish/test/test-utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/5a49465ce0670097f088a6b57085aec4d5ceee1d/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/5a49465ce0670097f088a6b57085aec4d5ceee1d/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts?ref=5a49465ce0670097f088a6b57085aec4d5ceee1d",
            "patch": "@@ -89,14 +89,18 @@ export function setupReleaseActionForTesting<T extends ReleaseAction>(\n   spyOn(console, 'promptConfirm').and.resolveTo(true);\n \n   // Fake all external commands for the release tool.\n-  spyOn(npm, 'runNpmPublish').and.resolveTo(true);\n+  spyOn(npm, 'runNpmPublish').and.resolveTo();\n   spyOn(externalCommands, 'invokeSetNpmDistCommand').and.resolveTo();\n   spyOn(externalCommands, 'invokeYarnInstallCommand').and.resolveTo();\n   spyOn(externalCommands, 'invokeReleaseBuildCommand').and.resolveTo([\n     {name: '@angular/pkg1', outputPath: `${testTmpDir}/dist/pkg1`},\n     {name: '@angular/pkg2', outputPath: `${testTmpDir}/dist/pkg2`}\n   ]);\n \n+  // Fake checking the package versions since we don't actually create packages to check against in\n+  // the publish tests.\n+  spyOn(ReleaseAction.prototype, '_verifyPackageVersions' as any).and.resolveTo();\n+\n   // Create an empty changelog and a `package.json` file so that file system\n   // interactions with the project directory do not cause exceptions.\n   writeFileSync(join(testTmpDir, 'CHANGELOG.md'), 'Existing changelog');"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 38,
        "deletions": 1
    }
}