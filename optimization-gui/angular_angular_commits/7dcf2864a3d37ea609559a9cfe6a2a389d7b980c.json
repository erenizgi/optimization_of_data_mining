{
    "author": "JoostK",
    "message": "feat(compiler-cli): expose function to allow short-circuiting of linking (#40137)\n\nThe linker is implemented using a Babel transform such that Babel needs\nto parse and walk a source file to find the declarations that need to be\ncompiled. If it can be determined that a source file is known not to\ncontain any declarations the parsing and walking can be skipped as a\nperformance improvement. This commit adds an exposed function for tools\nthat integrate the linker to use to allow short-circuiting of the linker\ntransform.\n\nPR Close #40137",
    "sha": "7dcf2864a3d37ea609559a9cfe6a2a389d7b980c",
    "files": [
        {
            "sha": "ae0962151afe6e2ba83ce6890e705f83193d33ec",
            "filename": "packages/compiler-cli/linker/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Flinker%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Flinker%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Findex.ts?ref=7dcf2864a3d37ea609559a9cfe6a2a389d7b980c",
            "patch": "@@ -12,3 +12,4 @@ export {DeclarationScope} from './src/file_linker/declaration_scope';\n export {FileLinker} from './src/file_linker/file_linker';\n export {LinkerEnvironment} from './src/file_linker/linker_environment';\n export {LinkerOptions} from './src/file_linker/linker_options';\n+export {needsLinking} from './src/file_linker/needs_linking';"
        },
        {
            "sha": "1a0901e5194617f45a3394ce1e303d3ca0849d6d",
            "filename": "packages/compiler-cli/linker/src/file_linker/needs_linking.ts",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fneeds_linking.ts",
            "raw_url": "https://github.com/angular/angular/raw/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fneeds_linking.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fneeds_linking.ts?ref=7dcf2864a3d37ea609559a9cfe6a2a389d7b980c",
            "patch": "@@ -0,0 +1,28 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {declarationFunctions} from './partial_linkers/partial_linker_selector';\n+\n+/**\n+ * Determines if the provided source file may need to be processed by the linker, i.e. whether it\n+ * potentially contains any declarations. If true is returned, then the source file should be\n+ * processed by the linker as it may contain declarations that need to be fully compiled. If false\n+ * is returned, parsing and processing of the source file can safely be skipped to improve\n+ * performance.\n+ *\n+ * This function may return true even for source files that don't actually contain any declarations\n+ * that need to be compiled.\n+ *\n+ * @param path the absolute path of the source file for which to determine whether linking may be\n+ * needed.\n+ * @param source the source file content as a string.\n+ * @returns whether the source file may contain declarations that need to be linked.\n+ */\n+export function needsLinking(path: string, source: string): boolean {\n+  return declarationFunctions.some(fn => source.includes(fn));\n+}"
        },
        {
            "sha": "6d24c3d127ad2836a24d0278a0ea3a5386282e6c",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_linker_selector.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "raw_url": "https://github.com/angular/angular/raw/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts?ref=7dcf2864a3d37ea609559a9cfe6a2a389d7b980c",
            "patch": "@@ -12,6 +12,10 @@ import {PartialComponentLinkerVersion1} from './partial_component_linker_1';\n import {PartialDirectiveLinkerVersion1} from './partial_directive_linker_1';\n import {PartialLinker} from './partial_linker';\n \n+export const ɵɵngDeclareDirective = 'ɵɵngDeclareDirective';\n+export const ɵɵngDeclareComponent = 'ɵɵngDeclareComponent';\n+export const declarationFunctions = [ɵɵngDeclareDirective, ɵɵngDeclareComponent];\n+\n export class PartialLinkerSelector<TExpression> {\n   /**\n    * A database of linker instances that should be used if their given semver range satisfies the\n@@ -27,11 +31,11 @@ export class PartialLinkerSelector<TExpression> {\n    * allows the linker to work on local builds effectively.\n    */\n   private linkers: Record<string, {range: string, linker: PartialLinker<TExpression>}[]> = {\n-    'ɵɵngDeclareDirective': [\n+    [ɵɵngDeclareDirective]: [\n       {range: '0.0.0-PLACEHOLDER', linker: new PartialDirectiveLinkerVersion1()},\n       {range: '>=11.1.0-next.1', linker: new PartialDirectiveLinkerVersion1()},\n     ],\n-    'ɵɵngDeclareComponent':\n+    [ɵɵngDeclareComponent]:\n         [\n           {range: '0.0.0-PLACEHOLDER', linker: new PartialComponentLinkerVersion1(this.options)},\n           {range: '>=11.1.0-next.1', linker: new PartialComponentLinkerVersion1(this.options)},"
        },
        {
            "sha": "b83842939e7f083527464e1f31bedb4492ee3937",
            "filename": "packages/compiler-cli/linker/test/file_linker/needs_linking_spec.ts",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/angular/angular/blob/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fneeds_linking_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fneeds_linking_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fneeds_linking_spec.ts?ref=7dcf2864a3d37ea609559a9cfe6a2a389d7b980c",
            "patch": "@@ -0,0 +1,67 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {needsLinking} from '../../src/file_linker/needs_linking';\n+\n+describe('needsLinking', () => {\n+  it('should return true for directive declarations', () => {\n+    expect(needsLinking('file.js', `\n+      export class Dir {\n+        ɵdir = ɵɵngDeclareDirective({type: Dir});\n+      }\n+    `)).toBeTrue();\n+  });\n+\n+  it('should return true for namespaced directive declarations', () => {\n+    expect(needsLinking('file.js', `\n+      export class Dir {\n+        ɵdir = ng.ɵɵngDeclareDirective({type: Dir});\n+      }\n+    `)).toBeTrue();\n+  });\n+\n+  it('should return true for unrelated usages of ɵɵngDeclareDirective', () => {\n+    expect(needsLinking('file.js', `\n+      const fnName = 'ɵɵngDeclareDirective';\n+    `)).toBeTrue();\n+  });\n+\n+  it('should return false when the file does not contain ɵɵngDeclareDirective', () => {\n+    expect(needsLinking('file.js', `\n+      const foo = ngDeclareDirective;\n+    `)).toBeFalse();\n+  });\n+\n+  it('should return true for component declarations', () => {\n+    expect(needsLinking('file.js', `\n+      export class Cmp {\n+        ɵdir = ɵɵngDeclareComponent({type: Cmp});\n+      }\n+    `)).toBeTrue();\n+  });\n+\n+  it('should return true for namespaced component declarations', () => {\n+    expect(needsLinking('file.js', `\n+      export class Cmp {\n+        ɵdir = ng.ɵɵngDeclareComponent({type: Cmp});\n+      }\n+    `)).toBeTrue();\n+  });\n+\n+  it('should return true for unrelated usages of ɵɵngDeclareComponent', () => {\n+    expect(needsLinking('file.js', `\n+      const fnName = 'ɵɵngDeclareComponent';\n+    `)).toBeTrue();\n+  });\n+\n+  it('should return false when the file does not contain ɵɵngDeclareComponent', () => {\n+    expect(needsLinking('file.js', `\n+      const foo = ngDeclareComponent;\n+    `)).toBeFalse();\n+  });\n+});"
        },
        {
            "sha": "7f2f0b16fec4ffa0703bd8d3678e9c2be7174c31",
            "filename": "packages/compiler-cli/test/compliance/linked/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2FBUILD.bazel?ref=7dcf2864a3d37ea609559a9cfe6a2a389d7b980c",
            "patch": "@@ -5,6 +5,7 @@ ts_library(\n     testonly = True,\n     srcs = [\"linked_compile_spec.ts\"],\n     deps = [\n+        \"//packages/compiler-cli/linker\",\n         \"//packages/compiler-cli/linker/babel\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/logging\","
        },
        {
            "sha": "4e09b1397aee61ab49e7bbd051e726bd7109da15",
            "filename": "packages/compiler-cli/test/compliance/linked/linked_compile_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts?ref=7dcf2864a3d37ea609559a9cfe6a2a389d7b980c",
            "patch": "@@ -7,6 +7,7 @@\n  */\n import {PluginObj, transformSync} from '@babel/core';\n \n+import {needsLinking} from '../../../linker';\n import {createEs2015LinkerPlugin} from '../../../linker/babel';\n import {AbsoluteFsPath, FileSystem} from '../../../src/ngtsc/file_system';\n import {ConsoleLogger, LogLevel} from '../../../src/ngtsc/logging';\n@@ -57,7 +58,7 @@ function linkPartials(fs: FileSystem, test: ComplianceTest): CompileResult {\n       const sourceMap =\n           fs.exists(sourceMapPath) ? JSON.parse(fs.readFile(sourceMapPath)) : undefined;\n       const {linkedSource, linkedSourceMap} =\n-          applyLinker({fileName, source, sourceMap}, linkerPlugin);\n+          applyLinker({path: partialPath, source, sourceMap}, linkerPlugin);\n \n       if (linkedSourceMap !== undefined) {\n         const mapAndPath: MapAndPath = {map: linkedSourceMap, mapPath: sourceMapPath};\n@@ -75,18 +76,18 @@ function linkPartials(fs: FileSystem, test: ComplianceTest): CompileResult {\n  *\n  * It will ignore files that do not have a `.js` extension.\n  *\n- * @param file The file name and its source to be transformed using the linker.\n+ * @param file The absolute file path and its source to be transformed using the linker.\n  * @param linkerPlugin The linker plugin to apply.\n  * @returns The file's source content, which has been transformed using the linker if necessary.\n  */\n function applyLinker(\n-    file: {fileName: string; source: string, sourceMap: RawSourceMap | undefined},\n+    file: {path: string; source: string, sourceMap: RawSourceMap | undefined},\n     linkerPlugin: PluginObj): {linkedSource: string, linkedSourceMap: RawSourceMap|undefined} {\n-  if (!file.fileName.endsWith('.js')) {\n+  if (!file.path.endsWith('.js') || !needsLinking(file.path, file.source)) {\n     return {linkedSource: file.source, linkedSourceMap: file.sourceMap};\n   }\n   const result = transformSync(file.source, {\n-    filename: file.fileName,\n+    filename: file.path,\n     sourceMaps: !!file.sourceMap,\n     plugins: [linkerPlugin],\n     parserOpts: {sourceType: 'unambiguous'},"
        },
        {
            "sha": "99873782b489d1807d3753d84c60dc061c405881",
            "filename": "packages/compiler-cli/test/compliance_old/prelink/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2FBUILD.bazel?ref=7dcf2864a3d37ea609559a9cfe6a2a389d7b980c",
            "patch": "@@ -6,6 +6,7 @@ ts_library(\n     srcs = [\"bootstrap.ts\"],\n     deps = [\n         \"//packages:types\",\n+        \"//packages/compiler-cli/linker\",\n         \"//packages/compiler-cli/linker/babel\",\n         \"//packages/compiler-cli/test/compliance_old/mock_compile\",\n         \"@npm//@babel/core\","
        },
        {
            "sha": "262df8548998a65ea79854825f0cfd927a348b87",
            "filename": "packages/compiler-cli/test/compliance_old/prelink/bootstrap.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2Fbootstrap.ts",
            "raw_url": "https://github.com/angular/angular/raw/7dcf2864a3d37ea609559a9cfe6a2a389d7b980c/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2Fbootstrap.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2Fbootstrap.ts?ref=7dcf2864a3d37ea609559a9cfe6a2a389d7b980c",
            "patch": "@@ -8,6 +8,7 @@\n import {PluginObj, transformSync} from '@babel/core';\n import * as ts from 'typescript';\n \n+import {needsLinking} from '../../../linker';\n import {createEs2015LinkerPlugin} from '../../../linker/babel';\n import {compileFiles, CompileFn, setCompileFn} from '../mock_compile';\n \n@@ -34,24 +35,27 @@ const linkedCompile: CompileFn = (data, angularFiles, options) => {\n     ...options,\n   });\n \n-  const source = compiledFiles.map(file => applyLinker(file, linkerPlugin)).join('\\n');\n+  const source =\n+      compiledFiles\n+          .map(file => applyLinker({path: file.fileName, source: file.source}, linkerPlugin))\n+          .join('\\n');\n \n   return {source};\n };\n \n /**\n  * Runs the provided code through the Babel linker plugin, if the file has the .js extension.\n  *\n- * @param file The file name and its source to be transformed using the linker.\n+ * @param file The absolute file path and its source to be transformed using the linker.\n  * @param linkerPlugin The linker plugin to apply.\n  * @returns The file's source content, which has been transformed using the linker if necessary.\n  */\n-function applyLinker(file: {fileName: string; source: string}, linkerPlugin: PluginObj): string {\n-  if (!file.fileName.endsWith('.js')) {\n+function applyLinker(file: {path: string; source: string}, linkerPlugin: PluginObj): string {\n+  if (!file.path.endsWith('.js') || !needsLinking(file.path, file.source)) {\n     return file.source;\n   }\n   const result = transformSync(file.source, {\n-    filename: file.fileName,\n+    filename: file.path,\n     plugins: [linkerPlugin],\n     parserOpts: {sourceType: 'unambiguous'},\n   });"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 119,
        "deletions": 12
    }
}