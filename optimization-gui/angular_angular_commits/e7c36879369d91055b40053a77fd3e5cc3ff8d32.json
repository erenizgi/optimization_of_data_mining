{
    "author": "petebacondarwin",
    "message": "refactor(compiler): synthesize external template node for partial compilation (#40237)\n\nWhen partially compiling a component with an external template, we must\nsynthesize a new AST node for the string literal that holds the contents of\nthe external template, since we want to source-map this expression directly\nback to the original external template file.\n\nPR Close #40237",
    "sha": "e7c36879369d91055b40053a77fd3e5cc3ff8d32",
    "files": [
        {
            "sha": "699cedcf4f0a3f814f334df2cbc0c9d746abadf3",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/e7c36879369d91055b40053a77fd3e5cc3ff8d32/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/e7c36879369d91055b40053a77fd3e5cc3ff8d32/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=e7c36879369d91055b40053a77fd3e5cc3ff8d32",
            "patch": "@@ -958,14 +958,6 @@ function sourceMapUrl(resourceUrl: string): string {\n  * some of which might be useful for re-parsing the template with different options.\n  */\n export interface ParsedComponentTemplate extends ParsedTemplate {\n-  /**\n-   * A full path to the file which contains the template.\n-   *\n-   * This can be either the original .ts file if the template is inline, or the .html file if an\n-   * external file was used.\n-   */\n-  templateUrl: string;\n-\n   /**\n    * True if the original template was stored inline;\n    * False if the template was in an external file."
        },
        {
            "sha": "5a61485ad33f3ea97d8633085b392c452c9ccc8e",
            "filename": "packages/compiler/src/render3/partial/component.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 3,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/e7c36879369d91055b40053a77fd3e5cc3ff8d32/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/e7c36879369d91055b40053a77fd3e5cc3ff8d32/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts?ref=e7c36879369d91055b40053a77fd3e5cc3ff8d32",
            "patch": "@@ -8,13 +8,14 @@\n import * as core from '../../core';\n import {DEFAULT_INTERPOLATION_CONFIG} from '../../ml_parser/interpolation_config';\n import * as o from '../../output/output_ast';\n+import {ParseLocation, ParseSourceFile, ParseSourceSpan} from '../../parse_util';\n import {Identifiers as R3} from '../r3_identifiers';\n import {DeclarationListEmitMode, R3ComponentDef, R3ComponentMetadata, R3UsedDirectiveMetadata} from '../view/api';\n import {createComponentType} from '../view/compiler';\n import {ParsedTemplate} from '../view/template';\n import {DefinitionMap} from '../view/util';\n-import {R3DeclareComponentMetadata} from './api';\n \n+import {R3DeclareComponentMetadata} from './api';\n import {createDirectiveDefinitionMap} from './directive';\n import {toOptionalLiteralArray} from './util';\n \n@@ -79,13 +80,50 @@ export function createComponentDefinitionMap(meta: R3ComponentMetadata, template\n  */\n function compileTemplateDefinition(template: ParsedTemplate): o.LiteralMapExpr {\n   const templateMap = new DefinitionMap<R3DeclareComponentMetadata['template']>();\n-  const templateExpr =\n-      typeof template.template === 'string' ? o.literal(template.template) : template.template;\n+  const templateExpr = getTemplateExpression(template);\n   templateMap.set('source', templateExpr);\n   templateMap.set('isInline', o.literal(template.isInline));\n   return templateMap.toLiteralMap();\n }\n \n+function getTemplateExpression(template: ParsedTemplate): o.Expression {\n+  if (typeof template.template === 'string') {\n+    if (template.isInline) {\n+      // The template is inline but not a simple literal string, so give up with trying to\n+      // source-map it and just return a simple literal here.\n+      return o.literal(template.template);\n+    } else {\n+      // The template is external so we must synthesize an expression node with the appropriate\n+      // source-span.\n+      const contents = template.template;\n+      const file = new ParseSourceFile(contents, template.templateUrl);\n+      const start = new ParseLocation(file, 0, 0, 0);\n+      const end = computeEndLocation(file, contents);\n+      const span = new ParseSourceSpan(start, end);\n+      return o.literal(contents, null, span);\n+    }\n+  } else {\n+    // The template is inline so we can just reuse the current expression node.\n+    return template.template;\n+  }\n+}\n+\n+function computeEndLocation(file: ParseSourceFile, contents: string): ParseLocation {\n+  const length = contents.length;\n+  let lineStart = 0;\n+  let lastLineStart = 0;\n+  let line = 0;\n+  do {\n+    lineStart = contents.indexOf('\\n', lastLineStart);\n+    if (lineStart !== -1) {\n+      lastLineStart = lineStart + 1;\n+      line++;\n+    }\n+  } while (lineStart !== -1);\n+\n+  return new ParseLocation(file, length, line, length - lastLineStart);\n+}\n+\n /**\n  * Compiles the directives as registered in the component metadata into an array literal of the\n  * individual directives. If the component does not use any directives, then null is returned."
        },
        {
            "sha": "a1e77ada50b1efd6d11172e55bbddf57f205cc4a",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/e7c36879369d91055b40053a77fd3e5cc3ff8d32/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/e7c36879369d91055b40053a77fd3e5cc3ff8d32/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=e7c36879369d91055b40053a77fd3e5cc3ff8d32",
            "patch": "@@ -2092,6 +2092,7 @@ export function parseTemplate(\n       interpolationConfig,\n       preserveWhitespaces,\n       template,\n+      templateUrl,\n       isInline,\n       errors: parseResult.errors,\n       nodes: [],\n@@ -2117,6 +2118,7 @@ export function parseTemplate(\n       interpolationConfig,\n       preserveWhitespaces,\n       template,\n+      templateUrl,\n       isInline,\n       errors: i18nMetaResult.errors,\n       nodes: [],\n@@ -2149,6 +2151,7 @@ export function parseTemplate(\n     preserveWhitespaces,\n     errors: errors.length > 0 ? errors : null,\n     template,\n+    templateUrl,\n     isInline,\n     nodes,\n     styleUrls,\n@@ -2321,6 +2324,14 @@ export interface ParsedTemplate {\n    */\n   template: string|o.Expression;\n \n+  /**\n+   * A full path to the file which contains the template.\n+   *\n+   * This can be either the original .ts file if the template is inline, or the .html file if an\n+   * external file was used.\n+   */\n+  templateUrl: string;\n+\n   /**\n    * Whether the template was inline (using `template`) or external (using `templateUrl`).\n    */"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 52,
        "deletions": 11
    }
}