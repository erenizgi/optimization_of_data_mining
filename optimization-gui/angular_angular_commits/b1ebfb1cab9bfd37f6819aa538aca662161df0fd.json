{
    "author": "josephperrott",
    "message": "feat(dev-infra): support squashing fixups in the `ng-dev pr rebase` command (#39747)\n\nAdding support for squashing fixup commits during when rebasing can allow\nfor rebasing to better unblock things like merging.\n\nPR Close #39747",
    "sha": "b1ebfb1cab9bfd37f6819aa538aca662161df0fd",
    "files": [
        {
            "sha": "a86d2d3ac30b40c43ac33b43046d2e8b68ed2a87",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 40,
            "deletions": 34,
            "changes": 74,
            "blob_url": "https://github.com/angular/angular/blob/b1ebfb1cab9bfd37f6819aa538aca662161df0fd/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/b1ebfb1cab9bfd37f6819aa538aca662161df0fd/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=b1ebfb1cab9bfd37f6819aa538aca662161df0fd",
            "patch": "@@ -1779,6 +1779,30 @@ function parseCommitMessage(commitMsg) {\n         isRevert: REVERT_PREFIX_RE.test(commitMsg),\n     };\n }\n+/** Retrieve and parse each commit message in a provide range. */\n+function parseCommitMessagesForRange(range) {\n+    /** A random number used as a split point in the git log result. */\n+    const randomValueSeparator = `${Math.random()}`;\n+    /**\n+     * Custom git log format that provides the commit header and body, separated as expected with the\n+     * custom separator as the trailing value.\n+     */\n+    const gitLogFormat = `%s%n%n%b${randomValueSeparator}`;\n+    // Retrieve the commits in the provided range.\n+    const result = exec(`git log --reverse --format=${gitLogFormat} ${range}`);\n+    if (result.code) {\n+        throw new Error(`Failed to get all commits in the range:\\n  ${result.stderr}`);\n+    }\n+    return result\n+        // Separate the commits from a single string into individual commits.\n+        .split(randomValueSeparator)\n+        // Remove extra space before and after each commit message.\n+        .map(l => l.trim())\n+        // Remove any superfluous lines which remain from the split.\n+        .filter(line => !!line)\n+        // Parse each commit message.\n+        .map(commit => parseCommitMessage(commit));\n+}\n \n /**\n  * @license\n@@ -1980,38 +2004,6 @@ const ValidateFileModule = {\n     describe: 'Validate the most recent commit message',\n };\n \n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-/** Retrieve and parse each commit message in a provide range. */\n-function parseCommitMessagesForRange(range) {\n-    /** A random number used as a split point in the git log result. */\n-    const randomValueSeparator = `${Math.random()}`;\n-    /**\n-     * Custom git log format that provides the commit header and body, separated as expected with the\n-     * custom separator as the trailing value.\n-     */\n-    const gitLogFormat = `%s%n%n%b${randomValueSeparator}`;\n-    // Retrieve the commits in the provided range.\n-    const result = exec(`git log --reverse --format=${gitLogFormat} ${range}`);\n-    if (result.code) {\n-        throw new Error(`Failed to get all commits in the range:\\n  ${result.stderr}`);\n-    }\n-    return result\n-        // Separate the commits from a single string into individual commits.\n-        .split(randomValueSeparator)\n-        // Remove extra space before and after each commit message.\n-        .map(l => l.trim())\n-        // Remove any superfluous lines which remain from the split.\n-        .filter(line => !!line)\n-        // Parse each commit message.\n-        .map(commit => parseCommitMessage(commit));\n-}\n-\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n@@ -4352,12 +4344,26 @@ function rebasePr(prNumber, githubToken, config = getConfig()) {\n             // Fetch the branch at the commit of the PR, and check it out in a detached state.\n             info(`Checking out PR #${prNumber} from ${fullHeadRef}`);\n             git.run(['fetch', '-q', headRefUrl, headRefName]);\n-            git.run(['checkout', '--detach', 'FETCH_HEAD']);\n+            git.run(['checkout', '-q', '--detach', 'FETCH_HEAD']);\n             // Fetch the PRs target branch and rebase onto it.\n             info(`Fetching ${fullBaseRef} to rebase #${prNumber} on`);\n             git.run(['fetch', '-q', baseRefUrl, baseRefName]);\n+            const commonAncestorSha = git.run(['merge-base', 'HEAD', 'FETCH_HEAD']).stdout.trim();\n+            const commits = parseCommitMessagesForRange(`${commonAncestorSha}..HEAD`);\n+            let squashFixups = commits.filter((commit) => commit.isFixup).length === 0 ?\n+                false :\n+                yield promptConfirm(`PR #${prNumber} contains fixup commits, would you like to squash them during rebase?`, true);\n             info(`Attempting to rebase PR #${prNumber} on ${fullBaseRef}`);\n-            const rebaseResult = git.runGraceful(['rebase', 'FETCH_HEAD']);\n+            /**\n+             * Tuple of flags to be added to the rebase command and env object to run the git command.\n+             *\n+             * Additional flags to perform the autosquashing are added when the user confirm squashing of\n+             * fixup commits should occur.\n+             */\n+            const [flags, env] = squashFixups ?\n+                [['--interactive', '--autosquash'], Object.assign(Object.assign({}, process.env), { GIT_SEQUENCE_EDITOR: 'true' })] :\n+                [[], undefined];\n+            const rebaseResult = git.runGraceful(['rebase', ...flags, 'FETCH_HEAD'], { env: env });\n             // If the rebase was clean, push the rebased PR up to the authors fork.\n             if (rebaseResult.status === 0) {\n                 info(`Rebase was able to complete automatically without conflicts`);"
        },
        {
            "sha": "6b420d8f6f23eba2a34110cc41b6da027288abc4",
            "filename": "dev-infra/pr/rebase/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/b1ebfb1cab9bfd37f6819aa538aca662161df0fd/dev-infra%2Fpr%2Frebase%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b1ebfb1cab9bfd37f6819aa538aca662161df0fd/dev-infra%2Fpr%2Frebase%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Frebase%2FBUILD.bazel?ref=b1ebfb1cab9bfd37f6819aa538aca662161df0fd",
            "patch": "@@ -9,6 +9,7 @@ ts_library(\n     module_name = \"@angular/dev-infra-private/pr/rebase\",\n     visibility = [\"//dev-infra:__subpackages__\"],\n     deps = [\n+        \"//dev-infra/commit-message\",\n         \"//dev-infra/utils\",\n         \"@npm//@types/inquirer\",\n         \"@npm//@types/node\","
        },
        {
            "sha": "48aecbbc37a2ffc18be362323f31e59db65a0a0f",
            "filename": "dev-infra/pr/rebase/index.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 3,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/b1ebfb1cab9bfd37f6819aa538aca662161df0fd/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1ebfb1cab9bfd37f6819aa538aca662161df0fd/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Frebase%2Findex.ts?ref=b1ebfb1cab9bfd37f6819aa538aca662161df0fd",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import {types as graphQLTypes} from 'typed-graphqlify';\n+import {parseCommitMessagesForRange, ParsedCommitMessage} from '../../commit-message/parse';\n \n import {getConfig, NgDevConfig} from '../../utils/config';\n import {error, info, promptConfirm} from '../../utils/console';\n@@ -85,13 +86,34 @@ export async function rebasePr(\n     // Fetch the branch at the commit of the PR, and check it out in a detached state.\n     info(`Checking out PR #${prNumber} from ${fullHeadRef}`);\n     git.run(['fetch', '-q', headRefUrl, headRefName]);\n-    git.run(['checkout', '--detach', 'FETCH_HEAD']);\n-\n+    git.run(['checkout', '-q', '--detach', 'FETCH_HEAD']);\n     // Fetch the PRs target branch and rebase onto it.\n     info(`Fetching ${fullBaseRef} to rebase #${prNumber} on`);\n     git.run(['fetch', '-q', baseRefUrl, baseRefName]);\n+\n+    const commonAncestorSha = git.run(['merge-base', 'HEAD', 'FETCH_HEAD']).stdout.trim();\n+\n+    const commits = parseCommitMessagesForRange(`${commonAncestorSha}..HEAD`);\n+\n+    let squashFixups =\n+        commits.filter((commit: ParsedCommitMessage) => commit.isFixup).length === 0 ?\n+        false :\n+        await promptConfirm(\n+            `PR #${prNumber} contains fixup commits, would you like to squash them during rebase?`,\n+            true);\n+\n     info(`Attempting to rebase PR #${prNumber} on ${fullBaseRef}`);\n-    const rebaseResult = git.runGraceful(['rebase', 'FETCH_HEAD']);\n+\n+    /**\n+     * Tuple of flags to be added to the rebase command and env object to run the git command.\n+     *\n+     * Additional flags to perform the autosquashing are added when the user confirm squashing of\n+     * fixup commits should occur.\n+     */\n+    const [flags, env] = squashFixups ?\n+        [['--interactive', '--autosquash'], {...process.env, GIT_SEQUENCE_EDITOR: 'true'}] :\n+        [[], undefined];\n+    const rebaseResult = git.runGraceful(['rebase', ...flags, 'FETCH_HEAD'], {env: env});\n \n     // If the rebase was clean, push the rebased PR up to the authors fork.\n     if (rebaseResult.status === 0) {"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 66,
        "deletions": 37
    }
}