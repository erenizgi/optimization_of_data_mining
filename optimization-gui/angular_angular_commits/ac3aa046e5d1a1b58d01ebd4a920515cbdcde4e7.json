{
    "author": "petebacondarwin",
    "message": "refactor(compiler-cli): avoid free-standing `FileSystem` functions (#39006)\n\nThese free standing functions rely upon the \"current\" `FileSystem`,\nbut it is safer to explicitly pass the `FileSystem` into functions or\nclasses that need it.\n\nPR Close #39006",
    "sha": "ac3aa046e5d1a1b58d01ebd4a920515cbdcde4e7",
    "files": [
        {
            "sha": "43e1b841ea53e295662210635f78c131916c7074",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/src/source_file.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/ac3aa046e5d1a1b58d01ebd4a920515cbdcde4e7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file.ts",
            "raw_url": "https://github.com/angular/angular/raw/ac3aa046e5d1a1b58d01ebd4a920515cbdcde4e7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file.ts?ref=ac3aa046e5d1a1b58d01ebd4a920515cbdcde4e7",
            "patch": "@@ -8,7 +8,7 @@\n import {removeComments, removeMapFileComments} from 'convert-source-map';\n import {decode, encode, SourceMapMappings, SourceMapSegment} from 'sourcemap-codec';\n \n-import {AbsoluteFsPath, dirname, relative} from '../../file_system';\n+import {AbsoluteFsPath, FileSystem} from '../../file_system';\n \n import {RawSourceMap} from './raw_source_map';\n import {compareSegments, offsetSegment, SegmentMarker} from './segment_marker';\n@@ -38,7 +38,9 @@ export class SourceFile {\n       /** Whether this source file's source map was inline or external. */\n       readonly inline: boolean,\n       /** Any source files referenced by the raw source map associated with this source file. */\n-      readonly sources: (SourceFile|null)[]) {\n+      readonly sources: (SourceFile|null)[],\n+      private fs: FileSystem,\n+  ) {\n     this.contents = removeSourceMapComments(contents);\n     this.startOfLinePositions = computeStartOfLinePositions(this.contents);\n     this.flattenedMappings = this.flattenMappings();\n@@ -75,11 +77,11 @@ export class SourceFile {\n       mappings[line].push(mappingArray);\n     }\n \n-    const sourcePathDir = dirname(this.sourcePath);\n+    const sourcePathDir = this.fs.dirname(this.sourcePath);\n     const sourceMap: RawSourceMap = {\n       version: 3,\n-      file: relative(sourcePathDir, this.sourcePath),\n-      sources: sources.map(sf => relative(sourcePathDir, sf.sourcePath)),\n+      file: this.fs.relative(sourcePathDir, this.sourcePath),\n+      sources: sources.map(sf => this.fs.relative(sourcePathDir, sf.sourcePath)),\n       names,\n       mappings: encode(mappings),\n       sourcesContent: sources.map(sf => sf.contents),"
        },
        {
            "sha": "7017144bb675a76a25f937a6e4240e21a259d618",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/src/source_file_loader.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/ac3aa046e5d1a1b58d01ebd4a920515cbdcde4e7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts",
            "raw_url": "https://github.com/angular/angular/raw/ac3aa046e5d1a1b58d01ebd4a920515cbdcde4e7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts?ref=ac3aa046e5d1a1b58d01ebd4a920515cbdcde4e7",
            "patch": "@@ -7,7 +7,7 @@\n  */\n import {commentRegex, fromComment, mapFileCommentRegex} from 'convert-source-map';\n \n-import {absoluteFrom, AbsoluteFsPath, FileSystem} from '../../file_system';\n+import {AbsoluteFsPath, FileSystem} from '../../file_system';\n import {Logger} from '../../logging';\n \n import {RawSourceMap} from './raw_source_map';\n@@ -83,7 +83,7 @@ export class SourceFileLoader {\n         inline = mapAndPath.mapPath === null;\n       }\n \n-      return new SourceFile(sourcePath, contents, map, inline, sources);\n+      return new SourceFile(sourcePath, contents, map, inline, sources, this.fs);\n     } catch (e) {\n       this.logger.warn(\n           `Unable to fully load ${sourcePath} for source-map flattening: ${e.message}`);\n@@ -124,7 +124,7 @@ export class SourceFileLoader {\n       }\n     }\n \n-    const impliedMapPath = absoluteFrom(sourcePath + '.map');\n+    const impliedMapPath = this.fs.resolve(sourcePath + '.map');\n     if (this.fs.exists(impliedMapPath)) {\n       return {map: this.readRawSourceMap(impliedMapPath), mapPath: impliedMapPath};\n     }"
        },
        {
            "sha": "a6fb591a4f2793cede8a56685ffe9b4ead822b8d",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/test/source_file_spec.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 32,
            "changes": 69,
            "blob_url": "https://github.com/angular/angular/blob/ac3aa046e5d1a1b58d01ebd4a920515cbdcde4e7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ac3aa046e5d1a1b58d01ebd4a920515cbdcde4e7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_spec.ts?ref=ac3aa046e5d1a1b58d01ebd4a920515cbdcde4e7",
            "patch": "@@ -7,17 +7,19 @@\n  */\n import {encode} from 'sourcemap-codec';\n \n-import {absoluteFrom} from '../../file_system';\n+import {absoluteFrom, FileSystem, getFileSystem} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n import {RawSourceMap} from '../src/raw_source_map';\n import {SegmentMarker} from '../src/segment_marker';\n import {computeStartOfLinePositions, ensureOriginalSegmentLinks, extractOriginalSegments, findLastMappingIndexBefore, Mapping, parseMappings, SourceFile} from '../src/source_file';\n \n runInEachFileSystem(() => {\n   describe('SourceFile and utilities', () => {\n+    let fs: FileSystem;\n     let _: typeof absoluteFrom;\n \n     beforeEach(() => {\n+      fs = getFileSystem();\n       _ = absoluteFrom;\n     });\n \n@@ -40,7 +42,7 @@ runInEachFileSystem(() => {\n           sources: ['a.js'],\n           version: 3\n         };\n-        const originalSource = new SourceFile(_('/foo/src/a.js'), 'abcdefg', null, false, []);\n+        const originalSource = new SourceFile(_('/foo/src/a.js'), 'abcdefg', null, false, [], fs);\n         const mappings = parseMappings(rawSourceMap, [originalSource], [0, 8]);\n         expect(mappings).toEqual([\n           {\n@@ -71,7 +73,8 @@ runInEachFileSystem(() => {\n \n       it('should parse the segments in ascending order of original position from the raw source map',\n          () => {\n-           const originalSource = new SourceFile(_('/foo/src/a.js'), 'abcdefg', null, false, []);\n+           const originalSource =\n+               new SourceFile(_('/foo/src/a.js'), 'abcdefg', null, false, [], fs);\n            const rawSourceMap: RawSourceMap = {\n              mappings: encode([[[0, 0, 0, 0], [2, 0, 0, 3], [4, 0, 0, 2]]]),\n              names: [],\n@@ -88,8 +91,8 @@ runInEachFileSystem(() => {\n          });\n \n       it('should create separate arrays for each original source file', () => {\n-        const sourceA = new SourceFile(_('/foo/src/a.js'), 'abcdefg', null, false, []);\n-        const sourceB = new SourceFile(_('/foo/src/b.js'), '1234567', null, false, []);\n+        const sourceA = new SourceFile(_('/foo/src/a.js'), 'abcdefg', null, false, [], fs);\n+        const sourceB = new SourceFile(_('/foo/src/b.js'), '1234567', null, false, [], fs);\n         const rawSourceMap: RawSourceMap = {\n           mappings:\n               encode([[[0, 0, 0, 0], [2, 1, 0, 3], [4, 0, 0, 2], [5, 1, 0, 5], [6, 1, 0, 2]]]),\n@@ -313,8 +316,8 @@ runInEachFileSystem(() => {\n     describe('ensureOriginalSegmentLinks', () => {\n       it('should add `next` properties to each segment that point to the next segment in the same source file',\n          () => {\n-           const sourceA = new SourceFile(_('/foo/src/a.js'), 'abcdefg', null, false, []);\n-           const sourceB = new SourceFile(_('/foo/src/b.js'), '1234567', null, false, []);\n+           const sourceA = new SourceFile(_('/foo/src/a.js'), 'abcdefg', null, false, [], fs);\n+           const sourceB = new SourceFile(_('/foo/src/b.js'), '1234567', null, false, [], fs);\n            const rawSourceMap: RawSourceMap = {\n              mappings:\n                  encode([[[0, 0, 0, 0], [2, 1, 0, 3], [4, 0, 0, 2], [5, 1, 0, 5], [6, 1, 0, 2]]]),\n@@ -336,14 +339,14 @@ runInEachFileSystem(() => {\n       describe('flattenedMappings', () => {\n         it('should be an empty array for source files with no source map', () => {\n           const sourceFile =\n-              new SourceFile(_('/foo/src/index.js'), 'index contents', null, false, []);\n+              new SourceFile(_('/foo/src/index.js'), 'index contents', null, false, [], fs);\n           expect(sourceFile.flattenedMappings).toEqual([]);\n         });\n \n         it('should be empty array for source files with no source map mappings', () => {\n           const rawSourceMap: RawSourceMap = {mappings: '', names: [], sources: [], version: 3};\n           const sourceFile =\n-              new SourceFile(_('/foo/src/index.js'), 'index contents', rawSourceMap, false, []);\n+              new SourceFile(_('/foo/src/index.js'), 'index contents', rawSourceMap, false, [], fs);\n           expect(sourceFile.flattenedMappings).toEqual([]);\n         });\n \n@@ -355,25 +358,26 @@ runInEachFileSystem(() => {\n                sources: ['a.js'],\n                version: 3\n              };\n-             const originalSource = new SourceFile(_('/foo/src/a.js'), 'abcdefg', null, false, []);\n+             const originalSource =\n+                 new SourceFile(_('/foo/src/a.js'), 'abcdefg', null, false, [], fs);\n              const sourceFile = new SourceFile(\n-                 _('/foo/src/index.js'), 'abc123defg', rawSourceMap, false, [originalSource]);\n+                 _('/foo/src/index.js'), 'abc123defg', rawSourceMap, false, [originalSource], fs);\n              expect(removeOriginalSegmentLinks(sourceFile.flattenedMappings))\n                  .toEqual(parseMappings(rawSourceMap, [originalSource], [0, 11]));\n            });\n \n         it('should merge mappings from flattened original source files', () => {\n-          const cSource = new SourceFile(_('/foo/src/c.js'), 'bcd123', null, false, []);\n-          const dSource = new SourceFile(_('/foo/src/d.js'), 'aef', null, false, []);\n+          const cSource = new SourceFile(_('/foo/src/c.js'), 'bcd123', null, false, [], fs);\n+          const dSource = new SourceFile(_('/foo/src/d.js'), 'aef', null, false, [], fs);\n \n           const bSourceMap: RawSourceMap = {\n             mappings: encode([[[0, 1, 0, 0], [1, 0, 0, 0], [4, 1, 0, 1]]]),\n             names: [],\n             sources: ['c.js', 'd.js'],\n             version: 3\n           };\n-          const bSource =\n-              new SourceFile(_('/foo/src/b.js'), 'abcdef', bSourceMap, false, [cSource, dSource]);\n+          const bSource = new SourceFile(\n+              _('/foo/src/b.js'), 'abcdef', bSourceMap, false, [cSource, dSource], fs);\n \n           const aSourceMap: RawSourceMap = {\n             mappings: encode([[[0, 0, 0, 0], [2, 0, 0, 3], [4, 0, 0, 2], [5, 0, 0, 5]]]),\n@@ -382,7 +386,7 @@ runInEachFileSystem(() => {\n             version: 3\n           };\n           const aSource =\n-              new SourceFile(_('/foo/src/a.js'), 'abdecf', aSourceMap, false, [bSource]);\n+              new SourceFile(_('/foo/src/a.js'), 'abdecf', aSourceMap, false, [bSource], fs);\n \n           expect(removeOriginalSegmentLinks(aSource.flattenedMappings)).toEqual([\n             {\n@@ -431,15 +435,16 @@ runInEachFileSystem(() => {\n             sources: ['c.js'],\n             version: 3\n           };\n-          const bSource = new SourceFile(_('/foo/src/b.js'), 'abcdef', bSourceMap, false, [null]);\n+          const bSource =\n+              new SourceFile(_('/foo/src/b.js'), 'abcdef', bSourceMap, false, [null], fs);\n           const aSourceMap: RawSourceMap = {\n             mappings: encode([[[0, 0, 0, 0], [2, 0, 0, 3], [4, 0, 0, 2], [5, 0, 0, 5]]]),\n             names: [],\n             sources: ['b.js'],\n             version: 3\n           };\n           const aSource =\n-              new SourceFile(_('/foo/src/a.js'), 'abdecf', aSourceMap, false, [bSource]);\n+              new SourceFile(_('/foo/src/a.js'), 'abdecf', aSourceMap, false, [bSource], fs);\n \n           // These flattened mappings are just the mappings from a to b.\n           // (The mappings to c are dropped since there is no source file to map to.)\n@@ -462,23 +467,23 @@ runInEachFileSystem(() => {\n \n       describe('renderFlattenedSourceMap()', () => {\n         it('should convert the flattenedMappings into a raw source-map object', () => {\n-          const cSource = new SourceFile(_('/foo/src/c.js'), 'bcd123e', null, false, []);\n+          const cSource = new SourceFile(_('/foo/src/c.js'), 'bcd123e', null, false, [], fs);\n           const bToCSourceMap: RawSourceMap = {\n             mappings: encode([[[1, 0, 0, 0], [4, 0, 0, 3], [4, 0, 0, 6], [5, 0, 0, 7]]]),\n             names: [],\n             sources: ['c.js'],\n             version: 3\n           };\n           const bSource =\n-              new SourceFile(_('/foo/src/b.js'), 'abcdef', bToCSourceMap, false, [cSource]);\n+              new SourceFile(_('/foo/src/b.js'), 'abcdef', bToCSourceMap, false, [cSource], fs);\n           const aToBSourceMap: RawSourceMap = {\n             mappings: encode([[[0, 0, 0, 0], [2, 0, 0, 3], [4, 0, 0, 2], [5, 0, 0, 5]]]),\n             names: [],\n             sources: ['b.js'],\n             version: 3\n           };\n           const aSource =\n-              new SourceFile(_('/foo/src/a.js'), 'abdecf', aToBSourceMap, false, [bSource]);\n+              new SourceFile(_('/foo/src/a.js'), 'abdecf', aToBSourceMap, false, [bSource], fs);\n \n           const aTocSourceMap = aSource.renderFlattenedSourceMap();\n           expect(aTocSourceMap.version).toEqual(3);\n@@ -493,7 +498,7 @@ runInEachFileSystem(() => {\n         });\n \n         it('should handle mappings that map from lines outside of the actual content lines', () => {\n-          const bSource = new SourceFile(_('/foo/src/b.js'), 'abcdef', null, false, []);\n+          const bSource = new SourceFile(_('/foo/src/b.js'), 'abcdef', null, false, [], fs);\n           const aToBSourceMap: RawSourceMap = {\n             mappings: encode([\n               [[0, 0, 0, 0], [2, 0, 0, 3], [4, 0, 0, 2], [5, 0, 0, 5]],\n@@ -506,7 +511,7 @@ runInEachFileSystem(() => {\n             version: 3\n           };\n           const aSource =\n-              new SourceFile(_('/foo/src/a.js'), 'abdecf', aToBSourceMap, false, [bSource]);\n+              new SourceFile(_('/foo/src/a.js'), 'abdecf', aToBSourceMap, false, [bSource], fs);\n \n           const aTocSourceMap = aSource.renderFlattenedSourceMap();\n           expect(aTocSourceMap.version).toEqual(3);\n@@ -522,13 +527,13 @@ runInEachFileSystem(() => {\n       describe('getOriginalLocation()', () => {\n         it('should return null for source files with no flattened mappings', () => {\n           const sourceFile =\n-              new SourceFile(_('/foo/src/index.js'), 'index contents', null, false, []);\n+              new SourceFile(_('/foo/src/index.js'), 'index contents', null, false, [], fs);\n           expect(sourceFile.getOriginalLocation(1, 1)).toEqual(null);\n         });\n \n         it('should return offset locations in multiple flattened original source files', () => {\n-          const cSource = new SourceFile(_('/foo/src/c.js'), 'bcd123', null, false, []);\n-          const dSource = new SourceFile(_('/foo/src/d.js'), 'aef', null, false, []);\n+          const cSource = new SourceFile(_('/foo/src/c.js'), 'bcd123', null, false, [], fs);\n+          const dSource = new SourceFile(_('/foo/src/d.js'), 'aef', null, false, [], fs);\n \n           const bSourceMap: RawSourceMap = {\n             mappings: encode([\n@@ -542,8 +547,8 @@ runInEachFileSystem(() => {\n             sources: ['c.js', 'd.js'],\n             version: 3\n           };\n-          const bSource =\n-              new SourceFile(_('/foo/src/b.js'), 'abcdef', bSourceMap, false, [cSource, dSource]);\n+          const bSource = new SourceFile(\n+              _('/foo/src/b.js'), 'abcdef', bSourceMap, false, [cSource, dSource], fs);\n \n           const aSourceMap: RawSourceMap = {\n             mappings: encode([\n@@ -560,7 +565,7 @@ runInEachFileSystem(() => {\n             version: 3\n           };\n           const aSource =\n-              new SourceFile(_('/foo/src/a.js'), 'abde\\n    cf', aSourceMap, false, [bSource]);\n+              new SourceFile(_('/foo/src/a.js'), 'abde\\n    cf', aSourceMap, false, [bSource], fs);\n \n           // Line 0\n           expect(aSource.getOriginalLocation(0, 0))  // a\n@@ -592,8 +597,8 @@ runInEachFileSystem(() => {\n         });\n \n         it('should return offset locations across multiple lines', () => {\n-          const originalSource =\n-              new SourceFile(_('/foo/src/original.js'), 'abcdef\\nghijk\\nlmnop', null, false, []);\n+          const originalSource = new SourceFile(\n+              _('/foo/src/original.js'), 'abcdef\\nghijk\\nlmnop', null, false, [], fs);\n           const generatedSourceMap: RawSourceMap = {\n             mappings: encode([\n               [\n@@ -614,7 +619,7 @@ runInEachFileSystem(() => {\n           };\n           const generatedSource = new SourceFile(\n               _('/foo/src/generated.js'), 'ABC\\nGHIJDEFK\\nLMNOP', generatedSourceMap, false,\n-              [originalSource]);\n+              [originalSource], fs);\n \n           // Line 0\n           expect(generatedSource.getOriginalLocation(0, 0))  // A"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 47,
        "deletions": 40
    }
}