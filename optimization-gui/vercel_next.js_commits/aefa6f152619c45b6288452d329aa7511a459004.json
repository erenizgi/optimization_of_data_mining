{
    "author": "timneutkens",
    "message": "Turbopack Build: Fix underscore path tests (#79778)\n\n## What?\n\nImplements handling for `%5F` to `_` conversion to handle pathnames in\nApp Router that want to bypass the underscore ignore folder.\n\nImplementing this was a bit of a hassle not on the Turbopack side but\nthere's an additional layer of route handling before the compiler that\nturns the filesystem paths into routable routes. Turns out there was\nsome additional places where the normalization needs to apply.\n\nFor now implemented it so that it special cases Turbopack handling,\nmight change the webpack implementation in the future to output the\nfiles into the same path that Turbopack outputs it at. This is only\nrelevant for dev, production is handled the same already.",
    "sha": "aefa6f152619c45b6288452d329aa7511a459004",
    "files": [
        {
            "sha": "a9d9f638642f9a975073ecb57a907efa2cd2cd4f",
            "filename": ".vscode/launch.json",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/.vscode%2Flaunch.json",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/.vscode%2Flaunch.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.vscode%2Flaunch.json?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -55,9 +55,7 @@\n       },\n       \"env\": {\n         // Enable the following environment variables to use turbopack instead of webpack:\n-        // \"TURBOPACK\": \"1\",\n-        // \"TURBOPACK_DEV\": \"1\",\n-        // \"TURBOPACK_BUILD\": \"1\",\n+        // \"IS_TURBOPACK_TEST\": \"1\",\n         \"NEXT_PRIVATE_LOCAL_WEBPACK\": \"1\",\n         \"NEXT_PRIVATE_SKIP_CANARY_CHECK\": \"1\",\n         \"NEXT_TELEMETRY_DISABLED\": \"1\""
        },
        {
            "sha": "f6b7d88567dae9e18c77775c4538d3a1961aa414",
            "filename": "crates/next-core/src/app_structure.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -26,6 +26,12 @@ use crate::{\n     next_import_map::get_next_package,\n };\n \n+// Next.js ignores underscores for routes but you can use %5f to still serve an underscored\n+// route.\n+fn normalize_underscore(string: &str) -> String {\n+    string.replace(\"%5F\", \"_\")\n+}\n+\n /// A final route in the app directory.\n #[turbo_tasks::value]\n #[derive(Default, Debug, Clone)]\n@@ -977,7 +983,7 @@ async fn directory_tree_to_loader_tree_internal(\n         // When constructing the app_page fails (e. g. due to limitations of the order),\n         // we only want to emit the error when there are actual pages below that\n         // directory.\n-        if let Err(e) = child_app_page.push_str(subdir_name) {\n+        if let Err(e) = child_app_page.push_str(&normalize_underscore(subdir_name)) {\n             illegal_path_error = Some(e);\n         }\n \n@@ -1394,7 +1400,7 @@ async fn directory_tree_to_entrypoints_internal_untraced(\n             // When constructing the app_page fails (e. g. due to limitations of the order),\n             // we only want to emit the error when there are actual pages below that\n             // directory.\n-            if let Err(e) = child_app_page.push_str(subdir_name) {\n+            if let Err(e) = child_app_page.push_str(&normalize_underscore(subdir_name)) {\n                 illegal_path = Some(e);\n             }\n "
        },
        {
            "sha": "9ce9a7b6aa06fe510c385667fbfb68cf8eb4bb57",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -310,11 +310,23 @@ export default class DevServer extends Server {\n         })\n       )\n \n+      // TODO: Improve passing of \"is running with Turbopack\"\n+      const isTurbopack = !!process.env.TURBOPACK\n       matchers.push(\n-        new DevAppPageRouteMatcherProvider(appDir, extensions, fileReader)\n+        new DevAppPageRouteMatcherProvider(\n+          appDir,\n+          extensions,\n+          fileReader,\n+          isTurbopack\n+        )\n       )\n       matchers.push(\n-        new DevAppRouteRouteMatcherProvider(appDir, extensions, fileReader)\n+        new DevAppRouteRouteMatcherProvider(\n+          appDir,\n+          extensions,\n+          fileReader,\n+          isTurbopack\n+        )\n       )\n     }\n "
        },
        {
            "sha": "783e7fbad6bc9571bfe48cd4e7050f2fc392ed42",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -510,7 +510,12 @@ async function startWatcher(opts: SetupOpts) {\n           if (!appPaths[pageName]) {\n             appPaths[pageName] = []\n           }\n-          appPaths[pageName].push(originalPageName)\n+          appPaths[pageName].push(\n+            opts.turbo\n+              ? // Turbopack outputs the correct path which is normalized with the `_`.\n+                originalPageName.replace(/%5F/g, '_')\n+              : originalPageName\n+          )\n \n           if (useFileSystemPublicRoutes) {\n             appFiles.add(pageName)"
        },
        {
            "sha": "980052d973f55bedaa69627ed61c1624a1c64060",
            "filename": "packages/next/src/server/normalizers/built/app/app-bundle-path-normalizer.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Fnormalizers%2Fbuilt%2Fapp%2Fapp-bundle-path-normalizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Fnormalizers%2Fbuilt%2Fapp%2Fapp-bundle-path-normalizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnormalizers%2Fbuilt%2Fapp%2Fapp-bundle-path-normalizer.ts?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -2,6 +2,7 @@ import { Normalizers } from '../../normalizers'\n import type { Normalizer } from '../../normalizer'\n import { PrefixingNormalizer } from '../../prefixing-normalizer'\n import { normalizePagePath } from '../../../../shared/lib/page-path/normalize-page-path'\n+import { UnderscoreNormalizer } from '../../underscore-normalizer'\n \n export class AppBundlePathNormalizer extends PrefixingNormalizer {\n   constructor() {\n@@ -14,13 +15,19 @@ export class AppBundlePathNormalizer extends PrefixingNormalizer {\n }\n \n export class DevAppBundlePathNormalizer extends Normalizers {\n-  constructor(pageNormalizer: Normalizer) {\n-    super([\n+  constructor(pageNormalizer: Normalizer, isTurbopack: boolean) {\n+    const normalizers = [\n       // This should normalize the filename to a page.\n       pageNormalizer,\n       // Normalize the app page to a pathname.\n       new AppBundlePathNormalizer(),\n-    ])\n+    ]\n+\n+    // %5F to _ replacement should only happen with Turbopack.\n+    if (isTurbopack) {\n+      normalizers.unshift(new UnderscoreNormalizer())\n+    }\n+    super(normalizers)\n   }\n \n   public normalize(filename: string): string {"
        },
        {
            "sha": "637950e917c72cfd89a608773b960c08b12e66fa",
            "filename": "packages/next/src/server/normalizers/built/app/app-page-normalizer.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Fnormalizers%2Fbuilt%2Fapp%2Fapp-page-normalizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Fnormalizers%2Fbuilt%2Fapp%2Fapp-page-normalizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnormalizers%2Fbuilt%2Fapp%2Fapp-page-normalizer.ts?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -1,12 +1,35 @@\n import { PAGE_TYPES } from '../../../../lib/page-types'\n import { AbsoluteFilenameNormalizer } from '../../absolute-filename-normalizer'\n+import { Normalizers } from '../../normalizers'\n \n /**\n  * DevAppPageNormalizer is a normalizer that is used to normalize a pathname\n  * to a page in the `app` directory.\n  */\n-export class DevAppPageNormalizer extends AbsoluteFilenameNormalizer {\n+class DevAppPageNormalizerInternal extends AbsoluteFilenameNormalizer {\n   constructor(appDir: string, extensions: ReadonlyArray<string>) {\n     super(appDir, extensions, PAGE_TYPES.APP)\n   }\n }\n+\n+export class DevAppPageNormalizer extends Normalizers {\n+  constructor(\n+    appDir: string,\n+    extensions: ReadonlyArray<string>,\n+    _isTurbopack: boolean\n+  ) {\n+    const normalizer = new DevAppPageNormalizerInternal(appDir, extensions)\n+    super(\n+      // %5F to _ replacement should only happen with Turbopack.\n+      // TODO: enable when page matcher `/_` check is moved: https://github.com/vercel/next.js/blob/8eda00bf5999e43e8f0211bd72c981d5ce292e8b/packages/next/src/server/route-matcher-providers/dev/dev-app-route-route-matcher-provider.ts#L48\n+      // isTurbopack\n+      //   ? [\n+      //       // The page should have the `%5F` characters replaced with `_` characters.\n+      //       new UnderscoreNormalizer(),\n+      //       normalizer,\n+      //     ]\n+      //   : [normalizer]\n+      [normalizer]\n+    )\n+  }\n+}"
        },
        {
            "sha": "cf99c1437760ef0445705cd66e365829f04b4896",
            "filename": "packages/next/src/server/normalizers/built/app/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Fnormalizers%2Fbuilt%2Fapp%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Fnormalizers%2Fbuilt%2Fapp%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnormalizers%2Fbuilt%2Fapp%2Findex.ts?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -26,9 +26,13 @@ export class DevAppNormalizers {\n   public readonly pathname: DevAppPathnameNormalizer\n   public readonly bundlePath: DevAppBundlePathNormalizer\n \n-  constructor(appDir: string, extensions: ReadonlyArray<string>) {\n-    this.page = new DevAppPageNormalizer(appDir, extensions)\n+  constructor(\n+    appDir: string,\n+    extensions: ReadonlyArray<string>,\n+    isTurbopack: boolean\n+  ) {\n+    this.page = new DevAppPageNormalizer(appDir, extensions, isTurbopack)\n     this.pathname = new DevAppPathnameNormalizer(this.page)\n-    this.bundlePath = new DevAppBundlePathNormalizer(this.page)\n+    this.bundlePath = new DevAppBundlePathNormalizer(this.page, isTurbopack)\n   }\n }"
        },
        {
            "sha": "0ebacf28e81913083ead7eeab151fc944114fab0",
            "filename": "packages/next/src/server/route-matcher-providers/dev/dev-app-page-route-matcher-provider.test.ts",
            "status": "modified",
            "additions": 98,
            "deletions": 77,
            "changes": 175,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-page-route-matcher-provider.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-page-route-matcher-provider.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-page-route-matcher-provider.test.ts?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -3,87 +3,108 @@ import { RouteKind } from '../../route-kind'\n import { DevAppPageRouteMatcherProvider } from './dev-app-page-route-matcher-provider'\n import type { FileReader } from './helpers/file-reader/file-reader'\n \n-describe('DevAppPageRouteMatcher', () => {\n-  const dir = '<root>'\n-  const extensions = ['ts', 'tsx', 'js', 'jsx']\n+describe.each(['webpack', 'turbopack'])(\n+  'DevAppPageRouteMatcher %s',\n+  (bundler) => {\n+    const isTurbopack = bundler === 'turbopack'\n+    const dir = '<root>'\n+    const extensions = ['ts', 'tsx', 'js', 'jsx']\n \n-  it('returns no routes with an empty filesystem', async () => {\n-    const reader: FileReader = { read: jest.fn(() => []) }\n-    const provider = new DevAppPageRouteMatcherProvider(dir, extensions, reader)\n-    const matchers = await provider.matchers()\n-    expect(matchers).toHaveLength(0)\n-    expect(reader.read).toHaveBeenCalledWith(dir)\n-  })\n+    it('returns no routes with an empty filesystem', async () => {\n+      const reader: FileReader = { read: jest.fn(() => []) }\n+      const provider = new DevAppPageRouteMatcherProvider(\n+        dir,\n+        extensions,\n+        reader,\n+        isTurbopack\n+      )\n+      const matchers = await provider.matchers()\n+      expect(matchers).toHaveLength(0)\n+      expect(reader.read).toHaveBeenCalledWith(dir)\n+    })\n \n-  describe('filename matching', () => {\n-    it.each<{\n-      files: ReadonlyArray<string>\n-      route: AppPageRouteDefinition\n-    }>([\n-      {\n-        files: [`${dir}/(marketing)/about/page.ts`],\n-        route: {\n-          kind: RouteKind.APP_PAGE,\n-          pathname: '/about',\n-          filename: `${dir}/(marketing)/about/page.ts`,\n-          page: '/(marketing)/about/page',\n-          bundlePath: 'app/(marketing)/about/page',\n-          appPaths: ['/(marketing)/about/page'],\n+    describe('filename matching', () => {\n+      it.each<{\n+        files: ReadonlyArray<string>\n+        route: AppPageRouteDefinition\n+      }>([\n+        {\n+          files: [`${dir}/(marketing)/about/page.ts`],\n+          route: {\n+            kind: RouteKind.APP_PAGE,\n+            pathname: '/about',\n+            filename: `${dir}/(marketing)/about/page.ts`,\n+            page: '/(marketing)/about/page',\n+            bundlePath: 'app/(marketing)/about/page',\n+            appPaths: ['/(marketing)/about/page'],\n+          },\n         },\n-      },\n-      {\n-        files: [`${dir}/(marketing)/about/page.ts`],\n-        route: {\n-          kind: RouteKind.APP_PAGE,\n-          pathname: '/about',\n-          filename: `${dir}/(marketing)/about/page.ts`,\n-          page: '/(marketing)/about/page',\n-          bundlePath: 'app/(marketing)/about/page',\n-          appPaths: ['/(marketing)/about/page'],\n+        {\n+          files: [`${dir}/(marketing)/about/page.ts`],\n+          route: {\n+            kind: RouteKind.APP_PAGE,\n+            pathname: '/about',\n+            filename: `${dir}/(marketing)/about/page.ts`,\n+            page: '/(marketing)/about/page',\n+            bundlePath: 'app/(marketing)/about/page',\n+            appPaths: ['/(marketing)/about/page'],\n+          },\n         },\n-      },\n-      {\n-        files: [`${dir}/some/other/page.ts`],\n-        route: {\n-          kind: RouteKind.APP_PAGE,\n-          pathname: '/some/other',\n-          filename: `${dir}/some/other/page.ts`,\n-          page: '/some/other/page',\n-          bundlePath: 'app/some/other/page',\n-          appPaths: ['/some/other/page'],\n+        {\n+          files: [`${dir}/some/other/page.ts`],\n+          route: {\n+            kind: RouteKind.APP_PAGE,\n+            pathname: '/some/other',\n+            filename: `${dir}/some/other/page.ts`,\n+            page: '/some/other/page',\n+            bundlePath: 'app/some/other/page',\n+            appPaths: ['/some/other/page'],\n+          },\n         },\n-      },\n-      {\n-        files: [`${dir}/page.ts`],\n-        route: {\n-          kind: RouteKind.APP_PAGE,\n-          pathname: '/',\n-          filename: `${dir}/page.ts`,\n-          page: '/page',\n-          bundlePath: 'app/page',\n-          appPaths: ['/page'],\n+        {\n+          files: [`${dir}/page.ts`],\n+          route: {\n+            kind: RouteKind.APP_PAGE,\n+            pathname: '/',\n+            filename: `${dir}/page.ts`,\n+            page: '/page',\n+            bundlePath: 'app/page',\n+            appPaths: ['/page'],\n+          },\n         },\n-      },\n-    ])(\n-      \"matches the '$route.page' route specified with the provided files\",\n-      async ({ files, route }) => {\n-        const reader: FileReader = {\n-          read: jest.fn(() => [\n-            ...extensions.map((ext) => `${dir}/some/route.${ext}`),\n-            ...extensions.map((ext) => `${dir}/api/other.${ext}`),\n-            ...files,\n-          ]),\n+        {\n+          files: [`${dir}/%5Fnotignored/page.ts`],\n+          route: {\n+            kind: RouteKind.APP_PAGE,\n+            pathname: '/_notignored',\n+            filename: `${dir}/%5Fnotignored/page.ts`,\n+            page: `/${isTurbopack ? '_' : '%5F'}notignored/page`,\n+            bundlePath: `app/${isTurbopack ? '_' : '%5F'}notignored/page`,\n+            appPaths: [`/${isTurbopack ? '_' : '%5F'}notignored/page`],\n+          },\n+        },\n+      ])(\n+        \"matches the '$route.page' route specified with the provided files\",\n+        async ({ files, route }) => {\n+          const reader: FileReader = {\n+            read: jest.fn(() => [\n+              ...extensions.map((ext) => `${dir}/some/route.${ext}`),\n+              ...extensions.map((ext) => `${dir}/api/other.${ext}`),\n+              ...files,\n+            ]),\n+          }\n+          const provider = new DevAppPageRouteMatcherProvider(\n+            dir,\n+            extensions,\n+            reader,\n+            isTurbopack\n+          )\n+          const matchers = await provider.matchers()\n+          expect(matchers).toHaveLength(1)\n+          expect(reader.read).toHaveBeenCalledWith(dir)\n+          expect(matchers[0].definition).toEqual(route)\n         }\n-        const provider = new DevAppPageRouteMatcherProvider(\n-          dir,\n-          extensions,\n-          reader\n-        )\n-        const matchers = await provider.matchers()\n-        expect(matchers).toHaveLength(1)\n-        expect(reader.read).toHaveBeenCalledWith(dir)\n-        expect(matchers[0].definition).toEqual(route)\n-      }\n-    )\n-  })\n-})\n+      )\n+    })\n+  }\n+)"
        },
        {
            "sha": "49242f2e224639c8642c7bcfebc7420df6f03e87",
            "filename": "packages/next/src/server/route-matcher-providers/dev/dev-app-page-route-matcher-provider.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-page-route-matcher-provider.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-page-route-matcher-provider.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-page-route-matcher-provider.ts?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -9,21 +9,24 @@ import { normalizeCatchAllRoutes } from '../../../build/normalize-catchall-route\n export class DevAppPageRouteMatcherProvider extends FileCacheRouteMatcherProvider<AppPageRouteMatcher> {\n   private readonly expression: RegExp\n   private readonly normalizers: DevAppNormalizers\n+  private readonly isTurbopack: boolean\n \n   constructor(\n     appDir: string,\n     extensions: ReadonlyArray<string>,\n-    reader: FileReader\n+    reader: FileReader,\n+    isTurbopack: boolean\n   ) {\n     super(appDir, reader)\n \n-    this.normalizers = new DevAppNormalizers(appDir, extensions)\n+    this.normalizers = new DevAppNormalizers(appDir, extensions, isTurbopack)\n \n     // Match any page file that ends with `/page.${extension}` or `/default.${extension}` under the app\n     // directory.\n     this.expression = new RegExp(\n       `[/\\\\\\\\](page|default)\\\\.(?:${extensions.join('|')})$`\n     )\n+    this.isTurbopack = isTurbopack\n   }\n \n   protected async transform(\n@@ -41,11 +44,19 @@ export class DevAppPageRouteMatcherProvider extends FileCacheRouteMatcherProvide\n       // If the file isn't a match for this matcher, then skip it.\n       if (!this.expression.test(filename)) continue\n \n-      const page = this.normalizers.page.normalize(filename)\n+      let page = this.normalizers.page.normalize(filename)\n \n       // Validate that this is not an ignored page.\n       if (page.includes('/_')) continue\n \n+      // Turbopack uses the correct page name with the underscore normalized.\n+      // TODO: Move implementation to packages/next/src/server/normalizers/built/app/app-page-normalizer.ts.\n+      // The `includes('/_')` check above needs to be moved for that to work as otherwise `%5Fsegmentname`\n+      // will result in `_segmentname` which hits that includes check and be skipped.\n+      if (this.isTurbopack) {\n+        page = page.replace(/%5F/g, '_')\n+      }\n+\n       // This is a valid file that we want to create a matcher for.\n       routeFilenames.push(filename)\n "
        },
        {
            "sha": "bc787b87054ddf7fb5794ad02ee0f4c0d9fb60a2",
            "filename": "packages/next/src/server/route-matcher-providers/dev/dev-app-route-route-matcher-provider.test.ts",
            "status": "modified",
            "additions": 77,
            "deletions": 55,
            "changes": 132,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-route-route-matcher-provider.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-route-route-matcher-provider.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-route-route-matcher-provider.test.ts?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -3,63 +3,85 @@ import { RouteKind } from '../../route-kind'\n import { DevAppRouteRouteMatcherProvider } from './dev-app-route-route-matcher-provider'\n import type { FileReader } from './helpers/file-reader/file-reader'\n \n-describe('DevAppRouteRouteMatcher', () => {\n-  const dir = '<root>'\n-  const extensions = ['ts', 'tsx', 'js', 'jsx']\n+describe.each(['webpack', 'turbopack'])(\n+  'DevAppRouteRouteMatcher %s',\n+  (bundler) => {\n+    const isTurbopack = bundler === 'turbopack'\n+    const dir = '<root>'\n+    const extensions = ['ts', 'tsx', 'js', 'jsx']\n \n-  it('returns no routes with an empty filesystem', async () => {\n-    const reader: FileReader = { read: jest.fn(() => []) }\n-    const matcher = new DevAppRouteRouteMatcherProvider(dir, extensions, reader)\n-    const matchers = await matcher.matchers()\n-    expect(matchers).toHaveLength(0)\n-    expect(reader.read).toHaveBeenCalledWith(dir)\n-  })\n+    it('returns no routes with an empty filesystem', async () => {\n+      const reader: FileReader = { read: jest.fn(() => []) }\n+      const matcher = new DevAppRouteRouteMatcherProvider(\n+        dir,\n+        extensions,\n+        reader,\n+        isTurbopack\n+      )\n+      const matchers = await matcher.matchers()\n+      expect(matchers).toHaveLength(0)\n+      expect(reader.read).toHaveBeenCalledWith(dir)\n+    })\n \n-  describe('filename matching', () => {\n-    it.each<{\n-      files: ReadonlyArray<string>\n-      route: AppRouteRouteDefinition\n-    }>([\n-      {\n-        files: [`${dir}/some/other/route.ts`],\n-        route: {\n-          kind: RouteKind.APP_ROUTE,\n-          pathname: '/some/other',\n-          filename: `${dir}/some/other/route.ts`,\n-          page: '/some/other/route',\n-          bundlePath: 'app/some/other/route',\n+    describe('filename matching', () => {\n+      it.each<{\n+        files: ReadonlyArray<string>\n+        route: AppRouteRouteDefinition\n+      }>([\n+        {\n+          files: [`${dir}/some/other/route.ts`],\n+          route: {\n+            kind: RouteKind.APP_ROUTE,\n+            pathname: '/some/other',\n+            filename: `${dir}/some/other/route.ts`,\n+            page: '/some/other/route',\n+            bundlePath: 'app/some/other/route',\n+          },\n         },\n-      },\n-      {\n-        files: [`${dir}/route.ts`],\n-        route: {\n-          kind: RouteKind.APP_ROUTE,\n-          pathname: '/',\n-          filename: `${dir}/route.ts`,\n-          page: '/route',\n-          bundlePath: 'app/route',\n+        {\n+          files: [`${dir}/route.ts`],\n+          route: {\n+            kind: RouteKind.APP_ROUTE,\n+            pathname: '/',\n+            filename: `${dir}/route.ts`,\n+            page: '/route',\n+            bundlePath: 'app/route',\n+          },\n         },\n-      },\n-    ])(\n-      \"matches the '$route.page' route specified with the provided files\",\n-      async ({ files, route }) => {\n-        const reader: FileReader = {\n-          read: jest.fn(() => [\n-            ...extensions.map((ext) => `${dir}/some/page.${ext}`),\n-            ...extensions.map((ext) => `${dir}/api/other.${ext}`),\n-            ...files,\n-          ]),\n+        {\n+          files: [`${dir}/%5Fnotignored/route.ts`],\n+          route: {\n+            kind: RouteKind.APP_ROUTE,\n+            pathname: '/_notignored',\n+            filename: `${dir}/%5Fnotignored/route.ts`,\n+            page: `/${isTurbopack ? '_' : '%5F'}notignored/route`,\n+            bundlePath: `app/${isTurbopack ? '_' : '%5F'}notignored/route`,\n+          },\n+        },\n+      ])(\n+        \"matches the '$route.page' route specified with the provided files\",\n+        async ({ files, route }) => {\n+          console.log({ files })\n+\n+          const reader: FileReader = {\n+            read: jest.fn(() => [\n+              ...extensions.map((ext) => `${dir}/some/page.${ext}`),\n+              ...extensions.map((ext) => `${dir}/api/other.${ext}`),\n+              ...files,\n+            ]),\n+          }\n+          const matcher = new DevAppRouteRouteMatcherProvider(\n+            dir,\n+            extensions,\n+            reader,\n+            isTurbopack\n+          )\n+          const matchers = await matcher.matchers()\n+          expect(matchers).toHaveLength(1)\n+          expect(reader.read).toHaveBeenCalledWith(dir)\n+          expect(matchers[0].definition).toEqual(route)\n         }\n-        const matcher = new DevAppRouteRouteMatcherProvider(\n-          dir,\n-          extensions,\n-          reader\n-        )\n-        const matchers = await matcher.matchers()\n-        expect(matchers).toHaveLength(1)\n-        expect(reader.read).toHaveBeenCalledWith(dir)\n-        expect(matchers[0].definition).toEqual(route)\n-      }\n-    )\n-  })\n-})\n+      )\n+    })\n+  }\n+)"
        },
        {
            "sha": "74bab178e391dee468679f38ddf535a928e453f3",
            "filename": "packages/next/src/server/route-matcher-providers/dev/dev-app-route-route-matcher-provider.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-route-route-matcher-provider.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-route-route-matcher-provider.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-route-route-matcher-provider.ts?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -19,31 +19,42 @@ export class DevAppRouteRouteMatcherProvider extends FileCacheRouteMatcherProvid\n     bundlePath: Normalizer\n   }\n   private readonly appDir: string\n+  private readonly isTurbopack: boolean\n \n   constructor(\n     appDir: string,\n     extensions: ReadonlyArray<string>,\n-    reader: FileReader\n+    reader: FileReader,\n+    isTurbopack: boolean\n   ) {\n     super(appDir, reader)\n \n     this.appDir = appDir\n-    this.normalizers = new DevAppNormalizers(appDir, extensions)\n+    this.isTurbopack = isTurbopack\n+    this.normalizers = new DevAppNormalizers(appDir, extensions, isTurbopack)\n   }\n \n   protected async transform(\n     files: ReadonlyArray<string>\n   ): Promise<ReadonlyArray<AppRouteRouteMatcher>> {\n     const matchers: Array<AppRouteRouteMatcher> = []\n     for (const filename of files) {\n-      const page = this.normalizers.page.normalize(filename)\n+      let page = this.normalizers.page.normalize(filename)\n \n       // If the file isn't a match for this matcher, then skip it.\n       if (!isAppRouteRoute(page)) continue\n \n       // Validate that this is not an ignored page.\n       if (page.includes('/_')) continue\n \n+      // Turbopack uses the correct page name with the underscore normalized.\n+      // TODO: Move implementation to packages/next/src/server/normalizers/built/app/app-page-normalizer.ts.\n+      // The `includes('/_')` check above needs to be moved for that to work as otherwise `%5Fsegmentname`\n+      // will result in `_segmentname` which hits that includes check and be skipped.\n+      if (this.isTurbopack) {\n+        page = page.replace(/%5F/g, '_')\n+      }\n+\n       const pathname = this.normalizers.pathname.normalize(filename)\n       const bundlePath = this.normalizers.bundlePath.normalize(filename)\n       const ext = path.extname(filename).slice(1)"
        },
        {
            "sha": "54b5cf79ed966a8a89247eac61228c1e92504023",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/aefa6f152619c45b6288452d329aa7511a459004/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/aefa6f152619c45b6288452d329aa7511a459004/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=aefa6f152619c45b6288452d329aa7511a459004",
            "patch": "@@ -33,12 +33,12 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/app-dir/_allow-underscored-root-directory/_allow-underscored-root-directory.test.ts\": {\n-    \"passed\": [],\n-    \"failed\": [\n+    \"passed\": [\n       \"_allow-underscored-root-directory should not serve app path with underscore\",\n       \"_allow-underscored-root-directory should pages path with a underscore at the root\",\n       \"_allow-underscored-root-directory should serve app path with %5F\"\n     ],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -5810,12 +5810,12 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/app-dir/underscore-ignore-app-paths/underscore-ignore-app-paths.test.ts\": {\n-    \"passed\": [],\n-    \"failed\": [\n+    \"passed\": [\n       \"underscore-ignore-app-paths should not serve app path with underscore\",\n       \"underscore-ignore-app-paths should serve app path with %5F\",\n       \"underscore-ignore-app-paths should serve pages path with underscore\"\n     ],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false"
        }
    ],
    "stats": {
        "total": 434,
        "additions": 277,
        "deletions": 157
    }
}