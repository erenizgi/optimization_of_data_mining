{
    "author": "bgw",
    "message": "fix(turbo-tasks): Store persistence of wrapped task on RawVc::LocalOutput (#78488)\n\nUsing the parent task id for determining the persistence of a `RawVc::LocalOutput` is (sometimes) wrong.\n\nIf we have a transient task calling a persistent task, the wrapped `LocalOutput` should be persistent.\n\nWe just store the persistence here, and not the task id of the wrapped `LocalOutput`, because when this is constructed, no non-local task id has been reserved yet. We don't really need the full task id though: just the persistence/transient bit is sufficient.\n\nAfter this PR stack, the parent task id isn't really used for anything anymore, so we can get rid of it (TODO).\n\nTested using the repro here: https://vercel.slack.com/archives/C046HAU4H7F/p1744792143917369?thread_ts=1744792143.917369",
    "sha": "e7f6a3d704b9aa9172ecafcdc4af2c5653eba750",
    "files": [
        {
            "sha": "818a8c9aea58a2fd365045d2409605872a79eb07",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/update_output.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs?ref=e7f6a3d704b9aa9172ecafcdc4af2c5653eba750",
            "patch": "@@ -91,8 +91,8 @@ impl UpdateOutputOperation {\n                     cell,\n                 })\n             }\n-            Ok(Ok(RawVc::LocalOutput(_, _))) => {\n-                panic!(\"LocalOutput must not be output of a task\");\n+            Ok(Ok(RawVc::LocalOutput(..))) => {\n+                panic!(\"Non-local tasks must not return a local Vc\");\n             }\n             Ok(Err(err)) => {\n                 task.insert(CachedDataItem::Error {"
        },
        {
            "sha": "a12b998ce9f5b2d88691103ff08931147e21e787",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/transient_vc.rs",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftransient_vc.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftransient_vc.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftransient_vc.rs?ref=e7f6a3d704b9aa9172ecafcdc4af2c5653eba750",
            "patch": "@@ -0,0 +1 @@\n+../../turbo-tasks-testing/tests/transient_vc.rs\n\\ No newline at end of file"
        },
        {
            "sha": "a12b998ce9f5b2d88691103ff08931147e21e787",
            "filename": "turbopack/crates/turbo-tasks-memory/tests/transient_vc.rs",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks-memory%2Ftests%2Ftransient_vc.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks-memory%2Ftests%2Ftransient_vc.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-memory%2Ftests%2Ftransient_vc.rs?ref=e7f6a3d704b9aa9172ecafcdc4af2c5653eba750",
            "patch": "@@ -0,0 +1 @@\n+../../turbo-tasks-testing/tests/transient_vc.rs\n\\ No newline at end of file"
        },
        {
            "sha": "2cc4fbe4f8408ed6e54096b95918439a2b5f4c28",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/transient_vc.rs",
            "status": "added",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Ftransient_vc.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Ftransient_vc.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Ftransient_vc.rs?ref=e7f6a3d704b9aa9172ecafcdc4af2c5653eba750",
            "patch": "@@ -0,0 +1,55 @@\n+#![feature(arbitrary_self_types)]\n+#![feature(arbitrary_self_types_pointers)]\n+\n+use anyhow::Result;\n+use turbo_tasks::{TaskInput, TransientValue, Vc};\n+use turbo_tasks_testing::{register, run_without_cache_check, Registration};\n+\n+static REGISTRATION: Registration = register!();\n+\n+#[tokio::test]\n+async fn test_transient_vc() -> Result<()> {\n+    run_without_cache_check(&REGISTRATION, async {\n+        test_transient_operation(TransientValue::new(123))\n+            .read_strongly_consistent()\n+            .await?;\n+        Ok(())\n+    })\n+    .await\n+}\n+\n+#[turbo_tasks::function(operation)]\n+async fn test_transient_operation(transient_arg: TransientValue<i32>) -> Result<()> {\n+    let called_with_transient = has_transient_arg(transient_arg);\n+    let called_with_persistent = has_persistent_arg(123);\n+\n+    assert!(called_with_transient.is_transient());\n+    assert!(!called_with_persistent.is_transient());\n+    assert!(has_vc_arg(called_with_transient).is_transient());\n+    assert!(!has_vc_arg(called_with_persistent).is_transient());\n+\n+    let called_with_transient_resolved = called_with_transient.to_resolved().await?;\n+    let called_with_persistent_resolved = called_with_persistent.to_resolved().await?;\n+\n+    assert!(called_with_transient_resolved.is_transient());\n+    assert!(!called_with_persistent_resolved.is_transient());\n+    assert!(has_vc_arg(*called_with_transient_resolved).is_transient());\n+    assert!(!has_vc_arg(*called_with_persistent_resolved).is_transient());\n+\n+    Ok(())\n+}\n+\n+#[turbo_tasks::function]\n+fn has_transient_arg(arg: TransientValue<i32>) -> Vc<i32> {\n+    Vc::cell(*arg)\n+}\n+\n+#[turbo_tasks::function]\n+fn has_persistent_arg(arg: i32) -> Vc<i32> {\n+    Vc::cell(arg)\n+}\n+\n+#[turbo_tasks::function]\n+async fn has_vc_arg(arg: Vc<i32>) -> Result<Vc<i32>> {\n+    Ok(Vc::cell(*arg.await?))\n+}"
        },
        {
            "sha": "72903d935bff7449a8c05db8cb31b623bf975617",
            "filename": "turbopack/crates/turbo-tasks/src/manager.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs?ref=e7f6a3d704b9aa9172ecafcdc4af2c5653eba750",
            "patch": "@@ -306,7 +306,7 @@ pub struct UpdateInfo {\n     placeholder_for_future_fields: (),\n }\n \n-#[derive(Clone, Copy, Debug, Eq, PartialEq)]\n+#[derive(Clone, Copy, Debug, Eq, PartialEq, Hash, Serialize, Deserialize)]\n pub enum TaskPersistence {\n     /// Tasks that may be persisted across sessions using serialization.\n     Persistent,\n@@ -796,7 +796,7 @@ impl<B: Backend + 'static> TurboTasks<B> {\n         #[cfg(not(feature = \"tokio_tracing\"))]\n         tokio::task::spawn(future);\n \n-        RawVc::LocalOutput(parent_task_id, local_task_id)\n+        RawVc::LocalOutput(parent_task_id, persistence, local_task_id)\n     }\n \n     fn begin_primary_job(&self) {"
        },
        {
            "sha": "682b4ab02e058bf7f877aadbb083dc9d33dad4e4",
            "filename": "turbopack/crates/turbo-tasks/src/raw_vc.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 17,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fraw_vc.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fraw_vc.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fraw_vc.rs?ref=e7f6a3d704b9aa9172ecafcdc4af2c5653eba750",
            "patch": "@@ -12,7 +12,7 @@ use crate::{\n     manager::{read_local_output, read_task_cell, read_task_output, with_turbo_tasks},\n     registry::{self, get_value_type},\n     turbo_tasks, CollectiblesSource, ReadCellOptions, ReadConsistency, ResolvedVc, TaskId,\n-    TraitTypeId, ValueType, ValueTypeId, VcValueTrait,\n+    TaskPersistence, TraitTypeId, ValueType, ValueTypeId, VcValueTrait,\n };\n \n #[derive(Error, Debug)]\n@@ -57,31 +57,34 @@ impl Display for CellId {\n pub enum RawVc {\n     TaskOutput(TaskId),\n     TaskCell(TaskId, CellId),\n-    LocalOutput(TaskId, LocalTaskId),\n+    LocalOutput(TaskId, TaskPersistence, LocalTaskId),\n }\n \n impl RawVc {\n     pub fn is_resolved(&self) -> bool {\n         match self {\n-            RawVc::TaskOutput(_) => false,\n-            RawVc::TaskCell(_, _) => true,\n-            RawVc::LocalOutput(_, _) => false,\n+            RawVc::TaskOutput(..) => false,\n+            RawVc::TaskCell(..) => true,\n+            RawVc::LocalOutput(..) => false,\n         }\n     }\n \n     pub fn is_local(&self) -> bool {\n         match self {\n-            RawVc::TaskOutput(_) => false,\n-            RawVc::TaskCell(_, _) => false,\n-            RawVc::LocalOutput(_, _) => true,\n+            RawVc::TaskOutput(..) => false,\n+            RawVc::TaskCell(..) => false,\n+            RawVc::LocalOutput(..) => true,\n         }\n     }\n \n+    /// Returns `true` if the task this `RawVc` reads from cannot be serialized and will not be\n+    /// stored in the persistent cache.\n+    ///\n+    /// See [`TaskPersistence`] for more details.\n     pub fn is_transient(&self) -> bool {\n         match self {\n-            RawVc::TaskOutput(task) | RawVc::TaskCell(task, _) | RawVc::LocalOutput(task, _) => {\n-                task.is_transient()\n-            }\n+            RawVc::TaskOutput(task) | RawVc::TaskCell(task, ..) => task.is_transient(),\n+            RawVc::LocalOutput(_, persistence, ..) => *persistence == TaskPersistence::Transient,\n         }\n     }\n \n@@ -145,7 +148,7 @@ impl RawVc {\n                         return Err(ResolveTypeError::NoContent);\n                     }\n                 }\n-                RawVc::LocalOutput(task_id, local_task_id) => {\n+                RawVc::LocalOutput(task_id, _persistence, local_task_id) => {\n                     current = read_local_output(&*tt, task_id, local_task_id)\n                         .await\n                         .map_err(|source| ResolveTypeError::TaskError { source })?;\n@@ -182,7 +185,7 @@ impl RawVc {\n                     consistency = ReadConsistency::Eventual;\n                 }\n                 RawVc::TaskCell(_, _) => return Ok(current),\n-                RawVc::LocalOutput(task_id, local_task_id) => {\n+                RawVc::LocalOutput(task_id, _persistence, local_task_id) => {\n                     debug_assert_eq!(consistency, ReadConsistency::Eventual);\n                     current = read_local_output(&*tt, task_id, local_task_id).await?;\n                 }\n@@ -197,7 +200,7 @@ impl RawVc {\n         let mut current = self;\n         loop {\n             match current {\n-                RawVc::LocalOutput(task_id, local_task_id) => {\n+                RawVc::LocalOutput(task_id, _persistence, local_task_id) => {\n                     current = read_local_output(&*tt, task_id, local_task_id).await?;\n                 }\n                 non_local => return Ok(non_local),\n@@ -212,14 +215,14 @@ impl RawVc {\n \n     pub fn get_task_id(&self) -> TaskId {\n         match self {\n-            RawVc::TaskOutput(t) | RawVc::TaskCell(t, _) | RawVc::LocalOutput(t, _) => *t,\n+            RawVc::TaskOutput(t) | RawVc::TaskCell(t, _) | RawVc::LocalOutput(t, ..) => *t,\n         }\n     }\n \n     pub fn try_get_type_id(&self) -> Option<ValueTypeId> {\n         match self {\n             RawVc::TaskCell(_, CellId { type_id, .. }) => Some(*type_id),\n-            RawVc::TaskOutput(_) | RawVc::LocalOutput(_, _) => None,\n+            RawVc::TaskOutput(_) | RawVc::LocalOutput(..) => None,\n         }\n     }\n \n@@ -357,7 +360,7 @@ impl Future for ReadRawVcFuture {\n                             Err(err) => return Poll::Ready(Err(err)),\n                         }\n                     }\n-                    RawVc::LocalOutput(task_id, local_output_id) => {\n+                    RawVc::LocalOutput(task_id, _persistence, local_output_id) => {\n                         debug_assert_eq!(this.consistency, ReadConsistency::Eventual);\n                         let read_result = tt.try_read_local_output(task_id, local_output_id);\n                         match read_result {"
        },
        {
            "sha": "6cfffe03ccc561a49ba2cec3da3300025fd25989",
            "filename": "turbopack/crates/turbo-tasks/src/task/task_input.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ftask_input.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7f6a3d704b9aa9172ecafcdc4af2c5653eba750/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ftask_input.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ftask_input.rs?ref=e7f6a3d704b9aa9172ecafcdc4af2c5653eba750",
            "patch": "@@ -139,7 +139,7 @@ where\n     }\n \n     fn is_transient(&self) -> bool {\n-        self.node.get_task_id().is_transient()\n+        self.node.is_transient()\n     }\n \n     async fn resolve_input(&self) -> Result<Self> {"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 82,
        "deletions": 22
    }
}