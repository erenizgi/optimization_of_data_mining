{
    "author": "mischnic",
    "message": "Turbopack: codegen modules without module graph (#81238)\n\n- We didn't actually need the module graph in the chunk item, so this now ensures that we only codegen modules once, regardless on how many pages they are (in dev, nothing changes about builds).\n- For that, move the export usage information onto the chunking context, just like the module id functionality.",
    "sha": "f5376f422362f9c312a8e84ad258e866d12d2ee2",
    "files": [
        {
            "sha": "c705ad6996f0a6b9cfb7c26a2171bbb9163194c6",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 71,
            "deletions": 60,
            "changes": 131,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -10,10 +10,13 @@ use next_core::{\n     instrumentation::instrumentation_files,\n     middleware::middleware_files,\n     mode::NextMode,\n-    next_client::{get_client_chunking_context, get_client_compile_time_info},\n+    next_client::{\n+        ClientChunkingContextOptions, get_client_chunking_context, get_client_compile_time_info,\n+    },\n     next_config::{JsConfig, ModuleIds as ModuleIdStrategyConfig, NextConfig},\n+    next_edge::context::EdgeChunkingContextOptions,\n     next_server::{\n-        ServerContextType, get_server_chunking_context,\n+        ServerChunkingContextOptions, ServerContextType, get_server_chunking_context,\n         get_server_chunking_context_with_client_assets, get_server_compile_time_info,\n         get_server_module_options_context, get_server_resolve_options_context,\n     },\n@@ -62,6 +65,7 @@ use turbopack_core::{\n     module_graph::{\n         GraphEntries, ModuleGraph, SingleModuleGraph, VisitedModules,\n         chunk_group_info::ChunkGroupEntry,\n+        export_usage::{OptionExportUsageInfo, compute_export_usage_info},\n     },\n     output::{OutputAsset, OutputAssets},\n     reference_type::{EntryReferenceSubType, ReferenceType},\n@@ -1026,55 +1030,49 @@ impl Project {\n     pub(super) async fn client_chunking_context(\n         self: Vc<Self>,\n     ) -> Result<Vc<Box<dyn ChunkingContext>>> {\n-        Ok(get_client_chunking_context(\n-            self.project_root_path().await?.clone_value(),\n-            self.client_relative_path().await?.clone_value(),\n-            rcstr!(\"/ROOT\"),\n-            self.next_config().computed_asset_prefix(),\n-            self.next_config().chunk_suffix_path(),\n-            self.client_compile_time_info().environment(),\n-            self.next_mode(),\n-            self.module_ids(),\n-            self.next_config().turbo_minify(self.next_mode()),\n-            self.next_config().client_source_maps(self.next_mode()),\n-            self.no_mangling(),\n-            self.next_config().turbo_scope_hoisting(self.next_mode()),\n-        ))\n+        Ok(get_client_chunking_context(ClientChunkingContextOptions {\n+            mode: self.next_mode(),\n+            root_path: self.project_root_path().await?.clone_value(),\n+            client_root: self.client_relative_path().await?.clone_value(),\n+            client_root_to_root_path: rcstr!(\"/ROOT\"),\n+            asset_prefix: self.next_config().computed_asset_prefix(),\n+            chunk_suffix_path: self.next_config().chunk_suffix_path(),\n+            environment: self.client_compile_time_info().environment(),\n+            module_id_strategy: self.module_ids(),\n+            export_usage: self.export_usage(),\n+            minify: self.next_config().turbo_minify(self.next_mode()),\n+            source_maps: self.next_config().client_source_maps(self.next_mode()),\n+            no_mangling: self.no_mangling(),\n+            scope_hoisting: self.next_config().turbo_scope_hoisting(self.next_mode()),\n+        }))\n     }\n \n     #[turbo_tasks::function]\n     pub(super) async fn server_chunking_context(\n         self: Vc<Self>,\n         client_assets: bool,\n     ) -> Result<Vc<NodeJsChunkingContext>> {\n+        let options = ServerChunkingContextOptions {\n+            mode: self.next_mode(),\n+            root_path: self.project_root_path().await?.clone_value(),\n+            node_root: self.node_root().await?.clone_value(),\n+            node_root_to_root_path: self.node_root_to_root_path().owned().await?,\n+            environment: self.server_compile_time_info().environment(),\n+            module_id_strategy: self.module_ids(),\n+            export_usage: self.export_usage(),\n+            turbo_minify: self.next_config().turbo_minify(self.next_mode()),\n+            turbo_source_maps: self.next_config().server_source_maps(),\n+            no_mangling: self.no_mangling(),\n+            scope_hoisting: self.next_config().turbo_scope_hoisting(self.next_mode()),\n+        };\n         Ok(if client_assets {\n             get_server_chunking_context_with_client_assets(\n-                self.next_mode(),\n-                self.project_root_path().await?.clone_value(),\n-                self.node_root().await?.clone_value(),\n-                self.node_root_to_root_path().owned().await?,\n+                options,\n                 self.client_relative_path().await?.clone_value(),\n                 self.next_config().computed_asset_prefix().owned().await?,\n-                self.server_compile_time_info().environment(),\n-                self.module_ids(),\n-                self.next_config().turbo_minify(self.next_mode()),\n-                self.next_config().server_source_maps(),\n-                self.no_mangling(),\n-                self.next_config().turbo_scope_hoisting(self.next_mode()),\n             )\n         } else {\n-            get_server_chunking_context(\n-                self.next_mode(),\n-                self.project_root_path().await?.clone_value(),\n-                self.node_root().await?.clone_value(),\n-                self.node_root_to_root_path().owned().await?,\n-                self.server_compile_time_info().environment(),\n-                self.module_ids(),\n-                self.next_config().turbo_minify(self.next_mode()),\n-                self.next_config().server_source_maps(),\n-                self.no_mangling(),\n-                self.next_config().turbo_scope_hoisting(self.next_mode()),\n-            )\n+            get_server_chunking_context(options)\n         })\n     }\n \n@@ -1083,34 +1081,27 @@ impl Project {\n         self: Vc<Self>,\n         client_assets: bool,\n     ) -> Result<Vc<Box<dyn ChunkingContext>>> {\n+        let options = EdgeChunkingContextOptions {\n+            mode: self.next_mode(),\n+            root_path: self.project_root_path().await?.clone_value(),\n+            node_root: self.node_root().await?.clone_value(),\n+            output_root_to_root_path: self.node_root_to_root_path(),\n+            environment: self.edge_compile_time_info().environment(),\n+            module_id_strategy: self.module_ids(),\n+            export_usage: self.export_usage(),\n+            turbo_minify: self.next_config().turbo_minify(self.next_mode()),\n+            turbo_source_maps: self.next_config().server_source_maps(),\n+            no_mangling: self.no_mangling(),\n+            scope_hoisting: self.next_config().turbo_scope_hoisting(self.next_mode()),\n+        };\n         Ok(if client_assets {\n             get_edge_chunking_context_with_client_assets(\n-                self.next_mode(),\n-                self.project_root_path().await?.clone_value(),\n-                self.node_root().await?.clone_value(),\n-                self.node_root_to_root_path(),\n+                options,\n                 self.client_relative_path().await?.clone_value(),\n                 self.next_config().computed_asset_prefix(),\n-                self.edge_compile_time_info().environment(),\n-                self.module_ids(),\n-                self.next_config().turbo_minify(self.next_mode()),\n-                self.next_config().server_source_maps(),\n-                self.no_mangling(),\n-                self.next_config().turbo_scope_hoisting(self.next_mode()),\n             )\n         } else {\n-            get_edge_chunking_context(\n-                self.next_mode(),\n-                self.project_root_path().await?.clone_value(),\n-                self.node_root().await?.clone_value(),\n-                self.node_root_to_root_path(),\n-                self.edge_compile_time_info().environment(),\n-                self.module_ids(),\n-                self.next_config().turbo_minify(self.next_mode()),\n-                self.next_config().server_source_maps(),\n-                self.no_mangling(),\n-                self.next_config().turbo_scope_hoisting(self.next_mode()),\n-            )\n+            get_edge_chunking_context(options)\n         })\n     }\n \n@@ -1784,6 +1775,26 @@ impl Project {\n             }\n         }\n     }\n+\n+    /// Compute the used exports for each module.\n+    #[turbo_tasks::function]\n+    pub async fn export_usage(self: Vc<Self>) -> Result<Vc<OptionExportUsageInfo>> {\n+        if *self\n+            .next_config()\n+            .turbopack_remove_unused_exports(self.next_mode())\n+            .await?\n+        {\n+            let module_graphs = self.whole_app_module_graphs().await?;\n+            Ok(Vc::cell(Some(\n+                compute_export_usage_info(module_graphs.full)\n+                    // As a performance optimization, we resolve strongly consistently\n+                    .resolve_strongly_consistent()\n+                    .await?,\n+            )))\n+        } else {\n+            Ok(Vc::cell(None))\n+        }\n+    }\n }\n \n // This is a performance optimization. This function is a root aggregation function that"
        },
        {
            "sha": "a4484dfb83d1a5e4419758a3dea1e427d00a7b2b",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 41,
            "deletions": 18,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -1,8 +1,9 @@\n use std::iter::once;\n \n use anyhow::Result;\n+use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{ResolvedVc, TaskInput, Vc};\n+use turbo_tasks::{ResolvedVc, TaskInput, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::{\n     css::chunk::CssChunkType,\n@@ -24,6 +25,7 @@ use turbopack_core::{\n     compile_time_info::{CompileTimeDefines, CompileTimeInfo, FreeVarReference, FreeVarReferences},\n     environment::{BrowserEnvironment, Environment, ExecutionEnvironment},\n     free_var_references,\n+    module_graph::export_usage::OptionExportUsageInfo,\n     resolve::{parse::Request, pattern::Pattern},\n };\n use turbopack_ecmascript::chunk::EcmascriptChunkType;\n@@ -323,9 +325,7 @@ pub async fn get_client_module_options_context(\n         enable_postcss_transform,\n         side_effect_free_packages: next_config.optimize_package_imports().owned().await?,\n         keep_last_successful_parse: next_mode.is_development(),\n-        remove_unused_exports: *next_config\n-            .turbopack_remove_unused_exports(next_mode.is_development())\n-            .await?,\n+        remove_unused_exports: *next_config.turbopack_remove_unused_exports(mode).await?,\n         ..Default::default()\n     };\n \n@@ -397,21 +397,43 @@ pub async fn get_client_module_options_context(\n     Ok(module_options_context)\n }\n \n+#[derive(Clone, Debug, PartialEq, Eq, Hash, TaskInput, TraceRawVcs, Serialize, Deserialize)]\n+pub struct ClientChunkingContextOptions {\n+    pub mode: Vc<NextMode>,\n+    pub root_path: FileSystemPath,\n+    pub client_root: FileSystemPath,\n+    pub client_root_to_root_path: RcStr,\n+    pub asset_prefix: Vc<Option<RcStr>>,\n+    pub chunk_suffix_path: Vc<Option<RcStr>>,\n+    pub environment: Vc<Environment>,\n+    pub module_id_strategy: Vc<Box<dyn ModuleIdStrategy>>,\n+    pub export_usage: Vc<OptionExportUsageInfo>,\n+    pub minify: Vc<bool>,\n+    pub source_maps: Vc<bool>,\n+    pub no_mangling: Vc<bool>,\n+    pub scope_hoisting: Vc<bool>,\n+}\n+\n #[turbo_tasks::function]\n pub async fn get_client_chunking_context(\n-    root_path: FileSystemPath,\n-    client_root: FileSystemPath,\n-    client_root_to_root_path: RcStr,\n-    asset_prefix: ResolvedVc<Option<RcStr>>,\n-    chunk_suffix_path: ResolvedVc<Option<RcStr>>,\n-    environment: ResolvedVc<Environment>,\n-    mode: Vc<NextMode>,\n-    module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n-    minify: Vc<bool>,\n-    source_maps: Vc<bool>,\n-    no_mangling: Vc<bool>,\n-    scope_hoisting: Vc<bool>,\n+    options: ClientChunkingContextOptions,\n ) -> Result<Vc<Box<dyn ChunkingContext>>> {\n+    let ClientChunkingContextOptions {\n+        mode,\n+        root_path,\n+        client_root,\n+        client_root_to_root_path,\n+        asset_prefix,\n+        chunk_suffix_path,\n+        environment,\n+        module_id_strategy,\n+        export_usage,\n+        minify,\n+        source_maps,\n+        no_mangling,\n+        scope_hoisting,\n+    } = options;\n+\n     let next_mode = mode.await?;\n     let asset_prefix = asset_prefix.owned().await?;\n     let chunk_suffix_path = chunk_suffix_path.owned().await?;\n@@ -424,7 +446,7 @@ pub async fn get_client_chunking_context(\n         get_client_assets_path(client_root.clone())\n             .await?\n             .clone_value(),\n-        environment,\n+        environment.to_resolved().await?,\n         next_mode.runtime_type(),\n     )\n     .chunk_base_path(asset_prefix.clone())\n@@ -443,7 +465,8 @@ pub async fn get_client_chunking_context(\n     })\n     .asset_base_path(asset_prefix)\n     .current_chunk_method(CurrentChunkMethod::DocumentCurrentScript)\n-    .module_id_strategy(module_id_strategy);\n+    .export_usage(*export_usage.await?)\n+    .module_id_strategy(module_id_strategy.to_resolved().await?);\n \n     if next_mode.is_development() {\n         builder = builder.hot_module_replacement().use_file_source_map_uris();"
        },
        {
            "sha": "2d8924feaa30be2303bdea4a7593211c48787e6f",
            "filename": "crates/next-core/src/next_client/mod.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fmod.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -3,8 +3,8 @@ pub(crate) mod runtime_entry;\n pub(crate) mod transforms;\n \n pub use context::{\n-    ClientContextType, get_client_chunking_context, get_client_compile_time_info,\n-    get_client_module_options_context, get_client_resolve_options_context,\n-    get_client_runtime_entries,\n+    ClientChunkingContextOptions, ClientContextType, get_client_chunking_context,\n+    get_client_compile_time_info, get_client_module_options_context,\n+    get_client_resolve_options_context, get_client_runtime_entries,\n };\n pub use runtime_entry::{RuntimeEntries, RuntimeEntry};"
        },
        {
            "sha": "a50b9075e997ac2b07f5c1ef2adf7c927816dd0d",
            "filename": "crates/next-core/src/next_client_reference/ecmascript_client_reference/ecmascript_client_reference_module.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -15,7 +15,7 @@ use turbopack_core::{\n     context::AssetContext,\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::ModuleGraph,\n+    module_graph::{ModuleGraph, export_usage::ModuleExportUsageInfo},\n     reference::{ModuleReference, ModuleReferences},\n     reference_type::ReferenceType,\n     resolve::ModuleResolveResult,\n@@ -76,7 +76,7 @@ impl EcmascriptClientReferenceModule {\n         // Adapted from https://github.com/facebook/react/blob/c5b9375767e2c4102d7e5559d383523736f1c902/packages/react-server-dom-webpack/src/ReactFlightWebpackNodeLoader.js#L323-L354\n         if let EcmascriptExports::EsmExports(exports) = &*self.client_module.get_exports().await? {\n             is_esm = true;\n-            let exports = exports.expand_exports(None).await?;\n+            let exports = exports.expand_exports(ModuleExportUsageInfo::all()).await?;\n \n             if !exports.dynamic_exports.is_empty() {\n                 // TODO: throw? warn?"
        },
        {
            "sha": "bc7a3b2a12329af3b2fef45bdb5b8825b5b0bb46",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -1644,12 +1644,12 @@ impl NextConfig {\n     }\n \n     #[turbo_tasks::function]\n-    pub fn turbopack_remove_unused_exports(&self, is_development: bool) -> Vc<bool> {\n-        Vc::cell(\n+    pub async fn turbopack_remove_unused_exports(&self, mode: Vc<NextMode>) -> Result<Vc<bool>> {\n+        Ok(Vc::cell(\n             self.experimental\n                 .turbopack_remove_unused_exports\n-                .unwrap_or(!is_development),\n-        )\n+                .unwrap_or(matches!(*mode.await?, NextMode::Build)),\n+        ))\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "dfbc1b5a89a3ca816ad507d0723f155796b936fa",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 53,
            "deletions": 26,
            "changes": 79,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -1,6 +1,7 @@\n use anyhow::Result;\n+use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{ResolvedVc, Vc};\n+use turbo_tasks::{ResolvedVc, TaskInput, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::{css::chunk::CssChunkType, resolve_options_context::ResolveOptionsContext};\n use turbopack_browser::BrowserChunkingContext;\n@@ -12,6 +13,7 @@ use turbopack_core::{\n     compile_time_info::{CompileTimeDefines, CompileTimeInfo, FreeVarReference, FreeVarReferences},\n     environment::{EdgeWorkerEnvironment, Environment, ExecutionEnvironment, NodeJsVersion},\n     free_var_references,\n+    module_graph::export_usage::OptionExportUsageInfo,\n };\n use turbopack_ecmascript::chunk::EcmascriptChunkType;\n use turbopack_node::execution_context::ExecutionContext;\n@@ -185,21 +187,40 @@ pub async fn get_edge_resolve_options_context(\n     .cell())\n }\n \n+#[derive(Clone, Debug, PartialEq, Eq, Hash, TaskInput, TraceRawVcs, Serialize, Deserialize)]\n+pub struct EdgeChunkingContextOptions {\n+    pub mode: Vc<NextMode>,\n+    pub root_path: FileSystemPath,\n+    pub node_root: FileSystemPath,\n+    pub output_root_to_root_path: Vc<RcStr>,\n+    pub environment: Vc<Environment>,\n+    pub module_id_strategy: Vc<Box<dyn ModuleIdStrategy>>,\n+    pub export_usage: Vc<OptionExportUsageInfo>,\n+    pub turbo_minify: Vc<bool>,\n+    pub turbo_source_maps: Vc<bool>,\n+    pub no_mangling: Vc<bool>,\n+    pub scope_hoisting: Vc<bool>,\n+}\n+\n #[turbo_tasks::function]\n pub async fn get_edge_chunking_context_with_client_assets(\n-    mode: Vc<NextMode>,\n-    root_path: FileSystemPath,\n-    node_root: FileSystemPath,\n-    output_root_to_root_path: ResolvedVc<RcStr>,\n+    options: EdgeChunkingContextOptions,\n     client_root: FileSystemPath,\n     asset_prefix: ResolvedVc<Option<RcStr>>,\n-    environment: ResolvedVc<Environment>,\n-    module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n-    turbo_minify: Vc<bool>,\n-    turbo_source_maps: Vc<bool>,\n-    no_mangling: Vc<bool>,\n-    scope_hoisting: Vc<bool>,\n ) -> Result<Vc<Box<dyn ChunkingContext>>> {\n+    let EdgeChunkingContextOptions {\n+        mode,\n+        root_path,\n+        node_root,\n+        output_root_to_root_path,\n+        environment,\n+        module_id_strategy,\n+        export_usage,\n+        turbo_minify,\n+        turbo_source_maps,\n+        no_mangling,\n+        scope_hoisting,\n+    } = options;\n     let output_root = node_root.join(\"server/edge\")?;\n     let next_mode = mode.await?;\n     let mut builder = BrowserChunkingContext::builder(\n@@ -209,7 +230,7 @@ pub async fn get_edge_chunking_context_with_client_assets(\n         client_root.clone(),\n         output_root.join(\"chunks/ssr\")?,\n         client_root.join(\"static/media\")?,\n-        environment,\n+        environment.to_resolved().await?,\n         next_mode.runtime_type(),\n     )\n     .asset_base_path(asset_prefix.owned().await?)\n@@ -226,7 +247,8 @@ pub async fn get_edge_chunking_context_with_client_assets(\n     } else {\n         SourceMapsType::None\n     })\n-    .module_id_strategy(module_id_strategy);\n+    .module_id_strategy(module_id_strategy.to_resolved().await?)\n+    .export_usage(*export_usage.await?);\n \n     if !next_mode.is_development() {\n         builder = builder\n@@ -252,27 +274,31 @@ pub async fn get_edge_chunking_context_with_client_assets(\n \n #[turbo_tasks::function]\n pub async fn get_edge_chunking_context(\n-    mode: Vc<NextMode>,\n-    root_path: FileSystemPath,\n-    node_root: FileSystemPath,\n-    node_root_to_root_path: ResolvedVc<RcStr>,\n-    environment: ResolvedVc<Environment>,\n-    module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n-    turbo_minify: Vc<bool>,\n-    turbo_source_maps: Vc<bool>,\n-    no_mangling: Vc<bool>,\n-    scope_hoisting: Vc<bool>,\n+    options: EdgeChunkingContextOptions,\n ) -> Result<Vc<Box<dyn ChunkingContext>>> {\n+    let EdgeChunkingContextOptions {\n+        mode,\n+        root_path,\n+        node_root,\n+        output_root_to_root_path,\n+        environment,\n+        module_id_strategy,\n+        export_usage,\n+        turbo_minify,\n+        turbo_source_maps,\n+        no_mangling,\n+        scope_hoisting,\n+    } = options;\n     let output_root = node_root.join(\"server/edge\")?;\n     let next_mode = mode.await?;\n     let mut builder = BrowserChunkingContext::builder(\n         root_path,\n         output_root.clone(),\n-        node_root_to_root_path.owned().await?,\n+        output_root_to_root_path.owned().await?,\n         output_root.clone(),\n         output_root.join(\"chunks\")?,\n         output_root.join(\"assets\")?,\n-        environment,\n+        environment.to_resolved().await?,\n         next_mode.runtime_type(),\n     )\n     // Since one can't read files in edge directly, any asset need to be fetched\n@@ -292,7 +318,8 @@ pub async fn get_edge_chunking_context(\n     } else {\n         SourceMapsType::None\n     })\n-    .module_id_strategy(module_id_strategy);\n+    .module_id_strategy(module_id_strategy.to_resolved().await?)\n+    .export_usage(*export_usage.await?);\n \n     if !next_mode.is_development() {\n         builder = builder"
        },
        {
            "sha": "b2d65f84ad012e80872c21333209e6f35f0e67b2",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 54,
            "deletions": 28,
            "changes": 82,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -1,8 +1,9 @@\n use std::iter::once;\n \n use anyhow::{Result, bail};\n+use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{ResolvedVc, TaskInput, Vc};\n+use turbo_tasks::{ResolvedVc, TaskInput, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::{\n     css::chunk::CssChunkType,\n@@ -23,6 +24,7 @@ use turbopack_core::{\n         Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion, RuntimeVersions,\n     },\n     free_var_references,\n+    module_graph::export_usage::OptionExportUsageInfo,\n     target::CompileTarget,\n };\n use turbopack_ecmascript::{chunk::EcmascriptChunkType, references::esm::UrlRewriteBehavior};\n@@ -538,9 +540,7 @@ pub async fn get_server_module_options_context(\n             None\n         },\n         keep_last_successful_parse: next_mode.is_development(),\n-        remove_unused_exports: *next_config\n-            .turbopack_remove_unused_exports(next_mode.is_development())\n-            .await?,\n+\n         ..Default::default()\n     };\n \n@@ -948,21 +948,41 @@ pub fn get_server_runtime_entries(\n     Vc::cell(runtime_entries)\n }\n \n+#[derive(Clone, Debug, PartialEq, Eq, Hash, TaskInput, TraceRawVcs, Serialize, Deserialize)]\n+pub struct ServerChunkingContextOptions {\n+    pub mode: Vc<NextMode>,\n+    pub root_path: FileSystemPath,\n+    pub node_root: FileSystemPath,\n+    pub node_root_to_root_path: RcStr,\n+    pub environment: Vc<Environment>,\n+    pub module_id_strategy: Vc<Box<dyn ModuleIdStrategy>>,\n+    pub export_usage: Vc<OptionExportUsageInfo>,\n+    pub turbo_minify: Vc<bool>,\n+    pub turbo_source_maps: Vc<bool>,\n+    pub no_mangling: Vc<bool>,\n+    pub scope_hoisting: Vc<bool>,\n+}\n+\n #[turbo_tasks::function]\n pub async fn get_server_chunking_context_with_client_assets(\n-    mode: Vc<NextMode>,\n-    root_path: FileSystemPath,\n-    node_root: FileSystemPath,\n-    node_root_to_root_path: RcStr,\n+    options: ServerChunkingContextOptions,\n     client_root: FileSystemPath,\n     asset_prefix: Option<RcStr>,\n-    environment: ResolvedVc<Environment>,\n-    module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n-    turbo_minify: Vc<bool>,\n-    turbo_source_maps: Vc<bool>,\n-    no_mangling: Vc<bool>,\n-    scope_hoisting: Vc<bool>,\n ) -> Result<Vc<NodeJsChunkingContext>> {\n+    let ServerChunkingContextOptions {\n+        mode,\n+        root_path,\n+        node_root,\n+        node_root_to_root_path,\n+        environment,\n+        module_id_strategy,\n+        export_usage,\n+        turbo_minify,\n+        turbo_source_maps,\n+        no_mangling,\n+        scope_hoisting,\n+    } = options;\n+\n     let next_mode = mode.await?;\n     // TODO(alexkirsz) This should return a trait that can be implemented by the\n     // different server chunking contexts. OR the build chunking context should\n@@ -974,7 +994,7 @@ pub async fn get_server_chunking_context_with_client_assets(\n         client_root.clone(),\n         node_root.join(\"server/chunks/ssr\")?,\n         client_root.join(\"static/media\")?,\n-        environment,\n+        environment.to_resolved().await?,\n         next_mode.runtime_type(),\n     )\n     .asset_prefix(asset_prefix)\n@@ -991,7 +1011,8 @@ pub async fn get_server_chunking_context_with_client_assets(\n     } else {\n         SourceMapsType::None\n     })\n-    .module_id_strategy(module_id_strategy)\n+    .module_id_strategy(module_id_strategy.to_resolved().await?)\n+    .export_usage(*export_usage.await?)\n     .file_tracing(next_mode.is_production());\n \n     if next_mode.is_development() {\n@@ -1022,17 +1043,21 @@ pub async fn get_server_chunking_context_with_client_assets(\n \n #[turbo_tasks::function]\n pub async fn get_server_chunking_context(\n-    mode: Vc<NextMode>,\n-    root_path: FileSystemPath,\n-    node_root: FileSystemPath,\n-    node_root_to_root_path: RcStr,\n-    environment: ResolvedVc<Environment>,\n-    module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n-    turbo_minify: Vc<bool>,\n-    turbo_source_maps: Vc<bool>,\n-    no_mangling: Vc<bool>,\n-    scope_hoisting: Vc<bool>,\n+    options: ServerChunkingContextOptions,\n ) -> Result<Vc<NodeJsChunkingContext>> {\n+    let ServerChunkingContextOptions {\n+        mode,\n+        root_path,\n+        node_root,\n+        node_root_to_root_path,\n+        environment,\n+        module_id_strategy,\n+        export_usage,\n+        turbo_minify,\n+        turbo_source_maps,\n+        no_mangling,\n+        scope_hoisting,\n+    } = options;\n     let next_mode = mode.await?;\n     // TODO(alexkirsz) This should return a trait that can be implemented by the\n     // different server chunking contexts. OR the build chunking context should\n@@ -1044,7 +1069,7 @@ pub async fn get_server_chunking_context(\n         node_root.clone(),\n         node_root.join(\"server/chunks\")?,\n         node_root.join(\"server/assets\")?,\n-        environment,\n+        environment.to_resolved().await?,\n         next_mode.runtime_type(),\n     )\n     .minify_type(if *turbo_minify.await? {\n@@ -1059,7 +1084,8 @@ pub async fn get_server_chunking_context(\n     } else {\n         SourceMapsType::None\n     })\n-    .module_id_strategy(module_id_strategy)\n+    .module_id_strategy(module_id_strategy.to_resolved().await?)\n+    .export_usage(*export_usage.await?)\n     .file_tracing(next_mode.is_production());\n \n     if next_mode.is_development() {"
        },
        {
            "sha": "c2f97a515ecdbcfe82b6fa2a47104b011d5f03c4",
            "filename": "crates/next-core/src/next_server/mod.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fmod.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -3,7 +3,8 @@ pub(crate) mod resolve;\n pub(crate) mod transforms;\n \n pub use context::{\n-    ServerContextType, get_server_chunking_context, get_server_chunking_context_with_client_assets,\n-    get_server_compile_time_info, get_server_module_options_context,\n-    get_server_resolve_options_context, get_server_runtime_entries,\n+    ServerChunkingContextOptions, ServerContextType, get_server_chunking_context,\n+    get_server_chunking_context_with_client_assets, get_server_compile_time_info,\n+    get_server_module_options_context, get_server_resolve_options_context,\n+    get_server_runtime_entries,\n };"
        },
        {
            "sha": "4b2ea130ca3baced4a9ebcf2bb280464e1e80142",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -21,7 +21,11 @@ use turbopack_core::{\n     environment::Environment,\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::{ModuleGraph, chunk_group_info::ChunkGroup},\n+    module_graph::{\n+        ModuleGraph,\n+        chunk_group_info::ChunkGroup,\n+        export_usage::{ExportUsageInfo, ModuleExportUsageInfo},\n+    },\n     output::{OutputAsset, OutputAssets},\n };\n use turbopack_ecmascript::{\n@@ -150,6 +154,11 @@ impl BrowserChunkingContextBuilder {\n         self\n     }\n \n+    pub fn export_usage(mut self, export_usage: Option<ResolvedVc<ExportUsageInfo>>) -> Self {\n+        self.chunking_context.export_usage = export_usage;\n+        self\n+    }\n+\n     pub fn chunking_config<T>(mut self, ty: ResolvedVc<T>, chunking_config: ChunkingConfig) -> Self\n     where\n         T: Upcast<Box<dyn ChunkType>>,\n@@ -225,6 +234,8 @@ pub struct BrowserChunkingContext {\n     manifest_chunks: bool,\n     /// The module id strategy to use\n     module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n+    /// The module export usage info, if available.\n+    export_usage: Option<ResolvedVc<ExportUsageInfo>>,\n     /// The chunking configs\n     chunking_configs: Vec<(ResolvedVc<Box<dyn ChunkType>>, ChunkingConfig)>,\n }\n@@ -264,6 +275,7 @@ impl BrowserChunkingContext {\n                 current_chunk_method: CurrentChunkMethod::StringLiteral,\n                 manifest_chunks: false,\n                 module_id_strategy: ResolvedVc::upcast(DevModuleIdStrategy::new_resolved()),\n+                export_usage: None,\n                 chunking_configs: Default::default(),\n             },\n         }\n@@ -714,4 +726,16 @@ impl ChunkingContext for BrowserChunkingContext {\n             self.chunk_item_id_from_ident(AsyncLoaderModule::asset_ident_for(module))\n         })\n     }\n+\n+    #[turbo_tasks::function]\n+    async fn module_export_usage(\n+        self: Vc<Self>,\n+        module: ResolvedVc<Box<dyn Module>>,\n+    ) -> Result<Vc<ModuleExportUsageInfo>> {\n+        if let Some(export_usage) = self.await?.export_usage {\n+            Ok(export_usage.await?.used_exports(module))\n+        } else {\n+            Ok(ModuleExportUsageInfo::all())\n+        }\n+    }\n }"
        },
        {
            "sha": "8f4c3f274a59b1199a6bc1984cc98777edcec1dc",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -35,6 +35,7 @@ use turbopack_core::{\n     module_graph::{\n         ModuleGraph,\n         chunk_group_info::{ChunkGroup, ChunkGroupEntry},\n+        export_usage::compute_export_usage_info,\n     },\n     output::{OutputAsset, OutputAssets},\n     reference::all_assets_from_entries,\n@@ -314,6 +315,9 @@ async fn build_internal(\n             .to_resolved()\n             .await?,\n     );\n+    let export_usage = compute_export_usage_info(module_graph.to_resolved().await?)\n+        .resolve_strongly_consistent()\n+        .await?;\n \n     let chunking_context: Vc<Box<dyn ChunkingContext>> = match target {\n         Target::Browser => {\n@@ -339,6 +343,7 @@ async fn build_internal(\n             )\n             .source_maps(source_maps_type)\n             .module_id_strategy(module_id_strategy)\n+            .export_usage(Some(export_usage))\n             .current_chunk_method(CurrentChunkMethod::DocumentCurrentScript)\n             .minify_type(minify_type);\n \n@@ -386,6 +391,7 @@ async fn build_internal(\n             )\n             .source_maps(source_maps_type)\n             .module_id_strategy(module_id_strategy)\n+            .export_usage(Some(export_usage))\n             .minify_type(minify_type);\n \n             match *node_env.await? {"
        },
        {
            "sha": "9441c429cf2b8c3419806276d5d60e9e6587f05f",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking_context.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -13,7 +13,10 @@ use crate::{\n     environment::Environment,\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::{ModuleGraph, chunk_group_info::ChunkGroup, module_batches::BatchingConfig},\n+    module_graph::{\n+        ModuleGraph, chunk_group_info::ChunkGroup, export_usage::ModuleExportUsageInfo,\n+        module_batches::BatchingConfig,\n+    },\n     output::{OutputAsset, OutputAssets},\n };\n \n@@ -292,6 +295,12 @@ pub trait ChunkingContext {\n     fn chunk_item_id_from_module(self: Vc<Self>, module: Vc<Box<dyn Module>>) -> Vc<ModuleId> {\n         self.chunk_item_id_from_ident(module.ident())\n     }\n+\n+    #[turbo_tasks::function]\n+    async fn module_export_usage(\n+        self: Vc<Self>,\n+        module: Vc<Box<dyn Module>>,\n+    ) -> Result<Vc<ModuleExportUsageInfo>>;\n }\n \n pub trait ChunkingContextExt {"
        },
        {
            "sha": "6fc743be56550eb2bde085a0a050c68573c00b70",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/export_usage.rs",
            "status": "renamed",
            "additions": 33,
            "deletions": 31,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fexport_usage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fexport_usage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fexport_usage.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -1,43 +1,23 @@\n //! Intermediate tree shaking that uses global information but not good as the full tree shaking.\n \n-use anyhow::{Context, Result};\n+use anyhow::Result;\n use auto_hash_map::AutoSet;\n use rustc_hash::FxHashMap;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, Vc};\n-use turbopack_core::{module_graph::ModuleGraph, resolve::ExportUsage};\n \n-use crate::chunk::EcmascriptChunkPlaceable;\n-\n-#[turbo_tasks::function]\n-pub async fn get_module_export_usages(\n-    graph: ResolvedVc<ModuleGraph>,\n-    module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n-) -> Result<Vc<ModuleExportUsageInfo>> {\n-    let export_usage_info = compute_export_usage_info(graph)\n-        .resolve_strongly_consistent()\n-        .await?;\n-\n-    let export_usage_info = export_usage_info.await?;\n-\n-    let Some(exports) = export_usage_info.used_exports.get(&module) else {\n-        // We exclude template files from tree shaking because they are entrypoints to the module\n-        // graph.\n-        return Ok(ModuleExportUsageInfo::All.cell());\n-    };\n-\n-    Ok(exports.clone().cell())\n-}\n+use crate::{module::Module, module_graph::ModuleGraph, resolve::ExportUsage};\n \n #[turbo_tasks::function(operation)]\n-async fn compute_export_usage_info(graph: ResolvedVc<ModuleGraph>) -> Result<Vc<ExportUsageInfo>> {\n+pub async fn compute_export_usage_info(\n+    graph: ResolvedVc<ModuleGraph>,\n+) -> Result<Vc<ExportUsageInfo>> {\n     let mut used_exports = FxHashMap::<_, ModuleExportUsageInfo>::default();\n \n     graph\n         .await?\n         .traverse_all_edges_unordered(|(_, ref_data), target| {\n-            if let Some(target_module) =\n-                ResolvedVc::try_downcast::<Box<dyn EcmascriptChunkPlaceable>>(target.module)\n+            if let Some(target_module) = ResolvedVc::try_downcast::<Box<dyn Module>>(target.module)\n             {\n                 let e = used_exports.entry(target_module).or_default();\n \n@@ -46,25 +26,47 @@ async fn compute_export_usage_info(graph: ResolvedVc<ModuleGraph>) -> Result<Vc<\n \n             Ok(())\n         })\n-        .await\n-        .context(\"failed to traverse module graph\")?;\n+        .await?;\n \n     Ok(ExportUsageInfo { used_exports }.cell())\n }\n \n+#[turbo_tasks::value(transparent)]\n+pub struct OptionExportUsageInfo(Option<ResolvedVc<ExportUsageInfo>>);\n+\n #[turbo_tasks::value]\n-#[derive(Default)]\n pub struct ExportUsageInfo {\n-    used_exports: FxHashMap<ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>, ModuleExportUsageInfo>,\n+    used_exports: FxHashMap<ResolvedVc<Box<dyn Module>>, ModuleExportUsageInfo>,\n+}\n+\n+impl ExportUsageInfo {\n+    pub fn used_exports(&self, module: ResolvedVc<Box<dyn Module>>) -> Vc<ModuleExportUsageInfo> {\n+        if let Some(exports) = self.used_exports.get(&module) {\n+            exports.clone().cell()\n+        } else {\n+            // We exclude template files from tree shaking because they are entrypoints to the\n+            // module graph.\n+            ModuleExportUsageInfo::all()\n+        }\n+    }\n }\n \n #[turbo_tasks::value]\n #[derive(Default, Clone)]\n pub enum ModuleExportUsageInfo {\n-    All,\n+    /// Only the side effects are needed, no exports is used.\n     #[default]\n     Evaluation,\n     Exports(AutoSet<RcStr>),\n+    All,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl ModuleExportUsageInfo {\n+    #[turbo_tasks::function]\n+    pub fn all() -> Vc<Self> {\n+        ModuleExportUsageInfo::All.cell()\n+    }\n }\n \n impl ModuleExportUsageInfo {",
            "previous_filename": "turbopack/crates/turbopack-ecmascript/src/export_usage.rs"
        },
        {
            "sha": "66c1b7d2ebf78ad05bdebcc2532463244814c7f6",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -43,6 +43,7 @@ use crate::{\n \n pub mod async_module_info;\n pub mod chunk_group_info;\n+pub mod export_usage;\n pub mod merged_modules;\n pub mod module_batch;\n pub(crate) mod module_batches;"
        },
        {
            "sha": "04846d790320dcd1cb31f7df90860dfe88eef06a",
            "filename": "turbopack/crates/turbopack-ecmascript/src/code_gen.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 23,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -12,9 +12,7 @@ use swc_core::{\n };\n use turbo_rcstr::RcStr;\n use turbo_tasks::{NonLocalValue, ResolvedVc, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n-use turbopack_core::{\n-    chunk::ChunkingContext, module_graph::ModuleGraph, reference::ModuleReference,\n-};\n+use turbopack_core::{chunk::ChunkingContext, reference::ModuleReference};\n \n use crate::{\n     ScopeHoistingContext,\n@@ -194,30 +192,29 @@ pub enum CodeGen {\n impl CodeGen {\n     pub async fn code_generation(\n         &self,\n-        g: Vc<ModuleGraph>,\n         ctx: Vc<Box<dyn ChunkingContext>>,\n         scope_hoisting_context: ScopeHoistingContext<'_>,\n     ) -> Result<CodeGeneration> {\n         match self {\n-            Self::AmdDefineWithDependenciesCodeGen(v) => v.code_generation(g, ctx).await,\n-            Self::CjsRequireCacheAccess(v) => v.code_generation(g, ctx).await,\n-            Self::ConstantConditionCodeGen(v) => v.code_generation(g, ctx).await,\n-            Self::ConstantValueCodeGen(v) => v.code_generation(g, ctx).await,\n-            Self::DynamicExpression(v) => v.code_generation(g, ctx).await,\n-            Self::EsmBinding(v) => v.code_generation(g, ctx, scope_hoisting_context).await,\n-            Self::EsmModuleItem(v) => v.code_generation(g, ctx).await,\n-            Self::IdentReplacement(v) => v.code_generation(g, ctx).await,\n-            Self::ImportMetaBinding(v) => v.code_generation(g, ctx).await,\n-            Self::ImportMetaRef(v) => v.code_generation(g, ctx).await,\n-            Self::MemberReplacement(v) => v.code_generation(g, ctx).await,\n-            Self::Unreachable(v) => v.code_generation(g, ctx).await,\n-            Self::CjsRequireAssetReferenceCodeGen(v) => v.code_generation(g, ctx).await,\n-            Self::CjsRequireResolveAssetReferenceCodeGen(v) => v.code_generation(g, ctx).await,\n-            Self::EsmAsyncAssetReferenceCodeGen(v) => v.code_generation(g, ctx).await,\n-            Self::EsmModuleIdAssetReferenceCodeGen(v) => v.code_generation(g, ctx).await,\n-            Self::RequireContextAssetReferenceCodeGen(v) => v.code_generation(g, ctx).await,\n-            Self::UrlAssetReferenceCodeGen(v) => v.code_generation(g, ctx).await,\n-            Self::WorkerAssetReferenceCodeGen(v) => v.code_generation(g, ctx).await,\n+            Self::AmdDefineWithDependenciesCodeGen(v) => v.code_generation(ctx).await,\n+            Self::CjsRequireCacheAccess(v) => v.code_generation(ctx).await,\n+            Self::ConstantConditionCodeGen(v) => v.code_generation(ctx).await,\n+            Self::ConstantValueCodeGen(v) => v.code_generation(ctx).await,\n+            Self::DynamicExpression(v) => v.code_generation(ctx).await,\n+            Self::EsmBinding(v) => v.code_generation(ctx, scope_hoisting_context).await,\n+            Self::EsmModuleItem(v) => v.code_generation(ctx).await,\n+            Self::IdentReplacement(v) => v.code_generation(ctx).await,\n+            Self::ImportMetaBinding(v) => v.code_generation(ctx).await,\n+            Self::ImportMetaRef(v) => v.code_generation(ctx).await,\n+            Self::MemberReplacement(v) => v.code_generation(ctx).await,\n+            Self::Unreachable(v) => v.code_generation(ctx).await,\n+            Self::CjsRequireAssetReferenceCodeGen(v) => v.code_generation(ctx).await,\n+            Self::CjsRequireResolveAssetReferenceCodeGen(v) => v.code_generation(ctx).await,\n+            Self::EsmAsyncAssetReferenceCodeGen(v) => v.code_generation(ctx).await,\n+            Self::EsmModuleIdAssetReferenceCodeGen(v) => v.code_generation(ctx).await,\n+            Self::RequireContextAssetReferenceCodeGen(v) => v.code_generation(ctx).await,\n+            Self::UrlAssetReferenceCodeGen(v) => v.code_generation(ctx).await,\n+            Self::WorkerAssetReferenceCodeGen(v) => v.code_generation(ctx).await,\n         }\n     }\n }"
        },
        {
            "sha": "fb297a3c09fcfe56e1b887340a02a499bd1643c7",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 46,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -14,7 +14,6 @@ pub mod async_chunk;\n pub mod chunk;\n pub mod code_gen;\n mod errors;\n-pub mod export_usage;\n pub mod magic_identifier;\n pub mod manifest;\n mod merged_module;\n@@ -117,7 +116,6 @@ use crate::{\n     analyzer::graph::EvalContext,\n     chunk::{EcmascriptChunkPlaceable, placeable::is_marked_as_side_effect_free},\n     code_gen::{CodeGens, ModifiableAst},\n-    export_usage::{ModuleExportUsageInfo, get_module_export_usages},\n     merged_module::MergedEcmascriptModule,\n     parse::generate_js_source_map,\n     references::{\n@@ -342,20 +340,17 @@ pub trait EcmascriptAnalyzable: Module + Asset {\n     #[turbo_tasks::function]\n     async fn module_content_options(\n         self: Vc<Self>,\n-        module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n         async_module_info: Option<Vc<AsyncModuleInfo>>,\n     ) -> Result<Vc<EcmascriptModuleContentOptions>>;\n \n     #[turbo_tasks::function]\n     fn module_content(\n         self: Vc<Self>,\n-        module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n         async_module_info: Option<Vc<AsyncModuleInfo>>,\n     ) -> Result<Vc<EcmascriptModuleContent>> {\n-        let own_options =\n-            self.module_content_options(module_graph, chunking_context, async_module_info);\n+        let own_options = self.module_content_options(chunking_context, async_module_info);\n         Ok(EcmascriptModuleContent::new(own_options))\n     }\n }\n@@ -470,7 +465,6 @@ impl EcmascriptAnalyzable for EcmascriptModuleAsset {\n     #[turbo_tasks::function]\n     async fn module_content_options(\n         self: ResolvedVc<Self>,\n-        module_graph: ResolvedVc<ModuleGraph>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n         async_module_info: Option<ResolvedVc<AsyncModuleInfo>>,\n     ) -> Result<Vc<EcmascriptModuleContentOptions>> {\n@@ -484,21 +478,10 @@ impl EcmascriptAnalyzable for EcmascriptModuleAsset {\n             .reference_module_source_maps(Vc::upcast(*self))\n             .await?;\n \n-        let export_usage_info = if self.options().await?.remove_unused_exports {\n-            Some(\n-                get_module_export_usages(*module_graph, Vc::upcast(*self))\n-                    .to_resolved()\n-                    .await?,\n-            )\n-        } else {\n-            None\n-        };\n-\n         Ok(EcmascriptModuleContentOptions {\n             parsed,\n-            ident: self.ident().to_resolved().await?,\n+            module: ResolvedVc::upcast(self),\n             specified_module_type: module_type_result.module_type,\n-            module_graph,\n             chunking_context,\n             references: analyze.references().to_resolved().await?,\n             esm_references: analyze_ref.esm_references,\n@@ -509,7 +492,6 @@ impl EcmascriptAnalyzable for EcmascriptModuleAsset {\n             original_source_map: analyze_ref.source_map,\n             exports: analyze_ref.exports,\n             async_module_info,\n-            export_usage_info,\n         }\n         .cell())\n     }\n@@ -683,14 +665,13 @@ impl Asset for EcmascriptModuleAsset {\n #[turbo_tasks::value_impl]\n impl ChunkableModule for EcmascriptModuleAsset {\n     #[turbo_tasks::function]\n-    fn as_chunk_item(\n+    async fn as_chunk_item(\n         self: ResolvedVc<Self>,\n-        module_graph: ResolvedVc<ModuleGraph>,\n+        _module_graph: ResolvedVc<ModuleGraph>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     ) -> Vc<Box<dyn ChunkItem>> {\n         Vc::upcast(ModuleChunkItem::cell(ModuleChunkItem {\n             module: self,\n-            module_graph,\n             chunking_context,\n         }))\n     }\n@@ -789,7 +770,6 @@ impl ResolveOrigin for EcmascriptModuleAsset {\n #[turbo_tasks::value]\n struct ModuleChunkItem {\n     module: ResolvedVc<EcmascriptModuleAsset>,\n-    module_graph: ResolvedVc<ModuleGraph>,\n     chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n }\n \n@@ -842,11 +822,9 @@ impl EcmascriptChunkItem for ModuleChunkItem {\n                 .module_options(async_module_info);\n \n             // TODO check if we need to pass async_module_info at all\n-            let content = this.module.module_content(\n-                *this.module_graph,\n-                *this.chunking_context,\n-                async_module_info,\n-            );\n+            let content = this\n+                .module\n+                .module_content(*this.chunking_context, async_module_info);\n \n             EcmascriptChunkItemContent::new(\n                 content,\n@@ -875,10 +853,9 @@ pub struct EcmascriptModuleContent {\n #[turbo_tasks::value(shared)]\n #[derive(Clone, Debug, Hash, TaskInput)]\n pub struct EcmascriptModuleContentOptions {\n+    module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n     parsed: ResolvedVc<ParseResult>,\n-    ident: ResolvedVc<AssetIdent>,\n     specified_module_type: SpecifiedModuleType,\n-    module_graph: ResolvedVc<ModuleGraph>,\n     chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     references: ResolvedVc<ModuleReferences>,\n     esm_references: ResolvedVc<EsmAssetReferences>,\n@@ -889,7 +866,6 @@ pub struct EcmascriptModuleContentOptions {\n     original_source_map: Option<ResolvedVc<Box<dyn GenerateSourceMap>>>,\n     exports: ResolvedVc<EcmascriptExports>,\n     async_module_info: Option<ResolvedVc<AsyncModuleInfo>>,\n-    export_usage_info: Option<ResolvedVc<ModuleExportUsageInfo>>,\n }\n \n impl EcmascriptModuleContentOptions {\n@@ -899,7 +875,7 @@ impl EcmascriptModuleContentOptions {\n     ) -> Result<Vec<CodeGeneration>> {\n         let EcmascriptModuleContentOptions {\n             parsed,\n-            module_graph,\n+            module,\n             chunking_context,\n             references,\n             esm_references,\n@@ -908,7 +884,6 @@ impl EcmascriptModuleContentOptions {\n             async_module,\n             exports,\n             async_module_info,\n-            export_usage_info,\n             ..\n         } = self;\n \n@@ -934,7 +909,7 @@ impl EcmascriptModuleContentOptions {\n                                 **chunking_context,\n                                 scope_hoisting_context,\n                                 Some(**parsed),\n-                                *export_usage_info,\n+                                *module,\n                             )\n                             .await?,\n                     )\n@@ -959,9 +934,7 @@ impl EcmascriptModuleContentOptions {\n             let code_gens = code_generation\n                 .await?\n                 .iter()\n-                .map(|c| {\n-                    c.code_generation(**module_graph, **chunking_context, scope_hoisting_context)\n-                })\n+                .map(|c| c.code_generation(**chunking_context, scope_hoisting_context))\n                 .try_join()\n                 .await?;\n \n@@ -987,7 +960,7 @@ impl EcmascriptModuleContent {\n         let input = input.await?;\n         let EcmascriptModuleContentOptions {\n             parsed,\n-            ident,\n+            module,\n             specified_module_type,\n             generate_source_map,\n             original_source_map,\n@@ -1000,7 +973,7 @@ impl EcmascriptModuleContent {\n \n             let content = process_parse_result(\n                 *parsed,\n-                **ident,\n+                module.ident(),\n                 *specified_module_type,\n                 *generate_source_map,\n                 *original_source_map,\n@@ -1075,13 +1048,12 @@ impl EcmascriptModuleContent {\n \n             let contents = module_options\n                 .iter()\n-                .zip(modules.keys().copied())\n-                .map(async |(options, module)| {\n+                .map(async |options| {\n                     let options = options.await?;\n                     let EcmascriptModuleContentOptions {\n                         chunking_context,\n                         parsed,\n-                        ident,\n+                        module,\n                         specified_module_type,\n                         generate_source_map,\n                         original_source_map,\n@@ -1090,20 +1062,20 @@ impl EcmascriptModuleContent {\n \n                     let result = process_parse_result(\n                         *parsed,\n-                        **ident,\n+                        module.ident(),\n                         *specified_module_type,\n                         *generate_source_map,\n                         *original_source_map,\n                         *chunking_context.minify_type().await?,\n                         Some(&*options),\n                         Some(ScopeHoistingOptions {\n-                            module,\n+                            module: *module,\n                             modules: &modules,\n                         }),\n                     )\n                     .await?;\n \n-                    Ok((module, result))\n+                    Ok((*module, result))\n                 })\n                 .try_join()\n                 .await?;"
        },
        {
            "sha": "dfee97590af6699c7bae5ac4fb215a9ff2dc93b6",
            "filename": "turbopack/crates/turbopack-ecmascript/src/merged_module.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmerged_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmerged_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmerged_module.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -92,13 +92,12 @@ impl ChunkableModule for MergedEcmascriptModule {\n     #[turbo_tasks::function]\n     fn as_chunk_item(\n         self: ResolvedVc<Self>,\n-        module_graph: ResolvedVc<ModuleGraph>,\n+        _module_graph: ResolvedVc<ModuleGraph>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     ) -> Vc<Box<dyn ChunkItem>> {\n         Vc::upcast(\n             MergedEcmascriptModuleChunkItem {\n                 module: self,\n-                module_graph,\n                 chunking_context,\n             }\n             .cell(),\n@@ -109,7 +108,6 @@ impl ChunkableModule for MergedEcmascriptModule {\n #[turbo_tasks::value]\n struct MergedEcmascriptModuleChunkItem {\n     module: ResolvedVc<MergedEcmascriptModule>,\n-    module_graph: ResolvedVc<ModuleGraph>,\n     chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n }\n \n@@ -159,11 +157,7 @@ impl EcmascriptChunkItem for MergedEcmascriptModuleChunkItem {\n                 let Some(m) = ResolvedVc::try_downcast::<Box<dyn EcmascriptAnalyzable>>(*m) else {\n                     anyhow::bail!(\"Expected EcmascriptAnalyzable in scope hoisting group\");\n                 };\n-                Ok(m.module_content_options(\n-                    *self.module_graph,\n-                    *self.chunking_context,\n-                    async_module_info,\n-                ))\n+                Ok(m.module_content_options(*self.chunking_context, async_module_info))\n             })\n             .collect::<Result<Vec<_>>>()?;\n "
        },
        {
            "sha": "8f577810e2bf8793eb205d3d62cbb05741071c44",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/amd.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Famd.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Famd.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Famd.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -18,7 +18,6 @@ use turbo_tasks::{\n use turbopack_core::{\n     chunk::{ChunkableModuleReference, ChunkingContext},\n     issue::IssueSource,\n-    module_graph::ModuleGraph,\n     reference::ModuleReference,\n     resolve::{ModuleResolveResult, origin::ResolveOrigin, parse::Request},\n };\n@@ -157,7 +156,6 @@ impl AmdDefineWithDependenciesCodeGen {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let mut visitors = Vec::new();"
        },
        {
            "sha": "512ef7322dff6516ad0996918b47cb4dc43297f3",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/cjs.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fcjs.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fcjs.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fcjs.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -12,7 +12,6 @@ use turbo_tasks::{\n use turbopack_core::{\n     chunk::{ChunkableModuleReference, ChunkingContext},\n     issue::IssueSource,\n-    module_graph::ModuleGraph,\n     reference::ModuleReference,\n     resolve::{ModuleResolveResult, origin::ResolveOrigin, parse::Request},\n };\n@@ -157,7 +156,6 @@ pub struct CjsRequireAssetReferenceCodeGen {\n impl CjsRequireAssetReferenceCodeGen {\n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let reference = self.reference.await?;\n@@ -281,7 +279,6 @@ pub struct CjsRequireResolveAssetReferenceCodeGen {\n impl CjsRequireResolveAssetReferenceCodeGen {\n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let reference = self.reference.await?;\n@@ -344,7 +341,6 @@ impl CjsRequireCacheAccess {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let mut visitors = Vec::new();"
        },
        {
            "sha": "12d8a10baba5e3a716885dc7538e2345c3c77ed9",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/constant_condition.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_condition.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_condition.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_condition.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -2,7 +2,7 @@ use anyhow::Result;\n use serde::{Deserialize, Serialize};\n use swc_core::quote;\n use turbo_tasks::{NonLocalValue, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n-use turbopack_core::{chunk::ChunkingContext, module_graph::ModuleGraph};\n+use turbopack_core::chunk::ChunkingContext;\n \n use super::AstPath;\n use crate::{\n@@ -32,7 +32,6 @@ impl ConstantConditionCodeGen {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let value = self.value;"
        },
        {
            "sha": "f2bde35c1e014d482e0ed0a7226268030044fc53",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/constant_value.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_value.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_value.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_value.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -2,9 +2,7 @@ use anyhow::Result;\n use serde::{Deserialize, Serialize};\n use swc_core::quote;\n use turbo_tasks::{NonLocalValue, TaskInput, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n-use turbopack_core::{\n-    chunk::ChunkingContext, compile_time_info::CompileTimeDefineValue, module_graph::ModuleGraph,\n-};\n+use turbopack_core::{chunk::ChunkingContext, compile_time_info::CompileTimeDefineValue};\n \n use super::AstPath;\n use crate::{\n@@ -36,7 +34,6 @@ impl ConstantValueCodeGen {\n     }\n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let value = self.value.clone();"
        },
        {
            "sha": "02e5dba56d18780483e68896df10af24a9df79b5",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/dynamic_expression.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fdynamic_expression.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fdynamic_expression.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fdynamic_expression.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -2,7 +2,7 @@ use anyhow::Result;\n use serde::{Deserialize, Serialize};\n use swc_core::quote;\n use turbo_tasks::{NonLocalValue, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n-use turbopack_core::{chunk::ChunkingContext, module_graph::ModuleGraph};\n+use turbopack_core::chunk::ChunkingContext;\n \n use super::AstPath;\n use crate::{\n@@ -39,7 +39,6 @@ impl DynamicExpression {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let visitor = match self.ty {"
        },
        {
            "sha": "8f5e0d94e4d621135a88f1793f01bc3b14d977af",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/base.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -23,6 +23,7 @@ use turbopack_core::{\n         OptionStyledString, StyledString,\n     },\n     module::Module,\n+    module_graph::export_usage::ModuleExportUsageInfo,\n     reference::ModuleReference,\n     reference_type::{EcmaScriptModulesReferenceSubType, ImportWithType},\n     resolve::{\n@@ -165,7 +166,7 @@ impl ReferencedAsset {\n                     && let Some(export) = &export\n                     && let EcmascriptExports::EsmExports(exports) = *asset.get_exports().await?\n                 {\n-                    let exports = exports.expand_exports(None).await?;\n+                    let exports = exports.expand_exports(ModuleExportUsageInfo::all()).await?;\n                     let esm_export = exports.exports.get(export);\n                     match esm_export {\n                         Some(EsmExport::LocalBinding(_, _)) => {"
        },
        {
            "sha": "1fcf2e006b212351684410a1d5749f7fd6dae275",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/binding.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbinding.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbinding.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbinding.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -6,7 +6,7 @@ use swc_core::ecma::{\n };\n use turbo_rcstr::RcStr;\n use turbo_tasks::{NonLocalValue, ResolvedVc, Vc, trace::TraceRawVcs};\n-use turbopack_core::{chunk::ChunkingContext, module_graph::ModuleGraph};\n+use turbopack_core::chunk::ChunkingContext;\n \n use super::EsmAssetReference;\n use crate::{\n@@ -57,7 +57,6 @@ impl EsmBinding {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n         scope_hoisting_context: ScopeHoistingContext<'_>,\n     ) -> Result<CodeGeneration> {"
        },
        {
            "sha": "cf639471b68d2147d327e14b079838f528bf81ab",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/dynamic.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fdynamic.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fdynamic.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fdynamic.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -13,7 +13,6 @@ use turbopack_core::{\n     chunk::{ChunkableModuleReference, ChunkingContext, ChunkingType, ChunkingTypeOption},\n     environment::ChunkLoading,\n     issue::IssueSource,\n-    module_graph::ModuleGraph,\n     reference::ModuleReference,\n     reference_type::EcmaScriptModulesReferenceSubType,\n     resolve::{\n@@ -131,7 +130,6 @@ pub struct EsmAsyncAssetReferenceCodeGen {\n impl EsmAsyncAssetReferenceCodeGen {\n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let reference = self.reference.await?;"
        },
        {
            "sha": "44010036cc82438bbf467c49480fc44b78db004e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/export.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 13,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -22,6 +22,7 @@ use turbopack_core::{\n     ident::AssetIdent,\n     issue::{IssueExt, IssueSeverity, StyledString, analyze::AnalyzeIssue},\n     module::Module,\n+    module_graph::export_usage::ModuleExportUsageInfo,\n     reference::ModuleReference,\n     resolve::ModulePart,\n };\n@@ -31,7 +32,6 @@ use crate::{\n     EcmascriptModuleAsset, ScopeHoistingContext,\n     chunk::{EcmascriptChunkPlaceable, EcmascriptExports},\n     code_gen::{CodeGeneration, CodeGenerationHoistedStmt},\n-    export_usage::ModuleExportUsageInfo,\n     magic_identifier,\n     parse::ParseResult,\n     runtime_functions::{TURBOPACK_DYNAMIC, TURBOPACK_ESM},\n@@ -499,17 +499,14 @@ impl EsmExports {\n     #[turbo_tasks::function]\n     pub async fn expand_exports(\n         &self,\n-        export_usage_info: Option<ResolvedVc<ModuleExportUsageInfo>>,\n+        export_usage_info: Vc<ModuleExportUsageInfo>,\n     ) -> Result<Vc<ExpandedExports>> {\n         let mut exports: BTreeMap<RcStr, EsmExport> = self.exports.clone();\n         let mut dynamic_exports = vec![];\n-        let usage_info = match export_usage_info {\n-            Some(usage_info) => Some(usage_info.await?),\n-            None => None,\n-        };\n+        let export_usage_info = export_usage_info.await?;\n \n-        if let Some(usage_info) = &usage_info {\n-            exports.retain(|export, _| usage_info.is_export_used(export));\n+        if !matches!(*export_usage_info, ModuleExportUsageInfo::All) {\n+            exports.retain(|export, _| export_usage_info.is_export_used(export));\n         }\n \n         for &esm_ref in self.star_exports.iter() {\n@@ -524,9 +521,7 @@ impl EsmExports {\n             let export_info = expand_star_exports(**asset).await?;\n \n             for export in &export_info.star_exports {\n-                if let Some(usage_info) = &usage_info\n-                    && !usage_info.is_export_used(export)\n-                {\n+                if !export_usage_info.is_export_used(export) {\n                     continue;\n                 }\n \n@@ -561,9 +556,10 @@ impl EsmExports {\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n         scope_hoisting_context: ScopeHoistingContext<'_>,\n         parsed: Option<Vc<ParseResult>>,\n-        export_usage_info: Option<ResolvedVc<ModuleExportUsageInfo>>,\n+        module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n     ) -> Result<CodeGeneration> {\n-        let expanded = self.expand_exports(export_usage_info.map(|v| *v)).await?;\n+        let export_usage_info = chunking_context.module_export_usage(*ResolvedVc::upcast(module));\n+        let expanded = self.expand_exports(export_usage_info).await?;\n \n         if scope_hoisting_context.skip_module_exports() && expanded.dynamic_exports.is_empty() {\n             // If the current module is not exposed, no need to generate exports."
        },
        {
            "sha": "88407cb45de2d2fb98978e0be6c55d212d651ea9",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/meta.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmeta.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmeta.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmeta.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -10,7 +10,7 @@ use swc_core::{\n use turbo_rcstr::rcstr;\n use turbo_tasks::{NonLocalValue, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n-use turbopack_core::{chunk::ChunkingContext, module_graph::ModuleGraph};\n+use turbopack_core::chunk::ChunkingContext;\n \n use crate::{\n     code_gen::{CodeGen, CodeGeneration},\n@@ -38,7 +38,6 @@ impl ImportMetaBinding {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let rel_path = chunking_context\n@@ -98,7 +97,6 @@ impl ImportMetaRef {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let visitor = create_visitor!(self.ast_path, visit_mut_expr, |expr: &mut Expr| {"
        },
        {
            "sha": "a7a5169e44080e726052f332d14c6b911cb15c5c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/module_id.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_id.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_id.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_id.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -7,7 +7,6 @@ use turbo_tasks::{\n };\n use turbopack_core::{\n     chunk::{ChunkableModuleReference, ChunkingContext, ChunkingTypeOption, ModuleChunkItemIdExt},\n-    module_graph::ModuleGraph,\n     reference::ModuleReference,\n     resolve::ModuleResolveResult,\n };\n@@ -83,7 +82,6 @@ pub struct EsmModuleIdAssetReferenceCodeGen {\n impl EsmModuleIdAssetReferenceCodeGen {\n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let mut visitors = Vec::new();"
        },
        {
            "sha": "752c42bbe1f3c4c0ed1179e42c60ee4f25c95443",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/module_item.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_item.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -11,7 +11,7 @@ use swc_core::{\n     quote,\n };\n use turbo_tasks::{NonLocalValue, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n-use turbopack_core::{chunk::ChunkingContext, module_graph::ModuleGraph};\n+use turbopack_core::chunk::ChunkingContext;\n \n use crate::{\n     code_gen::{CodeGen, CodeGeneration},\n@@ -34,7 +34,6 @@ impl EsmModuleItem {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let mut visitors = Vec::new();"
        },
        {
            "sha": "7e13c78c3f57bf77029cfff7f9de011340bdde14",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/url.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Furl.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Furl.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Furl.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -16,7 +16,6 @@ use turbopack_core::{\n     },\n     environment::Rendering,\n     issue::IssueSource,\n-    module_graph::ModuleGraph,\n     reference::ModuleReference,\n     reference_type::{ReferenceType, UrlReferenceSubType},\n     resolve::{\n@@ -173,7 +172,6 @@ impl UrlAssetReferenceCodeGen {\n     */\n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let mut visitors = vec![];"
        },
        {
            "sha": "59209335899441bb8c9e791cd734f1ad7dffb8b9",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/ident.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fident.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fident.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fident.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -3,7 +3,7 @@ use serde::{Deserialize, Serialize};\n use swc_core::{ecma::ast::Expr, quote};\n use turbo_rcstr::RcStr;\n use turbo_tasks::{NonLocalValue, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n-use turbopack_core::{chunk::ChunkingContext, module_graph::ModuleGraph};\n+use turbopack_core::chunk::ChunkingContext;\n \n use super::AstPath;\n use crate::{\n@@ -24,7 +24,6 @@ impl IdentReplacement {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let value = self.value.clone();"
        },
        {
            "sha": "9c078b6bf438192b501a4024027b9097544e46a2",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/member.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmember.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmember.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmember.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -7,7 +7,7 @@ use swc_core::{\n };\n use turbo_rcstr::RcStr;\n use turbo_tasks::{NonLocalValue, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n-use turbopack_core::{chunk::ChunkingContext, module_graph::ModuleGraph};\n+use turbopack_core::chunk::ChunkingContext;\n \n use super::AstPath;\n use crate::{\n@@ -29,7 +29,6 @@ impl MemberReplacement {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let key = self.key.clone();"
        },
        {
            "sha": "4becb1d9e72a719a9433f0c5ac5a26c225761813",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/require_context.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Frequire_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Frequire_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Frequire_context.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -318,7 +318,6 @@ pub struct RequireContextAssetReferenceCodeGen {\n impl RequireContextAssetReferenceCodeGen {\n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let module_id = self"
        },
        {
            "sha": "c61368fa6798f3bcf29143723712bcbb565b0888",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/unreachable.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Funreachable.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Funreachable.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Funreachable.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -24,7 +24,7 @@ use swc_core::{\n     quote,\n };\n use turbo_tasks::{NonLocalValue, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n-use turbopack_core::{chunk::ChunkingContext, module_graph::ModuleGraph};\n+use turbopack_core::chunk::ChunkingContext;\n \n use crate::{\n     code_gen::{AstModifier, CodeGen, CodeGeneration},\n@@ -139,7 +139,6 @@ impl Unreachable {\n \n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let comments = SwcComments::default();"
        },
        {
            "sha": "d12f34c49a6a500030ba26097a07c156967bff1c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/worker.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fworker.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fworker.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fworker.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -13,7 +13,6 @@ use turbopack_core::{\n     chunk::{ChunkableModule, ChunkableModuleReference, ChunkingContext},\n     issue::{IssueExt, IssueSeverity, IssueSource, StyledString, code_gen::CodeGenerationIssue},\n     module::Module,\n-    module_graph::ModuleGraph,\n     reference::ModuleReference,\n     reference_type::{ReferenceType, WorkerReferenceSubType},\n     resolve::{ModuleResolveResult, origin::ResolveOrigin, parse::Request, url_resolve},\n@@ -134,7 +133,6 @@ pub struct WorkerAssetReferenceCodeGen {\n impl WorkerAssetReferenceCodeGen {\n     pub async fn code_generation(\n         &self,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let Some(loader) = self.reference.await?.worker_loader_module().await? else {"
        },
        {
            "sha": "31341da1c852bd3ba01c93336813b5dbd322f7bb",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/facade/chunk_item.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fchunk_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fchunk_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fchunk_item.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -4,7 +4,6 @@ use turbopack_core::{\n     chunk::{AsyncModuleInfo, ChunkItem, ChunkType, ChunkingContext},\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::ModuleGraph,\n };\n \n use super::module::EcmascriptModuleFacadeModule;\n@@ -20,7 +19,6 @@ use crate::{\n #[turbo_tasks::value(shared)]\n pub struct EcmascriptModuleFacadeChunkItem {\n     pub(crate) module: ResolvedVc<EcmascriptModuleFacadeModule>,\n-    pub(crate) module_graph: ResolvedVc<ModuleGraph>,\n     pub(crate) chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n }\n \n@@ -37,11 +35,10 @@ impl EcmascriptChunkItem for EcmascriptModuleFacadeChunkItem {\n         async_module_info: Option<Vc<AsyncModuleInfo>>,\n     ) -> Result<Vc<EcmascriptChunkItemContent>> {\n         let chunking_context = self.chunking_context;\n-        let module_graph = self.module_graph;\n \n-        let content =\n-            self.module\n-                .module_content(*module_graph, *chunking_context, async_module_info);\n+        let content = self\n+            .module\n+            .module_content(*chunking_context, async_module_info);\n \n         let async_module_options = self\n             .module"
        },
        {
            "sha": "b499b19bed6ad1ccfaa4f122412a74e21b21b934",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/facade/module.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 17,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -23,7 +23,6 @@ use crate::{\n     EcmascriptModuleContentOptions, EcmascriptOptions, MergedEcmascriptModule, SpecifiedModuleType,\n     chunk::{EcmascriptChunkPlaceable, EcmascriptExports},\n     code_gen::CodeGens,\n-    export_usage::get_module_export_usages,\n     parse::ParseResult,\n     references::{\n         async_module::{AsyncModule, OptionAsyncModule},\n@@ -234,27 +233,15 @@ impl EcmascriptAnalyzable for EcmascriptModuleFacadeModule {\n     #[turbo_tasks::function]\n     async fn module_content_options(\n         self: ResolvedVc<Self>,\n-        module_graph: ResolvedVc<ModuleGraph>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n         async_module_info: Option<ResolvedVc<AsyncModuleInfo>>,\n     ) -> Result<Vc<EcmascriptModuleContentOptions>> {\n         let (esm_references, part_references) = self.await?.specific_references().await?;\n \n-        let export_usage_info = if self.await?.remove_unused_exports {\n-            Some(\n-                get_module_export_usages(*module_graph, Vc::upcast(*self))\n-                    .to_resolved()\n-                    .await?,\n-            )\n-        } else {\n-            None\n-        };\n-\n         Ok(EcmascriptModuleContentOptions {\n             parsed: ParseResult::empty().to_resolved().await?,\n-            ident: self.ident().to_resolved().await?,\n+            module: ResolvedVc::upcast(self),\n             specified_module_type: SpecifiedModuleType::EcmaScript,\n-            module_graph,\n             chunking_context,\n             references: self.references().to_resolved().await?,\n             esm_references,\n@@ -268,7 +255,6 @@ impl EcmascriptAnalyzable for EcmascriptModuleFacadeModule {\n             original_source_map: None,\n             exports: self.get_exports().to_resolved().await?,\n             async_module_info,\n-            export_usage_info,\n         }\n         .cell())\n     }\n@@ -440,13 +426,12 @@ impl ChunkableModule for EcmascriptModuleFacadeModule {\n     #[turbo_tasks::function]\n     fn as_chunk_item(\n         self: ResolvedVc<Self>,\n-        module_graph: ResolvedVc<ModuleGraph>,\n+        _module_graph: ResolvedVc<ModuleGraph>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     ) -> Result<Vc<Box<dyn turbopack_core::chunk::ChunkItem>>> {\n         Ok(Vc::upcast(\n             EcmascriptModuleFacadeChunkItem {\n                 module: self,\n-                module_graph,\n                 chunking_context,\n             }\n             .cell(),"
        },
        {
            "sha": "ca811b6753c1fd338065c393292cbbbfe67d89e2",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/locals/chunk_item.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fchunk_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fchunk_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fchunk_item.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -4,7 +4,6 @@ use turbopack_core::{\n     chunk::{AsyncModuleInfo, ChunkItem, ChunkType, ChunkingContext},\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::ModuleGraph,\n };\n \n use super::module::EcmascriptModuleLocalsModule;\n@@ -17,7 +16,6 @@ use crate::{\n #[turbo_tasks::value(shared)]\n pub struct EcmascriptModuleLocalsChunkItem {\n     pub(super) module: ResolvedVc<EcmascriptModuleLocalsModule>,\n-    pub(super) module_graph: ResolvedVc<ModuleGraph>,\n     pub(super) chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n }\n \n@@ -35,7 +33,6 @@ impl EcmascriptChunkItem for EcmascriptModuleLocalsChunkItem {\n     ) -> Result<Vc<EcmascriptChunkItemContent>> {\n         let module = self.module.await?;\n         let chunking_context = self.chunking_context;\n-        let module_graph = self.module_graph;\n         let original_module = module.module;\n \n         let analyze = original_module.analyze();\n@@ -44,9 +41,9 @@ impl EcmascriptChunkItem for EcmascriptModuleLocalsChunkItem {\n             .async_module\n             .module_options(async_module_info);\n \n-        let content =\n-            self.module\n-                .module_content(*module_graph, *chunking_context, async_module_info);\n+        let content = self\n+            .module\n+            .module_content(*chunking_context, async_module_info);\n \n         Ok(EcmascriptChunkItemContent::new(\n             content,"
        },
        {
            "sha": "97f3dcd589ae9d7c4c3003372347d794444682f8",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/locals/module.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 19,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -21,7 +21,6 @@ use crate::{\n     AnalyzeEcmascriptModuleResult, EcmascriptAnalyzable, EcmascriptModuleAsset,\n     EcmascriptModuleContent, EcmascriptModuleContentOptions, MergedEcmascriptModule,\n     chunk::{EcmascriptChunkPlaceable, EcmascriptExports},\n-    export_usage::get_module_export_usages,\n     references::{\n         async_module::OptionAsyncModule,\n         esm::{EsmExport, EsmExports},\n@@ -95,8 +94,7 @@ impl EcmascriptAnalyzable for EcmascriptModuleLocalsModule {\n \n     #[turbo_tasks::function]\n     async fn module_content_options(\n-        self: Vc<Self>,\n-        module_graph: ResolvedVc<ModuleGraph>,\n+        self: ResolvedVc<Self>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n         async_module_info: Option<ResolvedVc<AsyncModuleInfo>>,\n     ) -> Result<Vc<EcmascriptModuleContentOptions>> {\n@@ -109,24 +107,13 @@ impl EcmascriptAnalyzable for EcmascriptModuleLocalsModule {\n \n         let module_type_result = original_module.determine_module_type().await?;\n         let generate_source_map = *chunking_context\n-            .reference_module_source_maps(Vc::upcast(self))\n+            .reference_module_source_maps(Vc::upcast(*self))\n             .await?;\n \n-        let export_usage_info = if original_module.options().await?.remove_unused_exports {\n-            Some(\n-                get_module_export_usages(*module_graph, Vc::upcast(self))\n-                    .to_resolved()\n-                    .await?,\n-            )\n-        } else {\n-            None\n-        };\n-\n         Ok(EcmascriptModuleContentOptions {\n             parsed,\n-            ident: self.ident().to_resolved().await?,\n+            module: ResolvedVc::upcast(self),\n             specified_module_type: module_type_result.module_type,\n-            module_graph,\n             chunking_context,\n             references: analyze.local_references().to_resolved().await?,\n             esm_references: analyze_result.esm_local_references,\n@@ -137,7 +124,6 @@ impl EcmascriptAnalyzable for EcmascriptModuleLocalsModule {\n             original_source_map: analyze_result.source_map,\n             exports,\n             async_module_info,\n-            export_usage_info,\n         }\n         .cell())\n     }\n@@ -195,13 +181,12 @@ impl ChunkableModule for EcmascriptModuleLocalsModule {\n     #[turbo_tasks::function]\n     fn as_chunk_item(\n         self: ResolvedVc<Self>,\n-        module_graph: ResolvedVc<ModuleGraph>,\n+        _module_graph: ResolvedVc<ModuleGraph>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     ) -> Vc<Box<dyn turbopack_core::chunk::ChunkItem>> {\n         Vc::upcast(\n             EcmascriptModuleLocalsChunkItem {\n                 module: self,\n-                module_graph,\n                 chunking_context,\n             }\n             .cell(),"
        },
        {
            "sha": "e44d46161e5d9a1daa1291ea6f36c635d9bb76b3",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/asset.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 20,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -22,7 +22,6 @@ use crate::{\n     EcmascriptModuleAssetType, EcmascriptModuleContent, EcmascriptModuleContentOptions,\n     EcmascriptParsable,\n     chunk::{EcmascriptChunkPlaceable, EcmascriptExports},\n-    export_usage::get_module_export_usages,\n     parse::ParseResult,\n     references::{\n         FollowExportsResult, analyse_ecmascript_module, esm::FoundExportType, follow_reexports,\n@@ -77,8 +76,7 @@ impl EcmascriptAnalyzable for EcmascriptModulePartAsset {\n \n     #[turbo_tasks::function]\n     async fn module_content_options(\n-        self: Vc<Self>,\n-        module_graph: ResolvedVc<ModuleGraph>,\n+        self: ResolvedVc<Self>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n         async_module_info: Option<ResolvedVc<AsyncModuleInfo>>,\n     ) -> Result<Vc<EcmascriptModuleContentOptions>> {\n@@ -94,24 +92,12 @@ impl EcmascriptAnalyzable for EcmascriptModulePartAsset {\n \n         let module_type_result = module.full_module.determine_module_type().await?;\n         let generate_source_map = *chunking_context\n-            .reference_module_source_maps(Vc::upcast(self))\n+            .reference_module_source_maps(Vc::upcast(*self))\n             .await?;\n-\n-        let export_usage_info = if module.full_module.options().await?.remove_unused_exports {\n-            Some(\n-                get_module_export_usages(*module_graph, Vc::upcast(*module.full_module))\n-                    .to_resolved()\n-                    .await?,\n-            )\n-        } else {\n-            None\n-        };\n-\n         Ok(EcmascriptModuleContentOptions {\n             parsed,\n-            ident: self.ident().to_resolved().await?,\n+            module: ResolvedVc::upcast(self),\n             specified_module_type: module_type_result.module_type,\n-            module_graph,\n             chunking_context,\n             references: analyze.references().to_resolved().await?,\n             esm_references: analyze_ref.esm_references,\n@@ -122,7 +108,6 @@ impl EcmascriptAnalyzable for EcmascriptModulePartAsset {\n             original_source_map: analyze_ref.source_map,\n             exports: analyze_ref.exports,\n             async_module_info,\n-            export_usage_info,\n         }\n         .cell())\n     }\n@@ -402,13 +387,12 @@ impl ChunkableModule for EcmascriptModulePartAsset {\n     #[turbo_tasks::function]\n     fn as_chunk_item(\n         self: ResolvedVc<Self>,\n-        module_graph: ResolvedVc<ModuleGraph>,\n+        _module_graph: ResolvedVc<ModuleGraph>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     ) -> Vc<Box<dyn turbopack_core::chunk::ChunkItem>> {\n         Vc::upcast(\n             EcmascriptModulePartChunkItem {\n                 module: self,\n-                module_graph,\n                 chunking_context,\n             }\n             .cell(),"
        },
        {
            "sha": "43386bd90f4b10bc88d6feb59fbab5b19cfe7b88",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/chunk_item.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fchunk_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fchunk_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fchunk_item.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -28,7 +28,6 @@ use crate::{\n #[turbo_tasks::value(shared)]\n pub struct EcmascriptModulePartChunkItem {\n     pub(super) module: ResolvedVc<EcmascriptModulePartAsset>,\n-    pub(super) module_graph: ResolvedVc<ModuleGraph>,\n     pub(super) chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n }\n \n@@ -48,11 +47,9 @@ impl EcmascriptChunkItem for EcmascriptModulePartChunkItem {\n         let analyze_ref = analyze.await?;\n         let async_module_options = analyze_ref.async_module.module_options(async_module_info);\n \n-        let content = self.module.module_content(\n-            *self.module_graph,\n-            *self.chunking_context,\n-            async_module_info,\n-        );\n+        let content = self\n+            .module\n+            .module_content(*self.chunking_context, async_module_info);\n \n         Ok(EcmascriptChunkItemContent::new(\n             content,"
        },
        {
            "sha": "f08c01abddc2336255404218b7daec1bc8ac296a",
            "filename": "turbopack/crates/turbopack-nodejs/src/chunking_context.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -16,7 +16,11 @@ use turbopack_core::{\n     environment::Environment,\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::{ModuleGraph, chunk_group_info::ChunkGroup},\n+    module_graph::{\n+        ModuleGraph,\n+        chunk_group_info::ChunkGroup,\n+        export_usage::{ExportUsageInfo, ModuleExportUsageInfo},\n+    },\n     output::{OutputAsset, OutputAssets},\n };\n use turbopack_ecmascript::{\n@@ -84,6 +88,11 @@ impl NodeJsChunkingContextBuilder {\n         self\n     }\n \n+    pub fn export_usage(mut self, export_usage: Option<ResolvedVc<ExportUsageInfo>>) -> Self {\n+        self.chunking_context.export_usage = export_usage;\n+        self\n+    }\n+\n     pub fn chunking_config<T>(mut self, ty: ResolvedVc<T>, chunking_config: ChunkingConfig) -> Self\n     where\n         T: Upcast<Box<dyn ChunkType>>,\n@@ -134,6 +143,8 @@ pub struct NodeJsChunkingContext {\n     manifest_chunks: bool,\n     /// The strategy to use for generating module ids\n     module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n+    /// The module export usage info, if available.\n+    export_usage: Option<ResolvedVc<ExportUsageInfo>>,\n     /// Whether to use file:// uris for source map sources\n     should_use_file_source_map_uris: bool,\n     /// The chunking configs\n@@ -170,6 +181,7 @@ impl NodeJsChunkingContext {\n                 manifest_chunks: false,\n                 should_use_file_source_map_uris: false,\n                 module_id_strategy: ResolvedVc::upcast(DevModuleIdStrategy::new_resolved()),\n+                export_usage: None,\n                 chunking_configs: Default::default(),\n             },\n         }\n@@ -497,4 +509,16 @@ impl ChunkingContext for NodeJsChunkingContext {\n             self.chunk_item_id_from_ident(AsyncLoaderModule::asset_ident_for(module))\n         })\n     }\n+\n+    #[turbo_tasks::function]\n+    async fn module_export_usage(\n+        self: Vc<Self>,\n+        module: ResolvedVc<Box<dyn Module>>,\n+    ) -> Result<Vc<ModuleExportUsageInfo>> {\n+        if let Some(export_usage) = self.await?.export_usage {\n+            Ok(export_usage.await?.used_exports(module))\n+        } else {\n+            Ok(ModuleExportUsageInfo::all())\n+        }\n+    }\n }"
        },
        {
            "sha": "10bef384351ed80f48414f666b5297e7a5183845",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 41,
            "deletions": 21,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -39,6 +39,9 @@ use turbopack_core::{\n     file_source::FileSource,\n     ident::Layer,\n     issue::IssueDescriptionExt,\n+    module_graph::{\n+        ModuleGraph, chunk_group_info::ChunkGroupEntry, export_usage::compute_export_usage_info,\n+    },\n     reference_type::{InnerAssets, ReferenceType},\n     resolve::{\n         ExternalTraced, ExternalType,\n@@ -414,6 +417,35 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n         Layer::new(rcstr!(\"test\")),\n     ));\n \n+    let jest_entry_source = FileSource::new(jest_entry_path);\n+    let test_source = FileSource::new(test_path);\n+\n+    let test_asset = asset_context\n+        .process(\n+            Vc::upcast(test_source),\n+            ReferenceType::Internal(InnerAssets::empty().to_resolved().await?),\n+        )\n+        .module()\n+        .to_resolved()\n+        .await?;\n+\n+    let jest_entry_asset = asset_context\n+        .process(\n+            Vc::upcast(jest_entry_source),\n+            ReferenceType::Internal(ResolvedVc::cell(fxindexmap! {\n+                rcstr!(\"TESTS\") => test_asset,\n+            })),\n+        )\n+        .module();\n+\n+    // Keep this in sync with what `evaluate` does internally\n+    let module_graph = ModuleGraph::from_modules(\n+        Vc::cell(vec![ChunkGroupEntry::Entry(vec![\n+            jest_entry_asset.to_resolved().await?,\n+        ])]),\n+        false,\n+    );\n+\n     let chunking_context = NodeJsChunkingContext::builder(\n         project_root.clone(),\n         chunk_root_path.clone(),\n@@ -446,28 +478,16 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n     } else {\n         MinifyType::NoMinify\n     })\n-    .build();\n-\n-    let jest_entry_source = FileSource::new(jest_entry_path);\n-    let test_source = FileSource::new(test_path);\n-\n-    let test_asset = asset_context\n-        .process(\n-            Vc::upcast(test_source),\n-            ReferenceType::Internal(InnerAssets::empty().to_resolved().await?),\n-        )\n-        .module()\n-        .to_resolved()\n-        .await?;\n-\n-    let jest_entry_asset = asset_context\n-        .process(\n-            Vc::upcast(jest_entry_source),\n-            ReferenceType::Internal(ResolvedVc::cell(fxindexmap! {\n-                rcstr!(\"TESTS\") => test_asset,\n-            })),\n+    .export_usage(if remove_unused_exports {\n+        Some(\n+            compute_export_usage_info(module_graph.to_resolved().await?)\n+                .resolve_strongly_consistent()\n+                .await?,\n         )\n-        .module();\n+    } else {\n+        None\n+    })\n+    .build();\n \n     let res = evaluate(\n         jest_entry_asset,"
        },
        {
            "sha": "75ca17dca0980a727bf43e4572ec5f7b7c7f1fd0",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 78,
            "deletions": 61,
            "changes": 139,
            "blob_url": "https://github.com/vercel/next.js/blob/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f5376f422362f9c312a8e84ad258e866d12d2ee2/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=f5376f422362f9c312a8e84ad258e866d12d2ee2",
            "patch": "@@ -46,6 +46,7 @@ use turbopack_core::{\n     module_graph::{\n         ModuleGraph,\n         chunk_group_info::{ChunkGroup, ChunkGroupEntry},\n+        export_usage::compute_export_usage_info,\n     },\n     output::{OutputAsset, OutputAssets},\n     reference_type::{EntryReferenceSubType, ReferenceType},\n@@ -352,8 +353,55 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n         .await?\n         .map(|asset| EvaluatableAssets::one(asset.to_evaluatable(asset_context)));\n \n+    let entry_module = asset_context\n+        .process(\n+            Vc::upcast(FileSource::new(entry_asset)),\n+            ReferenceType::Entry(EntryReferenceSubType::Undefined),\n+        )\n+        .module();\n+\n+    let (evaluatable_assets, entry_modules) = if let Some(ecmascript) =\n+        Vc::try_resolve_sidecast::<Box<dyn EvaluatableAsset>>(entry_module).await?\n+    {\n+        let evaluatable_assets = runtime_entries\n+            .unwrap_or_else(EvaluatableAssets::empty)\n+            .with_entry(Vc::upcast(ecmascript));\n+        (\n+            evaluatable_assets,\n+            evaluatable_assets\n+                .await?\n+                .iter()\n+                .copied()\n+                .map(ResolvedVc::upcast)\n+                .collect::<Vec<_>>(),\n+        )\n+    } else {\n+        // TODO convert into a serve-able asset\n+        bail!(\"Entry module is not chunkable, so it can't be used to bootstrap the application\")\n+    };\n+\n+    let module_graph = ModuleGraph::from_modules(\n+        Vc::cell(vec![ChunkGroupEntry::Entry(entry_modules.clone())]),\n+        false,\n+    );\n+\n+    let export_usage = if options.remove_unused_exports {\n+        Some(\n+            compute_export_usage_info(module_graph.to_resolved().await?)\n+                .resolve_strongly_consistent()\n+                .await?,\n+        )\n+    } else {\n+        None\n+    };\n+\n     let chunk_root_path = project_path.join(\"output\")?;\n     let static_root_path = project_path.join(\"static\")?;\n+    let expected_paths = expected(chunk_root_path.clone())\n+        .await?\n+        .union(&expected(static_root_path.clone()).await?)\n+        .cloned()\n+        .collect();\n \n     let chunking_context: Vc<Box<dyn ChunkingContext>> = match options.runtime {\n         Runtime::Browser => {\n@@ -367,7 +415,8 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n                 env,\n                 options.runtime_type,\n             )\n-            .module_merging(options.scope_hoisting);\n+            .module_merging(options.scope_hoisting)\n+            .export_usage(export_usage);\n \n             if options.production_chunking {\n                 builder = builder.chunking_config(\n@@ -394,7 +443,8 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n                 options.runtime_type,\n             )\n             .minify_type(options.minify_type)\n-            .module_merging(options.scope_hoisting);\n+            .module_merging(options.scope_hoisting)\n+            .export_usage(export_usage);\n \n             if options.production_chunking {\n                 builder = builder.chunking_config(\n@@ -411,66 +461,33 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n         }\n     };\n \n-    let expected_paths = expected(chunk_root_path.clone())\n-        .await?\n-        .union(&expected(static_root_path.clone()).await?)\n-        .cloned()\n-        .collect();\n-\n-    let entry_module = asset_context\n-        .process(\n-            Vc::upcast(FileSource::new(entry_asset)),\n-            ReferenceType::Entry(EntryReferenceSubType::Undefined),\n-        )\n-        .module();\n-\n-    let chunks = if let Some(ecmascript) =\n-        Vc::try_resolve_sidecast::<Box<dyn EvaluatableAsset>>(entry_module).await?\n-    {\n-        let evaluatable_assets = runtime_entries\n-            .unwrap_or_else(EvaluatableAssets::empty)\n-            .with_entry(Vc::upcast(ecmascript));\n-        let all_modules = evaluatable_assets\n-            .await?\n-            .iter()\n-            .copied()\n-            .map(ResolvedVc::upcast)\n-            .collect::<Vec<_>>();\n-        let module_graph = ModuleGraph::from_modules(\n-            Vc::cell(vec![ChunkGroupEntry::Entry(all_modules.clone())]),\n-            false,\n-        );\n-        // TODO: Load runtime entries from snapshots\n-        match options.runtime {\n-            Runtime::Browser => chunking_context.evaluated_chunk_group_assets(\n-                entry_module.ident(),\n-                ChunkGroup::Entry(all_modules.into_iter().collect()),\n-                module_graph,\n-                AvailabilityInfo::Root,\n-            ),\n-            Runtime::NodeJs => {\n-                Vc::cell(vec![\n-                    Vc::try_resolve_downcast_type::<NodeJsChunkingContext>(chunking_context)\n-                        .await?\n-                        .unwrap()\n-                        .entry_chunk_group(\n-                            // `expected` expects a completely flat output directory.\n-                            chunk_root_path\n-                                .join(entry_module.ident().path().await?.file_stem().unwrap())?\n-                                .with_extension(\"entry.js\"),\n-                            evaluatable_assets,\n-                            module_graph,\n-                            OutputAssets::empty(),\n-                            AvailabilityInfo::Root,\n-                        )\n-                        .await?\n-                        .asset,\n-                ])\n-            }\n+    // TODO: Load runtime entries from snapshots\n+    let chunks = match options.runtime {\n+        Runtime::Browser => chunking_context.evaluated_chunk_group_assets(\n+            entry_module.ident(),\n+            ChunkGroup::Entry(entry_modules.into_iter().collect()),\n+            module_graph,\n+            AvailabilityInfo::Root,\n+        ),\n+        Runtime::NodeJs => {\n+            Vc::cell(vec![\n+                Vc::try_resolve_downcast_type::<NodeJsChunkingContext>(chunking_context)\n+                    .await?\n+                    .unwrap()\n+                    .entry_chunk_group(\n+                        // `expected` expects a completely flat output directory.\n+                        chunk_root_path\n+                            .join(entry_module.ident().path().await?.file_stem().unwrap())?\n+                            .with_extension(\"entry.js\"),\n+                        evaluatable_assets,\n+                        module_graph,\n+                        OutputAssets::empty(),\n+                        AvailabilityInfo::Root,\n+                    )\n+                    .await?\n+                    .asset,\n+            ])\n         }\n-    } else {\n-        // TODO convert into a serve-able asset\n-        bail!(\"Entry module is not chunkable, so it can't be used to bootstrap the application\")\n     };\n \n     let mut seen = FxHashSet::default();"
        }
    ],
    "stats": {
        "total": 991,
        "additions": 530,
        "deletions": 461
    }
}