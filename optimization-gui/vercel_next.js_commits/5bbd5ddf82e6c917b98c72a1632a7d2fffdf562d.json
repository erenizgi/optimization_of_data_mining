{
    "author": "mischnic",
    "message": "Turbopack: improve Lightning CSS error handling (#82561)\n\nDon't return the `Result:Err`, but turn into an issue and return `Unparseable`\r\n\r\nAlso fixes the location translation: Lightning CSS uses 1-based columns, while Turbopack uses 0-based column indices.",
    "sha": "5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d",
    "files": [
        {
            "sha": "0bceadaa1cf9ab593034b1ecf7648776c498b9bd",
            "filename": "test/development/acceptance-app/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts?ref=5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d",
            "patch": "@@ -415,13 +415,13 @@ describe('ReactRefreshLogBox app', () => {\n     if (isTurbopack) {\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"description\": \"Parsing css source code failed\",\n+         \"description\": \"Parsing CSS source code failed\",\n          \"environmentLabel\": null,\n          \"label\": \"Build Error\",\n-         \"source\": \"./index.module.css (1:9)\n-       Parsing css source code failed\n+         \"source\": \"./index.module.css (1:8)\n+       Parsing CSS source code failed\n        > 1 | .button\n-           |         ^\",\n+           |        ^\",\n          \"stack\": [],\n        }\n       `)\n@@ -447,11 +447,11 @@ describe('ReactRefreshLogBox app', () => {\n     if (isTurbopack) {\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"description\": \"Parsing css source code failed\",\n+         \"description\": \"Transforming CSS failed\",\n          \"environmentLabel\": null,\n          \"label\": \"Build Error\",\n          \"source\": \"./index.module.css\n-       Parsing css source code failed\n+       Transforming CSS failed\n        Selector \"button\" is not pure. Pure selectors must contain at least one local class or id.\n        Import traces:\n          Client Component Browser:"
        },
        {
            "sha": "fb75d0c2d0b3dab671cbe45984af9374ef7b8e19",
            "filename": "test/development/acceptance/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts?ref=5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d",
            "patch": "@@ -578,13 +578,13 @@ describe('ReactRefreshLogBox', () => {\n     if (isTurbopack) {\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"description\": \"Parsing css source code failed\",\n+         \"description\": \"Parsing CSS source code failed\",\n          \"environmentLabel\": null,\n          \"label\": \"Build Error\",\n-         \"source\": \"./index.module.css (1:9)\n-       Parsing css source code failed\n+         \"source\": \"./index.module.css (1:8)\n+       Parsing CSS source code failed\n        > 1 | .button\n-           |         ^\",\n+           |        ^\",\n          \"stack\": [],\n        }\n       `)\n@@ -610,11 +610,11 @@ describe('ReactRefreshLogBox', () => {\n     if (isTurbopack) {\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"description\": \"Parsing css source code failed\",\n+         \"description\": \"Transforming CSS failed\",\n          \"environmentLabel\": null,\n          \"label\": \"Build Error\",\n          \"source\": \"./index.module.css\n-       Parsing css source code failed\n+       Transforming CSS failed\n        Selector \"button\" is not pure. Pure selectors must contain at least one local class or id.\n        Import traces:\n          Browser:"
        },
        {
            "sha": "f75e8f4d37422c9b081a59c7dcb5920b9179062a",
            "filename": "test/development/sass-error/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d/test%2Fdevelopment%2Fsass-error%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d/test%2Fdevelopment%2Fsass-error%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fsass-error%2Findex.test.ts?ref=5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d",
            "patch": "@@ -27,7 +27,7 @@ describe('app dir - css', () => {\n           // css-loader does not report an error for this case\n           expect(source).toMatchInlineSnapshot(`\n            \"./app/global.scss.css (45:1)\n-           Parsing css source code failed\n+           Parsing CSS source code failed\n              43 | }\n              44 |\n            > 45 | input.defaultCheckbox::before path {\n@@ -36,7 +36,7 @@ describe('app dir - css', () => {\n              47 | }\n              48 |\n \n-           Pseudo-elements like '::before' or '::after' can't be followed by selectors like 'Ident(\"path\")' at [project]/app/global.scss.css:0:884\n+           Pseudo-elements like '::before' or '::after' can't be followed by selectors like 'Ident(\"path\")'\n \n            Import trace:\n              Client Component Browser:"
        },
        {
            "sha": "4b83a6092bcd63fcf69a59a89f6580483ff137d5",
            "filename": "turbopack/crates/turbopack-core/src/issue/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs?ref=5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d",
            "patch": "@@ -767,8 +767,8 @@ async fn into_plain_trace(traces: Vec<Vec<ReadRef<AssetIdent>>>) -> Result<Vec<P\n     Ok(plain_traces)\n }\n \n-#[turbo_tasks::value(shared, serialization = \"none\")]\n-#[derive(Clone, Debug, PartialOrd, Ord, DeterministicHash, Serialize)]\n+#[turbo_tasks::value(shared)]\n+#[derive(Clone, Debug, PartialOrd, Ord, DeterministicHash)]\n pub enum IssueStage {\n     Config,\n     AppStructure,"
        },
        {
            "sha": "4c4c8cd60716b0b9ce17f2c038c4a52ced37ca9a",
            "filename": "turbopack/crates/turbopack-css/src/process.rs",
            "status": "modified",
            "additions": 39,
            "deletions": 13,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs?ref=5bbd5ddf82e6c917b98c72a1632a7d2fffdf562d",
            "patch": "@@ -1,6 +1,6 @@\n use std::sync::{Arc, RwLock};\n \n-use anyhow::{Context, Result, bail};\n+use anyhow::{Result, bail};\n use lightningcss::{\n     css_modules::{CssModuleExport, CssModuleExports, Pattern, Segment},\n     stylesheet::{MinifyOptions, ParserOptions, PrinterOptions, StyleSheet, ToCssResult},\n@@ -466,8 +466,8 @@ async fn process_content(\n \n                 // We need to collect here because we need to avoid holding the lock while calling\n                 // `.await` in the loop.\n-                let warngins = warnings.read().unwrap().iter().cloned().collect::<Vec<_>>();\n-                for err in warngins.iter() {\n+                let warnings = warnings.read().unwrap().iter().cloned().collect::<Vec<_>>();\n+                for err in warnings.iter() {\n                     match err.kind {\n                         lightningcss::error::ParserError::UnexpectedToken(_)\n                         | lightningcss::error::ParserError::UnexpectedImportRule\n@@ -477,15 +477,16 @@ async fn process_content(\n                                 Some(loc) => {\n                                     let pos = SourcePos {\n                                         line: loc.line as _,\n-                                        column: loc.column as _,\n+                                        column: (loc.column - 1) as _,\n                                     };\n                                     IssueSource::from_line_col(source, pos, pos)\n                                 }\n                                 None => IssueSource::from_source_only(source),\n                             };\n \n                             ParsingIssue {\n-                                msg: err.to_string().into(),\n+                                msg: err.kind.to_string().into(),\n+                                stage: IssueStage::Parse,\n                                 source,\n                             }\n                             .resolved_cell()\n@@ -506,13 +507,30 @@ async fn process_content(\n                 // minify() is actually transform, and it performs operations like CSS modules\n                 // handling.\n                 //\n-                //\n                 // See: https://github.com/parcel-bundler/lightningcss/issues/935#issuecomment-2739325537\n-                ss.minify(MinifyOptions {\n+                if let Err(e) = ss.minify(MinifyOptions {\n                     targets,\n                     ..Default::default()\n-                })\n-                .context(\"failed to transform css\")?;\n+                }) {\n+                    let source = match &e.loc {\n+                        Some(loc) => {\n+                            let pos = SourcePos {\n+                                line: loc.line as _,\n+                                column: (loc.column - 1) as _,\n+                            };\n+                            IssueSource::from_line_col(source, pos, pos)\n+                        }\n+                        None => IssueSource::from_source_only(source),\n+                    };\n+                    ParsingIssue {\n+                        msg: e.kind.to_string().into(),\n+                        stage: IssueStage::Transform,\n+                        source,\n+                    }\n+                    .resolved_cell()\n+                    .emit();\n+                    return Ok(ParseCssResult::Unparsable.cell());\n+                }\n \n                 stylesheet_into_static(&ss, without_warnings(config.clone()))\n             }\n@@ -521,14 +539,15 @@ async fn process_content(\n                     Some(loc) => {\n                         let pos = SourcePos {\n                             line: loc.line as _,\n-                            column: loc.column as _,\n+                            column: (loc.column - 1) as _,\n                         };\n                         IssueSource::from_line_col(source, pos, pos)\n                     }\n                     None => IssueSource::from_source_only(source),\n                 };\n                 ParsingIssue {\n-                    msg: e.to_string().into(),\n+                    msg: e.kind.to_string().into(),\n+                    stage: IssueStage::Parse,\n                     source,\n                 }\n                 .resolved_cell()\n@@ -581,6 +600,7 @@ impl CssError {\n                          least one local class or id.\"\n                     )\n                     .into(),\n+                    stage: IssueStage::Transform,\n                     // TODO: This should include the location of the selector in the file.\n                     source: IssueSource::from_source_only(source),\n                 }\n@@ -680,6 +700,7 @@ fn generate_css_source_map(source_map: &parcel_sourcemap::SourceMap) -> Result<R\n #[turbo_tasks::value]\n struct ParsingIssue {\n     msg: RcStr,\n+    stage: IssueStage,\n     source: IssueSource,\n }\n \n@@ -692,12 +713,17 @@ impl Issue for ParsingIssue {\n \n     #[turbo_tasks::function]\n     fn stage(&self) -> Vc<IssueStage> {\n-        IssueStage::Parse.cell()\n+        self.stage.clone().cell()\n     }\n \n     #[turbo_tasks::function]\n     fn title(&self) -> Vc<StyledString> {\n-        StyledString::Text(rcstr!(\"Parsing css source code failed\")).cell()\n+        StyledString::Text(match self.stage {\n+            IssueStage::Parse => rcstr!(\"Parsing CSS source code failed\"),\n+            IssueStage::Transform => rcstr!(\"Transforming CSS failed\"),\n+            _ => rcstr!(\"CSS processing failed\"),\n+        })\n+        .cell()\n     }\n \n     #[turbo_tasks::function]"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 55,
        "deletions": 29
    }
}