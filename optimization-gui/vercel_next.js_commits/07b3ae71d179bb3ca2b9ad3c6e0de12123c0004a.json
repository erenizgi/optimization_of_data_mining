{
    "author": "bgw",
    "message": "chore: Attempt to fix ppr-partial-hydration flakiness (#84672)\n\nWrite to a marker file to determine when the slow server component finishes rendering instead of trying to sleep for some fixed amount of time.",
    "sha": "07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a",
    "files": [
        {
            "sha": "b141ad79f5d085aabd671fa78bf67f0d95a8d1e5",
            "filename": "test/e2e/app-dir/ppr-partial-hydration/app/with-shell/with-streaming-metadata/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwith-shell%2Fwith-streaming-metadata%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwith-shell%2Fwith-streaming-metadata%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwith-shell%2Fwith-streaming-metadata%2Fpage.tsx?ref=07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a",
            "patch": "@@ -1,7 +1,7 @@\n import { Suspense } from 'react'\n import { connection } from 'next/server'\n-import { setTimeout } from 'timers/promises'\n import { HydrationIndicator } from '../../hydration-indicator'\n+import waitForMarkerFile from '../../../waitForMarkerFile'\n import type { Metadata } from 'next'\n \n export async function generateMetadata(): Promise<Metadata> {\n@@ -20,16 +20,16 @@ export default function Page() {\n         <HydrationIndicator id=\"shell-hydrated\" />\n         <hr />\n         <Suspense fallback={<div id=\"dynamic-fallback\">Loading...</div>}>\n-          <SlowServerComponent delay={500} />\n+          <SlowServerComponent />\n         </Suspense>\n       </div>\n     </main>\n   )\n }\n \n-async function SlowServerComponent({ delay }: { delay: number }) {\n+async function SlowServerComponent() {\n   await connection()\n-  await setTimeout(delay)\n+  await waitForMarkerFile()\n   const randomValue = Math.floor(Math.random() * 1000)\n   return (\n     <div id=\"dynamic\">"
        },
        {
            "sha": "29ad7b94f7494ae54b5116ccfa10f71f9a71901d",
            "filename": "test/e2e/app-dir/ppr-partial-hydration/app/with-shell/without-metadata/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwith-shell%2Fwithout-metadata%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwith-shell%2Fwithout-metadata%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwith-shell%2Fwithout-metadata%2Fpage.tsx?ref=07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a",
            "patch": "@@ -1,7 +1,7 @@\n import { Suspense } from 'react'\n import { connection } from 'next/server'\n-import { setTimeout } from 'timers/promises'\n import { HydrationIndicator } from '../../hydration-indicator'\n+import waitForMarkerFile from '../../../waitForMarkerFile'\n \n export default function Page() {\n   return (\n@@ -12,16 +12,16 @@ export default function Page() {\n         <HydrationIndicator id=\"shell-hydrated\" />\n         <hr />\n         <Suspense fallback={<div id=\"dynamic-fallback\">Loading...</div>}>\n-          <SlowServerComponent delay={500} />\n+          <SlowServerComponent />\n         </Suspense>\n       </div>\n     </main>\n   )\n }\n \n-async function SlowServerComponent({ delay }: { delay: number }) {\n+async function SlowServerComponent() {\n   await connection()\n-  await setTimeout(delay)\n+  await waitForMarkerFile()\n   const randomValue = Math.floor(Math.random() * 1000)\n   return (\n     <div id=\"dynamic\">"
        },
        {
            "sha": "2a8bde4878cabb23fba0ac2fdb3e1a9a80b4e44b",
            "filename": "test/e2e/app-dir/ppr-partial-hydration/app/without-shell/with-streaming-metadata/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwithout-shell%2Fwith-streaming-metadata%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwithout-shell%2Fwith-streaming-metadata%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwithout-shell%2Fwith-streaming-metadata%2Fpage.tsx?ref=07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a",
            "patch": "@@ -1,7 +1,7 @@\n import { Suspense } from 'react'\n import { connection } from 'next/server'\n-import { setTimeout } from 'timers/promises'\n import { HydrationIndicator } from '../../hydration-indicator'\n+import waitForMarkerFile from '../../../waitForMarkerFile'\n import type { Metadata } from 'next'\n \n export async function generateMetadata(): Promise<Metadata> {\n@@ -23,16 +23,16 @@ export default async function Page() {\n         <HydrationIndicator id=\"shell-hydrated\" />\n         <hr />\n         <Suspense fallback={<div id=\"dynamic-fallback\">Loading...</div>}>\n-          <SlowServerComponent delay={500} />\n+          <SlowServerComponent />\n         </Suspense>\n       </div>\n     </main>\n   )\n }\n \n-async function SlowServerComponent({ delay }: { delay: number }) {\n+async function SlowServerComponent() {\n   await connection()\n-  await setTimeout(delay)\n+  await waitForMarkerFile()\n   const randomValue = Math.floor(Math.random() * 1000)\n   return (\n     <div id=\"dynamic\">"
        },
        {
            "sha": "0e89f399f6994204b585f3d7e33ffda8a284ae78",
            "filename": "test/e2e/app-dir/ppr-partial-hydration/app/without-shell/without-metadata/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwithout-shell%2Fwithout-metadata%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwithout-shell%2Fwithout-metadata%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fapp%2Fwithout-shell%2Fwithout-metadata%2Fpage.tsx?ref=07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a",
            "patch": "@@ -1,7 +1,7 @@\n import { Suspense } from 'react'\n import { connection } from 'next/server'\n-import { setTimeout } from 'timers/promises'\n import { HydrationIndicator } from '../../hydration-indicator'\n+import waitForMarkerFile from '../../../waitForMarkerFile'\n \n export default async function Page() {\n   // Trigger the Suspense-around-body in the root layout so that no static shell is produced\n@@ -15,16 +15,16 @@ export default async function Page() {\n         <HydrationIndicator id=\"shell-hydrated\" />\n         <hr />\n         <Suspense fallback={<div id=\"dynamic-fallback\">Loading...</div>}>\n-          <SlowServerComponent delay={500} />\n+          <SlowServerComponent />\n         </Suspense>\n       </div>\n     </main>\n   )\n }\n \n-async function SlowServerComponent({ delay }: { delay: number }) {\n+async function SlowServerComponent() {\n   await connection()\n-  await setTimeout(delay)\n+  await waitForMarkerFile()\n   const randomValue = Math.floor(Math.random() * 1000)\n   return (\n     <div id=\"dynamic\">"
        },
        {
            "sha": "d35ea983b8b6050c316d5735f82d36f8a3286a4f",
            "filename": "test/e2e/app-dir/ppr-partial-hydration/ppr-partial-hydration.test.ts",
            "status": "modified",
            "additions": 69,
            "deletions": 45,
            "changes": 114,
            "blob_url": "https://github.com/vercel/next.js/blob/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fppr-partial-hydration.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fppr-partial-hydration.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2Fppr-partial-hydration.test.ts?ref=07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a",
            "patch": "@@ -8,9 +8,15 @@ import { nextTestSetup } from 'e2e-utils'\n import { retry } from 'next-test-utils'\n \n describe('PPR - partial hydration', () => {\n-  const { next, isNextDev } = nextTestSetup({ files: __dirname })\n-  if (isNextDev) {\n-    it.skip('only testable in production', () => {})\n+  const { next, isNextDev, skipped } = nextTestSetup({\n+    files: __dirname,\n+    // the file-patching strategy we use for synchronizing the test doesn't work\n+    // on deployments\n+    skipDeployment: true,\n+  })\n+\n+  if (isNextDev || skipped) {\n+    it.skip('only testable in production (non-deployment)', () => {})\n     return\n   }\n \n@@ -60,28 +66,35 @@ describe('PPR - partial hydration', () => {\n             await browser.elementByCssInstant('#dynamic-fallback').text()\n           ).toContain('Loading...')\n         },\n-        1000,\n-        50\n+        // This can take a while? It's unclear why... The delay appears pretty\n+        // random.\n+        /* duration */ 15_000 // ms\n       )\n \n-      // Then, the slow content should stream in and hydrate\n-      await retry(async () => {\n-        // The shell is already hydrated, this shouldn't change\n-        expect(\n-          await browser\n-            .elementByCssInstant('#shell-hydrated')\n-            .getAttribute('data-is-hydrated')\n-        ).toBe('true')\n+      // Then, the slow content should stream in and hydrate (once\n+      // `slowComponentReady` is written)\n+      await next.patchFile('slowComponentReady', 'marker file', async () => {\n+        await retry(\n+          async () => {\n+            // The shell is already hydrated, this shouldn't change\n+            expect(\n+              await browser\n+                .elementByCssInstant('#shell-hydrated')\n+                .getAttribute('data-is-hydrated')\n+            ).toBe('true')\n \n-        // The dynamic content should be visible and hydrated\n-        expect(await browser.elementByCssInstant('#dynamic').text()).toMatch(\n-          /Random value: \\d+/\n+            // The dynamic content should be visible and hydrated\n+            expect(\n+              await browser.elementByCssInstant('#dynamic').text()\n+            ).toMatch(/Random value: \\d+/)\n+            expect(\n+              await browser\n+                .elementByCssInstant('#dynamic-hydrated')\n+                .getAttribute('data-is-hydrated')\n+            ).toBe('true')\n+          },\n+          /* duration */ 10_000 // ms\n         )\n-        expect(\n-          await browser\n-            .elementByCssInstant('#dynamic-hydrated')\n-            .getAttribute('data-is-hydrated')\n-        ).toBe('true')\n       })\n \n       // If the HTML and RSC streams were interleaved correctly, we shouldn't be in quirks mode\n@@ -96,36 +109,47 @@ describe('PPR - partial hydration', () => {\n       // In particular, RSC script tags should never appear before the initial HTML\n       // (which could happen if we e.g. have no static shell and don't wait for it to be rendered before sending them)\n       const response = await next.fetch(path)\n-      expect(response.status).toBe(200)\n-      const text = await response\n-        .text()\n+      let body = ''\n+      response.body.on('data', (chunk) => {\n+        body += chunk.toString('utf-8')\n+      })\n+      await retry(() => {\n+        expect(response.status).toBe(200)\n         // Ignore the sentinel. For pages with no static shell, it ends up at the front\n         // and messes up the assertion.\n-        .then((s) => s.replace('<!-- PPR_BOUNDARY_SENTINEL -->', ''))\n-\n-      expect(text).toStartWith('<!DOCTYPE html>')\n-      expect(text).toEndWith('</body></html>')\n+        const trimmed = body.replace('<!-- PPR_BOUNDARY_SENTINEL -->', '')\n+        expect(trimmed).toStartWith('<!DOCTYPE html>')\n+      })\n+      await next.patchFile('slowComponentReady', 'marker file', async () => {\n+        await retry(() => {\n+          expect(body).toEndWith('</body></html>')\n+        })\n+      })\n     })\n \n     it('should display the shell without JS', async () => {\n-      const browser = await next.browser(path, {\n-        disableJavaScript: true,\n-        waitUntil: 'load', // Unlike the previous test, we want the page to load fully\n-      })\n-      expect(await browser.elementByCss('#shell').text()).toContain(\n-        'This is a page'\n-      )\n-      expect(\n-        await browser\n-          .elementByCss('#shell-hydrated')\n-          .getAttribute('data-is-hydrated')\n-      ).toBe('false')\n+      // patch the marker file right away so that `load` finishes quickly\n+      await next.patchFile('slowComponentReady', 'marker file', async () => {\n+        const browser = await next.browser(path, {\n+          disableJavaScript: true,\n+          waitUntil: 'load', // Unlike the previous test, we want the page to load fully\n+        })\n \n-      // The dynamic content can't be inserted into the document because we disabled JS,\n-      // so we should only see the fallback\n-      expect(await browser.elementByCss('#dynamic-fallback').text()).toContain(\n-        'Loading...'\n-      )\n+        expect(await browser.elementByCss('#shell').text()).toContain(\n+          'This is a page'\n+        )\n+        expect(\n+          await browser\n+            .elementByCss('#shell-hydrated')\n+            .getAttribute('data-is-hydrated')\n+        ).toBe('false')\n+\n+        // The dynamic content can't be inserted into the document because we disabled JS,\n+        // so we should only see the fallback\n+        expect(\n+          await browser.elementByCss('#dynamic-fallback').text()\n+        ).toContain('Loading...')\n+      })\n     })\n   })\n })"
        },
        {
            "sha": "eeaa28edef796cf0e2443d7c303b49b4be47d60c",
            "filename": "test/e2e/app-dir/ppr-partial-hydration/waitForMarkerFile.ts",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2FwaitForMarkerFile.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2FwaitForMarkerFile.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-partial-hydration%2FwaitForMarkerFile.ts?ref=07b3ae71d179bb3ca2b9ad3c6e0de12123c0004a",
            "patch": "@@ -0,0 +1,20 @@\n+import { setTimeout } from 'node:timers/promises'\n+import { access } from 'node:fs/promises'\n+import path from 'node:path'\n+import React from 'react'\n+\n+export default async function waitForMarkerFile() {\n+  const signal = React.cacheSignal()\n+  if (!signal) {\n+    throw new Error('cacheSignal returned null, are we not rendering?')\n+  }\n+  while (true) {\n+    try {\n+      await access(path.join(process.cwd(), 'slowComponentReady'))\n+      return\n+    } catch (e) {\n+      await setTimeout(100, { signal })\n+      continue\n+    }\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 166,
        "additions": 105,
        "deletions": 61
    }
}