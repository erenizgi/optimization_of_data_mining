{
    "author": "eps1lon",
    "message": "Don't invalidate hot reloader excessively during dev server boot (#85732)\n\nSuspecting that this fixes (or reduces) the \"Watchpack Error (watcher):\nError: EMFILE:\" issues e.g.\nhttps://github.com/vercel/next.js/actions/runs/19028750529/job/54337767548?pr=85637\n\nI noticed that all the Watchpack errors in CI happened in tests with a\ntsconfig (or ones where a tsconfig was created). When watchpack starts\nwatching, an initial `aggregated` event is set. During that event we\nused to consider all files as changed because we hadn't seen them\nbefore. This also meant we considered the tsconfig as changed and\ninvalidated the hot-reloader.\n\nThis is excessive and likely hits some hard to debug race conditions.\nNow we check if the file was actually changed since we started watching\nby comparing its change time to the time when we started watching. Each\nfile modified before we started watching is no longer considered\nchanged.",
    "sha": "5f9e5f0e70651542cddb027a5ad00aa241a7d788",
    "files": [
        {
            "sha": "4395c844d92b8e1d9c7d3e54e7b174ddab95b2e0",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/5f9e5f0e70651542cddb027a5ad00aa241a7d788/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5f9e5f0e70651542cddb027a5ad00aa241a7d788/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=5f9e5f0e70651542cddb027a5ad00aa241a7d788",
            "patch": "@@ -371,6 +371,7 @@ async function startWatcher(\n     const routeTypesFilePath = path.join(distDir, 'types', 'routes.d.ts')\n     const validatorFilePath = path.join(distDir, 'types', 'validator.ts')\n \n+    let initialWatchTime = performance.now() + performance.timeOrigin\n     wp.on('aggregated', async () => {\n       let writeEnvDefinitions = false\n       let typescriptStatusFromLastAggregation = enabledTypeScript\n@@ -445,14 +446,21 @@ async function startWatcher(\n         const meta = knownFiles.get(fileName)\n \n         const watchTime = fileWatchTimes.get(fileName)\n+        const nextWatchTime = meta?.timestamp\n         // If the file is showing up for the first time or the meta.timestamp is changed since last time\n-        const watchTimeChange =\n-          watchTime === undefined ||\n-          (watchTime && watchTime !== meta?.timestamp)\n-        fileWatchTimes.set(fileName, meta?.timestamp)\n+        // Files that were created before we started watching are not considered changed.\n+        // If any file was created by Next.js while booting, we assume those changes\n+        // are handled in the bootstrap phase.\n+        // Files that existed before we booted should be handled during bootstrapping.\n+        const fileChanged =\n+          (watchTime === undefined &&\n+            (nextWatchTime === undefined ||\n+              nextWatchTime >= initialWatchTime)) ||\n+          (watchTime && watchTime !== nextWatchTime)\n+        fileWatchTimes.set(fileName, nextWatchTime)\n \n         if (envFiles.includes(fileName)) {\n-          if (watchTimeChange) {\n+          if (fileChanged) {\n             envChange = true\n           }\n           continue\n@@ -462,7 +470,7 @@ async function startWatcher(\n           if (fileName.endsWith('tsconfig.json')) {\n             enabledTypeScript = true\n           }\n-          if (watchTimeChange) {\n+          if (fileChanged) {\n             tsconfigChange = true\n           }\n           continue"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 14,
        "deletions": 6
    }
}