{
    "author": "sokra",
    "message": "Turbopack: count turbo_tasks::run as foreground tasks to avoid being idle (#84245)\n\n### What?\n\nWe need to count `turbo_tasks::run` as foreground task otherwise persistent caching thinks we are idle and starts persisting too early.",
    "sha": "0774abdeb94ed8fc2e5baa0454816ed8ebc9a76f",
    "files": [
        {
            "sha": "1620396ca9c81a39b53c524d3dbc37bb64e41b02",
            "filename": "turbopack/crates/turbo-tasks/src/manager.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0774abdeb94ed8fc2e5baa0454816ed8ebc9a76f/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0774abdeb94ed8fc2e5baa0454816ed8ebc9a76f/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs?ref=0774abdeb94ed8fc2e5baa0454816ed8ebc9a76f",
            "patch": "@@ -539,12 +539,13 @@ impl<B: Backend + 'static> TurboTasks<B> {\n         &self,\n         future: impl Future<Output = Result<T>> + Send + 'static,\n     ) -> Result<T, TurboTasksExecutionError> {\n+        self.begin_foreground_job();\n         // it's okay for execution ids to overflow and wrap, they're just used for an assert\n         let execution_id = self.execution_id_factory.wrapping_get();\n         let current_task_state =\n             Arc::new(RwLock::new(CurrentTaskState::new_temporary(execution_id)));\n \n-        TURBO_TASKS\n+        let result = TURBO_TASKS\n             .scope(\n                 self.pin(),\n                 CURRENT_TASK_STATE.scope(current_task_state, async {\n@@ -563,7 +564,9 @@ impl<B: Backend + 'static> TurboTasks<B> {\n                     }\n                 }),\n             )\n-            .await\n+            .await;\n+        self.finish_foreground_job();\n+        result\n     }\n \n     pub fn start_once_process(&self, future: impl Future<Output = ()> + Send + 'static) {"
        }
    ],
    "stats": {
        "total": 7,
        "additions": 5,
        "deletions": 2
    }
}