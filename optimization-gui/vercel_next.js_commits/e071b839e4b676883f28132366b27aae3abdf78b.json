{
    "author": "ztanner",
    "message": "[dev-overlay]: wire up ISR status for pages router (#76458)\n\nThe static indicator was added in the new dev overlay but wasn't hooked up to pages router. This wires that up so they're properly marked static/dynamic. \r\n\r\nCloses NDX-897",
    "sha": "e071b839e4b676883f28132366b27aae3abdf78b",
    "files": [
        {
            "sha": "b52a80fd52d82f13eb0f6f332bfdec8eaf697145",
            "filename": "packages/next/src/client/components/react-dev-overlay/pages/client.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e071b839e4b676883f28132366b27aae3abdf78b/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e071b839e4b676883f28132366b27aae3abdf78b/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts?ref=e071b839e4b676883f28132366b27aae3abdf78b",
            "patch": "@@ -10,6 +10,7 @@ import {\n   ACTION_BUILD_ERROR,\n   ACTION_BUILD_OK,\n   ACTION_REFRESH,\n+  ACTION_STATIC_INDICATOR,\n   ACTION_UNHANDLED_ERROR,\n   ACTION_UNHANDLED_REJECTION,\n   ACTION_VERSION_INFO,\n@@ -138,5 +139,9 @@ export function onVersionInfo(versionInfo: VersionInfo) {\n   Bus.emit({ type: ACTION_VERSION_INFO, versionInfo })\n }\n \n+export function onStaticIndicator(isStatic: boolean) {\n+  Bus.emit({ type: ACTION_STATIC_INDICATOR, staticIndicator: isStatic })\n+}\n+\n export { getErrorByType } from '../utils/get-error-by-type'\n export { getServerError } from '../utils/node-stack-frames'"
        },
        {
            "sha": "072179a45d80e7758d2bfe96f7533aee64941c57",
            "filename": "packages/next/src/client/components/react-dev-overlay/pages/hooks.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e071b839e4b676883f28132366b27aae3abdf78b/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhooks.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e071b839e4b676883f28132366b27aae3abdf78b/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhooks.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhooks.ts?ref=e071b839e4b676883f28132366b27aae3abdf78b",
            "patch": "@@ -1,13 +1,21 @@\n import React from 'react'\n import * as Bus from './bus'\n import { useErrorOverlayReducer } from '../shared'\n+import { Router } from '../../../router'\n \n export const usePagesDevOverlay = () => {\n   const [state, dispatch] = useErrorOverlayReducer()\n \n   React.useEffect(() => {\n     Bus.on(dispatch)\n+\n+    const { handleStaticIndicator } =\n+      require('./hot-reloader-client') as typeof import('./hot-reloader-client')\n+\n+    Router.events.on('routeChangeComplete', handleStaticIndicator)\n+\n     return function () {\n+      Router.events.off('routeChangeComplete', handleStaticIndicator)\n       Bus.off(dispatch)\n     }\n   }, [dispatch])"
        },
        {
            "sha": "ee763c8b7218b4ce1a4383170686612403fa9cec",
            "filename": "packages/next/src/client/components/react-dev-overlay/pages/hot-reloader-client.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/e071b839e4b676883f28132366b27aae3abdf78b/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e071b839e4b676883f28132366b27aae3abdf78b/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts?ref=e071b839e4b676883f28132366b27aae3abdf78b",
            "patch": "@@ -35,6 +35,7 @@ import {\n   onBeforeRefresh,\n   onRefresh,\n   onVersionInfo,\n+  onStaticIndicator,\n } from './client'\n import stripAnsi from 'next/dist/compiled/strip-ansi'\n import { addMessageListener, sendMessage } from './websocket'\n@@ -218,6 +219,7 @@ function handleErrors(errors: any) {\n let startLatency: number | null = null\n let turbopackLastUpdateLatency: number | null = null\n let turbopackUpdatedModules: Set<string> = new Set()\n+let isrManifest: Record<string, boolean> = {}\n \n function onBeforeFastRefresh(updatedModules: string[]) {\n   if (updatedModules.length > 0) {\n@@ -269,6 +271,25 @@ function handleAvailableHash(hash: string) {\n   mostRecentCompilationHash = hash\n }\n \n+export function handleStaticIndicator() {\n+  if (process.env.__NEXT_DEV_INDICATOR) {\n+    const routeInfo = window.next.router.components[window.next.router.pathname]\n+    const pageComponent = routeInfo?.Component\n+    const appComponent = window.next.router.components['/_app']?.Component\n+    const isDynamicPage =\n+      Boolean(pageComponent?.getInitialProps) || Boolean(routeInfo.__N_SSP)\n+    const hasAppGetInitialProps =\n+      Boolean(appComponent?.getInitialProps) &&\n+      appComponent?.getInitialProps !== appComponent?.origGetInitialProps\n+\n+    const isPageStatic =\n+      window.location.pathname in isrManifest ||\n+      (!isDynamicPage && !hasAppGetInitialProps)\n+\n+    onStaticIndicator(isPageStatic)\n+  }\n+}\n+\n /** Handles messages from the sevrer for the Pages Router. */\n function processMessage(obj: HMR_ACTION_TYPES) {\n   if (!('action' in obj)) {\n@@ -277,6 +298,11 @@ function processMessage(obj: HMR_ACTION_TYPES) {\n \n   // Use turbopack message for analytics, (still need built for webpack)\n   switch (obj.action) {\n+    case HMR_ACTIONS_SENT_TO_BROWSER.ISR_MANIFEST: {\n+      isrManifest = obj.data\n+      handleStaticIndicator()\n+      break\n+    }\n     case HMR_ACTIONS_SENT_TO_BROWSER.BUILDING: {\n       startLatency = Date.now()\n       turbopackLastUpdateLatency = null"
        },
        {
            "sha": "c7a458496c0549d68e8dbd70d74d9bedf21881a6",
            "filename": "packages/next/src/server/render.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e071b839e4b676883f28132366b27aae3abdf78b/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e071b839e4b676883f28132366b27aae3abdf78b/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx?ref=e071b839e4b676883f28132366b27aae3abdf78b",
            "patch": "@@ -257,6 +257,7 @@ export type RenderOptsPartial = {\n   assetQueryString?: string\n   resolvedUrl?: string\n   resolvedAsPath?: string\n+  setIsrStatus?: (key: string, value: boolean | null) => void\n   clientReferenceManifest?: DeepReadonly<ClientReferenceManifest>\n   nextFontManifest?: DeepReadonly<NextFontManifest>\n   distDir?: string\n@@ -653,6 +654,10 @@ export async function renderToHTMLImpl(\n         `\\`pages${pathname}\\` ${STATIC_STATUS_PAGE_GET_INITIAL_PROPS_ERROR}`\n       )\n     }\n+\n+    if (renderOpts?.setIsrStatus) {\n+      renderOpts.setIsrStatus(asPath, isSSG || isAutoExport ? true : null)\n+    }\n   }\n \n   for (const methodName of ["
        },
        {
            "sha": "f4685e22c6c600eba43338ef846c5235b4177639",
            "filename": "test/development/app-dir/dev-indicator/route-type.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fapp-dir%2Fdev-indicator%2Froute-type.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fapp-dir%2Fdev-indicator%2Froute-type.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdev-indicator%2Froute-type.test.ts?ref=e071b839e4b676883f28132366b27aae3abdf78b",
            "patch": "@@ -1,7 +1,7 @@\n import { nextTestSetup } from 'e2e-utils'\n import { getRouteTypeFromDevToolsIndicator, retry } from 'next-test-utils'\n \n-describe('dev indicator - route type', () => {\n+describe('app dir dev indicator - route type', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,\n   })"
        },
        {
            "sha": "60c9a85befea22854ea2c044787f0dd67c48249f",
            "filename": "test/development/dev-indicator/dev-indicator.test.ts",
            "status": "added",
            "additions": 118,
            "deletions": 0,
            "changes": 118,
            "blob_url": "https://github.com/vercel/next.js/blob/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fdev-indicator%2Fdev-indicator.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fdev-indicator%2Fdev-indicator.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-indicator%2Fdev-indicator.test.ts?ref=e071b839e4b676883f28132366b27aae3abdf78b",
            "patch": "@@ -0,0 +1,118 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { getRouteTypeFromDevToolsIndicator, retry } from 'next-test-utils'\n+\n+describe('dev indicator - route type', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  describe('getServerSideProps', () => {\n+    it('should update when going from dynamic -> static', async () => {\n+      const browser = await next.browser('/gssp')\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Dynamic')\n+      })\n+\n+      // validate static -> dynamic updates\n+      await browser.elementByCss(\"[href='/']\").click()\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Static')\n+      })\n+    })\n+\n+    it('should update when going from static -> dynamic', async () => {\n+      const browser = await next.browser('/')\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Static')\n+      })\n+\n+      // validate static -> dynamic updates\n+      await browser.elementByCss(\"[href='/gssp']\").click()\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Dynamic')\n+      })\n+    })\n+\n+    it('should be marked dynamic on first load', async () => {\n+      const browser = await next.browser('/gssp')\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Dynamic')\n+      })\n+    })\n+  })\n+\n+  describe('getInitialProps', () => {\n+    it('should be marked dynamic on first load', async () => {\n+      const browser = await next.browser('/gip')\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Dynamic')\n+      })\n+    })\n+\n+    it('should update when going from dynamic -> static', async () => {\n+      const browser = await next.browser('/gip')\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Dynamic')\n+      })\n+\n+      await browser.elementByCss(\"[href='/']\").click()\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Static')\n+      })\n+    })\n+\n+    it('should update when going from static -> dynamic', async () => {\n+      const browser = await next.browser('/')\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Static')\n+      })\n+\n+      await browser.elementByCss(\"[href='/gip']\").click()\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Dynamic')\n+      })\n+    })\n+  })\n+\n+  describe('getStaticPaths', () => {\n+    it('should be marked static on first load', async () => {\n+      const browser = await next.browser('/pregenerated')\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Static')\n+      })\n+    })\n+\n+    it('should update when going from dynamic -> static', async () => {\n+      const browser = await next.browser('/gssp')\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Dynamic')\n+      })\n+\n+      await browser.elementByCss(\"[href='/pregenerated']\").click()\n+\n+      await retry(async () => {\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Static')\n+      })\n+    })\n+  })\n+\n+  it('should have route type as static by default for static page', async () => {\n+    const browser = await next.browser('/')\n+\n+    await retry(async () => {\n+      expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Static')\n+    })\n+  })\n+})"
        },
        {
            "sha": "d6c5fa700a74246f13dd934bdd5b28f5d65a02f5",
            "filename": "test/development/dev-indicator/pages/[slug]/index.tsx",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fdev-indicator%2Fpages%2F%5Bslug%5D%2Findex.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fdev-indicator%2Fpages%2F%5Bslug%5D%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-indicator%2Fpages%2F%5Bslug%5D%2Findex.tsx?ref=e071b839e4b676883f28132366b27aae3abdf78b",
            "patch": "@@ -0,0 +1,35 @@\n+import Link from 'next/link'\n+\n+export default function Page({ slug }: { slug: string }) {\n+  return (\n+    <p>\n+      hello world {slug} <Link href=\"/gssp\">to /gssp</Link>\n+      <Link href=\"/\">to /</Link>\n+    </p>\n+  )\n+}\n+\n+export const getStaticPaths = async () => {\n+  return {\n+    paths: [\n+      {\n+        params: {\n+          slug: 'pregenerated',\n+        },\n+      },\n+    ],\n+    fallback: true,\n+  }\n+}\n+\n+export const getStaticProps = async ({\n+  params,\n+}: {\n+  params: { slug: string }\n+}) => {\n+  return {\n+    props: {\n+      slug: params.slug,\n+    },\n+  }\n+}"
        },
        {
            "sha": "3d85c0d860c9d2150382199a86bf2ffe9b014c4e",
            "filename": "test/development/dev-indicator/pages/gip.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fdev-indicator%2Fpages%2Fgip.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fdev-indicator%2Fpages%2Fgip.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-indicator%2Fpages%2Fgip.tsx?ref=e071b839e4b676883f28132366b27aae3abdf78b",
            "patch": "@@ -0,0 +1,15 @@\n+import Link from 'next/link'\n+\n+export default function Page() {\n+  return (\n+    <p>\n+      hello world <Link href=\"/\">to /</Link>\n+    </p>\n+  )\n+}\n+\n+Page.getInitialProps = async () => {\n+  return {\n+    static: false,\n+  }\n+}"
        },
        {
            "sha": "20de16ace781f2f38f08b937d76e2a957c740625",
            "filename": "test/development/dev-indicator/pages/gssp.tsx",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fdev-indicator%2Fpages%2Fgssp.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fdev-indicator%2Fpages%2Fgssp.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-indicator%2Fpages%2Fgssp.tsx?ref=e071b839e4b676883f28132366b27aae3abdf78b",
            "patch": "@@ -0,0 +1,18 @@\n+import Link from 'next/link'\n+\n+export default function Page() {\n+  return (\n+    <p>\n+      hello world <Link href=\"/pregenerated\">to /pregenerated</Link>{' '}\n+      <Link href=\"/\">to /</Link>\n+    </p>\n+  )\n+}\n+\n+export async function getServerSideProps() {\n+  return {\n+    props: {\n+      static: false,\n+    },\n+  }\n+}"
        },
        {
            "sha": "ef1ba7d9a400ad76d6eb1e6ed1b474f6f2a4f7be",
            "filename": "test/development/dev-indicator/pages/index.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fdev-indicator%2Fpages%2Findex.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e071b839e4b676883f28132366b27aae3abdf78b/test%2Fdevelopment%2Fdev-indicator%2Fpages%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-indicator%2Fpages%2Findex.tsx?ref=e071b839e4b676883f28132366b27aae3abdf78b",
            "patch": "@@ -0,0 +1,11 @@\n+import Link from 'next/link'\n+\n+export default function Page() {\n+  return (\n+    <p>\n+      hello world <Link href=\"/gssp\">to /gssp</Link>{' '}\n+      <Link href=\"/pregenerated\">to /pregenerated</Link>\n+      <Link href=\"/gip\">to /gip</Link>\n+    </p>\n+  )\n+}"
        }
    ],
    "stats": {
        "total": 243,
        "additions": 242,
        "deletions": 1
    }
}