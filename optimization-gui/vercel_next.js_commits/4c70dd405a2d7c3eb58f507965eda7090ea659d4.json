{
    "author": "eps1lon",
    "message": "Revert \"Remove useSyncExternalStore from useIsDevRendering (#77651)\" (#77672)",
    "sha": "4c70dd405a2d7c3eb58f507965eda7090ea659d4",
    "files": [
        {
            "sha": "61e2a4c2151fd46ef860ac9d3c1a8d0b38dfe486",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/dev-indicator/dev-render-indicator.tsx",
            "status": "modified",
            "additions": 26,
            "deletions": 12,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/4c70dd405a2d7c3eb58f507965eda7090ea659d4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fdev-render-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4c70dd405a2d7c3eb58f507965eda7090ea659d4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fdev-render-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fdev-render-indicator.tsx?ref=4c70dd405a2d7c3eb58f507965eda7090ea659d4",
            "patch": "@@ -3,21 +3,35 @@\n  * Used by the dev tools indicator to show render status\n  */\n \n-import { useEffect, useOptimistic } from 'react'\n+import { useSyncExternalStore } from 'react'\n \n-const optimisticStateSetters = new Set<(boolean: true) => void>()\n+let isVisible = false\n+let listeners: Array<() => void> = []\n+\n+const subscribe = (listener: () => void) => {\n+  listeners.push(listener)\n+  return () => {\n+    listeners = listeners.filter((l) => l !== listener)\n+  }\n+}\n+\n+const getSnapshot = () => isVisible\n+\n+const show = () => {\n+  isVisible = true\n+  listeners.forEach((listener) => listener())\n+}\n+\n+const hide = () => {\n+  isVisible = false\n+  listeners.forEach((listener) => listener())\n+}\n \n export function useIsDevRendering() {\n-  const [isDevRendering, setIsDevRendering] = useOptimistic(false)\n-  useEffect(() => {\n-    optimisticStateSetters.add(setIsDevRendering)\n-    return () => {\n-      optimisticStateSetters.delete(setIsDevRendering)\n-    }\n-  }, [setIsDevRendering])\n-  return isDevRendering\n+  return useSyncExternalStore(subscribe, getSnapshot)\n }\n \n-export function setDevRenderIndicatorPending() {\n-  optimisticStateSetters.forEach((setter) => setter(true))\n+export const devRenderIndicator = {\n+  show,\n+  hide,\n }"
        },
        {
            "sha": "354bdf93f076e30c313965dcc29f83ca3a2ccef3",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/4c70dd405a2d7c3eb58f507965eda7090ea659d4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4c70dd405a2d7c3eb58f507965eda7090ea659d4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator.tsx?ref=4c70dd405a2d7c3eb58f507965eda7090ea659d4",
            "patch": "@@ -0,0 +1,16 @@\n+import { useEffect, useTransition } from 'react'\n+import { devRenderIndicator } from './dev-render-indicator'\n+\n+export const useSyncDevRenderIndicator = () => {\n+  const [isPending, startTransition] = useTransition()\n+\n+  useEffect(() => {\n+    if (isPending) {\n+      devRenderIndicator.show()\n+    } else {\n+      devRenderIndicator.hide()\n+    }\n+  }, [isPending])\n+\n+  return startTransition\n+}"
        },
        {
            "sha": "1e4406c9f99f2ef26e4b2c4352180014c40e8f31",
            "filename": "packages/next/src/client/components/use-action-queue.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 16,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/4c70dd405a2d7c3eb58f507965eda7090ea659d4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4c70dd405a2d7c3eb58f507965eda7090ea659d4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts?ref=4c70dd405a2d7c3eb58f507965eda7090ea659d4",
            "patch": "@@ -1,5 +1,5 @@\n import type { Dispatch } from 'react'\n-import React, { startTransition, use } from 'react'\n+import React, { use } from 'react'\n import { isThenable } from '../../shared/lib/is-thenable'\n import type { AppRouterActionQueue } from './app-router-instance'\n import type {\n@@ -19,20 +19,6 @@ export function dispatchAppRouterAction(action: ReducerActions) {\n       'Internal Next.js error: Router action dispatched before initialization.'\n     )\n   }\n-\n-  if (process.env.NODE_ENV !== 'production') {\n-    // In development, set an pending state on the DevTools indicator\n-    // whenever a router action is in progress. This is backed by useOptimistic,\n-    // so we don't need to set it back to false; it will be automatically reset\n-    // when the transition completes.\n-    const setDevRenderIndicatorPending =\n-      require('./react-dev-overlay/utils/dev-indicator/dev-render-indicator')\n-        .setDevRenderIndicatorPending as typeof import('./react-dev-overlay/utils/dev-indicator/dev-render-indicator').setDevRenderIndicatorPending\n-    startTransition(() => setDevRenderIndicatorPending())\n-  }\n-\n-  // NOTE: This is wrapped in a startTransition internally, but to avoid a\n-  // refactor hazard we should consider wrapping it here instead.\n   dispatch(action)\n }\n \n@@ -48,7 +34,22 @@ export function useActionQueue(\n   // Ideally, what we'd do instead is pass the state as a prop to root.render;\n   // this is conceptually how we're modeling the app router state, despite the\n   // weird implementation details.\n-  dispatch = (action: ReducerActions) => actionQueue.dispatch(action, setState)\n+  if (process.env.NODE_ENV !== 'production') {\n+    const useSyncDevRenderIndicator =\n+      require('./react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator')\n+        .useSyncDevRenderIndicator as typeof import('./react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator').useSyncDevRenderIndicator\n+    // eslint-disable-next-line react-hooks/rules-of-hooks\n+    const syncDevRenderIndicator = useSyncDevRenderIndicator()\n+\n+    dispatch = (action: ReducerActions) => {\n+      syncDevRenderIndicator(() => {\n+        actionQueue.dispatch(action, setState)\n+      })\n+    }\n+  } else {\n+    dispatch = (action: ReducerActions) =>\n+      actionQueue.dispatch(action, setState)\n+  }\n \n   return isThenable(state) ? use(state) : state\n }"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 59,
        "deletions": 28
    }
}