{
    "author": "timneutkens",
    "message": "Make hasNecessaryDependencies sync (#83564)\n\n## What?\n\nIt's currently half-sync and half-async. Given this happens in the\nblocking path when booting in development it's better to use the sync fs\nversion.",
    "sha": "64b29e00580b393d0536e5a90c2e454e16ad0234",
    "files": [
        {
            "sha": "3c45f5a34ea3fde66c68087eec417249ca91dcf9",
            "filename": "packages/next/src/build/load-jsconfig.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Fbuild%2Fload-jsconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Fbuild%2Fload-jsconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fload-jsconfig.ts?ref=64b29e00580b393d0536e5a90c2e454e16ad0234",
            "patch": "@@ -56,7 +56,7 @@ export default async function loadJsConfig(\n }> {\n   let typeScriptPath: string | undefined\n   try {\n-    const deps = await hasNecessaryDependencies(dir, [\n+    const deps = hasNecessaryDependencies(dir, [\n       {\n         pkg: 'typescript',\n         file: 'typescript/lib/typescript.js',"
        },
        {
            "sha": "76569f6131c583c0d877541fc4dfb7a3636b7cb4",
            "filename": "packages/next/src/cli/next-test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts?ref=64b29e00580b393d0536e5a90c2e454e16ad0234",
            "patch": "@@ -93,7 +93,7 @@ async function checkRequiredDeps(\n   baseDir: string,\n   testRunner: SupportedTestRunners\n ) {\n-  const deps = await hasNecessaryDependencies(\n+  const deps = hasNecessaryDependencies(\n     baseDir,\n     requiredPackagesByTestRunner[testRunner]\n   )"
        },
        {
            "sha": "0fec5a03c24a8b7dcaa7153a15a259dcfb5dd633",
            "filename": "packages/next/src/lib/eslint/runLintCheck.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Flib%2Feslint%2FrunLintCheck.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Flib%2Feslint%2FrunLintCheck.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Feslint%2FrunLintCheck.ts?ref=64b29e00580b393d0536e5a90c2e454e16ad0234",
            "patch": "@@ -115,7 +115,7 @@ async function lint(\n > {\n   try {\n     // Load ESLint after we're sure it exists:\n-    const deps = await hasNecessaryDependencies(baseDir, requiredPackages)\n+    const deps = hasNecessaryDependencies(baseDir, requiredPackages)\n     const packageManager = getPkgManager(baseDir)\n \n     if (deps.missing.some((dep) => dep.pkg === 'eslint')) {"
        },
        {
            "sha": "50542701fa9c9d717e366e82485379cbc5b90735",
            "filename": "packages/next/src/lib/has-necessary-dependencies.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 25,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Flib%2Fhas-necessary-dependencies.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Flib%2Fhas-necessary-dependencies.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fhas-necessary-dependencies.ts?ref=64b29e00580b393d0536e5a90c2e454e16ad0234",
            "patch": "@@ -1,4 +1,4 @@\n-import { existsSync, promises as fs } from 'fs'\n+import { existsSync, realpathSync } from 'fs'\n import { resolveFrom } from './resolve-from'\n import { dirname, join, relative } from 'path'\n \n@@ -29,41 +29,41 @@ export type NecessaryDependencies = {\n   missing: MissingDependency[]\n }\n \n-export async function hasNecessaryDependencies(\n+export function hasNecessaryDependencies(\n   baseDir: string,\n   requiredPackages: MissingDependency[]\n-): Promise<NecessaryDependencies> {\n+): NecessaryDependencies {\n   let resolutions = new Map<string, string>()\n   const missingPackages: MissingDependency[] = []\n \n-  await Promise.all(\n-    requiredPackages.map(async (p) => {\n-      try {\n-        const pkgPath = await fs.realpath(\n-          resolveFrom(baseDir, `${p.pkg}/package.json`)\n-        )\n-        const pkgDir = dirname(pkgPath)\n+  for (const p of requiredPackages) {\n+    try {\n+      const pkgPath = realpathSync(\n+        resolveFrom(baseDir, `${p.pkg}/package.json`)\n+      )\n+      const pkgDir = dirname(pkgPath)\n \n-        if (p.exportsRestrict) {\n-          const fileNameToVerify = relative(p.pkg, p.file)\n-          if (fileNameToVerify) {\n-            const fileToVerify = join(pkgDir, fileNameToVerify)\n-            if (existsSync(fileToVerify)) {\n-              resolutions.set(p.pkg, fileToVerify)\n-            } else {\n-              return missingPackages.push(p)\n-            }\n+      if (p.exportsRestrict) {\n+        const fileNameToVerify = relative(p.pkg, p.file)\n+        if (fileNameToVerify) {\n+          const fileToVerify = join(pkgDir, fileNameToVerify)\n+          if (existsSync(fileToVerify)) {\n+            resolutions.set(p.pkg, fileToVerify)\n           } else {\n-            resolutions.set(p.pkg, pkgPath)\n+            missingPackages.push(p)\n+            continue\n           }\n         } else {\n-          resolutions.set(p.pkg, resolveFrom(baseDir, p.file))\n+          resolutions.set(p.pkg, pkgPath)\n         }\n-      } catch (_) {\n-        return missingPackages.push(p)\n+      } else {\n+        resolutions.set(p.pkg, resolveFrom(baseDir, p.file))\n       }\n-    })\n-  )\n+    } catch (_) {\n+      missingPackages.push(p)\n+      continue\n+    }\n+  }\n \n   return {\n     resolved: resolutions,"
        },
        {
            "sha": "f7b5d0d589975d990e077f1ca038b0162856f912",
            "filename": "packages/next/src/lib/verify-partytown-setup.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 10,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Flib%2Fverify-partytown-setup.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Flib%2Fverify-partytown-setup.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fverify-partytown-setup.ts?ref=64b29e00580b393d0536e5a90c2e454e16ad0234",
            "patch": "@@ -66,16 +66,13 @@ export async function verifyPartytownSetup(\n   targetDir: string\n ): Promise<void> {\n   try {\n-    const partytownDeps: NecessaryDependencies = await hasNecessaryDependencies(\n-      dir,\n-      [\n-        {\n-          file: '@builder.io/partytown',\n-          pkg: '@builder.io/partytown',\n-          exportsRestrict: false,\n-        },\n-      ]\n-    )\n+    const partytownDeps: NecessaryDependencies = hasNecessaryDependencies(dir, [\n+      {\n+        file: '@builder.io/partytown',\n+        pkg: '@builder.io/partytown',\n+        exportsRestrict: false,\n+      },\n+    ])\n \n     if (partytownDeps.missing?.length > 0) {\n       await missingDependencyError(dir)"
        },
        {
            "sha": "c73772416be8cd8410dd2ccb12fb963289515170",
            "filename": "packages/next/src/lib/verify-typescript-setup.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b29e00580b393d0536e5a90c2e454e16ad0234/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts?ref=64b29e00580b393d0536e5a90c2e454e16ad0234",
            "patch": "@@ -65,7 +65,7 @@ export async function verifyTypeScriptSetup({\n     }\n \n     // Ensure TypeScript and necessary `@types/*` are installed:\n-    let deps: NecessaryDependencies = await hasNecessaryDependencies(\n+    let deps: NecessaryDependencies = hasNecessaryDependencies(\n       dir,\n       requiredPackages\n     )\n@@ -102,7 +102,7 @@ export async function verifyTypeScriptSetup({\n         }\n         throw err\n       })\n-      deps = await hasNecessaryDependencies(dir, requiredPackages)\n+      deps = hasNecessaryDependencies(dir, requiredPackages)\n     }\n \n     // Load TypeScript after we're sure it exists:"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 37,
        "deletions": 40
    }
}