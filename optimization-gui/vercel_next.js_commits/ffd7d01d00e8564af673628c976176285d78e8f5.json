{
    "author": "eps1lon",
    "message": "[test] Enable `strictNullChecks` in test utils (#78142)",
    "sha": "ffd7d01d00e8564af673628c976176285d78e8f5",
    "files": [
        {
            "sha": "e810259d8285e51f985a253315239ffdcc3f42ff",
            "filename": "packages/next/types/global.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/packages%2Fnext%2Ftypes%2Fglobal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/packages%2Fnext%2Ftypes%2Fglobal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2Fglobal.d.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -19,6 +19,7 @@ declare namespace NodeJS {\n   }\n \n   interface ProcessEnv {\n+    // TODO: Should be optional and possibly undefined\n     readonly NODE_ENV: 'development' | 'production' | 'test'\n   }\n "
        },
        {
            "sha": "3202a28cbd40808ddbcfdefcec6ff2245e1d3f13",
            "filename": "test/lib/add-redbox-matchers.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fadd-redbox-matchers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fadd-redbox-matchers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fadd-redbox-matchers.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -63,12 +63,12 @@ declare global {\n }\n \n interface ErrorSnapshot {\n-  environmentLabel: string\n-  label: string\n-  description: string\n+  environmentLabel: string | null\n+  label: string | null\n+  description: string | null\n   componentStack?: string\n-  source: string\n-  stack: string[]\n+  source: string | null\n+  stack: string[] | null\n }\n \n async function createErrorSnapshot(\n@@ -145,7 +145,7 @@ async function createErrorSnapshot(\n         : description,\n     source: focusedSource,\n     stack:\n-      next !== null\n+      next !== null && stack !== null\n         ? stack.map((stackframe) => {\n             return stackframe.replace(next.testDir, '<FIXME-project-root>')\n           })\n@@ -202,7 +202,7 @@ expect.extend({\n     expectedRedboxSnapshot?: string\n   ) {\n     let browser: BrowserInterface\n-    let next: NextInstance\n+    let next: NextInstance | null\n     if ('browser' in browserOrContext && 'next' in browserOrContext) {\n       browser = browserOrContext.browser\n       next = browserOrContext.next"
        },
        {
            "sha": "731cd0526d683d92b9a25588b7b1bfe12af4ea56",
            "filename": "test/lib/browsers/base.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 9,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fbrowsers%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fbrowsers%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fbrowsers%2Fbase.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -12,7 +12,7 @@ export abstract class BrowserInterface<TCurrent = any> {\n   readonly [Symbol.toStringTag]: string = 'BrowserInterface'\n \n   protected chain<TNext>(\n-    nextCall: (current: TCurrent) => TNext | Promise<TNext>\n+    nextCall: (current: TCurrent | undefined) => TNext | Promise<TNext>\n   ): BrowserInterface<TNext> & Promise<TNext> {\n     const syncError = new Error('next-browser-base-chain-error')\n     const promise = Promise.resolve(this.promise)\n@@ -23,7 +23,7 @@ export abstract class BrowserInterface<TCurrent = any> {\n           typeof reason === 'object' &&\n           'stack' in reason\n         ) {\n-          const syncCallStack = syncError.stack.split(syncError.message)[1]\n+          const syncCallStack = syncError.stack!.split(syncError.message)[1]\n           reason.stack += `\\n${syncCallStack}`\n         }\n         throw reason\n@@ -100,12 +100,7 @@ export abstract class BrowserInterface<TCurrent = any> {\n   abstract off(event: Event, cb: (...args: any[]) => void): void\n   abstract loadPage(\n     url: string,\n-    {\n-      disableCache,\n-      cpuThrottleRate,\n-      beforePageLoad,\n-      pushErrorAsConsoleLog,\n-    }?: {\n+    options?: {\n       disableCache?: boolean\n       cpuThrottleRate?: number\n       beforePageLoad?: Function\n@@ -114,7 +109,7 @@ export abstract class BrowserInterface<TCurrent = any> {\n   ): Promise<void>\n   abstract get(url: string): Promise<void>\n   abstract getValue(): Promise<string>\n-  abstract getAttribute(name: string): Promise<string>\n+  abstract getAttribute(name: string): Promise<string | null>\n   abstract eval(snippet: string | Function, ...args: any[]): Promise<any>\n   abstract evalAsync(snippet: string | Function, ...args: any[]): Promise<any>\n   abstract text(): Promise<string>"
        },
        {
            "sha": "4a415e05e34716f70d2909479abeac310836c7b7",
            "filename": "test/lib/browsers/playwright.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fbrowsers%2Fplaywright.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -16,8 +16,8 @@ import path from 'path'\n type PageLog = { source: string; message: string; args: unknown[] }\n \n let page: Page\n-let browser: Browser\n-let context: BrowserContext\n+let browser: Browser | undefined\n+let context: BrowserContext | undefined\n let contextHasJSEnabled: boolean = true\n let pageLogs: Array<Promise<PageLog> | PageLog> = []\n let websocketFrames: Array<{ payload: string | Buffer }> = []\n@@ -34,7 +34,7 @@ const defaultTimeout = process.env.NEXT_E2E_TEST_TIMEOUT\n // This is due to `quit` can be called anytime outside of BrowserInterface's lifecycle,\n // which can create corrupted state by terminating the context.\n // [TODO] global `quit` might need to be removed, instead should introduce per-instance teardown\n-const pendingTeardown = []\n+const pendingTeardown: Array<() => Promise<void>> = []\n export async function quit() {\n   await Promise.all(pendingTeardown.map((fn) => fn()))\n   await context?.close()\n@@ -90,13 +90,13 @@ export class Playwright extends BrowserInterface {\n       const traceOutputPath = path.join(\n         traceDir,\n         `${path\n-          .relative(path.join(__dirname, '../../'), process.env.TEST_FILE_PATH)\n+          .relative(path.join(__dirname, '../../'), process.env.TEST_FILE_PATH!)\n           .replace(/\\//g, '-')}`,\n         `playwright-${this.activeTrace}-${Date.now()}.zip`\n       )\n \n       await fs.remove(traceOutputPath)\n-      await context.tracing.stop({\n+      await context!.tracing.stop({\n         path: traceOutputPath,\n       })\n     } catch (e) {\n@@ -214,12 +214,12 @@ export class Playwright extends BrowserInterface {\n     await this.close()\n \n     // clean-up existing pages\n-    for (const oldPage of context.pages()) {\n+    for (const oldPage of context!.pages()) {\n       await oldPage.close()\n     }\n \n-    await this.initContextTracing(url, context)\n-    page = await context.newPage()\n+    await this.initContextTracing(url, context!)\n+    page = await context!.newPage()\n \n     page.setDefaultTimeout(defaultTimeout)\n     page.setDefaultNavigationTimeout(defaultTimeout)\n@@ -255,12 +255,12 @@ export class Playwright extends BrowserInterface {\n \n     if (opts?.disableCache) {\n       // TODO: this doesn't seem to work (dev tools does not check the box as expected)\n-      const session = await context.newCDPSession(page)\n+      const session = await context!.newCDPSession(page)\n       session.send('Network.setCacheDisabled', { cacheDisabled: true })\n     }\n \n     if (opts?.cpuThrottleRate) {\n-      const session = await context.newCDPSession(page)\n+      const session = await context!.newCDPSession(page)\n       // https://chromedevtools.github.io/devtools-protocol/tot/Emulation/#method-setCPUThrottlingRate\n       session.send('Emulation.setCPUThrottlingRate', {\n         rate: opts.cpuThrottleRate,\n@@ -315,7 +315,7 @@ export class Playwright extends BrowserInterface {\n   }\n   addCookie(opts: { name: string; value: string }) {\n     return this.chain(async () =>\n-      context.addCookies([\n+      context!.addCookies([\n         {\n           path: '/',\n           domain: await page.evaluate('window.location.hostname'),\n@@ -325,7 +325,7 @@ export class Playwright extends BrowserInterface {\n     )\n   }\n   deleteCookies() {\n-    return this.chain(async () => context.clearCookies())\n+    return this.chain(async () => context!.clearCookies())\n   }\n \n   focusPage() {\n@@ -336,7 +336,7 @@ export class Playwright extends BrowserInterface {\n     function getComputedCss(prop: string) {\n       return page.evaluate(\n         function (args) {\n-          const style = getComputedStyle(document.querySelector(args.selector))\n+          const style = getComputedStyle(document.querySelector(args.selector)!)\n           return style[args.prop] || null\n         },\n         { selector, prop }"
        },
        {
            "sha": "d7126b81449817443436ed1c30e75080a8c5381f",
            "filename": "test/lib/create-next-install.js",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fcreate-next-install.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fcreate-next-install.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fcreate-next-install.js?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -31,6 +31,19 @@ async function installDependencies(cwd, tmpDir) {\n   })\n }\n \n+/**\n+ *\n+ * @param {object} param0\n+ * @param {import('@next/telemetry').Span} param0.parentSpan\n+ * @param {object} [param0.dependencies]\n+ * @param {object | null} [param0.resolutions]\n+ * @param { ((ctx: { dependencies: { [key: string]: string } }) => string) | string | null} [param0.installCommand]\n+ * @param {object} [param0.packageJson]\n+ * @param {string} [param0.dirSuffix]\n+ * @param {boolean} [param0.keepRepoDir]\n+ * @param {(span: import('@next/telemetry').Span, installDir: string) => Promise<void>} param0.beforeInstall\n+ * @returns {Promise<{installDir: string, pkgPaths: Map<string, string>, tmpRepoDir: string | undefined}>}\n+ */\n async function createNextInstall({\n   parentSpan,\n   dependencies = {},"
        },
        {
            "sha": "d612d255075fef5f8b149d88dbf6af1287b97ea7",
            "filename": "test/lib/development-sandbox.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fdevelopment-sandbox.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fdevelopment-sandbox.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fdevelopment-sandbox.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -35,7 +35,7 @@ export async function createSandbox(\n   next: NextInstance,\n   initialFiles?: Map<string, string | ((contents: string) => string)>,\n   initialUrl: string = '/',\n-  webDriverOptions: WebdriverOptions = undefined\n+  webDriverOptions: WebdriverOptions | undefined = undefined\n ) {\n   let unwrappedByTypeScriptUsingKeyword = false\n "
        },
        {
            "sha": "6df759066b2827b8a4d67da997b0a226f860afd0",
            "filename": "test/lib/e2e-utils/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fe2e-utils%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fe2e-utils%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fe2e-utils%2Findex.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -71,7 +71,7 @@ if (testModeFromFile === 'e2e') {\n     testMode = 'start'\n   }\n   assert(\n-    validE2EModes.includes(testMode),\n+    validE2EModes.includes(testMode!),\n     `NEXT_TEST_MODE must be one of ${validE2EModes.join(\n       ', '\n     )} for e2e tests but received ${testMode}`\n@@ -194,6 +194,8 @@ export async function createNext(\n         })\n       }\n \n+      nextInstance = nextInstance!\n+\n       nextInstance.on('destroy', () => {\n         nextInstance = undefined\n       })\n@@ -204,7 +206,7 @@ export async function createNext(\n         await rootSpan\n           .traceChild('start next instance')\n           .traceAsyncFn(async () => {\n-            await nextInstance.start()\n+            await nextInstance!.start()\n           })\n       }\n "
        },
        {
            "sha": "5eceeef1192616b06963bf1edf56d5d5b602f326",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 11,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -79,12 +79,12 @@ export class NextInstance {\n   protected childProcess?: ChildProcess\n   protected _url: string\n   protected _parsedUrl: URL\n-  protected packageJson?: PackageJson = {}\n+  protected packageJson: PackageJson = {}\n   protected basePath?: string\n   public env: Record<string, string>\n   public forcedPort?: string\n   public dirSuffix: string = ''\n-  public serverReadyPattern?: RegExp = / ✓ Ready in /\n+  public serverReadyPattern: RegExp = / ✓ Ready in /\n   patchFileDelay: number = 0\n \n   constructor(opts: NextInstanceOpts) {\n@@ -96,7 +96,8 @@ export class NextInstance {\n         ...this.env,\n         // remove node_modules/.bin repo path from env\n         // to match CI $PATH value and isolate further\n-        PATH: process.env.PATH.split(path.delimiter)\n+        PATH: process.env\n+          .PATH!.split(path.delimiter)\n           .filter((part) => {\n             return !part.includes(path.join('node_modules', '.bin'))\n           })\n@@ -279,7 +280,7 @@ export class NextInstance {\n                 await this.beforeInstall(span)\n               },\n             })\n-            this.tmpRepoDir = tmpRepoDir\n+            this.tmpRepoDir = tmpRepoDir!\n           }\n         }\n \n@@ -296,7 +297,7 @@ export class NextInstance {\n         }\n \n         if (this.nextConfig || (isNextDeploy && !nextConfigFile)) {\n-          const functions = []\n+          const functions: string[] = []\n           const exportDeclare =\n             this.packageJson?.type === 'module'\n               ? 'export default'\n@@ -308,7 +309,7 @@ export class NextInstance {\n                 {\n                   ...this.nextConfig,\n                 } as NextConfig,\n-                (key, val) => {\n+                (key, val: unknown) => {\n                   if (typeof val === 'function') {\n                     functions.push(\n                       val\n@@ -324,7 +325,7 @@ export class NextInstance {\n                 },\n                 2\n               ).replace(/\"__func_[\\d]{1,}\"/g, function (str) {\n-                return functions.shift()\n+                return functions.shift()!\n               })\n           )\n         }\n@@ -428,7 +429,10 @@ export class NextInstance {\n     await this.writeInitialFiles()\n   }\n \n-  public async build(): Promise<{ exitCode?: number; cliOutput?: string }> {\n+  public async build(): Promise<{\n+    exitCode: NodeJS.Signals | number | null\n+    cliOutput: string\n+  }> {\n     throw new Error('Not implemented')\n   }\n \n@@ -455,7 +459,7 @@ export class NextInstance {\n       this.isStopping = true\n       const closePromise = once(this.childProcess, 'close')\n       await new Promise<void>((resolve) => {\n-        treeKill(this.childProcess.pid, signal, (err) => {\n+        treeKill(this.childProcess!.pid!, signal, (err) => {\n           if (err) {\n             require('console').error('tree-kill', err)\n           }\n@@ -491,7 +495,7 @@ export class NextInstance {\n               `${path\n                 .relative(\n                   path.join(__dirname, '../../'),\n-                  process.env.TEST_FILE_PATH\n+                  process.env.TEST_FILE_PATH!\n                 )\n                 .replace(/\\//g, '-')}`,\n               `next-trace`\n@@ -576,7 +580,7 @@ export class NextInstance {\n \n   public async patchFile(\n     filename: string,\n-    content: string | ((content: string) => string),\n+    content: string | ((content: string | undefined) => string),\n     runWithTempContent?: (context: { newFile: boolean }) => Promise<void>\n   ): Promise<{ newFile: boolean }> {\n     const outputPath = path.join(this.testDir, filename)"
        },
        {
            "sha": "7f94b478aeac58f0bad98ea58886a89bb462588b",
            "filename": "test/lib/next-modes/next-deploy.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-deploy.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -36,7 +36,7 @@ export class NextDeployInstance extends NextInstance {\n       })\n     }\n \n-    const vercelFlags = []\n+    const vercelFlags: string[] = []\n \n     // If the team name is available in the environment, use it as the scope.\n     if (TEST_TEAM_NAME) {\n@@ -87,7 +87,7 @@ export class NextDeployInstance extends NextInstance {\n     }\n     require('console').log(`Deploying project at ${this.testDir}`)\n \n-    const additionalEnv = []\n+    const additionalEnv: string[] = []\n \n     for (const key of Object.keys(this.env || {})) {\n       additionalEnv.push('--build-env')"
        },
        {
            "sha": "1b256684e60cbe36181c4450a63ec77dbca4c8dc",
            "filename": "test/lib/next-modes/next-dev.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-dev.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -71,13 +71,13 @@ export class NextDevInstance extends NextInstance {\n \n         this._cliOutput = ''\n \n-        this.childProcess.stdout.on('data', (chunk) => {\n+        this.childProcess.stdout!.on('data', (chunk) => {\n           const msg = chunk.toString()\n           if (!process.env.CI) process.stdout.write(chunk)\n           this._cliOutput += msg\n           this.emit('stdout', [msg])\n         })\n-        this.childProcess.stderr.on('data', (chunk) => {\n+        this.childProcess.stderr!.on('data', (chunk) => {\n           const msg = chunk.toString()\n           if (!process.env.CI) process.stderr.write(chunk)\n           this._cliOutput += msg"
        },
        {
            "sha": "0e123320edf9e8502b9479ad17d4752ce1b7afd0",
            "filename": "test/lib/next-modes/next-start.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-start.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -102,7 +102,7 @@ export class NextStartInstance extends NextInstance {\n         )\n         this.handleStdio(this.childProcess)\n         this.childProcess.on('exit', (code, signal) => {\n-          this.childProcess = null\n+          this.childProcess = undefined\n           if (code || signal)\n             reject(\n               new Error(`next build failed with code/signal ${code || signal}`)\n@@ -163,7 +163,7 @@ export class NextStartInstance extends NextInstance {\n             this._parsedUrl = new URL(this._url)\n           }\n \n-          if (this.serverReadyPattern.test(colorStrippedMsg)) {\n+          if (this.serverReadyPattern!.test(colorStrippedMsg)) {\n             clearTimeout(serverReadyTimeoutId)\n             resolve()\n             this.off('stdout', readyCb)\n@@ -190,7 +190,10 @@ export class NextStartInstance extends NextInstance {\n         __NEXT_TEST_MODE: 'e2e',\n       },\n     }\n-    return new Promise((resolve) => {\n+    return new Promise<{\n+      exitCode: NodeJS.Signals | number | null\n+      cliOutput: string\n+    }>((resolve) => {\n       const curOutput = this._cliOutput.length\n       const exportArgs = ['pnpm', 'next', 'build']\n "
        },
        {
            "sha": "3e69b630ba1bf6d851c9d289a61f32d8d5d40e62",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 24,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -97,12 +97,12 @@ export function initNextServerScript(\n       })\n     }\n \n-    instance.stdout.on('data', handleStdout)\n-    instance.stderr.on('data', handleStderr)\n+    instance.stdout!.on('data', handleStdout)\n+    instance.stderr!.on('data', handleStderr)\n \n     instance.on('close', () => {\n-      instance.stdout.removeListener('data', handleStdout)\n-      instance.stderr.removeListener('data', handleStderr)\n+      instance.stdout!.removeListener('data', handleStdout)\n+      instance.stderr!.removeListener('data', handleStderr)\n     })\n \n     instance.on('error', (err) => {\n@@ -230,8 +230,8 @@ export function runNextCommand(\n   argv: string[],\n   options: NextOptions = {}\n ): Promise<{\n-  code: number\n-  signal: NodeJS.Signals\n+  code: number | null\n+  signal: NodeJS.Signals | null\n   stdout: string\n   stderr: string\n }> {\n@@ -241,7 +241,8 @@ export function runNextCommand(\n   // Let Next.js decide the environment\n   const env = {\n     ...process.env,\n-    NODE_ENV: undefined,\n+    // @ts-ignore packages/next/types/global.d.ts should allow undefined NODE_ENV\n+    NODE_ENV: undefined as NodeJS.ProcessEnv['NODE_ENV'],\n     __NEXT_TEST_MODE: 'true',\n     ...options.env,\n   }\n@@ -267,7 +268,7 @@ export function runNextCommand(\n \n     let stderrOutput = ''\n     if (options.stderr || options.onStderr) {\n-      instance.stderr.on('data', function (chunk) {\n+      instance.stderr!.on('data', function (chunk) {\n         mergedStdio += chunk\n         stderrOutput += chunk\n \n@@ -279,14 +280,14 @@ export function runNextCommand(\n         }\n       })\n     } else {\n-      instance.stderr.on('data', function (chunk) {\n+      instance.stderr!.on('data', function (chunk) {\n         mergedStdio += chunk\n       })\n     }\n \n     let stdoutOutput = ''\n     if (options.stdout || options.onStdout) {\n-      instance.stdout.on('data', function (chunk) {\n+      instance.stdout!.on('data', function (chunk) {\n         mergedStdio += chunk\n         stdoutOutput += chunk\n \n@@ -298,7 +299,7 @@ export function runNextCommand(\n         }\n       })\n     } else {\n-      instance.stdout.on('data', function (chunk) {\n+      instance.stdout!.on('data', function (chunk) {\n         mergedStdio += chunk\n       })\n     }\n@@ -363,7 +364,8 @@ export function runNextCommandDev(\n   const cwd = opts.cwd || nextDir\n   const env = {\n     ...process.env,\n-    NODE_ENV: undefined,\n+    // @ts-ignore packages/next/types/global.d.ts should allow undefined NODE_ENV\n+    NODE_ENV: undefined as NodeJS.ProcessEnv['NODE_ENV'],\n     __NEXT_TEST_MODE: 'true',\n     ...opts.env,\n   }\n@@ -425,12 +427,12 @@ export function runNextCommandDev(\n       }\n     }\n \n-    instance.stderr.on('data', handleStderr)\n-    instance.stdout.on('data', handleStdout)\n+    instance.stderr!.on('data', handleStderr)\n+    instance.stdout!.on('data', handleStdout)\n \n     instance.on('close', () => {\n-      instance.stderr.removeListener('data', handleStderr)\n-      instance.stdout.removeListener('data', handleStdout)\n+      instance.stderr!.removeListener('data', handleStderr)\n+      instance.stdout!.removeListener('data', handleStdout)\n       if (!didResolve) {\n         didResolve = true\n         resolve(undefined)\n@@ -460,7 +462,7 @@ export function launchApp(\n       port as string,\n       '--hostname',\n       '::',\n-    ].filter(Boolean),\n+    ].filter((flag: string | undefined): flag is string => Boolean(flag)),\n     undefined,\n     { ...options, turbo: useTurbo }\n   )\n@@ -534,8 +536,8 @@ export function buildTS(\n       output += chunk.toString()\n     }\n \n-    instance.stdout.on('data', handleData)\n-    instance.stderr.on('data', handleData)\n+    instance.stdout!.on('data', handleData)\n+    instance.stderr!.on('data', handleData)\n \n     instance.on('exit', (code) => {\n       if (code) {\n@@ -741,7 +743,7 @@ export async function check(\n \n export class File {\n   path: string\n-  originalContent: string\n+  originalContent: string | null\n \n   constructor(path: string) {\n     this.path = path\n@@ -789,7 +791,7 @@ export class File {\n   }\n \n   restore() {\n-    this.write(this.originalContent)\n+    this.write(this.originalContent!)\n   }\n }\n \n@@ -823,6 +825,8 @@ export async function retry<T>(\n       await waitFor(interval)\n     }\n   }\n+\n+  throw new Error('Duration cannot be less than 0.')\n }\n \n export async function assertHasRedbox(browser: BrowserInterface) {\n@@ -1241,7 +1245,7 @@ function runSuite(\n     stderr: string\n     stdout: string\n     appPort: number\n-    code: number\n+    code: number | null\n     server: ChildProcess\n   }>,\n   options: {\n@@ -1340,7 +1344,7 @@ export function findAllTelemetryEvents(output: string, eventName: string) {\n   const regex = /\\[telemetry\\] ({.+?^})/gms\n   // Pop the last element of each entry to retrieve contents of the capturing group\n   const events = [...output.matchAll(regex)].map((entry) =>\n-    JSON.parse(entry.pop())\n+    JSON.parse(entry.pop()!)\n   )\n   return events.filter((e) => e.eventName === eventName).map((e) => e.payload)\n }\n@@ -1493,7 +1497,7 @@ export function colorToRgb(color) {\n }\n \n export function getUrlFromBackgroundImage(backgroundImage: string) {\n-  const matches = backgroundImage.match(/url\\(\"[^)]+\"\\)/g).map((match) => {\n+  const matches = backgroundImage.match(/url\\(\"[^)]+\"\\)/g)!.map((match) => {\n     // Extract the URL part from each match. The match includes 'url(\"' and '\"\")', so we remove those.\n     return match.slice(5, -2)\n   })"
        },
        {
            "sha": "50ef7fd07db7948dba56e89af5a6991ddb9e0580",
            "filename": "test/lib/next-webdriver.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-webdriver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Fnext-webdriver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-webdriver.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -3,7 +3,7 @@ import os from 'os'\n import { BrowserInterface } from './browsers/base'\n \n if (!process.env.TEST_FILE_PATH) {\n-  process.env.TEST_FILE_PATH = module.parent.filename\n+  process.env.TEST_FILE_PATH = module.parent!.filename\n }\n \n let deviceIP: string\n@@ -15,7 +15,7 @@ if (isBrowserStack) {\n   for (const key of Object.keys(nets)) {\n     let done = false\n \n-    for (const item of nets[key]) {\n+    for (const item of nets[key]!) {\n       if (item.family === 'IPv4' && !item.internal) {\n         deviceIP = item.address\n         done = true\n@@ -123,9 +123,9 @@ export default async function webdriver(\n   const browserName = process.env.BROWSER_NAME || 'chrome'\n   await browser.setup(\n     browserName,\n-    locale,\n+    locale!,\n     !disableJavaScript,\n-    ignoreHTTPSErrors,\n+    Boolean(ignoreHTTPSErrors),\n     // allow headless to be overwritten for a particular test\n     typeof headless !== 'undefined' ? headless : !!process.env.HEADLESS,\n     userAgent"
        },
        {
            "sha": "e3b9f8ecff616e0719b89a1a180aebafa36c9b7f",
            "filename": "test/lib/test-data-service/writer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Ftest-data-service%2Fwriter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Ftest-data-service%2Fwriter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Ftest-data-service%2Fwriter.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -34,7 +34,7 @@ export function createTestDataServer(\n   onRequest: (key: string, response: TestDataResponse) => any\n ): TestDataServer {\n   const httpServer = http.createServer(async (req, res) => {\n-    const searchParams = new URL(req.url, 'http://n').searchParams\n+    const searchParams = new URL(req.url!, 'http://n').searchParams\n     const key = searchParams.get('key')\n \n     if (typeof key !== 'string') {"
        },
        {
            "sha": "168fce71170d10c1b9c15bbe979baf8397f6984d",
            "filename": "test/lib/test-log.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Ftest-log.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Ftest-log.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Ftest-log.ts?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -9,7 +9,7 @@\n //\n // Based on the Scheduler.log pattern used in the React repo.\n export function createTestLog() {\n-  let events = []\n+  let events: unknown[] = []\n \n   // Represents a pending waitFor call.\n   let pendingExpectation: null | {\n@@ -19,7 +19,7 @@ export function createTestLog() {\n     error: Error\n   } = null\n \n-  function log(value: any) {\n+  function log(value: unknown) {\n     // Add to the event log.\n     events.push(value)\n "
        },
        {
            "sha": "e840a9c82947dfa5f9bb872069bee2f837a72754",
            "filename": "test/lib/tsconfig.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/ffd7d01d00e8564af673628c976176285d78e8f5/test%2Flib%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Ftsconfig.json?ref=ffd7d01d00e8564af673628c976176285d78e8f5",
            "patch": "@@ -2,6 +2,6 @@\n   \"extends\": \"../../tsconfig.json\",\n   \"include\": [\"./**/*.ts\"],\n   \"compilerOptions\": {\n-    \"strictNullChecks\": false\n+    \"strictNullChecks\": true\n   }\n }"
        }
    ],
    "stats": {
        "total": 186,
        "additions": 104,
        "deletions": 82
    }
}