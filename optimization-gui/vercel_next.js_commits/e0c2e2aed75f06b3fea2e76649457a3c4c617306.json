{
    "author": "kdy1",
    "message": "perf(turbopack): Use rayon threadpool for `minify()` (#79261)\n\n### What?\n\nRun `minify()` on the `rayon` threadpool instead of the `tokio` threadpool.\n\n### Why?\n\nES minification is a very CPU-intensive operation, and more importantly, it calls `rayon` internally anyway. So it's better to run it from the rayon thread pool from the start.\n\nIt seems like this PR makes the total build ~ 3% faster, at the cost of a small RSS increase.\n\nx-ref: Numbers at\nhttps://vercel.slack.com/archives/C06PPGZ0FD3/p1747349799503749?thread_ts=1747349784.352809&cid=C06PPGZ0FD3",
    "sha": "e0c2e2aed75f06b3fea2e76649457a3c4c617306",
    "files": [
        {
            "sha": "d4155ec34b9dc9300700e3ebe10e637fb19a1c23",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e0c2e2aed75f06b3fea2e76649457a3c4c617306/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/e0c2e2aed75f06b3fea2e76649457a3c4c617306/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=e0c2e2aed75f06b3fea2e76649457a3c4c617306",
            "patch": "@@ -10162,6 +10162,7 @@ dependencies = [\n  \"par-core\",\n  \"parking_lot\",\n  \"petgraph 0.6.3\",\n+ \"rayon\",\n  \"regex\",\n  \"rustc-hash 2.1.1\",\n  \"serde\","
        },
        {
            "sha": "b0851a51bca98b44c67bbb3f732e931110cb725b",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/content.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e0c2e2aed75f06b3fea2e76649457a3c4c617306/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e0c2e2aed75f06b3fea2e76649457a3c4c617306/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs?ref=e0c2e2aed75f06b3fea2e76649457a3c4c617306",
            "patch": "@@ -128,7 +128,7 @@ impl EcmascriptBrowserChunkContent {\n         let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            code = minify(&code, source_maps, mangle)?;\n+            code = minify(code, source_maps, mangle).await?;\n         }\n \n         Ok(code.cell())"
        },
        {
            "sha": "ae2ada1465666d93246e2e632fe901e51910f0ab",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/evaluate/chunk.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e0c2e2aed75f06b3fea2e76649457a3c4c617306/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e0c2e2aed75f06b3fea2e76649457a3c4c617306/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs?ref=e0c2e2aed75f06b3fea2e76649457a3c4c617306",
            "patch": "@@ -194,7 +194,7 @@ impl EcmascriptBrowserEvaluateChunk {\n         let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            code = minify(&code, source_maps, mangle)?;\n+            code = minify(code, source_maps, mangle).await?;\n         }\n \n         Ok(code.cell())"
        },
        {
            "sha": "3ef1b2df2b3eaf7319a271582e7fb6f01ac82905",
            "filename": "turbopack/crates/turbopack-ecmascript/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e0c2e2aed75f06b3fea2e76649457a3c4c617306/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/e0c2e2aed75f06b3fea2e76649457a3c4c617306/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml?ref=e0c2e2aed75f06b3fea2e76649457a3c4c617306",
            "patch": "@@ -44,6 +44,7 @@ turbopack-resolve = { workspace = true }\n turbopack-swc-utils = { workspace = true }\n url = { workspace = true }\n urlencoding = { workspace = true }\n+rayon = { workspace = true }\n \n swc_core = { workspace = true, features = [\n   \"ecma_ast\","
        },
        {
            "sha": "189e0cf3e1f307be7bfd822ce39e7eb614c76704",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/e0c2e2aed75f06b3fea2e76649457a3c4c617306/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e0c2e2aed75f06b3fea2e76649457a3c4c617306/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=e0c2e2aed75f06b3fea2e76649457a3c4c617306",
            "patch": "@@ -31,7 +31,18 @@ use turbopack_core::{\n use crate::parse::generate_js_source_map;\n \n #[instrument(level = Level::INFO, skip_all)]\n-pub fn minify(code: &Code, source_maps: bool, mangle: Option<MangleType>) -> Result<Code> {\n+pub async fn minify(code: Code, source_maps: bool, mangle: Option<MangleType>) -> Result<Code> {\n+    let (tx, rx) = tokio::sync::oneshot::channel();\n+\n+    rayon::spawn(move || {\n+        let result = minify_inner(code, source_maps, mangle);\n+        tx.send(result).unwrap();\n+    });\n+\n+    rx.await.unwrap()\n+}\n+\n+fn minify_inner(code: Code, source_maps: bool, mangle: Option<MangleType>) -> Result<Code> {\n     let source_maps = source_maps\n         .then(|| code.generate_source_map_ref())\n         .transpose()?;\n@@ -139,8 +150,8 @@ pub fn minify(code: &Code, source_maps: bool, mangle: Option<MangleType>) -> Res\n                 src_map_buf,\n                 Some(original_map),\n                 // We do not inline source contents.\n-                // We provide a synthesized value to `cm.new_source_file` above, so it cannot be\n-                // the value user expect anyway.\n+                // We provide a synthesized value to `cm.new_source_file` above, so it cannot\n+                // be the value user expect anyway.\n                 false,\n             )?),\n         );"
        },
        {
            "sha": "b5f073284b7c4d4d10354f6179b264f1cedeb034",
            "filename": "turbopack/crates/turbopack-nodejs/src/ecmascript/node/content.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e0c2e2aed75f06b3fea2e76649457a3c4c617306/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e0c2e2aed75f06b3fea2e76649457a3c4c617306/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs?ref=e0c2e2aed75f06b3fea2e76649457a3c4c617306",
            "patch": "@@ -78,7 +78,7 @@ impl EcmascriptBuildNodeChunkContent {\n         let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            code = minify(&code, source_maps, mangle)?;\n+            code = minify(code, source_maps, mangle).await?;\n         }\n \n         Ok(code.cell())"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 19,
        "deletions": 6
    }
}