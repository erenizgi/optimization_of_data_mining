{
    "author": "ztanner",
    "message": "[devtools]: instrument client navigation hooks for suspense devtools (#85007)\n\nVarious navigation hooks (eg `usePathname`, `useParams`) could suspend\nduring SSR/prerendering even though they don't necessarily suspend\nduring client side navigation (because it was likely part of a prefetch\nresponse). React's Suspense DevTools show all the possible things that\ncould have suspended on the page, but without us calling `use` in these\nhooks, there'd be no way for React to track them as IO in the same way\nthat we do during prerendering.\n\nIn development, this instruments all of the client navigation hooks to\ncall `use` on a fulfilled promise set to the same value that we would\nhave returned previously. For hooks like `useSelectedLayoutSegment`, I'm\nstoring a map of promises at each level of layout (because these hooks\ntake a parallel route key argument and values are relative to the\ncalling layout's position in the tree). These are eagerly pre-computed\nduring dev.",
    "sha": "7147642e4e219466c47f0f6c48ec815f95f6250d",
    "files": [
        {
            "sha": "8789c2f76717a3eae10f909ccb32ccd95d23cde3",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 42,
            "deletions": 20,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -21,6 +21,8 @@ import {\n   SearchParamsContext,\n   PathnameContext,\n   PathParamsContext,\n+  NavigationPromisesContext,\n+  type NavigationPromises,\n } from '../../shared/lib/hooks-client-context.shared-runtime'\n import { dispatchAppRouterAction, useActionQueue } from './use-action-queue'\n import { AppRouterAnnouncer } from './app-router-announcer'\n@@ -411,6 +413,22 @@ function Router({\n     return getSelectedParams(tree)\n   }, [tree])\n \n+  // Create instrumented promises for navigation hooks (dev-only)\n+  // These are specially instrumented promises to show in the Suspense DevTools\n+  // Promises are cached outside of render to survive suspense retries.\n+  let instrumentedNavigationPromises: NavigationPromises | null = null\n+  if (process.env.NODE_ENV !== 'production') {\n+    const { createRootNavigationPromises } =\n+      require('./navigation-devtools') as typeof import('./navigation-devtools')\n+\n+    instrumentedNavigationPromises = createRootNavigationPromises(\n+      tree,\n+      pathname,\n+      searchParams,\n+      pathParams\n+    )\n+  }\n+\n   const layoutRouterContext = useMemo(() => {\n     return {\n       parentTree: tree,\n@@ -510,26 +528,30 @@ function Router({\n     <>\n       <HistoryUpdater appRouterState={state} />\n       <RuntimeStyles />\n-      <PathParamsContext.Provider value={pathParams}>\n-        <PathnameContext.Provider value={pathname}>\n-          <SearchParamsContext.Provider value={searchParams}>\n-            <GlobalLayoutRouterContext.Provider\n-              value={globalLayoutRouterContext}\n-            >\n-              {/* TODO: We should be able to remove this context. useRouter\n-                  should import from app-router-instance instead. It's only\n-                  necessary because useRouter is shared between Pages and\n-                  App Router. We should fork that module, then remove this\n-                  context provider. */}\n-              <AppRouterContext.Provider value={publicAppRouterInstance}>\n-                <LayoutRouterContext.Provider value={layoutRouterContext}>\n-                  {content}\n-                </LayoutRouterContext.Provider>\n-              </AppRouterContext.Provider>\n-            </GlobalLayoutRouterContext.Provider>\n-          </SearchParamsContext.Provider>\n-        </PathnameContext.Provider>\n-      </PathParamsContext.Provider>\n+      <NavigationPromisesContext.Provider\n+        value={instrumentedNavigationPromises}\n+      >\n+        <PathParamsContext.Provider value={pathParams}>\n+          <PathnameContext.Provider value={pathname}>\n+            <SearchParamsContext.Provider value={searchParams}>\n+              <GlobalLayoutRouterContext.Provider\n+                value={globalLayoutRouterContext}\n+              >\n+                {/* TODO: We should be able to remove this context. useRouter\n+                    should import from app-router-instance instead. It's only\n+                    necessary because useRouter is shared between Pages and\n+                    App Router. We should fork that module, then remove this\n+                    context provider. */}\n+                <AppRouterContext.Provider value={publicAppRouterInstance}>\n+                  <LayoutRouterContext.Provider value={layoutRouterContext}>\n+                    {content}\n+                  </LayoutRouterContext.Provider>\n+                </AppRouterContext.Provider>\n+              </GlobalLayoutRouterContext.Provider>\n+            </SearchParamsContext.Provider>\n+          </PathnameContext.Provider>\n+        </PathParamsContext.Provider>\n+      </NavigationPromisesContext.Provider>\n     </>\n   )\n }"
        },
        {
            "sha": "006f75c543fc6b8a0a52ddb1aacdfd30ec5f6894",
            "filename": "packages/next/src/client/components/layout-router.tsx",
            "status": "modified",
            "additions": 31,
            "deletions": 1,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -43,6 +43,10 @@ import { dispatchAppRouterAction } from './use-action-queue'\n import { useRouterBFCache, type RouterBFCacheEntry } from './bfcache'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { PAGE_SEGMENT_KEY } from '../../shared/lib/segment'\n+import {\n+  NavigationPromisesContext,\n+  type NavigationPromises,\n+} from '../../shared/lib/hooks-client-context.shared-runtime'\n \n /**\n  * Add refetch marker to router state at the point of the current layout segment.\n@@ -341,6 +345,8 @@ function InnerLayoutRouter({\n   url: string\n }) {\n   const context = useContext(GlobalLayoutRouterContext)\n+  const parentNavPromises = useContext(NavigationPromisesContext)\n+\n   if (!context) {\n     throw new Error('invariant global layout router not mounted')\n   }\n@@ -421,6 +427,30 @@ function InnerLayoutRouter({\n   }\n \n   // If we get to this point, then we know we have something we can render.\n+  let content = resolvedRsc\n+\n+  // In dev, we create a NavigationPromisesContext containing the instrumented promises that provide\n+  // `useSelectedLayoutSegment` and `useSelectedLayoutSegments`.\n+  // Promises are cached outside of render to survive suspense retries.\n+  let navigationPromises: NavigationPromises | null = null\n+  if (process.env.NODE_ENV !== 'production') {\n+    const { createNestedLayoutNavigationPromises } =\n+      require('./navigation-devtools') as typeof import('./navigation-devtools')\n+\n+    navigationPromises = createNestedLayoutNavigationPromises(\n+      tree,\n+      parentNavPromises\n+    )\n+  }\n+\n+  if (navigationPromises) {\n+    content = (\n+      <NavigationPromisesContext.Provider value={navigationPromises}>\n+        {resolvedRsc}\n+      </NavigationPromisesContext.Provider>\n+    )\n+  }\n+\n   const subtree = (\n     // The layout router context narrows down tree and childNodes at each level.\n     <LayoutRouterContext.Provider\n@@ -433,7 +463,7 @@ function InnerLayoutRouter({\n         url: url,\n       }}\n     >\n-      {resolvedRsc}\n+      {content}\n     </LayoutRouterContext.Provider>\n   )\n   // Ensure root layout is not wrapped in a div as the root layout renders `<html>`"
        },
        {
            "sha": "502b2028b1a0e99d97e09f7a3d7fe4f51ad912bd",
            "filename": "packages/next/src/client/components/navigation-devtools.ts",
            "status": "added",
            "additions": 179,
            "deletions": 0,
            "changes": 179,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation-devtools.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation-devtools.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation-devtools.ts?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -0,0 +1,179 @@\n+import type { FlightRouterState } from '../../shared/lib/app-router-types'\n+import type { Params } from '../../server/request/params'\n+import {\n+  createDevToolsInstrumentedPromise,\n+  type InstrumentedPromise,\n+  type NavigationPromises,\n+} from '../../shared/lib/hooks-client-context.shared-runtime'\n+import {\n+  computeSelectedLayoutSegment,\n+  getSelectedLayoutSegmentPath,\n+} from '../../shared/lib/segment'\n+import { ReadonlyURLSearchParams } from './readonly-url-search-params'\n+\n+/**\n+ * Promises are cached by tree to ensure stability across suspense retries.\n+ */\n+type LayoutSegmentPromisesCache = {\n+  selectedLayoutSegmentPromises: Map<string, InstrumentedPromise<string | null>>\n+  selectedLayoutSegmentsPromises: Map<string, InstrumentedPromise<string[]>>\n+}\n+\n+const layoutSegmentPromisesCache = new WeakMap<\n+  FlightRouterState,\n+  LayoutSegmentPromisesCache\n+>()\n+\n+/**\n+ * Creates instrumented promises for layout segment hooks at a given tree level.\n+ * This is dev-only code for React Suspense DevTools instrumentation.\n+ */\n+export function createLayoutSegmentPromises(\n+  tree: FlightRouterState\n+): LayoutSegmentPromisesCache | null {\n+  if (process.env.NODE_ENV === 'production') {\n+    return null\n+  }\n+\n+  // Check if we already have cached promises for this tree\n+  const cached = layoutSegmentPromisesCache.get(tree)\n+  if (cached) {\n+    return cached\n+  }\n+\n+  // Create new promises and cache them\n+  const segmentPromises = new Map<string, InstrumentedPromise<string | null>>()\n+  const segmentsPromises = new Map<string, InstrumentedPromise<string[]>>()\n+\n+  const parallelRoutes = tree[1]\n+  for (const parallelRouteKey of Object.keys(parallelRoutes)) {\n+    const segments = getSelectedLayoutSegmentPath(tree, parallelRouteKey)\n+\n+    // Use the shared logic to compute the segment value\n+    const segment = computeSelectedLayoutSegment(segments, parallelRouteKey)\n+\n+    segmentPromises.set(\n+      parallelRouteKey,\n+      createDevToolsInstrumentedPromise('useSelectedLayoutSegment', segment)\n+    )\n+    segmentsPromises.set(\n+      parallelRouteKey,\n+      createDevToolsInstrumentedPromise('useSelectedLayoutSegments', segments)\n+    )\n+  }\n+\n+  const result: LayoutSegmentPromisesCache = {\n+    selectedLayoutSegmentPromises: segmentPromises,\n+    selectedLayoutSegmentsPromises: segmentsPromises,\n+  }\n+\n+  // Cache the result for future renders\n+  layoutSegmentPromisesCache.set(tree, result)\n+\n+  return result\n+}\n+\n+const rootNavigationPromisesCache = new WeakMap<\n+  FlightRouterState,\n+  Map<string, NavigationPromises>\n+>()\n+\n+/**\n+ * Creates instrumented navigation promises for the root app-router.\n+ */\n+export function createRootNavigationPromises(\n+  tree: FlightRouterState,\n+  pathname: string,\n+  searchParams: URLSearchParams,\n+  pathParams: Params\n+): NavigationPromises | null {\n+  if (process.env.NODE_ENV === 'production') {\n+    return null\n+  }\n+\n+  // Create stable cache keys from the values\n+  const searchParamsString = searchParams.toString()\n+  const pathParamsString = JSON.stringify(pathParams)\n+  const cacheKey = `${pathname}:${searchParamsString}:${pathParamsString}`\n+\n+  // Get or create the cache for this tree\n+  let treeCache = rootNavigationPromisesCache.get(tree)\n+  if (!treeCache) {\n+    treeCache = new Map<string, NavigationPromises>()\n+    rootNavigationPromisesCache.set(tree, treeCache)\n+  }\n+\n+  // Check if we have cached promises for this combination\n+  const cached = treeCache.get(cacheKey)\n+  if (cached) {\n+    return cached\n+  }\n+\n+  const readonlySearchParams = new ReadonlyURLSearchParams(searchParams)\n+\n+  const layoutSegmentPromises = createLayoutSegmentPromises(tree)\n+\n+  const promises: NavigationPromises = {\n+    pathname: createDevToolsInstrumentedPromise('usePathname', pathname),\n+    searchParams: createDevToolsInstrumentedPromise(\n+      'useSearchParams',\n+      readonlySearchParams\n+    ),\n+    params: createDevToolsInstrumentedPromise('useParams', pathParams),\n+    ...layoutSegmentPromises,\n+  }\n+\n+  treeCache.set(cacheKey, promises)\n+\n+  return promises\n+}\n+\n+const nestedLayoutPromisesCache = new WeakMap<\n+  FlightRouterState,\n+  Map<NavigationPromises | null, NavigationPromises>\n+>()\n+\n+/**\n+ * Creates merged navigation promises for nested layouts.\n+ * Merges parent promises with layout-specific segment promises.\n+ */\n+export function createNestedLayoutNavigationPromises(\n+  tree: FlightRouterState,\n+  parentNavPromises: NavigationPromises | null\n+): NavigationPromises | null {\n+  if (process.env.NODE_ENV === 'production') {\n+    return null\n+  }\n+\n+  const parallelRoutes = tree[1]\n+  const parallelRouteKeys = Object.keys(parallelRoutes)\n+\n+  // Only create promises if there are parallel routes at this level\n+  if (parallelRouteKeys.length === 0) {\n+    return null\n+  }\n+\n+  // Get or create the cache for this tree\n+  let treeCache = nestedLayoutPromisesCache.get(tree)\n+  if (!treeCache) {\n+    treeCache = new Map<NavigationPromises | null, NavigationPromises>()\n+    nestedLayoutPromisesCache.set(tree, treeCache)\n+  }\n+\n+  // Check if we have cached promises for this parent combination\n+  const cached = treeCache.get(parentNavPromises)\n+  if (cached) {\n+    return cached\n+  }\n+\n+  // Create merged promises\n+  const layoutSegmentPromises = createLayoutSegmentPromises(tree)\n+  const promises: NavigationPromises = {\n+    ...parentNavPromises!,\n+    ...layoutSegmentPromises,\n+  }\n+\n+  treeCache.set(parentNavPromises, promises)\n+\n+  return promises\n+}"
        },
        {
            "sha": "bb6aacd01388899c77fbb9f14dbee3cb99837451",
            "filename": "packages/next/src/client/components/navigation.react-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 27,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.react-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.react-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.react-server.ts?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -1,30 +1,4 @@\n-/** @internal */\n-class ReadonlyURLSearchParamsError extends Error {\n-  constructor() {\n-    super(\n-      'Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams'\n-    )\n-  }\n-}\n-\n-class ReadonlyURLSearchParams extends URLSearchParams {\n-  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n-  append() {\n-    throw new ReadonlyURLSearchParamsError()\n-  }\n-  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n-  delete() {\n-    throw new ReadonlyURLSearchParamsError()\n-  }\n-  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n-  set() {\n-    throw new ReadonlyURLSearchParamsError()\n-  }\n-  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n-  sort() {\n-    throw new ReadonlyURLSearchParamsError()\n-  }\n-}\n+import { ReadonlyURLSearchParams } from './readonly-url-search-params'\n \n export function unstable_isUnrecognizedActionError(): boolean {\n   throw new Error("
        },
        {
            "sha": "9ea6b56a9055d8c0ee323736d48739bfe8546490",
            "filename": "packages/next/src/client/components/navigation.ts",
            "status": "modified",
            "additions": 59,
            "deletions": 54,
            "changes": 113,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -1,7 +1,6 @@\n-import type { FlightRouterState } from '../../shared/lib/app-router-types'\n import type { Params } from '../../server/request/params'\n \n-import { useContext, useMemo } from 'react'\n+import { useContext, useMemo, use } from 'react'\n import {\n   AppRouterContext,\n   LayoutRouterContext,\n@@ -11,10 +10,13 @@ import {\n   SearchParamsContext,\n   PathnameContext,\n   PathParamsContext,\n+  NavigationPromisesContext,\n } from '../../shared/lib/hooks-client-context.shared-runtime'\n-import { getSegmentValue } from './router-reducer/reducers/get-segment-value'\n-import { PAGE_SEGMENT_KEY, DEFAULT_SEGMENT_KEY } from '../../shared/lib/segment'\n-import { ReadonlyURLSearchParams } from './navigation.react-server'\n+import {\n+  computeSelectedLayoutSegment,\n+  getSelectedLayoutSegmentPath,\n+} from '../../shared/lib/segment'\n+import { ReadonlyURLSearchParams } from './readonly-url-search-params'\n \n const useDynamicRouteParams =\n   typeof window === 'undefined'\n@@ -69,6 +71,14 @@ export function useSearchParams(): ReadonlyURLSearchParams {\n     return new ReadonlyURLSearchParams(searchParams)\n   }, [searchParams]) as ReadonlyURLSearchParams\n \n+  // Instrument with Suspense DevTools (dev-only)\n+  if (process.env.NODE_ENV !== 'production') {\n+    const navigationPromises = use(NavigationPromisesContext)\n+    if (navigationPromises) {\n+      return use(navigationPromises.searchParams)\n+    }\n+  }\n+\n   return readonlySearchParams\n }\n \n@@ -95,7 +105,17 @@ export function usePathname(): string {\n \n   // In the case where this is `null`, the compat types added in `next-env.d.ts`\n   // will add a new overload that changes the return type to include `null`.\n-  return useContext(PathnameContext) as string\n+  const pathname = useContext(PathnameContext) as string\n+\n+  // Instrument with Suspense DevTools (dev-only)\n+  if (process.env.NODE_ENV !== 'production') {\n+    const navigationPromises = use(NavigationPromisesContext)\n+    if (navigationPromises) {\n+      return use(navigationPromises.pathname)\n+    }\n+  }\n+\n+  return pathname\n }\n \n // Client components API\n@@ -153,44 +173,17 @@ export function useRouter(): AppRouterInstance {\n export function useParams<T extends Params = Params>(): T {\n   useDynamicRouteParams?.('useParams()')\n \n-  return useContext(PathParamsContext) as T\n-}\n+  const params = useContext(PathParamsContext) as T\n \n-/** Get the canonical parameters from the current level to the leaf node. */\n-// Client components API\n-function getSelectedLayoutSegmentPath(\n-  tree: FlightRouterState,\n-  parallelRouteKey: string,\n-  first = true,\n-  segmentPath: string[] = []\n-): string[] {\n-  let node: FlightRouterState\n-  if (first) {\n-    // Use the provided parallel route key on the first parallel route\n-    node = tree[1][parallelRouteKey]\n-  } else {\n-    // After first parallel route prefer children, if there's no children pick the first parallel route.\n-    const parallelRoutes = tree[1]\n-    node = parallelRoutes.children ?? Object.values(parallelRoutes)[0]\n-  }\n-\n-  if (!node) return segmentPath\n-  const segment = node[0]\n-\n-  let segmentValue = getSegmentValue(segment)\n-\n-  if (!segmentValue || segmentValue.startsWith(PAGE_SEGMENT_KEY)) {\n-    return segmentPath\n+  // Instrument with Suspense DevTools (dev-only)\n+  if (process.env.NODE_ENV !== 'production') {\n+    const navigationPromises = use(NavigationPromisesContext)\n+    if (navigationPromises) {\n+      return use(navigationPromises.params) as T\n+    }\n   }\n \n-  segmentPath.push(segmentValue)\n-\n-  return getSelectedLayoutSegmentPath(\n-    node,\n-    parallelRouteKey,\n-    false,\n-    segmentPath\n-  )\n+  return params\n }\n \n /**\n@@ -228,6 +221,20 @@ export function useSelectedLayoutSegments(\n   // @ts-expect-error This only happens in `pages`. Type is overwritten in navigation.d.ts\n   if (!context) return null\n \n+  // Instrument with Suspense DevTools (dev-only)\n+  if (process.env.NODE_ENV !== 'production') {\n+    const navigationPromises = use(NavigationPromisesContext)\n+    if (navigationPromises) {\n+      const promise =\n+        navigationPromises.selectedLayoutSegmentsPromises?.get(parallelRouteKey)\n+      if (promise) {\n+        // We should always have a promise here, but if we don't, it's not worth erroring over.\n+        // We just won't be able to instrument it, but can still provide the value.\n+        return use(promise)\n+      }\n+    }\n+  }\n+\n   return getSelectedLayoutSegmentPath(context.parentTree, parallelRouteKey)\n }\n \n@@ -254,23 +261,21 @@ export function useSelectedLayoutSegment(\n   parallelRouteKey: string = 'children'\n ): string | null {\n   useDynamicRouteParams?.('useSelectedLayoutSegment()')\n-\n+  const navigationPromises = useContext(NavigationPromisesContext)\n   const selectedLayoutSegments = useSelectedLayoutSegments(parallelRouteKey)\n \n-  if (!selectedLayoutSegments || selectedLayoutSegments.length === 0) {\n-    return null\n+  // Instrument with Suspense DevTools (dev-only)\n+  if (process.env.NODE_ENV !== 'production' && navigationPromises) {\n+    const promise =\n+      navigationPromises.selectedLayoutSegmentPromises?.get(parallelRouteKey)\n+    if (promise) {\n+      // We should always have a promise here, but if we don't, it's not worth erroring over.\n+      // We just won't be able to instrument it, but can still provide the value.\n+      return use(promise)\n+    }\n   }\n \n-  const selectedLayoutSegment =\n-    parallelRouteKey === 'children'\n-      ? selectedLayoutSegments[0]\n-      : selectedLayoutSegments[selectedLayoutSegments.length - 1]\n-\n-  // if the default slot is showing, we return null since it's not technically \"selected\" (it's a fallback)\n-  // and returning an internal value like `__DEFAULT__` would be confusing.\n-  return selectedLayoutSegment === DEFAULT_SEGMENT_KEY\n-    ? null\n-    : selectedLayoutSegment\n+  return computeSelectedLayoutSegment(selectedLayoutSegments, parallelRouteKey)\n }\n \n export { unstable_isUnrecognizedActionError } from './unrecognized-action-error'"
        },
        {
            "sha": "3cbc9640a1c2b73258ce07bb2b64c6a6841af4dc",
            "filename": "packages/next/src/client/components/readonly-url-search-params.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freadonly-url-search-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freadonly-url-search-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freadonly-url-search-params.ts?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -0,0 +1,37 @@\n+/**\n+ * ReadonlyURLSearchParams implementation shared between client and server.\n+ * This file is intentionally not marked as 'use client' or 'use server'\n+ * so it can be imported by both environments.\n+ */\n+\n+/** @internal */\n+class ReadonlyURLSearchParamsError extends Error {\n+  constructor() {\n+    super(\n+      'Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams'\n+    )\n+  }\n+}\n+\n+/**\n+ * A read-only version of URLSearchParams that throws errors when mutation methods are called.\n+ * This ensures that the URLSearchParams returned by useSearchParams() cannot be mutated.\n+ */\n+export class ReadonlyURLSearchParams extends URLSearchParams {\n+  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n+  append() {\n+    throw new ReadonlyURLSearchParamsError()\n+  }\n+  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n+  delete() {\n+    throw new ReadonlyURLSearchParamsError()\n+  }\n+  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n+  set() {\n+    throw new ReadonlyURLSearchParamsError()\n+  }\n+  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n+  sort() {\n+    throw new ReadonlyURLSearchParamsError()\n+  }\n+}"
        },
        {
            "sha": "dda19a45fb22e94b79dcb1cf643cd2499ac99e85",
            "filename": "packages/next/src/client/components/router-reducer/reducers/get-segment-value.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/358e1a4d5787b51e17b34d2f84f1bca41f0a5058/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fget-segment-value.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/358e1a4d5787b51e17b34d2f84f1bca41f0a5058/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fget-segment-value.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fget-segment-value.ts?ref=358e1a4d5787b51e17b34d2f84f1bca41f0a5058",
            "patch": "@@ -1,5 +0,0 @@\n-import type { Segment } from '../../../../shared/lib/app-router-types'\n-\n-export function getSegmentValue(segment: Segment) {\n-  return Array.isArray(segment) ? segment[1] : segment\n-}"
        },
        {
            "sha": "aeb0015c8e5000c363a986c3ed1b00f094fad5a3",
            "filename": "packages/next/src/shared/lib/hooks-client-context.shared-runtime.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fhooks-client-context.shared-runtime.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fhooks-client-context.shared-runtime.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fhooks-client-context.shared-runtime.ts?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -7,8 +7,46 @@ export const SearchParamsContext = createContext<URLSearchParams | null>(null)\n export const PathnameContext = createContext<string | null>(null)\n export const PathParamsContext = createContext<Params | null>(null)\n \n+// Dev-only context for Suspense DevTools instrumentation\n+// These promises are used to track navigation hook usage in React DevTools\n+export type InstrumentedPromise<T> = Promise<T> & {\n+  status: 'fulfilled'\n+  value: T\n+  displayName: string\n+}\n+\n+export type NavigationPromises = {\n+  pathname: InstrumentedPromise<string>\n+  searchParams: InstrumentedPromise<any> // ReadonlyURLSearchParams\n+  params: InstrumentedPromise<any> // Params\n+  // Layout segment hooks (updated at each layout boundary)\n+  selectedLayoutSegmentPromises?: Map<\n+    string,\n+    InstrumentedPromise<string | null>\n+  >\n+  selectedLayoutSegmentsPromises?: Map<string, InstrumentedPromise<string[]>>\n+}\n+\n+export const NavigationPromisesContext =\n+  createContext<NavigationPromises | null>(null)\n+\n+// Creates an instrumented promise for Suspense DevTools\n+// These promises are always fulfilled and exist purely for\n+// tracking in React's Suspense DevTools.\n+export function createDevToolsInstrumentedPromise<T>(\n+  displayName: string,\n+  value: T\n+): InstrumentedPromise<T> {\n+  const promise = Promise.resolve(value) as InstrumentedPromise<T>\n+  promise.status = 'fulfilled'\n+  promise.value = value\n+  promise.displayName = `${displayName} (SSR)`\n+  return promise\n+}\n+\n if (process.env.NODE_ENV !== 'production') {\n   SearchParamsContext.displayName = 'SearchParamsContext'\n   PathnameContext.displayName = 'PathnameContext'\n   PathParamsContext.displayName = 'PathParamsContext'\n+  NavigationPromisesContext.displayName = 'NavigationPromisesContext'\n }"
        },
        {
            "sha": "ec0c23317fe0774e72454c6a0931f00eea9a5063",
            "filename": "packages/next/src/shared/lib/segment.test.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsegment.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsegment.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsegment.test.ts?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -1,4 +1,4 @@\n-import { getSegmentValue } from './reducers/get-segment-value'\n+import { getSegmentValue } from './segment'\n \n describe('getSegmentValue', () => {\n   it('should support string segment', () => {",
            "previous_filename": "packages/next/src/client/components/router-reducer/get-segment-value.test.ts"
        },
        {
            "sha": "4da4cb75deb907392928035fa0c4889d72612092",
            "filename": "packages/next/src/shared/lib/segment.ts",
            "status": "modified",
            "additions": 60,
            "deletions": 1,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsegment.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsegment.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsegment.ts?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -1,4 +1,8 @@\n-import type { Segment } from './app-router-types'\n+import type { FlightRouterState, Segment } from './app-router-types'\n+\n+export function getSegmentValue(segment: Segment) {\n+  return Array.isArray(segment) ? segment[1] : segment\n+}\n \n export function isGroupSegment(segment: string) {\n   // Use array[0] for performant purpose\n@@ -25,5 +29,60 @@ export function addSearchParamsIfPageSegment(\n   return segment\n }\n \n+export function computeSelectedLayoutSegment(\n+  segments: string[] | null,\n+  parallelRouteKey: string\n+): string | null {\n+  if (!segments || segments.length === 0) {\n+    return null\n+  }\n+\n+  // For 'children', use first segment; for other parallel routes, use last segment\n+  const rawSegment =\n+    parallelRouteKey === 'children'\n+      ? segments[0]\n+      : segments[segments.length - 1]\n+\n+  // If the default slot is showing, return null since it's not technically \"selected\" (it's a fallback)\n+  // Returning an internal value like `__DEFAULT__` would be confusing\n+  return rawSegment === DEFAULT_SEGMENT_KEY ? null : rawSegment\n+}\n+\n+/** Get the canonical parameters from the current level to the leaf node. */\n+export function getSelectedLayoutSegmentPath(\n+  tree: FlightRouterState,\n+  parallelRouteKey: string,\n+  first = true,\n+  segmentPath: string[] = []\n+): string[] {\n+  let node: FlightRouterState\n+  if (first) {\n+    // Use the provided parallel route key on the first parallel route\n+    node = tree[1][parallelRouteKey]\n+  } else {\n+    // After first parallel route prefer children, if there's no children pick the first parallel route.\n+    const parallelRoutes = tree[1]\n+    node = parallelRoutes.children ?? Object.values(parallelRoutes)[0]\n+  }\n+\n+  if (!node) return segmentPath\n+  const segment = node[0]\n+\n+  let segmentValue = getSegmentValue(segment)\n+\n+  if (!segmentValue || segmentValue.startsWith(PAGE_SEGMENT_KEY)) {\n+    return segmentPath\n+  }\n+\n+  segmentPath.push(segmentValue)\n+\n+  return getSelectedLayoutSegmentPath(\n+    node,\n+    parallelRouteKey,\n+    false,\n+    segmentPath\n+  )\n+}\n+\n export const PAGE_SEGMENT_KEY = '__PAGE__'\n export const DEFAULT_SEGMENT_KEY = '__DEFAULT__'"
        },
        {
            "sha": "97a1e335751db780d85e1bdcbf813846fd27bebd",
            "filename": "test/development/acceptance-app/hydration-error.test.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 44,
            "changes": 84,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -142,27 +142,26 @@ describe('Error overlay for hydration errors in App router', () => {\n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n          \"componentStack\": \"...\n-           <RenderFromTemplateContext>\n-             <ScrollAndFocusHandler segmentPath={[...]}>\n-               <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n-                 <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n-                   <LoadingBoundary loading={null}>\n-                     <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                       <HTTPAccessFallbackErrorBoundary pathname=\"/extra-att...\" notFound={<SegmentViewNode>} ...>\n-                         <RedirectBoundary>\n-                           <RedirectErrorBoundary router={{...}}>\n-                             <InnerLayoutRouter url=\"/extra-att...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n-                               <SegmentViewNode type=\"layout\" pagePath=\"(extra-att...\">\n-                                 <SegmentTrieNode>\n-                                 <script>\n-                                 <script>\n-                                 <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n-                                   <Root params={Promise}>\n-                                     <html\n-       -                               className=\"server-html\"\n-                                     >\n-                             ...\n-                 ...\",\n+           <ScrollAndFocusHandler segmentPath={[...]}>\n+             <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+               <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                 <LoadingBoundary loading={null}>\n+                   <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n+                     <HTTPAccessFallbackErrorBoundary pathname=\"/extra-att...\" notFound={<SegmentViewNode>} ...>\n+                       <RedirectBoundary>\n+                         <RedirectErrorBoundary router={{...}}>\n+                           <InnerLayoutRouter url=\"/extra-att...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                             <SegmentViewNode type=\"layout\" pagePath=\"(extra-att...\">\n+                               <SegmentTrieNode>\n+                               <script>\n+                               <script>\n+                               <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n+                                 <Root params={Promise}>\n+                                   <html\n+       -                             className=\"server-html\"\n+                                   >\n+                           ...\n+               ...\",\n          \"description\": \"A tree hydrated but some attributes of the server rendered HTML didn't match the client properties. This won't be patched up. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Console Error\",\n@@ -179,25 +178,24 @@ describe('Error overlay for hydration errors in App router', () => {\n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n          \"componentStack\": \"...\n-           <RenderFromTemplateContext>\n-             <ScrollAndFocusHandler segmentPath={[...]}>\n-               <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n-                 <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n-                   <LoadingBoundary loading={null}>\n-                     <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                       <HTTPAccessFallbackErrorBoundary pathname=\"/extra-att...\" notFound={<SegmentViewNode>} ...>\n-                         <RedirectBoundary>\n-                           <RedirectErrorBoundary router={{...}}>\n-                             <InnerLayoutRouter url=\"/extra-att...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n-                               <SegmentViewNode type=\"layout\" pagePath=\"(extra-att...\">\n-                                 <SegmentTrieNode>\n-                                 <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n-                                   <Root params={Promise}>\n-                                     <html\n-       -                               className=\"server-html\"\n-                                     >\n-                             ...\n-                 ...\",\n+           <ScrollAndFocusHandler segmentPath={[...]}>\n+             <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+               <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                 <LoadingBoundary loading={null}>\n+                   <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n+                     <HTTPAccessFallbackErrorBoundary pathname=\"/extra-att...\" notFound={<SegmentViewNode>} ...>\n+                       <RedirectBoundary>\n+                         <RedirectErrorBoundary router={{...}}>\n+                           <InnerLayoutRouter url=\"/extra-att...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                             <SegmentViewNode type=\"layout\" pagePath=\"(extra-att...\">\n+                               <SegmentTrieNode>\n+                               <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n+                                 <Root params={Promise}>\n+                                   <html\n+       -                             className=\"server-html\"\n+                                   >\n+                           ...\n+               ...\",\n          \"description\": \"A tree hydrated but some attributes of the server rendered HTML didn't match the client properties. This won't be patched up. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Console Error\",\n@@ -920,8 +918,7 @@ describe('Error overlay for hydration errors in App router', () => {\n                                        <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n          >                               <script nonce={undefined} dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}>\n                                ...\n-                   ...\n-             ...\",\n+                   ...\",\n              \"description\": \"In HTML, <script> cannot be a child of <html>.\n          This will cause a hydration error.\",\n              \"environmentLabel\": null,\n@@ -983,8 +980,7 @@ describe('Error overlay for hydration errors in App router', () => {\n                                        <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n          >                               <script nonce={undefined} dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}>\n                                ...\n-                   ...\n-             ...\",\n+                   ...\",\n              \"description\": \"In HTML, <script> cannot be a child of <html>.\n          This will cause a hydration error.\",\n              \"environmentLabel\": null,"
        },
        {
            "sha": "ea02542cba54f13a4d52972e02a3224e62b7cb42",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 24,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/7147642e4e219466c47f0f6c48ec815f95f6250d/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7147642e4e219466c47f0f6c48ec815f95f6250d/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=7147642e4e219466c47f0f6c48ec815f95f6250d",
            "patch": "@@ -238,13 +238,13 @@ describe('Cache Components Errors', () => {\n                    at ScrollAndFocusHandler (bundler:///<next-src>)\n                    at RenderFromTemplateContext (bundler:///<next-src>)\n                    at OuterLayoutRouter (bundler:///<next-src>)\n-                 331 |  */\n-                 332 | function InnerLayoutRouter({\n-               > 333 |   tree,\n+                 335 |  */\n+                 336 | function InnerLayoutRouter({\n+               > 337 |   tree,\n                      |   ^\n-                 334 |   segmentPath,\n-                 335 |   cacheNode,\n-                 336 |   url,\n+                 338 |   segmentPath,\n+                 339 |   cacheNode,\n+                 340 |   url,\n                To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/dynamic-metadata-error-route\" in your browser to investigate the error.\n                Error occurred prerendering page \"/dynamic-metadata-error-route\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n@@ -745,13 +745,13 @@ describe('Cache Components Errors', () => {\n                    at ScrollAndFocusHandler (bundler:///<next-src>)\n                    at RenderFromTemplateContext (bundler:///<next-src>)\n                    at OuterLayoutRouter (bundler:///<next-src>)\n-                 331 |  */\n-                 332 | function InnerLayoutRouter({\n-               > 333 |   tree,\n+                 335 |  */\n+                 336 | function InnerLayoutRouter({\n+               > 337 |   tree,\n                      |   ^\n-                 334 |   segmentPath,\n-                 335 |   cacheNode,\n-                 336 |   url,\n+                 338 |   segmentPath,\n+                 339 |   cacheNode,\n+                 340 |   url,\n                To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/dynamic-root\" in your browser to investigate the error.\n                Error occurred prerendering page \"/dynamic-root\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n@@ -2141,13 +2141,13 @@ describe('Cache Components Errors', () => {\n                      at ScrollAndFocusHandler (bundler:///<next-src>)\n                      at RenderFromTemplateContext (<anonymous>)\n                      at OuterLayoutRouter (bundler:///<next-src>)\n-                   331 |  */\n-                   332 | function InnerLayoutRouter({\n-                 > 333 |   tree,\n+                   335 |  */\n+                   336 | function InnerLayoutRouter({\n+                 > 337 |   tree,\n                        |   ^\n-                   334 |   segmentPath,\n-                   335 |   cacheNode,\n-                   336 |   url,\n+                   338 |   segmentPath,\n+                   339 |   cacheNode,\n+                   340 |   url,\n                  To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/sync-attribution/unguarded-async-guarded-clientsync\" in your browser to investigate the error.\n                  Error occurred prerendering page \"/sync-attribution/unguarded-async-guarded-clientsync\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n@@ -3157,13 +3157,13 @@ describe('Cache Components Errors', () => {\n                      at ScrollAndFocusHandler (bundler:///<next-src>)\n                      at RenderFromTemplateContext (bundler:///<next-src>)\n                      at OuterLayoutRouter (bundler:///<next-src>)\n-                   331 |  */\n-                   332 | function InnerLayoutRouter({\n-                 > 333 |   tree,\n+                   335 |  */\n+                   336 | function InnerLayoutRouter({\n+                 > 337 |   tree,\n                        |   ^\n-                   334 |   segmentPath,\n-                   335 |   cacheNode,\n-                   336 |   url,\n+                   338 |   segmentPath,\n+                   339 |   cacheNode,\n+                   340 |   url,\n                  To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-without-suspense\" in your browser to investigate the error.\n                  Error occurred prerendering page \"/use-cache-private-without-suspense\". Read more: https://nextjs.org/docs/messages/prerender-error\n "
        }
    ],
    "stats": {
        "total": 689,
        "additions": 512,
        "deletions": 177
    }
}