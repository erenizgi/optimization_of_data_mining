{
    "author": "timneutkens",
    "message": "Turbopack build: Switch to using workerthreads for process (#84818)\n\n## What?\n\nSwitches the worker booted to run Turbopack build (for fast memory\ncleanup when this step is done) to using worker threads instead of child\nprocess.",
    "sha": "ef16156880a1c6c300b5680fe3a0d096bf31f2cb",
    "files": [
        {
            "sha": "108ad29e211635fd220b314fb57679b0da2896f3",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/ef16156880a1c6c300b5680fe3a0d096bf31f2cb/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef16156880a1c6c300b5680fe3a0d096bf31f2cb/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=ef16156880a1c6c300b5680fe3a0d096bf31f2cb",
            "patch": "@@ -210,7 +210,9 @@ export async function turbopackBuild(): Promise<{\n let shutdownPromise: Promise<void> | undefined\n export async function workerMain(workerData: {\n   buildContext: typeof NextBuildContext\n-}): Promise<Awaited<ReturnType<typeof turbopackBuild>>> {\n+}): Promise<\n+  Omit<Awaited<ReturnType<typeof turbopackBuild>>, 'shutdownPromise'>\n+> {\n   // setup new build context from the serialized data passed from the parent\n   Object.assign(NextBuildContext, workerData.buildContext)\n \n@@ -234,9 +236,16 @@ export async function workerMain(workerData: {\n   })\n   setGlobal('telemetry', telemetry)\n \n-  const result = await turbopackBuild()\n-  shutdownPromise = result.shutdownPromise\n-  return result\n+  const {\n+    shutdownPromise: resultShutdownPromise,\n+    buildTraceContext,\n+    duration,\n+  } = await turbopackBuild()\n+  shutdownPromise = resultShutdownPromise\n+  return {\n+    buildTraceContext,\n+    duration,\n+  }\n }\n \n export async function waitForShutdown(): Promise<void> {"
        },
        {
            "sha": "3317941ea309243462b112a08854c3bd3530786c",
            "filename": "packages/next/src/build/turbopack-build/index.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 10,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/ef16156880a1c6c300b5680fe3a0d096bf31f2cb/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef16156880a1c6c300b5680fe3a0d096bf31f2cb/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts?ref=ef16156880a1c6c300b5680fe3a0d096bf31f2cb",
            "patch": "@@ -3,10 +3,13 @@ import path from 'path'\n import { Worker } from '../../lib/worker'\n import { NextBuildContext } from '../build-context'\n \n-async function turbopackBuildWithWorker() {\n+async function turbopackBuildWithWorker(): ReturnType<\n+  typeof import('./impl').turbopackBuild\n+> {\n   try {\n     const worker = new Worker(path.join(__dirname, 'impl.js'), {\n       exposedMethods: ['workerMain', 'waitForShutdown'],\n+      enableWorkerThreads: true,\n       debuggerPortOffset: -1,\n       isolatedMemory: false,\n       numWorkers: 1,\n@@ -17,18 +20,25 @@ async function turbopackBuildWithWorker() {\n         },\n       },\n     }) as Worker & typeof import('./impl')\n-    const { nextBuildSpan, ...prunedBuildContext } = NextBuildContext\n-    const result = await worker.workerMain({\n+    const {\n+      nextBuildSpan,\n+      // Config is not serializable and is loaded in the worker.\n+      config: _config,\n+      ...prunedBuildContext\n+    } = NextBuildContext\n+    const { buildTraceContext, duration } = await worker.workerMain({\n       buildContext: prunedBuildContext,\n     })\n \n-    // destroy worker when Turbopack has shutdown so it's not sticking around using memory\n-    // We need to wait for shutdown to make sure filesystem cache is flushed\n-    result.shutdownPromise = worker.waitForShutdown().then(() => {\n-      worker.end()\n-    })\n-\n-    return result\n+    return {\n+      // destroy worker when Turbopack has shutdown so it's not sticking around using memory\n+      // We need to wait for shutdown to make sure filesystem cache is flushed\n+      shutdownPromise: worker.waitForShutdown().then(() => {\n+        worker.end()\n+      }),\n+      buildTraceContext,\n+      duration,\n+    }\n   } catch (err: any) {\n     // When the error is a serialized `Error` object we need to recreate the `Error` instance\n     // in order to keep the consistent error reporting behavior."
        }
    ],
    "stats": {
        "total": 47,
        "additions": 33,
        "deletions": 14
    }
}