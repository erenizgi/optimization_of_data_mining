{
    "author": "mischnic",
    "message": "Turbopack: throw large static metadata error earlier (#82939)\n\nThrow it during bundling, as opposed to at runtime.\n\nThis circumnavigates a panic in Turbopack when inlining a 40mb string into a JS module.",
    "sha": "d6794f43c19ef3d64ac7bcc7bbe47433c95d42f9",
    "files": [
        {
            "sha": "9b9796de753348b114bee05acbf96728760caaab",
            "filename": "crates/next-core/src/next_app/metadata/route.rs",
            "status": "modified",
            "additions": 88,
            "deletions": 23,
            "changes": 111,
            "blob_url": "https://github.com/vercel/next.js/blob/d6794f43c19ef3d64ac7bcc7bbe47433c95d42f9/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d6794f43c19ef3d64ac7bcc7bbe47433c95d42f9/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs?ref=d6794f43c19ef3d64ac7bcc7bbe47433c95d42f9",
            "patch": "@@ -5,12 +5,16 @@\n use anyhow::{Ok, Result, bail};\n use base64::{display::Base64Display, engine::general_purpose::STANDARD};\n use indoc::{formatdoc, indoc};\n-use turbo_rcstr::rcstr;\n+use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::Vc;\n use turbo_tasks_fs::{self, File, FileContent, FileSystemPath};\n use turbopack::ModuleAssetContext;\n use turbopack_core::{\n-    asset::AssetContent, file_source::FileSource, source::Source, virtual_source::VirtualSource,\n+    asset::AssetContent,\n+    file_source::FileSource,\n+    issue::{Issue, IssueExt, IssueSeverity, IssueStage, OptionStyledString, StyledString},\n+    source::Source,\n+    virtual_source::VirtualSource,\n };\n use turbopack_ecmascript::utils::StringifyJs;\n \n@@ -133,8 +137,6 @@ async fn static_route_source(mode: NextMode, path: FileSystemPath) -> Result<Vc<\n     let stem = path.file_stem();\n     let stem = stem.unwrap_or_default();\n \n-    let content_type = get_content_type(path.clone()).await?;\n-\n     let cache_control = if stem == \"favicon\" {\n         CACHE_HEADER_REVALIDATE\n     } else if mode.is_production() {\n@@ -143,16 +145,40 @@ async fn static_route_source(mode: NextMode, path: FileSystemPath) -> Result<Vc<\n         CACHE_HEADER_NONE\n     };\n \n-    let original_file_content_b64 = get_base64_file_content(path.clone()).await?;\n-\n     let is_twitter = stem == \"twitter-image\";\n     let is_open_graph = stem == \"opengraph-image\";\n+\n+    let content_type = get_content_type(path.clone()).await?;\n+    let original_file_content_b64;\n+\n     // Twitter image file size limit is 5MB.\n     // General Open Graph image file size limit is 8MB.\n     // x-ref: https://developer.x.com/en/docs/x-for-websites/cards/overview/summary\n     // x-ref(facebook): https://developers.facebook.com/docs/sharing/webmasters/images\n-    let file_size_limit = if is_twitter { 5 } else { 8 };\n-    let img_name = if is_twitter { \"Twitter\" } else { \"Open Graph\" };\n+    let file_size_limit_mb = if is_twitter { 5 } else { 8 };\n+    if (is_twitter || is_open_graph)\n+        && let Some(content) = path.read().await?.as_content()\n+        && let file_size = content.content().to_bytes().len()\n+        && file_size > (file_size_limit_mb * 1024 * 1024)\n+    {\n+        StaticMetadataFileSizeIssue {\n+            img_name: if is_twitter {\n+                rcstr!(\"Twitter\")\n+            } else {\n+                rcstr!(\"Open Graph\")\n+            },\n+            path: path.clone(),\n+            file_size_limit_mb,\n+            file_size,\n+        }\n+        .resolved_cell()\n+        .emit();\n+\n+        // Don't inline huge string, just insert placeholder\n+        original_file_content_b64 = \"\".to_string();\n+    } else {\n+        original_file_content_b64 = get_base64_file_content(path.clone()).await?\n+    }\n \n     let code = formatdoc! {\n         r#\"\n@@ -162,16 +188,6 @@ async fn static_route_source(mode: NextMode, path: FileSystemPath) -> Result<Vc<\n             const cacheControl = {cache_control}\n             const buffer = Buffer.from({original_file_content_b64}, 'base64')\n \n-            if ({is_twitter} || {is_open_graph}) {{\n-                const fileSizeInMB = buffer.byteLength / 1024 / 1024\n-                if (fileSizeInMB > {file_size_limit}) {{\n-                    throw new Error('File size for {img_name} image {path} exceeds {file_size_limit}MB. ' +\n-                    `(Current: ${{fileSizeInMB.toFixed(2)}}MB)\\n` +\n-                    'Read more: https://nextjs.org/docs/app/api-reference/file-conventions/metadata/opengraph-image#image-files-jpg-png-gif'\n-                    )\n-                }}\n-            }}\n-\n             export function GET() {{\n                 return new NextResponse(buffer, {{\n                     headers: {{\n@@ -186,11 +202,6 @@ async fn static_route_source(mode: NextMode, path: FileSystemPath) -> Result<Vc<\n         content_type = StringifyJs(&content_type),\n         cache_control = StringifyJs(cache_control),\n         original_file_content_b64 = StringifyJs(&original_file_content_b64),\n-        is_twitter = is_twitter,\n-        is_open_graph = is_open_graph,\n-        file_size_limit = file_size_limit,\n-        img_name = img_name,\n-        path = StringifyJs(&path.value_to_string().await?),\n     };\n \n     let file = File::from(code);\n@@ -412,3 +423,57 @@ async fn dynamic_image_route_source(path: FileSystemPath) -> Result<Vc<Box<dyn S\n \n     Ok(Vc::upcast(source))\n }\n+\n+#[turbo_tasks::value(shared)]\n+struct StaticMetadataFileSizeIssue {\n+    img_name: RcStr,\n+    path: FileSystemPath,\n+    file_size: usize,\n+    file_size_limit_mb: usize,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl Issue for StaticMetadataFileSizeIssue {\n+    fn severity(&self) -> IssueSeverity {\n+        IssueSeverity::Error\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn title(&self) -> Vc<StyledString> {\n+        StyledString::Text(rcstr!(\"Static metadata file size exceeded\")).cell()\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn stage(&self) -> Vc<IssueStage> {\n+        IssueStage::ProcessModule.into()\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn file_path(&self) -> Vc<FileSystemPath> {\n+        self.path.clone().cell()\n+    }\n+\n+    #[turbo_tasks::function]\n+    async fn description(&self) -> Result<Vc<OptionStyledString>> {\n+        Ok(Vc::cell(Some(\n+            StyledString::Text(\n+                format!(\n+                    \"File size for {} image \\\"{}\\\" exceeds {}MB. (Current: {:.1}MB)\",\n+                    self.img_name,\n+                    self.path.value_to_string().await?,\n+                    self.file_size_limit_mb,\n+                    (self.file_size as f32) / 1024.0 / 1024.0\n+                )\n+                .into(),\n+            )\n+            .resolved_cell(),\n+        )))\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn documentation_link(&self) -> Vc<RcStr> {\n+        Vc::cell(rcstr!(\n+            \"https://nextjs.org/docs/app/api-reference/file-conventions/metadata/opengraph-image#image-files-jpg-png-gif\"\n+        ))\n+    }\n+}"
        },
        {
            "sha": "f940b64d569a80078b64fd675bd6e0d6b7f40e6f",
            "filename": "test/production/app-dir/metadata-img-too-large/opengraph-image/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d6794f43c19ef3d64ac7bcc7bbe47433c95d42f9/test%2Fproduction%2Fapp-dir%2Fmetadata-img-too-large%2Fopengraph-image%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6794f43c19ef3d64ac7bcc7bbe47433c95d42f9/test%2Fproduction%2Fapp-dir%2Fmetadata-img-too-large%2Fopengraph-image%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-img-too-large%2Fopengraph-image%2Findex.test.ts?ref=d6794f43c19ef3d64ac7bcc7bbe47433c95d42f9",
            "patch": "@@ -14,8 +14,8 @@ describe('app-dir - metadata-img-too-large opengraph-image', () => {\n     await next.build()\n \n     const regex = isTurbopack\n-      ? // in Turbopack, the path is simplified as [project]/...\n-        /Error: File size for Open Graph image \"\\[project\\]\\/app\\/opengraph-image\\.png\" exceeds 8MB/\n+      ? // in Turbopack, the path is simplified as [project]/.... It's also thrown earlier, so the prefix is slightly different.\n+        /File size for Open Graph image \"\\[project\\]\\/app\\/opengraph-image\\.png\" exceeds 8MB/\n       : /Error: File size for Open Graph image \".*\\/app\\/opengraph-image\\.png\" exceeds 8MB/\n \n     expect(next.cliOutput).toMatch(regex)"
        },
        {
            "sha": "07dc470a5c62891ef5ae35aebd3877aa2a3ceaeb",
            "filename": "test/production/app-dir/metadata-img-too-large/twitter-image/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d6794f43c19ef3d64ac7bcc7bbe47433c95d42f9/test%2Fproduction%2Fapp-dir%2Fmetadata-img-too-large%2Ftwitter-image%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6794f43c19ef3d64ac7bcc7bbe47433c95d42f9/test%2Fproduction%2Fapp-dir%2Fmetadata-img-too-large%2Ftwitter-image%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-img-too-large%2Ftwitter-image%2Findex.test.ts?ref=d6794f43c19ef3d64ac7bcc7bbe47433c95d42f9",
            "patch": "@@ -14,8 +14,8 @@ describe('app-dir - metadata-img-too-large twitter-image', () => {\n     await next.build()\n \n     const regex = isTurbopack\n-      ? // in Turbopack, the path is simplified as [project]/...\n-        /Error: File size for Twitter image \"\\[project\\]\\/app\\/twitter-image\\.png\" exceeds 5MB/\n+      ? // in Turbopack, the path is simplified as [project]/.... It's also thrown earlier, so the prefix is slightly different.\n+        /File size for Twitter image \"\\[project\\]\\/app\\/twitter-image\\.png\" exceeds 5MB/\n       : /Error: File size for Twitter image \".*\\/app\\/twitter-image\\.png\" exceeds 5MB/\n \n     expect(next.cliOutput).toMatch(regex)"
        }
    ],
    "stats": {
        "total": 119,
        "additions": 92,
        "deletions": 27
    }
}