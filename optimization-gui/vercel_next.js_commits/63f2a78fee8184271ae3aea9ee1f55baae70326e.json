{
    "author": "mischnic",
    "message": "Turbopack: unique node middleware layer name (#76447)",
    "sha": "63f2a78fee8184271ae3aea9ee1f55baae70326e",
    "files": [
        {
            "sha": "5c45029833e30d0de866be4e4937b78e865c553b",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 65,
            "deletions": 37,
            "changes": 102,
            "blob_url": "https://github.com/vercel/next.js/blob/63f2a78fee8184271ae3aea9ee1f55baae70326e/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/63f2a78fee8184271ae3aea9ee1f55baae70326e/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=63f2a78fee8184271ae3aea9ee1f55baae70326e",
            "patch": "@@ -1223,7 +1223,7 @@ impl Project {\n     }\n \n     #[turbo_tasks::function]\n-    async fn middleware_context(self: Vc<Self>) -> Result<Vc<Box<dyn AssetContext>>> {\n+    async fn edge_middleware_context(self: Vc<Self>) -> Result<Vc<Box<dyn AssetContext>>> {\n         let mut transitions = vec![];\n \n         let app_dir = *find_app_dir(self.project_path()).await?;\n@@ -1244,7 +1244,7 @@ impl Project {\n             ));\n         }\n \n-        let edge_module_context = ModuleAssetContext::new(\n+        Ok(Vc::upcast(ModuleAssetContext::new(\n             TransitionOptions {\n                 named_transitions: transitions.clone().into_iter().collect(),\n                 ..Default::default()\n@@ -1273,8 +1273,68 @@ impl Project {\n                 self.next_config(),\n                 self.execution_context(),\n             ),\n+            Vc::cell(\"middleware-edge\".into()),\n+        )))\n+    }\n+\n+    #[turbo_tasks::function]\n+    async fn node_middleware_context(self: Vc<Self>) -> Result<Vc<Box<dyn AssetContext>>> {\n+        let mut transitions = vec![];\n+\n+        let app_dir = *find_app_dir(self.project_path()).await?;\n+        let app_project = *self.app_project().await?;\n+\n+        let ecmascript_client_reference_transition_name = match app_project {\n+            Some(app_project) => Some(app_project.client_transition_name().to_resolved().await?),\n+            None => None,\n+        };\n+\n+        if let Some(app_project) = app_project {\n+            transitions.push((\n+                ECMASCRIPT_CLIENT_TRANSITION_NAME.into(),\n+                app_project\n+                    .edge_ecmascript_client_reference_transition()\n+                    .to_resolved()\n+                    .await?,\n+            ));\n+        }\n+\n+        Ok(Vc::upcast(ModuleAssetContext::new(\n+            TransitionOptions {\n+                named_transitions: transitions.clone().into_iter().collect(),\n+                ..Default::default()\n+            }\n+            .cell(),\n+            self.server_compile_time_info(),\n+            get_server_module_options_context(\n+                self.project_path(),\n+                self.execution_context(),\n+                Value::new(ServerContextType::Middleware {\n+                    app_dir,\n+                    ecmascript_client_reference_transition_name,\n+                }),\n+                self.next_mode(),\n+                self.next_config(),\n+                NextRuntime::NodeJs,\n+                self.encryption_key(),\n+            ),\n+            get_server_resolve_options_context(\n+                self.project_path(),\n+                Value::new(ServerContextType::Middleware {\n+                    app_dir,\n+                    ecmascript_client_reference_transition_name,\n+                }),\n+                self.next_mode(),\n+                self.next_config(),\n+                self.execution_context(),\n+            ),\n             Vc::cell(\"middleware\".into()),\n-        );\n+        )))\n+    }\n+\n+    #[turbo_tasks::function]\n+    async fn middleware_context(self: Vc<Self>) -> Result<Vc<Box<dyn AssetContext>>> {\n+        let edge_module_context = self.edge_middleware_context();\n \n         let middleware = self.find_middleware();\n         let FindContextFileResult::Found(fs_path, _) = *middleware.await? else {\n@@ -1292,41 +1352,9 @@ impl Project {\n         let config = parse_config_from_source(module, NextRuntime::Edge).await?;\n \n         if matches!(config.runtime, NextRuntime::NodeJs) {\n-            let server_module_context = ModuleAssetContext::new(\n-                TransitionOptions {\n-                    named_transitions: transitions.clone().into_iter().collect(),\n-                    ..Default::default()\n-                }\n-                .cell(),\n-                self.server_compile_time_info(),\n-                get_server_module_options_context(\n-                    self.project_path(),\n-                    self.execution_context(),\n-                    Value::new(ServerContextType::Middleware {\n-                        app_dir,\n-                        ecmascript_client_reference_transition_name,\n-                    }),\n-                    self.next_mode(),\n-                    self.next_config(),\n-                    NextRuntime::NodeJs,\n-                    self.encryption_key(),\n-                ),\n-                get_server_resolve_options_context(\n-                    self.project_path(),\n-                    Value::new(ServerContextType::Middleware {\n-                        app_dir,\n-                        ecmascript_client_reference_transition_name,\n-                    }),\n-                    self.next_mode(),\n-                    self.next_config(),\n-                    self.execution_context(),\n-                ),\n-                Vc::cell(\"middleware\".into()),\n-            );\n-\n-            Ok(Vc::upcast(server_module_context))\n+            Ok(self.node_middleware_context())\n         } else {\n-            Ok(Vc::upcast(edge_module_context))\n+            Ok(edge_module_context)\n         }\n     }\n "
        },
        {
            "sha": "b788b30bd301b4a30670980776fbf84e63246d45",
            "filename": "test/development/middleware-errors/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/63f2a78fee8184271ae3aea9ee1f55baae70326e/test%2Fdevelopment%2Fmiddleware-errors%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/63f2a78fee8184271ae3aea9ee1f55baae70326e/test%2Fdevelopment%2Fmiddleware-errors%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmiddleware-errors%2Findex.test.ts?ref=63f2a78fee8184271ae3aea9ee1f55baae70326e",
            "patch": "@@ -212,7 +212,7 @@ describe('middleware - development errors', () => {\n         isTurbopack\n           ? '\\n тип Error: booooom!' +\n               // TODO(veil): Should be sourcemapped\n-              '\\n    at [project]/middleware.js [middleware] (ecmascript)'\n+              '\\n    at [project]/middleware.js [middleware-edge] (ecmascript)'\n           : '\\n тип Error: booooom!' +\n               // TODO: Should be anonymous method without a method name\n               '\\n    at <unknown> (middleware.js:3)' +"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 66,
        "deletions": 38
    }
}