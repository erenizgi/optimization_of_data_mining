{
    "author": "lubieowoce",
    "message": "fix: don't drop queued actions when navigating (#75362)\n\nIf we run two or more actions, the first starts executing immediately,\nand the rest gets queued. The bug here was that if we navigated right\nafter, the navigation would make us drop the rest of the queue, which\nwould cause all the queued action calls to never resolve.",
    "sha": "dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9",
    "files": [
        {
            "sha": "e01648aa0981b523ed5b912cdbbaeb70b1b73827",
            "filename": "packages/next/src/shared/lib/router/action-queue.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Faction-queue.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Faction-queue.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Faction-queue.ts?ref=dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9",
            "patch": "@@ -151,8 +151,9 @@ function dispatchAction(\n     // Mark the pending action as discarded (so the state is never applied) and start the navigation action immediately.\n     actionQueue.pending.discarded = true\n \n-    // Mark this action as the last in the queue\n-    actionQueue.last = newAction\n+    // The rest of the current queue should still execute after this navigation.\n+    // (Note that it can't contain any earlier navigations, because we always put those into `actionQueue.pending` by calling `runAction`)\n+    newAction.next = actionQueue.pending.next\n \n     // if the pending action was a server action, mark the queue as needing a refresh once events are processed\n     if (actionQueue.pending.payload.type === ACTION_SERVER_ACTION) {"
        },
        {
            "sha": "a14e64fcd5e33e9399d0e823434b0ab3095d5b75",
            "filename": "test/e2e/app-dir/navigation-with-queued-actions/app/layout.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fapp%2Flayout.tsx?ref=dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9",
            "patch": "@@ -0,0 +1,16 @@\n+export const metadata = {\n+  title: 'Next.js',\n+  description: 'Generated by Next.js',\n+}\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "2d3c4fe1c758c122f4c2066934f6a7ffdf0b36fd",
            "filename": "test/e2e/app-dir/navigation-with-queued-actions/app/page.tsx",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fapp%2Fpage.tsx?ref=dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9",
            "patch": "@@ -0,0 +1,27 @@\n+'use client'\n+\n+import { useRouter } from 'next/navigation'\n+import { useState } from 'react'\n+import { myAction } from './server'\n+\n+export default function Page() {\n+  const router = useRouter()\n+  const [text, setText] = useState('initial')\n+\n+  return (\n+    <>\n+      <button\n+        type=\"button\"\n+        onClick={() => {\n+          Promise.all([myAction(0), myAction(1)]).then(() => setText('done'))\n+          setTimeout(() => {\n+            router.replace('?')\n+          })\n+        }}\n+      >\n+        run actions\n+      </button>\n+      <div id=\"action-state\">{text}</div>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "0512ff0020a27d54ea9fdcf6d2582ddb520bc4a9",
            "filename": "test/e2e/app-dir/navigation-with-queued-actions/app/server.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fapp%2Fserver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fapp%2Fserver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fapp%2Fserver.ts?ref=dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9",
            "patch": "@@ -0,0 +1,8 @@\n+'use server'\n+\n+import { setTimeout } from 'timers/promises'\n+\n+export async function myAction(id: number) {\n+  console.log(`myAction(${id}) :: server`)\n+  await setTimeout(100)\n+}"
        },
        {
            "sha": "fd0669c1013f0f35fe081f2ec5534918f763a10f",
            "filename": "test/e2e/app-dir/navigation-with-queued-actions/index.test.ts",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Findex.test.ts?ref=dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9",
            "patch": "@@ -0,0 +1,18 @@\n+import { nextTestSetup } from '../../../lib/e2e-utils'\n+import { retry } from '../../../lib/next-test-utils'\n+\n+describe('actions', () => {\n+  const { next } = nextTestSetup({ files: __dirname })\n+  it('works', async () => {\n+    const browser = await next.browser('/')\n+    await browser.elementByCss('button').click()\n+    await retry(\n+      async () => {\n+        expect(await browser.elementById('action-state').text()).toEqual('done')\n+      },\n+      undefined,\n+      undefined,\n+      'wait for both actions to finish'\n+    )\n+  })\n+})"
        },
        {
            "sha": "b1c6ea436a540020ff61f01dea449d5b39367b27",
            "filename": "test/e2e/app-dir/navigation-with-queued-actions/next.config.mjs",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fnext.config.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fnext.config.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation-with-queued-actions%2Fnext.config.mjs?ref=dc52e7ece357e9b11e6d6b0bef2ced6e01f8f5a9",
            "patch": "@@ -0,0 +1 @@\n+export default {}"
        }
    ],
    "stats": {
        "total": 75,
        "additions": 73,
        "deletions": 2
    }
}