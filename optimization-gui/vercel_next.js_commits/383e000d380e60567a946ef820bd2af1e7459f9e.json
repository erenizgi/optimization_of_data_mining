{
    "author": "eps1lon",
    "message": "[sourcemaps] ignore-list Webpack runtime (#81229)\n\nThe way this works in dev is by assigning a dummy sourcemap to the Webpack runtime that ignore-lists everything. The mappings will will be incorrect in development. Production sourcemaps will be correct since those emit real sourcemaps for the webpack runtime where we just start ignore-listing modules that look like Webpack runtime.\r\n\r\nChrome already has this heuristic where it ignore-lists a source if its sourcemap ignore-lists every source. We'll use the same heuristic in the terminal and Redbox in a follow-up. We'll implement this heuristic for the Redbox and terminal in a follow-up.\r\n\r\n\r\nhttps://github.com/user-attachments/assets/b250e61d-c6f9-49b6-85c4-8bdd54275a01\r\n\r\nCloses https://linear.app/vercel/issue/NEXT-4409/",
    "sha": "383e000d380e60567a946ef820bd2af1e7459f9e",
    "files": [
        {
            "sha": "c335c07bb80212bf7bc820b240774830edf5fc05",
            "filename": "packages/next/src/build/webpack/plugins/devtools-ignore-list-plugin.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/383e000d380e60567a946ef820bd2af1e7459f9e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdevtools-ignore-list-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/383e000d380e60567a946ef820bd2af1e7459f9e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdevtools-ignore-list-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdevtools-ignore-list-plugin.ts?ref=383e000d380e60567a946ef820bd2af1e7459f9e",
            "patch": "@@ -31,6 +31,13 @@ function defaultIsSourceMapAsset(name: string): boolean {\n   return name.endsWith('.map')\n }\n \n+function isWebpackRuntimeModule(modulePath: string): boolean {\n+  // webpack:///webpack/bootstrap\n+  // webpack://_N_E/webpack/\n+  // webpack://someOtherLibrary/webpack/\n+  return /^webpack:\\/\\/([^/]*)\\/webpack/.test(modulePath)\n+}\n+\n /**\n  * This plugin adds a field to source maps that identifies which sources are\n  * vendored or runtime-injected (aka third-party) sources. These are consumed by\n@@ -77,6 +84,10 @@ export default class DevToolsIgnorePlugin {\n             for (const [index, path] of sourcemap.sources.entries()) {\n               if (this.options.shouldIgnorePath(path)) {\n                 ignoreList.push(index)\n+              } else if (isWebpackRuntimeModule(path)) {\n+                // Just like our EvalSourceMapDevToolPlugin ignore-lists Webpack\n+                // runtime by default, we do the same here.\n+                ignoreList.push(index)\n               }\n             }\n "
        },
        {
            "sha": "df66ef9c91a9beeee4570edf44bf4bc34f9fdc57",
            "filename": "packages/next/src/build/webpack/plugins/eval-source-map-dev-tool-plugin.ts",
            "status": "modified",
            "additions": 55,
            "deletions": 4,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/383e000d380e60567a946ef820bd2af1e7459f9e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Feval-source-map-dev-tool-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/383e000d380e60567a946ef820bd2af1e7459f9e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Feval-source-map-dev-tool-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Feval-source-map-dev-tool-plugin.ts?ref=383e000d380e60567a946ef820bd2af1e7459f9e",
            "patch": "@@ -228,10 +228,61 @@ export default class EvalSourceMapDevToolPlugin {\n           'EvalDevToolModulePlugin',\n           () => 'the eval-source-map devtool is used.'\n         )\n-        hooks.render.tap(\n-          'EvalSourceMapDevToolPlugin',\n-          (source) => new ConcatSource(devtoolWarning, source)\n-        )\n+        hooks.render.tap('EvalSourceMapDevToolPlugin', (source, context) => {\n+          if (\n+            context.chunk.id === 'webpack' ||\n+            context.chunk.id === 'webpack-runtime'\n+          ) {\n+            const sourceURL = new URL(\n+              'webpack-internal://nextjs/' + context.chunk.id + '.js'\n+            )\n+            // Webpack runtime chunks are not sourcemapped.\n+            // We insert a dummy source map that ignore-lists everything.\n+            // The mappings will be incorrect but end-users will almost never interact\n+            // with the webpack runtime. Users who do, can follow the instructions\n+            // in the sources content and disable sourcemaps in their debugger.\n+            const sourceMappingURL = new URL(\n+              'data:application/json;charset=utf-8;base64,' +\n+                Buffer.from(\n+                  JSON.stringify({\n+                    version: 3,\n+                    ignoreList: [0],\n+                    // Minimal, parseable mappings.\n+                    mappings: 'AAAA',\n+                    sources: [\n+                      // TODO: This should be the original source URL so that CTRL+Click works in the terminal.\n+                      sourceURL.toString(),\n+                    ],\n+                    sourcesContent: [\n+                      '' +\n+                        '// This source was generated by Next.js based off of the generated Webpack runtime.\\n' +\n+                        '// The mappings are incorrect.\\n' +\n+                        '// To get the correct line/column mappings, turn off sourcemaps in your debugger.\\n' +\n+                        '\\n' +\n+                        source.source(),\n+                    ],\n+                  })\n+                ).toString('base64')\n+            )\n+\n+            return new ConcatSource(\n+              source,\n+              new RawSource(\n+                '\\n//# sourceMappingURL=' +\n+                  sourceMappingURL +\n+                  // Webpack will add a trailing semicolon. Adding a newline\n+                  // ensures the semicolon is not part of the sourceURL and actually\n+                  // terminates the previous statement.\n+                  '\\n'\n+              )\n+              // We don't need to add a sourceURL here because that's handled by\n+              // whatever is running this script. It'll be the file in Node.js\n+              // and the static asset path in the browser.\n+            )\n+          } else {\n+            return new ConcatSource(devtoolWarning, source)\n+          }\n+        })\n         hooks.chunkHash.tap('EvalSourceMapDevToolPlugin', (_chunk, hash) => {\n           hash.update('EvalSourceMapDevToolPlugin')\n           hash.update('2')"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 66,
        "deletions": 4
    }
}