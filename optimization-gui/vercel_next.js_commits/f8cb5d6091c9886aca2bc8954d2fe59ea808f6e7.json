{
    "author": "xusd320",
    "message": "chore(turbopack-node): remove some outdated codes (#86111)\n\nThese codes are outdated.",
    "sha": "f8cb5d6091c9886aca2bc8954d2fe59ea808f6e7",
    "files": [
        {
            "sha": "b16e3541bdd679691d0853186c0c19bfc51945bf",
            "filename": "turbopack/crates/turbopack-node/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 102,
            "changes": 104,
            "blob_url": "https://github.com/vercel/next.js/blob/f8cb5d6091c9886aca2bc8954d2fe59ea808f6e7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f8cb5d6091c9886aca2bc8954d2fe59ea808f6e7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs?ref=f8cb5d6091c9886aca2bc8954d2fe59ea808f6e7",
            "patch": "@@ -2,27 +2,17 @@\n #![feature(arbitrary_self_types)]\n #![feature(arbitrary_self_types_pointers)]\n \n-use std::thread::available_parallelism;\n-\n-use anyhow::{Result, bail};\n+use anyhow::Result;\n use rustc_hash::FxHashMap;\n-use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, TryFlatJoinIterExt, Vc};\n-use turbo_tasks_env::ProcessEnv;\n-use turbo_tasks_fs::{File, FileSystemPath, to_sys_path};\n+use turbo_tasks_fs::{File, FileSystemPath};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n-    changed::content_changed,\n-    chunk::{ChunkingContext, ChunkingContextExt, EvaluatableAsset, EvaluatableAssets},\n-    module::Module,\n-    module_graph::{ModuleGraph, chunk_group_info::ChunkGroupEntry},\n     output::{ExpandOutputAssetsInput, OutputAsset, OutputAssets, expand_output_assets},\n     source_map::GenerateSourceMap,\n     virtual_output::VirtualOutputAsset,\n };\n \n-use self::pool::NodeJsPool;\n-\n pub mod debug;\n pub mod embed_js;\n pub mod evaluate;\n@@ -112,93 +102,3 @@ fn emit_package_json(dir: FileSystemPath) -> Result<Vc<()>> {\n         dir,\n     ))\n }\n-\n-/// Creates a node.js renderer pool for an entrypoint.\n-#[turbo_tasks::function(operation)]\n-pub async fn get_renderer_pool_operation(\n-    cwd: FileSystemPath,\n-    env: ResolvedVc<Box<dyn ProcessEnv>>,\n-    intermediate_asset: ResolvedVc<Box<dyn OutputAsset>>,\n-    intermediate_output_path: FileSystemPath,\n-    output_root: FileSystemPath,\n-    project_dir: FileSystemPath,\n-    debug: bool,\n-) -> Result<Vc<NodeJsPool>> {\n-    emit_package_json(intermediate_output_path.clone())?.await?;\n-\n-    emit(*intermediate_asset, output_root.clone())\n-        .as_side_effect()\n-        .await?;\n-    let assets_for_source_mapping =\n-        internal_assets_for_source_mapping(*intermediate_asset, output_root.clone());\n-\n-    let entrypoint = intermediate_asset.path().owned().await?;\n-\n-    let Some(cwd) = to_sys_path(cwd.clone()).await? else {\n-        bail!(\n-            \"can only render from a disk filesystem, but `cwd = {}`\",\n-            cwd.value_to_string().await?\n-        );\n-    };\n-    let Some(entrypoint) = to_sys_path(entrypoint.clone()).await? else {\n-        bail!(\n-            \"can only render from a disk filesystem, but `entrypoint = {}`\",\n-            entrypoint.value_to_string().await?\n-        );\n-    };\n-    // Invalidate pool when code content changes\n-    content_changed(*ResolvedVc::upcast(intermediate_asset)).await?;\n-\n-    Ok(NodeJsPool::new(\n-        cwd,\n-        entrypoint,\n-        env.read_all()\n-            .await?\n-            .iter()\n-            .map(|(k, v)| (k.clone(), v.clone()))\n-            .collect(),\n-        assets_for_source_mapping.to_resolved().await?,\n-        output_root,\n-        project_dir,\n-        available_parallelism().map_or(1, |v| v.get()),\n-        debug,\n-    )\n-    .cell())\n-}\n-\n-/// Converts a module graph into node.js executable assets\n-#[turbo_tasks::function]\n-pub async fn get_intermediate_asset(\n-    chunking_context: Vc<Box<dyn ChunkingContext>>,\n-    main_entry: ResolvedVc<Box<dyn EvaluatableAsset>>,\n-    other_entries: Vc<EvaluatableAssets>,\n-) -> Result<Vc<Box<dyn OutputAsset>>> {\n-    Ok(chunking_context.root_entry_chunk_group_asset(\n-        chunking_context\n-            .chunk_path(None, main_entry.ident(), None, rcstr!(\".js\"))\n-            .owned()\n-            .await?,\n-        other_entries.with_entry(*main_entry),\n-        ModuleGraph::from_modules(\n-            Vc::cell(vec![ChunkGroupEntry::Entry(\n-                other_entries\n-                    .await?\n-                    .into_iter()\n-                    .copied()\n-                    .chain(std::iter::once(main_entry))\n-                    .map(ResolvedVc::upcast)\n-                    .collect(),\n-            )]),\n-            false,\n-        ),\n-        OutputAssets::empty(),\n-        OutputAssets::empty(),\n-    ))\n-}\n-\n-#[derive(Clone, Debug)]\n-#[turbo_tasks::value(shared)]\n-pub struct ResponseHeaders {\n-    pub status: u16,\n-    pub headers: Vec<(RcStr, RcStr)>,\n-}"
        },
        {
            "sha": "1d4532868d66e40a98c8f7407d930e1b541b4e2e",
            "filename": "turbopack/crates/turbopack-node/src/pool.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 52,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/f8cb5d6091c9886aca2bc8954d2fe59ea808f6e7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fpool.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f8cb5d6091c9886aca2bc8954d2fe59ea808f6e7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fpool.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fpool.rs?ref=f8cb5d6091c9886aca2bc8954d2fe59ea808f6e7",
            "patch": "@@ -1,5 +1,4 @@\n use std::{\n-    borrow::Cow,\n     cmp::max,\n     fmt::{Debug, Display},\n     future::Future,\n@@ -71,9 +70,6 @@ impl FormattingMode {\n struct NodeJsPoolProcess {\n     child: Option<Child>,\n     connection: TcpStream,\n-    assets_for_source_mapping: ResolvedVc<AssetsForSourceMapping>,\n-    assets_root: FileSystemPath,\n-    project_dir: FileSystemPath,\n     stdout_handler: OutputStreamHandler<ChildStdout, Stdout>,\n     stderr_handler: OutputStreamHandler<ChildStderr, Stderr>,\n     debug: bool,\n@@ -107,39 +103,6 @@ impl PartialEq for NodeJsPoolProcess {\n     }\n }\n \n-impl NodeJsPoolProcess {\n-    pub async fn apply_source_mapping<'a>(\n-        &self,\n-        text: &'a str,\n-        formatting_mode: FormattingMode,\n-    ) -> Result<Cow<'a, str>> {\n-        let text = unmangle_identifiers(text, |content| formatting_mode.magic_identifier(content));\n-        match text {\n-            Cow::Borrowed(text) => {\n-                apply_source_mapping(\n-                    text,\n-                    *self.assets_for_source_mapping,\n-                    self.assets_root.clone(),\n-                    self.project_dir.clone(),\n-                    formatting_mode,\n-                )\n-                .await\n-            }\n-            Cow::Owned(ref text) => {\n-                let cow = apply_source_mapping(\n-                    text,\n-                    *self.assets_for_source_mapping,\n-                    self.assets_root.clone(),\n-                    self.project_dir.clone(),\n-                    formatting_mode,\n-                )\n-                .await?;\n-                Ok(Cow::Owned(cow.into_owned()))\n-            }\n-        }\n-    }\n-}\n-\n const CONNECT_TIMEOUT: Duration = Duration::from_secs(30);\n \n #[derive(Clone, PartialEq, Eq, Hash)]\n@@ -456,9 +419,6 @@ impl NodeJsPoolProcess {\n         let mut process = Self {\n             child: Some(child),\n             connection,\n-            assets_for_source_mapping,\n-            assets_root: assets_root.clone(),\n-            project_dir: project_dir.clone(),\n             stdout_handler,\n             stderr_handler,\n             debug,\n@@ -958,18 +918,6 @@ impl NodeJsOperation {\n             self.allow_process_reuse = false;\n         }\n     }\n-\n-    pub async fn apply_source_mapping<'a>(\n-        &self,\n-        text: &'a str,\n-        formatting_mode: FormattingMode,\n-    ) -> Result<Cow<'a, str>> {\n-        if let Some(process) = self.process.as_ref() {\n-            process.apply_source_mapping(text, formatting_mode).await\n-        } else {\n-            Ok(Cow::Borrowed(text))\n-        }\n-    }\n }\n \n impl Drop for NodeJsOperation {"
        },
        {
            "sha": "eeaf2e6cab1f68f69b966c0830e0de67862eb2cb",
            "filename": "turbopack/crates/turbopack-node/src/source_map/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 38,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/f8cb5d6091c9886aca2bc8954d2fe59ea808f6e7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fsource_map%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f8cb5d6091c9886aca2bc8954d2fe59ea808f6e7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fsource_map%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fsource_map%2Fmod.rs?ref=f8cb5d6091c9886aca2bc8954d2fe59ea808f6e7",
            "patch": "@@ -9,20 +9,18 @@ use const_format::concatcp;\n use once_cell::sync::Lazy;\n use regex::Regex;\n pub use trace::{StackFrame, TraceResult, trace_source_map};\n-use tracing::{Level, instrument};\n use turbo_tasks::{ReadRef, Vc};\n use turbo_tasks_fs::{\n     FileLinesContent, FileSystemPath, source_context::get_source_context, to_sys_path,\n };\n use turbopack_cli_utils::source_context::format_source_context_lines;\n use turbopack_core::{\n     PROJECT_FILESYSTEM_NAME, SOURCE_URL_PROTOCOL,\n-    output::OutputAsset,\n     source_map::{GenerateSourceMap, SourceMap},\n };\n use turbopack_ecmascript::magic_identifier::unmangle_identifiers;\n \n-use crate::{AssetsForSourceMapping, internal_assets_for_source_mapping, pool::FormattingMode};\n+use crate::{AssetsForSourceMapping, pool::FormattingMode};\n \n pub mod trace;\n \n@@ -332,38 +330,3 @@ impl StructuredError {\n         Ok(message)\n     }\n }\n-\n-pub async fn trace_stack(\n-    error: StructuredError,\n-    root_asset: Vc<Box<dyn OutputAsset>>,\n-    output_path: FileSystemPath,\n-    project_dir: FileSystemPath,\n-) -> Result<String> {\n-    let assets_for_source_mapping =\n-        internal_assets_for_source_mapping(root_asset, output_path.clone());\n-\n-    trace_stack_with_source_mapping_assets(\n-        error,\n-        assets_for_source_mapping,\n-        output_path,\n-        project_dir,\n-    )\n-    .await\n-}\n-\n-#[instrument(level = Level::TRACE, skip_all)]\n-pub async fn trace_stack_with_source_mapping_assets(\n-    error: StructuredError,\n-    assets_for_source_mapping: Vc<AssetsForSourceMapping>,\n-    output_path: FileSystemPath,\n-    project_dir: FileSystemPath,\n-) -> Result<String> {\n-    error\n-        .print(\n-            assets_for_source_mapping,\n-            output_path,\n-            project_dir,\n-            FormattingMode::Plain,\n-        )\n-        .await\n-}"
        }
    ],
    "stats": {
        "total": 195,
        "additions": 3,
        "deletions": 192
    }
}