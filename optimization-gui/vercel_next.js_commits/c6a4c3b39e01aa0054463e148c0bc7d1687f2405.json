{
    "author": "ztanner",
    "message": "update routes-manifest to include whether app has pages routes (#86051)\n\nThe Vercel CLI produces a lot of `/_next/data` routes regardless of if\npages router is in-use. There's a lot of different metadata we emit but\nnothing concretely tells us if an app has pages router enabled. For app\nrouter, we rely on the presence of `app-paths-manifest`, but in pages\nrouter, we always emit a `pages-manifest`.\n\nRather than trying to cobble together something in the CLI, this updates\nthe routes manifest to explicitly output the app type (pages, app, or\nhybrid).",
    "sha": "c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
    "files": [
        {
            "sha": "dfb1a8c74812f5298e8c8cf9916b7461af194009",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
            "patch": "@@ -435,6 +435,7 @@ type ManifestDataRoute = {\n export type RoutesManifest = {\n   version: number\n   pages404: boolean\n+  appType: 'app' | 'pages' | 'hybrid'\n   basePath: string\n   redirects: Array<ManifestRedirectRoute>\n   rewrites: {\n@@ -923,6 +924,7 @@ export default async function build(\n   NextBuildContext.isCompileMode = isCompileMode\n   NextBuildContext.analyze = experimentalAnalyze\n   const buildStartTime = Date.now()\n+  let appType: RoutesManifest['appType']\n \n   let loadedConfig: NextConfigComplete | undefined\n   try {\n@@ -1077,6 +1079,14 @@ export default async function build(\n       const publicDir = path.join(dir, 'public')\n       const { pagesDir, appDir } = findPagesDir(dir)\n \n+      if (pagesDir && appDir) {\n+        appType = 'hybrid'\n+      } else if (pagesDir) {\n+        appType = 'pages'\n+      } else if (appDir) {\n+        appType = 'app'\n+      }\n+\n       if (!appDirOnly && !pagesDir) {\n         appDirOnly = true\n       }\n@@ -1619,6 +1629,7 @@ export default async function build(\n           return {\n             version: 3,\n             pages404: true,\n+            appType,\n             caseSensitive: !!config.experimental.caseSensitiveRoutes,\n             basePath: config.basePath,\n             redirects: redirects.map((r) =>"
        },
        {
            "sha": "a9d171b7266cecd78221d6c3af0587631ac8b989",
            "filename": "test/integration/custom-routes/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fintegration%2Fcustom-routes%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fintegration%2Fcustom-routes%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcustom-routes%2Ftest%2Findex.test.ts?ref=c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
            "patch": "@@ -1500,6 +1500,7 @@ const runTests = (isDev = false) => {\n         ])\n       ).toMatchInlineSnapshot(`\n        {\n+         \"appType\": \"pages\",\n          \"basePath\": \"\",\n          \"caseSensitive\": true,\n          \"dataRoutes\": ["
        },
        {
            "sha": "2edfeb5a3bc0770c0482f8a3d70fc2e2c269a1ec",
            "filename": "test/integration/dynamic-routing/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fintegration%2Fdynamic-routing%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fintegration%2Fdynamic-routing%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fdynamic-routing%2Ftest%2Findex.test.ts?ref=c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
            "patch": "@@ -1257,6 +1257,7 @@ function runTests({ dev }) {\n       expect(normalizeManifest(manifest, [[buildId, 'BUILD_ID']]))\n         .toMatchInlineSnapshot(`\n        {\n+         \"appType\": \"pages\",\n          \"basePath\": \"\",\n          \"caseSensitive\": false,\n          \"dataRoutes\": ["
        },
        {
            "sha": "60b69262bfcada5558110192b7873d14ef0c548e",
            "filename": "test/production/app-type/app-type.test.ts",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Fapp-type.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Fapp-type.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-type%2Fapp-type.test.ts?ref=c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
            "patch": "@@ -0,0 +1,46 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import path from 'path'\n+\n+describe('app-type', () => {\n+  describe('app-only', () => {\n+    const { next } = nextTestSetup({\n+      files: path.join(__dirname, 'fixtures', 'app-only'),\n+    })\n+\n+    it('should have the app-only app type', async () => {\n+      const requiredServerFiles = JSON.parse(\n+        await next.readFile('.next/routes-manifest.json')\n+      )\n+\n+      expect(requiredServerFiles.appType).toBe('app')\n+    })\n+  })\n+\n+  describe('pages-only', () => {\n+    const { next } = nextTestSetup({\n+      files: path.join(__dirname, 'fixtures', 'pages-only'),\n+    })\n+\n+    it('should have the pages-only app type', async () => {\n+      const requiredServerFiles = JSON.parse(\n+        await next.readFile('.next/routes-manifest.json')\n+      )\n+\n+      expect(requiredServerFiles.appType).toBe('pages')\n+    })\n+  })\n+\n+  describe('hybrid', () => {\n+    const { next } = nextTestSetup({\n+      files: path.join(__dirname, 'fixtures', 'hybrid'),\n+    })\n+\n+    it('should have the hybrid app type', async () => {\n+      const requiredServerFiles = JSON.parse(\n+        await next.readFile('.next/routes-manifest.json')\n+      )\n+\n+      expect(requiredServerFiles.appType).toBe('hybrid')\n+    })\n+  })\n+})"
        },
        {
            "sha": "08eaa94fdc8896acfd343a0dbb61c713eec93a55",
            "filename": "test/production/app-type/fixtures/app-only/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fapp-only%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fapp-only%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-type%2Ffixtures%2Fapp-only%2Fapp%2Flayout.tsx?ref=c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "4be1d6684e2f4cf883e6c4fae51f8dc94e280699",
            "filename": "test/production/app-type/fixtures/app-only/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fapp-only%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fapp-only%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-type%2Ffixtures%2Fapp-only%2Fapp%2Fpage.tsx?ref=c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <div>Hello, world!</div>\n+}"
        },
        {
            "sha": "08eaa94fdc8896acfd343a0dbb61c713eec93a55",
            "filename": "test/production/app-type/fixtures/hybrid/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fhybrid%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fhybrid%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-type%2Ffixtures%2Fhybrid%2Fapp%2Flayout.tsx?ref=c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "4be1d6684e2f4cf883e6c4fae51f8dc94e280699",
            "filename": "test/production/app-type/fixtures/hybrid/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fhybrid%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fhybrid%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-type%2Ffixtures%2Fhybrid%2Fapp%2Fpage.tsx?ref=c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <div>Hello, world!</div>\n+}"
        },
        {
            "sha": "4be1d6684e2f4cf883e6c4fae51f8dc94e280699",
            "filename": "test/production/app-type/fixtures/hybrid/pages/other.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fhybrid%2Fpages%2Fother.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fhybrid%2Fpages%2Fother.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-type%2Ffixtures%2Fhybrid%2Fpages%2Fother.tsx?ref=c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <div>Hello, world!</div>\n+}"
        },
        {
            "sha": "4be1d6684e2f4cf883e6c4fae51f8dc94e280699",
            "filename": "test/production/app-type/fixtures/pages-only/pages/index.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fpages-only%2Fpages%2Findex.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a4c3b39e01aa0054463e148c0bc7d1687f2405/test%2Fproduction%2Fapp-type%2Ffixtures%2Fpages-only%2Fpages%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-type%2Ffixtures%2Fpages-only%2Fpages%2Findex.tsx?ref=c6a4c3b39e01aa0054463e148c0bc7d1687f2405",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <div>Hello, world!</div>\n+}"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 93,
        "deletions": 0
    }
}