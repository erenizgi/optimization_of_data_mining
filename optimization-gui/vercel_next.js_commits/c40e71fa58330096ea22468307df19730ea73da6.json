{
    "author": "Kikobeats",
    "message": "fix(edge-runtime): clone requests properly (#82878)",
    "sha": "c40e71fa58330096ea22468307df19730ea73da6",
    "files": [
        {
            "sha": "0fc59f637216ae2d88f3863541ef92388738eae7",
            "filename": "packages/next/src/server/web/sandbox/context.test.ts",
            "status": "added",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/vercel/next.js/blob/c40e71fa58330096ea22468307df19730ea73da6/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c40e71fa58330096ea22468307df19730ea73da6/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.test.ts?ref=c40e71fa58330096ea22468307df19730ea73da6",
            "patch": "@@ -0,0 +1,72 @@\n+import { getModuleContext } from './context'\n+import { validateURL } from '../utils'\n+\n+jest.mock('../utils', () => ({\n+  ...jest.requireActual('../utils'),\n+  validateURL: jest.fn(jest.requireActual('../utils').validateURL),\n+}))\n+\n+const mockedValidateURL = jest.mocked(validateURL)\n+\n+describe('Next.js sandbox Request constructor', () => {\n+  let moduleContext: any\n+\n+  beforeEach(async () => {\n+    mockedValidateURL.mockClear()\n+    moduleContext = await getModuleContext({\n+      moduleName: 'test-module',\n+      onError: () => {},\n+      onWarning: () => {},\n+      useCache: false,\n+      distDir: '/tmp',\n+      edgeFunctionEntry: {\n+        assets: [],\n+        wasm: [],\n+        env: {},\n+      },\n+    })\n+  })\n+\n+  it('should preserve Request method when copying Request in Next.js context', () => {\n+    const { Request: NextRequest } = moduleContext.runtime.context\n+\n+    const originalRequest = new NextRequest('https://example.com', {\n+      method: 'POST',\n+    })\n+    expect(originalRequest.method).toBe('POST')\n+\n+    const copiedRequest = new NextRequest(originalRequest)\n+\n+    expect(copiedRequest.method).toBe('POST')\n+    expect(copiedRequest.url).toBe('https://example.com/')\n+  })\n+\n+  it('should validate URL is called during Request construction', () => {\n+    const { Request: NextRequest } = moduleContext.runtime.context\n+\n+    new NextRequest('https://example.com')\n+    expect(mockedValidateURL).toHaveBeenCalledWith('https://example.com')\n+  })\n+\n+  it('should handle Request with body and headers correctly', () => {\n+    const { Request: NextRequest } = moduleContext.runtime.context\n+\n+    const originalRequest = new NextRequest('https://example.com', {\n+      method: 'POST',\n+      body: 'test body',\n+      headers: { 'Content-Type': 'application/json' },\n+    })\n+\n+    const copiedRequest = new NextRequest(originalRequest)\n+\n+    expect(copiedRequest.method).toBe('POST')\n+    expect(copiedRequest.headers.get('Content-Type')).toBe('application/json')\n+  })\n+\n+  it('should throw Next.js specific error for relative URLs', () => {\n+    const { Request: NextRequest } = moduleContext.runtime.context\n+    expect(() => new NextRequest('/urls-b')).toThrow(\n+      'Please use only absolute URLs'\n+    )\n+  })\n+})"
        },
        {
            "sha": "a5ff663ab4e7b39fa079875f21f5fb9393885e1c",
            "filename": "packages/next/src/server/web/sandbox/context.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c40e71fa58330096ea22468307df19730ea73da6/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c40e71fa58330096ea22468307df19730ea73da6/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.ts?ref=c40e71fa58330096ea22468307df19730ea73da6",
            "patch": "@@ -406,8 +406,14 @@ Learn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation`),\n             typeof input !== 'string' && 'url' in input\n               ? input.url\n               : String(input)\n-          validateURL(url)\n-          super(url, init)\n+\n+          if (typeof input === 'string') {\n+            validateURL(url)\n+            super(input, init)\n+          } else {\n+            super(input, init)\n+            validateURL(url)\n+          }\n           this.next = init?.next\n         }\n       }"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 80,
        "deletions": 2
    }
}