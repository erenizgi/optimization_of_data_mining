{
    "author": "eps1lon",
    "message": "[devtools] Use `useEffectEvent` instead of ignoring exhaustive deps (#83236)",
    "sha": "684c7c019ff84480e720c935db92333323727842",
    "files": [
        {
            "sha": "138d432c5adb1285d195d3336ab984ff5210175f",
            "filename": "packages/next/next-devtools.webpack-config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/684c7c019ff84480e720c935db92333323727842/packages%2Fnext%2Fnext-devtools.webpack-config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/684c7c019ff84480e720c935db92333323727842/packages%2Fnext%2Fnext-devtools.webpack-config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fnext-devtools.webpack-config.js?ref=684c7c019ff84480e720c935db92333323727842",
            "patch": "@@ -17,7 +17,7 @@ function shouldIgnorePath(modulePath) {\n  * @returns {webpack.Configuration}\n  */\n module.exports = ({ dev, ...rest }) => {\n-  const experimental = false\n+  const experimental = true\n \n   const bundledReactChannel = experimental ? '-experimental' : ''\n "
        },
        {
            "sha": "7d55191b810a4aa4c21e54e01e6319fe8419ba84",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/devtools-panel/resize/resize-provider.tsx",
            "status": "modified",
            "additions": 15,
            "deletions": 9,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/684c7c019ff84480e720c935db92333323727842/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fresize%2Fresize-provider.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/684c7c019ff84480e720c935db92333323727842/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fresize%2Fresize-provider.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fresize%2Fresize-provider.tsx?ref=684c7c019ff84480e720c935db92333323727842",
            "patch": "@@ -2,6 +2,7 @@ import {\n   createContext,\n   useCallback,\n   useContext,\n+  experimental_useEffectEvent as useEffectEvent,\n   useLayoutEffect,\n   useState,\n   type RefObject,\n@@ -71,8 +72,9 @@ export const ResizeProvider = ({ value, children }: ResizeProviderProps) => {\n \n   const storageKey = value.storageKey ?? STORE_KEY_SHARED_PANEL_SIZE\n \n+  const { resizeRef } = value\n   const applyConstrainedDimensions = useCallback(() => {\n-    if (!value.resizeRef.current) return\n+    if (!resizeRef.current) return\n \n     // this feels weird to read local storage on resize, but we don't\n     // track the dimensions of the container, and this is better than\n@@ -96,23 +98,23 @@ export const ResizeProvider = ({ value, children }: ResizeProviderProps) => {\n       minHeight: minHeight ?? 80,\n     })\n \n-    value.resizeRef.current.style.width = `${width}px`\n-    value.resizeRef.current.style.height = `${height}px`\n+    resizeRef.current.style.width = `${width}px`\n+    resizeRef.current.style.height = `${height}px`\n     return true\n   }, [\n-    value.resizeRef,\n+    resizeRef,\n     draggingDirection,\n     storageKey,\n     minWidth,\n     minHeight,\n     value.devToolsPanelSize,\n   ])\n \n-  useLayoutEffect(() => {\n+  const fireInitialConstrainDimensions = useEffectEvent(() => {\n     const applied = applyConstrainedDimensions()\n     if (\n       !applied &&\n-      value.resizeRef.current &&\n+      resizeRef.current &&\n       value.initialSize?.height &&\n       value.initialSize.width\n     ) {\n@@ -122,10 +124,14 @@ export const ResizeProvider = ({ value, children }: ResizeProviderProps) => {\n         minWidth: minWidth ?? 100,\n         minHeight: minHeight ?? 80,\n       })\n-      value.resizeRef.current.style.width = `${width}px`\n-      value.resizeRef.current.style.height = `${height}px`\n+      resizeRef.current.style.width = `${width}px`\n+      resizeRef.current.style.height = `${height}px`\n     }\n-    // eslint-disable-next-line react-hooks/exhaustive-deps\n+  })\n+\n+  useLayoutEffect(() => {\n+    // eslint-disable-next-line react-hooks/rules-of-hooks -- eprh bug\n+    fireInitialConstrainDimensions()\n   }, [])\n \n   useLayoutEffect(() => {"
        },
        {
            "sha": "f5c8d4c5e69c9e6a03a22abea540732f777ca810",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/utils.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/684c7c019ff84480e720c935db92333323727842/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/684c7c019ff84480e720c935db92333323727842/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Futils.ts?ref=684c7c019ff84480e720c935db92333323727842",
            "patch": "@@ -1,11 +1,18 @@\n-import { useEffect } from 'react'\n+import { useEffect, experimental_useEffectEvent as useEffectEvent } from 'react'\n \n export function useFocusTrap(\n   rootRef: React.RefObject<HTMLElement | null>,\n   triggerRef: React.RefObject<HTMLButtonElement | null> | null,\n   active: boolean,\n   onOpenFocus?: () => void\n ) {\n+  const fireOpenFocus = useEffectEvent((rootNode: HTMLElement | null) => {\n+    if (onOpenFocus) {\n+      onOpenFocus()\n+    } else {\n+      rootNode?.focus()\n+    }\n+  })\n   useEffect(() => {\n     let rootNode: HTMLElement | null = null\n \n@@ -35,11 +42,7 @@ export function useFocusTrap(\n       // Grab this on next tick to ensure the content is mounted\n       rootNode = rootRef.current\n       if (active) {\n-        if (onOpenFocus) {\n-          onOpenFocus()\n-        } else {\n-          rootNode?.focus()\n-        }\n+        fireOpenFocus(rootNode)\n         rootNode?.addEventListener('keydown', onTab)\n       } else {\n         const activeElement = getActiveElement(rootNode)\n@@ -56,8 +59,7 @@ export function useFocusTrap(\n       clearTimeout(id)\n       rootNode?.removeEventListener('keydown', onTab)\n     }\n-    // eslint-disable-next-line react-hooks/exhaustive-deps\n-  }, [active])\n+  }, [active, rootRef, triggerRef])\n }\n \n export function getActiveElement(node: HTMLElement | null) {"
        },
        {
            "sha": "7306477ac374122b38701567b0c339e82bcb13d2",
            "filename": "packages/next/src/next-devtools/dev-overlay/menu/dev-overlay-menu.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/684c7c019ff84480e720c935db92333323727842/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fmenu%2Fdev-overlay-menu.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/684c7c019ff84480e720c935db92333323727842/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fmenu%2Fdev-overlay-menu.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fmenu%2Fdev-overlay-menu.tsx?ref=684c7c019ff84480e720c935db92333323727842",
            "patch": "@@ -1,6 +1,7 @@\n import { useDevOverlayContext } from '../../dev-overlay.browser'\n import { useClickOutsideAndEscape } from '../components/errors/dev-tools-indicator/utils'\n import {\n+  experimental_useEffectEvent as useEffectEvent,\n   useLayoutEffect,\n   useRef,\n   createContext,\n@@ -134,14 +135,18 @@ export const DevtoolMenu = ({\n       }\n     }\n   )\n-  useLayoutEffect(() => {\n-    menuRef.current?.focus() // allows keydown to be captured\n+  const fireInitialSelectMenuItem = useEffectEvent(() => {\n     selectMenuItem({\n       index: selectedIndex === -1 ? 'first' : selectedIndex,\n       menuRef,\n       setSelectedIndex,\n     })\n-    // eslint-disable-next-line react-hooks/exhaustive-deps\n+  })\n+\n+  useLayoutEffect(() => {\n+    menuRef.current?.focus() // allows keydown to be captured\n+    // eslint-disable-next-line react-hooks/rules-of-hooks -- eprh bug\n+    fireInitialSelectMenuItem()\n   }, [])\n \n   const indicatorOffset = getIndicatorOffset(state)"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 34,
        "deletions": 21
    }
}