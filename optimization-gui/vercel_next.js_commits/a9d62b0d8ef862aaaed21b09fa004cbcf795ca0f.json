{
    "author": "kdy1",
    "message": "fix(turbopack): Pass correct browserslist to `styled-jsx` (#83334)\n\n### What?\n\nPass the correct browserslist query to `lightningcss` in `styled-jsx`.\n\n### Why?\n\nTo fix an issue with `styled-jsx`.\n\n#### Testing instruction:\n\n1. `git clone https://github.com/kdy1/repro-next-styled-jsx-526\n~/projects/repro-next-styled-jsx-526`\n2. `pnpm pack-next -p ~/projects/repro-next-styled-jsx-526 && (cd\nrepro-next-styled-jsx-526 && pnpm i && pnpm build && pnpm start`\n\n\n### How?\n\nCloses https://github.com/swc-project/plugins/issues/526",
    "sha": "a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
    "files": [
        {
            "sha": "99fd15966583dd30e9e26df1140c46bef7d21419",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -997,6 +997,7 @@ impl Project {\n             format!(\"/ROOT/{}\", self.project_path().await?.path).into(),\n             this.define_env.nodejs(),\n             self.current_node_js_version(),\n+            this.browserslist_query.clone(),\n         ))\n     }\n \n@@ -1007,6 +1008,7 @@ impl Project {\n             self.project_path().owned().await?,\n             this.define_env.edge(),\n             self.current_node_js_version(),\n+            this.browserslist_query.clone(),\n         ))\n     }\n "
        },
        {
            "sha": "a6599a85147919d7efadee0d8ecbf83883b976b0",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -98,18 +98,18 @@ pub async fn get_client_compile_time_info(\n     browserslist_query: RcStr,\n     define_env: Vc<OptionEnvMap>,\n ) -> Result<Vc<CompileTimeInfo>> {\n+    let environment = BrowserEnvironment {\n+        dom: true,\n+        web_worker: false,\n+        service_worker: false,\n+        browserslist_query: browserslist_query.to_owned(),\n+    }\n+    .resolved_cell();\n+\n     CompileTimeInfo::builder(\n-        Environment::new(ExecutionEnvironment::Browser(\n-            BrowserEnvironment {\n-                dom: true,\n-                web_worker: false,\n-                service_worker: false,\n-                browserslist_query: browserslist_query.to_owned(),\n-            }\n-            .resolved_cell(),\n-        ))\n-        .to_resolved()\n-        .await?,\n+        Environment::new(ExecutionEnvironment::Browser(environment), *environment)\n+            .to_resolved()\n+            .await?,\n     )\n     .defines(next_client_defines(define_env).to_resolved().await?)\n     .free_var_references(next_client_free_vars(define_env).to_resolved().await?)\n@@ -260,7 +260,7 @@ pub async fn get_client_module_options_context(\n     let tree_shaking_mode_for_foreign_code = *next_config\n         .tree_shaking_mode_for_foreign_code(next_mode.is_development())\n         .await?;\n-    let target_browsers = env.runtime_versions();\n+    let css_target_browsers = env.css_runtime_versions();\n \n     let mut next_client_rules =\n         get_next_client_transforms_rules(next_config, ty.clone(), mode, false, encryption_key)\n@@ -273,7 +273,7 @@ pub async fn get_client_module_options_context(\n         get_relay_transform_rule(next_config, project_path.clone()).await?,\n         get_emotion_transform_rule(next_config).await?,\n         get_styled_components_transform_rule(next_config).await?,\n-        get_styled_jsx_transform_rule(next_config, target_browsers).await?,\n+        get_styled_jsx_transform_rule(next_config, css_target_browsers).await?,\n         get_react_remove_properties_transform_rule(next_config).await?,\n         get_remove_console_transform_rule(next_config).await?,\n     ]"
        },
        {
            "sha": "326f4cdc58bbc11957af3fe7fb6579cbf0c969c2",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -11,7 +11,9 @@ use turbopack_core::{\n         module_id_strategies::ModuleIdStrategy,\n     },\n     compile_time_info::{CompileTimeDefines, CompileTimeInfo, FreeVarReference, FreeVarReferences},\n-    environment::{EdgeWorkerEnvironment, Environment, ExecutionEnvironment, NodeJsVersion},\n+    environment::{\n+        BrowserEnvironment, EdgeWorkerEnvironment, Environment, ExecutionEnvironment, NodeJsVersion,\n+    },\n     free_var_references,\n     module_graph::export_usage::OptionExportUsageInfo,\n };\n@@ -60,11 +62,23 @@ pub async fn get_edge_compile_time_info(\n     project_path: FileSystemPath,\n     define_env: Vc<OptionEnvMap>,\n     node_version: ResolvedVc<NodeJsVersion>,\n+    css_browserslist_query: RcStr,\n ) -> Result<Vc<CompileTimeInfo>> {\n+    let css_environment = BrowserEnvironment {\n+        dom: false,\n+        web_worker: false,\n+        service_worker: false,\n+        browserslist_query: css_browserslist_query,\n+    }\n+    .resolved_cell();\n+\n     CompileTimeInfo::builder(\n-        Environment::new(ExecutionEnvironment::EdgeWorker(\n-            EdgeWorkerEnvironment { node_version }.resolved_cell(),\n-        ))\n+        Environment::new(\n+            ExecutionEnvironment::EdgeWorker(\n+                EdgeWorkerEnvironment { node_version }.resolved_cell(),\n+            ),\n+            *css_environment,\n+        )\n         .to_resolved()\n         .await?,\n     )"
        },
        {
            "sha": "e802bdfc0b8e51a683d5b58d6b22228a8d606d07",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 28,
            "deletions": 14,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -22,7 +22,7 @@ use turbopack_core::{\n     compile_time_defines,\n     compile_time_info::{CompileTimeDefines, CompileTimeInfo, FreeVarReferences},\n     environment::{\n-        Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion, RuntimeVersions,\n+        BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion,\n     },\n     free_var_references,\n     module_graph::export_usage::OptionExportUsageInfo,\n@@ -364,16 +364,28 @@ pub async fn get_server_compile_time_info(\n     cwd: RcStr,\n     define_env: Vc<OptionEnvMap>,\n     node_version: ResolvedVc<NodeJsVersion>,\n+    css_browserslist_query: RcStr,\n ) -> Result<Vc<CompileTimeInfo>> {\n+    let css_environment = BrowserEnvironment {\n+        dom: false,\n+        web_worker: false,\n+        service_worker: false,\n+        browserslist_query: css_browserslist_query,\n+    }\n+    .resolved_cell();\n+\n     CompileTimeInfo::builder(\n-        Environment::new(ExecutionEnvironment::NodeJsLambda(\n-            NodeJsEnvironment {\n-                compile_target: CompileTarget::current().to_resolved().await?,\n-                node_version,\n-                cwd: ResolvedVc::cell(Some(cwd)),\n-            }\n-            .resolved_cell(),\n-        ))\n+        Environment::new(\n+            ExecutionEnvironment::NodeJsLambda(\n+                NodeJsEnvironment {\n+                    compile_target: CompileTarget::current().to_resolved().await?,\n+                    node_version,\n+                    cwd: ResolvedVc::cell(Some(cwd)),\n+                }\n+                .resolved_cell(),\n+            ),\n+            *css_environment,\n+        )\n         .to_resolved()\n         .await?,\n     )\n@@ -386,9 +398,10 @@ pub async fn get_server_compile_time_info(\n #[turbo_tasks::function]\n pub async fn get_tracing_compile_time_info() -> Result<Vc<CompileTimeInfo>> {\n     CompileTimeInfo::builder(\n-        Environment::new(ExecutionEnvironment::NodeJsLambda(\n-            NodeJsEnvironment::default().resolved_cell(),\n-        ))\n+        Environment::new(\n+            ExecutionEnvironment::NodeJsLambda(NodeJsEnvironment::default().resolved_cell()),\n+            BrowserEnvironment::default().cell(),\n+        )\n         .to_resolved()\n         .await?,\n     )\n@@ -505,7 +518,7 @@ pub async fn get_server_module_options_context(\n     let tree_shaking_mode_for_foreign_code = *next_config\n         .tree_shaking_mode_for_foreign_code(next_mode.is_development())\n         .await?;\n-    let versions = RuntimeVersions(Default::default()).cell();\n+    let css_versions = environment.css_runtime_versions();\n \n     // ModuleOptionsContext related options\n     let tsconfig = get_typescript_transform_options(project_path.clone())\n@@ -546,7 +559,8 @@ pub async fn get_server_module_options_context(\n     // context type.\n     let styled_components_transform_rule =\n         get_styled_components_transform_rule(next_config).await?;\n-    let styled_jsx_transform_rule = get_styled_jsx_transform_rule(next_config, versions).await?;\n+    let styled_jsx_transform_rule =\n+        get_styled_jsx_transform_rule(next_config, css_versions).await?;\n \n     let source_maps = if *next_config.server_source_maps().await? {\n         SourceMapsType::Full"
        },
        {
            "sha": "c1d5879ce8ed98fdf522cd3fb4216b972d270153",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 24,
            "deletions": 15,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -237,9 +237,12 @@ async fn build_internal(\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n-                Environment::new(ExecutionEnvironment::NodeJsLambda(\n-                    NodeJsEnvironment::default().resolved_cell(),\n-                ))\n+                Environment::new(\n+                    ExecutionEnvironment::NodeJsLambda(\n+                        NodeJsEnvironment::default().resolved_cell(),\n+                    ),\n+                    compile_time_info.css_environment(),\n+                )\n                 .to_resolved()\n                 .await?,\n                 runtime_type,\n@@ -321,22 +324,25 @@ async fn build_internal(\n \n     let chunking_context: Vc<Box<dyn ChunkingContext>> = match target {\n         Target::Browser => {\n+            let browser_environment = BrowserEnvironment {\n+                dom: true,\n+                web_worker: false,\n+                service_worker: false,\n+                browserslist_query: browserslist_query.clone(),\n+            }\n+            .resolved_cell();\n+\n             let mut builder = BrowserChunkingContext::builder(\n                 project_path,\n                 build_output_root.clone(),\n                 build_output_root_to_root_path,\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n-                Environment::new(ExecutionEnvironment::Browser(\n-                    BrowserEnvironment {\n-                        dom: true,\n-                        web_worker: false,\n-                        service_worker: false,\n-                        browserslist_query: browserslist_query.clone(),\n-                    }\n-                    .resolved_cell(),\n-                ))\n+                Environment::new(\n+                    ExecutionEnvironment::Browser(browser_environment),\n+                    *browser_environment,\n+                )\n                 .to_resolved()\n                 .await?,\n                 runtime_type,\n@@ -382,9 +388,12 @@ async fn build_internal(\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n-                Environment::new(ExecutionEnvironment::NodeJsLambda(\n-                    NodeJsEnvironment::default().resolved_cell(),\n-                ))\n+                Environment::new(\n+                    ExecutionEnvironment::NodeJsLambda(\n+                        NodeJsEnvironment::default().resolved_cell(),\n+                    ),\n+                    BrowserEnvironment::default().cell(),\n+                )\n                 .to_resolved()\n                 .await?,\n                 runtime_type,"
        },
        {
            "sha": "6eb456a006fba7f0d5090ddcfc669b16699913a8",
            "filename": "turbopack/crates/turbopack-cli/src/contexts.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 11,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -199,18 +199,19 @@ pub async fn get_client_compile_time_info(\n     node_env: Vc<NodeEnv>,\n ) -> Result<Vc<CompileTimeInfo>> {\n     let node_env = node_env.await?;\n+\n+    let environment = BrowserEnvironment {\n+        dom: true,\n+        web_worker: false,\n+        service_worker: false,\n+        browserslist_query,\n+    }\n+    .resolved_cell();\n+\n     CompileTimeInfo::builder(\n-        Environment::new(ExecutionEnvironment::Browser(\n-            BrowserEnvironment {\n-                dom: true,\n-                web_worker: false,\n-                service_worker: false,\n-                browserslist_query,\n-            }\n-            .resolved_cell(),\n-        ))\n-        .to_resolved()\n-        .await?,\n+        Environment::new(ExecutionEnvironment::Browser(environment), *environment)\n+            .to_resolved()\n+            .await?,\n     )\n     .defines(client_defines(&node_env).resolved_cell())\n     .free_var_references("
        },
        {
            "sha": "a625d8828d36a7327039f552fa552dc192c750b5",
            "filename": "turbopack/crates/turbopack-core/src/compile_time_info.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -4,7 +4,7 @@ use turbo_rcstr::RcStr;\n use turbo_tasks::{FxIndexMap, NonLocalValue, ResolvedVc, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n \n-use crate::environment::Environment;\n+use crate::environment::{BrowserEnvironment, Environment};\n \n #[macro_export]\n macro_rules! definable_name_map_pattern_internal {\n@@ -349,6 +349,11 @@ impl CompileTimeInfo {\n     pub fn environment(&self) -> Vc<Environment> {\n         *self.environment\n     }\n+\n+    #[turbo_tasks::function]\n+    pub async fn css_environment(&self) -> Result<Vc<BrowserEnvironment>> {\n+        Ok(self.environment.css_environment())\n+    }\n }\n \n pub struct CompileTimeInfoBuilder {"
        },
        {
            "sha": "3809236eb331203e2c56dc71758d457f721a2321",
            "filename": "turbopack/crates/turbopack-core/src/environment.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -42,13 +42,20 @@ pub enum ChunkLoading {\n pub struct Environment {\n     // members must be private to avoid leaking non-custom types\n     execution: ExecutionEnvironment,\n+    css_environment: ResolvedVc<BrowserEnvironment>,\n }\n \n #[turbo_tasks::value_impl]\n impl Environment {\n     #[turbo_tasks::function]\n-    pub fn new(execution: ExecutionEnvironment) -> Vc<Self> {\n-        Self::cell(Environment { execution })\n+    pub async fn new(\n+        execution: ExecutionEnvironment,\n+        css_environment: ResolvedVc<BrowserEnvironment>,\n+    ) -> Vc<Self> {\n+        Self::cell(Environment {\n+            execution,\n+            css_environment,\n+        })\n     }\n }\n \n@@ -100,6 +107,17 @@ impl Environment {\n         })\n     }\n \n+    #[turbo_tasks::function]\n+    pub fn css_environment(&self) -> Vc<BrowserEnvironment> {\n+        *self.css_environment\n+    }\n+\n+    #[turbo_tasks::function]\n+    pub async fn css_runtime_versions(&self) -> Result<Vc<RuntimeVersions>> {\n+        let distribs = resolve_browserslist(self.css_environment).await?;\n+        Ok(Vc::cell(Versions::parse_versions(distribs)?))\n+    }\n+\n     #[turbo_tasks::function]\n     pub async fn browserslist_query(&self) -> Result<Vc<RcStr>> {\n         Ok(match self.execution {\n@@ -317,6 +335,7 @@ impl Default for NodeJsVersion {\n }\n \n #[turbo_tasks::value(shared)]\n+#[derive(Default)]\n pub struct BrowserEnvironment {\n     pub dom: bool,\n     pub web_worker: bool,"
        },
        {
            "sha": "59bac81b6adf28113f37c9fd8cab632923e8154b",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/analyzer.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 9,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -14,7 +14,9 @@ use turbo_tasks::ResolvedVc;\n use turbo_tasks_testing::VcStorage;\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n-    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion},\n+    environment::{\n+        BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion,\n+    },\n     target::CompileTarget,\n };\n use turbopack_ecmascript::analyzer::{\n@@ -102,15 +104,20 @@ fn bench_link(b: &mut Bencher, input: &BenchInput) {\n         let var_cache = Default::default();\n         for val in input.var_graph.values.values() {\n             VcStorage::with(async {\n+                let css_environment = BrowserEnvironment::default().cell();\n+\n                 let compile_time_info = CompileTimeInfo::builder(\n-                    Environment::new(ExecutionEnvironment::NodeJsLambda(\n-                        NodeJsEnvironment {\n-                            compile_target: CompileTarget::unknown().to_resolved().await?,\n-                            node_version: NodeJsVersion::default().resolved_cell(),\n-                            cwd: ResolvedVc::cell(None),\n-                        }\n-                        .resolved_cell(),\n-                    ))\n+                    Environment::new(\n+                        ExecutionEnvironment::NodeJsLambda(\n+                            NodeJsEnvironment {\n+                                compile_target: CompileTarget::unknown().to_resolved().await?,\n+                                node_version: NodeJsVersion::default().resolved_cell(),\n+                                cwd: ResolvedVc::cell(None),\n+                            }\n+                            .resolved_cell(),\n+                        ),\n+                        css_environment,\n+                    )\n                     .to_resolved()\n                     .await?,\n                 )"
        },
        {
            "sha": "badc61a120d1162b1d8338334e6037dcad191399",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/references.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -9,7 +9,7 @@ use turbo_tasks_backend::{\n use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n-    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n };\n@@ -41,9 +41,10 @@ pub fn benchmark(c: &mut Criterion) {\n             let root_dir = PathBuf::from(env!(\"CARGO_MANIFEST_DIR\")).join(\"tests/benches/\");\n             let fs = DiskFileSystem::new(rcstr!(\"project\"), root_dir.to_str().unwrap().into());\n \n-            let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n-                NodeJsEnvironment::default().resolved_cell(),\n-            ));\n+            let environment = Environment::new(\n+                ExecutionEnvironment::NodeJsLambda(NodeJsEnvironment::default().resolved_cell()),\n+                BrowserEnvironment::default().cell(),\n+            );\n             let compile_time_info = CompileTimeInfo::new(environment).to_resolved().await?;\n             let layer = Layer::new(rcstr!(\"test\"));\n             let module_asset_context = NoopAssetContext {"
        },
        {
            "sha": "939e9db6ba148315acc8feb08ac82259212790d8",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/mod.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 13,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -3777,7 +3777,9 @@ mod tests {\n     use turbo_tasks::{ResolvedVc, util::FormatDuration};\n     use turbopack_core::{\n         compile_time_info::CompileTimeInfo,\n-        environment::{Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion},\n+        environment::{\n+            BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion,\n+        },\n         target::{Arch, CompileTarget, Endianness, Libc, Platform},\n     };\n \n@@ -4177,21 +4179,26 @@ mod tests {\n         var_cache: &Mutex<FxHashMap<Id, JsValue>>,\n     ) -> (JsValue, u32) {\n         turbo_tasks_testing::VcStorage::with(async {\n+            let css_environment = BrowserEnvironment::default().resolved_cell();\n+\n             let compile_time_info = CompileTimeInfo::builder(\n-                Environment::new(ExecutionEnvironment::NodeJsLambda(\n-                    NodeJsEnvironment {\n-                        compile_target: CompileTarget {\n-                            arch: Arch::X64,\n-                            platform: Platform::Linux,\n-                            endianness: Endianness::Little,\n-                            libc: Libc::Glibc,\n+                Environment::new(\n+                    ExecutionEnvironment::NodeJsLambda(\n+                        NodeJsEnvironment {\n+                            compile_target: CompileTarget {\n+                                arch: Arch::X64,\n+                                platform: Platform::Linux,\n+                                endianness: Endianness::Little,\n+                                libc: Libc::Glibc,\n+                            }\n+                            .resolved_cell(),\n+                            node_version: NodeJsVersion::default().resolved_cell(),\n+                            cwd: ResolvedVc::cell(None),\n                         }\n                         .resolved_cell(),\n-                        node_version: NodeJsVersion::default().resolved_cell(),\n-                        cwd: ResolvedVc::cell(None),\n-                    }\n-                    .resolved_cell(),\n-                ))\n+                    ),\n+                    *css_environment,\n+                )\n                 .to_resolved()\n                 .await?,\n             )"
        },
        {
            "sha": "4f602ec37b6c769d805c6b281ad247ae69f5b43b",
            "filename": "turbopack/crates/turbopack-nft/src/nft.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -12,7 +12,7 @@ use turbopack_cli_utils::issue::{ConsoleUi, LogOptions};\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     context::AssetContext,\n-    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     issue::{IssueReporter, IssueSeverity, handle_issues},\n@@ -69,9 +69,10 @@ async fn node_file_trace_operation(\n     let input = input_dir.join(&format!(\"{input}\"))?;\n \n     let source = FileSource::new(input);\n-    let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n-        NodeJsEnvironment::default().resolved_cell(),\n-    ));\n+    let environment = Environment::new(\n+        ExecutionEnvironment::NodeJsLambda(NodeJsEnvironment::default().resolved_cell()),\n+        BrowserEnvironment::default().cell(),\n+    );\n     let module_asset_context = ModuleAssetContext::new(\n         Default::default(),\n         // This config should be kept in sync with"
        },
        {
            "sha": "fde70f95c6c8a408031a9ac7d3f8feef7fd08412",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -36,7 +36,7 @@ use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     condition::ContextCondition,\n     context::AssetContext,\n-    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     issue::IssueDescriptionExt,\n@@ -352,9 +352,10 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n         .get_relative_path_to(project_root)\n         .context(\"Project path is in root path\")?;\n \n-    let env = Environment::new(ExecutionEnvironment::NodeJsBuildTime(\n-        NodeJsEnvironment::default().resolved_cell(),\n-    ))\n+    let env = Environment::new(\n+        ExecutionEnvironment::NodeJsBuildTime(NodeJsEnvironment::default().resolved_cell()),\n+        BrowserEnvironment::default().cell(),\n+    )\n     .to_resolved()\n     .await?;\n "
        },
        {
            "sha": "fb4e2075337b9aee604435253573c60bc5955fc4",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 17,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -274,28 +274,33 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n \n     let entry_asset = project_path.join(&options.entry)?;\n \n-    let env = Environment::new(match options.environment {\n+    let env = match options.environment {\n         SnapshotEnvironment::Browser => {\n-            ExecutionEnvironment::Browser(\n-                // TODO: load more from options.json\n-                BrowserEnvironment {\n-                    dom: true,\n-                    web_worker: false,\n-                    service_worker: false,\n-                    browserslist_query: options.browserslist.into(),\n-                }\n-                .resolved_cell(),\n-            )\n+            let environment=// TODO: load more from options.json\n+            BrowserEnvironment {\n+                dom: true,\n+                web_worker: false,\n+                service_worker: false,\n+                browserslist_query: options.browserslist.into(),\n+            }\n+            .resolved_cell();\n+\n+            Environment::new(ExecutionEnvironment::Browser(environment), *environment)\n+                .to_resolved()\n+                .await?\n         }\n         SnapshotEnvironment::NodeJs => {\n-            ExecutionEnvironment::NodeJsBuildTime(\n-                // TODO: load more from options.json\n-                NodeJsEnvironment::default().resolved_cell(),\n+            Environment::new(\n+                ExecutionEnvironment::NodeJsBuildTime(\n+                    // TODO: load more from options.json\n+                    NodeJsEnvironment::default().resolved_cell(),\n+                ),\n+                BrowserEnvironment::default().cell(),\n             )\n+            .to_resolved()\n+            .await?\n         }\n-    })\n-    .to_resolved()\n-    .await?;\n+    };\n \n     let mut defines = compile_time_defines!(\n         process.turbopack = true,"
        },
        {
            "sha": "73da001083bf9c149f9a5dcb184f42b4de3f6e12",
            "filename": "turbopack/crates/turbopack/benches/node_file_trace.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack%2Fbenches%2Fnode_file_trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack%2Fbenches%2Fnode_file_trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fbenches%2Fnode_file_trace.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -14,7 +14,7 @@ use turbopack::{\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     context::AssetContext,\n-    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     rebase::RebasedAsset,\n@@ -88,9 +88,12 @@ fn bench_emit(b: &mut Bencher, bench_input: &BenchInput) {\n \n                 let source = FileSource::new(input);\n                 let compile_time_info = CompileTimeInfo::builder(\n-                    Environment::new(ExecutionEnvironment::NodeJsLambda(\n-                        NodeJsEnvironment::default().resolved_cell(),\n-                    ))\n+                    Environment::new(\n+                        ExecutionEnvironment::NodeJsLambda(\n+                            NodeJsEnvironment::default().resolved_cell(),\n+                        ),\n+                        BrowserEnvironment::default().cell(),\n+                    )\n                     .to_resolved()\n                     .await?,\n                 )"
        },
        {
            "sha": "af136d4ec6af7453f7748c2bac3ca10d3a4bb6ad",
            "filename": "turbopack/crates/turbopack/examples/turbopack.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack%2Fexamples%2Fturbopack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack%2Fexamples%2Fturbopack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fexamples%2Fturbopack.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -17,7 +17,7 @@ use turbopack_core::{\n     PROJECT_FILESYSTEM_NAME,\n     compile_time_info::CompileTimeInfo,\n     context::AssetContext,\n-    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     rebase::RebasedAsset,\n@@ -49,9 +49,12 @@ async fn main() -> Result<()> {\n             let source = FileSource::new(entry);\n             let module_asset_context = turbopack::ModuleAssetContext::new(\n                 Default::default(),\n-                CompileTimeInfo::new(Environment::new(ExecutionEnvironment::NodeJsLambda(\n-                    NodeJsEnvironment::default().resolved_cell(),\n-                ))),\n+                CompileTimeInfo::new(Environment::new(\n+                    ExecutionEnvironment::NodeJsLambda(\n+                        NodeJsEnvironment::default().resolved_cell(),\n+                    ),\n+                    BrowserEnvironment::default().cell(),\n+                )),\n                 Default::default(),\n                 ResolveOptionsContext {\n                     enable_typescript: true,"
        },
        {
            "sha": "190cb23d914e1533b44d1f9c76ca86b6f24250ee",
            "filename": "turbopack/crates/turbopack/src/evaluate_context.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fevaluate_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fevaluate_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fevaluate_context.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -8,7 +8,7 @@ use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     condition::ContextCondition,\n     context::AssetContext,\n-    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n     ident::Layer,\n     resolve::options::{ImportMap, ImportMapping},\n };\n@@ -24,9 +24,10 @@ use crate::{\n \n #[turbo_tasks::function]\n pub fn node_build_environment() -> Vc<Environment> {\n-    Environment::new(ExecutionEnvironment::NodeJsBuildTime(\n-        NodeJsEnvironment::default().resolved_cell(),\n-    ))\n+    Environment::new(\n+        ExecutionEnvironment::NodeJsBuildTime(NodeJsEnvironment::default().resolved_cell()),\n+        BrowserEnvironment::default().cell(),\n+    )\n }\n \n #[turbo_tasks::function]"
        },
        {
            "sha": "2425d65855b15ad258e9711e4c1c78ddf59b1f23",
            "filename": "turbopack/crates/turbopack/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs?ref=a9d62b0d8ef862aaaed21b09fa004cbcf795ca0f",
            "patch": "@@ -40,7 +40,7 @@ use turbopack::{\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     context::AssetContext,\n-    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     output::OutputAsset,\n@@ -346,9 +346,10 @@ async fn node_file_trace_operation(\n     let output_dir = output_fs.root().owned().await?;\n \n     let source = FileSource::new(input);\n-    let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n-        NodeJsEnvironment::default().resolved_cell(),\n-    ));\n+    let environment = Environment::new(\n+        ExecutionEnvironment::NodeJsLambda(NodeJsEnvironment::default().resolved_cell()),\n+        BrowserEnvironment::default().cell(),\n+    );\n     let module_asset_context = ModuleAssetContext::new(\n         Default::default(),\n         // TODO These test cases should move into the `node-file-trace` crate and use the same"
        }
    ],
    "stats": {
        "total": 348,
        "additions": 221,
        "deletions": 127
    }
}