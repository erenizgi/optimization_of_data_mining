{
    "author": "gaojude",
    "message": "Check cache busting search params on all RSC requests (#80669)\n\nFor all RSC requests, we require the `_rsc` search param to match the\nhash of its corresponding RSC headers. In the case where the match\nfails, we respond with a redirect to the correct search param. This hash\ncheck only applies to `next start` mode for now.",
    "sha": "6fd6ed1ea23e2afdef9404d88681bed758f8b071",
    "files": [
        {
            "sha": "a57b9c1b183f726605a0580b7bf73e2e353be6b7",
            "filename": "packages/next/src/client/components/router-reducer/set-cache-busting-search-param.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 6,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fset-cache-busting-search-param.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fset-cache-busting-search-param.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fset-cache-busting-search-param.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -36,12 +36,29 @@ export const setCacheBustingSearchParam = (\n     headers[NEXT_ROUTER_STATE_TREE_HEADER],\n     headers[NEXT_URL]\n   )\n-  if (uniqueCacheKey === null) {\n-    // None of our custom request headers are present. We don't need to set a\n-    // cache-busting search param.\n-    return\n-  }\n+  setCacheBustingSearchParamWithHash(url, uniqueCacheKey)\n+}\n \n+/**\n+ * Sets a cache-busting search parameter on a URL using a provided hash value.\n+ *\n+ * This function performs the same logic as `setCacheBustingSearchParam` but accepts\n+ * a pre-computed hash instead of computing it from headers.\n+ *\n+ * Example:\n+ * URL before: https://example.com/path?query=1\n+ * hash: \"abc123\"\n+ * URL after: https://example.com/path?query=1&_rsc=abc123\n+ *\n+ * If the hash is null, we will set `_rsc` search param without a value.\n+ * Like this: https://example.com/path?query=1&_rsc\n+ *\n+ * Note: This function mutates the input URL directly and does not return anything.\n+ */\n+export const setCacheBustingSearchParamWithHash = (\n+  url: URL,\n+  hash: string\n+): void => {\n   /**\n    * Note that we intentionally do not use `url.searchParams.set` here:\n    *\n@@ -64,6 +81,10 @@ export const setCacheBustingSearchParam = (\n     .split('&')\n     .filter((pair) => pair && !pair.startsWith(`${NEXT_RSC_UNION_QUERY}=`))\n \n-  pairs.push(`${NEXT_RSC_UNION_QUERY}=${uniqueCacheKey}`)\n+  if (hash.length > 0) {\n+    pairs.push(`${NEXT_RSC_UNION_QUERY}=${hash}`)\n+  } else {\n+    pairs.push(`${NEXT_RSC_UNION_QUERY}`)\n+  }\n   url.search = pairs.length ? `?${pairs.join('&')}` : ''\n }"
        },
        {
            "sha": "b8c3079d3b38155acc00b66298d31c55d85601f7",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -11,6 +11,9 @@ import {\n   NEXT_ROUTER_STATE_TREE_HEADER,\n   ACTION_HEADER,\n   NEXT_ACTION_NOT_FOUND_HEADER,\n+  NEXT_ROUTER_PREFETCH_HEADER,\n+  NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n+  NEXT_URL,\n } from '../../client/components/app-router-headers'\n import {\n   getAccessFallbackHTTPStatus,\n@@ -54,6 +57,7 @@ import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.exte\n import { InvariantError } from '../../shared/lib/invariant-error'\n import { executeRevalidates } from '../revalidation-utils'\n import { getRequestMeta } from '../request-meta'\n+import { setCacheBustingSearchParam } from '../../client/components/router-reducer/set-cache-busting-search-param'\n \n function formDataFromSearchQueryString(query: string) {\n   const searchParams = new URLSearchParams(query)\n@@ -339,6 +343,20 @@ async function createRedirectRenderResult(\n     forwardedHeaders.delete(ACTION_HEADER)\n \n     try {\n+      setCacheBustingSearchParam(fetchUrl, {\n+        [NEXT_ROUTER_PREFETCH_HEADER]: forwardedHeaders.get(\n+          NEXT_ROUTER_PREFETCH_HEADER\n+        )\n+          ? ('1' as const)\n+          : undefined,\n+        [NEXT_ROUTER_SEGMENT_PREFETCH_HEADER]:\n+          forwardedHeaders.get(NEXT_ROUTER_SEGMENT_PREFETCH_HEADER) ??\n+          undefined,\n+        [NEXT_ROUTER_STATE_TREE_HEADER]:\n+          forwardedHeaders.get(NEXT_ROUTER_STATE_TREE_HEADER) ?? undefined,\n+        [NEXT_URL]: forwardedHeaders.get(NEXT_URL) ?? undefined,\n+      })\n+\n       const response = await fetch(fetchUrl, {\n         method: 'GET',\n         headers: forwardedHeaders,"
        },
        {
            "sha": "5611478f0caef445798f8d98b13840433d269fd0",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 19,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -171,6 +171,7 @@ import { getCacheHandlers } from './use-cache/handlers'\n import { fixMojibake } from './lib/fix-mojibake'\n import { computeCacheBustingSearchParam } from '../shared/lib/router/utils/cache-busting-search-param'\n import { RedirectStatusCode } from '../client/components/redirect-status-code'\n+import { setCacheBustingSearchParamWithHash } from '../client/components/router-reducer/set-cache-busting-search-param'\n \n export type FindComponentsResult = {\n   components: LoadComponentsReturnType\n@@ -2055,27 +2056,19 @@ export default abstract class Server<\n     const isPossibleServerAction = getIsPossibleServerAction(req)\n     const hasGetInitialProps = !!components.Component?.getInitialProps\n     let isSSG = !!components.getStaticProps\n+    // NOTE: Don't delete headers[RSC] yet, it still needs to be used in renderToHTML later\n+    const isRSCRequest = getRequestMeta(req, 'isRSCRequest') ?? false\n \n     // Not all CDNs respect the Vary header when caching. We must assume that\n     // only the URL is used to vary the responses. The Next client computes a\n     // hash of the header values and sends it as a search param. Before\n     // responding to a request, we must verify that the hash matches the\n     // expected value. Neglecting to do this properly can lead to cache\n     // poisoning attacks on certain CDNs.\n-    // TODO: This is verification only runs during per-segment prefetch\n-    // requests, since those are the only ones that both vary on a custom\n-    // header and are cacheable. But for safety, we should run this\n-    // verification for all requests, once we confirm the behavior is correct.\n-    // Will need to update our test suite, since there are a handlful of unit\n-    // tests that send fetch requests with custom headers but without a\n-    // corresponding cache-busting search param.\n-    // TODO: Consider not using custom request headers at all, and instead fully\n-    // encode everything into the search param.\n     if (\n       !this.minimalMode &&\n       this.nextConfig.experimental.validateRSCRequestHeaders &&\n-      this.isAppSegmentPrefetchEnabled &&\n-      getRequestMeta(req, 'segmentPrefetchRSCRequest')\n+      isRSCRequest\n     ) {\n       const headers = req.headers\n       const expectedHash = computeCacheBustingSearchParam(\n@@ -2084,12 +2077,22 @@ export default abstract class Server<\n         headers[NEXT_ROUTER_STATE_TREE_HEADER.toLowerCase()],\n         headers[NEXT_URL.toLowerCase()]\n       )\n-      const actualHash = getRequestMeta(req, 'cacheBustingSearchParam') ?? null\n+      const actualHash =\n+        getRequestMeta(req, 'cacheBustingSearchParam') ??\n+        new URL(req.url || '', 'http://localhost').searchParams.get(\n+          NEXT_RSC_UNION_QUERY\n+        )\n+\n       if (expectedHash !== actualHash) {\n         // The hash sent by the client does not match the expected value.\n-        // Respond with an error.\n-        res.statusCode = 400\n-        res.setHeader('content-type', 'text/plain')\n+        // Redirect to the URL with the correct cache-busting search param.\n+        // This prevents cache poisoning attacks on CDNs that don't respect Vary headers.\n+        // Note: When no headers are present, expectedHash is empty string and client\n+        // must send `_rsc` param, otherwise actualHash is null and hash check fails.\n+        const url = new URL(req.url || '', 'http://localhost')\n+        setCacheBustingSearchParamWithHash(url, expectedHash)\n+        res.statusCode = 307\n+        res.setHeader('location', `${url.pathname}${url.search}`)\n         res.body('').send()\n         return null\n       }\n@@ -2173,10 +2176,6 @@ export default abstract class Server<\n     const isPrefetchRSCRequest =\n       getRequestMeta(req, 'isPrefetchRSCRequest') ?? false\n \n-    // NOTE: Don't delete headers[RSC] yet, it still needs to be used in renderToHTML later\n-\n-    const isRSCRequest = getRequestMeta(req, 'isRSCRequest') ?? false\n-\n     // when we are handling a middleware prefetch and it doesn't\n     // resolve to a static data route we bail early to avoid\n     // unexpected SSR invocations"
        },
        {
            "sha": "a9cec3204ee3fe242982cdce6c96c0ef6083d7f4",
            "filename": "packages/next/src/shared/lib/router/utils/cache-busting-search-param.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fcache-busting-search-param.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fcache-busting-search-param.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fcache-busting-search-param.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -5,14 +5,14 @@ export function computeCacheBustingSearchParam(\n   segmentPrefetchHeader: string | string[] | undefined,\n   stateTreeHeader: string | string[] | undefined,\n   nextUrlHeader: string | string[] | undefined\n-): string | null {\n+): string {\n   if (\n     prefetchHeader === undefined &&\n     segmentPrefetchHeader === undefined &&\n     stateTreeHeader === undefined &&\n     nextUrlHeader === undefined\n   ) {\n-    return null\n+    return ''\n   }\n   return hexHash(\n     ["
        },
        {
            "sha": "78523e24454d84171c94cffd233af3760b37a3da",
            "filename": "test/e2e/app-dir/app-inline-css/index.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fapp-inline-css%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fapp-inline-css%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-inline-css%2Findex.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { NEXT_RSC_UNION_QUERY } from 'next/dist/client/components/app-router-headers'\n describe('app dir - css - experimental inline css', () => {\n   const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n@@ -17,7 +18,7 @@ describe('app dir - css - experimental inline css', () => {\n \n     it('should not return rsc payload with inlined style as a dynamic client nav', async () => {\n       const rscPayload = await (\n-        await next.fetch('/a', {\n+        await next.fetch(`/a?${NEXT_RSC_UNION_QUERY}`, {\n           method: 'GET',\n           headers: {\n             rsc: '1',\n@@ -32,7 +33,7 @@ describe('app dir - css - experimental inline css', () => {\n \n       expect(\n         await (\n-          await next.fetch('/a', {\n+          await next.fetch(`/a?${NEXT_RSC_UNION_QUERY}`, {\n             method: 'GET',\n           })\n         ).text()"
        },
        {
            "sha": "b711add3041d1b614da0379b41faeeee1e80414b",
            "filename": "test/e2e/app-dir/app-prefetch/prefetching.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 8,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -1,6 +1,7 @@\n import { nextTestSetup } from 'e2e-utils'\n import { check, waitFor, retry } from 'next-test-utils'\n import { NEXT_RSC_UNION_QUERY } from 'next/dist/client/components/app-router-headers'\n+import { computeCacheBustingSearchParam } from 'next/dist/shared/lib/router/utils/cache-busting-search-param'\n \n const browserConfigWithFixedTime = {\n   beforePageLoad: (page) => {\n@@ -294,14 +295,26 @@ describe('app dir - prefetching', () => {\n         true,\n       ])\n     )\n-    const response = await next.fetch(`/prefetch-auto/justputit?_rsc=dcqtr`, {\n-      headers: {\n-        RSC: '1',\n-        'Next-Router-Prefetch': '1',\n-        'Next-Router-State-Tree': stateTree,\n-        'Next-Url': '/prefetch-auto/vercel',\n-      },\n-    })\n+\n+    const headers = {\n+      RSC: '1',\n+      'Next-Router-Prefetch': '1',\n+      'Next-Router-State-Tree': stateTree,\n+      'Next-Url': '/prefetch-auto/vercel',\n+    }\n+\n+    const url = new URL('/prefetch-auto/justputit', 'http://localhost')\n+    const cacheBustingParam = computeCacheBustingSearchParam(\n+      headers['Next-Router-Prefetch'],\n+      undefined,\n+      headers['Next-Router-State-Tree'],\n+      headers['Next-Url']\n+    )\n+    if (cacheBustingParam) {\n+      url.searchParams.set('_rsc', cacheBustingParam)\n+    }\n+\n+    const response = await next.fetch(url.toString(), { headers })\n \n     const prefetchResponse = await response.text()\n     expect(prefetchResponse).not.toContain('Page Data!')"
        },
        {
            "sha": "ffa19fe2aa2c5f882c2ffd3ed3ae2bb103efad77",
            "filename": "test/e2e/app-dir/app-validation/validation.test.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 12,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fapp-validation%2Fvalidation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fapp-validation%2Fvalidation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-validation%2Fvalidation.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { computeCacheBustingSearchParam } from 'next/dist/shared/lib/router/utils/cache-busting-search-param'\n \n describe('app dir - validation', () => {\n   const { next, skipped } = nextTestSetup({\n@@ -11,20 +12,47 @@ describe('app dir - validation', () => {\n   }\n \n   it('should error when passing invalid router state tree', async () => {\n-    const res = await next.fetch('/', {\n-      headers: {\n-        RSC: '1',\n-        'Next-Router-State-Tree': JSON.stringify(['', '']),\n-      },\n-    })\n+    const stateTree1 = JSON.stringify(['', ''])\n+    const stateTree2 = JSON.stringify(['', {}])\n+\n+    const headers1 = {\n+      RSC: '1',\n+      'Next-Router-State-Tree': stateTree1,\n+    }\n+\n+    const headers2 = {\n+      RSC: '1',\n+      'Next-Router-State-Tree': stateTree2,\n+    }\n+\n+    const url1 = new URL('/', 'http://localhost')\n+    const url2 = new URL('/', 'http://localhost')\n+\n+    // Add cache busting search param for both requests\n+    const cacheBustingParam1 = computeCacheBustingSearchParam(\n+      undefined,\n+      undefined,\n+      stateTree1,\n+      undefined\n+    )\n+    const cacheBustingParam2 = computeCacheBustingSearchParam(\n+      undefined,\n+      undefined,\n+      stateTree2,\n+      undefined\n+    )\n+\n+    if (cacheBustingParam1) {\n+      url1.searchParams.set('_rsc', cacheBustingParam1)\n+    }\n+    if (cacheBustingParam2) {\n+      url2.searchParams.set('_rsc', cacheBustingParam2)\n+    }\n+\n+    const res = await next.fetch(url1.toString(), { headers: headers1 })\n     expect(res.status).toBe(500)\n \n-    const res2 = await next.fetch('/', {\n-      headers: {\n-        RSC: '1',\n-        'Next-Router-State-Tree': JSON.stringify(['', {}]),\n-      },\n-    })\n+    const res2 = await next.fetch(url2.toString(), { headers: headers2 })\n     expect(res2.status).toBe(200)\n   })\n })"
        },
        {
            "sha": "d8359bbf73b929d0c170194405156db44129f89a",
            "filename": "test/e2e/app-dir/app/index.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 9,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -2,6 +2,10 @@ import { nextTestSetup } from 'e2e-utils'\n import { check, retry, waitFor } from 'next-test-utils'\n import cheerio from 'cheerio'\n import stripAnsi from 'strip-ansi'\n+import {\n+  NEXT_RSC_UNION_QUERY,\n+  RSC_HEADER,\n+} from 'next/dist/client/components/app-router-headers'\n \n // TODO: We should decide on an established pattern for gating test assertions\n // on experimental flags. For example, as a first step we could all the common\n@@ -306,18 +310,21 @@ describe('app dir - basic', () => {\n   }\n \n   it('should use text/x-component for flight', async () => {\n-    const res = await next.fetch('/dashboard/deployments/123', {\n-      headers: {\n-        ['RSC'.toString()]: '1',\n-      },\n-    })\n+    const res = await next.fetch(\n+      `/dashboard/deployments/123?${NEXT_RSC_UNION_QUERY}`,\n+      {\n+        headers: {\n+          [RSC_HEADER]: '1',\n+        },\n+      }\n+    )\n     expect(res.headers.get('Content-Type')).toBe('text/x-component')\n   })\n \n   it('should use text/x-component for flight with edge runtime', async () => {\n-    const res = await next.fetch('/dashboard', {\n+    const res = await next.fetch(`/dashboard?${NEXT_RSC_UNION_QUERY}`, {\n       headers: {\n-        ['RSC'.toString()]: '1',\n+        [RSC_HEADER]: '1',\n       },\n     })\n     expect(res.headers.get('Content-Type')).toBe('text/x-component')\n@@ -332,9 +339,9 @@ describe('app dir - basic', () => {\n   })\n \n   it('should return the `vary` header from pages for flight requests', async () => {\n-    const res = await next.fetch('/', {\n+    const res = await next.fetch(`/?${NEXT_RSC_UNION_QUERY}`, {\n       headers: {\n-        ['RSC'.toString()]: '1',\n+        [RSC_HEADER]: '1',\n       },\n     })\n     expect(res.headers.get('vary')).toBe("
        },
        {
            "sha": "f02d4b721047f5f00c3c6d4fce6820e1a6a68b5b",
            "filename": "test/e2e/app-dir/ppr-full/ppr-full.test.ts",
            "status": "modified",
            "additions": 74,
            "deletions": 17,
            "changes": 91,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -3,6 +3,7 @@ import { measurePPRTimings } from 'e2e-utils/ppr'\n import { links } from './components/links'\n import cheerio from 'cheerio'\n import { retry } from 'next-test-utils'\n+import { computeCacheBustingSearchParam } from 'next/dist/shared/lib/router/utils/cache-busting-search-param'\n \n type Page = {\n   pathname: string\n@@ -46,6 +47,26 @@ const pages: Page[] = [\n   },\n ]\n \n+const addCacheBustingSearchParam = (\n+  pathname: string,\n+  headers: Record<string, string | string[] | undefined>\n+) => {\n+  const cacheKey = computeCacheBustingSearchParam(\n+    headers['Next-Router-Prefetch'],\n+    headers['Next-Router-Segment-Prefetch'],\n+    headers['Next-Router-State-Tree'],\n+    headers['Next-URL']\n+  )\n+\n+  if (cacheKey === null) {\n+    return pathname\n+  }\n+\n+  const url = new URL(pathname, 'http://localhost')\n+  url.searchParams.set('_rsc', cacheKey)\n+  return url.pathname + url.search\n+}\n+\n describe('ppr-full', () => {\n   const { next, isNextDev, isNextDeploy } = nextTestSetup({\n     files: __dirname,\n@@ -536,8 +557,17 @@ describe('ppr-full', () => {\n       describe.each(pages)('for $pathname', ({ pathname, revalidate }) => {\n         it('should have correct headers', async () => {\n           await retry(async () => {\n-            const res = await next.fetch(pathname, {\n-              headers: { RSC: '1', 'Next-Router-Prefetch': '1' },\n+            const headers = {\n+              RSC: '1',\n+              'Next-Router-Prefetch': '1',\n+            }\n+            const urlWithCacheBusting = addCacheBustingSearchParam(\n+              pathname,\n+              headers\n+            )\n+\n+            const res = await next.fetch(urlWithCacheBusting, {\n+              headers,\n             })\n \n             expect(res.status).toEqual(200)\n@@ -565,12 +595,18 @@ describe('ppr-full', () => {\n \n         it('should not contain dynamic content', async () => {\n           const unexpected = `${Date.now()}:${Math.random()}`\n-          const res = await next.fetch(pathname, {\n-            headers: {\n-              RSC: '1',\n-              'Next-Router-Prefetch': '1',\n-              'X-Test-Input': unexpected,\n-            },\n+          const headers = {\n+            RSC: '1',\n+            'Next-Router-Prefetch': '1',\n+            'X-Test-Input': unexpected,\n+          }\n+          const urlWithCacheBusting = addCacheBustingSearchParam(\n+            pathname,\n+            headers\n+          )\n+\n+          const res = await next.fetch(urlWithCacheBusting, {\n+            headers,\n           })\n           expect(res.status).toEqual(200)\n           expect(res.headers.get('content-type')).toEqual('text/x-component')\n@@ -583,8 +619,14 @@ describe('ppr-full', () => {\n     describe('Dynamic RSC Response', () => {\n       describe.each(pages)('for $pathname', ({ pathname, dynamic }) => {\n         it('should have correct headers', async () => {\n-          const res = await next.fetch(pathname, {\n-            headers: { RSC: '1' },\n+          const headers = { RSC: '1' }\n+          const urlWithCacheBusting = addCacheBustingSearchParam(\n+            pathname,\n+            headers\n+          )\n+\n+          const res = await next.fetch(urlWithCacheBusting, {\n+            headers,\n           })\n           expect(res.status).toEqual(200)\n           expect(res.headers.get('content-type')).toEqual('text/x-component')\n@@ -601,8 +643,17 @@ describe('ppr-full', () => {\n         if (dynamic === true || dynamic === 'force-dynamic') {\n           it('should contain dynamic content', async () => {\n             const expected = `${Date.now()}:${Math.random()}`\n-            const res = await next.fetch(pathname, {\n-              headers: { RSC: '1', 'X-Test-Input': expected },\n+            const headers = {\n+              RSC: '1',\n+              'X-Test-Input': expected,\n+            }\n+            const urlWithCacheBusting = addCacheBustingSearchParam(\n+              pathname,\n+              headers\n+            )\n+\n+            const res = await next.fetch(urlWithCacheBusting, {\n+              headers,\n             })\n             expect(res.status).toEqual(200)\n             expect(res.headers.get('content-type')).toEqual('text/x-component')\n@@ -612,11 +663,17 @@ describe('ppr-full', () => {\n         } else {\n           it('should not contain dynamic content', async () => {\n             const unexpected = `${Date.now()}:${Math.random()}`\n-            const res = await next.fetch(pathname, {\n-              headers: {\n-                RSC: '1',\n-                'X-Test-Input': unexpected,\n-              },\n+            const headers = {\n+              RSC: '1',\n+              'X-Test-Input': unexpected,\n+            }\n+            const urlWithCacheBusting = addCacheBustingSearchParam(\n+              pathname,\n+              headers\n+            )\n+\n+            const res = await next.fetch(urlWithCacheBusting, {\n+              headers,\n             })\n             expect(res.status).toEqual(200)\n             expect(res.headers.get('content-type')).toEqual('text/x-component')"
        },
        {
            "sha": "3384d52ece8a0ed8a5bde6ffcfb51c00f817923c",
            "filename": "test/e2e/app-dir/rewrite-headers/rewrite-headers.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Frewrite-headers.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Frewrite-headers.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Frewrite-headers.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { computeCacheBustingSearchParam } from 'next/dist/shared/lib/router/utils/cache-busting-search-param'\n \n const targets = ['x-nextjs-rewritten-path', 'x-nextjs-rewritten-query'] as const\n \n@@ -381,7 +382,29 @@ describe('rewrite-headers', () => {\n     ({ pathname, headers = {}, expected }) => {\n       let response\n       beforeAll(async () => {\n-        response = await next.fetch(pathname, { headers })\n+        const url = new URL(pathname, 'http://localhost')\n+\n+        // Add cache busting param for RSC requests\n+        if (headers.RSC === '1') {\n+          const cacheBustingParam = computeCacheBustingSearchParam(\n+            headers['Next-Router-Prefetch'],\n+            undefined,\n+            headers['Next-Router-State-Tree'],\n+            undefined\n+          )\n+          if (cacheBustingParam) {\n+            // Preserve existing search params if any\n+            const existingSearch = url.search\n+            const rawQuery = existingSearch.startsWith('?')\n+              ? existingSearch.slice(1)\n+              : existingSearch\n+            const pairs = rawQuery.split('&').filter(Boolean)\n+            pairs.push(`_rsc=${cacheBustingParam}`)\n+            url.search = pairs.length ? `?${pairs.join('&')}` : ''\n+          }\n+        }\n+\n+        response = await next.fetch(url.toString(), { headers })\n         if (response.status !== 200) {\n           throw new Error(\n             `Expected status 200, got ${response.status} for ${pathname}`"
        },
        {
            "sha": "6c69c93289769441329235f32fbba7e5db7bb675",
            "filename": "test/e2e/app-dir/rsc-basic/rsc-basic.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -2,6 +2,10 @@ import path from 'path'\n import { check } from 'next-test-utils'\n import { nextTestSetup } from 'e2e-utils'\n import cheerio from 'cheerio'\n+import {\n+  NEXT_RSC_UNION_QUERY,\n+  RSC_HEADER,\n+} from 'next/dist/client/components/app-router-headers'\n \n // TODO: We should decide on an established pattern for gating test assertions\n // on experimental flags. For example, as a first step we could all the common\n@@ -380,8 +384,10 @@ describe('app dir - rsc basics', () => {\n \n   it('should support streaming for flight response', async () => {\n     await next\n-      .fetch('/', {\n-        headers: { RSC: '1' },\n+      .fetch(`/?${NEXT_RSC_UNION_QUERY}`, {\n+        headers: {\n+          [RSC_HEADER]: '1',\n+        },\n       })\n       .then(async (response) => {\n         const result = await resolveStreamResponse(response)"
        },
        {
            "sha": "4387f1e48801a42e3fd911b2ff38ebd13387798c",
            "filename": "test/e2e/app-dir/rsc-redirect/rsc-redirect.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 7,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Frsc-redirect.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Frsc-redirect.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Frsc-redirect.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -1,5 +1,6 @@\n import { nextTestSetup } from 'e2e-utils'\n import { fetchViaHTTP } from 'next-test-utils'\n+import { NEXT_RSC_UNION_QUERY } from 'next/dist/client/components/app-router-headers'\n \n describe('rsc-redirect', () => {\n   const { next } = nextTestSetup({\n@@ -14,13 +15,17 @@ describe('rsc-redirect', () => {\n   })\n \n   it('should get 200 status code for rsc request', async () => {\n-    // TODO: add RSC cache busting query param\n-    const response = await fetchViaHTTP(next.url, '/origin', undefined, {\n-      redirect: 'manual',\n-      headers: {\n-        RSC: '1',\n-      },\n-    })\n+    const response = await fetchViaHTTP(\n+      next.url,\n+      `/origin?${NEXT_RSC_UNION_QUERY}`,\n+      undefined,\n+      {\n+        redirect: 'manual',\n+        headers: {\n+          RSC: '1',\n+        },\n+      }\n+    )\n     expect(response.status).toBe(200)\n   })\n })"
        },
        {
            "sha": "f7d45ff89326fd614b7cb13a7f0ea45a3b8e6b4b",
            "filename": "test/e2e/app-dir/segment-cache/cdn-cache-busting/cdn-cache-busting.test.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 15,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fcdn-cache-busting.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fcdn-cache-busting.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fcdn-cache-busting.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -74,23 +74,30 @@ describe('segment cache (CDN cache busting)', () => {\n   )\n \n   it(\n-    'prevent cache poisoning attacks by responding with an error if a custom ' +\n-      'header is sent during a prefetch without a corresponding cache-busting ' +\n-      'search param',\n+    'prevent cache poisoning attacks by responding with a redirect to correct ' +\n+      'cache busting query param if a custom header is sent during a prefetch ' +\n+      'without a corresponding cache-busting search param',\n     async () => {\n       const browser = await webdriver(port, '/')\n-      const { status } = await browser.eval(async () => {\n-        const res = await fetch('/target-page', {\n-          headers: {\n-            RSC: '1',\n-            'Next-Router-Prefetch': '1',\n-            'Next-Router-Segment-Prefetch': '/_tree',\n-          },\n-        })\n-        return { status: res.status, text: await res.text() }\n-      })\n-\n-      expect(status).toBe(400)\n+      const { status, responseUrl, redirected } = await browser.eval(\n+        async () => {\n+          const res = await fetch('/target-page', {\n+            headers: {\n+              RSC: '1',\n+              'Next-Router-Prefetch': '1',\n+              'Next-Router-Segment-Prefetch': '/_tree',\n+            },\n+          })\n+          return {\n+            status: res.status,\n+            responseUrl: res.url,\n+            redirected: res.redirected,\n+          }\n+        }\n+      )\n+      expect(status).toBe(200)\n+      expect(responseUrl).toContain('_rsc=')\n+      expect(redirected).toBe(true)\n     }\n   )\n "
        },
        {
            "sha": "470a6aa209ddf96ff9c0c703e7e6e8dc56fffd53",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/conflicting-routes.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -1,6 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-\n-import { computeCacheBustingSearchParam } from '../../../../../packages/next/src/shared/lib/router/utils/cache-busting-search-param'\n+import { computeCacheBustingSearchParam } from 'next/dist/shared/lib/router/utils/cache-busting-search-param'\n \n describe('conflicting routes', () => {\n   const { next, isNextDev, isNextDeploy } = nextTestSetup({"
        },
        {
            "sha": "a71a15b3d88ca01ded0074ff30fca9611f9a9f4f",
            "filename": "test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6fd6ed1ea23e2afdef9404d88681bed758f8b071/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts?ref=6fd6ed1ea23e2afdef9404d88681bed758f8b071",
            "patch": "@@ -1,5 +1,6 @@\n import { nextTestSetup } from 'e2e-utils'\n import { check } from 'next-test-utils'\n+import { NEXT_RSC_UNION_QUERY } from 'next/dist/client/components/app-router-headers'\n \n import { SavedSpan } from './constants'\n import { type Collector, connectCollector } from './collector'\n@@ -358,7 +359,7 @@ describe('opentelemetry', () => {\n           })\n \n           it('should handle RSC with fetch in RSC mode', async () => {\n-            await next.fetch('/app/param/rsc-fetch', {\n+            await next.fetch(`/app/param/rsc-fetch?${NEXT_RSC_UNION_QUERY}`, {\n               ...env.fetchInit,\n               headers: {\n                 ...env.fetchInit?.headers,\n@@ -376,7 +377,7 @@ describe('opentelemetry', () => {\n                   'http.method': 'GET',\n                   'http.route': '/app/[param]/rsc-fetch',\n                   'http.status_code': 200,\n-                  'http.target': '/app/param/rsc-fetch',\n+                  'http.target': `/app/param/rsc-fetch?${NEXT_RSC_UNION_QUERY}`,\n                   'next.route': '/app/[param]/rsc-fetch',\n                   'next.rsc': true,\n                   'next.span_name': 'RSC GET /app/[param]/rsc-fetch',"
        }
    ],
    "stats": {
        "total": 393,
        "additions": 289,
        "deletions": 104
    }
}