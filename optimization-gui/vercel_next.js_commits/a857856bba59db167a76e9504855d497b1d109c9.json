{
    "author": "eps1lon",
    "message": "ignore-list published sources if they have a sourcemap (#78242)",
    "sha": "a857856bba59db167a76e9504855d497b1d109c9",
    "files": [
        {
            "sha": "16cb16fb0855389b060186e068a412c935928306",
            "filename": "packages/next/taskfile-swc.js",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/a857856bba59db167a76e9504855d497b1d109c9/packages%2Fnext%2Ftaskfile-swc.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a857856bba59db167a76e9504855d497b1d109c9/packages%2Fnext%2Ftaskfile-swc.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftaskfile-swc.js?ref=a857856bba59db167a76e9504855d497b1d109c9",
            "patch": "@@ -166,11 +166,24 @@ if ((typeof exports.default === 'function' || (typeof exports.default === 'objec\n \n         output.code += Buffer.from(`\\n//# sourceMappingURL=${map}`)\n \n+        const sourceMapPayload = JSON.parse(output.map)\n+        if ('ignoreList' in sourceMapPayload) {\n+          throw new Error(\n+            'SWC already sets an ignoreList. We may no longer need to manually set ignoreList.'\n+          )\n+        }\n+        // ignore-list everything\n+        sourceMapPayload.ignoreList = sourceMapPayload.sources.map(\n+          (source, sourceIndex) => {\n+            return sourceIndex\n+          }\n+        )\n+\n         // add sourcemap to `files` array\n         this._.files.push({\n           base: map,\n           dir: file.dir,\n-          data: Buffer.from(output.map),\n+          data: Buffer.from(JSON.stringify(sourceMapPayload)),\n         })\n       }\n "
        },
        {
            "sha": "eb494e49c0099bd0aaeca3ac739e9b6f4277ca1c",
            "filename": "test/integration/edge-runtime-dynamic-code/test/index.test.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/a857856bba59db167a76e9504855d497b1d109c9/test%2Fintegration%2Fedge-runtime-dynamic-code%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a857856bba59db167a76e9504855d497b1d109c9/test%2Fintegration%2Fedge-runtime-dynamic-code%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fedge-runtime-dynamic-code%2Ftest%2Findex.test.js?ref=a857856bba59db167a76e9504855d497b1d109c9",
            "patch": "@@ -109,11 +109,10 @@ describe.each([\n             expect(output).toContain(\n               isTurbopack\n                 ? '' +\n+                    // TODO(veil): Turbopack duplicates project path\n                     '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/utils.js:11:16)' +\n                     '\\n    at middleware (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/middleware.js:12:52)' +\n-                    // Next.js internal frame. Feel free to adjust.\n-                    // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-                    '\\n    at'\n+                    '\\n   9 | export async function usingEval() {'\n                 : '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/lib/utils.js:11:18)' +\n                     '\\n    at middleware (../../test/integration/edge-runtime-dynamic-code/middleware.js:12:53)' +\n                     // Next.js internal frame. Feel free to adjust.\n@@ -124,9 +123,10 @@ describe.each([\n             expect(output).toContain(\n               isTurbopack\n                 ? '' +\n+                    // TODO(veil): Turbopack duplicates project path\n                     '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/utils.js:11:16)' +\n                     '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:13:22)' +\n-                    // Next.js internal frame. Feel free to adjust.\n+                    // @opentelemetry/api internal frame. Feel free to adjust.\n                     // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n                     '\\n    at'\n                 : '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/lib/utils.js:11:18)' +\n@@ -175,9 +175,10 @@ describe.each([\n                 ? '' +\n                     '\\n    at usingWebAssemblyCompile (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/wasm.js:22:17)' +\n                     '\\n    at middleware (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/middleware.js:24:68)' +\n-                    // Next.js internal frame. Feel free to adjust.\n-                    // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-                    '\\n    at'\n+                    '\\n  20 |' +\n+                    '\\n  21 | export async function usingWebAssemblyCompile(x) {' +\n+                    '\\n> 22 |   const module = await WebAssembly.compile(SQUARE_WASM_BUFFER)' +\n+                    '\\n     |                 ^'\n                 : '\\n    at usingWebAssemblyCompile (../../test/integration/edge-runtime-dynamic-code/lib/wasm.js:22:23)' +\n                     '\\n    at middleware (../../test/integration/edge-runtime-dynamic-code/middleware.js:24:68)' +\n                     // Next.js internal frame. Feel free to adjust.\n@@ -188,6 +189,7 @@ describe.each([\n             expect(output).toContain(\n               isTurbopack\n                 ? '' +\n+                    // TODO(veil): Turbopack duplicates project path\n                     '\\n    at usingWebAssemblyCompile (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/wasm.js:22:17)' +\n                     '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:17:42)' +\n                     // Next.js internal frame. Feel free to adjust.\n@@ -232,14 +234,12 @@ describe.each([\n                 ? '' +\n                     '\\n    at async usingWebAssemblyInstantiateWithBuffer (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/wasm.js:28:23)' +\n                     '\\n    at async middleware (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/middleware.js:37:29)' +\n-                    // Next.js internal frame. Feel free to adjust.\n-                    // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-                    '\\n    at'\n+                    '\\n  26 |\\n'\n                 : '' +\n                     '\\n    at async usingWebAssemblyInstantiateWithBuffer (../../test/integration/edge-runtime-dynamic-code/lib/wasm.js:28:23)' +\n                     '\\n    at async middleware (../../test/integration/edge-runtime-dynamic-code/middleware.js:37:29)' +\n                     // Next.js internal frame. Feel free to adjust.\n-                    // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n+                    // TODO(veil): https://linear.app/vercel/issue/NDX-464\n                     '\\n    at '\n             )\n             expect(stripAnsi(output)).toContain(\n@@ -254,9 +254,7 @@ describe.each([\n                     // TODO(veil): Turbopack duplicates project path\n                     '\\n    at async usingWebAssemblyInstantiateWithBuffer (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/wasm.js:28:23)' +\n                     '\\n    at async handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:21:16)' +\n-                    // Next.js internal frame. Feel free to adjust.\n-                    // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-                    '\\n    at'\n+                    '\\n  26 |'\n                 : '' +\n                     '\\n    at async usingWebAssemblyInstantiateWithBuffer (../../test/integration/edge-runtime-dynamic-code/lib/wasm.js:28:23)' +\n                     '\\n    at async handler (../../test/integration/edge-runtime-dynamic-code/pages/api/route.js:21:16)' +"
        },
        {
            "sha": "400ef94ef36dfa3a1b9979ff5675b5056219d6f0",
            "filename": "test/integration/edge-runtime-with-node.js-apis/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 8,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a857856bba59db167a76e9504855d497b1d109c9/test%2Fintegration%2Fedge-runtime-with-node.js-apis%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a857856bba59db167a76e9504855d497b1d109c9/test%2Fintegration%2Fedge-runtime-with-node.js-apis%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fedge-runtime-with-node.js-apis%2Ftest%2Findex.test.ts?ref=a857856bba59db167a76e9504855d497b1d109c9",
            "patch": "@@ -44,8 +44,6 @@ const unsupportedClasses = [\n   'WritableStreamDefaultController',\n ]\n \n-const isTurbopack = process.env.IS_TURBOPACK_TEST\n-\n describe.each([\n   {\n     title: 'Middleware',\n@@ -113,12 +111,7 @@ describe.each([\n         expect(output)\n           .toInclude(`A Node.js API is used (${api}) which is not supported in the Edge Runtime.\n Learn more: https://nextjs.org/docs/api-reference/edge-runtime`)\n-        if (isTurbopack) {\n-          expect(stripAnsi(output)).toInclude(errorHighlight)\n-        } else {\n-          // TODO(veil): Use codeframe froma stackframe that's not ignore-listed\n-          expect(stripAnsi(output)).not.toInclude(errorHighlight)\n-        }\n+        expect(stripAnsi(output)).toInclude(errorHighlight)\n       })\n     }\n   )"
        },
        {
            "sha": "9bf4a0e4c4bdcd2a88d8a98b79db3cd3bd9e71da",
            "filename": "test/integration/server-side-dev-errors/test/index.test.js",
            "status": "modified",
            "additions": 126,
            "deletions": 305,
            "changes": 431,
            "blob_url": "https://github.com/vercel/next.js/blob/a857856bba59db167a76e9504855d497b1d109c9/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a857856bba59db167a76e9504855d497b1d109c9/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js?ref=a857856bba59db167a76e9504855d497b1d109c9",
            "patch": "@@ -65,57 +65,29 @@ describe('server-side dev errors', () => {\n       })\n \n       const stderrOutput = stripAnsi(stderr.slice(stderrIdx)).trim()\n-      if (isTurbopack) {\n-        expect(stderrOutput).toContain(\n-          ' ⨯ ReferenceError: missingVar is not defined' +\n-            '\\n    at getStaticProps (../../test/integration/server-side-dev-errors/pages/gsp.js:6:2)' +\n-            // Next.js internal frame. Feel free to adjust.\n-            // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-            '\\n    at <unknown>'\n-        )\n-      } else {\n-        expect(stderrOutput).toStartWith(\n-          '⨯ ReferenceError: missingVar is not defined' +\n-            '\\n    at getStaticProps (../../test/integration/server-side-dev-errors/pages/gsp.js:6:2)' +\n-            // Next.js internal frame. Feel free to adjust.\n-            // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-            '\\n    at <unknown>'\n-        )\n-      }\n-      expect(stderr).toContain(\n-        '\\n  5 | export async function getStaticProps() {' +\n-          '\\n> 6 |   missingVar;return {'\n+\n+      expect(stderrOutput).toStartWith(\n+        '⨯ ReferenceError: missingVar is not defined' +\n+          '\\n    at getStaticProps (../../test/integration/server-side-dev-errors/pages/gsp.js:6:2)' +\n+          '\\n  4 |' +\n+          '\\n  5 | export async function getStaticProps() {' +\n+          '\\n> 6 |   missingVar;return {' +\n+          '\\n    |  ^'\n       )\n \n-      if (isTurbopack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/gsp.js (6:3) @ getStaticProps\n-         > 6 |   missingVar;return {\n-             |   ^\",\n-           \"stack\": [\n-             \"getStaticProps pages/gsp.js (6:3)\",\n-           ],\n-         }\n-        `)\n-      } else {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/gsp.js (6:3) @ getStaticProps\n-         > 6 |   missingVar;return {\n-             |   ^\",\n-           \"stack\": [\n-             \"getStaticProps pages/gsp.js (6:3)\",\n-           ],\n-         }\n-        `)\n-      }\n+      await expect(browser).toDisplayRedbox(`\n+        {\n+          \"description\": \"ReferenceError: missingVar is not defined\",\n+          \"environmentLabel\": null,\n+          \"label\": \"Runtime Error\",\n+          \"source\": \"pages/gsp.js (6:3) @ getStaticProps\n+        > 6 |   missingVar;return {\n+            |   ^\",\n+          \"stack\": [\n+            \"getStaticProps pages/gsp.js (6:3)\",\n+          ],\n+        }\n+      `)\n \n       await fs.writeFile(gspPage, content, { flush: true })\n       await assertNoRedbox(browser)\n@@ -142,57 +114,28 @@ describe('server-side dev errors', () => {\n       })\n \n       const stderrOutput = stripAnsi(stderr.slice(stderrIdx)).trim()\n-      if (isTurbopack) {\n-        expect(stderrOutput).toContain(\n-          ' ⨯ ReferenceError: missingVar is not defined' +\n-            '\\n    at getServerSideProps (../../test/integration/server-side-dev-errors/pages/gssp.js:6:2)' +\n-            // Next.js internal frame. Feel free to adjust.\n-            // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-            '\\n    at <unknown>'\n-        )\n-      } else {\n-        expect(stderrOutput).toStartWith(\n-          '⨯ ReferenceError: missingVar is not defined' +\n-            '\\n    at getServerSideProps (../../test/integration/server-side-dev-errors/pages/gssp.js:6:2)' +\n-            // Next.js internal frame. Feel free to adjust.\n-            // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-            '\\n    at <unknown>'\n-        )\n-      }\n-      expect(stderrOutput).toContain(\n-        '\\n  5 | export async function getServerSideProps() {' +\n-          '\\n> 6 |   missingVar;return {'\n+      expect(stderrOutput).toStartWith(\n+        '⨯ ReferenceError: missingVar is not defined' +\n+          '\\n    at getServerSideProps (../../test/integration/server-side-dev-errors/pages/gssp.js:6:2)' +\n+          '\\n  4 |' +\n+          '\\n  5 | export async function getServerSideProps() {' +\n+          '\\n> 6 |   missingVar;return {' +\n+          '\\n    |  ^'\n       )\n \n-      if (isTurbopack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/gssp.js (6:3) @ getServerSideProps\n-         > 6 |   missingVar;return {\n-             |   ^\",\n-           \"stack\": [\n-             \"getServerSideProps pages/gssp.js (6:3)\",\n-           ],\n-         }\n-        `)\n-      } else {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/gssp.js (6:3) @ getServerSideProps\n-         > 6 |   missingVar;return {\n-             |   ^\",\n-           \"stack\": [\n-             \"getServerSideProps pages/gssp.js (6:3)\",\n-           ],\n-         }\n-        `)\n-      }\n+      await expect(browser).toDisplayRedbox(`\n+        {\n+          \"description\": \"ReferenceError: missingVar is not defined\",\n+          \"environmentLabel\": null,\n+          \"label\": \"Runtime Error\",\n+          \"source\": \"pages/gssp.js (6:3) @ getServerSideProps\n+        > 6 |   missingVar;return {\n+            |   ^\",\n+          \"stack\": [\n+            \"getServerSideProps pages/gssp.js (6:3)\",\n+          ],\n+        }\n+      `)\n \n       await fs.writeFile(gsspPage, content)\n       await assertNoRedbox(browser)\n@@ -219,57 +162,28 @@ describe('server-side dev errors', () => {\n       })\n \n       const stderrOutput = stripAnsi(stderr.slice(stderrIdx)).trim()\n-      if (isTurbopack) {\n-        expect(stderrOutput).toContain(\n-          ' ⨯ ReferenceError: missingVar is not defined' +\n-            '\\n    at getServerSideProps (../../test/integration/server-side-dev-errors/pages/blog/[slug].js:6:2)' +\n-            // Next.js internal frame. Feel free to adjust.\n-            // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-            '\\n    at <unknown>'\n-        )\n-      } else {\n-        expect(stderrOutput).toStartWith(\n-          '⨯ ReferenceError: missingVar is not defined' +\n-            '\\n    at getServerSideProps (../../test/integration/server-side-dev-errors/pages/blog/[slug].js:6:2)' +\n-            // Next.js internal frame. Feel free to adjust.\n-            // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-            '\\n    at <unknown>'\n-        )\n-      }\n-      expect(stderrOutput).toContain(\n-        '\\n  5 | export async function getServerSideProps() {' +\n-          '\\n> 6 |   missingVar;return {'\n+      expect(stderrOutput).toStartWith(\n+        '⨯ ReferenceError: missingVar is not defined' +\n+          '\\n    at getServerSideProps (../../test/integration/server-side-dev-errors/pages/blog/[slug].js:6:2)' +\n+          '\\n  4 |' +\n+          '\\n  5 | export async function getServerSideProps() {' +\n+          '\\n> 6 |   missingVar;return {' +\n+          '\\n    |  ^'\n       )\n \n-      if (isTurbopack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/blog/[slug].js (6:3) @ getServerSideProps\n-         > 6 |   missingVar;return {\n-             |   ^\",\n-           \"stack\": [\n-             \"getServerSideProps pages/blog/[slug].js (6:3)\",\n-           ],\n-         }\n-        `)\n-      } else {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/blog/[slug].js (6:3) @ getServerSideProps\n-         > 6 |   missingVar;return {\n-             |   ^\",\n-           \"stack\": [\n-             \"getServerSideProps pages/blog/[slug].js (6:3)\",\n-           ],\n-         }\n-        `)\n-      }\n+      await expect(browser).toDisplayRedbox(`\n+        {\n+          \"description\": \"ReferenceError: missingVar is not defined\",\n+          \"environmentLabel\": null,\n+          \"label\": \"Runtime Error\",\n+          \"source\": \"pages/blog/[slug].js (6:3) @ getServerSideProps\n+        > 6 |   missingVar;return {\n+            |   ^\",\n+          \"stack\": [\n+            \"getServerSideProps pages/blog/[slug].js (6:3)\",\n+          ],\n+        }\n+      `)\n \n       await fs.writeFile(dynamicGsspPage, content)\n     } finally {\n@@ -295,89 +209,44 @@ describe('server-side dev errors', () => {\n       })\n \n       const stderrOutput = stripAnsi(stderr.slice(stderrIdx)).trim()\n-      if (isTurbopack) {\n-        expect(stderrOutput).toContain(\n-          ' ⨯ ReferenceError: missingVar is not defined' +\n-            '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/hello.js:2:2)' +\n-            // Next.js internal frame. Feel free to adjust.\n-            // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-            '\\n    at async'\n-        )\n-      } else {\n-        expect(stderrOutput).toStartWith(\n-          '⨯ ReferenceError: missingVar is not defined' +\n-            '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/hello.js:2:2)' +\n-            // Next.js internal frame. Feel free to adjust.\n-            // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-            '\\n    at async'\n-        )\n-      }\n-      expect(stderrOutput).toContain(\n-        '\\n  1 | export default function handler(req, res) {' +\n-          \"\\n> 2 |   missingVar;res.status(200).json({ hello: 'world' })\"\n+\n+      expect(stderrOutput).toStartWith(\n+        '⨯ ReferenceError: missingVar is not defined' +\n+          '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/hello.js:2:2)' +\n+          '\\n  1 | export default function handler(req, res) {' +\n+          \"\\n> 2 |   missingVar;res.status(200).json({ hello: 'world' })\" +\n+          '\\n    |  ^'\n       )\n \n-      if (isTurbopack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/api/hello.js (2:3) @ handler\n-         > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n-             |   ^\",\n-           \"stack\": [\n-             \"handler pages/api/hello.js (2:3)\",\n-           ],\n-         }\n-        `)\n-      } else {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/api/hello.js (2:3) @ handler\n-         > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n-             |   ^\",\n-           \"stack\": [\n-             \"handler pages/api/hello.js (2:3)\",\n-           ],\n-         }\n-        `)\n-      }\n+      await expect(browser).toDisplayRedbox(`\n+        {\n+          \"description\": \"ReferenceError: missingVar is not defined\",\n+          \"environmentLabel\": null,\n+          \"label\": \"Runtime Error\",\n+          \"source\": \"pages/api/hello.js (2:3) @ handler\n+        > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n+            |   ^\",\n+          \"stack\": [\n+            \"handler pages/api/hello.js (2:3)\",\n+          ],\n+        }\n+      `)\n \n       await fs.writeFile(apiPage, content)\n \n-      if (isTurbopack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/api/hello.js (2:3) @ handler\n-         > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n-             |   ^\",\n-           \"stack\": [\n-             \"handler pages/api/hello.js (2:3)\",\n-           ],\n-         }\n-        `)\n-      } else {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/api/hello.js (2:3) @ handler\n-         > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n-             |   ^\",\n-           \"stack\": [\n-             \"handler pages/api/hello.js (2:3)\",\n-           ],\n-         }\n-        `)\n-      }\n+      await expect(browser).toDisplayRedbox(`\n+        {\n+          \"description\": \"ReferenceError: missingVar is not defined\",\n+          \"environmentLabel\": null,\n+          \"label\": \"Runtime Error\",\n+          \"source\": \"pages/api/hello.js (2:3) @ handler\n+        > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n+            |   ^\",\n+          \"stack\": [\n+            \"handler pages/api/hello.js (2:3)\",\n+          ],\n+        }\n+      `)\n     } finally {\n       await fs.writeFile(apiPage, content)\n     }\n@@ -401,91 +270,43 @@ describe('server-side dev errors', () => {\n       })\n \n       const stderrOutput = stripAnsi(stderr.slice(stderrIdx)).trim()\n-      // FIXME(veil): error repeated\n-      if (isTurbopack) {\n-        expect(stderrOutput).toContain(\n-          ' ⨯ ReferenceError: missingVar is not defined' +\n-            '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js:2:2)' +\n-            // Next.js internal frame. Feel free to adjust.\n-            // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-            '\\n    at'\n-        )\n-      } else {\n-        expect(stderrOutput).toContain(\n-          ' ⨯ ReferenceError: missingVar is not defined' +\n-            '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js:2:2)' +\n-            // Next.js internal frame. Feel free to adjust.\n-            // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-            '\\n    at'\n-        )\n-      }\n-\n-      expect(stderrOutput).toContain(\n-        '\\n  1 | export default function handler(req, res) {' +\n-          '\\n> 2 |   missingVar;res.status(200).json({ slug: req.query.slug })'\n+      expect(stderrOutput).toStartWith(\n+        '⨯ ReferenceError: missingVar is not defined' +\n+          '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js:2:2)' +\n+          '\\n  1 | export default function handler(req, res) {' +\n+          '\\n> 2 |   missingVar;res.status(200).json({ slug: req.query.slug })' +\n+          '\\n    |  ^'\n       )\n \n-      if (isTurbopack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n-         > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n-             |   ^\",\n-           \"stack\": [\n-             \"handler pages/api/blog/[slug].js (2:3)\",\n-           ],\n-         }\n-        `)\n-      } else {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n-         > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n-             |   ^\",\n-           \"stack\": [\n-             \"handler pages/api/blog/[slug].js (2:3)\",\n-           ],\n-         }\n-        `)\n-      }\n+      await expect(browser).toDisplayRedbox(`\n+        {\n+          \"description\": \"ReferenceError: missingVar is not defined\",\n+          \"environmentLabel\": null,\n+          \"label\": \"Runtime Error\",\n+          \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n+        > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n+            |   ^\",\n+          \"stack\": [\n+            \"handler pages/api/blog/[slug].js (2:3)\",\n+          ],\n+        }\n+      `)\n \n       await fs.writeFile(dynamicApiPage, content)\n \n-      if (isTurbopack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n-         > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n-             |   ^\",\n-           \"stack\": [\n-             \"handler pages/api/blog/[slug].js (2:3)\",\n-           ],\n-         }\n-        `)\n-      } else {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"ReferenceError: missingVar is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n-         > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n-             |   ^\",\n-           \"stack\": [\n-             \"handler pages/api/blog/[slug].js (2:3)\",\n-           ],\n-         }\n-        `)\n-      }\n+      await expect(browser).toDisplayRedbox(`\n+        {\n+          \"description\": \"ReferenceError: missingVar is not defined\",\n+          \"environmentLabel\": null,\n+          \"label\": \"Runtime Error\",\n+          \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n+        > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n+            |   ^\",\n+          \"stack\": [\n+            \"handler pages/api/blog/[slug].js (2:3)\",\n+          ],\n+        }\n+      `)\n     } finally {\n       await fs.writeFile(dynamicApiPage, content)\n     }"
        }
    ],
    "stats": {
        "total": 481,
        "additions": 153,
        "deletions": 328
    }
}