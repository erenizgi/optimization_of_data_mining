{
    "author": "huozhi",
    "message": "[metadata] fix the metadata route like pages and refactor utils (#77264)\n\n### What\r\n\r\n- Fix the metadata route like pages rendering, e.g. `/sitemap/page.js` should still work properly rather than being treated as route\r\n- Refactor metadata utils, should prefer using the file matcher rather than just checking the route or page path if possible to determine if it's metadata route\r\n\r\nPreviously the metadata regex didn't handle the route well. For example:\r\n\r\nWhen it's not checking the end, `/opengraph-image-abc` can still be matched, but actually it's not a valid metadata route. This PR refines the route/file path regex matching for metadata entries and add more tests.\r\n\r\nThe underlayer helper - `isMetadataRouteFile`, you can use it to check if a file path is an metadata entry.\r\nThe helpers built on top of it:\r\n- `isMetadataPage`: determine if a page path is metadata route, the input is more like a pathname.\r\n- `isMetadataRoute`: determine if a route is metadata route, the input contains nextjs route suffix like `/route`.\r\n\r\nWe change the most of places to use `isMetadataRouteFile` if possible, since it's more accurate, especially when we check the static metadata routes, e.g. `/opengraph-image.png`, `/opengraph-image.js` will require the extension check and strict matching on file name convention.\r\n\r\nCloses #77250 \r\nFixes #76747",
    "sha": "f5198b48373cf7694934957833bbbdeca149fd94",
    "files": [
        {
            "sha": "4062d2a9b344cb86029e054df72517169102bdaa",
            "filename": "packages/next/src/build/webpack/loaders/next-app-loader/create-app-route-code.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Fcreate-app-route-code.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Fcreate-app-route-code.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Fcreate-app-route-code.ts?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -1,7 +1,10 @@\n import path from 'path'\n import { stringify } from 'querystring'\n import { WEBPACK_RESOURCE_QUERIES } from '../../../../lib/constants'\n-import { isMetadataRoute } from '../../../../lib/metadata/is-metadata-route'\n+import {\n+  DEFAULT_METADATA_ROUTE_EXTENSIONS,\n+  isMetadataRouteFile,\n+} from '../../../../lib/metadata/is-metadata-route'\n import type { NextConfig } from '../../../../server/config-shared'\n import { AppBundlePathNormalizer } from '../../../../server/normalizers/built/app/app-bundle-path-normalizer'\n import { AppPathnameNormalizer } from '../../../../server/normalizers/built/app/app-pathname-normalizer'\n@@ -10,13 +13,15 @@ import type { PageExtensions } from '../../../page-extensions-type'\n import { getFilenameAndExtension } from '../next-metadata-route-loader'\n \n export async function createAppRouteCode({\n+  appDir,\n   name,\n   page,\n   pagePath,\n   resolveAppRoute,\n   pageExtensions,\n   nextConfigOutput,\n }: {\n+  appDir: string\n   name: string\n   page: string\n   pagePath: string\n@@ -39,10 +44,16 @@ export async function createAppRouteCode({\n     )\n   }\n \n-  // If this is a metadata route, then we need to use the metadata loader for\n-  // the route to ensure that the route is generated.\n+  // If this is a metadata route file, then we need to use the metadata-loader\n+  // for the route to ensure that the route is generated.\n   const fileBaseName = path.parse(resolvedPagePath).name\n-  if (isMetadataRoute(name) && fileBaseName !== 'route') {\n+  const appDirRelativePath = resolvedPagePath.slice(appDir.length)\n+  const isMetadataEntryFile = isMetadataRouteFile(\n+    appDirRelativePath,\n+    DEFAULT_METADATA_ROUTE_EXTENSIONS,\n+    true\n+  )\n+  if (isMetadataEntryFile) {\n     const { ext } = getFilenameAndExtension(resolvedPagePath)\n     const isDynamicRouteExtension = pageExtensions.includes(ext)\n "
        },
        {
            "sha": "8b72ea4cc8e2b24c7cf937fa4471ecea25e2ac5f",
            "filename": "packages/next/src/build/webpack/loaders/next-app-loader/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -666,6 +666,7 @@ const nextAppLoader: AppLoader = async function nextAppLoader() {\n \n   if (isAppRouteRoute(name)) {\n     return createAppRouteCode({\n+      appDir,\n       // TODO: investigate if the local `page` is the same as the loaderOptions.page\n       page: loaderOptions.page,\n       name,"
        },
        {
            "sha": "8643121f78153b9810f453cbb3d4c57efa823bce",
            "filename": "packages/next/src/build/webpack/plugins/flight-client-entry-plugin.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 2,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -43,7 +43,10 @@ import { PAGE_TYPES } from '../../../lib/page-types'\n import { getModuleBuildInfo } from '../loaders/get-module-build-info'\n import { getAssumedSourceType } from '../loaders/next-flight-loader'\n import { isAppRouteRoute } from '../../../lib/is-app-route-route'\n-import { isMetadataRoute } from '../../../lib/metadata/is-metadata-route'\n+import {\n+  DEFAULT_METADATA_ROUTE_EXTENSIONS,\n+  isMetadataRouteFile,\n+} from '../../../lib/metadata/is-metadata-route'\n import type { MetadataRouteLoaderOptions } from '../loaders/next-metadata-route-loader'\n import type { FlightActionEntryLoaderActions } from '../loaders/next-flight-action-entry-loader'\n \n@@ -346,13 +349,27 @@ export class FlightClientEntryPlugin {\n           : entryRequest\n \n         // Replace file suffix as `.js` will be added.\n+        // bundlePath will have app/ prefix but not src/.\n+        // e.g. src/app/foo/page.js -> app/foo/page\n         let bundlePath = normalizePathSep(\n           relativeRequest.replace(/\\.[^.\\\\/]+$/, '').replace(/^src[\\\\/]/, '')\n         )\n \n         // For metadata routes, the entry name can be used as the bundle path,\n         // as it has been normalized already.\n-        if (isMetadataRoute(bundlePath)) {\n+        // e.g.\n+        // When `relativeRequest` is 'src/app/sitemap.js',\n+        // `appDirRelativeRequest` will be '/sitemap.js'\n+        // then `isMetadataEntryFile` will be `true`\n+        const appDirRelativeRequest = relativeRequest\n+          .replace(/^src[\\\\/]/, '')\n+          .replace(/^app[\\\\/]/, '/')\n+        const isMetadataEntryFile = isMetadataRouteFile(\n+          appDirRelativeRequest,\n+          DEFAULT_METADATA_ROUTE_EXTENSIONS,\n+          true\n+        )\n+        if (isMetadataEntryFile) {\n           bundlePath = name\n         }\n "
        },
        {
            "sha": "e29c9c3489809bcd4c9c38f6acead51a4e924050",
            "filename": "packages/next/src/build/webpack/plugins/next-trace-entrypoints-plugin.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -18,7 +18,7 @@ import picomatch from 'next/dist/compiled/picomatch'\n import { getModuleBuildInfo } from '../loaders/get-module-build-info'\n import { getPageFilePath } from '../../entries'\n import { resolveExternal } from '../../handle-externals'\n-import { isStaticMetadataRoutePage } from '../../../lib/metadata/is-metadata-route'\n+import { isMetadataRouteFile } from '../../../lib/metadata/is-metadata-route'\n import { getCompilationSpan } from '../utils'\n \n const PLUGIN_NAME = 'TraceEntryPointsPlugin'\n@@ -243,7 +243,7 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n \n           const entryIsStaticMetadataRoute =\n             appDirRelativeEntryPath &&\n-            isStaticMetadataRoutePage(appDirRelativeEntryPath)\n+            isMetadataRouteFile(appDirRelativeEntryPath, [], true)\n \n           // Include the client reference manifest in the trace, but not for\n           // static metadata routes, for which we don't generate those."
        },
        {
            "sha": "f38a97936cb710f8a67f31841894828b9fbe2144",
            "filename": "packages/next/src/export/routes/app-route.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-route.ts?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -23,7 +23,7 @@ import { isDynamicUsageError } from '../helpers/is-dynamic-usage-error'\n import { hasNextSupport } from '../../server/ci-info'\n import { isStaticGenEnabled } from '../../server/route-modules/app-route/helpers/is-static-gen-enabled'\n import type { ExperimentalConfig } from '../../server/config-shared'\n-import { isMetadataRouteFile } from '../../lib/metadata/is-metadata-route'\n+import { isMetadataRoute } from '../../lib/metadata/is-metadata-route'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import type { Params } from '../../server/request/params'\n import { AfterRunner } from '../../server/after/run-with-after'\n@@ -101,13 +101,13 @@ export async function exportAppRoute(\n   try {\n     const userland = module.userland\n     // we don't bail from the static optimization for\n-    // metadata routes\n-    const normalizedPage = normalizeAppPath(page)\n-    const isMetadataRoute = isMetadataRouteFile(normalizedPage, [], false)\n+    // metadata routes, since it's app-route we can always append /route suffix.\n+    const routePath = normalizeAppPath(page) + '/route'\n+    const isPageMetadataRoute = isMetadataRoute(routePath)\n \n     if (\n       !isStaticGenEnabled(userland) &&\n-      !isMetadataRoute &&\n+      !isPageMetadataRoute &&\n       // We don't disable static gen when dynamicIO is enabled because we\n       // expect that anything dynamic in the GET handler will make it dynamic\n       // and thus avoid the cache surprises that led to us removing static gen"
        },
        {
            "sha": "af1cb678808408442a793a9ab28d3d3eb3291a30",
            "filename": "packages/next/src/lib/metadata/get-metadata-route.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fget-metadata-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fget-metadata-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fget-metadata-route.ts?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -1,4 +1,4 @@\n-import { isMetadataRoute } from './is-metadata-route'\n+import { isMetadataPage } from './is-metadata-route'\n import path from '../../shared/lib/isomorphic/path'\n import { interpolateDynamicPath } from '../../server/server-utils'\n import { getNamedRouteRegex } from '../../shared/lib/router/utils/route-regex'\n@@ -83,7 +83,7 @@ export function fillMetadataSegment(\n  * @returns\n  */\n export function normalizeMetadataRoute(page: string) {\n-  if (!isMetadataRoute(page)) {\n+  if (!isMetadataPage(page)) {\n     return page\n   }\n   let route = page"
        },
        {
            "sha": "d997c5b3c1764de87a0e906566d3f63e23f688b8",
            "filename": "packages/next/src/lib/metadata/is-metadata-route.test.ts",
            "status": "modified",
            "additions": 102,
            "deletions": 1,
            "changes": 103,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fis-metadata-route.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fis-metadata-route.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fis-metadata-route.test.ts?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -1,4 +1,9 @@\n-import { getExtensionRegexString } from './is-metadata-route'\n+import {\n+  getExtensionRegexString,\n+  isMetadataRouteFile,\n+  isMetadataRoute,\n+  isMetadataPage,\n+} from './is-metadata-route'\n \n describe('getExtensionRegexString', () => {\n   function createExtensionMatchRegex(\n@@ -54,3 +59,99 @@ describe('getExtensionRegexString', () => {\n     })\n   })\n })\n+\n+describe('isMetadataRouteFile', () => {\n+  describe('match route - without extension', () => {\n+    it('should match metadata route page paths', () => {\n+      expect(isMetadataRouteFile('/icons/descriptor/page', [], false)).toBe(\n+        false\n+      )\n+      expect(isMetadataRouteFile('/foo/icon', [], false)).toBe(true)\n+      expect(isMetadataRouteFile('/foo/opengraph-image', [], false)).toBe(true)\n+      expect(isMetadataRouteFile('/foo/sitemap.xml', [], false)).toBe(true)\n+      // group routes\n+      expect(\n+        isMetadataRouteFile('/foo/opengraph-image-abc123', [], false)\n+      ).toBe(true)\n+      // These pages are not normalized from actual entry files\n+      expect(isMetadataRouteFile('/foo/sitemap/0.xml', [], false)).toBe(false)\n+      expect(\n+        isMetadataRouteFile('/foo/opengraph-image-abc12313333', [], false)\n+      ).toBe(false)\n+    })\n+  })\n+\n+  describe('match file - with extension', () => {\n+    it('should match static metadata route files', () => {\n+      expect(isMetadataRouteFile('/icons/descriptor/page', [], true)).toBe(\n+        false\n+      )\n+      expect(isMetadataRouteFile('/foo/icon.png', [], true)).toBe(true)\n+      expect(isMetadataRouteFile('/bar/opengraph-image.jpg', [], true)).toBe(\n+        true\n+      )\n+      expect(isMetadataRouteFile('/favicon.ico', [], true)).toBe(true)\n+      expect(isMetadataRouteFile('/robots.txt', [], true)).toBe(true)\n+      expect(isMetadataRouteFile('/manifest.json', [], true)).toBe(true)\n+      expect(isMetadataRouteFile('/sitemap.xml', [], true)).toBe(true)\n+    })\n+\n+    it('should match dynamic metadata routes', () => {\n+      // with dynamic extensions, passing the 2nd arg: such as ['tsx', 'ts']\n+      expect(isMetadataRouteFile('/foo/icon.js', ['tsx', 'ts'], true)).toBe(\n+        false\n+      )\n+      expect(isMetadataRouteFile('/foo/icon.ts', ['tsx', 'ts'], true)).toBe(\n+        true\n+      )\n+      expect(\n+        isMetadataRouteFile('/foo/icon.tsx', ['js', 'jsx', 'tsx', 'ts'], true)\n+      ).toBe(true)\n+    })\n+  })\n+})\n+\n+describe('isMetadataRoute', () => {\n+  it('should require suffix for metadata routes', () => {\n+    expect(isMetadataRoute('/icon')).toBe(false)\n+    expect(isMetadataRoute('/icon/route')).toBe(true)\n+    expect(isMetadataRoute('/opengraph-image')).toBe(false)\n+    expect(isMetadataRoute('/opengraph-image/route')).toBe(true)\n+  })\n+\n+  it('should match metadata routes', () => {\n+    expect(isMetadataRoute('/app/robots/route')).toBe(true)\n+    expect(isMetadataRoute('/robots/route')).toBe(true)\n+    expect(isMetadataRoute('/sitemap/[__metadata_id__]/route')).toBe(true)\n+    expect(isMetadataRoute('/app/sitemap/page')).toBe(false)\n+    expect(isMetadataRoute('/icon-a102f4/route')).toBe(true)\n+  })\n+\n+  it('should match grouped metadata routes', () => {\n+    expect(isMetadataRoute('/opengraph-image-1ow20b/route')).toBe(true)\n+    expect(isMetadataRoute('/foo/icon2-1ow20b/route')).toBe(true)\n+  })\n+\n+  it('should support metadata variant numeric suffix', () => {\n+    expect(isMetadataRoute('/icon0/route')).toBe(true)\n+    expect(isMetadataRoute('/opengraph-image1/route')).toBe(true)\n+    expect(isMetadataRoute('/foo/icon0-a120ff/route')).toBe(true)\n+    expect(isMetadataRoute('/foo/icon0-a120ff3/route')).toBe(false)\n+  })\n+})\n+\n+describe('isMetadataPage', () => {\n+  it('should match metadata page path', () => {\n+    expect(isMetadataPage('/sitemap.xml')).toBe(true)\n+    expect(isMetadataPage('/favicon.ico')).toBe(true)\n+    expect(isMetadataPage('/manifest.json')).toBe(true)\n+    expect(isMetadataPage('/robots.txt')).toBe(true)\n+  })\n+\n+  it('should not match app router page path or error boundary path', () => {\n+    expect(isMetadataPage('/icon/page')).toBe(false)\n+    expect(isMetadataPage('/icon/route')).toBe(false)\n+    expect(isMetadataPage('/icon/error')).toBe(false)\n+    expect(isMetadataPage('/icon/not-found')).toBe(false)\n+  })\n+})"
        },
        {
            "sha": "3c5f97b8be58e059f4494a9685abf97483dd63e0",
            "filename": "packages/next/src/lib/metadata/is-metadata-route.ts",
            "status": "modified",
            "additions": 93,
            "deletions": 77,
            "changes": 170,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fis-metadata-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fis-metadata-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fis-metadata-route.ts?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -1,5 +1,6 @@\n import type { PageExtensions } from '../../build/page-extensions-type'\n import { normalizePathSep } from '../../shared/lib/page-path/normalize-path-sep'\n+import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { isAppRouteRoute } from '../is-app-route-route'\n \n export const STATIC_METADATA_IMAGES = {\n@@ -27,7 +28,7 @@ export const STATIC_METADATA_IMAGES = {\n \n // Match routes that are metadata routes, e.g. /sitemap.xml, /favicon.<ext>, /<icon>.<ext>, etc.\n // TODO-METADATA: support more metadata routes with more extensions\n-const defaultExtensions = ['js', 'jsx', 'ts', 'tsx']\n+export const DEFAULT_METADATA_ROUTE_EXTENSIONS = ['js', 'jsx', 'ts', 'tsx']\n \n // Match the file extension with the dynamic multi-routes extensions\n // e.g. ([xml, js], null) -> can match `/sitemap.xml/route`, `sitemap.js/route`\n@@ -38,130 +39,145 @@ export const getExtensionRegexString = (\n ) => {\n   // If there's no possible multi dynamic routes, will not match any <name>[].<ext> files\n   if (!dynamicExtensions || dynamicExtensions.length === 0) {\n-    return `\\\\.(?:${staticExtensions.join('|')})`\n+    return `(\\\\.(?:${staticExtensions.join('|')}))`\n   }\n-  return `(?:\\\\.(${staticExtensions.join('|')})|((\\\\[\\\\])?\\\\.(${dynamicExtensions.join('|')})))`\n+  return `(?:\\\\.(${staticExtensions.join('|')})|(\\\\.(${dynamicExtensions.join('|')})))`\n }\n \n-// When you only pass the file extension as `[]`, it will only match the static convention files\n-// e.g. /robots.txt, /sitemap.xml, /favicon.ico, /manifest.json\n-// When you pass the file extension as `['js', 'jsx', 'ts', 'tsx']`, it will also match the dynamic convention files\n-// e.g. /robots.js, /sitemap.tsx, /favicon.jsx, /manifest.ts\n-// When `withExtension` is false, it will match the static convention files without the extension, by default it's true\n-// e.g. /robots, /sitemap, /favicon, /manifest, use to match dynamic API routes like app/robots.ts\n+/**\n+ * Determine if the file is a metadata route file entry\n+ * @param appDirRelativePath the relative file path to app/\n+ * @param pageExtensions the js extensions, such as ['js', 'jsx', 'ts', 'tsx']\n+ * @param strictlyMatchExtensions if it's true, match the file with page extension, otherwise match the file with default corresponding extension\n+ * @returns {boolean} if the file is a metadata route file\n+ */\n export function isMetadataRouteFile(\n   appDirRelativePath: string,\n   pageExtensions: PageExtensions,\n-  withExtension: boolean\n+  strictlyMatchExtensions: boolean\n ) {\n+  // End with the extension or optional to have the extension\n+  // When strictlyMatchExtensions is true, it's used for match file path;\n+  // When strictlyMatchExtensions, the dynamic extension is skipped but\n+  // static extension is kept, which is usually used for matching route path.\n+  const trailingMatcher = (strictlyMatchExtensions ? '' : '?') + '$'\n+  // Match the optional variants like /opengraph-image2, /icon-a102f4.png, etc.\n+  const variantsMatcher = '\\\\d?'\n+  // The -\\w{6} is the suffix that normalized from group routes;\n+  const groupSuffix = strictlyMatchExtensions ? '' : '(-\\\\w{6})?'\n+\n+  const suffixMatcher = `${variantsMatcher}${groupSuffix}`\n+\n   const metadataRouteFilesRegex = [\n     new RegExp(\n-      `^[\\\\\\\\/]robots${\n-        withExtension\n-          ? `${getExtensionRegexString(pageExtensions.concat('txt'), null)}$`\n-          : ''\n-      }`\n+      `^[\\\\\\\\/]robots${getExtensionRegexString(\n+        pageExtensions.concat('txt'),\n+        null\n+      )}${trailingMatcher}`\n     ),\n     new RegExp(\n-      `^[\\\\\\\\/]manifest${\n-        withExtension\n-          ? `${getExtensionRegexString(\n-              pageExtensions.concat('webmanifest', 'json'),\n-              null\n-            )}$`\n-          : ''\n-      }`\n+      `^[\\\\\\\\/]manifest${getExtensionRegexString(\n+        pageExtensions.concat('webmanifest', 'json'),\n+        null\n+      )}${trailingMatcher}`\n     ),\n     new RegExp(`^[\\\\\\\\/]favicon\\\\.ico$`),\n     new RegExp(\n-      `[\\\\\\\\/]sitemap${\n-        withExtension\n-          ? `${getExtensionRegexString(['xml'], pageExtensions)}$`\n-          : ''\n-      }`\n+      `[\\\\\\\\/]sitemap${getExtensionRegexString(['xml'], pageExtensions)}${trailingMatcher}`\n     ),\n     new RegExp(\n-      `[\\\\\\\\/]${STATIC_METADATA_IMAGES.icon.filename}\\\\d?${\n-        withExtension\n-          ? `${getExtensionRegexString(\n-              STATIC_METADATA_IMAGES.icon.extensions,\n-              pageExtensions\n-            )}$`\n-          : ''\n-      }`\n+      `[\\\\\\\\/]${STATIC_METADATA_IMAGES.icon.filename}${suffixMatcher}${getExtensionRegexString(\n+        STATIC_METADATA_IMAGES.icon.extensions,\n+        pageExtensions\n+      )}${trailingMatcher}`\n     ),\n     new RegExp(\n-      `[\\\\\\\\/]${STATIC_METADATA_IMAGES.apple.filename}\\\\d?${\n-        withExtension\n-          ? `${getExtensionRegexString(\n-              STATIC_METADATA_IMAGES.apple.extensions,\n-              pageExtensions\n-            )}$`\n-          : ''\n-      }`\n+      `[\\\\\\\\/]${STATIC_METADATA_IMAGES.apple.filename}${suffixMatcher}${getExtensionRegexString(\n+        STATIC_METADATA_IMAGES.apple.extensions,\n+        pageExtensions\n+      )}${trailingMatcher}`\n     ),\n     new RegExp(\n-      `[\\\\\\\\/]${STATIC_METADATA_IMAGES.openGraph.filename}\\\\d?${\n-        withExtension\n-          ? `${getExtensionRegexString(\n-              STATIC_METADATA_IMAGES.openGraph.extensions,\n-              pageExtensions\n-            )}$`\n-          : ''\n-      }`\n+      `[\\\\\\\\/]${STATIC_METADATA_IMAGES.openGraph.filename}${suffixMatcher}${getExtensionRegexString(\n+        STATIC_METADATA_IMAGES.openGraph.extensions,\n+        pageExtensions\n+      )}${trailingMatcher}`\n     ),\n     new RegExp(\n-      `[\\\\\\\\/]${STATIC_METADATA_IMAGES.twitter.filename}\\\\d?${\n-        withExtension\n-          ? `${getExtensionRegexString(\n-              STATIC_METADATA_IMAGES.twitter.extensions,\n-              pageExtensions\n-            )}$`\n-          : ''\n-      }`\n+      `[\\\\\\\\/]${STATIC_METADATA_IMAGES.twitter.filename}${suffixMatcher}${getExtensionRegexString(\n+        STATIC_METADATA_IMAGES.twitter.extensions,\n+        pageExtensions\n+      )}${trailingMatcher}`\n     ),\n   ]\n \n   const normalizedAppDirRelativePath = normalizePathSep(appDirRelativePath)\n-  return metadataRouteFilesRegex.some((r) =>\n+  const matched = metadataRouteFilesRegex.some((r) =>\n     r.test(normalizedAppDirRelativePath)\n   )\n-}\n \n-export function isStaticMetadataRoutePage(appDirRelativePath: string) {\n-  return isMetadataRouteFile(appDirRelativePath, [], true)\n+  return matched\n }\n \n // Check if the route is a static metadata route, with /route suffix\n // e.g. /favicon.ico/route, /icon.png/route, etc.\n // But skip the text routes like robots.txt since they might also be dynamic.\n // Checking route path is not enough to determine if text routes is dynamic.\n export function isStaticMetadataRoute(route: string) {\n-  const pathname = route.slice(0, -'/route'.length)\n-  return (\n+  // extract ext with regex\n+  const pathname = route.replace(/\\/route$/, '')\n+\n+  const matched =\n     isAppRouteRoute(route) &&\n-    isStaticMetadataRoutePage(pathname) &&\n+    isMetadataRouteFile(pathname, [], true) &&\n     // These routes can either be built by static or dynamic entrypoints,\n     // so we assume they're dynamic\n     pathname !== '/robots.txt' &&\n     pathname !== '/manifest.webmanifest' &&\n     !pathname.endsWith('/sitemap.xml')\n-  )\n+\n+  return matched\n+}\n+\n+/**\n+ * Determine if a page or pathname is a metadata page.\n+ *\n+ * The input is a page or pathname, which can be with or without page suffix /foo/page or /foo.\n+ * But it will not contain the /route suffix.\n+ *\n+ * .e.g\n+ * /robots -> true\n+ * /sitemap -> true\n+ * /foo -> false\n+ */\n+export function isMetadataPage(page: string) {\n+  const matched = !isAppRouteRoute(page) && isMetadataRouteFile(page, [], false)\n+\n+  return matched\n }\n \n /*\n- * Remove the 'app' prefix or '/route' suffix, only check the route name since they're only allowed in root app directory\n+ * Determine if a Next.js route is a metadata route.\n+ * `route` will has a route suffix.\n+ *\n  * e.g.\n- * /app/robots -> /robots\n- * app/robots -> /robots\n- * /robots -> /robots\n+ * /app/robots/route -> true\n+ * /robots/route -> true\n+ * /sitemap/[__metadata_id__]/route -> true\n+ * /app/sitemap/page -> false\n+ * /icon-a102f4/route -> true\n  */\n export function isMetadataRoute(route: string): boolean {\n-  let page = route.replace(/^\\/?app\\//, '').replace(/\\/route$/, '')\n+  let page = normalizeAppPath(route)\n+    .replace(/^\\/?app\\//, '')\n+    // Remove the dynamic route id\n+    .replace('/[__metadata_id__]', '')\n+    // Remove the /route suffix\n+    .replace(/\\/route$/, '')\n+\n   if (page[0] !== '/') page = '/' + page\n \n-  return (\n-    !page.endsWith('/page') &&\n-    isMetadataRouteFile(page, defaultExtensions, false)\n-  )\n+  const matched = isAppRouteRoute(route) && isMetadataRouteFile(page, [], false)\n+\n+  return matched\n }"
        },
        {
            "sha": "3216387f1acbe3c8d54baf14dbd12cfa840a629a",
            "filename": "test/e2e/app-dir/metadata-route-like-pages/app/icon/error.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Ficon%2Ferror.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Ficon%2Ferror.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Ficon%2Ferror.tsx?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export default function Error() {\n+  return <p>Error</p>\n+}"
        },
        {
            "sha": "2c108c08f427d2e43f97304314b28ba163a388d9",
            "filename": "test/e2e/app-dir/metadata-route-like-pages/app/icon/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Ficon%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Ficon%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Ficon%2Fpage.tsx?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <h1>Icon</h1>\n+}"
        },
        {
            "sha": "08eaa94fdc8896acfd343a0dbb61c713eec93a55",
            "filename": "test/e2e/app-dir/metadata-route-like-pages/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Flayout.tsx?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "3216387f1acbe3c8d54baf14dbd12cfa840a629a",
            "filename": "test/e2e/app-dir/metadata-route-like-pages/app/sitemap/error.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Fsitemap%2Ferror.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Fsitemap%2Ferror.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Fsitemap%2Ferror.tsx?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export default function Error() {\n+  return <p>Error</p>\n+}"
        },
        {
            "sha": "a3ea5c9b664e6538917e727962ccf52fb08e8258",
            "filename": "test/e2e/app-dir/metadata-route-like-pages/app/sitemap/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Fsitemap%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Fsitemap%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fapp%2Fsitemap%2Fpage.tsx?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <h1>Sitemap</h1>\n+}"
        },
        {
            "sha": "b5d09de39dd473aeaf8ecccc79b0d3a76cf9ea70",
            "filename": "test/e2e/app-dir/metadata-route-like-pages/metadata-route-like-pages.test.ts",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fmetadata-route-like-pages.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fmetadata-route-like-pages.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fmetadata-route-like-pages.test.ts?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -0,0 +1,20 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { assertNoRedbox } from 'next-test-utils'\n+\n+describe('metadata-route-like-pages', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should able to visit sitemap page', async () => {\n+    const browser = await next.browser('/sitemap')\n+    await assertNoRedbox(browser)\n+    expect(await browser.elementByCss('h1').text()).toBe('Sitemap')\n+  })\n+\n+  it('should able to visit icon page', async () => {\n+    const browser = await next.browser('/icon')\n+    await assertNoRedbox(browser)\n+    expect(await browser.elementByCss('h1').text()).toBe('Icon')\n+  })\n+})"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/metadata-route-like-pages/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f5198b48373cf7694934957833bbbdeca149fd94/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-route-like-pages%2Fnext.config.js?ref=f5198b48373cf7694934957833bbbdeca149fd94",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 385,
        "additions": 292,
        "deletions": 93
    }
}