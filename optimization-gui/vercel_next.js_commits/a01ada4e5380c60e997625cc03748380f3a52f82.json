{
    "author": "timneutkens",
    "message": "Turbopack: Use readFileSync / writeFileSync for manifest writing (#83694)\n\n## What?\n\nUse sync fs methods for reading/writing manifests after a Turbopack\nwriteToDisk. Next step will be not calling it when nothing changed.\n\nBefore:\n\n```\n GET / 200 in 41ms\n GET / 200 in 54ms\n GET / 200 in 57ms\n GET / 200 in 165ms\n GET / 200 in 44ms\n GET / 200 in 52ms\n GET / 200 in 42ms\n GET / 200 in 50ms\n GET / 200 in 39ms\n GET / 200 in 53ms\n GET / 200 in 39ms\n GET / 200 in 49ms\n GET / 200 in 40ms\n GET / 200 in 49ms\n GET / 200 in 40ms\n GET / 200 in 54ms\n GET / 200 in 39ms\n GET / 200 in 52ms\n GET / 200 in 47ms\n GET / 200 in 50ms\n GET / 200 in 45ms\n GET / 200 in 59ms\n GET / 200 in 44ms\n GET / 200 in 55ms\n GET / 200 in 46ms\n GET / 200 in 51ms\n```\n\n\nAfter:\n\n```\n GET / 200 in 31ms\n GET / 200 in 29ms\n GET / 200 in 32ms\n GET / 200 in 33ms\n GET / 200 in 33ms\n GET / 200 in 34ms\n GET / 200 in 32ms\n GET / 200 in 30ms\n GET / 200 in 33ms\n GET / 200 in 30ms\n GET / 200 in 31ms\n GET / 200 in 32ms\n GET / 200 in 31ms\n GET / 200 in 31ms\n GET / 200 in 30ms\n GET / 200 in 33ms\n GET / 200 in 33ms\n GET / 200 in 32ms\n GET / 200 in 29ms\n GET / 200 in 30ms\n GET / 200 in 36ms\n GET / 200 in 35ms\n GET / 200 in 34ms\n GET / 200 in 32ms\n GET / 200 in 30ms\n```",
    "sha": "a01ada4e5380c60e997625cc03748380f3a52f82",
    "files": [
        {
            "sha": "851f54cc3636cb0724683d89edf2eac83f7fcc49",
            "filename": "packages/next/src/build/handle-entrypoints.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-entrypoints.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-entrypoints.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-entrypoints.ts?ref=a01ada4e5380c60e997625cc03748380f3a52f82",
            "patch": "@@ -109,25 +109,27 @@ export async function handleRouteType({\n         manifestLoader.deleteMiddlewareManifest(key)\n       }\n \n-      await manifestLoader.loadAppBuildManifest(page)\n-      await manifestLoader.loadBuildManifest(page, 'app')\n-      await manifestLoader.loadAppPathsManifest(page)\n-      await manifestLoader.loadActionManifest(page)\n-      await manifestLoader.loadFontManifest(page, 'app')\n+      manifestLoader.loadAppBuildManifest(page)\n+      manifestLoader.loadBuildManifest(page, 'app')\n+      manifestLoader.loadAppPathsManifest(page)\n+      manifestLoader.loadActionManifest(page)\n+      manifestLoader.loadFontManifest(page, 'app')\n \n       if (shouldCreateWebpackStats) {\n-        await manifestLoader.loadWebpackStats(page, 'app')\n+        manifestLoader.loadWebpackStats(page, 'app')\n       }\n \n       break\n     }\n     case 'app-route': {\n       const key = getEntryKey('app', 'server', page)\n \n-      await manifestLoader.loadAppPathsManifest(page)\n+      manifestLoader.loadAppPathsManifest(page)\n \n-      const middlewareManifestWritten =\n-        await manifestLoader.loadMiddlewareManifest(page, 'app')\n+      const middlewareManifestWritten = manifestLoader.loadMiddlewareManifest(\n+        page,\n+        'app'\n+      )\n \n       if (!middlewareManifestWritten) {\n         manifestLoader.deleteMiddlewareManifest(key)"
        },
        {
            "sha": "fbe9ddf9777949acc6d2aa43f98ec154f4dc8253",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=a01ada4e5380c60e997625cc03748380f3a52f82",
            "patch": "@@ -202,7 +202,7 @@ export async function turbopackBuild(): Promise<{\n         )),\n     ])\n \n-    await manifestLoader.writeManifests({\n+    manifestLoader.writeManifests({\n       devRewrites: undefined,\n       productionRewrites: rewrites,\n       entrypoints: currentEntrypoints,"
        },
        {
            "sha": "9de40785a190b2ddf988ad3de616ff7e03c75f18",
            "filename": "packages/next/src/lib/fs/rename.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 17,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Flib%2Ffs%2Frename.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Flib%2Ffs%2Frename.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ffs%2Frename.ts?ref=a01ada4e5380c60e997625cc03748380f3a52f82",
            "patch": "@@ -25,18 +25,18 @@ SOFTWARE.\n // This file is based on https://github.com/microsoft/vscode/blob/f860fcf11022f10a992440fd54c6e45674e39617/src/vs/base/node/pfs.ts\n // See the LICENSE at the top of the file\n \n-import { rename as fsRename, stat } from 'node:fs/promises'\n+import { renameSync as fsRenameSync, statSync } from 'node:fs'\n \n /**\n  * A drop-in replacement for `fs.rename` that:\n  * - allows to move across multiple disks\n  * - attempts to retry the operation for certain error codes on Windows\n  */\n-export async function rename(\n+export function renameSync(\n   source: string,\n   target: string,\n   windowsRetryTimeout: number | false = 60000 /* matches graceful-fs */\n-): Promise<void> {\n+): void {\n   if (source === target) {\n     return // simulate node.js behaviour here and do a no-op if paths match\n   }\n@@ -46,21 +46,21 @@ export async function rename(\n     // is locked by AV software. We do leverage graceful-fs to iron\n     // out these issues, however in case the target file exists,\n     // graceful-fs will immediately return without retry for fs.rename().\n-    await renameWithRetry(source, target, Date.now(), windowsRetryTimeout)\n+    renameSyncWithRetry(source, target, Date.now(), windowsRetryTimeout)\n   } else {\n-    await fsRename(source, target)\n+    fsRenameSync(source, target)\n   }\n }\n \n-async function renameWithRetry(\n+function renameSyncWithRetry(\n   source: string,\n   target: string,\n   startTime: number,\n   retryTimeout: number,\n   attempt = 0\n-): Promise<void> {\n+): void {\n   try {\n-    return await fsRename(source, target)\n+    return fsRenameSync(source, target)\n   } catch (error: any) {\n     if (\n       error.code !== 'EACCES' &&\n@@ -72,16 +72,23 @@ async function renameWithRetry(\n \n     if (Date.now() - startTime >= retryTimeout) {\n       console.error(\n-        `[node.js fs] rename failed after ${attempt} retries with error: ${error}`\n+        `Node.js fs rename failed after ${attempt} retries with error: ${error}`\n       )\n \n       throw error // give up after configurable timeout\n     }\n \n+    if (attempt > 100) {\n+      console.error(\n+        `Node.js fs rename failed after ${attempt} retries with error ${error}`\n+      )\n+      throw error\n+    }\n+\n     if (attempt === 0) {\n       let abortRetry = false\n       try {\n-        const statTarget = await stat(target)\n+        const statTarget = statSync(target)\n         if (!statTarget.isFile()) {\n           abortRetry = true // if target is not a file, EPERM error may be raised and we should not attempt to retry\n         }\n@@ -94,13 +101,13 @@ async function renameWithRetry(\n       }\n     }\n \n-    // Delay with incremental backoff up to 100ms\n-    await timeout(Math.min(100, attempt * 10))\n-\n     // Attempt again\n-    return renameWithRetry(source, target, startTime, retryTimeout, attempt + 1)\n+    return renameSyncWithRetry(\n+      source,\n+      target,\n+      startTime,\n+      retryTimeout,\n+      attempt + 1\n+    )\n   }\n }\n-\n-const timeout = (millis: number) =>\n-  new Promise((resolve) => setTimeout(resolve, millis))"
        },
        {
            "sha": "afab4e9361e946aa0f99feaa0573be67ed07ee33",
            "filename": "packages/next/src/lib/fs/write-atomic.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 9,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Flib%2Ffs%2Fwrite-atomic.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Flib%2Ffs%2Fwrite-atomic.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ffs%2Fwrite-atomic.ts?ref=a01ada4e5380c60e997625cc03748380f3a52f82",
            "patch": "@@ -1,17 +1,14 @@\n-import { unlink, writeFile } from 'fs/promises'\n-import { rename } from './rename'\n+import { unlinkSync, writeFileSync } from 'fs'\n+import { renameSync } from './rename'\n \n-export async function writeFileAtomic(\n-  filePath: string,\n-  content: string\n-): Promise<void> {\n+export function writeFileAtomic(filePath: string, content: string): void {\n   const tempPath = filePath + '.tmp.' + Math.random().toString(36).slice(2)\n   try {\n-    await writeFile(tempPath, content, 'utf-8')\n-    await rename(tempPath, filePath)\n+    writeFileSync(tempPath, content, 'utf-8')\n+    renameSync(tempPath, filePath)\n   } catch (e) {\n     try {\n-      await unlink(tempPath)\n+      unlinkSync(tempPath)\n     } catch {\n       // ignore\n     }"
        },
        {
            "sha": "336e5473cfdea7ffe7e9e7fa1a1380f8eaa65e8a",
            "filename": "packages/next/src/server/dev/turbopack-utils.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 16,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts?ref=a01ada4e5380c60e997625cc03748380f3a52f82",
            "patch": "@@ -243,7 +243,7 @@ export async function handleRouteType({\n           await manifestLoader.loadWebpackStats(page, 'pages')\n         }\n \n-        await manifestLoader.writeManifests({\n+        manifestLoader.writeManifests({\n           devRewrites,\n           productionRewrites,\n           entrypoints,\n@@ -334,7 +334,7 @@ export async function handleRouteType({\n         manifestLoader.deleteMiddlewareManifest(key)\n       }\n \n-      await manifestLoader.writeManifests({\n+      manifestLoader.writeManifests({\n         devRewrites,\n         productionRewrites,\n         entrypoints,\n@@ -382,22 +382,22 @@ export async function handleRouteType({\n       const type = writtenEndpoint.type\n \n       if (type === 'edge') {\n-        await manifestLoader.loadMiddlewareManifest(page, 'app')\n+        manifestLoader.loadMiddlewareManifest(page, 'app')\n       } else {\n         manifestLoader.deleteMiddlewareManifest(key)\n       }\n \n-      await manifestLoader.loadAppBuildManifest(page)\n-      await manifestLoader.loadBuildManifest(page, 'app')\n-      await manifestLoader.loadAppPathsManifest(page)\n-      await manifestLoader.loadActionManifest(page)\n-      await manifestLoader.loadFontManifest(page, 'app')\n+      manifestLoader.loadAppBuildManifest(page)\n+      manifestLoader.loadBuildManifest(page, 'app')\n+      manifestLoader.loadAppPathsManifest(page)\n+      manifestLoader.loadActionManifest(page)\n+      manifestLoader.loadFontManifest(page, 'app')\n \n       if (shouldCreateWebpackStats) {\n-        await manifestLoader.loadWebpackStats(page, 'app')\n+        manifestLoader.loadWebpackStats(page, 'app')\n       }\n \n-      await manifestLoader.writeManifests({\n+      manifestLoader.writeManifests({\n         devRewrites,\n         productionRewrites,\n         entrypoints,\n@@ -415,15 +415,15 @@ export async function handleRouteType({\n \n       const type = writtenEndpoint.type\n \n-      await manifestLoader.loadAppPathsManifest(page)\n+      manifestLoader.loadAppPathsManifest(page)\n \n       if (type === 'edge') {\n-        await manifestLoader.loadMiddlewareManifest(page, 'app')\n+        manifestLoader.loadMiddlewareManifest(page, 'app')\n       } else {\n         manifestLoader.deleteMiddlewareManifest(key)\n       }\n \n-      await manifestLoader.writeManifests({\n+      manifestLoader.writeManifests({\n         devRewrites,\n         productionRewrites,\n         entrypoints,\n@@ -690,7 +690,7 @@ export async function handleEntrypoints({\n       'instrumentation',\n       'instrumentation'\n     )\n-    await manifestLoader.writeManifests({\n+    manifestLoader.writeManifests({\n       devRewrites,\n       productionRewrites: undefined,\n       entrypoints: currentEntrypoints,\n@@ -758,7 +758,7 @@ export async function handleEntrypoints({\n             'middleware',\n             dev.serverFields.middleware\n           )\n-          await manifestLoader.writeManifests({\n+          manifestLoader.writeManifests({\n             devRewrites,\n             productionRewrites: undefined,\n             entrypoints: currentEntrypoints,\n@@ -956,7 +956,7 @@ export async function handlePagesErrorRoute({\n   await manifestLoader.loadPagesManifest('_error')\n   await manifestLoader.loadFontManifest('_error')\n \n-  await manifestLoader.writeManifests({\n+  manifestLoader.writeManifests({\n     devRewrites,\n     productionRewrites,\n     entrypoints,"
        },
        {
            "sha": "966b2abf7ee2a38a20b44579e4a094e1f9bb3d13",
            "filename": "packages/next/src/shared/lib/turbopack/manifest-loader.ts",
            "status": "modified",
            "additions": 63,
            "deletions": 93,
            "changes": 156,
            "blob_url": "https://github.com/vercel/next.js/blob/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a01ada4e5380c60e997625cc03748380f3a52f82/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts?ref=a01ada4e5380c60e997625cc03748380f3a52f82",
            "patch": "@@ -30,7 +30,7 @@ import {\n   WEBPACK_STATS,\n } from '../constants'\n import { join, posix } from 'path'\n-import { readFile } from 'fs/promises'\n+import { readFileSync } from 'fs'\n import type { SetupOpts } from '../../../server/lib/router-utils/setup-dev-bundler'\n import { deleteCache } from '../../../server/dev/require-cache'\n import { writeFileAtomic } from '../../../lib/fs/write-atomic'\n@@ -121,15 +121,15 @@ const getManifestPath = (\n   return manifestPath\n }\n \n-async function readPartialManifest<T>(\n+function readPartialManifest<T>(\n   distDir: string,\n   name: ManifestName,\n   pageName: string,\n   type: 'pages' | 'app' | 'middleware' | 'instrumentation' = 'pages'\n-): Promise<T> {\n+): T {\n   const page = pageName\n   const manifestPath = getManifestPath(page, distDir, name, type, true)\n-  return JSON.parse(await readFile(posix.join(manifestPath), 'utf-8')) as T\n+  return JSON.parse(readFileSync(posix.join(manifestPath), 'utf-8')) as T\n }\n \n export class TurbopackManifestLoader {\n@@ -174,10 +174,10 @@ export class TurbopackManifestLoader {\n     this.webpackStats.delete(key)\n   }\n \n-  async loadActionManifest(pageName: string): Promise<void> {\n+  loadActionManifest(pageName: string): void {\n     this.actionManifests.set(\n       getEntryKey('app', 'server', pageName),\n-      await readPartialManifest(\n+      readPartialManifest(\n         this.distDir,\n         `${SERVER_REFERENCE_MANIFEST}.json`,\n         pageName,\n@@ -186,7 +186,7 @@ export class TurbopackManifestLoader {\n     )\n   }\n \n-  private async mergeActionManifests(manifests: Iterable<ActionManifest>) {\n+  private mergeActionManifests(manifests: Iterable<ActionManifest>) {\n     type ActionEntries = ActionManifest['edge' | 'node']\n     const manifest: ActionManifest = {\n       node: {},\n@@ -228,8 +228,8 @@ export class TurbopackManifestLoader {\n     return manifest\n   }\n \n-  private async writeActionManifest(): Promise<void> {\n-    const actionManifest = await this.mergeActionManifests(\n+  private writeActionManifest(): void {\n+    const actionManifest = this.mergeActionManifests(\n       this.actionManifests.values()\n     )\n     const actionManifestJsonPath = join(\n@@ -245,22 +245,17 @@ export class TurbopackManifestLoader {\n     const json = JSON.stringify(actionManifest, null, 2)\n     deleteCache(actionManifestJsonPath)\n     deleteCache(actionManifestJsPath)\n-    await writeFileAtomic(actionManifestJsonPath, json)\n-    await writeFileAtomic(\n+    writeFileAtomic(actionManifestJsonPath, json)\n+    writeFileAtomic(\n       actionManifestJsPath,\n       `self.__RSC_SERVER_MANIFEST=${JSON.stringify(json)}`\n     )\n   }\n \n-  async loadAppBuildManifest(pageName: string): Promise<void> {\n+  loadAppBuildManifest(pageName: string): void {\n     this.appBuildManifests.set(\n       getEntryKey('app', 'server', pageName),\n-      await readPartialManifest(\n-        this.distDir,\n-        APP_BUILD_MANIFEST,\n-        pageName,\n-        'app'\n-      )\n+      readPartialManifest(this.distDir, APP_BUILD_MANIFEST, pageName, 'app')\n     )\n   }\n \n@@ -275,31 +270,26 @@ export class TurbopackManifestLoader {\n     return manifest\n   }\n \n-  private async writeAppBuildManifest(): Promise<void> {\n+  private writeAppBuildManifest(): void {\n     const appBuildManifest = this.mergeAppBuildManifests(\n       this.appBuildManifests.values()\n     )\n     const appBuildManifestPath = join(this.distDir, APP_BUILD_MANIFEST)\n     deleteCache(appBuildManifestPath)\n-    await writeFileAtomic(\n+    writeFileAtomic(\n       appBuildManifestPath,\n       JSON.stringify(appBuildManifest, null, 2)\n     )\n   }\n \n-  async loadAppPathsManifest(pageName: string): Promise<void> {\n+  loadAppPathsManifest(pageName: string): void {\n     this.appPathsManifests.set(\n       getEntryKey('app', 'server', pageName),\n-      await readPartialManifest(\n-        this.distDir,\n-        APP_PATHS_MANIFEST,\n-        pageName,\n-        'app'\n-      )\n+      readPartialManifest(this.distDir, APP_PATHS_MANIFEST, pageName, 'app')\n     )\n   }\n \n-  private async writeAppPathsManifest(): Promise<void> {\n+  private writeAppPathsManifest(): void {\n     const appPathsManifest = this.mergePagesManifests(\n       this.appPathsManifests.values()\n     )\n@@ -309,36 +299,33 @@ export class TurbopackManifestLoader {\n       APP_PATHS_MANIFEST\n     )\n     deleteCache(appPathsManifestPath)\n-    await writeFileAtomic(\n+    writeFileAtomic(\n       appPathsManifestPath,\n       JSON.stringify(appPathsManifest, null, 2)\n     )\n   }\n \n-  private async writeWebpackStats(): Promise<void> {\n+  private writeWebpackStats(): void {\n     const webpackStats = this.mergeWebpackStats(this.webpackStats.values())\n     const path = join(this.distDir, 'server', WEBPACK_STATS)\n     deleteCache(path)\n-    await writeFileAtomic(path, JSON.stringify(webpackStats, null, 2))\n+    writeFileAtomic(path, JSON.stringify(webpackStats, null, 2))\n   }\n \n-  async loadBuildManifest(\n-    pageName: string,\n-    type: 'app' | 'pages' = 'pages'\n-  ): Promise<void> {\n+  loadBuildManifest(pageName: string, type: 'app' | 'pages' = 'pages'): void {\n     this.buildManifests.set(\n       getEntryKey(type, 'server', pageName),\n-      await readPartialManifest(this.distDir, BUILD_MANIFEST, pageName, type)\n+      readPartialManifest(this.distDir, BUILD_MANIFEST, pageName, type)\n     )\n   }\n \n-  async loadClientBuildManifest(\n+  loadClientBuildManifest(\n     pageName: string,\n     type: 'app' | 'pages' = 'pages'\n-  ): Promise<void> {\n+  ): void {\n     this.clientBuildManifests.set(\n       getEntryKey(type, 'server', pageName),\n-      await readPartialManifest(\n+      readPartialManifest(\n         this.distDir,\n         TURBOPACK_CLIENT_BUILD_MANIFEST,\n         pageName,\n@@ -347,13 +334,10 @@ export class TurbopackManifestLoader {\n     )\n   }\n \n-  async loadWebpackStats(\n-    pageName: string,\n-    type: 'app' | 'pages' = 'pages'\n-  ): Promise<void> {\n+  loadWebpackStats(pageName: string, type: 'app' | 'pages' = 'pages'): void {\n     this.webpackStats.set(\n       getEntryKey(type, 'client', pageName),\n-      await readPartialManifest(this.distDir, WEBPACK_STATS, pageName, type)\n+      readPartialManifest(this.distDir, WEBPACK_STATS, pageName, type)\n     )\n   }\n \n@@ -458,11 +442,11 @@ export class TurbopackManifestLoader {\n     return sortObjectByKey(manifest)\n   }\n \n-  private async writeBuildManifest(\n+  private writeBuildManifest(\n     entrypoints: Entrypoints,\n     devRewrites: SetupOpts['fsChecker']['rewrites'] | undefined,\n     productionRewrites: CustomRoutes['rewrites'] | undefined\n-  ): Promise<void> {\n+  ): void {\n     const rewrites = productionRewrites ?? {\n       ...devRewrites,\n       beforeFiles: (devRewrites?.beforeFiles ?? []).map(processRoute),\n@@ -484,11 +468,8 @@ export class TurbopackManifestLoader {\n     deleteCache(buildManifestPath)\n     deleteCache(middlewareBuildManifestPath)\n     deleteCache(interceptionRewriteManifestPath)\n-    await writeFileAtomic(\n-      buildManifestPath,\n-      JSON.stringify(buildManifest, null, 2)\n-    )\n-    await writeFileAtomic(\n+    writeFileAtomic(buildManifestPath, JSON.stringify(buildManifest, null, 2))\n+    writeFileAtomic(\n       middlewareBuildManifestPath,\n       // we use globalThis here because middleware can be node\n       // which doesn't have \"self\"\n@@ -499,7 +480,7 @@ export class TurbopackManifestLoader {\n       rewrites.beforeFiles.filter(isInterceptionRouteRewrite)\n     )\n \n-    await writeFileAtomic(\n+    writeFileAtomic(\n       interceptionRewriteManifestPath,\n       `self.__INTERCEPTION_ROUTE_REWRITE_MANIFEST=${JSON.stringify(\n         interceptionRewrites\n@@ -525,17 +506,17 @@ export class TurbopackManifestLoader {\n       null,\n       2\n     )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n-    await writeFileAtomic(\n+    writeFileAtomic(\n       join(this.distDir, 'static', this.buildId, '_buildManifest.js'),\n       clientBuildManifestJs\n     )\n-    await writeFileAtomic(\n+    writeFileAtomic(\n       join(this.distDir, 'static', this.buildId, '_ssgManifest.js'),\n       srcEmptySsgManifest\n     )\n   }\n \n-  private async writeClientMiddlewareManifest(): Promise<void> {\n+  private writeClientMiddlewareManifest(): void {\n     const middlewareManifest = this.mergeMiddlewareManifests(\n       this.middlewareManifests.values()\n     )\n@@ -549,7 +530,7 @@ export class TurbopackManifestLoader {\n       `${TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST}`\n     )\n     deleteCache(clientMiddlewareManifestPath)\n-    await writeFileAtomic(\n+    writeFileAtomic(\n       clientMiddlewareManifestPath,\n       JSON.stringify(matchers, null, 2)\n     )\n@@ -567,19 +548,16 @@ export class TurbopackManifestLoader {\n       `fallback-${BUILD_MANIFEST}`\n     )\n     deleteCache(fallbackBuildManifestPath)\n-    await writeFileAtomic(\n+    writeFileAtomic(\n       fallbackBuildManifestPath,\n       JSON.stringify(fallbackBuildManifest, null, 2)\n     )\n   }\n \n-  async loadFontManifest(\n-    pageName: string,\n-    type: 'app' | 'pages' = 'pages'\n-  ): Promise<void> {\n+  loadFontManifest(pageName: string, type: 'app' | 'pages' = 'pages'): void {\n     this.fontManifests.set(\n       getEntryKey(type, 'server', pageName),\n-      await readPartialManifest(\n+      readPartialManifest(\n         this.distDir,\n         `${NEXT_FONT_MANIFEST}.json`,\n         pageName,\n@@ -625,8 +603,8 @@ export class TurbopackManifestLoader {\n     )\n     deleteCache(fontManifestJsonPath)\n     deleteCache(fontManifestJsPath)\n-    await writeFileAtomic(fontManifestJsonPath, json)\n-    await writeFileAtomic(\n+    writeFileAtomic(fontManifestJsonPath, json)\n+    writeFileAtomic(\n       fontManifestJsPath,\n       `self.__NEXT_FONT_MANIFEST=${JSON.stringify(json)}`\n     )\n@@ -635,10 +613,10 @@ export class TurbopackManifestLoader {\n   /**\n    * @returns If the manifest was written or not\n    */\n-  async loadMiddlewareManifest(\n+  loadMiddlewareManifest(\n     pageName: string,\n     type: 'pages' | 'app' | 'middleware' | 'instrumentation'\n-  ): Promise<boolean> {\n+  ): boolean {\n     const middlewareManifestPath = getManifestPath(\n       pageName,\n       this.distDir,\n@@ -658,12 +636,7 @@ export class TurbopackManifestLoader {\n         'server',\n         pageName\n       ),\n-      await readPartialManifest(\n-        this.distDir,\n-        MIDDLEWARE_MANIFEST,\n-        pageName,\n-        type\n-      )\n+      readPartialManifest(this.distDir, MIDDLEWARE_MANIFEST, pageName, type)\n     )\n \n     return true\n@@ -730,7 +703,7 @@ export class TurbopackManifestLoader {\n     return manifest\n   }\n \n-  private async writeMiddlewareManifest(): Promise<void> {\n+  private writeMiddlewareManifest(): void {\n     const middlewareManifest = this.mergeMiddlewareManifests(\n       this.middlewareManifests.values()\n     )\n@@ -754,16 +727,16 @@ export class TurbopackManifestLoader {\n       MIDDLEWARE_MANIFEST\n     )\n     deleteCache(middlewareManifestPath)\n-    await writeFileAtomic(\n+    writeFileAtomic(\n       middlewareManifestPath,\n       JSON.stringify(middlewareManifest, null, 2)\n     )\n   }\n \n-  async loadPagesManifest(pageName: string): Promise<void> {\n+  loadPagesManifest(pageName: string): void {\n     this.pagesManifests.set(\n       getEntryKey('pages', 'server', pageName),\n-      await readPartialManifest(this.distDir, PAGES_MANIFEST, pageName)\n+      readPartialManifest(this.distDir, PAGES_MANIFEST, pageName)\n     )\n   }\n \n@@ -775,37 +748,34 @@ export class TurbopackManifestLoader {\n     return sortObjectByKey(manifest)\n   }\n \n-  private async writePagesManifest(): Promise<void> {\n+  private writePagesManifest(): void {\n     const pagesManifest = this.mergePagesManifests(this.pagesManifests.values())\n     const pagesManifestPath = join(this.distDir, 'server', PAGES_MANIFEST)\n     deleteCache(pagesManifestPath)\n-    await writeFileAtomic(\n-      pagesManifestPath,\n-      JSON.stringify(pagesManifest, null, 2)\n-    )\n+    writeFileAtomic(pagesManifestPath, JSON.stringify(pagesManifest, null, 2))\n   }\n \n-  async writeManifests({\n+  writeManifests({\n     devRewrites,\n     productionRewrites,\n     entrypoints,\n   }: {\n     devRewrites: SetupOpts['fsChecker']['rewrites'] | undefined\n     productionRewrites: CustomRoutes['rewrites'] | undefined\n     entrypoints: Entrypoints\n-  }) {\n-    await this.writeActionManifest()\n-    await this.writeAppBuildManifest()\n-    await this.writeAppPathsManifest()\n-    await this.writeBuildManifest(entrypoints, devRewrites, productionRewrites)\n-    await this.writeFallbackBuildManifest()\n-    await this.writeMiddlewareManifest()\n-    await this.writeClientMiddlewareManifest()\n-    await this.writeNextFontManifest()\n-    await this.writePagesManifest()\n+  }): void {\n+    this.writeActionManifest()\n+    this.writeAppBuildManifest()\n+    this.writeAppPathsManifest()\n+    this.writeBuildManifest(entrypoints, devRewrites, productionRewrites)\n+    this.writeFallbackBuildManifest()\n+    this.writeMiddlewareManifest()\n+    this.writeClientMiddlewareManifest()\n+    this.writeNextFontManifest()\n+    this.writePagesManifest()\n \n     if (process.env.TURBOPACK_STATS != null) {\n-      await this.writeWebpackStats()\n+      this.writeWebpackStats()\n     }\n   }\n }"
        }
    ],
    "stats": {
        "total": 266,
        "additions": 121,
        "deletions": 145
    }
}