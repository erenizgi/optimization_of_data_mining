{
    "author": "sokra",
    "message": "Turbopack: make invalidation from chunking context more granular (#81457)\n\n### What?\n\nMore granular invalidation to improve incremental builds with Skew Protections (modifies chunking context as it includes `chunk_suffix_path`).",
    "sha": "c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
    "files": [
        {
            "sha": "5e655f9e747ac88877b1276139d414a3eef00b44",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 33,
            "deletions": 30,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -282,36 +282,6 @@ impl BrowserChunkingContext {\n     }\n }\n \n-impl BrowserChunkingContext {\n-    /// Returns the kind of runtime to include in output chunks.\n-    ///\n-    /// This is defined directly on `BrowserChunkingContext` so it is zero-cost\n-    /// when `RuntimeType` has a single variant.\n-    pub fn runtime_type(&self) -> RuntimeType {\n-        self.runtime_type\n-    }\n-\n-    /// Returns the asset base path.\n-    pub fn chunk_base_path(&self) -> Option<RcStr> {\n-        self.chunk_base_path.clone()\n-    }\n-\n-    /// Returns the asset suffix path.\n-    pub fn chunk_suffix_path(&self) -> Option<RcStr> {\n-        self.chunk_suffix_path.clone()\n-    }\n-\n-    /// Returns the source map type.\n-    pub fn source_maps_type(&self) -> SourceMapsType {\n-        self.source_maps_type\n-    }\n-\n-    /// Returns the minify type.\n-    pub fn minify_type(&self) -> MinifyType {\n-        self.minify_type\n-    }\n-}\n-\n #[turbo_tasks::value_impl]\n impl BrowserChunkingContext {\n     #[turbo_tasks::function]\n@@ -373,6 +343,39 @@ impl BrowserChunkingContext {\n     pub fn current_chunk_method(&self) -> Vc<CurrentChunkMethod> {\n         self.current_chunk_method.cell()\n     }\n+\n+    /// Returns the kind of runtime to include in output chunks.\n+    ///\n+    /// This is defined directly on `BrowserChunkingContext` so it is zero-cost\n+    /// when `RuntimeType` has a single variant.\n+    #[turbo_tasks::function]\n+    pub fn runtime_type(&self) -> Vc<RuntimeType> {\n+        self.runtime_type.cell()\n+    }\n+\n+    /// Returns the asset base path.\n+    #[turbo_tasks::function]\n+    pub fn chunk_base_path(&self) -> Vc<Option<RcStr>> {\n+        Vc::cell(self.chunk_base_path.clone())\n+    }\n+\n+    /// Returns the asset suffix path.\n+    #[turbo_tasks::function]\n+    pub fn chunk_suffix_path(&self) -> Vc<Option<RcStr>> {\n+        Vc::cell(self.chunk_suffix_path.clone())\n+    }\n+\n+    /// Returns the source map type.\n+    #[turbo_tasks::function]\n+    pub fn source_maps_type(&self) -> Vc<SourceMapsType> {\n+        self.source_maps_type.cell()\n+    }\n+\n+    /// Returns the minify type.\n+    #[turbo_tasks::function]\n+    pub fn minify_type(&self) -> Vc<MinifyType> {\n+        self.minify_type.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "273a4218027efbc9dc9f027173b3e289256db28c",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/content.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -127,7 +127,7 @@ impl EcmascriptBrowserChunkContent {\n \n         let mut code = code.build();\n \n-        if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n+        if let MinifyType::Minify { mangle } = *this.chunking_context.minify_type().await? {\n             code = minify(code, source_maps, mangle)?;\n         }\n "
        },
        {
            "sha": "4195cc0520d4df66c7b1718b0c5824bcc651ddc3",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/evaluate/chunk.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -78,7 +78,6 @@ impl EcmascriptBrowserEvaluateChunk {\n     #[turbo_tasks::function]\n     async fn code(self: Vc<Self>) -> Result<Vc<Code>> {\n         let this = self.await?;\n-        let chunking_context = this.chunking_context.await?;\n         let environment = this.chunking_context.environment();\n \n         let output_root_to_root_path = this\n@@ -168,13 +167,14 @@ impl EcmascriptBrowserEvaluateChunk {\n             StringifyJs(&params),\n         )?;\n \n-        match chunking_context.runtime_type() {\n+        let runtime_type = *this.chunking_context.runtime_type().await?;\n+        match runtime_type {\n             RuntimeType::Production | RuntimeType::Development => {\n                 let runtime_code = turbopack_ecmascript_runtime::get_browser_runtime_code(\n                     environment,\n-                    chunking_context.chunk_base_path(),\n-                    chunking_context.chunk_suffix_path(),\n-                    chunking_context.runtime_type(),\n+                    this.chunking_context.chunk_base_path(),\n+                    this.chunking_context.chunk_suffix_path(),\n+                    runtime_type,\n                     output_root_to_root_path,\n                     source_maps,\n                 );\n@@ -189,7 +189,7 @@ impl EcmascriptBrowserEvaluateChunk {\n \n         let mut code = code.build();\n \n-        if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n+        if let MinifyType::Minify { mangle } = *this.chunking_context.minify_type().await? {\n             code = minify(code, source_maps, mangle)?;\n         }\n "
        },
        {
            "sha": "8861385a4565529970f41725c9aec60dae9039d5",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking_context.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 15,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -57,21 +57,8 @@ impl Default for MinifyType {\n     }\n }\n \n-#[derive(\n-    Debug,\n-    Default,\n-    TaskInput,\n-    Clone,\n-    Copy,\n-    PartialEq,\n-    Eq,\n-    Hash,\n-    Serialize,\n-    Deserialize,\n-    TraceRawVcs,\n-    DeterministicHash,\n-    NonLocalValue,\n-)]\n+#[turbo_tasks::value(shared)]\n+#[derive(Debug, Default, TaskInput, Clone, Copy, Hash, DeterministicHash)]\n pub enum SourceMapsType {\n     /// Extracts source maps from input files and writes source maps for output files.\n     #[default]"
        },
        {
            "sha": "8ca989aaf100c4b57eb682572d6ae6feab69dad2",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/src/asset_context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fasset_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fasset_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fasset_context.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -11,6 +11,7 @@ use turbopack_core::{\n use turbopack_ecmascript::TreeShakingMode;\n \n /// Returns the runtime asset context to use to process runtime code assets.\n+#[turbo_tasks::function]\n pub async fn get_runtime_asset_context(\n     environment: ResolvedVc<Environment>,\n ) -> Result<Vc<Box<dyn AssetContext>>> {"
        },
        {
            "sha": "8726a03695f4242d373f88bc7860cb586eeec5d4",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/src/browser_runtime.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fbrowser_runtime.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fbrowser_runtime.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fbrowser_runtime.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -17,13 +17,13 @@ use crate::{RuntimeType, asset_context::get_runtime_asset_context, embed_js::emb\n #[turbo_tasks::function]\n pub async fn get_browser_runtime_code(\n     environment: ResolvedVc<Environment>,\n-    chunk_base_path: Option<RcStr>,\n-    chunk_suffix_path: Option<RcStr>,\n+    chunk_base_path: Vc<Option<RcStr>>,\n+    chunk_suffix_path: Vc<Option<RcStr>>,\n     runtime_type: RuntimeType,\n     output_root_to_root_path: RcStr,\n     generate_source_map: bool,\n ) -> Result<Vc<Code>> {\n-    let asset_context = get_runtime_asset_context(environment).await?;\n+    let asset_context = get_runtime_asset_context(*environment).resolve().await?;\n \n     let shared_runtime_utils_code = embed_static_code(\n         asset_context,\n@@ -79,7 +79,9 @@ pub async fn get_browser_runtime_code(\n \n     let mut code: CodeBuilder = CodeBuilder::default();\n     let relative_root_path = output_root_to_root_path;\n+    let chunk_base_path = chunk_base_path.await?;\n     let chunk_base_path = chunk_base_path.as_ref().map_or_else(|| \"\", |f| f.as_str());\n+    let chunk_suffix_path = chunk_suffix_path.await?;\n     let chunk_suffix_path = chunk_suffix_path\n         .as_ref()\n         .map_or_else(|| \"\", |f| f.as_str());"
        },
        {
            "sha": "e18b52c33473b1d811190807fa44e4df3cbeddcf",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/src/nodejs_runtime.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fnodejs_runtime.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fnodejs_runtime.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fnodejs_runtime.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -13,7 +13,7 @@ pub async fn get_nodejs_runtime_code(\n     environment: ResolvedVc<Environment>,\n     generate_source_map: bool,\n ) -> Result<Vc<Code>> {\n-    let asset_context = get_runtime_asset_context(environment).await?;\n+    let asset_context = get_runtime_asset_context(*environment).resolve().await?;\n \n     let shared_runtime_utils_code = embed_static_code(\n         asset_context,"
        },
        {
            "sha": "ce42cf19bf7516bd32b6433f632c52af1c6502a5",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/src/runtime_type.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 15,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fruntime_type.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fruntime_type.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fruntime_type.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -1,19 +1,7 @@\n-use serde::{Deserialize, Serialize};\n-use turbo_tasks::{NonLocalValue, TaskInput, trace::TraceRawVcs};\n+use turbo_tasks::TaskInput;\n \n-#[derive(\n-    Serialize,\n-    Deserialize,\n-    Debug,\n-    Clone,\n-    Copy,\n-    Hash,\n-    PartialEq,\n-    Eq,\n-    TraceRawVcs,\n-    NonLocalValue,\n-    TaskInput,\n-)]\n+#[turbo_tasks::value(shared)]\n+#[derive(Debug, Clone, Copy, Hash, TaskInput)]\n pub enum RuntimeType {\n     Development,\n     Production,"
        },
        {
            "sha": "3ccab317676ee59e04057c174552a84e4ae1f452",
            "filename": "turbopack/crates/turbopack-nodejs/src/chunking_context.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 21,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -188,27 +188,6 @@ impl NodeJsChunkingContext {\n     }\n }\n \n-impl NodeJsChunkingContext {\n-    /// Returns the kind of runtime to include in output chunks.\n-    ///\n-    /// This is defined directly on `NodeJsChunkingContext` so it is zero-cost\n-    /// when `RuntimeType` has a single variant.\n-    pub fn runtime_type(&self) -> RuntimeType {\n-        self.runtime_type\n-    }\n-\n-    /// Returns the minify type.\n-    pub fn minify_type(&self) -> MinifyType {\n-        self.minify_type\n-    }\n-}\n-\n-impl NodeJsChunkingContext {\n-    pub async fn asset_prefix(self: Vc<Self>) -> Result<Option<RcStr>> {\n-        Ok(self.await?.asset_prefix.clone())\n-    }\n-}\n-\n #[turbo_tasks::value_impl]\n impl NodeJsChunkingContext {\n     #[turbo_tasks::function]\n@@ -230,6 +209,26 @@ impl NodeJsChunkingContext {\n             },\n         )\n     }\n+\n+    /// Returns the kind of runtime to include in output chunks.\n+    ///\n+    /// This is defined directly on `NodeJsChunkingContext` so it is zero-cost\n+    /// when `RuntimeType` has a single variant.\n+    #[turbo_tasks::function]\n+    pub fn runtime_type(&self) -> Vc<RuntimeType> {\n+        self.runtime_type.cell()\n+    }\n+\n+    /// Returns the minify type.\n+    #[turbo_tasks::function]\n+    pub fn minify_type(&self) -> Vc<MinifyType> {\n+        self.minify_type.cell()\n+    }\n+\n+    #[turbo_tasks::function]\n+    pub fn asset_prefix(&self) -> Vc<Option<RcStr>> {\n+        Vc::cell(self.asset_prefix.clone())\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "17d0ac22c20b4e0090668ccf7eb09e09417b18c8",
            "filename": "turbopack/crates/turbopack-nodejs/src/ecmascript/node/content.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -77,7 +77,7 @@ impl EcmascriptBuildNodeChunkContent {\n \n         let mut code = code.build();\n \n-        if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n+        if let MinifyType::Minify { mangle } = *this.chunking_context.minify_type().await? {\n             code = minify(code, source_maps, mangle)?;\n         }\n \n@@ -90,7 +90,7 @@ impl EcmascriptBuildNodeChunkContent {\n             self.chunking_context.output_root().await?.clone_value(),\n             self.chunk.path().await?.clone_value(),\n             *self.content,\n-            self.chunking_context.await?.minify_type(),\n+            *self.chunking_context.minify_type().await?,\n         ))\n     }\n }"
        },
        {
            "sha": "3ee404875395799749f3c7617f08815ed78ad6c5",
            "filename": "turbopack/crates/turbopack-nodejs/src/ecmascript/node/entry/runtime.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fentry%2Fruntime.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c278c8792f78daf2fe6c18d985f1e82ffdce93a8/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fentry%2Fruntime.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fentry%2Fruntime.rs?ref=c278c8792f78daf2fe6c18d985f1e82ffdce93a8",
            "patch": "@@ -69,7 +69,7 @@ impl EcmascriptBuildNodeRuntimeChunk {\n             StringifyJs(asset_prefix),\n         )?;\n \n-        match this.chunking_context.await?.runtime_type() {\n+        match *this.chunking_context.runtime_type().await? {\n             RuntimeType::Development => {\n                 let runtime_code = turbopack_ecmascript_runtime::get_nodejs_runtime_code(\n                     this.chunking_context.environment(),"
        }
    ],
    "stats": {
        "total": 170,
        "additions": 75,
        "deletions": 95
    }
}