{
    "author": "bgw",
    "message": "fix: Handle non-directory files in cache folder when performing cleanup (#84930)\n\nhttps://vercel.slack.com/archives/C046HAU4H7F/p1760563400531829\n\nRepro this by creating a non-directory file in `cache/turbopack`, and then invalidating it:\n\n```\ntouch .next/dev/cache/turbopack/notadirectory\ntouch .next/dev/cache/turbopack/__turbo_tasks_invalidated_db\n```\n\nBefore:\n![Screenshot 2025-10-15 at 4.13.33 PM.png](https://app.graphite.dev/user-attachments/assets/670eba50-d87d-4d2a-a28d-d338cfd3863c.png)\n\nAfter:\n\n![Screenshot 2025-10-15 at 4.14.09 PM.png](https://app.graphite.dev/user-attachments/assets/30ba99ab-7859-475c-954a-77c1a0cd45a9.png)\n\nSee that the directory was cleaned up.",
    "sha": "fb106d545f2ffa8094d687572a48fb3aca1d3a2b",
    "files": [
        {
            "sha": "a6bce9b6cd38d631cb1ec1362fb02002e38547ab",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/db_invalidation.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/fb106d545f2ffa8094d687572a48fb3aca1d3a2b/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_invalidation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb106d545f2ffa8094d687572a48fb3aca1d3a2b/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_invalidation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_invalidation.rs?ref=fb106d545f2ffa8094d687572a48fb3aca1d3a2b",
            "patch": "@@ -166,7 +166,11 @@ fn cleanup_db_inner(base_path: &Path) -> io::Result<()> {\n     for entry in contents {\n         let entry = entry?;\n         if entry.file_name() != INVALIDATION_MARKER {\n-            fs::remove_dir_all(entry.path())?;\n+            if entry.file_type()?.is_dir() {\n+                fs::remove_dir_all(entry.path())?;\n+            } else {\n+                fs::remove_file(entry.path())?;\n+            }\n         }\n     }\n "
        }
    ],
    "stats": {
        "total": 6,
        "additions": 5,
        "deletions": 1
    }
}