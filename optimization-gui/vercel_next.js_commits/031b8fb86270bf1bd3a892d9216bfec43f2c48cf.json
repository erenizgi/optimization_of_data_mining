{
    "author": "mischnic",
    "message": "Turbopack: only replace edge dynamic calls in dev (#84354)\n\nThis replacement should only happen in dev, it's really only to be able to have nicer error messages.\r\n\r\nThis previously failed the deployment tests.\r\n\r\nRelated: https://github.com/vercel/next.js/issues/40625\r\n\r\nCloses PACK-5591",
    "sha": "031b8fb86270bf1bd3a892d9216bfec43f2c48cf",
    "files": [
        {
            "sha": "b62b6771c3049346b20511b47578996813c1da2d",
            "filename": "crates/next-core/src/next_server/transforms.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/031b8fb86270bf1bd3a892d9216bfec43f2c48cf/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/031b8fb86270bf1bd3a892d9216bfec43f2c48cf/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs?ref=031b8fb86270bf1bd3a892d9216bfec43f2c48cf",
            "patch": "@@ -174,14 +174,18 @@ pub async fn get_next_server_transforms_rules(\n     }\n \n     if let NextRuntime::Edge = next_runtime {\n-        rules.push(get_middleware_dynamic_assert_rule(mdx_rs));\n+        let mode = *mode.await?;\n+\n+        if mode == NextMode::Development {\n+            rules.push(get_middleware_dynamic_assert_rule(mdx_rs));\n+        }\n \n         if !foreign_code {\n             rules.push(next_edge_node_api_assert(\n                 mdx_rs,\n                 matches!(context_ty, ServerContextType::Middleware { .. })\n-                    && matches!(*mode.await?, NextMode::Build),\n-                matches!(*mode.await?, NextMode::Build),\n+                    && mode == NextMode::Build,\n+                mode == NextMode::Build,\n             ));\n         }\n "
        },
        {
            "sha": "050d584594b8944d8a575ec412b171e135d5cc73",
            "filename": "crates/next-custom-transforms/src/transforms/middleware_dynamic.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/031b8fb86270bf1bd3a892d9216bfec43f2c48cf/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fmiddleware_dynamic.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/031b8fb86270bf1bd3a892d9216bfec43f2c48cf/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fmiddleware_dynamic.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fmiddleware_dynamic.rs?ref=031b8fb86270bf1bd3a892d9216bfec43f2c48cf",
            "patch": "@@ -12,12 +12,13 @@ enum WrappedExpr {\n     WasmInstantiate,\n }\n \n-/// Replaces call / expr to dynamic evaluation in the give code to\n-/// wrapped expression (__next_eval__, __next_webassembly_compile__,..) to raise\n-/// corresponding error.\n+/// Replaces call / expr to dynamic evaluation in the give code to wrapped expression\n+/// (__next_eval__, __next_webassembly_compile__,..) to raise a (nicer) error message.\n ///\n-/// This transform is specific to edge runtime which are not allowed to\n-/// call certain dynamic evaluation (eval, webassembly.instantiate, etc)\n+/// This should only be only used in development mode.\n+///\n+/// This transform is specific to edge runtime which are not allowed to call certain dynamic\n+/// evaluation (eval, webassembly.instantiate, etc)\n ///\n /// check middleware-plugin for corresponding webpack side transform.\n pub fn next_middleware_dynamic() -> MiddlewareDynamic {"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 13,
        "deletions": 8
    }
}