{
    "author": "lukesandberg",
    "message": "[turbopack] vibecode a benchmark runner for module-cost (#82287)\n\n# Add automated benchmark runner for module-cost\n\n## What?\nThis PR adds an automated benchmark runner for the module-cost benchmark, allowing for consistent measurement of module loading and execution times.\n\n## Why?\n\nIt is to tedious and error prone to run the benchmark. \n\n## Usage\n\nBuild `next` and turbopack however you like\n```\npnpm i\npnpm prepare-bench\npnpm build-webpack (or build-turbopack)\npnpm benchmark\n```\n\n## How?\n\nv0 mostly",
    "sha": "cee784dea0a4dffcf8f09261cfe2412f2df4f0d2",
    "files": [
        {
            "sha": "b1d3827455c448c6688d555614b188d8d490779b",
            "filename": "bench/module-cost/.gitignore",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/cee784dea0a4dffcf8f09261cfe2412f2df4f0d2/bench%2Fmodule-cost%2F.gitignore",
            "raw_url": "https://github.com/vercel/next.js/raw/cee784dea0a4dffcf8f09261cfe2412f2df4f0d2/bench%2Fmodule-cost%2F.gitignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Fmodule-cost%2F.gitignore?ref=cee784dea0a4dffcf8f09261cfe2412f2df4f0d2",
            "patch": "@@ -1,3 +1,4 @@\n commonjs/*\n esm/*\n-CPU*\n\\ No newline at end of file\n+CPU*\n+benchmark-results-*.json\n\\ No newline at end of file"
        },
        {
            "sha": "f8118beb353a28471a6582bc9096d7cc82a76948",
            "filename": "bench/module-cost/components/client.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/cee784dea0a4dffcf8f09261cfe2412f2df4f0d2/bench%2Fmodule-cost%2Fcomponents%2Fclient.js",
            "raw_url": "https://github.com/vercel/next.js/raw/cee784dea0a4dffcf8f09261cfe2412f2df4f0d2/bench%2Fmodule-cost%2Fcomponents%2Fclient.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Fmodule-cost%2Fcomponents%2Fclient.js?ref=cee784dea0a4dffcf8f09261cfe2412f2df4f0d2",
            "patch": "@@ -4,6 +4,11 @@ import { useEffect, useRef, useState } from 'react'\n import { format, measure } from '../lib/measure'\n \n function report(result, element, textarea) {\n+  if (!globalThis.BENCHMARK_RESULTS) {\n+    globalThis.BENCHMARK_RESULTS = []\n+  }\n+  globalThis.BENCHMARK_RESULTS.push(result)\n+\n   const formattedResult = format(result)\n   element.textContent += `: ${formattedResult}`\n   textarea.current.value += `\\n    ${formattedResult}`"
        },
        {
            "sha": "eb6e8a7478d92aa8e3731fb0b46e4edcdddc7977",
            "filename": "bench/module-cost/package.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/cee784dea0a4dffcf8f09261cfe2412f2df4f0d2/bench%2Fmodule-cost%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/cee784dea0a4dffcf8f09261cfe2412f2df4f0d2/bench%2Fmodule-cost%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Fmodule-cost%2Fpackage.json?ref=cee784dea0a4dffcf8f09261cfe2412f2df4f0d2",
            "patch": "@@ -2,6 +2,7 @@\n   \"name\": \"module-cost\",\n   \"scripts\": {\n     \"prepare-bench\": \"node scripts/prepare-bench.mjs\",\n+    \"benchmark\": \"node scripts/benchmark-runner.mjs\",\n     \"dev-webpack\": \"next dev\",\n     \"dev-turbopack\": \"next dev --turbo\",\n     \"build-webpack\": \"next build\",\n@@ -10,6 +11,7 @@\n   },\n   \"devDependencies\": {\n     \"rimraf\": \"6.0.1\",\n-    \"next\": \"workspace:*\"\n+    \"next\": \"workspace:*\",\n+    \"playwright\": \"^1.40.0\"\n   }\n }"
        },
        {
            "sha": "eb96b27ce357163c355d732b79c77f264c78adbc",
            "filename": "bench/module-cost/scripts/benchmark-runner.mjs",
            "status": "added",
            "additions": 255,
            "deletions": 0,
            "changes": 255,
            "blob_url": "https://github.com/vercel/next.js/blob/cee784dea0a4dffcf8f09261cfe2412f2df4f0d2/bench%2Fmodule-cost%2Fscripts%2Fbenchmark-runner.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/cee784dea0a4dffcf8f09261cfe2412f2df4f0d2/bench%2Fmodule-cost%2Fscripts%2Fbenchmark-runner.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Fmodule-cost%2Fscripts%2Fbenchmark-runner.mjs?ref=cee784dea0a4dffcf8f09261cfe2412f2df4f0d2",
            "patch": "@@ -0,0 +1,255 @@\n+import { spawn } from 'node:child_process'\n+import { writeFileSync } from 'node:fs'\n+import { chromium } from 'playwright'\n+\n+/// To use:\n+/// - Install Playwright: `npx playwright install chromium`\n+/// - Install dependencies: `pnpm install`\n+/// - Build the application: `pnpm build-webpack` or pnpm build-turbopack`\n+/// - Run the benchmark: `pnpm benchmark`\n+\n+class BenchmarkRunner {\n+  constructor(options) {\n+    this.name = options.name\n+    this.samples = options.samples ?? 50\n+    this.buttonClickDelay = options.buttonClickDelay ?? 500\n+    this.results = []\n+  }\n+\n+  async runBenchmark() {\n+    for (let i = 1; i <= this.samples; i++) {\n+      console.log(`\\n--- Running sample ${i}/${this.samples} ---`)\n+\n+      const result = await this.runSingleSample()\n+      this.results.push(...result)\n+    }\n+\n+    this.saveResults()\n+    console.log('\\nBenchmark completed!')\n+  }\n+\n+  async runSingleSample() {\n+    let server\n+    let browser\n+\n+    try {\n+      // 1. Launch the server\n+      server = await this.startServer()\n+\n+      // 2. Launch Chrome incognito\n+      console.log('Launching browser...')\n+      browser = await chromium.launch({\n+        headless: true, // Set to true if you don't want to see the browser\n+        args: ['--incognito'],\n+      })\n+\n+      const context = await browser.newContext()\n+      const page = await context.newPage()\n+\n+      // 3. Navigate to localhost:3000\n+      await page.goto('http://localhost:3000', { waitUntil: 'load' })\n+\n+      // 4. Find and click all buttons\n+      const buttons = await page.locator('button').all()\n+\n+      for (let j = 0; j < buttons.length; j++) {\n+        await buttons[j].click()\n+        await this.sleep(this.buttonClickDelay)\n+      }\n+\n+      // 5. Capture data from textbox\n+      console.log('Capturing data from the page...')\n+      const textboxData = await this.capturePageData(page)\n+      console.log('Captured data from the page:', textboxData)\n+\n+      // 6. Close browser\n+      console.log('Closing browser...')\n+      await browser.close()\n+      browser = null\n+\n+      // 7. Shut down server\n+      console.log('Shutting down server...')\n+      await this.stopServer(server)\n+      server = null\n+\n+      return textboxData\n+    } catch (error) {\n+      // Cleanup in case of error\n+      if (browser) {\n+        try {\n+          await browser.close()\n+        } catch (e) {\n+          console.error('Error closing browser:', e.message)\n+        }\n+      }\n+      if (server) {\n+        try {\n+          await this.stopServer(server)\n+        } catch (e) {\n+          console.error('Error stopping server:', e.message)\n+        }\n+      }\n+      throw error\n+    }\n+  }\n+\n+  async startServer() {\n+    return new Promise((resolve, reject) => {\n+      const server = spawn('pnpm', ['start'], {\n+        stdio: ['pipe', 'pipe', 'pipe'],\n+        shell: true,\n+      })\n+\n+      let serverReady = false\n+\n+      server.stdout.on('data', (data) => {\n+        const output = data.toString()\n+        console.log('Server:', output.trim())\n+\n+        // Look for common Next.js ready indicators\n+        if (\n+          output.includes('Ready') ||\n+          output.includes('started server') ||\n+          output.includes('Local:')\n+        ) {\n+          if (!serverReady) {\n+            serverReady = true\n+            resolve(server)\n+          }\n+        }\n+      })\n+\n+      server.stderr.on('data', (data) => {\n+        console.error('Server Error:', data.toString().trim())\n+      })\n+\n+      server.on('error', (error) => {\n+        reject(new Error(`Failed to start server: ${error.message}`))\n+      })\n+\n+      server.on('close', (code) => {\n+        if (!serverReady) {\n+          reject(\n+            new Error(`Server exited with code ${code} before becoming ready`)\n+          )\n+        }\n+      })\n+\n+      // Timeout after 30 seconds\n+      setTimeout(() => {\n+        if (!serverReady) {\n+          server.kill()\n+          reject(new Error('Server startup timeout'))\n+        }\n+      }, 30000)\n+    })\n+  }\n+\n+  async stopServer(server) {\n+    return new Promise((resolve) => {\n+      if (!server || server.killed) {\n+        resolve()\n+        return\n+      }\n+\n+      server.on('close', () => {\n+        resolve()\n+      })\n+\n+      // Try graceful shutdown first\n+      server.kill('SIGTERM')\n+\n+      // Force kill after 5 seconds\n+      setTimeout(() => {\n+        if (!server.killed) {\n+          server.kill('SIGKILL')\n+        }\n+        resolve()\n+      }, 5000)\n+    })\n+  }\n+\n+  async capturePageData(page) {\n+    return await page.evaluate(() => globalThis.BENCHMARK_RESULTS)\n+  }\n+\n+  async sleep(ms) {\n+    return new Promise((resolve) => setTimeout(resolve, ms))\n+  }\n+\n+  saveResults() {\n+    const timestamp = new Date().toISOString().replace(/[:.]/g, '-')\n+    const filename = `benchmark-results-${this.name}-${timestamp}.json`\n+\n+    writeFileSync(\n+      filename,\n+      JSON.stringify(summarizeDurations(this.results), null, 2)\n+    )\n+    console.log(`Results saved to ${filename}`)\n+  }\n+}\n+\n+const summarizeDurations = (data) => {\n+  if (!Array.isArray(data) || data.length === 0) {\n+    throw new Error('No data to summarize')\n+  }\n+\n+  const byName = new Map()\n+  for (const item of data) {\n+    const name = item.name\n+    if (!byName.has(name)) {\n+      byName.set(name, [])\n+    }\n+    byName.get(name).push(item)\n+  }\n+  const results = []\n+  for (const [name, data] of byName) {\n+    const loadDurations = data\n+      .map((item) => item.loadDuration)\n+      .sort((a, b) => a - b)\n+    const executeDurations = data\n+      .map((item) => item.executeDuration)\n+      .sort((a, b) => a - b)\n+\n+    const getSummary = (durations) => {\n+      const sum = durations.reduce((acc, val) => acc + val, 0)\n+      const average = sum / durations.length\n+\n+      const middle = Math.floor(durations.length / 2)\n+      const median =\n+        durations.length % 2 === 0\n+          ? (durations[middle - 1] + durations[middle]) / 2\n+          : durations[middle]\n+\n+      const percentile75Index = Math.floor(durations.length * 0.75)\n+      const percentile75 = durations[percentile75Index]\n+\n+      return {\n+        average,\n+        median,\n+        percentile75,\n+      }\n+    }\n+\n+    results.push({\n+      name,\n+      totalSamples: data.length,\n+      loadDuration: getSummary(loadDurations),\n+      executeDuration: getSummary(executeDurations),\n+    })\n+  }\n+\n+  return results\n+}\n+\n+// CLI usage\n+const args = process.argv.slice(2)\n+const samples = args.length > 0 ? Number.parseInt(args[0]) : undefined\n+const name = args.length > 1 ? args[1] : undefined\n+\n+const runner = new BenchmarkRunner({\n+  name,\n+  samples,\n+})\n+\n+runner.runBenchmark().catch(console.error)"
        },
        {
            "sha": "497f1c252103b805cf65eeeebbf04e1e80a002de",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/cee784dea0a4dffcf8f09261cfe2412f2df4f0d2/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/cee784dea0a4dffcf8f09261cfe2412f2df4f0d2/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=cee784dea0a4dffcf8f09261cfe2412f2df4f0d2",
            "patch": "@@ -676,6 +676,9 @@ importers:\n       next:\n         specifier: workspace:*\n         version: link:../../packages/next\n+      playwright:\n+        specifier: ^1.40.0\n+        version: 1.48.0\n       rimraf:\n         specifier: 6.0.1\n         version: 6.0.1"
        }
    ],
    "stats": {
        "total": 270,
        "additions": 268,
        "deletions": 2
    }
}