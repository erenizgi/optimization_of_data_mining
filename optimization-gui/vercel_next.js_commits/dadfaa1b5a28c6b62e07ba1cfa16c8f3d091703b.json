{
    "author": "ijjk",
    "message": "Revert \"Add a --webpack flag and default --turbopack to true (#84216)\" (#84348)",
    "sha": "dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
    "files": [
        {
            "sha": "1f4fb64e6b07d97074eac8d4f6f0a2f2772d4d73",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 16,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -502,7 +502,6 @@ jobs:\n \n         export NEXT_TEST_MODE=start\n         export NEXT_TEST_WASM=true\n-        export IS_WEBPACK_TEST=1\n         node run-tests.js \\\n           test/production/pages-dir/production/test/index.test.ts \\\n           test/e2e/streaming-ssr/index.test.ts\n@@ -712,7 +711,7 @@ jobs:\n \n     secrets: inherit\n \n-  test-dev: # TODO: rename to include webpack\n+  test-dev:\n     name: test dev\n     needs: ['optimize-ci', 'changes', 'build-native', 'build-next']\n     if: ${{ needs.optimize-ci.outputs.skip == 'false' && needs.changes.outputs.docs-only == 'false' }}\n@@ -729,7 +728,6 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       afterBuild: |\n-        export IS_WEBPACK_TEST=1\n         export NEXT_TEST_MODE=dev\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n@@ -754,10 +752,8 @@ jobs:\n \n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      # Should this be using turbopack? a variation?\n       afterBuild: |\n         export NEXT_TEST_MODE=dev\n-        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           test/e2e/app-dir/app/index.test.ts \\\n@@ -784,7 +780,6 @@ jobs:\n     with:\n       nodeVersion: 20.9.0\n       afterBuild: |\n-        export IS_WEBPACK_TEST=1\n         node run-tests.js \\\n           --concurrency 4 \\\n           test/production/pages-dir/production/test/index.test.ts \\\n@@ -813,7 +808,6 @@ jobs:\n     with:\n       afterBuild: |\n         export NEXT_TEST_MODE=start\n-        export IS_WEBPACK_TEST=1\n \n         node run-tests.js --type production \\\n           test/e2e/app-dir/app/index.test.ts \\\n@@ -842,7 +836,6 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       afterBuild: |\n-        export IS_WEBPACK_TEST=1\n         export NEXT_TEST_MODE=start\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n@@ -882,7 +875,6 @@ jobs:\n     with:\n       nodeVersion: 20.9.0\n       afterBuild: |\n-        export IS_WEBPACK_TEST=1\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n         node run-tests.js \\\n@@ -904,7 +896,6 @@ jobs:\n \n         # these all run without concurrency because they're heavier\n         export TEST_CONCURRENCY=1\n-        export IS_WEBPACK_TEST=1\n \n         BROWSER_NAME=firefox node run-tests.js \\\n           test/production/pages-dir/production/test/index.test.ts\n@@ -932,7 +923,6 @@ jobs:\n       afterBuild: |\n         export __NEXT_EXPERIMENTAL_PPR=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\"\n-        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\\n@@ -955,7 +945,6 @@ jobs:\n         export __NEXT_EXPERIMENTAL_PPR=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\"\n         export NEXT_TEST_MODE=dev\n-        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\\n@@ -979,7 +968,6 @@ jobs:\n         export __NEXT_EXPERIMENTAL_PPR=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\"\n         export NEXT_TEST_MODE=start\n-        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\\n@@ -1002,7 +990,6 @@ jobs:\n         export __NEXT_EXPERIMENTAL_PPR=true # for compatibility with the existing tests\n         export __NEXT_EXPERIMENTAL_CACHE_COMPONENTS=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/experimental-tests-manifest.json\"\n-        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\\n@@ -1027,7 +1014,6 @@ jobs:\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/experimental-tests-manifest.json\"\n         export NEXT_TEST_MODE=dev\n         export __NEXT_EXPERIMENTAL_ISOLATED_DEV_BUILD=true\n-        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\\n@@ -1052,7 +1038,6 @@ jobs:\n         export __NEXT_EXPERIMENTAL_CACHE_COMPONENTS=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/experimental-tests-manifest.json\"\n         export NEXT_TEST_MODE=start\n-        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\"
        },
        {
            "sha": "2428e307218e85d043df704cd0f22c9d438a75ee",
            "filename": "bench/heavy-npm-deps/package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/bench%2Fheavy-npm-deps%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/bench%2Fheavy-npm-deps%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Fheavy-npm-deps%2Fpackage.json?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -4,9 +4,9 @@\n   \"private\": true,\n   \"scripts\": {\n     \"dev-turbopack\": \"next dev --turbopack\",\n-    \"dev-webpack\": \"next dev --webpack\",\n+    \"dev-webpack\": \"next dev\",\n     \"build-turbopack\": \"next build --turbopack\",\n-    \"build-webpack\": \"next build --webpack\",\n+    \"build-webpack\": \"next build\",\n     \"start-turbopack\": \"next start\",\n     \"start-webpack\": \"next start\",\n     \"build-application\": \"next build\","
        },
        {
            "sha": "eb6e8a7478d92aa8e3731fb0b46e4edcdddc7977",
            "filename": "bench/module-cost/package.json",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/bench%2Fmodule-cost%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/bench%2Fmodule-cost%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Fmodule-cost%2Fpackage.json?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -3,10 +3,10 @@\n   \"scripts\": {\n     \"prepare-bench\": \"node scripts/prepare-bench.mjs\",\n     \"benchmark\": \"node scripts/benchmark-runner.mjs\",\n-    \"dev-webpack\": \"next dev --webpack\",\n-    \"dev-turbopack\": \"next dev --turbopack\",\n-    \"build-webpack\": \"next build --webpack\",\n-    \"build-turbopack\": \"next build --turbopack\",\n+    \"dev-webpack\": \"next dev\",\n+    \"dev-turbopack\": \"next dev --turbo\",\n+    \"build-webpack\": \"next build\",\n+    \"build-turbopack\": \"next build --turbo\",\n     \"start\": \"next start\"\n   },\n   \"devDependencies\": {"
        },
        {
            "sha": "cc91c605dda661cff6dc7143882a13f22fe890a9",
            "filename": "package.json",
            "status": "modified",
            "additions": 23,
            "deletions": 44,
            "changes": 67,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -17,49 +17,29 @@\n     \"ci:publish\": \"tsx ./scripts/release/publish-npm.ts\",\n     \"test-types\": \"tsc\",\n     \"test-unit\": \"jest test/unit/ packages/next/ packages/font\",\n-    \"test-dev-inner\": \"cross-env NEXT_TEST_MODE=dev pnpm testheadless\",\n-    \"test-dev\": \"pnpm run test-dev-webpack\",\n-    \"test-dev-webpack\": \"pnpm run with-webpack pnpm test-dev-inner\",\n-    \"test-dev-experimental-inner\": \"pnpm run with-experimental pnpm test-dev-inner\",\n-    \"test-dev-experimental\": \"pnpm run test-dev-experimental-webpack\",\n-    \"test-dev-experimental-webpack\": \"pnpm run with-webpack pnpm test-dev-experimental-inner\",\n-    \"test-dev-rspack\": \"pnpm run with-rspack pnpm run test-dev-inner\",\n-    \"test-dev-experimental-rspack\": \"pnpm run with-rspack pnpm run test-dev-experimental-inner\",\n-    \"test-dev-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm test-dev-inner\",\n-    \"test-dev-experimental-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm run with-experimental pnpm test-dev-inner\",\n-    \"test-start-inner\": \"cross-env NEXT_TEST_MODE=start pnpm testheadless\",\n-    \"test-start\": \"pnpm run test-start-webpack\",\n-    \"test-start-webpack\": \"pnpm run with-webpack pnpm run test-start-inner\",\n-    \"test-start-experimental-inner\": \"pnpm run with-experimental pnpm test-start-inner\",\n-    \"test-start-experimental\": \"pnpm run test-start-experimental-webpack\",\n-    \"test-start-experimental-webpack\": \"pnpm run with-webpack pnpm run test-start-experimental-inner\",\n-    \"test-start-rspack\": \"pnpm run with-rspack pnpm run test-start-inner\",\n-    \"test-start-experimental-rspack\": \"pnpm run with-rspack pnpm run test-start-experimental-inner\",\n-    \"test-start-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm test-start-inner\",\n-    \"test-start-experimental-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm run with-experimental pnpm test-start-experimental-inner\",\n-    \"test-deploy-inner\": \"cross-env NEXT_TEST_MODE=deploy pnpm testheadless\",\n-    \"test-deploy\": \"pnpm run test-deploy-webpack\",\n-    \"test-deploy-webpack\": \"pnpm run with-webpack pnpm test-deploy-inner\",\n-    \"test-deploy-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm test-deploy-inner\",\n-    \"testonly-dev-inner\": \"cross-env NEXT_TEST_MODE=dev pnpm testonly\",\n-    \"testonly-dev\": \"pnpm run testonly-dev-webpack\",\n-    \"testonly-dev-webpack\": \"pnpm run with-webpack pnpm run testonly-dev-inner\",\n-    \"testonly-dev-rspack\": \"pnpm run with-rspack pnpm run testonly-dev-inner\",\n-    \"testonly-dev-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm testonly-dev-inner\",\n-    \"testonly-start-inner\": \"cross-env NEXT_TEST_MODE=start pnpm testonly\",\n-    \"testonly-start\": \"pnpm run testonly-start-webpack\",\n-    \"testonly-start-webpack\": \"pnpm run with-webpack pnpm run testonly-start-inner\",\n-    \"testonly-start-rspack\": \"pnpm run with-rspack pnpm run testonly-start-inner\",\n-    \"testonly-start-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm testonly-start-inner\",\n-    \"testonly-deploy-inner\": \"cross-env NEXT_TEST_MODE=deploy pnpm testonly\",\n-    \"testonly-deploy\": \"pnpm run testonly-deploy-webpack\",\n-    \"testonly-deploy-webpack\": \"pnpm run with-webpack pnpm run testonly-deploy-inner\",\n-    \"testonly-deploy-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm testonly-deploy-inner\",\n-    \"test-inner\": \"pnpm testheadless\",\n-    \"test\": \"pnpm test-webpack\",\n-    \"test-webpack\": \"pnpm run with-webpack pnpm run test-inner\",\n-    \"test-rspack\": \"pnpm run with-rspack pnpm run test-inner\",\n-    \"test-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 TURBOPACK_BUILD=1 pnpm test-inner\",\n+    \"test-dev\": \"cross-env NEXT_TEST_MODE=dev pnpm testheadless\",\n+    \"test-dev-experimental\": \"cross-env NEXT_TEST_MODE=dev pnpm run with-experimental pnpm testheadless\",\n+    \"test-dev-rspack\": \"pnpm run with-rspack pnpm run test-dev\",\n+    \"test-dev-experimental-rspack\": \"pnpm run with-rspack pnpm run test-dev-experimental\",\n+    \"test-dev-turbo\": \"cross-env NEXT_TEST_MODE=dev IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm testheadless\",\n+    \"test-dev-experimental-turbo\": \"cross-env NEXT_TEST_MODE=dev IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm run with-experimental pnpm testheadless\",\n+    \"test-start\": \"cross-env NEXT_TEST_MODE=start pnpm testheadless\",\n+    \"test-start-experimental\": \"cross-env NEXT_TEST_MODE=start pnpm run with-experimental pnpm testheadless\",\n+    \"test-start-rspack\": \"pnpm run with-rspack pnpm run test-start\",\n+    \"test-start-experimental-rspack\": \"pnpm run with-rspack pnpm run test-start-experimental\",\n+    \"test-start-turbo\": \"cross-env NEXT_TEST_MODE=start IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm testheadless\",\n+    \"test-start-experimental-turbo\": \"cross-env NEXT_TEST_MODE=start IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm run with-experimental pnpm testheadless\",\n+    \"test-deploy\": \"cross-env NEXT_TEST_MODE=deploy pnpm testheadless\",\n+    \"testonly-dev\": \"cross-env NEXT_TEST_MODE=dev pnpm testonly\",\n+    \"testonly-dev-rspack\": \"pnpm run with-rspack pnpm run testonly-dev\",\n+    \"testonly-dev-turbo\": \"cross-env NEXT_TEST_MODE=dev IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm testonly\",\n+    \"testonly-start\": \"cross-env NEXT_TEST_MODE=start pnpm testonly\",\n+    \"testonly-start-rspack\": \"pnpm run with-rspack pnpm run testonly-start\",\n+    \"testonly-start-turbo\": \"cross-env NEXT_TEST_MODE=start IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm testonly\",\n+    \"testonly-deploy\": \"cross-env NEXT_TEST_MODE=deploy pnpm testonly\",\n+    \"test\": \"pnpm testheadless\",\n+    \"test-rspack\": \"pnpm run with-rspack pnpm run test\",\n+    \"test-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 TURBOPACK_BUILD=1 pnpm testheadless\",\n     \"testonly\": \"jest --runInBand\",\n     \"testheadless\": \"cross-env HEADLESS=true pnpm testonly\",\n     \"genstats\": \"cross-env LOCAL_STATS=true node .github/actions/next-stats-action/src/index.js\",\n@@ -109,7 +89,6 @@\n     \"build-storybook\": \"turbo run build-storybook\",\n     \"test-storybook\": \"turbo run test-storybook\",\n     \"with-rspack\": \"cross-env NEXT_RSPACK=1 NEXT_TEST_USE_RSPACK=1\",\n-    \"with-webpack\": \"cross-env IS_WEBPACK_TEST=1\",\n     \"with-experimental\": \"cross-env __NEXT_EXPERIMENTAL_CACHE_COMPONENTS=true __NEXT_EXPERIMENTAL_PPR=true\"\n   },\n   \"devDependencies\": {"
        },
        {
            "sha": "e0ce02d637d847aa34678314996fbb8c90484826",
            "filename": "packages/next-rspack/index.js",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext-rspack%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext-rspack%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-rspack%2Findex.js?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -1,13 +1,5 @@\n module.exports = function withRspack(config) {\n   process.env.NEXT_RSPACK = 'true'\n   process.env.RSPACK_CONFIG_VALIDATE = 'loose-silent'\n-  if (process.env.TURBOPACK === 'auto') {\n-    // If next has defaulted to turbopack, override it.\n-    delete process.env.TURBOPACK\n-  } else if (process.env.TURBOPACK) {\n-    console.error('Cannot call withRspack and pass the --turbopack flag.')\n-    console.error('Please configure only one bundler.')\n-    process.exit(1)\n-  }\n   return config\n }"
        },
        {
            "sha": "cfcb4b5b355b726a7ceaa99cb25926571c9d6d6d",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -133,9 +133,8 @@ program\n   .option('--no-mangling', 'Disables mangling.')\n   .option('--profile', 'Enables production profiling for React.')\n   .option('--experimental-app-only', 'Builds only App Router routes.')\n-  .option('--turbo', 'Builds using Turbopack.')\n-  .option('--turbopack', 'Builds using Turbopack.')\n-  .option('--webpack', 'Builds using webpack.')\n+  .option('--turbo', 'Starts development mode using Turbopack.')\n+  .option('--turbopack', 'Starts development mode using Turbopack.')\n   .addOption(\n     new Option(\n       '--experimental-build-mode [mode]',\n@@ -174,7 +173,6 @@ program\n   )\n   .option('--turbo', 'Starts development mode using Turbopack.')\n   .option('--turbopack', 'Starts development mode using Turbopack.')\n-  .option('--webpack', 'Starts development mode using webpack.')\n   .addOption(\n     new Option(\n       '-p, --port <port>',"
        },
        {
            "sha": "b3b0f9ebfc4fee01e351c49fe8664574a50e9a13",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 36,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -83,7 +83,6 @@ import {\n   UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY,\n } from '../shared/lib/entry-constants'\n import { isDynamicRoute } from '../shared/lib/router/utils'\n-import { Bundler, finalizeBundlerFromConfig } from '../lib/bundler'\n import type { __ApiPreviewProps } from '../server/api-utils'\n import loadConfig from '../server/config'\n import type { BuildManifest } from '../server/get-page-files'\n@@ -902,7 +901,7 @@ export default async function build(\n   runLint = true,\n   noMangling = false,\n   appDirOnly = false,\n-  bundler = Bundler.Turbopack,\n+  isTurbopack = false,\n   experimentalBuildMode: 'default' | 'compile' | 'generate' | 'generate-env',\n   traceUploadUrl: string | undefined\n ): Promise<void> {\n@@ -915,6 +914,7 @@ export default async function build(\n   try {\n     const nextBuildSpan = trace('next-build', undefined, {\n       buildMode: experimentalBuildMode,\n+      isTurboBuild: String(isTurbopack),\n       version: process.env.__NEXT_VERSION as string,\n     })\n \n@@ -949,10 +949,6 @@ export default async function build(\n         )\n       loadedConfig = config\n \n-      // Reading the config can modify environment variables that influence the bundler selection.\n-      bundler = finalizeBundlerFromConfig(bundler)\n-      nextBuildSpan.setAttribute('bundler', getBundlerForTelemetry(bundler))\n-\n       process.env.NEXT_DEPLOYMENT_ID = config.deploymentId || ''\n       NextBuildContext.config = config\n \n@@ -975,7 +971,7 @@ export default async function build(\n       NextBuildContext.buildId = buildId\n \n       if (experimentalBuildMode === 'generate-env') {\n-        if (bundler === Bundler.Turbopack) {\n+        if (isTurbopack) {\n           Log.warn('generate-env is not needed with turbopack')\n           process.exit(0)\n         }\n@@ -1402,7 +1398,7 @@ export default async function build(\n         })\n \n       // Turbopack already handles conflicting app and page routes.\n-      if (bundler !== Bundler.Turbopack) {\n+      if (!isTurbopack) {\n         const numConflictingAppPaths = conflictingAppPagePaths.length\n         if (mappedAppPages && numConflictingAppPaths > 0) {\n           Log.error(\n@@ -1685,7 +1681,7 @@ export default async function build(\n \n       let shutdownPromise = Promise.resolve()\n       if (!isGenerateMode) {\n-        if (bundler === Bundler.Turbopack) {\n+        if (isTurbopack) {\n           const {\n             duration: compilerDuration,\n             shutdownPromise: p,\n@@ -1800,7 +1796,7 @@ export default async function build(\n \n             telemetry.record(\n               eventBuildCompleted(pagesPaths, {\n-                bundler: getBundlerForTelemetry(bundler),\n+                bundler: getBundlerForTelemetry(isTurbopack),\n                 durationInSeconds,\n                 totalAppPagesCount,\n               })\n@@ -1816,7 +1812,7 @@ export default async function build(\n \n             telemetry.record(\n               eventBuildCompleted(pagesPaths, {\n-                bundler: getBundlerForTelemetry(bundler),\n+                bundler: getBundlerForTelemetry(isTurbopack),\n                 durationInSeconds: compilerDuration,\n                 totalAppPagesCount,\n               })\n@@ -2454,10 +2450,7 @@ export default async function build(\n         )\n         // If there's edge routes, append the edge instrumentation hook\n         // Turbopack generates this chunk with a hashed name and references it in middleware-manifest.\n-        if (\n-          bundler !== Bundler.Turbopack &&\n-          (edgeRuntimeAppCount || edgeRuntimePagesCount)\n-        ) {\n+        if (!isTurbopack && (edgeRuntimeAppCount || edgeRuntimePagesCount)) {\n           instrumentationHookEntryFiles.push(\n             path.join(\n               SERVER_DIRECTORY,\n@@ -2510,7 +2503,7 @@ export default async function build(\n               path.join(SERVER_DIRECTORY, FUNCTIONS_CONFIG_MANIFEST),\n               path.join(SERVER_DIRECTORY, MIDDLEWARE_MANIFEST),\n               path.join(SERVER_DIRECTORY, MIDDLEWARE_BUILD_MANIFEST + '.js'),\n-              ...(bundler !== Bundler.Turbopack\n+              ...(!isTurbopack\n                 ? [\n                     path.join(\n                       SERVER_DIRECTORY,\n@@ -2545,7 +2538,7 @@ export default async function build(\n                     ),\n                   ]\n                 : []),\n-              ...(pagesDir && bundler !== Bundler.Turbopack\n+              ...(pagesDir && !isTurbopack\n                 ? [\n                     DYNAMIC_CSS_MANIFEST + '.json',\n                     path.join(SERVER_DIRECTORY, DYNAMIC_CSS_MANIFEST + '.js'),\n@@ -2613,7 +2606,7 @@ export default async function build(\n             ],\n           }\n \n-          if (bundler === Bundler.Turbopack) {\n+          if (isTurbopack) {\n             await writeManifest(\n               path.join(\n                 distDir,\n@@ -2629,11 +2622,7 @@ export default async function build(\n \n       await writeFunctionsConfigManifest(distDir, functionsConfigManifest)\n \n-      if (\n-        bundler !== Bundler.Turbopack &&\n-        !isGenerateMode &&\n-        !buildTracesPromise\n-      ) {\n+      if (!isTurbopack && !isGenerateMode && !buildTracesPromise) {\n         buildTracesPromise = nextBuildSpan\n           .traceChild('collect-build-traces')\n           .traceAsyncFn(() => {\n@@ -2775,7 +2764,7 @@ export default async function build(\n \n       // we don't need to inline for turbopack build as\n       // it will handle it's own caching separate of compile\n-      if (isGenerateMode && bundler !== Bundler.Turbopack) {\n+      if (isGenerateMode && !isTurbopack) {\n         Log.info('Inlining static env ...')\n \n         await nextBuildSpan\n@@ -4211,7 +4200,7 @@ export default async function build(\n     if (telemetry) {\n       telemetry.record(\n         eventBuildFailed({\n-          bundler: getBundlerForTelemetry(bundler),\n+          bundler: getBundlerForTelemetry(isTurbopack),\n           errorCode: getErrorCodeForTelemetry(e),\n           durationInSeconds: Math.floor((Date.now() - buildStartTime) / 1000),\n         })\n@@ -4232,7 +4221,7 @@ export default async function build(\n         mode: 'build',\n         projectDir: dir,\n         distDir: loadedConfig.distDir,\n-        isTurboSession: bundler === Bundler.Turbopack,\n+        isTurboSession: isTurbopack,\n         sync: true,\n       })\n     }\n@@ -4246,17 +4235,16 @@ function errorFromUnsupportedSegmentConfig(): never {\n   process.exit(1)\n }\n \n-function getBundlerForTelemetry(bundler: Bundler) {\n-  switch (bundler) {\n-    case Bundler.Turbopack:\n-      return 'turbopack'\n-    case Bundler.Rspack:\n-      return 'rspack'\n-    case Bundler.Webpack:\n-      return 'webpack'\n-    default:\n-      throw new Error(`unknown bundler: ${bundler}`)\n+function getBundlerForTelemetry(isTurbopack: boolean) {\n+  if (isTurbopack) {\n+    return 'turbopack'\n   }\n+\n+  if (process.env.NEXT_RSPACK) {\n+    return 'rspack'\n+  }\n+\n+  return 'webpack'\n }\n \n function getErrorCodeForTelemetry(err: unknown) {"
        },
        {
            "sha": "a2df58fdc4135664a9299c42e6ac978300eff58a",
            "filename": "packages/next/src/cli/next-build.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -10,7 +10,6 @@ import isError from '../lib/is-error'\n import { getProjectDir } from '../lib/get-project-dir'\n import { enableMemoryDebuggingMode } from '../lib/memory/startup'\n import { disableMemoryDebuggingMode } from '../lib/memory/shutdown'\n-import { parseBundlerArgs } from '../lib/bundler'\n \n export type NextBuildOptions = {\n   debug?: boolean\n@@ -20,7 +19,6 @@ export type NextBuildOptions = {\n   mangling: boolean\n   turbo?: boolean\n   turbopack?: boolean\n-  webpack?: boolean\n   experimentalDebugMemoryUsage: boolean\n   experimentalAppOnly?: boolean\n   experimentalTurbo?: boolean\n@@ -84,7 +82,12 @@ const nextBuild = (options: NextBuildOptions, directory?: string) => {\n     printAndExit(`> No such directory exists as the project root: ${dir}`)\n   }\n \n-  const bundler = parseBundlerArgs(options)\n+  const isTurbopack = Boolean(\n+    options.turbo || options.turbopack || process.env.IS_TURBOPACK_TEST\n+  )\n+  if (isTurbopack) {\n+    process.env.TURBOPACK = '1'\n+  }\n \n   return build(\n     dir,\n@@ -94,7 +97,7 @@ const nextBuild = (options: NextBuildOptions, directory?: string) => {\n     lint,\n     !mangling,\n     experimentalAppOnly,\n-    bundler,\n+    isTurbopack,\n     experimentalBuildMode,\n     traceUploadUrl\n   )"
        },
        {
            "sha": "33e6e51bc6d881fc282f6660bddfe5dba13e8de0",
            "filename": "packages/next/src/cli/next-dev.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 19,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -38,17 +38,11 @@ import { once } from 'node:events'\n import { clearTimeout } from 'timers'\n import { flushAllTraces, trace } from '../trace'\n import { traceId } from '../trace/shared'\n-import {\n-  Bundler,\n-  finalizeBundlerFromConfig,\n-  parseBundlerArgs,\n-} from '../lib/bundler'\n \n export type NextDevOptions = {\n   disableSourceMaps: boolean\n   turbo?: boolean\n   turbopack?: boolean\n-  webpack?: boolean\n   port: number\n   hostname?: string\n   experimentalHttps?: boolean\n@@ -64,11 +58,11 @@ let dir: string\n let child: undefined | ChildProcess\n // The config in next-dev is only used to access config.distDir for telemetry and trace.\n let config: NextConfigComplete\n-let bundler: Bundler\n+let isTurboSession = false\n let traceUploadUrl: string\n let sessionStopHandled = false\n-const sessionStarted = Date.now()\n-const sessionSpan = trace('next-dev')\n+let sessionStarted = Date.now()\n+let sessionSpan = trace('next-dev')\n \n // How long should we wait for the child to cleanly exit after sending\n // SIGINT/SIGTERM to the child process before sending SIGKILL?\n@@ -129,13 +123,11 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n       new Telemetry({\n         distDir: path.join(dir, config.distDir),\n       })\n-    // Reading the config can modify environment variables that influence the bundler selection.\n-    bundler = finalizeBundlerFromConfig(bundler)\n \n     telemetry.record(\n       eventCliSessionStopped({\n         cliCommand: 'dev',\n-        turboFlag: bundler === Bundler.Turbopack,\n+        turboFlag: isTurboSession,\n         durationMilliseconds: Date.now() - sessionStarted,\n         pagesDir,\n         appDir,\n@@ -154,7 +146,7 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n       mode: 'dev',\n       projectDir: dir,\n       distDir: config.distDir,\n-      isTurboSession: bundler === Bundler.Turbopack,\n+      isTurboSession,\n     })\n   }\n \n@@ -176,7 +168,14 @@ const nextDev = async (\n   portSource: PortSource,\n   directory?: string\n ) => {\n-  bundler = parseBundlerArgs(options)\n+  const isTurbopack = Boolean(\n+    options.turbo || options.turbopack || process.env.IS_TURBOPACK_TEST\n+  )\n+  if (isTurbopack) {\n+    process.env.TURBOPACK = '1'\n+  }\n+\n+  isTurboSession = isTurbopack\n \n   dir = getProjectDir(process.env.NEXT_PRIVATE_DEV_DIR || directory)\n \n@@ -289,9 +288,7 @@ const nextDev = async (\n         stdio: 'inherit',\n         env: {\n           ...defaultEnv,\n-          ...(bundler === Bundler.Turbopack\n-            ? { TURBOPACK: process.env.TURBOPACK }\n-            : undefined),\n+          ...(isTurbopack ? { TURBOPACK: '1' } : undefined),\n           NEXT_PRIVATE_WORKER: '1',\n           NEXT_PRIVATE_TRACE_ID: traceId,\n           NODE_EXTRA_CA_CERTS: startServerOptions.selfSignedCertificate\n@@ -339,13 +336,12 @@ const nextDev = async (\n               (await loadConfig(PHASE_DEVELOPMENT_SERVER, dir, {\n                 silent: true,\n               }))\n-            bundler = finalizeBundlerFromConfig(bundler)\n             uploadTrace({\n               traceUploadUrl,\n               mode: 'dev',\n               projectDir: dir,\n               distDir: config.distDir,\n-              isTurboSession: bundler === Bundler.Turbopack,\n+              isTurboSession,\n               sync: true,\n             })\n           }"
        },
        {
            "sha": "7ffa9998bde0908423dd3da83f4460ba0460733a",
            "filename": "packages/next/src/lib/bundler.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 90,
            "changes": 90,
            "blob_url": "https://github.com/vercel/next.js/blob/8586cdf17dd1460fd2560bcdc8288e122e8eaff7/packages%2Fnext%2Fsrc%2Flib%2Fbundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8586cdf17dd1460fd2560bcdc8288e122e8eaff7/packages%2Fnext%2Fsrc%2Flib%2Fbundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fbundler.ts?ref=8586cdf17dd1460fd2560bcdc8288e122e8eaff7",
            "patch": "@@ -1,90 +0,0 @@\n-/// Utilties for configuring the bundler to use.\n-export enum Bundler {\n-  Turbopack,\n-  Webpack,\n-  Rspack,\n-}\n-/**\n- * Parse the bundler arguments and potentially sets the `TURBOPACK` environment variable.\n- *\n- * NOTE: rspack is configured via next config which is chaotic so it is possible for this to be overridden later.\n- *\n- * @param options The options to parse.\n- * @returns The bundler that was configured\n- */\n-export function parseBundlerArgs(options: {\n-  turbo?: boolean\n-  turbopack?: boolean\n-  webpack?: boolean\n-}): Bundler {\n-  const bundlerFlags = new Map<Bundler, string[]>()\n-  const setBundlerFlag = (bundler: Bundler, flag: string) => {\n-    bundlerFlags.set(bundler, (bundlerFlags.get(bundler) ?? []).concat(flag))\n-  }\n-  // What turbo flag was set? We allow multiple to be set, which is silly but not ambiguous, just pick the most relevant one.\n-  if (options.turbopack) {\n-    setBundlerFlag(Bundler.Turbopack, '--turbopack')\n-  }\n-  if (options.turbo) {\n-    setBundlerFlag(Bundler.Turbopack, '--turbo')\n-  } else if (process.env.TURBOPACK) {\n-    // We don't really want to support this but it is trivial and not really confusing.\n-    // If we don't support it and someone sets it, we would have inconsistent behavior\n-    // since some parts of next would read the return value of this function and other\n-    // parts will read the env variable.\n-    setBundlerFlag(Bundler.Turbopack, 'TURBOPACK')\n-  } else if (process.env.IS_TURBOPACK_TEST) {\n-    setBundlerFlag(Bundler.Turbopack, 'IS_TURBOPACK_TEST')\n-  }\n-  if (options.webpack) {\n-    setBundlerFlag(Bundler.Webpack, '--webpack')\n-  }\n-\n-  if (process.env.IS_WEBPACK_TEST) {\n-    setBundlerFlag(Bundler.Webpack, 'IS_WEBPACK_TEST')\n-  }\n-\n-  // Mostly this is set via the NextConfig but it can also be set via the command line which is\n-  // common for testing.\n-  if (process.env.NEXT_RSPACK) {\n-    setBundlerFlag(Bundler.Rspack, 'NEXT_RSPACK')\n-  }\n-  if (process.env.IS_RSPACK_TEST) {\n-    setBundlerFlag(Bundler.Rspack, 'NEXT_TEST_USE_RSPACK')\n-  }\n-\n-  if (bundlerFlags.size > 1) {\n-    console.error(\n-      `Multiple bundler flags set: ${Array.from(bundlerFlags.values()).flat().join(', ')}. Configure exactly one bundler.`\n-    )\n-    process.exit(1)\n-  }\n-  // The default is turbopack when nothing is configured.\n-  if (bundlerFlags.size === 0) {\n-    process.env.TURBOPACK = 'auto'\n-    return Bundler.Turbopack\n-  }\n-  if (bundlerFlags.has(Bundler.Turbopack)) {\n-    // Only conditionally assign to the environment variable, preserving already set values.\n-    // If it was set to 'auto' because no flag was set and this function is called a second time we\n-    // would upgrade to '1' but we don't really want that.\n-    process.env.TURBOPACK ??= '1'\n-    return Bundler.Turbopack\n-  }\n-  // Otherwise it is one of rspack or webpack. At this point there must be exactly one key in the map.\n-  return bundlerFlags.keys().next().value!\n-}\n-\n-/**\n- * Finalize the bundler based on the config.\n- *\n- * Rspack is configured via next config by setting an environment variable (yay, side effects)\n- * so this should only be called after parsing the config.\n- */\n-export function finalizeBundlerFromConfig(fromOptions: Bundler) {\n-  // Reading the next config can set NEXT_RSPACK environment variables.\n-  if (process.env.NEXT_RSPACK) {\n-    return Bundler.Rspack\n-  }\n-  return fromOptions\n-}"
        },
        {
            "sha": "1419761d0995d8e332b5a98dbd8ac42a6f761e6c",
            "filename": "packages/next/src/lib/turbopack-warning.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 23,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -47,9 +47,11 @@ const unsupportedTurbopackNextConfigOptions = [\n ]\n \n // The following will need to be supported by `next build --turbopack`\n-const unsupportedProductionSpecificTurbopackNextConfigOptions: string[] = []\n+const unsupportedProductionSpecificTurbopackNextConfigOptions: string[] = [\n+  // TODO: Support disabling sourcemaps, currently they're always enabled.\n+  // 'productionBrowserSourceMaps',\n+]\n \n-/**  */\n export async function validateTurboNextConfig({\n   dir,\n   isDev,\n@@ -69,7 +71,7 @@ export async function validateTurboNextConfig({\n   let hasWebpackConfig = false\n   let hasTurboConfig = false\n \n-  const unsupportedConfig: string[] = []\n+  let unsupportedConfig: string[] = []\n   let rawNextConfig: NextConfig = {}\n \n   const phase = isDev ? PHASE_DEVELOPMENT_SERVER : PHASE_PRODUCTION_BUILD\n@@ -122,7 +124,7 @@ export async function validateTurboNextConfig({\n \n     const customKeys = flattenKeys(rawNextConfig)\n \n-    const unsupportedKeys = isDev\n+    let unsupportedKeys = isDev\n       ? unsupportedTurbopackNextConfigOptions\n       : [\n           ...unsupportedTurbopackNextConfigOptions,\n@@ -137,7 +139,7 @@ export async function validateTurboNextConfig({\n         hasTurboConfig = true\n       }\n \n-      const isUnsupported =\n+      let isUnsupported =\n         unsupportedKeys.some(\n           (unsupportedKey) =>\n             // Either the key matches (or is a more specific subkey) of\n@@ -160,26 +162,13 @@ export async function validateTurboNextConfig({\n     Log.error('Unexpected error occurred while checking config', e)\n   }\n \n-  // If the build was defaulted to Turbopack, we want to warn about possibly ignored webpack\n-  // configuration. Otherwise the user explicitly picked turbopack and thus we expect that\n-  // they have configured it correctly.\n-  if (process.env.TURBOPACK === 'auto' && hasWebpackConfig && !hasTurboConfig) {\n-    const logMethod = isDev ? Log.warn : Log.error\n-    // In a production build with auto-detected Turbopack, we want to fail the build.\n-    logMethod(\n-      `Webpack is configured while Turbopack is not. This may be a mistake.`\n-    )\n-    logMethod(\n-      `To configure Turbopack, see:\\n  https://nextjs.org/docs/app/api-reference/next-config-js/turbopack`\n+  if (hasWebpackConfig && !hasTurboConfig) {\n+    Log.warn(\n+      `Webpack is configured while Turbopack is not, which may cause problems.`\n     )\n-    logMethod(\n-      `TIP: Silence this ${isDev ? 'warning' : 'error'} by passing the --turbopack or --webpack flag explicitly.`\n+    Log.warn(\n+      `See instructions if you need to configure Turbopack:\\n  https://nextjs.org/docs/app/api-reference/next-config-js/turbopack\\n`\n     )\n-\n-    // For production builds we want to simply fail to prevent accidental misconfiguration.\n-    if (!isDev) {\n-      process.exit(1)\n-    }\n   }\n \n   if (unsupportedConfig.length) {"
        },
        {
            "sha": "f62b101ea0f9e57cce4d089f3239d049e43e4149",
            "filename": "scripts/test-new-tests.mjs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/scripts%2Ftest-new-tests.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/scripts%2Ftest-new-tests.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Ftest-new-tests.mjs?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -153,7 +153,6 @@ async function main() {\n         NEXT_EXTERNAL_TESTS_FILTERS,\n         NEXT_TEST_MODE: testMode,\n         NEXT_TEST_VERSION: nextTestVersion,\n-        IS_WEBPACK_TEST: '1',\n       },\n     })\n   }\n@@ -171,7 +170,6 @@ async function main() {\n           NEXT_TEST_VERSION: nextTestVersion,\n           IS_TURBOPACK_TEST: '1',\n           TURBOPACK_BUILD: testMode === 'start' ? '1' : undefined,\n-          TURBOPACK_DEV: testMode === 'dev' ? '1' : undefined,\n         },\n       })\n     }"
        },
        {
            "sha": "f43c75d6176fdf0cd765aa8c0c9738dd48ad6ef5",
            "filename": "test/development/next-config-ts/turbo/index.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/test%2Fdevelopment%2Fnext-config-ts%2Fturbo%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/test%2Fdevelopment%2Fnext-config-ts%2Fturbo%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fnext-config-ts%2Fturbo%2Findex.test.ts?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -1,15 +1,13 @@\n import { nextTestSetup } from 'e2e-utils'\n-;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n-  'next-config-ts - turbopack',\n-  () => {\n-    const { next } = nextTestSetup({\n-      files: __dirname,\n-      // explicitly ensure that turbopack is used\n-      startCommand: 'pnpm next dev --turbopack',\n-    })\n-    it('should work with Turbopack', async () => {\n-      const $ = await next.render$('/')\n-      expect($('p').text()).toBe('foo')\n-    })\n-  }\n-)\n+\n+describe('next-config-ts - turbopack', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    // explicitly ensure that turbopack is used\n+    startCommand: 'pnpm next dev --turbo',\n+  })\n+  it('should work with Turbopack', async () => {\n+    const $ = await next.render$('/')\n+    expect($('p').text()).toBe('foo')\n+  })\n+})"
        },
        {
            "sha": "36dacfd63a972f134cef42f2fa82548fb93a3fae",
            "filename": "test/e2e/config-turbopack/index.test.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 91,
            "changes": 135,
            "blob_url": "https://github.com/vercel/next.js/blob/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/test%2Fe2e%2Fconfig-turbopack%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b/test%2Fe2e%2Fconfig-turbopack%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fconfig-turbopack%2Findex.test.ts?ref=dadfaa1b5a28c6b62e07ba1cfa16c8f3d091703b",
            "patch": "@@ -5,90 +5,40 @@ const WARNING_MESSAGE = 'Webpack is configured while Turbopack is not'\n \n const itif = (condition: boolean) => (condition ? it : it.skip)\n \n-const page = {\n-  'app/page.js': `\n-export default function Page() {\n-  return <p>hello world</p>\n-}\n-`,\n-}\n-\n-const TURBOPACK_FLAG = process.env.TURBOPACK\n describe('config-turbopack', () => {\n-  describe('when turbopack is auto selected', () => {\n-    if (process.env.IS_TURBOPACK_TEST) {\n-      beforeAll(() => {\n-        // This is hacky since it isn't a public API, but it's the only way to test this.\n-        // If next started ignoring IS_TURBOPACK_TEST we could possibly change nextTestSetup to not set the turbopack flag.\n-        process.env.TURBOPACK = 'auto'\n-      })\n-      afterAll(() => {\n-        if (TURBOPACK_FLAG) {\n-          process.env.TURBOPACK = TURBOPACK_FLAG\n-        } else {\n-          delete process.env.TURBOPACK\n-        }\n-      })\n-    }\n-    describe('when webpack is configured but Turbopack is not', () => {\n-      const { next, isTurbopack, isNextDev, isNextStart } = nextTestSetup({\n-        skipStart: Boolean(process.env.TURBOPACK_BUILD),\n-        turbo: false,\n-        files: {\n-          ...page,\n-          'next.config.js': `\n+  describe('when webpack is configured but Turbopack is not', () => {\n+    const { next, isTurbopack } = nextTestSetup({\n+      files: {\n+        'app/page.js': `\n+          export default function Page() {\n+            return <p>hello world</p>\n+          }\n+        `,\n+        'next.config.js': `\n           module.exports = {\n             webpack: (config) => {\n               return config\n             },\n           }\n         `,\n-        },\n-      })\n-\n-      itif(isTurbopack && isNextDev)('warns', async () => {\n-        if (next) await next.render('/')\n-        expect(next.cliOutput).toContain(WARNING_MESSAGE)\n-      })\n-      itif(isTurbopack && isNextStart)('errors', async () => {\n-        const { exitCode, cliOutput } = await next.build()\n-        expect(exitCode).toBe(1)\n-        expect(cliOutput).toContain(WARNING_MESSAGE)\n-      })\n+      },\n     })\n-    // no warn cases work when auto selected too\n-    noWarnCases()\n-  })\n-\n-  describe('when turbopack is explicitly configured', () => {\n-    describe('when webpack is configured but Turbopack is not', () => {\n-      const { next, isTurbopack } = nextTestSetup({\n-        files: {\n-          ...page,\n-          'next.config.js': `\n-            module.exports = {\n-              webpack: (config) => {\n-                return config\n-              },\n-            }\n-          `,\n-        },\n-      })\n \n-      itif(isTurbopack)('does not warn', async () => {\n-        if (next) await next.render('/')\n-        expect(next.cliOutput).not.toContain(WARNING_MESSAGE)\n-      })\n+    itif(isTurbopack)('warns', async () => {\n+      if (next) await next.render('/')\n+      expect(next.cliOutput).toContain(WARNING_MESSAGE)\n     })\n-    noWarnCases()\n   })\n-  /// These other cases don't warn because --turbopack is explicitly selected\n-  function noWarnCases() {\n-    describe('when webpack is configured and config.turbopack is set', () => {\n-      const { next, isTurbopack } = nextTestSetup({\n-        files: {\n-          ...page,\n-          'next.config.js': `\n+\n+  describe('when webpack is configured and config.turbopack is set', () => {\n+    const { next, isTurbopack } = nextTestSetup({\n+      files: {\n+        'app/page.js': `\n+          export default function Page() {\n+            return <p>hello world</p>\n+          }\n+        `,\n+        'next.config.js': `\n           module.exports = {\n             turbopack: {\n               rules: {\n@@ -102,20 +52,24 @@ describe('config-turbopack', () => {\n             },\n           }\n         `,\n-        },\n-      })\n+      },\n+    })\n \n-      itif(isTurbopack)('does not warn', async () => {\n-        if (next) await next.render('/')\n-        expect(next.cliOutput).not.toContain(WARNING_MESSAGE)\n-      })\n+    itif(isTurbopack)('does not warn', async () => {\n+      if (next) await next.render('/')\n+      expect(next.cliOutput).not.toContain(WARNING_MESSAGE)\n     })\n+  })\n \n-    describe('when webpack is configured and config.experimental.turbo is set', () => {\n-      const { next, isTurbopack } = nextTestSetup({\n-        files: {\n-          ...page,\n-          'next.config.js': `\n+  describe('when webpack is configured and config.experimental.turbo is set', () => {\n+    const { next, isTurbopack } = nextTestSetup({\n+      files: {\n+        'app/page.js': `\n+          export default function Page() {\n+            return <p>hello world</p>\n+          }\n+        `,\n+        'next.config.js': `\n           module.exports = {\n             experimental: {\n               turbo: {\n@@ -131,13 +85,12 @@ describe('config-turbopack', () => {\n             },\n           }\n         `,\n-        },\n-      })\n+      },\n+    })\n \n-      itif(isTurbopack)('does not warn', async () => {\n-        if (next) await next.render('/')\n-        expect(next.cliOutput).not.toContain(WARNING_MESSAGE)\n-      })\n+    itif(isTurbopack)('does not warn', async () => {\n+      if (next) await next.render('/')\n+      expect(next.cliOutput).not.toContain(WARNING_MESSAGE)\n     })\n-  }\n+  })\n })"
        }
    ],
    "stats": {
        "total": 503,
        "additions": 146,
        "deletions": 357
    }
}