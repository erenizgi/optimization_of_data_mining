{
    "author": "feedthejim",
    "message": "perf: improve stats thresholds to reduce CI noise (#88158)\n\n## Summary\n\nAdd per-metric significance thresholds that account for variance.\n\n**Time metrics** (high variance from CI):\n- Dev boot: <100ms AND <15%, OR <3%\n- Build times: <500ms AND <5%, OR <2%\n\n**Size metrics** (deterministic):\n- node_modules: <10KB AND <1%, OR <0.01%\n- Bundle sizes: <2KB AND <1%, OR <0.1%\n\n## Problem\n\nCurrent thresholds flag insignificant changes as regressions:\n- 3.45 KB change on 457 MB node_modules (0.0008%) was flagged as a\nregression\n\n## Solution\n\nUse per-metric thresholds with OR logic for very small percentage\nchanges:\n- Time metrics need more generous thresholds due to CI variance\n- Size metrics can be tighter since they're deterministic\n\n## Test plan\n\n- Verify that 3.45 KB on 457 MB (0%) is now marked as insignificant\n- Verify that real regressions (>0.1% for sizes, >3% for times) are\nstill flagged\n\n---\n\nStack:\n- #88157\n- **→ This PR**",
    "sha": "be6fcb250e28ba3c40bb12aee45a87541a3eac6f",
    "files": [
        {
            "sha": "6a11edde50ecff98fac3d173bec74f7420b4f93e",
            "filename": ".github/actions/next-stats-action/src/add-comment.js",
            "status": "modified",
            "additions": 48,
            "deletions": 13,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/be6fcb250e28ba3c40bb12aee45a87541a3eac6f/.github%2Factions%2Fnext-stats-action%2Fsrc%2Fadd-comment.js",
            "raw_url": "https://github.com/vercel/next.js/raw/be6fcb250e28ba3c40bb12aee45a87541a3eac6f/.github%2Factions%2Fnext-stats-action%2Fsrc%2Fadd-comment.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Factions%2Fnext-stats-action%2Fsrc%2Fadd-comment.js?ref=be6fcb250e28ba3c40bb12aee45a87541a3eac6f",
            "patch": "@@ -162,6 +162,38 @@ const METRIC_GROUPS = {\n   },\n }\n \n+// Per-metric significance thresholds\n+// A change is insignificant if:\n+//   - (absoluteDiff < absoluteMin AND percentDiff < percentMin), OR\n+//   - percentDiff < percentOnly\n+//\n+// Time metrics have HIGH VARIANCE (CPU, I/O, cache) - need generous thresholds\n+// Size metrics are DETERMINISTIC - can be tighter\n+const METRIC_THRESHOLDS = {\n+  // Dev boot times (~300-400ms): high variance from CI\n+  // <100ms AND <15%, OR <3%\n+  ms: { absoluteMin: 100, percentMin: 15, percentOnly: 3 },\n+\n+  // Build times (~13s): high variance, longer duration\n+  // <500ms AND <5%, OR <2%\n+  buildDurationTurbo: { absoluteMin: 500, percentMin: 5, percentOnly: 2 },\n+  buildDurationCachedTurbo: { absoluteMin: 500, percentMin: 5, percentOnly: 2 },\n+  buildDurationWebpack: { absoluteMin: 500, percentMin: 5, percentOnly: 2 },\n+  buildDurationCachedWebpack: {\n+    absoluteMin: 500,\n+    percentMin: 5,\n+    percentOnly: 2,\n+  },\n+\n+  // node_modules (~450MB): deterministic, huge baseline\n+  // <10KB AND <1%, OR <0.01%\n+  nodeModulesSize: { absoluteMin: 10240, percentMin: 1, percentOnly: 0.01 },\n+\n+  // Bundle sizes (KB-MB): deterministic\n+  // <2KB AND <1%, OR <0.1%\n+  bytes: { absoluteMin: 2048, percentMin: 1, percentOnly: 0.1 },\n+}\n+\n // ============================================================================\n // Historical Data (Vercel KV)\n // ============================================================================\n@@ -229,27 +261,30 @@ function getMetricLabel(key) {\n   return METRIC_LABELS[key] || shortenLabel(key)\n }\n \n-function formatChange(mainVal, diffVal, type = 'bytes') {\n+function formatChange(mainVal, diffVal, type = 'bytes', metricKey = null) {\n   if (typeof mainVal !== 'number' || typeof diffVal !== 'number') {\n     return { text: '-', significant: false, improved: false, regression: false }\n   }\n \n   const diff = diffVal - mainVal\n   const percentChange = mainVal > 0 ? (diff / mainVal) * 100 : 0\n \n-  // Thresholds: filter CI noise while catching real regressions\n-  // For time:\n-  //   - (<50ms AND <10%) = insignificant for short ops (dev boot ~300ms)\n-  //   - OR <2% = insignificant for long ops (builds ~13s where 70ms is noise)\n-  // For size: <1KB AND <1% = not worth mentioning\n-  // If mainVal is 0 and diff is non-zero, always consider it significant\n+  // Get threshold config: prefer metric-specific, then type-based, then default to bytes\n+  const threshold =\n+    METRIC_THRESHOLDS[metricKey] ||\n+    METRIC_THRESHOLDS[type] ||\n+    METRIC_THRESHOLDS.bytes\n+\n+  // A change is insignificant if:\n+  //   - (absoluteDiff < absoluteMin AND percentDiff < percentMin), OR\n+  //   - percentDiff < percentOnly (definitely noise regardless of absolute)\n+  // Exception: if mainVal is 0 and diff is non-zero, always significant\n   const isInsignificant =\n     mainVal === 0 && diff !== 0\n       ? false\n-      : type === 'ms'\n-        ? (Math.abs(diff) < 50 && Math.abs(percentChange) < 10) ||\n-          Math.abs(percentChange) < 2\n-        : Math.abs(diff) < 1024 && Math.abs(percentChange) < 1\n+      : (Math.abs(diff) < threshold.absoluteMin &&\n+          Math.abs(percentChange) < threshold.percentMin) ||\n+        Math.abs(percentChange) < threshold.percentOnly\n \n   if (isInsignificant) {\n     return { text: '✓', significant: false, improved: false, regression: false }\n@@ -378,7 +413,7 @@ function generateChangeSummary(mainStats, diffStats, history) {\n     const mainVal = mainGeneral[key]\n     const diffVal = diffGeneral[key]\n     const type = getMetricType(key)\n-    const change = formatChange(mainVal, diffVal, type)\n+    const change = formatChange(mainVal, diffVal, type, key)\n \n     if (change.significant) {\n       const histValues = getHistoricalValues(history, key)\n@@ -483,7 +518,7 @@ function generateMetricsTable(\n     const metricType = metricDef.type || 'ms'\n     const mainStr = prettify(mainVal, metricType)\n     const diffStr = prettify(diffVal, metricType)\n-    const change = formatChange(mainVal, diffVal, metricType)\n+    const change = formatChange(mainVal, diffVal, metricType, metricDef.key)\n     const histValues = getHistoricalValues(history, metricDef.key)\n     const sparkline = generateTrendBar(histValues)\n "
        }
    ],
    "stats": {
        "total": 61,
        "additions": 48,
        "deletions": 13
    }
}