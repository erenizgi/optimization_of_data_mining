{
    "author": "mischnic",
    "message": "Turbopack: Add PURE comments for FreeVarReference::EcmaScriptModule (#80902)\n\nIdeally, we'd refactor `Effect`s so that overlapping effects (i.e. `process.env.NODE_ENV` inlining and polyfilling the `process` variable in the browser context) don't run twice.\r\n\r\nBut this lessens the impact by making\r\n```js\r\nconsole.log(process.env.NODE_ENV);\r\n```\r\nproduce\r\n```js\r\nvar __TURBOPACK_imported_$process = /*@__PURE__*/ __turbopack_import__(\"[project]/node_modules/process/index.js\");\r\nconsole.log(\"production)\";\r\n```\r\nso that the minifier can get rid of the import (even though the module will still be bundled).",
    "sha": "69f805c32dd466c518e52ccc083f2b34e5d9298c",
    "files": [
        {
            "sha": "f928b43e91bdfb15dad5e6d7b13d3c33e10fd80e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/base.rs",
            "status": "modified",
            "additions": 63,
            "deletions": 22,
            "changes": 85,
            "blob_url": "https://github.com/vercel/next.js/blob/69f805c32dd466c518e52ccc083f2b34e5d9298c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/69f805c32dd466c518e52ccc083f2b34e5d9298c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs?ref=69f805c32dd466c518e52ccc083f2b34e5d9298c",
            "patch": "@@ -2,7 +2,7 @@ use anyhow::{Result, anyhow, bail};\n use either::Either;\n use strsim::jaro;\n use swc_core::{\n-    common::{BytePos, DUMMY_SP, Span, SyntaxContext},\n+    common::{BytePos, DUMMY_SP, Span, SyntaxContext, source_map::PURE_SP},\n     ecma::ast::{\n         ComputedPropName, Decl, Expr, ExprStmt, Ident, Lit, MemberExpr, MemberProp, Number,\n         SeqExpr, Stmt, Str,\n@@ -315,6 +315,7 @@ pub struct EsmAssetReference {\n     pub issue_source: IssueSource,\n     pub export_name: Option<ModulePart>,\n     pub import_externals: bool,\n+    pub is_pure_import: bool,\n }\n \n impl EsmAssetReference {\n@@ -343,6 +344,26 @@ impl EsmAssetReference {\n             annotations,\n             export_name,\n             import_externals,\n+            is_pure_import: false,\n+        }\n+    }\n+\n+    pub fn new_pure(\n+        origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n+        request: ResolvedVc<Request>,\n+        issue_source: IssueSource,\n+        annotations: ImportAnnotations,\n+        export_name: Option<ModulePart>,\n+        import_externals: bool,\n+    ) -> Self {\n+        EsmAssetReference {\n+            origin,\n+            request,\n+            issue_source,\n+            annotations,\n+            export_name,\n+            import_externals,\n+            is_pure_import: true,\n         }\n     }\n }\n@@ -577,14 +598,21 @@ impl EsmAssetReference {\n                                             DUMMY_SP,\n                                             ctxt.unwrap_or_default(),\n                                         );\n+                                        let mut call_expr = quote!(\n+                                            \"$turbopack_import($id)\" as Expr,\n+                                            turbopack_import: Expr = TURBOPACK_IMPORT.into(),\n+                                            id: Expr = module_id_to_lit(&id),\n+                                        );\n+                                        if this.is_pure_import {\n+                                            call_expr.set_span(PURE_SP);\n+                                        }\n                                         result.push(CodeGenerationHoistedStmt::new(\n                                             id.to_string().into(),\n                                             var_decl_with_span(\n                                                 quote!(\n-                                                    \"var $name = $turbopack_import($id);\" as Stmt,\n+                                                    \"var $name = $call;\" as Stmt,\n                                                     name = name,\n-                                                    turbopack_import: Expr = TURBOPACK_IMPORT.into(),\n-                                                    id: Expr = module_id_to_lit(&id),\n+                                                    call: Expr = call_expr\n                                                 ),\n                                                 span,\n                                             ),\n@@ -613,24 +641,30 @@ impl EsmAssetReference {\n                                             DUMMY_SP,\n                                             ctxt.unwrap_or_default(),\n                                         );\n+                                        let mut call_expr = if import_externals {\n+                                            quote!(\n+                                                \"$turbopack_external_import($id)\" as Expr,\n+                                                turbopack_external_import: Expr = TURBOPACK_EXTERNAL_IMPORT.into(),\n+                                                id: Expr = Expr::Lit(request.clone().to_string().into())\n+                                            )\n+                                        } else {\n+                                            quote!(\n+                                                \"$turbopack_external_require($id, () => require($id), true)\" as Expr,\n+                                                turbopack_external_require: Expr = TURBOPACK_EXTERNAL_REQUIRE.into(),\n+                                                id: Expr = Expr::Lit(request.clone().to_string().into())\n+                                            )\n+                                        };\n+                                        if this.is_pure_import {\n+                                            call_expr.set_span(PURE_SP);\n+                                        }\n                                         result.push(CodeGenerationHoistedStmt::new(\n                                             name.sym.as_str().into(),\n                                             var_decl_with_span(\n-                                                if import_externals {\n-                                                    quote!(\n-                                                        \"var $name = $turbopack_external_import($id);\" as Stmt,\n-                                                        name = name,\n-                                                        turbopack_external_import: Expr = TURBOPACK_EXTERNAL_IMPORT.into(),\n-                                                        id: Expr = Expr::Lit(request.clone().to_string().into())\n-                                                    )\n-                                                } else {\n-                                                    quote!(\n-                                                        \"var $name = $turbopack_external_require($id, () => require($id), true);\" as Stmt,\n-                                                        name = name,\n-                                                        turbopack_external_require: Expr = TURBOPACK_EXTERNAL_REQUIRE.into(),\n-                                                        id: Expr = Expr::Lit(request.clone().to_string().into())\n-                                                    )\n-                                                },\n+                                                quote!(\n+                                                    \"var $name = $call;\" as Stmt,\n+                                                    name = name,\n+                                                    call: Expr = call_expr,\n+                                                ),\n                                                 span,\n                                             ),\n                                         ));\n@@ -658,14 +692,21 @@ impl EsmAssetReference {\n                                             DUMMY_SP,\n                                             ctxt.unwrap_or_default(),\n                                         );\n+                                        let mut call_expr = quote!(\n+                                            \"$turbopack_external_require($id, () => require($id), true)\" as Expr,\n+                                            turbopack_external_require: Expr = TURBOPACK_EXTERNAL_REQUIRE.into(),\n+                                            id: Expr = Expr::Lit(request.clone().to_string().into())\n+                                        );\n+                                        if this.is_pure_import {\n+                                            call_expr.set_span(PURE_SP);\n+                                        }\n                                         result.push(CodeGenerationHoistedStmt::new(\n                                             name.sym.as_str().into(),\n                                             var_decl_with_span(\n                                                 quote!(\n-                                                    \"var $name = $turbopack_external_require($id, () => require($id), true);\" as Stmt,\n+                                                    \"var $name = $call;\" as Stmt,\n                                                     name = name,\n-                                                    turbopack_external_require: Expr = TURBOPACK_EXTERNAL_REQUIRE.into(),\n-                                                    id: Expr = Expr::Lit(request.clone().to_string().into())\n+                                                    call: Expr = call_expr,\n                                                 ),\n                                                 span,\n                                             ),"
        },
        {
            "sha": "aebeebaaaaa640b75ccb8fe349f8340d01de11be",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/69f805c32dd466c518e52ccc083f2b34e5d9298c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/69f805c32dd466c518e52ccc083f2b34e5d9298c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=69f805c32dd466c518e52ccc083f2b34e5d9298c",
            "patch": "@@ -2587,7 +2587,11 @@ async fn handle_free_var_reference(\n         } => {\n             let esm_reference = analysis\n                 .add_esm_reference_free_var(request.clone(), async || {\n-                    Ok(EsmAssetReference::new(\n+                    // There would be no import in the first place if you don't reference the given\n+                    // free var (e.g. `process`). This means that it's also fine to remove the\n+                    // import again if the variable reference turns out be dead code in some later\n+                    // stage of the build, thus mark the import call as /*@__PURE__*/.\n+                    Ok(EsmAssetReference::new_pure(\n                         if let Some(lookup_path) = lookup_path {\n                             ResolvedVc::upcast(\n                                 PlainResolveOrigin::new("
        }
    ],
    "stats": {
        "total": 91,
        "additions": 68,
        "deletions": 23
    }
}