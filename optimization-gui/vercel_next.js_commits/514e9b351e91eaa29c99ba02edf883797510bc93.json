{
    "author": "sokra",
    "message": "Turbopack: inline minify into code generation and make it a plain function instead of a turbo tasks function (#76628)\n\n### What?\n\nThis avoids celling the input code for minification and passes is directly to magnification",
    "sha": "514e9b351e91eaa29c99ba02edf883797510bc93",
    "files": [
        {
            "sha": "080349e1cb3cff06553e218da4669f86eb711887",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/content.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -65,9 +65,10 @@ impl EcmascriptBrowserChunkContent {\n     async fn code(self: Vc<Self>) -> Result<Vc<Code>> {\n         let this = self.await?;\n         let output_root = this.chunking_context.output_root().await?;\n-        let source_maps = this\n+        let source_maps = *this\n             .chunking_context\n-            .reference_chunk_source_maps(*ResolvedVc::upcast(this.chunk));\n+            .reference_chunk_source_maps(*ResolvedVc::upcast(this.chunk))\n+            .await?;\n         let chunk_path_vc = this.chunk.path();\n         let chunk_path = chunk_path_vc.await?;\n         let chunk_server_path = if let Some(path) = output_root.get_path_to(&chunk_path) {\n@@ -108,7 +109,7 @@ impl EcmascriptBrowserChunkContent {\n \n         write!(code, \"\\n}}]);\")?;\n \n-        if *source_maps.await? && code.has_source_map() {\n+        if source_maps && code.has_source_map() {\n             let filename = chunk_path.file_name();\n             write!(\n                 code,\n@@ -119,13 +120,13 @@ impl EcmascriptBrowserChunkContent {\n             )?;\n         }\n \n-        let code = code.build().cell();\n+        let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            return Ok(minify(chunk_path_vc, code, source_maps, mangle));\n+            code = minify(&*chunk_path_vc.await?, &code, source_maps, mangle)?;\n         }\n \n-        Ok(code)\n+        Ok(code.cell())\n     }\n }\n "
        },
        {
            "sha": "c9b9a10c6fd0a053fe7be18755b7e0a5242fd30b",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/evaluate/chunk.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -76,9 +76,10 @@ impl EcmascriptBrowserEvaluateChunk {\n \n         let output_root = this.chunking_context.output_root().await?;\n         let output_root_to_root_path = this.chunking_context.output_root_to_root_path();\n-        let source_maps = this\n+        let source_maps = *this\n             .chunking_context\n-            .reference_chunk_source_maps(Vc::upcast(self));\n+            .reference_chunk_source_maps(Vc::upcast(self))\n+            .await?;\n         let chunk_path_vc = self.path();\n         let chunk_path = chunk_path_vc.await?;\n         let chunk_public_path = if let Some(path) = output_root.get_path_to(&chunk_path) {\n@@ -175,7 +176,7 @@ impl EcmascriptBrowserEvaluateChunk {\n             }\n         }\n \n-        if *source_maps.await? && code.has_source_map() {\n+        if source_maps && code.has_source_map() {\n             let filename = chunk_path.file_name();\n             write!(\n                 code,\n@@ -186,13 +187,13 @@ impl EcmascriptBrowserEvaluateChunk {\n             )?;\n         }\n \n-        let code = code.build().cell();\n+        let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            return Ok(minify(chunk_path_vc, code, source_maps, mangle));\n+            code = minify(&*chunk_path_vc.await?, &code, source_maps, mangle)?;\n         }\n \n-        Ok(code)\n+        Ok(code.cell())\n     }\n }\n "
        },
        {
            "sha": "6c4aae98e8df3342bea2a0d7f26271bfc552e5af",
            "filename": "turbopack/crates/turbopack-css/src/module_asset.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 9,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -403,13 +403,10 @@ impl EcmascriptChunkItem for ModuleChunkItem {\n             // We generate a minimal map for runtime code so that the filename is\n             // displayed in dev tools.\n             source_map: if source_map {\n-                Some(\n-                    generate_minimal_source_map(\n-                        self.module.ident().to_string().await?.to_string(),\n-                        code,\n-                    )\n-                    .await?,\n-                )\n+                Some(generate_minimal_source_map(\n+                    self.module.ident().to_string().await?.to_string(),\n+                    code,\n+                )?)\n             } else {\n                 None\n             },\n@@ -419,7 +416,7 @@ impl EcmascriptChunkItem for ModuleChunkItem {\n     }\n }\n \n-async fn generate_minimal_source_map(filename: String, source: String) -> Result<Rope> {\n+fn generate_minimal_source_map(filename: String, source: String) -> Result<Rope> {\n     let mut mappings = vec![];\n     // Start from 1 because 0 is reserved for dummy spans in SWC.\n     let mut pos = 1;\n@@ -435,7 +432,7 @@ async fn generate_minimal_source_map(filename: String, source: String) -> Result\n     }\n     let sm: Arc<SourceMap> = Default::default();\n     sm.new_source_file(FileName::Custom(filename).into(), source);\n-    let map = generate_js_source_map(sm, mappings, None).await?;\n+    let map = generate_js_source_map(sm, mappings, None)?;\n     Ok(map)\n }\n "
        },
        {
            "sha": "7d11b28254a90441c963639a07d8183a88436014",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/src/browser_runtime.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fbrowser_runtime.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fbrowser_runtime.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fbrowser_runtime.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -20,7 +20,7 @@ pub async fn get_browser_runtime_code(\n     chunk_base_path: Vc<Option<RcStr>>,\n     runtime_type: Value<RuntimeType>,\n     output_root_to_root_path: Vc<RcStr>,\n-    generate_source_map: Vc<bool>,\n+    generate_source_map: bool,\n ) -> Result<Vc<Code>> {\n     let asset_context = get_runtime_asset_context(environment).await?;\n "
        },
        {
            "sha": "d627ad9aa7076bf4aac4cfdd43287c8ac3011ebc",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/src/embed_js.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fembed_js.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fembed_js.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fembed_js.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -23,7 +23,7 @@ pub fn embed_file_path(path: RcStr) -> Vc<FileSystemPath> {\n pub fn embed_static_code(\n     asset_context: Vc<Box<dyn AssetContext>>,\n     path: RcStr,\n-    generate_source_map: Vc<bool>,\n+    generate_source_map: bool,\n ) -> Vc<Code> {\n     StaticEcmascriptCode::new(asset_context, embed_file_path(path), generate_source_map).code()\n }"
        },
        {
            "sha": "808d15b9719c69b3d95d64ef17e938fc1877403a",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/src/nodejs_runtime.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fnodejs_runtime.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fnodejs_runtime.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fnodejs_runtime.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -11,7 +11,7 @@ use crate::{asset_context::get_runtime_asset_context, embed_js::embed_static_cod\n #[turbo_tasks::function]\n pub async fn get_nodejs_runtime_code(\n     environment: Vc<Environment>,\n-    generate_source_map: Vc<bool>,\n+    generate_source_map: bool,\n ) -> Result<Vc<Code>> {\n     let asset_context = get_runtime_asset_context(environment).await?;\n "
        },
        {
            "sha": "84b1da86bbbd3926038a11328814547c3b2d27f5",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 16,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -292,7 +292,7 @@ pub trait EcmascriptAnalyzable {\n     /// transforming code that is not a module, e.g. runtime code.\n     async fn module_content_without_analysis(\n         self: Vc<Self>,\n-        generate_source_map: Vc<bool>,\n+        generate_source_map: bool,\n     ) -> Result<Vc<EcmascriptModuleContent>>;\n \n     async fn module_content(\n@@ -396,7 +396,7 @@ impl EcmascriptAnalyzable for EcmascriptModuleAsset {\n     #[turbo_tasks::function]\n     async fn module_content_without_analysis(\n         self: Vc<Self>,\n-        generate_source_map: Vc<bool>,\n+        generate_source_map: bool,\n     ) -> Result<Vc<EcmascriptModuleContent>> {\n         let this = self.await?;\n \n@@ -423,7 +423,9 @@ impl EcmascriptAnalyzable for EcmascriptModuleAsset {\n         let analyze_ref = analyze.await?;\n \n         let module_type_result = *self.determine_module_type().await?;\n-        let generate_source_map = chunking_context.reference_module_source_maps(Vc::upcast(self));\n+        let generate_source_map = *chunking_context\n+            .reference_module_source_maps(Vc::upcast(self))\n+            .await?;\n \n         Ok(EcmascriptModuleContent::new(\n             EcmascriptModuleContentOptions {\n@@ -766,7 +768,7 @@ pub struct EcmascriptModuleContentOptions {\n     esm_references: Vc<EsmAssetReferences>,\n     code_generation: Vc<CodeGens>,\n     async_module: Vc<OptionAsyncModule>,\n-    generate_source_map: Vc<bool>,\n+    generate_source_map: bool,\n     original_source_map: ResolvedVc<OptionStringifiedSourceMap>,\n     exports: Vc<EcmascriptExports>,\n     async_module_info: Option<Vc<AsyncModuleInfo>>,\n@@ -856,7 +858,7 @@ impl EcmascriptModuleContent {\n         parsed: Vc<ParseResult>,\n         ident: Vc<AssetIdent>,\n         specified_module_type: SpecifiedModuleType,\n-        generate_source_map: Vc<bool>,\n+        generate_source_map: bool,\n     ) -> Result<Vc<Self>> {\n         gen_content_with_code_gens(\n             parsed.to_resolved().await?,\n@@ -875,7 +877,7 @@ async fn gen_content_with_code_gens(\n     ident: Vc<AssetIdent>,\n     specified_module_type: SpecifiedModuleType,\n     code_gens: impl IntoIterator<Item = &CodeGeneration>,\n-    generate_source_map: Vc<bool>,\n+    generate_source_map: bool,\n     original_source_map: ResolvedVc<OptionStringifiedSourceMap>,\n ) -> Result<Vc<EcmascriptModuleContent>> {\n     let parsed = parsed.final_read_hint().await?;\n@@ -937,8 +939,6 @@ async fn gen_content_with_code_gens(\n \n             let mut mappings = vec![];\n \n-            let generate_source_map = *generate_source_map.await?;\n-\n             {\n                 let comments = match comments {\n                     Either::Left(comments) => Either::Left(comments.into_consumable()),\n@@ -965,14 +965,11 @@ async fn gen_content_with_code_gens(\n             }\n \n             let source_map = if generate_source_map {\n-                Some(\n-                    generate_js_source_map(\n-                        source_map.clone(),\n-                        mappings,\n-                        original_source_map.await?.as_ref(),\n-                    )\n-                    .await?,\n-                )\n+                Some(generate_js_source_map(\n+                    source_map.clone(),\n+                    mappings,\n+                    original_source_map.await?.as_ref(),\n+                )?)\n             } else {\n                 None\n             };"
        },
        {
            "sha": "5d19d255d87f08d9356cbd49441ebcacfe194129",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 13,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -19,23 +19,13 @@ use swc_core::{\n         transforms::base::fixer::paren_remover,\n     },\n };\n-use turbo_tasks::Vc;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::code_builder::{Code, CodeBuilder};\n \n use crate::parse::generate_js_source_map;\n \n-#[turbo_tasks::function]\n-pub async fn minify(\n-    path: Vc<FileSystemPath>,\n-    code: Vc<Code>,\n-    source_maps: Vc<bool>,\n-    mangle: bool,\n-) -> Result<Vc<Code>> {\n-    let path = path.await?;\n-    let code = code.await?;\n+pub fn minify(path: &FileSystemPath, code: &Code, source_maps: bool, mangle: bool) -> Result<Code> {\n     let source_maps = source_maps\n-        .await?\n         .then(|| code.generate_source_map_ref())\n         .transpose()?;\n \n@@ -121,7 +111,7 @@ pub async fn minify(\n         src_map_buf.shrink_to_fit();\n         builder.push_source(\n             &src.into(),\n-            Some(generate_js_source_map(cm, src_map_buf, Some(original_map)).await?),\n+            Some(generate_js_source_map(cm, src_map_buf, Some(original_map))?),\n         );\n \n         write!(\n@@ -134,7 +124,7 @@ pub async fn minify(\n     } else {\n         builder.push_source(&src.into(), None);\n     }\n-    Ok(builder.build().cell())\n+    Ok(builder.build())\n }\n \n // From https://github.com/swc-project/swc/blob/11efd4e7c5e8081f8af141099d3459c3534c1e1d/crates/swc/src/lib.rs#L523-L560"
        },
        {
            "sha": "a8c05a947bcf59ef332f1c75d746ef9cb5115509",
            "filename": "turbopack/crates/turbopack-ecmascript/src/parse.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -74,7 +74,7 @@ impl PartialEq for ParseResult {\n     }\n }\n \n-pub async fn generate_js_source_map(\n+pub fn generate_js_source_map(\n     files_map: Arc<swc_core::common::SourceMap>,\n     mappings: Vec<(BytePos, LineCol)>,\n     original_source_map: Option<&Rope>,"
        },
        {
            "sha": "620764fa2439dd8130a24dab2e2c66b86cc746b2",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/locals/chunk_item.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fchunk_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fchunk_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fchunk_item.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -50,8 +50,9 @@ impl EcmascriptChunkItem for EcmascriptModuleLocalsChunkItem {\n             .module_options(async_module_info);\n \n         let module_type_result = *original_module.determine_module_type().await?;\n-        let generate_source_map =\n-            chunking_context.reference_module_source_maps(*ResolvedVc::upcast(self.module));\n+        let generate_source_map = *chunking_context\n+            .reference_module_source_maps(*ResolvedVc::upcast(self.module))\n+            .await?;\n \n         let content = EcmascriptModuleContent::new(EcmascriptModuleContentOptions {\n             parsed,"
        },
        {
            "sha": "ab373ac2fbc1c7b4f8b3cafdbe4deb04145a8195",
            "filename": "turbopack/crates/turbopack-ecmascript/src/static_code.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fstatic_code.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fstatic_code.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fstatic_code.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -18,7 +18,7 @@ use crate::EcmascriptAnalyzable;\n pub struct StaticEcmascriptCode {\n     asset_context: ResolvedVc<Box<dyn AssetContext>>,\n     asset: ResolvedVc<Box<dyn EcmascriptAnalyzable>>,\n-    generate_source_map: ResolvedVc<bool>,\n+    generate_source_map: bool,\n }\n \n #[turbo_tasks::value_impl]\n@@ -28,7 +28,7 @@ impl StaticEcmascriptCode {\n     pub async fn new(\n         asset_context: ResolvedVc<Box<dyn AssetContext>>,\n         asset_path: ResolvedVc<FileSystemPath>,\n-        generate_source_map: ResolvedVc<bool>,\n+        generate_source_map: bool,\n     ) -> Result<Vc<Self>> {\n         let module = asset_context\n             .process(\n@@ -54,7 +54,7 @@ impl StaticEcmascriptCode {\n     pub async fn code(&self) -> Result<Vc<Code>> {\n         let runtime_base_content = self\n             .asset\n-            .module_content_without_analysis(*self.generate_source_map)\n+            .module_content_without_analysis(self.generate_source_map)\n             .await?;\n         let mut code = CodeBuilder::default();\n         code.push_source("
        },
        {
            "sha": "9409b51c38368a4e3a78ed6fc315b1c121328b56",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/asset.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -67,7 +67,7 @@ impl EcmascriptAnalyzable for EcmascriptModulePartAsset {\n     #[turbo_tasks::function]\n     fn module_content_without_analysis(\n         &self,\n-        generate_source_map: Vc<bool>,\n+        generate_source_map: bool,\n     ) -> Vc<EcmascriptModuleContent> {\n         self.full_module\n             .module_content_without_analysis(generate_source_map)"
        },
        {
            "sha": "c2602be2dd0d63bb5ea9c7dc64ba3d3033b0966d",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/chunk_item.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fchunk_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fchunk_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fchunk_item.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -56,9 +56,10 @@ impl EcmascriptChunkItem for EcmascriptModulePartChunkItem {\n         let async_module_options = analyze_ref.async_module.module_options(async_module_info);\n \n         let module_type_result = *module.full_module.determine_module_type().await?;\n-        let generate_source_map = self\n+        let generate_source_map = *self\n             .chunking_context\n-            .reference_module_source_maps(*ResolvedVc::upcast(self.module));\n+            .reference_module_source_maps(*ResolvedVc::upcast(self.module))\n+            .await?;\n \n         let content = EcmascriptModuleContent::new(EcmascriptModuleContentOptions {\n             parsed,"
        },
        {
            "sha": "7fd8f1e692ebbe36dd8fa8306a9c7ec385c4c91c",
            "filename": "turbopack/crates/turbopack-nodejs/src/ecmascript/node/content.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -45,9 +45,10 @@ impl EcmascriptBuildNodeChunkContent {\n     async fn code(self: Vc<Self>) -> Result<Vc<Code>> {\n         use std::io::Write;\n         let this = self.await?;\n-        let source_maps = this\n+        let source_maps = *this\n             .chunking_context\n-            .reference_chunk_source_maps(*ResolvedVc::upcast(this.chunk));\n+            .reference_chunk_source_maps(*ResolvedVc::upcast(this.chunk))\n+            .await?;\n         let chunk_path_vc = this.chunk.path();\n         let chunk_path = chunk_path_vc.await?;\n \n@@ -73,7 +74,7 @@ impl EcmascriptBuildNodeChunkContent {\n \n         write!(code, \"\\n}};\")?;\n \n-        if *source_maps.await? && code.has_source_map() {\n+        if source_maps && code.has_source_map() {\n             let filename = chunk_path.file_name();\n             write!(\n                 code,\n@@ -82,13 +83,13 @@ impl EcmascriptBuildNodeChunkContent {\n             )?;\n         }\n \n-        let code = code.build().cell();\n+        let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            return Ok(minify(chunk_path_vc, code, source_maps, mangle));\n+            code = minify(&*chunk_path_vc.await?, &code, source_maps, mangle)?;\n         }\n \n-        Ok(code)\n+        Ok(code.cell())\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "31616b6d23b74c6c71f6d82b0952d2ec7c335044",
            "filename": "turbopack/crates/turbopack-nodejs/src/ecmascript/node/entry/runtime.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fentry%2Fruntime.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/514e9b351e91eaa29c99ba02edf883797510bc93/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fentry%2Fruntime.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fentry%2Fruntime.rs?ref=514e9b351e91eaa29c99ba02edf883797510bc93",
            "patch": "@@ -38,9 +38,10 @@ impl EcmascriptBuildNodeRuntimeChunk {\n \n         let output_root_to_root_path = this.chunking_context.output_root_to_root_path().await?;\n         let output_root = this.chunking_context.output_root().await?;\n-        let generate_source_map = this\n+        let generate_source_map = *this\n             .chunking_context\n-            .reference_chunk_source_maps(Vc::upcast(self));\n+            .reference_chunk_source_maps(Vc::upcast(self))\n+            .await?;\n         let runtime_path = self.path().await?;\n         let runtime_public_path = if let Some(path) = output_root.get_path_to(&runtime_path) {\n             path"
        }
    ],
    "stats": {
        "total": 130,
        "additions": 60,
        "deletions": 70
    }
}