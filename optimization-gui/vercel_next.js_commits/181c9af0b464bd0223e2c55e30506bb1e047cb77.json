{
    "author": "mischnic",
    "message": "Fix no-double-tailwind-execution flake (#86549)\n\nhttps://github.com/vercel/next.js/runs/56466402435\n\nwait for the `patchFile` revert operation to finish before asserting\n\n```\nFAIL webpack test/e2e/app-dir/no-double-tailwind-execution/no-double-tailwind-execution.test.ts (31.136 s)\n  no-double-tailwind-execution\n    ✕ should run tailwind only once initially and per change (20280 ms)\n\n  ● no-double-tailwind-execution › should run tailwind only once initially and per change\n\n    expect(received).toBe(expected) // Object.is equality\n\n    Expected: 3\n    Received: 2\n\n      48 |     ].length\n      49 |     if (isNextDev) {\n    > 50 |       expect(tailwindProcessingCount).toBe(3) // dev: initial + hmr + hmr (revert)\n         |                                       ^\n      51 |     } else {\n      52 |       expect(tailwindProcessingCount).toBe(1) // build\n      53 |     }\n\n      at Object.toBe (e2e/app-dir/no-double-tailwind-execution/no-double-tailwind-execution.test.ts:50:39)\n```",
    "sha": "181c9af0b464bd0223e2c55e30506bb1e047cb77",
    "files": [
        {
            "sha": "6b56f895b47ad6cff0291b08c7c073e8e967a88f",
            "filename": "test/e2e/app-dir/no-double-tailwind-execution/no-double-tailwind-execution.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 16,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/181c9af0b464bd0223e2c55e30506bb1e047cb77/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fno-double-tailwind-execution.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/181c9af0b464bd0223e2c55e30506bb1e047cb77/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fno-double-tailwind-execution.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fno-double-tailwind-execution.test.ts?ref=181c9af0b464bd0223e2c55e30506bb1e047cb77",
            "patch": "@@ -23,33 +23,37 @@ describe('no-double-tailwind-execution', () => {\n     const browser = await next.browser('/')\n     expect(await browser.elementByCss('p').text()).toBe('hello world')\n \n+    function getTailwindProcessingCount() {\n+      return [\n+        ...next.cliOutput.matchAll(\n+          /\\[@tailwindcss\\/postcss\\] app\\/globals.css/g\n+        ),\n+      ].length\n+    }\n+\n+    expect(getTailwindProcessingCount()).toBe(1) // initial\n+\n     if (isNextDev) {\n-      const filePath = 'app/page.tsx'\n-      const origContent = await next.readFile(filePath)\n-      let getOutput = next.getCliOutputFromHere()\n       await next.patchFile(\n-        filePath,\n-        origContent.replace('hello world', 'hello hmr'),\n+        'app/page.tsx',\n+        (content) => content.replace('hello world', 'hello hmr'),\n         async () => {\n           await retry(async () => {\n             expect(await browser.elementByCss('p').text()).toBe('hello hmr')\n-            let tailwindProcessingCount = [\n-              ...getOutput().matchAll(\n-                /\\[@tailwindcss\\/postcss\\] app\\/globals.css/g\n-              ),\n-            ].length\n-            expect(tailwindProcessingCount).toBe(1)\n+            expect(getTailwindProcessingCount()).toBe(2) // dev: initial + hmr\n           })\n         }\n       )\n+      // Wait for the patchFile revert to get processed\n+      await retry(async () => {\n+        expect(await browser.elementByCss('p').text()).toBe('hello world')\n+      })\n     }\n-    let tailwindProcessingCount = [\n-      ...next.cliOutput.matchAll(/\\[@tailwindcss\\/postcss\\] app\\/globals.css/g),\n-    ].length\n+\n     if (isNextDev) {\n-      expect(tailwindProcessingCount).toBe(3) // dev: initial + hmr + hmr (revert)\n+      expect(getTailwindProcessingCount()).toBe(3) // dev: initial + hmr + hmr (revert)\n     } else {\n-      expect(tailwindProcessingCount).toBe(1) // build\n+      expect(getTailwindProcessingCount()).toBe(1) // build\n     }\n   })\n })"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 20,
        "deletions": 16
    }
}