{
    "author": "huozhi",
    "message": "[dev-overlay] do not attach hydration info to non hydration errors (#76349)",
    "sha": "922f0e927b3f65a30da25a6c3b55442ae4645e4e",
    "files": [
        {
            "sha": "7c3db1b9a032fb02a694f1136be1bae00947da3f",
            "filename": "packages/next/src/client/components/errors/attach-hydration-error-state.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/922f0e927b3f65a30da25a6c3b55442ae4645e4e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fattach-hydration-error-state.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/922f0e927b3f65a30da25a6c3b55442ae4645e4e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fattach-hydration-error-state.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fattach-hydration-error-state.ts?ref=922f0e927b3f65a30da25a6c3b55442ae4645e4e",
            "patch": "@@ -9,12 +9,18 @@ import {\n } from './hydration-error-info'\n \n export function attachHydrationErrorState(error: Error) {\n-  const reactHydrationDiffSegments = getReactHydrationDiffSegments(\n-    error.message\n-  )\n   let parsedHydrationErrorState: typeof hydrationErrorState = {}\n   const isHydrationWarning = testReactHydrationWarning(error.message)\n   const isHydrationRuntimeError = isHydrationError(error)\n+\n+  // If it's not hydration warnings or errors, skip\n+  if (!(isHydrationRuntimeError || isHydrationWarning)) {\n+    return\n+  }\n+\n+  const reactHydrationDiffSegments = getReactHydrationDiffSegments(\n+    error.message\n+  )\n   // If the reactHydrationDiffSegments exists\n   // and the diff (reactHydrationDiffSegments[1]) exists\n   // e.g. the hydration diff log error.\n@@ -72,5 +78,6 @@ export function attachHydrationErrorState(error: Error) {\n         hydrationErrorState.reactOutputComponentDiff\n     }\n   }\n+  // If it's a hydration error, store the hydration error state into the error object\n   ;(error as any).details = parsedHydrationErrorState\n }"
        },
        {
            "sha": "284039221219177e331c5c8f2c9582caf85108e2",
            "filename": "test/development/app-dir/hydration-error-count/app/hydration-with-runtime-errors/page.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/922f0e927b3f65a30da25a6c3b55442ae4645e4e/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fapp%2Fhydration-with-runtime-errors%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/922f0e927b3f65a30da25a6c3b55442ae4645e4e/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fapp%2Fhydration-with-runtime-errors%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fapp%2Fhydration-with-runtime-errors%2Fpage.tsx?ref=922f0e927b3f65a30da25a6c3b55442ae4645e4e",
            "patch": "@@ -0,0 +1,15 @@\n+'use client'\n+\n+import { useEffect } from 'react'\n+\n+export default function Page() {\n+  useEffect(() => {\n+    throw new Error('runtime error')\n+  }, [])\n+\n+  return (\n+    <p>\n+      sneaky <p>very sneaky</p>\n+    </p>\n+  )\n+}"
        },
        {
            "sha": "1a6729b6d18ef2fe8f6b1bbf7cc3fc12140d7f4e",
            "filename": "test/development/app-dir/hydration-error-count/hydration-error-count.test.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/922f0e927b3f65a30da25a6c3b55442ae4645e4e/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fhydration-error-count.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/922f0e927b3f65a30da25a6c3b55442ae4645e4e/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fhydration-error-count.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fhydration-error-count.test.ts?ref=922f0e927b3f65a30da25a6c3b55442ae4645e4e",
            "patch": "@@ -9,6 +9,7 @@ import {\n   goToNextErrorView,\n   getRedboxDescriptionWarning,\n   getHighlightedDiffLines,\n+  assertHasRedbox,\n } from 'next-test-utils'\n import { BrowserInterface } from 'next-webdriver'\n \n@@ -131,6 +132,47 @@ describe('hydration-error-count', () => {\n      }\n     `)\n   })\n+\n+  it('should display runtime error separately from hydration errors', async () => {\n+    const browser = await next.browser('/hydration-with-runtime-errors')\n+    await assertHasRedbox(browser)\n+    expect(await getToastErrorCount(browser)).toBe(3)\n+\n+    // Move to the last hydration error\n+    await goToNextErrorView(browser)\n+    expect(browser).toDisplayRedbox(`\n+     {\n+       \"count\": 3,\n+       \"description\": \"In HTML, <p> cannot be a descendant of <p>.\n+     This will cause a hydration error.\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Unhandled Runtime Error\",\n+       \"source\": \"app/hydration-with-runtime-errors/page.tsx (12:14) @ Page\n+     > 12 |       sneaky <p>very sneaky</p>\n+          |              ^\",\n+       \"stack\": [\n+         \"p <anonymous> (0:0)\",\n+         \"Page app/hydration-with-runtime-errors/page.tsx (12:14)\",\n+       ],\n+     }\n+    `)\n+\n+    await goToNextErrorView(browser)\n+    expect(browser).toDisplayRedbox(`\n+     {\n+       \"count\": 3,\n+       \"description\": \"Error: runtime error\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Unhandled Runtime Error\",\n+       \"source\": \"app/hydration-with-runtime-errors/page.tsx (7:11) @ Page.useEffect\n+     >  7 |     throw new Error('runtime error')\n+          |           ^\",\n+       \"stack\": [\n+         \"Page.useEffect app/hydration-with-runtime-errors/page.tsx (7:11)\",\n+       ],\n+     }\n+    `)\n+  })\n })\n \n async function getHydrationErrorSnapshot(browser: BrowserInterface) {"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 67,
        "deletions": 3
    }
}