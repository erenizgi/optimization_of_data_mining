{
    "author": "mischnic",
    "message": "Turbopack: remove `css_environment` from `Environment` (#83487)\n\nChange the fix from #83334 to not have a \"CSS environment\" inside of every environment. I don't think that this makes sense, and it also makes the implementation more complicated.\n```diff\n  pub struct Environment {\n    execution: ExecutionEnvironment,\n+   css_environment: ResolvedVc<BrowserEnvironment>,\n  }\n```\n\nInstead, we can just pass the client's `Environment` when we create the server's transform rules, to use the client's browserslist config for styled-jsx.\n\n#83334 was also missing a test case\n\nI recommend the review each commits individually.",
    "sha": "bdb12360376a6996d84cac06b7c3a2671232973a",
    "files": [
        {
            "sha": "e5314b76d9703f84ff3f153ffe80082feecc373b",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -218,6 +218,7 @@ impl AppProject {\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n             self.project().server_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n \n@@ -232,6 +233,7 @@ impl AppProject {\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n             self.project().edge_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n \n@@ -246,6 +248,7 @@ impl AppProject {\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n             self.project().server_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n \n@@ -260,6 +263,7 @@ impl AppProject {\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n             self.project().edge_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n \n@@ -582,6 +586,7 @@ impl AppProject {\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n             self.project().server_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n \n@@ -596,6 +601,7 @@ impl AppProject {\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n             self.project().edge_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n "
        },
        {
            "sha": "42b74b54b7569f047889de7d381aaef312897865",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -460,6 +460,7 @@ impl PagesProject {\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n             self.project().server_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n \n@@ -476,6 +477,7 @@ impl PagesProject {\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n             self.project().edge_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n \n@@ -492,6 +494,7 @@ impl PagesProject {\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n             self.project().server_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n \n@@ -508,6 +511,7 @@ impl PagesProject {\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n             self.project().edge_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n \n@@ -524,6 +528,7 @@ impl PagesProject {\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n             self.project().server_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n \n@@ -542,6 +547,7 @@ impl PagesProject {\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n             self.project().edge_compile_time_info().environment(),\n+            self.project().client_compile_time_info().environment(),\n         ))\n     }\n "
        },
        {
            "sha": "b9ab3910beb216506707f897d47ab6df0dca24be",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -984,7 +984,6 @@ impl Project {\n             format!(\"/ROOT/{}\", self.project_path().await?.path).into(),\n             this.define_env.nodejs(),\n             self.current_node_js_version(),\n-            this.browserslist_query.clone(),\n         ))\n     }\n \n@@ -995,7 +994,6 @@ impl Project {\n             self.project_path().owned().await?,\n             this.define_env.edge(),\n             self.current_node_js_version(),\n-            this.browserslist_query.clone(),\n         ))\n     }\n \n@@ -1296,6 +1294,7 @@ impl Project {\n                 NextRuntime::Edge,\n                 self.encryption_key(),\n                 self.edge_compile_time_info().environment(),\n+                self.client_compile_time_info().environment(),\n             ),\n             get_edge_resolve_options_context(\n                 self.project_path().owned().await?,\n@@ -1358,6 +1357,7 @@ impl Project {\n                 NextRuntime::NodeJs,\n                 self.encryption_key(),\n                 self.server_compile_time_info().environment(),\n+                self.client_compile_time_info().environment(),\n             ),\n             get_server_resolve_options_context(\n                 self.project_path().owned().await?,\n@@ -1472,6 +1472,7 @@ impl Project {\n                 NextRuntime::NodeJs,\n                 self.encryption_key(),\n                 self.server_compile_time_info().environment(),\n+                self.client_compile_time_info().environment(),\n             ),\n             get_server_resolve_options_context(\n                 self.project_path().owned().await?,\n@@ -1534,6 +1535,7 @@ impl Project {\n                 NextRuntime::Edge,\n                 self.encryption_key(),\n                 self.edge_compile_time_info().environment(),\n+                self.client_compile_time_info().environment(),\n             ),\n             get_edge_resolve_options_context(\n                 self.project_path().owned().await?,"
        },
        {
            "sha": "794a296656a7f3af36c6c5244a461f5a792117c0",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -98,18 +98,18 @@ pub async fn get_client_compile_time_info(\n     browserslist_query: RcStr,\n     define_env: Vc<OptionEnvMap>,\n ) -> Result<Vc<CompileTimeInfo>> {\n-    let environment = BrowserEnvironment {\n-        dom: true,\n-        web_worker: false,\n-        service_worker: false,\n-        browserslist_query: browserslist_query.to_owned(),\n-    }\n-    .resolved_cell();\n-\n     CompileTimeInfo::builder(\n-        Environment::new(ExecutionEnvironment::Browser(environment), *environment)\n-            .to_resolved()\n-            .await?,\n+        Environment::new(ExecutionEnvironment::Browser(\n+            BrowserEnvironment {\n+                dom: true,\n+                web_worker: false,\n+                service_worker: false,\n+                browserslist_query: browserslist_query.to_owned(),\n+            }\n+            .resolved_cell(),\n+        ))\n+        .to_resolved()\n+        .await?,\n     )\n     .defines(next_client_defines(define_env).to_resolved().await?)\n     .free_var_references(next_client_free_vars(define_env).to_resolved().await?)\n@@ -274,7 +274,7 @@ pub async fn get_client_module_options_context(\n     let tree_shaking_mode_for_foreign_code = *next_config\n         .tree_shaking_mode_for_foreign_code(next_mode.is_development())\n         .await?;\n-    let css_target_browsers = env.css_runtime_versions();\n+    let target_browsers = env.runtime_versions();\n \n     let mut next_client_rules =\n         get_next_client_transforms_rules(next_config, ty.clone(), mode, false, encryption_key)\n@@ -287,7 +287,7 @@ pub async fn get_client_module_options_context(\n         get_relay_transform_rule(next_config, project_path.clone()).await?,\n         get_emotion_transform_rule(next_config).await?,\n         get_styled_components_transform_rule(next_config).await?,\n-        get_styled_jsx_transform_rule(next_config, css_target_browsers).await?,\n+        get_styled_jsx_transform_rule(next_config, target_browsers).await?,\n         get_react_remove_properties_transform_rule(next_config).await?,\n         get_remove_console_transform_rule(next_config).await?,\n     ]"
        },
        {
            "sha": "a5c788e836c972b17aa6bf314ba1a515cc986f58",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 18,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -11,9 +11,7 @@ use turbopack_core::{\n         module_id_strategies::ModuleIdStrategy,\n     },\n     compile_time_info::{CompileTimeDefines, CompileTimeInfo, FreeVarReference, FreeVarReferences},\n-    environment::{\n-        BrowserEnvironment, EdgeWorkerEnvironment, Environment, ExecutionEnvironment, NodeJsVersion,\n-    },\n+    environment::{EdgeWorkerEnvironment, Environment, ExecutionEnvironment, NodeJsVersion},\n     free_var_references,\n     module_graph::export_usage::OptionExportUsageInfo,\n };\n@@ -62,23 +60,11 @@ pub async fn get_edge_compile_time_info(\n     project_path: FileSystemPath,\n     define_env: Vc<OptionEnvMap>,\n     node_version: ResolvedVc<NodeJsVersion>,\n-    css_browserslist_query: RcStr,\n ) -> Result<Vc<CompileTimeInfo>> {\n-    let css_environment = BrowserEnvironment {\n-        dom: false,\n-        web_worker: false,\n-        service_worker: false,\n-        browserslist_query: css_browserslist_query,\n-    }\n-    .resolved_cell();\n-\n     CompileTimeInfo::builder(\n-        Environment::new(\n-            ExecutionEnvironment::EdgeWorker(\n-                EdgeWorkerEnvironment { node_version }.resolved_cell(),\n-            ),\n-            *css_environment,\n-        )\n+        Environment::new(ExecutionEnvironment::EdgeWorker(\n+            EdgeWorkerEnvironment { node_version }.resolved_cell(),\n+        ))\n         .to_resolved()\n         .await?,\n     )"
        },
        {
            "sha": "383b2022e4015b1e0cbfea55326636001e3f78ae",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 29,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -21,9 +21,7 @@ use turbopack_core::{\n     },\n     compile_time_defines,\n     compile_time_info::{CompileTimeDefines, CompileTimeInfo, FreeVarReferences},\n-    environment::{\n-        BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion,\n-    },\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion},\n     free_var_references,\n     module_graph::export_usage::OptionExportUsageInfo,\n     target::CompileTarget,\n@@ -371,28 +369,16 @@ pub async fn get_server_compile_time_info(\n     cwd: RcStr,\n     define_env: Vc<OptionEnvMap>,\n     node_version: ResolvedVc<NodeJsVersion>,\n-    css_browserslist_query: RcStr,\n ) -> Result<Vc<CompileTimeInfo>> {\n-    let css_environment = BrowserEnvironment {\n-        dom: false,\n-        web_worker: false,\n-        service_worker: false,\n-        browserslist_query: css_browserslist_query,\n-    }\n-    .resolved_cell();\n-\n     CompileTimeInfo::builder(\n-        Environment::new(\n-            ExecutionEnvironment::NodeJsLambda(\n-                NodeJsEnvironment {\n-                    compile_target: CompileTarget::current().to_resolved().await?,\n-                    node_version,\n-                    cwd: ResolvedVc::cell(Some(cwd)),\n-                }\n-                .resolved_cell(),\n-            ),\n-            *css_environment,\n-        )\n+        Environment::new(ExecutionEnvironment::NodeJsLambda(\n+            NodeJsEnvironment {\n+                compile_target: CompileTarget::current().to_resolved().await?,\n+                node_version,\n+                cwd: ResolvedVc::cell(Some(cwd)),\n+            }\n+            .resolved_cell(),\n+        ))\n         .to_resolved()\n         .await?,\n     )\n@@ -405,10 +391,9 @@ pub async fn get_server_compile_time_info(\n #[turbo_tasks::function]\n pub async fn get_tracing_compile_time_info() -> Result<Vc<CompileTimeInfo>> {\n     CompileTimeInfo::builder(\n-        Environment::new(\n-            ExecutionEnvironment::NodeJsLambda(NodeJsEnvironment::default().resolved_cell()),\n-            BrowserEnvironment::default().cell(),\n-        )\n+        Environment::new(ExecutionEnvironment::NodeJsLambda(\n+            NodeJsEnvironment::default().resolved_cell(),\n+        ))\n         .to_resolved()\n         .await?,\n     )\n@@ -456,6 +441,7 @@ pub async fn get_server_module_options_context(\n     next_runtime: NextRuntime,\n     encryption_key: ResolvedVc<RcStr>,\n     environment: ResolvedVc<Environment>,\n+    client_environment: ResolvedVc<Environment>,\n ) -> Result<Vc<ModuleOptionsContext>> {\n     let next_mode = mode.await?;\n     let mut next_server_rules = get_next_server_transforms_rules(\n@@ -525,7 +511,6 @@ pub async fn get_server_module_options_context(\n     let tree_shaking_mode_for_foreign_code = *next_config\n         .tree_shaking_mode_for_foreign_code(next_mode.is_development())\n         .await?;\n-    let css_versions = environment.css_runtime_versions();\n \n     let tsconfig_path = next_config\n         .typescript_tsconfig_path()\n@@ -586,8 +571,10 @@ pub async fn get_server_module_options_context(\n     // context type.\n     let styled_components_transform_rule =\n         get_styled_components_transform_rule(next_config).await?;\n+    // It's important the client's browserlist config is used for styled-jsx, otherwise we transpile\n+    // the CSS to be compatible with Node.js 20.\n     let styled_jsx_transform_rule =\n-        get_styled_jsx_transform_rule(next_config, css_versions).await?;\n+        get_styled_jsx_transform_rule(next_config, client_environment.runtime_versions()).await?;\n \n     let source_maps = if *next_config.server_source_maps().await? {\n         SourceMapsType::Full"
        },
        {
            "sha": "4a6a8f7e6d1aa7af407829659ecb7158e4d2fcc5",
            "filename": "test/integration/css-fixtures/compilation-and-prefixing/pages/index.js",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/test%2Fintegration%2Fcss-fixtures%2Fcompilation-and-prefixing%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/test%2Fintegration%2Fcss-fixtures%2Fcompilation-and-prefixing%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-fixtures%2Fcompilation-and-prefixing%2Fpages%2Findex.js?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -1,3 +1,27 @@\n export default function Home() {\n-  return <div className=\"red-text\">This text should be red.</div>\n+  return (\n+    <>\n+      <div className=\"red-text\">This text should be red.</div>\n+      <StyledJsxTest />\n+    </>\n+  )\n+}\n+\n+function StyledJsxTest() {\n+  return (\n+    <>\n+      <div className=\"media-query-test\">This text should be blue.</div>\n+      <style jsx>{`\n+        .media-query-test {\n+          color: blue;\n+        }\n+\n+        @media (max-width: 400px) {\n+          .media-query-test {\n+            color: orange;\n+          }\n+        }\n+      `}</style>\n+    </>\n+  )\n }"
        },
        {
            "sha": "32521c8ba65a0668ded93e0a4fc2ae7ca9ce7084",
            "filename": "test/integration/css/test/css-compilation.test.js",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.js?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -219,6 +219,32 @@ module.exports = {\n                   }\n                 `)\n               }\n+\n+              const inlineStyle = $('style')\n+              expect(inlineStyle.length).toBe(1)\n+              const inlineCssContent = inlineStyle\n+                .html()\n+                .replace(\n+                  /media-query-test.jsx-[a-f0-9]{16}/g,\n+                  'media-query-test.jsx-HASH'\n+                )\n+              if (process.env.IS_TURBOPACK_TEST && useLightningcss) {\n+                expect(inlineCssContent).toMatchInlineSnapshot(\n+                  `\".media-query-test.jsx-HASH{color:#00f}@media (max-width:400px){.media-query-test.jsx-HASH{color:orange}}\"`\n+                )\n+              } else if (process.env.IS_TURBOPACK_TEST && !useLightningcss) {\n+                expect(inlineCssContent).toMatchInlineSnapshot(\n+                  `\".media-query-test.jsx-HASH{color:#00f}@media (max-width:400px){.media-query-test.jsx-HASH{color:orange}}\"`\n+                )\n+              } else if (useLightningcss) {\n+                expect(inlineCssContent).toMatchInlineSnapshot(\n+                  `\".media-query-test.jsx-HASH{color:blue}@media(max-width:400px){.media-query-test.jsx-HASH{color:orange}}\"`\n+                )\n+              } else {\n+                expect(inlineCssContent).toMatchInlineSnapshot(\n+                  `\".media-query-test.jsx-HASH{color:blue}@media(max-width:400px){.media-query-test.jsx-HASH{color:orange}}\"`\n+                )\n+              }\n             })\n           }\n         )"
        },
        {
            "sha": "bd98caa78a134de94a3e09a5f9102f4b3ebe2601",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 24,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -237,12 +237,9 @@ async fn build_internal(\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n-                Environment::new(\n-                    ExecutionEnvironment::NodeJsLambda(\n-                        NodeJsEnvironment::default().resolved_cell(),\n-                    ),\n-                    compile_time_info.css_environment(),\n-                )\n+                Environment::new(ExecutionEnvironment::NodeJsLambda(\n+                    NodeJsEnvironment::default().resolved_cell(),\n+                ))\n                 .to_resolved()\n                 .await?,\n                 runtime_type,\n@@ -324,25 +321,22 @@ async fn build_internal(\n \n     let chunking_context: Vc<Box<dyn ChunkingContext>> = match target {\n         Target::Browser => {\n-            let browser_environment = BrowserEnvironment {\n-                dom: true,\n-                web_worker: false,\n-                service_worker: false,\n-                browserslist_query: browserslist_query.clone(),\n-            }\n-            .resolved_cell();\n-\n             let mut builder = BrowserChunkingContext::builder(\n                 project_path,\n                 build_output_root.clone(),\n                 build_output_root_to_root_path,\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n-                Environment::new(\n-                    ExecutionEnvironment::Browser(browser_environment),\n-                    *browser_environment,\n-                )\n+                Environment::new(ExecutionEnvironment::Browser(\n+                    BrowserEnvironment {\n+                        dom: true,\n+                        web_worker: false,\n+                        service_worker: false,\n+                        browserslist_query: browserslist_query.clone(),\n+                    }\n+                    .resolved_cell(),\n+                ))\n                 .to_resolved()\n                 .await?,\n                 runtime_type,\n@@ -388,12 +382,9 @@ async fn build_internal(\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n                 build_output_root.clone(),\n-                Environment::new(\n-                    ExecutionEnvironment::NodeJsLambda(\n-                        NodeJsEnvironment::default().resolved_cell(),\n-                    ),\n-                    BrowserEnvironment::default().cell(),\n-                )\n+                Environment::new(ExecutionEnvironment::NodeJsLambda(\n+                    NodeJsEnvironment::default().resolved_cell(),\n+                ))\n                 .to_resolved()\n                 .await?,\n                 runtime_type,"
        },
        {
            "sha": "a00803a23ac109be3e0eff7584b4607ce50b191f",
            "filename": "turbopack/crates/turbopack-cli/src/contexts.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 12,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -199,19 +199,18 @@ pub async fn get_client_compile_time_info(\n     node_env: Vc<NodeEnv>,\n ) -> Result<Vc<CompileTimeInfo>> {\n     let node_env = node_env.await?;\n-\n-    let environment = BrowserEnvironment {\n-        dom: true,\n-        web_worker: false,\n-        service_worker: false,\n-        browserslist_query,\n-    }\n-    .resolved_cell();\n-\n     CompileTimeInfo::builder(\n-        Environment::new(ExecutionEnvironment::Browser(environment), *environment)\n-            .to_resolved()\n-            .await?,\n+        Environment::new(ExecutionEnvironment::Browser(\n+            BrowserEnvironment {\n+                dom: true,\n+                web_worker: false,\n+                service_worker: false,\n+                browserslist_query,\n+            }\n+            .resolved_cell(),\n+        ))\n+        .to_resolved()\n+        .await?,\n     )\n     .defines(client_defines(&node_env).resolved_cell())\n     .free_var_references("
        },
        {
            "sha": "0737a64b681def8cb314f2b8fd93be8fee8364f5",
            "filename": "turbopack/crates/turbopack-core/src/compile_time_info.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -4,7 +4,7 @@ use turbo_rcstr::RcStr;\n use turbo_tasks::{FxIndexMap, NonLocalValue, ResolvedVc, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n \n-use crate::environment::{BrowserEnvironment, Environment};\n+use crate::environment::Environment;\n \n #[macro_export]\n macro_rules! definable_name_map_pattern_internal {\n@@ -349,11 +349,6 @@ impl CompileTimeInfo {\n     pub fn environment(&self) -> Vc<Environment> {\n         *self.environment\n     }\n-\n-    #[turbo_tasks::function]\n-    pub async fn css_environment(&self) -> Result<Vc<BrowserEnvironment>> {\n-        Ok(self.environment.css_environment())\n-    }\n }\n \n pub struct CompileTimeInfoBuilder {"
        },
        {
            "sha": "05c3229d70e8d4c53c599cf2dee3f17f3879c9c2",
            "filename": "turbopack/crates/turbopack-core/src/environment.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 21,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -42,20 +42,13 @@ pub enum ChunkLoading {\n pub struct Environment {\n     // members must be private to avoid leaking non-custom types\n     execution: ExecutionEnvironment,\n-    css_environment: ResolvedVc<BrowserEnvironment>,\n }\n \n #[turbo_tasks::value_impl]\n impl Environment {\n     #[turbo_tasks::function]\n-    pub async fn new(\n-        execution: ExecutionEnvironment,\n-        css_environment: ResolvedVc<BrowserEnvironment>,\n-    ) -> Vc<Self> {\n-        Self::cell(Environment {\n-            execution,\n-            css_environment,\n-        })\n+    pub fn new(execution: ExecutionEnvironment) -> Vc<Self> {\n+        Self::cell(Environment { execution })\n     }\n }\n \n@@ -107,17 +100,6 @@ impl Environment {\n         })\n     }\n \n-    #[turbo_tasks::function]\n-    pub fn css_environment(&self) -> Vc<BrowserEnvironment> {\n-        *self.css_environment\n-    }\n-\n-    #[turbo_tasks::function]\n-    pub async fn css_runtime_versions(&self) -> Result<Vc<RuntimeVersions>> {\n-        let distribs = resolve_browserslist(self.css_environment).await?;\n-        Ok(Vc::cell(Versions::parse_versions(distribs)?))\n-    }\n-\n     #[turbo_tasks::function]\n     pub async fn browserslist_query(&self) -> Result<Vc<RcStr>> {\n         Ok(match self.execution {\n@@ -335,7 +317,6 @@ impl Default for NodeJsVersion {\n }\n \n #[turbo_tasks::value(shared)]\n-#[derive(Default)]\n pub struct BrowserEnvironment {\n     pub dom: bool,\n     pub web_worker: bool,"
        },
        {
            "sha": "403adc71fa56bbfcc73220b2a2f63957e7db7a55",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/analyzer.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 16,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -14,9 +14,7 @@ use turbo_tasks::ResolvedVc;\n use turbo_tasks_testing::VcStorage;\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n-    environment::{\n-        BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion,\n-    },\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion},\n     target::CompileTarget,\n };\n use turbopack_ecmascript::analyzer::{\n@@ -102,20 +100,15 @@ fn bench_link(b: &mut Bencher, input: &BenchInput) {\n         let var_cache = Default::default();\n         for val in input.var_graph.values.values() {\n             VcStorage::with(async {\n-                let css_environment = BrowserEnvironment::default().cell();\n-\n                 let compile_time_info = CompileTimeInfo::builder(\n-                    Environment::new(\n-                        ExecutionEnvironment::NodeJsLambda(\n-                            NodeJsEnvironment {\n-                                compile_target: CompileTarget::unknown().to_resolved().await?,\n-                                node_version: NodeJsVersion::default().resolved_cell(),\n-                                cwd: ResolvedVc::cell(None),\n-                            }\n-                            .resolved_cell(),\n-                        ),\n-                        css_environment,\n-                    )\n+                    Environment::new(ExecutionEnvironment::NodeJsLambda(\n+                        NodeJsEnvironment {\n+                            compile_target: CompileTarget::unknown().to_resolved().await?,\n+                            node_version: NodeJsVersion::default().resolved_cell(),\n+                            cwd: ResolvedVc::cell(None),\n+                        }\n+                        .resolved_cell(),\n+                    ))\n                     .to_resolved()\n                     .await?,\n                 )"
        },
        {
            "sha": "fb62272b46ac338b025b45c98d9cc921cfc5bd9b",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/references.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -9,7 +9,7 @@ use turbo_tasks_backend::{\n use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n-    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n };\n@@ -38,10 +38,9 @@ pub fn benchmark(c: &mut Criterion) {\n             let root_dir = PathBuf::from(env!(\"CARGO_MANIFEST_DIR\")).join(\"tests/benches/\");\n             let fs = DiskFileSystem::new(rcstr!(\"project\"), root_dir.to_str().unwrap().into());\n \n-            let environment = Environment::new(\n-                ExecutionEnvironment::NodeJsLambda(NodeJsEnvironment::default().resolved_cell()),\n-                BrowserEnvironment::default().cell(),\n-            );\n+            let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n+                NodeJsEnvironment::default().resolved_cell(),\n+            ));\n             let compile_time_info = CompileTimeInfo::new(environment).to_resolved().await?;\n             let layer = Layer::new(rcstr!(\"test\"));\n             let module_asset_context = NoopAssetContext {"
        },
        {
            "sha": "996db83b6e737b504bcffe4a2b7178ce847c137e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/mod.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 20,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -3777,9 +3777,7 @@ mod tests {\n     use turbo_tasks::{ResolvedVc, util::FormatDuration};\n     use turbopack_core::{\n         compile_time_info::CompileTimeInfo,\n-        environment::{\n-            BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion,\n-        },\n+        environment::{Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion},\n         target::{Arch, CompileTarget, Endianness, Libc, Platform},\n     };\n \n@@ -4178,26 +4176,21 @@ mod tests {\n         var_cache: &Mutex<FxHashMap<Id, JsValue>>,\n     ) -> (JsValue, u32) {\n         turbo_tasks_testing::VcStorage::with(async {\n-            let css_environment = BrowserEnvironment::default().resolved_cell();\n-\n             let compile_time_info = CompileTimeInfo::builder(\n-                Environment::new(\n-                    ExecutionEnvironment::NodeJsLambda(\n-                        NodeJsEnvironment {\n-                            compile_target: CompileTarget {\n-                                arch: Arch::X64,\n-                                platform: Platform::Linux,\n-                                endianness: Endianness::Little,\n-                                libc: Libc::Glibc,\n-                            }\n-                            .resolved_cell(),\n-                            node_version: NodeJsVersion::default().resolved_cell(),\n-                            cwd: ResolvedVc::cell(None),\n+                Environment::new(ExecutionEnvironment::NodeJsLambda(\n+                    NodeJsEnvironment {\n+                        compile_target: CompileTarget {\n+                            arch: Arch::X64,\n+                            platform: Platform::Linux,\n+                            endianness: Endianness::Little,\n+                            libc: Libc::Glibc,\n                         }\n                         .resolved_cell(),\n-                    ),\n-                    *css_environment,\n-                )\n+                        node_version: NodeJsVersion::default().resolved_cell(),\n+                        cwd: ResolvedVc::cell(None),\n+                    }\n+                    .resolved_cell(),\n+                ))\n                 .to_resolved()\n                 .await?,\n             )"
        },
        {
            "sha": "85debaa3ac68a6fb14954fa3434325f80848fca3",
            "filename": "turbopack/crates/turbopack-nft/src/nft.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -12,7 +12,7 @@ use turbopack_cli_utils::issue::{ConsoleUi, LogOptions};\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     context::AssetContext,\n-    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     issue::{IssueReporter, IssueSeverity, handle_issues},\n@@ -69,10 +69,9 @@ async fn node_file_trace_operation(\n     let input = input_dir.join(&format!(\"{input}\"))?;\n \n     let source = FileSource::new(input);\n-    let environment = Environment::new(\n-        ExecutionEnvironment::NodeJsLambda(NodeJsEnvironment::default().resolved_cell()),\n-        BrowserEnvironment::default().cell(),\n-    );\n+    let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n+        NodeJsEnvironment::default().resolved_cell(),\n+    ));\n     let module_asset_context = ModuleAssetContext::new(\n         Default::default(),\n         // This config should be kept in sync with"
        },
        {
            "sha": "65f3cb7857acc6e977edc7f77584a96818cab70c",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -36,7 +36,7 @@ use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     condition::ContextCondition,\n     context::AssetContext,\n-    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     issue::IssueDescriptionExt,\n@@ -337,10 +337,9 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n         .get_relative_path_to(project_root)\n         .context(\"Project path is in root path\")?;\n \n-    let env = Environment::new(\n-        ExecutionEnvironment::NodeJsBuildTime(NodeJsEnvironment::default().resolved_cell()),\n-        BrowserEnvironment::default().cell(),\n-    )\n+    let env = Environment::new(ExecutionEnvironment::NodeJsBuildTime(\n+        NodeJsEnvironment::default().resolved_cell(),\n+    ))\n     .to_resolved()\n     .await?;\n "
        },
        {
            "sha": "e04a7acd74c79423251d2202a663fb748098b2a4",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 17,
            "deletions": 22,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -257,33 +257,28 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n \n     let entry_asset = project_path.join(&options.entry)?;\n \n-    let env = match options.environment {\n+    let env = Environment::new(match options.environment {\n         SnapshotEnvironment::Browser => {\n-            let environment=// TODO: load more from options.json\n-            BrowserEnvironment {\n-                dom: true,\n-                web_worker: false,\n-                service_worker: false,\n-                browserslist_query: options.browserslist.into(),\n-            }\n-            .resolved_cell();\n-\n-            Environment::new(ExecutionEnvironment::Browser(environment), *environment)\n-                .to_resolved()\n-                .await?\n+            ExecutionEnvironment::Browser(\n+                // TODO: load more from options.json\n+                BrowserEnvironment {\n+                    dom: true,\n+                    web_worker: false,\n+                    service_worker: false,\n+                    browserslist_query: options.browserslist.into(),\n+                }\n+                .resolved_cell(),\n+            )\n         }\n         SnapshotEnvironment::NodeJs => {\n-            Environment::new(\n-                ExecutionEnvironment::NodeJsBuildTime(\n-                    // TODO: load more from options.json\n-                    NodeJsEnvironment::default().resolved_cell(),\n-                ),\n-                BrowserEnvironment::default().cell(),\n+            ExecutionEnvironment::NodeJsBuildTime(\n+                // TODO: load more from options.json\n+                NodeJsEnvironment::default().resolved_cell(),\n             )\n-            .to_resolved()\n-            .await?\n         }\n-    };\n+    })\n+    .to_resolved()\n+    .await?;\n \n     let mut defines = compile_time_defines!(\n         process.turbopack = true,"
        },
        {
            "sha": "de94a62ef548f916859dff049f5615d0f7966711",
            "filename": "turbopack/crates/turbopack-tracing/benches/node_file_trace.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-tracing%2Fbenches%2Fnode_file_trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-tracing%2Fbenches%2Fnode_file_trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Fbenches%2Fnode_file_trace.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -13,7 +13,7 @@ use turbopack::{\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     context::AssetContext,\n-    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     rebase::RebasedAsset,\n@@ -85,12 +85,9 @@ fn bench_emit(b: &mut Bencher, bench_input: &BenchInput) {\n \n                 let source = FileSource::new(input);\n                 let compile_time_info = CompileTimeInfo::builder(\n-                    Environment::new(\n-                        ExecutionEnvironment::NodeJsLambda(\n-                            NodeJsEnvironment::default().resolved_cell(),\n-                        ),\n-                        BrowserEnvironment::default().cell(),\n-                    )\n+                    Environment::new(ExecutionEnvironment::NodeJsLambda(\n+                        NodeJsEnvironment::default().resolved_cell(),\n+                    ))\n                     .to_resolved()\n                     .await?,\n                 )"
        },
        {
            "sha": "9fdb55f6cafdea5b908e0541b37cb492f5c41b56",
            "filename": "turbopack/crates/turbopack-tracing/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -39,7 +39,7 @@ use turbopack::{\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     context::AssetContext,\n-    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     output::OutputAsset,\n@@ -345,10 +345,9 @@ async fn node_file_trace_operation(\n     let output_dir = output_fs.root().owned().await?;\n \n     let source = FileSource::new(input);\n-    let environment = Environment::new(\n-        ExecutionEnvironment::NodeJsLambda(NodeJsEnvironment::default().resolved_cell()),\n-        BrowserEnvironment::default().cell(),\n-    );\n+    let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n+        NodeJsEnvironment::default().resolved_cell(),\n+    ));\n     let module_asset_context = ModuleAssetContext::new(\n         Default::default(),\n         // TODO These test cases should move into the `node-file-trace` crate and use the same"
        },
        {
            "sha": "3451873eba906b25d9cc6f36685fc7aab6c05623",
            "filename": "turbopack/crates/turbopack-tracing/tests/unit.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -21,7 +21,7 @@ use turbopack_core::{\n     chunk::ChunkingType,\n     compile_time_info::CompileTimeInfo,\n     context::AssetContext,\n-    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     module::Module,\n@@ -183,10 +183,9 @@ async fn node_file_trace_operation(package_root: RcStr, input: RcStr) -> Result<\n     let input = input_dir.join(&input)?;\n \n     let source = FileSource::new(input);\n-    let environment = Environment::new(\n-        ExecutionEnvironment::NodeJsLambda(NodeJsEnvironment::default().resolved_cell()),\n-        BrowserEnvironment::default().cell(),\n-    );\n+    let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n+        NodeJsEnvironment::default().resolved_cell(),\n+    ));\n     let module_asset_context = ModuleAssetContext::new(\n         Default::default(),\n         // TODO These test cases should move into the `node-file-trace` crate and use the same"
        },
        {
            "sha": "271c9225acc349c4ed53be2de41ff9bc2a3ffa81",
            "filename": "turbopack/crates/turbopack/examples/turbopack.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack%2Fexamples%2Fturbopack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack%2Fexamples%2Fturbopack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fexamples%2Fturbopack.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -17,7 +17,7 @@ use turbopack_core::{\n     PROJECT_FILESYSTEM_NAME,\n     compile_time_info::CompileTimeInfo,\n     context::AssetContext,\n-    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n     file_source::FileSource,\n     ident::Layer,\n     rebase::RebasedAsset,\n@@ -47,12 +47,9 @@ async fn main() -> Result<()> {\n             let source = FileSource::new(entry);\n             let module_asset_context = turbopack::ModuleAssetContext::new(\n                 Default::default(),\n-                CompileTimeInfo::new(Environment::new(\n-                    ExecutionEnvironment::NodeJsLambda(\n-                        NodeJsEnvironment::default().resolved_cell(),\n-                    ),\n-                    BrowserEnvironment::default().cell(),\n-                )),\n+                CompileTimeInfo::new(Environment::new(ExecutionEnvironment::NodeJsLambda(\n+                    NodeJsEnvironment::default().resolved_cell(),\n+                ))),\n                 Default::default(),\n                 ResolveOptionsContext {\n                     enable_typescript: true,"
        },
        {
            "sha": "912fb733b1e84c29561b4e3e8fe92d9927f04f86",
            "filename": "turbopack/crates/turbopack/src/evaluate_context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fevaluate_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdb12360376a6996d84cac06b7c3a2671232973a/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fevaluate_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fevaluate_context.rs?ref=bdb12360376a6996d84cac06b7c3a2671232973a",
            "patch": "@@ -8,7 +8,7 @@ use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     condition::ContextCondition,\n     context::AssetContext,\n-    environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n     ident::Layer,\n     resolve::options::{ImportMap, ImportMapping},\n };\n@@ -24,10 +24,9 @@ use crate::{\n \n #[turbo_tasks::function]\n pub fn node_build_environment() -> Vc<Environment> {\n-    Environment::new(\n-        ExecutionEnvironment::NodeJsBuildTime(NodeJsEnvironment::default().resolved_cell()),\n-        BrowserEnvironment::default().cell(),\n-    )\n+    Environment::new(ExecutionEnvironment::NodeJsBuildTime(\n+        NodeJsEnvironment::default().resolved_cell(),\n+    ))\n }\n \n #[turbo_tasks::function]"
        }
    ],
    "stats": {
        "total": 428,
        "additions": 200,
        "deletions": 228
    }
}