{
    "author": "gaojude",
    "message": "[MCP] Fix: Do not dedup by URL for MCP get_page_metadata (#84564)\n\nThe `get_page_metadata` MCP tool was incorrectly grouping browser\nsessions by URL instead of counting each session individually. When\nmultiple browser tabs were open to the same URL, the tool would report\nonly 1 session instead of the actual number of sessions.",
    "sha": "a29b4fa5c3f02c5a8f5a14050a1cdd7736a8bb30",
    "files": [
        {
            "sha": "41fa09fe1c80c5b18e68f1d0b3cc31237d4fff09",
            "filename": "packages/next/src/server/mcp/tools/get-page-metadata.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/a29b4fa5c3f02c5a8f5a14050a1cdd7736a8bb30/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-page-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a29b4fa5c3f02c5a8f5a14050a1cdd7736a8bb30/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-page-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-page-metadata.ts?ref=a29b4fa5c3f02c5a8f5a14050a1cdd7736a8bb30",
            "patch": "@@ -59,16 +59,17 @@ export function registerGetPageMetadataTool(\n           }\n         }\n \n-        const metadataByUrl = new Map<string, PageMetadata>()\n+        const sessionMetadata: Array<{ url: string; metadata: PageMetadata }> =\n+          []\n         for (const response of responses) {\n           if (response.data) {\n             // TODO: Add other metadata for the current page render here. Currently, we only have segment trie data.\n             const pageMetadata = convertSegmentTrieToPageMetadata(response.data)\n-            metadataByUrl.set(response.url, pageMetadata)\n+            sessionMetadata.push({ url: response.url, metadata: pageMetadata })\n           }\n         }\n \n-        if (metadataByUrl.size === 0) {\n+        if (sessionMetadata.length === 0) {\n           return {\n             content: [\n               {\n@@ -79,7 +80,7 @@ export function registerGetPageMetadataTool(\n           }\n         }\n \n-        const output = formatPageMetadata(metadataByUrl)\n+        const output = formatPageMetadata(sessionMetadata)\n \n         return {\n           content: [\n@@ -145,10 +146,12 @@ function convertSegmentTrieToPageMetadata(data: SegmentTrieData): PageMetadata {\n   }\n }\n \n-function formatPageMetadata(metadataByUrl: Map<string, PageMetadata>): string {\n-  let output = `# Page metadata from ${metadataByUrl.size} browser session(s)\\n\\n`\n+function formatPageMetadata(\n+  sessionMetadata: Array<{ url: string; metadata: PageMetadata }>\n+): string {\n+  let output = `# Page metadata from ${sessionMetadata.length} browser session(s)\\n\\n`\n \n-  for (const [url, metadata] of metadataByUrl) {\n+  for (const { url, metadata } of sessionMetadata) {\n     let displayUrl = url\n     try {\n       const urlObj = new URL(url)"
        },
        {
            "sha": "63725ecaf4340f81f2cc20cbf9d9eaead5dfde22",
            "filename": "test/development/mcp-server/mcp-server-get-page-metadata.test.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/a29b4fa5c3f02c5a8f5a14050a1cdd7736a8bb30/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-page-metadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a29b4fa5c3f02c5a8f5a14050a1cdd7736a8bb30/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-page-metadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-page-metadata.test.ts?ref=a29b4fa5c3f02c5a8f5a14050a1cdd7736a8bb30",
            "patch": "@@ -180,6 +180,33 @@ describe('mcp-server get_page_metadata tool', () => {\n         await session2.close()\n       }\n     })\n+\n+    it('should count multiple browser tabs with the same URL separately', async () => {\n+      await new Promise((resolve) => setTimeout(resolve, 500))\n+\n+      const session1 = await launchStandaloneSession(next.url, '/')\n+      const session2 = await launchStandaloneSession(next.url, '/')\n+\n+      try {\n+        await new Promise((resolve) => setTimeout(resolve, 1000))\n+\n+        let metadata: string = ''\n+        await retry(async () => {\n+          const sessionId = 'test-same-url-' + Date.now()\n+          metadata = await callGetPageMetadata(next.url, sessionId)\n+          const rootSessions = (metadata.match(/## Session: \\/(?!\\w)/g) || [])\n+            .length\n+          expect(rootSessions).toBeGreaterThanOrEqual(2)\n+        })\n+\n+        const rootSessions = (metadata.match(/## Session: \\/(?!\\w)/g) || [])\n+          .length\n+        expect(rootSessions).toBeGreaterThanOrEqual(2)\n+      } finally {\n+        await session1.close()\n+        await session2.close()\n+      }\n+    })\n   })\n \n   describe('pages router', () => {"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 37,
        "deletions": 7
    }
}