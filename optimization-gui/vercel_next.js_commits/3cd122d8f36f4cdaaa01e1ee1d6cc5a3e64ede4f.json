{
    "author": "unstubbable",
    "message": "Scope `runInCleanSnapshot` to Work Store (#78930)",
    "sha": "3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
    "files": [
        {
            "sha": "2ab01fe8b8ee467c963f4520872975d243d20a90",
            "filename": ".vscode/settings.json",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/.vscode%2Fsettings.json",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/.vscode%2Fsettings.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.vscode%2Fsettings.json?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -59,7 +59,6 @@\n     // singleton modules should always use \"*.external\" instead of \"*-instance\"\n     \"packages/next/src/server/app-render/action-async-storage-instance.ts\",\n     \"packages/next/src/server/app-render/after-task-async-storage-instance.ts\",\n-    \"packages/next/src/server/app-render/clean-async-snapshot-instance.ts\",\n     \"packages/next/src/server/app-render/work-async-storage-instance.ts\",\n     \"packages/next/src/server/app-render/work-unit-async-storage-instance.ts\",\n     \"packages/next/src/client/components/segment-cache-impl/*\""
        },
        {
            "sha": "4ddbdfc067b0774a41323199c5cef3979d5aaf6c",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -178,7 +178,6 @@ import { CacheSignal } from './cache-signal'\n import { getTracedMetadata } from '../lib/trace/utils'\n import { InvariantError } from '../../shared/lib/invariant-error'\n \n-import './clean-async-snapshot.external'\n import { INFINITE_CACHE } from '../../lib/constants'\n import { createComponentStylesAndScripts } from './create-component-styles-and-scripts'\n import { parseLoaderTree } from './parse-loader-tree'"
        },
        {
            "sha": "c37bc4227a84a4b13d8ec68f8f5605a7c8dd48a1",
            "filename": "packages/next/src/server/app-render/clean-async-snapshot-instance.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4452ca2bce11befc3096cb6eba33c8e845dc32fd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fclean-async-snapshot-instance.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4452ca2bce11befc3096cb6eba33c8e845dc32fd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fclean-async-snapshot-instance.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fclean-async-snapshot-instance.ts?ref=4452ca2bce11befc3096cb6eba33c8e845dc32fd",
            "patch": "@@ -1,6 +0,0 @@\n-import { createSnapshot } from '../app-render/async-local-storage'\n-\n-export const runInCleanSnapshot: <R, TArgs extends any[]>(\n-  fn: (...args: TArgs) => R,\n-  ...args: TArgs\n-) => R = createSnapshot()"
        },
        {
            "sha": "44aa9ff8f0361aa9ad405a1cc95896880858fb58",
            "filename": "packages/next/src/server/app-render/clean-async-snapshot.external.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/4452ca2bce11befc3096cb6eba33c8e845dc32fd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fclean-async-snapshot.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4452ca2bce11befc3096cb6eba33c8e845dc32fd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fclean-async-snapshot.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fclean-async-snapshot.external.ts?ref=4452ca2bce11befc3096cb6eba33c8e845dc32fd",
            "patch": "@@ -1,4 +0,0 @@\n-// Share the instance module in the next-shared layer\n-import { runInCleanSnapshot } from './clean-async-snapshot-instance' with { 'turbopack-transition': 'next-shared' }\n-\n-export { runInCleanSnapshot }"
        },
        {
            "sha": "5335c999f5c77c7a0ee9fb0300aa4cee8e3d1239",
            "filename": "packages/next/src/server/app-render/work-async-storage.external.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -98,6 +98,18 @@ export interface WorkStore {\n \n   dynamicIOEnabled: boolean\n   dev: boolean\n+\n+  /**\n+   * Run the given function inside a clean AsyncLocalStorage snapshot. This is\n+   * useful when generating cache entries, to ensure that the cache generation\n+   * cannot read anything from the context we're currently executing in, which\n+   * might include request-specific things like `cookies()` inside a\n+   * `React.cache()`.\n+   */\n+  runInCleanSnapshot: <R, TArgs extends any[]>(\n+    fn: (...args: TArgs) => R,\n+    ...args: TArgs\n+  ) => R\n }\n \n export type WorkAsyncStorage = AsyncLocalStorage<WorkStore>"
        },
        {
            "sha": "01173d7095e24c014e3a519678017f0045b72090",
            "filename": "packages/next/src/server/async-storage/work-store.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -12,6 +12,7 @@ import { AfterContext } from '../after/after-context'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { createLazyResult, type LazyResult } from '../lib/lazy-result'\n import { getCacheHandlerEntries } from '../use-cache/handlers'\n+import { createSnapshot } from '../app-render/async-local-storage'\n \n export type WorkStoreContext = {\n   /**\n@@ -138,6 +139,7 @@ export function createWorkStore({\n     dev: renderOpts.dev ?? false,\n     previouslyRevalidatedTags,\n     refreshTagsByCacheKind: createRefreshTagsByCacheKind(),\n+    runInCleanSnapshot: createSnapshot(),\n   }\n \n   // TODO: remove this when we resolve accessing the store outside the execution context"
        },
        {
            "sha": "9738f5078e753f22f2bb0748dc72dcf8cdcb6a30",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -27,7 +27,6 @@ import {\n   workUnitAsyncStorage,\n   getDraftModeProviderForCacheScope,\n } from '../app-render/work-unit-async-storage.external'\n-import { runInCleanSnapshot } from '../app-render/clean-async-snapshot.external'\n \n import { makeHangingPromise } from '../dynamic-rendering-utils'\n \n@@ -83,7 +82,7 @@ function generateCacheEntry(\n   // might include request specific things like cookies() inside a React.cache().\n   // Note: It is important that we await at least once before this because it lets us\n   // pop out of any stack specific contexts as well - aka \"Sync\" Local Storage.\n-  return runInCleanSnapshot(\n+  return workStore.runInCleanSnapshot(\n     generateCacheEntryWithRestoredWorkStore,\n     workStore,\n     outerWorkUnitStore,"
        },
        {
            "sha": "d99c7f6d35b31643b83cb4b2a4bc9e778d7e39f4",
            "filename": "test/production/custom-server/als.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fals.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fals.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fals.js?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -0,0 +1,3 @@\n+const { AsyncLocalStorage } = require('async_hooks')\n+\n+exports.requestIdStorage = new AsyncLocalStorage()"
        },
        {
            "sha": "cefdb25dc748a9247b546679db0f1827f8f82052",
            "filename": "test/production/custom-server/app/use-cache/page.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fapp%2Fuse-cache%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fapp%2Fuse-cache%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fapp%2Fuse-cache%2Fpage.js?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -0,0 +1,19 @@\n+import { connection } from 'next/server'\n+\n+async function Inner({ id }) {\n+  'use cache'\n+\n+  return <p>inner cache</p>\n+}\n+\n+async function Outer({ id }) {\n+  'use cache'\n+\n+  return <Inner id=\"inner\" />\n+}\n+\n+export default async function Page() {\n+  await connection()\n+\n+  return <Outer id=\"outer\" />\n+}"
        },
        {
            "sha": "e8711977ecf05a5f234c85c9cbf6d55c4cf0c179",
            "filename": "test/production/custom-server/cache-handler.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fcache-handler.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fcache-handler.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fcache-handler.js?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -0,0 +1,35 @@\n+// @ts-check\n+\n+const { requestIdStorage } = require('./als')\n+\n+const defaultCacheHandler =\n+  require('next/dist/server/lib/cache-handlers/default').default\n+\n+/**\n+ * @type {import('next/dist/server/lib/cache-handlers/types').CacheHandlerV2}\n+ */\n+const cacheHandler = {\n+  async get(cacheKey) {\n+    return defaultCacheHandler.get(cacheKey)\n+  },\n+\n+  async set(cacheKey, pendingEntry) {\n+    const requestId = requestIdStorage.getStore()\n+    console.log('set cache', cacheKey, 'requestId:', requestId)\n+    return defaultCacheHandler.set(cacheKey, pendingEntry)\n+  },\n+\n+  async refreshTags() {\n+    return defaultCacheHandler.refreshTags()\n+  },\n+\n+  async getExpiration(...tags) {\n+    return defaultCacheHandler.getExpiration(...tags)\n+  },\n+\n+  async expireTags(...tags) {\n+    return defaultCacheHandler.expireTags(...tags)\n+  },\n+}\n+\n+module.exports = cacheHandler"
        },
        {
            "sha": "a200ca0c5ba6e064d7a95c448197fcb25d1e9159",
            "filename": "test/production/custom-server/custom-server.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fcustom-server.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fcustom-server.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fcustom-server.test.ts?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -36,6 +36,17 @@ describe('custom server', () => {\n         expect($('body').text()).toMatch(/pages: 19\\.\\d+\\.\\d+/)\n       }\n     })\n+\n+    describe('when using \"use cache\" with a custom cache handler', () => {\n+      it(\"should not unset the custom server's ALS context\", async () => {\n+        const cliOutputLength = next.cliOutput.length\n+        const $ = await next.render$('/use-cache')\n+        expect($('p').text()).toBe('inner cache')\n+        const cliOutput = next.cliOutput.slice(cliOutputLength)\n+        expect(cliOutput).toMatch(createCacheSetLogRegExp('outer'))\n+        expect(cliOutput).toMatch(createCacheSetLogRegExp('inner'))\n+      })\n+    })\n   })\n })\n \n@@ -55,3 +66,11 @@ describe('custom server with quiet setting', () => {\n     expect(next.cliOutput).not.toInclude('Server side error')\n   })\n })\n+\n+function createCacheSetLogRegExp(id: string) {\n+  // Expect a requestId, that's provided through ALS, to be present in the log\n+  // message for the cache handler set call.\n+  return new RegExp(\n+    `set cache \\\\[\"[A-Za-z0-9_-]{21}\",\"(?:[0-9a-f]{2})+\",\\\\[{\"id\":\"${id}\"},\"\\\\$undefined\"\\\\]\\\\] requestId: \\\\d+`\n+  )\n+}"
        },
        {
            "sha": "691865906e35812361d4d683ba431343107e2942",
            "filename": "test/production/custom-server/next.config.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fnext.config.js?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -0,0 +1,13 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    useCache: true,\n+    cacheHandlers: {\n+      default: require.resolve('./cache-handler.js'),\n+    },\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "e82f053fc000ae4d0a01baf4e0a72d2d213d0610",
            "filename": "test/production/custom-server/server.js",
            "status": "modified",
            "additions": 25,
            "deletions": 20,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fserver.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f/test%2Fproduction%2Fcustom-server%2Fserver.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fserver.js?ref=3cd122d8f36f4cdaaa01e1ee1d6cc5a3e64ede4f",
            "patch": "@@ -2,8 +2,11 @@ const { createServer } = require('http')\n const { parse } = require('url')\n const next = require('next')\n const getPort = require('get-port')\n+const { requestIdStorage } = require('./als')\n const quiet = process.env.USE_QUIET === 'true'\n \n+let requestId = 0\n+\n async function main() {\n   const port = await getPort()\n   const hostname = 'localhost'\n@@ -12,28 +15,30 @@ async function main() {\n   const handle = app.getRequestHandler()\n \n   app.prepare().then(() => {\n-    createServer(async (req, res) => {\n-      try {\n-        // Be sure to pass `true` as the second argument to `url.parse`.\n-        // This tells it to parse the query portion of the URL.\n-        const parsedUrl = parse(req.url, true)\n-        const { pathname, query } = parsedUrl\n+    createServer((req, res) =>\n+      requestIdStorage.run(requestId++, async () => {\n+        try {\n+          // Be sure to pass `true` as the second argument to `url.parse`.\n+          // This tells it to parse the query portion of the URL.\n+          const parsedUrl = parse(req.url, true)\n+          const { pathname, query } = parsedUrl\n \n-        if (pathname === '/a') {\n-          await app.render(req, res, '/a', query)\n-        } else if (pathname === '/b') {\n-          await app.render(req, res, '/page-b', query)\n-        } else if (pathname === '/error') {\n-          await app.render(req, res, '/page-error')\n-        } else {\n-          await handle(req, res, parsedUrl)\n+          if (pathname === '/a') {\n+            await app.render(req, res, '/a', query)\n+          } else if (pathname === '/b') {\n+            await app.render(req, res, '/page-b', query)\n+          } else if (pathname === '/error') {\n+            await app.render(req, res, '/page-error')\n+          } else {\n+            await handle(req, res, parsedUrl)\n+          }\n+        } catch (err) {\n+          console.error('Error occurred handling', req.url, err)\n+          res.statusCode = 500\n+          res.end('Internal Server Error')\n         }\n-      } catch (err) {\n-        console.error('Error occurred handling', req.url, err)\n-        res.statusCode = 500\n-        res.end('Internal Server Error')\n-      }\n-    }).listen(port, undefined, (err) => {\n+      })\n+    ).listen(port, undefined, (err) => {\n       if (err) throw err\n       // Start mode\n       console.log(`- Local: http://${hostname}:${port}`)"
        }
    ],
    "stats": {
        "total": 163,
        "additions": 129,
        "deletions": 34
    }
}