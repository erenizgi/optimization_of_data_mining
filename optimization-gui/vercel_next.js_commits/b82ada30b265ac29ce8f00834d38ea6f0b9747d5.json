{
    "author": "gaojude",
    "message": "guarantee cache busting param correctness (#80381)\n\n[RSC validation](https://github.com/vercel/next.js/pull/80157) requires\n`_rsc` search param to match the RSC\n[hash](https://github.com/vercel/next.js/blob/06-10-remove_existing_cache_busting_param_and_add_fresh_one/packages/next/src/shared/lib/router/utils/cache-busting-search-param.ts#L3)\nof request headers.\n\n\nTo guarantee any request initiated from Next.js meets the criteria, we\nare going to remove existing cache busting param and add fresh one\n**just in case the pre-existing param does not match the hash**.\n\nExisting E2E tests should cover this change.\n\n---------\n\nCo-authored-by: graphite-app[bot] <96075541+graphite-app[bot]@users.noreply.github.com>",
    "sha": "b82ada30b265ac29ce8f00834d38ea6f0b9747d5",
    "files": [
        {
            "sha": "a7db3f204af41c40854e2195e1a0b80e1b5afc9a",
            "filename": "packages/next/src/client/components/router-reducer/set-cache-busting-search-param.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/b82ada30b265ac29ce8f00834d38ea6f0b9747d5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fset-cache-busting-search-param.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b82ada30b265ac29ce8f00834d38ea6f0b9747d5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fset-cache-busting-search-param.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fset-cache-busting-search-param.ts?ref=b82ada30b265ac29ce8f00834d38ea6f0b9747d5",
            "patch": "@@ -57,7 +57,13 @@ export const setCacheBustingSearchParam = (\n   const rawQuery = existingSearch.startsWith('?')\n     ? existingSearch.slice(1)\n     : existingSearch\n-  const pairs = rawQuery.split('&').filter(Boolean)\n+\n+  // Always remove any existing cache busting param and add a fresh one to ensure\n+  // we have the correct value based on current request headers\n+  const pairs = rawQuery\n+    .split('&')\n+    .filter((pair) => pair && !pair.startsWith(`${NEXT_RSC_UNION_QUERY}=`))\n+\n   pairs.push(`${NEXT_RSC_UNION_QUERY}=${uniqueCacheKey}`)\n   url.search = pairs.length ? `?${pairs.join('&')}` : ''\n }"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 7,
        "deletions": 1
    }
}