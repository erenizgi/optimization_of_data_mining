{
    "author": "mischnic",
    "message": "Turbopack: don't define `process.cwd()` in node_modules (#83452)\n\nDon't compile-time-define `process.cwd()` inside of node_modules.\n\nThis means that node_modules cannot break outside of their individual packages anymore, so in the worst case, a given package includes all of itself, but not anymore the whole project.\n\nThis means that a `readFileSync(path.join(process.cwd(), \"something.txt\")))` won't cause that file to be listed in the NFT file anymore.",
    "sha": "da54d10487a1bbedd73ecfb85ee97de3f9082f40",
    "files": [
        {
            "sha": "0facb2f8c269ddfb2edd99e8263b568745136593",
            "filename": "test/production/standalone-mode/node-modules/app/layout.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Flayout.js?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Root({ children }) {\n+  return (\n+    <html>\n+      <head></head>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "fc2a5559872f928261d2a407b84c72845b348ce2",
            "filename": "test/production/standalone-mode/node-modules/app/page.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fpage.js?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -0,0 +1,10 @@\n+import path from 'path'\n+\n+import 'foo'\n+\n+const projectDir = process.cwd()\n+path.join(projectDir, 'app', 'static-from-app.txt')\n+\n+export default function Page() {\n+  return 'hello'\n+}"
        },
        {
            "sha": "ce013625030ba8dba906f756967f9e9ca394464a",
            "filename": "test/production/standalone-mode/node-modules/app/static-from-app.txt",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fstatic-from-app.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fstatic-from-app.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fstatic-from-app.txt?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -0,0 +1 @@\n+hello"
        },
        {
            "sha": "ce013625030ba8dba906f756967f9e9ca394464a",
            "filename": "test/production/standalone-mode/node-modules/app/static-from-pkg.txt",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fstatic-from-pkg.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fstatic-from-pkg.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fstatic-from-pkg.txt?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -0,0 +1 @@\n+hello"
        },
        {
            "sha": "a76d4f0fddfe9e11f6d819cf1be379d40da6f398",
            "filename": "test/production/standalone-mode/node-modules/foo/index.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Ffoo%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Ffoo%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Ffoo%2Findex.js?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -0,0 +1,6 @@\n+import path from 'path'\n+\n+const projectDir = process.cwd()\n+path.join(projectDir, 'app', 'static-from-pkg.txt')\n+\n+export default 'foo'"
        },
        {
            "sha": "1aea491022211e28c1c4dd68868236fd015138a3",
            "filename": "test/production/standalone-mode/node-modules/foo/package.json",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Ffoo%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Ffoo%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Ffoo%2Fpackage.json?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -0,0 +1,4 @@\n+{\n+  \"name\": \"foo\",\n+  \"version\": \"0.0.0\"\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/production/standalone-mode/node-modules/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fnext.config.js?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "a6badcb1852e0cf46c00a043d23e567e47a7bbc0",
            "filename": "test/production/standalone-mode/node-modules/node-modules.test.ts",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fnode-modules.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fnode-modules.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fnode-modules.test.ts?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -0,0 +1,22 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('standalone mode - NFT in node_modules', () => {\n+  const dependencies = require('./package.json').dependencies\n+\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    dependencies,\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should not trace process.cwd calls in node_modules', async () => {\n+    let trace = await next.readJSON('.next/server/app/page.js.nft.json')\n+\n+    expect(trace.files).toContain('../../../app/static-from-app.txt')\n+    expect(trace.files).not.toContain('../../../app/static-from-pkg.txt')\n+  })\n+})"
        },
        {
            "sha": "2511e3bc7558fc3f72727730a56cdf486f449e66",
            "filename": "test/production/standalone-mode/node-modules/package.json",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fpackage.json?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -0,0 +1,5 @@\n+{\n+  \"dependencies\": {\n+    \"foo\": \"file:./foo\"\n+  }\n+}"
        },
        {
            "sha": "ca85b9059a8ab7df8d58e55f6f5f24cf13df1309",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -3747,7 +3747,7 @@ pub mod test_utils {\n                 }\n             }\n             _ => {\n-                let (mut v, m1) = replace_well_known(v, compile_time_info).await?;\n+                let (mut v, m1) = replace_well_known(v, compile_time_info, true).await?;\n                 let m2 = replace_builtin(&mut v);\n                 let m = m1 || m2 || v.make_nested_operations_unknown();\n                 return Ok((v, m));"
        },
        {
            "sha": "06b3f0308378b8d47857db71ec907c4508bae0be",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/well_known.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -15,6 +15,7 @@ use crate::analyzer::RequireContextValue;\n pub async fn replace_well_known(\n     value: JsValue,\n     compile_time_info: Vc<CompileTimeInfo>,\n+    define_process_cwd: bool,\n ) -> Result<(JsValue, bool)> {\n     Ok(match value {\n         JsValue::Call(_, box JsValue::WellKnownFunction(kind), args) => (\n@@ -23,6 +24,7 @@ pub async fn replace_well_known(\n                 JsValue::unknown_empty(false, \"this is not analyzed yet\"),\n                 args,\n                 compile_time_info,\n+                define_process_cwd,\n             )\n             .await?,\n             true,\n@@ -67,6 +69,7 @@ pub async fn well_known_function_call(\n     _this: JsValue,\n     args: Vec<JsValue>,\n     compile_time_info: Vc<CompileTimeInfo>,\n+    define_process_cwd: bool,\n ) -> Result<JsValue> {\n     Ok(match kind {\n         WellKnownFunctionKind::ObjectAssign => object_assign(args),\n@@ -100,7 +103,8 @@ pub async fn well_known_function_call(\n             .as_str()\n             .into(),\n         WellKnownFunctionKind::ProcessCwd => {\n-            if let Some(cwd) = &*compile_time_info.environment().cwd().await? {\n+            if define_process_cwd && let Some(cwd) = &*compile_time_info.environment().cwd().await?\n+            {\n                 cwd.clone().into()\n             } else {\n                 JsValue::unknown("
        },
        {
            "sha": "a95df54c5fec5be0e2965573d5226823c8b23b7c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/da54d10487a1bbedd73ecfb85ee97de3f9082f40/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/da54d10487a1bbedd73ecfb85ee97de3f9082f40/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=da54d10487a1bbedd73ecfb85ee97de3f9082f40",
            "patch": "@@ -432,6 +432,7 @@ struct AnalysisState<'a> {\n     origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n     compile_time_info: ResolvedVc<CompileTimeInfo>,\n     var_graph: &'a VarGraph,\n+    define_process_cwd: bool,\n     /// This is the current state of known values of function\n     /// arguments.\n     fun_args_values: Mutex<FxHashMap<u32, Vec<JsValue>>>,\n@@ -461,6 +462,7 @@ impl AnalysisState<'_> {\n                     &self.free_var_references,\n                     self.var_graph,\n                     attributes,\n+                    self.define_process_cwd,\n                 )\n             },\n             &self.fun_args_values,\n@@ -1001,6 +1003,7 @@ pub async fn analyse_ecmascript_module_internal(\n             origin,\n             compile_time_info,\n             var_graph: &var_graph,\n+            define_process_cwd: !source.ident().path().await?.path.contains(\"/node_modules/\"),\n             fun_args_values: Default::default(),\n             var_cache: Default::default(),\n             first_import_meta: true,\n@@ -2927,6 +2930,7 @@ async fn value_visitor(\n     >,\n     var_graph: &VarGraph,\n     attributes: &ImportAttributes,\n+    define_process_cwd: bool,\n ) -> Result<(JsValue, bool)> {\n     let (mut v, modified) = value_visitor_inner(\n         origin,\n@@ -2935,6 +2939,7 @@ async fn value_visitor(\n         free_var_references,\n         var_graph,\n         attributes,\n+        define_process_cwd,\n     )\n     .await?;\n     v.normalize_shallow();\n@@ -2951,6 +2956,7 @@ async fn value_visitor_inner(\n     >,\n     var_graph: &VarGraph,\n     attributes: &ImportAttributes,\n+    define_process_cwd: bool,\n ) -> Result<(JsValue, bool)> {\n     let ImportAttributes { ignore, .. } = *attributes;\n     // This check is just an optimization\n@@ -3076,7 +3082,8 @@ async fn value_visitor_inner(\n             v.into_unknown(true, \"cross function analyzing is not yet supported\")\n         }\n         _ => {\n-            let (mut v, mut modified) = replace_well_known(v, compile_time_info).await?;\n+            let (mut v, mut modified) =\n+                replace_well_known(v, compile_time_info, define_process_cwd).await?;\n             modified = replace_builtin(&mut v) || modified;\n             modified = modified || v.make_nested_operations_unknown();\n             return Ok((v, modified));"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 77,
        "deletions": 3
    }
}