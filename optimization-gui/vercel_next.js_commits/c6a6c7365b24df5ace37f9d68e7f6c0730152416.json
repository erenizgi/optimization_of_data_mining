{
    "author": "mischnic",
    "message": "Turbopack: better errors for strip_prefix_len (#84882)\n\nTo help debugging",
    "sha": "c6a6c7365b24df5ace37f9d68e7f6c0730152416",
    "files": [
        {
            "sha": "4c73f9d13190d43917efb7360dfe7ea561d5e4af",
            "filename": "turbopack/crates/turbopack-core/src/resolve/alias_map.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a6c7365b24df5ace37f9d68e7f6c0730152416/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Falias_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a6c7365b24df5ace37f9d68e7f6c0730152416/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Falias_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Falias_map.rs?ref=c6a6c7365b24df5ace37f9d68e7f6c0730152416",
            "patch": "@@ -610,7 +610,9 @@ where\n \n                         if is_match {\n                             let mut remaining = self.request.clone();\n-                            remaining.strip_prefix_len(prefix.len());\n+                            if let Err(e) = remaining.strip_prefix_len(prefix.len()) {\n+                                return Some(Err(e.context(self.request.describe_as_string())));\n+                            }\n                             remaining.strip_suffix_len(suffix.len());\n \n                             let output = template.replace(&remaining);"
        },
        {
            "sha": "f5df097b570ed654b8535a758e911ea8235e9e19",
            "filename": "turbopack/crates/turbopack-core/src/resolve/pattern.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 15,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a6c7365b24df5ace37f9d68e7f6c0730152416/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a6c7365b24df5ace37f9d68e7f6c0730152416/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs?ref=c6a6c7365b24df5ace37f9d68e7f6c0730152416",
            "patch": "@@ -4,7 +4,7 @@ use std::{\n     sync::LazyLock,\n };\n \n-use anyhow::Result;\n+use anyhow::{Result, bail};\n use regex::Regex;\n use rustc_hash::{FxHashMap, FxHashSet};\n use serde::{Deserialize, Serialize};\n@@ -227,18 +227,18 @@ impl Pattern {\n         longest_common_suffix(&strings)\n     }\n \n-    pub fn strip_prefix(&self, prefix: &str) -> Option<Self> {\n+    pub fn strip_prefix(&self, prefix: &str) -> Result<Option<Self>> {\n         if self.must_match(prefix) {\n             let mut pat = self.clone();\n-            pat.strip_prefix_len(prefix.len());\n-            Some(pat)\n+            pat.strip_prefix_len(prefix.len())?;\n+            Ok(Some(pat))\n         } else {\n-            None\n+            Ok(None)\n         }\n     }\n \n-    pub fn strip_prefix_len(&mut self, len: usize) {\n-        fn strip_prefix_internal(pattern: &mut Pattern, chars_to_strip: &mut usize) {\n+    pub fn strip_prefix_len(&mut self, len: usize) -> Result<()> {\n+        fn strip_prefix_internal(pattern: &mut Pattern, chars_to_strip: &mut usize) -> Result<()> {\n             match pattern {\n                 Pattern::Constant(c) => {\n                     let c_len = c.len();\n@@ -252,38 +252,45 @@ impl Pattern {\n                 Pattern::Concatenation(list) => {\n                     for c in list {\n                         if *chars_to_strip > 0 {\n-                            strip_prefix_internal(c, chars_to_strip);\n+                            strip_prefix_internal(c, chars_to_strip)?;\n                         }\n                     }\n                 }\n                 Pattern::Alternatives(_) => {\n-                    panic!(\"for strip_prefix a Pattern must be normalized\");\n+                    bail!(\"strip_prefix pattern must be normalized\");\n                 }\n                 Pattern::Dynamic | Pattern::DynamicNoSlash => {\n-                    panic!(\"strip_prefix prefix is too long\");\n+                    bail!(\"strip_prefix prefix is too long\");\n                 }\n             }\n+            Ok(())\n         }\n \n         match &mut *self {\n             c @ Pattern::Constant(_) | c @ Pattern::Concatenation(_) => {\n                 let mut len_local = len;\n-                strip_prefix_internal(c, &mut len_local);\n+                strip_prefix_internal(c, &mut len_local)?;\n             }\n             Pattern::Alternatives(list) => {\n                 for c in list {\n                     let mut len_local = len;\n-                    strip_prefix_internal(c, &mut len_local);\n+                    strip_prefix_internal(c, &mut len_local)?;\n                 }\n             }\n             Pattern::Dynamic | Pattern::DynamicNoSlash => {\n                 if len > 0 {\n-                    panic!(\"strip_prefix prefix is too long\");\n+                    bail!(\n+                        \"strip_prefix prefix ({}) is too long: {}\",\n+                        len,\n+                        self.describe_as_string()\n+                    );\n                 }\n             }\n         };\n \n-        self.normalize()\n+        self.normalize();\n+\n+        Ok(())\n     }\n \n     pub fn strip_suffix_len(&mut self, len: usize) {\n@@ -2164,7 +2171,7 @@ mod tests {\n     #[test]\n     fn strip_prefix() {\n         fn strip(mut pat: Pattern, n: usize) -> Pattern {\n-            pat.strip_prefix_len(n);\n+            pat.strip_prefix_len(n).unwrap();\n             pat\n         }\n "
        },
        {
            "sha": "60220448653096a1314ac98588729da4aafd0d17",
            "filename": "turbopack/crates/turbopack-resolve/src/typescript.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c6a6c7365b24df5ace37f9d68e7f6c0730152416/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c6a6c7365b24df5ace37f9d68e7f6c0730152416/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs?ref=c6a6c7365b24df5ace37f9d68e7f6c0730152416",
            "patch": "@@ -426,7 +426,7 @@ pub async fn type_resolve(\n         fragment: _,\n     } = &*request.await?\n     {\n-        let mut m = if let Some(mut stripped) = m.strip_prefix(\"@\") {\n+        let mut m = if let Some(mut stripped) = m.strip_prefix(\"@\")? {\n             stripped.replace_constants(&|c| Some(Pattern::Constant(c.replace(\"/\", \"__\").into())));\n             stripped\n         } else {"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 26,
        "deletions": 17
    }
}