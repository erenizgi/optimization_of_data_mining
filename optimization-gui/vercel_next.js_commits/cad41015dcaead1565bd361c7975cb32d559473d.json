{
    "author": "bgw",
    "message": "Turbopack: Allow arrays to be used as values in `turbopack.rules` config (#83138)\n\nThis implements the last part of the syntax proposal in #82857.\n\nWe want to support this syntax:\n\n```javascript\nmodule.exports = {\n  turbopack: {\n    rules: {\n      // all matched rules apply, adding their loaders in order\n      '*.svg': [\n        // this optionally can be an array of objects (shown here), or just an object\n        {\n          // this condition is matched after the glob\n          condition: {\n            all: [\n              { not: 'foreign' }, // excludes `node_modules`\n              { path: /app\\/.*\\.svg/, content: /\\<svg[^\\>]*\\>/ },\n            ],\n          },\n          loaders: ['@svgr/webpack'],\n          as: '*.js',\n        },\n      ],\n    },\n  },\n}\n```\n\nPrior to this PR, the value of `'*.svg'` in the `turbopack.rules` object had to be a configuration object or an array of shorthand loader syntax. After this PR, it can be an array of \"full\" configuration objects.",
    "sha": "cad41015dcaead1565bd361c7975cb32d559473d",
    "files": [
        {
            "sha": "3de7c630086765b6ccd2e92bcc5d08250804f373",
            "filename": "crates/next-core/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/cad41015dcaead1565bd361c7975cb32d559473d/crates%2Fnext-core%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/cad41015dcaead1565bd361c7975cb32d559473d/crates%2Fnext-core%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2FCargo.toml?ref=cad41015dcaead1565bd361c7975cb32d559473d",
            "patch": "@@ -15,7 +15,7 @@ workspace = true\n anyhow = { workspace = true }\n async-trait = { workspace = true }\n base64 = \"0.21.0\"\n-either = { workspace = true }\n+either = { workspace = true, features = [\"serde\"] }\n once_cell = { workspace = true }\n qstring = { workspace = true }\n regex = { workspace = true }"
        },
        {
            "sha": "87b45cbe96f2a1efdb5655e0e0cea7480c50453d",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 92,
            "deletions": 68,
            "changes": 160,
            "blob_url": "https://github.com/vercel/next.js/blob/cad41015dcaead1565bd361c7975cb32d559473d/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/cad41015dcaead1565bd361c7975cb32d559473d/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=cad41015dcaead1565bd361c7975cb32d559473d",
            "patch": "@@ -1,6 +1,7 @@\n use std::{collections::BTreeSet, str::FromStr};\n \n use anyhow::{Context, Result, bail};\n+use either::Either;\n use rustc_hash::FxHashSet;\n use serde::{Deserialize, Deserializer, Serialize};\n use serde_json::Value as JsonValue;\n@@ -558,7 +559,7 @@ pub enum RemotePatternProtocol {\n pub struct TurbopackConfig {\n     /// This option has been replaced by `rules`.\n     pub loaders: Option<JsonValue>,\n-    pub rules: Option<FxIndexMap<RcStr, RuleConfigItemOrShortcut>>,\n+    pub rules: Option<FxIndexMap<RcStr, RuleConfigCollection>>,\n     #[turbo_tasks(trace_ignore)]\n     pub conditions: Option<FxIndexMap<RcStr, ConfigConditionItem>>,\n     pub resolve_alias: Option<FxIndexMap<RcStr, JsonValue>>,\n@@ -666,6 +667,16 @@ impl TryFrom<ConfigConditionItem> for ConditionItem {\n     }\n }\n \n+#[derive(\n+    Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n+)]\n+#[serde(rename_all = \"camelCase\", untagged)]\n+pub enum RuleConfigItem {\n+    Options(RuleConfigItemOptions),\n+    LegacyConditional(FxIndexMap<RcStr, RuleConfigItem>),\n+    LegacyBoolean(bool),\n+}\n+\n #[derive(\n     Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n )]\n@@ -678,23 +689,33 @@ pub struct RuleConfigItemOptions {\n     pub condition: Option<ConfigConditionItem>,\n }\n \n-#[derive(\n-    Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n-)]\n-#[serde(rename_all = \"camelCase\", untagged)]\n-pub enum RuleConfigItemOrShortcut {\n-    Loaders(Vec<LoaderItem>),\n-    Advanced(RuleConfigItem),\n+#[derive(Clone, Debug, PartialEq, Eq, Serialize, TraceRawVcs, NonLocalValue, OperationValue)]\n+#[serde(transparent)]\n+pub struct RuleConfigCollection(Vec<RuleConfigCollectionItem>);\n+\n+impl<'de> Deserialize<'de> for RuleConfigCollection {\n+    fn deserialize<D>(deserializer: D) -> Result<Self, D::Error>\n+    where\n+        D: Deserializer<'de>,\n+    {\n+        match either::serde_untagged::deserialize::<Vec<RuleConfigCollectionItem>, RuleConfigItem, D>(\n+            deserializer,\n+        )? {\n+            Either::Left(collection) => Ok(RuleConfigCollection(collection)),\n+            Either::Right(item) => Ok(RuleConfigCollection(vec![RuleConfigCollectionItem::Full(\n+                item,\n+            )])),\n+        }\n+    }\n }\n \n #[derive(\n     Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n )]\n-#[serde(rename_all = \"camelCase\", untagged)]\n-pub enum RuleConfigItem {\n-    Options(RuleConfigItemOptions),\n-    LegacyConditional(FxIndexMap<RcStr, RuleConfigItem>),\n-    LegacyBoolean(bool),\n+#[serde(untagged)]\n+pub enum RuleConfigCollectionItem {\n+    Shorthand(LoaderItem),\n+    Full(RuleConfigItem),\n }\n \n #[derive(\n@@ -1392,11 +1413,12 @@ impl NextConfig {\n             return Ok(Vc::cell(Vec::new()));\n         }\n         let mut rules = Vec::new();\n-        for (glob, rule) in turbo_rules.iter() {\n-            fn transform_loaders(loaders: &[LoaderItem]) -> ResolvedVc<WebpackLoaderItems> {\n+        for (glob, rule_collection) in turbo_rules.iter() {\n+            fn transform_loaders(\n+                loaders: &mut dyn Iterator<Item = &LoaderItem>,\n+            ) -> ResolvedVc<WebpackLoaderItems> {\n                 ResolvedVc::cell(\n                     loaders\n-                        .iter()\n                         .map(|item| match item {\n                             LoaderItem::LoaderName(name) => WebpackLoaderItem {\n                                 loader: name.clone(),\n@@ -1445,65 +1467,67 @@ impl NextConfig {\n                 }\n             }\n             let config_file_path = || project_path.join(&self.config_file_name);\n-            match rule {\n-                RuleConfigItemOrShortcut::Loaders(loaders) => {\n-                    rules.push((\n-                        glob.clone(),\n-                        LoaderRuleItem {\n-                            loaders: transform_loaders(loaders),\n-                            rename_as: None,\n-                            condition: None,\n-                        },\n-                    ));\n-                }\n-                RuleConfigItemOrShortcut::Advanced(rule) => {\n-                    if let FindRuleResult::Found(RuleConfigItemOptions {\n-                        loaders,\n-                        rename_as,\n-                        condition,\n-                    }) = find_rule(rule, &active_conditions)\n-                    {\n-                        // If the extension contains a wildcard, and the rename_as does not,\n-                        // emit an issue to prevent users from encountering duplicate module names.\n-                        if glob.contains(\"*\")\n-                            && let Some(rename_as) = rename_as.as_ref()\n-                            && !rename_as.contains(\"*\")\n+            for item in &rule_collection.0 {\n+                match item {\n+                    RuleConfigCollectionItem::Shorthand(loaders) => {\n+                        rules.push((\n+                            glob.clone(),\n+                            LoaderRuleItem {\n+                                loaders: transform_loaders(&mut [loaders].into_iter()),\n+                                rename_as: None,\n+                                condition: None,\n+                            },\n+                        ));\n+                    }\n+                    RuleConfigCollectionItem::Full(rule_config_item) => {\n+                        if let FindRuleResult::Found(RuleConfigItemOptions {\n+                            loaders,\n+                            rename_as,\n+                            condition,\n+                        }) = find_rule(rule_config_item, &active_conditions)\n                         {\n-                            InvalidLoaderRuleRenameAsIssue {\n-                                glob: glob.clone(),\n-                                config_file_path: config_file_path()?,\n-                                rename_as: rename_as.clone(),\n-                            }\n-                            .resolved_cell()\n-                            .emit();\n-                        }\n-\n-                        // convert from Next.js-specific condition type to internal Turbopack\n-                        // condition type\n-                        let condition = if let Some(condition) = condition {\n-                            if let Ok(cond) = ConditionItem::try_from(condition.clone()) {\n-                                Some(cond)\n-                            } else {\n-                                InvalidLoaderRuleConditionIssue {\n-                                    condition: condition.clone(),\n+                            // If the extension contains a wildcard, and the rename_as does not,\n+                            // emit an issue to prevent users from encountering duplicate module\n+                            // names.\n+                            if glob.contains(\"*\")\n+                                && let Some(rename_as) = rename_as.as_ref()\n+                                && !rename_as.contains(\"*\")\n+                            {\n+                                InvalidLoaderRuleRenameAsIssue {\n+                                    glob: glob.clone(),\n                                     config_file_path: config_file_path()?,\n+                                    rename_as: rename_as.clone(),\n                                 }\n                                 .resolved_cell()\n                                 .emit();\n-                                None\n                             }\n-                        } else {\n-                            None\n-                        };\n \n-                        rules.push((\n-                            glob.clone(),\n-                            LoaderRuleItem {\n-                                loaders: transform_loaders(loaders),\n-                                rename_as: rename_as.clone(),\n-                                condition,\n-                            },\n-                        ));\n+                            // convert from Next.js-specific condition type to internal Turbopack\n+                            // condition type\n+                            let condition = if let Some(condition) = condition {\n+                                if let Ok(cond) = ConditionItem::try_from(condition.clone()) {\n+                                    Some(cond)\n+                                } else {\n+                                    InvalidLoaderRuleConditionIssue {\n+                                        condition: condition.clone(),\n+                                        config_file_path: config_file_path()?,\n+                                    }\n+                                    .resolved_cell()\n+                                    .emit();\n+                                    None\n+                                }\n+                            } else {\n+                                None\n+                            };\n+                            rules.push((\n+                                glob.clone(),\n+                                LoaderRuleItem {\n+                                    loaders: transform_loaders(&mut loaders.iter()),\n+                                    rename_as: rename_as.clone(),\n+                                    condition,\n+                                },\n+                            ));\n+                        }\n                     }\n                 }\n             }"
        },
        {
            "sha": "0caf25f60247969f90a2af8686c3f849d9a7805a",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 18,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/cad41015dcaead1565bd361c7975cb32d559473d/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cad41015dcaead1565bd361c7975cb32d559473d/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=cad41015dcaead1565bd361c7975cb32d559473d",
            "patch": "@@ -14,9 +14,9 @@ import type {\n   TurbopackLoaderBuiltinCondition,\n   TurbopackLoaderItem,\n   TurbopackRuleCondition,\n+  TurbopackRuleConfigCollection,\n   TurbopackRuleConfigItem,\n   TurbopackRuleConfigItemOptions,\n-  TurbopackRuleConfigItemOrShortcut,\n } from '../../server/config-shared'\n import { isDeepStrictEqual } from 'util'\n import { type DefineEnvOptions, getDefineEnv } from '../define-env'\n@@ -1014,13 +1014,19 @@ function bindingToApi(\n \n   // Note: Returns an updated `turbopackRules` with serialized conditions. Does not mutate in-place.\n   function serializeTurbopackRules(\n-    turbopackRules: Record<string, TurbopackRuleConfigItemOrShortcut>\n+    turbopackRules: Record<string, TurbopackRuleConfigCollection>\n   ): Record<string, any> {\n     const serializedRules: Record<string, any> = {}\n     for (const [glob, rule] of Object.entries(turbopackRules)) {\n       if (Array.isArray(rule)) {\n-        checkLoaderItems(rule, glob)\n-        serializedRules[glob] = rule\n+        serializedRules[glob] = rule.map((item) => {\n+          if (typeof item !== 'string' && 'loaders' in item) {\n+            return serializeConfigItem(item, glob)\n+          } else {\n+            checkLoaderItem(item, glob)\n+            return item\n+          }\n+        })\n       } else {\n         serializedRules[glob] = serializeConfigItem(rule, glob)\n       }\n@@ -1036,7 +1042,9 @@ function bindingToApi(\n       let serializedRule: any = rule\n       if ('loaders' in rule) {\n         const narrowedRule = rule as TurbopackRuleConfigItemOptions\n-        checkLoaderItems(narrowedRule.loaders, glob)\n+        for (const item of narrowedRule.loaders) {\n+          checkLoaderItem(item, glob)\n+        }\n         if (narrowedRule.condition != null) {\n           serializedRule = {\n             ...rule,\n@@ -1056,19 +1064,15 @@ function bindingToApi(\n       return serializedRule\n     }\n \n-    function checkLoaderItems(\n-      loaderItems: TurbopackLoaderItem[],\n-      glob: string\n-    ) {\n-      for (const loaderItem of loaderItems) {\n-        if (\n-          typeof loaderItem !== 'string' &&\n-          !isDeepStrictEqual(loaderItem, JSON.parse(JSON.stringify(loaderItem)))\n-        ) {\n-          throw new Error(\n-            `loader ${loaderItem.loader} for match \"${glob}\" does not have serializable options. Ensure that options passed are plain JavaScript objects and values.`\n-          )\n-        }\n+    function checkLoaderItem(loaderItem: TurbopackLoaderItem, glob: string) {\n+      if (\n+        typeof loaderItem !== 'string' &&\n+        !isDeepStrictEqual(loaderItem, JSON.parse(JSON.stringify(loaderItem)))\n+      ) {\n+        throw new Error(\n+          `loader ${loaderItem.loader} for match \"${glob}\" does not have serializable options. ` +\n+            'Ensure that options passed are plain JavaScript objects and values.'\n+        )\n       }\n     }\n   }"
        },
        {
            "sha": "9352c6e6566e6dee9437181f7bae2024ae26ced0",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/cad41015dcaead1565bd361c7975cb32d559473d/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cad41015dcaead1565bd361c7975cb32d559473d/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=cad41015dcaead1565bd361c7975cb32d559473d",
            "patch": "@@ -12,7 +12,7 @@ import type {\n   TurbopackOptions,\n   TurbopackRuleConfigItem,\n   TurbopackRuleConfigItemOptions,\n-  TurbopackRuleConfigItemOrShortcut,\n+  TurbopackRuleConfigCollection,\n   TurbopackRuleCondition,\n   TurbopackLoaderBuiltinCondition,\n } from './config-shared'\n@@ -151,11 +151,14 @@ const zTurbopackRuleConfigItem: zod.ZodType<TurbopackRuleConfigItem> = z.union([\n   zTurbopackRuleConfigItemOptions,\n ])\n \n-const zTurbopackRuleConfigItemOrShortcut: zod.ZodType<TurbopackRuleConfigItemOrShortcut> =\n-  z.union([z.array(zTurbopackLoaderItem), zTurbopackRuleConfigItem])\n+const zTurbopackRuleConfigCollection: zod.ZodType<TurbopackRuleConfigCollection> =\n+  z.union([\n+    zTurbopackRuleConfigItem,\n+    z.array(z.union([zTurbopackLoaderItem, zTurbopackRuleConfigItemOptions])),\n+  ])\n \n const zTurbopackConfig: zod.ZodType<TurbopackOptions> = z.strictObject({\n-  rules: z.record(z.string(), zTurbopackRuleConfigItemOrShortcut).optional(),\n+  rules: z.record(z.string(), zTurbopackRuleConfigCollection).optional(),\n   conditions: z.record(z.string(), zTurbopackCondition).optional(),\n   resolveAlias: z\n     .record(\n@@ -177,7 +180,7 @@ const zTurbopackConfig: zod.ZodType<TurbopackOptions> = z.strictObject({\n const zDeprecatedExperimentalTurboConfig: zod.ZodType<DeprecatedExperimentalTurboOptions> =\n   z.strictObject({\n     loaders: z.record(z.string(), z.array(zTurbopackLoaderItem)).optional(),\n-    rules: z.record(z.string(), zTurbopackRuleConfigItemOrShortcut).optional(),\n+    rules: z.record(z.string(), zTurbopackRuleConfigCollection).optional(),\n     resolveAlias: z\n       .record(\n         z.string(),"
        },
        {
            "sha": "c018edb0155763c57cfb64a0c30c71f9fdbc47dd",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/cad41015dcaead1565bd361c7975cb32d559473d/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cad41015dcaead1565bd361c7975cb32d559473d/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=cad41015dcaead1565bd361c7975cb32d559473d",
            "patch": "@@ -289,9 +289,18 @@ export type TurbopackRuleConfigItem =\n   | { [condition in TurbopackLoaderBuiltinCondition]?: TurbopackRuleConfigItem }\n   | false\n \n-export type TurbopackRuleConfigItemOrShortcut =\n-  | TurbopackLoaderItem[]\n+/**\n+ * This can be an object representing a single configuration, or a list of\n+ * loaders and/or rule configuration objects.\n+ *\n+ * - A list of loader path strings or objects is the \"shorthand\" syntax.\n+ * - A list of rule configuration objects can be useful when each configuration\n+ *   object has different `condition` fields, but still match the same top-level\n+ *   path glob.\n+ */\n+export type TurbopackRuleConfigCollection =\n   | TurbopackRuleConfigItem\n+  | (TurbopackLoaderItem | TurbopackRuleConfigItemOptions)[]\n \n export interface TurbopackOptions {\n   /**\n@@ -316,7 +325,7 @@ export interface TurbopackOptions {\n    *\n    * @see [Turbopack Loaders](https://nextjs.org/docs/app/api-reference/next-config-js/turbo#webpack-loaders)\n    */\n-  rules?: Record<string, TurbopackRuleConfigItemOrShortcut>\n+  rules?: Record<string, TurbopackRuleConfigCollection>\n \n   /**\n    * (`next --turbopack` only) A list of conditions to apply when running webpack loaders with Turbopack."
        },
        {
            "sha": "6d9bd1fcf5c34c9bf5674ec8f4c3e3a0ba919e5a",
            "filename": "test/e2e/turbopack-loader-config/next.config.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 41,
            "changes": 84,
            "blob_url": "https://github.com/vercel/next.js/blob/cad41015dcaead1565bd361c7975cb32d559473d/test%2Fe2e%2Fturbopack-loader-config%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cad41015dcaead1565bd361c7975cb32d559473d/test%2Fe2e%2Fturbopack-loader-config%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fturbopack-loader-config%2Fnext.config.ts?ref=cad41015dcaead1565bd361c7975cb32d559473d",
            "patch": "@@ -7,56 +7,58 @@ export default {\n         // use the shorthand syntax\n         loaders: ['./webpack-loader-replace-with-stub.cjs'],\n       },\n-      // this condition should not match\n-      'bar.js': {\n-        condition: 'foreign',\n-        loaders: [\n-          {\n-            loader: './webpack-loader-replace-with-stub.cjs',\n-            options: { returnValue: 'foreign' },\n-          },\n-        ],\n-      },\n-      // this condition should not match\n-      '{bar}.js': {\n-        condition: {\n-          not: { content: /export/ },\n+      'bar.js': [\n+        // this condition should not match\n+        {\n+          condition: 'foreign',\n+          loaders: [\n+            {\n+              loader: './webpack-loader-replace-with-stub.cjs',\n+              options: { returnValue: 'foreign' },\n+            },\n+          ],\n         },\n-        loaders: [\n-          {\n-            loader: './webpack-loader-replace-with-stub.cjs',\n-            options: { returnValue: 'missing export' },\n+        // this condition should not match\n+        {\n+          condition: {\n+            not: { content: /export/ },\n           },\n-        ],\n-      },\n-      // this should match on dev\n-      '{bar.js}': {\n-        condition: {\n-          any: [\n+          loaders: [\n             {\n-              all: ['development', { not: { not: { content: /export/ } } }],\n+              loader: './webpack-loader-replace-with-stub.cjs',\n+              options: { returnValue: 'missing export' },\n             },\n           ],\n         },\n-        loaders: [\n-          {\n-            loader: './webpack-loader-replace-with-stub.cjs',\n-            options: { returnValue: 'has export substring on dev' },\n+        // this should match on dev\n+        {\n+          condition: {\n+            any: [\n+              {\n+                all: ['development', { not: { not: { content: /export/ } } }],\n+              },\n+            ],\n           },\n-        ],\n-      },\n-      // this should match on production\n-      'bar.{js}': {\n-        condition: {\n-          all: [{ not: 'development' }, { content: /export/ }],\n+          loaders: [\n+            {\n+              loader: './webpack-loader-replace-with-stub.cjs',\n+              options: { returnValue: 'has export substring on dev' },\n+            },\n+          ],\n         },\n-        loaders: [\n-          {\n-            loader: './webpack-loader-replace-with-stub.cjs',\n-            options: { returnValue: 'has export substring on prod' },\n+        // this should match on production\n+        {\n+          condition: {\n+            all: [{ not: 'development' }, { content: /export/ }],\n           },\n-        ],\n-      },\n+          loaders: [\n+            {\n+              loader: './webpack-loader-replace-with-stub.cjs',\n+              options: { returnValue: 'has export substring on prod' },\n+            },\n+          ],\n+        },\n+      ],\n     },\n   },\n }"
        }
    ],
    "stats": {
        "total": 314,
        "additions": 178,
        "deletions": 136
    }
}