{
    "author": "lukesandberg",
    "message": "Revert \"Revert \"Add a --webpack flag and default --turbopack to true (#84216)\"\" (#84351)\n\nReverts vercel/next.js#84348  which itself reverted #84216. \n\nIn the 2nd attempt to make --turbopack a default behavior.\n* adjust the Generate Pull Request States action to specify `--webpack`\n* set the `IS_WEBPACK_TEST` flag in the deployment e2e tests (which are now [passing](https://github.com/vercel/next.js/actions/runs/18113062122))\n* make the warning about having a webpack config without a turbopack config more verbose and consistently an error",
    "sha": "9a76ce433b9915bd6030f2001cf43ec3aeee3074",
    "files": [
        {
            "sha": "9a0e0cbb8e95bb97e7f48226a54091805243445a",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -502,6 +502,7 @@ jobs:\n \n         export NEXT_TEST_MODE=start\n         export NEXT_TEST_WASM=true\n+        export IS_WEBPACK_TEST=1\n         node run-tests.js \\\n           test/production/pages-dir/production/test/index.test.ts \\\n           test/e2e/streaming-ssr/index.test.ts\n@@ -711,7 +712,7 @@ jobs:\n \n     secrets: inherit\n \n-  test-dev:\n+  test-dev: # TODO: rename to include webpack\n     name: test dev\n     needs: ['optimize-ci', 'changes', 'build-native', 'build-next']\n     if: ${{ needs.optimize-ci.outputs.skip == 'false' && needs.changes.outputs.docs-only == 'false' }}\n@@ -728,6 +729,7 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       afterBuild: |\n+        export IS_WEBPACK_TEST=1\n         export NEXT_TEST_MODE=dev\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n@@ -752,8 +754,10 @@ jobs:\n \n     uses: ./.github/workflows/build_reusable.yml\n     with:\n+      # Should this be using turbopack? a variation?\n       afterBuild: |\n         export NEXT_TEST_MODE=dev\n+        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           test/e2e/app-dir/app/index.test.ts \\\n@@ -780,6 +784,7 @@ jobs:\n     with:\n       nodeVersion: 20.9.0\n       afterBuild: |\n+        export IS_WEBPACK_TEST=1\n         node run-tests.js \\\n           --concurrency 4 \\\n           test/production/pages-dir/production/test/index.test.ts \\\n@@ -808,6 +813,7 @@ jobs:\n     with:\n       afterBuild: |\n         export NEXT_TEST_MODE=start\n+        export IS_WEBPACK_TEST=1\n \n         node run-tests.js --type production \\\n           test/e2e/app-dir/app/index.test.ts \\\n@@ -836,6 +842,7 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       afterBuild: |\n+        export IS_WEBPACK_TEST=1\n         export NEXT_TEST_MODE=start\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n@@ -875,6 +882,7 @@ jobs:\n     with:\n       nodeVersion: 20.9.0\n       afterBuild: |\n+        export IS_WEBPACK_TEST=1\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n         node run-tests.js \\\n@@ -896,6 +904,7 @@ jobs:\n \n         # these all run without concurrency because they're heavier\n         export TEST_CONCURRENCY=1\n+        export IS_WEBPACK_TEST=1\n \n         BROWSER_NAME=firefox node run-tests.js \\\n           test/production/pages-dir/production/test/index.test.ts\n@@ -923,6 +932,7 @@ jobs:\n       afterBuild: |\n         export __NEXT_EXPERIMENTAL_PPR=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\"\n+        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\\n@@ -945,6 +955,7 @@ jobs:\n         export __NEXT_EXPERIMENTAL_PPR=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\"\n         export NEXT_TEST_MODE=dev\n+        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\\n@@ -968,6 +979,7 @@ jobs:\n         export __NEXT_EXPERIMENTAL_PPR=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\"\n         export NEXT_TEST_MODE=start\n+        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\\n@@ -990,6 +1002,7 @@ jobs:\n         export __NEXT_EXPERIMENTAL_PPR=true # for compatibility with the existing tests\n         export __NEXT_EXPERIMENTAL_CACHE_COMPONENTS=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/experimental-tests-manifest.json\"\n+        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\\n@@ -1014,6 +1027,7 @@ jobs:\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/experimental-tests-manifest.json\"\n         export NEXT_TEST_MODE=dev\n         export __NEXT_EXPERIMENTAL_ISOLATED_DEV_BUILD=true\n+        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\\n@@ -1038,6 +1052,7 @@ jobs:\n         export __NEXT_EXPERIMENTAL_CACHE_COMPONENTS=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/experimental-tests-manifest.json\"\n         export NEXT_TEST_MODE=start\n+        export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\\n           --timings \\"
        },
        {
            "sha": "9fe1fc91701bc8e9537790858baa4b1bf9274eec",
            "filename": ".github/workflows/pull_request_stats.yml",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/.github%2Fworkflows%2Fpull_request_stats.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/.github%2Fworkflows%2Fpull_request_stats.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fpull_request_stats.yml?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -60,3 +60,7 @@ jobs:\n \n       - uses: ./.github/actions/next-stats-action\n         if: ${{ steps.docs-change.outputs.DOCS_CHANGE == 'nope' }}\n+        env:\n+          # This uses the webpack bundle analyzer and for consistent results we need to use webpack.\n+          # Once there is an equivalent analyzer for turbopack, we can remove this.\n+          IS_WEBPACK_TEST: 1"
        },
        {
            "sha": "9c0d33eeefde9bdf2598094708bbf624a9959d22",
            "filename": ".github/workflows/test_e2e_deploy_release.yml",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -78,7 +78,15 @@ jobs:\n       matrix:\n         group: [1/8, 2/8, 3/8, 4/8, 5/8, 6/8, 7/8, 8/8]\n     with:\n-      afterBuild: npm i -g vercel@latest && NEXT_E2E_TEST_TIMEOUT=240000 NEXT_TEST_MODE=deploy NEXT_EXTERNAL_TESTS_FILTERS=\"test/deploy-tests-manifest.json\" NEXT_TEST_VERSION=\"${{ github.event.inputs.nextVersion || 'canary' }}\" VERCEL_CLI_VERSION=\"${{ github.event.inputs.vercelCliVersion || 'vercel@latest' }}\" node run-tests.js --timings -g ${{ matrix.group }} -c 2 --type e2e\n+      afterBuild: |\n+        npm i -g vercel@latest && \\\n+        NEXT_E2E_TEST_TIMEOUT=240000 \\\n+        NEXT_TEST_MODE=deploy \\\n+        IS_WEBPACK_TEST=1 \\\n+        NEXT_EXTERNAL_TESTS_FILTERS=\"test/deploy-tests-manifest.json\" \\\n+        NEXT_TEST_VERSION=\"${{ github.event.inputs.nextVersion || 'canary' }}\" \\\n+        VERCEL_CLI_VERSION=\"${{ github.event.inputs.vercelCliVersion || 'vercel@latest' }}\" \\\n+        node run-tests.js --timings -g ${{ matrix.group }} -c 2 --type e2e\n       skipNativeBuild: 'yes'\n       skipNativeInstall: 'no'\n       stepName: 'test-deploy-${{ matrix.group }}'"
        },
        {
            "sha": "8bd442a10f8a5e223ed306692343b304b693cbf8",
            "filename": "bench/heavy-npm-deps/package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/bench%2Fheavy-npm-deps%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/bench%2Fheavy-npm-deps%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Fheavy-npm-deps%2Fpackage.json?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -4,9 +4,9 @@\n   \"private\": true,\n   \"scripts\": {\n     \"dev-turbopack\": \"next dev --turbopack\",\n-    \"dev-webpack\": \"next dev\",\n+    \"dev-webpack\": \"next dev --webpack\",\n     \"build-turbopack\": \"next build --turbopack\",\n-    \"build-webpack\": \"next build\",\n+    \"build-webpack\": \"next build --webpack\",\n     \"start-turbopack\": \"next start\",\n     \"start-webpack\": \"next start\",\n     \"build-application\": \"next build\","
        },
        {
            "sha": "96814e0e6e87594f4c81449017e2fed9f53ffb30",
            "filename": "bench/module-cost/package.json",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/bench%2Fmodule-cost%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/bench%2Fmodule-cost%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Fmodule-cost%2Fpackage.json?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -3,10 +3,10 @@\n   \"scripts\": {\n     \"prepare-bench\": \"node scripts/prepare-bench.mjs\",\n     \"benchmark\": \"node scripts/benchmark-runner.mjs\",\n-    \"dev-webpack\": \"next dev\",\n-    \"dev-turbopack\": \"next dev --turbo\",\n-    \"build-webpack\": \"next build\",\n-    \"build-turbopack\": \"next build --turbo\",\n+    \"dev-webpack\": \"next dev --webpack\",\n+    \"dev-turbopack\": \"next dev --turbopack\",\n+    \"build-webpack\": \"next build --webpack\",\n+    \"build-turbopack\": \"next build --turbopack\",\n     \"start\": \"next start\"\n   },\n   \"devDependencies\": {"
        },
        {
            "sha": "7cb0e799cfef808b260def0e994edd671ffb68e3",
            "filename": "package.json",
            "status": "modified",
            "additions": 44,
            "deletions": 23,
            "changes": 67,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -17,29 +17,49 @@\n     \"ci:publish\": \"tsx ./scripts/release/publish-npm.ts\",\n     \"test-types\": \"tsc\",\n     \"test-unit\": \"jest test/unit/ packages/next/ packages/font\",\n-    \"test-dev\": \"cross-env NEXT_TEST_MODE=dev pnpm testheadless\",\n-    \"test-dev-experimental\": \"cross-env NEXT_TEST_MODE=dev pnpm run with-experimental pnpm testheadless\",\n-    \"test-dev-rspack\": \"pnpm run with-rspack pnpm run test-dev\",\n-    \"test-dev-experimental-rspack\": \"pnpm run with-rspack pnpm run test-dev-experimental\",\n-    \"test-dev-turbo\": \"cross-env NEXT_TEST_MODE=dev IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm testheadless\",\n-    \"test-dev-experimental-turbo\": \"cross-env NEXT_TEST_MODE=dev IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm run with-experimental pnpm testheadless\",\n-    \"test-start\": \"cross-env NEXT_TEST_MODE=start pnpm testheadless\",\n-    \"test-start-experimental\": \"cross-env NEXT_TEST_MODE=start pnpm run with-experimental pnpm testheadless\",\n-    \"test-start-rspack\": \"pnpm run with-rspack pnpm run test-start\",\n-    \"test-start-experimental-rspack\": \"pnpm run with-rspack pnpm run test-start-experimental\",\n-    \"test-start-turbo\": \"cross-env NEXT_TEST_MODE=start IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm testheadless\",\n-    \"test-start-experimental-turbo\": \"cross-env NEXT_TEST_MODE=start IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm run with-experimental pnpm testheadless\",\n-    \"test-deploy\": \"cross-env NEXT_TEST_MODE=deploy pnpm testheadless\",\n-    \"testonly-dev\": \"cross-env NEXT_TEST_MODE=dev pnpm testonly\",\n-    \"testonly-dev-rspack\": \"pnpm run with-rspack pnpm run testonly-dev\",\n-    \"testonly-dev-turbo\": \"cross-env NEXT_TEST_MODE=dev IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm testonly\",\n-    \"testonly-start\": \"cross-env NEXT_TEST_MODE=start pnpm testonly\",\n-    \"testonly-start-rspack\": \"pnpm run with-rspack pnpm run testonly-start\",\n-    \"testonly-start-turbo\": \"cross-env NEXT_TEST_MODE=start IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm testonly\",\n-    \"testonly-deploy\": \"cross-env NEXT_TEST_MODE=deploy pnpm testonly\",\n-    \"test\": \"pnpm testheadless\",\n-    \"test-rspack\": \"pnpm run with-rspack pnpm run test\",\n-    \"test-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 TURBOPACK_BUILD=1 pnpm testheadless\",\n+    \"test-dev-inner\": \"cross-env NEXT_TEST_MODE=dev pnpm testheadless\",\n+    \"test-dev\": \"pnpm run test-dev-webpack\",\n+    \"test-dev-webpack\": \"pnpm run with-webpack pnpm test-dev-inner\",\n+    \"test-dev-experimental-inner\": \"pnpm run with-experimental pnpm test-dev-inner\",\n+    \"test-dev-experimental\": \"pnpm run test-dev-experimental-webpack\",\n+    \"test-dev-experimental-webpack\": \"pnpm run with-webpack pnpm test-dev-experimental-inner\",\n+    \"test-dev-rspack\": \"pnpm run with-rspack pnpm run test-dev-inner\",\n+    \"test-dev-experimental-rspack\": \"pnpm run with-rspack pnpm run test-dev-experimental-inner\",\n+    \"test-dev-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm test-dev-inner\",\n+    \"test-dev-experimental-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm run with-experimental pnpm test-dev-inner\",\n+    \"test-start-inner\": \"cross-env NEXT_TEST_MODE=start pnpm testheadless\",\n+    \"test-start\": \"pnpm run test-start-webpack\",\n+    \"test-start-webpack\": \"pnpm run with-webpack pnpm run test-start-inner\",\n+    \"test-start-experimental-inner\": \"pnpm run with-experimental pnpm test-start-inner\",\n+    \"test-start-experimental\": \"pnpm run test-start-experimental-webpack\",\n+    \"test-start-experimental-webpack\": \"pnpm run with-webpack pnpm run test-start-experimental-inner\",\n+    \"test-start-rspack\": \"pnpm run with-rspack pnpm run test-start-inner\",\n+    \"test-start-experimental-rspack\": \"pnpm run with-rspack pnpm run test-start-experimental-inner\",\n+    \"test-start-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm test-start-inner\",\n+    \"test-start-experimental-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm run with-experimental pnpm test-start-experimental-inner\",\n+    \"test-deploy-inner\": \"cross-env NEXT_TEST_MODE=deploy pnpm testheadless\",\n+    \"test-deploy\": \"pnpm run test-deploy-webpack\",\n+    \"test-deploy-webpack\": \"pnpm run with-webpack pnpm test-deploy-inner\",\n+    \"test-deploy-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm test-deploy-inner\",\n+    \"testonly-dev-inner\": \"cross-env NEXT_TEST_MODE=dev pnpm testonly\",\n+    \"testonly-dev\": \"pnpm run testonly-dev-webpack\",\n+    \"testonly-dev-webpack\": \"pnpm run with-webpack pnpm run testonly-dev-inner\",\n+    \"testonly-dev-rspack\": \"pnpm run with-rspack pnpm run testonly-dev-inner\",\n+    \"testonly-dev-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 pnpm testonly-dev-inner\",\n+    \"testonly-start-inner\": \"cross-env NEXT_TEST_MODE=start pnpm testonly\",\n+    \"testonly-start\": \"pnpm run testonly-start-webpack\",\n+    \"testonly-start-webpack\": \"pnpm run with-webpack pnpm run testonly-start-inner\",\n+    \"testonly-start-rspack\": \"pnpm run with-rspack pnpm run testonly-start-inner\",\n+    \"testonly-start-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm testonly-start-inner\",\n+    \"testonly-deploy-inner\": \"cross-env NEXT_TEST_MODE=deploy pnpm testonly\",\n+    \"testonly-deploy\": \"pnpm run testonly-deploy-webpack\",\n+    \"testonly-deploy-webpack\": \"pnpm run with-webpack pnpm run testonly-deploy-inner\",\n+    \"testonly-deploy-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 pnpm testonly-deploy-inner\",\n+    \"test-inner\": \"pnpm testheadless\",\n+    \"test\": \"pnpm test-webpack\",\n+    \"test-webpack\": \"pnpm run with-webpack pnpm run test-inner\",\n+    \"test-rspack\": \"pnpm run with-rspack pnpm run test-inner\",\n+    \"test-turbo\": \"cross-env IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 TURBOPACK_BUILD=1 pnpm test-inner\",\n     \"testonly\": \"jest --runInBand\",\n     \"testheadless\": \"cross-env HEADLESS=true pnpm testonly\",\n     \"genstats\": \"cross-env LOCAL_STATS=true node .github/actions/next-stats-action/src/index.js\",\n@@ -89,6 +109,7 @@\n     \"build-storybook\": \"turbo run build-storybook\",\n     \"test-storybook\": \"turbo run test-storybook\",\n     \"with-rspack\": \"cross-env NEXT_RSPACK=1 NEXT_TEST_USE_RSPACK=1\",\n+    \"with-webpack\": \"cross-env IS_WEBPACK_TEST=1\",\n     \"with-experimental\": \"cross-env __NEXT_EXPERIMENTAL_CACHE_COMPONENTS=true __NEXT_EXPERIMENTAL_PPR=true\"\n   },\n   \"devDependencies\": {"
        },
        {
            "sha": "adcc47df109ecdac42aea5c7f8bea7f4dcf450a2",
            "filename": "packages/next-rspack/index.js",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext-rspack%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext-rspack%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-rspack%2Findex.js?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -1,5 +1,13 @@\n module.exports = function withRspack(config) {\n   process.env.NEXT_RSPACK = 'true'\n   process.env.RSPACK_CONFIG_VALIDATE = 'loose-silent'\n+  if (process.env.TURBOPACK === 'auto') {\n+    // If next has defaulted to turbopack, override it.\n+    delete process.env.TURBOPACK\n+  } else if (process.env.TURBOPACK) {\n+    console.error('Cannot call withRspack and pass the --turbopack flag.')\n+    console.error('Please configure only one bundler.')\n+    process.exit(1)\n+  }\n   return config\n }"
        },
        {
            "sha": "a947d1ad95aeed6c5b3e11bd979487a76dffcb17",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -133,8 +133,9 @@ program\n   .option('--no-mangling', 'Disables mangling.')\n   .option('--profile', 'Enables production profiling for React.')\n   .option('--experimental-app-only', 'Builds only App Router routes.')\n-  .option('--turbo', 'Starts development mode using Turbopack.')\n-  .option('--turbopack', 'Starts development mode using Turbopack.')\n+  .option('--turbo', 'Builds using Turbopack.')\n+  .option('--turbopack', 'Builds using Turbopack.')\n+  .option('--webpack', 'Builds using webpack.')\n   .addOption(\n     new Option(\n       '--experimental-build-mode [mode]',\n@@ -173,6 +174,7 @@ program\n   )\n   .option('--turbo', 'Starts development mode using Turbopack.')\n   .option('--turbopack', 'Starts development mode using Turbopack.')\n+  .option('--webpack', 'Starts development mode using webpack.')\n   .addOption(\n     new Option(\n       '-p, --port <port>',"
        },
        {
            "sha": "bb3648fdb8467a4035d0a754e3fbfc0fc5ccc5db",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 24,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -83,6 +83,7 @@ import {\n   UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY,\n } from '../shared/lib/entry-constants'\n import { isDynamicRoute } from '../shared/lib/router/utils'\n+import { Bundler, finalizeBundlerFromConfig } from '../lib/bundler'\n import type { __ApiPreviewProps } from '../server/api-utils'\n import loadConfig from '../server/config'\n import type { BuildManifest } from '../server/get-page-files'\n@@ -901,7 +902,7 @@ export default async function build(\n   runLint = true,\n   noMangling = false,\n   appDirOnly = false,\n-  isTurbopack = false,\n+  bundler = Bundler.Turbopack,\n   experimentalBuildMode: 'default' | 'compile' | 'generate' | 'generate-env',\n   traceUploadUrl: string | undefined\n ): Promise<void> {\n@@ -914,7 +915,6 @@ export default async function build(\n   try {\n     const nextBuildSpan = trace('next-build', undefined, {\n       buildMode: experimentalBuildMode,\n-      isTurboBuild: String(isTurbopack),\n       version: process.env.__NEXT_VERSION as string,\n     })\n \n@@ -949,6 +949,10 @@ export default async function build(\n         )\n       loadedConfig = config\n \n+      // Reading the config can modify environment variables that influence the bundler selection.\n+      bundler = finalizeBundlerFromConfig(bundler)\n+      nextBuildSpan.setAttribute('bundler', getBundlerForTelemetry(bundler))\n+\n       process.env.NEXT_DEPLOYMENT_ID = config.deploymentId || ''\n       NextBuildContext.config = config\n \n@@ -971,7 +975,7 @@ export default async function build(\n       NextBuildContext.buildId = buildId\n \n       if (experimentalBuildMode === 'generate-env') {\n-        if (isTurbopack) {\n+        if (bundler === Bundler.Turbopack) {\n           Log.warn('generate-env is not needed with turbopack')\n           process.exit(0)\n         }\n@@ -1398,7 +1402,7 @@ export default async function build(\n         })\n \n       // Turbopack already handles conflicting app and page routes.\n-      if (!isTurbopack) {\n+      if (bundler !== Bundler.Turbopack) {\n         const numConflictingAppPaths = conflictingAppPagePaths.length\n         if (mappedAppPages && numConflictingAppPaths > 0) {\n           Log.error(\n@@ -1681,7 +1685,7 @@ export default async function build(\n \n       let shutdownPromise = Promise.resolve()\n       if (!isGenerateMode) {\n-        if (isTurbopack) {\n+        if (bundler === Bundler.Turbopack) {\n           const {\n             duration: compilerDuration,\n             shutdownPromise: p,\n@@ -1796,7 +1800,7 @@ export default async function build(\n \n             telemetry.record(\n               eventBuildCompleted(pagesPaths, {\n-                bundler: getBundlerForTelemetry(isTurbopack),\n+                bundler: getBundlerForTelemetry(bundler),\n                 durationInSeconds,\n                 totalAppPagesCount,\n               })\n@@ -1812,7 +1816,7 @@ export default async function build(\n \n             telemetry.record(\n               eventBuildCompleted(pagesPaths, {\n-                bundler: getBundlerForTelemetry(isTurbopack),\n+                bundler: getBundlerForTelemetry(bundler),\n                 durationInSeconds: compilerDuration,\n                 totalAppPagesCount,\n               })\n@@ -2450,7 +2454,10 @@ export default async function build(\n         )\n         // If there's edge routes, append the edge instrumentation hook\n         // Turbopack generates this chunk with a hashed name and references it in middleware-manifest.\n-        if (!isTurbopack && (edgeRuntimeAppCount || edgeRuntimePagesCount)) {\n+        if (\n+          bundler !== Bundler.Turbopack &&\n+          (edgeRuntimeAppCount || edgeRuntimePagesCount)\n+        ) {\n           instrumentationHookEntryFiles.push(\n             path.join(\n               SERVER_DIRECTORY,\n@@ -2503,7 +2510,7 @@ export default async function build(\n               path.join(SERVER_DIRECTORY, FUNCTIONS_CONFIG_MANIFEST),\n               path.join(SERVER_DIRECTORY, MIDDLEWARE_MANIFEST),\n               path.join(SERVER_DIRECTORY, MIDDLEWARE_BUILD_MANIFEST + '.js'),\n-              ...(!isTurbopack\n+              ...(bundler !== Bundler.Turbopack\n                 ? [\n                     path.join(\n                       SERVER_DIRECTORY,\n@@ -2538,7 +2545,7 @@ export default async function build(\n                     ),\n                   ]\n                 : []),\n-              ...(pagesDir && !isTurbopack\n+              ...(pagesDir && bundler !== Bundler.Turbopack\n                 ? [\n                     DYNAMIC_CSS_MANIFEST + '.json',\n                     path.join(SERVER_DIRECTORY, DYNAMIC_CSS_MANIFEST + '.js'),\n@@ -2606,7 +2613,7 @@ export default async function build(\n             ],\n           }\n \n-          if (isTurbopack) {\n+          if (bundler === Bundler.Turbopack) {\n             await writeManifest(\n               path.join(\n                 distDir,\n@@ -2622,7 +2629,11 @@ export default async function build(\n \n       await writeFunctionsConfigManifest(distDir, functionsConfigManifest)\n \n-      if (!isTurbopack && !isGenerateMode && !buildTracesPromise) {\n+      if (\n+        bundler !== Bundler.Turbopack &&\n+        !isGenerateMode &&\n+        !buildTracesPromise\n+      ) {\n         buildTracesPromise = nextBuildSpan\n           .traceChild('collect-build-traces')\n           .traceAsyncFn(() => {\n@@ -2764,7 +2775,7 @@ export default async function build(\n \n       // we don't need to inline for turbopack build as\n       // it will handle it's own caching separate of compile\n-      if (isGenerateMode && !isTurbopack) {\n+      if (isGenerateMode && bundler !== Bundler.Turbopack) {\n         Log.info('Inlining static env ...')\n \n         await nextBuildSpan\n@@ -4200,7 +4211,7 @@ export default async function build(\n     if (telemetry) {\n       telemetry.record(\n         eventBuildFailed({\n-          bundler: getBundlerForTelemetry(isTurbopack),\n+          bundler: getBundlerForTelemetry(bundler),\n           errorCode: getErrorCodeForTelemetry(e),\n           durationInSeconds: Math.floor((Date.now() - buildStartTime) / 1000),\n         })\n@@ -4221,7 +4232,7 @@ export default async function build(\n         mode: 'build',\n         projectDir: dir,\n         distDir: loadedConfig.distDir,\n-        isTurboSession: isTurbopack,\n+        isTurboSession: bundler === Bundler.Turbopack,\n         sync: true,\n       })\n     }\n@@ -4235,16 +4246,17 @@ function errorFromUnsupportedSegmentConfig(): never {\n   process.exit(1)\n }\n \n-function getBundlerForTelemetry(isTurbopack: boolean) {\n-  if (isTurbopack) {\n-    return 'turbopack'\n+function getBundlerForTelemetry(bundler: Bundler) {\n+  switch (bundler) {\n+    case Bundler.Turbopack:\n+      return 'turbopack'\n+    case Bundler.Rspack:\n+      return 'rspack'\n+    case Bundler.Webpack:\n+      return 'webpack'\n+    default:\n+      throw new Error(`unknown bundler: ${bundler}`)\n   }\n-\n-  if (process.env.NEXT_RSPACK) {\n-    return 'rspack'\n-  }\n-\n-  return 'webpack'\n }\n \n function getErrorCodeForTelemetry(err: unknown) {"
        },
        {
            "sha": "bea9c4900e8e685ffae4b9f7ae8be5984c45f238",
            "filename": "packages/next/src/cli/next-build.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -10,6 +10,7 @@ import isError from '../lib/is-error'\n import { getProjectDir } from '../lib/get-project-dir'\n import { enableMemoryDebuggingMode } from '../lib/memory/startup'\n import { disableMemoryDebuggingMode } from '../lib/memory/shutdown'\n+import { parseBundlerArgs } from '../lib/bundler'\n \n export type NextBuildOptions = {\n   debug?: boolean\n@@ -19,6 +20,7 @@ export type NextBuildOptions = {\n   mangling: boolean\n   turbo?: boolean\n   turbopack?: boolean\n+  webpack?: boolean\n   experimentalDebugMemoryUsage: boolean\n   experimentalAppOnly?: boolean\n   experimentalTurbo?: boolean\n@@ -82,12 +84,7 @@ const nextBuild = (options: NextBuildOptions, directory?: string) => {\n     printAndExit(`> No such directory exists as the project root: ${dir}`)\n   }\n \n-  const isTurbopack = Boolean(\n-    options.turbo || options.turbopack || process.env.IS_TURBOPACK_TEST\n-  )\n-  if (isTurbopack) {\n-    process.env.TURBOPACK = '1'\n-  }\n+  const bundler = parseBundlerArgs(options)\n \n   return build(\n     dir,\n@@ -97,7 +94,7 @@ const nextBuild = (options: NextBuildOptions, directory?: string) => {\n     lint,\n     !mangling,\n     experimentalAppOnly,\n-    isTurbopack,\n+    bundler,\n     experimentalBuildMode,\n     traceUploadUrl\n   )"
        },
        {
            "sha": "b4f1e0db71f6dc4a4f032c03b5927bc574deccb6",
            "filename": "packages/next/src/cli/next-dev.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 15,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -38,11 +38,17 @@ import { once } from 'node:events'\n import { clearTimeout } from 'timers'\n import { flushAllTraces, trace } from '../trace'\n import { traceId } from '../trace/shared'\n+import {\n+  Bundler,\n+  finalizeBundlerFromConfig,\n+  parseBundlerArgs,\n+} from '../lib/bundler'\n \n export type NextDevOptions = {\n   disableSourceMaps: boolean\n   turbo?: boolean\n   turbopack?: boolean\n+  webpack?: boolean\n   port: number\n   hostname?: string\n   experimentalHttps?: boolean\n@@ -58,11 +64,11 @@ let dir: string\n let child: undefined | ChildProcess\n // The config in next-dev is only used to access config.distDir for telemetry and trace.\n let config: NextConfigComplete\n-let isTurboSession = false\n+let bundler: Bundler\n let traceUploadUrl: string\n let sessionStopHandled = false\n-let sessionStarted = Date.now()\n-let sessionSpan = trace('next-dev')\n+const sessionStarted = Date.now()\n+const sessionSpan = trace('next-dev')\n \n // How long should we wait for the child to cleanly exit after sending\n // SIGINT/SIGTERM to the child process before sending SIGKILL?\n@@ -123,11 +129,13 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n       new Telemetry({\n         distDir: path.join(dir, config.distDir),\n       })\n+    // Reading the config can modify environment variables that influence the bundler selection.\n+    bundler = finalizeBundlerFromConfig(bundler)\n \n     telemetry.record(\n       eventCliSessionStopped({\n         cliCommand: 'dev',\n-        turboFlag: isTurboSession,\n+        turboFlag: bundler === Bundler.Turbopack,\n         durationMilliseconds: Date.now() - sessionStarted,\n         pagesDir,\n         appDir,\n@@ -146,7 +154,7 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n       mode: 'dev',\n       projectDir: dir,\n       distDir: config.distDir,\n-      isTurboSession,\n+      isTurboSession: bundler === Bundler.Turbopack,\n     })\n   }\n \n@@ -168,14 +176,7 @@ const nextDev = async (\n   portSource: PortSource,\n   directory?: string\n ) => {\n-  const isTurbopack = Boolean(\n-    options.turbo || options.turbopack || process.env.IS_TURBOPACK_TEST\n-  )\n-  if (isTurbopack) {\n-    process.env.TURBOPACK = '1'\n-  }\n-\n-  isTurboSession = isTurbopack\n+  bundler = parseBundlerArgs(options)\n \n   dir = getProjectDir(process.env.NEXT_PRIVATE_DEV_DIR || directory)\n \n@@ -288,7 +289,9 @@ const nextDev = async (\n         stdio: 'inherit',\n         env: {\n           ...defaultEnv,\n-          ...(isTurbopack ? { TURBOPACK: '1' } : undefined),\n+          ...(bundler === Bundler.Turbopack\n+            ? { TURBOPACK: process.env.TURBOPACK }\n+            : undefined),\n           NEXT_PRIVATE_WORKER: '1',\n           NEXT_PRIVATE_TRACE_ID: traceId,\n           NODE_EXTRA_CA_CERTS: startServerOptions.selfSignedCertificate\n@@ -336,12 +339,13 @@ const nextDev = async (\n               (await loadConfig(PHASE_DEVELOPMENT_SERVER, dir, {\n                 silent: true,\n               }))\n+            bundler = finalizeBundlerFromConfig(bundler)\n             uploadTrace({\n               traceUploadUrl,\n               mode: 'dev',\n               projectDir: dir,\n               distDir: config.distDir,\n-              isTurboSession,\n+              isTurboSession: bundler === Bundler.Turbopack,\n               sync: true,\n             })\n           }"
        },
        {
            "sha": "38eee0866d2e6f47303354acce0d9be098a1014b",
            "filename": "packages/next/src/lib/bundler.ts",
            "status": "added",
            "additions": 99,
            "deletions": 0,
            "changes": 99,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Flib%2Fbundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Flib%2Fbundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fbundler.ts?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -0,0 +1,99 @@\n+/// Utilties for configuring the bundler to use.\n+export enum Bundler {\n+  Turbopack,\n+  Webpack,\n+  Rspack,\n+}\n+/**\n+ * Parse the bundler arguments and potentially sets the `TURBOPACK` environment variable.\n+ *\n+ * NOTE: rspack is configured via next config which is chaotic so it is possible for this to be overridden later.\n+ *\n+ * @param options The options to parse.\n+ * @returns The bundler that was configured\n+ */\n+export function parseBundlerArgs(options: {\n+  turbo?: boolean\n+  turbopack?: boolean\n+  webpack?: boolean\n+}): Bundler {\n+  const bundlerFlags = new Map<Bundler, string[]>()\n+  const setBundlerFlag = (bundler: Bundler, flag: string) => {\n+    bundlerFlags.set(bundler, (bundlerFlags.get(bundler) ?? []).concat(flag))\n+  }\n+  // What turbo flag was set? We allow multiple to be set, which is silly but not ambiguous, just pick the most relevant one.\n+  if (options.turbopack) {\n+    setBundlerFlag(Bundler.Turbopack, '--turbopack')\n+  }\n+  if (options.turbo) {\n+    setBundlerFlag(Bundler.Turbopack, '--turbo')\n+  } else if (process.env.TURBOPACK) {\n+    // We don't really want to support this but it is trivial and not really confusing.\n+    // If we don't support it and someone sets it, we would have inconsistent behavior\n+    // since some parts of next would read the return value of this function and other\n+    // parts will read the env variable.\n+    setBundlerFlag(Bundler.Turbopack, `TURBOPACK=${process.env.TURBOPACK}`)\n+  } else if (process.env.IS_TURBOPACK_TEST) {\n+    setBundlerFlag(\n+      Bundler.Turbopack,\n+      `IS_TURBOPACK_TEST=${process.env.IS_TURBOPACK_TEST}`\n+    )\n+  }\n+  if (options.webpack) {\n+    setBundlerFlag(Bundler.Webpack, '--webpack')\n+  }\n+\n+  if (process.env.IS_WEBPACK_TEST) {\n+    setBundlerFlag(\n+      Bundler.Webpack,\n+      `IS_WEBPACK_TEST=${process.env.IS_WEBPACK_TEST}`\n+    )\n+  }\n+\n+  // Mostly this is set via the NextConfig but it can also be set via the command line which is\n+  // common for testing.\n+  if (process.env.NEXT_RSPACK) {\n+    setBundlerFlag(Bundler.Rspack, `NEXT_RSPACK=${process.env.NEXT_RSPACK}`)\n+  }\n+  if (process.env.NEXT_TEST_USE_RSPACK) {\n+    setBundlerFlag(\n+      Bundler.Rspack,\n+      `NEXT_TEST_USE_RSPACK=${process.env.NEXT_TEST_USE_RSPACK}`\n+    )\n+  }\n+\n+  if (bundlerFlags.size > 1) {\n+    console.error(\n+      `Multiple bundler flags set: ${Array.from(bundlerFlags.values()).flat().join(', ')}. Configure exactly one bundler.`\n+    )\n+    process.exit(1)\n+  }\n+  // The default is turbopack when nothing is configured.\n+  if (bundlerFlags.size === 0) {\n+    process.env.TURBOPACK = 'auto'\n+    return Bundler.Turbopack\n+  }\n+  if (bundlerFlags.has(Bundler.Turbopack)) {\n+    // Only conditionally assign to the environment variable, preserving already set values.\n+    // If it was set to 'auto' because no flag was set and this function is called a second time we\n+    // would upgrade to '1' but we don't really want that.\n+    process.env.TURBOPACK ??= '1'\n+    return Bundler.Turbopack\n+  }\n+  // Otherwise it is one of rspack or webpack. At this point there must be exactly one key in the map.\n+  return bundlerFlags.keys().next().value!\n+}\n+\n+/**\n+ * Finalize the bundler based on the config.\n+ *\n+ * Rspack is configured via next config by setting an environment variable (yay, side effects)\n+ * so this should only be called after parsing the config.\n+ */\n+export function finalizeBundlerFromConfig(fromOptions: Bundler) {\n+  // Reading the next config can set NEXT_RSPACK environment variables.\n+  if (process.env.NEXT_RSPACK) {\n+    return Bundler.Rspack\n+  }\n+  return fromOptions\n+}"
        },
        {
            "sha": "4aafd28cb2fd0de19207f692c82c8e3925359827",
            "filename": "packages/next/src/lib/turbopack-warning.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 16,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -1,4 +1,4 @@\n-import type { NextConfig } from '../server/config-shared'\n+import type { NextConfigComplete } from '../server/config-shared'\n import loadConfig from '../server/config'\n import * as Log from '../build/output/log'\n import {\n@@ -47,11 +47,9 @@ const unsupportedTurbopackNextConfigOptions = [\n ]\n \n // The following will need to be supported by `next build --turbopack`\n-const unsupportedProductionSpecificTurbopackNextConfigOptions: string[] = [\n-  // TODO: Support disabling sourcemaps, currently they're always enabled.\n-  // 'productionBrowserSourceMaps',\n-]\n+const unsupportedProductionSpecificTurbopackNextConfigOptions: string[] = []\n \n+/**  */\n export async function validateTurboNextConfig({\n   dir,\n   isDev,\n@@ -71,16 +69,16 @@ export async function validateTurboNextConfig({\n   let hasWebpackConfig = false\n   let hasTurboConfig = false\n \n-  let unsupportedConfig: string[] = []\n-  let rawNextConfig: NextConfig = {}\n+  const unsupportedConfig: string[] = []\n+  let rawNextConfig: NextConfigComplete = {} as NextConfigComplete\n \n   const phase = isDev ? PHASE_DEVELOPMENT_SERVER : PHASE_PRODUCTION_BUILD\n   try {\n     rawNextConfig = interopDefault(\n       await loadConfig(phase, dir, {\n         rawConfig: true,\n       })\n-    ) as NextConfig\n+    )\n \n     if (typeof rawNextConfig === 'function') {\n       rawNextConfig = (rawNextConfig as any)(phase, {\n@@ -124,7 +122,7 @@ export async function validateTurboNextConfig({\n \n     const customKeys = flattenKeys(rawNextConfig)\n \n-    let unsupportedKeys = isDev\n+    const unsupportedKeys = isDev\n       ? unsupportedTurbopackNextConfigOptions\n       : [\n           ...unsupportedTurbopackNextConfigOptions,\n@@ -139,7 +137,7 @@ export async function validateTurboNextConfig({\n         hasTurboConfig = true\n       }\n \n-      let isUnsupported =\n+      const isUnsupported =\n         unsupportedKeys.some(\n           (unsupportedKey) =>\n             // Either the key matches (or is a more specific subkey) of\n@@ -162,13 +160,24 @@ export async function validateTurboNextConfig({\n     Log.error('Unexpected error occurred while checking config', e)\n   }\n \n-  if (hasWebpackConfig && !hasTurboConfig) {\n-    Log.warn(\n-      `Webpack is configured while Turbopack is not, which may cause problems.`\n-    )\n-    Log.warn(\n-      `See instructions if you need to configure Turbopack:\\n  https://nextjs.org/docs/app/api-reference/next-config-js/turbopack\\n`\n+  // If the build was defaulted to Turbopack, we want to warn about possibly ignored webpack\n+  // configuration. Otherwise the user explicitly picked turbopack and thus we expect that\n+  // they have configured it correctly.\n+  if (process.env.TURBOPACK === 'auto' && hasWebpackConfig && !hasTurboConfig) {\n+    const configFile = rawNextConfig.configFileName ?? 'your Next config file'\n+    Log.error(\n+      `ERROR: This build is using Turbopack, with a \\`webpack\\` config and no \\`turbopack\\` config. This may be a mistake.\n+\n+  As of Next.js 16 turbopack is enabled by default and custom webpack configurations may need to be migrated to Turbopack.\n+\n+  NOTE: your \\`webpack\\` config may have been added by a configuration plugin.\n+\n+  To configure Turbopack, see https://nextjs.org/docs/app/api-reference/next-config-js/turbopack\n+\n+  TIP: Many applications work fine under Turbopack with no configuration, if that is the case for you, you can silence this error by passing the \\`--turbopack\\` or \\`--webpack\\` flag explicitly or simply setting an empty turbopack config in ${configFile} (e.g. \\`turbopack: {}\\`).`\n     )\n+\n+    process.exit(1)\n   }\n \n   if (unsupportedConfig.length) {"
        },
        {
            "sha": "2ca7d7b9bffb9a57847b3adce525d5b4d180e311",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -540,7 +540,8 @@ function createServer(\n     options &&\n     (options.turbo || options.turbopack || process.env.IS_TURBOPACK_TEST)\n   ) {\n-    process.env.TURBOPACK = '1'\n+    // Configure TURBOPACK if it isn't already set\n+    process.env.TURBOPACK ??= '1'\n   }\n   // The package is used as a TypeScript plugin.\n   if ("
        },
        {
            "sha": "881ae9dc3b21a7bb466bfd0445972ff26f1beaef",
            "filename": "scripts/test-new-tests.mjs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/scripts%2Ftest-new-tests.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/scripts%2Ftest-new-tests.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Ftest-new-tests.mjs?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -153,6 +153,7 @@ async function main() {\n         NEXT_EXTERNAL_TESTS_FILTERS,\n         NEXT_TEST_MODE: testMode,\n         NEXT_TEST_VERSION: nextTestVersion,\n+        IS_WEBPACK_TEST: '1',\n       },\n     })\n   }\n@@ -170,6 +171,7 @@ async function main() {\n           NEXT_TEST_VERSION: nextTestVersion,\n           IS_TURBOPACK_TEST: '1',\n           TURBOPACK_BUILD: testMode === 'start' ? '1' : undefined,\n+          TURBOPACK_DEV: testMode === 'dev' ? '1' : undefined,\n         },\n       })\n     }"
        },
        {
            "sha": "348568ae507ed3fb6e5e14512d094a378ac86f62",
            "filename": "test/development/next-config-ts/turbo/index.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 12,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/test%2Fdevelopment%2Fnext-config-ts%2Fturbo%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/test%2Fdevelopment%2Fnext-config-ts%2Fturbo%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fnext-config-ts%2Fturbo%2Findex.test.ts?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -1,13 +1,15 @@\n import { nextTestSetup } from 'e2e-utils'\n-\n-describe('next-config-ts - turbopack', () => {\n-  const { next } = nextTestSetup({\n-    files: __dirname,\n-    // explicitly ensure that turbopack is used\n-    startCommand: 'pnpm next dev --turbo',\n-  })\n-  it('should work with Turbopack', async () => {\n-    const $ = await next.render$('/')\n-    expect($('p').text()).toBe('foo')\n-  })\n-})\n+;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n+  'next-config-ts - turbopack',\n+  () => {\n+    const { next } = nextTestSetup({\n+      files: __dirname,\n+      // explicitly ensure that turbopack is used\n+      startCommand: 'pnpm next dev --turbopack',\n+    })\n+    it('should work with Turbopack', async () => {\n+      const $ = await next.render$('/')\n+      expect($('p').text()).toBe('foo')\n+    })\n+  }\n+)"
        },
        {
            "sha": "64089fd3d012981f059517a9a66a77c93366b3d3",
            "filename": "test/e2e/config-turbopack/index.test.ts",
            "status": "modified",
            "additions": 118,
            "deletions": 72,
            "changes": 190,
            "blob_url": "https://github.com/vercel/next.js/blob/9a76ce433b9915bd6030f2001cf43ec3aeee3074/test%2Fe2e%2Fconfig-turbopack%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9a76ce433b9915bd6030f2001cf43ec3aeee3074/test%2Fe2e%2Fconfig-turbopack%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fconfig-turbopack%2Findex.test.ts?ref=9a76ce433b9915bd6030f2001cf43ec3aeee3074",
            "patch": "@@ -1,96 +1,142 @@\n /* eslint-disable jest/no-standalone-expect */\n import { nextTestSetup } from 'e2e-utils'\n \n-const WARNING_MESSAGE = 'Webpack is configured while Turbopack is not'\n+const WARNING_MESSAGE =\n+  'ERROR: This build is using Turbopack, with a `webpack` config and no `turbopack` config. This may be a mistake'\n \n const itif = (condition: boolean) => (condition ? it : it.skip)\n \n-describe('config-turbopack', () => {\n-  describe('when webpack is configured but Turbopack is not', () => {\n-    const { next, isTurbopack } = nextTestSetup({\n-      files: {\n-        'app/page.js': `\n-          export default function Page() {\n-            return <p>hello world</p>\n-          }\n-        `,\n-        'next.config.js': `\n+const page = {\n+  'app/page.js': `\n+export default function Page() {\n+  return <p>hello world</p>\n+}\n+`,\n+}\n+\n+;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n+  'config-turbopack',\n+  () => {\n+    describe('when turbopack is auto selected', () => {\n+      describe('when webpack is configured but Turbopack is not', () => {\n+        const { next, isNextDev, isNextStart } = nextTestSetup({\n+          skipStart: Boolean(process.env.NEXT_TEST_MODE === 'start'),\n+          turbo: false,\n+          env: {\n+            TURBOPACK: 'auto',\n+          },\n+          files: {\n+            ...page,\n+            'next.config.js': `\n           module.exports = {\n             webpack: (config) => {\n               return config\n             },\n           }\n         `,\n-      },\n-    })\n+          },\n+        })\n+\n+        itif(isNextDev)('warns', async () => {\n+          if (next)\n+            try {\n+              await next.render('/')\n+            } catch (e) {\n+              // we expect an error but this is the only way to get the server to crash\n+            }\n \n-    itif(isTurbopack)('warns', async () => {\n-      if (next) await next.render('/')\n-      expect(next.cliOutput).toContain(WARNING_MESSAGE)\n+          expect(next.cliOutput).toContain(WARNING_MESSAGE)\n+        })\n+        itif(isNextStart)('errors', async () => {\n+          const { exitCode, cliOutput } = await next.build()\n+          expect(exitCode).toBe(1)\n+          expect(cliOutput).toContain(WARNING_MESSAGE)\n+        })\n+      })\n+      // no warn cases work when auto selected too\n+      noWarnCases()\n     })\n-  })\n \n-  describe('when webpack is configured and config.turbopack is set', () => {\n-    const { next, isTurbopack } = nextTestSetup({\n-      files: {\n-        'app/page.js': `\n-          export default function Page() {\n-            return <p>hello world</p>\n-          }\n-        `,\n-        'next.config.js': `\n-          module.exports = {\n-            turbopack: {\n-              rules: {\n-                '*.foo': {\n-                  loaders: ['foo-loader']\n-                }\n+    describe('when turbopack is explicitly configured', () => {\n+      describe('when webpack is configured but Turbopack is not', () => {\n+        const { next } = nextTestSetup({\n+          files: {\n+            ...page,\n+            'next.config.js': `\n+              module.exports = {\n+                webpack: (config) => {\n+                  return config\n+                },\n               }\n-            },\n-            webpack: (config) => {\n-              return config\n-            },\n-          }\n-        `,\n-      },\n-    })\n+            `,\n+          },\n+        })\n \n-    itif(isTurbopack)('does not warn', async () => {\n-      if (next) await next.render('/')\n-      expect(next.cliOutput).not.toContain(WARNING_MESSAGE)\n+        it('does not warn', async () => {\n+          if (next) await next.render('/')\n+          expect(next.cliOutput).not.toContain(WARNING_MESSAGE)\n+        })\n+      })\n+      noWarnCases()\n     })\n-  })\n-\n-  describe('when webpack is configured and config.experimental.turbo is set', () => {\n-    const { next, isTurbopack } = nextTestSetup({\n-      files: {\n-        'app/page.js': `\n-          export default function Page() {\n-            return <p>hello world</p>\n-          }\n-        `,\n-        'next.config.js': `\n-          module.exports = {\n-            experimental: {\n-              turbo: {\n+    /// These other cases don't warn because --turbopack is explicitly selected\n+    function noWarnCases(env?: Record<string, string>) {\n+      describe('when webpack is configured and config.turbopack is set', () => {\n+        const { next } = nextTestSetup({\n+          env,\n+          files: {\n+            ...page,\n+            'next.config.js': `\n+            module.exports = {\n+              turbopack: {\n                 rules: {\n                   '*.foo': {\n                     loaders: ['foo-loader']\n                   }\n                 }\n-              }\n-            },\n-            webpack: (config) => {\n-              return config\n-            },\n-          }\n-        `,\n-      },\n-    })\n+              },\n+              webpack: (config) => {\n+                return config\n+              },\n+            }\n+          `,\n+          },\n+        })\n \n-    itif(isTurbopack)('does not warn', async () => {\n-      if (next) await next.render('/')\n-      expect(next.cliOutput).not.toContain(WARNING_MESSAGE)\n-    })\n-  })\n-})\n+        it('does not warn', async () => {\n+          if (next) await next.render('/')\n+          expect(next.cliOutput).not.toContain(WARNING_MESSAGE)\n+        })\n+      })\n+\n+      describe('when webpack is configured and config.experimental.turbo is set', () => {\n+        const { next } = nextTestSetup({\n+          files: {\n+            ...page,\n+            'next.config.js': `\n+            module.exports = {\n+              experimental: {\n+                turbo: {\n+                  rules: {\n+                    '*.foo': {\n+                      loaders: ['foo-loader']\n+                    }\n+                  }\n+                }\n+              },\n+              webpack: (config) => {\n+                return config\n+              },\n+            }\n+          `,\n+          },\n+        })\n+\n+        it('does not warn', async () => {\n+          if (next) await next.render('/')\n+          expect(next.cliOutput).not.toContain(WARNING_MESSAGE)\n+        })\n+      })\n+    }\n+  }\n+)"
        }
    ],
    "stats": {
        "total": 590,
        "additions": 410,
        "deletions": 180
    }
}