{
    "author": "wbinnssmith",
    "message": "Turbopack: canary-gate production builds (#77146)\n\nThis allows `next build --turbopack` to be run without `TURBOPACK_BUILD`\nbeing set, and only allows it when used with canary Next.js builds.\n\nThis also accepts `next build --turbo` and `next build\n--experimental-turbo` for compatibility.\n\nNote: This keeps `TURBOPACK_BUILD` for test purposes.\n\nCloses PACK-4108\nCloses PACK-4111\n\nTest Plan:\n\n- `pnpm next build --turbopack examples/basic-css/` uses Turbopack to\nbuild and succeeds\n- Set `next`â€™s package.json version to `15.3.0`, build, and run\n`./node_modules/.bin/next build --turbopack examples/basic-css/`. Verify\nthe canary-gate message is shown",
    "sha": "152e54a1711f94c057c8251341c94a1c095f536b",
    "files": [
        {
            "sha": "c11f4aeac3d0d9c6ad87bcd0e073e1c7b8c42c8e",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/152e54a1711f94c057c8251341c94a1c095f536b/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/152e54a1711f94c057c8251341c94a1c095f536b/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=152e54a1711f94c057c8251341c94a1c095f536b",
            "patch": "@@ -663,5 +663,6 @@\n   \"662\": \"Invariant failed to find webpack runtime chunk\",\n   \"663\": \"Invariant: client chunk changed but failed to detect hash %s\",\n   \"664\": \"Missing 'next-action' header.\",\n-  \"665\": \"Failed to find Server Action \\\"%s\\\". This request might be from an older or newer deployment.\\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\"\n+  \"665\": \"Failed to find Server Action \\\"%s\\\". This request might be from an older or newer deployment.\\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\",\n+  \"666\": \"Turbopack builds are only available in canary builds of Next.js.\"\n }"
        },
        {
            "sha": "2407db1085ef9e63639084772800846c13c57412",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/152e54a1711f94c057c8251341c94a1c095f536b/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/152e54a1711f94c057c8251341c94a1c095f536b/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=152e54a1711f94c057c8251341c94a1c095f536b",
            "patch": "@@ -130,6 +130,8 @@ program\n   .option('--profile', 'Enables production profiling for React.')\n   .option('--experimental-app-only', 'Builds only App Router routes.')\n   .addOption(new Option('--experimental-turbo').hideHelp())\n+  .addOption(new Option('--turbo').hideHelp())\n+  .addOption(new Option('--turbopack').hideHelp())\n   .addOption(\n     new Option(\n       '--experimental-build-mode [mode]',"
        },
        {
            "sha": "f341591cb6c64fcacb01511352d0dccb3a5f03e4",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/152e54a1711f94c057c8251341c94a1c095f536b/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/152e54a1711f94c057c8251341c94a1c095f536b/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=152e54a1711f94c057c8251341c94a1c095f536b",
            "patch": "@@ -19,16 +19,17 @@ import loadConfig from '../../server/config'\n import { hasCustomExportOutput } from '../../export/utils'\n import { Telemetry } from '../../telemetry/storage'\n import { setGlobal } from '../../trace'\n-\n-const IS_TURBOPACK_BUILD = process.env.TURBOPACK && process.env.TURBOPACK_BUILD\n+import { isStableBuild, CanaryOnlyError } from '../../shared/lib/canary-only'\n \n export async function turbopackBuild(): Promise<{\n   duration: number\n   buildTraceContext: undefined\n   shutdownPromise: Promise<void>\n }> {\n-  if (!IS_TURBOPACK_BUILD) {\n-    throw new Error(\"next build doesn't support turbopack yet\")\n+  if (isStableBuild()) {\n+    throw new CanaryOnlyError(\n+      'Turbopack builds are only available in canary builds of Next.js.'\n+    )\n   }\n \n   await validateTurboNextConfig({"
        },
        {
            "sha": "677299d66a15f9774704f0667f24becaec00db17",
            "filename": "packages/next/src/cli/next-build.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/152e54a1711f94c057c8251341c94a1c095f536b/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/152e54a1711f94c057c8251341c94a1c095f536b/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts?ref=152e54a1711f94c057c8251341c94a1c095f536b",
            "patch": "@@ -16,6 +16,8 @@ export type NextBuildOptions = {\n   profile?: boolean\n   lint: boolean\n   mangling: boolean\n+  turbo?: boolean\n+  turbopack?: boolean\n   experimentalDebugMemoryUsage: boolean\n   experimentalAppOnly?: boolean\n   experimentalTurbo?: boolean\n@@ -34,11 +36,13 @@ const nextBuild = (options: NextBuildOptions, directory?: string) => {\n     lint,\n     mangling,\n     experimentalAppOnly,\n-    experimentalTurbo,\n     experimentalBuildMode,\n     experimentalUploadTrace,\n   } = options\n \n+  const useTurbopack =\n+    options.experimentalTurbo || options.turbo || options.turbopack\n+\n   let traceUploadUrl: string | undefined\n   if (experimentalUploadTrace && !process.env.NEXT_TRACE_UPLOAD_DISABLED) {\n     traceUploadUrl = experimentalUploadTrace\n@@ -71,7 +75,7 @@ const nextBuild = (options: NextBuildOptions, directory?: string) => {\n     printAndExit(`> No such directory exists as the project root: ${dir}`)\n   }\n \n-  if (experimentalTurbo) {\n+  if (useTurbopack) {\n     process.env.TURBOPACK = '1'\n   }\n "
        }
    ],
    "stats": {
        "total": 22,
        "additions": 15,
        "deletions": 7
    }
}