{
    "author": "gnoff",
    "message": "[dynamicIO] Do not use `React.unstable_postpone()` (#81652)\n\ndynamicIO does not rely on Postponing for any prerender reason. This is\nan experimental only API with no clear path to stailization. To make\ndynamicIO supportable with stable React we should eliminate use of this\nAPI.\n\nThis change replaces the postpone value when aborting the resume of a\nprerender we want to complete even when it had a postponed state with\nthe already existing BailoutToCSRError error subclass.\n\nWe already have plumbing in place to ignore this error on the client\nwhen hydrating which is exactly what we want to achieve here.",
    "sha": "0a220665f5ddd4104e42ccb5db3e1166f1970c1b",
    "files": [
        {
            "sha": "d858690ae3847abf1fe92020e9f389ab9cf4c46c",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0a220665f5ddd4104e42ccb5db3e1166f1970c1b/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/0a220665f5ddd4104e42ccb5db3e1166f1970c1b/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=0a220665f5ddd4104e42ccb5db3e1166f1970c1b",
            "patch": "@@ -718,5 +718,6 @@\n   \"717\": \"Unsupported environment condition \\\"%s\\\" and react condition \\\"%s\\\". This is a bug in Next.js.\",\n   \"718\": \"Invariant: projectDir is required for node runtime\",\n   \"719\": \"Failed to get source map for '%s'. This is a bug in Next.js\",\n-  \"720\": \"A client prerender store should not be used for a route handler.\"\n+  \"720\": \"A client prerender store should not be used for a route handler.\",\n+  \"721\": \"Render in Browser\"\n }"
        },
        {
            "sha": "6a8e744f2e8de264140dc8c9362fdaca95dc2253",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/0a220665f5ddd4104e42ccb5db3e1166f1970c1b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0a220665f5ddd4104e42ccb5db3e1166f1970c1b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=0a220665f5ddd4104e42ccb5db3e1166f1970c1b",
            "patch": "@@ -125,7 +125,7 @@ import {\n import { getStackWithoutErrorMessage } from '../../lib/format-server-error'\n import {\n   accessedDynamicData,\n-  createPostponedAbortSignal,\n+  createRenderInBrowserAbortSignal,\n   formatDynamicAPIAccesses,\n   isPrerenderInterruptedError,\n   createDynamicTrackingState,\n@@ -3423,7 +3423,7 @@ async function prerenderToStream(\n             />,\n             JSON.parse(JSON.stringify(postponed)),\n             {\n-              signal: createPostponedAbortSignal('static prerender resume'),\n+              signal: createRenderInBrowserAbortSignal(),\n               onError: htmlRendererErrorHandler,\n               nonce,\n             }\n@@ -3660,7 +3660,7 @@ async function prerenderToStream(\n             />,\n             JSON.parse(JSON.stringify(postponed)),\n             {\n-              signal: createPostponedAbortSignal('static prerender resume'),\n+              signal: createRenderInBrowserAbortSignal(),\n               onError: htmlRendererErrorHandler,\n               nonce,\n             }"
        },
        {
            "sha": "7165ef6e15882bfd44bb3ad304a28e0696abb62b",
            "filename": "packages/next/src/server/app-render/dynamic-rendering.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/0a220665f5ddd4104e42ccb5db3e1166f1970c1b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0a220665f5ddd4104e42ccb5db3e1166f1970c1b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts?ref=0a220665f5ddd4104e42ccb5db3e1166f1970c1b",
            "patch": "@@ -42,6 +42,7 @@ import {\n   OUTLET_BOUNDARY_NAME,\n } from '../../lib/metadata/metadata-constants'\n import { scheduleOnNextTick } from '../../lib/scheduler'\n+import { BailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n \n const hasPostpone = typeof React.unstable_postpone === 'function'\n \n@@ -495,15 +496,9 @@ function assertPostpone() {\n  * This is a bit of a hack to allow us to abort a render using a Postpone instance instead of an Error which changes React's\n  * abort semantics slightly.\n  */\n-export function createPostponedAbortSignal(reason: string): AbortSignal {\n-  assertPostpone()\n+export function createRenderInBrowserAbortSignal(): AbortSignal {\n   const controller = new AbortController()\n-  // We get our hands on a postpone instance by calling postpone and catching the throw\n-  try {\n-    React.unstable_postpone(reason)\n-  } catch (x: unknown) {\n-    controller.abort(x)\n-  }\n+  controller.abort(new BailoutToCSRError('Render in Browser'))\n   return controller.signal\n }\n "
        }
    ],
    "stats": {
        "total": 20,
        "additions": 8,
        "deletions": 12
    }
}