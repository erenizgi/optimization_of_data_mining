{
    "author": "lubieowoce",
    "message": "fix: remove useless set-cookie in action-handler (#76839)\n\n`handleAction` had a weird spot where it'd add a `set-cookie` header if\na redirect was thrown during handling a no-js action. AFAICT, this is\nunnecessary -- we set the `set-cookie` header on the response as soon as\n`cookies().set()` is called, so there's no need to set the cookies again\nin that branch of the handler.\n\nthis is done through a combination of the patched setter from\n`RequestCookies`:\n\nhttps://github.com/vercel/next.js/blob/0abd87717f19bced6c35af1255837628513cf772/packages/next/src/server/web/spec-extension/adapters/request-cookies.ts#L160-L171\nand this cookie updating function from the request store (which\n`updateResponseCookies` above would invoke with the new cookies):\n\nhttps://github.com/vercel/next.js/blob/0abd87717f19bced6c35af1255837628513cf772/packages/next/src/server/async-storage/request-store.ts#L170-L174\n\ni've also added a test for this specific scenario to ensure that this\nwasn't actually doing anything useful.",
    "sha": "fb67605d2643999ed324badf049a9a6e80cd26e6",
    "files": [
        {
            "sha": "e08d15399c05c4ead3fe6f31897bcd223d697269",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 11,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/fb67605d2643999ed324badf049a9a6e80cd26e6/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fb67605d2643999ed324badf049a9a6e80cd26e6/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=fb67605d2643999ed324badf049a9a6e80cd26e6",
            "patch": "@@ -30,10 +30,7 @@ import {\n   filterReqHeaders,\n   actionsForbiddenHeaders,\n } from '../lib/server-ipc/utils'\n-import {\n-  appendMutableCookies,\n-  getModifiedCookieValues,\n-} from '../web/spec-extension/adapters/request-cookies'\n+import { getModifiedCookieValues } from '../web/spec-extension/adapters/request-cookies'\n \n import {\n   NEXT_CACHE_REVALIDATED_TAGS_HEADER,\n@@ -976,13 +973,6 @@ export async function handleAction({\n         }\n       }\n \n-      // If there were mutable cookies set, we need to set them on the\n-      // response.\n-      const headers = new Headers()\n-      if (appendMutableCookies(headers, requestStore.mutableCookies)) {\n-        res.setHeader('set-cookie', Array.from(headers.values()))\n-      }\n-\n       res.setHeader('Location', redirectUrl)\n       return {\n         type: 'done',"
        },
        {
            "sha": "3c5d749dc04eb9abae47de35a4ba1017cc37785f",
            "filename": "test/e2e/app-dir/actions/app-action.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/fb67605d2643999ed324badf049a9a6e80cd26e6/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fb67605d2643999ed324badf049a9a6e80cd26e6/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts?ref=fb67605d2643999ed324badf049a9a6e80cd26e6",
            "patch": "@@ -175,6 +175,27 @@ describe('app-dir action handling', () => {\n     })\n   })\n \n+  it.each([\n+    { description: 'with javascript', disableJavaScript: false },\n+    { description: 'no javascript', disableJavaScript: true },\n+  ])(\n+    'should support setting cookies when redirecting ($description)',\n+    async ({ disableJavaScript }) => {\n+      const browser = await next.browser('/mutate-cookie-with-redirect', {\n+        disableJavaScript,\n+      })\n+      expect(await browser.elementByCss('#value').text()).toBe('')\n+\n+      await browser.elementByCss('#update-cookie').click()\n+      await browser.elementByCss('#redirect-target')\n+\n+      expect(await browser.elementByCss('#value').text()).toMatch(/\\d+/)\n+      expect(await browser.eval('document.cookie')).toMatch(\n+        /(?:^|(?:; ))testCookie=\\d+/\n+      )\n+    }\n+  )\n+\n   it('should push new route when redirecting', async () => {\n     const browser = await next.browser('/header')\n "
        },
        {
            "sha": "c561f5a559362b051422baccac04f6529779ce09",
            "filename": "test/e2e/app-dir/actions/app/mutate-cookie-with-redirect/page.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/fb67605d2643999ed324badf049a9a6e80cd26e6/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fmutate-cookie-with-redirect%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/fb67605d2643999ed324badf049a9a6e80cd26e6/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fmutate-cookie-with-redirect%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fmutate-cookie-with-redirect%2Fpage.js?ref=fb67605d2643999ed324badf049a9a6e80cd26e6",
            "patch": "@@ -0,0 +1,21 @@\n+import { cookies } from 'next/headers'\n+import { redirect } from 'next/navigation'\n+\n+async function updateCookieAndRedirect() {\n+  'use server'\n+  ;(await cookies()).set('testCookie', Date.now())\n+  redirect('/mutate-cookie-with-redirect/redirect-target')\n+}\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p id=\"value\">{(await cookies()).get('testCookie')?.value ?? null}</p>\n+      <form action={updateCookieAndRedirect}>\n+        <button id=\"update-cookie\" type=\"submit\">\n+          Update Cookie\n+        </button>\n+      </form>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "e4bd72c12affc0bc3027ec76eb157fcc10a29ead",
            "filename": "test/e2e/app-dir/actions/app/mutate-cookie-with-redirect/redirect-target/page.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/fb67605d2643999ed324badf049a9a6e80cd26e6/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fmutate-cookie-with-redirect%2Fredirect-target%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/fb67605d2643999ed324badf049a9a6e80cd26e6/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fmutate-cookie-with-redirect%2Fredirect-target%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fmutate-cookie-with-redirect%2Fredirect-target%2Fpage.js?ref=fb67605d2643999ed324badf049a9a6e80cd26e6",
            "patch": "@@ -0,0 +1,9 @@\n+import { cookies } from 'next/headers'\n+\n+export default async function Page() {\n+  return (\n+    <div id=\"redirect-target\">\n+      <p id=\"value\">{(await cookies()).get('testCookie')?.value ?? null}</p>\n+    </div>\n+  )\n+}"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 52,
        "deletions": 11
    }
}