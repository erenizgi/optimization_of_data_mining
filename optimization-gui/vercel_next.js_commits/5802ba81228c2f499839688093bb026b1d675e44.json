{
    "author": "timneutkens",
    "message": "Turbopack Build: Implement browserslist for CSS / JS (#80603)\n\n## What?\n\nImplement browserslist for CSS / JS handling in Turbopack.\n\nFor JS it's not fully implemented yet, but for CSS it should be good\nnow.",
    "sha": "5802ba81228c2f499839688093bb026b1d675e44",
    "files": [
        {
            "sha": "4e978cf3ba4545bec98c3af98bbabf885b27ba44",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 6,
            "deletions": 10,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -3606,11 +3606,11 @@ dependencies = [\n [[package]]\n name = \"lightningcss\"\n version = \"1.0.0-alpha.66\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"9a73ffa17de66534e4b527232f44aa0a89fad22c4f4e0735f9be35494f058e54\"\n+source = \"git+https://github.com/timneutkens/lightningcss?branch=add%2Fbrowserslist-options#4e73e2321bd50d254aa81556f7ff2c4f7ac95da8\"\n dependencies = [\n  \"ahash 0.8.11\",\n  \"bitflags 2.9.0\",\n+ \"browserslist-rs\",\n  \"const-str\",\n  \"cssparser\",\n  \"cssparser-color\",\n@@ -3634,8 +3634,7 @@ dependencies = [\n [[package]]\n name = \"lightningcss-derive\"\n version = \"1.0.0-alpha.43\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"84c12744d1279367caed41739ef094c325d53fb0ffcd4f9b84a368796f870252\"\n+source = \"git+https://github.com/timneutkens/lightningcss?branch=add%2Fbrowserslist-options#4e73e2321bd50d254aa81556f7ff2c4f7ac95da8\"\n dependencies = [\n  \"convert_case\",\n  \"proc-macro2\",\n@@ -4801,8 +4800,7 @@ dependencies = [\n [[package]]\n name = \"parcel_selectors\"\n version = \"0.28.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"54fd03f1ad26cb6b3ec1b7414fa78a3bd639e7dbb421b1a60513c96ce886a196\"\n+source = \"git+https://github.com/timneutkens/lightningcss?branch=add%2Fbrowserslist-options#4e73e2321bd50d254aa81556f7ff2c4f7ac95da8\"\n dependencies = [\n  \"bitflags 2.9.0\",\n  \"cssparser\",\n@@ -6768,8 +6766,7 @@ dependencies = [\n [[package]]\n name = \"static-self\"\n version = \"0.1.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"f6635404b73efc136af3a7956e53c53d4f34b2f16c95a15c438929add0f69412\"\n+source = \"git+https://github.com/timneutkens/lightningcss?branch=add%2Fbrowserslist-options#4e73e2321bd50d254aa81556f7ff2c4f7ac95da8\"\n dependencies = [\n  \"indexmap 2.7.1\",\n  \"smallvec\",\n@@ -6779,8 +6776,7 @@ dependencies = [\n [[package]]\n name = \"static-self-derive\"\n version = \"0.1.1\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"5268c96d4b907c558a9a52d8492522d6c7b559651a5e1d8f2d551e461b9425d5\"\n+source = \"git+https://github.com/timneutkens/lightningcss?branch=add%2Fbrowserslist-options#4e73e2321bd50d254aa81556f7ff2c4f7ac95da8\"\n dependencies = [\n  \"proc-macro2\",\n  \"quote\","
        },
        {
            "sha": "a2510f43c2cdb55d031b9b52afbd8a9cdfec1b80",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -362,6 +362,7 @@ lightningcss = { version = \"1.0.0-alpha.66\", features = [\n   \"serde\",\n   \"visitor\",\n   \"into_owned\",\n+  \"browserslist\"\n ] }\n lightningcss-napi = { version = \"0.4.4\", default-features = false, features = [\n   \"visitor\",\n@@ -434,4 +435,6 @@ vergen-gitcl = { version = \"1.0.8\", features = [\n webbrowser = \"0.8.7\"\n \n [patch.crates-io]\n+lightningcss = { git = \"https://github.com/timneutkens/lightningcss\", branch = \"add/browserslist-options\"}\n+parcel_selectors = { git = \"https://github.com/timneutkens/lightningcss\", branch = \"add/browserslist-options\"}\n mdxjs = { git = \"https://github.com/kdy1/mdxjs-rs.git\", branch = \"swc-core-29\" }"
        },
        {
            "sha": "574dba0e82d53dba1d1abc461d392ae51dae0708",
            "filename": "crates/next-api/benches/hmr.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-api%2Fbenches%2Fhmr.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-api%2Fbenches%2Fhmr.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fbenches%2Fhmr.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -1,6 +1,7 @@\n extern crate turbo_tasks_malloc;\n \n use std::{\n+    env,\n     fs::{create_dir_all, write},\n     mem::forget,\n     path::{Path, PathBuf},\n@@ -183,7 +184,10 @@ impl HmrBenchmark {\n                 project_path: RcStr::from(project_path.clone()),\n                 next_config: load_next_config(),\n                 js_config: RcStr::from(\"{}\"),\n-                env: vec![],\n+                env: vec![(\n+                    RcStr::from(\"PATH\"),\n+                    RcStr::from(env::var(\"PATH\").unwrap_or_default()),\n+                )],\n                 define_env: DefineEnv {\n                     client: vec![],\n                     edge: vec![],"
        },
        {
            "sha": "74831503363b0ba8ccbf8d1e0f872ef70adbd639",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -242,6 +242,7 @@ impl AppProject {\n             self.project().next_config(),\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n+            self.project().server_compile_time_info().environment(),\n         ))\n     }\n \n@@ -255,6 +256,7 @@ impl AppProject {\n             self.project().next_config(),\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n+            self.project().edge_compile_time_info().environment(),\n         ))\n     }\n \n@@ -268,6 +270,7 @@ impl AppProject {\n             self.project().next_config(),\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n+            self.project().server_compile_time_info().environment(),\n         ))\n     }\n \n@@ -281,6 +284,7 @@ impl AppProject {\n             self.project().next_config(),\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n+            self.project().edge_compile_time_info().environment(),\n         ))\n     }\n \n@@ -592,6 +596,7 @@ impl AppProject {\n             self.project().next_config(),\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n+            self.project().server_compile_time_info().environment(),\n         ))\n     }\n \n@@ -605,6 +610,7 @@ impl AppProject {\n             self.project().next_config(),\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n+            self.project().edge_compile_time_info().environment(),\n         ))\n     }\n "
        },
        {
            "sha": "0f02a3346ef0816031d94829aacd96a06e868f82",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -450,6 +450,7 @@ impl PagesProject {\n             self.project().next_config(),\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n+            self.project().server_compile_time_info().environment(),\n         ))\n     }\n \n@@ -465,6 +466,7 @@ impl PagesProject {\n             self.project().next_config(),\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n+            self.project().edge_compile_time_info().environment(),\n         ))\n     }\n \n@@ -480,6 +482,7 @@ impl PagesProject {\n             self.project().next_config(),\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n+            self.project().server_compile_time_info().environment(),\n         ))\n     }\n \n@@ -495,6 +498,7 @@ impl PagesProject {\n             self.project().next_config(),\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n+            self.project().edge_compile_time_info().environment(),\n         ))\n     }\n \n@@ -510,6 +514,7 @@ impl PagesProject {\n             self.project().next_config(),\n             NextRuntime::NodeJs,\n             self.project().encryption_key(),\n+            self.project().server_compile_time_info().environment(),\n         ))\n     }\n \n@@ -527,6 +532,7 @@ impl PagesProject {\n             self.project().next_config(),\n             NextRuntime::Edge,\n             self.project().encryption_key(),\n+            self.project().edge_compile_time_info().environment(),\n         ))\n     }\n "
        },
        {
            "sha": "2d331bb671384726d7c9b20432b8e726e70d81ee",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -986,6 +986,7 @@ impl Project {\n         Ok(get_edge_compile_time_info(\n             self.project_path(),\n             this.define_env.edge(),\n+            self.env(),\n         ))\n     }\n \n@@ -1306,6 +1307,7 @@ impl Project {\n                 self.next_config(),\n                 NextRuntime::Edge,\n                 self.encryption_key(),\n+                self.edge_compile_time_info().environment(),\n             ),\n             get_edge_resolve_options_context(\n                 self.project_path(),\n@@ -1361,6 +1363,7 @@ impl Project {\n                 self.next_config(),\n                 NextRuntime::NodeJs,\n                 self.encryption_key(),\n+                self.server_compile_time_info().environment(),\n             ),\n             get_server_resolve_options_context(\n                 self.project_path(),\n@@ -1473,6 +1476,7 @@ impl Project {\n                 self.next_config(),\n                 NextRuntime::NodeJs,\n                 self.encryption_key(),\n+                self.server_compile_time_info().environment(),\n             ),\n             get_server_resolve_options_context(\n                 self.project_path(),\n@@ -1528,6 +1532,7 @@ impl Project {\n                 self.next_config(),\n                 NextRuntime::Edge,\n                 self.encryption_key(),\n+                self.edge_compile_time_info().environment(),\n             ),\n             get_edge_resolve_options_context(\n                 self.project_path(),"
        },
        {
            "sha": "374c689dfa946e96c4cda5c67824c1bd37c09771",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -342,7 +342,7 @@ pub async fn get_client_module_options_context(\n             source_maps,\n             ..Default::default()\n         },\n-        preset_env_versions: Some(env),\n+        environment: Some(env),\n         execution_context: Some(execution_context),\n         tree_shaking_mode: tree_shaking_mode_for_user_code,\n         enable_postcss_transform,"
        },
        {
            "sha": "7f77d9dc40fcc2da48ea2c3df0e1c32ef22f4ab9",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -1,7 +1,7 @@\n use anyhow::Result;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{FxIndexMap, OptionVcExt, ResolvedVc, Vc};\n-use turbo_tasks_env::EnvMap;\n+use turbo_tasks_env::{EnvMap, ProcessEnv};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::{css::chunk::CssChunkType, resolve_options_context::ResolveOptionsContext};\n use turbopack_browser::BrowserChunkingContext;\n@@ -14,7 +14,7 @@ use turbopack_core::{\n         CompileTimeDefineValue, CompileTimeDefines, CompileTimeInfo, DefineableNameSegment,\n         FreeVarReference, FreeVarReferences,\n     },\n-    environment::{EdgeWorkerEnvironment, Environment, ExecutionEnvironment},\n+    environment::{EdgeWorkerEnvironment, Environment, ExecutionEnvironment, NodeJsVersion},\n     free_var_references,\n };\n use turbopack_ecmascript::chunk::EcmascriptChunkType;\n@@ -83,10 +83,16 @@ async fn next_edge_free_vars(\n pub async fn get_edge_compile_time_info(\n     project_path: Vc<FileSystemPath>,\n     define_env: Vc<EnvMap>,\n+    process_env: Vc<Box<dyn ProcessEnv>>,\n ) -> Result<Vc<CompileTimeInfo>> {\n     CompileTimeInfo::builder(\n         Environment::new(ExecutionEnvironment::EdgeWorker(\n-            EdgeWorkerEnvironment {}.resolved_cell(),\n+            EdgeWorkerEnvironment {\n+                node_version: NodeJsVersion::resolved_cell(NodeJsVersion::Current(\n+                    process_env.to_resolved().await?,\n+                )),\n+            }\n+            .resolved_cell(),\n         ))\n         .to_resolved()\n         .await?,"
        },
        {
            "sha": "905ffe1f50a03c4fd7f48264881d85bfdae639e4",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -414,6 +414,7 @@ pub async fn get_server_module_options_context(\n     next_config: Vc<NextConfig>,\n     next_runtime: NextRuntime,\n     encryption_key: ResolvedVc<RcStr>,\n+    environment: ResolvedVc<Environment>,\n ) -> Result<Vc<ModuleOptionsContext>> {\n     let next_mode = mode.await?;\n     let mut next_server_rules = get_next_server_transforms_rules(\n@@ -553,6 +554,7 @@ pub async fn get_server_module_options_context(\n             ..Default::default()\n         },\n         execution_context: Some(execution_context),\n+        environment: Some(environment),\n         css: CssOptionsContext {\n             source_maps,\n             ..Default::default()"
        },
        {
            "sha": "68c3c5e8a40b87c47b96988a742888796a01fae1",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -28,7 +28,7 @@ export function lightningCssTransformStyleAttribute(\n \n /* auto-generated by NAPI-RS */\n \n-export class ExternalObject<T> {\n+export declare class ExternalObject<T> {\n   readonly '': {\n     readonly '': unique symbol\n     [K: symbol]: T"
        },
        {
            "sha": "cc6decbbe0c1a0cb16328b4dfb5b72c755d4ff1f",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -21,6 +21,7 @@ import { Telemetry } from '../../telemetry/storage'\n import { setGlobal } from '../../trace'\n import { isCI } from '../../server/ci-info'\n import { backgroundLogCompilationEvents } from '../../shared/lib/turbopack/compilation-events'\n+import { getSupportedBrowsers } from '../utils'\n \n export async function turbopackBuild(): Promise<{\n   duration: number\n@@ -47,10 +48,7 @@ export async function turbopackBuild(): Promise<{\n   const bindings = await loadBindings(config?.experimental?.useWasmBinary)\n   const dev = false\n \n-  // const supportedBrowsers = await getSupportedBrowsers(dir, dev)\n-  const supportedBrowsers = [\n-    'last 1 Chrome versions, last 1 Firefox versions, last 1 Safari versions, last 1 Edge versions',\n-  ]\n+  const supportedBrowsers = await getSupportedBrowsers(dir, dev)\n \n   const persistentCaching = isPersistentCachingEnabled(config)\n   const project = await bindings.turbo.createProject("
        },
        {
            "sha": "869dfcb099166030f6140032e270730e74f78e28",
            "filename": "test/development/basic/next-rs-api.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -197,7 +197,9 @@ describe('next.rs api', () => {\n       '.next'\n     )\n     project = await bindings.turbo.createProject({\n-      env: {},\n+      env: {\n+        PATH: process.env.PATH,\n+      },\n       jsConfig: {\n         compilerOptions: {},\n       },"
        },
        {
            "sha": "2419e1e1a2fe30adb7cddc404b0dc454193dcdb6",
            "filename": "test/e2e/next-font/index.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/test%2Fe2e%2Fnext-font%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/test%2Fe2e%2Fnext-font%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-font%2Findex.test.ts?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -310,21 +310,21 @@ describe('next/font', () => {\n         await browser.eval(\n           'getComputedStyle(document.querySelector(\"#with-fallback-fonts-classname\")).fontFamily'\n         )\n-      ).toMatch(/^\"Open Sans\", system-ui, Arial$/)\n+      ).toMatch(/^\"Open Sans\", .*system-ui.*, Arial$/)\n \n       // .style\n       expect(\n         await browser.eval(\n           'getComputedStyle(document.querySelector(\"#with-fallback-fonts-style\")).fontFamily'\n         )\n-      ).toMatch(/^\"Open Sans\", system-ui, Arial$/)\n+      ).toMatch(/^\"Open Sans\", .*system-ui.*, Arial$/)\n \n       // .variable\n       expect(\n         await browser.eval(\n           'getComputedStyle(document.querySelector(\"#with-fallback-fonts-variable\")).fontFamily'\n         )\n-      ).toMatch(/^\"Open Sans\", system-ui, Arial$/)\n+      ).toMatch(/^\"Open Sans\", .*system-ui.*, Arial$/)\n     })\n   })\n "
        },
        {
            "sha": "b5cfaba07158df493365377f990a7c9cc40d3a70",
            "filename": "test/integration/css-features/test/browserslist.test.js",
            "status": "modified",
            "additions": 18,
            "deletions": 6,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/test%2Fintegration%2Fcss-features%2Ftest%2Fbrowserslist.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/test%2Fintegration%2Fcss-features%2Ftest%2Fbrowserslist.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-features%2Ftest%2Fbrowserslist.test.js?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -54,9 +54,15 @@ describe('Browserslist: Old', () => {\n           .replace(/\\/\\*.*?\\*\\/\\n?/g, '')\n           .trim()\n \n-        expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n-          `\"a{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:none;border-collapse:separate;-webkit-border-image:none;border-image:none;-webkit-border-radius:0;border-radius:0;border-spacing:0;bottom:auto;-webkit-box-shadow:none;box-shadow:none;-webkit-box-sizing:content-box;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-webkit-column-count:auto;-webkit-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;column-span:1;-webkit-column-width:auto;columns:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc none outside;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}@media (-webkit-min-device-pixel-ratio:2),(min-resolution:2dppx){.image{background-image:url(data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==)}}\"`\n-        )\n+        if (process.env.IS_TURBOPACK_TEST) {\n+          expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n+            `\"a{all:initial}@media (-webkit-min-device-pixel-ratio:2),(min-resolution:2dppx){.image{background-image:url(data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==)}}\"`\n+          )\n+        } else {\n+          expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n+            `\"a{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:none;border-collapse:separate;-webkit-border-image:none;border-image:none;-webkit-border-radius:0;border-radius:0;border-spacing:0;bottom:auto;-webkit-box-shadow:none;box-shadow:none;-webkit-box-sizing:content-box;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-webkit-column-count:auto;-webkit-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;column-span:1;-webkit-column-width:auto;columns:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc none outside;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}@media (-webkit-min-device-pixel-ratio:2),(min-resolution:2dppx){.image{background-image:url(data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==)}}\"`\n+          )\n+        }\n       })\n     }\n   )\n@@ -102,9 +108,15 @@ describe('Browserslist: New', () => {\n           .replace(/\\/\\*.*?\\*\\/\\n?/g, '')\n           .trim()\n \n-        expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n-          `\"a{all:initial}@media (min-resolution:2dppx){.image{background-image:url(data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==)}}\"`\n-        )\n+        if (process.env.IS_TURBOPACK_TEST) {\n+          expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n+            `\"a{all:initial}@media (resolution>=2x){.image{background-image:url(data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==)}}\"`\n+          )\n+        } else {\n+          expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n+            `\"a{all:initial}@media (min-resolution:2dppx){.image{background-image:url(data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==)}}\"`\n+          )\n+        }\n       })\n     }\n   )"
        },
        {
            "sha": "7145de319841b999de6bb5bedeb4e0466b95ff3c",
            "filename": "test/integration/css-modules/test/index.test.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -137,7 +137,7 @@ describe('3rd Party CSS Module Support', () => {\n           expect(\n             cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n           ).toMatchInlineSnapshot(\n-            `\".index-module__jAE1EW__foo{position:relative}.index-module__jAE1EW__foo .bar,.index-module__jAE1EW__foo .baz{height:100%;overflow:hidden}.index-module__jAE1EW__foo .lol{width:80%}.index-module__jAE1EW__foo>.lel{width:80%}\"`\n+            `\".index-module__jAE1EW__foo{position:relative}.index-module__jAE1EW__foo .bar{height:100%;overflow:hidden}.index-module__jAE1EW__foo .baz{height:100%;overflow:hidden}.index-module__jAE1EW__foo .lol{width:80%}.index-module__jAE1EW__foo>.lel{width:80%}\"`\n           )\n         } else {\n           expect("
        },
        {
            "sha": "7fc609fe925e58ce3edea28a921a971959b5a1e2",
            "filename": "test/integration/css/test/css-compilation.test.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.js?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -79,11 +79,11 @@ module.exports = {\n \n               if (process.env.IS_TURBOPACK_TEST && useLightningcss) {\n                 expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n-                  `\"@media (480px<=width<768px){::placeholder{color:green}}.flex-parsing{flex:0 0 calc(50% - var(--vertical-gutter))}.transform-parsing{transform:translate3d(0px,0px)}.css-grid-shorthand{grid-column:span 2}.g-docs-sidenav .filter::-webkit-input-placeholder{opacity:.8}\"`\n+                  `\"@media (min-width:480px) and (not (min-width:768px)){::placeholder{color:green}}.flex-parsing{flex:0 0 calc(50% - var(--vertical-gutter))}.transform-parsing{transform:translate3d(0px,0px)}.css-grid-shorthand{grid-column:span 2}.g-docs-sidenav .filter::-webkit-input-placeholder{opacity:.8}\"`\n                 )\n               } else if (process.env.IS_TURBOPACK_TEST && !useLightningcss) {\n                 expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n-                  `\"@media (480px<=width<768px){::placeholder{color:green}}.flex-parsing{flex:0 0 calc(50% - var(--vertical-gutter))}.transform-parsing{transform:translate3d(0px,0px)}.css-grid-shorthand{grid-column:span 2}.g-docs-sidenav .filter::-webkit-input-placeholder{opacity:.8}\"`\n+                  `\"@media (min-width:480px) and (not (min-width:768px)){::placeholder{color:green}}.flex-parsing{flex:0 0 calc(50% - var(--vertical-gutter))}.transform-parsing{transform:translate3d(0px,0px)}.css-grid-shorthand{grid-column:span 2}.g-docs-sidenav .filter::-webkit-input-placeholder{opacity:.8}\"`\n                 )\n               } else if (useLightningcss) {\n                 expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n@@ -119,7 +119,7 @@ module.exports = {\n               if (process.env.IS_TURBOPACK_TEST && useLightningcss) {\n                 expect(sourceMapContentParsed).toMatchInlineSnapshot(`\n                  {\n-                   \"mappings\": \"AAAA,4BACE,2BAKF,0DAIA,kDAIA,uCAIA\",\n+                   \"mappings\": \"AAAA,qDACE,2BAKF,0DAIA,kDAIA,uCAIA\",\n                    \"names\": [],\n                    \"sourcesContent\": [\n                      \"@media (480px <= width < 768px) {\n@@ -151,7 +151,7 @@ module.exports = {\n               } else if (process.env.IS_TURBOPACK_TEST && !useLightningcss) {\n                 expect(sourceMapContentParsed).toMatchInlineSnapshot(`\n                  {\n-                   \"mappings\": \"AAAA,4BACE,2BAKF,0DAIA,kDAIA,uCAIA\",\n+                   \"mappings\": \"AAAA,qDACE,2BAKF,0DAIA,kDAIA,uCAIA\",\n                    \"names\": [],\n                    \"sourcesContent\": [\n                      \"@media (480px <= width < 768px) {"
        },
        {
            "sha": "db1d1533a045505d06a5132c688bf28c8d8831df",
            "filename": "turbopack/crates/turbopack-cli/src/contexts.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -111,7 +111,7 @@ async fn get_client_module_options_context(\n ) -> Result<Vc<ModuleOptionsContext>> {\n     let is_dev = matches!(*node_env.await?, NodeEnv::Development);\n     let module_options_context = ModuleOptionsContext {\n-        preset_env_versions: Some(env),\n+        environment: Some(env),\n         execution_context: Some(execution_context),\n         tree_shaking_mode: Some(TreeShakingMode::ReexportsOnly),\n         keep_last_successful_parse: is_dev,"
        },
        {
            "sha": "310744149231b8195d9132d9d0dcdc3dbc6131df",
            "filename": "turbopack/crates/turbopack-core/src/environment.rs",
            "status": "modified",
            "additions": 57,
            "deletions": 6,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -4,6 +4,7 @@ use std::{\n };\n \n use anyhow::{Context, Result, anyhow};\n+use browserslist::Distrib;\n use swc_core::ecma::preset_env::{Version, Versions};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, TaskInput, Vc};\n@@ -62,6 +63,16 @@ pub enum ExecutionEnvironment {\n     Custom(u8),\n }\n \n+async fn resolve_browserslist(browser_env: ResolvedVc<BrowserEnvironment>) -> Result<Vec<Distrib>> {\n+    Ok(browserslist::resolve(\n+        browser_env.await?.browserslist_query.split(','),\n+        &browserslist::Opts {\n+            ignore_unknown_versions: true,\n+            ..Default::default()\n+        },\n+    )?)\n+}\n+\n #[turbo_tasks::value_impl]\n impl Environment {\n     #[turbo_tasks::function]\n@@ -81,12 +92,31 @@ impl Environment {\n             ExecutionEnvironment::NodeJsBuildTime(node_env, ..)\n             | ExecutionEnvironment::NodeJsLambda(node_env) => node_env.runtime_versions(),\n             ExecutionEnvironment::Browser(browser_env) => {\n-                Vc::cell(Versions::parse_versions(browserslist::resolve(\n-                    browser_env.await?.browserslist_query.split(','),\n-                    &browserslist::Opts::default(),\n-                )?)?)\n+                let distribs = resolve_browserslist(browser_env).await?;\n+                Vc::cell(Versions::parse_versions(distribs)?)\n+            }\n+            ExecutionEnvironment::EdgeWorker(edge_env) => edge_env.runtime_versions(),\n+            ExecutionEnvironment::Custom(_) => todo!(),\n+        })\n+    }\n+\n+    #[turbo_tasks::function]\n+    pub async fn browserslist_query(&self) -> Result<Vc<RcStr>> {\n+        Ok(match self.execution {\n+            ExecutionEnvironment::NodeJsBuildTime(_)\n+            | ExecutionEnvironment::NodeJsLambda(_)\n+            | ExecutionEnvironment::EdgeWorker(_) =>\n+            // TODO: This is a hack, browserslist_query is only used by CSS processing for\n+            // LightningCSS However, there is an issue where the CSS is not transitioned\n+            // to the client which we still have to solve. It does apply the\n+            // browserslist correctly because CSS Modules in client components is double-processed,\n+            // once for server once for browser.\n+            {\n+                Vc::cell(\"\".into())\n+            }\n+            ExecutionEnvironment::Browser(browser_env) => {\n+                Vc::cell(browser_env.await?.browserslist_query.clone())\n             }\n-            ExecutionEnvironment::EdgeWorker(_) => todo!(),\n             ExecutionEnvironment::Custom(_) => todo!(),\n         })\n     }\n@@ -292,7 +322,28 @@ pub struct BrowserEnvironment {\n }\n \n #[turbo_tasks::value(shared)]\n-pub struct EdgeWorkerEnvironment {}\n+pub struct EdgeWorkerEnvironment {\n+    pub node_version: ResolvedVc<NodeJsVersion>,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl EdgeWorkerEnvironment {\n+    #[turbo_tasks::function]\n+    pub async fn runtime_versions(&self) -> Result<Vc<RuntimeVersions>> {\n+        let str = match *self.node_version.await? {\n+            NodeJsVersion::Current(process_env) => get_current_nodejs_version(*process_env),\n+            NodeJsVersion::Static(version) => *version,\n+        }\n+        .await?;\n+\n+        Ok(Vc::cell(Versions {\n+            node: Some(\n+                Version::from_str(&str).map_err(|_| anyhow!(\"Node.js version parse error\"))?,\n+            ),\n+            ..Default::default()\n+        }))\n+    }\n+}\n \n // TODO preset_env_base::Version implements Serialize/Deserialize incorrectly\n #[turbo_tasks::value(transparent, serialization = \"none\")]"
        },
        {
            "sha": "40987c398a3873d1a75bb715ce8758aaa84a0c3a",
            "filename": "turbopack/crates/turbopack-css/src/asset.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -6,6 +6,7 @@ use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkItem, ChunkType, ChunkableModule, ChunkingContext, MinifyType},\n     context::AssetContext,\n+    environment::Environment,\n     ident::AssetIdent,\n     module::{Module, OptionStyleType, StyleType},\n     module_graph::ModuleGraph,\n@@ -38,6 +39,7 @@ pub struct CssModuleAsset {\n     import_context: Option<ResolvedVc<ImportContext>>,\n     ty: CssModuleAssetType,\n     minify_type: MinifyType,\n+    environment: Option<ResolvedVc<Environment>>,\n }\n \n #[turbo_tasks::value_impl]\n@@ -50,17 +52,19 @@ impl CssModuleAsset {\n         ty: CssModuleAssetType,\n         minify_type: MinifyType,\n         import_context: Option<ResolvedVc<ImportContext>>,\n+        environment: Option<ResolvedVc<Environment>>,\n     ) -> Vc<Self> {\n         Self::cell(CssModuleAsset {\n             source,\n             asset_context,\n             import_context,\n             ty,\n             minify_type,\n+            environment,\n         })\n     }\n \n-    /// Retrns the asset ident of the source without the \"css\" modifier\n+    /// Returns the asset ident of the source without the \"css\" modifier\n     #[turbo_tasks::function]\n     pub fn source_ident(&self) -> Vc<AssetIdent> {\n         self.source.ident()\n@@ -78,17 +82,22 @@ impl ParseCss for CssModuleAsset {\n             Vc::upcast(self),\n             this.import_context.map(|v| *v),\n             this.ty,\n+            this.environment.as_deref().copied(),\n         ))\n     }\n }\n \n #[turbo_tasks::value_impl]\n impl ProcessCss for CssModuleAsset {\n     #[turbo_tasks::function]\n-    fn get_css_with_placeholder(self: Vc<Self>) -> Vc<CssWithPlaceholderResult> {\n+    async fn get_css_with_placeholder(self: Vc<Self>) -> Result<Vc<CssWithPlaceholderResult>> {\n+        let this = self.await?;\n         let parse_result = self.parse_css();\n \n-        process_css_with_placeholder(parse_result)\n+        Ok(process_css_with_placeholder(\n+            parse_result,\n+            this.environment.as_deref().copied(),\n+        ))\n     }\n \n     #[turbo_tasks::function]\n@@ -99,8 +108,9 @@ impl ProcessCss for CssModuleAsset {\n     ) -> Result<Vc<FinalCssResult>> {\n         let process_result = self.get_css_with_placeholder();\n \n+        let this = self.await?;\n         let origin_source_map =\n-            match ResolvedVc::try_sidecast::<Box<dyn GenerateSourceMap>>(self.await?.source) {\n+            match ResolvedVc::try_sidecast::<Box<dyn GenerateSourceMap>>(this.source) {\n                 Some(gsm) => gsm.generate_source_map(),\n                 None => Vc::cell(None),\n             };\n@@ -109,6 +119,7 @@ impl ProcessCss for CssModuleAsset {\n             chunking_context,\n             minify_type,\n             origin_source_map,\n+            this.environment.as_deref().copied(),\n         ))\n     }\n }"
        },
        {
            "sha": "2fd9a479d541a193c2b13cdaf6c5fb15c98259a5",
            "filename": "turbopack/crates/turbopack-css/src/process.rs",
            "status": "modified",
            "additions": 80,
            "deletions": 16,
            "changes": 96,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -3,8 +3,8 @@ use std::sync::{Arc, RwLock};\n use anyhow::{Context, Result, bail};\n use lightningcss::{\n     css_modules::{CssModuleExport, CssModuleExports, Pattern, Segment},\n-    stylesheet::{ParserOptions, PrinterOptions, StyleSheet, ToCssResult},\n-    targets::{Features, Targets},\n+    stylesheet::{MinifyOptions, ParserOptions, PrinterOptions, StyleSheet, ToCssResult},\n+    targets::{BrowserslistConfig, Features, Targets},\n     traits::ToCss,\n     values::url::Url,\n     visit_types,\n@@ -21,6 +21,7 @@ use turbopack_core::{\n     SOURCE_URL_PROTOCOL,\n     asset::{Asset, AssetContent},\n     chunk::{ChunkingContext, MinifyType},\n+    environment::Environment,\n     issue::{\n         Issue, IssueExt, IssueSource, IssueStage, OptionIssueSource, OptionStyledString,\n         StyledString,\n@@ -53,6 +54,51 @@ impl PartialEq for StyleSheetLike<'_, '_> {\n \n pub type CssOutput = (ToCssResult, Option<Rope>);\n \n+#[turbo_tasks::value(transparent, serialization = \"none\", eq = \"manual\")]\n+struct LightningCssTargets(#[turbo_tasks(trace_ignore)] pub Targets);\n+\n+impl PartialEq for LightningCssTargets {\n+    fn eq(&self, _: &Self) -> bool {\n+        false\n+    }\n+}\n+\n+/// Returns the LightningCSS targets for the given browserslist query.\n+#[turbo_tasks::function]\n+async fn get_lightningcss_browser_targets(\n+    environment: Option<ResolvedVc<Environment>>,\n+    handle_nesting: bool,\n+) -> Result<Vc<LightningCssTargets>> {\n+    match environment {\n+        Some(environment) => {\n+            let browserslist_query = (*environment.browserslist_query().await?).clone();\n+            let browserslist_browsers =\n+                lightningcss::targets::Browsers::from_browserslist_with_config(\n+                    browserslist_query.split(','),\n+                    BrowserslistConfig {\n+                        ignore_unknown_versions: true,\n+                        ..Default::default()\n+                    },\n+                )?;\n+\n+            Ok(if handle_nesting {\n+                Vc::cell(Targets {\n+                    browsers: browserslist_browsers,\n+                    include: Features::Nesting,\n+                    ..Default::default()\n+                })\n+            } else {\n+                Vc::cell(Targets {\n+                    browsers: browserslist_browsers,\n+                    ..Default::default()\n+                })\n+            })\n+        }\n+        // Default when empty environment is passed.\n+        None => Ok(Vc::cell(Default::default())),\n+    }\n+}\n+\n impl StyleSheetLike<'_, '_> {\n     pub fn to_static(\n         &self,\n@@ -61,13 +107,14 @@ impl StyleSheetLike<'_, '_> {\n         StyleSheetLike(stylesheet_into_static(&self.0, options))\n     }\n \n-    pub fn to_css(\n+    pub async fn to_css(\n         &self,\n         code: &str,\n         minify_type: MinifyType,\n         enable_srcmap: bool,\n         handle_nesting: bool,\n         mut origin_source_map: Option<parcel_sourcemap::SourceMap>,\n+        environment: Option<ResolvedVc<Environment>>,\n     ) -> Result<CssOutput> {\n         let ss = &self.0;\n         let mut srcmap = if enable_srcmap {\n@@ -76,14 +123,9 @@ impl StyleSheetLike<'_, '_> {\n             None\n         };\n \n-        let targets = if handle_nesting {\n-            Targets {\n-                include: Features::Nesting,\n-                ..Default::default()\n-            }\n-        } else {\n-            Default::default()\n-        };\n+        let targets =\n+            *get_lightningcss_browser_targets(environment.as_deref().copied(), handle_nesting)\n+                .await?;\n \n         let result = ss.to_css(PrinterOptions {\n             minify: matches!(minify_type, MinifyType::Minify { .. }),\n@@ -180,6 +222,7 @@ impl PartialEq for FinalCssResult {\n #[turbo_tasks::function]\n pub async fn process_css_with_placeholder(\n     parse_result: ResolvedVc<ParseCssResult>,\n+    environment: Option<ResolvedVc<Environment>>,\n ) -> Result<Vc<CssWithPlaceholderResult>> {\n     let result = parse_result.await?;\n \n@@ -199,7 +242,9 @@ pub async fn process_css_with_placeholder(\n \n             // We use NoMinify because this is not a final css. We need to replace url references,\n             // and we do final codegen with proper minification.\n-            let (result, _) = stylesheet.to_css(&code, MinifyType::NoMinify, false, false, None)?;\n+            let (result, _) = stylesheet\n+                .to_css(&code, MinifyType::NoMinify, false, false, None, environment)\n+                .await?;\n \n             let exports = result.exports.map(|exports| {\n                 let mut exports = exports.into_iter().collect::<FxIndexMap<_, _>>();\n@@ -229,6 +274,7 @@ pub async fn finalize_css(\n     chunking_context: Vc<Box<dyn ChunkingContext>>,\n     minify_type: MinifyType,\n     origin_source_map: Vc<OptionStringifiedSourceMap>,\n+    environment: Option<ResolvedVc<Environment>>,\n ) -> Result<Vc<FinalCssResult>> {\n     let result = result.await?;\n     match &*result {\n@@ -273,8 +319,16 @@ pub async fn finalize_css(\n                 None\n             };\n \n-            let (result, srcmap) =\n-                stylesheet.to_css(&code, minify_type, true, true, origin_source_map)?;\n+            let (result, srcmap) = stylesheet\n+                .to_css(\n+                    &code,\n+                    minify_type,\n+                    true,\n+                    true,\n+                    origin_source_map,\n+                    environment,\n+                )\n+                .await?;\n \n             Ok(FinalCssResult::Ok {\n                 output_code: result.code,\n@@ -313,6 +367,7 @@ pub async fn parse_css(\n     origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n     import_context: Option<ResolvedVc<ImportContext>>,\n     ty: CssModuleAssetType,\n+    environment: Option<ResolvedVc<Environment>>,\n ) -> Result<Vc<ParseCssResult>> {\n     let span = {\n         let name = source.ident().to_string().await?.to_string();\n@@ -338,6 +393,7 @@ pub async fn parse_css(\n                             origin,\n                             import_context,\n                             ty,\n+                            environment,\n                         )\n                         .await?\n                     }\n@@ -358,6 +414,7 @@ async fn process_content(\n     origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n     import_context: Option<ResolvedVc<ImportContext>>,\n     ty: CssModuleAssetType,\n+    environment: Option<ResolvedVc<Environment>>,\n ) -> Result<Vc<ParseCssResult>> {\n     #[allow(clippy::needless_lifetimes)]\n     fn without_warnings<'o, 'i>(config: ParserOptions<'o, 'i>) -> ParserOptions<'o, 'static> {\n@@ -452,13 +509,20 @@ async fn process_content(\n                     }\n                 }\n \n+                let targets =\n+                    *get_lightningcss_browser_targets(environment.as_deref().copied(), true)\n+                        .await?;\n+\n                 // minify() is actually transform, and it performs operations like CSS modules\n                 // handling.\n                 //\n                 //\n                 // See: https://github.com/parcel-bundler/lightningcss/issues/935#issuecomment-2739325537\n-                ss.minify(Default::default())\n-                    .context(\"failed to transform css\")?;\n+                ss.minify(MinifyOptions {\n+                    targets,\n+                    ..Default::default()\n+                })\n+                .context(\"failed to transform css\")?;\n \n                 stylesheet_into_static(&ss, without_warnings(config.clone()))\n             }"
        },
        {
            "sha": "8ebb197c64eb822510ce499284f348ab5d9a53a2",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/src/asset_context.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fasset_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fasset_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fasset_context.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -1,5 +1,5 @@\n use turbo_rcstr::rcstr;\n-use turbo_tasks::{Result, Vc};\n+use turbo_tasks::{ResolvedVc, Result, Vc};\n use turbopack::{\n     ModuleAssetContext,\n     module_options::{EcmascriptOptionsContext, ModuleOptionsContext, TypescriptTransformOptions},\n@@ -11,7 +11,7 @@ use turbopack_ecmascript::TreeShakingMode;\n \n /// Returns the runtime asset context to use to process runtime code assets.\n pub async fn get_runtime_asset_context(\n-    environment: Vc<Environment>,\n+    environment: ResolvedVc<Environment>,\n ) -> Result<Vc<Box<dyn AssetContext>>> {\n     let module_options_context = ModuleOptionsContext {\n         ecmascript: EcmascriptOptionsContext {\n@@ -21,14 +21,13 @@ pub async fn get_runtime_asset_context(\n             ..Default::default()\n         },\n         // TODO: Somehow this fails to compile when enabled.\n-        // preset_env_versions: Some(environment),\n+        // environment: Some(environment),\n+        environment: None,\n         tree_shaking_mode: Some(TreeShakingMode::ReexportsOnly),\n         ..Default::default()\n     }\n     .cell();\n-    let compile_time_info = CompileTimeInfo::builder(environment.to_resolved().await?)\n-        .cell()\n-        .await?;\n+    let compile_time_info = CompileTimeInfo::builder(environment).cell().await?;\n \n     let asset_context: Vc<Box<dyn AssetContext>> = Vc::upcast(ModuleAssetContext::new(\n         Default::default(),"
        },
        {
            "sha": "24f064d588132c36ad4d7c782d17cc15597ed26e",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/src/browser_runtime.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fbrowser_runtime.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fbrowser_runtime.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fbrowser_runtime.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -3,7 +3,7 @@ use std::io::Write;\n use anyhow::Result;\n use indoc::writedoc;\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::Vc;\n+use turbo_tasks::{ResolvedVc, Vc};\n use turbopack_core::{\n     code_builder::{Code, CodeBuilder},\n     context::AssetContext,\n@@ -16,7 +16,7 @@ use crate::{RuntimeType, asset_context::get_runtime_asset_context, embed_js::emb\n /// Returns the code for the ECMAScript runtime.\n #[turbo_tasks::function]\n pub async fn get_browser_runtime_code(\n-    environment: Vc<Environment>,\n+    environment: ResolvedVc<Environment>,\n     chunk_base_path: Option<RcStr>,\n     chunk_suffix_path: Option<RcStr>,\n     runtime_type: RuntimeType,"
        },
        {
            "sha": "69277d2d40e5a5d6974a4f5d8831b8a33ea79701",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/src/nodejs_runtime.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fnodejs_runtime.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fnodejs_runtime.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fsrc%2Fnodejs_runtime.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -1,5 +1,5 @@\n use anyhow::Result;\n-use turbo_tasks::Vc;\n+use turbo_tasks::{ResolvedVc, Vc};\n use turbopack_core::{\n     code_builder::{Code, CodeBuilder},\n     environment::Environment,\n@@ -10,7 +10,7 @@ use crate::{asset_context::get_runtime_asset_context, embed_js::embed_static_cod\n /// Returns the code for the Node.js production ECMAScript runtime.\n #[turbo_tasks::function]\n pub async fn get_nodejs_runtime_code(\n-    environment: Vc<Environment>,\n+    environment: ResolvedVc<Environment>,\n     generate_source_map: bool,\n ) -> Result<Vc<Code>> {\n     let asset_context = get_runtime_asset_context(environment).await?;"
        },
        {
            "sha": "b969665c2beb1dc1a9d837461ed01a8f417a421a",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -373,7 +373,7 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n                 import_externals: true,\n                 ..Default::default()\n             },\n-            preset_env_versions: Some(env),\n+            environment: Some(env),\n             tree_shaking_mode: options.tree_shaking_mode,\n             rules: vec![(\n                 ContextCondition::InDirectory(\"node_modules\".into()),"
        },
        {
            "sha": "3fa400ea65b6ab4aed4d6a57eac1f75c4db47f15",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -303,14 +303,14 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n             css: CssOptionsContext {\n                 ..Default::default()\n             },\n-            preset_env_versions: Some(env),\n+            environment: Some(env),\n             rules: vec![(\n                 ContextCondition::InDirectory(\"node_modules\".into()),\n                 ModuleOptionsContext {\n                     css: CssOptionsContext {\n                         ..Default::default()\n                     },\n-                    preset_env_versions: Some(env),\n+                    environment: Some(env),\n                     tree_shaking_mode: options.tree_shaking_mode,\n                     remove_unused_exports: options.remove_unused_exports,\n                     ..Default::default()"
        },
        {
            "sha": "86787ad3f9c932e7e7c26cc23ca0a582159a0b3b",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -236,7 +236,7 @@ async fn apply_module_type(\n                 .await?,\n         ),\n \n-        ModuleType::Css { ty } => ResolvedVc::upcast(\n+        ModuleType::Css { ty, environment } => ResolvedVc::upcast(\n             CssModuleAsset::new(\n                 *source,\n                 Vc::upcast(module_asset_context),\n@@ -247,6 +247,7 @@ async fn apply_module_type(\n                     .css\n                     .minify_type,\n                 css_import_context,\n+                environment.as_deref().copied(),\n             )\n             .to_resolved()\n             .await?,\n@@ -564,7 +565,7 @@ async fn process_default_internal(\n                         }\n                     }\n                     ModuleRuleEffect::ModuleType(module) => {\n-                        current_module_type = Some(*module);\n+                        current_module_type = Some(module.clone());\n                     }\n                     ModuleRuleEffect::ExtendEcmascriptTransforms { prepend, append } => {\n                         current_module_type = match current_module_type {\n@@ -687,6 +688,9 @@ async fn externals_tracing_module_context(ty: ExternalType) -> Result<Vc<ModuleA\n                 source_maps: SourceMapsType::None,\n                 ..Default::default()\n             },\n+            // Environment is not passed in order to avoid downleveling JS / CSS for\n+            // node-file-trace.\n+            environment: None,\n             ..Default::default()\n         }\n         .cell(),"
        },
        {
            "sha": "9ed4e5a8d84eca2a0f7f2c140a0bc3d579b770c7",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -139,7 +139,7 @@ impl ModuleOptions {\n                 },\n             ref enable_postcss_transform,\n             ref enable_webpack_loaders,\n-            preset_env_versions,\n+            environment,\n             ref module_rules,\n             execution_context,\n             tree_shaking_mode,\n@@ -180,8 +180,8 @@ impl ModuleOptions {\n         };\n         let ecmascript_options_vc = ecmascript_options.resolved_cell();\n \n-        if let Some(env) = preset_env_versions {\n-            transforms.push(EcmascriptInputTransform::PresetEnv(env));\n+        if let Some(environment) = environment {\n+            transforms.push(EcmascriptInputTransform::PresetEnv(environment));\n         }\n \n         if let Some(enable_typeof_window_inlining) = enable_typeof_window_inlining {\n@@ -446,6 +446,7 @@ impl ModuleOptions {\n                     ]),\n                     vec![ModuleRuleEffect::ModuleType(ModuleType::Css {\n                         ty: CssModuleAssetType::Default,\n+                        environment,\n                     })],\n                 ),\n                 ModuleRule::new(\n@@ -455,6 +456,7 @@ impl ModuleOptions {\n                     ]),\n                     vec![ModuleRuleEffect::ModuleType(ModuleType::Css {\n                         ty: CssModuleAssetType::Module,\n+                        environment,\n                     })],\n                 ),\n             ]);\n@@ -507,6 +509,7 @@ impl ModuleOptions {\n                     ]),\n                     vec![ModuleRuleEffect::ModuleType(ModuleType::Css {\n                         ty: CssModuleAssetType::Default,\n+                        environment,\n                     })],\n                 ),\n                 ModuleRule::new(\n@@ -537,6 +540,7 @@ impl ModuleOptions {\n                     ]),\n                     vec![ModuleRuleEffect::ModuleType(ModuleType::Css {\n                         ty: CssModuleAssetType::Module,\n+                        environment,\n                     })],\n                 ),\n                 // Ecmascript CSS Modules referencing the actual CSS module to include it\n@@ -547,6 +551,7 @@ impl ModuleOptions {\n                     ]),\n                     vec![ModuleRuleEffect::ModuleType(ModuleType::Css {\n                         ty: CssModuleAssetType::Module,\n+                        environment,\n                     })],\n                 ),\n                 // Ecmascript CSS Modules referencing the actual CSS module to list the classes\n@@ -562,6 +567,7 @@ impl ModuleOptions {\n                     ]),\n                     vec![ModuleRuleEffect::ModuleType(ModuleType::Css {\n                         ty: CssModuleAssetType::Module,\n+                        environment,\n                     })],\n                 ),\n             ]);"
        },
        {
            "sha": "5466cadedbd61de4e15bde8cdbc2e96979020c46",
            "filename": "turbopack/crates/turbopack/src/module_options/module_options_context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -147,7 +147,7 @@ pub struct ModuleOptionsContext {\n     pub enable_mdx: bool,\n     pub enable_mdx_rs: Option<ResolvedVc<MdxTransformOptions>>,\n \n-    pub preset_env_versions: Option<ResolvedVc<Environment>>,\n+    pub environment: Option<ResolvedVc<Environment>>,\n     pub execution_context: Option<ResolvedVc<ExecutionContext>>,\n     pub side_effect_free_packages: Vec<RcStr>,\n     pub tree_shaking_mode: Option<TreeShakingMode>,"
        },
        {
            "sha": "66fb41f5736ce47a8316f0abfb2eed602bbb993a",
            "filename": "turbopack/crates/turbopack/src/module_options/module_rule.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -3,7 +3,8 @@ use serde::{Deserialize, Serialize};\n use turbo_tasks::{NonLocalValue, ResolvedVc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n-    reference_type::ReferenceType, source::Source, source_transform::SourceTransforms,\n+    environment::Environment, reference_type::ReferenceType, source::Source,\n+    source_transform::SourceTransforms,\n };\n use turbopack_css::CssModuleAssetType;\n use turbopack_ecmascript::{EcmascriptInputTransforms, EcmascriptOptions};\n@@ -77,7 +78,7 @@ pub enum ModuleRuleEffect {\n }\n \n #[turbo_tasks::value(shared)]\n-#[derive(Hash, Debug, Copy, Clone)]\n+#[derive(Hash, Debug, Clone)]\n pub enum ModuleType {\n     Ecmascript {\n         transforms: ResolvedVc<EcmascriptInputTransforms>,\n@@ -103,6 +104,7 @@ pub enum ModuleType {\n     CssModule,\n     Css {\n         ty: CssModuleAssetType,\n+        environment: Option<ResolvedVc<Environment>>,\n     },\n     StaticUrlJs,\n     StaticUrlCss,"
        },
        {
            "sha": "1de646b38ddfbce83558ee3ad1aa009a8124791b",
            "filename": "turbopack/crates/turbopack/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5802ba81228c2f499839688093bb026b1d675e44/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs?ref=5802ba81228c2f499839688093bb026b1d675e44",
            "patch": "@@ -337,14 +337,15 @@ async fn node_file_trace_operation(\n     let output_dir = output_fs.root().to_resolved().await?;\n \n     let source = FileSource::new(input);\n+    let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n+        NodeJsEnvironment::default().resolved_cell(),\n+    ));\n     let module_asset_context = ModuleAssetContext::new(\n         Default::default(),\n         // TODO It's easy to make a mistake here as this should match the config in the\n         // binary. TODO These test cases should move into the\n         // `node-file-trace` crate and use the same config.\n-        CompileTimeInfo::new(Environment::new(ExecutionEnvironment::NodeJsLambda(\n-            NodeJsEnvironment::default().resolved_cell(),\n-        ))),\n+        CompileTimeInfo::new(environment),\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n                 enable_types: true,\n@@ -354,6 +355,9 @@ async fn node_file_trace_operation(\n                 enable_raw_css: true,\n                 ..Default::default()\n             },\n+            // Environment is not passed in order to avoid downleveling JS / CSS for\n+            // node-file-trace.\n+            environment: None,\n             ..Default::default()\n         }\n         .cell(),"
        }
    ],
    "stats": {
        "total": 353,
        "additions": 267,
        "deletions": 86
    }
}