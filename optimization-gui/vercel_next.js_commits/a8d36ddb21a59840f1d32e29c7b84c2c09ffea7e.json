{
    "author": "gnoff",
    "message": "Disallow `rootParams()` in `cache` scope (#75801)\n\nroot params exposes request data and thus must be disallowed from caches\r\nunless the cache also implicitly keys the entries on the root params\r\nvalues. For now we will simply disallow this pattern. we will implement\r\na strategy in the future which will allow root params to be called from\r\ninside a cache scope once we can sufficiently key the cache entries by\r\nthe root params values read. The same problem will arise with variants\r\nin the future so we will eventually need to implement support\r\n\r\nThe implementation removes rootParams from the workStore. This is an\r\ninvitation to accidentally leak request data into cache scopes. Now\r\nrootParams are conveyed on the workUnitStore and the cache store types\r\ndon't define it.\r\n\r\ncloses NAR-89",
    "sha": "a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
    "files": [
        {
            "sha": "5610d44f0720ef49a54302bb80822bc9074234aa",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -636,5 +636,9 @@\n   \"635\": \"%s: Invalid source map. Only conformant source maps can be used to find the original code.\",\n   \"636\": \"Invariant: frames must be a function when the React version has React.use. This is a bug in Next.js.\",\n   \"637\": \"Invariant: frames must be an array when the React version does not have React.use. This is a bug in Next.js.\",\n-  \"638\": \"The following tags are missing in the Root Layout: %s.\\\\nRead more at https://nextjs.org/docs/messages/missing-root-layout-tags\"\n+  \"638\": \"The following tags are missing in the Root Layout: %s.\\\\nRead more at https://nextjs.org/docs/messages/missing-root-layout-tags\",\n+  \"639\": \"unstable_rootParams() can only be used within App Router.\",\n+  \"640\": \"Route %s used \\\"unstable_rootParams\\\" inside \\\\`\\\"use cache\\\"\\\\` or \\\\`unstable_cache\\\\`. Support for this API inside cache scopes is planned for a future version of Next.js.\",\n+  \"641\": \"Route %s used \\\\`unstable_rootParams()\\\\` in Pages Router. This API is only available within App Router.\",\n+  \"642\": \"Route %s used \\\\`unstable_rootParams()\\\\` inside \\\\`\\\"use cache\\\"\\\\` or \\\\`unstable_cache\\\\`. Support for this API inside cache scopes is planned for a future version of Next.js.\"\n }"
        },
        {
            "sha": "c2ced452b9814b4d942a5237d4f4b05290276c0d",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 30,
            "deletions": 1,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -99,7 +99,7 @@ import { getRequiredScripts } from './required-scripts'\n import { addPathPrefix } from '../../shared/lib/router/utils/add-path-prefix'\n import { makeGetServerInsertedHTML } from './make-get-server-inserted-html'\n import { walkTreeWithFlightRouterState } from './walk-tree-with-flight-router-state'\n-import { createComponentTree } from './create-component-tree'\n+import { createComponentTree, getRootParams } from './create-component-tree'\n import { getAssetQueryString } from './get-asset-query-string'\n import { setReferenceManifestsSingleton } from './encryption-utils'\n import {\n@@ -673,6 +673,11 @@ async function warmupDevRender(\n     )\n   }\n \n+  const rootParams = getRootParams(\n+    ctx.componentMod.tree,\n+    ctx.getDynamicParamFromSegment\n+  )\n+\n   function onFlightDataRenderError(err: DigestedError) {\n     return renderOpts.onInstrumentationRequestError?.(\n       err,\n@@ -696,6 +701,7 @@ async function warmupDevRender(\n   const prerenderStore: PrerenderStore = {\n     type: 'prerender',\n     phase: 'render',\n+    rootParams,\n     implicitTags: [],\n     renderSignal: renderController.signal,\n     controller: prerenderController,\n@@ -1441,10 +1447,12 @@ async function renderToHTMLOrFlightImpl(\n       renderOpts.devRenderResumeDataCache ??\n       postponedState?.renderResumeDataCache\n \n+    const rootParams = getRootParams(loaderTree, ctx.getDynamicParamFromSegment)\n     const requestStore = createRequestStoreForRender(\n       req,\n       res,\n       url,\n+      rootParams,\n       implicitTags,\n       renderOpts.onUpdateCookies,\n       renderOpts.previewProps,\n@@ -2175,6 +2183,10 @@ async function spawnDynamicValidationInDev(\n   requestStore: RequestStore\n ): Promise<void> {\n   const { componentMod: ComponentMod } = ctx\n+  const rootParams = getRootParams(\n+    ComponentMod.tree,\n+    ctx.getDynamicParamFromSegment\n+  )\n \n   // Prerender controller represents the lifetime of the prerender.\n   // It will be aborted when a Task is complete or a synchronously aborting\n@@ -2192,6 +2204,7 @@ async function spawnDynamicValidationInDev(\n   const initialServerPrerenderStore: PrerenderStore = {\n     type: 'prerender',\n     phase: 'render',\n+    rootParams,\n     implicitTags: [],\n     renderSignal: initialServerRenderController.signal,\n     controller: initialServerPrerenderController,\n@@ -2208,6 +2221,7 @@ async function spawnDynamicValidationInDev(\n   const initialClientPrerenderStore: PrerenderStore = {\n     type: 'prerender',\n     phase: 'render',\n+    rootParams,\n     implicitTags: [],\n     renderSignal: initialClientController.signal,\n     controller: initialClientController,\n@@ -2353,6 +2367,7 @@ async function spawnDynamicValidationInDev(\n   const finalServerPrerenderStore: PrerenderStore = {\n     type: 'prerender',\n     phase: 'render',\n+    rootParams,\n     implicitTags: [],\n     renderSignal: finalServerController.signal,\n     controller: finalServerController,\n@@ -2373,6 +2388,7 @@ async function spawnDynamicValidationInDev(\n   const finalClientPrerenderStore: PrerenderStore = {\n     type: 'prerender',\n     phase: 'render',\n+    rootParams,\n     implicitTags: [],\n     renderSignal: finalClientController.signal,\n     controller: finalClientController,\n@@ -2543,6 +2559,7 @@ async function prerenderToStream(\n   // because some shared APIs expect a formState value and this is slightly\n   // more explicit than making it an optional function argument\n   const formState = null\n+  const rootParams = getRootParams(tree, ctx.getDynamicParamFromSegment)\n \n   const renderOpts = ctx.renderOpts\n   const ComponentMod = renderOpts.ComponentMod\n@@ -2691,6 +2708,7 @@ async function prerenderToStream(\n         const initialServerPrerenderStore: PrerenderStore = (prerenderStore = {\n           type: 'prerender',\n           phase: 'render',\n+          rootParams,\n           implicitTags: implicitTags,\n           renderSignal: initialServerRenderController.signal,\n           controller: initialServerPrerenderController,\n@@ -2784,6 +2802,7 @@ async function prerenderToStream(\n           const initialClientPrerenderStore: PrerenderStore = {\n             type: 'prerender',\n             phase: 'render',\n+            rootParams,\n             implicitTags: implicitTags,\n             renderSignal: initialClientController.signal,\n             controller: initialClientController,\n@@ -2868,6 +2887,7 @@ async function prerenderToStream(\n         const finalRenderPrerenderStore: PrerenderStore = (prerenderStore = {\n           type: 'prerender',\n           phase: 'render',\n+          rootParams,\n           implicitTags: implicitTags,\n           renderSignal: finalServerController.signal,\n           controller: finalServerController,\n@@ -2936,6 +2956,7 @@ async function prerenderToStream(\n         const finalClientPrerenderStore: PrerenderStore = {\n           type: 'prerender',\n           phase: 'render',\n+          rootParams,\n           implicitTags: implicitTags,\n           renderSignal: finalClientController.signal,\n           controller: finalClientController,\n@@ -3170,6 +3191,7 @@ async function prerenderToStream(\n         const initialServerPrerenderStore: PrerenderStore = (prerenderStore = {\n           type: 'prerender',\n           phase: 'render',\n+          rootParams,\n           implicitTags: implicitTags,\n           renderSignal: initialServerRenderController.signal,\n           controller: initialServerPrerenderController,\n@@ -3186,6 +3208,7 @@ async function prerenderToStream(\n         const initialClientPrerenderStore: PrerenderStore = (prerenderStore = {\n           type: 'prerender',\n           phase: 'render',\n+          rootParams,\n           implicitTags: implicitTags,\n           renderSignal: initialClientController.signal,\n           controller: initialClientController,\n@@ -3337,6 +3360,7 @@ async function prerenderToStream(\n         const finalServerPrerenderStore: PrerenderStore = (prerenderStore = {\n           type: 'prerender',\n           phase: 'render',\n+          rootParams,\n           implicitTags: implicitTags,\n           renderSignal: finalServerController.signal,\n           controller: finalServerController,\n@@ -3360,6 +3384,7 @@ async function prerenderToStream(\n         const finalClientPrerenderStore: PrerenderStore = (prerenderStore = {\n           type: 'prerender',\n           phase: 'render',\n+          rootParams,\n           implicitTags: implicitTags,\n           renderSignal: finalClientController.signal,\n           controller: finalClientController,\n@@ -3554,6 +3579,7 @@ async function prerenderToStream(\n       const reactServerPrerenderStore: PrerenderStore = (prerenderStore = {\n         type: 'prerender-ppr',\n         phase: 'render',\n+        rootParams,\n         implicitTags: implicitTags,\n         dynamicTracking,\n         revalidate: INFINITE_CACHE,\n@@ -3586,6 +3612,7 @@ async function prerenderToStream(\n       const ssrPrerenderStore: PrerenderStore = {\n         type: 'prerender-ppr',\n         phase: 'render',\n+        rootParams,\n         implicitTags: implicitTags,\n         dynamicTracking,\n         revalidate: INFINITE_CACHE,\n@@ -3775,6 +3802,7 @@ async function prerenderToStream(\n       const prerenderLegacyStore: PrerenderStore = (prerenderStore = {\n         type: 'prerender-legacy',\n         phase: 'render',\n+        rootParams,\n         implicitTags: implicitTags,\n         revalidate: INFINITE_CACHE,\n         expire: INFINITE_CACHE,\n@@ -3934,6 +3962,7 @@ async function prerenderToStream(\n     const prerenderLegacyStore: PrerenderStore = (prerenderStore = {\n       type: 'prerender-legacy',\n       phase: 'render',\n+      rootParams,\n       implicitTags: implicitTags,\n       revalidate:\n         typeof prerenderStore?.revalidate !== 'undefined'"
        },
        {
            "sha": "2ac103e657115e71a555be447a1dfed79b7f4883",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 53,
            "deletions": 5,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -8,7 +8,7 @@ import { getLayoutOrPageModule } from '../lib/app-dir-module'\n import type { LoaderTree } from '../lib/app-dir-module'\n import { interopDefault } from './interop-default'\n import { parseLoaderTree } from './parse-loader-tree'\n-import type { AppRenderContext } from './app-render'\n+import type { AppRenderContext, GetDynamicParamFromSegment } from './app-render'\n import { createComponentStylesAndScripts } from './create-component-styles-and-scripts'\n import { getLayerAssets } from './get-layer-assets'\n import { hasLoadingComponentInTree } from './has-loading-component-in-tree'\n@@ -392,10 +392,6 @@ async function createComponentTreeInternal({\n   // Resolve the segment param\n   const actualSegment = segmentParam ? segmentParam.treeSegment : segment\n \n-  if (rootLayoutAtThisLevel) {\n-    workStore.rootParams = currentParams\n-  }\n-\n   // Only render metadata on the actual SSR'd segment not the `default` segment,\n   // as it's used as a placeholder for navigation.\n   const metadata =\n@@ -921,3 +917,55 @@ function createErrorBoundaryClientSegmentRoot({\n   }\n   return null\n }\n+\n+export function getRootParams(\n+  loaderTree: LoaderTree,\n+  getDynamicParamFromSegment: GetDynamicParamFromSegment\n+): Params {\n+  return getRootParamsImpl({}, loaderTree, getDynamicParamFromSegment)\n+}\n+\n+function getRootParamsImpl(\n+  parentParams: Params,\n+  loaderTree: LoaderTree,\n+  getDynamicParamFromSegment: GetDynamicParamFromSegment\n+): Params {\n+  const {\n+    segment,\n+    modules: { layout },\n+    parallelRoutes,\n+  } = parseLoaderTree(loaderTree)\n+\n+  const segmentParam = getDynamicParamFromSegment(segment)\n+\n+  let currentParams: Params = parentParams\n+  if (segmentParam && segmentParam.value !== null) {\n+    currentParams = {\n+      ...parentParams,\n+      [segmentParam.param]: segmentParam.value,\n+    }\n+  }\n+\n+  const isRootLayout = typeof layout !== 'undefined'\n+\n+  if (isRootLayout) {\n+    return currentParams\n+  } else if (!parallelRoutes.children) {\n+    // This should really be an error but there are bugs in Turbopack that cause\n+    // the _not-found LoaderTree to not have any layouts. For rootParams sake\n+    // this is somewhat irrelevant when you are not customizing the 404 page.\n+    // If you are customizing 404\n+    // TODO update rootParams to make all params optional if `/app/not-found.tsx` is defined\n+    return currentParams\n+  } else {\n+    return getRootParamsImpl(\n+      currentParams,\n+      // We stop looking for root params as soon as we hit the first layout\n+      // and it is not possible to use parallel route children above the root layout\n+      // so every parallelRoutes object that this function can visit will necessarily\n+      // have a single `children` prop and no others.\n+      parallelRoutes.children,\n+      getDynamicParamFromSegment\n+    )\n+  }\n+}"
        },
        {
            "sha": "88abc9dae7c2aea3fb82391a2e83d0c8bde4b02f",
            "filename": "packages/next/src/server/app-render/work-async-storage.external.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -7,7 +7,6 @@ import type { DeepReadonly } from '../../shared/lib/deep-readonly'\n import type { AppSegmentConfig } from '../../build/segment-config/app/app-segment-config'\n import type { AfterContext } from '../after/after-context'\n import type { CacheLife } from '../use-cache/cache-life'\n-import type { Params } from '../request/params'\n \n // Share the instance module in the next-shared layer\n import { workAsyncStorageInstance } from './work-async-storage-instance' with { 'turbopack-transition': 'next-shared' }\n@@ -71,7 +70,6 @@ export interface WorkStore {\n   >\n   readonly assetPrefix?: string\n \n-  rootParams: Params\n   dynamicIOEnabled: boolean\n   dev: boolean\n }"
        },
        {
            "sha": "c8a86cc5f03eddc27860f95e2c6a11bb41203f3b",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -13,6 +13,7 @@ import type {\n   RenderResumeDataCache,\n   PrerenderResumeDataCache,\n } from '../resume-data-cache/resume-data-cache'\n+import type { Params } from '../request/params'\n \n type WorkUnitPhase = 'action' | 'render' | 'after'\n \n@@ -52,6 +53,7 @@ export type RequestStore = {\n   readonly serverComponentsHmrCache?: ServerComponentsHmrCache\n \n   readonly implicitTags: string[]\n+  readonly rootParams: Params\n \n   /**\n    * The resume data cache for this request. This will be a immutable cache.\n@@ -100,6 +102,8 @@ export type PrerenderStoreModern = {\n    */\n   readonly dynamicTracking: null | DynamicTrackingState\n \n+  readonly rootParams: Params\n+\n   // Collected revalidate times and tags for this document during the prerender.\n   revalidate: number // in seconds. 0 means dynamic. INFINITE_CACHE and higher means never revalidate.\n   expire: number // server expiration time\n@@ -120,6 +124,7 @@ export type PrerenderStoreModern = {\n \n export type PrerenderStorePPR = {\n   type: 'prerender-ppr'\n+  readonly rootParams: Params\n   readonly implicitTags: string[]\n   readonly dynamicTracking: null | DynamicTrackingState\n   // Collected revalidate times and tags for this document during the prerender.\n@@ -136,6 +141,7 @@ export type PrerenderStorePPR = {\n \n export type PrerenderStoreLegacy = {\n   type: 'prerender-legacy'\n+  readonly rootParams: Params\n   readonly implicitTags: string[]\n   // Collected revalidate times and tags for this document during the prerender.\n   revalidate: number // in seconds. 0 means dynamic. INFINITE_CACHE and higher means never revalidate."
        },
        {
            "sha": "2f8ef4a03bb91d065083751d70e5934377ce92aa",
            "filename": "packages/next/src/server/async-storage/request-store.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -22,6 +22,7 @@ import { DraftModeProvider } from './draft-mode-provider'\n import { splitCookiesString } from '../web/utils'\n import type { ServerComponentsHmrCache } from '../response-cache'\n import type { RenderResumeDataCache } from '../resume-data-cache/resume-data-cache'\n+import type { Params } from '../request/params'\n \n function getHeaders(headers: Headers | IncomingHttpHeaders): ReadonlyHeaders {\n   const cleaned = HeadersAdapter.from(headers)\n@@ -106,6 +107,7 @@ export function createRequestStoreForRender(\n   req: RequestContext['req'],\n   res: RequestContext['res'],\n   url: RequestContext['url'],\n+  rootParams: Params,\n   implicitTags: RequestContext['implicitTags'],\n   onUpdateCookies: RenderOpts['onUpdateCookies'],\n   previewProps: WrapperRenderOpts['previewProps'],\n@@ -119,6 +121,7 @@ export function createRequestStoreForRender(\n     req,\n     res,\n     url,\n+    rootParams,\n     implicitTags,\n     onUpdateCookies,\n     renderResumeDataCache,\n@@ -141,6 +144,7 @@ export function createRequestStoreForAPI(\n     req,\n     undefined,\n     url,\n+    {},\n     implicitTags,\n     onUpdateCookies,\n     undefined,\n@@ -155,6 +159,7 @@ function createRequestStoreImpl(\n   req: RequestContext['req'],\n   res: RequestContext['res'],\n   url: RequestContext['url'],\n+  rootParams: Params,\n   implicitTags: RequestContext['implicitTags'],\n   onUpdateCookies: RenderOpts['onUpdateCookies'],\n   renderResumeDataCache: RenderResumeDataCache | undefined,\n@@ -184,6 +189,7 @@ function createRequestStoreImpl(\n     // to ensure we don't use parts of the URL that we shouldn't. This also\n     // lets us avoid requiring an empty string for `search` in the type.\n     url: { pathname: url.pathname, search: url.search ?? '' },\n+    rootParams,\n     get headers() {\n       if (!cache.headers) {\n         // Seal the headers object that'll freeze out any methods that could"
        },
        {
            "sha": "fca6cb64b7772c9754530e86380cb7cf9b6948d4",
            "filename": "packages/next/src/server/async-storage/work-store.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -118,8 +118,6 @@ export function createWorkStore({\n \n     isDraftMode: renderOpts.isDraftMode,\n \n-    rootParams: {},\n-\n     requestEndedState,\n     isPrefetchRequest,\n     buildId,"
        },
        {
            "sha": "b130c9737985ce9315ef526ac257a4ec705ea349",
            "filename": "packages/next/src/server/request/root-params.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 27,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -23,41 +23,36 @@ const CachedParams = new WeakMap<CacheLifetime, Promise<Params>>()\n \n export async function unstable_rootParams(): Promise<Params> {\n   const workStore = workAsyncStorage.getStore()\n-  const workUnitStore = workUnitAsyncStorage.getStore()\n-\n   if (!workStore) {\n     throw new InvariantError('Missing workStore in unstable_rootParams')\n   }\n \n-  const underlyingParams = workStore.rootParams\n+  const workUnitStore = workUnitAsyncStorage.getStore()\n \n-  if (workUnitStore) {\n-    switch (workUnitStore.type) {\n-      case 'cache': {\n-        // TODO: We need to be able to express this case with PPR+DynamicIO.\n-        // We don't want rootParams to leak into the fallback shell, and we don't\n-        // currently have a way to express `dynamicParams = false`.\n-        if (workStore.fallbackRouteParams && process.env.__NEXT_PPR) {\n-          throw new Error(\n-            `Route ${workStore.route} used \"unstable_rootParams\" inside \"use cache\". This is not currently supported.`\n-          )\n-        }\n+  if (!workUnitStore) {\n+    throw new Error(\n+      `Route ${workStore.route} used \\`unstable_rootParams()\\` in Pages Router. This API is only available within App Router.`\n+    )\n+  }\n \n-        return Promise.resolve(underlyingParams)\n-      }\n-      case 'prerender':\n-      case 'prerender-ppr':\n-      case 'prerender-legacy':\n-        return createPrerenderRootParams(\n-          underlyingParams,\n-          workStore,\n-          workUnitStore\n-        )\n-      default:\n-      // fallthrough\n+  switch (workUnitStore.type) {\n+    case 'unstable-cache':\n+    case 'cache': {\n+      throw new Error(\n+        `Route ${workStore.route} used \\`unstable_rootParams()\\` inside \\`\"use cache\"\\` or \\`unstable_cache\\`. Support for this API inside cache scopes is planned for a future version of Next.js.`\n+      )\n     }\n+    case 'prerender':\n+    case 'prerender-ppr':\n+    case 'prerender-legacy':\n+      return createPrerenderRootParams(\n+        workUnitStore.rootParams,\n+        workStore,\n+        workUnitStore\n+      )\n+    default:\n+      return Promise.resolve(workUnitStore.rootParams)\n   }\n-  return Promise.resolve(underlyingParams)\n }\n \n function createPrerenderRootParams("
        },
        {
            "sha": "14c3f439d48e5f25c29bb357b604f12820940fc9",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -364,6 +364,9 @@ export class AppRouteRouteModule extends RouteModule<\n             (prerenderStore = {\n               type: 'prerender',\n               phase: 'action',\n+              // This replicates prior behavior where rootParams is empty in routes\n+              // TODO we need to make this have the proper rootParams for this route\n+              rootParams: {},\n               implicitTags: implicitTags,\n               renderSignal: prospectiveController.signal,\n               controller: prospectiveController,\n@@ -450,6 +453,7 @@ export class AppRouteRouteModule extends RouteModule<\n           const finalRoutePrerenderStore: PrerenderStore = (prerenderStore = {\n             type: 'prerender',\n             phase: 'action',\n+            rootParams: {},\n             implicitTags: implicitTags,\n             renderSignal: finalController.signal,\n             controller: finalController,\n@@ -529,6 +533,7 @@ export class AppRouteRouteModule extends RouteModule<\n           prerenderStore = {\n             type: 'prerender-legacy',\n             phase: 'action',\n+            rootParams: {},\n             implicitTags: implicitTags,\n             revalidate: defaultRevalidate,\n             expire: INFINITE_CACHE,"
        },
        {
            "sha": "3bd7a26303ee8fc7c659fa1eb1a7f9f6a49ca31b",
            "filename": "test/e2e/app-dir/app-root-params/dynamic-io.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 30,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/eb66a4dfa12df6f791d1a3287bee11addafb7386/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Fdynamic-io.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eb66a4dfa12df6f791d1a3287bee11addafb7386/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Fdynamic-io.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Fdynamic-io.test.ts?ref=eb66a4dfa12df6f791d1a3287bee11addafb7386",
            "patch": "@@ -1,30 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-import { join } from 'path'\n-\n-const isPPREnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n-\n-describe('app-root-params - dynamicIO', () => {\n-  const { next } = nextTestSetup({\n-    files: join(__dirname, 'fixtures', 'dynamic-io'),\n-    skipStart: isPPREnabled,\n-    skipDeployment: isPPREnabled,\n-  })\n-\n-  // TODO: We need to figure out how to handle cached root params when\n-  // generating a PPR fallback shell.\n-  if (isPPREnabled) {\n-    it('is not currently enabled', () => {})\n-  } else {\n-    it('should prerender pages when using rootParams in generateStaticParams', async () => {\n-      const $ = await next.render$('/en/us')\n-      expect($('#param').text()).toBe('en us')\n-      const initialRandom = $('#random').text()\n-      expect(initialRandom).toMatch(/0(\\.\\d+)?$/)\n-\n-      const $2 = await next.render$('/en/us')\n-      expect($2('#param').text()).toBe('en us')\n-      const random = $2('#random').text()\n-      expect(random).toBe(initialRandom)\n-    })\n-  }\n-})"
        },
        {
            "sha": "0502ea507ea10670a970dada5ca7c180be06ceb2",
            "filename": "test/e2e/app-dir/app-root-params/fixtures/use-cache-build/app/[lang]/[locale]/layout.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-build%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-build%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-build%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Flayout.tsx?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "previous_filename": "test/e2e/app-dir/app-root-params/fixtures/dynamic-io/app/[lang]/[locale]/layout.tsx"
        },
        {
            "sha": "334d9d6f222e08e29bc71b6395fc9ed5dd1fd898",
            "filename": "test/e2e/app-dir/app-root-params/fixtures/use-cache-build/app/[lang]/[locale]/use-cache/page.tsx",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-build%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Fuse-cache%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-build%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Fuse-cache%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-build%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Fuse-cache%2Fpage.tsx?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -0,0 +1,22 @@\n+import { unstable_rootParams } from 'next/server'\n+\n+export default async function Page() {\n+  const rootParams = await getCachedParams()\n+  const data = await fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/random'\n+  ).then((res) => res.text())\n+\n+  return (\n+    <p>\n+      <span id=\"param\">\n+        {rootParams.lang} {rootParams.locale}\n+      </span>{' '}\n+      <span id=\"random\">{data}</span>\n+    </p>\n+  )\n+}\n+\n+async function getCachedParams() {\n+  'use cache'\n+  return unstable_rootParams()\n+}"
        },
        {
            "sha": "9b469ab0242bf6f3efedd7279f24aae4a43a2c5e",
            "filename": "test/e2e/app-dir/app-root-params/fixtures/use-cache-build/next.config.js",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-build%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-build%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-build%2Fnext.config.js?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -1,5 +1,5 @@\n module.exports = {\n   experimental: {\n-    dynamicIO: true,\n+    useCache: true,\n   },\n }",
            "previous_filename": "test/e2e/app-dir/app-root-params/fixtures/dynamic-io/next.config.js"
        },
        {
            "sha": "716a8db36f52c5b3b068de4e1d3c3bd64290a8be",
            "filename": "test/e2e/app-dir/app-root-params/fixtures/use-cache-runtime/app/[lang]/[locale]/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Flayout.tsx?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -0,0 +1,9 @@\n+import { ReactNode } from 'react'\n+\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "44a4d23cad589341c342b0792ba2d41d474c5bc5",
            "filename": "test/e2e/app-dir/app-root-params/fixtures/use-cache-runtime/app/[lang]/[locale]/request/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Frequest%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Frequest%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Frequest%2Fpage.tsx?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -1,5 +1,3 @@\n-'use cache'\n-\n import { unstable_rootParams } from 'next/server'\n \n export default async function Page() {",
            "previous_filename": "test/e2e/app-dir/app-root-params/fixtures/dynamic-io/app/[lang]/[locale]/page.tsx"
        },
        {
            "sha": "2ffdc10ec5fdd5384e5ed669199dd2592999b70d",
            "filename": "test/e2e/app-dir/app-root-params/fixtures/use-cache-runtime/app/[lang]/[locale]/unstable_cache/page.tsx",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Funstable_cache%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Funstable_cache%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Funstable_cache%2Fpage.tsx?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -0,0 +1,22 @@\n+import { unstable_rootParams } from 'next/server'\n+import { unstable_cache as cache } from 'next/cache'\n+\n+export default async function Page() {\n+  const rootParams = await getCachedParams()\n+  const data = await fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/random'\n+  ).then((res) => res.text())\n+\n+  return (\n+    <p>\n+      <span id=\"param\">\n+        {rootParams.lang} {rootParams.locale}\n+      </span>{' '}\n+      <span id=\"random\">{data}</span>\n+    </p>\n+  )\n+}\n+\n+const getCachedParams = cache(async () => {\n+  return unstable_rootParams()\n+})"
        },
        {
            "sha": "334d9d6f222e08e29bc71b6395fc9ed5dd1fd898",
            "filename": "test/e2e/app-dir/app-root-params/fixtures/use-cache-runtime/app/[lang]/[locale]/use-cache/page.tsx",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Fuse-cache%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Fuse-cache%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Fuse-cache%2Fpage.tsx?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -0,0 +1,22 @@\n+import { unstable_rootParams } from 'next/server'\n+\n+export default async function Page() {\n+  const rootParams = await getCachedParams()\n+  const data = await fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/random'\n+  ).then((res) => res.text())\n+\n+  return (\n+    <p>\n+      <span id=\"param\">\n+        {rootParams.lang} {rootParams.locale}\n+      </span>{' '}\n+      <span id=\"random\">{data}</span>\n+    </p>\n+  )\n+}\n+\n+async function getCachedParams() {\n+  'use cache'\n+  return unstable_rootParams()\n+}"
        },
        {
            "sha": "9b469ab0242bf6f3efedd7279f24aae4a43a2c5e",
            "filename": "test/e2e/app-dir/app-root-params/fixtures/use-cache-runtime/next.config.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Ffixtures%2Fuse-cache-runtime%2Fnext.config.js?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -0,0 +1,5 @@\n+module.exports = {\n+  experimental: {\n+    useCache: true,\n+  },\n+}"
        },
        {
            "sha": "ae5560426bd186b47f44c0bd73c406a0f53460b7",
            "filename": "test/e2e/app-dir/app-root-params/use-cache.test.ts",
            "status": "added",
            "additions": 117,
            "deletions": 0,
            "changes": 117,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Fuse-cache.test.ts?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -0,0 +1,117 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { join } from 'path'\n+import { createSandbox } from 'development-sandbox'\n+\n+const isPPREnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n+\n+describe('app-root-params - cache - at runtime', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: join(__dirname, 'fixtures', 'use-cache-runtime'),\n+    skipStart: true,\n+  })\n+\n+  if (isNextDev) {\n+    it('should error when using rootParams within a \"use cache\" - dev', async () => {\n+      await using sandbox = await createSandbox(\n+        next,\n+        undefined,\n+        '/en/us/use-cache'\n+      )\n+      const { session } = sandbox\n+      await session.assertHasRedbox()\n+      if (isPPREnabled) {\n+        // When PPR is enabled we verify that we have at least one root param value from generateStaticParams\n+        // Which this test does not define so we get a different error which preempts the root params error\n+        expect(await session.getRedboxDescription()).toInclude(\n+          'Required root params (lang, locale) were not provided in generateStaticParams'\n+        )\n+      } else {\n+        expect(await session.getRedboxDescription()).toInclude(\n+          'Route /[lang]/[locale]/use-cache used `unstable_rootParams()` inside `\"use cache\"` or `unstable_cache`'\n+        )\n+      }\n+    })\n+\n+    it('should error when using rootParams within `unstable_cache` - dev', async () => {\n+      await using sandbox = await createSandbox(\n+        next,\n+        undefined,\n+        '/en/us/unstable_cache'\n+      )\n+      const { session } = sandbox\n+      await session.assertHasRedbox()\n+      if (isPPREnabled) {\n+        // When PPR is enabled we verify that we have at least one root param value from generateStaticParams\n+        // Which this test does not define so we get a different error which preempts the root params error\n+        expect(await session.getRedboxDescription()).toInclude(\n+          'Required root params (lang, locale) were not provided in generateStaticParams'\n+        )\n+      } else {\n+        expect(await session.getRedboxDescription()).toInclude(\n+          'Route /[lang]/[locale]/unstable_cache used `unstable_rootParams()` inside `\"use cache\"` or `unstable_cache`'\n+        )\n+      }\n+    })\n+  } else {\n+    beforeAll(async () => {\n+      try {\n+        await next.start()\n+      } catch (_) {\n+        // We expect the build to fail\n+      }\n+    })\n+\n+    it('should error when using rootParams within a \"use cache\" - start', async () => {\n+      if (isPPREnabled) {\n+        // When PPR is enabled we verify that we have at least one root param value from generateStaticParams\n+        // Which this test does not define so we get a different error which preempts the root params error\n+        expect(next.cliOutput).toInclude(\n+          'Required root params (lang, locale) were not provided in generateStaticParams'\n+        )\n+      } else {\n+        await next.render$('/en/us/use-cache')\n+        expect(next.cliOutput).toInclude(\n+          'Error: Route /[lang]/[locale]/use-cache used `unstable_rootParams()` inside `\"use cache\"` or `unstable_cache`'\n+        )\n+      }\n+    })\n+\n+    it('should error when using rootParams within `unstable_cache` - start', async () => {\n+      if (isPPREnabled) {\n+        // When PPR is enabled we verify that we have at least one root param value from generateStaticParams\n+        // Which this test does not define so we get a different error which preempts the root params error\n+        expect(next.cliOutput).toInclude(\n+          'Required root params (lang, locale) were not provided in generateStaticParams'\n+        )\n+      } else {\n+        await next.render$('/en/us/unstable_cache')\n+        expect(next.cliOutput).toInclude(\n+          'Error: Route /[lang]/[locale]/unstable_cache used `unstable_rootParams()` inside `\"use cache\"` or `unstable_cache`'\n+        )\n+      }\n+    })\n+  }\n+})\n+\n+describe('app-root-params - cache - at build', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: join(__dirname, 'fixtures', 'use-cache-build'),\n+    skipStart: true,\n+  })\n+\n+  if (isNextDev) {\n+    // we omit these tests in dev because they are duplicates semantically to the runtime fixture tested above\n+    it('noop in dev', () => {})\n+  } else {\n+    it('should error when building a project that uses rootParams within `\"use cache\"`', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n+      }\n+      expect(next.cliOutput).toInclude(\n+        'Error: Route /[lang]/[locale]/use-cache used `unstable_rootParams()` inside `\"use cache\"` or `unstable_cache`'\n+      )\n+    })\n+  }\n+})"
        }
    ],
    "stats": {
        "total": 396,
        "additions": 325,
        "deletions": 71
    }
}