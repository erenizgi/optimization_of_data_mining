{
    "author": "eps1lon",
    "message": "[test] Deflake nested `after()` tests (#85566)",
    "sha": "d12578661023cbfa6f6080550dc6f271e16f6ff9",
    "files": [
        {
            "sha": "5dbb9e0482a667bddb020e145bc6aa25e4d7c686",
            "filename": "test/e2e/app-dir/next-after-app-api-usage/index.test.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 16,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/d12578661023cbfa6f6080550dc6f271e16f6ff9/test%2Fe2e%2Fapp-dir%2Fnext-after-app-api-usage%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d12578661023cbfa6f6080550dc6f271e16f6ff9/test%2Fe2e%2Fapp-dir%2Fnext-after-app-api-usage%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-after-app-api-usage%2Findex.test.ts?ref=d12578661023cbfa6f6080550dc6f271e16f6ff9",
            "patch": "@@ -58,24 +58,27 @@ describe('nextjs APIs in after()', () => {\n           `[${path}] headers(): error: Error: Route ${path} used \\`headers()\\` inside \\`after()\\`. This is not supported.`\n         )\n \n-        expect(logs).not.toContain(`[${path}] nested headers(): ok`)\n+        expect(logs).not.toContain(`[${path}] cookies(): ok`)\n         expect(logs).toContain(\n-          `[${path}] nested headers(): error: Error: Route ${path} used \\`headers()\\` inside \\`after()\\`. This is not supported.`\n+          `[${path}] cookies(): error: Error: Route ${path} used \\`cookies()\\` inside \\`after()\\`. This is not supported.`\n         )\n \n-        expect(logs).not.toContain(`[${path}] cookies(): ok`)\n+        expect(logs).not.toContain(`[${path}] connection(): ok`)\n         expect(logs).toContain(\n-          `[${path}] cookies(): error: Error: Route ${path} used \\`cookies()\\` inside \\`after()\\`. This is not supported.`\n+          `[${path}] connection(): error: Error: Route ${path} used \\`connection()\\` inside \\`after()\\`.`\n         )\n+      })\n+      await retry(() => {\n+        const logs = getLogs()\n \n-        expect(logs).not.toContain(`[${path}] nested cookies(): ok`)\n+        expect(logs).not.toContain(`[${path}] nested headers(): ok`)\n         expect(logs).toContain(\n-          `[${path}] nested cookies(): error: Error: Route ${path} used \\`cookies()\\` inside \\`after()\\`. This is not supported.`\n+          `[${path}] nested headers(): error: Error: Route ${path} used \\`headers()\\` inside \\`after()\\`. This is not supported.`\n         )\n \n-        expect(logs).not.toContain(`[${path}] connection(): ok`)\n+        expect(logs).not.toContain(`[${path}] nested cookies(): ok`)\n         expect(logs).toContain(\n-          `[${path}] connection(): error: Error: Route ${path} used \\`connection()\\` inside \\`after()\\`.`\n+          `[${path}] nested cookies(): error: Error: Route ${path} used \\`cookies()\\` inside \\`after()\\`. This is not supported.`\n         )\n \n         expect(logs).not.toContain(`[${path}] nested connection(): ok`)\n@@ -105,24 +108,27 @@ describe('nextjs APIs in after()', () => {\n             `[${path}] headers(): error: Error: Route ${path} used \\`headers()\\` inside \\`after()\\`. This is not supported.`\n           )\n \n-          expect(logs).not.toContain(`[${path}] nested headers(): ok`)\n+          expect(logs).not.toContain(`[${path}] cookies(): ok`)\n           expect(logs).toContain(\n-            `[${path}] nested headers(): error: Error: Route ${path} used \\`headers()\\` inside \\`after()\\`. This is not supported.`\n+            `[${path}] cookies(): error: Error: Route ${path} used \\`cookies()\\` inside \\`after()\\`. This is not supported.`\n           )\n \n-          expect(logs).not.toContain(`[${path}] cookies(): ok`)\n+          expect(logs).not.toContain(`[${path}] connection(): ok`)\n           expect(logs).toContain(\n-            `[${path}] cookies(): error: Error: Route ${path} used \\`cookies()\\` inside \\`after()\\`. This is not supported.`\n+            `[${path}] connection(): error: Error: Route ${path} used \\`connection()\\` inside \\`after()\\`.`\n           )\n+        })\n+        await retry(() => {\n+          const logs = isNextDev ? getLogs() : buildLogs // in `next start` the error was logged at build time\n \n-          expect(logs).not.toContain(`[${path}] nested cookies(): ok`)\n+          expect(logs).not.toContain(`[${path}] nested headers(): ok`)\n           expect(logs).toContain(\n-            `[${path}] nested cookies(): error: Error: Route ${path} used \\`cookies()\\` inside \\`after()\\`. This is not supported.`\n+            `[${path}] nested headers(): error: Error: Route ${path} used \\`headers()\\` inside \\`after()\\`. This is not supported.`\n           )\n \n-          expect(logs).not.toContain(`[${path}] connection(): ok`)\n+          expect(logs).not.toContain(`[${path}] nested cookies(): ok`)\n           expect(logs).toContain(\n-            `[${path}] connection(): error: Error: Route ${path} used \\`connection()\\` inside \\`after()\\`.`\n+            `[${path}] nested cookies(): error: Error: Route ${path} used \\`cookies()\\` inside \\`after()\\`. This is not supported.`\n           )\n \n           expect(logs).not.toContain(`[${path}] nested connection(): ok`)"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 22,
        "deletions": 16
    }
}