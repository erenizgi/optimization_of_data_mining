{
    "author": "unstubbable",
    "message": "[dynamicIO] Split up static generation into two phases (#79629)\n\nWhen `experimental.dynamicIO` is enabled, we're now prerendering\nfallback shells for routes that have some entries defined in\n`generateStaticParams` in a second phase, after the more specific route\nare prerendered.\n\nThis will allow us to offer better error messages when those fallback\nprerenders timeout due to accessing params inside of `\"use cache\"`. In\nthe future, we might even be able to avoid waiting for a timeout in this\ncase, if we share the resume data cache between the two prerender\nphases. This would also reduce most of the build performance cost we're\nadding with this PR temporarily (when the feature flag is enabled). [^1]\n\nWe're also fixing a bug with this PR, where PPR shells for routes with\ndynamic params were listed twice in the build output.\n\n[^1]: Note that `fetch` responses are already cached and shared between\nthe two phases.",
    "sha": "711b1bad5fff3045bc880c88ca4c384d47b48fd3",
    "files": [
        {
            "sha": "3423b0e7b8f6c61af24ca1300c59f1981ffe7ede",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=711b1bad5fff3045bc880c88ca4c384d47b48fd3",
            "patch": "@@ -735,7 +735,7 @@ const staticWorkerExposedMethods = [\n   'getDefinedNamedExports',\n   'exportPages',\n ] as const\n-type StaticWorker = typeof import('./worker') & Worker\n+export type StaticWorker = typeof import('./worker') & Worker\n export function createStaticWorker(\n   config: NextConfigComplete,\n   options: {"
        },
        {
            "sha": "d49166a49da44698ee82088df5ac78ddab9647cc",
            "filename": "packages/next/src/build/static-paths/app.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 15,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fapp.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fapp.ts?ref=711b1bad5fff3045bc880c88ca4c384d47b48fd3",
            "patch": "@@ -313,7 +313,7 @@ export async function buildAppStaticPaths({\n   isRoutePPREnabled: boolean\n   buildId: string\n   rootParamKeys: readonly string[]\n-}): Promise<Partial<StaticPathsResult>> {\n+}): Promise<StaticPathsResult> {\n   if (\n     segments.some((generate) => generate.config?.dynamicParams === true) &&\n     nextConfigOutput === 'export'\n@@ -484,12 +484,7 @@ export async function buildAppStaticPaths({\n       : undefined\n     : FallbackMode.NOT_FOUND\n \n-  const result: Partial<StaticPathsResult> = {\n-    fallbackMode,\n-    prerenderedRoutes: lastDynamicSegmentHadGenerateStaticParams\n-      ? []\n-      : undefined,\n-  }\n+  const prerenderedRoutesByPathname = new Map<string, PrerenderedRoute>()\n \n   if (hadAllParamsGenerated || isRoutePPREnabled) {\n     if (isRoutePPREnabled) {\n@@ -499,8 +494,7 @@ export async function buildAppStaticPaths({\n         ...filterUniqueRootParamsCombinations(rootParamKeys, routeParams)\n       )\n \n-      result.prerenderedRoutes ??= []\n-      result.prerenderedRoutes.push({\n+      prerenderedRoutesByPathname.set(page, {\n         params: {},\n         pathname: page,\n         encodedPathname: page,\n@@ -577,10 +571,11 @@ export async function buildAppStaticPaths({\n         fallbackRouteParams.includes(param)\n       )\n \n-      result.prerenderedRoutes ??= []\n-      result.prerenderedRoutes.push({\n+      pathname = normalizePathname(pathname)\n+\n+      prerenderedRoutesByPathname.set(pathname, {\n         params,\n-        pathname: normalizePathname(pathname),\n+        pathname,\n         encodedPathname: normalizePathname(encodedPathname),\n         fallbackRouteParams,\n         fallbackMode: dynamicParams\n@@ -597,10 +592,16 @@ export async function buildAppStaticPaths({\n     })\n   }\n \n+  const prerenderedRoutes =\n+    prerenderedRoutesByPathname.size > 0 ||\n+    lastDynamicSegmentHadGenerateStaticParams\n+      ? [...prerenderedRoutesByPathname.values()]\n+      : undefined\n+\n   // Now we have to set the throwOnEmptyStaticShell for each of the routes.\n-  if (result.prerenderedRoutes && dynamicIO) {\n-    assignErrorIfEmpty(result.prerenderedRoutes, routeParamKeys)\n+  if (prerenderedRoutes && dynamicIO) {\n+    assignErrorIfEmpty(prerenderedRoutes, routeParamKeys)\n   }\n \n-  return result\n+  return { fallbackMode, prerenderedRoutes }\n }"
        },
        {
            "sha": "b2f7358a1e3e7a88402a7df6e13ef414b0af5927",
            "filename": "packages/next/src/build/static-paths/pages.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 41,
            "changes": 80,
            "blob_url": "https://github.com/vercel/next.js/blob/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fpages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fpages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fpages.ts?ref=711b1bad5fff3045bc880c88ca4c384d47b48fd3",
            "patch": "@@ -22,7 +22,7 @@ export async function buildPagesStaticPaths({\n   locales?: readonly string[]\n   defaultLocale?: string\n }): Promise<StaticPathsResult> {\n-  const prerenderedRoutes: PrerenderedRoute[] = []\n+  const prerenderedRoutesByPathname = new Map<string, PrerenderedRoute>()\n   const _routeRegex = getRouteRegex(page)\n   const _routeMatcher = getRouteMatcher(_routeRegex)\n \n@@ -108,20 +108,24 @@ export async function buildPagesStaticPaths({\n       // If leveraging the string paths variant the entry should already be\n       // encoded so we decode the segments ensuring we only escape path\n       // delimiters\n-      prerenderedRoutes.push({\n-        params,\n-        pathname: entry\n-          .split('/')\n-          .map((segment) =>\n-            escapePathDelimiters(decodeURIComponent(segment), true)\n-          )\n-          .join('/'),\n-        encodedPathname: entry,\n-        fallbackRouteParams: undefined,\n-        fallbackMode: parseStaticPathsResult(staticPathsResult.fallback),\n-        fallbackRootParams: undefined,\n-        throwOnEmptyStaticShell: undefined,\n-      })\n+      const pathname = entry\n+        .split('/')\n+        .map((segment) =>\n+          escapePathDelimiters(decodeURIComponent(segment), true)\n+        )\n+        .join('/')\n+\n+      if (!prerenderedRoutesByPathname.has(pathname)) {\n+        prerenderedRoutesByPathname.set(pathname, {\n+          params,\n+          pathname,\n+          encodedPathname: entry,\n+          fallbackRouteParams: undefined,\n+          fallbackMode: parseStaticPathsResult(staticPathsResult.fallback),\n+          fallbackRootParams: undefined,\n+          throwOnEmptyStaticShell: undefined,\n+        })\n+      }\n     }\n     // For the object-provided path, we must make sure it specifies all\n     // required keys.\n@@ -197,36 +201,30 @@ export async function buildPagesStaticPaths({\n       }\n       const curLocale = entry.locale || defaultLocale || ''\n \n-      prerenderedRoutes.push({\n-        params,\n-        pathname: normalizePathname(\n-          `${curLocale ? `/${curLocale}` : ''}${\n-            curLocale && builtPage === '/' ? '' : builtPage\n-          }`\n-        ),\n-        encodedPathname: normalizePathname(\n-          `${curLocale ? `/${curLocale}` : ''}${\n-            curLocale && encodedBuiltPage === '/' ? '' : encodedBuiltPage\n-          }`\n-        ),\n-        fallbackRouteParams: undefined,\n-        fallbackMode: parseStaticPathsResult(staticPathsResult.fallback),\n-        fallbackRootParams: undefined,\n-        throwOnEmptyStaticShell: undefined,\n-      })\n+      const pathname = normalizePathname(\n+        `${curLocale ? `/${curLocale}` : ''}${curLocale && builtPage === '/' ? '' : builtPage}`\n+      )\n+\n+      if (!prerenderedRoutesByPathname.has(pathname)) {\n+        prerenderedRoutesByPathname.set(pathname, {\n+          params,\n+          pathname,\n+          encodedPathname: normalizePathname(\n+            `${curLocale ? `/${curLocale}` : ''}${\n+              curLocale && encodedBuiltPage === '/' ? '' : encodedBuiltPage\n+            }`\n+          ),\n+          fallbackRouteParams: undefined,\n+          fallbackMode: parseStaticPathsResult(staticPathsResult.fallback),\n+          fallbackRootParams: undefined,\n+          throwOnEmptyStaticShell: undefined,\n+        })\n+      }\n     }\n   })\n \n-  const seen = new Set<string>()\n-\n   return {\n     fallbackMode: parseStaticPathsResult(staticPathsResult.fallback),\n-    prerenderedRoutes: prerenderedRoutes.filter((route) => {\n-      if (seen.has(route.pathname)) return false\n-\n-      // Filter out duplicate paths.\n-      seen.add(route.pathname)\n-      return true\n-    }),\n+    prerenderedRoutes: [...prerenderedRoutesByPathname.values()],\n   }\n }"
        },
        {
            "sha": "5895b71ace5b0d0c598813d8b71e332c50424295",
            "filename": "packages/next/src/build/static-paths/types.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Ftypes.ts?ref=711b1bad5fff3045bc880c88ca4c384d47b48fd3",
            "patch": "@@ -34,6 +34,6 @@ type FallbackPrerenderedRoute = {\n export type PrerenderedRoute = StaticPrerenderedRoute | FallbackPrerenderedRoute\n \n export type StaticPathsResult = {\n-  fallbackMode: FallbackMode\n-  prerenderedRoutes: PrerenderedRoute[]\n+  fallbackMode: FallbackMode | undefined\n+  prerenderedRoutes: PrerenderedRoute[] | undefined\n }"
        },
        {
            "sha": "8f45d3a6d9155d9b3860161da22d037606e2e2c2",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 115,
            "deletions": 83,
            "changes": 198,
            "blob_url": "https://github.com/vercel/next.js/blob/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=711b1bad5fff3045bc880c88ca4c384d47b48fd3",
            "patch": "@@ -2,8 +2,14 @@ import type {\n   ExportAppResult,\n   ExportAppOptions,\n   WorkerRenderOptsPartial,\n+  ExportPagesResult,\n+  ExportPathEntry,\n } from './types'\n-import { createStaticWorker, type PrerenderManifest } from '../build'\n+import {\n+  createStaticWorker,\n+  type PrerenderManifest,\n+  type StaticWorker,\n+} from '../build'\n import type { PagesManifest } from '../build/webpack/plugins/pages-manifest-plugin'\n \n import { bold, yellow } from '../lib/picocolors'\n@@ -445,50 +451,48 @@ async function exportAppImpl(\n     }\n   }\n \n-  // make sure to prevent duplicates\n-  const exportPaths = [\n-    ...new Set(\n-      Object.keys(exportPathMap).map((path) =>\n-        denormalizePagePath(normalizePagePath(path))\n-      )\n-    ),\n-  ]\n+  const allExportPaths: ExportPathEntry[] = []\n+  const seenExportPaths = new Set<string>()\n+  const fallbackEnabledPages = new Set<string>()\n \n-  const filteredPaths = exportPaths.filter(\n-    (route) =>\n-      exportPathMap[route]._isAppDir ||\n-      // Remove API routes\n-      !isAPIRoute(exportPathMap[route].page)\n-  )\n+  for (const [path, entry] of Object.entries(exportPathMap)) {\n+    // make sure to prevent duplicates\n+    const normalizedPath = denormalizePagePath(normalizePagePath(path))\n \n-  if (filteredPaths.length !== exportPaths.length) {\n-    hasApiRoutes = true\n-  }\n+    if (seenExportPaths.has(normalizedPath)) {\n+      continue\n+    }\n \n-  if (filteredPaths.length === 0) {\n-    return null\n-  }\n+    seenExportPaths.add(normalizedPath)\n+\n+    if (!entry._isAppDir && isAPIRoute(entry.page)) {\n+      hasApiRoutes = true\n+      continue\n+    }\n \n-  if (prerenderManifest && !options.buildExport) {\n-    const fallbackEnabledPages = new Set()\n+    allExportPaths.push({ ...entry, path: normalizedPath })\n \n-    for (const path of Object.keys(exportPathMap)) {\n-      const page = exportPathMap[path].page\n-      const prerenderInfo = prerenderManifest.dynamicRoutes[page]\n+    if (prerenderManifest && !options.buildExport) {\n+      const prerenderInfo = prerenderManifest.dynamicRoutes[entry.page]\n \n       if (prerenderInfo && prerenderInfo.fallback !== false) {\n-        fallbackEnabledPages.add(page)\n+        fallbackEnabledPages.add(entry.page)\n       }\n     }\n+  }\n \n-    if (fallbackEnabledPages.size > 0) {\n-      throw new ExportError(\n-        `Found pages with \\`fallback\\` enabled:\\n${[\n-          ...fallbackEnabledPages,\n-        ].join('\\n')}\\n${SSG_FALLBACK_EXPORT_ERROR}\\n`\n-      )\n-    }\n+  if (allExportPaths.length === 0) {\n+    return null\n+  }\n+\n+  if (fallbackEnabledPages.size > 0) {\n+    throw new ExportError(\n+      `Found pages with \\`fallback\\` enabled:\\n${[...fallbackEnabledPages].join(\n+        '\\n'\n+      )}\\n${SSG_FALLBACK_EXPORT_ERROR}\\n`\n+    )\n   }\n+\n   let hasMiddleware = false\n \n   if (!options.buildExport) {\n@@ -554,32 +558,78 @@ async function exportAppImpl(\n     )\n   }\n \n-  const failedExportAttemptsByPage: Map<string, boolean> = new Map()\n+  const exportPagesInBatches = async (\n+    worker: StaticWorker,\n+    exportPaths: ExportPathEntry[]\n+  ): Promise<ExportPagesResult> => {\n+    // Batch filtered pages into smaller batches, and call the export worker on\n+    // each batch. We've set a default minimum of 25 pages per batch to ensure\n+    // that even setups with only a few static pages can leverage a shared\n+    // incremental cache, however this value can be configured.\n+    const minPageCountPerBatch =\n+      nextConfig.experimental.staticGenerationMinPagesPerWorker ?? 25\n+\n+    // Calculate the number of workers needed to ensure each batch has at least\n+    // minPageCountPerBatch pages.\n+    const numWorkers = Math.min(\n+      options.numWorkers,\n+      Math.ceil(exportPaths.length / minPageCountPerBatch)\n+    )\n \n-  // Chunk filtered pages into smaller groups, and call the export worker on each group.\n-  // We've set a default minimum of 25 pages per chunk to ensure that even setups\n-  // with only a few static pages can leverage a shared incremental cache, however this\n-  // value can be configured.\n-  const minChunkSize =\n-    nextConfig.experimental.staticGenerationMinPagesPerWorker ?? 25\n-  // Calculate the number of workers needed to ensure each chunk has at least minChunkSize pages\n-  const numWorkers = Math.min(\n-    options.numWorkers,\n-    Math.ceil(filteredPaths.length / minChunkSize)\n-  )\n-  // Calculate the chunk size based on the number of workers\n-  const chunkSize = Math.ceil(filteredPaths.length / numWorkers)\n-  const chunks = Array.from({ length: numWorkers }, (_, i) =>\n-    filteredPaths.slice(i * chunkSize, (i + 1) * chunkSize)\n-  )\n-  // Distribute remaining pages\n-  const remainingPages = filteredPaths.slice(numWorkers * chunkSize)\n-  remainingPages.forEach((page, index) => {\n-    chunks[index % chunks.length].push(page)\n-  })\n+    // Calculate the page count per batch based on the number of workers.\n+    const pageCountPerBatch = Math.ceil(exportPaths.length / numWorkers)\n+\n+    const batches = Array.from({ length: numWorkers }, (_, i) =>\n+      exportPaths.slice(i * pageCountPerBatch, (i + 1) * pageCountPerBatch)\n+    )\n+\n+    // Distribute remaining pages.\n+    const remainingPages = exportPaths.slice(numWorkers * pageCountPerBatch)\n+    remainingPages.forEach((page, index) => {\n+      batches[index % batches.length].push(page)\n+    })\n+\n+    return (\n+      await Promise.all(\n+        batches.map(async (batch) =>\n+          worker.exportPages({\n+            buildId,\n+            exportPaths: batch,\n+            parentSpanId: span.getId(),\n+            pagesDataDir,\n+            renderOpts,\n+            options,\n+            dir,\n+            distDir,\n+            outDir,\n+            nextConfig,\n+            cacheHandler: nextConfig.cacheHandler,\n+            cacheMaxMemorySize: nextConfig.cacheMaxMemorySize,\n+            fetchCache: true,\n+            fetchCacheKeyPrefix: nextConfig.experimental.fetchCacheKeyPrefix,\n+          })\n+        )\n+      )\n+    ).flat()\n+  }\n+\n+  let initialPhaseExportPaths: ExportPathEntry[] = []\n+  const finalPhaseExportPaths: ExportPathEntry[] = []\n+\n+  if (renderOpts.experimental.dynamicIO) {\n+    for (const exportPath of allExportPaths) {\n+      if (exportPath._allowEmptyStaticShell) {\n+        finalPhaseExportPaths.push(exportPath)\n+      } else {\n+        initialPhaseExportPaths.push(exportPath)\n+      }\n+    }\n+  } else {\n+    initialPhaseExportPaths = allExportPaths\n+  }\n \n   const progress = createProgress(\n-    filteredPaths.length,\n+    initialPhaseExportPaths.length + finalPhaseExportPaths.length,\n     options.statusMessage || 'Exporting'\n   )\n \n@@ -588,29 +638,11 @@ async function exportAppImpl(\n     progress,\n   })\n \n-  const results = (\n-    await Promise.all(\n-      chunks.map((paths) =>\n-        worker.exportPages({\n-          buildId,\n-          paths,\n-          exportPathMap,\n-          parentSpanId: span.getId(),\n-          pagesDataDir,\n-          renderOpts,\n-          options,\n-          dir,\n-          distDir,\n-          outDir,\n-          nextConfig,\n-          cacheHandler: nextConfig.cacheHandler,\n-          cacheMaxMemorySize: nextConfig.cacheMaxMemorySize,\n-          fetchCache: true,\n-          fetchCacheKeyPrefix: nextConfig.experimental.fetchCacheKeyPrefix,\n-        })\n-      )\n-    )\n-  ).flat()\n+  const results = await exportPagesInBatches(worker, initialPhaseExportPaths)\n+\n+  if (finalPhaseExportPaths.length > 0) {\n+    results.push(...(await exportPagesInBatches(worker, finalPhaseExportPaths)))\n+  }\n \n   let hadValidationError = false\n \n@@ -621,15 +653,15 @@ async function exportAppImpl(\n     turborepoAccessTraceResults: new Map(),\n   }\n \n-  for (const { result, path, pageKey } of results) {\n+  const failedExportAttemptsByPage: Map<string, boolean> = new Map()\n+\n+  for (const { result, path, page, pageKey } of results) {\n     if (!result) continue\n     if ('error' in result) {\n       failedExportAttemptsByPage.set(pageKey, true)\n       continue\n     }\n \n-    const { page } = exportPathMap[path]\n-\n     if (result.turborepoAccessTraceResult) {\n       collector.turborepoAccessTraceResults?.set(\n         path,"
        },
        {
            "sha": "b718557d16b798b58ec743efb22444688059f12c",
            "filename": "packages/next/src/export/types.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts?ref=711b1bad5fff3045bc880c88ca4c384d47b48fd3",
            "patch": "@@ -21,12 +21,13 @@ export interface AmpValidation {\n   }\n }\n \n-type PathMap = ExportPathMap[keyof ExportPathMap]\n+export type ExportPathEntry = ExportPathMap[keyof ExportPathMap] & {\n+  path: string\n+}\n \n export interface ExportPagesInput {\n   buildId: string\n-  paths: string[]\n-  exportPathMap: ExportPathMap\n+  exportPaths: ExportPathEntry[]\n   parentSpanId: number\n   dir: string\n   distDir: string\n@@ -43,8 +44,7 @@ export interface ExportPagesInput {\n \n export interface ExportPageInput {\n   buildId: string\n-  path: string\n-  pathMap: PathMap\n+  exportPath: ExportPathEntry\n   distDir: string\n   outDir: string\n   pagesDataDir: string\n@@ -86,6 +86,7 @@ export type ExportPageResult = ExportRouteResult & {\n export type ExportPagesResult = {\n   result: ExportPageResult | undefined\n   path: string\n+  page: string\n   pageKey: string\n }[]\n "
        },
        {
            "sha": "c6b66272943052b43c81367aa630988ba80a3b61",
            "filename": "packages/next/src/export/worker.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 39,
            "changes": 83,
            "blob_url": "https://github.com/vercel/next.js/blob/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts?ref=711b1bad5fff3045bc880c88ca4c384d47b48fd3",
            "patch": "@@ -5,6 +5,7 @@ import type {\n   ExportRouteResult,\n   WorkerRenderOpts,\n   ExportPagesResult,\n+  ExportPathEntry,\n } from './types'\n \n import '../server/node-environment'\n@@ -69,8 +70,7 @@ async function exportPageImpl(\n   fileWriter: MultiFileWriter\n ): Promise<ExportRouteResult | undefined> {\n   const {\n-    path,\n-    pathMap,\n+    exportPath,\n     distDir,\n     pagesDataDir,\n     buildExport = false,\n@@ -83,13 +83,17 @@ async function exportPageImpl(\n     ampValidatorPath,\n     trailingSlash,\n     sriEnabled,\n+    renderOpts: commonRenderOpts,\n+    outDir: commonOutDir,\n+    buildId,\n   } = input\n \n   if (enableExperimentalReact) {\n     process.env.__NEXT_EXPERIMENTAL_REACT = 'true'\n   }\n \n   const {\n+    path,\n     page,\n \n     // The parameters that are currently unknown.\n@@ -111,31 +115,31 @@ async function exportPageImpl(\n \n     // Pull the original query out.\n     query: originalQuery = {},\n-  } = pathMap\n+  } = exportPath\n \n   const fallbackRouteParams: FallbackRouteParams | null =\n     getFallbackRouteParams(_fallbackRouteParams)\n \n   let query = { ...originalQuery }\n   const pathname = normalizeAppPath(page)\n   const isDynamic = isDynamicRoute(page)\n-  const outDir = isAppDir ? join(distDir, 'server/app') : input.outDir\n+  const outDir = isAppDir ? join(distDir, 'server/app') : commonOutDir\n \n   const filePath = normalizePagePath(path)\n   const ampPath = `${filePath}.amp`\n   let renderAmpPath = ampPath\n \n-  let updatedPath = pathMap._ssgPath || path\n-  let locale = pathMap._locale || input.renderOpts.locale\n+  let updatedPath = exportPath._ssgPath || path\n+  let locale = exportPath._locale || commonRenderOpts.locale\n \n-  if (input.renderOpts.locale) {\n-    const localePathResult = normalizeLocalePath(path, input.renderOpts.locales)\n+  if (commonRenderOpts.locale) {\n+    const localePathResult = normalizeLocalePath(path, commonRenderOpts.locales)\n \n     if (localePathResult.detectedLocale) {\n       updatedPath = localePathResult.pathname\n       locale = localePathResult.detectedLocale\n \n-      if (locale === input.renderOpts.defaultLocale) {\n+      if (locale === commonRenderOpts.defaultLocale) {\n         renderAmpPath = `${normalizePagePath(updatedPath)}.amp`\n       }\n     }\n@@ -148,7 +152,7 @@ async function exportPageImpl(\n   // Check if the page is a specified dynamic route\n   const { pathname: nonLocalizedPath } = normalizeLocalePath(\n     path,\n-    input.renderOpts.locales\n+    commonRenderOpts.locales\n   )\n \n   let params: Params | undefined\n@@ -182,8 +186,8 @@ async function exportPageImpl(\n   if (\n     locale &&\n     buildExport &&\n-    input.renderOpts.domainLocales &&\n-    input.renderOpts.domainLocales.some(\n+    commonRenderOpts.domainLocales &&\n+    commonRenderOpts.domainLocales.some(\n       (dl) => dl.defaultLocale === locale || dl.locales?.includes(locale || '')\n     )\n   ) {\n@@ -192,7 +196,7 @@ async function exportPageImpl(\n \n   envConfig.setConfig({\n     serverRuntimeConfig,\n-    publicRuntimeConfig: input.renderOpts.runtimeConfig,\n+    publicRuntimeConfig: commonRenderOpts.runtimeConfig,\n   })\n \n   const getHtmlFilename = (p: string) =>\n@@ -244,18 +248,18 @@ async function exportPageImpl(\n       params,\n       page,\n       components.routeModule as AppRouteRouteModule,\n-      input.renderOpts.incrementalCache,\n-      input.renderOpts.cacheLifeProfiles,\n+      commonRenderOpts.incrementalCache,\n+      commonRenderOpts.cacheLifeProfiles,\n       htmlFilepath,\n       fileWriter,\n-      input.renderOpts.experimental,\n-      input.buildId\n+      commonRenderOpts.experimental,\n+      buildId\n     )\n   }\n \n   const renderOpts: WorkerRenderOpts = {\n     ...components,\n-    ...input.renderOpts,\n+    ...commonRenderOpts,\n     ampPath: renderAmpPath,\n     params,\n     optimizeCss,\n@@ -269,7 +273,7 @@ async function exportPageImpl(\n     serveStreamingMetadata: true,\n     allowEmptyStaticShell,\n     experimental: {\n-      ...input.renderOpts.experimental,\n+      ...commonRenderOpts.experimental,\n       isRoutePPREnabled,\n     },\n   }\n@@ -280,9 +284,7 @@ async function exportPageImpl(\n \n   // Handle App Pages\n   if (isAppDir) {\n-    const sharedContext: AppSharedContext = {\n-      buildId: input.buildId,\n-    }\n+    const sharedContext: AppSharedContext = { buildId }\n \n     return exportAppPage(\n       req,\n@@ -302,13 +304,13 @@ async function exportPageImpl(\n   }\n \n   const sharedContext: PagesSharedContext = {\n-    buildId: input.buildId,\n-    deploymentId: input.renderOpts.deploymentId,\n+    buildId,\n+    deploymentId: commonRenderOpts.deploymentId,\n     customServer: undefined,\n   }\n \n   const renderContext: PagesRenderContext = {\n-    isFallback: pathMap._pagesFallback ?? false,\n+    isFallback: exportPath._pagesFallback ?? false,\n     isDraftMode: false,\n     developmentNotFoundSourcePage: undefined,\n   }\n@@ -342,8 +344,7 @@ export async function exportPages(\n   input: ExportPagesInput\n ): Promise<ExportPagesResult> {\n   const {\n-    exportPathMap,\n-    paths,\n+    exportPaths,\n     dir,\n     distDir,\n     outDir,\n@@ -385,9 +386,11 @@ export async function exportPages(\n     nextConfig.experimental.staticGenerationMaxConcurrency ?? 8\n   const results: ExportPagesResult = []\n \n-  const exportPageWithRetry = async (path: string, maxAttempts: number) => {\n-    const pathMap = exportPathMap[path]\n-    const { page } = exportPathMap[path]\n+  const exportPageWithRetry = async (\n+    exportPath: ExportPathEntry,\n+    maxAttempts: number\n+  ) => {\n+    const { page, path } = exportPath\n     const pageKey = page !== path ? `${page}: ${path}` : path\n     let attempt = 0\n     let result\n@@ -400,8 +403,7 @@ export async function exportPages(\n       try {\n         result = await Promise.race<ExportPageResult | undefined>([\n           exportPage({\n-            path,\n-            pathMap,\n+            exportPath,\n             distDir,\n             outDir,\n             pagesDataDir,\n@@ -495,16 +497,16 @@ export async function exportPages(\n       attempt++\n     }\n \n-    return { result, path, pageKey }\n+    return { result, path, page, pageKey }\n   }\n \n-  for (let i = 0; i < paths.length; i += maxConcurrency) {\n-    const subset = paths.slice(i, i + maxConcurrency)\n+  for (let i = 0; i < exportPaths.length; i += maxConcurrency) {\n+    const subset = exportPaths.slice(i, i + maxConcurrency)\n \n     const subsetResults = await Promise.all(\n-      subset.map((path) =>\n+      subset.map((exportPath) =>\n         exportPageWithRetry(\n-          path,\n+          exportPath,\n           nextConfig.experimental.staticGenerationRetryCount ?? 1\n         )\n       )\n@@ -519,7 +521,10 @@ export async function exportPages(\n async function exportPage(\n   input: ExportPageInput\n ): Promise<ExportPageResult | undefined> {\n-  trace('export-page', input.parentSpanId).setAttribute('path', input.path)\n+  trace('export-page', input.parentSpanId).setAttribute(\n+    'path',\n+    input.exportPath.path\n+  )\n \n   // Configure the http agent.\n   setHttpClientAndAgentOptions({\n@@ -559,7 +564,7 @@ async function exportPage(\n     }\n   } catch (err) {\n     console.error(\n-      `Error occurred prerendering page \"${input.path}\". Read more: https://nextjs.org/docs/messages/prerender-error`\n+      `Error occurred prerendering page \"${input.exportPath.path}\". Read more: https://nextjs.org/docs/messages/prerender-error`\n     )\n \n     // bailoutToCSRError errors should not leak to the user as they are not actionable; they're"
        },
        {
            "sha": "b2eb73c709a1463e54bbd66a929ee52627050401",
            "filename": "packages/next/src/server/dev/static-paths-worker.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fstatic-paths-worker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/711b1bad5fff3045bc880c88ca4c384d47b48fd3/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fstatic-paths-worker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fstatic-paths-worker.ts?ref=711b1bad5fff3045bc880c88ca4c384d47b48fd3",
            "patch": "@@ -75,7 +75,7 @@ export async function loadStaticPaths({\n   buildId: string\n   authInterrupts: boolean\n   sriEnabled: boolean\n-}): Promise<Partial<StaticPathsResult>> {\n+}): Promise<StaticPathsResult> {\n   // this needs to be initialized before loadComponents otherwise\n   // \"use cache\" could be missing it's cache handlers\n   await createIncrementalCache({"
        },
        {
            "sha": "0e6bcc425fdc0508465b2bc727f61038da215a8c",
            "filename": "test/production/app-dir/build-output-tree-view/build-output-tree-view.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/711b1bad5fff3045bc880c88ca4c384d47b48fd3/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Fbuild-output-tree-view.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/711b1bad5fff3045bc880c88ca4c384d47b48fd3/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Fbuild-output-tree-view.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Fbuild-output-tree-view.test.ts?ref=711b1bad5fff3045bc880c88ca4c384d47b48fd3",
            "patch": "@@ -14,8 +14,6 @@ describe('build-output-tree-view', () => {\n     beforeAll(() => next.build())\n \n     it('should show info about prerendered and dynamic routes in a tree view', async () => {\n-      // TODO: Fix double-listing of the /ppr/[slug] fallback.\n-\n       expect(getTreeView(next.cliOutput)).toMatchInlineSnapshot(`\n        \"Route (app)                      Size  First Load JS  Revalidate  Expire\n        ┌ ○ /_not-found                N/A kB         N/A kB\n@@ -27,7 +25,6 @@ describe('build-output-tree-view', () => {\n        ├ ƒ /dynamic                   N/A kB         N/A kB\n        ├ ◐ /ppr/[slug]                N/A kB         N/A kB          1w     30d\n        ├   ├ /ppr/[slug]                                             1w     30d\n-       ├   ├ /ppr/[slug]                                             1w     30d\n        ├   ├ /ppr/days                                               1d      1w\n        ├   └ /ppr/weeks                                              1w     30d\n        └ ○ /revalidate                N/A kB         N/A kB         15m      1y"
        }
    ],
    "stats": {
        "total": 414,
        "additions": 224,
        "deletions": 190
    }
}