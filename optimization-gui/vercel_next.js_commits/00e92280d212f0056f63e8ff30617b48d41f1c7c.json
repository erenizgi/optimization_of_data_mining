{
    "author": "styfle",
    "message": "feat(next/image)!: add `images.maximumResponseBody` config (#88183)\n\nAdd `images.maximumResponseBody` configuration to exit early when\nattempting to optimize large source images.",
    "sha": "00e92280d212f0056f63e8ff30617b48d41f1c7c",
    "files": [
        {
            "sha": "b69378cbc9bf5289137148a1d78d27ac6d97a0c3",
            "filename": "crates/next-build-test/nextConfig.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/crates%2Fnext-build-test%2FnextConfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/crates%2Fnext-build-test%2FnextConfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-build-test%2FnextConfig.json?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -31,6 +31,7 @@\n     \"minimumCacheTTL\": 60,\n     \"formats\": [\"image/avif\", \"image/webp\"],\n     \"maximumRedirects\": 3,\n+    \"maximumResponseBody\": 300000000,\n     \"dangerouslyAllowLocalIP\": false,\n     \"dangerouslyAllowSVG\": false,\n     \"contentSecurityPolicy\": \"script-src 'none'; frame-src 'none'; sandbox;\","
        },
        {
            "sha": "2c9fe992f4fdf474098983752c0fa49e409aa477",
            "filename": "docs/01-app/03-api-reference/02-components/image.mdx",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -837,6 +837,28 @@ module.exports = {\n }\n ```\n \n+#### `maximumResponseBody`\n+\n+The default image optimization loader will fetch source images up to 300 MB in size.\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  images: {\n+    maximumResponseBody: 300_000_000,\n+  },\n+}\n+```\n+\n+If you know all your source images are small, you can protect memory constrained servers by reducing this to a smaller value such as 50 MB.\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  images: {\n+    maximumResponseBody: 50_000_000,\n+  },\n+}\n+```\n+\n #### `dangerouslyAllowLocalIP`\n \n In rare cases when self-hosting Next.js on a private network, you may want to allow optimizing images from local IP addresses on the same network. This is not recommended for most users because it could allow malicious users to access content on your internal network.\n@@ -1341,6 +1363,7 @@ export default function Home() {\n \n | Version    | Changes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\n | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |\n+| `v16.1.2`  | `maximumResponseBody` configuration added.                                                                                                                                                                                                                                                                                                                                                                                                                                                 |\n | `v16.0.0`  | `qualities` default configuration changed to `[75]`, `preload` prop added, `priority` prop deprecated, `dangerouslyAllowLocalIP` config added, `maximumRedirects` config added.                                                                                                                                                                                                                                                                                                            |\n | `v15.3.0`  | `remotePatterns` added support for array of `URL` objects.                                                                                                                                                                                                                                                                                                                                                                                                                                 |\n | `v15.0.0`  | `contentDispositionType` configuration default changed to `attachment`.                                                                                                                                                                                                                                                                                                                                                                                                                    |"
        },
        {
            "sha": "c20f709f4581ec9f8b16194a164064592dce5870",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -588,6 +588,12 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n         loader: z.enum(VALID_LOADERS).optional(),\n         loaderFile: z.string().optional(),\n         maximumRedirects: z.number().int().min(0).max(20).optional(),\n+        maximumResponseBody: z\n+          .number()\n+          .int()\n+          .min(1)\n+          .max(Number.MAX_SAFE_INTEGER)\n+          .optional(),\n         minimumCacheTTL: z.number().int().gte(0).optional(),\n         path: z.string().optional(),\n         qualities: z"
        },
        {
            "sha": "5e0ab97d17777bf74db9bbffd68fafc905dc5211",
            "filename": "packages/next/src/server/image-optimizer.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 2,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -711,6 +711,7 @@ function isRedirect(statusCode: number) {\n export async function fetchExternalImage(\n   href: string,\n   dangerouslyAllowLocalIP: boolean,\n+  maximumResponseBody: number,\n   count = 3\n ): Promise<ImageUpstream> {\n   if (!dangerouslyAllowLocalIP) {\n@@ -766,7 +767,12 @@ export async function fetchExternalImage(\n       )\n     }\n     const redirect = new URL(locationHeader, href).href\n-    return fetchExternalImage(redirect, dangerouslyAllowLocalIP, count - 1)\n+    return fetchExternalImage(\n+      redirect,\n+      dangerouslyAllowLocalIP,\n+      maximumResponseBody,\n+      count - 1\n+    )\n   }\n \n   if (!res.ok) {\n@@ -777,7 +783,35 @@ export async function fetchExternalImage(\n     )\n   }\n \n-  const buffer = Buffer.from(await res.arrayBuffer())\n+  if (!res.body) {\n+    Log.error('upstream image response is empty for', href)\n+    throw new ImageError(\n+      400,\n+      '\"url\" parameter is valid but upstream response is invalid'\n+    )\n+  }\n+\n+  const chunks: Buffer[] = []\n+  let totalSize = 0\n+\n+  for await (const c of res.body) {\n+    const chunk = Buffer.from(c)\n+    totalSize += chunk.byteLength\n+    if (totalSize > maximumResponseBody) {\n+      Log.error(\n+        'upstream image response exceeded maximum size for',\n+        href,\n+        totalSize\n+      )\n+      throw new ImageError(\n+        413,\n+        '\"url\" parameter is valid but upstream response is invalid'\n+      )\n+    }\n+    chunks.push(chunk)\n+  }\n+\n+  const buffer = Buffer.concat(chunks)\n   const contentType = res.headers.get('Content-Type')\n   const cacheControl = res.headers.get('Cache-Control')\n   const etag = extractEtag(res.headers.get('ETag'), buffer)"
        },
        {
            "sha": "508198d4adc6472ab92da6b4aa5db2b61844dce2",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -785,6 +785,7 @@ export default class NextNodeServer extends BaseServer<\n         ? await fetchExternalImage(\n             href,\n             this.nextConfig.images.dangerouslyAllowLocalIP,\n+            this.nextConfig.images.maximumResponseBody,\n             this.nextConfig.images.maximumRedirects\n           )\n         : await fetchInternalImage("
        },
        {
            "sha": "88269971c200afbf69516bd1330338459d25e2fe",
            "filename": "packages/next/src/shared/lib/image-config.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -106,6 +106,9 @@ export type ImageConfigComplete = {\n   /** @see [Maximum Redirects](https://nextjs.org/docs/api-reference/next/image#maximumredirects) */\n   maximumRedirects: number\n \n+  /** @see [Maximum Response Body](https://nextjs.org/docs/api-reference/next/image#maximumresponsebody) */\n+  maximumResponseBody: number\n+\n   /** @see [Dangerously Allow Local IP](https://nextjs.org/docs/api-reference/next/image#dangerously-allow-local-ip) */\n   dangerouslyAllowLocalIP: boolean\n \n@@ -147,6 +150,7 @@ export const imageConfigDefault: ImageConfigComplete = {\n   minimumCacheTTL: 14400, // 4 hours\n   formats: ['image/webp'],\n   maximumRedirects: 3,\n+  maximumResponseBody: 300_000_000, // 300MB\n   dangerouslyAllowLocalIP: false,\n   dangerouslyAllowSVG: false,\n   contentSecurityPolicy: `script-src 'none'; frame-src 'none'; sandbox;`,"
        },
        {
            "sha": "e9377319ad9f3a325c3cc62a65959f8ee88470a4",
            "filename": "test/integration/next-image-new/app-dir-localpatterns/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Fintegration%2Fnext-image-new%2Fapp-dir-localpatterns%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Fintegration%2Fnext-image-new%2Fapp-dir-localpatterns%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir-localpatterns%2Ftest%2Findex.test.ts?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -98,6 +98,7 @@ function runTests(mode: 'dev' | 'server') {\n             },\n           ],\n           maximumRedirects: 3,\n+          maximumResponseBody: 300000000,\n           minimumCacheTTL: 14400,\n           path: '/_next/image',\n           qualities: [75],"
        },
        {
            "sha": "1c9b30cf7cd5ca25fa8f70fb0e112590a34a85b5",
            "filename": "test/integration/next-image-new/app-dir-qualities/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Fintegration%2Fnext-image-new%2Fapp-dir-qualities%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Fintegration%2Fnext-image-new%2Fapp-dir-qualities%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir-qualities%2Ftest%2Findex.test.ts?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -110,6 +110,7 @@ function runTests(mode: 'dev' | 'server') {\n             },\n           ],\n           maximumRedirects: 3,\n+          maximumResponseBody: 300000000,\n           minimumCacheTTL: 14400,\n           path: '/_next/image',\n           qualities: [42, 69, 88],"
        },
        {
            "sha": "7c68e3af135786eaa08c649188ce8ac57b81738d",
            "filename": "test/integration/next-image-new/app-dir/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -1796,6 +1796,7 @@ function runTests(mode: 'dev' | 'server') {\n             },\n           ],\n           maximumRedirects: 3,\n+          maximumResponseBody: 300000000,\n           minimumCacheTTL: 14400,\n           path: '/_next/image',\n           qualities: [75],"
        },
        {
            "sha": "330e4c9f79acf3a61241a4b2f856fc88035496ef",
            "filename": "test/integration/next-image-new/unicode/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -103,6 +103,7 @@ function runTests(mode: 'server' | 'dev') {\n             },\n           ],\n           maximumRedirects: 3,\n+          maximumResponseBody: 300000000,\n           minimumCacheTTL: 14400,\n           path: '/_next/image',\n           qualities: [75],"
        },
        {
            "sha": "039e4df67783d8411774d49a1d5acea4388850ec",
            "filename": "test/integration/next-image-new/unoptimized/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Fintegration%2Fnext-image-new%2Funoptimized%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Fintegration%2Fnext-image-new%2Funoptimized%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Funoptimized%2Ftest%2Findex.test.ts?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -118,6 +118,7 @@ function runTests(url: string, mode: 'dev' | 'server') {\n             },\n           ],\n           maximumRedirects: 3,\n+          maximumResponseBody: 300000000,\n           minimumCacheTTL: 14400,\n           path: '/_next/image',\n           qualities: [75],"
        },
        {
            "sha": "4be31fda1e3b594642f642897ccc416749a1826f",
            "filename": "test/unit/image-optimizer/fetch-external-image.test.ts",
            "status": "added",
            "additions": 188,
            "deletions": 0,
            "changes": 188,
            "blob_url": "https://github.com/vercel/next.js/blob/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Funit%2Fimage-optimizer%2Ffetch-external-image.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00e92280d212f0056f63e8ff30617b48d41f1c7c/test%2Funit%2Fimage-optimizer%2Ffetch-external-image.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fimage-optimizer%2Ffetch-external-image.test.ts?ref=00e92280d212f0056f63e8ff30617b48d41f1c7c",
            "patch": "@@ -0,0 +1,188 @@\n+/* eslint-env jest */\n+import {\n+  fetchExternalImage,\n+  ImageError,\n+} from 'next/dist/server/image-optimizer'\n+\n+describe('fetchExternalImage', () => {\n+  describe('response size limit', () => {\n+    it('should throw error when response has no body', async () => {\n+      global.fetch = jest.fn().mockResolvedValue({\n+        ok: true,\n+        status: 200,\n+        body: null,\n+        headers: {\n+          get: jest.fn(() => null),\n+        },\n+      })\n+\n+      const error = await fetchExternalImage(\n+        'http://example.com/no-body.jpg',\n+        false,\n+        300_000_000\n+      ).catch((e) => e)\n+\n+      expect(error).toBeInstanceOf(ImageError)\n+      expect((error as ImageError).statusCode).toBe(400)\n+      expect((error as ImageError).message).toBe(\n+        '\"url\" parameter is valid but upstream response is invalid'\n+      )\n+    })\n+\n+    it('should throw error when exceeding maximumResponseBody config on later chunk', async () => {\n+      const maximumResponseBody = 2_000 // 2KB custom limit\n+      const chunkSize = 1_000 // 1KB chunks\n+      const numChunks = 3 // 3KB total, exceeds custom 2KB limit\n+\n+      global.fetch = jest.fn().mockImplementation(() => {\n+        let chunksRead = 0\n+        const mockReadableStream = new ReadableStream({\n+          async pull(controller) {\n+            if (chunksRead < numChunks) {\n+              controller.enqueue(new Uint8Array(chunkSize))\n+              chunksRead++\n+            } else {\n+              controller.close()\n+            }\n+          },\n+        })\n+\n+        return Promise.resolve({\n+          ok: true,\n+          status: 200,\n+          body: mockReadableStream,\n+          headers: {\n+            get: jest.fn((header: string) => {\n+              if (header === 'Content-Type') return 'image/jpeg'\n+              return null\n+            }),\n+          },\n+        })\n+      })\n+\n+      const error = await fetchExternalImage(\n+        'http://example.com/custom-limit.jpg',\n+        false,\n+        maximumResponseBody\n+      ).catch((e) => e)\n+\n+      expect(error).toBeInstanceOf(ImageError)\n+      expect((error as ImageError).statusCode).toBe(413)\n+      expect((error as ImageError).message).toBe(\n+        '\"url\" parameter is valid but upstream response is invalid'\n+      )\n+    })\n+\n+    it('should throw error when exceeding maximumResponseBody config on first chunk', async () => {\n+      const maximumResponseBody = 2_000 // 2KB custom limit\n+\n+      global.fetch = jest.fn().mockImplementation(() => {\n+        const mockReadableStream = new ReadableStream({\n+          async pull(controller) {\n+            controller.enqueue(new Uint8Array(maximumResponseBody + 1))\n+            controller.close()\n+          },\n+        })\n+\n+        return Promise.resolve({\n+          ok: true,\n+          status: 200,\n+          body: mockReadableStream,\n+          headers: {\n+            get: jest.fn((header: string) => {\n+              if (header === 'Content-Type') return 'image/jpeg'\n+              return null\n+            }),\n+          },\n+        })\n+      })\n+\n+      const error = await fetchExternalImage(\n+        'http://example.com/custom-limit.jpg',\n+        false,\n+        maximumResponseBody\n+      ).catch((e) => e)\n+\n+      expect(error).toBeInstanceOf(ImageError)\n+      expect((error as ImageError).statusCode).toBe(413)\n+      expect((error as ImageError).message).toBe(\n+        '\"url\" parameter is valid but upstream response is invalid'\n+      )\n+    })\n+\n+    it('should succeed when exactly matching maximumResponseBody config on first chunk', async () => {\n+      const maximumResponseBody = 3_000 // 3KB custom limit\n+\n+      global.fetch = jest.fn().mockImplementation(() => {\n+        const mockReadableStream = new ReadableStream({\n+          async pull(controller) {\n+            controller.enqueue(new Uint8Array(maximumResponseBody))\n+            controller.close()\n+          },\n+        })\n+\n+        return Promise.resolve({\n+          ok: true,\n+          status: 200,\n+          body: mockReadableStream,\n+          headers: {\n+            get: jest.fn((header: string) => {\n+              if (header === 'Content-Type') return 'image/jpeg'\n+              return null\n+            }),\n+          },\n+        })\n+      })\n+\n+      const result = await fetchExternalImage(\n+        'http://example.com/custom-limit.jpg',\n+        false,\n+        maximumResponseBody\n+      )\n+\n+      expect(result.buffer).toBeInstanceOf(Buffer)\n+      expect(result.buffer.length).toBe(maximumResponseBody)\n+    })\n+\n+    it('should succeed when exactly matching maximumResponseBody config on later chunk', async () => {\n+      const maximumResponseBody = 3_000 // 3KB custom limit\n+      const chunkSize = 1_000 // 1KB chunks\n+      const numChunks = 3 // 3KB total\n+\n+      global.fetch = jest.fn().mockImplementation(() => {\n+        let chunksRead = 0\n+        const mockReadableStream = new ReadableStream({\n+          async pull(controller) {\n+            if (chunksRead < numChunks) {\n+              controller.enqueue(new Uint8Array(chunkSize))\n+              chunksRead++\n+            } else {\n+              controller.close()\n+            }\n+          },\n+        })\n+\n+        return Promise.resolve({\n+          ok: true,\n+          status: 200,\n+          body: mockReadableStream,\n+          headers: {\n+            get: jest.fn((header: string) => {\n+              if (header === 'Content-Type') return 'image/jpeg'\n+              return null\n+            }),\n+          },\n+        })\n+      })\n+\n+      const result = await fetchExternalImage(\n+        'http://example.com/custom-limit.jpg',\n+        false,\n+        maximumResponseBody\n+      )\n+\n+      expect(result.buffer).toBeInstanceOf(Buffer)\n+      expect(result.buffer.length).toBe(maximumResponseBody)\n+    })\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 266,
        "additions": 264,
        "deletions": 2
    }
}