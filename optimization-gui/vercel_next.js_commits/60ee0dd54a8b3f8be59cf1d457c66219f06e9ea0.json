{
    "author": "sokra",
    "message": "Turbopack: reduce temp allocation during compute_blocks (#81459)\n\n### What?\n\nReduce allocation size a little bit.",
    "sha": "60ee0dd54a8b3f8be59cf1d457c66219f06e9ea0",
    "files": [
        {
            "sha": "b935ff6ac87715c5dc9f0ae48ae052617a88d809",
            "filename": "turbopack/crates/turbo-persistence/src/static_sorted_file_builder.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/60ee0dd54a8b3f8be59cf1d457c66219f06e9ea0/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/60ee0dd54a8b3f8be59cf1d457c66219f06e9ea0/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs?ref=60ee0dd54a8b3f8be59cf1d457c66219f06e9ea0",
            "patch": "@@ -237,7 +237,7 @@ impl<'a> StaticSortedFileBuilder<'a> {\n         // Last block is Index block\n \n         // Store the locations of the values\n-        let mut value_locations: Vec<(usize, usize)> = Vec::with_capacity(entries.len());\n+        let mut value_locations: Vec<(u16, u32)> = Vec::with_capacity(entries.len());\n \n         // Split the values into blocks\n         let mut current_block_start = 0;\n@@ -249,7 +249,7 @@ impl<'a> StaticSortedFileBuilder<'a> {\n                     if current_block_size + value.len() > MAX_SMALL_VALUE_BLOCK_SIZE\n                         || current_block_count + 1 >= MAX_SMALL_VALUE_BLOCK_ENTRIES\n                     {\n-                        let block_index = self.blocks.len();\n+                        let block_index = self.blocks.len().try_into().unwrap();\n                         let mut block = Vec::with_capacity(current_block_size);\n                         for j in current_block_start..i {\n                             if let EntryValue::Small { value } = &entries[j].value() {\n@@ -262,12 +262,13 @@ impl<'a> StaticSortedFileBuilder<'a> {\n                         current_block_size = 0;\n                         current_block_count = 0;\n                     }\n-                    value_locations.push((0, current_block_size));\n+                    value_locations.push((0, current_block_size.try_into().unwrap()));\n                     current_block_size += value.len();\n                     current_block_count += 1;\n                 }\n                 EntryValue::Medium { value } => {\n-                    value_locations.push((self.blocks.len(), value.len()));\n+                    let block_index = self.blocks.len().try_into().unwrap();\n+                    value_locations.push((block_index, 0));\n                     self.blocks.push(self.compress_value_block(value));\n                 }\n                 _ => {\n@@ -276,7 +277,7 @@ impl<'a> StaticSortedFileBuilder<'a> {\n             }\n         }\n         if current_block_count > 0 {\n-            let block_index = self.blocks.len();\n+            let block_index = self.blocks.len().try_into().unwrap();\n             let mut block = Vec::with_capacity(current_block_size);\n             for j in current_block_start..entries.len() {\n                 if let EntryValue::Small { value } = &entries[j].value() {\n@@ -292,20 +293,20 @@ impl<'a> StaticSortedFileBuilder<'a> {\n         // Split the keys into blocks\n         fn add_entry_to_block<E: Entry>(\n             entry: &E,\n-            value_location: &(usize, usize),\n+            value_location: &(u16, u32),\n             block: &mut KeyBlockBuilder,\n         ) {\n             match entry.value() {\n                 EntryValue::Small { value } => {\n                     block.put_small(\n                         entry,\n-                        value_location.0.try_into().unwrap(),\n-                        value_location.1.try_into().unwrap(),\n+                        value_location.0,\n+                        value_location.1,\n                         value.len().try_into().unwrap(),\n                     );\n                 }\n                 EntryValue::Medium { .. } => {\n-                    block.put_medium(entry, value_location.0.try_into().unwrap());\n+                    block.put_medium(entry, value_location.0);\n                 }\n                 EntryValue::Large { blob } => {\n                     block.put_blob(entry, blob);"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 10,
        "deletions": 9
    }
}