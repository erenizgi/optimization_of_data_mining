{
    "author": "ztanner",
    "message": "[dev-overlay]: hiding devtools shouldn't hide errors (#76399)\n\nCurrently when you select \"Hide Dev Tools\", if an error comes in you\nwon't see the error indicator anymore.\n\nThis follows the same treatment as when the indicator is disabled in\nnext config, which is to only show you errors, and not the regular\nindicator/popover.",
    "sha": "025657cf9090ffca24bc29b05d9316746291c29e",
    "files": [
        {
            "sha": "b6a5069d46af0ebedb5d082c874547e367e01eb8",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/dev-tools-indicator.tsx",
            "status": "modified",
            "additions": 15,
            "deletions": 16,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/025657cf9090ffca24bc29b05d9316746291c29e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/025657cf9090ffca24bc29b05d9316746291c29e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx?ref=025657cf9090ffca24bc29b05d9316746291c29e",
            "patch": "@@ -36,24 +36,23 @@ export function DevToolsIndicator({\n   // Technically this prop isn't needed, but useful for testing.\n   position?: DevToolsIndicatorPosition\n }) {\n-  const [isDevToolsIndicatorOpen, setIsDevToolsIndicatorOpen] = useState(true)\n+  const [isDevToolsIndicatorVisible, setIsDevToolsIndicatorVisible] =\n+    useState(true)\n \n   return (\n-    isDevToolsIndicatorOpen && (\n-      <DevToolsPopover\n-        semver={state.versionInfo.installed}\n-        issueCount={errorCount}\n-        isStaticRoute={state.staticIndicator}\n-        hide={() => {\n-          setIsDevToolsIndicatorOpen(false)\n-        }}\n-        setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n-        isTurbopack={!!process.env.TURBOPACK}\n-        position={position}\n-        disabled={state.disableDevIndicator}\n-        isBuildError={isBuildError}\n-      />\n-    )\n+    <DevToolsPopover\n+      semver={state.versionInfo.installed}\n+      issueCount={errorCount}\n+      isStaticRoute={state.staticIndicator}\n+      hide={() => {\n+        setIsDevToolsIndicatorVisible(false)\n+      }}\n+      setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n+      isTurbopack={!!process.env.TURBOPACK}\n+      position={position}\n+      disabled={state.disableDevIndicator || !isDevToolsIndicatorVisible}\n+      isBuildError={isBuildError}\n+    />\n   )\n }\n "
        },
        {
            "sha": "84e3d8d8a54a1c67d2f7c805ca7adca2b8e95112",
            "filename": "test/development/client-dev-overlay/index.test.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 18,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/025657cf9090ffca24bc29b05d9316746291c29e/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/025657cf9090ffca24bc29b05d9316746291c29e/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts?ref=025657cf9090ffca24bc29b05d9316746291c29e",
            "patch": "@@ -2,7 +2,7 @@ import { createNext, FileRef } from 'e2e-utils'\n import webdriver, { BrowserInterface } from 'next-webdriver'\n import { NextInstance } from 'e2e-utils'\n import { join } from 'path'\n-import { check } from 'next-test-utils'\n+import { retry } from 'next-test-utils'\n \n describe('client-dev-overlay', () => {\n   let next: NextInstance\n@@ -30,6 +30,7 @@ describe('client-dev-overlay', () => {\n     fullScreenDialog: '[data-nextjs-dialog]',\n     toast: '[data-nextjs-toast]',\n     popover: '[data-nextjs-dev-tools-button]',\n+    indicator: '[data-next-badge-root]',\n     minimizeButton: 'body',\n     hideButton: '[data-hide-dev-tools]',\n   }\n@@ -50,13 +51,11 @@ describe('client-dev-overlay', () => {\n     await getMinimizeButton().click()\n     await getToast().click()\n \n-    await check(async () => {\n-      return (await elementExistsInNextJSPortalShadowDOM(\n-        selectors.fullScreenDialog\n-      ))\n-        ? 'success'\n-        : 'missing'\n-    }, 'success')\n+    await retry(async () => {\n+      expect(\n+        await elementExistsInNextJSPortalShadowDOM(selectors.fullScreenDialog)\n+      ).toBe(true)\n+    })\n   })\n \n   it('should be able to minimize the fullscreen overlay', async () => {\n@@ -66,22 +65,46 @@ describe('client-dev-overlay', () => {\n     )\n   })\n \n-  it('should be able to hide the minimized overlay', async () => {\n+  it('should keep the error indicator visible when there are errors', async () => {\n     await getMinimizeButton().click()\n     await getPopover().click()\n     await getHideButton().click()\n \n-    await check(async () => {\n-      const exists = await elementExistsInNextJSPortalShadowDOM(selectors.toast)\n-      return exists ? 'found' : 'success'\n-    }, 'success')\n+    await retry(async () => {\n+      const display = await browser.eval(\n+        `getComputedStyle(document.querySelector('nextjs-portal').shadowRoot.querySelector('${selectors.indicator}')).display`\n+      )\n+      expect(display).toBe('block')\n+    })\n+  })\n+\n+  it('should be possible to hide the minimized overlay when there are no errors', async () => {\n+    const originalContent = await next.readFile('pages/index.js')\n+    try {\n+      await next.patchFile('pages/index.js', (content) => {\n+        return content.replace(`throw Error('example runtime error')`, '')\n+      })\n+\n+      await getMinimizeButton().click()\n+      await getPopover().click()\n+      await getHideButton().click()\n+\n+      await retry(async () => {\n+        const display = await browser.eval(\n+          `getComputedStyle(document.querySelector('nextjs-portal').shadowRoot.querySelector('${selectors.indicator}')).display`\n+        )\n+        expect(display).toBe('none')\n+      })\n+    } finally {\n+      await next.patchFile('pages/index.js', originalContent)\n+    }\n   })\n \n   it('should have a role of \"dialog\" if the page is focused', async () => {\n-    await check(async () => {\n-      return (await elementExistsInNextJSPortalShadowDOM('[role=\"dialog\"]'))\n-        ? 'exists'\n-        : 'missing'\n-    }, 'exists')\n+    await retry(async () => {\n+      expect(\n+        await elementExistsInNextJSPortalShadowDOM('[role=\"dialog\"]')\n+      ).toBe(true)\n+    })\n   })\n })"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 56,
        "deletions": 34
    }
}