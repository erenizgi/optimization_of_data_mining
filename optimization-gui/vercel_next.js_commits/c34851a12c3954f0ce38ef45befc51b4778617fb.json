{
    "author": "timneutkens",
    "message": "Turbopack: Allow fully dynamic import() in node_modules (#79153)\n\n## What?\n\nAllows e.g. ```import(`${url}`)``` when in node_modules. This makes\nmonaco-editor work automatically when it's correctly imported in e.g. a\n`useEffect`.\n\n- [x] Apply change \n- [x] Verify against local reproduction\n- [x] Add test case\n\nFixes #72613\nFixes PACK-4602",
    "sha": "c34851a12c3954f0ce38ef45befc51b4778617fb",
    "files": [
        {
            "sha": "791a025b6c8f2e967521eb212f085689ad3a0426",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c34851a12c3954f0ce38ef45befc51b4778617fb/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c34851a12c3954f0ce38ef45befc51b4778617fb/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=c34851a12c3954f0ce38ef45befc51b4778617fb",
            "patch": "@@ -357,6 +357,8 @@ pub async fn get_client_module_options_context(\n     let foreign_codes_options_context = ModuleOptionsContext {\n         ecmascript: EcmascriptOptionsContext {\n             enable_typeof_window_inlining: None,\n+            // Ignore e.g. import(`${url}`) requests in node_modules.\n+            ignore_dynamic_requests: true,\n             ..module_options_context.ecmascript\n         },\n         enable_webpack_loaders: foreign_enable_webpack_loaders,"
        },
        {
            "sha": "cc25de95cd6dd3aef602221f5f63efef5dfc6c1c",
            "filename": "test/e2e/app-dir/monaco-editor/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fapp%2Flayout.tsx?ref=c34851a12c3954f0ce38ef45befc51b4778617fb",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: Readonly<{\n+  children: React.ReactNode\n+}>) {\n+  return (\n+    <html lang=\"en\" className=\"w-full h-full\">\n+      <body className={`w-full h-full`}>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "79fc54b2a2b6d5ba06bbdd4c05fe555ca6d2a49c",
            "filename": "test/e2e/app-dir/monaco-editor/app/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fapp%2Fpage.tsx?ref=c34851a12c3954f0ce38ef45befc51b4778617fb",
            "patch": "@@ -0,0 +1,9 @@\n+import { Editor } from '../components/editor/editor'\n+export default function Home() {\n+  return (\n+    <>\n+      <h1>Editor Page</h1>\n+      <Editor />\n+    </>\n+  )\n+}"
        },
        {
            "sha": "245960955116d76d748f3bcad4ce8328a50e02fa",
            "filename": "test/e2e/app-dir/monaco-editor/components/editor/editor.tsx",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fcomponents%2Feditor%2Feditor.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fcomponents%2Feditor%2Feditor.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fcomponents%2Feditor%2Feditor.tsx?ref=c34851a12c3954f0ce38ef45befc51b4778617fb",
            "patch": "@@ -0,0 +1,44 @@\n+'use client'\n+\n+import { RefObject, Suspense, use, useEffect, useRef } from 'react'\n+\n+// The monaco module uses `window` in the module scope, so when it executes it immediately throws.\n+// In order to avoid executing it on the server it's only imported in the browser.\n+// We leverage `use` to wait for the promise.\n+const maybeMonaco = typeof window === 'undefined' ? null : import('./monaco')\n+\n+function LazyMonaco({\n+  editorRef,\n+}: {\n+  editorRef: RefObject<HTMLDivElement | null>\n+}) {\n+  const { monaco } = maybeMonaco === null ? {} : use(maybeMonaco)\n+\n+  useEffect(() => {\n+    if (monaco && editorRef.current) {\n+      const monacoEditor = monaco.editor.create(editorRef.current, {\n+        value: \"console.log('Hello, world!');\",\n+        language: 'javascript',\n+        automaticLayout: true,\n+      })\n+\n+      return () => {\n+        monacoEditor.dispose()\n+      }\n+    }\n+  }, [monaco, editorRef])\n+\n+  return null\n+}\n+\n+export function Editor() {\n+  const editorRef = useRef<HTMLDivElement>(null)\n+  return (\n+    <>\n+      <Suspense fallback=\"initalizing monaco\">\n+        <LazyMonaco editorRef={editorRef} />\n+        <div id=\"editor\" ref={editorRef} className=\"h-full\" />\n+      </Suspense>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "794036098877e23ca001e74c8c5fd43e5e5eec4d",
            "filename": "test/e2e/app-dir/monaco-editor/components/editor/monaco.ts",
            "status": "added",
            "additions": 152,
            "deletions": 0,
            "changes": 152,
            "blob_url": "https://github.com/vercel/next.js/blob/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fcomponents%2Feditor%2Fmonaco.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fcomponents%2Feditor%2Fmonaco.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fcomponents%2Feditor%2Fmonaco.ts?ref=c34851a12c3954f0ce38ef45befc51b4778617fb",
            "patch": "@@ -0,0 +1,152 @@\n+// (1) Desired editor features:\n+// BEGIN_FEATURES\n+// import \"monaco-editor/esm/vs/editor/browser/controller/coreCommands.js\";\n+// import 'monaco-editor/esm/vs/editor/browser/widget/codeEditorWidget.js';\n+// import 'monaco-editor/esm/vs/editor/browser/widget/diffEditorWidget.js';\n+// import 'monaco-editor/esm/vs/editor/browser/widget/diffNavigator.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/anchorSelect/anchorSelect.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/bracketMatching/bracketMatching.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/caretOperations/caretOperations.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/caretOperations/transpose.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/clipboard/clipboard.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/codeAction/codeActionContributions.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/codelens/codelensController.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/colorPicker/colorContributions.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/comment/comment.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/contextmenu/contextmenu.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/cursorUndo/cursorUndo.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/dnd/dnd.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/documentSymbols/documentSymbols.js';\n+// import \"monaco-editor/esm/vs/editor/contrib/find/browser/findController.js\";\n+// import 'monaco-editor/esm/vs/editor/contrib/folding/folding.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/fontZoom/fontZoom.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/format/formatActions.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/gotoError/gotoError.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/gotoSymbol/goToCommands.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/gotoSymbol/link/goToDefinitionAtPosition.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/hover/hover.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/inPlaceReplace/inPlaceReplace.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/indentation/indentation.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/inlineHints/inlineHintsController.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/linesOperations/linesOperations.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/linkedEditing/linkedEditing.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/links/links.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/multicursor/multicursor.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/parameterHints/parameterHints.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/rename/rename.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/smartSelect/smartSelect.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/snippet/snippetController2.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/suggest/suggestController.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/toggleTabFocusMode/toggleTabFocusMode.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/unusualLineTerminators/unusualLineTerminators.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/viewportSemanticTokens/viewportSemanticTokens.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/wordHighlighter/wordHighlighter.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/wordOperations/wordOperations.js';\n+// import 'monaco-editor/esm/vs/editor/contrib/wordPartOperations/wordPartOperations.js';\n+// import 'monaco-editor/esm/vs/editor/standalone/browser/accessibilityHelp/accessibilityHelp.js';\n+// import 'monaco-editor/esm/vs/editor/standalone/browser/iPadShowKeyboard/iPadShowKeyboard.js';\n+// import 'monaco-editor/esm/vs/editor/standalone/browser/inspectTokens/inspectTokens.js';\n+// import 'monaco-editor/esm/vs/editor/standalone/browser/quickAccess/standaloneCommandsQuickAccess.js';\n+// import 'monaco-editor/esm/vs/editor/standalone/browser/quickAccess/standaloneGotoLineQuickAccess.js';\n+// import 'monaco-editor/esm/vs/editor/standalone/browser/quickAccess/standaloneGotoSymbolQuickAccess.js';\n+// import 'monaco-editor/esm/vs/editor/standalone/browser/quickAccess/standaloneHelpQuickAccess.js';\n+// import 'monaco-editor/esm/vs/editor/standalone/browser/referenceSearch/standaloneReferenceSearch.js';\n+// import 'monaco-editor/esm/vs/editor/standalone/browser/toggleHighContrast/toggleHighContrast.js';\n+// END_FEATURES\n+import * as monacoModule from 'monaco-editor/esm/vs/editor/editor.api.js'\n+\n+// (2) Desired languages:\n+// BEGIN_LANGUAGES\n+// import 'monaco-editor/esm/vs/language/css/monaco.contribution.js';\n+// import 'monaco-editor/esm/vs/language/html/monaco.contribution.js';\n+// import 'monaco-editor/esm/vs/language/json/monaco.contribution.js';\n+// import 'monaco-editor/esm/vs/language/typescript/monaco.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/abap/abap.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/apex/apex.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/azcli/azcli.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/bat/bat.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/cameligo/cameligo.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/clojure/clojure.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/coffee/coffee.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/cpp/cpp.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/csharp/csharp.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/csp/csp.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/css/css.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/dart/dart.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/dockerfile/dockerfile.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/ecl/ecl.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/fsharp/fsharp.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/go/go.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/graphql/graphql.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/handlebars/handlebars.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/hcl/hcl.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/html/html.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/ini/ini.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/java/java.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/javascript/javascript.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/julia/julia.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/kotlin/kotlin.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/less/less.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/lexon/lexon.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/lua/lua.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/m3/m3.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/markdown/markdown.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/mips/mips.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/msdax/msdax.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/mysql/mysql.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/objective-c/objective-c.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/pascal/pascal.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/pascaligo/pascaligo.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/perl/perl.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/pgsql/pgsql.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/php/php.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/postiats/postiats.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/powerquery/powerquery.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/powershell/powershell.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/pug/pug.contribution.js';\n+import 'monaco-editor/esm/vs/basic-languages/python/python.contribution.js'\n+// import 'monaco-editor/esm/vs/basic-languages/r/r.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/razor/razor.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/redis/redis.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/redshift/redshift.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/restructuredtext/restructuredtext.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/ruby/ruby.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/rust/rust.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/sb/sb.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/scala/scala.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/scheme/scheme.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/scss/scss.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/shell/shell.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/solidity/solidity.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/sophia/sophia.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/sql/sql.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/st/st.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/swift/swift.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/systemverilog/systemverilog.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/tcl/tcl.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/twig/twig.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/typescript/typescript.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/vb/vb.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/xml/xml.contribution.js';\n+// import 'monaco-editor/esm/vs/basic-languages/yaml/yaml.contribution.js';\n+// END_LANGUAGES\n+\n+self.MonacoEnvironment = {\n+  getWorkerUrl: function (moduleId, label) {\n+    // if (label === 'json') {\n+    // \treturn './json.worker.bundle.js';\n+    // }\n+    // if (label === 'css' || label === 'scss' || label === 'less') {\n+    // \treturn './css.worker.bundle.js';\n+    // }\n+    // if (label === 'html' || label === 'handlebars' || label === 'razor') {\n+    // \treturn './html.worker.bundle.js';\n+    // }\n+    // if (label === 'typescript' || label === 'javascript') {\n+    // \treturn './ts.worker.bundle.js';\n+    // }\n+    return './editor.worker.bundle.js'\n+  },\n+}\n+\n+export const monaco = monacoModule"
        },
        {
            "sha": "feb21a922096dc2bd1fc441d95ed97d77f864780",
            "filename": "test/e2e/app-dir/monaco-editor/monaco-editor.test.ts",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fmonaco-editor.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fmonaco-editor.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fmonaco-editor.test.ts?ref=c34851a12c3954f0ce38ef45befc51b4778617fb",
            "patch": "@@ -0,0 +1,19 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('monaco-editor', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    dependencies: {\n+      'monaco-editor': '^0.52.2',\n+    },\n+  })\n+\n+  // Recommended for tests that need a full browser\n+  it('should load monaco-editor', async () => {\n+    const browser = await next.browser('/')\n+    expect(await browser.elementByCss('h1').text()).toBe('Editor Page')\n+    expect(\n+      await browser.waitForElementByCss('.monaco-editor').getAttribute('role')\n+    ).toBe('code')\n+  })\n+})"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/monaco-editor/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c34851a12c3954f0ce38ef45befc51b4778617fb/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmonaco-editor%2Fnext.config.js?ref=c34851a12c3954f0ce38ef45befc51b4778617fb",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 243,
        "additions": 243,
        "deletions": 0
    }
}