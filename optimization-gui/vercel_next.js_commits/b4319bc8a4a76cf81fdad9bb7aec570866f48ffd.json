{
    "author": "icyJoseph",
    "message": "Docs/late aug feedback (#82953)\n\n- I've seen `NextResponse.next({ headers });` where devs likely meant\n`NextResponse.next({ request: { headers } });`\n  - for example https://github.com/vercel/next.js/issues/82937\n- Explaining further `outputFileTracingIncludes-*` options\n\n---------\n\nCo-authored-by: vercel[bot] <35613825+vercel[bot]@users.noreply.github.com>",
    "sha": "b4319bc8a4a76cf81fdad9bb7aec570866f48ffd",
    "files": [
        {
            "sha": "25e799c0d4d69f26378a981524ac9a5dee66af8e",
            "filename": "docs/01-app/01-getting-started/15-route-handlers-and-middleware.mdx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/b4319bc8a4a76cf81fdad9bb7aec570866f48ffd/docs%2F01-app%2F01-getting-started%2F15-route-handlers-and-middleware.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/b4319bc8a4a76cf81fdad9bb7aec570866f48ffd/docs%2F01-app%2F01-getting-started%2F15-route-handlers-and-middleware.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F01-getting-started%2F15-route-handlers-and-middleware.mdx?ref=b4319bc8a4a76cf81fdad9bb7aec570866f48ffd",
            "patch": "@@ -109,7 +109,7 @@ export default function Page() {\n   return <h1>Hello, Next.js!</h1>\n }\n \n-// ❌ Conflict\n+// Conflict\n // `app/route.ts`\n export async function POST(request: Request) {}\n ```\n@@ -119,7 +119,7 @@ export default function Page() {\n   return <h1>Hello, Next.js!</h1>\n }\n \n-// ❌ Conflict\n+// Conflict\n // `app/route.js`\n export async function POST(request) {}\n ```"
        },
        {
            "sha": "8757dcf15c9f5b5713ca71322a6b78d3a25be1d6",
            "filename": "docs/01-app/02-guides/backend-for-frontend.mdx",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/b4319bc8a4a76cf81fdad9bb7aec570866f48ffd/docs%2F01-app%2F02-guides%2Fbackend-for-frontend.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/b4319bc8a4a76cf81fdad9bb7aec570866f48ffd/docs%2F01-app%2F02-guides%2Fbackend-for-frontend.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F02-guides%2Fbackend-for-frontend.mdx?ref=b4319bc8a4a76cf81fdad9bb7aec570866f48ffd",
            "patch": "@@ -647,6 +647,15 @@ export function middleware(request) {\n \n ## Security\n \n+### Working with headers\n+\n+Be deliberate about where headers go, and avoid directly passing incoming request headers to the outgoing response.\n+\n+- **Upstream request headers**: In Middleware, `NextResponse.next({ request: { headers } })` modifies the headers your server receives and does not expose them to the client.\n+- **Response headers**: `new Response(..., { headers })`, `NextResponse.json(..., { headers })`, `NextResponse.next({ headers })`, or `response.headers.set(...)` send headers back to the client. If sensitive values were appended to these headers, they will be visible to clients.\n+\n+Learn more in [NextResponse headers in Middleware](/docs/app/api-reference/functions/next-response#next).\n+\n ### Rate limiting\n \n You can implement rate limiting in your Next.js backend. In addition to code-based checks, enable any rate limiting features provided by your host."
        },
        {
            "sha": "6dc0881b172800fc5d6de776955ffd8e443c2423",
            "filename": "docs/01-app/03-api-reference/03-file-conventions/middleware.mdx",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b4319bc8a4a76cf81fdad9bb7aec570866f48ffd/docs%2F01-app%2F03-api-reference%2F03-file-conventions%2Fmiddleware.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/b4319bc8a4a76cf81fdad9bb7aec570866f48ffd/docs%2F01-app%2F03-api-reference%2F03-file-conventions%2Fmiddleware.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F03-file-conventions%2Fmiddleware.mdx?ref=b4319bc8a4a76cf81fdad9bb7aec570866f48ffd",
            "patch": "@@ -400,6 +400,13 @@ export function middleware(request) {\n }\n ```\n \n+Note that the snippet uses:\n+\n+- `NextResponse.next({ request: { headers: requestHeaders } })` to make `requestHeaders` available upstream\n+- **NOT** `NextResponse.next({ headers: requestHeaders })` which makes `requestHeaders` available to clients\n+\n+Learn more in [NextResponse headers in Middleware](/docs/app/api-reference/functions/next-response#next).\n+\n > **Good to know**: Avoid setting large headers as it might cause [431 Request Header Fields Too Large](https://developer.mozilla.org/docs/Web/HTTP/Status/431) error depending on your backend web server configuration.\n \n ### CORS"
        },
        {
            "sha": "c07803a79fd6df69084e09412afbc67fcfa2a86e",
            "filename": "docs/01-app/03-api-reference/04-functions/next-response.mdx",
            "status": "modified",
            "additions": 48,
            "deletions": 2,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/b4319bc8a4a76cf81fdad9bb7aec570866f48ffd/docs%2F01-app%2F03-api-reference%2F04-functions%2Fnext-response.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/b4319bc8a4a76cf81fdad9bb7aec570866f48ffd/docs%2F01-app%2F03-api-reference%2F04-functions%2Fnext-response.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F04-functions%2Fnext-response.mdx?ref=b4319bc8a4a76cf81fdad9bb7aec570866f48ffd",
            "patch": "@@ -127,7 +127,7 @@ import { NextResponse } from 'next/server'\n return NextResponse.next()\n ```\n \n-You can also forward `headers` when producing the response:\n+You can also forward `headers` upstream when producing the response, using `NextResponse.next({ request: { headers } })`:\n \n ```ts\n import { NextResponse } from 'next/server'\n@@ -136,11 +136,57 @@ import { NextResponse } from 'next/server'\n const newHeaders = new Headers(request.headers)\n // Add a new header\n newHeaders.set('x-version', '123')\n-// And produce a response with the new headers\n+// Forward the modified request headers upstream\n return NextResponse.next({\n   request: {\n     // New request headers\n     headers: newHeaders,\n   },\n })\n ```\n+\n+This forwards `newHeaders` upstream to the target page, route, or server action, and does not expose them to the client. While this pattern is useful for passing data upstream, it should be used with caution because the headers containing this data may be forwarded to external services.\n+\n+In contrast, `NextResponse.next({ headers })` is a shorthand for sending headers from middleware to the client. This is **NOT** good practice and should be avoided. Among other reasons because setting response headers like `Content-Type`, can override framework expectations (for example, the `Content-Type` used by Server Actions), leading to failed submissions or broken streaming responses.\n+\n+```ts\n+import { type NextRequest, NextResponse } from 'next/server'\n+\n+async function middleware(request: NextRequest) {\n+  const headers = await injectAuth(request.headers)\n+  // DO NOT forward headers like this\n+  return NextResponse.next({ headers })\n+}\n+```\n+\n+In general, avoid copying all incoming request headers because doing so can leak sensitive data to clients or upstream services.\n+\n+Prefer a defensive approach by creating a subset of incoming request headers using an allow-list. For example, you might discard custom `x-*` headers and only forward known-safe headers:\n+\n+```ts\n+import { type NextRequest, NextResponse } from 'next/server'\n+\n+function middleware(request: NextRequest) {\n+  const incoming = new Headers(request.headers)\n+  const forwarded = new Headers()\n+\n+  for (const [name, value] of incoming) {\n+    const headerName = name.toLowerCase()\n+    // Keep only known-safe headers, discard custom x-* and other sensitive ones\n+    if (\n+      !headerName.startsWith('x-') &&\n+      headerName !== 'authorization' &&\n+      headerName !== 'cookie'\n+    ) {\n+      // Preserve original header name casing\n+      forwarded.set(name, value)\n+    }\n+  }\n+\n+  return NextResponse.next({\n+    request: {\n+      headers: forwarded,\n+    },\n+  })\n+}\n+```"
        },
        {
            "sha": "4d068fa1bba8d717e6ed5bdc1b185cdfff9876cb",
            "filename": "docs/01-app/03-api-reference/05-config/01-next-config-js/output.mdx",
            "status": "modified",
            "additions": 63,
            "deletions": 2,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/b4319bc8a4a76cf81fdad9bb7aec570866f48ffd/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2Foutput.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/b4319bc8a4a76cf81fdad9bb7aec570866f48ffd/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2Foutput.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2Foutput.mdx?ref=b4319bc8a4a76cf81fdad9bb7aec570866f48ffd",
            "patch": "@@ -69,13 +69,15 @@ node .next/standalone/server.js\n - While tracing in monorepo setups, the project directory is used for tracing by default. For `next build packages/web-app`, `packages/web-app` would be the tracing root and any files outside of that folder will not be included. To include files outside of this folder you can set `outputFileTracingRoot` in your `next.config.js`.\n \n ```js filename=\"packages/web-app/next.config.js\"\n+const path = require('path')\n+\n module.exports = {\n   // this includes files from the monorepo base two directories up\n   outputFileTracingRoot: path.join(__dirname, '../../'),\n }\n ```\n \n-- There are some cases in which Next.js might fail to include required files, or might incorrectly include unused files. In those cases, you can leverage `outputFileTracingExcludes` and `outputFileTracingIncludes` respectively in `next.config.js`. Each config accepts an object with [minimatch globs](https://www.npmjs.com/package/minimatch) for the key to match specific pages and a value of an array with globs relative to the project's root to either include or exclude in the trace.\n+- There are some cases in which Next.js might fail to include required files, or might incorrectly include unused files. In those cases, you can leverage `outputFileTracingExcludes` and `outputFileTracingIncludes` respectively in `next.config.js`. Each option accepts an object whose keys are **route globs** (matched with [picomatch](https://www.npmjs.com/package/picomatch#basic-globbing) against the route path, e.g. `/api/hello`) and whose values are **glob patterns resolved from the project root** that specify files to include or exclude in the trace.\n \n ```js filename=\"next.config.js\"\n module.exports = {\n@@ -91,4 +93,63 @@ module.exports = {\n }\n ```\n \n-**Note:** The key of `outputFileTracingIncludes`/`outputFileTracingExcludes` is a [glob](https://www.npmjs.com/package/picomatch#basic-globbing), so special characters need to be escaped.\n+Using a `src/` directory does not change how you write these options:\n+\n+- **Keys** still match the route path (`'/api/hello'`, `'/products/[id]'`, etc.).\n+- **Values** can reference paths under `src/` since they are resolved relative to the project root.\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  outputFileTracingIncludes: {\n+    '/products/*': ['src/lib/payments/**/*'],\n+    '/*': ['src/config/runtime/**/*.json'],\n+  },\n+  outputFileTracingExcludes: {\n+    '/api/*': ['src/temp/**/*', 'public/large-logs/**/*'],\n+  },\n+}\n+```\n+\n+You can also target all routes using a global key like `'/*'`:\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  outputFileTracingIncludes: {\n+    '/*': ['src/i18n/locales/**/*.json'],\n+  },\n+}\n+```\n+\n+These options are applied to server traces and do not affect routes that do not produce a server trace file:\n+\n+- Edge Runtime routes are not affected.\n+- Fully static pages are not affected.\n+\n+In monorepos or when you need to include files outside the app folder, combine `outputFileTracingRoot` with includes:\n+\n+```js filename=\"next.config.js\"\n+const path = require('path')\n+\n+module.exports = {\n+  // Trace from the monorepo root\n+  outputFileTracingRoot: path.join(__dirname, '../../'),\n+  outputFileTracingIncludes: {\n+    '/route1': ['../shared/assets/**/*'],\n+  },\n+}\n+```\n+\n+> **Good to know**:\n+>\n+> - Prefer forward slashes (`/`) in patterns for cross-platform compatibility.\n+> - Keep patterns as narrow as possible to avoid oversized traces (avoid `**/*` at the repo root).\n+\n+Common include patterns for native/runtime assets:\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  outputFileTracingIncludes: {\n+    '/*': ['node_modules/sharp/**/*', 'node_modules/aws-crt/dist/bin/**/*'],\n+  },\n+}\n+```"
        }
    ],
    "stats": {
        "total": 135,
        "additions": 129,
        "deletions": 6
    }
}