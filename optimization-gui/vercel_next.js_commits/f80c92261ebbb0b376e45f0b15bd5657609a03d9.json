{
    "author": "mischnic",
    "message": "Turbopack: expose client static assets correctly (#84695)\n\nThis is about whether `new URL(\"logo.png\", import.meta.url)` and `import logo from \"./logo.png\"` return a client or a server asset:\n\n- a server asset is a file that will be read by the server during rendering, for example a Wasm or font file (if you think about vercel/og image generation). It's stored on the server next to the JS chunks\n- a client asset is a file that will be used by the browser, e.g. for an `<img src={logo}/>` usecase. It will be stored on the CDN and have the `_next/` prefix.\n\nFor\n\n- client contexts, it's easy: all imports are client assets (unsurprisingly)\n- SSR contexts, we emulate the client (to prevent hydration mismatches)\n- API/metadata context, it's less clear cut what should happen, but we arbitrarily do the following: `new URL` returns server assets and `import logo` returns client assets.\n\nThat very last case of having client assets for imports, and server assets for `new URL` wasn't implemented in Turbopack.\n\nTurbopack doesn't change anything here fundamentally, but Webpack appears to have some bugs where this is less consistent (across nodejs/edge and api/metadata routes for example). See tests added in https://github.com/vercel/next.js/pull/84636\n\nCloses PACK-4874\nCloses PACK-5649\nCloses #80577",
    "sha": "f80c92261ebbb0b376e45f0b15bd5657609a03d9",
    "files": [
        {
            "sha": "463e79210f2188d37cc66e6d209e2119e0487198",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 10,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -1082,13 +1082,11 @@ impl Project {\n             no_mangling: self.no_mangling(),\n             scope_hoisting: self.next_config().turbo_scope_hoisting(self.next_mode()),\n             debug_ids: self.next_config().turbopack_debug_ids(),\n+            client_root: self.client_relative_path().owned().await?,\n+            asset_prefix: self.next_config().computed_asset_prefix().owned().await?,\n         };\n         Ok(if client_assets {\n-            get_server_chunking_context_with_client_assets(\n-                options,\n-                self.client_relative_path().owned().await?,\n-                self.next_config().computed_asset_prefix().owned().await?,\n-            )\n+            get_server_chunking_context_with_client_assets(options)\n         } else {\n             get_server_chunking_context(options)\n         })\n@@ -1111,13 +1109,11 @@ impl Project {\n             turbo_source_maps: self.next_config().server_source_maps(),\n             no_mangling: self.no_mangling(),\n             scope_hoisting: self.next_config().turbo_scope_hoisting(self.next_mode()),\n+            client_root: self.client_relative_path().owned().await?,\n+            asset_prefix: self.next_config().computed_asset_prefix().owned().await?,\n         };\n         Ok(if client_assets {\n-            get_edge_chunking_context_with_client_assets(\n-                options,\n-                self.client_relative_path().owned().await?,\n-                self.next_config().computed_asset_prefix(),\n-            )\n+            get_edge_chunking_context_with_client_assets(options)\n         } else {\n             get_edge_chunking_context(options)\n         })"
        },
        {
            "sha": "fa5bbd1f2764c1fc306711f30f313a37c9cacf25",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -417,7 +417,7 @@ pub struct ClientChunkingContextOptions {\n     pub root_path: FileSystemPath,\n     pub client_root: FileSystemPath,\n     pub client_root_to_root_path: RcStr,\n-    pub asset_prefix: Vc<Option<RcStr>>,\n+    pub asset_prefix: Vc<RcStr>,\n     pub chunk_suffix_path: Vc<Option<RcStr>>,\n     pub environment: Vc<Environment>,\n     pub module_id_strategy: Vc<Box<dyn ModuleIdStrategy>>,\n@@ -463,7 +463,7 @@ pub async fn get_client_chunking_context(\n         environment.to_resolved().await?,\n         next_mode.runtime_type(),\n     )\n-    .chunk_base_path(asset_prefix.clone())\n+    .chunk_base_path(Some(asset_prefix.clone()))\n     .chunk_suffix_path(chunk_suffix_path)\n     .minify_type(if *minify.await? {\n         MinifyType::Minify {\n@@ -477,7 +477,7 @@ pub async fn get_client_chunking_context(\n     } else {\n         SourceMapsType::None\n     })\n-    .asset_base_path(asset_prefix)\n+    .asset_base_path(Some(asset_prefix))\n     .current_chunk_method(CurrentChunkMethod::DocumentCurrentScript)\n     .export_usage(*export_usage.await?)\n     .module_id_strategy(module_id_strategy.to_resolved().await?)"
        },
        {
            "sha": "90e7f277cee1f14e190c5340317ea952bfe0695d",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -1672,10 +1672,10 @@ impl NextConfig {\n     /// Returns the final asset prefix. If an assetPrefix is set, it's used.\n     /// Otherwise, the basePath is used.\n     #[turbo_tasks::function]\n-    pub async fn computed_asset_prefix(self: Vc<Self>) -> Result<Vc<Option<RcStr>>> {\n+    pub async fn computed_asset_prefix(self: Vc<Self>) -> Result<Vc<RcStr>> {\n         let this = self.await?;\n \n-        Ok(Vc::cell(Some(\n+        Ok(Vc::cell(\n             format!(\n                 \"{}/_next/\",\n                 if let Some(asset_prefix) = &this.asset_prefix {\n@@ -1686,7 +1686,7 @@ impl NextConfig {\n                 .trim_end_matches('/')\n             )\n             .into(),\n-        )))\n+        ))\n     }\n \n     /// Returns the suffix to use for chunk loading."
        },
        {
            "sha": "12342c26300a70a9fde03ae3b030da6f17330ca5",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -208,13 +208,14 @@ pub struct EdgeChunkingContextOptions {\n     pub turbo_source_maps: Vc<bool>,\n     pub no_mangling: Vc<bool>,\n     pub scope_hoisting: Vc<bool>,\n+    pub client_root: FileSystemPath,\n+    pub asset_prefix: RcStr,\n }\n \n+/// Like `get_edge_chunking_context` but all assets are emitted as client assets (so `/_next`)\n #[turbo_tasks::function]\n pub async fn get_edge_chunking_context_with_client_assets(\n     options: EdgeChunkingContextOptions,\n-    client_root: FileSystemPath,\n-    asset_prefix: ResolvedVc<Option<RcStr>>,\n ) -> Result<Vc<Box<dyn ChunkingContext>>> {\n     let EdgeChunkingContextOptions {\n         mode,\n@@ -228,6 +229,8 @@ pub async fn get_edge_chunking_context_with_client_assets(\n         turbo_source_maps,\n         no_mangling,\n         scope_hoisting,\n+        client_root,\n+        asset_prefix,\n     } = options;\n     let output_root = node_root.join(\"server/edge\")?;\n     let next_mode = mode.await?;\n@@ -241,7 +244,7 @@ pub async fn get_edge_chunking_context_with_client_assets(\n         environment.to_resolved().await?,\n         next_mode.runtime_type(),\n     )\n-    .asset_base_path(asset_prefix.owned().await?)\n+    .asset_base_path(Some(asset_prefix))\n     .minify_type(if *turbo_minify.await? {\n         MinifyType::Minify {\n             // React needs deterministic function names to work correctly.\n@@ -280,6 +283,7 @@ pub async fn get_edge_chunking_context_with_client_assets(\n     Ok(Vc::upcast(builder.build()))\n }\n \n+// By default, assets are server assets, but the StructuredImageModuleType ones are on the client\n #[turbo_tasks::function]\n pub async fn get_edge_chunking_context(\n     options: EdgeChunkingContextOptions,\n@@ -296,6 +300,8 @@ pub async fn get_edge_chunking_context(\n         turbo_source_maps,\n         no_mangling,\n         scope_hoisting,\n+        client_root,\n+        asset_prefix,\n     } = options;\n     let output_root = node_root.join(\"server/edge\")?;\n     let next_mode = mode.await?;\n@@ -309,6 +315,9 @@ pub async fn get_edge_chunking_context(\n         environment.to_resolved().await?,\n         next_mode.runtime_type(),\n     )\n+    .client_roots_override(rcstr!(\"client\"), client_root.clone())\n+    .asset_root_path_override(rcstr!(\"client\"), client_root.join(\"static/media\")?)\n+    .asset_base_path_override(rcstr!(\"client\"), asset_prefix)\n     // Since one can't read files in edge directly, any asset need to be fetched\n     // instead. This special blob url is handled by the custom fetch\n     // implementation in the edge sandbox. It will respond with the"
        },
        {
            "sha": "81c0ad1f2e310c063605a329582bc8b0e08cc7f8",
            "filename": "crates/next-core/src/next_image/module.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_image%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_image%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_image%2Fmodule.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -56,7 +56,9 @@ impl StructuredImageModuleType {\n         blur_placeholder_mode: BlurPlaceholderMode,\n         module_asset_context: ResolvedVc<ModuleAssetContext>,\n     ) -> Result<Vc<Box<dyn Module>>> {\n-        let static_asset = StaticUrlJsModule::new(*source).to_resolved().await?;\n+        let static_asset = StaticUrlJsModule::new(*source, Some(rcstr!(\"client\")))\n+            .to_resolved()\n+            .await?;\n         Ok(module_asset_context\n             .process(\n                 Vc::upcast("
        },
        {
            "sha": "52bb81572148a3fc2023671a3312f7bb357c3e89",
            "filename": "crates/next-core/src/next_manifests/client_reference_manifest.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fclient_reference_manifest.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fclient_reference_manifest.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fclient_reference_manifest.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -165,11 +165,7 @@ async fn build_manifest(\n         let mut entry_manifest: SerializedClientReferenceManifest = Default::default();\n         let mut references = FxIndexSet::default();\n         let chunk_suffix_path = next_config.chunk_suffix_path().owned().await?;\n-        let prefix_path = next_config\n-            .computed_asset_prefix()\n-            .owned()\n-            .await?\n-            .unwrap_or_default();\n+        let prefix_path = next_config.computed_asset_prefix().owned().await?;\n         let suffix_path = chunk_suffix_path.unwrap_or_default();\n \n         // TODO: Add `suffix` to the manifest for React to use."
        },
        {
            "sha": "e1aef0c2c098b9fa9e41d902b54472b5fc9cd5c2",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -998,13 +998,14 @@ pub struct ServerChunkingContextOptions {\n     pub no_mangling: Vc<bool>,\n     pub scope_hoisting: Vc<bool>,\n     pub debug_ids: Vc<bool>,\n+    pub client_root: FileSystemPath,\n+    pub asset_prefix: RcStr,\n }\n \n+/// Like `get_server_chunking_context` but all assets are emitted as client assets (so `/_next`)\n #[turbo_tasks::function]\n pub async fn get_server_chunking_context_with_client_assets(\n     options: ServerChunkingContextOptions,\n-    client_root: FileSystemPath,\n-    asset_prefix: Option<RcStr>,\n ) -> Result<Vc<NodeJsChunkingContext>> {\n     let ServerChunkingContextOptions {\n         mode,\n@@ -1019,6 +1020,8 @@ pub async fn get_server_chunking_context_with_client_assets(\n         no_mangling,\n         scope_hoisting,\n         debug_ids,\n+        client_root,\n+        asset_prefix,\n     } = options;\n \n     let next_mode = mode.await?;\n@@ -1035,7 +1038,7 @@ pub async fn get_server_chunking_context_with_client_assets(\n         environment.to_resolved().await?,\n         next_mode.runtime_type(),\n     )\n-    .asset_prefix(asset_prefix)\n+    .asset_prefix(Some(asset_prefix))\n     .minify_type(if *turbo_minify.await? {\n         MinifyType::Minify {\n             // React needs deterministic function names to work correctly.\n@@ -1080,6 +1083,7 @@ pub async fn get_server_chunking_context_with_client_assets(\n     Ok(builder.build())\n }\n \n+// By default, assets are server assets, but the StructuredImageModuleType ones are on the client\n #[turbo_tasks::function]\n pub async fn get_server_chunking_context(\n     options: ServerChunkingContextOptions,\n@@ -1097,6 +1101,8 @@ pub async fn get_server_chunking_context(\n         no_mangling,\n         scope_hoisting,\n         debug_ids,\n+        client_root,\n+        asset_prefix,\n     } = options;\n     let next_mode = mode.await?;\n     // TODO(alexkirsz) This should return a trait that can be implemented by the\n@@ -1112,6 +1118,9 @@ pub async fn get_server_chunking_context(\n         environment.to_resolved().await?,\n         next_mode.runtime_type(),\n     )\n+    .client_roots_override(rcstr!(\"client\"), client_root.clone())\n+    .asset_root_path_override(rcstr!(\"client\"), client_root.join(\"static/media\")?)\n+    .asset_prefix_override(rcstr!(\"client\"), asset_prefix)\n     .minify_type(if *turbo_minify.await? {\n         MinifyType::Minify {\n             mangle: (!*no_mangling.await?).then_some(MangleType::OptimalSize),"
        },
        {
            "sha": "a76bc7b584f8fd85768f4c172be87a21ae2ffab5",
            "filename": "test/e2e/url-imports/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fnext.config.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/next.config.js"
        },
        {
            "sha": "a9334acdeb9bcec2faa94ef1cdf0437d0c057b60",
            "filename": "test/e2e/url-imports/next.lock/data/http_localhost_12345/value1_d8c72f577995000e3fad.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue1_d8c72f577995000e3fad.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue1_d8c72f577995000e3fad.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue1_d8c72f577995000e3fad.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/source/value1.js"
        },
        {
            "sha": "806efcbdf1d494a6724eb1d0c5c7040621b4e822",
            "filename": "test/e2e/url-imports/next.lock/data/http_localhost_12345/value2_c78b9332f4998e489c87.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue2_c78b9332f4998e489c87.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue2_c78b9332f4998e489c87.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue2_c78b9332f4998e489c87.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/source/value2.js"
        },
        {
            "sha": "6ab694c37a388fba0cdc0593051ece8738023534",
            "filename": "test/e2e/url-imports/next.lock/data/http_localhost_12345/value3_206680f033f0d0f3b538.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue3_206680f033f0d0f3b538.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue3_206680f033f0d0f3b538.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue3_206680f033f0d0f3b538.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/source/value3.js"
        },
        {
            "sha": "1295372d0b9f54f6facc74f32467db0251147215",
            "filename": "test/e2e/url-imports/next.lock/data/http_localhost_12345/value4_fcfa0c15487b3667cdfd.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue4_fcfa0c15487b3667cdfd.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue4_fcfa0c15487b3667cdfd.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fnext.lock%2Fdata%2Fhttp_localhost_12345%2Fvalue4_fcfa0c15487b3667cdfd.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/source/value4.js"
        },
        {
            "sha": "0a99ed025efbc9e2541f420e1628111a375916e4",
            "filename": "test/e2e/url-imports/next.lock/lock.json",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.lock%2Flock.json",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fnext.lock%2Flock.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fnext.lock%2Flock.json?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,24 @@\n+{\n+  \"http://localhost:12345/value1.js\": {\n+    \"integrity\": \"sha512-S1eh3STyIGuRSfoAVU0jhxVY2MoRXSC/JduKMKuATb91ArhG0G2rvRNsGvD2kZo/jENlbrMtWNkzK2dGLgaUfg==\",\n+    \"contentType\": \"application/javascript; charset=UTF-8\"\n+  },\n+  \"http://localhost:12345/value2.js\": {\n+    \"integrity\": \"sha512-R4XoB/ZTbRL9FGcM5d3hkxtxmMUXaKNKCqRKZPDy1v7Hh61HPLidPQHga1XMurakZPoJnCC5a5jRdOAagn3LRA==\",\n+    \"contentType\": \"application/javascript; charset=UTF-8\"\n+  },\n+  \"http://localhost:12345/value3.js\": {\n+    \"integrity\": \"sha512-xtYaDPwejlXaMwQOdnYldln3wA5UYqIaJXMuCdBmyjgRX3zSKKd/AbGYobURfITmpzkz7U7E5GEK2Ju17qCZkw==\",\n+    \"contentType\": \"application/javascript; charset=UTF-8\"\n+  },\n+  \"http://localhost:12345/value4.js\": {\n+    \"integrity\": \"sha512-orh6tVnh1jjxWNNLduiv0pUcW0guzwTmy52JQGdz4D2LL2IgIlJaC0w4+YBtIBXa2kKGho839WgGAK0sC0Folw==\",\n+    \"contentType\": \"application/javascript; charset=UTF-8\"\n+  },\n+  \"https://github.com/vercel/next.js/raw/canary/test/integration/url/public/vercel.png\": \"no-cache\",\n+  \"https://github.com/vercel/next.js/raw/canary/test/integration/url/public/vercel.png?_=image\": \"no-cache\",\n+  \"https://github.com/vercel/next.js/raw/canary/test/integration/url/public/vercel.png?_=ssg\": \"no-cache\",\n+  \"https://github.com/vercel/next.js/raw/canary/test/integration/url/public/vercel.png?_=ssr\": \"no-cache\",\n+  \"https://github.com/vercel/next.js/raw/canary/test/integration/url/public/vercel.png?_=static\": \"no-cache\",\n+  \"version\": 1\n+}"
        },
        {
            "sha": "513ae51d4575f8783e080ad1628a5816ba7ed72f",
            "filename": "test/e2e/url-imports/pages/api/value.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fapi%2Fvalue.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fapi%2Fvalue.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fpages%2Fapi%2Fvalue.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/pages/api/value.js"
        },
        {
            "sha": "3861e26ce14b9909c64ab7abfcd4e47ca7d6ca40",
            "filename": "test/e2e/url-imports/pages/css.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fcss.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fcss.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fpages%2Fcss.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/pages/css.js"
        },
        {
            "sha": "68792e4aa13bd8e81bd37bcb209cff895f47b4f0",
            "filename": "test/e2e/url-imports/pages/css.module.css",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fcss.module.css",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fcss.module.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fpages%2Fcss.module.css?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/pages/css.module.css"
        },
        {
            "sha": "c483ae1ae10cde5329dbbd6bec746a70a32d90a6",
            "filename": "test/e2e/url-imports/pages/image.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fimage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fimage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fpages%2Fimage.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/pages/image.js"
        },
        {
            "sha": "55b22c7db99374fcf8c14484e5056c78b31aecc6",
            "filename": "test/e2e/url-imports/pages/ssg.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fssg.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fssg.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fpages%2Fssg.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/pages/ssg.js"
        },
        {
            "sha": "79738631474fc80890eeddf2953d54803df4ead1",
            "filename": "test/e2e/url-imports/pages/ssr.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fssr.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fssr.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fpages%2Fssr.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/pages/ssr.js"
        },
        {
            "sha": "bf632d54dc49d4c53fd9f8b542b31f65944af158",
            "filename": "test/e2e/url-imports/pages/static.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fstatic.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpages%2Fstatic.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fpages%2Fstatic.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/pages/static.js"
        },
        {
            "sha": "cb137a989e5ffe5fe01eee70a4ad7a6e1798094a",
            "filename": "test/e2e/url-imports/public/vercel.png",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpublic%2Fvercel.png",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fpublic%2Fvercel.png",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fpublic%2Fvercel.png?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url-imports/public/vercel.png"
        },
        {
            "sha": "a9334acdeb9bcec2faa94ef1cdf0437d0c057b60",
            "filename": "test/e2e/url-imports/source/value1.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue1.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue1.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue1.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1 @@\n+export default 42 // 1"
        },
        {
            "sha": "806efcbdf1d494a6724eb1d0c5c7040621b4e822",
            "filename": "test/e2e/url-imports/source/value2.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue2.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue2.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue2.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1 @@\n+export default 42 // 2"
        },
        {
            "sha": "6ab694c37a388fba0cdc0593051ece8738023534",
            "filename": "test/e2e/url-imports/source/value3.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue3.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue3.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue3.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1 @@\n+export default 42 // 3"
        },
        {
            "sha": "1295372d0b9f54f6facc74f32467db0251147215",
            "filename": "test/e2e/url-imports/source/value4.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue4.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue4.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Fsource%2Fvalue4.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1 @@\n+export default 42 // 4"
        },
        {
            "sha": "e25079194f06ac85714cf227e3c14e049560cc7f",
            "filename": "test/e2e/url-imports/url-imports.test.ts",
            "status": "added",
            "additions": 100,
            "deletions": 0,
            "changes": 100,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Furl-imports.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl-imports%2Furl-imports.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl-imports%2Furl-imports.test.ts?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,100 @@\n+import {\n+  getBrowserBodyText,\n+  startStaticServer,\n+  stopApp,\n+  retry,\n+} from 'next-test-utils'\n+import { FileRef, nextTestSetup, isNextDev } from 'e2e-utils'\n+import { join } from 'path'\n+\n+// experimental.urlImports is not implemented in Turbopack\n+;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n+  `Handle url imports`,\n+  () => {\n+    let staticServer\n+    let staticServerPort\n+    beforeAll(async () => {\n+      staticServerPort = 12345\n+      staticServer = await startStaticServer(\n+        join(__dirname, 'source'),\n+        undefined,\n+        staticServerPort\n+      )\n+    })\n+    afterAll(async () => {\n+      await stopApp(staticServer)\n+    })\n+\n+    const { next, skipped } = nextTestSetup({\n+      files: isNextDev\n+        ? {\n+            // exclude next.lock here, should be generated automatically in dev\n+            'next.config.js': new FileRef(join(__dirname, 'next.config.js')),\n+            pages: new FileRef(join(__dirname, 'pages')),\n+            public: new FileRef(join(__dirname, 'public')),\n+          }\n+        : __dirname,\n+      // The staticServer above doesn't work when deployed\n+      skipDeployment: true,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    const expectedServer =\n+      /Hello <!-- -->42<!-- -->\\+<!-- -->42<!-- -->\\+<!-- -->\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png<!-- -->\\+<!-- -->\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png/\n+    const expectedClient = new RegExp(\n+      expectedServer.source.replace(/<!-- -->/g, '')\n+    )\n+\n+    for (const page of ['/static', '/ssr', '/ssg']) {\n+      it(`should render the ${page} page`, async () => {\n+        const html = await next.render(page)\n+        expect(html).toMatch(expectedServer)\n+      })\n+\n+      it(`should client-render the ${page} page`, async () => {\n+        const browser = await next.browser(page)\n+        await retry(async () =>\n+          expect(await getBrowserBodyText(browser)).toMatch(expectedClient)\n+        )\n+      })\n+    }\n+\n+    it(`should render a static url image import`, async () => {\n+      const browser = await next.browser('/image')\n+      await browser.waitForElementByCss('#static-image')\n+      await retry(async () =>\n+        expect(\n+          await browser.elementByCss('#static-image').getAttribute('src')\n+        ).toMatch(\n+          /^\\/_next\\/image\\?url=%2F_next%2Fstatic%2Fmedia%2Fvercel\\.[0-9a-f]{8}\\.png&/\n+        )\n+      )\n+    })\n+\n+    it(`should allow url import in css`, async () => {\n+      const browser = await next.browser('/css')\n+\n+      await browser.waitForElementByCss('#static-css')\n+      await retry(async () =>\n+        expect(\n+          await browser\n+            .elementByCss('#static-css')\n+            .getComputedCss('background-image')\n+        ).toMatch(\n+          /^url\\(\"http(s)?:\\/\\/.+\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png\"\\)$/\n+        )\n+      )\n+    })\n+\n+    it('should respond on value api', async () => {\n+      const data = await next\n+        .fetch('/api/value')\n+        .then((res) => res.ok && res.json())\n+\n+      expect(data).toEqual({ value: 42 })\n+    })\n+  }\n+)"
        },
        {
            "sha": "c105ed9d4e01d7075ebb13a5effafc1e82820fa8",
            "filename": "test/e2e/url/app/api/edge/route.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fapi%2Fedge%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fapi%2Fedge%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fapp%2Fapi%2Fedge%2Froute.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,8 @@\n+import imported from '../../../public/vercel.png'\n+const url = new URL('../../../public/vercel.png', import.meta.url).toString()\n+\n+export function GET(req, res) {\n+  return Response.json({ imported, url })\n+}\n+\n+export const runtime = 'edge'"
        },
        {
            "sha": "8e7a6b6dfd49e9e10e8677462c7ba0357777264e",
            "filename": "test/e2e/url/app/api/route.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fapi%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fapi%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fapp%2Fapi%2Froute.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,6 @@\n+import imported from '../../public/vercel.png'\n+const url = new URL('../../public/vercel.png', import.meta.url).toString()\n+\n+export function GET(req, res) {\n+  return Response.json({ imported, url })\n+}"
        },
        {
            "sha": "8b5aea8a1e9672065126758b666c21a54ba35fca",
            "filename": "test/e2e/url/app/client-edge/page.js",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fclient-edge%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fclient-edge%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fapp%2Fclient-edge%2Fpage.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,14 @@\n+'use client'\n+\n+import imported from '../../public/vercel.png'\n+const url = new URL('../../public/vercel.png', import.meta.url).toString()\n+\n+export default function Index(props) {\n+  return (\n+    <main>\n+      Hello {imported.src}+{url}\n+    </main>\n+  )\n+}\n+\n+export const runtime = 'edge'"
        },
        {
            "sha": "810acb958590dda95cddf9af36eab038ddd5206c",
            "filename": "test/e2e/url/app/client/page.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fclient%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fclient%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fapp%2Fclient%2Fpage.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,12 @@\n+'use client'\n+\n+import imported from '../../public/vercel.png'\n+const url = new URL('../../public/vercel.png', import.meta.url).toString()\n+\n+export default function Index(props) {\n+  return (\n+    <main>\n+      Hello {imported.src}+{url}\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "4ee00a218505ac95ed8f4b2cb12779643277286d",
            "filename": "test/e2e/url/app/layout.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fapp%2Flayout.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,7 @@\n+export default function RootLayout({ children }) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "b19203108ff7d906516782a28f23cddf651a0ffa",
            "filename": "test/e2e/url/app/manifest.js",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fmanifest.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fmanifest.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fapp%2Fmanifest.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,17 @@\n+import icon from '../public/vercel.png'\n+const url = new URL('../public/vercel.png', import.meta.url).toString()\n+\n+export default function manifest() {\n+  return {\n+    short_name: 'Next.js',\n+    name: 'Next.js',\n+    icons: [\n+      {\n+        src: icon.src,\n+        type: 'image/png',\n+        sizes: '512x512',\n+      },\n+    ],\n+    description: url,\n+  }\n+}"
        },
        {
            "sha": "07cd809ad1b0fb0026afca0444ee844431cf5ae1",
            "filename": "test/e2e/url/app/opengraph-image.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fopengraph-image.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Fopengraph-image.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fapp%2Fopengraph-image.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,9 @@\n+import imported from '../public/vercel.png'\n+const url = new URL('../public/vercel.png', import.meta.url).toString()\n+\n+export const contentType = 'text/json'\n+\n+// Image generation\n+export default async function Image() {\n+  return Response.json({ imported, url })\n+}"
        },
        {
            "sha": "b673e2eb62fdcb46a310e32b2b7a48d610d45763",
            "filename": "test/e2e/url/app/rsc-edge/page.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Frsc-edge%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Frsc-edge%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fapp%2Frsc-edge%2Fpage.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,12 @@\n+import imported from '../../public/vercel.png'\n+const url = new URL('../../public/vercel.png', import.meta.url).toString()\n+\n+export default function Index(props) {\n+  return (\n+    <main>\n+      Hello {imported.src}+{url}\n+    </main>\n+  )\n+}\n+\n+export const runtime = 'edge'"
        },
        {
            "sha": "ce35c94a1ec36d35512e8b820b6d3bb2013aa22a",
            "filename": "test/e2e/url/app/rsc/page.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Frsc%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fapp%2Frsc%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fapp%2Frsc%2Fpage.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,10 @@\n+import imported from '../../public/vercel.png'\n+const url = new URL('../../public/vercel.png', import.meta.url).toString()\n+\n+export default function Index(props) {\n+  return (\n+    <main>\n+      Hello {imported.src}+{url}\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "1d87d3d5bb57c1b0ddcc5c298a50be8b62e0c94c",
            "filename": "test/e2e/url/middleware.ts",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fmiddleware.ts?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,13 @@\n+import { NextRequest, NextResponse } from 'next/server'\n+\n+// @ts-ignore\n+import imported from './public/vercel.png'\n+const url = new URL('./public/vercel.png', import.meta.url).toString()\n+\n+export async function middleware(req: NextRequest) {\n+  if (req.nextUrl.toString().endsWith('/middleware')) {\n+    return Response.json({ imported, url })\n+  }\n+\n+  return NextResponse.next()\n+}"
        },
        {
            "sha": "d124c191ac55efcbfcea242b1a9fe6f8f7235204",
            "filename": "test/e2e/url/pages/api/pages-edge/index.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fapi%2Fpages-edge%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fapi%2Fpages-edge%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fpages%2Fapi%2Fpages-edge%2Findex.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,13 @@\n+import imported from '../../../public/vercel.png'\n+const url = new URL('../../../public/vercel.png', import.meta.url)\n+\n+export default (req, res) => {\n+  return new Response(\n+    JSON.stringify({\n+      imported,\n+      url: url.toString(),\n+    })\n+  )\n+}\n+\n+export const runtime = 'experimental-edge'"
        },
        {
            "sha": "6e1a9c032b0d4dadc11cb3e899a6f7fae96e69f5",
            "filename": "test/e2e/url/pages/api/pages/index.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fapi%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fapi%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fpages%2Fapi%2Fpages%2Findex.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,19 @@\n+import fs from 'fs'\n+\n+import imported from '../../../public/vercel.png'\n+const url = new URL('../../../public/vercel.png', import.meta.url)\n+\n+export default (req, res) => {\n+  let size\n+  try {\n+    size = fs.readFileSync(url).length\n+  } catch (e) {\n+    size = e.message\n+  }\n+\n+  res.send({\n+    imported,\n+    url: url.toString(),\n+    size,\n+  })\n+}"
        },
        {
            "sha": "de5792607d3e7fc54bf8c50a8144a5e05ff35c02",
            "filename": "test/e2e/url/pages/pages-edge/ssr.js",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fpages-edge%2Fssr.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fpages-edge%2Fssr.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fpages%2Fpages-edge%2Fssr.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,20 @@\n+import imported from '../../public/vercel.png'\n+\n+export function getServerSideProps() {\n+  return {\n+    props: {\n+      url: new URL('../../public/vercel.png', import.meta.url).toString(),\n+    },\n+  }\n+}\n+\n+export default function Index({ url }) {\n+  return (\n+    <main>\n+      Hello {imported.src}+\n+      {new URL('../../public/vercel.png', import.meta.url).toString()}+{url}\n+    </main>\n+  )\n+}\n+\n+export const runtime = 'experimental-edge'"
        },
        {
            "sha": "de324501b4d9b0af49e3d72fff669db8d47d7965",
            "filename": "test/e2e/url/pages/pages-edge/static.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fpages-edge%2Fstatic.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fpages-edge%2Fstatic.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fpages%2Fpages-edge%2Fstatic.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,12 @@\n+import imported from '../../public/vercel.png'\n+const url = new URL('../../public/vercel.png', import.meta.url).toString()\n+\n+export default function Index(props) {\n+  return (\n+    <main>\n+      Hello {imported.src}+{url}\n+    </main>\n+  )\n+}\n+\n+export const runtime = 'experimental-edge'"
        },
        {
            "sha": "fe8d852cca225ab223291cf7f62abce0e00fe15f",
            "filename": "test/e2e/url/pages/pages/ssg.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fpages%2Fssg.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fpages%2Fssg.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fpages%2Fpages%2Fssg.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,18 @@\n+import imported from '../../public/vercel.png'\n+\n+export async function getStaticProps() {\n+  return {\n+    props: {\n+      url: new URL('../../public/vercel.png', import.meta.url).toString(),\n+    },\n+  }\n+}\n+\n+export default function Index({ url }) {\n+  return (\n+    <main>\n+      Hello {imported.src}+\n+      {new URL('../../public/vercel.png', import.meta.url).toString()}+{url}\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "ca2572a4b85157a91d65ce05c2078911c4708c5f",
            "filename": "test/e2e/url/pages/pages/ssr.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fpages%2Fssr.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fpages%2Fssr.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fpages%2Fpages%2Fssr.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,18 @@\n+import imported from '../../public/vercel.png'\n+\n+export function getServerSideProps() {\n+  return {\n+    props: {\n+      url: new URL('../../public/vercel.png', import.meta.url).toString(),\n+    },\n+  }\n+}\n+\n+export default function Index({ url }) {\n+  return (\n+    <main>\n+      Hello {imported.src}+\n+      {new URL('../../public/vercel.png', import.meta.url).toString()}+{url}\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "ce35c94a1ec36d35512e8b820b6d3bb2013aa22a",
            "filename": "test/e2e/url/pages/pages/static.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fpages%2Fstatic.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpages%2Fpages%2Fstatic.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fpages%2Fpages%2Fstatic.js?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,10 @@\n+import imported from '../../public/vercel.png'\n+const url = new URL('../../public/vercel.png', import.meta.url).toString()\n+\n+export default function Index(props) {\n+  return (\n+    <main>\n+      Hello {imported.src}+{url}\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "cb137a989e5ffe5fe01eee70a4ad7a6e1798094a",
            "filename": "test/e2e/url/public/vercel.png",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpublic%2Fvercel.png",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Fpublic%2Fvercel.png",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Fpublic%2Fvercel.png?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "previous_filename": "test/integration/url/public/vercel.png"
        },
        {
            "sha": "a89ead35b292ebd2dc7d61fcc397545eafb55210",
            "filename": "test/e2e/url/url.test.ts",
            "status": "added",
            "additions": 188,
            "deletions": 0,
            "changes": 188,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Furl.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fe2e%2Furl%2Furl.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Furl%2Furl.test.ts?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -0,0 +1,188 @@\n+import { retry } from 'next-test-utils'\n+import { nextTestSetup } from 'e2e-utils'\n+\n+// |         | Pages Client            | Pages Server (SSR,RSC)  | API Routes/Middleware/Metadata |\n+// |---------|-------------------------|-------------------------|--------------------------------|\n+// | new URL | /_next/static/media/... | /_next/static/media/... | /server/assets/...             |\n+// | import  | /_next/static/media/... | /_next/static/media/... | /_next/static/media/...        |\n+// |---------|-------------------------|-------------------------|--------------------------------|\n+//\n+// Webpack has\n+// - a bug where App Router API routes (and Metadata) return client assets for `new URL`s.\n+// - a bug where Edge Page routes return client assets for `new URL`s.\n+describe(`Handle new URL asset references`, () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    // Workaround for `Error: invariant: htmlFsRef != null && jsonFsRef != null /ssg` errors\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  const serverFilePath = expect.stringMatching(\n+    /file:.*\\/.next(\\/dev)?\\/server\\/.*\\/vercel\\.[0-9a-f]{8}\\.png$/\n+  )\n+  const serverEdgeUrl = expect.stringMatching(\n+    /^blob:.*vercel\\.[0-9a-f]{8,}\\.png$/\n+  )\n+  const clientFilePath = expect.stringMatching(\n+    /^\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png$/\n+  )\n+\n+  it('should respond on middleware api', async () => {\n+    const data = await next\n+      .fetch('/middleware')\n+      .then((res) => res.ok && res.json())\n+\n+    expect(data).toEqual({\n+      imported: expect.objectContaining({\n+        src: clientFilePath,\n+      }),\n+      url: serverEdgeUrl,\n+    })\n+  })\n+\n+  const expectedPage =\n+    /^Hello \\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png(\\+\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png(\\+\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png)?)?$/\n+\n+  describe('app router', () => {\n+    it('should respond on webmanifest', async () => {\n+      const data = await next\n+        .fetch('/manifest.webmanifest')\n+        .then((res) => res.ok && res.json())\n+\n+      expect(data).toEqual({\n+        short_name: 'Next.js',\n+        name: 'Next.js',\n+        icons: [\n+          {\n+            src: clientFilePath,\n+            type: 'image/png',\n+            sizes: '512x512',\n+          },\n+        ],\n+        // TODO Webpack bug?\n+        description: process.env.IS_TURBOPACK_TEST\n+          ? serverFilePath\n+          : clientFilePath,\n+      })\n+    })\n+\n+    it('should respond on opengraph-image', async () => {\n+      const data = await next\n+        .fetch('/opengraph-image')\n+        .then((res) => res.ok && res.json())\n+\n+      expect(data).toEqual({\n+        imported: expect.objectContaining({\n+          src: clientFilePath,\n+        }),\n+        // TODO Webpack bug?\n+        url: process.env.IS_TURBOPACK_TEST ? serverFilePath : clientFilePath,\n+      })\n+    })\n+\n+    for (const page of ['/rsc', '/rsc-edge', '/client', '/client-edge']) {\n+      // TODO Webpack bug?\n+      let shouldSkip = process.env.IS_TURBOPACK_TEST\n+        ? false\n+        : page.includes('edge')\n+\n+      ;(shouldSkip ? it.skip : it)(\n+        `should render the ${page} page`,\n+        async () => {\n+          const $ = await next.render$(page)\n+          // eslint-disable-next-line jest/no-standalone-expect\n+          expect($('main').text()).toMatch(expectedPage)\n+        }\n+      )\n+      ;(shouldSkip ? it.skip : it)(\n+        `should client-render the ${page} page`,\n+        async () => {\n+          const browser = await next.browser(page)\n+          await retry(async () =>\n+            expect(await browser.elementByCss('main').text()).toMatch(\n+              expectedPage\n+            )\n+          )\n+        }\n+      )\n+    }\n+\n+    it('should respond on API', async () => {\n+      const data = await next.fetch('/api').then((res) => res.ok && res.json())\n+\n+      expect(data).toEqual({\n+        imported: expect.objectContaining({\n+          src: clientFilePath,\n+        }),\n+        // TODO Webpack bug?\n+        url: process.env.IS_TURBOPACK_TEST ? serverFilePath : clientFilePath,\n+      })\n+    })\n+  })\n+\n+  describe('pages router', () => {\n+    for (const page of [\n+      '/pages/static',\n+      '/pages/ssr',\n+      '/pages/ssg',\n+      '/pages-edge/static',\n+      '/pages-edge/ssr',\n+    ]) {\n+      // TODO Webpack bug?\n+      let shouldSkip = process.env.IS_TURBOPACK_TEST\n+        ? false\n+        : page.includes('edge')\n+\n+      ;(shouldSkip ? it.skip : it)(\n+        `should render the ${page} page`,\n+        async () => {\n+          const $ = await next.render$(page)\n+          // eslint-disable-next-line jest/no-standalone-expect\n+          expect($('main').text()).toMatch(expectedPage)\n+        }\n+      )\n+      ;(shouldSkip ? it.skip : it)(\n+        `should client-render the ${page} page`,\n+        async () => {\n+          const browser = await next.browser(page)\n+          await retry(async () =>\n+            expect(await browser.elementByCss('main').text()).toMatch(\n+              expectedPage\n+            )\n+          )\n+        }\n+      )\n+    }\n+\n+    it('should respond on API', async () => {\n+      const data = await next\n+        .fetch('/api/pages/')\n+        .then((res) => res.ok && res.json())\n+\n+      expect(data).toEqual({\n+        imported: expect.objectContaining({\n+          src: clientFilePath,\n+        }),\n+        url: serverFilePath,\n+        size: 30079,\n+      })\n+    })\n+\n+    it('should respond on edge API', async () => {\n+      const data = await next\n+        .fetch('/api/pages-edge/')\n+        .then((res) => res.ok && res.json())\n+\n+      expect(data).toEqual({\n+        imported: expect.objectContaining({\n+          src: clientFilePath,\n+        }),\n+        url: serverEdgeUrl,\n+      })\n+    })\n+  })\n+})"
        },
        {
            "sha": "217867659c8b5506c883d7db27335b930f9e79b2",
            "filename": "test/experimental-tests-manifest.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fexperimental-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/test%2Fexperimental-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fexperimental-tests-manifest.json?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -332,6 +332,7 @@\n       \"test/e2e/switchable-runtime/index.test.ts\",\n       \"test/e2e/testmode/testmode.test.ts\",\n       \"test/e2e/use-link-status/index.test.ts\",\n+      \"test/e2e/url/url.test.ts\",\n       \"test/integration/app-dir-export/**/*\",\n       \"test/integration/app-dynamic-error/test/index.test.ts\",\n       \"test/integration/app-types/app-types.test.js\","
        },
        {
            "sha": "3d389aacfc333b0754e149b1b514bd05eca222ff",
            "filename": "test/integration/url-imports/.gitignore",
            "status": "removed",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl-imports%2F.gitignore",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl-imports%2F.gitignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Furl-imports%2F.gitignore?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -1,3 +0,0 @@\n-# this is only needed for the test case\n-# Do not ignore that in real apps\n-next.lock\n\\ No newline at end of file"
        },
        {
            "sha": "c8015dd8a73252941d0c331a0bda21d38b0f99a5",
            "filename": "test/integration/url-imports/test/index.test.js",
            "status": "removed",
            "additions": 0,
            "deletions": 125,
            "changes": 125,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl-imports%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl-imports%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Furl-imports%2Ftest%2Findex.test.js?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -1,125 +0,0 @@\n-/* eslint-disable no-loop-func */\n-/* eslint-env jest */\n-\n-import fs from 'fs-extra'\n-import { join } from 'path'\n-import {\n-  nextBuild,\n-  findPort,\n-  nextStart,\n-  killApp,\n-  renderViaHTTP,\n-  fetchViaHTTP,\n-  launchApp,\n-  getBrowserBodyText,\n-  check,\n-  startStaticServer,\n-  stopApp,\n-} from 'next-test-utils'\n-import webdriver from 'next-webdriver'\n-\n-jest.setTimeout(1000 * 60 * 2)\n-const appDir = join(__dirname, '../')\n-\n-// experimental.urlImports is not implemented in Turbopack\n-;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n-  `Handle url imports`,\n-  () => {\n-    let staticServer\n-    let staticServerPort\n-    beforeAll(async () => {\n-      await fs.remove(join(appDir, 'next.lock'))\n-      staticServerPort = 12345\n-      staticServer = await startStaticServer(\n-        join(appDir, 'source'),\n-        undefined,\n-        staticServerPort\n-      )\n-    })\n-    afterAll(async () => {\n-      await stopApp(staticServer)\n-    })\n-\n-    for (const dev of [true, false]) {\n-      describe(dev ? 'with next dev' : 'with next build', () => {\n-        let appPort\n-        let app\n-        beforeAll(async () => {\n-          await fs.remove(join(appDir, '.next'))\n-          if (dev) {\n-            appPort = await findPort()\n-            app = await launchApp(appDir, appPort)\n-          } else {\n-            await nextBuild(appDir)\n-            appPort = await findPort()\n-            app = await nextStart(appDir, appPort)\n-          }\n-        })\n-        afterAll(async () => {\n-          await killApp(app)\n-        })\n-        const expectedServer =\n-          /Hello <!-- -->42<!-- -->\\+<!-- -->42<!-- -->\\+<!-- -->\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png<!-- -->\\+<!-- -->\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png/\n-        const expectedClient = new RegExp(\n-          expectedServer.source.replace(/<!-- -->/g, '')\n-        )\n-\n-        for (const page of ['/static', '/ssr', '/ssg']) {\n-          it(`should render the ${page} page`, async () => {\n-            const html = await renderViaHTTP(appPort, page)\n-            expect(html).toMatch(expectedServer)\n-          })\n-\n-          it(`should client-render the ${page} page`, async () => {\n-            let browser\n-            try {\n-              browser = await webdriver(appPort, page)\n-              await check(() => getBrowserBodyText(browser), expectedClient)\n-            } finally {\n-              await browser.close()\n-            }\n-          })\n-        }\n-\n-        it(`should render a static url image import`, async () => {\n-          let browser\n-          try {\n-            browser = await webdriver(appPort, '/image')\n-            await browser.waitForElementByCss('#static-image')\n-            await check(\n-              () => browser.elementByCss('#static-image').getAttribute('src'),\n-              /^\\/_next\\/image\\?url=%2F_next%2Fstatic%2Fmedia%2Fvercel\\.[0-9a-f]{8}\\.png&/\n-            )\n-          } finally {\n-            await browser.close()\n-          }\n-        })\n-\n-        it(`should allow url import in css`, async () => {\n-          let browser\n-          try {\n-            browser = await webdriver(appPort, '/css')\n-            await browser.waitForElementByCss('#static-css')\n-            await check(\n-              () =>\n-                browser\n-                  .elementByCss('#static-css')\n-                  .getComputedCss('background-image'),\n-              /^url\\(\"http:\\/\\/localhost:\\d+\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png\"\\)$/\n-            )\n-          } finally {\n-            await browser.close()\n-          }\n-        })\n-\n-        it('should respond on value api', async () => {\n-          const data = await fetchViaHTTP(appPort, '/api/value').then(\n-            (res) => res.ok && res.json()\n-          )\n-\n-          expect(data).toEqual({ value: 42 })\n-        })\n-      })\n-    }\n-  }\n-)"
        },
        {
            "sha": "0109c99b7b881916e90eef737d0a3463f62df060",
            "filename": "test/integration/url/pages/api/basename.js",
            "status": "removed",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Fpages%2Fapi%2Fbasename.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Fpages%2Fapi%2Fbasename.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Furl%2Fpages%2Fapi%2Fbasename.js?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -1,7 +0,0 @@\n-import path from 'path'\n-\n-const img = new URL('../../public/vercel.png', import.meta.url)\n-\n-export default (req, res) => {\n-  res.json({ basename: path.posix.basename(img.pathname) })\n-}"
        },
        {
            "sha": "7649a0bcb1307b422d297690b16d4d83ad4d31d9",
            "filename": "test/integration/url/pages/api/size.js",
            "status": "removed",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Fpages%2Fapi%2Fsize.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Fpages%2Fapi%2Fsize.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Furl%2Fpages%2Fapi%2Fsize.js?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -1,7 +0,0 @@\n-import fs from 'fs'\n-\n-const img = new URL('../../public/vercel.png', import.meta.url)\n-\n-export default (req, res) => {\n-  res.json({ size: fs.readFileSync(img).length })\n-}"
        },
        {
            "sha": "113f47c56552f686529258120eb468127c5589e5",
            "filename": "test/integration/url/pages/ssg.js",
            "status": "removed",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Fpages%2Fssg.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Fpages%2Fssg.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Furl%2Fpages%2Fssg.js?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -1,15 +0,0 @@\n-export async function getStaticProps() {\n-  return {\n-    props: {\n-      url: new URL('../public/vercel.png', import.meta.url).pathname,\n-    },\n-  }\n-}\n-\n-export default function Index({ url }) {\n-  return (\n-    <div>\n-      Hello {new URL('../public/vercel.png', import.meta.url).pathname}+{url}\n-    </div>\n-  )\n-}"
        },
        {
            "sha": "6aec1e94a0f7253fa34f50c7e886b8fdc88337c0",
            "filename": "test/integration/url/pages/ssr.js",
            "status": "removed",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Fpages%2Fssr.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Fpages%2Fssr.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Furl%2Fpages%2Fssr.js?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -1,15 +0,0 @@\n-export function getServerSideProps() {\n-  return {\n-    props: {\n-      url: new URL('../public/vercel.png', import.meta.url).pathname,\n-    },\n-  }\n-}\n-\n-export default function Index({ url }) {\n-  return (\n-    <div>\n-      Hello {new URL('../public/vercel.png', import.meta.url).pathname}+{url}\n-    </div>\n-  )\n-}"
        },
        {
            "sha": "03bc185ce9f08bed83f77451157ad6fe5c256639",
            "filename": "test/integration/url/pages/static.js",
            "status": "removed",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Fpages%2Fstatic.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Fpages%2Fstatic.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Furl%2Fpages%2Fstatic.js?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -1,9 +0,0 @@\n-const url = new URL('../public/vercel.png', import.meta.url).pathname\n-\n-export default function Index(props) {\n-  return (\n-    <div>\n-      Hello {new URL('../public/vercel.png', import.meta.url).pathname}+{url}\n-    </div>\n-  )\n-}"
        },
        {
            "sha": "ad860c21ae195b9b15c2517cd19970ce0b24264e",
            "filename": "test/integration/url/test/index.test.js",
            "status": "removed",
            "additions": 0,
            "deletions": 83,
            "changes": 83,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fintegration%2Furl%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Furl%2Ftest%2Findex.test.js?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -1,83 +0,0 @@\n-/* eslint-disable no-loop-func */\n-/* eslint-env jest */\n-\n-import fs from 'fs-extra'\n-import { join } from 'path'\n-import {\n-  nextBuild,\n-  findPort,\n-  nextStart,\n-  killApp,\n-  renderViaHTTP,\n-  fetchViaHTTP,\n-  launchApp,\n-  getBrowserBodyText,\n-  check,\n-} from 'next-test-utils'\n-import webdriver from 'next-webdriver'\n-\n-jest.setTimeout(1000 * 60 * 2)\n-const appDir = join(__dirname, '../')\n-\n-for (const dev of [false, true]) {\n-  ;(process.env.IS_TURBOPACK_TEST && !dev ? describe.skip : describe)(\n-    `Handle new URL asset references in next ${dev ? 'dev' : 'build'}`,\n-    () => {\n-      let appPort\n-      let app\n-      beforeAll(async () => {\n-        await fs.remove(join(appDir, '.next'))\n-        if (dev) {\n-          appPort = await findPort()\n-          app = await launchApp(appDir, appPort)\n-        } else {\n-          await nextBuild(appDir)\n-          appPort = await findPort()\n-          app = await nextStart(appDir, appPort)\n-        }\n-      })\n-      afterAll(() => killApp(app))\n-\n-      const expectedServer =\n-        /Hello <!-- -->\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png<!-- -->\\+<!-- -->\\/_next\\/static\\/media\\/vercel\\.[0-9a-f]{8}\\.png/\n-      const expectedClient = new RegExp(\n-        expectedServer.source.replace(/<!-- -->/g, '')\n-      )\n-\n-      for (const page of ['/static', '/ssr', '/ssg']) {\n-        it(`should render the ${page} page`, async () => {\n-          const html = await renderViaHTTP(appPort, page)\n-          expect(html).toMatch(expectedServer)\n-        })\n-\n-        it(`should client-render the ${page} page`, async () => {\n-          let browser\n-          try {\n-            browser = await webdriver(appPort, page)\n-            await check(() => getBrowserBodyText(browser), expectedClient)\n-          } finally {\n-            await browser.close()\n-          }\n-        })\n-      }\n-\n-      it('should respond on size api', async () => {\n-        const data = await fetchViaHTTP(appPort, '/api/size').then(\n-          (res) => res.ok && res.json()\n-        )\n-\n-        expect(data).toEqual({ size: 30079 })\n-      })\n-\n-      it('should respond on basename api', async () => {\n-        const data = await fetchViaHTTP(appPort, '/api/basename').then(\n-          (res) => res.ok && res.json()\n-        )\n-\n-        expect(data).toEqual({\n-          basename: expect.stringMatching(/^vercel\\.[0-9a-f]{8}\\.png$/),\n-        })\n-      })\n-    }\n-  )\n-}"
        },
        {
            "sha": "dcdf2158154b783fb612f03cb9e949d225ac7588",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 49,
            "deletions": 9,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -3,7 +3,7 @@ use serde::{Deserialize, Serialize};\n use tracing::Instrument;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{\n-    NonLocalValue, ResolvedVc, TaskInput, TryJoinIterExt, Upcast, ValueToString, Vc,\n+    FxIndexMap, NonLocalValue, ResolvedVc, TaskInput, TryJoinIterExt, Upcast, ValueToString, Vc,\n     trace::TraceRawVcs,\n };\n use turbo_tasks_fs::FileSystemPath;\n@@ -173,6 +173,21 @@ impl BrowserChunkingContextBuilder {\n         self\n     }\n \n+    pub fn asset_root_path_override(mut self, tag: RcStr, path: FileSystemPath) -> Self {\n+        self.chunking_context.asset_root_paths.insert(tag, path);\n+        self\n+    }\n+\n+    pub fn client_roots_override(mut self, tag: RcStr, path: FileSystemPath) -> Self {\n+        self.chunking_context.client_roots.insert(tag, path);\n+        self\n+    }\n+\n+    pub fn asset_base_path_override(mut self, tag: RcStr, path: RcStr) -> Self {\n+        self.chunking_context.asset_base_paths.insert(tag, path);\n+        self\n+    }\n+\n     pub fn chunking_config<T>(mut self, ty: ResolvedVc<T>, chunking_config: ChunkingConfig) -> Self\n     where\n         T: Upcast<Box<dyn ChunkType>>,\n@@ -200,7 +215,7 @@ impl BrowserChunkingContextBuilder {\n /// It splits \"node_modules\" separately as these are less likely to change\n /// during development\n #[turbo_tasks::value]\n-#[derive(Debug, Clone, Hash, TaskInput)]\n+#[derive(Debug, Clone)]\n pub struct BrowserChunkingContext {\n     name: Option<RcStr>,\n     /// The root path of the project\n@@ -213,10 +228,14 @@ pub struct BrowserChunkingContext {\n     output_root_to_root_path: RcStr,\n     /// This path is used to compute the url to request assets from\n     client_root: FileSystemPath,\n+    /// This path is used to compute the url to request chunks or assets from\n+    client_roots: FxIndexMap<RcStr, FileSystemPath>,\n     /// Chunks are placed at this path\n     chunk_root_path: FileSystemPath,\n     /// Static assets are placed at this path\n     asset_root_path: FileSystemPath,\n+    /// Static assets are placed at this path\n+    asset_root_paths: FxIndexMap<RcStr, FileSystemPath>,\n     /// Base path that will be prepended to all chunk URLs when loading them.\n     /// This path will not appear in chunk paths or chunk data.\n     chunk_base_path: Option<RcStr>,\n@@ -226,6 +245,9 @@ pub struct BrowserChunkingContext {\n     /// URL prefix that will be prepended to all static asset URLs when loading\n     /// them.\n     asset_base_path: Option<RcStr>,\n+    /// URL prefix that will be prepended to all static asset URLs when loading\n+    /// them.\n+    asset_base_paths: FxIndexMap<RcStr, RcStr>,\n     /// Enable HMR for this chunking\n     enable_hot_module_replacement: bool,\n     /// Enable tracing for this chunking\n@@ -276,12 +298,15 @@ impl BrowserChunkingContext {\n                 output_root,\n                 output_root_to_root_path,\n                 client_root,\n+                client_roots: Default::default(),\n                 chunk_root_path,\n                 should_use_file_source_map_uris: false,\n                 asset_root_path,\n+                asset_root_paths: Default::default(),\n                 chunk_base_path: None,\n                 chunk_suffix_path: None,\n                 asset_base_path: None,\n+                asset_base_paths: Default::default(),\n                 enable_hot_module_replacement: false,\n                 enable_tracing: false,\n                 enable_module_merging: false,\n@@ -497,19 +522,27 @@ impl ChunkingContext for BrowserChunkingContext {\n     }\n \n     #[turbo_tasks::function]\n-    async fn asset_url(&self, ident: FileSystemPath) -> Result<Vc<RcStr>> {\n+    async fn asset_url(&self, ident: FileSystemPath, tag: Option<RcStr>) -> Result<Vc<RcStr>> {\n         let asset_path = ident.to_string();\n+\n+        let client_root = tag\n+            .as_ref()\n+            .and_then(|tag| self.client_roots.get(tag))\n+            .unwrap_or(&self.client_root);\n+\n+        let asset_base_path = tag\n+            .as_ref()\n+            .and_then(|tag| self.asset_base_paths.get(tag))\n+            .or(self.asset_base_path.as_ref());\n+\n         let asset_path = asset_path\n-            .strip_prefix(&format!(\"{}/\", self.client_root.path))\n+            .strip_prefix(&format!(\"{}/\", client_root.path))\n             .context(\"expected asset_path to contain client_root\")?;\n \n         Ok(Vc::cell(\n             format!(\n                 \"{}{}\",\n-                self.asset_base_path\n-                    .as_ref()\n-                    .map(|s| s.as_str())\n-                    .unwrap_or(\"/\"),\n+                asset_base_path.map(|s| s.as_str()).unwrap_or(\"/\"),\n                 asset_path\n             )\n             .into(),\n@@ -537,6 +570,7 @@ impl ChunkingContext for BrowserChunkingContext {\n         &self,\n         content_hash: RcStr,\n         original_asset_ident: Vc<AssetIdent>,\n+        tag: Option<RcStr>,\n     ) -> Result<Vc<FileSystemPath>> {\n         let source_path = original_asset_ident.path().await?;\n         let basename = source_path.file_name();\n@@ -551,7 +585,13 @@ impl ChunkingContext for BrowserChunkingContext {\n                 content_hash = &content_hash[..8]\n             ),\n         };\n-        Ok(self.asset_root_path.join(&asset_path)?.cell())\n+\n+        let asset_root_path = tag\n+            .as_ref()\n+            .and_then(|tag| self.asset_root_paths.get(tag))\n+            .unwrap_or(&self.asset_root_path);\n+\n+        Ok(asset_root_path.join(&asset_path)?.cell())\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "d7a4434f9c7f2d6317ed8a70f76bf409669570f9",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking_context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -184,14 +184,17 @@ pub trait ChunkingContext {\n \n     /// Returns a URL (relative or absolute, depending on the asset prefix) to\n     /// the static asset based on its `ident`.\n+    /// The `tag` is an arbitrary string that can be used to distinguish\n+    /// different usages of the same asset (e.g. different base paths).\n     #[turbo_tasks::function]\n-    fn asset_url(self: Vc<Self>, ident: FileSystemPath) -> Result<Vc<RcStr>>;\n+    fn asset_url(self: Vc<Self>, ident: FileSystemPath, tag: Option<RcStr>) -> Result<Vc<RcStr>>;\n \n     #[turbo_tasks::function]\n     fn asset_path(\n         self: Vc<Self>,\n         content_hash: RcStr,\n         original_asset_ident: Vc<AssetIdent>,\n+        tag: Option<RcStr>,\n     ) -> Vc<FileSystemPath>;\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "c877f39598bee301cd5fc91c0bd59b36cd0c382d",
            "filename": "turbopack/crates/turbopack-nodejs/src/chunking_context.rs",
            "status": "modified",
            "additions": 48,
            "deletions": 6,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -1,7 +1,7 @@\n use anyhow::{Context, Result, bail};\n use tracing::Instrument;\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{ResolvedVc, TaskInput, TryJoinIterExt, Upcast, ValueToString, Vc};\n+use turbo_tasks::{FxIndexMap, ResolvedVc, TryJoinIterExt, Upcast, ValueToString, Vc};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n     asset::Asset,\n@@ -45,6 +45,21 @@ impl NodeJsChunkingContextBuilder {\n         self\n     }\n \n+    pub fn asset_prefix_override(mut self, tag: RcStr, prefix: RcStr) -> Self {\n+        self.chunking_context.asset_prefixes.insert(tag, prefix);\n+        self\n+    }\n+\n+    pub fn asset_root_path_override(mut self, tag: RcStr, path: FileSystemPath) -> Self {\n+        self.chunking_context.asset_root_paths.insert(tag, path);\n+        self\n+    }\n+\n+    pub fn client_roots_override(mut self, tag: RcStr, path: FileSystemPath) -> Self {\n+        self.chunking_context.client_roots.insert(tag, path);\n+        self\n+    }\n+\n     pub fn minify_type(mut self, minify_type: MinifyType) -> Self {\n         self.chunking_context.minify_type = minify_type;\n         self\n@@ -125,7 +140,7 @@ impl NodeJsChunkingContextBuilder {\n \n /// A chunking context for build mode.\n #[turbo_tasks::value]\n-#[derive(Debug, Clone, Hash, TaskInput)]\n+#[derive(Debug, Clone)]\n pub struct NodeJsChunkingContext {\n     /// The root path of the project\n     root_path: FileSystemPath,\n@@ -135,12 +150,18 @@ pub struct NodeJsChunkingContext {\n     output_root_to_root_path: RcStr,\n     /// This path is used to compute the url to request chunks or assets from\n     client_root: FileSystemPath,\n+    /// This path is used to compute the url to request chunks or assets from\n+    client_roots: FxIndexMap<RcStr, FileSystemPath>,\n     /// Chunks are placed at this path\n     chunk_root_path: FileSystemPath,\n     /// Static assets are placed at this path\n     asset_root_path: FileSystemPath,\n+    /// Static assets are placed at this path\n+    asset_root_paths: FxIndexMap<RcStr, FileSystemPath>,\n     /// Static assets requested from this url base\n     asset_prefix: Option<RcStr>,\n+    /// Static assets requested from this url base\n+    asset_prefixes: FxIndexMap<RcStr, RcStr>,\n     /// The environment chunks will be evaluated in.\n     environment: ResolvedVc<Environment>,\n     /// The kind of runtime to include in the output.\n@@ -187,9 +208,12 @@ impl NodeJsChunkingContext {\n                 output_root,\n                 output_root_to_root_path,\n                 client_root,\n+                client_roots: Default::default(),\n                 chunk_root_path,\n                 asset_root_path,\n+                asset_root_paths: Default::default(),\n                 asset_prefix: None,\n+                asset_prefixes: Default::default(),\n                 enable_file_tracing: false,\n                 enable_module_merging: false,\n                 enable_dynamic_chunk_content_loading: false,\n@@ -298,16 +322,27 @@ impl ChunkingContext for NodeJsChunkingContext {\n     }\n \n     #[turbo_tasks::function]\n-    async fn asset_url(&self, ident: FileSystemPath) -> Result<Vc<RcStr>> {\n+    async fn asset_url(&self, ident: FileSystemPath, tag: Option<RcStr>) -> Result<Vc<RcStr>> {\n         let asset_path = ident.to_string();\n+\n+        let client_root = tag\n+            .as_ref()\n+            .and_then(|tag| self.client_roots.get(tag))\n+            .unwrap_or(&self.client_root);\n+\n+        let asset_prefix = tag\n+            .as_ref()\n+            .and_then(|tag| self.asset_prefixes.get(tag))\n+            .or(self.asset_prefix.as_ref());\n+\n         let asset_path = asset_path\n-            .strip_prefix(&format!(\"{}/\", self.client_root.path))\n+            .strip_prefix(&format!(\"{}/\", client_root.path))\n             .context(\"expected client root to contain asset path\")?;\n \n         Ok(Vc::cell(\n             format!(\n                 \"{}{}\",\n-                self.asset_prefix.clone().unwrap_or(rcstr!(\"/\")),\n+                asset_prefix.map(|s| s.as_str()).unwrap_or(\"/\"),\n                 asset_path\n             )\n             .into(),\n@@ -366,6 +401,7 @@ impl ChunkingContext for NodeJsChunkingContext {\n         &self,\n         content_hash: RcStr,\n         original_asset_ident: Vc<AssetIdent>,\n+        tag: Option<RcStr>,\n     ) -> Result<Vc<FileSystemPath>> {\n         let source_path = original_asset_ident.path().await?;\n         let basename = source_path.file_name();\n@@ -380,7 +416,13 @@ impl ChunkingContext for NodeJsChunkingContext {\n                 content_hash = &content_hash[..8]\n             ),\n         };\n-        Ok(self.asset_root_path.join(&asset_path)?.cell())\n+\n+        let asset_root_path = tag\n+            .as_ref()\n+            .and_then(|tag| self.asset_root_paths.get(tag))\n+            .unwrap_or(&self.asset_root_path);\n+\n+        Ok(asset_root_path.join(&asset_path)?.cell())\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "92b9b39351e1d88dccc9e96f310e7bc9cb86e103",
            "filename": "turbopack/crates/turbopack-static/src/css.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fcss.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fcss.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fcss.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -1,4 +1,4 @@\n-use turbo_rcstr::rcstr;\n+use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, Vc};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n@@ -16,29 +16,34 @@ use crate::output_asset::StaticOutputAsset;\n #[derive(Clone)]\n pub struct StaticUrlCssModule {\n     pub source: ResolvedVc<Box<dyn Source>>,\n+    tag: Option<RcStr>,\n }\n \n #[turbo_tasks::value_impl]\n impl StaticUrlCssModule {\n     #[turbo_tasks::function]\n-    pub fn new(source: ResolvedVc<Box<dyn Source>>) -> Vc<Self> {\n-        Self::cell(StaticUrlCssModule { source })\n+    pub fn new(source: ResolvedVc<Box<dyn Source>>, tag: Option<RcStr>) -> Vc<Self> {\n+        Self::cell(StaticUrlCssModule { source, tag })\n     }\n \n     #[turbo_tasks::function]\n     fn static_output_asset(\n         &self,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     ) -> Vc<StaticOutputAsset> {\n-        StaticOutputAsset::new(*chunking_context, *self.source)\n+        StaticOutputAsset::new(*chunking_context, *self.source, self.tag.clone())\n     }\n }\n \n #[turbo_tasks::value_impl]\n impl Module for StaticUrlCssModule {\n     #[turbo_tasks::function]\n     fn ident(&self) -> Vc<AssetIdent> {\n-        self.source.ident().with_modifier(rcstr!(\"static in css\"))\n+        let mut ident = self.source.ident().with_modifier(rcstr!(\"static in css\"));\n+        if let Some(tag) = &self.tag {\n+            ident = ident.with_modifier(format!(\"tag {}\", tag).into());\n+        }\n+        ident\n     }\n }\n "
        },
        {
            "sha": "cf5530fdfacb8e802c61638ff5c5adbe7b4a07a8",
            "filename": "turbopack/crates/turbopack-static/src/ecma.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fecma.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fecma.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fecma.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -1,5 +1,5 @@\n use anyhow::Result;\n-use turbo_rcstr::rcstr;\n+use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, Vc};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n@@ -25,31 +25,37 @@ use crate::output_asset::StaticOutputAsset;\n #[derive(Clone)]\n pub struct StaticUrlJsModule {\n     pub source: ResolvedVc<Box<dyn Source>>,\n+    pub tag: Option<RcStr>,\n }\n \n #[turbo_tasks::value_impl]\n impl StaticUrlJsModule {\n     #[turbo_tasks::function]\n-    pub fn new(source: ResolvedVc<Box<dyn Source>>) -> Vc<Self> {\n-        Self::cell(StaticUrlJsModule { source })\n+    pub fn new(source: ResolvedVc<Box<dyn Source>>, tag: Option<RcStr>) -> Vc<Self> {\n+        Self::cell(StaticUrlJsModule { source, tag })\n     }\n \n     #[turbo_tasks::function]\n     fn static_output_asset(\n         &self,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     ) -> Vc<StaticOutputAsset> {\n-        StaticOutputAsset::new(*chunking_context, *self.source)\n+        StaticOutputAsset::new(*chunking_context, *self.source, self.tag.clone())\n     }\n }\n \n #[turbo_tasks::value_impl]\n impl Module for StaticUrlJsModule {\n     #[turbo_tasks::function]\n     fn ident(&self) -> Vc<AssetIdent> {\n-        self.source\n+        let mut ident = self\n+            .source\n             .ident()\n-            .with_modifier(rcstr!(\"static in ecmascript\"))\n+            .with_modifier(rcstr!(\"static in ecmascript\"));\n+        if let Some(tag) = &self.tag {\n+            ident = ident.with_modifier(format!(\"tag {}\", tag).into());\n+        }\n+        ident\n     }\n }\n \n@@ -77,6 +83,7 @@ impl ChunkableModule for StaticUrlJsModule {\n                     .static_output_asset(*chunking_context)\n                     .to_resolved()\n                     .await?,\n+                tag: self.await?.tag.clone(),\n             },\n         )))\n     }\n@@ -95,6 +102,7 @@ struct StaticUrlJsChunkItem {\n     module: ResolvedVc<StaticUrlJsModule>,\n     chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     static_asset: ResolvedVc<StaticOutputAsset>,\n+    tag: Option<RcStr>,\n }\n \n #[turbo_tasks::value_impl]\n@@ -137,7 +145,7 @@ impl EcmascriptChunkItem for StaticUrlJsChunkItem {\n                 path = StringifyJs(\n                     &self\n                         .chunking_context\n-                        .asset_url(self.static_asset.path().owned().await?)\n+                        .asset_url(self.static_asset.path().owned().await?, self.tag.clone())\n                         .await?\n                 )\n             )"
        },
        {
            "sha": "3d9600f5e078a75f9c10daf453defff5a2ece62f",
            "filename": "turbopack/crates/turbopack-static/src/output_asset.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Foutput_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Foutput_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Foutput_asset.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -1,4 +1,5 @@\n use anyhow::Result;\n+use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, Vc};\n use turbo_tasks_fs::{FileContent, FileSystemPath};\n use turbopack_core::{\n@@ -11,6 +12,7 @@ use turbopack_core::{\n pub struct StaticOutputAsset {\n     chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     source: ResolvedVc<Box<dyn Source>>,\n+    tag: Option<RcStr>,\n }\n \n #[turbo_tasks::value_impl]\n@@ -19,10 +21,12 @@ impl StaticOutputAsset {\n     pub fn new(\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n         source: ResolvedVc<Box<dyn Source>>,\n+        tag: Option<RcStr>,\n     ) -> Vc<Self> {\n         Self::cell(StaticOutputAsset {\n             chunking_context,\n             source,\n+            tag,\n         })\n     }\n }\n@@ -42,9 +46,11 @@ impl OutputAsset for StaticOutputAsset {\n             anyhow::bail!(\"StaticAsset::path: unsupported file content\")\n         };\n         let content_hash_b16 = turbo_tasks_hash::encode_hex(content_hash);\n-        Ok(self\n-            .chunking_context\n-            .asset_path(content_hash_b16.into(), self.source.ident()))\n+        Ok(self.chunking_context.asset_path(\n+            content_hash_b16.into(),\n+            self.source.ident(),\n+            self.tag.clone(),\n+        ))\n     }\n }\n "
        },
        {
            "sha": "565fd0381c977ba89804379d3a818cf91cf52eac",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -271,12 +271,16 @@ async fn apply_module_type(\n             .to_resolved()\n             .await?,\n         ),\n-        ModuleType::StaticUrlJs => {\n-            ResolvedVc::upcast(StaticUrlJsModule::new(*source).to_resolved().await?)\n-        }\n-        ModuleType::StaticUrlCss => {\n-            ResolvedVc::upcast(StaticUrlCssModule::new(*source).to_resolved().await?)\n-        }\n+        ModuleType::StaticUrlJs { tag } => ResolvedVc::upcast(\n+            StaticUrlJsModule::new(*source, tag.clone())\n+                .to_resolved()\n+                .await?,\n+        ),\n+        ModuleType::StaticUrlCss { tag } => ResolvedVc::upcast(\n+            StaticUrlCssModule::new(*source, tag.clone())\n+                .to_resolved()\n+                .await?,\n+        ),\n         ModuleType::InlinedBytesJs => {\n             ResolvedVc::upcast(InlinedBytesJsModule::new(*source).to_resolved().await?)\n         }"
        },
        {
            "sha": "327d87be986bfb17332a3b8f2bc222a4d06d5404",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 17,
            "deletions": 3,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -434,15 +434,29 @@ impl ModuleOptions {\n                     RuleCondition::ResourcePathEndsWith(\".webp\".to_string()),\n                     RuleCondition::ResourcePathEndsWith(\".woff2\".to_string()),\n                 ]),\n-                vec![ModuleRuleEffect::ModuleType(ModuleType::StaticUrlJs)],\n+                vec![ModuleRuleEffect::ModuleType(ModuleType::StaticUrlJs {\n+                    tag: None,\n+                })],\n             ),\n             ModuleRule::new(\n                 RuleCondition::ReferenceType(ReferenceType::Url(UrlReferenceSubType::Undefined)),\n-                vec![ModuleRuleEffect::ModuleType(ModuleType::StaticUrlJs)],\n+                vec![ModuleRuleEffect::ModuleType(ModuleType::StaticUrlJs {\n+                    tag: None,\n+                })],\n+            ),\n+            ModuleRule::new(\n+                RuleCondition::ReferenceType(ReferenceType::Url(\n+                    UrlReferenceSubType::EcmaScriptNewUrl,\n+                )),\n+                vec![ModuleRuleEffect::ModuleType(ModuleType::StaticUrlJs {\n+                    tag: None,\n+                })],\n             ),\n             ModuleRule::new(\n                 RuleCondition::ReferenceType(ReferenceType::Url(UrlReferenceSubType::CssUrl)),\n-                vec![ModuleRuleEffect::ModuleType(ModuleType::StaticUrlCss)],\n+                vec![ModuleRuleEffect::ModuleType(ModuleType::StaticUrlCss {\n+                    tag: None,\n+                })],\n             ),\n         ];\n "
        },
        {
            "sha": "28ff609703b32f411bc8c3cf3c8ccb1a3517d4d3",
            "filename": "turbopack/crates/turbopack/src/module_options/module_rule.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f80c92261ebbb0b376e45f0b15bd5657609a03d9/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs?ref=f80c92261ebbb0b376e45f0b15bd5657609a03d9",
            "patch": "@@ -1,5 +1,6 @@\n use anyhow::Result;\n use serde::{Deserialize, Serialize};\n+use turbo_rcstr::RcStr;\n use turbo_tasks::{NonLocalValue, ResolvedVc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n@@ -138,8 +139,14 @@ pub enum ModuleType {\n         ty: CssModuleAssetType,\n         environment: Option<ResolvedVc<Environment>>,\n     },\n-    StaticUrlJs,\n-    StaticUrlCss,\n+    StaticUrlJs {\n+        /// The tag that is passed to ChunkingContext::asset_url\n+        tag: Option<RcStr>,\n+    },\n+    StaticUrlCss {\n+        /// The tag that is passed to ChunkingContext::asset_url\n+        tag: Option<RcStr>,\n+    },\n     InlinedBytesJs,\n     WebAssembly {\n         source_ty: WebAssemblySourceType,"
        }
    ],
    "stats": {
        "total": 1080,
        "additions": 746,
        "deletions": 334
    }
}