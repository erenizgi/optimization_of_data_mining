{
    "author": "devjiwonchoi",
    "message": "Add codemod for removing `experimental_ppr` (#84979)\n\n`experimental_ppr` is removed by\nhttps://github.com/vercel/next.js/pull/84871, so add codemod for it.",
    "sha": "b42555aa39f7b6823d827715d73608701d458d1e",
    "files": [
        {
            "sha": "dacfcb097192bae361f2e05ed38784c6e0c9668e",
            "filename": "docs/01-app/02-guides/upgrading/codemods.mdx",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/b42555aa39f7b6823d827715d73608701d458d1e/docs%2F01-app%2F02-guides%2Fupgrading%2Fcodemods.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/b42555aa39f7b6823d827715d73608701d458d1e/docs%2F01-app%2F02-guides%2Fupgrading%2Fcodemods.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F02-guides%2Fupgrading%2Fcodemods.mdx?ref=b42555aa39f7b6823d827715d73608701d458d1e",
            "patch": "@@ -26,6 +26,20 @@ Replacing `<transform>` and `<path>` with appropriate values.\n \n ### 16.0\n \n+#### Remove `experimental_ppr` Route Segment Config from App Router pages and layouts\n+\n+##### `remove-experimental-ppr`\n+\n+```bash filename=\"Terminal\"\n+npx @next/codemod@latest remove-experimental-ppr .\n+```\n+\n+This codemod removes the `experimental_ppr` Route Segment Config from App Router pages and layouts.\n+\n+```diff filename=\"app/page.tsx\"\n+- export const experimental_ppr = true;\n+```\n+\n #### Migrate from `next lint` to ESLint CLI\n \n ##### `next-lint-to-eslint-cli`"
        },
        {
            "sha": "84e5494ad0e31f976255f6b6e6f620a7bf79fe76",
            "filename": "packages/next-codemod/lib/utils.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Flib%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Flib%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Flib%2Futils.ts?ref=b42555aa39f7b6823d827715d73608701d458d1e",
            "patch": "@@ -137,4 +137,10 @@ export const TRANSFORMER_INQUIRER_CHOICES = [\n     value: 'remove-unstable-prefix',\n     version: '16.0.0-canary.10',\n   },\n+  {\n+    title:\n+      'Remove `experimental_ppr` Route Segment Config from App Router pages and layouts',\n+    value: 'remove-experimental-ppr',\n+    version: '16.0.0-canary.11',\n+  },\n ]"
        },
        {
            "sha": "1552ab34d4c822bfcf7d7728ebf7ff4fda310e7d",
            "filename": "packages/next-codemod/transforms/__testfixtures__/remove-experimental-ppr/basic.input.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fbasic.input.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fbasic.input.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fbasic.input.tsx?ref=b42555aa39f7b6823d827715d73608701d458d1e",
            "patch": "@@ -0,0 +1,7 @@\n+// @ts-nocheck\n+export default function Page() {\n+  return <p>hello world</p>;\n+}\n+\n+export const experimental_ppr = true;\n+export const runtime = 'nodejs';"
        },
        {
            "sha": "95c7523afc972d38d6343c79548bff139a36198f",
            "filename": "packages/next-codemod/transforms/__testfixtures__/remove-experimental-ppr/basic.output.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fbasic.output.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fbasic.output.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fbasic.output.tsx?ref=b42555aa39f7b6823d827715d73608701d458d1e",
            "patch": "@@ -0,0 +1,6 @@\n+// @ts-nocheck\n+export default function Page() {\n+  return <p>hello world</p>;\n+}\n+\n+export const runtime = 'nodejs';"
        },
        {
            "sha": "e21b8ffb493e573b88f4ec7d392453e63e2ebf73",
            "filename": "packages/next-codemod/transforms/__testfixtures__/remove-experimental-ppr/separate-export.input.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fseparate-export.input.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fseparate-export.input.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fseparate-export.input.tsx?ref=b42555aa39f7b6823d827715d73608701d458d1e",
            "patch": "@@ -0,0 +1,9 @@\n+// @ts-nocheck\n+export default function Page() {\n+  return <p>hello world</p>;\n+}\n+\n+const experimental_ppr = true;\n+const runtime = 'nodejs';\n+\n+export { experimental_ppr, runtime };\n\\ No newline at end of file"
        },
        {
            "sha": "474c65da2ecc58f43463ccf7211925de9e34d115",
            "filename": "packages/next-codemod/transforms/__testfixtures__/remove-experimental-ppr/separate-export.output.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fseparate-export.output.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fseparate-export.output.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fremove-experimental-ppr%2Fseparate-export.output.tsx?ref=b42555aa39f7b6823d827715d73608701d458d1e",
            "patch": "@@ -0,0 +1,8 @@\n+// @ts-nocheck\n+export default function Page() {\n+  return <p>hello world</p>;\n+}\n+\n+const runtime = 'nodejs';\n+\n+export { runtime };\n\\ No newline at end of file"
        },
        {
            "sha": "b8ad7241f8209d764df92f73a9c26e45114c3439",
            "filename": "packages/next-codemod/transforms/__tests__/remove-experimental-ppr.test.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2F__tests__%2Fremove-experimental-ppr.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2F__tests__%2Fremove-experimental-ppr.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__tests__%2Fremove-experimental-ppr.test.js?ref=b42555aa39f7b6823d827715d73608701d458d1e",
            "patch": "@@ -0,0 +1,16 @@\n+/* global jest */\n+jest.autoMockOff()\n+const defineTest = require('jscodeshift/dist/testUtils').defineTest\n+const { readdirSync } = require('fs')\n+const { join } = require('path')\n+\n+const fixtureDir = 'remove-experimental-ppr'\n+const fixtureDirPath = join(__dirname, '..', '__testfixtures__', fixtureDir)\n+const fixtures = readdirSync(fixtureDirPath)\n+  .filter(file => file.endsWith('.input.tsx'))\n+  .map(file => file.replace('.input.tsx', ''))\n+\n+for (const fixture of fixtures) {\n+  const prefix = `${fixtureDir}/${fixture}`;\n+  defineTest(__dirname, fixtureDir, null, prefix, { parser: 'tsx' });\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "0336917d586bbd8ee8fb96c5f75775bffe505e11",
            "filename": "packages/next-codemod/transforms/remove-experimental-ppr.ts",
            "status": "added",
            "additions": 85,
            "deletions": 0,
            "changes": 85,
            "blob_url": "https://github.com/vercel/next.js/blob/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2Fremove-experimental-ppr.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b42555aa39f7b6823d827715d73608701d458d1e/packages%2Fnext-codemod%2Ftransforms%2Fremove-experimental-ppr.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2Fremove-experimental-ppr.ts?ref=b42555aa39f7b6823d827715d73608701d458d1e",
            "patch": "@@ -0,0 +1,85 @@\n+import type { API, FileInfo } from 'jscodeshift'\n+import { createParserFromPath } from '../lib/parser'\n+\n+export default function transformer(file: FileInfo, _api: API) {\n+  // Run on App Router page/layout/route files, except for test environment.\n+  if (\n+    process.env.NODE_ENV !== 'test' &&\n+    !/[/\\\\]app[/\\\\](?:.*[/\\\\])?(page|layout|route)(\\.[^/\\\\]*)?$/.test(file.path)\n+  ) {\n+    return file.source\n+  }\n+\n+  const j = createParserFromPath(file.path)\n+  const root = j(file.source)\n+\n+  let hasChanges = false\n+\n+  // Remove export const experimental_ppr = boolean\n+  const directExports = root.find(j.ExportNamedDeclaration, {\n+    declaration: {\n+      type: 'VariableDeclaration',\n+      declarations: [\n+        {\n+          id: { name: 'experimental_ppr' },\n+        },\n+      ],\n+    },\n+  })\n+\n+  if (directExports.size() > 0) {\n+    directExports.remove()\n+    hasChanges = true\n+  }\n+\n+  // Remove const experimental_ppr = boolean declarations\n+  const variableDeclarations = root.find(j.VariableDeclaration).filter((path) =>\n+    path.node.declarations.some((decl) => {\n+      if (j.VariableDeclarator.check(decl) && j.Identifier.check(decl.id)) {\n+        return decl.id.name === 'experimental_ppr'\n+      }\n+      return false\n+    })\n+  )\n+\n+  if (variableDeclarations.size() > 0) {\n+    variableDeclarations.remove()\n+    hasChanges = true\n+  }\n+\n+  // Handle export { experimental_ppr } and export { experimental_ppr, other }\n+  const namedExports = root\n+    .find(j.ExportNamedDeclaration)\n+    .filter((path) => path.node.specifiers && path.node.specifiers.length > 0)\n+\n+  namedExports.forEach((path) => {\n+    const specifiers = path.node.specifiers\n+    if (!specifiers) return\n+\n+    const filteredSpecifiers = specifiers.filter((spec) => {\n+      if (j.ExportSpecifier.check(spec) && j.Identifier.check(spec.local)) {\n+        return spec.local.name !== 'experimental_ppr'\n+      }\n+      return true\n+    })\n+\n+    // If we removed any specifiers\n+    if (filteredSpecifiers.length !== specifiers.length) {\n+      hasChanges = true\n+\n+      // If no specifiers left, remove the entire export statement\n+      if (filteredSpecifiers.length === 0) {\n+        j(path).remove()\n+      } else {\n+        // Update the specifiers array\n+        path.node.specifiers = filteredSpecifiers\n+      }\n+    }\n+  })\n+\n+  if (hasChanges) {\n+    return root.toSource()\n+  }\n+\n+  return file.source\n+}"
        }
    ],
    "stats": {
        "total": 151,
        "additions": 151,
        "deletions": 0
    }
}