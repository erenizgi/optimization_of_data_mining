{
    "author": "lubieowoce",
    "message": "fix: support calling onClose multiple times in edge-ssr-app (#81911)\n\n#81389 changed the implementation of `edge-ssr-app`. it added a\n`RenderOpts.onClose` implemented like this:\n```ts\nlet onCloseCallback: (() => void) | undefined\nconst renderOpts = {\n  // ...\n  onClose: (cb) => {\n    onCloseCallback = cb\n  },\n}\n```\nthis does not match the behavior of the node implementations of\n`onClose`, which use `res.on('close', cb)` -- calling this `onClose`\nmultiple times won't work right, because we'll only store the last\ncallback.\n\nin practice we currently only call `onClose` once per request, in\n`AfterContext`, so this *technically works*. but that might change in\nthe future, and it'd break things in surprising ways. to avoid this, i'm\nchanging it to use `CloseController`, which we're already using in other\nplaces that need to implement this behavior.",
    "sha": "a21b68ab13c21b9669e5d8f1bc911a24ff0f02a2",
    "files": [
        {
            "sha": "77b36b97cdae35254c5a203f8ec5cea46c3c76ee",
            "filename": "packages/next/src/build/templates/edge-ssr-app.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/a21b68ab13c21b9669e5d8f1bc911a24ff0f02a2/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a21b68ab13c21b9669e5d8f1bc911a24ff0f02a2/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts?ref=a21b68ab13c21b9669e5d8f1bc911a24ff0f02a2",
            "patch": "@@ -24,6 +24,7 @@ import { getBotType } from '../../shared/lib/router/utils/is-bot'\n import { interopDefault } from '../../lib/interop-default'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { checkIsOnDemandRevalidate } from '../../server/api-utils'\n+import { CloseController } from '../../server/web/web-on-close'\n \n declare const incrementalCacheHandler: any\n // OPTIONAL_IMPORT:incrementalCacheHandler\n@@ -99,6 +100,8 @@ async function requestHandler(\n     prerenderManifest.preview\n   )\n \n+  const closeController = new CloseController()\n+\n   const renderContext: AppPageRouteHandlerContext = {\n     page: normalizedSrcPage,\n     query,\n@@ -175,7 +178,7 @@ async function requestHandler(\n \n       waitUntil: event.waitUntil.bind(event),\n       onClose: (cb) => {\n-        onCloseCallback = cb\n+        closeController.onClose(cb)\n       },\n       onAfterTaskError: () => {},\n \n@@ -190,7 +193,6 @@ async function requestHandler(\n     },\n   }\n   let finalStatus = 200\n-  let onCloseCallback: (() => void) | undefined\n \n   const renderResultToResponse = (\n     result: RenderResult<AppPageRenderResultMetadata>\n@@ -202,7 +204,7 @@ async function requestHandler(\n     // Handle null responses\n     if (result.isNull) {\n       finalStatus = 500\n-      onCloseCallback?.()\n+      closeController.dispatchClose()\n       return new Response(null, { status: 500 })\n     }\n \n@@ -246,7 +248,7 @@ async function requestHandler(\n         'Content-Length',\n         String(new TextEncoder().encode(body).length)\n       )\n-      onCloseCallback?.()\n+      closeController.dispatchClose()\n       return new Response(body, {\n         status: finalStatus,\n         headers,\n@@ -264,7 +266,7 @@ async function requestHandler(\n       .catch((err: unknown) => {\n         console.error('Error piping RenderResult to response:', err)\n       })\n-      .finally(() => onCloseCallback?.())\n+      .finally(() => closeController.dispatchClose())\n \n     return new Response(readable, {\n       status: finalStatus,"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 7,
        "deletions": 5
    }
}