{
    "author": "mischnic",
    "message": "Turbopack: respect PURE comments for minification (#80893)\n\nPreviously, when Turbopack invoked the swc minifier, comments were ignored, so code explicitly marked as side-effect free was still not removed\n\n```js\nconst unused = /*@__PURE__*/ (() => {\n  state++\n})()\n```\n(same for unused JSX as well)\n\nThis makes the output smaller",
    "sha": "ef1e4ba8381550dac6e53bc7e1e07e339e19c629",
    "files": [
        {
            "sha": "6275225d15549d2bbdc3162b17f2f3f47aabdb99",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ef1e4ba8381550dac6e53bc7e1e07e339e19c629/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ef1e4ba8381550dac6e53bc7e1e07e339e19c629/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=ef1e4ba8381550dac6e53bc7e1e07e339e19c629",
            "patch": "@@ -43,11 +43,14 @@ pub fn minify(code: Code, source_maps: bool, mangle: Option<MangleType>) -> Resu\n     let (src, mut src_map_buf) = {\n         let fm = cm.new_source_file(FileName::Anon.into(), source_code);\n \n+        // Collect all comments and pass to the minifier so that `PURE` comments are respected.\n+        let comments = SingleThreadedComments::default();\n+\n         let lexer = Lexer::new(\n             Syntax::default(),\n             EsVersion::latest(),\n             StringInput::from(&*fm),\n-            None,\n+            Some(&comments),\n         );\n         let mut parser = Parser::new_from(lexer);\n \n@@ -60,7 +63,6 @@ pub fn minify(code: Code, source_maps: bool, mangle: Option<MangleType>) -> Resu\n                         bail!(\"failed to parse source code\\n{}\", fm.src)\n                     }\n                 };\n-                let comments = SingleThreadedComments::default();\n                 let unresolved_mark = Mark::new();\n                 let top_level_mark = Mark::new();\n "
        },
        {
            "sha": "8dc5182f2097a2c12c8928d4e2db45ea0edefd56",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/ef1e4ba8381550dac6e53bc7e1e07e339e19c629/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ef1e4ba8381550dac6e53bc7e1e07e339e19c629/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=ef1e4ba8381550dac6e53bc7e1e07e339e19c629",
            "patch": "@@ -30,7 +30,7 @@ use turbopack::{\n     module_options::{EcmascriptOptionsContext, ModuleOptionsContext, TypescriptTransformOptions},\n };\n use turbopack_core::{\n-    chunk::ChunkingConfig,\n+    chunk::{ChunkingConfig, MangleType, MinifyType},\n     compile_time_defines,\n     compile_time_info::CompileTimeInfo,\n     condition::ContextCondition,\n@@ -243,6 +243,8 @@ struct TestOptions {\n     tree_shaking_mode: Option<TreeShakingMode>,\n     remove_unused_exports: Option<bool>,\n     scope_hoisting: Option<bool>,\n+    #[serde(default)]\n+    minify: bool,\n }\n \n #[turbo_tasks::value]\n@@ -437,6 +439,13 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n         },\n     )\n     .module_merging(options.scope_hoisting.unwrap_or(true))\n+    .minify_type(if options.minify {\n+        MinifyType::Minify {\n+            mangle: Some(MangleType::OptimalSize),\n+        }\n+    } else {\n+        MinifyType::NoMinify\n+    })\n     .build();\n \n     let jest_entry_source = FileSource::new(jest_entry_path);"
        },
        {
            "sha": "0059aacd93302048628ec323b3cb57803f202015",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/minification/pure/input/index.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ef1e4ba8381550dac6e53bc7e1e07e339e19c629/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fminification%2Fpure%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ef1e4ba8381550dac6e53bc7e1e07e339e19c629/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fminification%2Fpure%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fminification%2Fpure%2Finput%2Findex.js?ref=ef1e4ba8381550dac6e53bc7e1e07e339e19c629",
            "patch": "@@ -0,0 +1,9 @@\n+let state = 0\n+\n+const unused = /*@__PURE__*/ (() => {\n+  state++\n+})()\n+\n+it('should remove unused PURE statements', () => {\n+  expect(state).toBe(0)\n+})"
        },
        {
            "sha": "3dc1021aa825f9bf91d35af760f984780cc54eb5",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/minification/pure/options.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/ef1e4ba8381550dac6e53bc7e1e07e339e19c629/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fminification%2Fpure%2Foptions.json",
            "raw_url": "https://github.com/vercel/next.js/raw/ef1e4ba8381550dac6e53bc7e1e07e339e19c629/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fminification%2Fpure%2Foptions.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fminification%2Fpure%2Foptions.json?ref=ef1e4ba8381550dac6e53bc7e1e07e339e19c629",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"minify\": true\n+}"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 26,
        "deletions": 3
    }
}