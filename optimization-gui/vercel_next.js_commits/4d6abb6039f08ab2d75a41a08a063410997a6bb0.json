{
    "author": "mischnic",
    "message": "chore: Fix test snapshot (#83901)\n\nA new version of sharp was released a few hours ago, which broke the tests:\n```\nexpect(received).toMatchInlineSnapshot(snapshot)\n\nSnapshot name: `next-server-nft should not trace too many files in next-server.js.nft.json 1`\n\n- Snapshot  - 8\n+ Received  + 3\n\n@@ -1,22 +1,18 @@\n  [\n+   \"/node_modules/@img/colour/color.cjs\",\n+   \"/node_modules/@img/colour/index.cjs\",\n    \"/node_modules/@next/env/dist/index.js\",\n    \"/node_modules/@swc/helpers/cjs/_class_private_field_loose_base.cjs\",\n    \"/node_modules/@swc/helpers/cjs/_class_private_field_loose_key.cjs\",\n    \"/node_modules/@swc/helpers/cjs/_interop_require_default.cjs\",\n    \"/node_modules/@swc/helpers/cjs/_interop_require_wildcard.cjs\",\n    \"/node_modules/client-only/index.js\",\n-   \"/node_modules/color-convert/conversions.js\",\n-   \"/node_modules/color-convert/index.js\",\n-   \"/node_modules/color-convert/route.js\",\n-   \"/node_modules/color-name/index.js\",\n-   \"/node_modules/color-string/index.js\",\n-   \"/node_modules/color/index.js\",\n    \"/node_modules/detect-libc/lib/detect-libc.js\",\n+   \"/node_modules/detect-libc/lib/elf.js\",\n    \"/node_modules/detect-libc/lib/filesystem.js\",\n    \"/node_modules/detect-libc/lib/process.js\",\n-   \"/node_modules/is-arrayish/index.js\",\n    \"/node_modules/next/dist/build/output/log.js\",\n    \"/node_modules/next/dist/build/segment-config/app/app-segment-config.js\",\n    \"/node_modules/next/dist/build/segment-config/app/app-segments.js\",\n    \"/node_modules/next/dist/build/static-paths/utils.js\",\n    \"/node_modules/next/dist/client/*\",\n@@ -156,11 +152,10 @@\n    \"/node_modules/sharp/lib/operation.js\",\n    \"/node_modules/sharp/lib/output.js\",\n    \"/node_modules/sharp/lib/resize.js\",\n    \"/node_modules/sharp/lib/sharp.js\",\n    \"/node_modules/sharp/lib/utility.js\",\n-   \"/node_modules/simple-swizzle/index.js\",\n    \"/node_modules/styled-jsx/dist/index/index.js\",\n    \"/node_modules/styled-jsx/index.js\",\n    \"/node_modules/styled-jsx/style.js\",\n    \"@img/sharp-*/sharp-*.node\",\n    \"@img/sharp-libvips-*\",\n```",
    "sha": "4d6abb6039f08ab2d75a41a08a063410997a6bb0",
    "files": [
        {
            "sha": "14a181d150bc623dcd88b567628fee477993987a",
            "filename": "test/production/next-server-nft/next-server-nft.test.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 62,
            "changes": 95,
            "blob_url": "https://github.com/vercel/next.js/blob/4d6abb6039f08ab2d75a41a08a063410997a6bb0/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4d6abb6039f08ab2d75a41a08a063410997a6bb0/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts?ref=4d6abb6039f08ab2d75a41a08a063410997a6bb0",
            "patch": "@@ -48,14 +48,14 @@ const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n             .map((file: string) => {\n               // Normalize sharp, different architectures have different files\n               if (file.includes('/node_modules/@img/sharp-libvips-')) {\n-                return '@img/sharp-libvips-*'\n+                return '/node_modules/@img/sharp-libvips-*'\n               }\n               if (\n                 file.match(\n                   /\\/node_modules\\/@img\\/sharp-\\w+-\\w+\\/lib\\/sharp-\\w+-\\w+.node$/\n                 )\n               ) {\n-                return '@img/sharp-*/sharp-*.node'\n+                return '/node_modules/@img/sharp-*/sharp-*.node'\n               }\n \n               // Strip double node_modules to simplify output\n@@ -76,21 +76,32 @@ const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n     it('should not trace too many files in next-server.js.nft.json', async () => {\n       let trace = await readNormalizedNFT('.next/next-server.js.nft.json')\n \n-      //  Group the entries together so that the snapshot doesn't change too often.\n+      // Group the entries together so that the snapshot doesn't change too often.\n       // This trace contains quite a lot of files that aren't actually needed. But there isn't much\n       // that Turbopack itself can do about that.\n-\n       let traceGrouped = [\n         ...new Set(\n           trace.map((file: string) => {\n-            if (file.startsWith('/node_modules/next/dist/client/')) {\n-              return '/node_modules/next/dist/client/*'\n-            }\n-            if (file.startsWith('/node_modules/next/dist/server/')) {\n-              return '/node_modules/next/dist/server/*'\n-            }\n-            if (file.startsWith('/node_modules/next/dist/shared/')) {\n-              return '/node_modules/next/dist/shared/*'\n+            if (file.startsWith('/node_modules/next/')) {\n+              if (file.startsWith('/node_modules/next/dist/client/')) {\n+                return '/node_modules/next/dist/client/*'\n+              }\n+              if (file.startsWith('/node_modules/next/dist/server/')) {\n+                return '/node_modules/next/dist/server/*'\n+              }\n+              if (file.startsWith('/node_modules/next/dist/shared/')) {\n+                return '/node_modules/next/dist/shared/*'\n+              }\n+            } else if (\n+              file.startsWith('/node_modules/react') ||\n+              file.endsWith('.node')\n+            ) {\n+              return file\n+            } else {\n+              let match = /^\\/node_modules\\/(@[^/]+\\/[^/]+|[^/]+)\\//.exec(file)\n+              if (match != null) {\n+                return `/node_modules/${match[1]}/*`\n+              }\n             }\n             return file\n           })\n@@ -99,18 +110,13 @@ const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n \n       expect(traceGrouped).toMatchInlineSnapshot(`\n        [\n-         \"/node_modules/@img/colour/color.cjs\",\n-         \"/node_modules/@img/colour/index.cjs\",\n-         \"/node_modules/@next/env/dist/index.js\",\n-         \"/node_modules/@swc/helpers/cjs/_class_private_field_loose_base.cjs\",\n-         \"/node_modules/@swc/helpers/cjs/_class_private_field_loose_key.cjs\",\n-         \"/node_modules/@swc/helpers/cjs/_interop_require_default.cjs\",\n-         \"/node_modules/@swc/helpers/cjs/_interop_require_wildcard.cjs\",\n-         \"/node_modules/client-only/index.js\",\n-         \"/node_modules/detect-libc/lib/detect-libc.js\",\n-         \"/node_modules/detect-libc/lib/elf.js\",\n-         \"/node_modules/detect-libc/lib/filesystem.js\",\n-         \"/node_modules/detect-libc/lib/process.js\",\n+         \"/node_modules/@img/colour/*\",\n+         \"/node_modules/@img/sharp-*/sharp-*.node\",\n+         \"/node_modules/@img/*\",\n+         \"/node_modules/@next/env/*\",\n+         \"/node_modules/@swc/helpers/*\",\n+         \"/node_modules/client-only/*\",\n+         \"/node_modules/detect-libc/*\",\n          \"/node_modules/next/dist/build/output/log.js\",\n          \"/node_modules/next/dist/build/segment-config/app/app-segment-config.js\",\n          \"/node_modules/next/dist/build/segment-config/app/app-segments.js\",\n@@ -221,44 +227,9 @@ const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n          \"/node_modules/react/index.js\",\n          \"/node_modules/react/jsx-dev-runtime.js\",\n          \"/node_modules/react/jsx-runtime.js\",\n-         \"/node_modules/semver/classes/comparator.js\",\n-         \"/node_modules/semver/classes/range.js\",\n-         \"/node_modules/semver/classes/semver.js\",\n-         \"/node_modules/semver/functions/cmp.js\",\n-         \"/node_modules/semver/functions/coerce.js\",\n-         \"/node_modules/semver/functions/compare.js\",\n-         \"/node_modules/semver/functions/eq.js\",\n-         \"/node_modules/semver/functions/gt.js\",\n-         \"/node_modules/semver/functions/gte.js\",\n-         \"/node_modules/semver/functions/lt.js\",\n-         \"/node_modules/semver/functions/lte.js\",\n-         \"/node_modules/semver/functions/neq.js\",\n-         \"/node_modules/semver/functions/parse.js\",\n-         \"/node_modules/semver/functions/satisfies.js\",\n-         \"/node_modules/semver/internal/constants.js\",\n-         \"/node_modules/semver/internal/debug.js\",\n-         \"/node_modules/semver/internal/identifiers.js\",\n-         \"/node_modules/semver/internal/lrucache.js\",\n-         \"/node_modules/semver/internal/parse-options.js\",\n-         \"/node_modules/semver/internal/re.js\",\n-         \"/node_modules/sharp/lib/channel.js\",\n-         \"/node_modules/sharp/lib/colour.js\",\n-         \"/node_modules/sharp/lib/composite.js\",\n-         \"/node_modules/sharp/lib/constructor.js\",\n-         \"/node_modules/sharp/lib/index.js\",\n-         \"/node_modules/sharp/lib/input.js\",\n-         \"/node_modules/sharp/lib/is.js\",\n-         \"/node_modules/sharp/lib/libvips.js\",\n-         \"/node_modules/sharp/lib/operation.js\",\n-         \"/node_modules/sharp/lib/output.js\",\n-         \"/node_modules/sharp/lib/resize.js\",\n-         \"/node_modules/sharp/lib/sharp.js\",\n-         \"/node_modules/sharp/lib/utility.js\",\n-         \"/node_modules/styled-jsx/dist/index/index.js\",\n-         \"/node_modules/styled-jsx/index.js\",\n-         \"/node_modules/styled-jsx/style.js\",\n-         \"@img/sharp-*/sharp-*.node\",\n-         \"@img/sharp-libvips-*\",\n+         \"/node_modules/semver/*\",\n+         \"/node_modules/sharp/*\",\n+         \"/node_modules/styled-jsx/*\",\n        ]\n       `)\n     })"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 33,
        "deletions": 62
    }
}