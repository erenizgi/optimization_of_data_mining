{
    "author": "gaojude",
    "message": "Revert \"[next-server] skip setting vary header for basic routes\" (#79426)\n\nReverts vercel/next.js#77797\nReinstate the `Vary` header to prevent browsers from incorrectly reusing\nRSC responses during bfcache restores.",
    "sha": "5c8f6206b1b2454b3453ab78d45cff1ea28b4f26",
    "files": [
        {
            "sha": "825749fbb024002ffd1f318c63b9af22f49962f1",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5c8f6206b1b2454b3453ab78d45cff1ea28b4f26/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c8f6206b1b2454b3453ab78d45cff1ea28b4f26/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=5c8f6206b1b2454b3453ab78d45cff1ea28b4f26",
            "patch": "@@ -104,6 +104,7 @@ import {\n   NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n   NEXT_DID_POSTPONE_HEADER,\n   NEXT_URL,\n+  NEXT_ROUTER_STATE_TREE_HEADER,\n   NEXT_IS_PRERENDER_HEADER,\n } from '../client/components/app-router-headers'\n import type {\n@@ -2020,16 +2021,21 @@ export default abstract class Server<\n     isAppPath: boolean,\n     resolvedPathname: string\n   ): void {\n+    const baseVaryHeader = `${RSC_HEADER}, ${NEXT_ROUTER_STATE_TREE_HEADER}, ${NEXT_ROUTER_PREFETCH_HEADER}, ${NEXT_ROUTER_SEGMENT_PREFETCH_HEADER}`\n+    const isRSCRequest = getRequestMeta(req, 'isRSCRequest') ?? false\n+\n     let addedNextUrlToVary = false\n \n     if (isAppPath && this.pathCouldBeIntercepted(resolvedPathname)) {\n       // Interception route responses can vary based on the `Next-URL` header.\n       // We use the Vary header to signal this behavior to the client to properly cache the response.\n-      res.appendHeader('vary', `${NEXT_URL}`)\n+      res.appendHeader('vary', `${baseVaryHeader}, ${NEXT_URL}`)\n       addedNextUrlToVary = true\n+    } else if (isAppPath || isRSCRequest) {\n+      // We don't need to include `Next-URL` in the Vary header for non-interception routes since it won't affect the response.\n+      // We also set this header for pages to avoid caching issues when navigating between pages and app.\n+      res.appendHeader('vary', baseVaryHeader)\n     }\n-    // For other cases such as App Router requests or RSC requests we don't need to set vary header since we already\n-    // have the _rsc query with the unique hash value.\n \n     if (!addedNextUrlToVary) {\n       // Remove `Next-URL` from the request headers we determined it wasn't necessary to include in the Vary header."
        },
        {
            "sha": "7da1cf4c2701e6077251b144876fe81e10d8fe07",
            "filename": "test/e2e/app-dir/app/index.test.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/5c8f6206b1b2454b3453ab78d45cff1ea28b4f26/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c8f6206b1b2454b3453ab78d45cff1ea28b4f26/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts?ref=5c8f6206b1b2454b3453ab78d45cff1ea28b4f26",
            "patch": "@@ -323,6 +323,29 @@ describe('app dir - basic', () => {\n     expect(res.headers.get('Content-Type')).toBe('text/x-component')\n   })\n \n+  it('should return the `vary` header from edge runtime', async () => {\n+    const res = await next.fetch('/dashboard')\n+    expect(res.headers.get('x-edge-runtime')).toBe('1')\n+    expect(res.headers.get('vary')).toBe(\n+      'RSC, Next-Router-State-Tree, Next-Router-Prefetch, Next-Router-Segment-Prefetch'\n+    )\n+  })\n+\n+  if (!isNextDeploy) {\n+    it('should return the `vary` header from pages for flight requests', async () => {\n+      const res = await next.fetch('/', {\n+        headers: {\n+          ['RSC'.toString()]: '1',\n+        },\n+      })\n+      expect(res.headers.get('vary')).toBe(\n+        isNextDeploy\n+          ? 'RSC, Next-Router-State-Tree, Next-Router-Prefetch, Next-Router-Segment-Prefetch'\n+          : 'RSC, Next-Router-State-Tree, Next-Router-Prefetch, Next-Router-Segment-Prefetch, Accept-Encoding'\n+      )\n+    })\n+  }\n+\n   it('should pass props from getServerSideProps in root layout', async () => {\n     const $ = await next.render$('/dashboard')\n     expect($('title').first().text()).toBe('hello world')"
        },
        {
            "sha": "5919cd711b56093ea95a31bc3c45c95b6c65651f",
            "filename": "test/e2e/vary-header/test/index.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/5c8f6206b1b2454b3453ab78d45cff1ea28b4f26/test%2Fe2e%2Fvary-header%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c8f6206b1b2454b3453ab78d45cff1ea28b4f26/test%2Fe2e%2Fvary-header%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fvary-header%2Ftest%2Findex.test.ts?ref=5c8f6206b1b2454b3453ab78d45cff1ea28b4f26",
            "patch": "@@ -12,16 +12,21 @@ describe('Vary Header Tests', () => {\n     expect(res.headers.get('vary')).toContain('Custom-Header')\n   })\n \n-  it('should preserve custom vary header', async () => {\n+  it('should preserve custom vary header and append RSC headers in app route handlers', async () => {\n     const res = await next.fetch('/normal')\n     const varyHeader = res.headers.get('vary')\n \n     // Custom header is preserved\n     expect(varyHeader).toContain('User-Agent')\n     expect(res.headers.get('cache-control')).toBe('s-maxage=3600')\n+\n+    // Next.js internal headers are appended\n+    expect(varyHeader).toContain('RSC')\n+    expect(varyHeader).toContain('Next-Router-State-Tree')\n+    expect(varyHeader).toContain('Next-Router-Prefetch')\n   })\n \n-  it('should preserve middleware vary header', async () => {\n+  it('should preserve middleware vary header in combination with route handlers', async () => {\n     const res = await next.fetch('/normal')\n     const varyHeader = res.headers.get('vary')\n     const customHeader = res.headers.get('my-custom-header')\n@@ -32,5 +37,10 @@ describe('Vary Header Tests', () => {\n     // Both middleware and route handler vary headers are preserved\n     expect(varyHeader).toContain('my-custom-header')\n     expect(varyHeader).toContain('User-Agent')\n+\n+    // Next.js internal headers are still present\n+    expect(varyHeader).toContain('RSC')\n+    expect(varyHeader).toContain('Next-Router-State-Tree')\n+    expect(varyHeader).toContain('Next-Router-Prefetch')\n   })\n })"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 44,
        "deletions": 5
    }
}