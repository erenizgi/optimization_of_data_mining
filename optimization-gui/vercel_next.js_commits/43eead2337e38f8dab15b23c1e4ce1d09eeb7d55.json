{
    "author": "feedthejim",
    "message": "ci: run stats on canary pushes for historical trend tracking (#88157)\n\n## Summary\n\n- Add push trigger for canary branch to `pull_request_stats.yml`\n- Remove redundant `releaseStats` job from `build_and_deploy.yml`\n- Rename workflow/jobs from \"PR Stats\" to \"Stats\"\n\n## Background\n\nThe stats system was designed to save historical metrics to KV for trend\ntracking, but it wasn't working:\n\n1. `releaseStats` job only ran on actual stable releases (rare)\n2. When it did run, KV secrets were missing\n3. PR stats had KV secrets but didn't save (because `isRelease=false`)\n\nThis change consolidates stats into one workflow that runs on both PRs\nand canary pushes.\n\n## Behavior\n\n**For PRs:**\n- Compare PR branch vs canary HEAD\n- Post comment to PR\n- Don't save to KV\n\n**For canary pushes:**\n- Compare current canary vs last stable release tag\n- Post comment to the commit\n- Save stats to KV for historical trend tracking\n\n## Test plan\n\n- [ ] Verify workflow triggers on PR (existing behavior)\n- [ ] Verify workflow triggers on canary push (new behavior)\n- [ ] Verify stats are saved to KV on canary push\n- [ ] Verify trend sparklines appear in PR comments (once history builds\nup)",
    "sha": "43eead2337e38f8dab15b23c1e4ce1d09eeb7d55",
    "files": [
        {
            "sha": "245b9258413e6b5e83080e43dbaf285bc9547e75",
            "filename": ".github/workflows/build_and_deploy.yml",
            "status": "modified",
            "additions": 0,
            "deletions": 31,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/43eead2337e38f8dab15b23c1e4ce1d09eeb7d55/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/43eead2337e38f8dab15b23c1e4ce1d09eeb7d55/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_deploy.yml?ref=43eead2337e38f8dab15b23c1e4ce1d09eeb7d55",
            "patch": "@@ -680,37 +680,6 @@ jobs:\n       - run: exit 1\n         if: ${{ always() && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')) }}\n \n-  releaseStats:\n-    name: Release Stats\n-    runs-on:\n-      - 'self-hosted'\n-      - 'linux'\n-      - 'x64'\n-      - 'metal'\n-    timeout-minutes: 25\n-    needs: [publishRelease]\n-    steps:\n-      - uses: actions/checkout@v4\n-        with:\n-          fetch-depth: 25\n-\n-      - uses: actions/download-artifact@v4\n-        with:\n-          pattern: next-swc-binaries-*\n-          merge-multiple: true\n-          path: packages/next-swc/native\n-\n-      - run: cp -r packages/next-swc/native .github/actions/next-stats-action/native\n-\n-      - run: ./scripts/release-stats.sh\n-      - uses: ./.github/actions/next-stats-action\n-        env:\n-          PR_STATS_COMMENT_TOKEN: ${{ secrets.PR_STATS_COMMENT_TOKEN }}\n-          NEXT_SKIP_NATIVE_POSTINSTALL: 1\n-          # This uses the webpack bundle analyzer and for consistent results we need to use webpack.\n-          # Once there is an equivalent analyzer for turbopack, we can remove this.\n-          IS_WEBPACK_TEST: 1\n-\n   upload_turbopack_bytesize:\n     if: ${{ needs.deploy-target.outputs.value != 'automated-preview'}}\n     name: Upload Turbopack Bytesize metrics to Datadog"
        },
        {
            "sha": "08176864238e2f634ae184c504a01931a79c6462",
            "filename": ".github/workflows/pull_request_stats.yml",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/43eead2337e38f8dab15b23c1e4ce1d09eeb7d55/.github%2Fworkflows%2Fpull_request_stats.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/43eead2337e38f8dab15b23c1e4ce1d09eeb7d55/.github%2Fworkflows%2Fpull_request_stats.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fpull_request_stats.yml?ref=43eead2337e38f8dab15b23c1e4ce1d09eeb7d55",
            "patch": "@@ -1,8 +1,11 @@\n on:\n   pull_request:\n     types: [opened, synchronize]\n+  push:\n+    branches:\n+      - canary\n \n-name: Generate Pull Request Stats\n+name: Generate Stats\n \n concurrency:\n   group: ${{ github.workflow }}-${{ github.ref }}\n@@ -36,7 +39,7 @@ jobs:\n       uploadAnalyzerArtifacts: 'yes'\n \n   stats:\n-    name: PR Stats (${{ matrix.bundler }})\n+    name: Stats (${{ matrix.bundler }})\n     needs: build\n     timeout-minutes: 25\n     strategy:\n@@ -85,7 +88,7 @@ jobs:\n           retention-days: 1\n \n   stats-aggregate:\n-    name: Aggregate PR Stats\n+    name: Aggregate Stats\n     needs: stats\n     if: always() && needs.stats.result != 'cancelled'\n     runs-on: ubuntu-latest"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 6,
        "deletions": 34
    }
}