{
    "author": "mischnic",
    "message": "Turbopack: fix route format for NFT globs (#82997)\n\nThese are effectively the tests for https://github.com/vercel/next.js/pull/82906\n\n`outputFileTracingIncludes` and `outputFileTracingExcludes` match not against the pathname of the routes, but also include the app/pages prefix, e.g. `app/route1` for `src/app/route1/route.js` (at least the Webpack implementation does, which is what we're replicating here).",
    "sha": "40ad4fa548dc9ecc5d79645996e0a2defd7ac016",
    "files": [
        {
            "sha": "7fa9706275af84518e71e4c7c0152c1297319baf",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=40ad4fa548dc9ecc5d79645996e0a2defd7ac016",
            "patch": "@@ -34,10 +34,7 @@ use next_core::{\n     },\n     next_server_utility::{NEXT_SERVER_UTILITY_MERGE_TAG, NextServerUtilityTransition},\n     parse_segment_config_from_source,\n-    util::{\n-        NextRuntime, app_middleware_function_name, module_styles_rule_condition,\n-        styles_rule_condition,\n-    },\n+    util::{NextRuntime, app_function_name, module_styles_rule_condition, styles_rule_condition},\n };\n use serde::{Deserialize, Serialize};\n use tracing::Instrument;\n@@ -1587,7 +1584,7 @@ impl AppEndpoint {\n                         files: file_paths_from_root.into_iter().collect(),\n                         wasm: wasm_paths_to_bindings(wasm_paths_from_root).await?,\n                         assets: paths_to_bindings(all_assets),\n-                        name: app_middleware_function_name(&app_entry.original_name).into(),\n+                        name: app_function_name(&app_entry.original_name).into(),\n                         page: app_entry.original_name.clone(),\n                         regions: app_entry\n                             .config\n@@ -1698,11 +1695,10 @@ impl AppEndpoint {\n                     .await?\n                     .is_production()\n                 {\n-                    let page_name = app_entry.pathname.clone();\n                     server_assets.insert(ResolvedVc::upcast(\n                         NftJsonAsset::new(\n                             project,\n-                            Some(page_name),\n+                            Some(app_function_name(&app_entry.original_name).into()),\n                             *rsc_chunk,\n                             client_reference_manifest\n                                 .iter()"
        },
        {
            "sha": "8f6b81af1ee06cfd4ba6635f833e9c822a40744d",
            "filename": "crates/next-api/src/nft_json.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fnft_json.rs?ref=40ad4fa548dc9ecc5d79645996e0a2defd7ac016",
            "patch": "@@ -35,7 +35,8 @@ pub struct NftJsonAsset {\n     /// An example of this is the two-phase approach used by the `ClientReferenceManifest` in\n     /// next.js.\n     additional_assets: Vec<ResolvedVc<Box<dyn OutputAsset>>>,\n-    page_name: Option<RcStr>,\n+    // The page name, e.g. `pages/index` or `app/route1`\n+    page_name: Option<String>,\n }\n \n #[turbo_tasks::value_impl]\n@@ -51,7 +52,7 @@ impl NftJsonAsset {\n             chunk,\n             project,\n             additional_assets,\n-            page_name,\n+            page_name: page_name.map(|page_name| format!(\"/{page_name}\")),\n         }\n         .cell()\n     }"
        },
        {
            "sha": "075502b2d8421c5eb82e55817a3d6212e82ee64c",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=40ad4fa548dc9ecc5d79645996e0a2defd7ac016",
            "patch": "@@ -24,8 +24,7 @@ use next_core::{\n         PagesDirectoryStructure, PagesStructure, PagesStructureItem, find_pages_structure,\n     },\n     util::{\n-        NextRuntime, get_asset_prefix_from_pathname, pages_middleware_function_name,\n-        parse_config_from_source,\n+        NextRuntime, get_asset_prefix_from_pathname, pages_function_name, parse_config_from_source,\n     },\n };\n use serde::{Deserialize, Serialize};\n@@ -1176,7 +1175,7 @@ impl PageEndpoint {\n                     ResolvedVc::cell(Some(ResolvedVc::upcast(\n                         NftJsonAsset::new(\n                             project,\n-                            Some(this.original_name.clone()),\n+                            Some(pages_function_name(&this.original_name).into()),\n                             *ssr_entry_chunk,\n                             additional_assets,\n                         )\n@@ -1585,7 +1584,7 @@ impl PageEndpoint {\n                         files: file_paths_from_root.into_iter().collect(),\n                         wasm: wasm_paths_to_bindings(wasm_paths_from_root).await?,\n                         assets: paths_to_bindings(all_assets),\n-                        name: pages_middleware_function_name(&this.original_name).into(),\n+                        name: pages_function_name(&this.original_name).into(),\n                         page: this.original_name.clone(),\n                         regions,\n                         matchers: vec![matchers],"
        },
        {
            "sha": "de4629b93ac338808ca6e9128a78038b859c26c7",
            "filename": "crates/next-core/src/next_app/app_page_entry.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs?ref=40ad4fa548dc9ecc5d79645996e0a2defd7ac016",
            "patch": "@@ -27,7 +27,7 @@ use crate::{\n     next_edge::entry::wrap_edge_entry,\n     next_server_component::NextServerComponentTransition,\n     parse_segment_config_from_loader_tree,\n-    util::{NextRuntime, app_middleware_function_name, file_content_rope, load_next_js_template},\n+    util::{NextRuntime, app_function_name, file_content_rope, load_next_js_template},\n };\n \n /// Computes the entry for a Next.js app page.\n@@ -186,6 +186,6 @@ async fn wrap_edge_page(\n         asset_context,\n         project_root,\n         wrapped,\n-        app_middleware_function_name(&page).into(),\n+        app_function_name(&page).into(),\n     ))\n }"
        },
        {
            "sha": "965f6127345eb0871d085eb913dabc3aa34e9974",
            "filename": "crates/next-core/src/next_app/app_route_entry.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs?ref=40ad4fa548dc9ecc5d79645996e0a2defd7ac016",
            "patch": "@@ -16,7 +16,7 @@ use crate::{\n     next_config::{NextConfig, OutputType},\n     next_edge::entry::wrap_edge_entry,\n     parse_segment_config_from_source,\n-    util::{NextRuntime, app_middleware_function_name, load_next_js_template},\n+    util::{NextRuntime, app_function_name, load_next_js_template},\n };\n \n /// Computes the entry for a Next.js app route.\n@@ -162,6 +162,6 @@ async fn wrap_edge_route(\n         asset_context,\n         project_root.clone(),\n         wrapped,\n-        app_middleware_function_name(&page).into(),\n+        app_function_name(&page).into(),\n     ))\n }"
        },
        {
            "sha": "37803f0387e49172c8754b404bff953b6377025f",
            "filename": "crates/next-core/src/next_pages/page_entry.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs?ref=40ad4fa548dc9ecc5d79645996e0a2defd7ac016",
            "patch": "@@ -19,7 +19,7 @@ use crate::{\n     next_config::NextConfig,\n     next_edge::entry::wrap_edge_entry,\n     pages_structure::{PagesStructure, PagesStructureItem},\n-    util::{NextRuntime, file_content_rope, load_next_js_template, pages_middleware_function_name},\n+    util::{NextRuntime, file_content_rope, load_next_js_template, pages_function_name},\n };\n \n #[turbo_tasks::value]\n@@ -163,7 +163,7 @@ pub async fn create_page_ssr_entry_module(\n                 ssr_module_context,\n                 project_root,\n                 ssr_module,\n-                pages_middleware_function_name(&definition_page).into(),\n+                pages_function_name(&definition_page).into(),\n             );\n         }\n     }\n@@ -288,7 +288,7 @@ async fn wrap_edge_page(\n         asset_context,\n         project_root,\n         wrapped,\n-        pages_middleware_function_name(&page).into(),\n+        pages_function_name(&page).into(),\n     ))\n }\n "
        },
        {
            "sha": "c012684cb15b315287295cb758db04dc45f454a2",
            "filename": "crates/next-core/src/util.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Futil.rs?ref=40ad4fa548dc9ecc5d79645996e0a2defd7ac016",
            "patch": "@@ -197,10 +197,10 @@ pub async fn internal_assets_conditions() -> Result<ContextCondition> {\n     ]))\n }\n \n-pub fn app_middleware_function_name(page: impl Display) -> String {\n+pub fn app_function_name(page: impl Display) -> String {\n     format!(\"app{page}\")\n }\n-pub fn pages_middleware_function_name(page: impl Display) -> String {\n+pub fn pages_function_name(page: impl Display) -> String {\n     format!(\"pages{page}\")\n }\n "
        },
        {
            "sha": "b036c414fc53f3847553dd3532e3877f18ae238b",
            "filename": "test/integration/build-trace-extra-entries/app/next.config.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/test%2Fintegration%2Fbuild-trace-extra-entries%2Fapp%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/40ad4fa548dc9ecc5d79645996e0a2defd7ac016/test%2Fintegration%2Fbuild-trace-extra-entries%2Fapp%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fbuild-trace-extra-entries%2Fapp%2Fnext.config.js?ref=40ad4fa548dc9ecc5d79645996e0a2defd7ac016",
            "patch": "@@ -18,11 +18,13 @@ module.exports = {\n     return cfg\n   },\n   outputFileTracingIncludes: {\n-    '/index': ['include-me/**/*'],\n-    '/route1': ['./include-me/**/*', 'node_modules/pkg-behind-symlink/*'],\n+    // Full path includes \"app\" or \"pages\"\n+    '/pages/index': ['include-me/**/*'],\n+    '/app/route1': ['./include-me/**/*', 'node_modules/pkg-behind-symlink/*'],\n     '/*': ['include-me-global.txt'],\n   },\n   outputFileTracingExcludes: {\n+    // Subpaths should also work\n     '/index': ['public/exclude-me/**/*'],\n     '/route1': ['./public/exclude-me/**/*'],\n   },"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 22,
        "deletions": 24
    }
}