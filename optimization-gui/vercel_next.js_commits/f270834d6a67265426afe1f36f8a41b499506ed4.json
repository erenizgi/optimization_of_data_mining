{
    "author": "lubieowoce",
    "message": "[dynamicIO] fix: do not apply import tracking transform in edge (#79284)\n\nDynamic import tracking should never be applied to edge runtime code,\nbecause:\n1. `dynamicIO` prerendering is not supported for edge\n2. the implementation of `dynamicIO` prerendering relies on\nnode-specific APIs.\n\nI missed this in #74152. This PR fixes a couple things:\n- We no longer apply the dynamic import tracking to any edge modules\n- Just to be safe, `trackDynamicImport` and `new CacheSignal` will now\nthrow if it's called from the edge runtime\n- However, if `track-module-loading` does end up in an edge module, we\ndon't want to error at the top-level when creating\n`moduleLoadingSignal`, so it is now initialized lazily. This is a bit\nugly, but `AppRouteRouteModule` currently pulls all prerendering-related\ncode in at the top level (instead of e.g. a conditional `require()` when\nprerendering), so it *is* included in edge route handlers, even if\nunused.\n- this also required changing `__next_require__`/`__next_chunk_load__`\nto only track module loading in DIO prerenders, otherwise we'd attempt\nto create `moduleLoadingSignal` in edge RSC too\n\nI also fixed a potential unhandled rejection in `CacheSignal.trackRead`,\nbecause `.finally` rejects even if the original error was caught\nsomewhere else. (thanks for finding this one @gnoff!)",
    "sha": "f270834d6a67265426afe1f36f8a41b499506ed4",
    "files": [
        {
            "sha": "ffd720ff99cc8877ff7507f23e583d0d5fded8b9",
            "filename": "crates/next-core/src/next_server/transforms.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -178,7 +178,12 @@ pub async fn get_next_server_transforms_rules(\n         ServerContextType::Middleware { .. } | ServerContextType::Instrumentation { .. } => false,\n     };\n \n-    if is_app_dir && *next_config.enable_dynamic_io().await? {\n+    if is_app_dir &&\n+        // `dynamicIO` is not supported in the edge runtime.\n+        // (also, the code generated by the dynamic imports transform relies on `CacheSignal`, which uses nodejs-specific APIs)\n+        next_runtime != NextRuntime::Edge &&\n+        *next_config.enable_dynamic_io().await?\n+    {\n         rules.push(get_next_track_dynamic_imports_transform_rule(mdx_rs));\n     }\n "
        },
        {
            "sha": "177868cb7cc2ff2ad3162f6a9c14054e7ad18c3f",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -677,5 +677,7 @@\n   \"676\": \"Invariant: missing internal router-server-methods this is an internal bug\",\n   \"677\": \"`trackDynamicImport` should always receive a promise. Something went wrong in the dynamic imports transform.\",\n   \"678\": \"CacheSignal got more endRead() calls than beginRead() calls\",\n-  \"679\": \"A CacheSignal cannot subscribe to itself\"\n+  \"679\": \"A CacheSignal cannot subscribe to itself\",\n+  \"680\": \"CacheSignal cannot be used in the edge runtime, because `dynamicIO` does not support it.\",\n+  \"681\": \"Dynamic imports should not be instrumented in the edge runtime, because `dynamicIO` doesn't support it\"\n }"
        },
        {
            "sha": "fa7bccca482e57b92e60d366a2f382cfb935d44c",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -534,6 +534,7 @@ export default async function getBaseWebpackConfig(\n       loader: 'next-swc-loader',\n       options: {\n         isServer: isNodeOrEdgeCompilation,\n+        compilerType,\n         rootDir: dir,\n         pagesDir,\n         appDir,"
        },
        {
            "sha": "2ae8f673640287f8361e4d8ff47e3cea3b104742",
            "filename": "packages/next/src/build/webpack/loaders/next-swc-loader.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -39,6 +39,10 @@ import {\n   type SwcTransformTelemetryOutput,\n } from '../plugins/telemetry-plugin/update-telemetry-loader-context-from-swc'\n import type { LoaderContext } from 'webpack'\n+import {\n+  COMPILER_NAMES,\n+  type CompilerNameValues,\n+} from '../../../shared/lib/constants'\n \n const maybeExclude = (\n   excludePath: string,\n@@ -57,6 +61,7 @@ const maybeExclude = (\n export interface SWCLoaderOptions {\n   rootDir: string\n   isServer: boolean\n+  compilerType: CompilerNameValues\n   pagesDir?: string\n   appDir?: string\n   hasReactRefresh: boolean\n@@ -214,10 +219,12 @@ async function loaderTransform(\n function shouldTrackDynamicImports(loaderOptions: SWCLoaderOptions): boolean {\n   // we only need to track `import()` 1. in dynamicIO, 2. on the server (RSC and SSR)\n   // (Note: logic duplicated in crates/next-core/src/next_server/transforms.rs)\n-  const { nextConfig, isServer, bundleLayer } = loaderOptions\n+  const { nextConfig, bundleLayer, compilerType } = loaderOptions\n   return (\n     !!nextConfig.experimental?.dynamicIO &&\n-    isServer &&\n+    // NOTE: `server` means nodejs. `dynamicIO` is not supported in the edge runtime, so we want to exclude it.\n+    // (also, the code generated by the dynamic imports transform relies on `CacheSignal`, which uses nodejs-specific APIs)\n+    compilerType === COMPILER_NAMES.server &&\n     (bundleLayer === WEBPACK_LAYERS.reactServerComponents ||\n       bundleLayer === WEBPACK_LAYERS.serverSideRendering)\n   )"
        },
        {
            "sha": "238f3175b3f8558bfd5dcc6d57d5d38f363ff15b",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -1203,18 +1203,33 @@ async function renderToHTMLOrFlightImpl(\n     // to treat chunk/module loading with similar semantics as cache reads to avoid\n     // module loading from causing a prerender to abort too early.\n \n+    const shouldTrackModuleLoading = () => {\n+      if (!renderOpts.experimental.dynamicIO) {\n+        return false\n+      }\n+      const workUnitStore = workUnitAsyncStorage.getStore()\n+      return !!(\n+        workUnitStore &&\n+        (workUnitStore.type === 'prerender' || workUnitStore.type === 'cache')\n+      )\n+    }\n+\n     const __next_require__: typeof instrumented.require = (...args) => {\n       const exportsOrPromise = instrumented.require(...args)\n-      // requiring an async module returns a promise.\n-      trackPendingImport(exportsOrPromise)\n+      if (shouldTrackModuleLoading()) {\n+        // requiring an async module returns a promise.\n+        trackPendingImport(exportsOrPromise)\n+      }\n       return exportsOrPromise\n     }\n     // @ts-expect-error\n     globalThis.__next_require__ = __next_require__\n \n     const __next_chunk_load__: typeof instrumented.loadChunk = (...args) => {\n       const loadingChunk = instrumented.loadChunk(...args)\n-      trackPendingChunkLoad(loadingChunk)\n+      if (shouldTrackModuleLoading()) {\n+        trackPendingChunkLoad(loadingChunk)\n+      }\n       return loadingChunk\n     }\n     // @ts-expect-error"
        },
        {
            "sha": "2b2978e5e5641f425be871471e8f3f0bca87ddb4",
            "filename": "packages/next/src/server/app-render/cache-signal.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcache-signal.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcache-signal.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcache-signal.ts?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -16,6 +16,15 @@ export class CacheSignal {\n \n   private subscribedSignals: Set<CacheSignal> | null = null\n \n+  constructor() {\n+    if (process.env.NEXT_RUNTIME === 'edge') {\n+      // we rely on `process.nextTick`, which is not supported in edge\n+      throw new InvariantError(\n+        'CacheSignal cannot be used in the edge runtime, because `dynamicIO` does not support it.'\n+      )\n+    }\n+  }\n+\n   private noMorePendingCaches() {\n     if (!this.tickPending) {\n       this.tickPending = true\n@@ -107,7 +116,9 @@ export class CacheSignal {\n \n   trackRead<T>(promise: Promise<T>) {\n     this.beginRead()\n-    promise.finally(this.endRead.bind(this))\n+    // `promise.finally()` still rejects, so don't use it here to avoid unhandled rejections\n+    const onFinally = this.endRead.bind(this)\n+    promise.then(onFinally, onFinally)\n     return promise\n   }\n "
        },
        {
            "sha": "0afd07840d02452dbb0ec6122d855418e82ab26c",
            "filename": "packages/next/src/server/app-render/module-loading/track-dynamic-import.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-dynamic-import.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-dynamic-import.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-dynamic-import.ts?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -12,6 +12,12 @@ import { trackPendingImport } from './track-module-loading.external'\n export function trackDynamicImport<TExports extends Record<string, any>>(\n   modulePromise: Promise<TExports>\n ): Promise<TExports> {\n+  if (process.env.NEXT_RUNTIME === 'edge') {\n+    throw new InvariantError(\n+      \"Dynamic imports should not be instrumented in the edge runtime, because `dynamicIO` doesn't support it\"\n+    )\n+  }\n+\n   if (!isThenable(modulePromise)) {\n     // We're expecting `import()` to always return a promise. If it's not, something's very wrong.\n     throw new InvariantError("
        },
        {
            "sha": "420c6e8e5deadfbf02ccb481dd3a714e71282038",
            "filename": "packages/next/src/server/app-render/module-loading/track-module-loading.instance.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-module-loading.instance.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-module-loading.instance.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-module-loading.instance.ts?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -1,14 +1,26 @@\n import { CacheSignal } from '../cache-signal'\n import { isThenable } from '../../../shared/lib/is-thenable'\n \n-/** Tracks all in-flight async imports and chunk loads. */\n-const moduleLoadingSignal = new CacheSignal()\n+/**\n+ * Tracks all in-flight async imports and chunk loads.\n+ * Initialized lazily, because we don't want this to error in case it gets pulled into an edge runtime module.\n+ */\n+let _moduleLoadingSignal: CacheSignal | null\n+function getModuleLoadingSignal() {\n+  if (!_moduleLoadingSignal) {\n+    _moduleLoadingSignal = new CacheSignal()\n+  }\n+  return _moduleLoadingSignal\n+}\n \n export function trackPendingChunkLoad(promise: Promise<unknown>) {\n+  const moduleLoadingSignal = getModuleLoadingSignal()\n   moduleLoadingSignal.trackRead(promise)\n }\n \n export function trackPendingImport(exportsOrPromise: unknown) {\n+  const moduleLoadingSignal = getModuleLoadingSignal()\n+\n   // requiring an async module returns a promise.\n   // if it's sync, there's nothing to track.\n   if (isThenable(exportsOrPromise)) {\n@@ -28,6 +40,8 @@ export function trackPendingImport(exportsOrPromise: unknown) {\n  * So if we see one, we want to extend the duration of `cacheSignal` at least until the import/chunk-load is done.\n  */\n export function trackPendingModules(cacheSignal: CacheSignal): void {\n+  const moduleLoadingSignal = getModuleLoadingSignal()\n+\n   // We can't just use `cacheSignal.trackRead(moduleLoadingSignal.cacheReady())`,\n   // because we might start and finish multiple batches of module loads while waiting for caches,\n   // and `moduleLoadingSignal.cacheReady()` would resolve after the first batch."
        },
        {
            "sha": "b1e71f1b5ee5dbefc83c2bfe0d5bc57488eee88b",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/not-instrumented/edge-route-handler/messages.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Fmessages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Fmessages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Fmessages.ts?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -0,0 +1 @@\n+export default { title: 'hello' }"
        },
        {
            "sha": "c7ca93ac75f4448d9ac28c3e74d02fe06734aee6",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/not-instrumented/edge-route-handler/route.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Froute.ts?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -0,0 +1,9 @@\n+export const runtime = 'edge'\n+\n+export async function GET(_request: Request) {\n+  // This import should not be instrumented, because edge routes are never prerendered.\n+  // `trackDynamicImport` will throw if it's used in the edge runtime,\n+  // so it's enough to just do an import() here and see if it succeeds.\n+  const messages = (await import('./messages')).default\n+  return new Response(messages.title)\n+}"
        },
        {
            "sha": "307f87a634a399352cbe74aea60c414e19c73507",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/not-instrumented/middleware/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fmiddleware%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fmiddleware%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fmiddleware%2Fpage.tsx?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -0,0 +1,5 @@\n+// This page is only used as a matcher target for the middleware.\n+\n+export default function Page() {\n+  return 'hello'\n+}"
        },
        {
            "sha": "b1e71f1b5ee5dbefc83c2bfe0d5bc57488eee88b",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/messages.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fmessages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fmessages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fmessages.ts?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -0,0 +1 @@\n+export default { title: 'hello' }"
        },
        {
            "sha": "1f75f25fcdb2e1f7881b75f25d145599cd8bd899",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/middleware.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fmiddleware.ts?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -0,0 +1,12 @@\n+import type { MiddlewareConfig } from 'next/server'\n+\n+export default async function middleware() {\n+  // This import should not be instrumented.\n+  // `trackDynamicImport` will throw if it's used in the edge runtime,\n+  // so it's enough to just do an import() here and see if it succeeds.\n+  await import('./messages')\n+}\n+\n+export const config: MiddlewareConfig = {\n+  matcher: ['/not-instrumented/middleware'],\n+}"
        },
        {
            "sha": "938c2db8ab2ee3b0aeab3893c1b90b4b90345add",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/dynamic-io-dynamic-imports.test.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fdynamic-io-dynamic-imports.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f270834d6a67265426afe1f36f8a41b499506ed4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fdynamic-io-dynamic-imports.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fdynamic-io-dynamic-imports.test.ts?ref=f270834d6a67265426afe1f36f8a41b499506ed4",
            "patch": "@@ -50,6 +50,7 @@ describe('async imports in dynamicIO', () => {\n          \"/inside-render/server/from-node-modules/esm/async-module\",\n          \"/inside-render/server/from-node-modules/esm/sync-module\",\n          \"/inside-render/server/sync-module\",\n+         \"/not-instrumented/middleware\",\n          \"/outside-of-render/client/async-module\",\n          \"/outside-of-render/client/sync-module\",\n          \"/outside-of-render/server/async-module\",\n@@ -154,6 +155,20 @@ describe('async imports in dynamicIO', () => {\n       })\n     })\n   })\n+\n+  describe('are not instrumented in edge', () => {\n+    it('middleware', async () => {\n+      // indirectly tests the behavior of middleware by rendering a page which the middleware matches\n+      await testPage('/not-instrumented/middleware')\n+    })\n+\n+    it('edge route handler', async () => {\n+      const result = await next\n+        .fetch('/not-instrumented/edge-route-handler')\n+        .then((res) => res.text())\n+      expect(result).toBe('hello')\n+    })\n+  })\n })\n \n describe('async imports in dynamicIO - external packages', () => {"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 114,
        "deletions": 10
    }
}