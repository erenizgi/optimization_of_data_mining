{
    "author": "RobPruzan",
    "message": "wrap devtools stories in context providers (#82345)\n\nWraps stories in context providers, and replaces any old arguments that\nwere being passed before the props -> context refactor in devtools\n\nCloses NEXT-4642",
    "sha": "65950f7fed1d4f43eb731b7bc8e9a20b32208ff5",
    "files": [
        {
            "sha": "e4bf3154605ad12e3e6cdc05749f6dbce2c29244",
            "filename": "packages/next/.storybook/preview.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/65950f7fed1d4f43eb731b7bc8e9a20b32208ff5/packages%2Fnext%2F.storybook%2Fpreview.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/65950f7fed1d4f43eb731b7bc8e9a20b32208ff5/packages%2Fnext%2F.storybook%2Fpreview.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2F.storybook%2Fpreview.tsx?ref=65950f7fed1d4f43eb731b7bc8e9a20b32208ff5",
            "patch": "@@ -1,5 +1,6 @@\n import type { Preview } from '@storybook/react'\n import { useInsertionEffect } from 'react'\n+import { withDevOverlayContexts } from '../src/next-devtools/dev-overlay/storybook/with-dev-overlay-contexts'\n \n function CreatePortalNode() {\n   useInsertionEffect(() => {\n@@ -63,6 +64,7 @@ const preview: Preview = {\n     },\n   },\n   decorators: [\n+    withDevOverlayContexts(),\n     (Story) => (\n       <>\n         <CreatePortalNode />"
        },
        {
            "sha": "5215bcb56d9ad765820c5c084c68138a2bf4cbe6",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/devtools-indicator/devtools-indicator.stories.tsx",
            "status": "modified",
            "additions": 18,
            "deletions": 22,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/65950f7fed1d4f43eb731b7bc8e9a20b32208ff5/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fdevtools-indicator.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/65950f7fed1d4f43eb731b7bc8e9a20b32208ff5/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fdevtools-indicator.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fdevtools-indicator.stories.tsx?ref=65950f7fed1d4f43eb731b7bc8e9a20b32208ff5",
            "patch": "@@ -1,9 +1,9 @@\n import type { Meta, StoryObj } from '@storybook/react'\n-import type { OverlayState } from '../../shared'\n \n import { DevToolsIndicator } from './devtools-indicator'\n-import { INITIAL_OVERLAY_STATE } from '../../shared'\n import { withShadowPortal } from '../../storybook/with-shadow-portal'\n+import { withDevOverlayContexts } from '../../storybook/with-dev-overlay-contexts'\n+import { INITIAL_OVERLAY_STATE, type OverlayState } from '../../shared'\n \n const meta: Meta<typeof DevToolsIndicator> = {\n   component: DevToolsIndicator,\n@@ -35,35 +35,31 @@ const meta: Meta<typeof DevToolsIndicator> = {\n     ),\n   ],\n }\n-\n-export default meta\n-type Story = StoryObj<typeof DevToolsIndicator>\n-\n const state: OverlayState = {\n   ...INITIAL_OVERLAY_STATE,\n   routerType: 'app',\n   isErrorOverlayOpen: false,\n }\n \n-export const Default: Story = {\n-  args: {\n-    state,\n-    dispatch: () => {},\n-  },\n-}\n+export default meta\n+type Story = StoryObj<typeof DevToolsIndicator>\n+\n+export const Default: Story = {}\n \n export const SingleError: Story = {\n-  args: {\n-    errorCount: 1,\n-    state,\n-    dispatch: () => {},\n-  },\n+  decorators: [\n+    withDevOverlayContexts({\n+      state,\n+      totalErrorCount: 1,\n+    }),\n+  ],\n }\n \n export const MultipleErrors: Story = {\n-  args: {\n-    errorCount: 3,\n-    state,\n-    dispatch: () => {},\n-  },\n+  decorators: [\n+    withDevOverlayContexts({\n+      state,\n+      totalErrorCount: 3,\n+    }),\n+  ],\n }"
        },
        {
            "sha": "a7be1b4fa10323667cdeadae49490e4934108d98",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/devtools-indicator/next-logo.stories.tsx",
            "status": "modified",
            "additions": 76,
            "deletions": 53,
            "changes": 129,
            "blob_url": "https://github.com/vercel/next.js/blob/65950f7fed1d4f43eb731b7bc8e9a20b32208ff5/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fnext-logo.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/65950f7fed1d4f43eb731b7bc8e9a20b32208ff5/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fnext-logo.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fnext-logo.stories.tsx?ref=65950f7fed1d4f43eb731b7bc8e9a20b32208ff5",
            "patch": "@@ -1,19 +1,10 @@\n import type { Meta, StoryObj } from '@storybook/react'\n import { NextLogo } from './next-logo'\n import { withShadowPortal } from '../../storybook/with-shadow-portal'\n-// TODO: NEXT-4642\n-const StoryBookNextLogo = (\n-  _: {\n-    issueCount: number\n-    isDevBuilding: boolean\n-    isDevRendering: boolean\n-  } & Record<string, unknown>\n-) => {\n-  return <NextLogo onTriggerClick={() => {}} />\n-}\n+import { withDevOverlayContexts } from '../../storybook/with-dev-overlay-contexts'\n \n-const meta: Meta<typeof StoryBookNextLogo> = {\n-  component: StoryBookNextLogo,\n+const meta: Meta<typeof NextLogo> = {\n+  component: NextLogo,\n   parameters: {\n     layout: 'centered',\n   },\n@@ -24,68 +15,100 @@ const meta: Meta<typeof StoryBookNextLogo> = {\n }\n \n export default meta\n-type Story = StoryObj<typeof StoryBookNextLogo>\n+type Story = StoryObj<typeof NextLogo>\n \n export const NoIssues: Story = {\n-  args: {\n-    issueCount: 0,\n-    isDevBuilding: false,\n-    isDevRendering: false,\n-  },\n+  decorators: [\n+    withDevOverlayContexts({\n+      totalErrorCount: 0,\n+      state: {\n+        buildingIndicator: false,\n+        renderingIndicator: false,\n+      },\n+    }),\n+  ],\n }\n \n export const SingleIssue: Story = {\n-  args: {\n-    issueCount: 1,\n-    isDevBuilding: false,\n-    isDevRendering: false,\n-  },\n+  decorators: [\n+    withDevOverlayContexts({\n+      totalErrorCount: 1,\n+      state: {\n+        buildingIndicator: false,\n+        renderingIndicator: false,\n+      },\n+    }),\n+  ],\n }\n \n export const MultipleIssues: Story = {\n-  args: {\n-    issueCount: 5,\n-    isDevBuilding: false,\n-    isDevRendering: false,\n-  },\n+  decorators: [\n+    withDevOverlayContexts({\n+      totalErrorCount: 5,\n+      state: {\n+        buildingIndicator: false,\n+        renderingIndicator: false,\n+      },\n+    }),\n+  ],\n }\n \n export const ManyIssues: Story = {\n-  args: {\n-    issueCount: 99,\n-    isDevBuilding: false,\n-    isDevRendering: false,\n-  },\n+  decorators: [\n+    withDevOverlayContexts({\n+      totalErrorCount: 99,\n+      state: {\n+        buildingIndicator: false,\n+        renderingIndicator: false,\n+      },\n+    }),\n+  ],\n }\n \n export const Building: Story = {\n-  args: {\n-    issueCount: 0,\n-    isDevBuilding: true,\n-    isDevRendering: false,\n-  },\n+  decorators: [\n+    withDevOverlayContexts({\n+      totalErrorCount: 0,\n+      state: {\n+        buildingIndicator: true,\n+        renderingIndicator: false,\n+      },\n+    }),\n+  ],\n }\n \n export const BuildingWithError: Story = {\n-  args: {\n-    issueCount: 1,\n-    isDevBuilding: true,\n-    isDevRendering: false,\n-  },\n+  decorators: [\n+    withDevOverlayContexts({\n+      totalErrorCount: 1,\n+      state: {\n+        buildingIndicator: true,\n+        renderingIndicator: false,\n+      },\n+    }),\n+  ],\n }\n \n export const Rendering: Story = {\n-  args: {\n-    issueCount: 0,\n-    isDevBuilding: false,\n-    isDevRendering: true,\n-  },\n+  decorators: [\n+    withDevOverlayContexts({\n+      totalErrorCount: 0,\n+      state: {\n+        buildingIndicator: false,\n+        renderingIndicator: true,\n+      },\n+    }),\n+  ],\n }\n \n export const RenderingWithError: Story = {\n-  args: {\n-    issueCount: 1,\n-    isDevBuilding: false,\n-    isDevRendering: true,\n-  },\n+  decorators: [\n+    withDevOverlayContexts({\n+      totalErrorCount: 1,\n+      state: {\n+        buildingIndicator: false,\n+        renderingIndicator: true,\n+      },\n+    }),\n+  ],\n }"
        },
        {
            "sha": "0150214397e3ed9304353bccb41d2585d9f0b08f",
            "filename": "packages/next/src/next-devtools/dev-overlay/storybook/with-dev-overlay-contexts.tsx",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/vercel/next.js/blob/65950f7fed1d4f43eb731b7bc8e9a20b32208ff5/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstorybook%2Fwith-dev-overlay-contexts.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/65950f7fed1d4f43eb731b7bc8e9a20b32208ff5/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstorybook%2Fwith-dev-overlay-contexts.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstorybook%2Fwith-dev-overlay-contexts.tsx?ref=65950f7fed1d4f43eb731b7bc8e9a20b32208ff5",
            "patch": "@@ -0,0 +1,67 @@\n+import { useRef, useState, type Dispatch, type SetStateAction } from 'react'\n+import { DevOverlayContext } from '../../dev-overlay.browser'\n+import { RenderErrorContext } from '../dev-overlay'\n+import { PanelRouterContext, type PanelStateKind } from '../menu/context'\n+import { INITIAL_OVERLAY_STATE } from '../shared'\n+import type { OverlayState, DispatcherEvent } from '../shared'\n+import type { ReadyRuntimeError } from '../utils/get-error-by-type'\n+\n+interface WithDevOverlayContextsProps {\n+  state?: Partial<OverlayState>\n+  dispatch?: (action: DispatcherEvent) => void\n+  runtimeErrors?: ReadyRuntimeError[]\n+  totalErrorCount?: number\n+  panel?: PanelStateKind | null\n+  setPanel?: Dispatch<SetStateAction<PanelStateKind | null>>\n+  selectedIndex?: number\n+  setSelectedIndex?: Dispatch<SetStateAction<number>>\n+}\n+\n+export const withDevOverlayContexts =\n+  (props?: WithDevOverlayContextsProps) => (Story: any) => {\n+    const [panel, setPanel] = useState<PanelStateKind | null>(\n+      props?.panel ?? null\n+    )\n+    const [selectedIndex, setSelectedIndex] = useState(\n+      props?.selectedIndex ?? -1\n+    )\n+    const triggerRef = useRef<HTMLButtonElement>(null)\n+\n+    const defaultState: OverlayState = {\n+      ...INITIAL_OVERLAY_STATE,\n+      routerType: 'app',\n+      isErrorOverlayOpen: false,\n+      ...props?.state,\n+    }\n+\n+    const defaultDispatch = props?.dispatch || (() => {})\n+\n+    return (\n+      <DevOverlayContext.Provider\n+        value={{\n+          state: defaultState,\n+          dispatch: defaultDispatch,\n+          getSquashedHydrationErrorDetails: () => null,\n+        }}\n+      >\n+        <RenderErrorContext.Provider\n+          value={{\n+            runtimeErrors: props?.runtimeErrors ?? [],\n+            totalErrorCount: props?.totalErrorCount ?? 0,\n+          }}\n+        >\n+          <PanelRouterContext.Provider\n+            value={{\n+              panel,\n+              setPanel: props?.setPanel ?? setPanel,\n+              triggerRef,\n+              selectedIndex,\n+              setSelectedIndex: props?.setSelectedIndex ?? setSelectedIndex,\n+            }}\n+          >\n+            <Story />\n+          </PanelRouterContext.Provider>\n+        </RenderErrorContext.Provider>\n+      </DevOverlayContext.Provider>\n+    )\n+  }"
        },
        {
            "sha": "fb7be204efb35220a1ad762a3c9674d1194eb1d7",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 7,
            "deletions": 22,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/65950f7fed1d4f43eb731b7bc8e9a20b32208ff5/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/65950f7fed1d4f43eb731b7bc8e9a20b32208ff5/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=65950f7fed1d4f43eb731b7bc8e9a20b32208ff5",
            "patch": "@@ -3461,12 +3461,6 @@ packages:\n     peerDependencies:\n       eslint: ^6.0.0 || ^7.0.0 || >=8.0.0\n \n-  '@eslint-community/eslint-utils@4.5.1':\n-    resolution: {integrity: sha512-soEIOALTfTK6EjmKMMoLugwaP0rzkad90iIWd1hMO9ARkSAyjfMfkRRhLvD5qH7vvM0Cg72pieUfR6yh6XxC4w==}\n-    engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}\n-    peerDependencies:\n-      eslint: ^6.0.0 || ^7.0.0 || >=8.0.0\n-\n   '@eslint-community/eslint-utils@4.7.0':\n     resolution: {integrity: sha512-dyybb3AcajC7uha6CvhdVRJqaKyn7w2YKqKyAN37NKYgZT36w+iRb0Dymmc5qEJ549c/S31cMMSFd75bteCpCw==}\n     engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}\n@@ -8946,10 +8940,6 @@ packages:\n     resolution: {integrity: sha512-wpc+LXeiyiisxPlEkUzU6svyS1frIO3Mgxj1fdy7Pm8Ygzguax2N3Fa/D/ag1WqbOprdI+uY6wMUl8/a2G+iag==}\n     engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}\n \n-  eslint-visitor-keys@4.2.0:\n-    resolution: {integrity: sha512-UyLnSehNt62FFhSwjZlHmeokpRK59rcz29j+F1/aDgbkbRTk7wIc9XzdoasMUbRNKDM0qQt/+BJ4BrpFeABemw==}\n-    engines: {node: ^18.18.0 || ^20.9.0 || >=21.1.0}\n-\n   eslint-visitor-keys@4.2.1:\n     resolution: {integrity: sha512-Uhdk5sfqcee/9H/rCOJikYz67o0a2Tw2hGRPOG2Y1R2dg7brRe1uG0yaNQDHu+TO/uQPF/5eCapvYSmHUjt7JQ==}\n     engines: {node: ^18.18.0 || ^20.9.0 || >=21.1.0}\n@@ -14014,6 +14004,7 @@ packages:\n     engines: {node: '>=0.6.0', teleport: '>=0.2.0'}\n     deprecated: |-\n       You or someone you depend on is using Q, the JavaScript Promise library that gave JavaScript developers strong feelings about promises. They can almost certainly migrate to the native JavaScript promise now. Thank you literally everyone for joining me in this bet against the odds. Be excellent to each other.\n+\n       (For a CapTP with native promises, see @endo/eventual-send and @endo/captp)\n \n   qs@6.11.0:\n@@ -15126,6 +15117,7 @@ packages:\n   source-map@0.8.0-beta.0:\n     resolution: {integrity: sha512-2ymg6oRBpebeZi9UUNsgQ89bhx01TcTkmNTGnNO88imTmbSgy4nfujrgVEFKWpMTEGA11EDkTt7mqObTPdigIA==}\n     engines: {node: '>= 8'}\n+    deprecated: The work that was done in this beta branch won't be included in future versions\n \n   sourcemap-codec@1.4.8:\n     resolution: {integrity: sha512-9NykojV5Uih4lgo5So5dtw+f0JgJX30KCNI8gwhz2J9A15wD0Ml6tjHKwf6fTSa6fAdVBdZeNOs9eJ71qCk8vA==}\n@@ -15490,7 +15482,7 @@ packages:\n   superagent@3.8.3:\n     resolution: {integrity: sha512-GLQtLMCoEIK4eDv6OGtkOoSMt3D+oq0y3dsxMuYuDvaNUvuT8eFBuLmfR0iYYzHC1e8hpzC6ZsxbuP6DIalMFA==}\n     engines: {node: '>= 4.0'}\n-    deprecated: Please upgrade to v9.0.0+ as we have fixed a public vulnerability with formidable dependency. Note that v9.0.0+ requires Node.js v14.18.0+. See https://github.com/ladjs/superagent/pull/1800 for insight. This project is supported and maintained by the team at Forward Email @ https://forwardemail.net\n+    deprecated: Please upgrade to superagent v10.2.2+, see release notes at https://github.com/forwardemail/superagent/releases/tag/v10.2.2 - maintenance is supported by Forward Email @ https://forwardemail.net\n \n   superstruct@1.0.3:\n     resolution: {integrity: sha512-8iTn3oSS8nRGn+C2pgXSKPI3jmpm6FExNazNpjvqS6ZUJQCej3PUXEKM8NjHBOs54ExM+LPW/FBRhymrdcCiSg==}\n@@ -18704,11 +18696,6 @@ snapshots:\n       eslint: 9.12.0\n       eslint-visitor-keys: 3.4.3\n \n-  '@eslint-community/eslint-utils@4.5.1(eslint@9.12.0)':\n-    dependencies:\n-      eslint: 9.12.0\n-      eslint-visitor-keys: 3.4.3\n-\n   '@eslint-community/eslint-utils@4.7.0(eslint@9.12.0)':\n     dependencies:\n       eslint: 9.12.0\n@@ -22923,7 +22910,7 @@ snapshots:\n     dependencies:\n       '@babel/runtime': 7.27.0\n       cosmiconfig: 7.1.0\n-      resolve: 1.22.8\n+      resolve: 1.22.10\n \n   babel-plugin-polyfill-corejs2@0.4.13(@babel/core@7.26.10):\n     dependencies:\n@@ -25751,8 +25738,6 @@ snapshots:\n \n   eslint-visitor-keys@3.4.3: {}\n \n-  eslint-visitor-keys@4.2.0: {}\n-\n   eslint-visitor-keys@4.2.1: {}\n \n   eslint@7.32.0:\n@@ -25888,7 +25873,7 @@ snapshots:\n \n   eslint@9.12.0:\n     dependencies:\n-      '@eslint-community/eslint-utils': 4.5.1(eslint@9.12.0)\n+      '@eslint-community/eslint-utils': 4.7.0(eslint@9.12.0)\n       '@eslint-community/regexpp': 4.11.1\n       '@eslint/config-array': 0.18.0\n       '@eslint/core': 0.6.0\n@@ -25906,7 +25891,7 @@ snapshots:\n       debug: 4.4.0\n       escape-string-regexp: 4.0.0\n       eslint-scope: 8.1.0\n-      eslint-visitor-keys: 4.2.0\n+      eslint-visitor-keys: 4.2.1\n       espree: 10.2.0\n       esquery: 1.6.0\n       esutils: 2.0.3\n@@ -25930,7 +25915,7 @@ snapshots:\n     dependencies:\n       acorn: 8.14.0\n       acorn-jsx: 5.3.2(acorn@8.14.0)\n-      eslint-visitor-keys: 4.2.0\n+      eslint-visitor-keys: 4.2.1\n \n   espree@7.3.1:\n     dependencies:"
        }
    ],
    "stats": {
        "total": 267,
        "additions": 170,
        "deletions": 97
    }
}