{
    "author": "ztanner",
    "message": "[devtools]: move RestartServerButton to panel footer (#81082)\n\nThis moves the restart button to the footer in the new panel UI. It also\nproperly gates to only be enabled with Turbopack + Persistent Cache.\n\nBecause it's no longer part of the error overlay, I refactored the logic\na bit to hoist the flag into overlay state and setup the beforeunload\nlistener from within the error renderer.\n\nThis heuristic still feels a bit unreliable and I'm not entirely\nconvinced how useful it is yet, but the goal with this PR is just to get\nit to render in the right spot for now.\n\n![CleanShot 2025-06-30 at 10 24\n12@2x](https://github.com/user-attachments/assets/7c96b7ad-0b90-4a08-9b9d-5bea02348ab8)\n\nCloses NEXT-4561",
    "sha": "824f853747a63702526803aea373895a8177ed7e",
    "files": [
        {
            "sha": "2fc12342ba7d39496629a93ae35a174e793fa131",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/devtools-panel/devtools-panel-footer.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel-footer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel-footer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel-footer.tsx?ref=824f853747a63702526803aea373895a8177ed7e",
            "patch": "@@ -2,13 +2,16 @@ import type { OverlayState } from '../../shared'\n \n import { DevToolsPanelVersionInfo } from './devtools-panel-version-info'\n import { css } from '../../utils/css'\n+import { RestartServerButton } from '../errors/error-overlay-toolbar/restart-server-button'\n \n export function DevToolsPanelFooter({\n   versionInfo,\n   isDraggable,\n+  showRestartServerButton,\n }: {\n   versionInfo: OverlayState['versionInfo']\n   isDraggable: boolean\n+  showRestartServerButton: boolean\n }) {\n   const bundlerName = (\n     process.env.__NEXT_BUNDLER || 'WEBPACK'\n@@ -32,6 +35,11 @@ export function DevToolsPanelFooter({\n           </span>\n         </div>\n       </div>\n+      {showRestartServerButton && (\n+        <div data-nextjs-devtools-panel-footer-tab-group>\n+          <RestartServerButton showButton={true} />\n+        </div>\n+      )}\n     </div>\n   )\n }"
        },
        {
            "sha": "2f9f0ae03346194f416852904c726303e65b65a8",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/devtools-panel/devtools-panel.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel.tsx?ref=824f853747a63702526803aea373895a8177ed7e",
            "patch": "@@ -231,6 +231,7 @@ export function DevToolsPanel({\n             <DevToolsPanelFooter\n               versionInfo={state.versionInfo}\n               isDraggable={!isFullscreen}\n+              showRestartServerButton={state.showRestartServerButton}\n             />\n           </Dialog>\n         </>"
        },
        {
            "sha": "810524114991a4b158a8d7ecae1b26db7eff0fd9",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/dev-tools-indicator.stories.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.stories.tsx?ref=824f853747a63702526803aea373895a8177ed7e",
            "patch": "@@ -61,6 +61,7 @@ const state: OverlayState = {\n   isErrorOverlayOpen: false,\n   // TODO: This will be handled on the next stack——with proper story.\n   isDevToolsPanelOpen: false,\n+  showRestartServerButton: false,\n   devToolsPosition: 'bottom-left',\n   scale: 1,\n   page: '',"
        },
        {
            "sha": "7ba6a0576439647d23fd1c7fb80c720cd69255a7",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/error-overlay-toolbar.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx?ref=824f853747a63702526803aea373895a8177ed7e",
            "patch": "@@ -2,7 +2,6 @@ import type { DebugInfo } from '../../../../shared/types'\n import { NodejsInspectorButton } from './nodejs-inspector-button'\n import { CopyStackTraceButton } from './copy-stack-trace-button'\n import { DocsLinkButton } from './docs-link-button'\n-import { RestartServerButton } from './restart-server-button'\n \n type ErrorOverlayToolbarProps = {\n   error: Error\n@@ -19,9 +18,6 @@ export function ErrorOverlayToolbar({\n     <span className=\"error-overlay-toolbar\">\n       {/* TODO: Move the button inside and remove the feedback on the footer of the error overlay.  */}\n       {feedbackButton}\n-      {process.env.__NEXT_BUNDLER_HAS_PERSISTENT_CACHE && (\n-        <RestartServerButton error={error} />\n-      )}\n       <CopyStackTraceButton error={error} />\n       <DocsLinkButton errorMessage={error.message} />\n       <NodejsInspectorButton"
        },
        {
            "sha": "8ac33ecc43a986c04b89a52fc5834b2172a94287",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/restart-server-button.tsx",
            "status": "modified",
            "additions": 52,
            "deletions": 19,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx?ref=824f853747a63702526803aea373895a8177ed7e",
            "patch": "@@ -1,5 +1,10 @@\n-import { useState, useEffect } from 'react'\n+import { useEffect } from 'react'\n import { RefreshClockWise } from '../../../icons/refresh-clock-wise'\n+import {\n+  ACTION_RESTART_SERVER_BUTTON,\n+  type OverlayDispatch,\n+} from '../../../shared'\n+import type { SupportedErrorEvent } from '../../../container/runtime-error/render-error'\n \n /**\n  * When the Turbopack persistent cache is enabled, and the user reloads on a\n@@ -8,24 +13,7 @@ import { RefreshClockWise } from '../../../icons/refresh-clock-wise'\n  * bundler cache, but we want to provide a shortcut to do this and collect\n  * telemetry on how often this is used.\n  */\n-export function RestartServerButton({ error }: { error: Error }) {\n-  const [showButton, setShowButton] = useState(false)\n-\n-  useEffect(() => {\n-    const ERROR_KEY = `__next_error_overlay:${window.location.pathname}:${error.message}`\n-\n-    setShowButton(sessionStorage.getItem(ERROR_KEY) === '1')\n-\n-    // When the user tries to reload, set the error key to the session storage.\n-    const handleBeforeUnload = () => {\n-      sessionStorage.setItem(ERROR_KEY, '1')\n-    }\n-    window.addEventListener('beforeunload', handleBeforeUnload)\n-    return () => {\n-      window.removeEventListener('beforeunload', handleBeforeUnload)\n-    }\n-  }, [error.message])\n-\n+export function RestartServerButton({ showButton }: { showButton: boolean }) {\n   if (!showButton) {\n     return null\n   }\n@@ -52,13 +40,58 @@ export function RestartServerButton({ error }: { error: Error }) {\n   )\n }\n \n+/**\n+ * Sets up a beforeunload listener to show the restart server button\n+ * if the developer reloads on a specific error and that error persists with Turbopack + Persistent Cache.\n+ */\n+export function usePersistentCacheErrorDetection({\n+  errors,\n+  dispatch,\n+}: {\n+  errors: SupportedErrorEvent[]\n+  dispatch: OverlayDispatch\n+}) {\n+  useEffect(() => {\n+    const isTurbopackWithCache =\n+      process.env.__NEXT_BUNDLER?.toUpperCase() === 'TURBOPACK' &&\n+      process.env.__NEXT_BUNDLER_HAS_PERSISTENT_CACHE\n+    // TODO: Is there a better heuristic here?\n+    const firstError = errors[0]?.error\n+\n+    if (isTurbopackWithCache && firstError) {\n+      const errorKey = `__next_error_overlay:${window.location.pathname}:${firstError.message}`\n+      const showRestartServerButton = sessionStorage.getItem(errorKey) === '1'\n+\n+      dispatch({\n+        type: ACTION_RESTART_SERVER_BUTTON,\n+        showRestartServerButton,\n+      })\n+\n+      const handleBeforeUnload = () => {\n+        sessionStorage.setItem(errorKey, '1')\n+      }\n+\n+      window.addEventListener('beforeunload', handleBeforeUnload)\n+      return () => {\n+        window.removeEventListener('beforeunload', handleBeforeUnload)\n+      }\n+    } else {\n+      dispatch({\n+        type: ACTION_RESTART_SERVER_BUTTON,\n+        showRestartServerButton: false,\n+      })\n+    }\n+  }, [errors, dispatch])\n+}\n+\n export const RESTART_SERVER_BUTTON_STYLES = `\n   .restart-dev-server-button {\n     -webkit-font-smoothing: antialiased;\n     display: flex;\n     justify-content: center;\n     align-items: center;\n     gap: 4px;\n+    margin: 0 12px;\n \n     height: var(--size-26);\n     padding: 6px 8px 6px 6px;"
        },
        {
            "sha": "39717aeb4cc31a0439be2702b6600f957184eeb8",
            "filename": "packages/next/src/next-devtools/dev-overlay/container/runtime-error/render-error.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcontainer%2Fruntime-error%2Frender-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcontainer%2Fruntime-error%2Frender-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcontainer%2Fruntime-error%2Frender-error.tsx?ref=824f853747a63702526803aea373895a8177ed7e",
            "patch": "@@ -1,4 +1,5 @@\n import type { OverlayState } from '../../shared'\n+import type { OverlayDispatch } from '../../shared'\n \n import { useMemo, useState, useEffect } from 'react'\n import {\n@@ -7,6 +8,7 @@ import {\n } from '../../utils/get-error-by-type'\n import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n import type { ComponentStackFrame } from '../../utils/parse-component-stack'\n+import { usePersistentCacheErrorDetection } from '../../components/errors/error-overlay-toolbar/restart-server-button'\n \n export type SupportedErrorEvent = {\n   id: number\n@@ -23,6 +25,7 @@ type Props = {\n   }) => React.ReactNode\n   state: OverlayState\n   isAppDir: boolean\n+  dispatch: OverlayDispatch\n }\n \n export const RenderError = (props: Props) => {\n@@ -36,7 +39,7 @@ export const RenderError = (props: Props) => {\n   }\n }\n \n-const RenderRuntimeError = ({ children, state, isAppDir }: Props) => {\n+const RenderRuntimeError = ({ children, state, isAppDir, dispatch }: Props) => {\n   const { errors } = state\n \n   const [lookups, setLookups] = useState<{\n@@ -65,6 +68,8 @@ const RenderRuntimeError = ({ children, state, isAppDir }: Props) => {\n     return [ready, next]\n   }, [errors, lookups])\n \n+  usePersistentCacheErrorDetection({ errors, dispatch })\n+\n   useEffect(() => {\n     if (nextError == null) {\n       return"
        },
        {
            "sha": "c05bd092bff4bfa08cd3a79f449a8d256aa77622",
            "filename": "packages/next/src/next-devtools/dev-overlay/dev-overlay.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fdev-overlay.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fdev-overlay.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fdev-overlay.tsx?ref=824f853747a63702526803aea373895a8177ed7e",
            "patch": "@@ -58,7 +58,7 @@ export function DevOverlay({\n       <ComponentStyles />\n       <DarkTheme />\n \n-      <RenderError state={state} isAppDir={true}>\n+      <RenderError state={state} dispatch={dispatch} isAppDir={true}>\n         {({ runtimeErrors, totalErrorCount }) => {\n           return (\n             <>"
        },
        {
            "sha": "57bc6a46a3175ec9484bd9e2ca6b3007ab71abfc",
            "filename": "packages/next/src/next-devtools/dev-overlay/shared.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fshared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/824f853747a63702526803aea373895a8177ed7e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fshared.ts?ref=824f853747a63702526803aea373895a8177ed7e",
            "patch": "@@ -36,6 +36,10 @@ export interface OverlayState {\n   staticIndicator: boolean\n   showIndicator: boolean\n   disableDevIndicator: boolean\n+  /** Whether to show the restart server button in the panel UI. Currently\n+   *  only used when Turbopack + Persistent Cache is enabled.\n+   */\n+  showRestartServerButton: boolean\n   debugInfo: DebugInfo\n   routerType: 'pages' | 'app'\n   /** This flag is used to handle the Error Overlay state in the \"old\" overlay.\n@@ -76,6 +80,7 @@ export const ACTION_DEVTOOLS_PANEL_TOGGLE = 'devtools-panel-toggle'\n \n export const ACTION_DEVTOOLS_POSITION = 'devtools-position'\n export const ACTION_DEVTOOLS_SCALE = 'devtools-scale'\n+export const ACTION_RESTART_SERVER_BUTTON = 'restart-server-button'\n \n export const STORAGE_KEY_THEME = '__nextjs-dev-tools-theme'\n export const STORAGE_KEY_POSITION = '__nextjs-dev-tools-position'\n@@ -176,6 +181,11 @@ export interface DevToolUpdateRouteStateAction {\n   page: string\n }\n \n+export interface RestartServerButtonAction {\n+  type: typeof ACTION_RESTART_SERVER_BUTTON\n+  showRestartServerButton: boolean\n+}\n+\n export type DispatcherEvent =\n   | BuildOkAction\n   | BuildErrorAction\n@@ -200,6 +210,8 @@ export type DispatcherEvent =\n   | DevToolsIndicatorPositionAction\n   | DevToolsScaleAction\n   | DevToolUpdateRouteStateAction\n+  | RestartServerButtonAction\n+\n const REACT_ERROR_STACK_BOTTOM_FRAME_REGEX =\n   // 1st group: v8\n   // 2nd group: SpiderMonkey, JavaScriptCore\n@@ -238,6 +250,7 @@ export const INITIAL_OVERLAY_STATE: Omit<\n   versionInfo: { installed: '0.0.0', staleness: 'unknown' },\n   debugInfo: { devtoolsFrontendUrl: undefined },\n   isDevToolsPanelOpen: false,\n+  showRestartServerButton: false,\n   devToolsPosition: 'bottom-left',\n   scale: NEXT_DEV_TOOLS_SCALE.Medium,\n   page: '',\n@@ -421,6 +434,12 @@ export function useErrorOverlayReducer(\n         case ACTION_DEVTOOL_UPDATE_ROUTE_STATE: {\n           return { ...state, page: action.page }\n         }\n+        case ACTION_RESTART_SERVER_BUTTON: {\n+          return {\n+            ...state,\n+            showRestartServerButton: action.showRestartServerButton,\n+          }\n+        }\n         default: {\n           return state\n         }"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 88,
        "deletions": 25
    }
}