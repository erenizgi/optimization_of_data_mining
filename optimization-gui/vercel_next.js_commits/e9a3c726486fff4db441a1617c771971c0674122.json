{
    "author": "gnoff",
    "message": "directly import search param resolver in metadata (#77402)\n\nlike with params in the prior change searchParams does not need to be\ncreated from outside the metadata components when the metadata component\nfactory is already part of the RSC layer. We can just directly import\nthis dependeny rather than route it through entry-base and expose it in\napp-render.",
    "sha": "e9a3c726486fff4db441a1617c771971c0674122",
    "files": [
        {
            "sha": "66bb75db4fb5f633c49cb83c540e8032879e2416",
            "filename": "packages/next/src/lib/metadata/metadata.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e9a3c726486fff4db441a1617c771971c0674122/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e9a3c726486fff4db441a1617c771971c0674122/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx?ref=e9a3c726486fff4db441a1617c771971c0674122",
            "patch": "@@ -3,6 +3,7 @@ import type { ParsedUrlQuery } from 'querystring'\n import type { GetDynamicParamFromSegment } from '../../server/app-render/app-render'\n import type { LoaderTree } from '../../server/lib/app-dir-module'\n import type { StreamingMetadataResolvedState } from '../../client/components/metadata/types'\n+import type { SearchParams } from '../../server/request/search-params'\n import {\n   AppleWebAppMeta,\n   FormatDetectionMeta,\n@@ -42,6 +43,7 @@ import {\n   AsyncMetadataOutlet,\n } from '../../client/components/metadata/async-metadata'\n import { isPostpone } from '../../server/lib/router-utils/is-postpone'\n+import { createServerSearchParamsForMetadata } from '../../server/request/search-params'\n \n // Use a promise to share the status of the metadata resolving,\n // returning two components `MetadataTree` and `MetadataOutlet`\n@@ -51,7 +53,7 @@ import { isPostpone } from '../../server/lib/router-utils/is-postpone'\n // and the error will be caught by the error boundary and trigger fallbacks.\n export function createMetadataComponents({\n   tree,\n-  searchParams,\n+  parsedQuery,\n   metadataContext,\n   getDynamicParamFromSegment,\n   appUsingSizeAdjustment,\n@@ -62,7 +64,7 @@ export function createMetadataComponents({\n   serveStreamingMetadata,\n }: {\n   tree: LoaderTree\n-  searchParams: Promise<ParsedUrlQuery>\n+  parsedQuery: SearchParams\n   metadataContext: MetadataContext\n   getDynamicParamFromSegment: GetDynamicParamFromSegment\n   appUsingSizeAdjustment: boolean\n@@ -78,6 +80,11 @@ export function createMetadataComponents({\n   getViewportReady: () => Promise<void>\n   StreamingMetadataOutlet: React.ComponentType\n } {\n+  const searchParams = createServerSearchParamsForMetadata(\n+    parsedQuery,\n+    workStore\n+  )\n+\n   function ViewportTree() {\n     return (\n       <>"
        },
        {
            "sha": "4cd48ee8a9c2fa1ffb50049f8aa1dbbce6109538",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 9,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/e9a3c726486fff4db441a1617c771971c0674122/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e9a3c726486fff4db441a1617c771971c0674122/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=e9a3c726486fff4db441a1617c771971c0674122",
            "patch": "@@ -468,7 +468,6 @@ async function generateDynamicRSCPayload(\n   const {\n     componentMod: {\n       tree: loaderTree,\n-      createServerSearchParamsForMetadata,\n       createMetadataComponents,\n       MetadataBoundary,\n       ViewportBoundary,\n@@ -487,7 +486,6 @@ async function generateDynamicRSCPayload(\n   if (!options?.skipFlight) {\n     const preloadCallbacks: PreloadCallbacks = []\n \n-    const searchParams = createServerSearchParamsForMetadata(query, workStore)\n     const {\n       ViewportTree,\n       MetadataTree,\n@@ -496,7 +494,7 @@ async function generateDynamicRSCPayload(\n       StreamingMetadataOutlet,\n     } = createMetadataComponents({\n       tree: loaderTree,\n-      searchParams,\n+      parsedQuery: query,\n       metadataContext: createTrackedMetadataContext(\n         url.pathname,\n         ctx.renderOpts,\n@@ -786,7 +784,6 @@ async function getRSCPayload(\n     appUsingSizeAdjustment,\n     componentMod: {\n       GlobalError,\n-      createServerSearchParamsForMetadata,\n       createMetadataComponents,\n       MetadataBoundary,\n       ViewportBoundary,\n@@ -802,7 +799,6 @@ async function getRSCPayload(\n   )\n   const serveStreamingMetadata = !!ctx.renderOpts.serveStreamingMetadata\n \n-  const searchParams = createServerSearchParamsForMetadata(query, workStore)\n   const {\n     ViewportTree,\n     MetadataTree,\n@@ -812,7 +808,7 @@ async function getRSCPayload(\n   } = createMetadataComponents({\n     tree,\n     errorType: is404 ? 'not-found' : undefined,\n-    searchParams,\n+    parsedQuery: query,\n     metadataContext: createTrackedMetadataContext(\n       url.pathname,\n       ctx.renderOpts,\n@@ -926,7 +922,6 @@ async function getErrorRSCPayload(\n     appUsingSizeAdjustment,\n     componentMod: {\n       GlobalError,\n-      createServerSearchParamsForMetadata,\n       createMetadataComponents,\n       MetadataBoundary,\n       ViewportBoundary,\n@@ -937,10 +932,9 @@ async function getErrorRSCPayload(\n   } = ctx\n \n   const serveStreamingMetadata = !!ctx.renderOpts.serveStreamingMetadata\n-  const searchParams = createServerSearchParamsForMetadata(query, workStore)\n   const { MetadataTree, ViewportTree } = createMetadataComponents({\n     tree,\n-    searchParams,\n+    parsedQuery: query,\n     // We create an untracked metadata context here because we can't postpone\n     // again during the error render.\n     metadataContext: createMetadataContext(url.pathname, ctx.renderOpts),"
        },
        {
            "sha": "8c7fda21fd641f7a829ebde37c3701120e478a3e",
            "filename": "packages/next/src/server/app-render/entry-base.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e9a3c726486fff4db441a1617c771971c0674122/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e9a3c726486fff4db441a1617c771971c0674122/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts?ref=e9a3c726486fff4db441a1617c771971c0674122",
            "patch": "@@ -20,7 +20,6 @@ import { ClientSegmentRoot } from '../../client/components/client-segment'\n import {\n   createServerSearchParamsForServerPage,\n   createPrerenderSearchParamsForClientPage,\n-  createServerSearchParamsForMetadata,\n } from '../request/search-params'\n import {\n   createServerParamsForServerSegment,\n@@ -59,7 +58,6 @@ export {\n   workUnitAsyncStorage,\n   actionAsyncStorage,\n   createServerSearchParamsForServerPage,\n-  createServerSearchParamsForMetadata,\n   createPrerenderSearchParamsForClientPage,\n   createServerParamsForServerSegment,\n   createPrerenderParamsForClientSegment,"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 12,
        "deletions": 13
    }
}