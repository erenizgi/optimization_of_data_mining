{
    "author": "mischnic",
    "message": "Turbopack: fix data-url CSS Module client references (#78428)\n\nCloses #78114\r\nCloses #78096\r\nCloses PACK-4337\r\n\r\ncc @jantimon . Thank you for creating the tests, that made it much easier!\r\n\r\nThey are indeed not working with Webpack at the moment:\r\n```\r\ndata:text/css+module,.client{font-weight:700}\r\nModule parse failed: Unexpected token (1:0)\r\nYou may need an appropriate loader to handle this file type, currently no loaders are configured to process this file. See https://webpack.js.org/concepts#loaders\r\n> .client{font-weight:700}\r\n```",
    "sha": "0125959066a43e3e57dd16633276de8b6012dea0",
    "files": [
        {
            "sha": "6356ca770634efb8ab292a1516b5295300b1e9d8",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0125959066a43e3e57dd16633276de8b6012dea0/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0125959066a43e3e57dd16633276de8b6012dea0/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=0125959066a43e3e57dd16633276de8b6012dea0",
            "patch": "@@ -115,13 +115,20 @@ fn styles_rule_condition() -> RuleCondition {\n             RuleCondition::ResourcePathEndsWith(\".sass\".into()),\n             RuleCondition::not(RuleCondition::ResourcePathEndsWith(\".module.sass\".into())),\n         ]),\n+        RuleCondition::all(vec![\n+            RuleCondition::ContentTypeStartsWith(\"text/css\".into()),\n+            RuleCondition::not(RuleCondition::ContentTypeStartsWith(\n+                \"text/css+module\".into(),\n+            )),\n+        ]),\n     ])\n }\n fn module_styles_rule_condition() -> RuleCondition {\n     RuleCondition::any(vec![\n         RuleCondition::ResourcePathEndsWith(\".module.css\".into()),\n         RuleCondition::ResourcePathEndsWith(\".module.scss\".into()),\n         RuleCondition::ResourcePathEndsWith(\".module.sass\".into()),\n+        RuleCondition::ContentTypeStartsWith(\"text/css+module\".into()),\n     ])\n }\n "
        },
        {
            "sha": "4cd409dbcfc65b84574be0ad3ce2b8f56aceaaf4",
            "filename": "crates/next-core/src/next_server/transforms.rs",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/0125959066a43e3e57dd16633276de8b6012dea0/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0125959066a43e3e57dd16633276de8b6012dea0/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs?ref=0125959066a43e3e57dd16633276de8b6012dea0",
            "patch": "@@ -54,16 +54,29 @@ pub async fn get_next_server_transforms_rules(\n             // Ignore the internal ModuleCssAsset -> CssModuleAsset references\n             // The CSS Module module itself is still needed for class names\n             ModuleRule::new_internal(\n-                RuleCondition::ResourcePathEndsWith(\".module.css\".into()),\n+                RuleCondition::any(vec![\n+                    RuleCondition::ResourcePathEndsWith(\".module.css\".into()),\n+                    RuleCondition::ContentTypeStartsWith(\"text/css+module\".into()),\n+                ]),\n                 vec![ModuleRuleEffect::Ignore],\n             ),\n         ]);\n         rules.extend([\n             // Ignore all non-module CSS references\n             ModuleRule::new(\n-                RuleCondition::all(vec![\n-                    RuleCondition::ResourcePathEndsWith(\".css\".into()),\n-                    RuleCondition::not(RuleCondition::ResourcePathEndsWith(\".module.css\".into())),\n+                RuleCondition::any(vec![\n+                    RuleCondition::all(vec![\n+                        RuleCondition::ResourcePathEndsWith(\".css\".into()),\n+                        RuleCondition::not(RuleCondition::ResourcePathEndsWith(\n+                            \".module.css\".into(),\n+                        )),\n+                    ]),\n+                    RuleCondition::all(vec![\n+                        RuleCondition::ContentTypeStartsWith(\"text/css\".into()),\n+                        RuleCondition::not(RuleCondition::ContentTypeStartsWith(\n+                            \"text/css+module\".into(),\n+                        )),\n+                    ]),\n                 ]),\n                 vec![ModuleRuleEffect::Ignore],\n             ),"
        },
        {
            "sha": "407b1d4f1aaf600a03a988985dda62e92def159a",
            "filename": "test/e2e/app-dir/css-modules-data-urls/app/client.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/0125959066a43e3e57dd16633276de8b6012dea0/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fapp%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0125959066a43e3e57dd16633276de8b6012dea0/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fapp%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fapp%2Fclient.tsx?ref=0125959066a43e3e57dd16633276de8b6012dea0",
            "patch": "@@ -0,0 +1,11 @@\n+'use client'\n+// @ts-expect-error\n+import styles from 'data:text/css+module,.client{font-weight:700}'\n+\n+export const ClientComponent = () => {\n+  return (\n+    <div id=\"client\" className={`${styles.client}`}>\n+      This text should be bold\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "56ffc2df94a7d1b5c51f70b7685a83b7a3750d1e",
            "filename": "test/e2e/app-dir/css-modules-data-urls/app/layout.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/0125959066a43e3e57dd16633276de8b6012dea0/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0125959066a43e3e57dd16633276de8b6012dea0/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fapp%2Flayout.tsx?ref=0125959066a43e3e57dd16633276de8b6012dea0",
            "patch": "@@ -0,0 +1,13 @@\n+import type { ReactNode } from 'react'\n+\n+export default function RootLayout({\n+  children,\n+}: Readonly<{\n+  children: ReactNode\n+}>) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "73e19f344bdecba02d9e93ae526c3d763653b9fb",
            "filename": "test/e2e/app-dir/css-modules-data-urls/app/page.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/0125959066a43e3e57dd16633276de8b6012dea0/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0125959066a43e3e57dd16633276de8b6012dea0/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fapp%2Fpage.tsx?ref=0125959066a43e3e57dd16633276de8b6012dea0",
            "patch": "@@ -0,0 +1,14 @@\n+// @ts-expect-error\n+import styles from 'data:text/css+module,.home{font-weight:700}'\n+import { ClientComponent } from './client'\n+\n+export default function Home() {\n+  return (\n+    <>\n+      <div id=\"rsc\" className={`${styles.home}`}>\n+        This text should be bold\n+      </div>\n+      <ClientComponent />\n+    </>\n+  )\n+}"
        },
        {
            "sha": "ef3921a0f9c80428af8775901e1efb2536e97bc1",
            "filename": "test/e2e/app-dir/css-modules-data-urls/css-modules-data-urls.test.ts",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/0125959066a43e3e57dd16633276de8b6012dea0/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fcss-modules-data-urls.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0125959066a43e3e57dd16633276de8b6012dea0/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fcss-modules-data-urls.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fcss-modules-data-urls.test.ts?ref=0125959066a43e3e57dd16633276de8b6012dea0",
            "patch": "@@ -0,0 +1,49 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+// CSS data urls are only support in Turbopack\n+;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n+  'css-modules-data-urls',\n+  () => {\n+    const { next } = nextTestSetup({\n+      files: __dirname,\n+    })\n+\n+    it('should apply rsc class name from data url correctly', async () => {\n+      const browser = await next.browser('/')\n+\n+      const clientElementClass =\n+        (await browser.elementByCss('#client').getAttribute('class')) || ''\n+\n+      expect(clientElementClass).not.toBe('')\n+    })\n+\n+    it('should apply rsc styles from data url correctly', async () => {\n+      const browser = await next.browser('/')\n+\n+      const rscElement = await browser\n+        .elementByCss('#rsc')\n+        .getComputedCss('font-weight')\n+\n+      expect(rscElement).toBe('700')\n+    })\n+\n+    it('should apply client class name from data url correctly', async () => {\n+      const browser = await next.browser('/')\n+\n+      const clientElementClass =\n+        (await browser.elementByCss('#client').getAttribute('class')) || ''\n+\n+      expect(clientElementClass).not.toBe('')\n+    })\n+\n+    it('should apply client styles from data url correctly', async () => {\n+      const browser = await next.browser('/')\n+\n+      const clientElement = await browser\n+        .elementByCss('#client')\n+        .getComputedCss('font-weight')\n+\n+      expect(clientElement).toBe('700')\n+    })\n+  }\n+)"
        },
        {
            "sha": "73290639bc0ae1d251322dd57c81c24e6934dfb7",
            "filename": "test/e2e/app-dir/css-modules-data-urls/next.config.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0125959066a43e3e57dd16633276de8b6012dea0/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0125959066a43e3e57dd16633276de8b6012dea0/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-data-urls%2Fnext.config.ts?ref=0125959066a43e3e57dd16633276de8b6012dea0",
            "patch": "@@ -0,0 +1,7 @@\n+import type { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  /* config options here */\n+}\n+\n+export default nextConfig"
        },
        {
            "sha": "b577940fd54ecdcc907cc6f2c57e1bdf3d62e840",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/0125959066a43e3e57dd16633276de8b6012dea0/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0125959066a43e3e57dd16633276de8b6012dea0/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=0125959066a43e3e57dd16633276de8b6012dea0",
            "patch": "@@ -527,7 +527,10 @@ impl ModuleOptions {\n                 ),\n                 ModuleRule::new(\n                     RuleCondition::all(vec![\n-                        RuleCondition::ResourcePathEndsWith(\".module.css\".to_string()),\n+                        RuleCondition::Any(vec![\n+                            RuleCondition::ResourcePathEndsWith(\".module.css\".to_string()),\n+                            RuleCondition::ContentTypeStartsWith(\"text/css+module\".to_string()),\n+                        ]),\n                         // Create a normal CSS asset if `@import`ed from CSS already.\n                         RuleCondition::ReferenceType(ReferenceType::Css(\n                             CssReferenceSubType::AtImport(None),"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 122,
        "deletions": 5
    }
}