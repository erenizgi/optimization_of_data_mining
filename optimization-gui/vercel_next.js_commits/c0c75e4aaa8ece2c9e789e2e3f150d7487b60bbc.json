{
    "author": "gnoff",
    "message": "Avoid proxying React modules through workUnitStore (#85486)\n\nToday the `captureOwnerStack()` function is provided to shared utilities\nthrough an AsyncLocalStorage that scopes the method from the appropriate\nReact instance. This is so that external code like patches to sync IO\nmethods can still generate errors with the appropriate React owner\ninformation even when the patched code itself is not bundled and can be\ncalled from etiher SSR or RSC contexts.\n\nThis works but it makes plumbing the React instances around tricky.\nThere is a simpler way. Most of the time you can just try both React's.\nIf one gives you a non-null/undefined result then you know you are in\nthat scope. If neither do then you're outside a React scope altogether.\n\nIn this change I remove `captureOwnerStack()` from the workUnitStore\ntypes and just call it from the shared server runtime which gives even\nexternal code access to the appropriate React instances for bundled code",
    "sha": "c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc",
    "files": [
        {
            "sha": "ee5e6e75ee8709e95467719b84e2c9bc6a97f558",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 17,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc",
            "patch": "@@ -955,7 +955,6 @@ async function prospectiveRuntimeServerPrerender(\n     renderResumeDataCache,\n     prerenderResumeDataCache,\n     hmrRefreshHash: undefined,\n-    captureOwnerStack: undefined,\n     // We only need task sequencing in the final prerender.\n     runtimeStagePromise: null,\n     // These are not present in regular prerenders, but allowed in a runtime prerender.\n@@ -1092,7 +1091,6 @@ async function finalRuntimeServerPrerender(\n     prerenderResumeDataCache,\n     renderResumeDataCache,\n     hmrRefreshHash: undefined,\n-    captureOwnerStack: undefined,\n     // Used to separate the \"Static\" stage from the \"Runtime\" stage.\n     runtimeStagePromise,\n     // These are not present in regular prerenders, but allowed in a runtime prerender.\n@@ -3315,9 +3313,7 @@ async function spawnDynamicValidationInDev(\n   // ready to cut the render off.\n   const cacheSignal = new CacheSignal()\n \n-  const captureOwnerStackClient = ReactClient.captureOwnerStack\n-  const { captureOwnerStack: captureOwnerStackServer, createElement } =\n-    ComponentMod\n+  const { createElement } = ComponentMod\n \n   // The resume data cache here should use a fresh instance as it's\n   // performing a fresh prerender. If we get to implementing the\n@@ -3350,7 +3346,6 @@ async function spawnDynamicValidationInDev(\n     prerenderResumeDataCache,\n     renderResumeDataCache: null,\n     hmrRefreshHash,\n-    captureOwnerStack: captureOwnerStackServer,\n   }\n \n   // We're not going to use the result of this render because the only time it could be used\n@@ -3384,7 +3379,6 @@ async function spawnDynamicValidationInDev(\n     prerenderResumeDataCache,\n     renderResumeDataCache: null,\n     hmrRefreshHash,\n-    captureOwnerStack: captureOwnerStackServer,\n   }\n \n   const pendingInitialServerResult = workUnitAsyncStorage.run(\n@@ -3505,7 +3499,6 @@ async function spawnDynamicValidationInDev(\n       prerenderResumeDataCache,\n       renderResumeDataCache: null,\n       hmrRefreshHash: undefined,\n-      captureOwnerStack: captureOwnerStackClient,\n     }\n \n     const prerender = (\n@@ -3616,7 +3609,6 @@ async function spawnDynamicValidationInDev(\n     prerenderResumeDataCache,\n     renderResumeDataCache: null,\n     hmrRefreshHash,\n-    captureOwnerStack: captureOwnerStackServer,\n   }\n \n   const finalAttemptRSCPayload = await workUnitAsyncStorage.run(\n@@ -3650,7 +3642,6 @@ async function spawnDynamicValidationInDev(\n     prerenderResumeDataCache,\n     renderResumeDataCache: null,\n     hmrRefreshHash,\n-    captureOwnerStack: captureOwnerStackServer,\n   }\n \n   const reactServerResult = await createReactServerPrerenderResult(\n@@ -3730,7 +3721,6 @@ async function spawnDynamicValidationInDev(\n     prerenderResumeDataCache,\n     renderResumeDataCache: null,\n     hmrRefreshHash,\n-    captureOwnerStack: captureOwnerStackClient,\n   }\n \n   let dynamicValidation = createDynamicValidationState()\n@@ -4108,7 +4098,6 @@ async function prerenderToStream(\n         prerenderResumeDataCache,\n         renderResumeDataCache,\n         hmrRefreshHash: undefined,\n-        captureOwnerStack: undefined, // Not available in production.\n       }\n \n       // We're not going to use the result of this render because the only time it could be used\n@@ -4142,7 +4131,6 @@ async function prerenderToStream(\n         prerenderResumeDataCache,\n         renderResumeDataCache,\n         hmrRefreshHash: undefined,\n-        captureOwnerStack: undefined, // Not available in production.\n       })\n \n       const pendingInitialServerResult = workUnitAsyncStorage.run(\n@@ -4257,7 +4245,6 @@ async function prerenderToStream(\n           prerenderResumeDataCache,\n           renderResumeDataCache,\n           hmrRefreshHash: undefined,\n-          captureOwnerStack: undefined, // Not available in production.\n         }\n \n         const prerender = (\n@@ -4367,7 +4354,6 @@ async function prerenderToStream(\n         prerenderResumeDataCache,\n         renderResumeDataCache,\n         hmrRefreshHash: undefined,\n-        captureOwnerStack: undefined, // Not available in production.\n       }\n \n       const finalAttemptRSCPayload = await workUnitAsyncStorage.run(\n@@ -4402,7 +4388,6 @@ async function prerenderToStream(\n         prerenderResumeDataCache,\n         renderResumeDataCache,\n         hmrRefreshHash: undefined,\n-        captureOwnerStack: undefined, // Not available in production.\n       })\n \n       let prerenderIsPending = true\n@@ -4488,7 +4473,6 @@ async function prerenderToStream(\n         prerenderResumeDataCache,\n         renderResumeDataCache,\n         hmrRefreshHash: undefined,\n-        captureOwnerStack: undefined, // Not available in production.\n       }\n \n       let dynamicValidation = createDynamicValidationState()"
        },
        {
            "sha": "d321cbc0080937dda131bfc68fde8b7f179564b7",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc",
            "patch": "@@ -207,11 +207,6 @@ interface PrerenderStoreModernCommon\n    * subsequent dynamic render.\n    */\n   readonly hmrRefreshHash: string | undefined\n-\n-  /**\n-   * Only available in dev mode.\n-   */\n-  readonly captureOwnerStack: undefined | (() => string | null)\n }\n \n interface StaticPrerenderStoreCommon {"
        },
        {
            "sha": "2a0bade809b032ebac07746b53d7f313b0bb0a3f",
            "filename": "packages/next/src/server/node-environment-extensions/console-dim.external.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.test.ts?ref=c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc",
            "patch": "@@ -321,13 +321,23 @@ describe('console-exit patches', () => {\n         }\n \n         // Install patches - this wraps the current console.log\n-        const {\n-          registerGetCacheSignal,\n-        } = require('next/dist/server/node-environment-extensions/console-dim.external')\n+        require('next/dist/server/node-environment-extensions/console-dim.external')\n \n-        registerGetCacheSignal(() => null)\n-        registerGetCacheSignal(() => controller?.signal)\n-        registerGetCacheSignal(() => null)\n+        const {\n+          registerServerReact,\n+          registerClientReact,\n+        } = require('next/dist/server/runtime-reacts.external')\n+\n+        registerServerReact({\n+          cacheSignal() {\n+            return controller?.signal\n+          },\n+        })\n+        registerClientReact({\n+          cacheSignal() {\n+            return null\n+          },\n+        })\n \n         console.log('before abort')\n         controller.abort()"
        },
        {
            "sha": "87396a043c8d3a99b380cde6821ae30b3d3a4730",
            "filename": "packages/next/src/server/node-environment-extensions/console-dim.external.tsx",
            "status": "modified",
            "additions": 26,
            "deletions": 32,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.tsx?ref=c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc",
            "patch": "@@ -4,12 +4,7 @@ import {\n   type ConsoleStore,\n } from '../app-render/console-async-storage.external'\n import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\n-\n-type GetCacheSignal = () => AbortSignal | null\n-const cacheSignals: Array<GetCacheSignal> = []\n-export function registerGetCacheSignal(getSignal: GetCacheSignal): void {\n-  cacheSignals.push(getSignal)\n-}\n+import { getServerReact, getClientReact } from '../runtime-reacts.external'\n \n // eslint-disable-next-line @typescript-eslint/no-unused-vars -- we may use later and want parity with the HIDDEN_STYLE value\n const DIMMED_STYLE = 'dimmed'\n@@ -191,33 +186,32 @@ function patchConsoleMethod(methodName: InterceptableConsoleMethod): void {\n       // the server React cacheSignal implementation. Any particular console call will be in one, the other, or neither\n       // scope and these signals return null if you are out of scope so this can be called from a single global patch\n       // and still work properly.\n-      for (let i = 0; i < cacheSignals.length; i++) {\n-        const signal = cacheSignals[i]() // try to get a signal from registered functions\n-        if (signal) {\n-          // We are in a React Server render and can consult the React cache signal to determine if logs\n-          // are now dimmable.\n-          if (signal.aborted) {\n-            if (currentAbortedLogsStyle === HIDDEN_STYLE) {\n-              return\n-            }\n-            return applyWithDimming.call(\n-              this,\n-              consoleStore,\n-              originalMethod,\n-              methodName,\n-              args\n-            )\n-          } else if (consoleStore?.dim === true) {\n-            return applyWithDimming.call(\n-              this,\n-              consoleStore,\n-              originalMethod,\n-              methodName,\n-              args\n-            )\n-          } else {\n-            return originalMethod.apply(this, args)\n+      const signal =\n+        getClientReact()?.cacheSignal() ?? getServerReact()?.cacheSignal()\n+      if (signal) {\n+        // We are in a React Server render and can consult the React cache signal to determine if logs\n+        // are now dimmable.\n+        if (signal.aborted) {\n+          if (currentAbortedLogsStyle === HIDDEN_STYLE) {\n+            return\n           }\n+          return applyWithDimming.call(\n+            this,\n+            consoleStore,\n+            originalMethod,\n+            methodName,\n+            args\n+          )\n+        } else if (consoleStore?.dim === true) {\n+          return applyWithDimming.call(\n+            this,\n+            consoleStore,\n+            originalMethod,\n+            methodName,\n+            args\n+          )\n+        } else {\n+          return originalMethod.apply(this, args)\n         }\n       }\n "
        },
        {
            "sha": "30213664c9bf0cd677fae7bf63ce2ae5b5433c84",
            "filename": "packages/next/src/server/node-environment-extensions/utils.tsx",
            "status": "modified",
            "additions": 10,
            "deletions": 12,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx?ref=c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc",
            "patch": "@@ -1,14 +1,13 @@\n import { workAsyncStorage } from '../app-render/work-async-storage.external'\n-import {\n-  workUnitAsyncStorage,\n-  type PrerenderStoreModern,\n-} from '../app-render/work-unit-async-storage.external'\n+import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\n import {\n   abortOnSynchronousPlatformIOAccess,\n   trackSynchronousPlatformIOAccessInDev,\n } from '../app-render/dynamic-rendering'\n import { InvariantError } from '../../shared/lib/invariant-error'\n \n+import { getServerReact, getClientReact } from '../runtime-reacts.external'\n+\n type ApiType = 'time' | 'random' | 'crypto'\n \n export function io(expression: string, type: ApiType) {\n@@ -47,7 +46,7 @@ export function io(expression: string, type: ApiType) {\n         abortOnSynchronousPlatformIOAccess(\n           workStore.route,\n           expression,\n-          applyOwnerStack(new Error(message), workUnitStore),\n+          applyOwnerStack(new Error(message)),\n           workUnitStore\n         )\n       }\n@@ -79,7 +78,7 @@ export function io(expression: string, type: ApiType) {\n         abortOnSynchronousPlatformIOAccess(\n           workStore.route,\n           expression,\n-          applyOwnerStack(new Error(message), workUnitStore),\n+          applyOwnerStack(new Error(message)),\n           workUnitStore\n         )\n       }\n@@ -101,16 +100,15 @@ export function io(expression: string, type: ApiType) {\n   }\n }\n \n-function applyOwnerStack(error: Error, workUnitStore: PrerenderStoreModern) {\n+function applyOwnerStack(error: Error) {\n   // TODO: Instead of stitching the stacks here, we should log the original\n   // error as-is when it occurs, and let `patchErrorInspect` handle adding the\n   // owner stack, instead of logging it deferred in the `LogSafely` component\n   // via `throwIfDisallowedDynamic`.\n-  if (\n-    process.env.NODE_ENV !== 'production' &&\n-    workUnitStore.captureOwnerStack\n-  ) {\n-    const ownerStack = workUnitStore.captureOwnerStack()\n+  if (process.env.NODE_ENV !== 'production') {\n+    const ownerStack =\n+      getClientReact()?.captureOwnerStack() ??\n+      getServerReact()?.captureOwnerStack()\n \n     if (ownerStack) {\n       let stack = ownerStack"
        },
        {
            "sha": "44968511476bd1514345b15339aa42beb740c988",
            "filename": "packages/next/src/server/route-modules/app-page/module.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts?ref=c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc",
            "patch": "@@ -39,13 +39,12 @@ if (process.env.NEXT_RUNTIME !== 'edge') {\n   vendoredReactSSR =\n     require('./vendored/ssr/entrypoints') as typeof import('./vendored/ssr/entrypoints')\n \n-  // In Node environments we augment console logging with information contextual to a React render.\n-  // This patching is global so we need to register the cacheSignal getter from our bundled React instances\n-  // here when we load them rather than in the external module itself when the patch is applied.\n-  const { registerGetCacheSignal } =\n-    require('../../node-environment-extensions/console-dim.external') as typeof import('../../node-environment-extensions/console-dim.external')\n-  registerGetCacheSignal(vendoredReactRSC.React.cacheSignal)\n-  registerGetCacheSignal(vendoredReactSSR.React.cacheSignal)\n+  // In Node environments we need to access the correct React instance from external modules such\n+  // as global patches. We register the loaded React instances here.\n+  const { registerServerReact, registerClientReact } =\n+    require('../../runtime-reacts.external') as typeof import('../../runtime-reacts.external')\n+  registerServerReact(vendoredReactRSC.React)\n+  registerClientReact(vendoredReactSSR.React)\n }\n \n /**"
        },
        {
            "sha": "ae9e62bfb290ec52698d5873f89981da97ce7e81",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc",
            "patch": "@@ -413,7 +413,6 @@ export class AppRouteRouteModule extends RouteModule<\n               prerenderResumeDataCache,\n               renderResumeDataCache: null,\n               hmrRefreshHash: undefined,\n-              captureOwnerStack: undefined,\n             })\n \n           let prospectiveResult\n@@ -505,7 +504,6 @@ export class AppRouteRouteModule extends RouteModule<\n             prerenderResumeDataCache,\n             renderResumeDataCache: null,\n             hmrRefreshHash: undefined,\n-            captureOwnerStack: undefined,\n           })\n \n           let responseHandled = false"
        },
        {
            "sha": "fce6fde59ec5196ef37252e2289c0783f6e494d0",
            "filename": "packages/next/src/server/runtime-reacts.external.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fruntime-reacts.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/packages%2Fnext%2Fsrc%2Fserver%2Fruntime-reacts.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fruntime-reacts.external.ts?ref=c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc",
            "patch": "@@ -0,0 +1,15 @@\n+let ClientReact: typeof import('react') | null = null\n+export function registerClientReact(react: typeof import('react')) {\n+  ClientReact = react\n+}\n+export function getClientReact() {\n+  return ClientReact\n+}\n+\n+let ServerReact: typeof import('react') | null = null\n+export function registerServerReact(react: typeof import('react')) {\n+  ServerReact = react\n+}\n+export function getServerReact() {\n+  return ServerReact\n+}"
        },
        {
            "sha": "4f59f42c3717fdff200b6a9379bdd8b2cf8fbaa4",
            "filename": "test/production/next-server-nft/next-server-nft.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts?ref=c0c75e4aaa8ece2c9e789e2e3f150d7487b60bbc",
            "patch": "@@ -321,6 +321,7 @@ const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n          \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/loadable.js\",\n          \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/router-context.js\",\n          \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/server-inserted-html.js\",\n+         \"/node_modules/next/dist/server/runtime-reacts.external.js\",\n          \"/node_modules/next/dist/shared/lib/deep-freeze.js\",\n          \"/node_modules/next/dist/shared/lib/invariant-error.js\",\n          \"/node_modules/next/dist/shared/lib/is-plain-object.js\","
        }
    ],
    "stats": {
        "total": 156,
        "additions": 75,
        "deletions": 81
    }
}