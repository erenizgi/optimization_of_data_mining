{
    "author": "lubieowoce",
    "message": "Allow SSR to finish microtasky work before flushing (#86311)\n\nIn a dynamic Fizz (SSR) render, rendering work is initially scheduled using microtasks, and a flush will be attempted when the stream gets pulled:\r\nhttps://github.com/facebook/react/blob/8ac5f4eb3601f7381462f8b74ecf24d47259cc20/packages/react-dom/src/server/ReactDOMFizzServerNode.js#L386-L389\r\nThis can cause streaming metadata to flake between appearing in `<head>` and `<body>` depending on if whether it had enough microtasks to render before the flush occurred.\r\nIn general, if something is async, but available after a couple microtasks, then we shouldn't bother streaming it, it should just go into the initial HTML. We achieve this by waiting a task before allowing the stream to get pulled, which allows all the microtasky work to finish without delaying the response too much.",
    "sha": "0dba1c692b1be8dddea0fb4edf1f1d00b33c90fc",
    "files": [
        {
            "sha": "0df3d16cd26b8310da8e7cbb8baf7f877f85b230",
            "filename": "packages/next/src/server/stream-utils/node-web-streams-helper.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/0dba1c692b1be8dddea0fb4edf1f1d00b33c90fc/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0dba1c692b1be8dddea0fb4edf1f1d00b33c90fc/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts?ref=0dba1c692b1be8dddea0fb4edf1f1d00b33c90fc",
            "patch": "@@ -2,7 +2,11 @@ import type { ReactDOMServerReadableStream } from 'react-dom/server'\n import { getTracer } from '../lib/trace/tracer'\n import { AppRenderSpan } from '../lib/trace/constants'\n import { DetachedPromise } from '../../lib/detached-promise'\n-import { scheduleImmediate, atLeastOneTask } from '../../lib/scheduler'\n+import {\n+  scheduleImmediate,\n+  atLeastOneTask,\n+  waitAtLeastOneReactRenderTask,\n+} from '../../lib/scheduler'\n import { ENCODED_TAGS } from './encoded-tags'\n import {\n   indexOfUint8Array,\n@@ -797,9 +801,13 @@ export async function continueFizzStream(\n   // Suffix itself might contain close tags at the end, so we need to split it.\n   const suffixUnclosed = suffix ? suffix.split(CLOSE_TAG, 1)[0] : null\n \n-  // If we're generating static HTML we need to wait for it to resolve before continuing.\n   if (isStaticGeneration) {\n+    // If we're generating static HTML we need to wait for it to resolve before continuing.\n     await renderStream.allReady\n+  } else {\n+    // Otherwise, we want to make sure Fizz is done with all microtasky work\n+    // before we start pulling the stream and cause a flush.\n+    await waitAtLeastOneReactRenderTask()\n   }\n \n   return chainTransformers(renderStream, ["
        },
        {
            "sha": "0f7ae983249d9a53e36cb8e89694d12f03fd7d6a",
            "filename": "test/e2e/app-dir/metadata-icons/app/custom-icon/delay-icons/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0dba1c692b1be8dddea0fb4edf1f1d00b33c90fc/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fdelay-icons%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0dba1c692b1be8dddea0fb4edf1f1d00b33c90fc/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fdelay-icons%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fdelay-icons%2Fpage.tsx?ref=0dba1c692b1be8dddea0fb4edf1f1d00b33c90fc",
            "patch": "@@ -18,8 +18,9 @@ export default async function Page() {\n \n export async function generateMetadata() {\n   await connection()\n+  // Delay until after the shell is flushed so that the tags end up in the body.\n+  await new Promise((resolve) => setTimeout(resolve, 10))\n   return {\n-    // This long text description will lead to the metadata being inserted after the head tag.\n     description: 'long text description'.repeat(1000),\n     icons: {\n       icon: `/heart.png`,"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 12,
        "deletions": 3
    }
}