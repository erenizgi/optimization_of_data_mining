{
    "author": "sokra",
    "message": "Turbopack: avoid celling source maps before minify (#76626)\n\n### What?\n\nAvoid using a turbo-tasks function for generating the input source map so the source map is not persistently stored in a cell.",
    "sha": "1ba2577a47d96c7ccf02499397bc328c60ca9db9",
    "files": [
        {
            "sha": "1acb073bd039c22ace02ca60713f2eae4c4e3226",
            "filename": "turbopack/crates/turbopack-core/src/code_builder.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 13,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/1ba2577a47d96c7ccf02499397bc328c60ca9db9/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcode_builder.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1ba2577a47d96c7ccf02499397bc328c60ca9db9/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcode_builder.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcode_builder.rs?ref=1ba2577a47d96c7ccf02499397bc328c60ca9db9",
            "patch": "@@ -151,6 +151,23 @@ impl GenerateSourceMap for Code {\n     /// chunk items into a single map file.\n     #[turbo_tasks::function]\n     pub async fn generate_source_map(&self) -> Result<Vc<OptionStringifiedSourceMap>> {\n+        Ok(Vc::cell(Some(self.generate_source_map_ref()?)))\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl Code {\n+    /// Returns the hash of the source code of this Code.\n+    #[turbo_tasks::function]\n+    pub fn source_code_hash(&self) -> Vc<u64> {\n+        let code = self;\n+        let hash = hash_xxh3_hash64(code.source_code());\n+        Vc::cell(hash)\n+    }\n+}\n+\n+impl Code {\n+    pub fn generate_source_map_ref(&self) -> Result<Rope> {\n         let mut pos = SourcePos::new();\n         let mut last_byte_pos = 0;\n \n@@ -173,18 +190,6 @@ impl GenerateSourceMap for Code {\n             sections.push((pos, map.clone().unwrap_or_else(SourceMap::empty_rope)))\n         }\n \n-        let source_map = SourceMap::sections_to_rope(sections)?;\n-        Ok(Vc::cell(Some(source_map)))\n-    }\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl Code {\n-    /// Returns the hash of the source code of this Code.\n-    #[turbo_tasks::function]\n-    pub fn source_code_hash(&self) -> Vc<u64> {\n-        let code = self;\n-        let hash = hash_xxh3_hash64(code.source_code());\n-        Vc::cell(hash)\n+        SourceMap::sections_to_rope(sections)\n     }\n }"
        },
        {
            "sha": "6aac43f45fe0dbfd9764b9042870ea1d6252b2c1",
            "filename": "turbopack/crates/turbopack-css/src/module_asset.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/1ba2577a47d96c7ccf02499397bc328c60ca9db9/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1ba2577a47d96c7ccf02499397bc328c60ca9db9/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs?ref=1ba2577a47d96c7ccf02499397bc328c60ca9db9",
            "patch": "@@ -19,7 +19,6 @@ use turbopack_core::{\n     reference_type::{CssReferenceSubType, ReferenceType},\n     resolve::{origin::ResolveOrigin, parse::Request},\n     source::Source,\n-    source_map::OptionStringifiedSourceMap,\n };\n use turbopack_ecmascript::{\n     chunk::{\n@@ -436,12 +435,7 @@ async fn generate_minimal_source_map(filename: String, source: String) -> Result\n     }\n     let sm: Arc<SourceMap> = Default::default();\n     sm.new_source_file(FileName::Custom(filename).into(), source);\n-    let map = generate_js_source_map(\n-        sm,\n-        mappings,\n-        OptionStringifiedSourceMap::none().to_resolved().await?,\n-    )\n-    .await?;\n+    let map = generate_js_source_map(sm, mappings, None).await?;\n     Ok(map)\n }\n "
        },
        {
            "sha": "69c20bbf6cc4f12e8d44693d84c9e3efe6b144ab",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/1ba2577a47d96c7ccf02499397bc328c60ca9db9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1ba2577a47d96c7ccf02499397bc328c60ca9db9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=1ba2577a47d96c7ccf02499397bc328c60ca9db9",
            "patch": "@@ -966,8 +966,12 @@ async fn gen_content_with_code_gens(\n \n             let source_map = if generate_source_map {\n                 Some(\n-                    generate_js_source_map(source_map.clone(), mappings, original_source_map)\n-                        .await?,\n+                    generate_js_source_map(\n+                        source_map.clone(),\n+                        mappings,\n+                        original_source_map.await?.as_ref(),\n+                    )\n+                    .await?,\n                 )\n             } else {\n                 None"
        },
        {
            "sha": "2e49da8f47396c145cf59aea131e05a06b70c2f5",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/1ba2577a47d96c7ccf02499397bc328c60ca9db9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1ba2577a47d96c7ccf02499397bc328c60ca9db9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=1ba2577a47d96c7ccf02499397bc328c60ca9db9",
            "patch": "@@ -21,10 +21,7 @@ use swc_core::{\n };\n use turbo_tasks::Vc;\n use turbo_tasks_fs::FileSystemPath;\n-use turbopack_core::{\n-    code_builder::{Code, CodeBuilder},\n-    source_map::GenerateSourceMap,\n-};\n+use turbopack_core::code_builder::{Code, CodeBuilder};\n \n use crate::parse::generate_js_source_map;\n \n@@ -36,8 +33,11 @@ pub async fn minify(\n     mangle: bool,\n ) -> Result<Vc<Code>> {\n     let path = path.await?;\n-    let source_maps = source_maps.await?.then(|| code.generate_source_map());\n     let code = code.await?;\n+    let source_maps = source_maps\n+        .await?\n+        .then(|| code.generate_source_map_ref())\n+        .transpose()?;\n \n     let cm = Arc::new(SwcSourceMap::new(FilePathMapping::empty()));\n     let (src, mut src_map_buf) = {\n@@ -117,11 +117,11 @@ pub async fn minify(\n     };\n \n     let mut builder = CodeBuilder::default();\n-    if let Some(original_map) = source_maps {\n+    if let Some(original_map) = source_maps.as_ref() {\n         src_map_buf.shrink_to_fit();\n         builder.push_source(\n             &src.into(),\n-            Some(generate_js_source_map(cm, src_map_buf, original_map.to_resolved().await?).await?),\n+            Some(generate_js_source_map(cm, src_map_buf, Some(original_map)).await?),\n         );\n \n         write!("
        },
        {
            "sha": "f2e7f27757fab4081c11bfe5f6d61652d1727327",
            "filename": "turbopack/crates/turbopack-ecmascript/src/parse.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/1ba2577a47d96c7ccf02499397bc328c60ca9db9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1ba2577a47d96c7ccf02499397bc328c60ca9db9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs?ref=1ba2577a47d96c7ccf02499397bc328c60ca9db9",
            "patch": "@@ -30,7 +30,7 @@ use turbopack_core::{\n     error::PrettyPrintError,\n     issue::{Issue, IssueExt, IssueSeverity, IssueStage, OptionStyledString, StyledString},\n     source::Source,\n-    source_map::{utils::add_default_ignore_list, OptionStringifiedSourceMap},\n+    source_map::utils::add_default_ignore_list,\n     SOURCE_URL_PROTOCOL,\n };\n use turbopack_swc_utils::emitter::IssueEmitter;\n@@ -77,9 +77,9 @@ impl PartialEq for ParseResult {\n pub async fn generate_js_source_map(\n     files_map: Arc<swc_core::common::SourceMap>,\n     mappings: Vec<(BytePos, LineCol)>,\n-    original_source_map: ResolvedVc<OptionStringifiedSourceMap>,\n+    original_source_map: Option<&Rope>,\n ) -> Result<Rope> {\n-    let input_map = if let Some(original_source_map) = &*original_source_map.await? {\n+    let input_map = if let Some(original_source_map) = original_source_map {\n         Some(match sourcemap::decode(original_source_map.read())? {\n             sourcemap::DecodedMap::Regular(source_map) => source_map,\n             // swc only accepts flattened sourcemaps as input"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 35,
        "deletions": 32
    }
}