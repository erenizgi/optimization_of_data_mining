{
    "author": "acdlite",
    "message": "Fork Form implementation for Pages and App Router (#76498)\n\nThe Form component should not need to check at runtime whether it's\nrunning in Pages or App Router â€” this is a build-time condition.\n\nThe implementation is different enough that we might as well fork the\nimplementations at the module level.\n\nI used #73019 as a reference, since that PR did the same thing for Link.\n\nI have not changed anything in implementation itself; I'll leave that\nfor subsequent PRs. All I've done is duplicate the existing module, fix\nthe imports, and update the bundler configuration to resolve to the\nappropriate module. There should be no observable change in behavior.",
    "sha": "121306dd245d0730f0058652e7a7a40a99e7c446",
    "files": [
        {
            "sha": "f946645c7d8a43fa67fa7fb0e883b38f67a93916",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/121306dd245d0730f0058652e7a7a40a99e7c446/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/121306dd245d0730f0058652e7a7a40a99e7c446/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=121306dd245d0730f0058652e7a7a40a99e7c446",
            "patch": "@@ -208,6 +208,10 @@ pub async fn get_next_client_import_map(\n                 \"next/link\",\n                 request_to_import_mapping(project_path, \"next/dist/client/app-dir/link\"),\n             );\n+            import_map.insert_exact_alias(\n+                \"next/form\",\n+                request_to_import_mapping(project_path, \"next/dist/client/app-dir/form\"),\n+            );\n         }\n         ClientContextType::Fallback => {}\n         ClientContextType::Other => {}\n@@ -374,7 +378,11 @@ pub async fn get_next_server_import_map(\n             import_map.insert_exact_alias(\n                 \"next/link\",\n                 request_to_import_mapping(project_path, \"next/dist/client/app-dir/link\"),\n-            )\n+            );\n+            import_map.insert_exact_alias(\n+                \"next/form\",\n+                request_to_import_mapping(project_path, \"next/dist/client/app-dir/form\"),\n+            );\n         }\n         ServerContextType::Middleware { .. } | ServerContextType::Instrumentation { .. } => {}\n     }\n@@ -431,6 +439,7 @@ pub async fn get_next_edge_import_map(\n             \"next/headers\" => \"next/dist/api/headers\".to_string(),\n             \"next/image\" => \"next/dist/api/image\".to_string(),\n             \"next/link\" => \"next/dist/api/link\".to_string(),\n+            \"next/form\" => \"next/dist/api/form\".to_string(),\n             \"next/navigation\" => \"next/dist/api/navigation\".to_string(),\n             \"next/router\" => \"next/dist/api/router\".to_string(),\n             \"next/script\" => \"next/dist/api/script\".to_string(),"
        },
        {
            "sha": "af5d3aa4aa9b468c48ba187bae5da746b4781770",
            "filename": "packages/next/src/build/create-compiler-aliases.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/121306dd245d0730f0058652e7a7a40a99e7c446/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/121306dd245d0730f0058652e7a7a40a99e7c446/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts?ref=121306dd245d0730f0058652e7a7a40a99e7c446",
            "patch": "@@ -238,6 +238,7 @@ export function createAppRouterApiAliases(isServerOnlyLayer: boolean) {\n     head: 'next/dist/client/components/noop-head',\n     dynamic: 'next/dist/api/app-dynamic',\n     link: 'next/dist/client/app-dir/link',\n+    form: 'next/dist/client/app-dir/form',\n   }\n \n   if (isServerOnlyLayer) {"
        },
        {
            "sha": "c169f4216a7010ee10284752e4f3dda5d77f73c9",
            "filename": "packages/next/src/client/app-dir/form.tsx",
            "status": "added",
            "additions": 418,
            "deletions": 0,
            "changes": 418,
            "blob_url": "https://github.com/vercel/next.js/blob/121306dd245d0730f0058652e7a7a40a99e7c446/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Fform.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/121306dd245d0730f0058652e7a7a40a99e7c446/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Fform.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Fform.tsx?ref=121306dd245d0730f0058652e7a7a40a99e7c446",
            "patch": "@@ -0,0 +1,418 @@\n+'use client'\n+\n+import { useEffect, type HTMLProps, type FormEvent, useContext } from 'react'\n+import { addBasePath } from '../add-base-path'\n+import { useIntersection } from '../use-intersection'\n+import { useMergedRef } from '../use-merged-ref'\n+import {\n+  AppRouterContext,\n+  type AppRouterInstance,\n+} from '../../shared/lib/app-router-context.shared-runtime'\n+import { PrefetchKind } from '../components/router-reducer/router-reducer-types'\n+import { RouterContext } from '../../shared/lib/router-context.shared-runtime'\n+import type { NextRouter } from '../router'\n+\n+const DISALLOWED_FORM_PROPS = ['method', 'encType', 'target'] as const\n+\n+type HTMLFormProps = HTMLProps<HTMLFormElement>\n+type DisallowedFormProps = (typeof DISALLOWED_FORM_PROPS)[number]\n+\n+type InternalFormProps = {\n+  /**\n+   * `action` can be either a `string` or a function.\n+   * - If `action` is a string, it will be interpreted as a path or URL to navigate to when the form is submitted.\n+   *   The path will be prefetched when the form becomes visible.\n+   * - If `action` is a function, it will be called when the form is submitted. See the [React docs](https://react.dev/reference/react-dom/components/form#props) for more.\n+   */\n+  action: NonNullable<HTMLFormProps['action']>\n+  /**\n+   * Controls how the route specified by `action` is prefetched.\n+   * Any `<Form />` that is in the viewport (initially or through scroll) will be prefetched.\n+   * Prefetch can be disabled by passing `prefetch={false}`. Prefetching is only enabled in production.\n+   *\n+   * Options:\n+   * - `null` (default): For statically generated pages, this will prefetch the full React Server Component data. For dynamic pages, this will prefetch up to the nearest route segment with a [`loading.js`](https://nextjs.org/docs/app/api-reference/file-conventions/loading) file. If there is no loading file, it will not fetch the full tree to avoid fetching too much data.\n+   * - `false`: This will not prefetch any data.\n+   *\n+   * In pages dir, prefetching is not supported, and passing this prop will emit a warning.\n+   *\n+   * @defaultValue `null`\n+   */\n+  prefetch?: false | null\n+  /**\n+   * Whether submitting the form should replace the current `history` state instead of adding a new url into the stack.\n+   * Only valid if `action` is a string.\n+   *\n+   * @defaultValue `false`\n+   */\n+  replace?: boolean\n+  /**\n+   * Override the default scroll behavior when navigating.\n+   * Only valid if `action` is a string.\n+   *\n+   * @defaultValue `true`\n+   */\n+  scroll?: boolean\n+} & Omit<HTMLFormProps, 'action' | DisallowedFormProps>\n+\n+// `RouteInferType` is a stub here to avoid breaking `typedRoutes` when the type\n+// isn't generated yet. It will be replaced when the webpack plugin runs.\n+// eslint-disable-next-line @typescript-eslint/no-unused-vars\n+export type FormProps<RouteInferType = any> = InternalFormProps\n+\n+export default function Form({\n+  replace,\n+  scroll,\n+  prefetch: prefetchProp,\n+  ref: externalRef,\n+  ...props\n+}: FormProps) {\n+  const router = useAppOrPagesRouter()\n+\n+  const actionProp = props.action\n+  const isNavigatingForm = typeof actionProp === 'string'\n+\n+  // Validate `action`\n+  if (process.env.NODE_ENV === 'development') {\n+    if (isNavigatingForm) {\n+      checkActionUrl(actionProp, 'action')\n+    }\n+  }\n+\n+  // Validate `prefetch`\n+  if (process.env.NODE_ENV === 'development') {\n+    if (\n+      !(\n+        prefetchProp === undefined ||\n+        prefetchProp === false ||\n+        prefetchProp === null\n+      )\n+    ) {\n+      console.error('The `prefetch` prop of <Form> must be `false` or `null`')\n+    }\n+\n+    if (prefetchProp !== undefined) {\n+      if (!isAppRouter(router)) {\n+        console.error(\n+          'Passing `prefetch` to a <Form> has no effect in the pages directory.'\n+        )\n+      } else if (!isNavigatingForm) {\n+        console.error(\n+          'Passing `prefetch` to a <Form> whose `action` is a function has no effect.'\n+        )\n+      }\n+    }\n+  }\n+\n+  const prefetch =\n+    prefetchProp === false || prefetchProp === null ? prefetchProp : null\n+\n+  // Validate `scroll` and `replace`\n+  if (process.env.NODE_ENV === 'development') {\n+    if (!isNavigatingForm && (replace !== undefined || scroll !== undefined)) {\n+      console.error(\n+        'Passing `replace` or `scroll` to a <Form> whose `action` is a function has no effect.\\n' +\n+          'See the relevant docs to learn how to control this behavior for navigations triggered from actions:\\n' +\n+          '  `redirect()`       - https://nextjs.org/docs/app/api-reference/functions/redirect#parameters\\n' +\n+          '  `router.replace()` - https://nextjs.org/docs/app/api-reference/functions/use-router#userouter\\n'\n+      )\n+    }\n+  }\n+\n+  // Clean up any unsupported form props (and warn if present)\n+  for (const key of DISALLOWED_FORM_PROPS) {\n+    if (key in props) {\n+      if (process.env.NODE_ENV === 'development') {\n+        console.error(\n+          `<Form> does not support changing \\`${key}\\`. ` +\n+            (isNavigatingForm\n+              ? `If you'd like to use it to perform a mutation, consider making \\`action\\` a function instead.\\n` +\n+                `Learn more: https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations`\n+              : '')\n+        )\n+      }\n+      delete (props as Record<string, unknown>)[key]\n+    }\n+  }\n+\n+  const isPrefetchEnabled =\n+    // there is no notion of instant loading states in pages dir, so prefetching is pointless\n+    isAppRouter(router) &&\n+    // if we don't have an action path, we can't preload anything anyway.\n+    isNavigatingForm &&\n+    prefetch === null\n+\n+  const [setIntersectionRef, isVisible] = useIntersection({\n+    rootMargin: '200px',\n+    disabled: !isPrefetchEnabled,\n+  })\n+\n+  const ownRef = useMergedRef<HTMLFormElement>(\n+    setIntersectionRef,\n+    externalRef ?? null\n+  )\n+\n+  useEffect(() => {\n+    if (!isVisible || !isPrefetchEnabled) {\n+      return\n+    }\n+\n+    try {\n+      const prefetchKind = PrefetchKind.AUTO\n+      router.prefetch(actionProp, { kind: prefetchKind })\n+    } catch (err) {\n+      console.error(err)\n+    }\n+  }, [isPrefetchEnabled, isVisible, actionProp, prefetch, router])\n+\n+  if (!isNavigatingForm) {\n+    return <form {...props} ref={ownRef} />\n+  }\n+\n+  const actionHref = addBasePath(actionProp)\n+\n+  return (\n+    <form\n+      {...props}\n+      ref={ownRef}\n+      action={actionHref}\n+      onSubmit={(event) =>\n+        onFormSubmit(event, {\n+          router,\n+          actionHref,\n+          replace,\n+          scroll,\n+          onSubmit: props.onSubmit,\n+        })\n+      }\n+    />\n+  )\n+}\n+\n+function onFormSubmit(\n+  event: FormEvent<HTMLFormElement>,\n+  {\n+    actionHref,\n+    onSubmit,\n+    replace,\n+    scroll,\n+    router,\n+  }: {\n+    actionHref: string\n+    onSubmit: FormProps['onSubmit']\n+    replace: FormProps['replace']\n+    scroll: FormProps['scroll']\n+    router: SomeRouter\n+  }\n+) {\n+  if (typeof onSubmit === 'function') {\n+    onSubmit(event)\n+\n+    // if the user called event.preventDefault(), do nothing.\n+    // (this matches what Link does for `onClick`)\n+    if (event.defaultPrevented) {\n+      return\n+    }\n+  }\n+\n+  const formElement = event.currentTarget\n+  const submitter = (event.nativeEvent as SubmitEvent).submitter\n+\n+  let action = actionHref\n+\n+  if (submitter) {\n+    if (process.env.NODE_ENV === 'development') {\n+      // the way server actions are encoded (e.g. `formMethod=\"post\")\n+      // causes some unnecessary dev-mode warnings from `hasUnsupportedSubmitterAttributes`.\n+      // we'd bail out anyway, but we just do it silently.\n+      if (hasReactServerActionAttributes(submitter)) {\n+        return\n+      }\n+    }\n+\n+    if (hasUnsupportedSubmitterAttributes(submitter)) {\n+      return\n+    }\n+\n+    // client actions have `formAction=\"javascript:...\"`. We obviously can't prefetch/navigate to that.\n+    if (hasReactClientActionAttributes(submitter)) {\n+      return\n+    }\n+\n+    // If the submitter specified an alternate formAction,\n+    // use that URL instead -- this is what a native form would do.\n+    // NOTE: `submitter.formAction` is unreliable, because it will give us `location.href` if it *wasn't* set\n+    // NOTE: this should not have `basePath` added, because we can't add it before hydration\n+    const submitterFormAction = submitter.getAttribute('formAction')\n+    if (submitterFormAction !== null) {\n+      if (process.env.NODE_ENV === 'development') {\n+        checkActionUrl(submitterFormAction, 'formAction')\n+      }\n+      action = submitterFormAction\n+    }\n+  }\n+\n+  let targetUrl: URL\n+  try {\n+    // NOTE: It might be more correct to resolve URLs relative to `document.baseURI`,\n+    // but we already do it relative to `location.href` elsewhere:\n+    //  (see e.g. https://github.com/vercel/next.js/blob/bb0e6722f87ceb2d43015f5b8a413d0072f2badf/packages/next/src/client/components/app-router.tsx#L146)\n+    // so it's better to stay consistent.\n+    const base = window.location.href\n+    targetUrl = new URL(action, base)\n+  } catch (err) {\n+    throw new Error(`Cannot parse form action \"${action}\" as a URL`, {\n+      cause: err,\n+    })\n+  }\n+  if (targetUrl.searchParams.size) {\n+    // url-encoded HTML forms *overwrite* any search params in the `action` url:\n+    //\n+    //  \"Let `query` be the result of running the application/x-www-form-urlencoded serializer [...]\"\n+    //  \"Set parsed action's query component to `query`.\"\n+    //   https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#submit-mutate-action\n+    //\n+    // We need to match that.\n+    // (note that all other parts of the URL, like `hash`, are preserved)\n+    targetUrl.search = ''\n+  }\n+\n+  const formData = new FormData(formElement)\n+\n+  for (let [name, value] of formData) {\n+    if (typeof value !== 'string') {\n+      // For file inputs, the native browser behavior is to use the filename as the value instead:\n+      //\n+      //   \"If entry's value is a File object, then let value be entry's value's name. Otherwise, let value be entry's value.\"\n+      //   https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#converting-an-entry-list-to-a-list-of-name-value-pairs\n+      //\n+      if (process.env.NODE_ENV === 'development') {\n+        console.warn(\n+          `<Form> only supports file inputs if \\`action\\` is a function. File inputs cannot be used if \\`action\\` is a string, ` +\n+            `because files cannot be encoded as search params.`\n+        )\n+      }\n+      value = value.name\n+    }\n+\n+    targetUrl.searchParams.append(name, value)\n+  }\n+\n+  // Finally, no more reasons for bailing out.\n+  event.preventDefault()\n+\n+  const method = replace ? 'replace' : 'push'\n+  const targetHref = targetUrl.href\n+  if (isAppRouter(router)) {\n+    router[method](targetHref, { scroll })\n+  } else {\n+    // TODO(form): Make this use a transition so that pending states work\n+    //\n+    // Unlike the app router, pages router doesn't use startTransition,\n+    // and can't easily be wrapped in one because of implementation details\n+    // (e.g. it doesn't use any react state)\n+    // But it's important to have this wrapped in a transition because\n+    // pending states from e.g. `useFormStatus` rely on that.\n+    // So this needs some follow up work.\n+    router[method](targetHref, undefined, { scroll })\n+  }\n+}\n+\n+type SomeRouter = AppRouterInstance | NextRouter\n+\n+function isAppRouter(router: SomeRouter): router is AppRouterInstance {\n+  return !('asPath' in router)\n+}\n+\n+function useAppOrPagesRouter(): SomeRouter {\n+  const pagesRouter = useContext(RouterContext)\n+  const appRouter = useContext(AppRouterContext)\n+  if (pagesRouter) {\n+    return pagesRouter\n+  } else {\n+    // We're in the app directory if there is no pages router.\n+    return appRouter!\n+  }\n+}\n+\n+function checkActionUrl(action: string, source: 'action' | 'formAction') {\n+  const aPropName = source === 'action' ? `an \\`action\\`` : `a \\`formAction\\``\n+\n+  let testUrl: URL\n+  try {\n+    testUrl = new URL(action, 'http://n')\n+  } catch (err) {\n+    console.error(\n+      `<Form> received ${aPropName} that cannot be parsed as a URL: \"${action}\".`\n+    )\n+    return\n+  }\n+\n+  // url-encoded HTML forms ignore any queryparams in the `action` url. We need to match that.\n+  if (testUrl.searchParams.size) {\n+    console.warn(\n+      `<Form> received ${aPropName} that contains search params: \"${action}\". This is not supported, and they will be ignored. ` +\n+        `If you need to pass in additional search params, use an \\`<input type=\"hidden\" />\\` instead.`\n+    )\n+  }\n+}\n+\n+const isSupportedEncType = (value: string) =>\n+  value === 'application/x-www-form-urlencoded'\n+const isSupportedMethod = (value: string) => value === 'get'\n+const isSupportedTarget = (value: string) => value === '_self'\n+\n+function hasUnsupportedSubmitterAttributes(submitter: HTMLElement): boolean {\n+  // A submitter can override `encType` for the form.\n+  const formEncType = submitter.getAttribute('formEncType')\n+  if (formEncType !== null && !isSupportedEncType(formEncType)) {\n+    if (process.env.NODE_ENV === 'development') {\n+      console.error(\n+        `<Form>'s \\`encType\\` was set to an unsupported value via \\`formEncType=\"${formEncType}\"\\`. ` +\n+          `This will disable <Form>'s navigation functionality. If you need this, use a native <form> element instead.`\n+      )\n+    }\n+    return true\n+  }\n+\n+  // A submitter can override `method` for the form.\n+  const formMethod = submitter.getAttribute('formMethod')\n+  if (formMethod !== null && !isSupportedMethod(formMethod)) {\n+    if (process.env.NODE_ENV === 'development') {\n+      console.error(\n+        `<Form>'s \\`method\\` was set to an unsupported value via \\`formMethod=\"${formMethod}\"\\`. ` +\n+          `This will disable <Form>'s navigation functionality. If you need this, use a native <form> element instead.`\n+      )\n+    }\n+    return true\n+  }\n+\n+  // A submitter can override `target` for the form.\n+  const formTarget = submitter.getAttribute('formTarget')\n+  if (formTarget !== null && !isSupportedTarget(formTarget)) {\n+    if (process.env.NODE_ENV === 'development') {\n+      console.error(\n+        `<Form>'s \\`target\\` was set to an unsupported value via \\`formTarget=\"${formTarget}\"\\`. ` +\n+          `This will disable <Form>'s navigation functionality. If you need this, use a native <form> element instead.`\n+      )\n+    }\n+    return true\n+  }\n+\n+  return false\n+}\n+\n+function hasReactServerActionAttributes(submitter: HTMLElement) {\n+  // https://github.com/facebook/react/blob/942eb80381b96f8410eab1bef1c539bed1ab0eb1/packages/react-client/src/ReactFlightReplyClient.js#L931-L934\n+  const name = submitter.getAttribute('name')\n+  return (\n+    name && (name.startsWith('$ACTION_ID_') || name.startsWith('$ACTION_REF_'))\n+  )\n+}\n+\n+function hasReactClientActionAttributes(submitter: HTMLElement) {\n+  // CSR: https://github.com/facebook/react/blob/942eb80381b96f8410eab1bef1c539bed1ab0eb1/packages/react-dom-bindings/src/client/ReactDOMComponent.js#L482-L487\n+  // SSR: https://github.com/facebook/react/blob/942eb80381b96f8410eab1bef1c539bed1ab0eb1/packages/react-dom-bindings/src/client/ReactDOMComponent.js#L2401\n+  const action = submitter.getAttribute('formAction')\n+  return action && /\\s*javascript:/i.test(action)\n+}"
        }
    ],
    "stats": {
        "total": 430,
        "additions": 429,
        "deletions": 1
    }
}