{
    "author": "sokra",
    "message": "Turbopack: use unsigned values for follower and upper edges (#79489)\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that you follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the PR.\n- Read the Docs Contribution Guide to ensure your contribution follows the docs guidelines: https://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc https://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See https://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See: https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature request has been accepted for implementation before opening a PR. (A discussion must be opened, see https://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added (https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to understand the PR)\n- When linking to a Slack thread, you might want to share details of the conclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic behind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "e4d18b05632d8dbfee18d5572dfa385e00929dee",
    "files": [
        {
            "sha": "fbaddf6e39dde5c6110103e84919fa6c87af427c",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/aggregation_update.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 20,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/e4d18b05632d8dbfee18d5572dfa385e00929dee/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Faggregation_update.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e4d18b05632d8dbfee18d5572dfa385e00929dee/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Faggregation_update.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Faggregation_update.rs?ref=e4d18b05632d8dbfee18d5572dfa385e00929dee",
            "patch": "@@ -1304,10 +1304,6 @@ impl AggregationUpdateQueue {\n                         follower_in_upper = true;\n                         return None;\n                     };\n-                    if old < 0 {\n-                        follower_in_upper = true;\n-                        return Some(old);\n-                    }\n                     if old == 1 {\n                         keep_upper = true;\n                         removed_uppers.push(upper_id);\n@@ -1382,10 +1378,6 @@ impl AggregationUpdateQueue {\n                             inner_in_upper = true;\n                             return None;\n                         };\n-                        if old < 0 {\n-                            inner_in_upper = true;\n-                            return Some(old);\n-                        }\n                         if old == 1 {\n                             removed_follower = true;\n                             return None;\n@@ -1409,7 +1401,7 @@ impl AggregationUpdateQueue {\n                             task: lost_follower_id,\n                         });\n                     }\n-                    // notify uppers about new follower\n+                    // notify uppers about lost follower\n                     if !upper_ids.is_empty() {\n                         self.push(AggregationUpdateJob::InnerOfUppersLostFollower {\n                             upper_ids,\n@@ -1471,10 +1463,6 @@ impl AggregationUpdateQueue {\n                         follower_in_upper = true;\n                         return None;\n                     };\n-                    if old < 0 {\n-                        follower_in_upper = true;\n-                        return Some(old);\n-                    }\n                     if old == 1 {\n                         remove_upper = true;\n                         return None;\n@@ -1543,10 +1531,6 @@ impl AggregationUpdateQueue {\n                             inner_in_upper = true;\n                             return None;\n                         };\n-                        if old < 0 {\n-                            inner_in_upper = true;\n-                            return Some(old);\n-                        }\n                         if old == 1 {\n                             removed_follower = true;\n                             return None;\n@@ -1570,7 +1554,7 @@ impl AggregationUpdateQueue {\n                             task: lost_follower_id,\n                         });\n                     }\n-                    // notify uppers about new follower\n+                    // notify uppers about lost follower\n                     if !upper_ids.is_empty() {\n                         self.push(AggregationUpdateJob::InnerOfUppersLostFollower {\n                             upper_ids,\n@@ -2461,7 +2445,7 @@ const MAX_YIELD_DURATION: Duration = Duration::from_millis(1);\n const MAX_RETRIES: u16 = 10000;\n \n /// Retry the passed function for a few milliseconds, while yielding to other threads.\n-/// Returns an error if the function was not ablue to complete and the timeout was reached.\n+/// Returns an error if the function was not able to complete and the timeout was reached.\n ///\n /// Each graph modification will only lock one or two tasks at a time, but updates usually also\n /// require follow-up updates to connected tasks. So an update will \"slowly\" propagate through the\n@@ -2472,7 +2456,7 @@ const MAX_RETRIES: u16 = 10000;\n /// update yet). So we will retry (with this method) removals until the thing is there. So this is\n /// basically a busy loop that waits for the \"add\" update to complete. If the busy loop is not\n /// sucessful, the update is added to the end of the queue again. This is important as the \"add\"\n-/// update might even be in the curreent thread and in the same queue. If that's the case yielding\n+/// update might even be in the current thread and in the same queue. If that's the case yielding\n /// won't help and the update need to be requeued.\n fn retry_loop(mut f: impl FnMut() -> ControlFlow<()>) -> Result<(), RetryTimeout> {\n     let mut time: Option<Instant> = None;"
        },
        {
            "sha": "cf700d34d9b6eeeddc3b2624f9b6ffde0fefa6a9",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/storage.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e4d18b05632d8dbfee18d5572dfa385e00929dee/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e4d18b05632d8dbfee18d5572dfa385e00929dee/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs?ref=e4d18b05632d8dbfee18d5572dfa385e00929dee",
            "patch": "@@ -137,7 +137,7 @@ pub struct InnerStorageSnapshot {\n     aggregation_number: OptionStorage<AggregationNumber>,\n     output_dependent: AutoMapStorage<TaskId, ()>,\n     output: OptionStorage<OutputValue>,\n-    upper: AutoMapStorage<TaskId, i32>,\n+    upper: AutoMapStorage<TaskId, u32>,\n     dynamic: DynamicStorage,\n     pub meta_modified: bool,\n     pub data_modified: bool,\n@@ -205,7 +205,7 @@ pub struct InnerStorage {\n     aggregation_number: OptionStorage<AggregationNumber>,\n     output_dependent: AutoMapStorage<TaskId, ()>,\n     output: OptionStorage<OutputValue>,\n-    upper: AutoMapStorage<TaskId, i32>,\n+    upper: AutoMapStorage<TaskId, u32>,\n     dynamic: DynamicStorage,\n     state: InnerStorageState,\n }"
        },
        {
            "sha": "15ead668e982ac2505ab67e5ebe0f5667f536f87",
            "filename": "turbopack/crates/turbo-tasks-backend/src/data.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e4d18b05632d8dbfee18d5572dfa385e00929dee/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e4d18b05632d8dbfee18d5572dfa385e00929dee/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs?ref=e4d18b05632d8dbfee18d5572dfa385e00929dee",
            "patch": "@@ -421,11 +421,11 @@ pub enum CachedDataItem {\n     },\n     Follower {\n         task: TaskId,\n-        value: i32,\n+        value: u32,\n     },\n     Upper {\n         task: TaskId,\n-        value: i32,\n+        value: u32,\n     },\n \n     // Aggregated Data"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 8,
        "deletions": 24
    }
}