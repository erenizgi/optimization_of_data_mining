{
    "author": "sokra",
    "message": "Turbopack: make GraphTraversal deterministically calling all nodes before erroring (#88119)\n\n### What?\n\nThe graph traversal used to early exit when there are errors. This leads to cycles to continuously executing the graph traversal to discover more task one by one. This leads to bad incremental performance.",
    "sha": "2b04d2eecd5ac482157e8f69e781424d9d00b8e0",
    "files": [
        {
            "sha": "87a1f6cc188b3446c49eac3a380671b1b3621b1f",
            "filename": "turbopack/crates/turbo-tasks/src/graph/control_flow.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2b04d2eecd5ac482157e8f69e781424d9d00b8e0/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fgraph%2Fcontrol_flow.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2b04d2eecd5ac482157e8f69e781424d9d00b8e0/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fgraph%2Fcontrol_flow.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fgraph%2Fcontrol_flow.rs?ref=2b04d2eecd5ac482157e8f69e781424d9d00b8e0",
            "patch": "@@ -8,6 +8,4 @@ pub enum VisitControlFlow {\n     /// The edge is excluded, and the traversal should not continue on the outgoing edges of the\n     /// given node.\n     Exclude,\n-    /// The traversal should abort and return immediately.\n-    Abort,\n }"
        },
        {
            "sha": "5cca3d30ae0098b212db2370fc79c74c2c81755a",
            "filename": "turbopack/crates/turbo-tasks/src/graph/graph_traversal.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 16,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/2b04d2eecd5ac482157e8f69e781424d9d00b8e0/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fgraph%2Fgraph_traversal.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2b04d2eecd5ac482157e8f69e781424d9d00b8e0/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fgraph%2Fgraph_traversal.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fgraph%2Fgraph_traversal.rs?ref=2b04d2eecd5ac482157e8f69e781424d9d00b8e0",
            "patch": "@@ -42,7 +42,6 @@ where\n         Impl: Send,\n     {\n         let mut futures = FuturesUnordered::new();\n-        let mut is_abort = false;\n \n         // Populate `futures` with all the roots, `root_nodes` isn't required to be `Send`, so this\n         // has to happen outside of the future. We could require `root_nodes` to be `Send` in the\n@@ -62,18 +61,11 @@ where\n                 VisitControlFlow::Exclude => {\n                     // do nothing\n                 }\n-                VisitControlFlow::Abort => {\n-                    // this must be returned inside the `async` block below so that it's part of the\n-                    // returned future\n-                    is_abort = true;\n-                }\n             }\n         }\n \n         async move {\n-            if is_abort {\n-                return GraphTraversalResult::Aborted;\n-            }\n+            let mut result = Ok(());\n             loop {\n                 match futures.next().await {\n                     Some((parent_node, span, Ok(edges))) => {\n@@ -94,17 +86,14 @@ where\n                                 VisitControlFlow::Exclude => {\n                                     // do nothing\n                                 }\n-                                VisitControlFlow::Abort => {\n-                                    return GraphTraversalResult::Aborted;\n-                                }\n                             }\n                         }\n                     }\n                     Some((_, _, Err(err))) => {\n-                        return GraphTraversalResult::Completed(Err(err));\n+                        result = Err(err);\n                     }\n                     None => {\n-                        return GraphTraversalResult::Completed(Ok(self));\n+                        return GraphTraversalResult::Completed(result.map(|()| self));\n                     }\n                 }\n             }\n@@ -114,14 +103,12 @@ where\n \n pub enum GraphTraversalResult<Completed> {\n     Completed(Completed),\n-    Aborted,\n }\n \n impl<Completed> GraphTraversalResult<Completed> {\n     pub fn completed(self) -> Completed {\n         match self {\n             GraphTraversalResult::Completed(completed) => completed,\n-            GraphTraversalResult::Aborted => panic!(\"Graph traversal was aborted\"),\n         }\n     }\n }"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 3,
        "deletions": 18
    }
}