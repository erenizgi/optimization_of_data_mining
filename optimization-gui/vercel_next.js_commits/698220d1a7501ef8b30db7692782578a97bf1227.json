{
    "author": "unstubbable",
    "message": "Fix runtime error in `writeConfigurationDefaults` (#76106)\n\nFollow-up for #74674\n\nWhen running `pnpm next build` or `pnpm next dev` with a test app in the\nNext.js repo, we patch the app's `tsconfig.json` to exclude the test\nfiles from the program, because those are already covered by the root\n`tsconfig.json`.\n\nThe code to suppress logging this action had a bug where we tried to\nremove the action from the list of `requiredActions` even if it wasn't\nadded, resulting in the following runtime error:\n\n```\nCannot read properties of undefined (reading 'includes')\n```\n\nThis could happen when the `requiredActions` array was empty but the\n`suggestedActions` array was not.",
    "sha": "698220d1a7501ef8b30db7692782578a97bf1227",
    "files": [
        {
            "sha": "cda8fcb658ad159059b4d87fec5e5cbb22ed0c9a",
            "filename": "packages/next/src/lib/typescript/writeConfigurationDefaults.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 16,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/698220d1a7501ef8b30db7692782578a97bf1227/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/698220d1a7501ef8b30db7692782578a97bf1227/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts?ref=698220d1a7501ef8b30db7692782578a97bf1227",
            "patch": "@@ -136,6 +136,9 @@ export function getRequiredConfiguration(\n   return res\n }\n \n+const localDevTestFilesExcludeAction =\n+  'NEXT_PRIVATE_LOCAL_DEV_TEST_FILES_EXCLUDE'\n+\n export async function writeConfigurationDefaults(\n   ts: typeof import('typescript'),\n   tsConfigPath: string,\n@@ -328,27 +331,14 @@ export async function writeConfigurationDefaults(\n     }\n \n     if (hasUpdates) {\n-      requiredActions.push(\n-        'Local development only: Excluded test files from coverage'\n-      )\n+      requiredActions.push(localDevTestFilesExcludeAction)\n     }\n   }\n \n   if (suggestedActions.length < 1 && requiredActions.length < 1) {\n     return\n   }\n \n-  if (process.env.NEXT_PRIVATE_LOCAL_DEV) {\n-    // remove it from the required actions if it exists\n-    if (\n-      requiredActions[requiredActions.length - 1].includes(\n-        'Local development only'\n-      )\n-    ) {\n-      requiredActions.pop()\n-    }\n-  }\n-\n   await fs.writeFile(\n     tsConfigPath,\n     CommentJson.stringify(userTsConfig, null, 2) + os.EOL\n@@ -386,14 +376,20 @@ export async function writeConfigurationDefaults(\n     Log.info('')\n   }\n \n-  if (requiredActions.length) {\n+  const requiredActionsToBeLogged = process.env.NEXT_PRIVATE_LOCAL_DEV\n+    ? requiredActions.filter(\n+        (action) => action !== localDevTestFilesExcludeAction\n+      )\n+    : requiredActions\n+\n+  if (requiredActionsToBeLogged.length) {\n     Log.info(\n       `The following ${white('mandatory changes')} were made to your ${cyan(\n         'tsconfig.json'\n       )}:\\n`\n     )\n \n-    requiredActions.forEach((action) => Log.info(`\\t- ${action}`))\n+    requiredActionsToBeLogged.forEach((action) => Log.info(`\\t- ${action}`))\n \n     Log.info('')\n   }"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 12,
        "deletions": 16
    }
}