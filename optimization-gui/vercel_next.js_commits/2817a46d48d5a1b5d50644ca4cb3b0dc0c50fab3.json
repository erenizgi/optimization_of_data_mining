{
    "author": "bgw",
    "message": "Turbopack: Split DynamicEqHash trait into smaller traits in a separate re-usable crate (#81741)\n\nI originally split this off to support #81742, but I ended up rewriting that PR to not depend on this...\n\nHowever, I think this is still a code quality improvement, so I'm publishing the PR anyways.\n\nA few notable changes:\n\n- This is now three traits (`DynPartialEq`, `DynEq`, and `DynHash`) instead of one (`DynamicEqHash`)\n- The `Dyn` naming instead of `Dynamic` matches the more common Rust convention.\n- [Trait upcasting is finally stable!](https://blog.rust-lang.org/2025/04/03/Rust-1.86.0/#trait-upcasting) Remove the `.as_any()` idiom. Be very careful with the explicit derefs.\n- Fix a bug where the type id was getting added to the hash state twice (once by the `Hash` impl, and a second time by the `DynHash` impl).\n- The `HasherMut` struct isn't really needed, as you can use a `&mut &mut Hasher` instead to work around these dyn compatibility issues in the stdlib.\n\nAnd finally, `MagicAny` is ported to use these `Dyn` traits to dedupe some logic.",
    "sha": "2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
    "files": [
        {
            "sha": "84a35c8a25e7ce9e88d7934e215cfd8881384a20",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -9107,6 +9107,10 @@ dependencies = [\n  \"utf-8\",\n ]\n \n+[[package]]\n+name = \"turbo-dyn-eq-hash\"\n+version = \"0.0.1\"\n+\n [[package]]\n name = \"turbo-esregex\"\n version = \"0.1.0\"\n@@ -9224,6 +9228,7 @@ dependencies = [\n  \"tokio-util\",\n  \"tracing\",\n  \"triomphe 0.1.12\",\n+ \"turbo-dyn-eq-hash\",\n  \"turbo-rcstr\",\n  \"turbo-tasks-build\",\n  \"turbo-tasks-hash\","
        },
        {
            "sha": "7a9e77536adfcf507f083ab94296ea3a5746b844",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -257,6 +257,7 @@ next-custom-transforms = { path = \"crates/next-custom-transforms\" }\n auto-hash-map = { path = \"turbopack/crates/turbo-tasks-auto-hash-map\" }\n turbo-prehash = { path = \"turbopack/crates/turbo-prehash\" }\n turbo-rcstr = { path = \"turbopack/crates/turbo-rcstr\" }\n+turbo-dyn-eq-hash = { path = \"turbopack/crates/turbo-dyn-eq-hash\" }\n turbo-esregex = { path = \"turbopack/crates/turbo-esregex\" }\n turbo-persistence = { path = \"turbopack/crates/turbo-persistence\" }\n turbo-tasks-malloc = { path = \"turbopack/crates/turbo-tasks-malloc\", default-features = false }"
        },
        {
            "sha": "f07e6d772e668935995caf6fb35cadcb39a53117",
            "filename": "turbopack/crates/turbo-dyn-eq-hash/Cargo.toml",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-dyn-eq-hash%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-dyn-eq-hash%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-dyn-eq-hash%2FCargo.toml?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -0,0 +1,14 @@\n+[package]\n+name = \"turbo-dyn-eq-hash\"\n+version = \"0.0.1\"\n+description = \"TBD\"\n+license = \"MIT\"\n+edition = \"2024\"\n+\n+[lib]\n+bench = false\n+\n+[lints]\n+workspace = true\n+\n+[dependencies]"
        },
        {
            "sha": "e12027e6959061811c841fba2d37044d45745e8e",
            "filename": "turbopack/crates/turbo-dyn-eq-hash/src/lib.rs",
            "status": "added",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-dyn-eq-hash%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-dyn-eq-hash%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-dyn-eq-hash%2Fsrc%2Flib.rs?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -0,0 +1,70 @@\n+use std::{\n+    any::{Any, TypeId},\n+    hash::{Hash, Hasher},\n+};\n+\n+/// A dynamic-dispatch version of the [`PartialEq`] trait. Implemented for every type that\n+/// implements [`Any`] + [`PartialEq`].\n+pub trait DynPartialEq: Any {\n+    fn dyn_partial_eq(&self, other: &dyn Any) -> bool;\n+}\n+\n+impl<T: Any + PartialEq> DynPartialEq for T {\n+    fn dyn_partial_eq(&self, other: &dyn Any) -> bool {\n+        other\n+            .downcast_ref::<Self>()\n+            .map(|other| PartialEq::eq(self, other))\n+            .unwrap_or(false)\n+    }\n+}\n+\n+#[macro_export]\n+macro_rules! impl_partial_eq_for_dyn {\n+    ($ty:ty) => {\n+        impl ::std::cmp::PartialEq for $ty {\n+            fn eq(&self, other: &Self) -> bool {\n+                $crate::DynPartialEq::dyn_partial_eq(self, other as &dyn ::std::any::Any)\n+            }\n+        }\n+    };\n+}\n+\n+/// A dynamic-dispatch version of the [`Eq`] trait. Implemented for every type that implements\n+/// [`Any`] + [`Eq`].\n+pub trait DynEq: DynPartialEq {}\n+\n+impl<T: Any + Eq> DynEq for T {}\n+\n+#[macro_export]\n+macro_rules! impl_eq_for_dyn {\n+    ($ty:ty) => {\n+        impl ::std::cmp::Eq for $ty {}\n+    };\n+}\n+\n+/// A dynamic-dispatch version of the [`Hash`] trait. Implemented for every type that implements\n+/// [`Any`] + [`Hash`].\n+///\n+/// The `TypeId::of::<Self>()` value is included in the resulting hash, so the hash generated by\n+/// `DynEqHash` will not match the hash generated by the underlying `Hash` implementation. In other\n+/// words, the hash of `T` will not match the hash of `T as dyn SomeDynHashTrait`.\n+pub trait DynHash {\n+    fn dyn_hash(&self, state: &mut dyn Hasher);\n+}\n+\n+impl<T: Any + Hash> DynHash for T {\n+    fn dyn_hash(&self, mut state: &mut dyn Hasher) {\n+        Hash::hash(&(TypeId::of::<Self>(), self), &mut state);\n+    }\n+}\n+\n+#[macro_export]\n+macro_rules! impl_hash_for_dyn {\n+    ($ty:ty) => {\n+        impl ::std::hash::Hash for $ty {\n+            fn hash<H: ::std::hash::Hasher>(&self, state: &mut H) {\n+                $crate::DynHash::dyn_hash(self, state as &mut dyn (::std::hash::Hasher))\n+            }\n+        }\n+    };\n+}"
        },
        {
            "sha": "f6cea48139d9eb8c6ed2f9c36a8fc2428a349392",
            "filename": "turbopack/crates/turbo-tasks-fs/src/invalidation.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 5,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Finvalidation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Finvalidation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Finvalidation.rs?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -1,4 +1,5 @@\n use std::{\n+    any::Any,\n     fmt::{Display, Formatter},\n     hash::Hash,\n };\n@@ -36,12 +37,12 @@ impl InvalidationReasonKind for WatchChangeKind {\n         reasons: &FxIndexSet<StaticOrArc<dyn InvalidationReason>>,\n         f: &mut Formatter<'_>,\n     ) -> std::fmt::Result {\n+        let first_reason: &dyn InvalidationReason = &*reasons[0];\n         write!(\n             f,\n             \"{} files changed ({}, ...)\",\n             reasons.len(),\n-            reasons[0]\n-                .as_any()\n+            (first_reason as &dyn Any)\n                 .downcast_ref::<WatchChange>()\n                 .unwrap()\n                 .path\n@@ -81,7 +82,10 @@ impl InvalidationReasonKind for WatchStartKind {\n         reasons: &FxIndexSet<StaticOrArc<dyn InvalidationReason>>,\n         f: &mut Formatter<'_>,\n     ) -> std::fmt::Result {\n-        let example = reasons[0].as_any().downcast_ref::<WatchStart>().unwrap();\n+        let first_reason: &dyn InvalidationReason = &*reasons[0];\n+        let example = (first_reason as &dyn Any)\n+            .downcast_ref::<WatchStart>()\n+            .unwrap();\n         write!(\n             f,\n             \"{} items started watching (e.g. {} in {})\",\n@@ -126,7 +130,10 @@ impl InvalidationReasonKind for InitializeKind {\n         reasons: &FxIndexSet<StaticOrArc<dyn InvalidationReason>>,\n         f: &mut Formatter<'_>,\n     ) -> std::fmt::Result {\n-        let example = reasons[0].as_any().downcast_ref::<Initialize>().unwrap();\n+        let first_reason: &dyn InvalidationReason = &*reasons[0];\n+        let example = (first_reason as &dyn Any)\n+            .downcast_ref::<Initialize>()\n+            .unwrap();\n         write!(\n             f,\n             \"{} items invalidated as part of project or filesystem initialization ({}, ...)\",\n@@ -166,11 +173,15 @@ impl InvalidationReasonKind for WriteKind {\n         reasons: &FxIndexSet<StaticOrArc<dyn InvalidationReason>>,\n         f: &mut Formatter<'_>,\n     ) -> std::fmt::Result {\n+        let first_reason: &dyn InvalidationReason = &*reasons[0];\n         write!(\n             f,\n             \"{} files written ({}, ...)\",\n             reasons.len(),\n-            reasons[0].as_any().downcast_ref::<Write>().unwrap().path\n+            (first_reason as &dyn Any)\n+                .downcast_ref::<Write>()\n+                .unwrap()\n+                .path\n         )\n     }\n }"
        },
        {
            "sha": "a9fe7e3826c865b5e4bd5f8a2316f28ce171dd79",
            "filename": "turbopack/crates/turbo-tasks-fs/src/watcher.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fwatcher.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fwatcher.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fwatcher.rs?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -1,4 +1,5 @@\n use std::{\n+    any::Any,\n     fmt,\n     mem::take,\n     path::{Path, PathBuf},\n@@ -616,12 +617,12 @@ impl InvalidationReasonKind for InvalidateRescanKind {\n         reasons: &FxIndexSet<StaticOrArc<dyn InvalidationReason>>,\n         f: &mut fmt::Formatter<'_>,\n     ) -> fmt::Result {\n+        let first_reason: &dyn InvalidationReason = &*reasons[0];\n         write!(\n             f,\n             \"{} items in filesystem invalidated due to notify::Watcher rescan event ({}, ...)\",\n             reasons.len(),\n-            reasons[0]\n-                .as_any()\n+            (first_reason as &dyn Any)\n                 .downcast_ref::<InvalidateRescan>()\n                 .unwrap()\n                 .path"
        },
        {
            "sha": "3cdf94702e8bb053db78360fd35990987e2f37d5",
            "filename": "turbopack/crates/turbo-tasks/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -48,6 +48,7 @@ tokio = { workspace = true, features = [\"full\"] }\n tokio-util = { workspace = true }\n tracing = { workspace = true }\n triomphe = { workspace = true, features = [\"unsize\", \"unstable\"] }\n+turbo-dyn-eq-hash = { workspace = true }\n turbo-rcstr = { workspace = true }\n turbo-tasks-hash = { workspace = true }\n turbo-tasks-macros = { workspace = true }"
        },
        {
            "sha": "02132dc60ed2497686292b6644deb4be596d5b32",
            "filename": "turbopack/crates/turbo-tasks/src/invalidation.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 48,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Finvalidation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Finvalidation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Finvalidation.rs?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -1,7 +1,6 @@\n use std::{\n-    any::{Any, TypeId},\n     fmt::Display,\n-    hash::{Hash, Hasher},\n+    hash::Hash,\n     mem::replace,\n     sync::{Arc, Weak},\n };\n@@ -10,10 +9,12 @@ use anyhow::Result;\n use indexmap::map::Entry;\n use serde::{Deserialize, Serialize, de::Visitor};\n use tokio::runtime::Handle;\n+use turbo_dyn_eq_hash::{\n+    DynEq, DynHash, impl_eq_for_dyn, impl_hash_for_dyn, impl_partial_eq_for_dyn,\n+};\n \n use crate::{\n     FxIndexMap, FxIndexSet, TaskId, TurboTasksApi,\n-    magic_any::HasherMut,\n     manager::{current_task, mark_invalidator, with_turbo_tasks},\n     trace::TraceRawVcs,\n     util::StaticOrArc,\n@@ -138,34 +139,11 @@ impl<'de> Deserialize<'de> for Invalidator {\n     }\n }\n \n-pub trait DynamicEqHash {\n-    fn as_any(&self) -> &dyn Any;\n-    fn dyn_eq(&self, other: &dyn Any) -> bool;\n-    fn dyn_hash(&self, state: &mut dyn Hasher);\n-}\n-\n-impl<T: Any + PartialEq + Eq + Hash> DynamicEqHash for T {\n-    fn as_any(&self) -> &dyn Any {\n-        self\n-    }\n-\n-    fn dyn_eq(&self, other: &dyn Any) -> bool {\n-        other\n-            .downcast_ref::<Self>()\n-            .map(|other| self.eq(other))\n-            .unwrap_or(false)\n-    }\n-\n-    fn dyn_hash(&self, state: &mut dyn Hasher) {\n-        Hash::hash(&(TypeId::of::<Self>(), self), &mut HasherMut(state));\n-    }\n-}\n-\n /// A user-facing reason why a task was invalidated. This should only be used\n /// for invalidation that were triggered by the user.\n ///\n /// Reasons are deduplicated, so this need to implement [Eq] and [Hash]\n-pub trait InvalidationReason: DynamicEqHash + Display + Send + Sync + 'static {\n+pub trait InvalidationReason: DynEq + DynHash + Display + Send + Sync + 'static {\n     fn kind(&self) -> Option<StaticOrArc<dyn InvalidationReasonKind>> {\n         None\n     }\n@@ -176,7 +154,7 @@ pub trait InvalidationReason: DynamicEqHash + Display + Send + Sync + 'static {\n ///\n /// Reason kinds are used a hash map key, so this need to implement [Eq] and\n /// [Hash]\n-pub trait InvalidationReasonKind: DynamicEqHash + Send + Sync + 'static {\n+pub trait InvalidationReasonKind: DynEq + DynHash + Send + Sync + 'static {\n     /// Displays a description of multiple invalidation reasons of the same\n     /// kind. It is only called with two or more reasons.\n     fn fmt(\n@@ -186,27 +164,13 @@ pub trait InvalidationReasonKind: DynamicEqHash + Send + Sync + 'static {\n     ) -> std::fmt::Result;\n }\n \n-macro_rules! impl_eq_hash {\n-    ($ty:ty) => {\n-        impl PartialEq for $ty {\n-            fn eq(&self, other: &Self) -> bool {\n-                DynamicEqHash::dyn_eq(self, other.as_any())\n-            }\n-        }\n-\n-        impl Eq for $ty {}\n-\n-        impl Hash for $ty {\n-            fn hash<H: Hasher>(&self, state: &mut H) {\n-                self.as_any().type_id().hash(state);\n-                DynamicEqHash::dyn_hash(self, state as &mut dyn Hasher)\n-            }\n-        }\n-    };\n-}\n+impl_partial_eq_for_dyn!(dyn InvalidationReason);\n+impl_eq_for_dyn!(dyn InvalidationReason);\n+impl_hash_for_dyn!(dyn InvalidationReason);\n \n-impl_eq_hash!(dyn InvalidationReason);\n-impl_eq_hash!(dyn InvalidationReasonKind);\n+impl_partial_eq_for_dyn!(dyn InvalidationReasonKind);\n+impl_eq_for_dyn!(dyn InvalidationReasonKind);\n+impl_hash_for_dyn!(dyn InvalidationReasonKind);\n \n #[derive(PartialEq, Eq, Hash)]\n enum MapKey {"
        },
        {
            "sha": "2c8494d6afb8983f415c56cab54a98213baa92c4",
            "filename": "turbopack/crates/turbo-tasks/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -98,8 +98,7 @@ pub use id::{\n     ExecutionId, LocalTaskId, SessionId, TRANSIENT_TASK_BIT, TaskId, TraitTypeId, ValueTypeId,\n };\n pub use invalidation::{\n-    DynamicEqHash, InvalidationReason, InvalidationReasonKind, InvalidationReasonSet, Invalidator,\n-    get_invalidator,\n+    InvalidationReason, InvalidationReasonKind, InvalidationReasonSet, Invalidator, get_invalidator,\n };\n pub use join_iter_ext::{JoinIterExt, TryFlatJoinIterExt, TryJoinIterExt};\n pub use key_value_pair::KeyValuePair;"
        },
        {
            "sha": "9cefc18505729ff25b95a641098a9b8e1948cbe3",
            "filename": "turbopack/crates/turbo-tasks/src/magic_any.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 46,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -2,24 +2,22 @@ use core::fmt;\n use std::{\n     any::{Any, TypeId},\n     fmt::Debug,\n-    hash::{Hash, Hasher},\n-    ops::DerefMut,\n+    hash::Hash,\n     sync::Arc,\n };\n \n use serde::{Deserialize, Serialize, de::DeserializeSeed};\n+use turbo_dyn_eq_hash::{\n+    DynEq, DynHash, DynPartialEq, impl_eq_for_dyn, impl_hash_for_dyn, impl_partial_eq_for_dyn,\n+};\n \n use crate::trace::{TraceRawVcs, TraceRawVcsContext};\n \n-pub trait MagicAny: mopa::Any + Send + Sync {\n+pub trait MagicAny: mopa::Any + DynPartialEq + DynEq + DynHash + Send + Sync {\n     fn magic_any_arc(self: Arc<Self>) -> Arc<dyn Any + Sync + Send>;\n \n     fn magic_debug(&self, f: &mut fmt::Formatter) -> fmt::Result;\n \n-    fn magic_eq(&self, other: &dyn MagicAny) -> bool;\n-\n-    fn magic_hash(&self, hasher: &mut dyn Hasher);\n-\n     fn magic_trace_raw_vcs(&self, trace_context: &mut TraceRawVcsContext);\n \n     #[cfg(debug_assertions)]\n@@ -51,17 +49,6 @@ impl<T: Debug + Eq + Hash + Send + Sync + TraceRawVcs + 'static> MagicAny for T\n         d.finish()\n     }\n \n-    fn magic_eq(&self, other: &dyn MagicAny) -> bool {\n-        match other.downcast_ref::<Self>() {\n-            None => false,\n-            Some(other) => self == other,\n-        }\n-    }\n-\n-    fn magic_hash(&self, hasher: &mut dyn Hasher) {\n-        Hash::hash(&(TypeId::of::<Self>(), self), &mut HasherMut(hasher))\n-    }\n-\n     fn magic_trace_raw_vcs(&self, trace_context: &mut TraceRawVcsContext) {\n         self.trace_raw_vcs(trace_context);\n     }\n@@ -78,34 +65,9 @@ impl fmt::Debug for dyn MagicAny {\n     }\n }\n \n-impl PartialEq for dyn MagicAny {\n-    fn eq(&self, other: &Self) -> bool {\n-        self.magic_eq(other)\n-    }\n-}\n-\n-impl Eq for dyn MagicAny {}\n-\n-impl Hash for dyn MagicAny {\n-    fn hash<H: Hasher>(&self, hasher: &mut H) {\n-        self.magic_hash(hasher)\n-    }\n-}\n-\n-pub struct HasherMut<H: ?Sized>(pub H);\n-\n-impl<H: DerefMut + ?Sized> Hasher for HasherMut<H>\n-where\n-    H::Target: Hasher,\n-{\n-    fn finish(&self) -> u64 {\n-        self.0.finish()\n-    }\n-\n-    fn write(&mut self, bytes: &[u8]) {\n-        self.0.write(bytes)\n-    }\n-}\n+impl_partial_eq_for_dyn!(dyn MagicAny);\n+impl_eq_for_dyn!(dyn MagicAny);\n+impl_hash_for_dyn!(dyn MagicAny);\n \n impl TraceRawVcs for dyn MagicAny {\n     fn trace_raw_vcs(&self, trace_context: &mut TraceRawVcsContext) {"
        },
        {
            "sha": "d537989f7f41b9419a6b57a4bf66814c67292321",
            "filename": "turbopack/crates/turbopack-dev-server/src/invalidation.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Finvalidation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Finvalidation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Finvalidation.rs?ref=2817a46d48d5a1b5d50644ca4cb3b0dc0c50fab3",
            "patch": "@@ -1,4 +1,7 @@\n-use std::fmt::{Display, Formatter};\n+use std::{\n+    any::Any,\n+    fmt::{Display, Formatter},\n+};\n \n use hyper::{Method, Uri};\n use turbo_tasks::{FxIndexSet, InvalidationReason, InvalidationReasonKind, util::StaticOrArc};\n@@ -36,7 +39,12 @@ impl InvalidationReasonKind for ServerRequestKind {\n     ) -> std::fmt::Result {\n         let example = reasons\n             .into_iter()\n-            .map(|reason| reason.as_any().downcast_ref::<ServerRequest>().unwrap())\n+            .map(|reason| {\n+                let reason: &dyn InvalidationReason = &**reason;\n+                (reason as &dyn Any)\n+                    .downcast_ref::<ServerRequest>()\n+                    .unwrap()\n+            })\n             .min_by_key(|reason| reason.uri.path().len())\n             .unwrap();\n         write!(\n@@ -84,8 +92,8 @@ impl InvalidationReasonKind for ServerRequestSideEffectsKind {\n         let example = reasons\n             .into_iter()\n             .map(|reason| {\n-                reason\n-                    .as_any()\n+                let reason: &dyn InvalidationReason = &**reason;\n+                (reason as &dyn Any)\n                     .downcast_ref::<ServerRequestSideEffects>()\n                     .unwrap()\n             })"
        }
    ],
    "stats": {
        "total": 250,
        "additions": 143,
        "deletions": 107
    }
}