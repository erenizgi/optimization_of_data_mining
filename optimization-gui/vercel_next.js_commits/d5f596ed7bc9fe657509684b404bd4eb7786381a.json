{
    "author": "huozhi",
    "message": "[metadata] only blocking render for html bots in ppr pages (#76379)\n\n### What\r\n\r\nIn non-PRR mode, we keep the original behavior that metadata is blocking but stream the rest. Previously we also do the full dynamic rendering for both non-PPR and PPR pages, which is required for PPR pages to discard the postpone cache but not necessary for non-PPR pages.\r\n\r\nThis PR align the behavior as before.\r\n\r\nCloses NDX-881",
    "sha": "d5f596ed7bc9fe657509684b404bd4eb7786381a",
    "files": [
        {
            "sha": "84ecd6ed912ca7b6e3730e80b90c37153613577f",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/d5f596ed7bc9fe657509684b404bd4eb7786381a/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d5f596ed7bc9fe657509684b404bd4eb7786381a/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=d5f596ed7bc9fe657509684b404bd4eb7786381a",
            "patch": "@@ -2067,11 +2067,6 @@ export default abstract class Server<\n       }\n     }\n \n-    const isHtmlBot = isHtmlBotRequest(req)\n-    if (isHtmlBot) {\n-      this.renderOpts.serveStreamingMetadata = false\n-    }\n-\n     if (\n       hasFallback ||\n       staticPaths?.includes(resolvedUrlPathname) ||\n@@ -2082,11 +2077,6 @@ export default abstract class Server<\n       isSSG = true\n     } else if (!this.renderOpts.dev) {\n       isSSG ||= !!prerenderManifest.routes[toRoute(pathname)]\n-      if (isHtmlBot) {\n-        // When it's html limited bots request, disable SSG\n-        // and perform the full blocking & dynamic rendering.\n-        isSSG = false\n-      }\n     }\n \n     // Toggle whether or not this is a Data request\n@@ -2227,6 +2217,12 @@ export default abstract class Server<\n       'segmentPrefetchRSCRequest'\n     )\n \n+    const isHtmlBot = isHtmlBotRequest(req)\n+    if (isHtmlBot && isRoutePPREnabled) {\n+      isSSG = false\n+      this.renderOpts.serveStreamingMetadata = false\n+    }\n+\n     // we need to ensure the status code if /404 is visited directly\n     if (is404Page && !isNextDataRequest && !isRSCRequest) {\n       res.statusCode = 404\n@@ -2483,7 +2479,11 @@ export default abstract class Server<\n         query: origQuery,\n       })\n \n-      const shouldWaitOnAllReady = !supportsDynamicResponse || isHtmlBot\n+      const shouldWaitOnAllReady =\n+        !supportsDynamicResponse ||\n+        // When html bots request PPR page, perform the full dynamic rendering.\n+        (isHtmlBot && isRoutePPREnabled)\n+\n       const renderOpts: LoadedRenderOpts = {\n         ...components,\n         ...opts,"
        },
        {
            "sha": "24d73471249f9d514689c0866bdb10bc2bb41fcc",
            "filename": "test/e2e/app-dir/metadata-streaming-static-generation/app/suspenseful/dynamic/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d5f596ed7bc9fe657509684b404bd4eb7786381a/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fapp%2Fsuspenseful%2Fdynamic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d5f596ed7bc9fe657509684b404bd4eb7786381a/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fapp%2Fsuspenseful%2Fdynamic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fapp%2Fsuspenseful%2Fdynamic%2Fpage.tsx?ref=d5f596ed7bc9fe657509684b404bd4eb7786381a",
            "patch": "@@ -2,12 +2,13 @@ import { connection } from 'next/server'\n \n export default async function Page() {\n   await connection()\n+  await new Promise((resolve) => setTimeout(resolve, 500))\n   return <p>suspenseful - dynamic</p>\n }\n \n export async function generateMetadata() {\n   await connection()\n-  await new Promise((resolve) => setTimeout(resolve, 1 * 1000))\n+  await new Promise((resolve) => setTimeout(resolve, 200))\n   return {\n     title: 'suspenseful page - dynamic',\n   }"
        },
        {
            "sha": "1105bc507316fe07ce6d2ec1cd5076672ceb8910",
            "filename": "test/e2e/app-dir/metadata-streaming-static-generation/metadata-streaming-static-generation.test.ts",
            "status": "modified",
            "additions": 85,
            "deletions": 73,
            "changes": 158,
            "blob_url": "https://github.com/vercel/next.js/blob/d5f596ed7bc9fe657509684b404bd4eb7786381a/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fmetadata-streaming-static-generation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d5f596ed7bc9fe657509684b404bd4eb7786381a/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fmetadata-streaming-static-generation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fmetadata-streaming-static-generation.test.ts?ref=d5f596ed7bc9fe657509684b404bd4eb7786381a",
            "patch": "@@ -2,94 +2,106 @@ import { nextTestSetup } from 'e2e-utils'\n \n const isPPREnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n \n-describe('app-dir - metadata-streaming-static-generation', () => {\n-  const { next, isNextDev, isNextStart } = nextTestSetup({\n-    files: __dirname,\n-  })\n-\n-  if (isNextStart && !isPPREnabled) {\n-    // Precondition for the following tests in build mode.\n-    // This test is only useful for non-PPR mode as in PPR mode those routes\n-    // are all listed in the prerender manifest.\n-    it('should generate all pages static', async () => {\n-      const prerenderManifest = JSON.parse(\n-        await next.readFile('.next/prerender-manifest.json')\n-      )\n-      const staticRoutes = prerenderManifest.routes\n-      expect(Object.keys(staticRoutes).sort()).toEqual([\n-        '/',\n-        '/slow/static',\n-        '/suspenseful/static',\n-      ])\n+// Skip PPR test as it's covered in test/e2e/app-dir/ppr-metadata-streaming/ppr-metadata-streaming.test.ts\n+;(isPPREnabled ? describe.skip : describe)(\n+  'app-dir - metadata-streaming-static-generation',\n+  () => {\n+    const { next, isNextDev, isNextStart } = nextTestSetup({\n+      files: __dirname,\n     })\n-  }\n \n-  if (isNextDev) {\n-    // In development it's still dynamic rendering that metadata will be inserted into body\n-    describe('static pages (development)', () => {\n-      it('should contain async generated metadata in body for simple static page', async () => {\n-        const $ = await next.render$('/')\n-        expect($('body title').text()).toBe('index page')\n+    if (isNextStart) {\n+      // Precondition for the following tests in build mode.\n+      // This test is only useful for non-PPR mode as in PPR mode those routes\n+      // are all listed in the prerender manifest.\n+      it('should generate all pages static', async () => {\n+        const prerenderManifest = JSON.parse(\n+          await next.readFile('.next/prerender-manifest.json')\n+        )\n+        const staticRoutes = prerenderManifest.routes\n+        expect(Object.keys(staticRoutes).sort()).toEqual([\n+          '/',\n+          '/slow/static',\n+          '/suspenseful/static',\n+        ])\n       })\n+    }\n \n-      it('should contain async generated metadata in body for slow static page', async () => {\n-        const $ = await next.render$('/slow/static')\n-        expect($('body title').text()).toBe('slow page - static')\n-      })\n+    if (isNextDev) {\n+      // In development it's still dynamic rendering that metadata will be inserted into body\n+      describe('static pages (development)', () => {\n+        it('should contain async generated metadata in body for simple static page', async () => {\n+          const $ = await next.render$('/')\n+          expect($('body title').text()).toBe('index page')\n+        })\n \n-      it('should contain async generated metadata in body static page with suspenseful content', async () => {\n-        const $ = await next.render$('/suspenseful/static')\n-        expect($('body title').text()).toBe('suspenseful page - static')\n-      })\n-    })\n-  } else {\n-    describe('static pages (production)', () => {\n-      it('should contain async generated metadata in head for simple static page', async () => {\n-        const $ = await next.render$('/')\n-        expect($('head title').text()).toBe('index page')\n+        it('should contain async generated metadata in body for slow static page', async () => {\n+          const $ = await next.render$('/slow/static')\n+          expect($('body title').text()).toBe('slow page - static')\n+        })\n+\n+        it('should contain async generated metadata in body static page with suspenseful content', async () => {\n+          const $ = await next.render$('/suspenseful/static')\n+          expect($('body title').text()).toBe('suspenseful page - static')\n+        })\n       })\n+    } else {\n+      describe('static pages (production)', () => {\n+        it('should contain async generated metadata in head for simple static page', async () => {\n+          const $ = await next.render$('/')\n+          expect($('head title').text()).toBe('index page')\n+        })\n+\n+        it('should contain async generated metadata in head for slow static page', async () => {\n+          const $ = await next.render$('/slow/static')\n+          expect($('head title').text()).toBe('slow page - static')\n+        })\n \n-      it('should contain async generated metadata in head for slow static page', async () => {\n-        const $ = await next.render$('/slow/static')\n-        expect($('head title').text()).toBe('slow page - static')\n+        it('should contain async generated metadata in head static page with suspenseful content', async () => {\n+          const $ = await next.render$('/suspenseful/static')\n+          expect($('head title').text()).toBe('suspenseful page - static')\n+        })\n       })\n+    }\n \n-      it('should contain async generated metadata in head static page with suspenseful content', async () => {\n-        const $ = await next.render$('/suspenseful/static')\n-        expect($('head title').text()).toBe('suspenseful page - static')\n+    describe('dynamic pages', () => {\n+      it('should contain async generated metadata in body for simple dynamics page', async () => {\n+        const $ = await next.render$('/suspenseful/dynamic')\n+        expect($('body title').text()).toBe('suspenseful page - dynamic')\n       })\n-    })\n-  }\n \n-  describe('dynamic pages', () => {\n-    it('should contain async generated metadata in body for simple dynamics page', async () => {\n-      const $ = await next.render$('/suspenseful/dynamic')\n-      expect($('body title').text()).toBe('suspenseful page - dynamic')\n+      it('should contain async generated metadata in body for suspenseful dynamic page', async () => {\n+        const $ = await next.render$('/slow/dynamic')\n+        expect($('body title').text()).toBe('slow page - dynamic')\n+      })\n     })\n \n-    it('should contain async generated metadata in body for suspenseful dynamic page', async () => {\n-      const $ = await next.render$('/slow/dynamic')\n-      expect($('body title').text()).toBe('slow page - dynamic')\n-    })\n-  })\n+    describe('dynamic pages with html limited bots', () => {\n+      it('should contain stream metadata in head for suspenseful dynamic page', async () => {\n+        const $ = await next.render$('/suspenseful/dynamic', undefined, {\n+          headers: {\n+            'User-Agent': 'Discordbot/2.0;',\n+          },\n+        })\n+        expect($('head title').text()).toBe('suspenseful page - dynamic')\n+        // Ensure it's suspenseful content\n+        expect($('.suspenseful-layout').text()).toBe('')\n \n-  describe('dynamic pages with html limited bots', () => {\n-    it('should contain async generated metadata in head for simple dynamics page', async () => {\n-      const $ = await next.render$('/suspenseful/dynamic', undefined, {\n-        headers: {\n-          'User-Agent': 'Discordbot/2.0;',\n-        },\n+        // Can still render the suspenseful content with browser\n+        const browser = await next.browser('/suspenseful/dynamic')\n+        expect(await browser.elementByCss('.suspenseful-layout').text()).toBe(\n+          'suspenseful - dynamic'\n+        )\n       })\n-      expect($('head title').text()).toBe('suspenseful page - dynamic')\n-    })\n \n-    it('should contain async generated metadata in head for suspenseful dynamic page', async () => {\n-      const $ = await next.render$('/slow/dynamic', undefined, {\n-        headers: {\n-          'User-Agent': 'Discordbot/2.0;',\n-        },\n+      it('should contain async generated metadata in head for simple dynamic page', async () => {\n+        const $ = await next.render$('/slow/dynamic', undefined, {\n+          headers: {\n+            'User-Agent': 'Discordbot/2.0;',\n+          },\n+        })\n+        expect($('head title').text()).toBe('slow page - dynamic')\n       })\n-      expect($('head title').text()).toBe('slow page - dynamic')\n     })\n-  })\n-})\n+  }\n+)"
        },
        {
            "sha": "80a18816e5f6590cdf46c5c78ab12e9104dbeeb3",
            "filename": "test/e2e/app-dir/ppr-metadata-streaming/app/dynamic-page/partial/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d5f596ed7bc9fe657509684b404bd4eb7786381a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fapp%2Fdynamic-page%2Fpartial%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d5f596ed7bc9fe657509684b404bd4eb7786381a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fapp%2Fdynamic-page%2Fpartial%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fapp%2Fdynamic-page%2Fpartial%2Fpage.tsx?ref=d5f596ed7bc9fe657509684b404bd4eb7786381a",
            "patch": "@@ -14,7 +14,7 @@ async function SuspendedComponent() {\n   await new Promise((resolve) => setTimeout(resolve, 500))\n   return (\n     <div>\n-      <div>suspended component</div>\n+      <div>outer suspended component</div>\n       <NestedSuspendedComponent />\n     </div>\n   )"
        },
        {
            "sha": "3ae99f88528375f5195592965a994c0b472252bf",
            "filename": "test/e2e/app-dir/ppr-metadata-streaming/ppr-metadata-streaming.test.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/d5f596ed7bc9fe657509684b404bd4eb7786381a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d5f596ed7bc9fe657509684b404bd4eb7786381a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts?ref=d5f596ed7bc9fe657509684b404bd4eb7786381a",
            "patch": "@@ -103,7 +103,7 @@ describe('ppr-metadata-streaming', () => {\n   if (!isNextDev && !isNextDeploy) {\n     // This test is only relevant in production mode, as it's testing PPR results\n     describe('html limited bots', () => {\n-      it('should serve partial static shell when normal UA requests the page', async () => {\n+      it('should serve partial static shell when normal UA requests the PPR page', async () => {\n         const res1 = await next.fetch('/dynamic-page/partial')\n         const res2 = await next.fetch('/dynamic-page/partial')\n \n@@ -123,7 +123,7 @@ describe('ppr-metadata-streaming', () => {\n         expect(headers.get('x-nextjs-postponed')).toBe('1')\n       })\n \n-      it('should not serve partial static shell when html limited bots requests the page', async () => {\n+      it('should perform blocking and dynamic rendering when html limited bots requests the PPR page', async () => {\n         const htmlLimitedBotUA = 'Discordbot'\n         const res1 = await next.fetch('/dynamic-page/partial', {\n           headers: {\n@@ -150,6 +150,11 @@ describe('ppr-metadata-streaming', () => {\n         // Two requests are dynamic and should not have the same data-date attribute\n         expect(attribute2).toBeGreaterThan(attribute1)\n         expect(attribute1).toBeTruthy()\n+\n+        // Should contain resolved suspense content\n+        const bodyHtml = $1('body').html()\n+        expect(bodyHtml).toContain('outer suspended component')\n+        expect(bodyHtml).toContain('nested suspended component')\n       })\n     })\n   }"
        }
    ],
    "stats": {
        "total": 194,
        "additions": 106,
        "deletions": 88
    }
}