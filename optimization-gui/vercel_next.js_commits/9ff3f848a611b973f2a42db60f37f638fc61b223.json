{
    "author": "sokra",
    "message": "Turbopack: only keep old database version if not on CI (#79964)\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that you follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the PR.\n- Read the Docs Contribution Guide to ensure your contribution follows the docs guidelines: https://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc https://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See https://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See: https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature request has been accepted for implementation before opening a PR. (A discussion must be opened, see https://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added (https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to understand the PR)\n- When linking to a Slack thread, you might want to share details of the conclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic behind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "9ff3f848a611b973f2a42db60f37f638fc61b223",
    "files": [
        {
            "sha": "c5106224bd0f6d537fc8f7a07aab563c13e8d88a",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9ff3f848a611b973f2a42db60f37f638fc61b223/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9ff3f848a611b973f2a42db60f37f638fc61b223/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=9ff3f848a611b973f2a42db60f37f638fc61b223",
            "patch": "@@ -222,6 +222,8 @@ pub struct NapiTurboEngineOptions {\n     pub memory_limit: Option<f64>,\n     /// Track dependencies between tasks. If false, any change during build will error.\n     pub dependency_tracking: Option<bool>,\n+    /// Whether the project is running in a CI environment.\n+    pub is_ci: Option<bool>,\n }\n \n impl From<NapiWatchOptions> for WatchOptions {\n@@ -394,11 +396,13 @@ pub async fn project_new(\n         .unwrap_or(usize::MAX);\n     let persistent_caching = turbo_engine_options.persistent_caching.unwrap_or_default();\n     let dependency_tracking = turbo_engine_options.dependency_tracking.unwrap_or(true);\n+    let is_ci = turbo_engine_options.is_ci.unwrap_or(false);\n     let turbo_tasks = create_turbo_tasks(\n         PathBuf::from(&options.dist_dir),\n         persistent_caching,\n         memory_limit,\n         dependency_tracking,\n+        is_ci,\n     )?;\n \n     turbo_tasks.send_compilation_event(Arc::new(DiagnosticEvent::new("
        },
        {
            "sha": "a4e3592b404607e4758f72eec6936993d9b45b42",
            "filename": "crates/napi/src/next_api/utils.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9ff3f848a611b973f2a42db60f37f638fc61b223/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9ff3f848a611b973f2a42db60f37f638fc61b223/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs?ref=9ff3f848a611b973f2a42db60f37f638fc61b223",
            "patch": "@@ -156,6 +156,7 @@ pub fn create_turbo_tasks(\n     persistent_caching: bool,\n     _memory_limit: usize,\n     dependency_tracking: bool,\n+    is_ci: bool,\n ) -> Result<NextTurboTasks> {\n     Ok(if persistent_caching {\n         let version_info = GitVersionInfo {\n@@ -174,7 +175,11 @@ pub fn create_turbo_tasks(\n                     dependency_tracking,\n                     ..Default::default()\n                 },\n-                default_backing_storage(&output_path.join(\"cache/turbopack\"), &version_info)?,\n+                default_backing_storage(\n+                    &output_path.join(\"cache/turbopack\"),\n+                    &version_info,\n+                    is_ci,\n+                )?,\n             ),\n         ))\n     } else {"
        },
        {
            "sha": "ca009439cc79fdbe1b1c0dbe79e93455ad8e62b3",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9ff3f848a611b973f2a42db60f37f638fc61b223/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9ff3f848a611b973f2a42db60f37f638fc61b223/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=9ff3f848a611b973f2a42db60f37f638fc61b223",
            "patch": "@@ -193,6 +193,8 @@ export interface NapiTurboEngineOptions {\n   memoryLimit?: number\n   /** Track dependencies between tasks. If false, any change during build will error. */\n   dependencyTracking?: boolean\n+  /** Whether the project is running in a CI environment. */\n+  isCi?: boolean\n }\n export declare function projectNew(\n   options: NapiProjectOptions,"
        },
        {
            "sha": "7a5243433276c77fa372ed943694256fe325f12e",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9ff3f848a611b973f2a42db60f37f638fc61b223/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9ff3f848a611b973f2a42db60f37f638fc61b223/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=9ff3f848a611b973f2a42db60f37f638fc61b223",
            "patch": "@@ -20,6 +20,7 @@ import { hasCustomExportOutput } from '../../export/utils'\n import { Telemetry } from '../../telemetry/storage'\n import { setGlobal } from '../../trace'\n import * as Log from '../output/log'\n+import { isCI } from '../../server/ci-info'\n \n export async function turbopackBuild(): Promise<{\n   duration: number\n@@ -86,6 +87,7 @@ export async function turbopackBuild(): Promise<{\n       persistentCaching,\n       memoryLimit: config.experimental?.turbopackMemoryLimit,\n       dependencyTracking: persistentCaching,\n+      isCi: isCI,\n     }\n   )\n   try {"
        },
        {
            "sha": "9eb939faeda2dd5159a10d59f1929d989c6d8158",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/db_versioning.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/9ff3f848a611b973f2a42db60f37f638fc61b223/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_versioning.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9ff3f848a611b973f2a42db60f37f638fc61b223/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_versioning.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_versioning.rs?ref=9ff3f848a611b973f2a42db60f37f638fc61b223",
            "patch": "@@ -22,10 +22,14 @@ pub struct GitVersionInfo<'a> {\n \n /// Specifies many databases that have a different version than the current one are retained.\n /// For example if MAX_OTHER_DB_VERSIONS is 2, there can be at most 3 databases in the directory,\n-/// the current one and two older/newer ones.\n+/// the current one and two older/newer ones. On CI it never keeps any other versions.\n const MAX_OTHER_DB_VERSIONS: usize = 2;\n \n-pub fn handle_db_versioning(base_path: &Path, version_info: &GitVersionInfo) -> Result<PathBuf> {\n+pub fn handle_db_versioning(\n+    base_path: &Path,\n+    version_info: &GitVersionInfo,\n+    is_ci: bool,\n+) -> Result<PathBuf> {\n     if let Ok(version) = env::var(\"TURBO_ENGINE_VERSION\") {\n         return Ok(base_path.join(version));\n     }\n@@ -59,6 +63,8 @@ pub fn handle_db_versioning(base_path: &Path, version_info: &GitVersionInfo) ->\n     if let Some(version) = version {\n         path = base_path.join(version);\n \n+        let max_other_db_versions = if is_ci { 0 } else { MAX_OTHER_DB_VERSIONS };\n+\n         // Remove old databases if needed\n         if let Ok(read_dir) = read_dir(base_path) {\n             let old_dbs = read_dir\n@@ -75,7 +81,7 @@ pub fn handle_db_versioning(base_path: &Path, version_info: &GitVersionInfo) ->\n                     Some(entry.path())\n                 })\n                 .collect::<Vec<_>>();\n-            if old_dbs.len() > MAX_OTHER_DB_VERSIONS {\n+            if old_dbs.len() > max_other_db_versions {\n                 let mut old_dbs = old_dbs\n                     .iter()\n                     .map(|p| {\n@@ -90,7 +96,7 @@ pub fn handle_db_versioning(base_path: &Path, version_info: &GitVersionInfo) ->\n                     })\n                     .collect::<Vec<_>>();\n                 old_dbs.sort_by_key(|(_, age)| *age);\n-                for (p, _) in old_dbs.into_iter().skip(MAX_OTHER_DB_VERSIONS) {\n+                for (p, _) in old_dbs.into_iter().skip(max_other_db_versions) {\n                     let _ = remove_dir_all(p);\n                 }\n             }"
        },
        {
            "sha": "bf32c8423283613dec28b4240b352a4ff9e52b55",
            "filename": "turbopack/crates/turbo-tasks-backend/src/lib.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/9ff3f848a611b973f2a42db60f37f638fc61b223/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9ff3f848a611b973f2a42db60f37f638fc61b223/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs?ref=9ff3f848a611b973f2a42db60f37f638fc61b223",
            "patch": "@@ -39,14 +39,15 @@ pub type LmdbBackingStorage = KeyValueDatabaseBackingStorage<\n pub fn lmdb_backing_storage(\n     path: &Path,\n     version_info: &GitVersionInfo,\n+    is_ci: bool,\n ) -> Result<LmdbBackingStorage> {\n     use crate::database::{\n         fresh_db_optimization::{FreshDbOptimization, is_fresh},\n         read_transaction_cache::ReadTransactionCache,\n         startup_cache::StartupCacheLayer,\n     };\n \n-    let path = handle_db_versioning(path, version_info)?;\n+    let path = handle_db_versioning(path, version_info, is_ci)?;\n     let fresh_db = is_fresh(&path);\n     let database = crate::database::lmdb::LmbdKeyValueDatabase::new(&path)?;\n     let database = FreshDbOptimization::new(database, fresh_db);\n@@ -60,8 +61,9 @@ pub type TurboBackingStorage = KeyValueDatabaseBackingStorage<TurboKeyValueDatab\n pub fn turbo_backing_storage(\n     path: &Path,\n     version_info: &GitVersionInfo,\n+    is_ci: bool,\n ) -> Result<TurboBackingStorage> {\n-    let path = handle_db_versioning(path, version_info)?;\n+    let path = handle_db_versioning(path, version_info, is_ci)?;\n     let database = TurboKeyValueDatabase::new(path)?;\n     Ok(KeyValueDatabaseBackingStorage::new(database))\n }\n@@ -79,8 +81,9 @@ pub type DefaultBackingStorage = LmdbBackingStorage;\n pub fn default_backing_storage(\n     path: &Path,\n     version_info: &GitVersionInfo,\n+    is_ci: bool,\n ) -> Result<DefaultBackingStorage> {\n-    lmdb_backing_storage(path, version_info)\n+    lmdb_backing_storage(path, version_info, is_ci)\n }\n \n #[cfg(not(feature = \"lmdb\"))]\n@@ -90,6 +93,7 @@ pub type DefaultBackingStorage = TurboBackingStorage;\n pub fn default_backing_storage(\n     path: &Path,\n     version_info: &GitVersionInfo,\n+    is_ci: bool,\n ) -> Result<DefaultBackingStorage> {\n-    turbo_backing_storage(path, version_info)\n+    turbo_backing_storage(path, version_info, is_ci)\n }"
        },
        {
            "sha": "3d7906ab40da4d0c0e653c346d08c85fc1bc9200",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/test_config.trs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9ff3f848a611b973f2a42db60f37f638fc61b223/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs",
            "raw_url": "https://github.com/vercel/next.js/raw/9ff3f848a611b973f2a42db60f37f638fc61b223/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs?ref=9ff3f848a611b973f2a42db60f37f638fc61b223",
            "patch": "@@ -16,6 +16,7 @@\n           describe: \"test-unversioned\",\n           dirty: false,\n         },\n+        false\n       ).unwrap()\n     )\n   )"
        },
        {
            "sha": "3d7906ab40da4d0c0e653c346d08c85fc1bc9200",
            "filename": "turbopack/crates/turbo-tasks-fetch/tests/test_config.trs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9ff3f848a611b973f2a42db60f37f638fc61b223/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ftest_config.trs",
            "raw_url": "https://github.com/vercel/next.js/raw/9ff3f848a611b973f2a42db60f37f638fc61b223/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ftest_config.trs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ftest_config.trs?ref=9ff3f848a611b973f2a42db60f37f638fc61b223",
            "patch": "@@ -16,6 +16,7 @@\n           describe: \"test-unversioned\",\n           dirty: false,\n         },\n+        false\n       ).unwrap()\n     )\n   )"
        },
        {
            "sha": "3fd28c57266ac8ce52931ed9ef277924b2ff765c",
            "filename": "turbopack/crates/turbopack/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9ff3f848a611b973f2a42db60f37f638fc61b223/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9ff3f848a611b973f2a42db60f37f638fc61b223/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs?ref=9ff3f848a611b973f2a42db60f37f638fc61b223",
            "patch": "@@ -284,6 +284,7 @@ fn node_file_trace_persistent(#[case] input: CaseInput) {\n                     describe: \"test-unversioned\",\n                     dirty: false,\n                 },\n+                false,\n             )\n             .unwrap(),\n         ))"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 35,
        "deletions": 9
    }
}