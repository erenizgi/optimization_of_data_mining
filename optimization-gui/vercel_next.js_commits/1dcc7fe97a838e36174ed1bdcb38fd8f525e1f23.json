{
    "author": "ijjk",
    "message": "Implement handler interface for app-page (#79568)\n\nContinuation of https://github.com/vercel/next.js/pull/78166 this\nimplements the handler interface for app router pages, This does not\nmove the response handling inside of the handler yet as that will be in\na follow-up PR to keep the changes isolated. This still returns the\nRenderResult for the base-server to continue to handle.\n\nValidated against deploy tests\nhttps://github.com/vercel/vercel/pull/13389 and\nhttps://github.com/vercel/next.js/actions/runs/15358616431/job/43222466204",
    "sha": "1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
    "files": [
        {
            "sha": "e9c466461604152ae94e4b75993b953be82d7a07",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 468,
            "deletions": 2,
            "changes": 470,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -1,7 +1,39 @@\n import type { LoaderTree } from '../../server/lib/app-dir-module'\n-import { AppPageRouteModule } from '../../server/route-modules/app-page/module.compiled' with { 'turbopack-transition': 'next-ssr' }\n+import type { ServerOnInstrumentationRequestError } from '../../server/app-render/types'\n+import type { IncomingMessage, ServerResponse } from 'node:http'\n+\n+import {\n+  AppPageRouteModule,\n+  type AppPageRouteHandlerContext,\n+} from '../../server/route-modules/app-page/module.compiled' with { 'turbopack-transition': 'next-ssr' }\n+\n import { RouteKind } from '../../server/route-kind' with { 'turbopack-transition': 'next-server-utility' }\n \n+import { getRevalidateReason } from '../../server/instrumentation/utils'\n+import { getTracer, SpanKind, type Span } from '../../server/lib/trace/tracer'\n+import { getRequestMeta } from '../../server/request-meta'\n+import { BaseServerSpan } from '../../server/lib/trace/constants'\n+import { interopDefault } from '../../server/app-render/interop-default'\n+import { NodeNextRequest, NodeNextResponse } from '../../server/base-http/node'\n+import { checkIsAppPPREnabled } from '../../server/lib/experimental/ppr'\n+import { getFallbackRouteParams } from '../../server/request/fallback-params'\n+import { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\n+import {\n+  isHtmlBotRequest,\n+  shouldServeStreamingMetadata,\n+} from '../../server/lib/streaming-metadata'\n+import { createServerModuleMap } from '../../server/app-render/action-utils'\n+import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n+import { getIsPossibleServerAction } from '../../server/lib/server-action-request-meta'\n+import {\n+  RouterServerContextSymbol,\n+  routerServerGlobal,\n+} from '../../server/lib/router-utils/router-server-context'\n+import {\n+  NEXT_ROUTER_PREFETCH_HEADER,\n+  RSC_HEADER,\n+} from '../../client/components/app-router-headers'\n+\n // These are injected by the loader afterwards.\n \n /**\n@@ -18,7 +50,9 @@ declare const pages: any\n \n export { tree, pages }\n \n-export { default as GlobalError } from 'VAR_MODULE_GLOBAL_ERROR' with { 'turbopack-transition': 'next-server-utility' }\n+import GlobalError from 'VAR_MODULE_GLOBAL_ERROR' with { 'turbopack-transition': 'next-server-utility' }\n+\n+export { GlobalError }\n \n // These are injected by the loader afterwards.\n declare const __next_app_require__: (id: string | number) => unknown\n@@ -32,6 +66,9 @@ export const __next_app__ = {\n   loadChunk: __next_app_load_chunk__,\n }\n \n+import * as entryBase from '../../server/app-render/entry-base' with { 'turbopack-transition': 'next-server-utility' }\n+import { getBotType } from '../../shared/lib/router/utils/is-bot'\n+\n export * from '../../server/app-render/entry-base' with { 'turbopack-transition': 'next-server-utility' }\n \n // Create and export the route module that will be consumed.\n@@ -51,3 +88,432 @@ export const routeModule = new AppPageRouteModule({\n   distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n   projectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n })\n+\n+export async function handler(\n+  req: IncomingMessage,\n+  res: ServerResponse,\n+  ctx: {\n+    waitUntil: (prom: Promise<void>) => void\n+  }\n+) {\n+  let srcPage = 'VAR_DEFINITION_PAGE'\n+\n+  // turbopack doesn't normalize `/index` in the page name\n+  // so we need to to process dynamic routes properly\n+  // TODO: fix turbopack providing differing value from webpack\n+  if (process.env.TURBOPACK) {\n+    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n+  } else if (srcPage === '/index') {\n+    // we always normalize /index specifically\n+    srcPage = '/'\n+  }\n+  const multiZoneDraftMode = process.env\n+    .__NEXT_MULTI_ZONE_DRAFT_MODE as any as boolean\n+\n+  const postponed = getRequestMeta(req, 'postponed')\n+\n+  const prepareResult = await routeModule.prepare(req, res, {\n+    srcPage,\n+    multiZoneDraftMode,\n+  })\n+\n+  if (!prepareResult) {\n+    res.statusCode = 400\n+    res.end('Bad Request')\n+    ctx.waitUntil?.(Promise.resolve())\n+    return null\n+  }\n+\n+  const {\n+    buildId,\n+    query,\n+    params,\n+    parsedUrl,\n+    pageIsDynamic,\n+    buildManifest,\n+    nextFontManifest,\n+    serverFilesManifest,\n+    reactLoadableManifest,\n+    serverActionsManifest,\n+    clientReferenceManifest,\n+    subresourceIntegrityManifest,\n+    prerenderManifest,\n+    isDraftMode,\n+    isOnDemandRevalidate,\n+  } = prepareResult\n+\n+  const routerServerContext =\n+    routerServerGlobal[RouterServerContextSymbol]?.[\n+      process.env.__NEXT_RELATIVE_PROJECT_DIR || ''\n+    ]\n+\n+  const onInstrumentationRequestError =\n+    routeModule.instrumentationOnRequestError.bind(routeModule)\n+\n+  const onError: ServerOnInstrumentationRequestError = (\n+    err,\n+    _,\n+    errorContext\n+  ) => {\n+    if (routerServerContext?.logErrorWithOriginalStack) {\n+      routerServerContext.logErrorWithOriginalStack(err, 'app-dir')\n+    } else {\n+      console.error(err)\n+    }\n+    return onInstrumentationRequestError(\n+      req,\n+      err,\n+      {\n+        path: req.url || '/',\n+        headers: req.headers,\n+        method: req.method || 'GET',\n+      },\n+      errorContext\n+    )\n+  }\n+\n+  const nextConfig =\n+    routerServerContext?.nextConfig || serverFilesManifest.config\n+\n+  const pathname = parsedUrl.pathname || '/'\n+  const normalizedSrcPage = normalizeAppPath(srcPage)\n+  let isIsr = Boolean(\n+    prerenderManifest.dynamicRoutes[normalizedSrcPage] ||\n+      prerenderManifest.routes[normalizedSrcPage] ||\n+      prerenderManifest.routes[pathname]\n+  )\n+\n+  const couldSupportPPR: boolean = checkIsAppPPREnabled(\n+    nextConfig.experimental.ppr\n+  )\n+\n+  // When enabled, this will allow the use of the `?__nextppronly` query to\n+  // enable debugging of the static shell.\n+  const hasDebugStaticShellQuery =\n+    process.env.__NEXT_EXPERIMENTAL_STATIC_SHELL_DEBUGGING === '1' &&\n+    typeof query.__nextppronly !== 'undefined' &&\n+    couldSupportPPR\n+\n+  // When enabled, this will allow the use of the `?__nextppronly` query\n+  // to enable debugging of the fallback shell.\n+  const hasDebugFallbackShellQuery =\n+    hasDebugStaticShellQuery && query.__nextppronly === 'fallback'\n+\n+  // This page supports PPR if it is marked as being `PARTIALLY_STATIC` in the\n+  // prerender manifest and this is an app page.\n+  const isRoutePPREnabled = Boolean(\n+    couldSupportPPR &&\n+      ((\n+        prerenderManifest.routes[normalizedSrcPage] ??\n+        prerenderManifest.routes[pathname] ??\n+        prerenderManifest.dynamicRoutes[normalizedSrcPage]\n+      )?.renderingMode === 'PARTIALLY_STATIC' ||\n+        // Ideally we'd want to check the appConfig to see if this page has PPR\n+        // enabled or not, but that would require plumbing the appConfig through\n+        // to the server during development. We assume that the page supports it\n+        // but only during development.\n+        (hasDebugStaticShellQuery &&\n+          (routeModule.isDev || routerServerContext?.experimentalTestProxy)))\n+  )\n+\n+  const isDebugFallbackShell = hasDebugFallbackShellQuery && isRoutePPREnabled\n+\n+  const isDebugStaticShell: boolean =\n+    hasDebugStaticShellQuery && isRoutePPREnabled\n+\n+  // We should enable debugging dynamic accesses when the static shell\n+  // debugging has been enabled and we're also in development mode.\n+  const isDebugDynamicAccesses =\n+    isDebugStaticShell && routeModule.isDev === true\n+\n+  const isRSCRequest =\n+    getRequestMeta(req, 'isRSCRequest') || Boolean(req.headers[RSC_HEADER])\n+\n+  const userAgent = req.headers['user-agent'] || ''\n+  const botType = getBotType(userAgent)\n+  const isHtmlBot = isHtmlBotRequest(req)\n+  const shouldWaitOnAllReady = isHtmlBot && isRoutePPREnabled\n+  let serveStreamingMetadata = shouldServeStreamingMetadata(\n+    userAgent,\n+    // @ts-expect-error update for readonly\n+    nextConfig.htmlLimitedBots\n+  )\n+\n+  if (isHtmlBot && isRoutePPREnabled) {\n+    isIsr = false\n+    serveStreamingMetadata = false\n+  }\n+\n+  // If this is a dynamic route with PPR enabled and the default route\n+  // matches were set, then we should pass the fallback route params to\n+  // the renderer as this is a fallback revalidation request.\n+  const fallbackRouteParams =\n+    pageIsDynamic &&\n+    isRoutePPREnabled &&\n+    (getRequestMeta(req, 'renderFallbackShell') || isDebugFallbackShell)\n+      ? getFallbackRouteParams(normalizedSrcPage)\n+      : null\n+\n+  const ComponentMod = {\n+    ...entryBase,\n+    tree,\n+    pages,\n+    GlobalError,\n+    handler,\n+    routeModule,\n+    __next_app__,\n+  }\n+\n+  // Before rendering (which initializes component tree modules), we have to\n+  // set the reference manifests to our global store so Server Action's\n+  // encryption util can access to them at the top level of the page module.\n+  if (serverActionsManifest && clientReferenceManifest) {\n+    setReferenceManifestsSingleton({\n+      page: srcPage,\n+      clientReferenceManifest,\n+      serverActionsManifest,\n+      serverModuleMap: createServerModuleMap({\n+        serverActionsManifest,\n+      }),\n+    })\n+  }\n+\n+  const isPossibleServerAction = getIsPossibleServerAction(req)\n+\n+  /**\n+   * If true, this indicates that the request being made is for an app\n+   * prefetch request.\n+   */\n+  const isPrefetchRSCRequest =\n+    getRequestMeta(req, 'isPrefetchRSCRequest') ??\n+    Boolean(isRSCRequest && req.headers[NEXT_ROUTER_PREFETCH_HEADER])\n+\n+  // If PPR is enabled, and this is a RSC request (but not a prefetch), then\n+  // we can use this fact to only generate the flight data for the request\n+  // because we can't cache the HTML (as it's also dynamic).\n+  const isDynamicRSCRequest =\n+    isRoutePPREnabled && isRSCRequest && !isPrefetchRSCRequest\n+\n+  let supportsDynamicResponse: boolean =\n+    // If we're in development, we always support dynamic HTML\n+    routeModule.isDev === true ||\n+    // If this is not SSG or does not have static paths, then it supports\n+    // dynamic HTML.\n+    !isIsr ||\n+    // If this request has provided postponed data, it supports dynamic\n+    // HTML.\n+    typeof postponed === 'string' ||\n+    // If this is a dynamic RSC request, then this render supports dynamic\n+    // HTML (it's dynamic).\n+    isDynamicRSCRequest\n+\n+  // This is a revalidation request if the request is for a static\n+  // page and it is not being resumed from a postponed render and\n+  // it is not a dynamic RSC request then it is a revalidation\n+  // request.\n+  const isRevalidate =\n+    isIsr && !supportsDynamicResponse && !postponed && !isDynamicRSCRequest\n+\n+  const method = req.method || 'GET'\n+  const tracer = getTracer()\n+  const activeSpan = tracer.getActiveScopeSpan()\n+\n+  try {\n+    const invokeRouteModule = async (span?: Span) => {\n+      const context: AppPageRouteHandlerContext = {\n+        query,\n+        params,\n+        page: normalizedSrcPage,\n+        sharedContext: {\n+          buildId,\n+        },\n+        serverComponentsHmrCache: getRequestMeta(\n+          req,\n+          'serverComponentsHmrCache'\n+        ),\n+        fallbackRouteParams,\n+        renderOpts: {\n+          App: () => null,\n+          Document: () => null,\n+          pageConfig: {},\n+          ComponentMod,\n+          Component: interopDefault(ComponentMod),\n+\n+          params,\n+          routeModule,\n+          page: srcPage,\n+          postponed,\n+          shouldWaitOnAllReady,\n+          serveStreamingMetadata,\n+          supportsDynamicResponse,\n+          buildManifest,\n+          nextFontManifest,\n+          reactLoadableManifest,\n+          subresourceIntegrityManifest,\n+          serverActionsManifest,\n+          clientReferenceManifest,\n+          isPossibleServerAction,\n+          isOnDemandRevalidate,\n+          setIsrStatus: routerServerContext?.setIsrStatus,\n+\n+          dir: routeModule.projectDir,\n+          isDraftMode,\n+          isRevalidate,\n+          botType,\n+          assetPrefix: nextConfig.assetPrefix,\n+          nextConfigOutput: nextConfig.output,\n+          crossOrigin: nextConfig.crossOrigin,\n+          trailingSlash: nextConfig.trailingSlash,\n+          previewProps: prerenderManifest.preview,\n+          deploymentId: nextConfig.deploymentId,\n+          enableTainting: nextConfig.experimental.taint,\n+          // @ts-expect-error fix issue with readonly regex object type\n+          htmlLimitedBots: nextConfig.htmlLimitedBots,\n+          reactMaxHeadersLength: nextConfig.reactMaxHeadersLength,\n+\n+          multiZoneDraftMode,\n+          incrementalCache: getRequestMeta(req, 'incrementalCache'),\n+          cacheLifeProfiles: nextConfig.experimental.cacheLife,\n+          basePath: nextConfig.basePath,\n+          // @ts-expect-error fix issue with readonly regex object type\n+          serverActions: nextConfig.experimental.serverActions,\n+\n+          ...(isDebugStaticShell || isDebugDynamicAccesses\n+            ? {\n+                nextExport: true,\n+                supportsDynamicResponse: false,\n+                isStaticGeneration: true,\n+                isRevalidate: true,\n+                isDebugDynamicAccesses: isDebugDynamicAccesses,\n+              }\n+            : {}),\n+\n+          experimental: {\n+            isRoutePPREnabled,\n+            expireTime: nextConfig.expireTime,\n+            staleTimes: nextConfig.experimental.staleTimes,\n+            dynamicIO: Boolean(nextConfig.experimental.dynamicIO),\n+            clientSegmentCache: Boolean(\n+              nextConfig.experimental.clientSegmentCache\n+            ),\n+            dynamicOnHover: Boolean(nextConfig.experimental.dynamicOnHover),\n+            inlineCss: Boolean(nextConfig.experimental.inlineCss),\n+            authInterrupts: Boolean(nextConfig.experimental.authInterrupts),\n+            clientTraceMetadata:\n+              nextConfig.experimental.clientTraceMetadata || ([] as any),\n+          },\n+\n+          waitUntil: ctx.waitUntil,\n+          onClose: (cb) => {\n+            res.on('close', cb)\n+          },\n+          onAfterTaskError: () => {},\n+\n+          onInstrumentationRequestError: onError,\n+          err: getRequestMeta(req, 'invokeError'),\n+          dev: routeModule.isDev,\n+        },\n+      }\n+      const nextReq = new NodeNextRequest(req)\n+      const nextRes = new NodeNextResponse(res)\n+\n+      // TODO: adapt for putting the RDC inside the postponed data\n+      // If we're in dev, and this isn't a prefetch or a server action,\n+      // we should seed the resume data cache.\n+      if (process.env.NODE_ENV === 'development') {\n+        if (\n+          nextConfig.experimental.dynamicIO &&\n+          !isPrefetchRSCRequest &&\n+          !isPossibleServerAction\n+        ) {\n+          const warmup = await routeModule.warmup(nextReq, nextRes, context)\n+\n+          // If the warmup is successful, we should use the resume data\n+          // cache from the warmup.\n+          if (warmup.metadata.devRenderResumeDataCache) {\n+            context.renderOpts.devRenderResumeDataCache =\n+              warmup.metadata.devRenderResumeDataCache\n+          }\n+        }\n+      }\n+\n+      return routeModule.render(nextReq, nextRes, context).finally(() => {\n+        if (!span) return\n+\n+        span.setAttributes({\n+          'http.status_code': res.statusCode,\n+          'next.rsc': false,\n+        })\n+\n+        const rootSpanAttributes = tracer.getRootSpanAttributes()\n+        // We were unable to get attributes, probably OTEL is not enabled\n+        if (!rootSpanAttributes) {\n+          return\n+        }\n+\n+        if (\n+          rootSpanAttributes.get('next.span_type') !==\n+          BaseServerSpan.handleRequest\n+        ) {\n+          console.warn(\n+            `Unexpected root span type '${rootSpanAttributes.get(\n+              'next.span_type'\n+            )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n+          )\n+          return\n+        }\n+\n+        const route = rootSpanAttributes.get('next.route')\n+        if (route) {\n+          const name = `${method} ${route}`\n+\n+          span.setAttributes({\n+            'next.route': route,\n+            'http.route': route,\n+            'next.span_name': name,\n+          })\n+          span.updateName(name)\n+        } else {\n+          span.updateName(`${method} ${req.url}`)\n+        }\n+      })\n+    }\n+\n+    // TODO: activeSpan code path is for when wrapped by\n+    // next-server can be removed when this is no longer used\n+    if (activeSpan) {\n+      return await invokeRouteModule(activeSpan)\n+    } else {\n+      return await tracer.withPropagatedContext(req.headers, () =>\n+        tracer.trace(\n+          BaseServerSpan.handleRequest,\n+          {\n+            spanName: `${method} ${req.url}`,\n+            kind: SpanKind.SERVER,\n+            attributes: {\n+              'http.method': method,\n+              'http.target': req.url,\n+            },\n+          },\n+          invokeRouteModule\n+        )\n+      )\n+    }\n+  } catch (err) {\n+    // if we aren't wrapped by base-server handle here\n+    if (!activeSpan) {\n+      await onError(err, req, {\n+        routerKind: 'App Router',\n+        routePath: srcPage,\n+        routeType: 'render',\n+        revalidateReason: getRevalidateReason({\n+          isRevalidate,\n+          isOnDemandRevalidate,\n+        }),\n+      })\n+    }\n+\n+    // rethrow so that we can handle serving error page\n+    throw err\n+  }\n+}"
        },
        {
            "sha": "0068c580a26061100a5374daef38fa8e8c6ee260",
            "filename": "packages/next/src/build/templates/pages.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -245,6 +245,7 @@ export async function handler(\n             locale,\n             locales,\n             defaultLocale,\n+            setIsrStatus: routerServerContext?.setIsrStatus,\n \n             isNextDataRequest:\n               isNextDataRequest && (hasServerProps || hasStaticProps),"
        },
        {
            "sha": "6901c3382fbf7f79715369fbf66af4d637adc875",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 87,
            "deletions": 84,
            "changes": 171,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -2779,56 +2779,59 @@ export default abstract class Server<\n             return null\n           }\n \n-          if (isPagesRouteModule(routeModule)) {\n-            const request = isNodeNextRequest(req) ? req.originalRequest : req\n+          const request = isNodeNextRequest(req) ? req.originalRequest : req\n+          const response = isNodeNextResponse(res) ? res.originalResponse : res\n \n-            const response = isNodeNextResponse(res)\n-              ? res.originalResponse\n-              : res\n-\n-            if (\n-              components.ComponentMod.handler &&\n-              process.env.NEXT_RUNTIME !== 'edge'\n-            ) {\n-              const parsedInitUrl = parseUrl(\n-                getRequestMeta(req, 'initURL') || req.url\n-              )\n-              request.url =\n-                req.url = `${parsedInitUrl.pathname}${parsedInitUrl.search || ''}`\n-\n-              // propagate the request context for dev\n-              setRequestMeta(request, getRequestMeta(req))\n-              addRequestMeta(request, 'projectDir', this.dir)\n-              addRequestMeta(request, 'isIsrFallback', pagesFallback)\n-              addRequestMeta(request, 'query', query)\n-              addRequestMeta(request, 'params', opts.params)\n-              addRequestMeta(\n-                request,\n-                'ampValidator',\n-                this.renderOpts.ampValidator\n-              )\n+          if (\n+            components.ComponentMod.handler &&\n+            process.env.NEXT_RUNTIME !== 'edge'\n+          ) {\n+            const parsedInitUrl = parseUrl(\n+              getRequestMeta(req, 'initURL') || req.url\n+            )\n+            request.url =\n+              req.url = `${parsedInitUrl.pathname}${parsedInitUrl.search || ''}`\n+\n+            // propagate the request context for dev\n+            setRequestMeta(request, getRequestMeta(req))\n+            addRequestMeta(request, 'postponed', postponed)\n+            addRequestMeta(request, 'projectDir', this.dir)\n+            addRequestMeta(request, 'isIsrFallback', pagesFallback)\n+            addRequestMeta(\n+              request,\n+              'renderFallbackShell',\n+              Boolean(fallbackRouteParams)\n+            )\n+            addRequestMeta(request, 'query', query)\n+            addRequestMeta(request, 'params', opts.params)\n+            addRequestMeta(\n+              request,\n+              'ampValidator',\n+              this.renderOpts.ampValidator\n+            )\n \n-              if (renderOpts.err) {\n-                addRequestMeta(request, 'invokeError', renderOpts.err)\n+            if (renderOpts.err) {\n+              addRequestMeta(request, 'invokeError', renderOpts.err)\n+            }\n+            const handler: (\n+              req: ServerRequest | IncomingMessage,\n+              res: ServerResponse | HTTPServerResponse,\n+              ctx: {\n+                waitUntil: ReturnType<Server['getWaitUntil']>\n               }\n-              const handler: (\n-                req: ServerRequest | IncomingMessage,\n-                res: ServerResponse | HTTPServerResponse,\n-                ctx: {\n-                  waitUntil: ReturnType<Server['getWaitUntil']>\n-                }\n-              ) => Promise<RenderResult> = components.ComponentMod.handler\n+            ) => Promise<RenderResult> = components.ComponentMod.handler\n \n-              result = await handler(request, response, {\n-                waitUntil: this.getWaitUntil(),\n-              })\n+            result = await handler(request, response, {\n+              waitUntil: this.getWaitUntil(),\n+            })\n \n-              if (!result) {\n-                throw new Error(\n-                  `Invariant: missing result from invoking ${pathname} handler`\n-                )\n-              }\n-            } else {\n+            if (!result) {\n+              throw new Error(\n+                `Invariant: missing result from invoking ${pathname} handler`\n+              )\n+            }\n+          } else {\n+            if (isPagesRouteModule(routeModule)) {\n               // Due to the way we pass data by mutating `renderOpts`, we can't extend\n               // the object here but only updating its `clientReferenceManifest` and\n               // `nextFontManifest` properties.\n@@ -2875,48 +2878,48 @@ export default abstract class Server<\n                 })\n                 throw err\n               }\n-            }\n-          } else {\n-            const module = components.routeModule as AppPageRouteModule\n-\n-            // Due to the way we pass data by mutating `renderOpts`, we can't extend the\n-            // object here but only updating its `nextFontManifest` field.\n-            // https://github.com/vercel/next.js/blob/df7cbd904c3bd85f399d1ce90680c0ecf92d2752/packages/next/server/render.tsx#L947-L952\n-            renderOpts.nextFontManifest = this.nextFontManifest\n-\n-            const context: AppPageRouteHandlerContext = {\n-              page: is404Page ? '/404' : pathname,\n-              params: opts.params,\n-              query,\n-              fallbackRouteParams,\n-              renderOpts,\n-              serverComponentsHmrCache: this.getServerComponentsHmrCache(),\n-              sharedContext: {\n-                buildId: this.buildId,\n-              },\n-            }\n+            } else {\n+              const module = components.routeModule as AppPageRouteModule\n \n-            // TODO: adapt for putting the RDC inside the postponed data\n-            // If we're in dev, and this isn't a prefetch or a server action,\n-            // we should seed the resume data cache.\n-            if (\n-              this.nextConfig.experimental.dynamicIO &&\n-              this.renderOpts.dev &&\n-              !isPrefetchRSCRequest &&\n-              !isPossibleServerAction\n-            ) {\n-              const warmup = await module.warmup(req, res, context)\n+              // Due to the way we pass data by mutating `renderOpts`, we can't extend the\n+              // object here but only updating its `nextFontManifest` field.\n+              // https://github.com/vercel/next.js/blob/df7cbd904c3bd85f399d1ce90680c0ecf92d2752/packages/next/server/render.tsx#L947-L952\n+              renderOpts.nextFontManifest = this.nextFontManifest\n \n-              // If the warmup is successful, we should use the resume data\n-              // cache from the warmup.\n-              if (warmup.metadata.devRenderResumeDataCache) {\n-                renderOpts.devRenderResumeDataCache =\n-                  warmup.metadata.devRenderResumeDataCache\n+              const context: AppPageRouteHandlerContext = {\n+                page: is404Page ? '/404' : pathname,\n+                params: opts.params,\n+                query,\n+                fallbackRouteParams,\n+                renderOpts,\n+                serverComponentsHmrCache: this.getServerComponentsHmrCache(),\n+                sharedContext: {\n+                  buildId: this.buildId,\n+                },\n               }\n-            }\n \n-            // Call the built-in render method on the module.\n-            result = await module.render(req, res, context)\n+              // TODO: adapt for putting the RDC inside the postponed data\n+              // If we're in dev, and this isn't a prefetch or a server action,\n+              // we should seed the resume data cache.\n+              if (\n+                this.nextConfig.experimental.dynamicIO &&\n+                this.renderOpts.dev &&\n+                !isPrefetchRSCRequest &&\n+                !isPossibleServerAction\n+              ) {\n+                const warmup = await module.warmup(req, res, context)\n+\n+                // If the warmup is successful, we should use the resume data\n+                // cache from the warmup.\n+                if (warmup.metadata.devRenderResumeDataCache) {\n+                  renderOpts.devRenderResumeDataCache =\n+                    warmup.metadata.devRenderResumeDataCache\n+                }\n+              }\n+\n+              // Call the built-in render method on the module.\n+              result = await module.render(req, res, context)\n+            }\n           }\n         } else {\n           throw new Error('Invariant: Unknown route module type')\n@@ -3205,7 +3208,7 @@ export default abstract class Server<\n                 postponed: undefined,\n                 pagesFallback: undefined,\n                 fallbackRouteParams:\n-                  // If we're in production of we're debugging the fallback\n+                  // If we're in production or we're debugging the fallback\n                   // shell then we should postpone when dynamic params are\n                   // accessed.\n                   isProduction || isDebugFallbackShell"
        },
        {
            "sha": "ac319c0554d48556c19fd62e3208127fdc33b038",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -676,6 +676,11 @@ export async function initialize(opts: {\n     nextConfig: config,\n     hostname: handlers.server.hostname,\n     revalidate: handlers.server.revalidate.bind(handlers.server),\n+    experimentalTestProxy: renderServerOpts.experimentalTestProxy,\n+    logErrorWithOriginalStack: opts.dev\n+      ? handlers.server.logErrorWithOriginalStack.bind(handlers.server)\n+      : (err: unknown) => Log.error(err),\n+    setIsrStatus: devBundlerService?.setIsrStatus.bind(devBundlerService),\n   }\n \n   const logError = async ("
        },
        {
            "sha": "2c300a60fa9659198d5b951d2f409f5c5256f967",
            "filename": "packages/next/src/server/lib/router-utils/block-cross-site.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -1,5 +1,5 @@\n import type { Duplex } from 'stream'\n-import type { IncomingMessage, ServerResponse } from 'webpack-dev-server'\n+import type { IncomingMessage, ServerResponse } from 'node:http'\n import { parseUrl } from '../../../lib/url'\n import { warnOnce } from '../../../build/output/log'\n import { isCsrfOriginAllowed } from '../../app-render/csrf-protection'"
        },
        {
            "sha": "f833c27b71dd6b48a54c95ef314283c78432f50f",
            "filename": "packages/next/src/server/lib/router-utils/router-server-context.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -25,6 +25,12 @@ export type RouterServerContext = Record<\n     nextConfig?: NextConfigComplete\n     // whether running in custom server mode\n     isCustomServer?: boolean\n+    // whether test proxy is enabled\n+    experimentalTestProxy?: boolean\n+    // allow dev server to log with original stack\n+    logErrorWithOriginalStack?: (err: unknown, type: string) => void\n+    // allow setting ISR status in dev\n+    setIsrStatus?: (key: string, value: boolean | null) => void\n   }\n >\n "
        },
        {
            "sha": "02ed8569c3a08ebc3c82dfeced65fe949d28629d",
            "filename": "packages/next/src/server/lib/streaming-metadata.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstreaming-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstreaming-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstreaming-metadata.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -20,7 +20,9 @@ export function shouldServeStreamingMetadata(\n \n // When the request UA is a html-limited bot, we should do a dynamic render.\n // In this case, postpone state is not sent.\n-export function isHtmlBotRequest(req: BaseNextRequest): boolean {\n+export function isHtmlBotRequest(req: {\n+  headers: BaseNextRequest['headers']\n+}): boolean {\n   const ua = req.headers['user-agent'] || ''\n   const botType = getBotType(ua)\n "
        },
        {
            "sha": "254808e07952d3d7f7fa61d24ea36349d1e5df76",
            "filename": "packages/next/src/server/load-manifest.external.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Fload-manifest.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Fload-manifest.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fload-manifest.external.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -115,6 +115,7 @@ export function loadManifestFromRelativePath<T extends object>({\n   cache,\n   skipParse,\n   handleMissing,\n+  useEval,\n }: {\n   projectDir: string\n   distDir: string\n@@ -123,14 +124,19 @@ export function loadManifestFromRelativePath<T extends object>({\n   cache?: Map<string, unknown>\n   skipParse?: boolean\n   handleMissing?: boolean\n+  useEval?: boolean\n }): DeepReadonly<T> {\n   try {\n-    return loadManifest<T>(\n-      join(/* turbopackIgnore: true */ projectDir, distDir, manifest),\n-      shouldCache,\n-      cache,\n-      skipParse\n+    const manifestPath = join(\n+      /* turbopackIgnore: true */ projectDir,\n+      distDir,\n+      manifest\n     )\n+\n+    if (useEval) {\n+      return evalManifest<T>(manifestPath, shouldCache, cache)\n+    }\n+    return loadManifest<T>(manifestPath, shouldCache, cache, skipParse)\n   } catch (err) {\n     if (handleMissing) {\n       // TODO: should this be undefined"
        },
        {
            "sha": "55ce632bd8b539ae63fbae2498230d09dace1028",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -86,6 +86,8 @@ interface NextWrapperServer {\n     ...args: Parameters<NextNodeServer['revalidate']>\n   ): ReturnType<NextNodeServer['revalidate']>\n \n+  logErrorWithOriginalStack(err: unknown, type: string): void\n+\n   render(\n     ...args: Parameters<NextNodeServer['render']>\n   ): ReturnType<NextNodeServer['render']>\n@@ -165,6 +167,14 @@ export class NextServer implements NextWrapperServer {\n     }\n   }\n \n+  async logErrorWithOriginalStack(err: unknown, type: string) {\n+    const server = await this.getServer()\n+    // this is only available on dev server\n+    if ((server as any).logErrorWithOriginalStack) {\n+      return (server as any).logErrorWithOriginalStack(err, type)\n+    }\n+  }\n+\n   async revalidate(...args: Parameters<NextWrapperServer['revalidate']>) {\n     const server = await this.getServer()\n     return server.revalidate(...args)\n@@ -452,6 +462,10 @@ class NextCustomServer implements NextWrapperServer {\n     this.server.logError(...args)\n   }\n \n+  logErrorWithOriginalStack(err: unknown, type: string) {\n+    return this.server.logErrorWithOriginalStack(err, type)\n+  }\n+\n   async revalidate(...args: Parameters<NextWrapperServer['revalidate']>) {\n     return this.server.revalidate(...args)\n   }"
        },
        {
            "sha": "12ea396d09b39c5488863af80665331e50010582",
            "filename": "packages/next/src/server/route-modules/app-page/module.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -58,6 +58,13 @@ export class AppPageRouteModule extends RouteModule<\n   AppPageRouteDefinition,\n   AppPageUserlandModule\n > {\n+  constructor(\n+    options: RouteModuleOptions<AppPageRouteDefinition, AppPageUserlandModule>\n+  ) {\n+    super(options)\n+    this.isAppRouter = true\n+  }\n+\n   public render(\n     req: BaseNextRequest,\n     res: BaseNextResponse,"
        },
        {
            "sha": "d138ec927149b1e9524e055be9927717e303c919",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 100,
            "deletions": 13,
            "changes": 113,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -13,11 +13,14 @@ import type { DeepReadonly } from '../../shared/lib/deep-readonly'\n import {\n   BUILD_ID_FILE,\n   BUILD_MANIFEST,\n+  CLIENT_REFERENCE_MANIFEST,\n   NEXT_FONT_MANIFEST,\n   PRERENDER_MANIFEST,\n   REACT_LOADABLE_MANIFEST,\n   ROUTES_MANIFEST,\n   SERVER_FILES_MANIFEST,\n+  SERVER_REFERENCE_MANIFEST,\n+  SUBRESOURCE_INTEGRITY_MANIFEST,\n } from '../../shared/lib/constants'\n import { parseReqUrl } from '../../lib/url'\n import {\n@@ -38,6 +41,7 @@ import { normalizeDataPath } from '../../shared/lib/page-path/normalize-data-pat\n import { pathHasPrefix } from '../../shared/lib/router/utils/path-has-prefix'\n import { addRequestMeta, getRequestMeta } from '../request-meta'\n import { normalizePagePath } from '../../shared/lib/page-path/normalize-page-path'\n+import { isStaticMetadataRoute } from '../../lib/metadata/is-metadata-route'\n \n /**\n  * RouteModuleOptions is the options that are passed to the route module, other\n@@ -93,6 +97,7 @@ export abstract class RouteModule<\n   public isDev: boolean\n   public distDir: string\n   public projectDir: string\n+  public isAppRouter?: boolean\n \n   constructor({\n     userland,\n@@ -140,6 +145,9 @@ export abstract class RouteModule<\n         buildManifest,\n         reactLoadableManifest,\n         nextFontManifest,\n+        clientReferenceManifest,\n+        serverActionsManifest,\n+        subresourceIntegrityManifest,\n         serverFilesManifest,\n         buildId,\n       ] = await Promise.all([\n@@ -162,7 +170,7 @@ export abstract class RouteModule<\n           projectDir,\n           distDir: this.distDir,\n           manifest: process.env.TURBOPACK\n-            ? `server/pages${normalizedPagePath}/${REACT_LOADABLE_MANIFEST}`\n+            ? `server/${this.isAppRouter ? 'app' : 'pages'}${normalizedPagePath}/${REACT_LOADABLE_MANIFEST}`\n             : REACT_LOADABLE_MANIFEST,\n           handleMissing: true,\n         }),\n@@ -171,6 +179,32 @@ export abstract class RouteModule<\n           distDir: this.distDir,\n           manifest: `server/${NEXT_FONT_MANIFEST}.json`,\n         }),\n+        this.isAppRouter && !isStaticMetadataRoute(srcPage)\n+          ? loadManifestFromRelativePath({\n+              distDir: this.distDir,\n+              projectDir,\n+              useEval: true,\n+              handleMissing: true,\n+              manifest: `server/app${srcPage.replace(/%5F/g, '_') + '_' + CLIENT_REFERENCE_MANIFEST}.js`,\n+              shouldCache: !this.isDev,\n+            })\n+          : undefined,\n+        this.isAppRouter\n+          ? loadManifestFromRelativePath<any>({\n+              distDir: this.distDir,\n+              projectDir,\n+              manifest: `server/${SERVER_REFERENCE_MANIFEST}.json`,\n+              handleMissing: true,\n+              shouldCache: !this.isDev,\n+            })\n+          : {},\n+        loadManifestFromRelativePath<Record<string, string>>({\n+          projectDir,\n+          distDir: this.distDir,\n+          manifest: `server/${SUBRESOURCE_INTEGRITY_MANIFEST}.json`,\n+          handleMissing: true,\n+          shouldCache: !this.isDev,\n+        }),\n         this.isDev\n           ? ({} as any)\n           : loadManifestFromRelativePath<RequiredServerFilesManifest>({\n@@ -196,6 +230,10 @@ export abstract class RouteModule<\n         prerenderManifest,\n         serverFilesManifest,\n         reactLoadableManifest,\n+        clientReferenceManifest: (clientReferenceManifest as any)\n+          ?.__RSC_MANIFEST?.[srcPage.replace(/%5F/g, '_')],\n+        serverActionsManifest,\n+        subresourceIntegrityManifest,\n       }\n     }\n     throw new Error('Invariant: loadManifests called for edge runtime')\n@@ -223,6 +261,7 @@ export abstract class RouteModule<\n         params?: ParsedUrlQuery\n         parsedUrl: UrlWithParsedQuery\n         previewData: PreviewData\n+        pageIsDynamic: boolean\n         isDraftMode: boolean\n         isNextDataRequest: boolean\n         buildManifest: DeepReadonly<BuildManifest>\n@@ -231,6 +270,11 @@ export abstract class RouteModule<\n         reactLoadableManifest: DeepReadonly<ReactLoadableManifest>\n         routesManifest: DeepReadonly<DevRoutesManifest>\n         prerenderManifest: DeepReadonly<PrerenderManifest>\n+        // we can't pull in the client reference type or it causes issues with\n+        // our pre-compiled types\n+        clientReferenceManifest?: any\n+        serverActionsManifest?: any\n+        subresourceIntegrityManifest?: DeepReadonly<Record<string, string>>\n         isOnDemandRevalidate: boolean\n         revalidateOnlyGenerated: boolean\n       }\n@@ -339,11 +383,16 @@ export abstract class RouteModule<\n \n       // attempt parsing from pathname\n       if (!params && serverUtils.dynamicRouteMatcher) {\n-        const paramsResult = serverUtils.dynamicRouteMatcher(\n+        const paramsMatch = serverUtils.dynamicRouteMatcher(\n           normalizeDataPath(localeResult?.pathname || parsedUrl.pathname || '/')\n         )\n-        if (paramsResult) {\n-          params = paramsResult\n+        const paramsResult = serverUtils.normalizeDynamicRouteParams(\n+          paramsMatch || {},\n+          true\n+        )\n+\n+        if (paramsResult.hasValidParams) {\n+          params = paramsResult.params\n         }\n       }\n \n@@ -361,14 +410,34 @@ export abstract class RouteModule<\n       }\n \n       const routeParamKeys = new Set<string>()\n-      const combinedParamKeys = [...rewriteParamKeys, ...routeParamKeys]\n+      const combinedParamKeys = [...routeParamKeys]\n+\n+      for (const key of rewriteParamKeys) {\n+        // We only want to filter rewrite param keys from the URL\n+        // if they are matches from the URL e.g. the key/value matches\n+        // before and after applying the rewrites /:path for /hello and\n+        // { path: 'hello' } but not for { path: 'another' } and /hello\n+        // TODO: we should prefix rewrite param keys the same as we do\n+        // for dynamic routes so we can identify them properly\n+        const originalValue = Array.isArray(originalQuery[key])\n+          ? originalQuery[key].join('')\n+          : originalQuery[key]\n+\n+        const queryValue = Array.isArray(query[key])\n+          ? query[key].join('')\n+          : query[key]\n+\n+        if (!(key in originalQuery) || originalValue === queryValue) {\n+          combinedParamKeys.push(key)\n+        }\n+      }\n \n       serverUtils.normalizeCdnUrl(req, combinedParamKeys)\n       serverUtils.normalizeQueryParams(query, routeParamKeys)\n       serverUtils.filterInternalQuery(originalQuery, combinedParamKeys)\n \n       if (pageIsDynamic) {\n-        const result = serverUtils.normalizeDynamicRouteParams(query, true)\n+        const queryResult = serverUtils.normalizeDynamicRouteParams(query, true)\n \n         req.url = serverUtils.interpolateDynamicPath(\n           req.url || '/',\n@@ -384,13 +453,28 @@ export abstract class RouteModule<\n         )\n \n         // try pulling from query if valid\n-        if (result.hasValidParams) {\n-          params = Object.assign({}, result.params, params)\n-\n-          // If we pulled from query remove it so it's\n-          // only in params\n-          for (const key in params) {\n-            delete query[key]\n+        if (!params) {\n+          if (queryResult.hasValidParams) {\n+            params = Object.assign({}, queryResult.params)\n+\n+            // If we pulled from query remove it so it's\n+            // only in params\n+            for (const key in serverUtils.defaultRouteMatches) {\n+              delete query[key]\n+            }\n+          } else {\n+            // use final params from URL matching\n+            const paramsMatch = serverUtils.dynamicRouteMatcher?.(\n+              normalizeDataPath(\n+                localeResult?.pathname || parsedUrl.pathname || '/'\n+              )\n+            )\n+            // we don't normalize these as they are allowed to be\n+            // the literal slug matches here e.g. /blog/[slug]\n+            // actually being requested\n+            if (paramsMatch) {\n+              params = Object.assign({}, paramsMatch)\n+            }\n           }\n         }\n       }\n@@ -433,9 +517,12 @@ export abstract class RouteModule<\n         defaultLocale,\n         isDraftMode,\n         previewData,\n+        pageIsDynamic,\n         isOnDemandRevalidate,\n         revalidateOnlyGenerated,\n         ...manifests,\n+        serverActionsManifest: manifests.serverActionsManifest,\n+        clientReferenceManifest: manifests.clientReferenceManifest,\n       }\n     }\n   }"
        },
        {
            "sha": "840584495bc6e0527e8e539d1091898dfb76f127",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -105,7 +105,9 @@ export function interpolateDynamicPath(\n       paramValue = ''\n     }\n \n-    pathname = pathname.replaceAll(builtParam, paramValue)\n+    if (paramValue || optional) {\n+      pathname = pathname.replaceAll(builtParam, paramValue)\n+    }\n   }\n \n   return pathname"
        },
        {
            "sha": "248ca50e3036d6bfa31079fd2ab7b5a24a44d8c3",
            "filename": "test/e2e/on-request-error/isr/instrumentation.js",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/test%2Fe2e%2Fon-request-error%2Fisr%2Finstrumentation.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/test%2Fe2e%2Fon-request-error%2Fisr%2Finstrumentation.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fon-request-error%2Fisr%2Finstrumentation.js?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -1,12 +1,11 @@\n import fs from 'fs'\n-import fsp from 'fs/promises'\n import path from 'path'\n \n const dir = path.dirname(new URL(import.meta.url).pathname)\n const logPath = path.join(dir, 'output-log.json')\n \n export async function register() {\n-  await fsp.writeFile(logPath, '{}', 'utf8')\n+  fs.writeFileSync(logPath, '{}', 'utf8')\n }\n \n // Since only Node.js runtime support ISR, we can just write the error state to a file here.\n@@ -19,13 +18,13 @@ export async function onRequestError(err, request, context) {\n   }\n \n   const json = fs.existsSync(logPath)\n-    ? JSON.parse(await fsp.readFile(logPath, 'utf8'))\n+    ? JSON.parse(fs.readFileSync(logPath, 'utf8'))\n     : {}\n \n   json[payload.message] = payload\n \n   console.log(\n     `[instrumentation] write-log:${payload.message} ${payload.context.revalidateReason}`\n   )\n-  await fsp.writeFile(logPath, JSON.stringify(json, null, 2), 'utf8')\n+  fs.writeFileSync(logPath, JSON.stringify(json, null, 2), 'utf8')\n }"
        },
        {
            "sha": "75c135a580d0d2e84b1a96462bc68d6df5135cf0",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -1266,7 +1266,7 @@ describe('required server files', () => {\n     )\n \n     const json = await res.json()\n-    expect(json.query).toEqual({ another: 'value', rest: ['index'] })\n+    expect(json.query).toEqual({ another: 'value' })\n     expect(json.url).toBe('/api/optional/index?another=value')\n   })\n "
        },
        {
            "sha": "2d61330fe46dd9cd6397762685e9b5e9de209ace",
            "filename": "test/rspack-build-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/test%2Frspack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/test%2Frspack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-build-tests-manifest.json?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -17729,7 +17729,6 @@\n   },\n   \"test/integration/server-side-dev-errors/test/index.test.js\": {\n     \"passed\": [\n-      \"server-side dev errors should show server-side error for dynamic api route correctly\",\n       \"server-side dev errors should show server-side error for dynamic gssp page correctly\",\n       \"server-side dev errors should show server-side error for gsp page correctly\",\n       \"server-side dev errors should show server-side error for gssp page correctly\",\n@@ -17739,7 +17738,8 @@\n       \"server-side dev errors should show server-side error for uncaught rejection correctly\"\n     ],\n     \"failed\": [\n-      \"server-side dev errors should show server-side error for api route correctly\"\n+      \"server-side dev errors should show server-side error for api route correctly\",\n+      \"server-side dev errors should show server-side error for dynamic api route correctly\"\n     ],\n     \"pending\": [],\n     \"flakey\": [],"
        },
        {
            "sha": "94617a845673435686bc1ed8234c4e3d51bd109a",
            "filename": "test/rspack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/test%2Frspack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23/test%2Frspack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-dev-tests-manifest.json?ref=1dcc7fe97a838e36174ed1bdcb38fd8f525e1f23",
            "patch": "@@ -21205,12 +21205,12 @@\n   },\n   \"test/integration/server-side-dev-errors/test/index.test.js\": {\n     \"passed\": [\n-      \"server-side dev errors should show server-side error for api route correctly\",\n       \"server-side dev errors should show server-side error for dynamic gssp page correctly\",\n       \"server-side dev errors should show server-side error for gsp page correctly\",\n       \"server-side dev errors should show server-side error for gssp page correctly\"\n     ],\n     \"failed\": [\n+      \"server-side dev errors should show server-side error for api route correctly\",\n       \"server-side dev errors should show server-side error for dynamic api route correctly\",\n       \"server-side dev errors should show server-side error for uncaught empty exception correctly\",\n       \"server-side dev errors should show server-side error for uncaught empty rejection correctly\","
        }
    ],
    "stats": {
        "total": 828,
        "additions": 713,
        "deletions": 115
    }
}