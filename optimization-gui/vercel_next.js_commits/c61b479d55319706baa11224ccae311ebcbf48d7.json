{
    "author": "eps1lon",
    "message": "[test] Improve coverage for fetch errors in Edge runtime (#78257)",
    "sha": "c61b479d55319706baa11224ccae311ebcbf48d7",
    "files": [
        {
            "sha": "61a10d14fa6ce8b29f8a155c6eadd52723261038",
            "filename": "test/e2e/fetch-failures-have-good-stack-traces-in-edge-runtime/fetch-failures-have-good-stack-traces-in-edge-runtime.test.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 18,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/c61b479d55319706baa11224ccae311ebcbf48d7/test%2Fe2e%2Ffetch-failures-have-good-stack-traces-in-edge-runtime%2Ffetch-failures-have-good-stack-traces-in-edge-runtime.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c61b479d55319706baa11224ccae311ebcbf48d7/test%2Fe2e%2Ffetch-failures-have-good-stack-traces-in-edge-runtime%2Ffetch-failures-have-good-stack-traces-in-edge-runtime.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ffetch-failures-have-good-stack-traces-in-edge-runtime%2Ffetch-failures-have-good-stack-traces-in-edge-runtime.test.ts?ref=c61b479d55319706baa11224ccae311ebcbf48d7",
            "patch": "@@ -1,15 +1,10 @@\n import { nextTestSetup } from 'e2e-utils'\n import webdriver from 'next-webdriver'\n-import {\n-  assertHasRedbox,\n-  getRedboxSource,\n-  getRedboxDescription,\n-  check,\n-} from 'next-test-utils'\n+import { check } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n \n describe('fetch failures have good stack traces in edge runtime', () => {\n-  const { next, isNextStart, isNextDev, skipped } = nextTestSetup({\n+  const { isTurbopack, next, isNextStart, isNextDev, skipped } = nextTestSetup({\n     files: __dirname,\n     // don't have access to runtime logs on deploy\n     skipDeployment: true,\n@@ -20,22 +15,46 @@ describe('fetch failures have good stack traces in edge runtime', () => {\n   }\n \n   it('when awaiting `fetch` using an unknown domain, stack traces are preserved', async () => {\n+    const outputIndex = next.cliOutput.length\n     const browser = await webdriver(next.url, '/api/unknown-domain')\n \n     if (isNextStart) {\n-      expect(next.cliOutput).toMatch(/at.+\\/pages\\/api\\/unknown-domain.js/)\n+      expect(next.cliOutput.slice(outputIndex)).toMatch(\n+        /at.+\\/pages\\/api\\/unknown-domain.js/\n+      )\n     } else if (isNextDev) {\n-      // TODO(veil): Apply sourcemap\n-      expect(next.cliOutput).toContain('\\n    at anotherFetcher (')\n+      expect(stripAnsi(next.cliOutput.slice(outputIndex))).toContain(\n+        '' +\n+          '\\n тип Error [TypeError]: fetch failed' +\n+          '\\n    at anotherFetcher (src/fetcher.js:6:15)' +\n+          '\\n    at fetcher (src/fetcher.js:2:15)' +\n+          '\\n    at UnknownDomainEndpoint (pages/api/unknown-domain.js:6:16)' +\n+          '\\n  4 |' +\n+          '\\n  5 | async function anotherFetcher(...args) {' +\n+          '\\n> 6 |   return await fetch(...args)' +\n+          '\\n    |               ^' +\n+          '\\n  7 | }' +\n+          '\\n  8 |' +\n+          // TODO(veil): Why double error?\n+          '\\n тип Error [TypeError]: fetch failed'\n+      )\n \n-      await assertHasRedbox(browser)\n-      const source = await getRedboxSource(browser)\n-\n-      expect(source).toContain('async function anotherFetcher(...args)')\n-      expect(source).toContain(`fetch(...args)`)\n-\n-      const description = await getRedboxDescription(browser)\n-      expect(description).toEqual('TypeError: fetch failed')\n+      // TODO(veil): Why column off by one?\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"TypeError: fetch failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"src/fetcher.js (6:16) @ anotherFetcher\n+       > 6 |   return await fetch(...args)\n+           |                ^\",\n+         \"stack\": [\n+           \"anotherFetcher src/fetcher.js (6:16)\",\n+           \"fetcher src/fetcher.js (2:16)\",\n+           \"UnknownDomainEndpoint pages/api/unknown-domain.js (6:${isTurbopack ? 15 : 16})\",\n+         ],\n+       }\n+      `)\n     }\n   })\n "
        },
        {
            "sha": "e475f75746ec084e800b89a99b0360470a9c7929",
            "filename": "test/e2e/fetch-failures-have-good-stack-traces-in-edge-runtime/pages/api/unknown-domain-no-await.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c61b479d55319706baa11224ccae311ebcbf48d7/test%2Fe2e%2Ffetch-failures-have-good-stack-traces-in-edge-runtime%2Fpages%2Fapi%2Funknown-domain-no-await.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c61b479d55319706baa11224ccae311ebcbf48d7/test%2Fe2e%2Ffetch-failures-have-good-stack-traces-in-edge-runtime%2Fpages%2Fapi%2Funknown-domain-no-await.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ffetch-failures-have-good-stack-traces-in-edge-runtime%2Fpages%2Fapi%2Funknown-domain-no-await.ts?ref=c61b479d55319706baa11224ccae311ebcbf48d7",
            "patch": "@@ -1,8 +1,8 @@\n export const config = { runtime: 'edge' }\n \n export default async function UnknownDomainEndpoint() {\n-  fetch('http://an.unknown.domain.nextjs').catch((err) => {\n-    console.error(`stack is:`, err.stack)\n+  fetch('http://an.unknown.domain.nextjs').catch((reason) => {\n+    console.error(reason)\n   })\n \n   return new Response('okay.')"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 39,
        "deletions": 20
    }
}