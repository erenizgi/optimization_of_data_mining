{
    "author": "gaojude",
    "message": "feat: build lifecycle hooks - afterProductionCompile (#77345)\n\nAdd a `runAfterProductionCompile` hook in next.config.js that executes\nafter production build compilation finishes, but before running\npost-compilation tasks like type checking and static page generation.\nThis hook provides access to project metadata including the project\ndirectory and build output directory, making it useful for third-party\nto collect build outputs like sourcemaps.",
    "sha": "ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
    "files": [
        {
            "sha": "5fa214522bae923192aed128cb9f2b934ecf0f06",
            "filename": "packages/next/src/build/after-production-compile.ts",
            "status": "added",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/packages%2Fnext%2Fsrc%2Fbuild%2Fafter-production-compile.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/packages%2Fnext%2Fsrc%2Fbuild%2Fafter-production-compile.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fafter-production-compile.ts?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -0,0 +1,63 @@\n+import type { NextConfigComplete } from '../server/config-shared'\n+import type { Span } from '../trace'\n+\n+import * as Log from './output/log'\n+import createSpinner from './spinner'\n+import isError from '../lib/is-error'\n+import type { Telemetry } from '../telemetry/storage'\n+import { EVENT_BUILD_FEATURE_USAGE } from '../telemetry/events/build'\n+\n+// TODO: refactor this to account for more compiler lifecycle events\n+// such as beforeProductionBuild, but for now this is the only one that is needed\n+export async function runAfterProductionCompile({\n+  config,\n+  buildSpan,\n+  telemetry,\n+  metadata,\n+}: {\n+  config: NextConfigComplete\n+  buildSpan: Span\n+  telemetry: Telemetry\n+  metadata: {\n+    projectDir: string\n+    distDir: string\n+  }\n+}): Promise<void> {\n+  const run = config.compiler.runAfterProductionCompile\n+  if (!run) {\n+    return\n+  }\n+  telemetry.record([\n+    {\n+      eventName: EVENT_BUILD_FEATURE_USAGE,\n+      payload: {\n+        featureName: 'runAfterProductionCompile',\n+        invocationCount: 1,\n+      },\n+    },\n+  ])\n+  const afterBuildSpinner = createSpinner(\n+    'Running next.config.js provided runAfterProductionCompile'\n+  )\n+\n+  try {\n+    const startTime = performance.now()\n+    await buildSpan\n+      .traceChild('after-production-compile')\n+      .traceAsyncFn(async () => {\n+        await run(metadata)\n+      })\n+    const duration = performance.now() - startTime\n+    const formattedDuration = `${Math.round(duration)}ms`\n+    Log.event(`Completed runAfterProductionCompile in ${formattedDuration}`)\n+  } catch (err) {\n+    // Handle specific known errors differently if needed\n+    if (isError(err)) {\n+      Log.error(`Failed to run runAfterProductionCompile: ${err.message}`)\n+    }\n+\n+    throw err\n+  } finally {\n+    afterBuildSpinner?.stop()\n+  }\n+}"
        },
        {
            "sha": "a8da6d0840f8c27eed4b66c6da1bcf85551ce90c",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -214,6 +214,7 @@ import { populateStaticEnv } from '../lib/static-env'\n import { durationToString } from './duration-to-string'\n import { traceGlobals } from '../trace/shared'\n import { extractNextErrorCode } from '../lib/error-telemetry-utils'\n+import { runAfterProductionCompile } from './after-production-compile'\n \n type Fallback = null | boolean | string\n \n@@ -1583,6 +1584,15 @@ export default async function build(\n             )\n           }\n         }\n+        await runAfterProductionCompile({\n+          config,\n+          buildSpan: nextBuildSpan,\n+          telemetry,\n+          metadata: {\n+            projectDir: dir,\n+            distDir,\n+          },\n+        })\n       }\n \n       // For app directory, we run type checking after build."
        },
        {
            "sha": "d6482fc6b06ea58d6dbfee4ac9ec2b8c1a19f8e2",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -263,6 +263,10 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n           }),\n         ]),\n         define: z.record(z.string(), z.string()).optional(),\n+        runAfterProductionCompile: z\n+          .function()\n+          .returns(z.promise(z.void()))\n+          .optional(),\n       })\n       .optional(),\n     compress: z.boolean().optional(),"
        },
        {
            "sha": "0947d3776be1289faeeadc549af6d5a54e686890",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -1055,6 +1055,22 @@ export interface NextConfig extends Record<string, any> {\n      * replaced with the respective values.\n      */\n     define?: Record<string, string>\n+\n+    /**\n+     * A hook function that executes after production build compilation finishes,\n+     * but before running post-compilation tasks such as type checking and\n+     * static page generation.\n+     */\n+    runAfterProductionCompile?: (metadata: {\n+      /**\n+       * The root directory of the project\n+       */\n+      projectDir: string\n+      /**\n+       * The build output directory (defaults to `.next`)\n+       */\n+      distDir: string\n+    }) => Promise<void>\n   }\n \n   /**\n@@ -1200,6 +1216,7 @@ export const defaultConfig: NextConfig = {\n     keepAlive: true,\n   },\n   logging: {},\n+  compiler: {},\n   expireTime: process.env.NEXT_PRIVATE_CDN_CONSUMED_SWR_CACHE_CONTROL\n     ? undefined\n     : 31536000, // one year"
        },
        {
            "sha": "5796efdff7f32dff358710cd26a26a6498456c7d",
            "filename": "packages/next/src/telemetry/events/build.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -195,6 +195,7 @@ export type EventBuildFeatureUsage = {\n     | 'webpackPlugins'\n     | UseCacheTrackerKey\n     | 'turbopackPersistentCaching'\n+    | 'runAfterProductionCompile'\n   invocationCount: number\n }\n export function eventBuildFeatureUsage("
        },
        {
            "sha": "d439d65dca1e62960cdc674bc93efe71e90593a8",
            "filename": "test/production/build-lifecycle-hooks/after.ts",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fafter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fafter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fafter.ts?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -0,0 +1,21 @@\n+import fs from 'fs/promises'\n+\n+export async function after({\n+  distDir,\n+  projectDir,\n+}: {\n+  distDir: string\n+  projectDir: string\n+}) {\n+  try {\n+    console.log(`Using distDir: ${distDir}`)\n+    console.log(`Using projectDir: ${projectDir}`)\n+\n+    await new Promise((resolve) => setTimeout(resolve, 5000))\n+\n+    const files = await fs.readdir(distDir, { recursive: true })\n+    console.log(`Total files in ${distDir} folder: ${files.length}`)\n+  } catch (err) {\n+    console.error(`Error reading ${distDir} directory:`, err)\n+  }\n+}"
        },
        {
            "sha": "e324d469a48136e421aaf270106aa8f53622c0bd",
            "filename": "test/production/build-lifecycle-hooks/app/layout.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fapp%2Flayout.tsx?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -0,0 +1,13 @@\n+import React from 'react'\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "172376e4f2f57197e6e85264278e3ff2d83f7f40",
            "filename": "test/production/build-lifecycle-hooks/app/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fapp%2Fpage.tsx?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -0,0 +1,9 @@\n+import React from 'react'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <h1>Hello, World!</h1>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "fddd40a495d04a49c0ad9de3355c8a9429725d38",
            "filename": "test/production/build-lifecycle-hooks/bad-after.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fbad-after.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fbad-after.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fbad-after.ts?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -0,0 +1,9 @@\n+export async function after({\n+  distDir,\n+  projectDir,\n+}: {\n+  distDir: string\n+  projectDir: string\n+}) {\n+  throw new Error('error after production build')\n+}"
        },
        {
            "sha": "95887fb72c9794ffeeb9997c9c2250e2374e44f5",
            "filename": "test/production/build-lifecycle-hooks/index.test.ts",
            "status": "added",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fbuild-lifecycle-hooks%2Findex.test.ts?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -0,0 +1,54 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { findAllTelemetryEvents } from 'next-test-utils'\n+\n+describe('build-lifecycle-hooks', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    env: {\n+      NEXT_TELEMETRY_DEBUG: '1',\n+    },\n+  })\n+\n+  it('should run runAfterProductionCompile', async () => {\n+    const output = next.cliOutput\n+\n+    expect(output).toContain('')\n+    expect(output).toContain(`Using distDir: ${next.testDir}/.next`)\n+    expect(output).toContain(`Using projectDir: ${next.testDir}`)\n+    expect(output).toContain(`Total files in ${next.testDir}/.next folder:`)\n+    expect(output).toContain('Completed runAfterProductionCompile in')\n+\n+    // Ensure telemetry event is recorded\n+    const events = findAllTelemetryEvents(output, 'NEXT_BUILD_FEATURE_USAGE')\n+    expect(events).toContainEqual({\n+      featureName: 'runAfterProductionCompile',\n+      invocationCount: 1,\n+    })\n+  })\n+\n+  it('should allow throwing error in runAfterProductionCompile', async () => {\n+    try {\n+      await next.stop()\n+      await next.patchFile('next.config.ts', (content) => {\n+        return content.replace(\n+          `import { after } from './after'`,\n+          `import { after } from './bad-after'`\n+        )\n+      })\n+\n+      const getCliOutput = next.getCliOutputFromHere()\n+      await next.build()\n+      expect(getCliOutput()).toContain('error after production build')\n+      expect(getCliOutput()).not.toContain(\n+        'Completed runAfterProductionCompile in'\n+      )\n+    } finally {\n+      await next.patchFile('next.config.ts', (content) => {\n+        return content.replace(\n+          `import { after } from './bad-after'`,\n+          `import { after } from './after'`\n+        )\n+      })\n+    }\n+  })\n+})"
        },
        {
            "sha": "691b32f99e27f9aaf98577a5bb2521c68dc0de84",
            "filename": "test/production/build-lifecycle-hooks/next.config.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec6c710845fa62b37f8472400c2e8bcd1b7fe449/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fbuild-lifecycle-hooks%2Fnext.config.ts?ref=ec6c710845fa62b37f8472400c2e8bcd1b7fe449",
            "patch": "@@ -0,0 +1,12 @@\n+import { NextConfig } from 'next'\n+import { after } from './after'\n+\n+const nextConfig: NextConfig = {\n+  compiler: {\n+    runAfterProductionCompile: async ({ distDir, projectDir }) => {\n+      await after({ distDir, projectDir })\n+    },\n+  },\n+}\n+\n+export default nextConfig"
        }
    ],
    "stats": {
        "total": 213,
        "additions": 213,
        "deletions": 0
    }
}