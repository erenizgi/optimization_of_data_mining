{
    "author": "mischnic",
    "message": "Turbopack: dedupe middleware-manifest entries (#76621)",
    "sha": "fceb1d1d44243116a62fdb21d31b2d3fe29407df",
    "files": [
        {
            "sha": "6dfb44f360f0f5f48d89a12d822ec2b055e846fd",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/fceb1d1d44243116a62fdb21d31b2d3fe29407df/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fceb1d1d44243116a62fdb21d31b2d3fe29407df/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=fceb1d1d44243116a62fdb21d31b2d3fe29407df",
            "patch": "@@ -1125,7 +1125,7 @@ impl AppEndpoint {\n         let mut server_assets = fxindexset![];\n         let mut client_assets = fxindexset![];\n         // assets to add to the middleware manifest (to be loaded in the edge runtime).\n-        let mut middleware_assets = vec![];\n+        let mut middleware_assets = fxindexset![];\n \n         let runtime = app_entry.config.await?.runtime.unwrap_or_default();\n \n@@ -1314,7 +1314,6 @@ impl AppEndpoint {\n                 .values()\n             {\n                 let ssr_chunks = ssr_chunks.await?;\n-\n                 middleware_assets.extend(ssr_chunks);\n             }\n         }\n@@ -1387,7 +1386,7 @@ impl AppEndpoint {\n                 .await?;\n             server_assets.insert(entry_manifest);\n             if runtime == NextRuntime::Edge {\n-                middleware_assets.push(entry_manifest);\n+                middleware_assets.insert(entry_manifest);\n             }\n             client_reference_manifest = Some(entry_manifest);\n \n@@ -1411,13 +1410,13 @@ impl AppEndpoint {\n                 // global variables defined in these files\n                 //\n                 // they are created in `setup-dev-bundler.ts`\n-                let mut file_paths_from_root = vec![\n+                let mut file_paths_from_root = fxindexset![\n                     \"server/server-reference-manifest.js\".into(),\n                     \"server/middleware-build-manifest.js\".into(),\n                     \"server/next-font-manifest.js\".into(),\n                     \"server/interception-route-rewrite-manifest.js\".into(),\n                 ];\n-                let mut wasm_paths_from_root = vec![];\n+                let mut wasm_paths_from_root = fxindexset![];\n \n                 let node_root_value = node_root.await?;\n \n@@ -1476,8 +1475,8 @@ impl AppEndpoint {\n                         ..Default::default()\n                     };\n                     let edge_function_definition = EdgeFunctionDefinition {\n-                        files: file_paths_from_root,\n-                        wasm: wasm_paths_to_bindings(wasm_paths_from_root),\n+                        files: file_paths_from_root.into_iter().collect(),\n+                        wasm: wasm_paths_to_bindings(wasm_paths_from_root.into_iter().collect()),\n                         assets: paths_to_bindings(all_assets),\n                         name: app_entry.pathname.clone(),\n                         page: app_entry.original_name.clone(),"
        },
        {
            "sha": "de69f6ebffce05b4831aa4bfcf25517414082b65",
            "filename": "crates/next-api/src/paths.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/fceb1d1d44243116a62fdb21d31b2d3fe29407df/crates%2Fnext-api%2Fsrc%2Fpaths.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fceb1d1d44243116a62fdb21d31b2d3fe29407df/crates%2Fnext-api%2Fsrc%2Fpaths.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpaths.rs?ref=fceb1d1d44243116a62fdb21d31b2d3fe29407df",
            "patch": "@@ -78,11 +78,11 @@ pub async fn all_paths_in_root(\n \n pub(crate) async fn get_paths_from_root(\n     root: &FileSystemPath,\n-    output_assets: &[ResolvedVc<Box<dyn OutputAsset>>],\n+    output_assets: impl IntoIterator<Item = &ResolvedVc<Box<dyn OutputAsset>>>,\n     filter: impl FnOnce(&str) -> bool + Copy,\n ) -> Result<Vec<RcStr>> {\n     output_assets\n-        .iter()\n+        .into_iter()\n         .map(move |&file| async move {\n             let path = &*file.path().await?;\n             let Some(relative) = root.get_path_to(path) else {\n@@ -101,21 +101,21 @@ pub(crate) async fn get_paths_from_root(\n \n pub(crate) async fn get_js_paths_from_root(\n     root: &FileSystemPath,\n-    output_assets: &[ResolvedVc<Box<dyn OutputAsset>>],\n+    output_assets: impl IntoIterator<Item = &ResolvedVc<Box<dyn OutputAsset>>>,\n ) -> Result<Vec<RcStr>> {\n     get_paths_from_root(root, output_assets, |path| path.ends_with(\".js\")).await\n }\n \n pub(crate) async fn get_wasm_paths_from_root(\n     root: &FileSystemPath,\n-    output_assets: &[ResolvedVc<Box<dyn OutputAsset>>],\n+    output_assets: impl IntoIterator<Item = &ResolvedVc<Box<dyn OutputAsset>>>,\n ) -> Result<Vec<RcStr>> {\n     get_paths_from_root(root, output_assets, |path| path.ends_with(\".wasm\")).await\n }\n \n pub(crate) async fn get_asset_paths_from_root(\n     root: &FileSystemPath,\n-    output_assets: &[ResolvedVc<Box<dyn OutputAsset>>],\n+    output_assets: impl IntoIterator<Item = &ResolvedVc<Box<dyn OutputAsset>>>,\n ) -> Result<Vec<RcStr>> {\n     get_paths_from_root(root, output_assets, |path| {\n         !path.ends_with(\".js\") && !path.ends_with(\".map\") && !path.ends_with(\".wasm\")\n@@ -125,7 +125,7 @@ pub(crate) async fn get_asset_paths_from_root(\n \n pub(crate) async fn get_font_paths_from_root(\n     root: &FileSystemPath,\n-    output_assets: &[ResolvedVc<Box<dyn OutputAsset>>],\n+    output_assets: impl IntoIterator<Item = &ResolvedVc<Box<dyn OutputAsset>>>,\n ) -> Result<Vec<RcStr>> {\n     get_paths_from_root(root, output_assets, |path| {\n         path.ends_with(\".woff\")"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 12,
        "deletions": 13
    }
}