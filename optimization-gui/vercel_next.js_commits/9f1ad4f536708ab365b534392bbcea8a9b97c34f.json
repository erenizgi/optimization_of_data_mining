{
    "author": "mischnic",
    "message": "Allow passing port to `next internal trace` (#83907)\n\n`pnpm next internal trace bench/basic-app/.next/trace -p 1235`",
    "sha": "9f1ad4f536708ab365b534392bbcea8a9b97c34f",
    "files": [
        {
            "sha": "ded0fef161bda25faf4b79495fbdb1b9e46ab86b",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9f1ad4f536708ab365b534392bbcea8a9b97c34f/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9f1ad4f536708ab365b534392bbcea8a9b97c34f/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=9f1ad4f536708ab365b534392bbcea8a9b97c34f",
            "patch": "@@ -411,7 +411,7 @@ pub fn project_new(\n             let trace_server = std::env::var(\"NEXT_TURBOPACK_TRACE_SERVER\").ok();\n             if trace_server.is_some() {\n                 thread::spawn(move || {\n-                    turbopack_trace_server::start_turbopack_trace_server(trace_file);\n+                    turbopack_trace_server::start_turbopack_trace_server(trace_file, None);\n                 });\n                 println!(\"Turbopack trace server started. View trace at https://trace.nextjs.org\");\n             }"
        },
        {
            "sha": "96ebae24a1c26675b018efc8a15140326dcb5658",
            "filename": "crates/napi/src/turbo_trace_server.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9f1ad4f536708ab365b534392bbcea8a9b97c34f/crates%2Fnapi%2Fsrc%2Fturbo_trace_server.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9f1ad4f536708ab365b534392bbcea8a9b97c34f/crates%2Fnapi%2Fsrc%2Fturbo_trace_server.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fturbo_trace_server.rs?ref=9f1ad4f536708ab365b534392bbcea8a9b97c34f",
            "patch": "@@ -1,7 +1,7 @@\n use std::path::PathBuf;\n \n #[napi]\n-pub fn start_turbopack_trace_server(path: String) {\n+pub fn start_turbopack_trace_server(path: String, port: Option<u16>) {\n     let path_buf = PathBuf::from(path);\n-    turbopack_trace_server::start_turbopack_trace_server(path_buf);\n+    turbopack_trace_server::start_turbopack_trace_server(path_buf, port);\n }"
        },
        {
            "sha": "540f3fcc2d125a0ab731e10fc5d6717806081cf9",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9f1ad4f536708ab365b534392bbcea8a9b97c34f/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9f1ad4f536708ab365b534392bbcea8a9b97c34f/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=9f1ad4f536708ab365b534392bbcea8a9b97c34f",
            "patch": "@@ -443,10 +443,15 @@ const internal = program\n internal\n   .command('trace')\n   .alias('turbo-trace-server')\n-  .argument('[file]', 'Trace file to serve.')\n-  .action((file: string) => {\n+  .argument('file', 'Trace file to serve.')\n+  .addOption(\n+    new Option('-p, --port <port>', 'Override the port.').argParser(\n+      parseValidPositiveInteger\n+    )\n+  )\n+  .action((file: string, options: { port: number | undefined }) => {\n     return import('../cli/internal/turbo-trace-server.js').then((mod) =>\n-      mod.startTurboTraceServerCli(file)\n+      mod.startTurboTraceServerCli(file, options.port)\n     )\n   })\n "
        },
        {
            "sha": "2f3400ec3e6461bde80c8acbaaac68e734a68d95",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9f1ad4f536708ab365b534392bbcea8a9b97c34f/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9f1ad4f536708ab365b534392bbcea8a9b97c34f/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=9f1ad4f536708ab365b534392bbcea8a9b97c34f",
            "patch": "@@ -461,7 +461,10 @@ export declare function transformSync(\n   isModule: boolean,\n   options: Buffer\n ): object\n-export declare function startTurbopackTraceServer(path: string): void\n+export declare function startTurbopackTraceServer(\n+  path: string,\n+  port?: number | undefined | null\n+): void\n export interface NextBuildContext {\n   /** The root directory of the workspace. */\n   root?: string"
        },
        {
            "sha": "00d5c7761d5042d38b04c6b51d26ee8e5c829fa9",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/9f1ad4f536708ab365b534392bbcea8a9b97c34f/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9f1ad4f536708ab365b534392bbcea8a9b97c34f/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=9f1ad4f536708ab365b534392bbcea8a9b97c34f",
            "patch": "@@ -1264,7 +1264,10 @@ async function loadWasm(importPath = '') {\n           '`turbo.createProject` is not supported by the wasm bindings.'\n         )\n       },\n-      startTurbopackTraceServer(_traceFilePath: string): void {\n+      startTurbopackTraceServer(\n+        _traceFilePath: string,\n+        _port: number | undefined\n+      ): void {\n         throw new Error(\n           '`turbo.startTurbopackTraceServer` is not supported by the wasm bindings.'\n         )\n@@ -1458,11 +1461,14 @@ function loadNative(importPath?: string) {\n       teardownTraceSubscriber: bindings.teardownTraceSubscriber,\n       turbo: {\n         createProject: bindingToApi(customBindings ?? bindings, false),\n-        startTurbopackTraceServer(traceFilePath) {\n+        startTurbopackTraceServer(traceFilePath, port) {\n           Log.warn(\n-            'Turbopack trace server started. View trace at https://trace.nextjs.org'\n+            `Turbopack trace server started. View trace at https://trace.nextjs.org${port != null ? `?port=${port}` : ''}`\n+          )\n+          ;(customBindings ?? bindings).startTurbopackTraceServer(\n+            traceFilePath,\n+            port\n           )\n-          ;(customBindings ?? bindings).startTurbopackTraceServer(traceFilePath)\n         },\n       },\n       mdx: {"
        },
        {
            "sha": "8267262a195720661d843503ba2b4e745145ede5",
            "filename": "packages/next/src/build/swc/types.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9f1ad4f536708ab365b534392bbcea8a9b97c34f/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9f1ad4f536708ab365b534392bbcea8a9b97c34f/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts?ref=9f1ad4f536708ab365b534392bbcea8a9b97c34f",
            "patch": "@@ -16,7 +16,10 @@ export interface Binding {\n       options: ProjectOptions,\n       turboEngineOptions?: NapiTurboEngineOptions\n     ): Promise<Project>\n-    startTurbopackTraceServer(traceFilePath: string): void\n+    startTurbopackTraceServer(\n+      traceFilePath: string,\n+      port: number | undefined\n+    ): void\n \n     nextBuild?: any\n   }"
        },
        {
            "sha": "d2402c1cd5df66fef8685b0190cde5ac6f8a4dd4",
            "filename": "packages/next/src/cli/internal/turbo-trace-server.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9f1ad4f536708ab365b534392bbcea8a9b97c34f/packages%2Fnext%2Fsrc%2Fcli%2Finternal%2Fturbo-trace-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9f1ad4f536708ab365b534392bbcea8a9b97c34f/packages%2Fnext%2Fsrc%2Fcli%2Finternal%2Fturbo-trace-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Finternal%2Fturbo-trace-server.ts?ref=9f1ad4f536708ab365b534392bbcea8a9b97c34f",
            "patch": "@@ -1,6 +1,9 @@\n import { loadBindings } from '../../build/swc'\n \n-export async function startTurboTraceServerCli(file: string) {\n+export async function startTurboTraceServerCli(\n+  file: string,\n+  port: number | undefined\n+) {\n   let bindings = await loadBindings()\n-  bindings.turbo.startTurbopackTraceServer(file)\n+  bindings.turbo.startTurbopackTraceServer(file, port)\n }"
        },
        {
            "sha": "22c35874698ab775ad5396dab80d8c345156c29a",
            "filename": "turbopack/crates/turbopack-trace-server/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9f1ad4f536708ab365b534392bbcea8a9b97c34f/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9f1ad4f536708ab365b534392bbcea8a9b97c34f/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Flib.rs?ref=9f1ad4f536708ab365b534392bbcea8a9b97c34f",
            "patch": "@@ -29,11 +29,11 @@ mod viewer;\n )]\n type FxIndexMap<K, V> = indexmap::IndexMap<K, V, BuildHasherDefault<FxHasher>>;\n \n-pub fn start_turbopack_trace_server(path: PathBuf) {\n+pub fn start_turbopack_trace_server(path: PathBuf, port: Option<u16>) {\n     let store = Arc::new(StoreContainer::new());\n     let reader = TraceReader::spawn(store.clone(), path);\n \n-    serve(store, 5747);\n+    serve(store, port.unwrap_or(5747));\n \n     reader.join().unwrap();\n }"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 36,
        "deletions": 16
    }
}