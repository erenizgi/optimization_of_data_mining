{
    "author": "devjiwonchoi",
    "message": "fix: Rename proxy.js to middleware.js in NFT file (#86214)\n\n### Why?\n\nWhen Proxy self-references itself, e.g., `__filename`, it is traced to\nthe NFT file. However, since Next.js renames 'proxy.js' to\n'middleware.js' during webpack build, the files in NFT will differ from\nthe actual outputs. This can cause a problem when verifying the NFT.\n\nCurrent Behavior:\n\n\nhttps://github.com/vercel/next.js/actions/runs/19483162554/job/55760669267?pr=86214#step:34:91\n\n### How?\n\nTherefore, also rename the self-reference of `'proxy.js'` in\n`middleware.js.nft.json` to `'middleware.js'`.\n\nI don't expect other modules to be referencing the build output of\nProxy, that is not recommended.\n\nCloses NEXT-4777\nCloses NAR-518\n\n---------\n\nCo-authored-by: Niklas Mischkulnig <4586894+mischnic@users.noreply.github.com>",
    "sha": "ce90e190f21bbd1178d26c67cc7cc80a4f820711",
    "files": [
        {
            "sha": "21ef9d7a00228357607681f20b97deaff61f5b09",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/ce90e190f21bbd1178d26c67cc7cc80a4f820711/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ce90e190f21bbd1178d26c67cc7cc80a4f820711/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=ce90e190f21bbd1178d26c67cc7cc80a4f820711",
            "patch": "@@ -4079,6 +4079,34 @@ export default async function build(\n           path.join(distDir, SERVER_DIRECTORY, 'proxy.js.nft.json'),\n           path.join(distDir, SERVER_DIRECTORY, 'middleware.js.nft.json')\n         )\n+\n+        const middlewareNft = JSON.parse(\n+          await fs.readFile(\n+            path.join(distDir, SERVER_DIRECTORY, 'middleware.js.nft.json'),\n+            'utf8'\n+          )\n+        )\n+\n+        // When Proxy self-reference itself e.g. __filename, it is traced to\n+        // the NFT file. However, since we rename 'proxy.js' to 'middleware.js',\n+        // the files in NFT will differ from the actual outputs, which will fail\n+        // for the providers like Vercel that uses NFT. Therefore also rename\n+        // the 'proxy.js' to 'middleware.js' in the NFT file.\n+        let hasProxyJsInNft = false\n+        middlewareNft.files = middlewareNft.files.map((file: string) => {\n+          if (file === 'proxy.js') {\n+            hasProxyJsInNft = true\n+            return 'middleware.js'\n+          }\n+          return file\n+        })\n+\n+        if (hasProxyJsInNft) {\n+          await fs.writeFile(\n+            path.join(distDir, SERVER_DIRECTORY, 'middleware.js.nft.json'),\n+            JSON.stringify(middlewareNft)\n+          )\n+        }\n       }\n \n       if (isCompileMode) {"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/proxy-nfc-traced/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/ce90e190f21bbd1178d26c67cc7cc80a4f820711/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ce90e190f21bbd1178d26c67cc7cc80a4f820711/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fapp%2Flayout.tsx?ref=ce90e190f21bbd1178d26c67cc7cc80a4f820711",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/proxy-nfc-traced/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/ce90e190f21bbd1178d26c67cc7cc80a4f820711/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ce90e190f21bbd1178d26c67cc7cc80a4f820711/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fapp%2Fpage.tsx?ref=ce90e190f21bbd1178d26c67cc7cc80a4f820711",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/proxy-nfc-traced/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ce90e190f21bbd1178d26c67cc7cc80a4f820711/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ce90e190f21bbd1178d26c67cc7cc80a4f820711/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fnext.config.js?ref=ce90e190f21bbd1178d26c67cc7cc80a4f820711",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "43a88e7dcfb05700dc0289f65f05c112c296709a",
            "filename": "test/e2e/app-dir/proxy-nfc-traced/proxy-nfc-traced.test.ts",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/ce90e190f21bbd1178d26c67cc7cc80a4f820711/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fproxy-nfc-traced.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ce90e190f21bbd1178d26c67cc7cc80a4f820711/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fproxy-nfc-traced.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fproxy-nfc-traced.test.ts?ref=ce90e190f21bbd1178d26c67cc7cc80a4f820711",
            "patch": "@@ -0,0 +1,33 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import fs from 'fs'\n+import path from 'path'\n+\n+// This test verifies a case when the \"proxy.ts\" bundle is being traced into the NFT file as \"proxy.js\".\n+// As Next.js renames \"proxy.js\" to \"middleware.js\" during webpack build, the files in NFT will differ\n+// from the actual outputs, which will fail for the providers like Vercel that checks for the files in NFT.\n+\n+describe('proxy-nfc-traced', () => {\n+  const { next, isTurbopack, isNextStart } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  // 'middleware.js' won't be traced because Turbopack doesn't bundle all code to .next/server/middleware.js\n+  if (isNextStart && !isTurbopack) {\n+    it('should have renamed trace file as middleware instead of proxy', async () => {\n+      const nfc = JSON.parse(\n+        fs.readFileSync(\n+          path.join(next.testDir, '.next/server/middleware.js.nft.json'),\n+          'utf-8'\n+        )\n+      )\n+      expect(nfc.files).toContain('middleware.js')\n+      expect(nfc.files).not.toContain('proxy.js')\n+    })\n+  }\n+\n+  // Previously, the deployment tests failed because of the traced file name mismatch.\n+  it('should successfully build and be redirected from proxy', async () => {\n+    const $ = await next.render$('/home')\n+    expect($('p').text()).toBe('hello world')\n+  })\n+})"
        },
        {
            "sha": "0ac376cebde7ba47736055b8b3c4ca7de162fd71",
            "filename": "test/e2e/app-dir/proxy-nfc-traced/proxy.ts",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/ce90e190f21bbd1178d26c67cc7cc80a4f820711/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fproxy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ce90e190f21bbd1178d26c67cc7cc80a4f820711/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fproxy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-nfc-traced%2Fproxy.ts?ref=ce90e190f21bbd1178d26c67cc7cc80a4f820711",
            "patch": "@@ -0,0 +1,17 @@\n+import type { NextRequest } from 'next/server'\n+import { NextResponse } from 'next/server'\n+\n+export default function proxy(request: NextRequest) {\n+  if (request.nextUrl.pathname === '/home') {\n+    return NextResponse.redirect(new URL('/', request.url))\n+  }\n+\n+  // `__filename` included in the bundle makes the NFT to trace it.\n+  // This will result creating \"proxy.js\" to be traced into the NFT file.\n+  // However, as Next.js renames \"proxy.js\" to \"middleware.js\" during build,\n+  // the files in NFT will differ from the actual outputs, which will fail for\n+  // the providers like Vercel that checks for the files in NFT.\n+  console.log(__filename)\n+\n+  return NextResponse.next()\n+}"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 95,
        "deletions": 0
    }
}