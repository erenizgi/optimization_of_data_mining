{
    "author": "gaojude",
    "message": "feat: useLinkStatus (#77300)\n\n# `useLinkStatus` Hook\n\nThe `useLinkStatus` hook is primarily useful when:\n\n- Links have `prefetch={false}` set\n- Navigation occurs before prefetching has completed\n- When React decides to [skip the loading\nstate](https://react.dev/reference/react/useTransition#preventing-unwanted-loading-indicators)\nand https://github.com/vercel/next.js/issues/69625\n\nIt provides loading state feedback during these navigation transitions,\npreventing pages from appearing \"frozen\" while new content loads.\n\n## Usage\n\n`useLinkStatus` can be called from any descendant component of `Link`\nand it returns `{ pending: true }` before history has updated. After the\nURL updates, it returns `{ pending: false }`.\n\n```jsx\n// When prefetching is disabled\n<Link href=\"/dashboard/reports\" prefetch={false}>\n  Reports <LoadingIndicator />\n</Link>\n\nfunction LoadingIndicator() {\n  const { pending } = useLinkStatus();\n  return pending ? <Spinner /> : null;\n}\n```\n\n## Notes\n\n- If the link has been prefetched, pending change will be skipped and\nremain `{ pending: false }`.\n- If `useLinkStatus` is not under any `Link`, it will always return `{\npending: false }`.\n- `useLinkStatus` currently does not support Pages Router, so it will\nalways return `{ pending: false }` in Pages Router.\n- When you click multiple links in a short period, only the last link's\npending state is shown\n\n---------\n\nCo-authored-by: Andrew Clark <git@andrewclark.io>",
    "sha": "ccd76c961a78775cb91d24e03f4af1f06386a8c5",
    "files": [
        {
            "sha": "fb63d21cef8c091c772e4c371ed7b1893bc1dd30",
            "filename": "packages/next/src/client/app-dir/form.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Fform.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Fform.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Fform.tsx?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -16,7 +16,10 @@ import {\n   hasUnsupportedSubmitterAttributes,\n   type FormProps,\n } from '../form-shared'\n-import { mountLinkInstance, unmountLinkInstance } from '../components/links'\n+import {\n+  mountFormInstance,\n+  unmountPrefetchableInstance,\n+} from '../components/links'\n \n export type { FormProps }\n \n@@ -96,10 +99,10 @@ export default function Form({\n   const observeFormVisibilityOnMount = useCallback(\n     (element: HTMLFormElement) => {\n       if (isPrefetchEnabled && router !== null) {\n-        mountLinkInstance(element, actionProp, router, PrefetchKind.AUTO)\n+        mountFormInstance(element, actionProp, router, PrefetchKind.AUTO)\n       }\n       return () => {\n-        unmountLinkInstance(element)\n+        unmountPrefetchableInstance(element)\n       }\n     },\n     [isPrefetchEnabled, actionProp, router]"
        },
        {
            "sha": "2133243e236fc70b80606244a29a68ba091faa8d",
            "filename": "packages/next/src/client/app-dir/link.tsx",
            "status": "modified",
            "additions": 55,
            "deletions": 30,
            "changes": 85,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -1,23 +1,25 @@\n 'use client'\n \n-import type { NextRouter } from '../../shared/lib/router/router'\n-\n-import React from 'react'\n+import React, { createContext, useContext, useOptimistic, useRef } from 'react'\n import type { UrlObject } from 'url'\n import { formatUrl } from '../../shared/lib/router/utils/format-url'\n import { AppRouterContext } from '../../shared/lib/app-router-context.shared-runtime'\n-import type { AppRouterInstance } from '../../shared/lib/app-router-context.shared-runtime'\n import { PrefetchKind } from '../components/router-reducer/router-reducer-types'\n import { useMergedRef } from '../use-merged-ref'\n import { isAbsoluteUrl } from '../../shared/lib/utils'\n import { addBasePath } from '../add-base-path'\n import { warnOnce } from '../../shared/lib/utils/warn-once'\n+import type { PENDING_LINK_STATUS } from '../components/links'\n import {\n+  IDLE_LINK_STATUS,\n   mountLinkInstance,\n   onNavigationIntent,\n-  unmountLinkInstance,\n+  unmountLinkForCurrentNavigation,\n+  unmountPrefetchableInstance,\n+  type LinkInstance,\n } from '../components/links'\n import { isLocalURL } from '../../shared/lib/router/utils/is-local-url'\n+import { dispatchNavigateAction } from '../components/app-router-instance'\n \n type Url = string | UrlObject\n type RequiredKeys<T> = {\n@@ -228,11 +230,10 @@ function isModifiedEvent(event: React.MouseEvent): boolean {\n \n function linkClicked(\n   e: React.MouseEvent,\n-  router: NextRouter | AppRouterInstance,\n   href: string,\n   as: string,\n+  linkInstanceRef: React.RefObject<LinkInstance | null>,\n   replace?: boolean,\n-  shallow?: boolean,\n   scroll?: boolean,\n   onNavigate?: OnNavigateEventHandler\n ): void {\n@@ -278,20 +279,12 @@ function linkClicked(\n       }\n     }\n \n-    // If the router is an NextRouter instance it will have `beforePopState`\n-    // TODO: This should access the router methods directly, rather than\n-    // go through the public interface.\n-    const routerScroll = scroll ?? true\n-    if ('beforePopState' in router) {\n-      router[replace ? 'replace' : 'push'](href, as, {\n-        shallow,\n-        scroll: routerScroll,\n-      })\n-    } else {\n-      router[replace ? 'replace' : 'push'](as || href, {\n-        scroll: routerScroll,\n-      })\n-    }\n+    dispatchNavigateAction(\n+      as || href,\n+      replace ? 'replace' : 'push',\n+      scroll ?? true,\n+      linkInstanceRef.current\n+    )\n   }\n \n   React.startTransition(navigate)\n@@ -321,8 +314,12 @@ export default function LinkComponent(\n     ref: React.Ref<HTMLAnchorElement>\n   }\n ) {\n+  const [linkStatus, setOptimisticLinkStatus] = useOptimistic(IDLE_LINK_STATUS)\n+\n   let children: React.ReactNode\n \n+  const linkInstanceRef = useRef<LinkInstance | null>(null)\n+\n   const {\n     href: hrefProp,\n     as: asProp,\n@@ -557,14 +554,26 @@ export default function LinkComponent(\n   // a revalidation or refresh.\n   const observeLinkVisibilityOnMount = React.useCallback(\n     (element: HTMLAnchorElement | SVGAElement) => {\n-      if (prefetchEnabled && router !== null) {\n-        mountLinkInstance(element, href, router, appPrefetchKind)\n+      if (router !== null) {\n+        linkInstanceRef.current = mountLinkInstance(\n+          element,\n+          href,\n+          router,\n+          appPrefetchKind,\n+          prefetchEnabled,\n+          setOptimisticLinkStatus\n+        )\n       }\n+\n       return () => {\n-        unmountLinkInstance(element)\n+        if (linkInstanceRef.current) {\n+          unmountLinkForCurrentNavigation(linkInstanceRef.current)\n+          linkInstanceRef.current = null\n+        }\n+        unmountPrefetchableInstance(element)\n       }\n     },\n-    [prefetchEnabled, href, router, appPrefetchKind]\n+    [prefetchEnabled, href, router, appPrefetchKind, setOptimisticLinkStatus]\n   )\n \n   const mergedRef = useMergedRef(observeLinkVisibilityOnMount, childRef)\n@@ -606,7 +615,7 @@ export default function LinkComponent(\n         return\n       }\n \n-      linkClicked(e, router, href, as, replace, shallow, scroll, onNavigate)\n+      linkClicked(e, href, as, linkInstanceRef, replace, scroll, onNavigate)\n     },\n     onMouseEnter(e) {\n       if (!legacyBehavior && typeof onMouseEnterProp === 'function') {\n@@ -671,6 +680,8 @@ export default function LinkComponent(\n     childProps.href = addBasePath(as)\n   }\n \n+  let link: React.ReactNode\n+\n   if (legacyBehavior) {\n     if (process.env.NODE_ENV === 'development') {\n       console.error(\n@@ -680,12 +691,26 @@ export default function LinkComponent(\n           'Learn more: https://nextjs.org/docs/app/building-your-application/upgrading/codemods#remove-a-tags-from-link-components'\n       )\n     }\n-    return React.cloneElement(child, childProps)\n+    link = React.cloneElement(child, childProps)\n+  } else {\n+    link = (\n+      <a {...restProps} {...childProps}>\n+        {children}\n+      </a>\n+    )\n   }\n \n   return (\n-    <a {...restProps} {...childProps}>\n-      {children}\n-    </a>\n+    <LinkStatusContext.Provider value={linkStatus}>\n+      {link}\n+    </LinkStatusContext.Provider>\n   )\n }\n+\n+const LinkStatusContext = createContext<\n+  typeof PENDING_LINK_STATUS | typeof IDLE_LINK_STATUS\n+>(IDLE_LINK_STATUS)\n+\n+export const useLinkStatus = () => {\n+  return useContext(LinkStatusContext)\n+}"
        },
        {
            "sha": "54202df189006b41a0299323e3dc3a8aa0c9d337",
            "filename": "packages/next/src/client/components/app-router-instance.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -24,6 +24,7 @@ import type {\n   NavigateOptions,\n   PrefetchOptions,\n } from '../../shared/lib/app-router-context.shared-runtime'\n+import { setLinkForCurrentNavigation, type LinkInstance } from './links'\n \n export type DispatchStatePromise = React.Dispatch<ReducerState>\n \n@@ -235,17 +236,21 @@ function getAppRouterActionQueue(): AppRouterActionQueue {\n   return globalActionQueue\n }\n \n-function dispatchNavigateAction(\n+export function dispatchNavigateAction(\n   href: string,\n   navigateType: NavigateAction['navigateType'],\n-  shouldScroll: boolean\n+  shouldScroll: boolean,\n+  linkInstanceRef: LinkInstance | null\n ): void {\n   // TODO: This stuff could just go into the reducer. Leaving as-is for now\n   // since we're about to rewrite all the router reducer stuff anyway.\n   const url = new URL(addBasePath(href), location.href)\n   if (process.env.__NEXT_APP_NAV_FAIL_HANDLING) {\n     window.next.__pendingUrl = url\n   }\n+\n+  setLinkForCurrentNavigation(linkInstanceRef)\n+\n   dispatchAppRouterAction({\n     type: ACTION_NAVIGATE,\n     url,\n@@ -298,12 +303,12 @@ export const publicAppRouterInstance: AppRouterInstance = {\n       },\n   replace: (href: string, options?: NavigateOptions) => {\n     startTransition(() => {\n-      dispatchNavigateAction(href, 'replace', options?.scroll ?? true)\n+      dispatchNavigateAction(href, 'replace', options?.scroll ?? true, null)\n     })\n   },\n   push: (href: string, options?: NavigateOptions) => {\n     startTransition(() => {\n-      dispatchNavigateAction(href, 'push', options?.scroll ?? true)\n+      dispatchNavigateAction(href, 'push', options?.scroll ?? true, null)\n     })\n   },\n   refresh: () => {"
        },
        {
            "sha": "1e122b44aa20bd115ed684792459e8d4f60d8fb9",
            "filename": "packages/next/src/client/components/links.ts",
            "status": "modified",
            "additions": 150,
            "deletions": 45,
            "changes": 195,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -12,13 +12,17 @@ import {\n   cancelPrefetchTask,\n   bumpPrefetchTask,\n } from './segment-cache'\n+import { startTransition } from 'react'\n \n-type LinkElement = HTMLAnchorElement | SVGAElement | HTMLFormElement\n+type LinkElement = HTMLAnchorElement | SVGAElement\n \n-type LinkInstance = {\n+type Element = LinkElement | HTMLFormElement\n+\n+// Properties that are shared between Link and Form instances. We use the same\n+// shape for both to prevent a polymorphic de-opt in the VM.\n+type LinkOrFormInstanceShared = {\n   router: AppRouterInstance\n   kind: PrefetchKind.AUTO | PrefetchKind.FULL\n-  prefetchHref: string\n \n   isVisible: boolean\n   wasHoveredOrTouched: boolean\n@@ -33,16 +37,68 @@ type LinkInstance = {\n   cacheVersion: number\n }\n \n+export type FormInstance = LinkOrFormInstanceShared & {\n+  prefetchHref: string\n+  setOptimisticLinkStatus: null\n+}\n+\n+type PrefetchableLinkInstance = LinkOrFormInstanceShared & {\n+  prefetchHref: string\n+  setOptimisticLinkStatus: (status: { pending: boolean }) => void\n+}\n+\n+type NonPrefetchableLinkInstance = LinkOrFormInstanceShared & {\n+  prefetchHref: null\n+  setOptimisticLinkStatus: (status: { pending: boolean }) => void\n+}\n+\n+type PrefetchableInstance = PrefetchableLinkInstance | FormInstance\n+\n+export type LinkInstance =\n+  | PrefetchableLinkInstance\n+  | NonPrefetchableLinkInstance\n+\n+// Tracks the most recently navigated link instance. When null, indicates\n+// the current navigation was not initiated by a link click.\n+let linkForMostRecentNavigation: LinkInstance | null = null\n+\n+// Status object indicating link is pending\n+export const PENDING_LINK_STATUS = { pending: true }\n+\n+// Status object indicating link is idle\n+export const IDLE_LINK_STATUS = { pending: false }\n+\n+// Updates the loading state when navigating between links\n+// - Resets the previous link's loading state\n+// - Sets the new link's loading state\n+// - Updates tracking of current navigation\n+export function setLinkForCurrentNavigation(link: LinkInstance | null) {\n+  startTransition(() => {\n+    linkForMostRecentNavigation?.setOptimisticLinkStatus(IDLE_LINK_STATUS)\n+    link?.setOptimisticLinkStatus(PENDING_LINK_STATUS)\n+    linkForMostRecentNavigation = link\n+  })\n+}\n+\n+// Unmounts the current link instance from navigation tracking\n+export function unmountLinkForCurrentNavigation(link: LinkInstance) {\n+  if (linkForMostRecentNavigation === link) {\n+    linkForMostRecentNavigation = null\n+  }\n+}\n+\n // Use a WeakMap to associate a Link instance with its DOM element. This is\n // used by the IntersectionObserver to track the link's visibility.\n-const links: WeakMap<LinkElement, LinkInstance> | Map<Element, LinkInstance> =\n+const prefetchable:\n+  | WeakMap<Element, PrefetchableInstance>\n+  | Map<Element, PrefetchableInstance> =\n   typeof WeakMap === 'function' ? new WeakMap() : new Map()\n \n // A Set of the currently visible links. We re-prefetch visible links after a\n // cache invalidation, or when the current URL changes. It's a separate data\n // structure from the WeakMap above because only the visible links need to\n // be enumerated.\n-const visibleLinks: Set<LinkInstance> = new Set()\n+const prefetchableAndVisible: Set<PrefetchableInstance> = new Set()\n \n // A single IntersectionObserver instance shared by all <Link> components.\n const observer: IntersectionObserver | null =\n@@ -52,20 +108,24 @@ const observer: IntersectionObserver | null =\n       })\n     : null\n \n-export function mountLinkInstance(\n-  element: LinkElement,\n-  href: string,\n-  router: AppRouterInstance,\n-  kind: PrefetchKind.AUTO | PrefetchKind.FULL\n-) {\n-  let prefetchUrl: URL | null = null\n+function observeVisibility(element: Element, instance: PrefetchableInstance) {\n+  const existingInstance = prefetchable.get(element)\n+  if (existingInstance !== undefined) {\n+    // This shouldn't happen because each <Link> component should have its own\n+    // anchor tag instance, but it's defensive coding to avoid a memory leak in\n+    // case there's a logical error somewhere else.\n+    unmountPrefetchableInstance(element)\n+  }\n+  // Only track prefetchable links that have a valid prefetch URL\n+  prefetchable.set(element, instance)\n+  if (observer !== null) {\n+    observer.observe(element)\n+  }\n+}\n+\n+function coercePrefetchableUrl(href: string): URL | null {\n   try {\n-    prefetchUrl = createPrefetchURL(href)\n-    if (prefetchUrl === null) {\n-      // We only track the link if it's prefetchable. For example, this excludes\n-      // links to external URLs.\n-      return\n-    }\n+    return createPrefetchURL(href)\n   } catch {\n     // createPrefetchURL sometimes throws an error if an invalid URL is\n     // provided, though I'm not sure if it's actually necessary.\n@@ -77,36 +137,84 @@ export function mountLinkInstance(\n     reportErrorFn(\n       `Cannot prefetch '${href}' because it cannot be converted to a URL.`\n     )\n-    return\n+    return null\n   }\n+}\n \n-  const instance: LinkInstance = {\n-    prefetchHref: prefetchUrl.href,\n+export function mountLinkInstance(\n+  element: LinkElement,\n+  href: string,\n+  router: AppRouterInstance,\n+  kind: PrefetchKind.AUTO | PrefetchKind.FULL,\n+  prefetchEnabled: boolean,\n+  setOptimisticLinkStatus: (status: { pending: boolean }) => void\n+): LinkInstance {\n+  if (prefetchEnabled) {\n+    const prefetchURL = coercePrefetchableUrl(href)\n+    if (prefetchURL !== null) {\n+      const instance: PrefetchableLinkInstance = {\n+        router,\n+        kind,\n+        isVisible: false,\n+        wasHoveredOrTouched: false,\n+        prefetchTask: null,\n+        cacheVersion: -1,\n+        prefetchHref: prefetchURL.href,\n+        setOptimisticLinkStatus,\n+      }\n+      // We only observe the link's visibility if it's prefetchable. For\n+      // example, this excludes links to external URLs.\n+      observeVisibility(element, instance)\n+      return instance\n+    }\n+  }\n+  // If the link is not prefetchable, we still create an instance so we can\n+  // track its optimistic state (i.e. useLinkStatus).\n+  const instance: NonPrefetchableLinkInstance = {\n     router,\n     kind,\n     isVisible: false,\n     wasHoveredOrTouched: false,\n     prefetchTask: null,\n     cacheVersion: -1,\n+    prefetchHref: null,\n+    setOptimisticLinkStatus,\n   }\n-  const existingInstance = links.get(element)\n-  if (existingInstance !== undefined) {\n-    // This shouldn't happen because each <Link> component should have its own\n-    // anchor tag instance, but it's defensive coding to avoid a memory leak in\n-    // case there's a logical error somewhere else.\n-    unmountLinkInstance(element)\n+  return instance\n+}\n+\n+export function mountFormInstance(\n+  element: HTMLFormElement,\n+  href: string,\n+  router: AppRouterInstance,\n+  kind: PrefetchKind.AUTO | PrefetchKind.FULL\n+): void {\n+  const prefetchURL = coercePrefetchableUrl(href)\n+  if (prefetchURL === null) {\n+    // This href is not prefetchable, so we don't track it.\n+    // TODO: We currently observe/unobserve a form every time its href changes.\n+    // For Links, this isn't a big deal because the href doesn't usually change,\n+    // but for forms it's extremely common. We should optimize this.\n+    return\n   }\n-  links.set(element, instance)\n-  if (observer !== null) {\n-    observer.observe(element)\n+  const instance: FormInstance = {\n+    router,\n+    kind,\n+    isVisible: false,\n+    wasHoveredOrTouched: false,\n+    prefetchTask: null,\n+    cacheVersion: -1,\n+    prefetchHref: prefetchURL.href,\n+    setOptimisticLinkStatus: null,\n   }\n+  observeVisibility(element, instance)\n }\n \n-export function unmountLinkInstance(element: LinkElement) {\n-  const instance = links.get(element)\n+export function unmountPrefetchableInstance(element: Element) {\n+  const instance = prefetchable.get(element)\n   if (instance !== undefined) {\n-    links.delete(element)\n-    visibleLinks.delete(instance)\n+    prefetchable.delete(element)\n+    prefetchableAndVisible.delete(instance)\n     const prefetchTask = instance.prefetchTask\n     if (prefetchTask !== null) {\n       cancelPrefetchTask(prefetchTask)\n@@ -127,33 +235,30 @@ function handleIntersect(entries: Array<IntersectionObserverEntry>) {\n   }\n }\n \n-export function onLinkVisibilityChanged(\n-  element: LinkElement,\n-  isVisible: boolean\n-) {\n+export function onLinkVisibilityChanged(element: Element, isVisible: boolean) {\n   if (process.env.NODE_ENV !== 'production') {\n     // Prefetching on viewport is disabled in development for performance\n     // reasons, because it requires compiling the target page.\n     // TODO: Investigate re-enabling this.\n     return\n   }\n \n-  const instance = links.get(element)\n+  const instance = prefetchable.get(element)\n   if (instance === undefined) {\n     return\n   }\n \n   instance.isVisible = isVisible\n   if (isVisible) {\n-    visibleLinks.add(instance)\n+    prefetchableAndVisible.add(instance)\n   } else {\n-    visibleLinks.delete(instance)\n+    prefetchableAndVisible.delete(instance)\n   }\n   rescheduleLinkPrefetch(instance)\n }\n \n export function onNavigationIntent(element: HTMLAnchorElement | SVGAElement) {\n-  const instance = links.get(element)\n+  const instance = prefetchable.get(element)\n   if (instance === undefined) {\n     return\n   }\n@@ -164,7 +269,7 @@ export function onNavigationIntent(element: HTMLAnchorElement | SVGAElement) {\n   }\n }\n \n-function rescheduleLinkPrefetch(instance: LinkInstance) {\n+function rescheduleLinkPrefetch(instance: PrefetchableInstance) {\n   const existingPrefetchTask = instance.prefetchTask\n \n   if (!instance.isVisible) {\n@@ -230,7 +335,7 @@ export function pingVisibleLinks(\n   // may affect the result of a prefetch task. It's also called after a\n   // cache invalidation.\n   const currentCacheVersion = getCurrentCacheVersion()\n-  for (const instance of visibleLinks) {\n+  for (const instance of prefetchableAndVisible) {\n     const task = instance.prefetchTask\n     if (\n       task !== null &&\n@@ -261,7 +366,7 @@ export function pingVisibleLinks(\n   }\n }\n \n-function prefetchWithOldCacheImplementation(instance: LinkInstance) {\n+function prefetchWithOldCacheImplementation(instance: PrefetchableInstance) {\n   // This is the path used when the Segment Cache is not enabled.\n   if (typeof window === 'undefined') {\n     return"
        },
        {
            "sha": "601e2433c2d1acbb64e0c1ba7b1322ceb1008dce",
            "filename": "packages/next/src/client/link.tsx",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/packages%2Fnext%2Fsrc%2Fclient%2Flink.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/packages%2Fnext%2Fsrc%2Fclient%2Flink.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Flink.tsx?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -5,7 +5,7 @@ import type {\n   PrefetchOptions as RouterPrefetchOptions,\n } from '../shared/lib/router/router'\n \n-import React from 'react'\n+import React, { createContext, useContext } from 'react'\n import type { UrlObject } from 'url'\n import { resolveHref } from './resolve-href'\n import { isLocalURL } from '../shared/lib/router/utils/is-local-url'\n@@ -686,4 +686,17 @@ const Link = React.forwardRef<HTMLAnchorElement, LinkPropsReal>(\n   }\n )\n \n+const LinkStatusContext = createContext<{\n+  pending: boolean\n+}>({\n+  // We do not support link status in the Pages Router, so we always return false\n+  pending: false,\n+})\n+\n+export const useLinkStatus = () => {\n+  // This behaviour is like React's useFormStatus. When the component is not under\n+  // a <form> tag, it will get the default value, instead of throwing an error.\n+  return useContext(LinkStatusContext)\n+}\n+\n export default Link"
        },
        {
            "sha": "df7cdb6effb1821e73d1d0db1f7846b86cb36c6a",
            "filename": "test/e2e/use-link-status/app/debug-mode.tsx",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Fdebug-mode.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Fdebug-mode.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fuse-link-status%2Fapp%2Fdebug-mode.tsx?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -0,0 +1,18 @@\n+'use client'\n+\n+import { useSearchParams } from 'next/navigation'\n+\n+export default function DebugMode() {\n+  const searchParams = useSearchParams()\n+  const debug = searchParams.get('debug')\n+\n+  if (debug === '1') {\n+    return (\n+      <div data-testid=\"debug-mode\">\n+        <h2>Debug Mode Enabled</h2>\n+      </div>\n+    )\n+  }\n+\n+  return null\n+}"
        },
        {
            "sha": "398ca58f772418731eeea1c5edab0106e472e225",
            "filename": "test/e2e/use-link-status/app/layout.tsx",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fuse-link-status%2Fapp%2Flayout.tsx?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -0,0 +1,23 @@\n+import React, { Suspense } from 'react'\n+import NavBar from './nav-bar'\n+import DebugMode from './debug-mode'\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html>\n+      <body>\n+        <NavBar />\n+        {children}\n+        <Suspense>\n+          <DebugMode />\n+        </Suspense>\n+      </body>\n+    </html>\n+  )\n+}\n+\n+export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "c8301671558d367507977a29c045d12b31e43b81",
            "filename": "test/e2e/use-link-status/app/nav-bar.tsx",
            "status": "added",
            "additions": 120,
            "deletions": 0,
            "changes": 120,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Fnav-bar.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Fnav-bar.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fuse-link-status%2Fapp%2Fnav-bar.tsx?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -0,0 +1,120 @@\n+'use client'\n+\n+import React from 'react'\n+import Link from 'next/link'\n+import { useLinkStatus } from 'next/link'\n+import { navigateByServerAction } from './server-action'\n+import { useRouter } from 'next/navigation'\n+\n+export default function NavBar() {\n+  const postIds = Array.from({ length: 5 }, (_, i) => i + 1)\n+  const router = useRouter()\n+\n+  return (\n+    <nav data-testid=\"navbar\">\n+      <ul style={{ display: 'flex', listStyle: 'none', gap: '10px' }}>\n+        <li>\n+          <Link\n+            prefetch={false}\n+            href=\"/\"\n+            id=\"home-link\"\n+            data-testid=\"home-link\"\n+          >\n+            Home <LoadingIndicator id=\"home\" />\n+          </Link>\n+          <button\n+            id=\"server-action-home-btn\"\n+            data-testid=\"server-action-home-btn\"\n+            onClick={() => navigateByServerAction(`/`)}\n+          >\n+            Navigate by server action to home\n+          </button>\n+        </li>\n+        {postIds.map((id) => (\n+          <li key={id}>\n+            <Link\n+              prefetch={false}\n+              href={`/post/${id}`}\n+              id={`post-${id}-link`}\n+              data-testid={`post-${id}-link`}\n+            >\n+              Post {id} <LoadingIndicator id={`post-${id}`} />\n+            </Link>\n+            <button\n+              id={`server-action-${id}-btn`}\n+              data-testid={`server-action-${id}-btn`}\n+              onClick={() => navigateByServerAction(`/post/${id}`)}\n+            >\n+              Navigate by server action to {id}\n+            </button>\n+            <button\n+              id={`router-push-${id}-btn`}\n+              data-testid={`router-push-${id}-btn`}\n+              onClick={() => router.push(`/post/${id}`)}\n+            >\n+              Navigate by Router.push to {id}\n+            </button>\n+          </li>\n+        ))}\n+\n+        <button\n+          id=\"enable-debug-btn\"\n+          data-testid=\"enable-debug-btn\"\n+          onClick={() => {\n+            const urlSearchParams = new URLSearchParams(window.location.search)\n+            urlSearchParams.set('debug', '1')\n+            window.history.pushState(null, '', `?${urlSearchParams.toString()}`)\n+          }}\n+        >\n+          Enable Debug Mode\n+        </button>\n+\n+        <button\n+          id=\"disable-debug-btn\"\n+          data-testid=\"disable-debug-btn\"\n+          onClick={() => {\n+            const urlSearchParams = new URLSearchParams(window.location.search)\n+            urlSearchParams.delete('debug')\n+            window.history.pushState(null, '', `?${urlSearchParams.toString()}`)\n+          }}\n+        >\n+          Disable Debug Mode\n+        </button>\n+\n+        <LinkThatChangesHref />\n+      </ul>\n+    </nav>\n+  )\n+}\n+\n+const LoadingIndicator = ({ id }: { id: string }) => {\n+  const { pending } = useLinkStatus()\n+\n+  if (pending) {\n+    return (\n+      <div id={`${id}-loading`} data-testid={`${id}-loading`}>\n+        (Loading)\n+      </div>\n+    )\n+  }\n+\n+  return null\n+}\n+\n+const LinkThatChangesHref = () => {\n+  const [postId, setPostId] = React.useState(6)\n+\n+  return (\n+    <div>\n+      <Link href={`/post/${postId}`} data-testid=\"changing-link\">\n+        Link to post {postId} <LoadingIndicator id={`post-${postId}`} />\n+      </Link>\n+      <button\n+        onClick={() => setPostId(postId + 1)}\n+        data-testid=\"increment-link-btn\"\n+      >\n+        Change link target\n+      </button>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "336b9e49e94a366905f54a265ede735acc5c8d42",
            "filename": "test/e2e/use-link-status/app/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fuse-link-status%2Fapp%2Fpage.tsx?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -0,0 +1,9 @@\n+import React from 'react'\n+\n+export default function HomePage() {\n+  return (\n+    <div data-testid=\"home-page\">\n+      <h1>Home Page</h1>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "225a22a05e9ba476dbaf841ba69da69761bbf3b5",
            "filename": "test/e2e/use-link-status/app/post/[id]/page.tsx",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Fpost%2F%5Bid%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Fpost%2F%5Bid%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fuse-link-status%2Fapp%2Fpost%2F%5Bid%5D%2Fpage.tsx?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -0,0 +1,26 @@\n+// This component delays rendering to simulate a slow page load\n+async function PostContent({ id }: { id: string }) {\n+  await new Promise((resolve) => setTimeout(resolve, 3000))\n+\n+  return (\n+    <div>\n+      <h1>Post {id}</h1>\n+      <p>This is post {id}</p>\n+      <p>Posted on: {Date.now()}</p>\n+    </div>\n+  )\n+}\n+\n+export default async function PostPage({\n+  params,\n+}: {\n+  params: Promise<{ id: string }>\n+}) {\n+  const { id } = await params\n+\n+  return (\n+    <div data-testid={`post-${id}-page`}>\n+      <PostContent id={id} />\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "e40abffad9260198a655fe8fce8686e64115723c",
            "filename": "test/e2e/use-link-status/app/server-action.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Fserver-action.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Fapp%2Fserver-action.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fuse-link-status%2Fapp%2Fserver-action.ts?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -0,0 +1,7 @@\n+'use server'\n+\n+import { redirect } from 'next/navigation'\n+\n+export async function navigateByServerAction(url: string) {\n+  redirect(url)\n+}"
        },
        {
            "sha": "0f4d755216b516872a6c7264d1e4b5fdeaad4a5b",
            "filename": "test/e2e/use-link-status/index.test.ts",
            "status": "added",
            "additions": 141,
            "deletions": 0,
            "changes": 141,
            "blob_url": "https://github.com/vercel/next.js/blob/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ccd76c961a78775cb91d24e03f4af1f06386a8c5/test%2Fe2e%2Fuse-link-status%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fuse-link-status%2Findex.test.ts?ref=ccd76c961a78775cb91d24e03f4af1f06386a8c5",
            "patch": "@@ -0,0 +1,141 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { waitFor } from 'next-test-utils'\n+\n+describe('useLinkStatus', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should show pending state for the last link clicked when clicking multiple links in a row', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Click post 1 link\n+    await browser.elementById('post-1-link').click()\n+\n+    // Quickly click post 2 link\n+    await browser.elementById('post-2-link').click()\n+\n+    // The pending state should be shown for post 2 link\n+    expect(await browser.elementById('post-2-loading').text()).toBe('(Loading)')\n+\n+    // Post 1 should not show loading\n+    const post1Loading = await browser.elementsByCss('#post-1-loading')\n+    expect(post1Loading.length).toBe(0)\n+\n+    // Wait for navigation to complete and verify we end up on post 2\n+    await browser.waitForIdleNetwork()\n+    await browser.waitForElementByCss('[data-testid=\"post-2-page\"]')\n+  })\n+\n+  it('should remove pending state after shallow routing', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Click post 1 link\n+    await browser.elementById('post-1-link').click()\n+\n+    // Verify pending state is shown\n+    expect(await browser.elementById('post-1-loading').text()).toBe('(Loading)')\n+\n+    // Trigger shallow routing by clicking debug mode button\n+    await browser.elementById('enable-debug-btn').click()\n+\n+    // Pending state should be gone\n+    const post1LoadingElements = await browser.elementsByCss('#post-1-loading')\n+    expect(post1LoadingElements.length).toBe(0)\n+  })\n+\n+  it('should remove pending state after browser back navigation', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Click post 1 link\n+    await browser.elementById('post-1-link').click()\n+\n+    // Wait for navigation to complete\n+    await browser.waitForIdleNetwork()\n+    await browser.waitForElementByCss('[data-testid=\"post-1-page\"]')\n+\n+    // Click post 2 link\n+    await browser.elementById('post-2-link').click()\n+\n+    // Verify pending state is shown\n+    expect(await browser.elementById('post-2-loading').text()).toBe('(Loading)')\n+\n+    // Go back using browser back button\n+    await browser.back()\n+\n+    // Wait for navigation and verify we're back on home\n+    // We should be on home because page 2 has not been fully loaded yet when we navigated back\n+    await browser.waitForIdleNetwork()\n+    await browser.waitForElementByCss('[data-testid=\"home-link\"]')\n+\n+    // Pending state should be gone\n+    const post2LoadingElements = await browser.elementsByCss('#post-2-loading')\n+    expect(post2LoadingElements.length).toBe(0)\n+  })\n+\n+  it('should show pending state when navigating to the same path', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Click post 1 link\n+    await browser.elementById('post-1-link').click()\n+\n+    // Wait for navigation to complete\n+    await browser.waitForIdleNetwork()\n+    await browser.waitForElementByCss('[data-testid=\"post-1-page\"]')\n+\n+    // Click post 1 link again\n+    await browser.elementById('post-1-link').click()\n+    // Verify pending state is shown even though it's the same path\n+    expect(await browser.elementById('post-1-loading').text()).toBe('(Loading)')\n+\n+    // Wait for navigation to complete and verify we're still on post 1\n+    await browser.waitForIdleNetwork()\n+    await browser.waitForElementByCss('[data-testid=\"post-1-page\"]')\n+  })\n+\n+  it('should remove pending state when navigation starts by router.push', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Click post 1 link\n+    await browser.elementById('post-1-link').click()\n+\n+    // Verify pending state is shown\n+    expect(await browser.elementById('post-1-loading').text()).toBe('(Loading)')\n+\n+    // Click router push button for post 2\n+    await browser.elementById('router-push-2-btn').click()\n+\n+    // Pending state for post 1 should be gone\n+    const post1Loading = await browser.elementsByCss('#post-1-loading')\n+    expect(post1Loading.length).toBe(0)\n+\n+    // Wait for navigation to complete and verify we end up on post 2\n+    await browser.waitForIdleNetwork()\n+    await browser.waitForElementByCss('[data-testid=\"post-2-page\"]')\n+  })\n+\n+  it('should remove pending state when server action triggers a redirect', async () => {\n+    const browser = await next.browser('/post/1')\n+    await browser.waitForIdleNetwork()\n+    await browser.waitForElementByCss('[data-testid=\"post-1-page\"]')\n+\n+    // Click post 2 link\n+    await browser.elementById('post-2-link').click()\n+\n+    // Verify pending state is shown\n+    expect(await browser.elementById('post-2-loading').text()).toBe('(Loading)')\n+\n+    // Click server action button for home\n+    await browser.elementById('server-action-home-btn').click()\n+\n+    await waitFor(1000) // buffer for server action to return a redirect\n+\n+    // Pending state for post 2 should be gone\n+    const post2Loading = await browser.elementsByCss('#post-2-loading')\n+    expect(post2Loading.length).toBe(0)\n+\n+    // Wait for navigation to complete and verify we end up on home\n+    await browser.waitForIdleNetwork()\n+    await browser.waitForElementByCss('[data-testid=\"home-link\"]')\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 661,
        "additions": 578,
        "deletions": 83
    }
}