{
    "author": "huozhi",
    "message": "[segment explorer] handle display loading (#80698)",
    "sha": "9d4239a150fb3762caf05756d77066cb82b81398",
    "files": [
        {
            "sha": "611533be5a7e2146b754a9d3a42bdc9f6380344c",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-explorer.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9d4239a150fb3762caf05756d77066cb82b81398/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9d4239a150fb3762caf05756d77066cb82b81398/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx?ref=9d4239a150fb3762caf05756d77066cb82b81398",
            "patch": "@@ -256,4 +256,8 @@ export const DEV_TOOLS_INFO_RENDER_FILES_STYLES = css`\n     background-color: var(--color-amber-300);\n     color: var(--color-amber-900);\n   }\n+  .segment-explorer-file-label--loading {\n+    background-color: var(--color-green-300);\n+    color: var(--color-green-900);\n+  }\n `"
        },
        {
            "sha": "d9eeccd64ef79efe480d41abca76418c0a51db00",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/9d4239a150fb3762caf05756d77066cb82b81398/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9d4239a150fb3762caf05756d77066cb82b81398/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=9d4239a150fb3762caf05756d77066cb82b81398",
            "patch": "@@ -593,8 +593,20 @@ async function createComponentTreeInternal({\n     parallelRouteCacheNodeSeedData[parallelRouteKey] = flightData\n   }\n \n-  const loadingData: LoadingModuleData = Loading\n-    ? [<Loading key=\"l\" />, loadingStyles, loadingScripts]\n+  let loadingElement = Loading ? <Loading key=\"l\" /> : null\n+  if (isSegmentViewEnabled && loadingElement) {\n+    const loadingFilePath = getConventionPathByType(tree, dir, 'loading')\n+    if (loadingFilePath) {\n+      loadingElement = (\n+        <SegmentViewNode type=\"loading\" pagePath={loadingFilePath}>\n+          {loadingElement}\n+        </SegmentViewNode>\n+      )\n+    }\n+  }\n+\n+  const loadingData: LoadingModuleData = loadingElement\n+    ? [loadingElement, loadingStyles, loadingScripts]\n     : null\n \n   // When the segment does not have a layout or page we still have to add the layout router to ensure the path holds the loading component"
        },
        {
            "sha": "dcc1740b85d9c771345cd811ed261b5a905c0db8",
            "filename": "test/development/app-dir/segment-explorer/app/search/layout.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/9d4239a150fb3762caf05756d77066cb82b81398/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9d4239a150fb3762caf05756d77066cb82b81398/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Flayout.tsx?ref=9d4239a150fb3762caf05756d77066cb82b81398",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+\n+import { Fragment } from 'react'\n+import { useSearchParams } from 'next/navigation'\n+\n+export default function SearchLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  let searchParams = useSearchParams()\n+  return <Fragment key={searchParams?.get('q')}>{children}</Fragment>\n+}"
        },
        {
            "sha": "c39332b81daa04433dbbc2e8e549f3b9910dc234",
            "filename": "test/development/app-dir/segment-explorer/app/search/loading.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9d4239a150fb3762caf05756d77066cb82b81398/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Floading.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9d4239a150fb3762caf05756d77066cb82b81398/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Floading.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Floading.tsx?ref=9d4239a150fb3762caf05756d77066cb82b81398",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Loading() {\n+  return <p id=\"loading\">Loading...</p>\n+}"
        },
        {
            "sha": "c0f3cfdb820831962017a2ae234eccef89bd79fe",
            "filename": "test/development/app-dir/segment-explorer/app/search/page.tsx",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/9d4239a150fb3762caf05756d77066cb82b81398/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9d4239a150fb3762caf05756d77066cb82b81398/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Fpage.tsx?ref=9d4239a150fb3762caf05756d77066cb82b81398",
            "patch": "@@ -0,0 +1,21 @@\n+import { Search } from './search'\n+\n+type AnySearchParams = { [key: string]: string | Array<string> | undefined }\n+\n+export default async function Page({\n+  searchParams,\n+}: {\n+  searchParams: Promise<AnySearchParams>\n+}) {\n+  const search = await searchParams\n+  if (Object.keys(search).length > 0) {\n+    await new Promise((resolve) => setTimeout(resolve, 30 * 1000))\n+  }\n+\n+  return (\n+    <main id=\"page-content\">\n+      <Search />\n+      <p id=\"search-value\">Search Value: {search.q ?? 'None'}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "c50fae8db3feb5d6e8b4b4c59d05762beebedd9e",
            "filename": "test/development/app-dir/segment-explorer/app/search/search.tsx",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/9d4239a150fb3762caf05756d77066cb82b81398/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Fsearch.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9d4239a150fb3762caf05756d77066cb82b81398/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Fsearch.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsearch%2Fsearch.tsx?ref=9d4239a150fb3762caf05756d77066cb82b81398",
            "patch": "@@ -0,0 +1,22 @@\n+'use client'\n+\n+import { useRouter } from 'next/navigation'\n+\n+export function Search() {\n+  let router = useRouter()\n+\n+  function search(event: React.FormEvent<HTMLFormElement>) {\n+    event.preventDefault()\n+\n+    let input = event.currentTarget.q.value\n+    let params = new URLSearchParams([['q', input]])\n+    router.push(`/search?${params}`)\n+  }\n+\n+  return (\n+    <form onSubmit={search}>\n+      <input placeholder=\"Search...\" name=\"q\" className=\"border\" />\n+      <button>Submit</button>\n+    </form>\n+  )\n+}"
        },
        {
            "sha": "873185ceb10d4ec4b893f92d3bdda30a937cf82f",
            "filename": "test/development/app-dir/segment-explorer/segment-explorer.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/9d4239a150fb3762caf05756d77066cb82b81398/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d4239a150fb3762caf05756d77066cb82b81398/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts?ref=9d4239a150fb3762caf05756d77066cb82b81398",
            "patch": "@@ -160,4 +160,23 @@ describe('segment-explorer', () => {\n      unauthorized.tsx\"\n     `)\n   })\n+\n+  it('should show the loading boundary when it is present', async () => {\n+    const browser = await next.browser('/search')\n+    const input = await browser.elementByCss('input[name=\"q\"]')\n+    await input.fill('abc')\n+    await browser.elementByCss('button').click() // submit the form\n+\n+    await retry(async () => {\n+      expect(await browser.elementByCss('#loading').text()).toBe('Loading...')\n+    })\n+\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n+     \"app/\n+     layout.tsx\n+     search/\n+     layout.tsx\n+     loading.tsx\"\n+    `)\n+  })\n })"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 96,
        "deletions": 2
    }
}