{
    "author": "wyattjoh",
    "message": "test: improve router prefetch test reliability (#86098)\n\nThis updates the tests to use the accordion style link reveal technique\nto ensure that prefetches occur within the act and do not hang waiting\nfor requests to be initiated.",
    "sha": "b24c4bb603eecd05f88f34092f001698aee0b9b9",
    "files": [
        {
            "sha": "7a87388c5a06ada1b88870b511f5d735cabffb9f",
            "filename": "test/e2e/app-dir/app-client-cache/client-cache.parallel-routes.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 28,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/b24c4bb603eecd05f88f34092f001698aee0b9b9/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.parallel-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b24c4bb603eecd05f88f34092f001698aee0b9b9/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.parallel-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.parallel-routes.test.ts?ref=b24c4bb603eecd05f88f34092f001698aee0b9b9",
            "patch": "@@ -2,6 +2,7 @@ import { nextTestSetup } from 'e2e-utils'\n import { createRouterAct } from 'router-act'\n import { browserConfigWithFixedTime, fastForwardTo } from './test-utils'\n import path from 'path'\n+import { Playwright } from 'next-webdriver'\n \n describe('app dir client cache with parallel routes', () => {\n   const { next, isNextDev } = nextTestSetup({\n@@ -14,6 +15,18 @@ describe('app dir client cache with parallel routes', () => {\n     return\n   }\n \n+  async function reveal(browser: Playwright, href: string) {\n+    // Get the reveal element and scroll it into view.\n+    const reveal = await browser.elementByCss(`[data-link-accordion=\"${href}\"]`)\n+    await reveal.scrollIntoViewIfNeeded()\n+\n+    // Click the reveal element to reveal the content.\n+    await reveal.click()\n+\n+    // Return the anchor link element.\n+    return browser.elementByCss(`a[href=\"${href}\"]`)\n+  }\n+\n   describe('prefetch={true}', () => {\n     it('should prefetch the full page', async () => {\n       let act: ReturnType<typeof createRouterAct>\n@@ -27,11 +40,7 @@ describe('app dir client cache with parallel routes', () => {\n       // Reveal the link to trigger prefetch and wait for it to complete\n       const link = await act(\n         async () => {\n-          const reveal = await browser.elementByCss(\n-            '[data-link-accordion=\"/0\"]'\n-          )\n-          await reveal.click()\n-          return await browser.elementByCss('[href=\"/0\"]')\n+          return reveal(browser, '/0')\n         },\n         { includes: 'random-number' }\n       )\n@@ -55,11 +64,8 @@ describe('app dir client cache with parallel routes', () => {\n       // Toggle the link, assert on the prefetch content\n       const link = await act(\n         async () => {\n-          const reveal = await browser.elementByCss(\n-            '[data-link-accordion=\"/0\"]'\n-          )\n-          await reveal.click()\n-          return await browser.elementByCss('[href=\"/0\"]')\n+          await reveal(browser, '/0')\n+          return browser.elementByCss('[href=\"/0\"]')\n         },\n         { includes: 'random-number' }\n       )\n@@ -68,15 +74,13 @@ describe('app dir client cache with parallel routes', () => {\n       const randomNumber = await act(async () => {\n         await link.click()\n         await browser.waitForElementByCss('#random-number')\n-        return await browser.elementByCss('#random-number').text()\n+        return browser.elementByCss('#random-number').text()\n       }, 'no-requests')\n \n       // Toggle the home link, assert on the homepage content\n       const homeLink = await act(\n         async () => {\n-          const reveal = await browser.elementByCss('[data-link-accordion=\"/\"]')\n-          await reveal.click()\n-          return await browser.elementByCss('[href=\"/\"]')\n+          return reveal(browser, '/')\n         },\n         { includes: 'home-page' }\n       )\n@@ -89,22 +93,18 @@ describe('app dir client cache with parallel routes', () => {\n \n       // Toggle the link to the other page again, navigate, assert no requests (because it's cached)\n       const number = await act(async () => {\n-        const reveal = await browser.elementByCss('[data-link-accordion=\"/0\"]')\n-        await reveal.click()\n-        const link = await browser.elementByCss('[href=\"/0\"]')\n+        const link = await reveal(browser, '/0')\n         await link.click()\n         await browser.waitForElementByCss('#random-number')\n-        return await browser.elementByCss('#random-number').text()\n+        return browser.elementByCss('#random-number').text()\n       }, 'no-requests')\n \n       expect(number).toBe(randomNumber)\n \n       // Navigate back home\n       await act(async () => {\n-        const reveal = await browser.elementByCss('[data-link-accordion=\"/\"]')\n-        await reveal.click()\n-        const homeLink = await browser.elementByCss('[href=\"/\"]')\n-        await homeLink.click()\n+        const link = await reveal(browser, '/')\n+        await link.click()\n         await browser.waitForElementByCss('#home-page')\n       }, 'no-requests')\n \n@@ -114,11 +114,7 @@ describe('app dir client cache with parallel routes', () => {\n       // Toggle the link to the other page again, assert on prefetch content\n       const linkAfterExpiry = await act(\n         async () => {\n-          const reveal = await browser.elementByCss(\n-            '[data-link-accordion=\"/0\"]'\n-          )\n-          await reveal.click()\n-          return await browser.elementByCss('[href=\"/0\"]')\n+          return reveal(browser, '/0')\n         },\n         { includes: 'random-number' }\n       )\n@@ -127,7 +123,7 @@ describe('app dir client cache with parallel routes', () => {\n       const newNumber = await act(async () => {\n         await linkAfterExpiry.click()\n         await browser.waitForElementByCss('#random-number')\n-        return await browser.elementByCss('#random-number').text()\n+        return browser.elementByCss('#random-number').text()\n       }, 'no-requests')\n \n       expect(newNumber).not.toBe(randomNumber)"
        },
        {
            "sha": "2b26bc523031bb546a7c907471279b66acb13964",
            "filename": "test/e2e/app-dir/interception-dynamic-segment/app/page.client.tsx",
            "status": "added",
            "additions": 94,
            "deletions": 0,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/b24c4bb603eecd05f88f34092f001698aee0b9b9/test%2Fe2e%2Fapp-dir%2Finterception-dynamic-segment%2Fapp%2Fpage.client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b24c4bb603eecd05f88f34092f001698aee0b9b9/test%2Fe2e%2Fapp-dir%2Finterception-dynamic-segment%2Fapp%2Fpage.client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finterception-dynamic-segment%2Fapp%2Fpage.client.tsx?ref=b24c4bb603eecd05f88f34092f001698aee0b9b9",
            "patch": "@@ -0,0 +1,94 @@\n+'use client'\n+\n+import Link from 'next/link'\n+import { useState } from 'react'\n+\n+export function LinkAccordion({ href }: { href: string }) {\n+  const [isOpen, setIsOpen] = useState(false)\n+\n+  return (\n+    <div\n+      data-testid=\"link-accordion\"\n+      data-href={href}\n+      style={{\n+        border: '1px solid #e5e7eb',\n+        borderRadius: '12px',\n+        padding: '16px',\n+        margin: '12px 0',\n+        backgroundColor: 'white',\n+        boxShadow:\n+          '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',\n+        transition: 'all 0.2s ease',\n+        cursor: 'pointer',\n+      }}\n+    >\n+      <div\n+        style={{\n+          display: 'flex',\n+          justifyContent: 'space-between',\n+          alignItems: 'center',\n+          gap: '12px',\n+        }}\n+      >\n+        <div\n+          style={{\n+            fontFamily: 'monospace',\n+            fontSize: '14px',\n+            color: '#374151',\n+            fontWeight: '500',\n+            flex: 1,\n+          }}\n+        >\n+          {href}\n+        </div>\n+        {!isOpen && (\n+          <button\n+            onClick={() => setIsOpen(true)}\n+            style={{\n+              padding: '8px 16px',\n+              borderRadius: '8px',\n+              border: 'none',\n+              backgroundColor: '#3b82f6',\n+              color: 'white',\n+              fontSize: '14px',\n+              fontWeight: '600',\n+              cursor: 'pointer',\n+              transition: 'all 0.2s ease',\n+              display: 'flex',\n+              alignItems: 'center',\n+              gap: '6px',\n+            }}\n+          >\n+            <span>▶</span>\n+            Open\n+          </button>\n+        )}\n+      </div>\n+      {isOpen && (\n+        <div\n+          style={{\n+            marginTop: '16px',\n+            paddingTop: '16px',\n+            borderTop: '1px solid #e5e7eb',\n+          }}\n+        >\n+          <Link\n+            href={href}\n+            style={{\n+              display: 'inline-block',\n+              padding: '10px 20px',\n+              backgroundColor: '#10b981',\n+              color: 'white',\n+              textDecoration: 'none',\n+              borderRadius: '8px',\n+              fontSize: '14px',\n+              fontWeight: '600',\n+            }}\n+          >\n+            Navigate to {href}\n+          </Link>\n+        </div>\n+      )}\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "1deac6767f7eee8d8f5e6b1f6c0e220e278bec4a",
            "filename": "test/e2e/app-dir/interception-dynamic-segment/app/page.tsx",
            "status": "modified",
            "additions": 11,
            "deletions": 17,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/b24c4bb603eecd05f88f34092f001698aee0b9b9/test%2Fe2e%2Fapp-dir%2Finterception-dynamic-segment%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b24c4bb603eecd05f88f34092f001698aee0b9b9/test%2Fe2e%2Fapp-dir%2Finterception-dynamic-segment%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finterception-dynamic-segment%2Fapp%2Fpage.tsx?ref=b24c4bb603eecd05f88f34092f001698aee0b9b9",
            "patch": "@@ -1,4 +1,4 @@\n-import Link from 'next/link'\n+import { LinkAccordion } from './page.client'\n \n export default function Page() {\n   return (\n@@ -8,17 +8,15 @@ export default function Page() {\n \n         <div>\n           <h3>Test Case 1a: Simple page (no parallel routes)</h3>\n-          <Link href=\"/simple-page\" style={{ color: 'blue', fontSize: '16px' }}>\n-            → /simple-page\n-          </Link>\n+          <LinkAccordion href=\"/simple-page\" />\n           <p>\n             Interception route with just a page.tsx, no parallel routes at all.\n           </p>\n         </div>\n \n         <div>\n           <h3>Test Case 1b: Has page.tsx</h3>\n-          <Link href=\"/has-page\">→ /has-page</Link>\n+          <LinkAccordion href=\"/has-page\" />\n           <p>\n             Interception route has page.tsx at root level. No children slot\n             exists.\n@@ -27,15 +25,13 @@ export default function Page() {\n \n         <div>\n           <h3>Test Case 2: No parallel routes</h3>\n-          <Link href=\"/no-parallel-routes/deeper\">\n-            → /no-parallel-routes/deeper\n-          </Link>\n+          <LinkAccordion href=\"/no-parallel-routes/deeper\" />\n           <p>No @parallel routes exist, so no implicit layout created.</p>\n         </div>\n \n         <div>\n           <h3>Test Case 3: Has both @sidebar AND page.tsx</h3>\n-          <Link href=\"/has-both\">→ /has-both</Link>\n+          <LinkAccordion href=\"/has-both\" />\n           <p>\n             Has @sidebar parallel route BUT page.tsx fills the children slot.\n           </p>\n@@ -47,14 +43,14 @@ export default function Page() {\n \n         <div>\n           <h3>Test Case 4a: Has @sidebar but NO page.tsx (implicit layout)</h3>\n-          <Link href=\"/test-nested\">→ /test-nested</Link>\n+          <LinkAccordion href=\"/test-nested\" />\n           <p>Has @sidebar (creates implicit layout) but NO page.tsx.</p>\n           <p>✓ Auto-uses null default (no explicit files needed)</p>\n         </div>\n \n         <div>\n           <h3>Test Case 4b: Has explicit layout.tsx but NO parallel routes</h3>\n-          <Link href=\"/explicit-layout/deeper\">→ /explicit-layout/deeper</Link>\n+          <LinkAccordion href=\"/explicit-layout/deeper\" />\n           <p>\n             Has explicit layout.tsx with children slot, but NO parallel routes\n             like @sidebar.\n@@ -69,18 +65,16 @@ export default function Page() {\n         <h2>Original Tests</h2>\n         <ul>\n           <li>\n-            <Link href=\"/foo/1\">/foo/1</Link>\n+            <LinkAccordion href=\"/foo/1\" />\n           </li>\n           <li>\n-            <Link href=\"/bar/1\">/bar/1</Link>\n+            <LinkAccordion href=\"/bar/1\" />\n           </li>\n           <li>\n-            <Link href=\"/test-nested/deeper\">/test-nested/deeper</Link>\n+            <LinkAccordion href=\"/test-nested/deeper\" />\n           </li>\n           <li>\n-            <Link href=\"/generate-static-params/foo\">\n-              /generate-static-params/foo\n-            </Link>\n+            <LinkAccordion href=\"/generate-static-params/foo\" />\n           </li>\n         </ul>\n       </section>"
        },
        {
            "sha": "2620329ca8a146873f53f94b40223c09668c93ac",
            "filename": "test/e2e/app-dir/interception-dynamic-segment/interception-dynamic-segment.test.ts",
            "status": "modified",
            "additions": 60,
            "deletions": 18,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/b24c4bb603eecd05f88f34092f001698aee0b9b9/test%2Fe2e%2Fapp-dir%2Finterception-dynamic-segment%2Finterception-dynamic-segment.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b24c4bb603eecd05f88f34092f001698aee0b9b9/test%2Fe2e%2Fapp-dir%2Finterception-dynamic-segment%2Finterception-dynamic-segment.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finterception-dynamic-segment%2Finterception-dynamic-segment.test.ts?ref=b24c4bb603eecd05f88f34092f001698aee0b9b9",
            "patch": "@@ -1,12 +1,50 @@\n import { nextTestSetup } from 'e2e-utils'\n import { retry } from 'next-test-utils'\n+import { Playwright } from 'next-webdriver'\n import { createRouterAct } from 'router-act'\n \n describe('interception-dynamic-segment', () => {\n   const { next, isNextStart, isNextDev } = nextTestSetup({\n     files: __dirname,\n   })\n \n+  /**\n+   * Returns true if the given href should already be opened. This allows us to\n+   * condition on whether to expect any additional network requests.\n+   */\n+  async function isAccordionClosed(\n+    browser: Playwright,\n+    href: string\n+  ): Promise<boolean> {\n+    const selector = `[data-testid=\"link-accordion\"][data-href=\"${href}\"]`\n+\n+    // Check if the button is already open\n+    return await browser.hasElementByCss(`${selector} button`)\n+  }\n+\n+  /**\n+   * Helper to navigate via the LinkAccordion component.\n+   * Scrolls to the accordion, opens it, and clicks the link.\n+   */\n+  async function navigate(browser: Playwright, href: string) {\n+    const selector = `[data-testid=\"link-accordion\"][data-href=\"${href}\"]`\n+\n+    // Find and scroll to accordion\n+    const accordion = await browser.elementByCss(selector)\n+    await accordion.scrollIntoViewIfNeeded()\n+\n+    // Click the \"Open\" button, it may already be open, so we don't need to\n+    // click it again.\n+    if (await isAccordionClosed(browser, href)) {\n+      const button = await browser.elementByCss(`${selector} button`)\n+      await button.click()\n+    }\n+\n+    // Click the actual link\n+    const link = await browser.elementByCss(`${selector} a`)\n+    await link.click()\n+  }\n+\n   /**\n    * Create a browser with router act that will FAIL if any 404s occur during navigation.\n    * This is critical because if a 404 occurs, the client will perform MPA navigation\n@@ -27,7 +65,7 @@ describe('interception-dynamic-segment', () => {\n   it('should work when interception route is paired with a dynamic segment', async () => {\n     const browser = await next.browser('/')\n \n-    await browser.elementByCss('[href=\"/foo/1\"]').click()\n+    await navigate(browser, '/foo/1')\n     await browser.waitForIdleNetwork()\n \n     await retry(async () => {\n@@ -52,7 +90,7 @@ describe('interception-dynamic-segment', () => {\n     const browser = await next.browser('/')\n \n     // Navigate with interception\n-    await browser.elementByCss('[href=\"/foo/1\"]').click()\n+    await navigate(browser, '/foo/1')\n     await browser.waitForIdleNetwork()\n \n     await retry(async () => {\n@@ -82,7 +120,7 @@ describe('interception-dynamic-segment', () => {\n     const browser = await next.browser('/')\n \n     for (let i = 0; i < 2; i++) {\n-      await browser.elementByCss('[href=\"/foo/1\"]').click()\n+      await navigate(browser, '/foo/1')\n       await browser.waitForIdleNetwork()\n \n       await retry(async () => {\n@@ -126,7 +164,7 @@ describe('interception-dynamic-segment', () => {\n         const { act, browser } = await createBrowserWithRouterAct('/')\n \n         await act(async () => {\n-          await browser.elementByCss('[href=\"/foo/1\"]').click()\n+          await navigate(browser, '/foo/1')\n         })\n \n         await retry(async () => {\n@@ -145,7 +183,7 @@ describe('interception-dynamic-segment', () => {\n         const { act, browser } = await createBrowserWithRouterAct('/')\n \n         await act(async () => {\n-          await browser.elementByCss('[href=\"/simple-page\"]').click()\n+          await navigate(browser, '/simple-page')\n         })\n \n         await retry(async () => {\n@@ -165,7 +203,7 @@ describe('interception-dynamic-segment', () => {\n         const { act, browser } = await createBrowserWithRouterAct('/')\n \n         await act(async () => {\n-          await browser.elementByCss('[href=\"/has-page\"]').click()\n+          await navigate(browser, '/has-page')\n         })\n \n         await retry(async () => {\n@@ -185,9 +223,7 @@ describe('interception-dynamic-segment', () => {\n         const { act, browser } = await createBrowserWithRouterAct('/')\n \n         await act(async () => {\n-          await browser\n-            .elementByCss('[href=\"/no-parallel-routes/deeper\"]')\n-            .click()\n+          await navigate(browser, '/no-parallel-routes/deeper')\n         })\n \n         await retry(async () => {\n@@ -207,7 +243,7 @@ describe('interception-dynamic-segment', () => {\n         const { act, browser } = await createBrowserWithRouterAct('/')\n \n         await act(async () => {\n-          await browser.elementByCss('[href=\"/has-both\"]').click()\n+          await navigate(browser, '/has-both')\n         })\n \n         await retry(async () => {\n@@ -235,7 +271,7 @@ describe('interception-dynamic-segment', () => {\n         const { act, browser } = await createBrowserWithRouterAct('/')\n \n         await act(async () => {\n-          await browser.elementByCss('[href=\"/test-nested\"]').click()\n+          await navigate(browser, '/test-nested')\n         })\n \n         await retry(async () => {\n@@ -260,7 +296,7 @@ describe('interception-dynamic-segment', () => {\n \n         // Navigate directly to the deeper page from home\n         await act(async () => {\n-          await browser.elementByCss('[href=\"/test-nested/deeper\"]').click()\n+          await navigate(browser, '/test-nested/deeper')\n         })\n \n         await retry(async () => {\n@@ -290,7 +326,7 @@ describe('interception-dynamic-segment', () => {\n         const { act, browser } = await createBrowserWithRouterAct('/')\n \n         await act(async () => {\n-          await browser.elementByCss('[href=\"/explicit-layout/deeper\"]').click()\n+          await navigate(browser, '/explicit-layout/deeper')\n         })\n \n         await retry(async () => {\n@@ -310,12 +346,18 @@ describe('interception-dynamic-segment', () => {\n         const { act, browser } = await createBrowserWithRouterAct('/')\n \n         for (let i = 0; i < 3; i++) {\n+          const isAccordionOpen = i > 0\n+\n+          await expect(\n+            isAccordionClosed(browser, '/test-nested')\n+          ).resolves.toBe(!isAccordionOpen)\n+\n           // Forward navigation: triggers RSC request (validates no 404)\n           await act(\n             async () => {\n-              await browser.elementByCss('[href=\"/test-nested\"]').click()\n+              await navigate(browser, '/test-nested')\n             },\n-            i > 0 ? 'no-requests' : undefined\n+            !isAccordionOpen ? undefined : 'no-requests'\n           )\n \n           await retry(async () => {\n@@ -343,7 +385,7 @@ describe('interception-dynamic-segment', () => {\n \n         // First interception\n         await act(async () => {\n-          await browser.elementByCss('[href=\"/test-nested\"]').click()\n+          await navigate(browser, '/test-nested')\n         })\n \n         await retry(async () => {\n@@ -353,8 +395,8 @@ describe('interception-dynamic-segment', () => {\n \n         // Second interception\n         await act(async () => {\n-          await browser.elementByCss('[href=\"/has-both\"]').click()\n-        }, 'no-requests')\n+          await navigate(browser, '/has-both')\n+        })\n \n         await retry(async () => {\n           const modalContent = await browser.elementByCss('#modal').text()"
        }
    ],
    "stats": {
        "total": 252,
        "additions": 189,
        "deletions": 63
    }
}