{
    "author": "eps1lon",
    "message": "[build-sourcemaps] Only compute codeframe once (#80326)",
    "sha": "270744b7a0ecbf0ff94d0c62cd3a6b5e975d052a",
    "files": [
        {
            "sha": "8a11aab605a37f20dfebdcf23dbb9e1b12cbfe0f",
            "filename": "packages/next/src/server/patch-error-inspect.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 17,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/270744b7a0ecbf0ff94d0c62cd3a6b5e975d052a/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/270744b7a0ecbf0ff94d0c62cd3a6b5e975d052a/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts?ref=270744b7a0ecbf0ff94d0c62cd3a6b5e975d052a",
            "patch": "@@ -275,12 +275,6 @@ function getSourcemappedFrameIfPossible(\n     }\n   }\n \n-  const sourceContent: string | null =\n-    sourceMapConsumer.sourceContentFor(\n-      sourcePosition.source,\n-      /* returnNullOnMissing */ true\n-    ) ?? null\n-\n   const applicableSourceMap = findApplicableSourceMapPayload(\n     frame,\n     sourceMapPayload\n@@ -321,16 +315,33 @@ function getSourcemappedFrameIfPossible(\n     ignored,\n   }\n \n-  const codeFrame = getOriginalCodeFrame(\n-    originalFrame,\n-    sourceContent,\n-    inspectOptions.colors\n-  )\n+  /** undefined = not yet computed*/\n+  let codeFrame: string | null | undefined\n \n-  return {\n-    stack: originalFrame,\n-    code: codeFrame,\n-  }\n+  return Object.defineProperty(\n+    {\n+      stack: originalFrame,\n+      code: null,\n+    },\n+    'code',\n+    {\n+      get: () => {\n+        if (codeFrame === undefined) {\n+          const sourceContent: string | null =\n+            sourceMapConsumer.sourceContentFor(\n+              sourcePosition.source,\n+              /* returnNullOnMissing */ true\n+            ) ?? null\n+          codeFrame = getOriginalCodeFrame(\n+            originalFrame,\n+            sourceContent,\n+            inspectOptions.colors\n+          )\n+        }\n+        return codeFrame\n+      },\n+    }\n+  )\n }\n \n function parseAndSourceMap(\n@@ -372,10 +383,10 @@ function parseAndSourceMap(\n       )\n \n       if (\n-        sourcemappedFrame.code !== null &&\n         sourceFrame === null &&\n         // TODO: Is this the right choice?\n-        !sourcemappedFrame.stack.ignored\n+        !sourcemappedFrame.stack.ignored &&\n+        sourcemappedFrame.code !== null\n       ) {\n         sourceFrame = sourcemappedFrame.code\n       }"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 28,
        "deletions": 17
    }
}