{
    "author": "bgw",
    "message": "chore(turbo-tasks): Audit all remaining uses of `Vc` in a struct (#77756)\n\nI suspect the test failures in https://github.com/vercel/next.js/pull/77661 are related to a `Vc` that should be an `OperationVc`.\n\nI realized that we have so few uses of `Vc` inside structs and enums that it might be easier to work off of that list than to carefully audit my changes in my other PR, though it doesn't look like anything's a smoking gun here.\n\nEither way, while it's totally valid for non-`VcValueType` structs and enums to contain unresolved `Vc`s, it's usually suboptimal, and there should probably at least be a comment explaining the choice to use an unresolved `Vc`.\n\nI still have a long-term goal of renaming `ResolvedVc` to `Vc` and the current version of `Vc` to `UnresolvedVc`, so for that reason alone, I want everything to prefer using `ResolvedVc` \"by default\".",
    "sha": "56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
    "files": [
        {
            "sha": "b01ad5a53a22d8a73bc524ec7e03a12a350b7471",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -9692,6 +9692,7 @@ dependencies = [\n  \"serde\",\n  \"smallvec\",\n  \"swc_core\",\n+ \"tokio\",\n  \"tracing\",\n  \"turbo-rcstr\",\n  \"turbo-tasks\","
        },
        {
            "sha": "b07d3ad2dbcb48296b58405e08b85bd27ead56dc",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -1267,7 +1267,7 @@ impl AppEndpoint {\n         if emit_manifests != EmitManifests::None {\n             let app_build_manifest = AppBuildManifest {\n                 pages: fxindexmap!(\n-                    app_entry.original_name.clone() => Vc::cell(entry_client_chunks\n+                    app_entry.original_name.clone() => ResolvedVc::cell(entry_client_chunks\n                         .iter()\n                         .chain(client_shared_chunks.iter())\n                         .copied()"
        },
        {
            "sha": "5cf4396739112d6693a5f838712eba9c7e26d9b9",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -1220,7 +1220,7 @@ impl PageEndpoint {\n     #[turbo_tasks::function]\n     async fn build_manifest(\n         &self,\n-        client_chunks: Vc<OutputAssets>,\n+        client_chunks: ResolvedVc<OutputAssets>,\n     ) -> Result<Vc<Box<dyn OutputAsset>>> {\n         let node_root = self.pages_project.project().node_root();\n         let client_relative_path = self.pages_project.project().client_relative_path();"
        },
        {
            "sha": "da9c992464c17901a7f46e16577c85215d37330e",
            "filename": "crates/next-core/src/app_page_loader_tree.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -34,8 +34,8 @@ pub struct AppPageLoaderTreeBuilder {\n \n impl AppPageLoaderTreeBuilder {\n     fn new(\n-        module_asset_context: Vc<ModuleAssetContext>,\n-        server_component_transition: Vc<Box<dyn Transition>>,\n+        module_asset_context: ResolvedVc<ModuleAssetContext>,\n+        server_component_transition: ResolvedVc<Box<dyn Transition>>,\n         base_path: Option<RcStr>,\n     ) -> Self {\n         AppPageLoaderTreeBuilder {\n@@ -195,7 +195,7 @@ impl AppPageLoaderTreeBuilder {\n                     .push(format!(\"import {identifier} from \\\"{inner_module_id}\\\";\").into());\n \n                 let source = dynamic_image_metadata_source(\n-                    Vc::upcast(self.base.module_asset_context),\n+                    *ResolvedVc::upcast(self.base.module_asset_context),\n                     **path,\n                     name.into(),\n                     app_page.clone(),\n@@ -240,7 +240,7 @@ impl AppPageLoaderTreeBuilder {\n         let module = Vc::upcast(StructuredImageModuleType::create_module(\n             Vc::upcast(FileSource::new(path)),\n             BlurPlaceholderMode::None,\n-            self.base.module_asset_context,\n+            *self.base.module_asset_context,\n         ));\n         let module = self.base.process_module(module).to_resolved().await?;\n         self.base\n@@ -422,8 +422,8 @@ pub struct AppPageLoaderTreeModule {\n impl AppPageLoaderTreeModule {\n     pub async fn build(\n         loader_tree: Vc<AppPageLoaderTree>,\n-        module_asset_context: Vc<ModuleAssetContext>,\n-        server_component_transition: Vc<Box<dyn Transition>>,\n+        module_asset_context: ResolvedVc<ModuleAssetContext>,\n+        server_component_transition: ResolvedVc<Box<dyn Transition>>,\n         base_path: Option<RcStr>,\n     ) -> Result<Self> {\n         AppPageLoaderTreeBuilder::new(module_asset_context, server_component_transition, base_path)"
        },
        {
            "sha": "20020a503ad72733712e305de2cb053cff96d9b1",
            "filename": "crates/next-core/src/base_loader_tree.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fbase_loader_tree.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fbase_loader_tree.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fbase_loader_tree.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -16,8 +16,8 @@ pub struct BaseLoaderTreeBuilder {\n     pub inner_assets: FxIndexMap<RcStr, ResolvedVc<Box<dyn Module>>>,\n     counter: usize,\n     pub imports: Vec<RcStr>,\n-    pub module_asset_context: Vc<ModuleAssetContext>,\n-    pub server_component_transition: Vc<Box<dyn Transition>>,\n+    pub module_asset_context: ResolvedVc<ModuleAssetContext>,\n+    pub server_component_transition: ResolvedVc<Box<dyn Transition>>,\n }\n \n #[derive(Clone, Copy, Debug, PartialEq, Eq)]\n@@ -53,8 +53,8 @@ impl AppDirModuleType {\n \n impl BaseLoaderTreeBuilder {\n     pub fn new(\n-        module_asset_context: Vc<ModuleAssetContext>,\n-        server_component_transition: Vc<Box<dyn Transition>>,\n+        module_asset_context: ResolvedVc<ModuleAssetContext>,\n+        server_component_transition: ResolvedVc<Box<dyn Transition>>,\n     ) -> Self {\n         BaseLoaderTreeBuilder {\n             inner_assets: FxIndexMap::default(),\n@@ -77,13 +77,13 @@ impl BaseLoaderTreeBuilder {\n         ));\n \n         self.server_component_transition\n-            .process(source, self.module_asset_context, reference_type)\n+            .process(source, *self.module_asset_context, reference_type)\n             .module()\n     }\n \n     pub fn process_module(&self, module: Vc<Box<dyn Module>>) -> Vc<Box<dyn Module>> {\n         self.server_component_transition\n-            .process_module(module, self.module_asset_context)\n+            .process_module(module, *self.module_asset_context)\n     }\n \n     pub async fn create_module_tuple_code("
        },
        {
            "sha": "c8d889ec3a10e75019e1df6aa706d1c69edc699d",
            "filename": "crates/next-core/src/next_app/app_page_entry.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -33,8 +33,8 @@ use crate::{\n /// Computes the entry for a Next.js app page.\n #[turbo_tasks::function]\n pub async fn get_app_page_entry(\n-    nodejs_context: Vc<ModuleAssetContext>,\n-    edge_context: Vc<ModuleAssetContext>,\n+    nodejs_context: ResolvedVc<ModuleAssetContext>,\n+    edge_context: ResolvedVc<ModuleAssetContext>,\n     loader_tree: Vc<AppPageLoaderTree>,\n     page: AppPage,\n     project_root: Vc<FileSystemPath>,\n@@ -48,7 +48,8 @@ pub async fn get_app_page_entry(\n         nodejs_context\n     };\n \n-    let server_component_transition = Vc::upcast(NextServerComponentTransition::new());\n+    let server_component_transition =\n+        ResolvedVc::upcast(NextServerComponentTransition::new().to_resolved().await?);\n \n     let base_path = next_config.await?.base_path.clone();\n     let loader_tree = AppPageLoaderTreeModule::build(\n@@ -123,7 +124,7 @@ pub async fn get_app_page_entry(\n \n     if is_edge {\n         rsc_entry = wrap_edge_page(\n-            Vc::upcast(module_asset_context),\n+            *ResolvedVc::upcast(module_asset_context),\n             project_root,\n             rsc_entry,\n             page,"
        },
        {
            "sha": "dbd274ff7397c54088a3da60381e1b48797efa04",
            "filename": "crates/next-core/src/next_manifests/mod.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fmod.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -29,7 +29,7 @@ pub struct PagesManifest {\n pub struct BuildManifest {\n     pub polyfill_files: Vec<ResolvedVc<Box<dyn OutputAsset>>>,\n     pub root_main_files: Vec<ResolvedVc<Box<dyn OutputAsset>>>,\n-    pub pages: FxIndexMap<RcStr, Vc<OutputAssets>>,\n+    pub pages: FxIndexMap<RcStr, ResolvedVc<OutputAssets>>,\n }\n \n impl BuildManifest {\n@@ -111,12 +111,7 @@ impl BuildManifest {\n             ..Default::default()\n         };\n \n-        let chunks: Vec<ReadRef<OutputAssets>> = self\n-            .pages\n-            .values()\n-            // rustc struggles here, so be very explicit\n-            .try_join()\n-            .await?;\n+        let chunks: Vec<ReadRef<OutputAssets>> = self.pages.values().try_join().await?;\n \n         let references = chunks\n             .into_iter()\n@@ -420,7 +415,7 @@ pub struct FontManifestEntry {\n \n #[derive(Default, Debug)]\n pub struct AppBuildManifest {\n-    pub pages: FxIndexMap<RcStr, Vc<OutputAssets>>,\n+    pub pages: FxIndexMap<RcStr, ResolvedVc<OutputAssets>>,\n }\n \n impl AppBuildManifest {"
        },
        {
            "sha": "883000639c51b1d9fe6f881e03b5e81885fd77bd",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 12,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -666,7 +666,7 @@ pub async fn get_server_module_options_context(\n             foreign_next_server_rules.extend(internal_custom_rules);\n \n             custom_source_transform_rules.push(\n-                get_next_react_server_components_transform_rule(next_config, false, Some(*app_dir))\n+                get_next_react_server_components_transform_rule(next_config, false, Some(app_dir))\n                     .await?,\n             );\n \n@@ -736,7 +736,7 @@ pub async fn get_server_module_options_context(\n             {\n                 custom_source_transform_rules.push(get_ecma_transform_rule(\n                     Box::new(ClientDirectiveTransformer::new(\n-                        *ecmascript_client_reference_transition_name,\n+                        ecmascript_client_reference_transition_name,\n                     )),\n                     enable_mdx_rs.is_some(),\n                     true,\n@@ -747,7 +747,7 @@ pub async fn get_server_module_options_context(\n             foreign_next_server_rules.extend(internal_custom_rules);\n \n             custom_source_transform_rules.push(\n-                get_next_react_server_components_transform_rule(next_config, true, Some(*app_dir))\n+                get_next_react_server_components_transform_rule(next_config, true, Some(app_dir))\n                     .await?,\n             );\n \n@@ -803,7 +803,7 @@ pub async fn get_server_module_options_context(\n             next_server_rules.extend(source_transform_rules);\n \n             let mut common_next_server_rules = vec![\n-                get_next_react_server_components_transform_rule(next_config, true, Some(*app_dir))\n+                get_next_react_server_components_transform_rule(next_config, true, Some(app_dir))\n                     .await?,\n             ];\n \n@@ -812,7 +812,7 @@ pub async fn get_server_module_options_context(\n             {\n                 common_next_server_rules.push(get_ecma_transform_rule(\n                     Box::new(ClientDirectiveTransformer::new(\n-                        *ecmascript_client_reference_transition_name,\n+                        ecmascript_client_reference_transition_name,\n                     )),\n                     enable_mdx_rs.is_some(),\n                     true,\n@@ -890,7 +890,7 @@ pub async fn get_server_module_options_context(\n             {\n                 custom_source_transform_rules.push(get_ecma_transform_rule(\n                     Box::new(ClientDirectiveTransformer::new(\n-                        *ecmascript_client_reference_transition_name,\n+                        ecmascript_client_reference_transition_name,\n                     )),\n                     enable_mdx_rs.is_some(),\n                     true,\n@@ -906,12 +906,7 @@ pub async fn get_server_module_options_context(\n             }\n \n             custom_source_transform_rules.push(\n-                get_next_react_server_components_transform_rule(\n-                    next_config,\n-                    true,\n-                    app_dir.as_deref().copied(),\n-                )\n-                .await?,\n+                get_next_react_server_components_transform_rule(next_config, true, app_dir).await?,\n             );\n \n             internal_custom_rules.extend(custom_source_transform_rules.iter().cloned());"
        },
        {
            "sha": "e9b29e72ba8d2e89dc3ea32424fb50ac8e405e53",
            "filename": "crates/next-core/src/next_shared/transforms/next_react_server_components.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_react_server_components.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_react_server_components.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_react_server_components.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -5,7 +5,7 @@ use swc_core::{\n     common::FileName,\n     ecma::{ast::Program, visit::VisitWith},\n };\n-use turbo_tasks::Vc;\n+use turbo_tasks::{ResolvedVc, Vc};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::module_options::ModuleRule;\n use turbopack_ecmascript::{CustomTransformer, TransformContext};\n@@ -31,7 +31,7 @@ use crate::next_config::NextConfig;\n pub async fn get_next_react_server_components_transform_rule(\n     next_config: Vc<NextConfig>,\n     is_react_server_layer: bool,\n-    app_dir: Option<Vc<FileSystemPath>>,\n+    app_dir: Option<ResolvedVc<FileSystemPath>>,\n ) -> Result<ModuleRule> {\n     let enable_mdx_rs = next_config.mdx_rs().await?.is_some();\n     let dynamic_io_enabled = *next_config.enable_dynamic_io().await?;\n@@ -53,15 +53,15 @@ struct NextJsReactServerComponents {\n     is_react_server_layer: bool,\n     dynamic_io_enabled: bool,\n     use_cache_enabled: bool,\n-    app_dir: Option<Vc<FileSystemPath>>,\n+    app_dir: Option<ResolvedVc<FileSystemPath>>,\n }\n \n impl NextJsReactServerComponents {\n     fn new(\n         is_react_server_layer: bool,\n         dynamic_io_enabled: bool,\n         use_cache_enabled: bool,\n-        app_dir: Option<Vc<FileSystemPath>>,\n+        app_dir: Option<ResolvedVc<FileSystemPath>>,\n     ) -> Self {\n         Self {\n             is_react_server_layer,"
        },
        {
            "sha": "d3929301e60f2ec409331f3bcb5c3754061dba6a",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunk_group.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunk_group.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunk_group.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunk_group.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -147,11 +147,11 @@ pub async fn make_chunk_group(\n     // Pass chunk items to chunking algorithm\n     let chunks = make_chunks(\n         module_graph,\n-        *chunking_context,\n+        chunking_context,\n         chunk_items,\n         chunk_item_batch_groups,\n         \"\".into(),\n-        Vc::cell(referenced_output_assets),\n+        ResolvedVc::cell(referenced_output_assets),\n     )\n     .await?;\n "
        },
        {
            "sha": "4f31587898a2bd7209781e30b3fcbd52761a5095",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking/dev.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fdev.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fdev.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fdev.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -5,7 +5,7 @@ use either::Either;\n use once_cell::sync::Lazy;\n use regex::Regex;\n use tracing::Level;\n-use turbo_tasks::{FxIndexMap, ResolvedVc, TryJoinIterExt, ValueToString, Vc};\n+use turbo_tasks::{FxIndexMap, ResolvedVc, TryJoinIterExt, ValueToString};\n \n use crate::chunk::{\n     chunking::{make_chunk, ChunkItemOrBatchWithInfo, SplitContext},\n@@ -39,7 +39,7 @@ async fn handle_split_group<'l>(\n pub async fn expand_batches(\n     chunk_items: Vec<&ChunkItemOrBatchWithInfo>,\n     ty: ResolvedVc<Box<dyn ChunkType>>,\n-    chunking_context: Vc<Box<dyn ChunkingContext>>,\n+    chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n ) -> Result<Vec<ChunkItemOrBatchWithInfo>> {\n     let mut expanded = Vec::new();\n     for item in chunk_items {\n@@ -55,7 +55,7 @@ pub async fn expand_batches(\n                         .iter()\n                         .map(async |item| {\n                             let size = ty.chunk_item_size(\n-                                chunking_context,\n+                                *chunking_context,\n                                 *item.chunk_item,\n                                 item.async_info.map(|i| *i),\n                             );"
        },
        {
            "sha": "ebb916c7c92121d84dbceff4d23b54aea8147456",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking/mod.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fmod.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -287,11 +287,11 @@ async fn batch_chunk_items_with_info_with_type(\n /// attaches `referenced_output_assets` to the first chunk.\n pub async fn make_chunks(\n     module_graph: Vc<ModuleGraph>,\n-    chunking_context: Vc<Box<dyn ChunkingContext>>,\n+    chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     chunk_items_or_batches: Vec<ChunkItemOrBatchWithAsyncModuleInfo>,\n     batch_groups: Vec<ResolvedVc<ChunkItemBatchGroup>>,\n     key_prefix: RcStr,\n-    mut referenced_output_assets: Vc<OutputAssets>,\n+    mut referenced_output_assets: ResolvedVc<OutputAssets>,\n ) -> Result<Vec<ResolvedVc<Box<dyn Chunk>>>> {\n     let chunking_configs = &*chunking_context.chunking_configs().await?;\n \n@@ -303,8 +303,8 @@ pub async fn make_chunks(\n     let chunk_items: Vec<ReadRef<ChunkItemsWithInfo>> = batch_info(\n         &batch_groups,\n         &chunk_items_or_batches,\n-        |batch_group| batch_chunk_items_with_info(batch_group, chunking_context).into_future(),\n-        |c| chunk_items_with_info(c.clone(), chunking_context).to_resolved(),\n+        |batch_group| batch_chunk_items_with_info(batch_group, *chunking_context).into_future(),\n+        |c| chunk_items_with_info(c.clone(), *chunking_context).to_resolved(),\n     )\n     .instrument(span)\n     .await?\n@@ -331,7 +331,7 @@ pub async fn make_chunks(\n                 chunking_context,\n                 chunks: &mut chunks,\n                 referenced_output_assets: &mut referenced_output_assets,\n-                empty_referenced_output_assets: OutputAssets::empty().resolve().await?,\n+                empty_referenced_output_assets: OutputAssets::empty().to_resolved().await?,\n             };\n \n             if let Some(chunking_config) = chunking_configs.get(&ty) {\n@@ -396,10 +396,12 @@ pub async fn make_chunks(\n \n struct SplitContext<'a> {\n     ty: ResolvedVc<Box<dyn ChunkType>>,\n-    chunking_context: Vc<Box<dyn ChunkingContext>>,\n+    chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n+    // resolution of `chunks` is deferred so it can be done with `try_join` at the end, letting as\n+    // much work happen in parallel as possible.\n     chunks: &'a mut Vec<Vc<Box<dyn Chunk>>>,\n-    referenced_output_assets: &'a mut Vc<OutputAssets>,\n-    empty_referenced_output_assets: Vc<OutputAssets>,\n+    referenced_output_assets: &'a mut ResolvedVc<OutputAssets>,\n+    empty_referenced_output_assets: ResolvedVc<OutputAssets>,\n }\n \n /// Creates a chunk with the given `chunk_items. `key` should be unique.\n@@ -412,7 +414,7 @@ async fn make_chunk<'l>(\n ) -> Result<()> {\n     split_context.chunks.push(\n         split_context.ty.chunk(\n-            split_context.chunking_context,\n+            *split_context.chunking_context,\n             chunk_items\n                 .into_iter()\n                 .map(|item| match item {\n@@ -425,7 +427,7 @@ async fn make_chunk<'l>(\n                 })\n                 .collect(),\n             ResolvedVc::deref_vec(batch_groups),\n-            replace(\n+            *replace(\n                 split_context.referenced_output_assets,\n                 split_context.empty_referenced_output_assets,\n             ),"
        },
        {
            "sha": "cf10448f9364902ee1cad59fdf2ddaf78c11143b",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking/style_production.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fstyle_production.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fstyle_production.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fstyle_production.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -15,7 +15,7 @@ pub async fn make_style_production_chunks(\n     chunk_items: Vec<&ChunkItemOrBatchWithInfo>,\n     _batch_groups: Vec<ResolvedVc<ChunkItemBatchGroup>>,\n     module_graph: Vc<ModuleGraph>,\n-    chunking_context: Vc<Box<dyn ChunkingContext>>,\n+    chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     chunking_config: &ChunkingConfig,\n     mut split_context: SplitContext<'_>,\n ) -> Result<()> {\n@@ -26,7 +26,7 @@ pub async fn make_style_production_chunks(\n     async move {\n         let style_groups = module_graph\n             .style_groups(\n-                chunking_context,\n+                *chunking_context,\n                 StyleGroupsConfig {\n                     max_chunk_size: chunking_config.max_merge_chunk_size,\n                 },"
        },
        {
            "sha": "89ee77e38b5069749d72ca5907b7e663238a9de8",
            "filename": "turbopack/crates/turbopack-css/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-css%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-css%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2FCargo.toml?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -29,6 +29,7 @@ swc_core = { workspace = true, features = [\n   \"common\",\n   \"common_concurrent\",\n ] }\n+tokio = { workspace = true }\n tracing = { workspace = true }\n turbo-rcstr = { workspace = true }\n turbo-tasks = { workspace = true }"
        },
        {
            "sha": "81120ec02f420158343fda333734372e357dc557",
            "filename": "turbopack/crates/turbopack-css/src/process.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 22,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -14,7 +14,7 @@ use smallvec::smallvec;\n use swc_core::base::sourcemap::SourceMapBuilder;\n use tracing::Instrument;\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{FxIndexMap, ResolvedVc, TryJoinIterExt, ValueToString, Vc};\n+use turbo_tasks::{FxIndexMap, ResolvedVc, ValueToString, Vc};\n use turbo_tasks_fs::{rope::Rope, FileContent, FileSystemPath};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n@@ -291,8 +291,8 @@ pub trait ProcessCss: ParseCss {\n #[turbo_tasks::function]\n pub async fn parse_css(\n     source: ResolvedVc<Box<dyn Source>>,\n-    origin: Vc<Box<dyn ResolveOrigin>>,\n-    import_context: Option<Vc<ImportContext>>,\n+    origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n+    import_context: Option<ResolvedVc<ImportContext>>,\n     ty: CssModuleAssetType,\n ) -> Result<Vc<ParseCssResult>> {\n     let span = {\n@@ -311,7 +311,7 @@ pub async fn parse_css(\n                     Err(_err) => ParseCssResult::Unparseable.cell(),\n                     Ok(string) => {\n                         process_content(\n-                            **file_content,\n+                            *file_content,\n                             string.into_owned(),\n                             fs_path.to_resolved().await?,\n                             ident_str,\n@@ -331,13 +331,13 @@ pub async fn parse_css(\n }\n \n async fn process_content(\n-    content_vc: Vc<FileContent>,\n+    content_vc: ResolvedVc<FileContent>,\n     code: String,\n     fs_path_vc: ResolvedVc<FileSystemPath>,\n     filename: &str,\n     source: ResolvedVc<Box<dyn Source>>,\n-    origin: Vc<Box<dyn ResolveOrigin>>,\n-    import_context: Option<Vc<ImportContext>>,\n+    origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n+    import_context: Option<ResolvedVc<ImportContext>>,\n     ty: CssModuleAssetType,\n ) -> Result<Vc<ParseCssResult>> {\n     #[allow(clippy::needless_lifetimes)]\n@@ -470,24 +470,12 @@ async fn process_content(\n     let mut stylesheet = stylesheet.to_static(config.clone());\n \n     let (references, url_references) =\n-        analyze_references(&mut stylesheet, source, origin, import_context)?;\n-\n-    let url_references = url_references\n-        .into_iter()\n-        .map(|(k, v)| async move { Ok((k, v.to_resolved().await?)) })\n-        .try_join()\n-        .await?;\n+        analyze_references(&mut stylesheet, source, origin, import_context).await?;\n \n     Ok(ParseCssResult::Ok {\n-        code: content_vc.to_resolved().await?,\n+        code: content_vc,\n         stylesheet,\n-        references: ResolvedVc::cell(\n-            references\n-                .into_iter()\n-                .map(|v| v.to_resolved())\n-                .try_join()\n-                .await?,\n-        ),\n+        references: ResolvedVc::cell(references),\n         url_references: ResolvedVc::cell(url_references),\n         options: config,\n     }"
        },
        {
            "sha": "b8b160e50ef53eba4593330d6e3af8e19a50d209",
            "filename": "turbopack/crates/turbopack-css/src/references/mod.rs",
            "status": "modified",
            "additions": 24,
            "deletions": 17,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Fmod.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -8,7 +8,7 @@ use lightningcss::{\n     visitor::{Visit, Visitor},\n };\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{ResolvedVc, Value, Vc};\n+use turbo_tasks::{ResolvedVc, TryJoinIterExt, Value, Vc};\n use turbopack_core::{\n     issue::IssueSource,\n     reference::ModuleReference,\n@@ -32,16 +32,16 @@ pub(crate) mod internal;\n pub(crate) mod url;\n \n pub type AnalyzedRefs = (\n-    Vec<Vc<Box<dyn ModuleReference>>>,\n-    Vec<(String, Vc<UrlAssetReference>)>,\n+    Vec<ResolvedVc<Box<dyn ModuleReference>>>,\n+    Vec<(String, ResolvedVc<UrlAssetReference>)>,\n );\n \n /// Returns `(all_references, urls)`.\n-pub fn analyze_references(\n+pub async fn analyze_references(\n     stylesheet: &mut StyleSheetLike<'static, 'static>,\n     source: ResolvedVc<Box<dyn Source>>,\n-    origin: Vc<Box<dyn ResolveOrigin>>,\n-    import_context: Option<Vc<ImportContext>>,\n+    origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n+    import_context: Option<ResolvedVc<ImportContext>>,\n ) -> Result<AnalyzedRefs> {\n     let mut references = Vec::new();\n     let mut urls = Vec::new();\n@@ -50,22 +50,29 @@ pub fn analyze_references(\n         ModuleReferencesVisitor::new(source, origin, import_context, &mut references, &mut urls);\n     stylesheet.0.visit(&mut visitor).unwrap();\n \n-    Ok((references, urls))\n+    tokio::try_join!(\n+        references.into_iter().map(|v| v.to_resolved()).try_join(),\n+        urls.into_iter()\n+            .map(|(k, v)| async move { Ok((k, v.to_resolved().await?)) })\n+            .try_join(),\n+    )\n }\n \n struct ModuleReferencesVisitor<'a> {\n     source: ResolvedVc<Box<dyn Source>>,\n-    origin: Vc<Box<dyn ResolveOrigin>>,\n-    import_context: Option<Vc<ImportContext>>,\n+    origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n+    import_context: Option<ResolvedVc<ImportContext>>,\n+    // `references` and `urls` must be resolved later (in `analyze_references`), as they're\n+    // collected inside of a synchronous visitor\n     references: &'a mut Vec<Vc<Box<dyn ModuleReference>>>,\n     urls: &'a mut Vec<(String, Vc<UrlAssetReference>)>,\n }\n \n impl<'a> ModuleReferencesVisitor<'a> {\n     fn new(\n         source: ResolvedVc<Box<dyn Source>>,\n-        origin: Vc<Box<dyn ResolveOrigin>>,\n-        import_context: Option<Vc<ImportContext>>,\n+        origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n+        import_context: Option<ResolvedVc<ImportContext>>,\n         references: &'a mut Vec<Vc<Box<dyn ModuleReference>>>,\n         urls: &'a mut Vec<(String, Vc<UrlAssetReference>)>,\n     ) -> Self {\n@@ -94,10 +101,10 @@ impl Visitor<'_> for ModuleReferencesVisitor<'_> {\n                 let issue_span = i.loc;\n \n                 self.references.push(Vc::upcast(ImportAssetReference::new(\n-                    self.origin,\n+                    *self.origin,\n                     Request::parse(Value::new(RcStr::from(src).into())),\n                     ImportAttributes::new_from_lightningcss(&i.clone().into_owned()).into(),\n-                    self.import_context,\n+                    self.import_context.map(|ctx| *ctx),\n                     IssueSource::from_line_col(\n                         ResolvedVc::upcast(self.source),\n                         SourcePos {\n@@ -113,8 +120,8 @@ impl Visitor<'_> for ModuleReferencesVisitor<'_> {\n \n                 *rule = CssRule::Ignored;\n \n-                // let res = i.visit_children(self);\n-                // res\n+                // This node type has no children worth visiting.\n+                // i.visit_children(self)\n                 Ok(())\n             }\n \n@@ -131,7 +138,7 @@ impl Visitor<'_> for ModuleReferencesVisitor<'_> {\n             let issue_span = u.loc;\n \n             let vc = UrlAssetReference::new(\n-                self.origin,\n+                *self.origin,\n                 Request::parse(Value::new(RcStr::from(src).into())),\n                 IssueSource::from_line_col(\n                     ResolvedVc::upcast(self.source),\n@@ -150,8 +157,8 @@ impl Visitor<'_> for ModuleReferencesVisitor<'_> {\n             self.urls.push((u.url.to_string(), vc));\n         }\n \n+        // This node type has no children worth visiting.\n         // u.visit_children(self)?;\n-\n         Ok(())\n     }\n "
        },
        {
            "sha": "0e509a67f281cdb424c8c970e723c9d3f5a91292",
            "filename": "turbopack/crates/turbopack-dev-server/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Flib.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -173,6 +173,8 @@ impl DevServerBuilder {\n                             uri: request.uri().clone(),\n                         };\n                         run_once_with_reason(tt.clone(), reason, async move {\n+                            // TODO: `get_issue_reporter` should be an `OperationVc`, as there's a\n+                            // risk it could be a task-local Vc, which is not safe for us to await.\n                             let issue_reporter = get_issue_reporter();\n \n                             if hyper_tungstenite::is_upgrade_request(&request) {"
        },
        {
            "sha": "1f1f183db182cd296938c2d031266374b90509ea",
            "filename": "turbopack/crates/turbopack-ecmascript-plugins/src/transform/directives/client.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2Fsrc%2Ftransform%2Fdirectives%2Fclient.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a1068c5fe8c9ceee1c48bd82e614b6cab89219/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2Fsrc%2Ftransform%2Fdirectives%2Fclient.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2Fsrc%2Ftransform%2Fdirectives%2Fclient.rs?ref=56a1068c5fe8c9ceee1c48bd82e614b6cab89219",
            "patch": "@@ -2,18 +2,18 @@ use anyhow::Result;\n use async_trait::async_trait;\n use swc_core::ecma::{ast::Program, transforms::base::resolver, visit::VisitMutWith};\n use turbo_rcstr::RcStr;\n-use turbo_tasks::Vc;\n+use turbo_tasks::ResolvedVc;\n use turbopack_ecmascript::{CustomTransformer, TransformContext};\n \n use super::{is_client_module, server_to_client_proxy::create_proxy_module};\n \n #[derive(Debug)]\n pub struct ClientDirectiveTransformer {\n-    transition_name: Vc<RcStr>,\n+    transition_name: ResolvedVc<RcStr>,\n }\n \n impl ClientDirectiveTransformer {\n-    pub fn new(transition_name: Vc<RcStr>) -> Self {\n+    pub fn new(transition_name: ResolvedVc<RcStr>) -> Self {\n         Self { transition_name }\n     }\n }"
        }
    ],
    "stats": {
        "total": 194,
        "additions": 93,
        "deletions": 101
    }
}