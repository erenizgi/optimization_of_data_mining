{
    "author": "eps1lon",
    "message": "[test] Use new Redbox matchers in pages/ middleware-errors (#76797)",
    "sha": "639dbbd36f2eb6252706d6da91ea46e57de359c3",
    "files": [
        {
            "sha": "1fdbc3afd002626a6634c98a044fa8d6b0601295",
            "filename": "test/development/middleware-errors/index.test.ts",
            "status": "modified",
            "additions": 186,
            "deletions": 26,
            "changes": 212,
            "blob_url": "https://github.com/vercel/next.js/blob/639dbbd36f2eb6252706d6da91ea46e57de359c3/test%2Fdevelopment%2Fmiddleware-errors%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/639dbbd36f2eb6252706d6da91ea46e57de359c3/test%2Fdevelopment%2Fmiddleware-errors%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmiddleware-errors%2Findex.test.ts?ref=639dbbd36f2eb6252706d6da91ea46e57de359c3",
            "patch": "@@ -1,11 +1,4 @@\n-import {\n-  assertHasRedbox,\n-  assertNoRedbox,\n-  check,\n-  getRedboxDescription,\n-  getRedboxSource,\n-  retry,\n-} from 'next-test-utils'\n+import { assertNoRedbox, check, retry } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n import { nextTestSetup } from 'e2e-utils'\n \n@@ -57,8 +50,42 @@ describe('middleware - development errors', () => {\n \n     it('renders the error correctly and recovers', async () => {\n       const browser = await next.browser('/')\n-      await assertHasRedbox(browser)\n+\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: boom\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"middleware.js (3:15) @\n+         {default export}\n+         > 3 |         throw new Error('boom')\n+             |               ^\",\n+           \"stack\": [\n+             \"{default export} middleware.js (3:15)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: boom\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"middleware.js (3:15) @ default\n+         > 3 |         throw new Error('boom')\n+             |               ^\",\n+           \"stack\": [\n+             \"default middleware.js (3:15)\",\n+           ],\n+         }\n+        `)\n+      }\n+\n       await next.patchFile('middleware.js', `export default function () {}`)\n+\n       await assertNoRedbox(browser)\n     })\n   })\n@@ -173,11 +200,44 @@ describe('middleware - development errors', () => {\n \n     it('renders the error correctly and recovers', async () => {\n       const browser = await next.browser('/')\n-      await assertHasRedbox(browser)\n \n-      const lengthOfLogs = next.cliOutput.length\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: test is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"middleware.js (4:9) @ eval\n+         > 4 |         eval('test')\n+             |         ^\",\n+           \"stack\": [\n+             \"eval middleware.js (4:9)\",\n+             \"<unknown> middleware.js (4:9)\",\n+             \"{default export} middleware.js (3:22)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: test is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"middleware.js (4:9) @ eval\n+         > 4 |         eval('test')\n+             |         ^\",\n+           \"stack\": [\n+             \"<FIXME-file-protocol>\",\n+             \"eval middleware.js (4:9)\",\n+             \"default middleware.js (4:9)\",\n+           ],\n+         }\n+        `)\n+      }\n \n-      expect(await getRedboxSource(browser)).toContain(`eval('test')`)\n+      const lengthOfLogs = next.cliOutput.length\n       await next.patchFile('middleware.js', `export default function () {}`)\n \n       retry(() => {\n@@ -225,12 +285,50 @@ describe('middleware - development errors', () => {\n \n     it('renders the error correctly and recovers', async () => {\n       const browser = await next.browser('/')\n-      await assertHasRedbox(browser)\n-      const source = await getRedboxSource(browser)\n-      expect(source).toContain(`throw new Error('booooom!')`)\n-      expect(source).toContain('middleware.js')\n-      expect(source).not.toContain('//middleware.js')\n+\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: booooom!\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"middleware.js (3:13) @ [project]/middleware.js [middleware-edge] (ecmascript)\n+         > 3 |       throw new Error('booooom!')\n+             |             ^\",\n+           \"stack\": [\n+             \"[project]/middleware.js [middleware-edge] (ecmascript) middleware.js (3:13)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: booooom!\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"middleware.js (3:13) @ eval\n+         > 3 |       throw new Error('booooom!')\n+             |             ^\",\n+           \"stack\": [\n+             \"<unknown> middleware.js (3:0)\",\n+             \"eval middleware.js (3:13)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+           ],\n+         }\n+        `)\n+      }\n+\n       await next.patchFile('middleware.js', `export default function () {}`)\n+\n       await assertNoRedbox(browser)\n     })\n   })\n@@ -330,18 +428,43 @@ describe('middleware - development errors', () => {\n \n     it('renders the error correctly and recovers', async () => {\n       const browser = await next.browser('/')\n-      await assertHasRedbox(browser)\n-      const description = await getRedboxDescription(browser)\n+\n       if (isTurbopack) {\n-        expect(description).toMatchInlineSnapshot(\n-          `\"Parsing ecmascript source code failed\"`\n-        )\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Parsing ecmascript source code failed\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"./middleware.js (1:28)\n+         Parsing ecmascript source code failed\n+         > 1 | export default function () }\n+             |                            ^\",\n+           \"stack\": [],\n+         }\n+        `)\n       } else {\n-        expect(description).toMatchInlineSnapshot(\n-          `\"Error:   x Expected '{', got '}'\"`\n-        )\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error:   x Expected '{', got '}'\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"./middleware.js\n+         Error:   x Expected '{', got '}'\n+            ,----\n+          1 | export default function () }\n+            :                            ^\n+            \\`----\n+         Caused by:\n+             Syntax Error\",\n+           \"stack\": [],\n+         }\n+        `)\n       }\n+\n       await next.patchFile('middleware.js', `export default function () {}`)\n+\n       await assertNoRedbox(browser)\n       expect(await browser.elementByCss('#page-title')).toBeTruthy()\n     })\n@@ -369,10 +492,47 @@ describe('middleware - development errors', () => {\n \n     it('renders the error correctly and recovers', async () => {\n       const browser = await next.browser('/')\n+\n       await assertNoRedbox(browser)\n+\n       await next.patchFile('middleware.js', `export default function () }`)\n-      await assertHasRedbox(browser)\n+\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Parsing ecmascript source code failed\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"./middleware.js (1:28)\n+         Parsing ecmascript source code failed\n+         > 1 | export default function () }\n+             |                            ^\",\n+           \"stack\": [],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error:   x Expected '{', got '}'\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"./middleware.js\n+         Error:   x Expected '{', got '}'\n+            ,----\n+          1 | export default function () }\n+            :                            ^\n+            \\`----\n+         Caused by:\n+             Syntax Error\",\n+           \"stack\": [],\n+         }\n+        `)\n+      }\n+\n       await next.patchFile('middleware.js', `export default function () {}`)\n+\n       await assertNoRedbox(browser)\n       expect(await browser.elementByCss('#page-title')).toBeTruthy()\n     })"
        }
    ],
    "stats": {
        "total": 212,
        "additions": 186,
        "deletions": 26
    }
}