{
    "author": "unstubbable",
    "message": "Support `Uint8Array` bodies when generating cache keys for POST requests (#81465)\n\nWhen opting into caching a POST request with the `revalidate` option, or\nwhen the Server Components HMR Cache implicitly caches a POST request,\nthe body of the request is now correctly handled if it is a\n`Uint8Array`. Previously, we logged `Failed to generate cache key for\n...` and the cache was bypassed.\n\ncloses NAR-180",
    "sha": "4e51eb2140119bf29d953f30aadec578abf72076",
    "files": [
        {
            "sha": "28dd6e1105c11da7d4c29cab3a1fde494f53680a",
            "filename": "packages/next/src/server/lib/incremental-cache/index.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/4e51eb2140119bf29d953f30aadec578abf72076/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e51eb2140119bf29d953f30aadec578abf72076/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts?ref=4e51eb2140119bf29d953f30aadec578abf72076",
            "patch": "@@ -293,8 +293,12 @@ export class IncrementalCache implements IncrementalCacheType {\n     const decoder = new TextDecoder()\n \n     if (init.body) {\n-      // handle ReadableStream body\n-      if (typeof (init.body as any).getReader === 'function') {\n+      // handle Uint8Array body\n+      if (init.body instanceof Uint8Array) {\n+        bodyChunks.push(decoder.decode(init.body))\n+        ;(init as any)._ogBody = init.body\n+      } // handle ReadableStream body\n+      else if (typeof (init.body as any).getReader === 'function') {\n         const readableBody = init.body as ReadableStream<Uint8Array | string>\n \n         const chunks: Uint8Array[] = []"
        },
        {
            "sha": "e2f05fd40559361bd76c560576a72b45eb2ae332",
            "filename": "test/e2e/app-dir/app-static/app-static.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 27,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/4e51eb2140119bf29d953f30aadec578abf72076/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e51eb2140119bf29d953f30aadec578abf72076/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts?ref=4e51eb2140119bf29d953f30aadec578abf72076",
            "patch": "@@ -907,8 +907,6 @@ describe('app-dir static/dynamic handling', () => {\n          \"variable-revalidate/encoding.rsc\",\n          \"variable-revalidate/headers-instance.html\",\n          \"variable-revalidate/headers-instance.rsc\",\n-         \"variable-revalidate/post-method.html\",\n-         \"variable-revalidate/post-method.rsc\",\n          \"variable-revalidate/revalidate-3.html\",\n          \"variable-revalidate/revalidate-3.rsc\",\n          \"variable-revalidate/revalidate-360-isr.html\",\n@@ -2278,31 +2276,6 @@ describe('app-dir static/dynamic handling', () => {\n            \"initialRevalidateSeconds\": 10,\n            \"srcRoute\": \"/variable-revalidate/headers-instance\",\n          },\n-         \"/variable-revalidate/post-method\": {\n-           \"allowHeader\": [\n-             \"host\",\n-             \"x-matched-path\",\n-             \"x-prerender-revalidate\",\n-             \"x-prerender-revalidate-if-generated\",\n-             \"x-next-revalidated-tags\",\n-             \"x-next-revalidate-tag-token\",\n-           ],\n-           \"dataRoute\": \"/variable-revalidate/post-method.rsc\",\n-           \"experimentalBypassFor\": [\n-             {\n-               \"key\": \"Next-Action\",\n-               \"type\": \"header\",\n-             },\n-             {\n-               \"key\": \"content-type\",\n-               \"type\": \"header\",\n-               \"value\": \"multipart/form-data;.*\",\n-             },\n-           ],\n-           \"initialExpireSeconds\": 31536000,\n-           \"initialRevalidateSeconds\": 10,\n-           \"srcRoute\": \"/variable-revalidate/post-method\",\n-         },\n          \"/variable-revalidate/revalidate-3\": {\n            \"allowHeader\": [\n              \"host\",\n@@ -3451,10 +3424,12 @@ describe('app-dir static/dynamic handling', () => {\n       const dataBody2 = $('#data-body2').text()\n       const dataBody3 = $('#data-body3').text()\n       const dataBody4 = $('#data-body4').text()\n+      const dataBody5 = $('#data-body5').text()\n \n       expect(dataBody1).not.toBe(dataBody2)\n       expect(dataBody2).not.toBe(dataBody3)\n       expect(dataBody3).not.toBe(dataBody4)\n+      expect(dataBody4).not.toBe(dataBody5)\n \n       const res2 = await fetchViaHTTP(\n         next.url,\n@@ -3469,6 +3444,8 @@ describe('app-dir static/dynamic handling', () => {\n       expect($2('#data-body1').text()).toBe(dataBody1)\n       expect($2('#data-body2').text()).toBe(dataBody2)\n       expect($2('#data-body3').text()).toBe(dataBody3)\n+      expect($2('#data-body4').text()).toBe(dataBody4)\n+      expect($2('#data-body5').text()).toBe(dataBody5)\n       return 'success'\n     }, 'success')\n   })"
        },
        {
            "sha": "1f30863352b80dc7ba3623b32f0b1c77e64bee05",
            "filename": "test/e2e/app-dir/app-static/app/variable-revalidate/post-method/page.js",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/4e51eb2140119bf29d953f30aadec578abf72076/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fvariable-revalidate%2Fpost-method%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4e51eb2140119bf29d953f30aadec578abf72076/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fvariable-revalidate%2Fpost-method%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fvariable-revalidate%2Fpost-method%2Fpage.js?ref=4e51eb2140119bf29d953f30aadec578abf72076",
            "patch": "@@ -1,5 +1,7 @@\n import { fetchRetry } from '../../../lib/fetch-retry'\n \n+export const dynamic = 'force-dynamic'\n+\n export default async function Page() {\n   const data = await fetchRetry(\n     'https://next-data-api-endpoint.vercel.app/api/random',\n@@ -55,6 +57,20 @@ export default async function Page() {\n     {\n       method: 'POST',\n       body: new URLSearchParams('myParam=myValue&myParam=diffValue'),\n+      next: {\n+        revalidate: 30,\n+      },\n+    }\n+  ).then((res) => res.text())\n+\n+  const dataWithBody5 = await fetchRetry(\n+    'https://next-data-api-endpoint.vercel.app/api/random',\n+    {\n+      method: 'POST',\n+      body: new TextEncoder().encode(JSON.stringify({ hi: 'there' })),\n+      next: {\n+        revalidate: 30,\n+      },\n     }\n   ).then((res) => res.text())\n \n@@ -66,6 +82,7 @@ export default async function Page() {\n       <p id=\"data-body2\">{dataWithBody2}</p>\n       <p id=\"data-body3\">{dataWithBody3}</p>\n       <p id=\"data-body4\">{dataWithBody4}</p>\n+      <p id=\"data-body5\">{dataWithBody5}</p>\n     </>\n   )\n }"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 27,
        "deletions": 29
    }
}