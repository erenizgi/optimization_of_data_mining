{
    "author": "ztanner",
    "message": "[metadata]: ensure metadata boundary is only rendered once on client nav (#76692)\n\nOn client navigations, rendering does not start at the root, it starts\nat the common layout down. As a result the existing heuristic to only\nrender the `<StreamingMetadata />` component once won't work, as\n`children` will likely appear for parallel routes within the subtree.\n(In other words: `children` is only useful as a heuristic for root\nrenders).\n\nAs a result, metadata will get duplicated on client navigation if\nparallel routes match that page (this is because we iterate over all\nparallel routes, and conditionally render `<StreamingMetadata />` based\non the flawed heuristic above)\n\nSince the metadata tree is accumulated and only rendered once, ideally\nit should never be rendered in `createComponentTree`. Or if it is, we\nneed to ensure itâ€™s never rendered more than once, as it would contain\nthe same contents twice.\n\nThis PR:\n- On client navs, ensures that we only render `<StreamingMetadata />`\nonce as part of the `rscHead`, rather than per parallel route segment:\n[5e3686a](https://github.com/vercel/next.js/pull/76692/commits/5e3686ac55c0020ab843e8a2648f180ad9f33ca6)\n- On the client, we make sure to prioritize the `head` node\ncorresponding with the root page slot (\"children\"). Otherwise we might\nnot render `<StreamingMetadata />` at all, since the current heuristic\nwould have early-returned for a parallel route that _didn't_ change as\npart of the navigation (eg the case where a slot doesn't match, and\nkeeps rendering the previous node):\n[7364e6e](https://github.com/vercel/next.js/pull/76692/commits/7364e6e008dfb99b454267ff6a7b4a080a9f3d08)",
    "sha": "129368cfd88480f25aeded2df346dee0a8c430f8",
    "files": [
        {
            "sha": "db6f9eb66502d97f0c9d21f705b53580cbc0d551",
            "filename": "packages/next/src/client/components/router-reducer/reducers/find-head-in-cache.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/129368cfd88480f25aeded2df346dee0a8c430f8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/129368cfd88480f25aeded2df346dee0a8c430f8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts?ref=129368cfd88480f25aeded2df346dee0a8c430f8",
            "patch": "@@ -19,7 +19,30 @@ function findHeadInCacheImpl(\n     // Returns the entire Cache Node of the segment whose head we will render.\n     return [cache, keyPrefix]\n   }\n+\n+  // First try the 'children' parallel route if it exists\n+  // when starting from the \"root\", this corresponds with the main page component\n+  if (parallelRoutes.children) {\n+    const [segment, childParallelRoutes] = parallelRoutes.children\n+    const childSegmentMap = cache.parallelRoutes.get('children')\n+    if (childSegmentMap) {\n+      const cacheKey = createRouterCacheKey(segment)\n+      const cacheNode = childSegmentMap.get(cacheKey)\n+      if (cacheNode) {\n+        const item = findHeadInCacheImpl(\n+          cacheNode,\n+          childParallelRoutes,\n+          keyPrefix + '/' + cacheKey\n+        )\n+        if (item) return item\n+      }\n+    }\n+  }\n+\n+  // if we didn't find metadata in the page slot, check the other parallel routes\n   for (const key in parallelRoutes) {\n+    if (key === 'children') continue // already checked above\n+\n     const [segment, childParallelRoutes] = parallelRoutes[key]\n     const childSegmentMap = cache.parallelRoutes.get(key)\n     if (!childSegmentMap) {"
        },
        {
            "sha": "80d0fb22ceb3f8c6e216bf4b10b21320415f8eed",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/129368cfd88480f25aeded2df346dee0a8c430f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/129368cfd88480f25aeded2df346dee0a8c430f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=129368cfd88480f25aeded2df346dee0a8c430f8",
            "patch": "@@ -522,6 +522,7 @@ async function generateDynamicRSCPayload(\n             <NonIndex ctx={ctx} />\n             {/* Adding requestId as react key to make metadata remount for each render */}\n             <ViewportTree key={requestId} />\n+            {StreamingMetadata ? <StreamingMetadata /> : null}\n             <StaticMetadata />\n           </React.Fragment>\n         ),\n@@ -532,7 +533,6 @@ async function generateDynamicRSCPayload(\n         getViewportReady,\n         getMetadataReady,\n         preloadCallbacks,\n-        StreamingMetadata,\n         StreamingMetadataOutlet,\n       })\n     ).map((path) => path.slice(1)) // remove the '' (root) segment"
        },
        {
            "sha": "21300e96bf319b97db1b214f39d4e155f3ad4905",
            "filename": "packages/next/src/server/app-render/walk-tree-with-flight-router-state.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/129368cfd88480f25aeded2df346dee0a8c430f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/129368cfd88480f25aeded2df346dee0a8c430f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx?ref=129368cfd88480f25aeded2df346dee0a8c430f8",
            "patch": "@@ -40,7 +40,6 @@ export async function walkTreeWithFlightRouterState({\n   getMetadataReady,\n   ctx,\n   preloadCallbacks,\n-  StreamingMetadata,\n   StreamingMetadataOutlet,\n }: {\n   loaderTreeToFilter: LoaderTree\n@@ -56,8 +55,7 @@ export async function walkTreeWithFlightRouterState({\n   getViewportReady: () => Promise<void>\n   ctx: AppRenderContext\n   preloadCallbacks: PreloadCallbacks\n-  StreamingMetadata: React.ComponentType<{}> | null\n-  StreamingMetadataOutlet: React.ComponentType<{}>\n+  StreamingMetadataOutlet: React.ComponentType\n }): Promise<FlightDataPath[]> {\n   const {\n     renderOpts: { nextFontManifest, experimental },\n@@ -206,7 +204,7 @@ export async function walkTreeWithFlightRouterState({\n         getMetadataReady,\n         preloadCallbacks,\n         authInterrupts: experimental.authInterrupts,\n-        StreamingMetadata,\n+        StreamingMetadata: null,\n         StreamingMetadataOutlet,\n       }\n     )\n@@ -267,7 +265,6 @@ export async function walkTreeWithFlightRouterState({\n       getViewportReady,\n       getMetadataReady,\n       preloadCallbacks,\n-      StreamingMetadata,\n       StreamingMetadataOutlet,\n     })\n "
        },
        {
            "sha": "bff087a3a98f99941044142b6601e0ffd4150fe7",
            "filename": "test/e2e/app-dir/metadata-streaming/app/parallel-routes/@bar/test-page/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2F%40bar%2Ftest-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2F%40bar%2Ftest-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2F%40bar%2Ftest-page%2Fpage.tsx?ref=129368cfd88480f25aeded2df346dee0a8c430f8",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'test-page @bar'\n+}"
        },
        {
            "sha": "44ab40e2ddfce8edb4eacbe5002a952280294d72",
            "filename": "test/e2e/app-dir/metadata-streaming/app/parallel-routes/@foo/no-bar/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2F%40foo%2Fno-bar%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2F%40foo%2Fno-bar%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2F%40foo%2Fno-bar%2Fpage.tsx?ref=129368cfd88480f25aeded2df346dee0a8c430f8",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'no-bar @foo'\n+}"
        },
        {
            "sha": "8eff01dbe6deca778649eae4eacb6e07e14a0d3c",
            "filename": "test/e2e/app-dir/metadata-streaming/app/parallel-routes/@foo/test-page/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2F%40foo%2Ftest-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2F%40foo%2Ftest-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2F%40foo%2Ftest-page%2Fpage.tsx?ref=129368cfd88480f25aeded2df346dee0a8c430f8",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'test-page @foo'\n+}"
        },
        {
            "sha": "640e2e61603f7c8839555a6cadf2a9211ab7ba55",
            "filename": "test/e2e/app-dir/metadata-streaming/app/parallel-routes/no-bar/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2Fno-bar%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2Fno-bar%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2Fno-bar%2Fpage.tsx?ref=129368cfd88480f25aeded2df346dee0a8c430f8",
            "patch": "@@ -0,0 +1,13 @@\n+import { connection } from 'next/server'\n+\n+export default function TestPage() {\n+  return 'test page'\n+}\n+\n+export async function generateMetadata() {\n+  await connection()\n+  await new Promise((resolve) => setTimeout(resolve, 3000))\n+  return {\n+    title: `Dynamic api ${Math.random()}`,\n+  }\n+}"
        },
        {
            "sha": "5739a4c02e37b6fbf346ad34636e788a4183c554",
            "filename": "test/e2e/app-dir/metadata-streaming/app/parallel-routes/page.tsx",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2Fpage.tsx?ref=129368cfd88480f25aeded2df346dee0a8c430f8",
            "patch": "@@ -1,5 +1,15 @@\n+import Link from 'next/link'\n+\n export default function Page() {\n-  return <div>Hello from Nested</div>\n+  return (\n+    <div>\n+      Hello from Nested{' '}\n+      <Link href=\"/parallel-routes/test-page\">\n+        To /parallel-routes/test-page\n+      </Link>\n+      <Link href=\"/parallel-routes/no-bar\">To /parallel-routes/no-bar</Link>\n+    </div>\n+  )\n }\n \n export const metadata = {"
        },
        {
            "sha": "640e2e61603f7c8839555a6cadf2a9211ab7ba55",
            "filename": "test/e2e/app-dir/metadata-streaming/app/parallel-routes/test-page/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2Ftest-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2Ftest-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fparallel-routes%2Ftest-page%2Fpage.tsx?ref=129368cfd88480f25aeded2df346dee0a8c430f8",
            "patch": "@@ -0,0 +1,13 @@\n+import { connection } from 'next/server'\n+\n+export default function TestPage() {\n+  return 'test page'\n+}\n+\n+export async function generateMetadata() {\n+  await connection()\n+  await new Promise((resolve) => setTimeout(resolve, 3000))\n+  return {\n+    title: `Dynamic api ${Math.random()}`,\n+  }\n+}"
        },
        {
            "sha": "eae22f99affe4b2776fc1b9cd59c5880ada51bcf",
            "filename": "test/e2e/app-dir/metadata-streaming/metadata-streaming.test.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/129368cfd88480f25aeded2df346dee0a8c430f8/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming.test.ts?ref=129368cfd88480f25aeded2df346dee0a8c430f8",
            "patch": "@@ -88,14 +88,38 @@ describe('app-dir - metadata-streaming', () => {\n     expect((await browser.elementsByCss('body meta')).length).toBe(9)\n   })\n \n-  it('should only insert metadata once for parallel routes', async () => {\n+  it('should only insert metadata once for parallel routes when slots match', async () => {\n     const browser = await next.browser('/parallel-routes')\n \n     expect((await browser.elementsByCss('head title')).length).toBe(1)\n     expect((await browser.elementsByCss('body title')).length).toBe(0)\n \n     const $ = await next.render$('/parallel-routes')\n     expect($('title').length).toBe(1)\n+\n+    // validate behavior remains the same on client navigations\n+    await browser.elementByCss('[href=\"/parallel-routes/test-page\"]').click()\n+\n+    await retry(async () => {\n+      expect(await browser.elementByCss('title').text()).toContain(\n+        'Dynamic api'\n+      )\n+    })\n+\n+    expect((await browser.elementsByCss('title')).length).toBe(1)\n+  })\n+\n+  it('should only insert metadata once for parallel routes when there is a missing slot', async () => {\n+    const browser = await next.browser('/parallel-routes')\n+    await browser.elementByCss('[href=\"/parallel-routes/no-bar\"]').click()\n+\n+    await retry(async () => {\n+      expect(await browser.elementByCss('title').text()).toContain(\n+        'Dynamic api'\n+      )\n+    })\n+\n+    expect((await browser.elementsByCss('title')).length).toBe(1)\n   })\n \n   describe('dynamic api', () => {"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 97,
        "deletions": 8
    }
}