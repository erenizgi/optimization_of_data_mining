{
    "author": "sokra",
    "message": "Turbopack: fix test case and update project_update to turbo_tasks::run too (#83978)\n\n### What?\n\nChanging an env var that is used in an RSC doesn't lead to HMR updates. It only refetches the RSC stream and no compilation happens at all since the env var is consumed only at runtime.\n\nThis test did pass before as the `run_once` created a task for the `project_update` and we counted that as computation. Changing this to `turbo_tasks::run` removes the once task and no computation happens at all.",
    "sha": "5b5d9b14e993790d98aa4c3a43f90cb964355496",
    "files": [
        {
            "sha": "1bc2a9de6ba1f7eae95eace7bd4c1d5b85226ec5",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5b5d9b14e993790d98aa4c3a43f90cb964355496/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5b5d9b14e993790d98aa4c3a43f90cb964355496/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=5b5d9b14e993790d98aa4c3a43f90cb964355496",
            "patch": "@@ -455,13 +455,13 @@ pub fn project_new(\n \n         let options: ProjectOptions = options.into();\n         let container = turbo_tasks\n-            .run_once(async move {\n+            .run(async move {\n                 let project = ProjectContainer::new(rcstr!(\"next.js\"), options.dev);\n                 let project = project.to_resolved().await?;\n                 project.initialize(options).await?;\n                 Ok(project)\n             })\n-            .or_else(|e| turbopack_ctx.throw_turbopack_internal_result(&e))\n+            .or_else(|e| turbopack_ctx.throw_turbopack_internal_result(&e.into()))\n             .await?;\n \n         turbo_tasks.start_once_process({\n@@ -580,11 +580,11 @@ pub async fn project_update(\n     let options = options.into();\n     let container = project.container;\n     ctx.turbo_tasks()\n-        .run_once(async move {\n+        .run(async move {\n             container.update(options).await?;\n             Ok(())\n         })\n-        .or_else(|e| ctx.throw_turbopack_internal_result(&e))\n+        .or_else(|e| ctx.throw_turbopack_internal_result(&e.into()))\n         .await\n }\n "
        },
        {
            "sha": "47fd07e134d7ef323a89dcc2dbcacb0ab908f5e7",
            "filename": "test/development/app-hmr/hmr-env.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 23,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/5b5d9b14e993790d98aa4c3a43f90cb964355496/test%2Fdevelopment%2Fapp-hmr%2Fhmr-env.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b5d9b14e993790d98aa4c3a43f90cb964355496/test%2Fdevelopment%2Fapp-hmr%2Fhmr-env.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-hmr%2Fhmr-env.test.ts?ref=5b5d9b14e993790d98aa4c3a43f90cb964355496",
            "patch": "@@ -17,32 +17,9 @@ describe(`app-dir hmr-env`, () => {\n       expect(await browser.elementByCss('p').text()).toBe('mac')\n \n       await next.patchFile(envFile, 'MY_DEVICE=\"ipad\"', async () => {\n-        let logs\n-\n-        await retry(async () => {\n-          logs = await browser.log()\n-          expect(logs).toEqual(\n-            expect.arrayContaining([\n-              expect.objectContaining({\n-                message: expect.stringContaining('[Fast Refresh] done'),\n-                source: 'log',\n-              }),\n-            ])\n-          )\n-        })\n-\n         await retry(async () => {\n           expect(await browser.elementByCss('p').text()).toBe('ipad')\n         })\n-\n-        expect(logs).toEqual(\n-          expect.arrayContaining([\n-            expect.objectContaining({\n-              message: expect.stringContaining('[Fast Refresh] done in'),\n-              source: 'log',\n-            }),\n-          ])\n-        )\n       })\n \n       // ensure it's restored back to \"mac\" before the next test"
        },
        {
            "sha": "9c0c534c2332e2dce117287e611ad457a23a44d8",
            "filename": "test/development/app-hmr/hmr.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 20,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/5b5d9b14e993790d98aa4c3a43f90cb964355496/test%2Fdevelopment%2Fapp-hmr%2Fhmr.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b5d9b14e993790d98aa4c3a43f90cb964355496/test%2Fdevelopment%2Fapp-hmr%2Fhmr.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-hmr%2Fhmr.test.ts?ref=5b5d9b14e993790d98aa4c3a43f90cb964355496",
            "patch": "@@ -76,26 +76,8 @@ describe(`app-dir-hmr`, () => {\n           expect(await browser.elementByCss('p').text()).toBe('ipad')\n         }, 5000 /* ms */)\n \n-        expect(\n-          await browser.eval('window.__TEST_NO_RELOAD === undefined')\n-        ).toBe(false)\n-\n-        const logs = await browser.log()\n-        const fastRefreshLogs = logs.filter((log) => {\n-          return log.message.startsWith('[Fast Refresh]')\n-        })\n-\n-        // The exact ordering and number of these messages is implementation\n-        // dependent and subject to race conditions, just check that we have at\n-        // least one \"rebuilding\" and \"done in\" message in the logs, the exact\n-        // details are unimportant.\n-        expect(fastRefreshLogs).toEqual(\n-          expect.arrayContaining([\n-            {\n-              source: 'log',\n-              message: expect.stringContaining('[Fast Refresh] done in '),\n-            },\n-          ])\n+        expect(await browser.eval('window.__TEST_NO_RELOAD === true')).toBe(\n+          true\n         )\n       })\n "
        }
    ],
    "stats": {
        "total": 53,
        "additions": 6,
        "deletions": 47
    }
}