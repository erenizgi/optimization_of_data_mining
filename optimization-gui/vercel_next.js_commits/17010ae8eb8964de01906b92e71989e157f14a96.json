{
    "author": "eps1lon",
    "message": "[next-upgrade] Fall back to `npx` if `yarn dlx` is not available (#86384)",
    "sha": "17010ae8eb8964de01906b92e71989e157f14a96",
    "files": [
        {
            "sha": "1f364ce26743e3a826e90b4bb886ee5570282103",
            "filename": "packages/next-codemod/bin/upgrade.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 8,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/17010ae8eb8964de01906b92e71989e157f14a96/packages%2Fnext-codemod%2Fbin%2Fupgrade.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/17010ae8eb8964de01906b92e71989e157f14a96/packages%2Fnext-codemod%2Fbin%2Fupgrade.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Fbin%2Fupgrade.ts?ref=17010ae8eb8964de01906b92e71989e157f14a96",
            "patch": "@@ -203,7 +203,7 @@ export async function runUpgrade(\n \n   let shouldRunReactCodemods = false\n   let shouldRunReactTypesCodemods = false\n-  let execCommand = 'npx'\n+  let execCommand = 'npx --yes'\n   // The following React codemods are for React 19\n   if (\n     !shouldStayOnReact18 &&\n@@ -213,13 +213,7 @@ export async function runUpgrade(\n     shouldRunReactCodemods = await suggestReactCodemods()\n     shouldRunReactTypesCodemods = await suggestReactTypesCodemods()\n \n-    const execCommandMap = {\n-      yarn: 'yarn dlx',\n-      pnpm: 'pnpx',\n-      bun: 'bunx',\n-      npm: 'npx',\n-    }\n-    execCommand = execCommandMap[packageManager]\n+    execCommand = getNpxCommand(packageManager)\n   }\n \n   fs.writeFileSync(appPackageJsonPath, JSON.stringify(appPackageJson, null, 2))\n@@ -740,3 +734,19 @@ function warnDependenciesOutOfRange(\n     })\n   }\n }\n+\n+function getNpxCommand(pkgManager: PackageManager) {\n+  let command = 'npx --yes'\n+  if (pkgManager === 'pnpm') {\n+    command = 'pnpm --silent dlx'\n+  } else if (pkgManager === 'yarn') {\n+    try {\n+      execSync('yarn dlx --help', { stdio: 'ignore', cwd })\n+      command = 'yarn --quiet dlx'\n+    } catch {}\n+  } else if (pkgManager === 'bun') {\n+    command = 'bunx'\n+  }\n+\n+  return command\n+}"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 18,
        "deletions": 8
    }
}