{
    "author": "unstubbable",
    "message": "[CI] Fix GitHub Actions matrix configuration for React versions (#83677)\n\nThe `build-and-test` workflow runs on `canary` are currently annotated\nwith the following error\n([x-ref](https://github.com/vercel/next.js/actions/runs/17629372493)):\n\n```\nError when evaluating 'strategy' for job 'test-rspack-production'. .github/workflows/build_and_test.yml (Line: 412, Col: 13): Matrix exclude key 'react' does not match any key within the matrix\n```\n\nThis addresses the issue for `test-rspack-production`, and also fixes\ninconsistencies in other jobs regarding the handling of this matrix\ndimension.",
    "sha": "6b0559f0b81206cfda51c04dee338ffaf6f3f4ce",
    "files": [
        {
            "sha": "3ea9b7a89cc013a3a798754f0c1a1091369ca180",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 35,
            "deletions": 10,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/6b0559f0b81206cfda51c04dee338ffaf6f3f4ce/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/6b0559f0b81206cfda51c04dee338ffaf6f3f4ce/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=6b0559f0b81206cfda51c04dee338ffaf6f3f4ce",
            "patch": "@@ -269,9 +269,9 @@ jobs:\n         group: [1/6, 2/6, 3/6, 4/6, 5/6, 6/6]\n         # Empty value uses default\n         # TODO: Run with React 18.\n-        # Integration tests use the installed React version in next/package.json.include:\n+        # Integration tests use the installed React version in next/package.json.\n         # We can't easily switch like we do for e2e tests.\n-        # Skipping this dimensions until we can figure out a way to test multiple React versions.\n+        # Skipping this dimension until we can figure out a way to test multiple React versions.\n         react: ['']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n@@ -301,10 +301,6 @@ jobs:\n           - react: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'run-react-18-tests') && '18.3.1' }}\n         group: [1/7, 2/7, 3/7, 4/7, 5/7, 6/7, 7/7]\n         # Empty value uses default\n-        # TODO: Run with React 18.\n-        # Integration tests use the installed React version in next/package.json.include:\n-        # We can't easily switch like we do for e2e tests.\n-        # Skipping this dimensions until we can figure out a way to test multiple React versions.\n         react: ['', '18.3.1']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n@@ -328,18 +324,25 @@ jobs:\n       fail-fast: false\n       matrix:\n         group: [1/7, 2/7, 3/7, 4/7, 5/7, 6/7, 7/7]\n+        # Empty value uses default\n+        # TODO: Run with React 18.\n+        # Integration tests use the installed React version in next/package.json.\n+        # We can't easily switch like we do for e2e tests.\n+        # Skipping this dimension until we can figure out a way to test multiple React versions.\n+        react: ['']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: 20.9.0\n       afterBuild: |\n         export IS_TURBOPACK_TEST=1\n         export TURBOPACK_BUILD=1\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n         node run-tests.js \\\n           --timings \\\n           -g ${{ matrix.group }} \\\n           --type integration\n-      stepName: 'test-turbopack-production-integration-${{ matrix.group }}'\n+      stepName: 'test-turbopack-production-integration-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n \n   test-rspack-dev:\n@@ -349,12 +352,18 @@ jobs:\n     strategy:\n       fail-fast: false\n       matrix:\n+        exclude:\n+          # Excluding React 18 tests unless on `canary` branch until budget is approved.\n+          - react: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'run-react-18-tests') && '18.3.1' }}\n         group: [1/5, 2/5, 3/5, 4/5, 5/5]\n+        # Empty value uses default\n+        react: ['', '18.3.1']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       afterBuild: |\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/rspack-dev-tests-manifest.json\"\n         export NEXT_TEST_MODE=dev\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n         # rspack flags\n         export NEXT_RSPACK=1\n@@ -379,11 +388,18 @@ jobs:\n       fail-fast: false\n       matrix:\n         group: [1/6, 2/6, 3/6, 4/6, 5/6, 6/6]\n+        # Empty value uses default\n+        # TODO: Run with React 18.\n+        # Integration tests use the installed React version in next/package.json.\n+        # We can't easily switch like we do for e2e tests.\n+        # Skipping this dimension until we can figure out a way to test multiple React versions.\n+        react: ['']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: 20.9.0\n       afterBuild: |\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/rspack-dev-tests-manifest.json\"\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n         # rspack flags\n         export NEXT_RSPACK=1\n@@ -412,12 +428,14 @@ jobs:\n           - react: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'run-react-18-tests') && '18.3.1' }}\n         group: [1/7, 2/7, 3/7, 4/7, 5/7, 6/7, 7/7]\n         # Empty value uses default\n+        react: ['', '18.3.1']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: 20.9.0\n       afterBuild: |\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/rspack-build-tests-manifest.json\"\n         export NEXT_TEST_MODE=start\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n         # rspack flags\n         export NEXT_RSPACK=1\n@@ -439,11 +457,18 @@ jobs:\n       fail-fast: false\n       matrix:\n         group: [1/7, 2/7, 3/7, 4/7, 5/7, 6/7, 7/7]\n+        # Empty value uses default\n+        # TODO: Run with React 18.\n+        # Integration tests use the installed React version in next/package.json.\n+        # We can't easily switch like we do for e2e tests.\n+        # Skipping this dimension until we can figure out a way to test multiple React versions.\n+        react: ['']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: 20.9.0\n       afterBuild: |\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/rspack-build-tests-manifest.json\"\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n         # rspack flags\n         export NEXT_RSPACK=1\n@@ -457,7 +482,7 @@ jobs:\n           --timings \\\n           -g ${{ matrix.group }} \\\n           --type integration\n-      stepName: 'test-rspack-production-integration-${{ matrix.group }}'\n+      stepName: 'test-rspack-production-integration-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n \n   test-next-swc-wasm:\n@@ -813,9 +838,9 @@ jobs:\n           - 13/13\n         # Empty value uses default\n         # TODO: Run with React 18.\n-        # Integration tests use the installed React version in next/package.json.include:\n+        # Integration tests use the installed React version in next/package.json.\n         # We can't easily switch like we do for e2e tests.\n-        # Skipping this dimensions until we can figure out a way to test multiple React versions.\n+        # Skipping this dimension until we can figure out a way to test multiple React versions.\n         react: ['']\n     uses: ./.github/workflows/build_reusable.yml\n     with:"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 35,
        "deletions": 10
    }
}