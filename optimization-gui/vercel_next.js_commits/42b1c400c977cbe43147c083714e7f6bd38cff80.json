{
    "author": "timneutkens",
    "message": "Turbopack build: Fix type: module with output: standalone (#79292)\n\n## What?\n\nThis PR ensures we first clean the `.next/standalone` folder before\nwriting into it.\n\nCurrently the order is:\n\n1. Write package.json to `.next/standalone/package.json`\n1. Delete `.next/standalone`\n1. Check `.nft.json` files and write the files listed there to\n`.next/standalone`\n\nWhich in turn causes the package.json to not exist.\n\nSo why does this not fail with webpack? Well, what I found is that the\n`_app` `.nft.json` file somehow lists the project root `package.json`\neven though it does not use it. This means that after we delete\n`.next/standalone` the `package.json` will still end up in the eventual\ndirectory regardless.\n\nIt fails with Turbopack because Turbopack correctly does not include the\npackage.json (as it's not used) and then the `package.json` is missing\nat runtime, causing the `server.js` which uses ESM to fail (because the\ndetection for ESM is still valid regardless of deleting the folder).\n\n\nNew order is:\n\n1. Delete `.next/standalone`\n1. Write package.json to `.next/standalone/package.json`\n1. Check `.nft.json` files and write the files listed there to\n`.next/standalone`",
    "sha": "42b1c400c977cbe43147c083714e7f6bd38cff80",
    "files": [
        {
            "sha": "2759a9c7c83da83c0ba74466c0bb17470ea9bc51",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/42b1c400c977cbe43147c083714e7f6bd38cff80/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42b1c400c977cbe43147c083714e7f6bd38cff80/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=42b1c400c977cbe43147c083714e7f6bd38cff80",
            "patch": "@@ -1539,6 +1539,10 @@ export async function copyTracedFiles(\n   staticPages: Set<string>\n ) {\n   const outputPath = path.join(distDir, 'standalone')\n+\n+  // Clean up standalone directory first.\n+  await fs.rm(outputPath, { recursive: true, force: true })\n+\n   let moduleType = false\n   const nextConfig = {\n     ...serverConfig,\n@@ -1561,7 +1565,6 @@ export async function copyTracedFiles(\n     await fs.writeFile(packageJsonOutputPath, packageJsonContent)\n   } catch {}\n   const copiedFiles = new Set()\n-  await fs.rm(outputPath, { recursive: true, force: true })\n \n   async function handleTraceFiles(traceFilePath: string) {\n     const traceData = JSON.parse(await fs.readFile(traceFilePath, 'utf8')) as {"
        },
        {
            "sha": "e3d1457abb79612cbef791adfb67a6f116df8a88",
            "filename": "test/production/standalone-mode/type-module/index.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 26,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/42b1c400c977cbe43147c083714e7f6bd38cff80/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42b1c400c977cbe43147c083714e7f6bd38cff80/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Findex.test.ts?ref=42b1c400c977cbe43147c083714e7f6bd38cff80",
            "patch": "@@ -1,5 +1,4 @@\n-import { createNext } from 'e2e-utils'\n-import { NextInstance } from 'e2e-utils'\n+import { nextTestSetup } from 'e2e-utils'\n import { join } from 'path'\n import fs from 'fs-extra'\n import {\n@@ -10,38 +9,21 @@ import {\n } from 'next-test-utils'\n \n describe('type-module', () => {\n-  let next: NextInstance\n-\n-  beforeAll(async () => {\n-    next = await createNext({\n-      files: {\n-        'pages/index.js': `\n-          export default function Page() {\n-            return <p>hello world</p>\n-          }\n-        `,\n-        'next.config.mjs': `export default ${JSON.stringify({\n-          output: 'standalone',\n-        })}`,\n-      },\n-      packageJson: { type: 'module' },\n-    })\n-    await next.stop()\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    packageJson: {\n+      type: 'module',\n+    },\n   })\n \n-  afterAll(() => next.destroy())\n-\n   it('should work', async () => {\n+    await next.stop()\n     const standalonePath = join(next.testDir, '.next/standalone')\n-    const staticSrc = join(next.testDir, '.next/static')\n-\n-    const staticDest = join(standalonePath, '.next/static')\n-\n-    await fs.move(staticSrc, staticDest)\n \n     expect(fs.existsSync(join(standalonePath, 'package.json'))).toBe(true)\n \n     const serverFile = join(standalonePath, 'server.js')\n+\n     const appPort = await findPort()\n     const server = await initNextServerScript(\n       serverFile,"
        },
        {
            "sha": "882e246885356f39e2c3b229f08483153a1e9f6c",
            "filename": "test/production/standalone-mode/type-module/next.config.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/42b1c400c977cbe43147c083714e7f6bd38cff80/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/42b1c400c977cbe43147c083714e7f6bd38cff80/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Fnext.config.js?ref=42b1c400c977cbe43147c083714e7f6bd38cff80",
            "patch": "@@ -0,0 +1,3 @@\n+export default {\n+  output: 'standalone',\n+}"
        },
        {
            "sha": "3dbc1ca591c0557e35b6004aeba250e6a70b56e3",
            "filename": "test/production/standalone-mode/type-module/package.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/42b1c400c977cbe43147c083714e7f6bd38cff80/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/42b1c400c977cbe43147c083714e7f6bd38cff80/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Fpackage.json?ref=42b1c400c977cbe43147c083714e7f6bd38cff80",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"type\": \"module\"\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/production/standalone-mode/type-module/pages/index.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/42b1c400c977cbe43147c083714e7f6bd38cff80/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/42b1c400c977cbe43147c083714e7f6bd38cff80/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Fpages%2Findex.js?ref=42b1c400c977cbe43147c083714e7f6bd38cff80",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "c60fa408afde70f0b58977f07cd9824a437a4625",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/42b1c400c977cbe43147c083714e7f6bd38cff80/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/42b1c400c977cbe43147c083714e7f6bd38cff80/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=42b1c400c977cbe43147c083714e7f6bd38cff80",
            "patch": "@@ -19583,8 +19583,8 @@\n     \"runtimeError\": false\n   },\n   \"test/production/standalone-mode/type-module/index.test.ts\": {\n-    \"passed\": [],\n-    \"failed\": [\"type-module should work\"],\n+    \"passed\": [\"type-module should work\"],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 23,
        "deletions": 29
    }
}