{
    "author": "devjiwonchoi",
    "message": "fix: OTel root span should indicate error status on exceptions (#82212)\n\nFor cases when the root span's status returned 500, the span status\nreturned `OK`.\nThis results in inaccurate telemetry, as users may expect the span to\nindicate an error when a 500 occurs.\n\nFailed CI:\nhttps://github.com/vercel/next.js/actions/runs/16633984270/job/47070403977?pr=82212#step:34:427\n\nAlso, the OTel documentation states:\n\n> For HTTP status codes in the 5xx range, as well as any other code the\nclient failed to interpret, span status SHOULD be set to Error.\n\nx-ref:\nhttps://opentelemetry.io/docs/specs/semconv/http/http-spans/#status\n\nTherefore, set the root span to `Error` when the status is in the 5xx\nrange.\n\nIn addition, as the document states:\n\n> When instrumentation detects such errors it SHOULD set span status to\nError and SHOULD set the error.type attribute.\n\nAdded `error.type` attributes to places where sets `Error` span status.\n\nFixes NEXT-4668",
    "sha": "2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54",
    "files": [
        {
            "sha": "807eec7d325287551afc72ff3f9fe12bf3fbce3a",
            "filename": "packages/next/src/server/app-render/create-error-handler.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-error-handler.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-error-handler.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-error-handler.tsx?ref=2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54",
            "patch": "@@ -91,6 +91,7 @@ export function createFlightReactServerErrorHandler(\n     const span = getTracer().getActiveScopeSpan()\n     if (span) {\n       span.recordException(err)\n+      span.setAttribute('error.type', err.name)\n       span.setStatus({\n         code: SpanStatusCode.ERROR,\n         message: err.message,\n@@ -164,6 +165,7 @@ export function createHTMLReactServerErrorHandler(\n       const span = getTracer().getActiveScopeSpan()\n       if (span) {\n         span.recordException(err)\n+        span.setAttribute('error.type', err.name)\n         span.setStatus({\n           code: SpanStatusCode.ERROR,\n           message: err.message,\n@@ -244,6 +246,7 @@ export function createHTMLErrorHandler(\n       const span = getTracer().getActiveScopeSpan()\n       if (span) {\n         span.recordException(err)\n+        span.setAttribute('error.type', err.name)\n         span.setStatus({\n           code: SpanStatusCode.ERROR,\n           message: err.message,"
        },
        {
            "sha": "63b574a449e86bc8e7899709086796fe1c26e031",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54",
            "patch": "@@ -96,7 +96,12 @@ import { AppRouteRouteMatcherProvider } from './route-matcher-providers/app-rout\n import { PagesAPIRouteMatcherProvider } from './route-matcher-providers/pages-api-route-matcher-provider'\n import { PagesRouteMatcherProvider } from './route-matcher-providers/pages-route-matcher-provider'\n import { ServerManifestLoader } from './route-matcher-providers/helpers/manifest-loaders/server-manifest-loader'\n-import { getTracer, isBubbledError, SpanKind } from './lib/trace/tracer'\n+import {\n+  getTracer,\n+  isBubbledError,\n+  SpanKind,\n+  SpanStatusCode,\n+} from './lib/trace/tracer'\n import { BaseServerSpan } from './lib/trace/constants'\n import { I18NProvider } from './lib/i18n-provider'\n import { sendResponse } from './send-response'\n@@ -896,6 +901,16 @@ export default abstract class Server<\n               'next.rsc': isRSCRequest,\n             })\n \n+            if (res.statusCode && res.statusCode >= 500) {\n+              // For 5xx status codes: SHOULD be set to 'Error' span status.\n+              // x-ref: https://opentelemetry.io/docs/specs/semconv/http/http-spans/#status\n+              span.setStatus({\n+                code: SpanStatusCode.ERROR,\n+              })\n+              // For span status 'Error', SHOULD set 'error.type' attribute.\n+              span.setAttribute('error.type', res.statusCode.toString())\n+            }\n+\n             const rootSpanAttributes = tracer.getRootSpanAttributes()\n             // We were unable to get attributes, probably OTEL is not enabled\n             if (!rootSpanAttributes) return"
        },
        {
            "sha": "8304b1c2bdbcb1ca780078f44468753422124e02",
            "filename": "packages/next/src/server/lib/trace/tracer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ftrace%2Ftracer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ftrace%2Ftracer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ftrace%2Ftracer.ts?ref=2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54",
            "patch": "@@ -56,6 +56,7 @@ const closeSpanWithError = (span: Span, error?: Error) => {\n   } else {\n     if (error) {\n       span.recordException(error)\n+      span.setAttribute('error.type', error.name)\n     }\n     span.setStatus({ code: SpanStatusCode.ERROR, message: error?.message })\n   }"
        },
        {
            "sha": "b5aa96e8d61228f418dcdbb5e2c0fbc6f5bbc9b0",
            "filename": "test/e2e/opentelemetry/instrumentation/app/app/[param]/rsc-fetch/error/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fapp%2Fapp%2F%5Bparam%5D%2Frsc-fetch%2Ferror%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fapp%2Fapp%2F%5Bparam%5D%2Frsc-fetch%2Ferror%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fapp%2Fapp%2F%5Bparam%5D%2Frsc-fetch%2Ferror%2Fpage.tsx?ref=2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54",
            "patch": "@@ -0,0 +1,13 @@\n+export default async function Page({\n+  searchParams,\n+}: {\n+  searchParams: Promise<{ [key: string]: string | string[] | undefined }>\n+}) {\n+  const { status } = await searchParams\n+\n+  if (status === 'error') {\n+    throw new Error('Error from Server Component')\n+  }\n+\n+  return <p>Page</p>\n+}"
        },
        {
            "sha": "e891a3d3a18ff9b81fe613060cf5f1ec31423657",
            "filename": "test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts",
            "status": "modified",
            "additions": 130,
            "deletions": 0,
            "changes": 130,
            "blob_url": "https://github.com/vercel/next.js/blob/2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts?ref=2da86a46918dd20a2f496ba89d8c0fd9a2eb0a54",
            "patch": "@@ -529,6 +529,136 @@ describe('opentelemetry', () => {\n               },\n             ])\n           })\n+\n+          it('should handle error in RSC', async () => {\n+            await next.fetch(\n+              '/app/param/rsc-fetch/error?status=error',\n+              env.fetchInit\n+            )\n+\n+            await expectTrace(getCollector(), [\n+              {\n+                name: 'GET /app/[param]/rsc-fetch/error',\n+                attributes: {\n+                  'http.method': 'GET',\n+                  'http.route': '/app/[param]/rsc-fetch/error',\n+                  'http.status_code': 500,\n+                  'http.target': '/app/param/rsc-fetch/error?status=error',\n+                  'next.route': '/app/[param]/rsc-fetch/error',\n+                  'next.rsc': false,\n+                  'next.span_name': 'GET /app/[param]/rsc-fetch/error',\n+                  'next.span_type': 'BaseServer.handleRequest',\n+                  'error.type': '500',\n+                },\n+                kind: 1,\n+                status: { code: 2 },\n+                traceId: env.span.traceId,\n+                parentId: env.span.rootParentId,\n+                spans: [\n+                  {\n+                    name: 'render route (app) /app/[param]/rsc-fetch/error',\n+                    attributes: {\n+                      'next.route': '/app/[param]/rsc-fetch/error',\n+                      'next.span_name':\n+                        'render route (app) /app/[param]/rsc-fetch/error',\n+                      'next.span_type': 'AppRender.getBodyResult',\n+                    },\n+                    kind: 0,\n+                    status: { code: 2 },\n+                    spans: [\n+                      {\n+                        name: 'build component tree',\n+                        attributes: {\n+                          'next.span_name': 'build component tree',\n+                          'next.span_type':\n+                            'NextNodeServer.createComponentTree',\n+                        },\n+                        kind: 0,\n+                        status: { code: 0 },\n+                        spans: [\n+                          {\n+                            name: 'resolve segment modules',\n+                            attributes: {\n+                              'next.segment': '__PAGE__',\n+                              'next.span_name': 'resolve segment modules',\n+                              'next.span_type':\n+                                'NextNodeServer.getLayoutOrPageModule',\n+                            },\n+                            kind: 0,\n+                            status: { code: 0 },\n+                          },\n+                          {\n+                            name: 'resolve segment modules',\n+                            attributes: {\n+                              'next.segment': '[param]',\n+                              'next.span_name': 'resolve segment modules',\n+                              'next.span_type':\n+                                'NextNodeServer.getLayoutOrPageModule',\n+                            },\n+                            kind: 0,\n+                            status: { code: 0 },\n+                          },\n+                        ],\n+                      },\n+                      {\n+                        name: 'generateMetadata /app/[param]/layout',\n+                        attributes: {\n+                          'next.page': '/app/[param]/layout',\n+                          'next.span_name':\n+                            'generateMetadata /app/[param]/layout',\n+                          'next.span_type': 'ResolveMetadata.generateMetadata',\n+                        },\n+                        kind: 0,\n+                        status: { code: 0 },\n+                      },\n+                      {\n+                        name: 'generateMetadata /app/[param]/layout',\n+                        attributes: {\n+                          'next.page': '/app/[param]/layout',\n+                          'next.span_name':\n+                            'generateMetadata /app/[param]/layout',\n+                          'next.span_type': 'ResolveMetadata.generateMetadata',\n+                        },\n+                        kind: 0,\n+                        status: { code: 0 },\n+                      },\n+                      {\n+                        attributes: {\n+                          'next.clientComponentLoadCount': isNextDev ? 9 : 8,\n+                          'next.span_type':\n+                            'NextNodeServer.clientComponentLoading',\n+                        },\n+                        kind: 0,\n+                        name: 'NextNodeServer.clientComponentLoading',\n+                        status: {\n+                          code: 0,\n+                        },\n+                      },\n+                      {\n+                        name: 'start response',\n+                        attributes: {\n+                          'next.span_name': 'start response',\n+                          'next.span_type': 'NextNodeServer.startResponse',\n+                        },\n+                        kind: 0,\n+                        status: { code: 0 },\n+                      },\n+                    ],\n+                  },\n+                  {\n+                    name: 'resolve page components',\n+                    attributes: {\n+                      'next.route': '/app/[param]/rsc-fetch/error',\n+                      'next.span_name': 'resolve page components',\n+                      'next.span_type': 'NextNodeServer.findPageComponents',\n+                    },\n+                    kind: 0,\n+                    status: { code: 0 },\n+                  },\n+                ],\n+              },\n+            ])\n+          })\n         })\n \n         describe('pages', () => {"
        }
    ],
    "stats": {
        "total": 164,
        "additions": 163,
        "deletions": 1
    }
}