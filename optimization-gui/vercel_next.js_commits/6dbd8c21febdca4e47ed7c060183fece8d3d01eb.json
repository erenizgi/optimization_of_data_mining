{
    "author": "unstubbable",
    "message": "Make `revalidate*` work when followed by a redirect in a route handler (#77090)\n\nWhen a route handler calls `revalidateTag` or `revalidatePath`, we need\nto make sure that these revalidations are executed before returning with\nthe redirect response.\n\nNote: When deployed, we currently don't have a strong guarantee that the\nrevalidations are fully propagated before executing the redirect target\nroute â€“ as we do for redirecting server actions. This is because, for\nroute handlers, the redirect occurs client-side, which prevents us from\nusing the same technique as for server actions, which involves sending a\nrevalidate token as a request header. This token must not leak to the\nclient. However, eventually the revalidation will be propagated, and a\nrefresh should show fresh data.\n\nfixes #74757",
    "sha": "6dbd8c21febdca4e47ed7c060183fece8d3d01eb",
    "files": [
        {
            "sha": "81625c742aa5eff74df4ca32fa2976db72111e78",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 13,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/6dbd8c21febdca4e47ed7c060183fece8d3d01eb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6dbd8c21febdca4e47ed7c060183fece8d3d01eb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=6dbd8c21febdca4e47ed7c060183fece8d3d01eb",
            "patch": "@@ -322,6 +322,23 @@ export class AppRouteRouteModule extends RouteModule<\n         : undefined,\n     }\n \n+    const resolvePendingRevalidations = () => {\n+      context.renderOpts.pendingWaitUntil = Promise.all([\n+        workStore.incrementalCache?.revalidateTag(\n+          workStore.pendingRevalidatedTags || []\n+        ),\n+        ...Object.values(workStore.pendingRevalidates || {}),\n+        ...(workStore.pendingRevalidateWrites || []),\n+      ]).finally(() => {\n+        if (process.env.NEXT_PRIVATE_DEBUG_CACHE) {\n+          console.log(\n+            'pending revalidates promise finished for:',\n+            requestStore.url\n+          )\n+        }\n+      })\n+    }\n+\n     let prerenderStore: null | PrerenderStore = null\n \n     let res: unknown\n@@ -575,6 +592,8 @@ export class AppRouteRouteModule extends RouteModule<\n           appendMutableCookies(headers, requestStore.mutableCookies)\n         }\n \n+        resolvePendingRevalidations()\n+\n         // Return the redirect response.\n         return new Response(null, {\n           // If we're in an action, we want to use a 303 redirect as we don't\n@@ -602,19 +621,7 @@ export class AppRouteRouteModule extends RouteModule<\n \n     context.renderOpts.fetchMetrics = workStore.fetchMetrics\n \n-    context.renderOpts.pendingWaitUntil = Promise.all([\n-      workStore.incrementalCache?.revalidateTag(\n-        workStore.pendingRevalidatedTags || []\n-      ),\n-      ...Object.values(workStore.pendingRevalidates || {}),\n-    ]).finally(() => {\n-      if (process.env.NEXT_PRIVATE_DEBUG_CACHE) {\n-        console.log(\n-          'pending revalidates promise finished for:',\n-          requestStore.url\n-        )\n-      }\n-    })\n+    resolvePendingRevalidations()\n \n     if (prerenderStore) {\n       context.renderOpts.collectedTags = prerenderStore.tags?.join(',')"
        },
        {
            "sha": "3ca4e89352798e642a52b71a326f3dcdc3300cae",
            "filename": "test/e2e/app-dir/use-cache/app/api/revalidate-redirect/route.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/6dbd8c21febdca4e47ed7c060183fece8d3d01eb/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fapi%2Frevalidate-redirect%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6dbd8c21febdca4e47ed7c060183fece8d3d01eb/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fapi%2Frevalidate-redirect%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fapi%2Frevalidate-redirect%2Froute.ts?ref=6dbd8c21febdca4e47ed7c060183fece8d3d01eb",
            "patch": "@@ -0,0 +1,7 @@\n+import { revalidateTag } from 'next/cache'\n+import { redirect } from 'next/navigation'\n+\n+export async function GET() {\n+  revalidateTag('api')\n+  redirect('/api')\n+}"
        },
        {
            "sha": "c24d01ee2c06cc1ebc9f3ff0e7236484fe3585d3",
            "filename": "test/e2e/app-dir/use-cache/app/api/route.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/6dbd8c21febdca4e47ed7c060183fece8d3d01eb/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fapi%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6dbd8c21febdca4e47ed7c060183fece8d3d01eb/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fapi%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fapi%2Froute.ts?ref=6dbd8c21febdca4e47ed7c060183fece8d3d01eb",
            "patch": "@@ -1,15 +1,15 @@\n+import { unstable_cacheTag } from 'next/cache'\n+\n async function getCachedRandom() {\n   'use cache'\n+  unstable_cacheTag('api')\n+\n   return Math.random()\n }\n \n export async function GET() {\n   const rand1 = await getCachedRandom()\n   const rand2 = await getCachedRandom()\n \n-  const response = JSON.stringify({ rand1, rand2 })\n-\n-  return new Response(response, {\n-    headers: { 'content-type': 'application/json' },\n-  })\n+  return Response.json({ rand1, rand2 })\n }"
        },
        {
            "sha": "e2605d837262f31337df8e7d41ef6af4cdf0cdf8",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 5,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/6dbd8c21febdca4e47ed7c060183fece8d3d01eb/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6dbd8c21febdca4e47ed7c060183fece8d3d01eb/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=6dbd8c21febdca4e47ed7c060183fece8d3d01eb",
            "patch": "@@ -158,12 +158,47 @@ describe('use-cache', () => {\n     }\n   })\n \n-  it('should cache results in route handlers', async () => {\n-    const response = await next.fetch('/api')\n-    const { rand1, rand2 } = await response.json()\n+  // TODO: Enable for deploy tests when upstream changes have been rolled out.\n+  if (!isNextDeploy) {\n+    it('should cache results in route handlers', async () => {\n+      const response = await next.fetch('/api')\n+      const { rand1, rand2 } = await response.json()\n \n-    expect(rand1).toEqual(rand2)\n-  })\n+      expect(rand1).toEqual(rand2)\n+    })\n+\n+    it('should revalidate before redirecting in a route handlers', async () => {\n+      const initialValues = await next.fetch('/api').then((res) => res.json())\n+\n+      const values = await next\n+        .fetch('/api/revalidate-redirect')\n+        .then((res) => res.json())\n+\n+      if (isNextDeploy) {\n+        try {\n+          expect(values).not.toEqual(initialValues)\n+        } catch {\n+          // When deployed, we currently don't have a strong guarantee that the\n+          // revalidations are propagated fully (as we do for redirecting server\n+          // actions). This is because, for route handlers, the redirect occurs\n+          // client-side, which prevents us from using the same technique as for\n+          // server actions, which involves sending a revalidate token as a\n+          // request header. This token must not leak to the client. However,\n+          // eventually the revalidation will be propagated, and a refresh should\n+          // show fresh data.\n+          await retry(async () => {\n+            const refreshedValues = await next\n+              .fetch('/api')\n+              .then((res) => res.json())\n+\n+            expect(refreshedValues).not.toEqual(initialValues)\n+          })\n+        }\n+      } else {\n+        expect(values).not.toEqual(initialValues)\n+      }\n+    })\n+  }\n \n   it('should cache results for cached functions imported from client components', async () => {\n     const browser = await next.browser('/imported-from-client')"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 72,
        "deletions": 23
    }
}