{
    "author": "timneutkens",
    "message": "Tests: Mirror arguments and environment between `next.build()` and `next.start()` (#83393)\n\n## What?\n\nPreparation for swapping the special logic in `start()` to using\n`build()` directly.\n\nThe build() method now respects buildCommand and `NEXT_SKIP_ISOLATE`\nsettings that it previously ignored.",
    "sha": "f37f11ef307c1122b821e76537a030513e0d16ae",
    "files": [
        {
            "sha": "c5e84217ae9b0d1a6c7ef709d3ec73f188de97fa",
            "filename": "test/lib/next-modes/next-start.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 68,
            "changes": 118,
            "blob_url": "https://github.com/vercel/next.js/blob/f37f11ef307c1122b821e76537a030513e0d16ae/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f37f11ef307c1122b821e76537a030513e0d16ae/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-start.ts?ref=f37f11ef307c1122b821e76537a030513e0d16ae",
            "patch": "@@ -8,7 +8,6 @@ import stripAnsi from 'strip-ansi'\n export class NextStartInstance extends NextInstance {\n   private _buildId: string\n   private _cliOutput: string = ''\n-  private spawnOpts: import('child_process').SpawnOptions\n \n   public get buildId() {\n     return this._buildId\n@@ -44,36 +43,10 @@ export class NextStartInstance extends NextInstance {\n     }\n \n     this._cliOutput = ''\n-    this.spawnOpts = {\n-      cwd: this.testDir,\n-      stdio: ['ignore', 'pipe', 'pipe'],\n-      shell: false,\n-      env: {\n-        ...process.env,\n-        ...this.env,\n-        NODE_ENV: this.env.NODE_ENV || ('' as any),\n-        ...(this.forcedPort\n-          ? {\n-              PORT: this.forcedPort,\n-            }\n-          : {\n-              PORT: '0',\n-            }),\n-        __NEXT_TEST_MODE: 'e2e',\n-      },\n-    }\n+    const spawnOpts = this.getSpawnOpts()\n \n-    let buildArgs = ['pnpm', 'next', 'build']\n     let startArgs = ['pnpm', 'next', 'start']\n \n-    if (this.buildCommand) {\n-      buildArgs = this.buildCommand.split(' ')\n-    }\n-\n-    if (this.buildArgs) {\n-      buildArgs.push(...this.buildArgs)\n-    }\n-\n     if (this.startCommand) {\n       startArgs = this.startCommand.split(' ')\n     }\n@@ -84,23 +57,17 @@ export class NextStartInstance extends NextInstance {\n \n     if (process.env.NEXT_SKIP_ISOLATE) {\n       // without isolation yarn can't be used and pnpm must be used instead\n-      if (buildArgs[0] === 'yarn') {\n-        buildArgs[0] = 'pnpm'\n-      }\n       if (startArgs[0] === 'yarn') {\n         startArgs[0] = 'pnpm'\n       }\n     }\n \n     if (!options.skipBuild) {\n+      const buildArgs = this.getBuildArgs()\n       console.log('running', buildArgs.join(' '))\n       await new Promise<void>((resolve, reject) => {\n         try {\n-          this.childProcess = spawn(\n-            buildArgs[0],\n-            buildArgs.slice(1),\n-            this.spawnOpts\n-          )\n+          this.childProcess = spawn(buildArgs[0], buildArgs.slice(1), spawnOpts)\n           this.handleStdio(this.childProcess)\n           this.childProcess.on('exit', (code, signal) => {\n             this.childProcess = undefined\n@@ -135,11 +102,7 @@ export class NextStartInstance extends NextInstance {\n     console.log('running', startArgs.join(' '))\n     await new Promise<void>((resolve, reject) => {\n       try {\n-        this.childProcess = spawn(\n-          startArgs[0],\n-          startArgs.slice(1),\n-          this.spawnOpts\n-        )\n+        this.childProcess = spawn(startArgs[0], startArgs.slice(1), spawnOpts)\n         this.handleStdio(this.childProcess)\n \n         this.childProcess.on('close', (code, signal) => {\n@@ -184,50 +147,69 @@ export class NextStartInstance extends NextInstance {\n     })\n   }\n \n-  public async build(\n-    options: { env?: Record<string, string>; args?: string[] } = {}\n-  ) {\n-    this.spawnOpts = {\n+  private getBuildArgs(args?: string[]) {\n+    let buildArgs = ['pnpm', 'next', 'build']\n+\n+    if (this.buildCommand) {\n+      buildArgs = this.buildCommand.split(' ')\n+    }\n+\n+    if (this.buildArgs) {\n+      buildArgs.push(...this.buildArgs)\n+    }\n+\n+    if (args) {\n+      buildArgs.push(...args)\n+    }\n+\n+    if (process.env.NEXT_SKIP_ISOLATE) {\n+      // without isolation yarn can't be used and pnpm must be used instead\n+      if (buildArgs[0] === 'yarn') {\n+        buildArgs[0] = 'pnpm'\n+      }\n+    }\n+\n+    return buildArgs\n+  }\n+\n+  private getSpawnOpts(\n+    env?: Record<string, string>\n+  ): import('child_process').SpawnOptions {\n+    return {\n       cwd: this.testDir,\n       stdio: ['ignore', 'pipe', 'pipe'],\n       shell: false,\n       env: {\n         ...process.env,\n         ...this.env,\n-        ...options.env,\n-        NODE_ENV: '' as any,\n-        PORT: this.forcedPort || '0',\n+        ...env,\n+        NODE_ENV: this.env.NODE_ENV || ('' as any),\n+        PORT: this.forcedPort ?? '0',\n         __NEXT_TEST_MODE: 'e2e',\n       },\n     }\n+  }\n+\n+  public async build(\n+    options: { env?: Record<string, string>; args?: string[] } = {}\n+  ) {\n+    if (this.childProcess) {\n+      throw new Error(\n+        `can not run export while server is running, use next.stop() first`\n+      )\n+    }\n+\n     return new Promise<{\n       exitCode: NodeJS.Signals | number | null\n       cliOutput: string\n     }>((resolve) => {\n       const curOutput = this._cliOutput.length\n-      const buildArgs = ['pnpm', 'next', 'build']\n-\n-      if (this.buildArgs) {\n-        buildArgs.push(...this.buildArgs)\n-      }\n-\n-      if (options.args) {\n-        buildArgs.push(...options.args)\n-      }\n-\n-      if (this.childProcess) {\n-        throw new Error(\n-          `can not run export while server is running, use next.stop() first`\n-        )\n-      }\n+      const spawnOpts = this.getSpawnOpts(options.env)\n+      const buildArgs = this.getBuildArgs(options.args)\n \n       console.log('running', buildArgs.join(' '))\n \n-      this.childProcess = spawn(\n-        buildArgs[0],\n-        buildArgs.slice(1),\n-        this.spawnOpts\n-      )\n+      this.childProcess = spawn(buildArgs[0], buildArgs.slice(1), spawnOpts)\n       this.handleStdio(this.childProcess)\n \n       this.childProcess.on('exit', (code, signal) => {"
        }
    ],
    "stats": {
        "total": 118,
        "additions": 50,
        "deletions": 68
    }
}