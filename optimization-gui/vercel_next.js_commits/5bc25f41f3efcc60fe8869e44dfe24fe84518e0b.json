{
    "author": "sokra",
    "message": "Turbopack: add test case for persistent caching (#77030)\n\n### What?\n\nMake the test case cover more cases by testing for add and removal of pages, client components, multiple noop builds and multiple change cycles.",
    "sha": "5bc25f41f3efcc60fe8869e44dfe24fe84518e0b",
    "files": [
        {
            "sha": "aee056b7fa3d2247e2a1abc4f4e905f6a82b9829",
            "filename": "test/e2e/persistent-caching/app/client/page.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5bc25f41f3efcc60fe8869e44dfe24fe84518e0b/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5bc25f41f3efcc60fe8869e44dfe24fe84518e0b/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fclient%2Fpage.tsx?ref=5bc25f41f3efcc60fe8869e44dfe24fe84518e0b",
            "patch": "@@ -0,0 +1,10 @@\n+'use client'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>hello world</p>\n+      <main suppressHydrationWarning>Timestamp</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "89f9113e08cb223a76a38fe8f971620dc7583165",
            "filename": "test/e2e/persistent-caching/app/remove-me/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5bc25f41f3efcc60fe8869e44dfe24fe84518e0b/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fremove-me%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5bc25f41f3efcc60fe8869e44dfe24fe84518e0b/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fremove-me%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fremove-me%2Fpage.tsx?ref=5bc25f41f3efcc60fe8869e44dfe24fe84518e0b",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Page() {\n+  return (\n+    <>\n+      <p>hello world</p>\n+      <main suppressHydrationWarning>Timestamp</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "37bff84cc66ce5da8d18982b75df3e64a9fd46e2",
            "filename": "test/e2e/persistent-caching/persistent-caching.test.ts",
            "status": "modified",
            "additions": 114,
            "deletions": 46,
            "changes": 160,
            "blob_url": "https://github.com/vercel/next.js/blob/5bc25f41f3efcc60fe8869e44dfe24fe84518e0b/test%2Fe2e%2Fpersistent-caching%2Fpersistent-caching.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5bc25f41f3efcc60fe8869e44dfe24fe84518e0b/test%2Fe2e%2Fpersistent-caching%2Fpersistent-caching.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fpersistent-caching.test.ts?ref=5bc25f41f3efcc60fe8869e44dfe24fe84518e0b",
            "patch": "@@ -2,6 +2,7 @@ import { nextTestSetup } from 'e2e-utils'\n import { waitFor } from 'next-test-utils'\n \n describe('persistent-caching', () => {\n+  process.env.NEXT_DEPLOYMENT_ID = '' + Date.now()\n   const { skipped, next, isNextDev } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n@@ -26,18 +27,25 @@ describe('persistent-caching', () => {\n \n   async function start() {\n     if (!isNextDev) {\n-      await next.build()\n+      // TODO workaround for missing content hashing on output static files\n+      // Browser caching would break this test case, but we want to test persistent caching.\n+      process.env.NEXT_DEPLOYMENT_ID = '' + Date.now()\n     }\n     await next.start()\n   }\n \n   it('should persistent cache loaders', async () => {\n-    let appTimestamp, pagesTimestamp\n+    let appTimestamp, appClientTimestamp, pagesTimestamp\n     {\n       const browser = await next.browser('/')\n       appTimestamp = await browser.elementByCss('main').text()\n       await browser.close()\n     }\n+    {\n+      const browser = await next.browser('/client')\n+      appClientTimestamp = await browser.elementByCss('main').text()\n+      await browser.close()\n+    }\n     {\n       const browser = await next.browser('/pages')\n       pagesTimestamp = await browser.elementByCss('main').text()\n@@ -52,59 +60,119 @@ describe('persistent-caching', () => {\n       await browser.close()\n     }\n     {\n-      const browser = await next.browser('/pages')\n+      const browser = await next.browser('/client')\n       // TODO Persistent Caching for webpack dev server is broken\n-      expect(await browser.elementByCss('main').text()).toBe(pagesTimestamp)\n-      await browser.close()\n-    }\n-  })\n-\n-  it('should allow to change files while stopped', async () => {\n-    {\n-      const browser = await next.browser('/')\n-      expect(await browser.elementByCss('p').text()).toBe('hello world')\n+      expect(await browser.elementByCss('main').text()).toBe(appClientTimestamp)\n       await browser.close()\n     }\n     {\n       const browser = await next.browser('/pages')\n-      expect(await browser.elementByCss('p').text()).toBe('hello world')\n+      // TODO Persistent Caching for webpack dev server is broken\n+      expect(await browser.elementByCss('main').text()).toBe(pagesTimestamp)\n       await browser.close()\n     }\n+  })\n \n-    await stop()\n+  it.each([1, 2, 3])(\n+    'should allow to change files while stopped (run %d)',\n+    async (_i) => {\n+      async function checkInitial() {\n+        {\n+          const browser = await next.browser('/')\n+          expect(await browser.elementByCss('p').text()).toBe('hello world')\n+          await browser.close()\n+        }\n+        {\n+          const browser = await next.browser('/client')\n+          expect(await browser.elementByCss('p').text()).toBe('hello world')\n+          await browser.close()\n+        }\n+        {\n+          const browser = await next.browser('/pages')\n+          expect(await browser.elementByCss('p').text()).toBe('hello world')\n+          await browser.close()\n+        }\n+        {\n+          const browser = await next.browser('/remove-me')\n+          expect(await browser.elementByCss('p').text()).toBe('hello world')\n+          await browser.close()\n+        }\n+      }\n \n-    await next.patchFile(\n-      'pages/pages.tsx',\n-      (content) => {\n-        return content.replace('hello world', 'hello persistent caching')\n-      },\n-      async () => {\n-        await next.patchFile(\n-          'app/page.tsx',\n-          (content) => {\n-            return content.replace('hello world', 'hello persistent caching')\n-          },\n-          async () => {\n-            await start()\n-            {\n-              const browser = await next.browser('/')\n-              expect(await browser.elementByCss('p').text()).toBe(\n-                'hello persistent caching'\n-              )\n-              await browser.close()\n-            }\n-            {\n-              const browser = await next.browser('/pages')\n-              expect(await browser.elementByCss('p').text()).toBe(\n-                'hello persistent caching'\n+      await checkInitial()\n+\n+      await stop()\n+\n+      async function checkChanges() {\n+        {\n+          const browser = await next.browser('/')\n+          expect(await browser.elementByCss('p').text()).toBe(\n+            'hello persistent caching'\n+          )\n+          await browser.close()\n+        }\n+        {\n+          const browser = await next.browser('/client')\n+          expect(await browser.elementByCss('p').text()).toBe(\n+            'hello persistent caching'\n+          )\n+          await browser.close()\n+        }\n+        {\n+          const browser = await next.browser('/pages')\n+          expect(await browser.elementByCss('p').text()).toBe(\n+            'hello persistent caching'\n+          )\n+          await browser.close()\n+        }\n+        {\n+          const browser = await next.browser('/add-me')\n+          expect(await browser.elementByCss('p').text()).toBe('hello world')\n+          await browser.close()\n+        }\n+      }\n+\n+      await next.patchFile(\n+        'pages/pages.tsx',\n+        (content) => {\n+          return content.replace('hello world', 'hello persistent caching')\n+        },\n+        async () => {\n+          await next.patchFile(\n+            'app/page.tsx',\n+            (content) => {\n+              return content.replace('hello world', 'hello persistent caching')\n+            },\n+            async () => {\n+              await next.patchFile(\n+                'app/client/page.tsx',\n+                (content) => {\n+                  return content.replace(\n+                    'hello world',\n+                    'hello persistent caching'\n+                  )\n+                },\n+                async () => {\n+                  await next.renameFolder('app/remove-me', 'app/add-me')\n+                  try {\n+                    await start()\n+                    await checkChanges()\n+                    // Some no-op change builds\n+                    for (let i = 0; i < 2; i++) {\n+                      await restartCycle()\n+                      await checkChanges()\n+                    }\n+                    await stop()\n+                  } finally {\n+                    await next.renameFolder('app/add-me', 'app/remove-me')\n+                  }\n+                }\n               )\n-              await browser.close()\n             }\n-            await stop()\n-          }\n-        )\n-      }\n-    )\n-    await start()\n-  })\n+          )\n+        }\n+      )\n+      await start()\n+    }\n+  )\n })"
        }
    ],
    "stats": {
        "total": 178,
        "additions": 132,
        "deletions": 46
    }
}