{
    "author": "wyattjoh",
    "message": "fix: strip _NEXTSEP_ from interpolated pathnames (#84430)\n\n## What\n\nFixes an issue where internal route normalization markers (`_NEXTSEP_`)\nwere leaking into compiled URLs for interception routes with adjacent\ndynamic parameters.\n\n## Why\n\nWhen Next.js normalizes route patterns like `/photos/(.):author/:id` for\npath-to-regexp validation, it inserts `_NEXTSEP_` as a literal separator\nbetween adjacent parameters. This internal marker was appearing in the\nfinal compiled URLs (e.g., `/photos/(.)_NEXTSEP_next/123` instead of\n`/photos/(.)next/123`), exposing implementation details to users.\n\n## How\n\n- Modified `safeCompile` to wrap the path-to-regexp compiler when\nnormalization is applied\n- The wrapper calls `stripNormalizedSeparators` to remove the internal\nmarker from compiled output\n- Added targeted regex pattern that only strips separators after\ninterception route markers (`)_NEXTSEP_` â†’ `)`)\n- Preserved separators in user content that legitimately contains this\nstring\n\nNAR-431",
    "sha": "6ec80654fd96adea8f63d8d705683ad35570228f",
    "files": [
        {
            "sha": "0460e3b0f7ae9718a3dcbc4b3058d0739bf5110d",
            "filename": "packages/next/src/lib/route-pattern-normalizer.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/6ec80654fd96adea8f63d8d705683ad35570228f/packages%2Fnext%2Fsrc%2Flib%2Froute-pattern-normalizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6ec80654fd96adea8f63d8d705683ad35570228f/packages%2Fnext%2Fsrc%2Flib%2Froute-pattern-normalizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Froute-pattern-normalizer.ts?ref=6ec80654fd96adea8f63d8d705683ad35570228f",
            "patch": "@@ -14,7 +14,7 @@ import type { Token } from 'next/dist/compiled/path-to-regexp'\n  * This unique marker is inserted between adjacent parameters and stripped out\n  * during parameter extraction to avoid conflicts with real URL content.\n  */\n-const PARAM_SEPARATOR = '_NEXTSEP_'\n+export const PARAM_SEPARATOR = '_NEXTSEP_'\n \n /**\n  * Detects if a route pattern needs normalization for path-to-regexp compatibility.\n@@ -97,6 +97,24 @@ export function normalizeTokensForRegexp(tokens: Token[]): Token[] {\n   })\n }\n \n+/**\n+ * Strips normalization separators from compiled pathname.\n+ * This removes separators that were inserted by normalizeAdjacentParameters\n+ * to satisfy path-to-regexp validation.\n+ *\n+ * Only removes separators in the specific contexts where they were inserted:\n+ * - After interception route markers: (.)_NEXTSEP_ -> (.)\n+ *\n+ * This targeted approach ensures we don't accidentally remove the separator\n+ * from legitimate user content.\n+ */\n+export function stripNormalizedSeparators(pathname: string): string {\n+  // Remove separator after interception route markers\n+  // Pattern: (.)_NEXTSEP_ -> (.), (..)_NEXTSEP_ -> (..), etc.\n+  // The separator appears after the closing paren of interception markers\n+  return pathname.replace(new RegExp(`\\\\)${PARAM_SEPARATOR}`, 'g'), ')')\n+}\n+\n /**\n  * Strips normalization separators from extracted route parameters.\n  * Used by both server and client code to clean up parameters after route matching."
        },
        {
            "sha": "daa1fc7a3ee490df6eda04e95afb6bd717976ba4",
            "filename": "packages/next/src/shared/lib/router/utils/route-match-utils.test.ts",
            "status": "added",
            "additions": 188,
            "deletions": 0,
            "changes": 188,
            "blob_url": "https://github.com/vercel/next.js/blob/6ec80654fd96adea8f63d8d705683ad35570228f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Froute-match-utils.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6ec80654fd96adea8f63d8d705683ad35570228f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Froute-match-utils.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Froute-match-utils.test.ts?ref=6ec80654fd96adea8f63d8d705683ad35570228f",
            "patch": "@@ -0,0 +1,188 @@\n+import { safeCompile } from './route-match-utils'\n+import {\n+  PARAM_SEPARATOR,\n+  stripNormalizedSeparators,\n+} from '../../../../lib/route-pattern-normalizer'\n+\n+describe('safeCompile', () => {\n+  describe('interception route patterns', () => {\n+    it('should strip _NEXTSEP_ from compiled output for (.) interception marker', () => {\n+      // Pattern with interception marker followed by parameter\n+      const pattern = '/photos/(.):author/:id'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      // The interception marker (.) is treated as an unnamed parameter (index 0)\n+      const result = compile({ '0': '(.)', author: 'next', id: '123' })\n+\n+      // Should NOT contain the internal separator\n+      expect(result).toBe('/photos/(.)next/123')\n+    })\n+\n+    it('should strip _NEXTSEP_ from compiled output for (..) interception marker', () => {\n+      const pattern = '/photos/(..):category/:id'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      const result = compile({ '0': '(..)', category: 'blog', id: '456' })\n+\n+      expect(result).toBe('/photos/(..)blog/456')\n+    })\n+\n+    it('should strip _NEXTSEP_ from compiled output for (...) interception marker', () => {\n+      const pattern = '/photos/(...):path'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      const result = compile({ '0': '(...)', path: 'deep/nested/route' })\n+\n+      expect(result).toBe('/photos/(...)deep/nested/route')\n+    })\n+\n+    it('should strip _NEXTSEP_ from compiled output for (..)(..) interception marker', () => {\n+      const pattern = '/photos/(.)(..)/:id'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      // (..)(..) is treated as two unnamed parameters\n+      const result = compile({ '0': '(..)', '1': '(..)', id: '789' })\n+\n+      expect(result).toBe('/photos/(..)(..)/789')\n+    })\n+\n+    it('should handle multiple interception markers in one pattern', () => {\n+      const pattern = '/(.):author/photos/(.):id'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      // Multiple markers are numbered sequentially\n+      const result = compile({\n+        '0': '(.)',\n+        author: 'john',\n+        '1': '(.)',\n+        id: '999',\n+      })\n+\n+      expect(result).toBe('/(.)john/photos/(.)999')\n+    })\n+\n+    it('should work with the actual failing case from interception routes', () => {\n+      // This is the exact pattern that was failing\n+      const pattern =\n+        '/intercepting-routes-dynamic/photos/(.):nxtPauthor/:nxtPid'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      const result = compile({\n+        '0': '(.)',\n+        nxtPauthor: 'next',\n+        nxtPid: '123',\n+      })\n+\n+      expect(result).toBe('/intercepting-routes-dynamic/photos/(.)next/123')\n+    })\n+  })\n+\n+  describe('patterns without normalization needs', () => {\n+    it('should work normally for patterns without adjacent parameters', () => {\n+      const pattern = '/photos/:author/:id'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      const result = compile({ author: 'jane', id: '456' })\n+\n+      expect(result).toBe('/photos/jane/456')\n+    })\n+\n+    it('should work with optional parameters', () => {\n+      const pattern = '/photos/:author?/:id'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      const result = compile({ id: '789' })\n+\n+      expect(result).toBe('/photos/789')\n+    })\n+\n+    it('should work with catchall parameters', () => {\n+      const pattern = '/files/:path*'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      const result = compile({ path: ['folder', 'subfolder', 'file.txt'] })\n+\n+      expect(result).toBe('/files/folder/subfolder/file.txt')\n+    })\n+  })\n+\n+  describe('edge cases', () => {\n+    it('should handle patterns with path separators between parameters', () => {\n+      // Normal case - parameters separated by path segments\n+      const pattern = '/:param1/separator/:param2'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      const result = compile({ param1: 'value1', param2: 'value2' })\n+\n+      expect(result).toBe('/value1/separator/value2')\n+    })\n+\n+    it('should not strip _NEXTSEP_ from user content outside interception markers', () => {\n+      // If user content happens to contain _NEXTSEP_, it should be preserved\n+      // Only separators after interception markers should be stripped\n+      const pattern = '/:folder/:file'\n+      const compile = safeCompile(pattern, { validate: false })\n+\n+      // User has a file or folder named something_NEXTSEP_something\n+      const result = compile({\n+        folder: 'my_NEXTSEP_folder',\n+        file: 'my_NEXTSEP_file.txt',\n+      })\n+\n+      // The _NEXTSEP_ in user content should be preserved\n+      expect(result).toBe('/my_NEXTSEP_folder/my_NEXTSEP_file.txt')\n+    })\n+  })\n+})\n+\n+describe('stripNormalizedSeparators', () => {\n+  it('should strip _NEXTSEP_ after single dot interception marker', () => {\n+    const input = `/photos/(.)${PARAM_SEPARATOR}next/123`\n+    const result = stripNormalizedSeparators(input)\n+    expect(result).toBe('/photos/(.)next/123')\n+  })\n+\n+  it('should strip _NEXTSEP_ after double dot interception marker', () => {\n+    const input = `/photos/(..)${PARAM_SEPARATOR}blog/456`\n+    const result = stripNormalizedSeparators(input)\n+    expect(result).toBe('/photos/(..)blog/456')\n+  })\n+\n+  it('should strip _NEXTSEP_ after triple dot interception marker', () => {\n+    const input = `/photos/(...)${PARAM_SEPARATOR}deep/nested/route`\n+    const result = stripNormalizedSeparators(input)\n+    expect(result).toBe('/photos/(...)deep/nested/route')\n+  })\n+\n+  it('should strip _NEXTSEP_ for adjacent interception markers with parameters', () => {\n+    // When there are two separate interception paths, each with parameters\n+    // Pattern: /(.)_NEXTSEP_:param1/(..)_NEXTSEP_:param2\n+    // After compilation: /(.)_NEXTSEP_value1/(..)_NEXTSEP_value2\n+    const input = `/(.)${PARAM_SEPARATOR}first/(..)${PARAM_SEPARATOR}second`\n+    const result = stripNormalizedSeparators(input)\n+    expect(result).toBe('/(.)first/(..)second')\n+  })\n+\n+  it('should handle multiple interception markers in one path', () => {\n+    const input = `/(.)${PARAM_SEPARATOR}john/photos/(.)${PARAM_SEPARATOR}999`\n+    const result = stripNormalizedSeparators(input)\n+    expect(result).toBe('/(.)john/photos/(.)999')\n+  })\n+\n+  it('should NOT strip _NEXTSEP_ from user content', () => {\n+    // If the separator appears outside the interception marker context,\n+    // it should be preserved as it's part of user content\n+    const input = `/folder/my${PARAM_SEPARATOR}file/data${PARAM_SEPARATOR}value`\n+    const result = stripNormalizedSeparators(input)\n+    expect(result).toBe(\n+      `/folder/my${PARAM_SEPARATOR}file/data${PARAM_SEPARATOR}value`\n+    )\n+  })\n+\n+  it('should only strip after closing paren, not before', () => {\n+    const input = `/path${PARAM_SEPARATOR}(.)${PARAM_SEPARATOR}value`\n+    const result = stripNormalizedSeparators(input)\n+    // Should only strip the one after ), not the one before\n+    expect(result).toBe(`/path${PARAM_SEPARATOR}(.)value`)\n+  })\n+})"
        },
        {
            "sha": "ed67bd5ff1de2ce1b843b25174bd0f3cb2bff855",
            "filename": "packages/next/src/shared/lib/router/utils/route-match-utils.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/6ec80654fd96adea8f63d8d705683ad35570228f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Froute-match-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6ec80654fd96adea8f63d8d705683ad35570228f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Froute-match-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Froute-match-utils.ts?ref=6ec80654fd96adea8f63d8d705683ad35570228f",
            "patch": "@@ -18,6 +18,7 @@ import {\n   hasAdjacentParameterIssues,\n   normalizeAdjacentParameters,\n   stripParameterSeparators,\n+  stripNormalizedSeparators,\n } from '../../../../lib/route-pattern-normalizer'\n \n /**\n@@ -59,6 +60,8 @@ export function safePathToRegexp(\n /**\n  * Client-safe wrapper around compile that handles path-to-regexp 6.3.0+ validation errors.\n  * No server-side error reporting to avoid bundling issues.\n+ * When normalization is applied, the returned compiler function automatically strips\n+ * the internal separator from the output URL.\n  */\n export function safeCompile(\n   route: string,\n@@ -71,13 +74,29 @@ export function safeCompile(\n     : route\n \n   try {\n-    return compile(routeToUse, options)\n+    const compiler = compile(routeToUse, options)\n+\n+    // If we normalized the route, wrap the compiler to strip separators from output\n+    // The normalization inserts _NEXTSEP_ as a literal string in the pattern to satisfy\n+    // path-to-regexp validation, but we don't want it in the final compiled URL\n+    if (needsNormalization) {\n+      return (params: any) => {\n+        return stripNormalizedSeparators(compiler(params))\n+      }\n+    }\n+\n+    return compiler\n   } catch (error) {\n     // Only try normalization if we haven't already normalized\n     if (!needsNormalization) {\n       try {\n         const normalizedRoute = normalizeAdjacentParameters(route)\n-        return compile(normalizedRoute, options)\n+        const compiler = compile(normalizedRoute, options)\n+\n+        // Wrap the compiler to strip separators from output\n+        return (params: any) => {\n+          return stripNormalizedSeparators(compiler(params))\n+        }\n       } catch (retryError) {\n         // If that doesn't work, fall back to original error\n         throw error"
        }
    ],
    "stats": {
        "total": 231,
        "additions": 228,
        "deletions": 3
    }
}