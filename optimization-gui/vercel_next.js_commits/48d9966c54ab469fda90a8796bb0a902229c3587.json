{
    "author": "gaojude",
    "message": "next mcp router",
    "sha": "48d9966c54ab469fda90a8796bb0a902229c3587",
    "files": [
        {
            "sha": "01d9b636b21e0ccc2c7fc8999b09d0844edced95",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/48d9966c54ab469fda90a8796bb0a902229c3587/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/48d9966c54ab469fda90a8796bb0a902229c3587/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=48d9966c54ab469fda90a8796bb0a902229c3587",
            "patch": "@@ -438,6 +438,15 @@ program\n   )\n   .usage('[directory] [options]')\n \n+program\n+  .command('mcp')\n+  .description(\n+    'Starts an MCP server using stdio transport. Manages sessions for all Next.js dev servers on this machine.'\n+  )\n+  .action(() => {\n+    import('../cli/next-mcp-stdio.js')\n+  })\n+\n const internal = program\n   .command('internal')\n   .description("
        },
        {
            "sha": "4ad77d8aee26b664b02a8e761948b22c65dd646e",
            "filename": "packages/next/src/cli/next-mcp-stdio.ts",
            "status": "added",
            "additions": 495,
            "deletions": 0,
            "changes": 495,
            "blob_url": "https://github.com/vercel/next.js/blob/48d9966c54ab469fda90a8796bb0a902229c3587/packages%2Fnext%2Fsrc%2Fcli%2Fnext-mcp-stdio.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/48d9966c54ab469fda90a8796bb0a902229c3587/packages%2Fnext%2Fsrc%2Fcli%2Fnext-mcp-stdio.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-mcp-stdio.ts?ref=48d9966c54ab469fda90a8796bb0a902229c3587",
            "patch": "@@ -0,0 +1,495 @@\n+#!/usr/bin/env node\n+\n+import { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n+import { StdioServerTransport } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/stdio'\n+import { z } from 'next/dist/compiled/zod'\n+import fs from 'fs'\n+import path from 'path'\n+import os from 'os'\n+\n+const DEV_SERVER_REGISTRY_PATH = path.join(os.tmpdir(), 'next-dev-servers.json')\n+\n+const HEARTBEAT_TIMEOUT_MS = 60000\n+const REGISTRY_POLL_INTERVAL_MS = 2000\n+\n+interface DevServerInfo {\n+  port: number\n+  hostname: string\n+  pid: number\n+  projectPath: string\n+  lastSeen: number\n+}\n+\n+interface DevServerRegistry {\n+  [projectPath: string]: DevServerInfo\n+}\n+\n+let devServerRegistry: DevServerRegistry = {}\n+let registryWatcher: fs.FSWatcher | null = null\n+let cleanupRegistryInterval: NodeJS.Timeout | null = null\n+\n+function isProcessAlive(pid: number): boolean {\n+  try {\n+    process.kill(pid, 0)\n+    return true\n+  } catch (error) {\n+    return false\n+  }\n+}\n+\n+function loadDevServerRegistry(): DevServerRegistry {\n+  try {\n+    if (!fs.existsSync(DEV_SERVER_REGISTRY_PATH)) {\n+      return {}\n+    }\n+\n+    const content = fs.readFileSync(DEV_SERVER_REGISTRY_PATH, 'utf-8')\n+    if (!content.trim()) {\n+      return {}\n+    }\n+\n+    const registry = JSON.parse(content) as DevServerRegistry\n+    const now = Date.now()\n+    const cleanedRegistry: DevServerRegistry = {}\n+\n+    for (const [projectPath, info] of Object.entries(registry)) {\n+      if (\n+        typeof info.port !== 'number' ||\n+        typeof info.hostname !== 'string' ||\n+        typeof info.pid !== 'number' ||\n+        typeof info.projectPath !== 'string' ||\n+        typeof info.lastSeen !== 'number'\n+      ) {\n+        console.error(\n+          `[MCP] Invalid registry entry for ${projectPath}, skipping`\n+        )\n+        continue\n+      }\n+\n+      if (now - info.lastSeen > HEARTBEAT_TIMEOUT_MS) {\n+        console.error(\n+          `[MCP] Dev server at ${projectPath} is stale (last seen ${Math.round((now - info.lastSeen) / 1000)}s ago), removing`\n+        )\n+        continue\n+      }\n+\n+      if (!isProcessAlive(info.pid)) {\n+        console.error(\n+          `[MCP] Dev server at ${projectPath} (PID ${info.pid}) is not running, removing`\n+        )\n+        continue\n+      }\n+\n+      cleanedRegistry[projectPath] = info\n+    }\n+\n+    return cleanedRegistry\n+  } catch (error) {\n+    console.error('[MCP] Failed to load dev server registry:', error)\n+    return {}\n+  }\n+}\n+\n+function watchDevServerRegistry(\n+  onChange: (registry: DevServerRegistry) => void\n+): () => void {\n+  const dir = path.dirname(DEV_SERVER_REGISTRY_PATH)\n+\n+  try {\n+    if (!fs.existsSync(dir)) {\n+      fs.mkdirSync(dir, { recursive: true })\n+    }\n+  } catch (error) {\n+    console.error('[MCP] Failed to create registry directory:', error)\n+    return () => {}\n+  }\n+\n+  try {\n+    registryWatcher = fs.watch(\n+      dir,\n+      { persistent: false },\n+      (eventType, filename) => {\n+        if (filename === path.basename(DEV_SERVER_REGISTRY_PATH)) {\n+          try {\n+            const registry = loadDevServerRegistry()\n+            onChange(registry)\n+          } catch (error) {\n+            console.error('[MCP] Error handling registry change:', error)\n+          }\n+        }\n+      }\n+    )\n+\n+    registryWatcher.on('error', (error) => {\n+      console.error('[MCP] Registry watcher error:', error)\n+    })\n+\n+    cleanupRegistryInterval = setInterval(() => {\n+      try {\n+        const registry = loadDevServerRegistry()\n+        onChange(registry)\n+      } catch (error) {\n+        console.error('[MCP] Error during periodic registry cleanup:', error)\n+      }\n+    }, REGISTRY_POLL_INTERVAL_MS)\n+\n+    return () => {\n+      if (registryWatcher) {\n+        registryWatcher.close()\n+        registryWatcher = null\n+      }\n+      if (cleanupRegistryInterval) {\n+        clearInterval(cleanupRegistryInterval)\n+        cleanupRegistryInterval = null\n+      }\n+    }\n+  } catch (error) {\n+    console.error('[MCP] Failed to setup registry watcher:', error)\n+    return () => {}\n+  }\n+}\n+\n+function findDevServerByContext(context?: string): DevServerInfo | null {\n+  const servers = Object.values(devServerRegistry)\n+\n+  if (servers.length === 0) {\n+    return null\n+  }\n+\n+  if (servers.length === 1) {\n+    return servers[0]\n+  }\n+\n+  if (!context) {\n+    return null\n+  }\n+\n+  if (devServerRegistry[context]) {\n+    return devServerRegistry[context]\n+  }\n+\n+  const normalizedContext = path.normalize(context)\n+\n+  for (const server of servers) {\n+    if (server.projectPath === normalizedContext) {\n+      return server\n+    }\n+  }\n+\n+  for (const server of servers) {\n+    if (server.projectPath.includes(normalizedContext)) {\n+      return server\n+    }\n+  }\n+\n+  for (const server of servers) {\n+    if (normalizedContext.includes(path.basename(server.projectPath))) {\n+      return server\n+    }\n+  }\n+\n+  return null\n+}\n+\n+async function proxyMcpRequest(\n+  method: string,\n+  params: unknown,\n+  context?: string,\n+  toolName?: string\n+): Promise<any> {\n+  const devServer = findDevServerByContext(context)\n+\n+  if (!devServer) {\n+    const projectCount = Object.keys(devServerRegistry).length\n+    if (projectCount === 0) {\n+      throw new Error(\n+        'No dev servers running. Please start a dev server with `next dev`'\n+      )\n+    } else if (context) {\n+      const availableProjects = Object.keys(devServerRegistry)\n+        .map((p) => `  - ${p}`)\n+        .join('\\n')\n+      throw new Error(\n+        `Could not find dev server for context \"${context}\".\\n` +\n+          `Available projects:\\n${availableProjects}\\n\\n` +\n+          `Use get_project_path() with one of the paths above.`\n+      )\n+    } else {\n+      const availableProjects = Object.keys(devServerRegistry)\n+        .map((p) => `  - ${p}`)\n+        .join('\\n')\n+      throw new Error(\n+        `Multiple dev servers running (${projectCount}). Please specify projectPath.\\n` +\n+          `Available projects:\\n${availableProjects}\\n\\n` +\n+          `Example: get_errors({ projectPath: \"${Object.keys(devServerRegistry)[0]}\" })`\n+      )\n+    }\n+  }\n+\n+  const url = `http://${devServer.hostname}:${devServer.port}/_next/mcp`\n+\n+  let response: Response\n+  try {\n+    response = await fetch(url, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json',\n+      },\n+      body: JSON.stringify({\n+        jsonrpc: '2.0',\n+        method,\n+        params,\n+        id: 1,\n+      }),\n+      signal: AbortSignal.timeout(10000),\n+    })\n+  } catch (error) {\n+    if (error instanceof Error && error.name === 'TimeoutError') {\n+      throw new Error(\n+        `Request to dev server timed out (${devServer.projectPath}). ` +\n+          `The dev server may be unresponsive.`\n+      )\n+    }\n+    throw new Error(\n+      `Failed to connect to dev server at ${devServer.hostname}:${devServer.port} (${devServer.projectPath}). ` +\n+        `Error: ${error instanceof Error ? error.message : String(error)}`\n+    )\n+  }\n+\n+  if (!response.ok) {\n+    throw new Error(\n+      `Dev server returned HTTP ${response.status}: ${response.statusText} (${devServer.projectPath})`\n+    )\n+  }\n+\n+  let data: {\n+    error?: { code?: number; message?: string }\n+    result?: unknown\n+  }\n+\n+  try {\n+    data = await response.json()\n+  } catch (error) {\n+    throw new Error(\n+      `Invalid JSON response from dev server (${devServer.projectPath})`\n+    )\n+  }\n+\n+  if (data.error) {\n+    if (\n+      toolName &&\n+      data.error.message &&\n+      (data.error.message.toLowerCase().includes('unknown tool') ||\n+        data.error.message.toLowerCase().includes('not found'))\n+    ) {\n+      throw new Error(\n+        `Tool '${toolName}' is not supported in this project (${devServer.projectPath}).\\n\\n` +\n+          `This tool may require a newer version of Next.js.\\n` +\n+          `Try upgrading: npm install next@latest`\n+      )\n+    }\n+    throw new Error(\n+      data.error.message || `MCP error code ${data.error.code || 'unknown'}`\n+    )\n+  }\n+\n+  return data.result\n+}\n+\n+async function startStdioMcpServer(): Promise<void> {\n+  devServerRegistry = loadDevServerRegistry()\n+\n+  const cleanup = watchDevServerRegistry((registry) => {\n+    devServerRegistry = registry\n+    const serverCount = Object.keys(registry).length\n+    console.error(`[MCP] Registry updated: ${serverCount} dev server(s) active`)\n+    for (const [projectPath, info] of Object.entries(registry)) {\n+      console.error(`[MCP]   - ${projectPath} on ${info.hostname}:${info.port}`)\n+    }\n+  })\n+\n+  process.on('SIGINT', () => {\n+    console.error('[MCP] Received SIGINT, shutting down...')\n+    cleanup()\n+    process.exit(0)\n+  })\n+\n+  process.on('SIGTERM', () => {\n+    console.error('[MCP] Received SIGTERM, shutting down...')\n+    cleanup()\n+    process.exit(0)\n+  })\n+\n+  process.on('uncaughtException', (error) => {\n+    console.error('[MCP] Uncaught exception:', error)\n+    cleanup()\n+    process.exit(1)\n+  })\n+\n+  process.on('unhandledRejection', (reason) => {\n+    console.error('[MCP] Unhandled rejection:', reason)\n+    cleanup()\n+    process.exit(1)\n+  })\n+\n+  const mcpServer = new McpServer({\n+    name: 'Next.js Dev Server Manager (stdio)',\n+    version: '0.1.0',\n+  })\n+\n+  mcpServer.registerTool(\n+    'list_dev_servers',\n+    {\n+      description: 'List all running Next.js dev servers',\n+      inputSchema: {},\n+    },\n+    async () => {\n+      const servers = Object.entries(devServerRegistry).map(\n+        ([projectPath, info]) => ({\n+          projectPath,\n+          port: info.port,\n+          hostname: info.hostname,\n+          pid: info.pid,\n+        })\n+      )\n+      return {\n+        content: [\n+          {\n+            type: 'text',\n+            text: JSON.stringify({ servers }, null, 2),\n+          },\n+        ],\n+      }\n+    }\n+  )\n+\n+  mcpServer.registerTool(\n+    'get_project_path',\n+    {\n+      description:\n+        'Get the absolute path to the Next.js project directory. Optional projectPath context to specify which dev server.',\n+      inputSchema: {\n+        projectPath: z.string().optional(),\n+      },\n+    },\n+    async (request) => {\n+      return proxyMcpRequest(\n+        'tools/call',\n+        {\n+          name: 'get_project_path',\n+          arguments: {},\n+        },\n+        request.projectPath,\n+        'get_project_path'\n+      )\n+    }\n+  )\n+\n+  mcpServer.registerTool(\n+    'get_errors',\n+    {\n+      description:\n+        'Get the current error state of the app when rendered in the browser. Optional projectPath to specify which dev server.',\n+      inputSchema: {\n+        projectPath: z.string().optional(),\n+      },\n+    },\n+    async (request) => {\n+      return proxyMcpRequest(\n+        'tools/call',\n+        {\n+          name: 'get_errors',\n+          arguments: {},\n+        },\n+        request.projectPath,\n+        'get_errors'\n+      )\n+    }\n+  )\n+\n+  mcpServer.registerTool(\n+    'get_page_metadata',\n+    {\n+      description:\n+        'Get metadata about the currently loaded page in the browser. Optional projectPath to specify which dev server.',\n+      inputSchema: {\n+        projectPath: z.string().optional(),\n+      },\n+    },\n+    async (request) => {\n+      return proxyMcpRequest(\n+        'tools/call',\n+        {\n+          name: 'get_page_metadata',\n+          arguments: {},\n+        },\n+        request.projectPath,\n+        'get_page_metadata'\n+      )\n+    }\n+  )\n+\n+  mcpServer.registerTool(\n+    'get_logs',\n+    {\n+      description:\n+        'Get recent build and runtime logs from the dev server. Optional projectPath to specify which dev server.',\n+      inputSchema: {\n+        projectPath: z.string().optional(),\n+      },\n+    },\n+    async (request) => {\n+      return proxyMcpRequest(\n+        'tools/call',\n+        {\n+          name: 'get_logs',\n+          arguments: {},\n+        },\n+        request.projectPath,\n+        'get_logs'\n+      )\n+    }\n+  )\n+\n+  mcpServer.registerTool(\n+    'get_server_action_by_id',\n+    {\n+      description:\n+        'Get information about a specific server action by its ID. Optional projectPath to specify which dev server.',\n+      inputSchema: {\n+        actionId: z.string(),\n+        projectPath: z.string().optional(),\n+      },\n+    },\n+    async (request) => {\n+      return proxyMcpRequest(\n+        'tools/call',\n+        {\n+          name: 'get_server_action_by_id',\n+          arguments: { actionId: request.actionId },\n+        },\n+        request.projectPath,\n+        'get_server_action_by_id'\n+      )\n+    }\n+  )\n+\n+  const transport = new StdioServerTransport()\n+  await mcpServer.connect(transport)\n+\n+  const serverCount = Object.keys(devServerRegistry).length\n+  console.error('[MCP] Session manager started')\n+  console.error('[MCP] Managing all Next.js dev servers on this machine')\n+  console.error(`[MCP] Currently tracking ${serverCount} dev server(s)`)\n+\n+  if (serverCount === 0) {\n+    console.error('[MCP] Waiting for dev servers to start...')\n+    console.error('[MCP] Run `next dev` in a Next.js project to register it')\n+  }\n+}\n+\n+startStdioMcpServer().catch((error) => {\n+  console.error('[MCP] Fatal error:', error)\n+  console.error('[MCP] Stack:', error instanceof Error ? error.stack : error)\n+  process.exit(1)\n+})"
        },
        {
            "sha": "975022613365378fae7afc53f7682988719aeac3",
            "filename": "packages/next/src/server/lib/start-server.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/48d9966c54ab469fda90a8796bb0a902229c3587/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/48d9966c54ab469fda90a8796bb0a902229c3587/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts?ref=48d9966c54ab469fda90a8796bb0a902229c3587",
            "patch": "@@ -364,6 +364,11 @@ export async function startServer(\n         process.env.__NEXT_EXPERIMENTAL_HTTPS = '1'\n       }\n \n+      if (isDev) {\n+        const { registerDevServer } = require('../mcp/standalone-mcp-server')\n+        registerDevServer(dir, port, formattedHostname)\n+      }\n+\n       // Only load env and config in dev to for logging purposes\n       let envInfo: string[] | undefined\n       let experimentalFeatures: ConfiguredExperimentalFeature[] | undefined"
        },
        {
            "sha": "83caf695b4a539b7ffefd0a2c080ef8cde5a0693",
            "filename": "packages/next/src/server/mcp/README.md",
            "status": "added",
            "additions": 352,
            "deletions": 0,
            "changes": 352,
            "blob_url": "https://github.com/vercel/next.js/blob/48d9966c54ab469fda90a8796bb0a902229c3587/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2FREADME.md",
            "raw_url": "https://github.com/vercel/next.js/raw/48d9966c54ab469fda90a8796bb0a902229c3587/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2FREADME.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2FREADME.md?ref=48d9966c54ab469fda90a8796bb0a902229c3587",
            "patch": "@@ -0,0 +1,352 @@\n+# Next.js MCP (Model Context Protocol) Integration\n+\n+## Architecture Overview\n+\n+Next.js provides an MCP server that allows AI assistants like Claude Code to introspect and interact with Next.js development servers.\n+\n+### Components\n+\n+1. **Session Manager** (`next-mcp-stdio.ts`)\n+   - Runs as a standalone process via `npx next@canary mcp`\n+   - Manages multiple Next.js dev servers across the machine\n+   - Uses stdio transport for communication with Claude Code\n+   - Routes MCP requests to the correct dev server\n+\n+2. **Dev Server Registry** (`/tmp/next-dev-servers.json`)\n+   - Global registry of all running Next.js dev servers\n+   - Updated via heartbeat every 30 seconds\n+   - Auto-cleaned of stale/dead servers\n+\n+3. **Dev Server Integration** (`standalone-mcp-server.ts`)\n+   - Each `next dev` registers itself in the global registry\n+   - Implements MCP tools via `/_next/mcp` endpoint\n+   - Provides access to errors, logs, metadata, etc.\n+\n+## Data Flow\n+\n+```\n+┌──────────────────┐\n+│   Claude Code    │\n+└────────┬─────────┘\n+         │ stdio (JSON-RPC)\n+         ↓\n+┌────────────────────────────────┐\n+│  Session Manager               │\n+│  (npx next@canary mcp)         │\n+│  • Watches registry            │\n+│  • Routes requests             │\n+└─────┬────────────┬────────────┘\n+      │ HTTP       │ HTTP\n+      ↓            ↓\n+┌──────────┐  ┌──────────┐\n+│ next@14  │  │ next@15  │\n+│ :3000    │  │ :3001    │\n+└──────────┘  └──────────┘\n+```\n+\n+## Configuration\n+\n+### Claude Code Setup\n+\n+Add to Claude Code's MCP configuration:\n+\n+```json\n+{\n+  \"mcpServers\": {\n+    \"nextjs\": {\n+      \"command\": \"npx\",\n+      \"args\": [\"-y\", \"next@canary\", \"mcp\"]\n+    }\n+  }\n+}\n+```\n+\n+### Usage\n+\n+```bash\n+# Start dev server - it auto-registers\n+cd ~/my-next-app\n+next dev\n+\n+# Claude Code can now access MCP tools\n+```\n+\n+## Available MCP Tools\n+\n+### `list_dev_servers()`\n+\n+Lists all running Next.js dev servers.\n+\n+**Returns:**\n+```json\n+{\n+  \"servers\": [\n+    {\n+      \"projectPath\": \"/Users/alice/app-a\",\n+      \"port\": 3000,\n+      \"hostname\": \"localhost\",\n+      \"pid\": 12345\n+    }\n+  ]\n+}\n+```\n+\n+### `get_project_path({ projectPath?: string })`\n+\n+Get the absolute path to a Next.js project.\n+\n+**Parameters:**\n+- `projectPath` (optional): Path hint for multi-project scenarios\n+\n+**Returns:** Absolute project path\n+\n+### `get_errors({ projectPath?: string })`\n+\n+Get current browser error state including build and runtime errors.\n+\n+**Parameters:**\n+- `projectPath` (optional): Path hint for multi-project scenarios\n+\n+**Returns:** Formatted error messages with source-mapped stack traces\n+\n+### `get_page_metadata({ projectPath?: string })`\n+\n+Get metadata about the currently loaded page in the browser.\n+\n+**Parameters:**\n+- `projectPath` (optional): Path hint for multi-project scenarios\n+\n+**Returns:** Page metadata (route, params, searchParams, etc.)\n+\n+### `get_logs({ projectPath?: string })`\n+\n+Get recent build and runtime logs from the dev server.\n+\n+**Parameters:**\n+- `projectPath` (optional): Path hint for multi-project scenarios\n+\n+**Returns:** Recent log entries\n+\n+### `get_server_action_by_id({ actionId: string, projectPath?: string })`\n+\n+Get information about a specific server action.\n+\n+**Parameters:**\n+- `actionId` (required): The server action ID\n+- `projectPath` (optional): Path hint for multi-project scenarios\n+\n+**Returns:** Server action details\n+\n+## Multi-Project Support\n+\n+### Single Project (Auto-routing)\n+\n+```javascript\n+// No projectPath needed - routes to only dev server\n+get_errors()\n+```\n+\n+### Multiple Projects (Requires Context)\n+\n+```javascript\n+// List all dev servers\n+list_dev_servers()\n+\n+// Specify project explicitly\n+get_errors({ projectPath: \"/Users/alice/app-a\" })\n+get_errors({ projectPath: \"app-a\" }) // Partial match OK\n+```\n+\n+## Version Compatibility\n+\n+The session manager advertises all tools from the version you run (`next@canary`), but each dev server implements only the tools it supports.\n+\n+**Example:**\n+\n+```javascript\n+// Session manager from next@canary has get_ai_hints\n+// Dev server running next@14 doesn't have it\n+\n+get_ai_hints({ projectPath: \"/old-project\" })\n+// Error: Tool 'get_ai_hints' is not supported in this project.\n+//        This tool may require a newer version of Next.js.\n+//        Try upgrading: npm install next@latest\n+```\n+\n+This allows gradual upgrades and testing of new features.\n+\n+## Registry Format\n+\n+**Location:** `/tmp/next-dev-servers.json` (macOS/Linux) or `%TEMP%\\next-dev-servers.json` (Windows)\n+\n+**Schema:**\n+```typescript\n+{\n+  \"/absolute/path/to/project\": {\n+    \"port\": 3000,\n+    \"hostname\": \"localhost\",\n+    \"pid\": 12345,\n+    \"projectPath\": \"/absolute/path/to/project\",\n+    \"lastSeen\": 1704067200000  // Unix timestamp\n+  }\n+}\n+```\n+\n+## Cleanup & Lifecycle\n+\n+### Automatic Cleanup\n+\n+Servers are removed from registry when:\n+- Process exits normally (`process.on('exit')`)\n+- Process receives SIGINT/SIGTERM\n+- Heartbeat expires (>60 seconds without update)\n+- Process PID no longer exists\n+\n+### Manual Cleanup\n+\n+```bash\n+# Remove stale registry\n+rm /tmp/next-dev-servers.json\n+```\n+\n+## Error Handling\n+\n+### No Dev Servers Running\n+\n+```\n+Error: No dev servers running. Please start a dev server with `next dev`\n+```\n+\n+### Multiple Dev Servers (No Context)\n+\n+```\n+Error: Multiple dev servers running (2). Please specify projectPath.\n+Available projects:\n+  - /Users/alice/app-a\n+  - /Users/alice/app-b\n+\n+Example: get_errors({ projectPath: \"/Users/alice/app-a\" })\n+```\n+\n+### Dev Server Not Found\n+\n+```\n+Error: Could not find dev server for context \"app-c\".\n+Available projects:\n+  - /Users/alice/app-a\n+  - /Users/alice/app-b\n+\n+Use get_project_path() with one of the paths above.\n+```\n+\n+### Connection Timeout\n+\n+```\n+Error: Request to dev server timed out (/Users/alice/app-a).\n+The dev server may be unresponsive.\n+```\n+\n+### Tool Not Supported\n+\n+```\n+Error: Tool 'get_ai_hints' is not supported in this project (/Users/alice/app-a).\n+\n+This tool may require a newer version of Next.js.\n+Try upgrading: npm install next@latest\n+```\n+\n+## Implementation Details\n+\n+### Atomic File Writes\n+\n+Registry updates use atomic writes to prevent corruption:\n+\n+```typescript\n+// Write to temp file\n+fs.writeFileSync(`${registryPath}.${pid}.tmp`, data)\n+// Atomic rename\n+fs.renameSync(tempPath, registryPath)\n+```\n+\n+### Heartbeat System\n+\n+Each dev server updates `lastSeen` every 30 seconds. Session manager polls every 2 seconds to clean stale entries.\n+\n+### Process Detection\n+\n+Uses `process.kill(pid, 0)` to check if process is alive without sending a signal.\n+\n+### Signal Handling\n+\n+Proper exit codes:\n+- `SIGINT` → exit code 130\n+- `SIGTERM` → exit code 143\n+\n+## Debugging\n+\n+### Enable Session Manager Logs\n+\n+```bash\n+# Run manually to see logs\n+npx next@canary mcp\n+```\n+\n+**Output:**\n+```\n+[MCP] Session manager started\n+[MCP] Managing all Next.js dev servers on this machine\n+[MCP] Currently tracking 0 dev server(s)\n+[MCP] Waiting for dev servers to start...\n+[MCP] Run `next dev` in a Next.js project to register it\n+[MCP] Registry updated: 1 dev server(s) active\n+[MCP]   - /Users/alice/app-a on localhost:3000\n+```\n+\n+### Check Registry\n+\n+```bash\n+# macOS/Linux\n+cat /tmp/next-dev-servers.json | jq\n+\n+# Windows\n+type %TEMP%\\next-dev-servers.json\n+```\n+\n+### Test MCP Tools\n+\n+Use `fetch` to test tools directly:\n+\n+```javascript\n+const response = await fetch('http://localhost:3000/_next/mcp', {\n+  method: 'POST',\n+  headers: { 'Content-Type': 'application/json' },\n+  body: JSON.stringify({\n+    jsonrpc: '2.0',\n+    method: 'tools/call',\n+    params: { name: 'get_errors', arguments: {} },\n+    id: 1\n+  })\n+})\n+```\n+\n+## Security Considerations\n+\n+1. **Local-only**: Registry and MCP endpoints are only accessible on localhost\n+2. **No auth**: Assumes trusted local environment\n+3. **PID validation**: Prevents stale entries from zombie processes\n+4. **Path normalization**: Prevents path traversal attacks\n+\n+## Performance\n+\n+- **Registry size**: ~1KB per dev server\n+- **Heartbeat overhead**: ~1 file write per 30s per dev server\n+- **Tool call latency**: <100ms (HTTP proxy overhead)\n+- **Memory**: ~5MB for session manager\n+\n+## Future Enhancements\n+\n+1. **WebSocket transport**: If MCP adds WebSocket support\n+2. **Tool discovery**: Dynamic tool registration from dev servers\n+3. **Authentication**: Add token-based auth for registry access\n+4. **Remote dev servers**: Support cloud dev environments\n+5. **Performance metrics**: Track tool call latency and usage"
        },
        {
            "sha": "7d603382c346c7898b88ad782685e1068ef3a578",
            "filename": "packages/next/src/server/mcp/standalone-mcp-server.ts",
            "status": "added",
            "additions": 199,
            "deletions": 0,
            "changes": 199,
            "blob_url": "https://github.com/vercel/next.js/blob/48d9966c54ab469fda90a8796bb0a902229c3587/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fstandalone-mcp-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/48d9966c54ab469fda90a8796bb0a902229c3587/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fstandalone-mcp-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fstandalone-mcp-server.ts?ref=48d9966c54ab469fda90a8796bb0a902229c3587",
            "patch": "@@ -0,0 +1,199 @@\n+import fs from 'fs'\n+import path from 'path'\n+import os from 'os'\n+\n+const DEV_SERVER_REGISTRY_PATH = path.join(\n+  os.tmpdir(),\n+  'next-dev-servers.json'\n+)\n+const HEARTBEAT_INTERVAL_MS = 30000\n+\n+interface DevServerInfo {\n+  port: number\n+  hostname: string\n+  pid: number\n+  projectPath: string\n+  lastSeen: number\n+}\n+\n+interface DevServerRegistry {\n+  [projectPath: string]: DevServerInfo\n+}\n+\n+let heartbeatInterval: NodeJS.Timeout | null = null\n+let registrationComplete = false\n+\n+function readRegistryFile(): DevServerRegistry {\n+  try {\n+    if (!fs.existsSync(DEV_SERVER_REGISTRY_PATH)) {\n+      return {}\n+    }\n+\n+    const content = fs.readFileSync(DEV_SERVER_REGISTRY_PATH, 'utf-8')\n+    if (!content.trim()) {\n+      return {}\n+    }\n+\n+    return JSON.parse(content) as DevServerRegistry\n+  } catch (error) {\n+    console.error('[MCP] Error reading registry file:', error)\n+    return {}\n+  }\n+}\n+\n+function isProcessAlive(pid: number): boolean {\n+  try {\n+    process.kill(pid, 0)\n+    return true\n+  } catch {\n+    return false\n+  }\n+}\n+\n+function writeRegistryFile(registry: DevServerRegistry): boolean {\n+  try {\n+    const dir = path.dirname(DEV_SERVER_REGISTRY_PATH)\n+\n+    if (!fs.existsSync(dir)) {\n+      fs.mkdirSync(dir, { recursive: true })\n+    }\n+\n+    const tempPath = `${DEV_SERVER_REGISTRY_PATH}.${process.pid}.tmp`\n+    fs.writeFileSync(tempPath, JSON.stringify(registry, null, 2), 'utf-8')\n+\n+    fs.renameSync(tempPath, DEV_SERVER_REGISTRY_PATH)\n+\n+    return true\n+  } catch (error) {\n+    console.error('[MCP] Error writing registry file:', error)\n+    return false\n+  }\n+}\n+\n+function updateHeartbeat(projectPath: string): void {\n+  try {\n+    const registry = readRegistryFile()\n+\n+    if (registry[projectPath]) {\n+      registry[projectPath].lastSeen = Date.now()\n+      writeRegistryFile(registry)\n+    } else {\n+      if (heartbeatInterval) {\n+        clearInterval(heartbeatInterval)\n+        heartbeatInterval = null\n+      }\n+    }\n+  } catch (error) {\n+    console.error('[MCP] Failed to update heartbeat:', error)\n+  }\n+}\n+\n+export function registerDevServer(\n+  projectPath: string,\n+  port: number,\n+  hostname: string\n+): void {\n+  if (registrationComplete) {\n+    console.warn(\n+      '[MCP] Dev server already registered, skipping duplicate registration'\n+    )\n+    return\n+  }\n+\n+  try {\n+    const normalizedPath = path.resolve(projectPath)\n+    const registry = readRegistryFile()\n+    const currentPid = process.pid\n+\n+    if (registry[normalizedPath]) {\n+      const existing = registry[normalizedPath]\n+\n+      if (existing.pid !== currentPid) {\n+        const isOtherServerAlive = isProcessAlive(existing.pid)\n+\n+        if (isOtherServerAlive) {\n+          console.error(\n+            `\\n[MCP] ERROR: Another dev server is already running for this project!\\n` +\n+              `  Project: ${normalizedPath}\\n` +\n+              `  Existing server: PID ${existing.pid} on ${existing.hostname}:${existing.port}\\n` +\n+              `  This server: PID ${currentPid} on ${hostname}:${port}\\n\\n` +\n+              `Please stop the other dev server first, or use a different project directory.\\n`\n+          )\n+          return\n+        } else {\n+          console.warn(\n+            `[MCP] Stale server entry found (PID ${existing.pid} is dead), replacing...`\n+          )\n+        }\n+      }\n+    }\n+\n+    registry[normalizedPath] = {\n+      port,\n+      hostname,\n+      pid: currentPid,\n+      projectPath: normalizedPath,\n+      lastSeen: Date.now(),\n+    }\n+\n+    if (!writeRegistryFile(registry)) {\n+      throw new Error('Failed to write registry file')\n+    }\n+\n+    registrationComplete = true\n+\n+    heartbeatInterval = setInterval(\n+      () => updateHeartbeat(normalizedPath),\n+      HEARTBEAT_INTERVAL_MS\n+    )\n+\n+    const cleanup = () => {\n+      if (heartbeatInterval) {\n+        clearInterval(heartbeatInterval)\n+        heartbeatInterval = null\n+      }\n+      unregisterDevServer(normalizedPath)\n+    }\n+\n+    process.once('exit', cleanup)\n+    process.once('SIGINT', () => {\n+      cleanup()\n+      process.exit(130)\n+    })\n+    process.once('SIGTERM', () => {\n+      cleanup()\n+      process.exit(143)\n+    })\n+\n+    console.log(\n+      `[MCP] Registered dev server: ${normalizedPath} on ${hostname}:${port}`\n+    )\n+  } catch (error) {\n+    console.error('[MCP] Failed to register dev server:', error)\n+    registrationComplete = false\n+  }\n+}\n+\n+export function unregisterDevServer(projectPath: string): void {\n+  if (!registrationComplete) {\n+    return\n+  }\n+\n+  try {\n+    const normalizedPath = path.resolve(projectPath)\n+    const registry = readRegistryFile()\n+\n+    if (!registry[normalizedPath]) {\n+      return\n+    }\n+\n+    delete registry[normalizedPath]\n+\n+    writeRegistryFile(registry)\n+\n+    console.log(`[MCP] Unregistered dev server: ${normalizedPath}`)\n+    registrationComplete = false\n+  } catch (error) {\n+    console.error('[MCP] Failed to unregister dev server:', error)\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 1060,
        "additions": 1060,
        "deletions": 0
    }
}