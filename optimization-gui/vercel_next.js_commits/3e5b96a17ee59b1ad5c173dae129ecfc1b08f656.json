{
    "author": "wbinnssmith",
    "message": "next analyze: annotate polyfill modules in UI (#86062)\n\nFor small routes, it can appear like the polyfill chunk takes up a sizable amount of data, but `polyfill-nomodule.js` is only sent to legacy browsers. This makes it clearer.\r\n\r\nThis PR enhances the bundle analyzer by adding visual indicators for polyfill chunks, and noting they're conditionally sent to modern or legacy browsers. The changes include:\r\n\r\n- Adds a source map to polyfill chunks (for the large pre-bundled input only)\r\n- Visually distinguished polyfill chunks in the treemap by lightening their color\r\n- Added a \"Polyfill\" badge (other badges coming soon!) with text when viewing polyfill chunk details\r\n\r\n<img width=\"388\" height=\"227\" alt=\"image\" src=\"https://github.com/user-attachments/assets/bcebfba6-1e10-459a-9364-b6b8197cd3df\" />\r\n\r\nFixes PACK-5826",
    "sha": "3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
    "files": [
        {
            "sha": "7c945ac8d867760b7e22bd8521dc45beaafb8d46",
            "filename": "apps/bundle-analyzer/app/globals.css",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Fapp%2Fglobals.css",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Fapp%2Fglobals.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fapp%2Fglobals.css?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -32,6 +32,8 @@\n   --sidebar-accent-foreground: oklch(0.205 0 0);\n   --sidebar-border: oklch(0.922 0 0);\n   --sidebar-ring: oklch(0.708 0 0);\n+  --polyfill: #5f707f;\n+  --polyfill-foreground: #ffffff;\n }\n \n .dark {\n@@ -62,6 +64,8 @@\n   --sidebar-accent-foreground: oklch(0.985 0 0);\n   --sidebar-border: oklch(0.269 0 0);\n   --sidebar-ring: oklch(0.439 0 0);\n+  --polyfill: #5f707f;\n+  --polyfill-foreground: #ffffff;\n }\n \n @theme inline {\n@@ -98,6 +102,8 @@\n   --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);\n   --color-sidebar-border: var(--sidebar-border);\n   --color-sidebar-ring: var(--sidebar-ring);\n+  --color-polyfill: var(--polyfill);\n+  --color-polyfill-foreground: var(--polyfill-foreground);\n }\n \n @layer base {"
        },
        {
            "sha": "514cf0dd00b7248e90cfe434eba155e6290cbea8",
            "filename": "apps/bundle-analyzer/app/page.tsx",
            "status": "modified",
            "additions": 39,
            "deletions": 5,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fapp%2Fpage.tsx?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -14,6 +14,8 @@ import { Input } from '@/components/ui/input'\n import { Skeleton, TreemapSkeleton } from '@/components/ui/skeleton'\n import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group'\n import { AnalyzeData, ModulesData } from '@/lib/analyze-data'\n+import { SpecialModule } from '@/lib/types'\n+import { getSpecialModuleType } from '@/lib/utils'\n \n function formatBytes(bytes: number): string {\n   if (bytes === 0) return '0 B'\n@@ -137,6 +139,11 @@ export default function Home() {\n   const isAnyLoading = isAnalyzeLoading || isModulesLoading\n   const rootSourceIndex = getRootSourceIndex(analyzeData)\n \n+  const specialModuleType = getSpecialModuleType(\n+    analyzeData,\n+    selectedSourceIndex\n+  )\n+\n   return (\n     <main\n       className=\"h-screen flex flex-col bg-background\"\n@@ -289,12 +296,39 @@ export default function Home() {\n                 {selectedSourceIndex != null &&\n                   analyzeData.source(selectedSourceIndex) && (\n                     <>\n-                      <p className=\"text-xs text-muted-foreground mt-2\">\n-                        Output Size:{' '}\n-                        {formatBytes(\n-                          analyzeData.getSourceOutputSize(selectedSourceIndex)\n+                      <dl className=\"space-y-2\">\n+                        <div>\n+                          <dt className=\"text-xs text-muted-foreground inline\">\n+                            Output Size:{' '}\n+                          </dt>\n+                          <dd className=\"text-xs text-muted-foreground inline\">\n+                            {formatBytes(\n+                              analyzeData.getSourceOutputSize(\n+                                selectedSourceIndex\n+                              )\n+                            )}\n+                          </dd>\n+                        </div>\n+                        {(specialModuleType === SpecialModule.POLYFILL_MODULE ||\n+                          specialModuleType ===\n+                            SpecialModule.POLYFILL_NOMODULE) && (\n+                          <div className=\"flex items-center gap-2\">\n+                            <dt className=\"inline-flex items-center rounded-md bg-polyfill/10 dark:bg-polyfill/30 px-2 py-1 text-xs font-medium text-polyfill dark:text-polyfill-foreground ring-1 ring-inset ring-polyfill/20 shrink-0\">\n+                              Polyfill\n+                            </dt>\n+                            <dd className=\"text-xs text-muted-foreground\">\n+                              Next.js built-in polyfills\n+                              {specialModuleType ===\n+                              SpecialModule.POLYFILL_NOMODULE ? (\n+                                <>\n+                                  . <code>polyfill-nomodule.js</code> is only\n+                                  sent to legacy browsers.\n+                                </>\n+                              ) : null}\n+                            </dd>\n+                          </div>\n                         )}\n-                      </p>\n+                      </dl>\n                       {modulesData && (\n                         <ImportChain\n                           key={selectedSourceIndex}"
        },
        {
            "sha": "e736a90a342d35bafc7bfdff0f85293c738fc0a3",
            "filename": "apps/bundle-analyzer/components/treemap-visualizer.tsx",
            "status": "modified",
            "additions": 23,
            "deletions": 5,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Fcomponents%2Ftreemap-visualizer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Fcomponents%2Ftreemap-visualizer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fcomponents%2Ftreemap-visualizer.tsx?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -1,6 +1,6 @@\n 'use client'\n \n-import { darken, lighten } from 'polished'\n+import { darken, lighten, readableColor } from 'polished'\n import type React from 'react'\n import { useEffect, useMemo, useRef, useState } from 'react'\n import type { AnalyzeData } from '@/lib/analyze-data'\n@@ -9,6 +9,7 @@ import {\n   type LayoutNode,\n   type LayoutNodeInfo,\n } from '@/lib/treemap-layout'\n+import { SpecialModule } from '@/lib/types'\n \n interface TreemapVisualizerProps {\n   analyzeData: AnalyzeData\n@@ -23,6 +24,8 @@ interface TreemapVisualizerProps {\n   onHoveredNodeChangeDelayed?: (nodeInfo: LayoutNodeInfo | null) => void\n   searchQuery?: string\n   filterSource?: (sourceIndex: number) => boolean\n+  isModulePolyfillChunk?: (sourceIndex: number) => boolean\n+  isNoModulePolyfillChunk?: (sourceIndex: number) => boolean\n }\n \n function getFileColor(node: {\n@@ -33,12 +36,17 @@ function getFileColor(node: {\n   server?: boolean\n   client?: boolean\n   traced?: boolean\n+  specialModuleType: SpecialModule | null\n }): string {\n-  const { js, css, json, asset, client, traced } = node\n+  const { js, css, json, asset, client, traced, specialModuleType } = node\n+\n+  if (isPolyfill(specialModuleType)) {\n+    return '#5f707f'\n+  }\n \n   let color = '#9ca3af' // gray-400 default\n-  if (js) color = '#0068d6'\n-  if (css) color = '#663399'\n+  if (js) color = '#4682b4'\n+  if (css) color = '#8b7d9e'\n   if (json) color = '#297a3a'\n   if (asset) color = '#da2f35'\n \n@@ -54,6 +62,13 @@ function getFileColor(node: {\n   return color\n }\n \n+function isPolyfill(specialModuleType: SpecialModule | null): boolean {\n+  return (\n+    specialModuleType === SpecialModule.POLYFILL_MODULE ||\n+    specialModuleType === SpecialModule.POLYFILL_NOMODULE\n+  )\n+}\n+\n function findNodeAtPosition(\n   node: LayoutNode,\n   x: number,\n@@ -320,7 +335,8 @@ function drawTreemap(\n     ctx.strokeRect(rect.x, rect.y, rect.width, rect.height)\n \n     if (rect.width > 60 && rect.height > 30) {\n-      ctx.fillStyle = colors.text\n+      const textColor = readableColor(color)\n+      ctx.fillStyle = textColor\n       ctx.font = '12px sans-serif'\n       ctx.textAlign = 'center'\n       ctx.textBaseline = 'middle'\n@@ -516,6 +532,7 @@ function wrapLayoutWithAncestorsUsingIndices(\n       titleBarHeight: titleBarHeight,\n       children: [currentNode],\n       sourceIndex: ancestorIndex,\n+      specialModuleType: null,\n     }\n \n     currentNode = ancestorNode\n@@ -539,6 +556,7 @@ function wrapLayoutWithAncestorsUsingIndices(\n     titleBarHeight: minTitleBarHeight,\n     children: [currentNode],\n     sourceIndex: rootIndex,\n+    specialModuleType: null,\n   }\n \n   return rootNode"
        },
        {
            "sha": "1ae82a5aa170682337942a3369659b47fd1a1484",
            "filename": "apps/bundle-analyzer/lib/analyze-data.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Flib%2Fanalyze-data.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Flib%2Fanalyze-data.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Flib%2Fanalyze-data.ts?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -388,6 +388,20 @@ export class AnalyzeData {\n     return { client, server, traced, js, css, json, asset }\n   }\n \n+  isPolyfillModule(index: number): boolean {\n+    const fullSourcePath = this.getFullSourcePath(index)\n+    return fullSourcePath.endsWith(\n+      'node_modules/next/dist/build/polyfills/polyfill-module.js'\n+    )\n+  }\n+\n+  isPolyfillNoModule(index: number): boolean {\n+    const fullSourcePath = this.getFullSourcePath(index)\n+    return fullSourcePath.endsWith(\n+      'node_modules/next/dist/build/polyfills/polyfill-nomodule.js'\n+    )\n+  }\n+\n   // Get the raw header for debugging\n   getRawAnalyzeHeader(): AnalyzeDataHeader {\n     return this.analyzeHeader"
        },
        {
            "sha": "67b023928a97af6d2b101322bc7ed38865128fab",
            "filename": "apps/bundle-analyzer/lib/treemap-layout.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Flib%2Ftreemap-layout.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Flib%2Ftreemap-layout.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Flib%2Ftreemap-layout.ts?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -1,5 +1,7 @@\n import type { AnalyzeData } from './analyze-data'\n import { layoutTreemap } from './layout-treemap'\n+import { SpecialModule } from './types'\n+import { getSpecialModuleType } from './utils'\n \n export interface LayoutRect {\n   x: number\n@@ -18,6 +20,7 @@ export interface LayoutNode extends LayoutNodeInfo {\n   size: number\n   rect: LayoutRect\n   type: 'file' | 'directory' | 'collapsed-directory'\n+  specialModuleType: SpecialModule | null\n   titleBarHeight?: number\n   children?: LayoutNode[]\n   itemCount?: number\n@@ -141,6 +144,7 @@ function computeTreemapLayoutFromAnalyzeInternal(\n       type: 'file',\n       rect,\n       sourceIndex,\n+      specialModuleType: getSpecialModuleType(analyzeData, sourceIndex),\n       ...analyzeData.getSourceFlags(sourceIndex),\n     }\n   }\n@@ -178,6 +182,7 @@ function computeTreemapLayoutFromAnalyzeInternal(\n       itemCount: countDescendants(sourceIndex),\n       children: [],\n       sourceIndex,\n+      specialModuleType: null,\n     }\n   }\n \n@@ -211,6 +216,7 @@ function computeTreemapLayoutFromAnalyzeInternal(\n       titleBarHeight,\n       children: [],\n       sourceIndex,\n+      specialModuleType: null,\n     }\n   }\n \n@@ -240,6 +246,7 @@ function computeTreemapLayoutFromAnalyzeInternal(\n     titleBarHeight,\n     children: layoutChildren,\n     sourceIndex,\n+    specialModuleType: null,\n   }\n }\n "
        },
        {
            "sha": "f0320edf363b3ebe3168a2dc5418f3461ac863b4",
            "filename": "apps/bundle-analyzer/lib/types.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Flib%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Flib%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Flib%2Ftypes.ts?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -33,3 +33,8 @@ export interface RouteManifest {\n   staticRoutes: Array<Route>\n   dynamicRoutes: Array<Route>\n }\n+\n+export enum SpecialModule {\n+  POLYFILL_MODULE,\n+  POLYFILL_NOMODULE,\n+}"
        },
        {
            "sha": "857a409da3175e3b35bed7e3c09cedd37b22166c",
            "filename": "apps/bundle-analyzer/lib/utils.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Flib%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Flib%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Flib%2Futils.ts?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -1,5 +1,7 @@\n import { type ClassValue, clsx } from 'clsx'\n import { twMerge } from 'tailwind-merge'\n+import { SpecialModule } from './types'\n+import { AnalyzeData } from './analyze-data'\n \n export function cn(...inputs: ClassValue[]) {\n   return twMerge(clsx(inputs))\n@@ -8,3 +10,19 @@ export function cn(...inputs: ClassValue[]) {\n export function jsonFetcher<T>(url: string): Promise<T> {\n   return fetch(url).then((res) => res.json())\n }\n+\n+export function getSpecialModuleType(\n+  analyzeData: AnalyzeData | undefined,\n+  sourceIndex: number | null\n+): SpecialModule | null {\n+  if (!analyzeData || sourceIndex == null) return null\n+\n+  const path = analyzeData.source(sourceIndex)?.path || ''\n+  if (path.endsWith('polyfill-module.js')) {\n+    return SpecialModule.POLYFILL_MODULE\n+  } else if (path.endsWith('polyfill-nomodule.js')) {\n+    return SpecialModule.POLYFILL_NOMODULE\n+  }\n+\n+  return null\n+}"
        },
        {
            "sha": "812455c123c1a4beebfe5f0143134de28b39f3de",
            "filename": "apps/bundle-analyzer/styles/globals.css",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Fstyles%2Fglobals.css",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/apps%2Fbundle-analyzer%2Fstyles%2Fglobals.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fstyles%2Fglobals.css?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -21,6 +21,8 @@\n   --border: oklch(0.922 0 0);\n   --input: oklch(0.922 0 0);\n   --ring: oklch(0.708 0 0);\n+  --polyfill: oklch(0.478 0.0185 252.37);\n+  --polyfill-foreground: oklch(0.99 0 0);\n   --radius: 0.625rem;\n }\n \n@@ -42,6 +44,8 @@\n   --border: oklch(0.269 0 0);\n   --input: oklch(0.269 0 0);\n   --ring: oklch(0.439 0 0);\n+  --polyfill: oklch(0.478 0.0185 252.37);\n+  --polyfill-foreground: oklch(0.99 0 0);\n }\n \n @theme inline {\n@@ -64,6 +68,8 @@\n   --color-border: var(--border);\n   --color-input: var(--input);\n   --color-ring: var(--ring);\n+  --color-polyfill: var(--polyfill);\n+  --color-polyfill-foreground: var(--polyfill-foreground);\n   --radius-sm: calc(var(--radius) - 4px);\n   --radius-md: calc(var(--radius) - 2px);\n   --radius-lg: var(--radius);"
        },
        {
            "sha": "aaf34df05e1b410040a99e90ffad511207d6e595",
            "filename": "crates/next-api/src/analyze.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/crates%2Fnext-api%2Fsrc%2Fanalyze.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/crates%2Fnext-api%2Fsrc%2Fanalyze.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fanalyze.rs?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -367,6 +367,7 @@ pub async fn analyze_output_assets(output_assets: Vc<OutputAssets>) -> Result<Vc\n             // Skip source maps.\n             continue;\n         }\n+\n         let output_file_index = builder.add_output_file(AnalyzeOutputFile { filename });\n         let chunk_parts = split_output_asset_into_parts(*asset).await?;\n         for chunk_part in chunk_parts {"
        },
        {
            "sha": "db8fb9b05665590dfa02d227fb988f1873ba6c25",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 26,
            "deletions": 11,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -62,14 +62,16 @@ use turbopack_core::{\n         chunk_group_info::{ChunkGroup, ChunkGroupEntry},\n     },\n     output::{OutputAsset, OutputAssets, OutputAssetsWithReferenced},\n-    raw_output::RawOutput,\n     reference::all_assets_from_entries,\n     reference_type::{CommonJsReferenceSubType, CssReferenceSubType, ReferenceType},\n     resolve::{origin::PlainResolveOrigin, parse::Request, pattern::Pattern},\n     source::Source,\n+    source_map::SourceMapAsset,\n     virtual_output::VirtualOutputAsset,\n };\n-use turbopack_ecmascript::resolve::cjs_resolve;\n+use turbopack_ecmascript::{\n+    resolve::cjs_resolve, single_file_ecmascript_output::SingleFileEcmascriptOutput,\n+};\n \n use crate::{\n     dynamic_imports::{NextDynamicChunkAvailability, collect_next_dynamic_chunks},\n@@ -1300,11 +1302,11 @@ impl AppEndpoint {\n \n         let manifest_path_prefix = &app_entry.original_name;\n \n-        // polyfill-nomodule.js is a pre-compiled asset distributed as part of next,\n-        // load it as a RawModule.\n+        // polyfill-nomodule.js is a pre-compiled asset distributed as part of next\n         let next_package = get_next_package(project.project_path().owned().await?).await?;\n-        let polyfill_source =\n-            FileSource::new(next_package.join(\"dist/build/polyfills/polyfill-nomodule.js\")?);\n+        let polyfill_source_path =\n+            next_package.join(\"dist/build/polyfills/polyfill-nomodule.js\")?;\n+        let polyfill_source = FileSource::new(polyfill_source_path.clone());\n         let polyfill_output_path = client_chunking_context\n             .chunk_path(\n                 Some(Vc::upcast(polyfill_source)),\n@@ -1314,13 +1316,26 @@ impl AppEndpoint {\n             )\n             .owned()\n             .await?;\n-        let polyfill_output_asset = ResolvedVc::upcast(\n-            RawOutput::new(polyfill_output_path, Vc::upcast(polyfill_source))\n-                .to_resolved()\n-                .await?,\n-        );\n+\n+        let polyfill_output = SingleFileEcmascriptOutput::new(\n+            polyfill_output_path.clone(),\n+            polyfill_source_path,\n+            Vc::upcast(polyfill_source),\n+        )\n+        .to_resolved()\n+        .await?;\n+\n+        let polyfill_output_asset = ResolvedVc::upcast(polyfill_output);\n         client_assets.insert(polyfill_output_asset);\n \n+        let polyfill_source_map_asset = SourceMapAsset::new_fixed(\n+            polyfill_output_path.clone(),\n+            *ResolvedVc::upcast(polyfill_output),\n+        )\n+        .to_resolved()\n+        .await?;\n+        client_assets.insert(ResolvedVc::upcast(polyfill_source_map_asset));\n+\n         let client_assets: ResolvedVc<OutputAssets> =\n             ResolvedVc::cell(client_assets.into_iter().collect::<Vec<_>>());\n "
        },
        {
            "sha": "1d3c5825392f01722c1f38e4261cfa62a3ede8d8",
            "filename": "crates/next-api/src/route.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/crates%2Fnext-api%2Fsrc%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/crates%2Fnext-api%2Fsrc%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Froute.rs?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -9,7 +9,7 @@ use turbo_tasks::{\n };\n use turbopack_core::{\n     module_graph::{GraphEntries, ModuleGraph},\n-    output::OutputAssets,\n+    output::{OptionOutputAsset, OutputAssets},\n };\n \n use crate::{operation::OptionEndpoint, paths::ServerPath, project::Project};\n@@ -72,6 +72,10 @@ pub trait Endpoint {\n     }\n     #[turbo_tasks::function]\n     fn module_graphs(self: Vc<Self>) -> Vc<ModuleGraphs>;\n+    #[turbo_tasks::function]\n+    fn polyfill_asset(self: Vc<Self>) -> Vc<OptionOutputAsset> {\n+        Vc::cell(None)\n+    }\n }\n \n #[derive("
        },
        {
            "sha": "9dd250face48e7c60263e5154dcef1b2a4db5908",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -24,6 +24,7 @@ mod path_visitor;\n pub mod references;\n pub mod runtime_functions;\n pub mod side_effect_optimization;\n+pub mod single_file_ecmascript_output;\n pub mod source_map;\n pub(crate) mod static_code;\n mod swc_comments;"
        },
        {
            "sha": "1592cad139c7425a4563fb5448c072fa340b3bcb",
            "filename": "turbopack/crates/turbopack-ecmascript/src/single_file_ecmascript_output.rs",
            "status": "added",
            "additions": 99,
            "deletions": 0,
            "changes": 99,
            "blob_url": "https://github.com/vercel/next.js/blob/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fsingle_file_ecmascript_output.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3e5b96a17ee59b1ad5c173dae129ecfc1b08f656/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fsingle_file_ecmascript_output.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fsingle_file_ecmascript_output.rs?ref=3e5b96a17ee59b1ad5c173dae129ecfc1b08f656",
            "patch": "@@ -0,0 +1,99 @@\n+use std::sync::Arc;\n+\n+use anyhow::Result;\n+use swc_core::common::{BytePos, FileName, LineCol, SourceMap};\n+use tokio::io::AsyncReadExt;\n+use turbo_tasks::{ResolvedVc, Vc};\n+use turbo_tasks_fs::{FileContent, FileSystemPath, rope::Rope};\n+use turbopack_core::{\n+    asset::{Asset, AssetContent},\n+    output::{OutputAsset, OutputAssetsReference},\n+    source::Source,\n+    source_map::{GenerateSourceMap, OptionStringifiedSourceMap},\n+};\n+\n+use crate::parse::generate_js_source_map;\n+\n+/// An EcmaScript OutputAsset composed of one file, no parsing and no references. Includes a source\n+/// map to the original file.\n+#[turbo_tasks::value]\n+pub struct SingleFileEcmascriptOutput {\n+    output_path: FileSystemPath,\n+    source_path: FileSystemPath,\n+    source: ResolvedVc<Box<dyn Source>>,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl OutputAsset for SingleFileEcmascriptOutput {\n+    #[turbo_tasks::function]\n+    fn path(&self) -> Vc<FileSystemPath> {\n+        self.output_path.clone().cell()\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl OutputAssetsReference for SingleFileEcmascriptOutput {}\n+\n+#[turbo_tasks::value_impl]\n+impl Asset for SingleFileEcmascriptOutput {\n+    #[turbo_tasks::function]\n+    fn content(&self) -> Vc<AssetContent> {\n+        self.source.content()\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl SingleFileEcmascriptOutput {\n+    #[turbo_tasks::function]\n+    pub fn new(\n+        output_path: FileSystemPath,\n+        source_path: FileSystemPath,\n+        source: ResolvedVc<Box<dyn Source>>,\n+    ) -> Vc<SingleFileEcmascriptOutput> {\n+        SingleFileEcmascriptOutput {\n+            output_path,\n+            source_path,\n+            source,\n+        }\n+        .cell()\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl GenerateSourceMap for SingleFileEcmascriptOutput {\n+    #[turbo_tasks::function]\n+    pub async fn generate_source_map(&self) -> Result<Vc<OptionStringifiedSourceMap>> {\n+        let FileContent::Content(file) = &*self.source.content().file_content().await? else {\n+            return Ok(Vc::cell(None));\n+        };\n+\n+        let file_source = {\n+            let mut s = String::new();\n+            file.read().read_to_string(&mut s).await?;\n+            s\n+        };\n+\n+        let mut mappings = vec![];\n+        // Start from 1 because 0 is reserved for dummy spans in SWC.\n+        let mut pos: u32 = 1;\n+        for (index, line) in file_source.split_inclusive('\\n').enumerate() {\n+            mappings.push((\n+                BytePos(pos),\n+                LineCol {\n+                    line: index as u32,\n+                    col: 0,\n+                },\n+            ));\n+            pos += line.len() as u32;\n+        }\n+\n+        let sm: Arc<SourceMap> = Default::default();\n+        sm.new_source_file(\n+            FileName::Custom(self.source_path.to_string()).into(),\n+            file_source,\n+        );\n+\n+        let map = generate_js_source_map(&*sm, mappings, None::<&Rope>, true, true)?;\n+        Ok(Vc::cell(Some(map)))\n+    }\n+}"
        }
    ],
    "stats": {
        "total": 272,
        "additions": 250,
        "deletions": 22
    }
}