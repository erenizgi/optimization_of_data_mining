{
    "author": "ijjk",
    "message": "Update middleware request header (#77201)\n\nThis just adds an additional header to our internal filtering list for\nmiddleware.",
    "sha": "9704c8e9fcc58236349ed787903831579440a879",
    "files": [
        {
            "sha": "60cb6e99e7e073eea94158ae8d9a28347d2b62bf",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9704c8e9fcc58236349ed787903831579440a879/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9704c8e9fcc58236349ed787903831579440a879/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=9704c8e9fcc58236349ed787903831579440a879",
            "patch": "@@ -166,6 +166,12 @@ export async function initialize(opts: {\n   renderServer.instance =\n     require('./render-server') as typeof import('./render-server')\n \n+  const randomBytes = new Uint8Array(8)\n+  crypto.getRandomValues(randomBytes)\n+  const middlewareSubrequestId = Buffer.from(randomBytes).toString('hex')\n+  ;(globalThis as any)[Symbol.for('@next/middleware-subrequest-id')] =\n+    middlewareSubrequestId\n+\n   const allowedOrigins = ['localhost', ...(config.allowedDevOrigins || [])]\n   if (opts.hostname) {\n     allowedOrigins.push(opts.hostname)"
        },
        {
            "sha": "0b82fdb3f8df9ea1a81d91cfa86d96effdb53850",
            "filename": "packages/next/src/server/lib/server-ipc/utils.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9704c8e9fcc58236349ed787903831579440a879/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fserver-ipc%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9704c8e9fcc58236349ed787903831579440a879/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fserver-ipc%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fserver-ipc%2Futils.ts?ref=9704c8e9fcc58236349ed787903831579440a879",
            "patch": "@@ -57,5 +57,16 @@ export const filterInternalHeaders = (\n     if (INTERNAL_HEADERS.includes(header)) {\n       delete headers[header]\n     }\n+\n+    // If this request didn't origin from this session we filter\n+    // out the \"x-middleware-subrequest\" header so we don't skip\n+    // middleware incorrectly\n+    if (\n+      header === 'x-middleware-subrequest' &&\n+      headers['x-middleware-subrequest-id'] !==\n+        (globalThis as any)[Symbol.for('@next/middleware-subrequest-id')]\n+    ) {\n+      delete headers['x-middleware-subrequest']\n+    }\n   }\n }"
        },
        {
            "sha": "0ee0fbc11dc816416705e084c5c90008a7fe3c7d",
            "filename": "packages/next/src/server/web/sandbox/context.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9704c8e9fcc58236349ed787903831579440a879/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9704c8e9fcc58236349ed787903831579440a879/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.ts?ref=9704c8e9fcc58236349ed787903831579440a879",
            "patch": "@@ -373,6 +373,10 @@ Learn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation`),\n             store.headers.get('x-middleware-subrequest') ?? ''\n           )\n         }\n+        init.headers.set(\n+          'x-middleware-subrequest-id',\n+          (globalThis as any)[Symbol.for('@next/middleware-subrequest-id')]\n+        )\n \n         const prevs =\n           init.headers.get(`x-middleware-subrequest`)?.split(':') || []"
        },
        {
            "sha": "7e50d4386ee07eb19c9cc1c36b4297808c9fb73f",
            "filename": "test/e2e/middleware-general/test/index.test.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/9704c8e9fcc58236349ed787903831579440a879/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9704c8e9fcc58236349ed787903831579440a879/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts?ref=9704c8e9fcc58236349ed787903831579440a879",
            "patch": "@@ -144,6 +144,19 @@ describe('Middleware Runtime', () => {\n       }\n     }\n \n+    it('should filter request header properly', async () => {\n+      const res = await next.fetch('/redirect-to-somewhere', {\n+        headers: {\n+          'x-middleware-subrequest':\n+            'middleware:middleware:middleware:middleware:middleware',\n+        },\n+        redirect: 'manual',\n+      })\n+\n+      expect(res.status).toBe(307)\n+      expect(res.headers.get('location')).toContain('/somewhere')\n+    })\n+\n     it('should handle 404 on fallback: false route correctly', async () => {\n       const res = await next.fetch('/ssg-fallback-false/first')\n       expect(res.status).toBe(200)"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 34,
        "deletions": 0
    }
}