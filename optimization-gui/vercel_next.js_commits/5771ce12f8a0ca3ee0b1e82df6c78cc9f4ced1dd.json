{
    "author": "huozhi",
    "message": "[segment explorer] handle builtin not-found (#80607)",
    "sha": "5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd",
    "files": [
        {
            "sha": "f3fe9da7dd091fca880ddf812a809f836b589e01",
            "filename": "packages/next/src/build/webpack/loaders/next-app-loader/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts?ref=5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd",
            "patch": "@@ -79,10 +79,11 @@ const GLOBAL_NOT_FOUND_FILE_TYPE = 'global-not-found'\n const PAGE_SEGMENT = 'page$'\n const PARALLEL_CHILDREN_SEGMENT = 'children$'\n \n-const defaultGlobalErrorPath = 'next/dist/client/components/global-error'\n-const defaultNotFoundPath = 'next/dist/client/components/not-found-error'\n-const defaultLayoutPath = 'next/dist/client/components/default-layout'\n-const defaultGlobalNotFoundPath = 'next/dist/client/components/global-not-found'\n+const defaultGlobalErrorPath = 'next/dist/client/components/global-error.js'\n+const defaultNotFoundPath = 'next/dist/client/components/not-found-error.js'\n+const defaultLayoutPath = 'next/dist/client/components/default-layout.js'\n+const defaultGlobalNotFoundPath =\n+  'next/dist/client/components/global-not-found.js'\n \n type DirResolver = (pathToResolve: string) => string\n type PathResolver = ("
        },
        {
            "sha": "ad21948b8b4914810d0f9dbc3ca00b5abecef1a8",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-explorer.tsx",
            "status": "modified",
            "additions": 35,
            "deletions": 47,
            "changes": 82,
            "blob_url": "https://github.com/vercel/next.js/blob/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx?ref=5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd",
            "patch": "@@ -39,7 +39,6 @@ function PageSegmentTreeLayerPresentation({\n   node: SegmentTrieNode\n   level: number\n }) {\n-  const nodeName = node.value?.type\n   const childrenKeys = Object.keys(node.children)\n \n   const sortedChildrenKeys = childrenKeys.sort((a, b) => {\n@@ -107,42 +106,38 @@ function PageSegmentTreeLayerPresentation({\n               ...{ paddingLeft: `${(level + 1) * 8}px` },\n             }}\n           >\n-            <div className=\"segment-explorer-line\">\n-              <div className={`segment-explorer-line-text-${nodeName}`}>\n-                <div className=\"segment-explorer-filename\">\n-                  {folderName && (\n-                    <span className=\"segment-explorer-filename--path\">\n-                      {folderName}\n-                      {/* hidden slashes for testing snapshots */}\n-                      <small>{'/'}</small>\n-                    </span>\n-                  )}\n-                  {/* display all the file segments in this level */}\n-                  {filesChildrenKeys.length > 0 && (\n-                    <span className=\"segment-explorer-files\">\n-                      {filesChildrenKeys.map((fileChildSegment) => {\n-                        const childNode = node.children[fileChildSegment]\n-                        if (!childNode || !childNode.value) {\n-                          return null\n-                        }\n-                        const fileName =\n-                          childNode.value.pagePath.split('/').pop() || ''\n-                        return (\n-                          <span\n-                            key={fileChildSegment}\n-                            className={cx(\n-                              'segment-explorer-file-label',\n-                              `segment-explorer-file-label--${childNode.value.type}`\n-                            )}\n-                          >\n-                            {fileName}\n-                          </span>\n-                        )\n-                      })}\n-                    </span>\n-                  )}\n-                </div>\n-              </div>\n+            <div className=\"segment-explorer-filename\">\n+              {folderName && (\n+                <span className=\"segment-explorer-filename--path\">\n+                  {folderName}\n+                  {/* hidden slashes for testing snapshots */}\n+                  <small>{'/'}</small>\n+                </span>\n+              )}\n+              {/* display all the file segments in this level */}\n+              {filesChildrenKeys.length > 0 && (\n+                <span className=\"segment-explorer-files\">\n+                  {filesChildrenKeys.map((fileChildSegment) => {\n+                    const childNode = node.children[fileChildSegment]\n+                    if (!childNode || !childNode.value) {\n+                      return null\n+                    }\n+                    const fileName =\n+                      childNode.value.pagePath.split('/').pop() || ''\n+                    return (\n+                      <span\n+                        key={fileChildSegment}\n+                        className={cx(\n+                          'segment-explorer-file-label',\n+                          `segment-explorer-file-label--${childNode.value.type}`\n+                        )}\n+                      >\n+                        {fileName}\n+                      </span>\n+                    )\n+                  })}\n+                </span>\n+              )}\n             </div>\n           </div>\n         </div>\n@@ -190,7 +185,6 @@ export function SegmentsExplorer({\n \n export const DEV_TOOLS_INFO_RENDER_FILES_STYLES = css`\n   .segment-explorer-content {\n-    overflow-y: auto;\n     font-size: var(--size-14);\n     margin: -12px -8px;\n   }\n@@ -210,6 +204,9 @@ export const DEV_TOOLS_INFO_RENDER_FILES_STYLES = css`\n     padding-top: 10px;\n     padding-bottom: 10px;\n     padding-right: 4px;\n+    white-space: pre;\n+    cursor: default;\n+    color: var(--color-gray-1000);\n   }\n \n   .segment-explorer-children--intended {\n@@ -232,15 +229,6 @@ export const DEV_TOOLS_INFO_RENDER_FILES_STYLES = css`\n     color: var(--color-gray-800);\n   }\n \n-  .segment-explorer-line {\n-    white-space: pre;\n-    cursor: default;\n-  }\n-\n-  .segment-explorer-line {\n-    color: var(--color-gray-1000);\n-  }\n-\n   .segment-explorer-files {\n     display: inline-flex;\n     gap: 8px;"
        },
        {
            "sha": "df8b7becfe88321ced4b8de192bb866861a68016",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd",
            "patch": "@@ -1033,7 +1033,10 @@ function normalizeConventionFilePath(\n   conventionPath: string | undefined\n ) {\n   const cwd = process.env.NEXT_RUNTIME === 'edge' ? '' : process.cwd()\n-  const relativePath = (conventionPath || '')\n+  const nextInternalPrefixRegex =\n+    /^(.*[\\\\/])?next[\\\\/]dist[\\\\/]client[\\\\/]components[\\\\/]/\n+\n+  let relativePath = (conventionPath || '')\n     // remove turbopack [project] prefix\n     .replace(/^\\[project\\][\\\\/]/, '')\n     // remove the project root from the path\n@@ -1043,6 +1046,11 @@ function normalizeConventionFilePath(\n     // remove /(src/)?app/ dir prefix\n     .replace(/^([\\\\/])*(src[\\\\/])?app[\\\\/]/, '')\n \n+  // If it's internal file only keep the filename, strip nextjs internal prefix\n+  if (nextInternalPrefixRegex.test(relativePath)) {\n+    relativePath = relativePath.replace(nextInternalPrefixRegex, '')\n+  }\n+\n   return relativePath\n }\n "
        },
        {
            "sha": "c4499f244949d531f9f9d0e0e8b621b956062dfa",
            "filename": "test/development/app-dir/segment-explorer/app/page.tsx",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fpage.tsx?ref=5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd",
            "patch": "@@ -0,0 +1,24 @@\n+import Link from 'next/link'\n+\n+const hrefs = [\n+  '/parallel-routes',\n+  '/blog/~/grid',\n+  '/soft-navigation/a',\n+  '/file-segments',\n+]\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <h1>Segment Explorer</h1>\n+      <p>Examples</p>\n+      <div>\n+        {hrefs.map((href) => (\n+          <div key={href}>\n+            <Link href={href}>{href}</Link>\n+          </div>\n+        ))}\n+      </div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "22b2c3e4065c2a9d4bdf4f2f0bd0b6c6547470a6",
            "filename": "test/development/app-dir/segment-explorer/app/runtime-error/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fruntime-error%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fruntime-error%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fruntime-error%2Fpage.tsx?ref=5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+\n+export default function Page() {\n+  if (typeof window !== 'undefined') {\n+    throw new Error('Error on client')\n+  }\n+  return <p>page</p>\n+}"
        },
        {
            "sha": "74194ccb4f128f8c1bb8c4f00d91ee709cc1c72e",
            "filename": "test/development/app-dir/segment-explorer/segment-explorer.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts?ref=5771ce12f8a0ca3ee0b1e82df6c78cc9f4ced1dd",
            "patch": "@@ -114,4 +114,13 @@ describe('segment-explorer', () => {\n       `\"Route Info currently is only available for the App Router.\"`\n     )\n   })\n+\n+  it('should handle special built-in not-found segments', async () => {\n+    const browser = await next.browser('/404')\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n+     \"app/\n+     layout.tsx\n+     not-found-error.js\"\n+    `)\n+  })\n })"
        }
    ],
    "stats": {
        "total": 142,
        "additions": 90,
        "deletions": 52
    }
}