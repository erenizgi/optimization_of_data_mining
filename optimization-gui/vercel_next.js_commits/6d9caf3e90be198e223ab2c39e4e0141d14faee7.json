{
    "author": "ztanner",
    "message": "fix: incorrect canonicalUrl set when using output: export (#85019)\n\nAfter the changes in\nhttps://github.com/vercel/next.js/commit/5ccc9078e094215e6c891c38a31fb94cda03456e,\nwhen in `output: 'export'` mode, the `canonicalUrl` value was getting\ncorrupted to be set to one of the URLs of the RSC responses (eg\n`/another.txt`). This is because the original `url` gets mutated to\nappend a `.txt` extension for the RSC requests.\n\nThis ensures we preserve the original canonical URL so it doesn't get\ncorrupted when we mutate the pathname.\n\nFailing test ref:\nhttps://github.com/vercel/next.js/actions/runs/18607156298/job/53060147186#step:34:151",
    "sha": "6d9caf3e90be198e223ab2c39e4e0141d14faee7",
    "files": [
        {
            "sha": "1ba1742fe21cd5e824f0f974c783c0e4aa165d68",
            "filename": "packages/next/src/client/components/router-reducer/fetch-server-response.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/6d9caf3e90be198e223ab2c39e4e0141d14faee7/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6d9caf3e90be198e223ab2c39e4e0141d14faee7/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts?ref=6d9caf3e90be198e223ab2c39e4e0141d14faee7",
            "patch": "@@ -158,6 +158,10 @@ export async function fetchServerResponse(\n     headers[NEXT_URL] = nextUrl\n   }\n \n+  // In static export mode, we need to modify the URL to request the .txt file,\n+  // but we should preserve the original URL for the canonical URL and error handling.\n+  const originalUrl = url\n+\n   try {\n     // When creating a \"temporary\" prefetch (the \"on-demand\" prefetch that gets created on navigation, if one doesn't exist)\n     // we send the request with a \"high\" priority as it's in response to a user interaction that could be blocking a transition.\n@@ -198,7 +202,7 @@ export async function fetchServerResponse(\n     )\n \n     const responseUrl = urlToUrlWithoutFlightMarker(new URL(res.url))\n-    const canonicalUrl = res.redirected ? responseUrl : url\n+    const canonicalUrl = res.redirected ? responseUrl : originalUrl\n \n     const contentType = res.headers.get('content-type') || ''\n     const interception = !!res.headers.get('vary')?.includes(NEXT_URL)\n@@ -285,15 +289,15 @@ export async function fetchServerResponse(\n   } catch (err) {\n     if (!abortController.signal.aborted) {\n       console.error(\n-        `Failed to fetch RSC payload for ${url}. Falling back to browser navigation.`,\n+        `Failed to fetch RSC payload for ${originalUrl}. Falling back to browser navigation.`,\n         err\n       )\n     }\n \n     // If fetch fails handle it like a mpa navigation\n     // TODO-APP: Add a test for the case where a CORS request fails, e.g. external url redirect coming from the response.\n     // See https://github.com/vercel/next.js/issues/43605#issuecomment-1451617521 for a reproduction.\n-    return url.toString()\n+    return originalUrl.toString()\n   }\n }\n "
        }
    ],
    "stats": {
        "total": 10,
        "additions": 7,
        "deletions": 3
    }
}