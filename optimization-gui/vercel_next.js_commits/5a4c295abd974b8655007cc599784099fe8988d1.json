{
    "author": "gnoff",
    "message": "[Cache Components] Dim logs after prerender aborts (#84153)\n\nWhen prerenders abort we reject hanging promises so resources can clean\nup. This can lead to user code which logs errors from rejections\nreporting many more errors than expected and these logs are for\nsemantically irrelevant errors.\n\nTo make it clearer that these errors are not semantically relevant we\nwill dim them. This is a partial solution because 3rd party loggers will\nnot necessarily interpret this and so these logs might continue to show\nup as normal logs in donwstream systems. We may need to ask that\nconsumers of these logs interpret the dimmed nature and convey this\nstatus to the viewer.\n\nWe will follow up this work with a config that allows you to hide logs\nfrom aborted prerenders. This will completely suppress their emission to\nthe underlying log system but it will run after any userland patches so\nyou could still end up reporting errors for instance to an otel\ncollector because the filtering would be applied after not before. The\nright way to solve this is for the log to check if there is a react\ncacheSignal that is aborted and do their own suppresion.",
    "sha": "5a4c295abd974b8655007cc599784099fe8988d1",
    "files": [
        {
            "sha": "cd9d8c0a4f4391c4e16dc4735847e0b2388ca654",
            "filename": ".vscode/settings.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/.vscode%2Fsettings.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/.vscode%2Fsettings.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.vscode%2Fsettings.json?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -62,7 +62,7 @@\n     \"packages/next/src/server/app-render/dynamic-access-async-storage-instance.ts\",\n     \"packages/next/src/server/app-render/work-async-storage-instance.ts\",\n     \"packages/next/src/server/app-render/work-unit-async-storage-instance.ts\",\n-    \"packages/next/src/server/app-render/dev-logs-async-storage-instance.ts\",\n+    \"packages/next/src/server/app-render/console-async-storage-instance.ts\",\n     \"packages/next/src/client/components/segment-cache-impl/*\"\n   ],\n   // Disable TypeScript surveys."
        },
        {
            "sha": "7d2510320eb892b76af2e7c001900f6ef60b6895",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -174,7 +174,7 @@ import {\n   workUnitAsyncStorage,\n   type PrerenderStore,\n } from './work-unit-async-storage.external'\n-import { devLogsAsyncStorage } from './dev-logs-async-storage.external'\n+import { consoleAsyncStorage } from './console-async-storage.external'\n import { CacheSignal } from './cache-signal'\n import { getTracedMetadata } from '../lib/trace/utils'\n import { InvariantError } from '../../shared/lib/invariant-error'\n@@ -2309,7 +2309,7 @@ async function renderToStream(\n         }\n       )\n \n-      devLogsAsyncStorage.run(\n+      consoleAsyncStorage.run(\n         { dim: true },\n         spawnDynamicValidationInDev,\n         resolveValidation,"
        },
        {
            "sha": "7ef5d887128886162a2efc64ae7ee994eb17a583",
            "filename": "packages/next/src/server/app-render/console-async-storage-instance.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fconsole-async-storage-instance.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fconsole-async-storage-instance.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fconsole-async-storage-instance.ts?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -0,0 +1,5 @@\n+import { createAsyncLocalStorage } from './async-local-storage'\n+import type { ConsoleAsyncStorage } from './console-async-storage.external'\n+\n+export const consoleAsyncStorageInstance: ConsoleAsyncStorage =\n+  createAsyncLocalStorage()"
        },
        {
            "sha": "5606b998083391bc3e497ccba5f4e9ebb4b4321b",
            "filename": "packages/next/src/server/app-render/console-async-storage.external.ts",
            "status": "renamed",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fconsole-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fconsole-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fconsole-async-storage.external.ts?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -1,9 +1,9 @@\n import type { AsyncLocalStorage } from 'async_hooks'\n \n // Share the instance module in the next-shared layer\n-import { devLogsAsyncStorageInstance } from './dev-logs-async-storage-instance' with { 'turbopack-transition': 'next-shared' }\n+import { consoleAsyncStorageInstance } from './console-async-storage-instance' with { 'turbopack-transition': 'next-shared' }\n \n-export interface DevLogsStore {\n+export interface ConsoleStore {\n   /**\n    * if true the color of logs output will be dimmed to indicate the log is\n    * from a repeat or validation render that is not typically relevant to\n@@ -12,6 +12,6 @@ export interface DevLogsStore {\n   readonly dim: boolean\n }\n \n-export type DevLogsAsyncStorage = AsyncLocalStorage<DevLogsStore>\n+export type ConsoleAsyncStorage = AsyncLocalStorage<ConsoleStore>\n \n-export { devLogsAsyncStorageInstance as devLogsAsyncStorage }\n+export { consoleAsyncStorageInstance as consoleAsyncStorage }",
            "previous_filename": "packages/next/src/server/app-render/dev-logs-async-storage.external.ts"
        },
        {
            "sha": "fd9282c1fee403c4aadd8e0b957af8ccbccd25d5",
            "filename": "packages/next/src/server/app-render/dev-logs-async-storage-instance.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c781f40bd149c7714f05906be171a79dc507eaed/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdev-logs-async-storage-instance.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c781f40bd149c7714f05906be171a79dc507eaed/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdev-logs-async-storage-instance.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdev-logs-async-storage-instance.ts?ref=c781f40bd149c7714f05906be171a79dc507eaed",
            "patch": "@@ -1,5 +0,0 @@\n-import { createAsyncLocalStorage } from './async-local-storage'\n-import type { DevLogsAsyncStorage } from './dev-logs-async-storage.external'\n-\n-export const devLogsAsyncStorageInstance: DevLogsAsyncStorage =\n-  createAsyncLocalStorage()"
        },
        {
            "sha": "fc46b5e5cb11cdc8ff58336dbad4f2487723b6b7",
            "filename": "packages/next/src/server/node-environment-extensions/console-dev.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 206,
            "changes": 206,
            "blob_url": "https://github.com/vercel/next.js/blob/c781f40bd149c7714f05906be171a79dc507eaed/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dev.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c781f40bd149c7714f05906be171a79dc507eaed/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dev.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dev.tsx?ref=c781f40bd149c7714f05906be171a79dc507eaed",
            "patch": "@@ -1,206 +0,0 @@\n-import { dim } from '../../lib/picocolors'\n-import { devLogsAsyncStorage } from '../app-render/dev-logs-async-storage.external'\n-import { getFileLogger } from '../dev/browser-logs/file-logger'\n-import { formatConsoleArgs } from '../../client/lib/console'\n-\n-type InterceptableConsoleMethod =\n-  | 'error'\n-  | 'assert'\n-  | 'debug'\n-  | 'dir'\n-  | 'dirxml'\n-  | 'group'\n-  | 'groupCollapsed'\n-  | 'groupEnd'\n-  | 'info'\n-  | 'log'\n-  | 'table'\n-  | 'trace'\n-  | 'warn'\n-\n-const isColorSupported = dim('test') !== 'test'\n-\n-// 50% opacity for dimmed text\n-const dimStyle = 'color: color(from currentColor xyz x y z / 0.5);'\n-const reactBadgeFormat = '\\x1b[0m\\x1b[7m%c%s\\x1b[0m%c '\n-\n-function dimmedConsoleArgs(...inputArgs: any[]): any[] {\n-  if (!isColorSupported) {\n-    return inputArgs\n-  }\n-\n-  const newArgs = inputArgs.slice(0)\n-  let template = ''\n-  let argumentsPointer = 0\n-  if (typeof inputArgs[0] === 'string') {\n-    const originalTemplateString = inputArgs[0]\n-    // Remove the original template string from the args.\n-    newArgs.splice(argumentsPointer, 1)\n-    argumentsPointer += 1\n-\n-    let i = 0\n-    if (originalTemplateString.startsWith(reactBadgeFormat)) {\n-      i = reactBadgeFormat.length\n-      // for `format` we already moved the pointer earlier\n-      // style, badge, reset style\n-      argumentsPointer += 3\n-      template += reactBadgeFormat\n-      // React's badge reset styles, reapply dimming\n-      template += '\\x1b[2m%c'\n-      // argumentsPointer includes template\n-      newArgs.splice(argumentsPointer - 1, 0, dimStyle)\n-      // dim the badge\n-      newArgs[0] += `;${dimStyle}`\n-    }\n-\n-    for (i; i < originalTemplateString.length; i++) {\n-      const currentChar = originalTemplateString[i]\n-      if (currentChar !== '%') {\n-        template += currentChar\n-        continue\n-      }\n-\n-      const nextChar = originalTemplateString[i + 1]\n-      ++i\n-\n-      switch (nextChar) {\n-        case 'f':\n-        case 'O':\n-        case 'o':\n-        case 'd':\n-        case 's':\n-        case 'i':\n-        case 'c':\n-          ++argumentsPointer\n-          template += `%${nextChar}`\n-          break\n-        default:\n-          template += `%${nextChar}`\n-      }\n-    }\n-  }\n-\n-  for (\n-    argumentsPointer;\n-    argumentsPointer < inputArgs.length;\n-    ++argumentsPointer\n-  ) {\n-    const arg = inputArgs[argumentsPointer]\n-    const argType = typeof arg\n-    if (argumentsPointer > 0) {\n-      template += ' '\n-    }\n-    switch (argType) {\n-      case 'boolean':\n-      case 'string':\n-        template += '%s'\n-        break\n-      case 'bigint':\n-        template += '%s'\n-        break\n-      case 'number':\n-        if (arg % 0) {\n-          template += '%f'\n-        } else {\n-          template += '%d'\n-        }\n-        break\n-      case 'object':\n-        template += '%O'\n-        break\n-      case 'symbol':\n-      case 'undefined':\n-      case 'function':\n-        template += '%s'\n-        break\n-      default:\n-        // deopt to string for new, unknown types\n-        template += '%s'\n-    }\n-  }\n-\n-  template += '\\x1b[22m'\n-\n-  return [dim(`%c${template}`), dimStyle, ...newArgs]\n-}\n-\n-function dimConsoleCall(\n-  methodName: InterceptableConsoleMethod,\n-  args: any[]\n-): any[] {\n-  switch (methodName) {\n-    case 'dir':\n-    case 'dirxml':\n-    case 'group':\n-    case 'groupCollapsed':\n-    case 'groupEnd':\n-    case 'table': {\n-      // These methods cannot be colorized because they don't take a formatting string.\n-      return args\n-    }\n-    case 'assert': {\n-      // assert takes formatting options as the second argument.\n-      return [args[0]].concat(...dimmedConsoleArgs(args[1], ...args.slice(2)))\n-    }\n-    case 'error':\n-    case 'debug':\n-    case 'info':\n-    case 'log':\n-    case 'trace':\n-    case 'warn':\n-      return dimmedConsoleArgs(args[0], ...args.slice(1))\n-    default:\n-      return methodName satisfies never\n-  }\n-}\n-\n-// Based on https://github.com/facebook/react/blob/28dc0776be2e1370fe217549d32aee2519f0cf05/packages/react-server/src/ReactFlightServer.js#L248\n-function patchConsoleMethodDEV(methodName: InterceptableConsoleMethod): void {\n-  const descriptor = Object.getOwnPropertyDescriptor(console, methodName)\n-  if (\n-    descriptor &&\n-    (descriptor.configurable || descriptor.writable) &&\n-    typeof descriptor.value === 'function'\n-  ) {\n-    const originalMethod = descriptor.value\n-    const originalName = Object.getOwnPropertyDescriptor(originalMethod, 'name')\n-    const wrapperMethod = function (this: typeof console, ...args: any[]) {\n-      const devLogsStore = devLogsAsyncStorage.getStore()\n-\n-      if (devLogsStore?.dim === true) {\n-        return originalMethod.apply(this, dimConsoleCall(methodName, args))\n-      } else {\n-        const ret = originalMethod.apply(this, args)\n-\n-        const fileLogger = getFileLogger()\n-        const message = formatConsoleArgs(args)\n-        // Strip ANSI escape codes for file logging\n-        // eslint-disable-next-line no-control-regex\n-        const ansiEscapeRegex = new RegExp('\\u001b\\\\[[0-9;]*m', 'g')\n-        const cleanMessage = message.replace(ansiEscapeRegex, '')\n-        fileLogger.logServer(methodName.toUpperCase(), cleanMessage)\n-        return ret\n-      }\n-    }\n-    if (originalName) {\n-      Object.defineProperty(wrapperMethod, 'name', originalName)\n-    }\n-    Object.defineProperty(console, methodName, {\n-      value: wrapperMethod,\n-    })\n-  }\n-}\n-\n-patchConsoleMethodDEV('error')\n-patchConsoleMethodDEV('assert')\n-patchConsoleMethodDEV('debug')\n-patchConsoleMethodDEV('dir')\n-patchConsoleMethodDEV('dirxml')\n-patchConsoleMethodDEV('group')\n-patchConsoleMethodDEV('groupCollapsed')\n-patchConsoleMethodDEV('groupEnd')\n-patchConsoleMethodDEV('info')\n-patchConsoleMethodDEV('log')\n-patchConsoleMethodDEV('table')\n-patchConsoleMethodDEV('trace')\n-patchConsoleMethodDEV('warn')"
        },
        {
            "sha": "6fa27fd78f51524e5166ce6121ba7271efbc2f66",
            "filename": "packages/next/src/server/node-environment-extensions/console-dim.external.test.ts",
            "status": "added",
            "additions": 350,
            "deletions": 0,
            "changes": 350,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.test.ts?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -0,0 +1,350 @@\n+/**\n+ * Testing console patching in Jest requires isolation since console methods are heavily used\n+ * by the test runner itself. We use the same worker thread strategy as unhandled-rejection.test.ts\n+ * to ensure our patches don't interfere with Jest's own console usage.\n+ *\n+ * @jest-environment node\n+ */\n+\n+/* eslint-disable @next/internal/typechecked-require */\n+\n+type ReportableResult =\n+  | ConsoleCallReport\n+  | ErrorReport\n+  | OutputReport\n+  | SerializableDataReport\n+\n+type ConsoleCallReport = {\n+  type: 'console-call'\n+  method: string\n+  input: string\n+}\n+\n+type ErrorReport = { type: 'error'; message: string }\n+type OutputReport = { type: 'output'; message: string }\n+type SerializableDataReport = {\n+  type: 'serialized'\n+  key: string\n+  data: string | number | boolean\n+}\n+\n+declare global {\n+  function reportResult(result: ReportableResult): void\n+}\n+\n+import { Worker } from 'node:worker_threads'\n+\n+type WorkerResult = {\n+  exitCode: number\n+  stderr: string\n+  consoleCalls: Array<{ method: string; input: string }>\n+  data: Record<string, unknown>\n+  messages: Array<ReportableResult>\n+}\n+\n+export function runWorkerCode(fn: Function): Promise<WorkerResult> {\n+  return new Promise((resolve, reject) => {\n+    const script = `\n+      const { parentPort } = require('node:worker_threads');\n+      (async () => {\n+        const { AsyncLocalStorage } = require('node:async_hooks');\n+        // We need to put this on the global because Next.js does not import it\n+        // from node directly to be compatible with edge runtimes.\n+        globalThis.AsyncLocalStorage = AsyncLocalStorage;\n+\n+        global.reportResult = (value) => {\n+          parentPort?.postMessage(value);\n+        };\n+\n+        const fn = (${fn.toString()});\n+        try {\n+          const out = await fn();\n+          await new Promise(r => setImmediate(r));\n+          reportResult({ type: 'result', out });\n+        } catch (e) {\n+          reportResult({ type: 'error', message: String(e && e.message || e) });\n+        }\n+      })();\n+    `\n+\n+    const w = new Worker(script, {\n+      eval: true,\n+      workerData: null,\n+      argv: [],\n+      execArgv: ['--conditions=react-server'],\n+      stderr: true,\n+      stdout: false,\n+      env: {\n+        FORCE_COLOR: '1',\n+      },\n+    })\n+\n+    const messages: Array<ReportableResult> = []\n+    const consoleCalls: Array<{ method: string; input: string }> = []\n+    const data = {} as Record<string, unknown>\n+    let stderr = ''\n+\n+    w.on('message', (m) => {\n+      messages.push(m)\n+      switch (m.type) {\n+        case 'console-call':\n+          consoleCalls.push({\n+            method: m.method,\n+            input: m.input,\n+          })\n+          break\n+        case 'serialized':\n+          data[m.key] = JSON.parse(m.data)\n+          break\n+        default:\n+          break\n+      }\n+    })\n+    w.on('error', (err) => console.error('Worker error', err))\n+    w.on('error', reject)\n+    w.stderr?.on('data', (b) => (stderr += String(b)))\n+    w.on('exit', (code) =>\n+      resolve({\n+        exitCode: code ?? -1,\n+        consoleCalls,\n+        data,\n+        messages,\n+        stderr,\n+      })\n+    )\n+  })\n+}\n+\n+describe('console-exit patches', () => {\n+  describe('basic functionality', () => {\n+    it('should patch console methods to dim when instructed', async () => {\n+      async function testForWorker() {\n+        const {\n+          consoleAsyncStorage,\n+        } = require('next/dist/server/app-render/console-async-storage.external')\n+\n+        // First, replace console.log to track what storage context it runs in\n+        console.log = function (...args) {\n+          let dimmed = false\n+          if (\n+            args.find((a) =>\n+              typeof a === 'string' ? a.includes('color:') : false\n+            )\n+          ) {\n+            dimmed = true\n+          }\n+          reportResult({\n+            type: 'console-call',\n+            method: 'log',\n+            input: `${dimmed ? '[DIM]' : '[BRIGHT]'}: ${args.join(' ')}`,\n+          })\n+        }\n+\n+        // Install patches - this wraps the current console.log\n+        require('next/dist/server/node-environment-extensions/console-dim.external')\n+\n+        // Test outside storage context\n+        console.log('outside')\n+\n+        consoleAsyncStorage.run({ dim: true }, () => {\n+          console.log('inside')\n+        })\n+      }\n+\n+      const { consoleCalls, exitCode } = await runWorkerCode(testForWorker)\n+\n+      expect(exitCode).toBe(0)\n+      // Both should show [No Store] because the wrapped console.log exits storage\n+      expect(consoleCalls).toEqual([\n+        { method: 'log', input: '[BRIGHT]: outside' },\n+        // can't match the formatting characters easily\n+        { method: 'log', input: expect.stringMatching(/\\[DIM\\].*inside/) },\n+      ])\n+    })\n+\n+    it('should not wrap console methods assigned after patching', async () => {\n+      async function testForWorker() {\n+        const {\n+          consoleAsyncStorage,\n+        } = require('next/dist/server/app-render/console-async-storage.external')\n+\n+        // Install patches first\n+        require('next/dist/server/node-environment-extensions/console-dim.external')\n+\n+        // Assign a new console.log after patching - this will NOT be wrapped\n+        console.log = function (...args) {\n+          let dimmed = false\n+          if (\n+            args.find((a) =>\n+              typeof a === 'string' ? a.includes('color:') : false\n+            )\n+          ) {\n+            dimmed = true\n+          }\n+          reportResult({\n+            type: 'console-call',\n+            method: 'log',\n+            input: `${dimmed ? '[DIM]' : '[BRIGHT]'}: ${args.join(' ')}`,\n+          })\n+        }\n+\n+        // Test outside storage context\n+        console.log('outside')\n+\n+        consoleAsyncStorage.run({ dim: true }, () => {\n+          console.log('inside')\n+        })\n+      }\n+\n+      const { consoleCalls, exitCode } = await runWorkerCode(testForWorker)\n+\n+      expect(exitCode).toBe(0)\n+      // New assignments after patching are NOT wrapped, so they preserve storage context\n+      expect(consoleCalls).toEqual([\n+        { method: 'log', input: '[BRIGHT]: outside' },\n+        { method: 'log', input: '[BRIGHT]: inside' },\n+      ])\n+    })\n+\n+    it('should preserve function properties and behavior', async () => {\n+      async function testForWorker() {\n+        reportResult({\n+          type: 'serialized',\n+          key: 'originalName',\n+          data: JSON.stringify(console.log.name),\n+        })\n+\n+        reportResult({\n+          type: 'serialized',\n+          key: 'originalLength',\n+          data: JSON.stringify(console.log.length),\n+        })\n+\n+        // install patch\n+        require('next/dist/server/node-environment-extensions/console-dim.external')\n+\n+        // Test that patched methods preserve name and other properties\n+        reportResult({\n+          type: 'serialized',\n+          key: 'patchedName',\n+          data: JSON.stringify(console.log.name),\n+        })\n+\n+        reportResult({\n+          type: 'serialized',\n+          key: 'patchedLength',\n+          data: JSON.stringify(console.log.length),\n+        })\n+      }\n+\n+      const { data, exitCode } = await runWorkerCode(testForWorker)\n+\n+      expect(exitCode).toBe(0)\n+      expect(data.patchedName).toBe('log')\n+      expect(data.patchedName).toBe(data.originalName)\n+      expect(data.patchedLength).toBe(data.originalLength)\n+    })\n+\n+    it('should enter a dimming context when a prerender store exists with an aborted renderSignal', async () => {\n+      async function testForWorker() {\n+        const {\n+          workUnitAsyncStorage,\n+        } = require('next/dist/server/app-render/work-unit-async-storage.external')\n+\n+        // First, replace console.log to track what storage context it runs in\n+        console.log = function (...args) {\n+          let dimmed = false\n+          if (\n+            args.find((a) =>\n+              typeof a === 'string' ? a.includes('color:') : false\n+            )\n+          ) {\n+            dimmed = true\n+          }\n+          reportResult({\n+            type: 'console-call',\n+            method: 'log',\n+            input: `${dimmed ? '[DIM]' : '[BRIGHT]'}: ${args.join(' ')}`,\n+          })\n+        }\n+\n+        // Install patches - this wraps the current console.log\n+        require('next/dist/server/node-environment-extensions/console-dim.external')\n+\n+        // Test outside storage context\n+        console.log('outside')\n+\n+        const controller = new AbortController()\n+\n+        workUnitAsyncStorage.run(\n+          { type: 'prerender', renderSignal: controller.signal },\n+          () => {\n+            console.log('before abort')\n+            controller.abort()\n+            console.log('after abort')\n+          }\n+        )\n+      }\n+\n+      const { consoleCalls, exitCode } = await runWorkerCode(testForWorker)\n+\n+      expect(exitCode).toBe(0)\n+      // Both should show [No Store] because the wrapped console.log exits storage\n+      expect(consoleCalls).toEqual([\n+        { method: 'log', input: '[BRIGHT]: outside' },\n+        { method: 'log', input: '[BRIGHT]: before abort' },\n+        { method: 'log', input: expect.stringMatching(/\\[DIM\\].*after abort/) },\n+      ])\n+    })\n+\n+    it('should enter a dimming context when a react cacheSignal exists and is aborted', async () => {\n+      async function testForWorker() {\n+        const originalLog = console.log\n+        let controller: null | AbortController = new AbortController()\n+\n+        // First, replace console.log to track what storage context it runs in\n+        console.log = function (...args) {\n+          originalLog(...args)\n+          let dimmed = false\n+          if (\n+            args.find((a) =>\n+              typeof a === 'string' ? a.includes('color:') : false\n+            )\n+          ) {\n+            dimmed = true\n+          }\n+          reportResult({\n+            type: 'console-call',\n+            method: 'log',\n+            input: `${dimmed ? '[DIM]' : '[BRIGHT]'}: ${args.join(' ')}`,\n+          })\n+        }\n+\n+        // Install patches - this wraps the current console.log\n+        const {\n+          registerGetCacheSignal,\n+        } = require('next/dist/server/node-environment-extensions/console-dim.external')\n+\n+        registerGetCacheSignal(() => null)\n+        registerGetCacheSignal(() => controller?.signal)\n+        registerGetCacheSignal(() => null)\n+\n+        console.log('before abort')\n+        controller.abort()\n+        console.log('after abort')\n+\n+        controller = null\n+        console.log('with null signal')\n+      }\n+\n+      const { consoleCalls, exitCode } = await runWorkerCode(testForWorker)\n+\n+      expect(exitCode).toBe(0)\n+      expect(consoleCalls).toEqual([\n+        { method: 'log', input: '[BRIGHT]: before abort' },\n+        { method: 'log', input: expect.stringMatching(/\\[DIM\\].*after abort/) },\n+        { method: 'log', input: '[BRIGHT]: with null signal' },\n+      ])\n+    })\n+  })\n+})"
        },
        {
            "sha": "d2454de516ac187b71301ba3c8d3f92984bec477",
            "filename": "packages/next/src/server/node-environment-extensions/console-dim.external.tsx",
            "status": "added",
            "additions": 289,
            "deletions": 0,
            "changes": 289,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.tsx?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -0,0 +1,289 @@\n+import { dim } from '../../lib/picocolors'\n+import {\n+  consoleAsyncStorage,\n+  type ConsoleStore,\n+} from '../app-render/console-async-storage.external'\n+import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\n+\n+type GetCacheSignal = () => AbortSignal | null\n+const cacheSignals: Array<GetCacheSignal> = []\n+export function registerGetCacheSignal(getSignal: GetCacheSignal): void {\n+  cacheSignals.push(getSignal)\n+}\n+\n+type InterceptableConsoleMethod =\n+  | 'error'\n+  | 'assert'\n+  | 'debug'\n+  | 'dir'\n+  | 'dirxml'\n+  | 'group'\n+  | 'groupCollapsed'\n+  | 'groupEnd'\n+  | 'info'\n+  | 'log'\n+  | 'table'\n+  | 'trace'\n+  | 'warn'\n+\n+const isColorSupported = dim('test') !== 'test'\n+\n+// 50% opacity for dimmed text\n+const dimStyle = 'color: color(from currentColor xyz x y z / 0.5);'\n+const reactBadgeFormat = '\\x1b[0m\\x1b[7m%c%s\\x1b[0m%c '\n+\n+function dimmedConsoleArgs(...inputArgs: any[]): any[] {\n+  if (!isColorSupported) {\n+    return inputArgs\n+  }\n+\n+  const newArgs = inputArgs.slice(0)\n+  let template = ''\n+  let argumentsPointer = 0\n+  if (typeof inputArgs[0] === 'string') {\n+    const originalTemplateString = inputArgs[0]\n+    // Remove the original template string from the args.\n+    newArgs.splice(argumentsPointer, 1)\n+    argumentsPointer += 1\n+\n+    let i = 0\n+    if (originalTemplateString.startsWith(reactBadgeFormat)) {\n+      i = reactBadgeFormat.length\n+      // for `format` we already moved the pointer earlier\n+      // style, badge, reset style\n+      argumentsPointer += 3\n+      template += reactBadgeFormat\n+      // React's badge reset styles, reapply dimming\n+      template += '\\x1b[2m%c'\n+      // argumentsPointer includes template\n+      newArgs.splice(argumentsPointer - 1, 0, dimStyle)\n+      // dim the badge\n+      newArgs[0] += `;${dimStyle}`\n+    }\n+\n+    for (i; i < originalTemplateString.length; i++) {\n+      const currentChar = originalTemplateString[i]\n+      if (currentChar !== '%') {\n+        template += currentChar\n+        continue\n+      }\n+\n+      const nextChar = originalTemplateString[i + 1]\n+      ++i\n+\n+      switch (nextChar) {\n+        case 'f':\n+        case 'O':\n+        case 'o':\n+        case 'd':\n+        case 's':\n+        case 'i':\n+        case 'c':\n+          ++argumentsPointer\n+          template += `%${nextChar}`\n+          break\n+        default:\n+          template += `%${nextChar}`\n+      }\n+    }\n+  }\n+\n+  for (\n+    argumentsPointer;\n+    argumentsPointer < inputArgs.length;\n+    ++argumentsPointer\n+  ) {\n+    const arg = inputArgs[argumentsPointer]\n+    const argType = typeof arg\n+    if (argumentsPointer > 0) {\n+      template += ' '\n+    }\n+    switch (argType) {\n+      case 'boolean':\n+      case 'string':\n+        template += '%s'\n+        break\n+      case 'bigint':\n+        template += '%s'\n+        break\n+      case 'number':\n+        if (arg % 0) {\n+          template += '%f'\n+        } else {\n+          template += '%d'\n+        }\n+        break\n+      case 'object':\n+        template += '%O'\n+        break\n+      case 'symbol':\n+      case 'undefined':\n+      case 'function':\n+        template += '%s'\n+        break\n+      default:\n+        // deopt to string for new, unknown types\n+        template += '%s'\n+    }\n+  }\n+\n+  template += '\\x1b[22m'\n+\n+  return [dim(`%c${template}`), dimStyle, ...newArgs]\n+}\n+\n+function convertToDimmedArgs(\n+  methodName: InterceptableConsoleMethod,\n+  args: any[]\n+): any[] {\n+  switch (methodName) {\n+    case 'dir':\n+    case 'dirxml':\n+    case 'group':\n+    case 'groupCollapsed':\n+    case 'groupEnd':\n+    case 'table': {\n+      // These methods cannot be colorized because they don't take a formatting string.\n+      return args\n+    }\n+    case 'assert': {\n+      // assert takes formatting options as the second argument.\n+      return [args[0]].concat(...dimmedConsoleArgs(args[1], ...args.slice(2)))\n+    }\n+    case 'error':\n+    case 'debug':\n+    case 'info':\n+    case 'log':\n+    case 'trace':\n+    case 'warn':\n+      return dimmedConsoleArgs(args[0], ...args.slice(1))\n+    default:\n+      return methodName satisfies never\n+  }\n+}\n+\n+// Based on https://github.com/facebook/react/blob/28dc0776be2e1370fe217549d32aee2519f0cf05/packages/react-server/src/ReactFlightServer.js#L248\n+function patchConsoleMethod(methodName: InterceptableConsoleMethod): void {\n+  const descriptor = Object.getOwnPropertyDescriptor(console, methodName)\n+  if (\n+    descriptor &&\n+    (descriptor.configurable || descriptor.writable) &&\n+    typeof descriptor.value === 'function'\n+  ) {\n+    const originalMethod = descriptor.value\n+    const originalName = Object.getOwnPropertyDescriptor(originalMethod, 'name')\n+    const wrapperMethod = function (this: typeof console, ...args: any[]) {\n+      const consoleStore = consoleAsyncStorage.getStore()\n+\n+      if (consoleStore?.dim === true) {\n+        return applyWithDimming.call(\n+          this,\n+          consoleStore,\n+          originalMethod,\n+          methodName,\n+          args\n+        )\n+      } else {\n+        // First we see if there is a cache signal for our current scope. If we're in a client render it'll\n+        // come from the client React cacheSignal implementation. If we are in a server render it'll come from\n+        // the server React cacheSignal implementation. Any particular console call will be in one, the other, or neither\n+        // scope and these signals return null if you are out of scope so this can be called from a single global patch\n+        // and still work properly.\n+        for (let i = 0; i < cacheSignals.length; i++) {\n+          const signal = cacheSignals[i]() // try to get a signal from registered functions\n+          if (signal) {\n+            // We are in a React Server render and can consult the React cache signal to determine if logs\n+            // are now dimmable.\n+            if (signal.aborted) {\n+              return applyWithDimming.call(\n+                this,\n+                consoleStore,\n+                originalMethod,\n+                methodName,\n+                args\n+              )\n+            } else {\n+              return originalMethod.apply(this, args)\n+            }\n+          }\n+        }\n+        // We need to fall back to checking the work unit store for two reasons.\n+        // 1. Client React does not yet implement cacheSignal (it always returns null)\n+        // 2. route.ts files aren't rendered with React but do have prerender semantics\n+        // TODO in the future we should be able to remove this once there is a runnable cache\n+        // scope independent of actual React rendering.\n+        const workUnitStore = workUnitAsyncStorage.getStore()\n+        switch (workUnitStore?.type) {\n+          case 'prerender':\n+          case 'prerender-runtime':\n+          // These can be hit in a route handler. In the future we can use potential React.createCache API\n+          // to create a cache scope for arbitrary computation and can move over to cacheSignal exclusively.\n+          // fallthrough\n+          case 'prerender-client':\n+            // This is a react-dom/server render and won't have a cacheSignal until React adds this for the client world.\n+            const renderSignal = workUnitStore.renderSignal\n+            if (renderSignal.aborted) {\n+              return applyWithDimming.call(\n+                this,\n+                consoleStore,\n+                originalMethod,\n+                methodName,\n+                args\n+              )\n+            } else {\n+              return originalMethod.apply(this, args)\n+            }\n+          case 'prerender-legacy':\n+          case 'prerender-ppr':\n+          case 'cache':\n+          case 'unstable-cache':\n+          case 'private-cache':\n+          case 'request':\n+          case undefined:\n+            return originalMethod.apply(this, args)\n+          default:\n+            workUnitStore satisfies never\n+        }\n+      }\n+    }\n+    if (originalName) {\n+      Object.defineProperty(wrapperMethod, 'name', originalName)\n+    }\n+    Object.defineProperty(console, methodName, {\n+      value: wrapperMethod,\n+    })\n+  }\n+}\n+\n+function applyWithDimming<F extends (this: Console, ...args: any[]) => any>(\n+  this: Console,\n+  consoleStore: undefined | ConsoleStore,\n+  method: F,\n+  methodName: InterceptableConsoleMethod,\n+  args: Parameters<F>\n+): ReturnType<F> {\n+  if (consoleStore?.dim === true) {\n+    return method.apply(this, convertToDimmedArgs(methodName, args))\n+  } else {\n+    return consoleAsyncStorage.run(\n+      DIMMED_STORE,\n+      method.bind(this, ...convertToDimmedArgs(methodName, args))\n+    )\n+  }\n+}\n+\n+const DIMMED_STORE = { dim: true }\n+\n+patchConsoleMethod('error')\n+patchConsoleMethod('assert')\n+patchConsoleMethod('debug')\n+patchConsoleMethod('dir')\n+patchConsoleMethod('dirxml')\n+patchConsoleMethod('group')\n+patchConsoleMethod('groupCollapsed')\n+patchConsoleMethod('groupEnd')\n+patchConsoleMethod('info')\n+patchConsoleMethod('log')\n+patchConsoleMethod('table')\n+patchConsoleMethod('trace')\n+patchConsoleMethod('warn')"
        },
        {
            "sha": "bdb524e121daab907ac65b17a47610b6ad1c2c9b",
            "filename": "packages/next/src/server/node-environment-extensions/console-file.tsx",
            "status": "added",
            "additions": 73,
            "deletions": 0,
            "changes": 73,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-file.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-file.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-file.tsx?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -0,0 +1,73 @@\n+import { consoleAsyncStorage } from '../app-render/console-async-storage.external'\n+import { getFileLogger } from '../dev/browser-logs/file-logger'\n+import { formatConsoleArgs } from '../../client/lib/console'\n+\n+type InterceptableConsoleMethod =\n+  | 'error'\n+  | 'assert'\n+  | 'debug'\n+  | 'dir'\n+  | 'dirxml'\n+  | 'group'\n+  | 'groupCollapsed'\n+  | 'groupEnd'\n+  | 'info'\n+  | 'log'\n+  | 'table'\n+  | 'trace'\n+  | 'warn'\n+\n+// Based on https://github.com/facebook/react/blob/28dc0776be2e1370fe217549d32aee2519f0cf05/packages/react-server/src/ReactFlightServer.js#L248\n+function patchConsoleMethodDEV(methodName: InterceptableConsoleMethod): void {\n+  const descriptor = Object.getOwnPropertyDescriptor(console, methodName)\n+  if (\n+    descriptor &&\n+    (descriptor.configurable || descriptor.writable) &&\n+    typeof descriptor.value === 'function'\n+  ) {\n+    const originalMethod = descriptor.value\n+    const originalName = Object.getOwnPropertyDescriptor(originalMethod, 'name')\n+    const wrapperMethod = function (this: typeof console, ...args: any[]) {\n+      const consoleStore = consoleAsyncStorage.getStore()\n+\n+      if (consoleStore?.dim === true) {\n+        // In this context the log args are already dimmed. We use the console store\n+        // to decide if this log is ignorable for reporting in our file logger.\n+        return originalMethod.apply(this, args)\n+      } else {\n+        const ret = originalMethod.apply(this, args)\n+\n+        const fileLogger = getFileLogger()\n+        const message = formatConsoleArgs(args)\n+        // Strip ANSI escape codes for file logging\n+        // eslint-disable-next-line no-control-regex\n+        const ansiEscapeRegex = new RegExp('\\u001b\\\\[[0-9;]*m', 'g')\n+        const cleanMessage = message.replace(ansiEscapeRegex, '')\n+        fileLogger.logServer(methodName.toUpperCase(), cleanMessage)\n+        return ret\n+      }\n+    }\n+    if (originalName) {\n+      Object.defineProperty(wrapperMethod, 'name', originalName)\n+    }\n+    Object.defineProperty(console, methodName, {\n+      value: wrapperMethod,\n+    })\n+  }\n+}\n+\n+if (process.env.NODE_ENV === 'development') {\n+  patchConsoleMethodDEV('error')\n+  patchConsoleMethodDEV('assert')\n+  patchConsoleMethodDEV('debug')\n+  patchConsoleMethodDEV('dir')\n+  patchConsoleMethodDEV('dirxml')\n+  patchConsoleMethodDEV('group')\n+  patchConsoleMethodDEV('groupCollapsed')\n+  patchConsoleMethodDEV('groupEnd')\n+  patchConsoleMethodDEV('info')\n+  patchConsoleMethodDEV('log')\n+  patchConsoleMethodDEV('table')\n+  patchConsoleMethodDEV('trace')\n+  patchConsoleMethodDEV('warn')\n+}"
        },
        {
            "sha": "1f8732fb1868decebbd5e54119d7bca4fd6d4d19",
            "filename": "packages/next/src/server/node-environment.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment.ts?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -5,13 +5,15 @@ import './node-environment-baseline'\n // Import as early as possible so that unexpected errors in other extensions are properly formatted.\n // Has to come after baseline since error-inspect requires AsyncLocalStorage that baseline provides.\n import './node-environment-extensions/error-inspect'\n+\n+// console file needs to go first because we want to be in a dimmed scope before\n+// deciding if we ought to write the log to file.\n+import './node-environment-extensions/console-file'\n import './node-environment-extensions/console-exit'\n+import './node-environment-extensions/console-dim.external'\n+\n import './node-environment-extensions/unhandled-rejection'\n import './node-environment-extensions/random'\n import './node-environment-extensions/date'\n import './node-environment-extensions/web-crypto'\n import './node-environment-extensions/node-crypto'\n-\n-if (process.env.NODE_ENV === 'development') {\n-  require('./node-environment-extensions/console-dev') as typeof import('./node-environment-extensions/console-dev')\n-}"
        },
        {
            "sha": "97fcf33282352ab2f2213512a8842fd486a395be",
            "filename": "packages/next/src/server/route-modules/app-page/module.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -38,6 +38,14 @@ if (process.env.NEXT_RUNTIME !== 'edge') {\n     require('./vendored/rsc/entrypoints') as typeof import('./vendored/rsc/entrypoints')\n   vendoredReactSSR =\n     require('./vendored/ssr/entrypoints') as typeof import('./vendored/ssr/entrypoints')\n+\n+  // In Node environments we augment console logging with information contextual to a React render.\n+  // This patching is global so we need to register the cacheSignal getter from our bundled React instances\n+  // here when we load them rather than in the external module itself when the patch is applied.\n+  const { registerGetCacheSignal } =\n+    require('../../node-environment-extensions/console-dim.external') as typeof import('../../node-environment-extensions/console-dim.external')\n+  registerGetCacheSignal(vendoredReactRSC.React.cacheSignal)\n+  registerGetCacheSignal(vendoredReactSSR.React.cacheSignal)\n }\n \n /**"
        },
        {
            "sha": "b57864dbb530ddeb22423e6f2cb21eda76f7e198",
            "filename": "test/e2e/app-dir/cache-components/app/console-after-abort/client/client.tsx",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -0,0 +1,41 @@\n+'use client'\n+\n+import { use } from 'react'\n+\n+function log(outBadge: string, errBadge: string) {\n+  console.info(`${outBadge} /console: template(one: %s, two: %s)`, 'one', 'two')\n+  console.log(\n+    // eslint-disable-next-line no-useless-concat\n+    `${outBadge} /console: This is a console page. Don't match the codeframe.`\n+  )\n+  console.warn(`${errBadge} /console: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  console.error(new Error(`${errBadge} /console: test`))\n+  console.assert(\n+    false,\n+    `${errBadge} /console: This is an assert message with a %s`,\n+    'template'\n+  )\n+  console.assert(\n+    true,\n+    `${errBadge} /console: This is an assert message without a template`\n+  )\n+}\n+\n+export default function ClientConsolePage({\n+  data,\n+  outBadge,\n+  errBadge,\n+}: {\n+  data: Promise<any>\n+  outBadge: string\n+  errBadge: string\n+}) {\n+  console.log(`${outBadge} logging before prerender aborts in client component`)\n+  setTimeout(log.bind(null, outBadge, errBadge), 1)\n+\n+  use(data)\n+\n+  return null\n+}"
        },
        {
            "sha": "bfaf4b5302c8ab4fb2cfdb69ba335dac282006c5",
            "filename": "test/e2e/app-dir/cache-components/app/console-after-abort/client/page.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fclient%2Fpage.tsx?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -0,0 +1,17 @@\n+import { headers } from 'next/headers'\n+\n+import ClientConsolePage from './client'\n+\n+let i = 0\n+\n+export default async function ConsolePage() {\n+  const data = headers().then(() => null)\n+\n+  const outBadge = `:::${i}:out:::`\n+  const errBadge = `:::${i++}:err:::`\n+  console.log(`${outBadge} logging before prerender abort`)\n+\n+  return (\n+    <ClientConsolePage data={data} outBadge={outBadge} errBadge={errBadge} />\n+  )\n+}"
        },
        {
            "sha": "63a9604cde7b44730f733b76146de2406d0ee6c6",
            "filename": "test/e2e/app-dir/cache-components/app/console-after-abort/layout.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Flayout.tsx?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -0,0 +1,5 @@\n+import { Suspense } from 'react'\n+\n+export default async function layout({ children }) {\n+  return <Suspense>{children}</Suspense>\n+}"
        },
        {
            "sha": "c4c93fef1e9c8739dc3c5550c1cc5376be17582a",
            "filename": "test/e2e/app-dir/cache-components/app/console-after-abort/server/page.tsx",
            "status": "added",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fserver%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fserver%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fserver%2Fpage.tsx?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -0,0 +1,63 @@\n+import { headers } from 'next/headers'\n+\n+async function cachedConsoleCalls(outBadge: string, errBadge: string) {\n+  'use cache'\n+  console.info(`${outBadge} /console: template(one: %s, two: %s)`, 'one', 'two')\n+  console.log(\n+    // eslint-disable-next-line no-useless-concat\n+    `${outBadge} /console: This is a console page` +\n+      \". Don't match the codeframe.\"\n+  )\n+  console.warn(`${errBadge} /console: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  // TODO(veil): Assert on inspected errors once we sourcemap errors replayed from Cache environment.\n+  // console.error(new Error('/console: test'))\n+  console.assert(\n+    false,\n+    `${errBadge} /console: This is an assert message with a %s`,\n+    'template'\n+  )\n+  console.assert(\n+    true,\n+    `${errBadge} /console: This is an assert message without a template`\n+  )\n+}\n+\n+let i = 0\n+export default async function ConsolePage() {\n+  const outBadge = `:::${i}:out:::`\n+  const errBadge = `:::${i++}:err:::`\n+\n+  console.log(`${outBadge} logging before trying await headers()`)\n+  try {\n+    await headers()\n+  } catch (error) {\n+    console.error(`${errBadge} caught error trying await headers()`)\n+  }\n+  // We add some delay because in tests this sometimes runs after the second render pass\n+  // has already started and that can lead to out-of-order console logs.\n+  console.info(`${outBadge} /console: template(one: %s, two: %s)`, 'one', 'two')\n+  console.log(\n+    // eslint-disable-next-line no-useless-concat\n+    `${outBadge} /console: This is a console page` +\n+      \". Don't match the codeframe.\"\n+  )\n+  console.warn(`${errBadge} /console: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  console.error(new Error(`${errBadge} /console: test`))\n+  console.assert(\n+    false,\n+    `${errBadge} /console: This is an assert message with a %s`,\n+    'template'\n+  )\n+  console.assert(\n+    true,\n+    `${errBadge} /console: This is an assert message without a template`\n+  )\n+\n+  await cachedConsoleCalls(outBadge, errBadge)\n+\n+  return null\n+}"
        },
        {
            "sha": "5c0c587fb55ac95d854a941c4ec92b7a923b99bf",
            "filename": "test/e2e/app-dir/cache-components/app/console/page.tsx",
            "status": "modified",
            "additions": 36,
            "deletions": 13,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole%2Fpage.tsx?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -1,37 +1,60 @@\n-async function cachedConsoleCalls() {\n+async function cachedConsoleCalls(outBadge: string, errBadge: string) {\n   'use cache'\n-  console.info('/console: template(one: %s, two: %s)', 'one', 'two')\n+  console.info(`${outBadge} /console: template(one: %s, two: %s)`, 'one', 'two')\n+  await 1\n   console.log(\n     // eslint-disable-next-line no-useless-concat\n-    '/console: This is a console page' + \". Don't match the codeframe.\"\n+    `${outBadge} /console: This is a console page` +\n+      \". Don't match the codeframe.\"\n   )\n-  console.warn('/console: not a template', { foo: 'just-some-object' })\n+  await 1\n+  console.warn(`${errBadge} /console: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  await 1\n   // TODO(veil): Assert on inspected errors once we sourcemap errors replayed from Cache environment.\n   // console.error(new Error('/console: test'))\n   console.assert(\n     false,\n-    '/console: This is an assert message with a %s',\n+    `${errBadge} /console: This is an assert message with a %s`,\n     'template'\n   )\n-  console.assert(true, '/console: This is an assert message without a template')\n+  console.assert(\n+    true,\n+    `${errBadge} /console: This is an assert message without a template`\n+  )\n }\n \n+let i = 0\n export default async function ConsolePage() {\n-  console.info('/console: template(one: %s, two: %s)', 'one', 'two')\n+  const outBadge = `:::${i}:out:::`\n+  const errBadge = `:::${i++}:err:::`\n+  console.info(`${outBadge} /console: template(one: %s, two: %s)`, 'one', 'two')\n+  await 1\n   console.log(\n     // eslint-disable-next-line no-useless-concat\n-    '/console: This is a console page' + \". Don't match the codeframe.\"\n+    `${outBadge} /console: This is a console page` +\n+      \". Don't match the codeframe.\"\n   )\n-  console.warn('/console: not a template', { foo: 'just-some-object' })\n-  console.error(new Error('/console: test'))\n+  await 1\n+  console.warn(`${errBadge} /console: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  await 1\n+  console.error(new Error(`${errBadge} /console: test`))\n+  await 1\n   console.assert(\n     false,\n-    '/console: This is an assert message with a %s',\n+    `${errBadge} /console: This is an assert message with a %s`,\n     'template'\n   )\n-  console.assert(true, '/console: This is an assert message without a template')\n+  console.assert(\n+    true,\n+    `${errBadge} /console: This is an assert message without a template`\n+  )\n \n-  await cachedConsoleCalls()\n+  await 1\n+  await cachedConsoleCalls(outBadge, errBadge)\n \n   return null\n }"
        },
        {
            "sha": "e4b440c156a87d5717f4f62da484cb2c7a5e99d2",
            "filename": "test/e2e/app-dir/cache-components/cache-components.console.test.ts",
            "status": "modified",
            "additions": 553,
            "deletions": 74,
            "changes": 627,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fcache-components.console.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fcache-components.console.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fcache-components.console.test.ts?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -1,117 +1,596 @@\n-import { nextTestSetup } from 'e2e-utils'\n+import { isNextDev, nextTestSetup } from 'e2e-utils'\n import { retry } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n \n-describe('cache-components', () => {\n-  const { isNextDev, next, skipped } = nextTestSetup({\n+describe('cache-components - Console Dimming - Validation', () => {\n+  const { next, skipped, isTurbopack } = nextTestSetup({\n     env: {\n       FORCE_COLOR: '1',\n     },\n     files: __dirname,\n     skipDeployment: true,\n+    skipStart: !isNextDev,\n   })\n \n   if (skipped) {\n     return\n   }\n \n   it('dims console calls during prospective rendering', async () => {\n-    const browser = await next.browser('/console', {})\n-\n+    const path: string = '/console'\n     if (isNextDev) {\n+      const browser = await next.browser(path, {})\n       await retry(() => {\n-        expect(stripAnsi(next.cliOutput)).toContain('GET /console 200')\n+        expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n       })\n \n       // do not strip ANSI codes here since we're explicitly testing coloring.\n       const cliOutputFromPage = next.cliOutput.match(\n-        /Compiled \\/console[^\\n]+\\n(.*)\\n GET \\/console /s\n+        new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n       )[1]\n \n-      expect(cliOutputFromPage).toMatchInlineSnapshot(`\n-       \"/console: template(one: one, two: two)\n-       /console: This is a console page. Don't match the codeframe.\n-       /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Error: /console: test\n-           at ConsolePage (app/console/page.tsx:26:17)\n-       \u001b[0m \u001b[90m 24 |\u001b[39m   )\n-        \u001b[90m 25 |\u001b[39m   console\u001b[33m.\u001b[39mwarn(\u001b[32m'/console: not a template'\u001b[39m\u001b[33m,\u001b[39m { foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m })\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 26 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m'/console: test'\u001b[39m))\n+      const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n+\n+      expect(reorderedLines).toMatchInlineSnapshot(`\n+       \":::0:out::: /console: template(one: one, two: two)\n+       :::0:out::: /console: This is a console page. Don't match the codeframe.\n+       :::0:out::: /console: template(one: one, two: two)\n+       :::0:out::: /console: This is a console page. Don't match the codeframe.\n+       \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console: template(one: one, two: two)\n+       \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console: This is a console page. Don't match the codeframe.\n+       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Error: :::0:err::: /console: test\n+           at ConsolePage (app/console/page.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 42 |\u001b[39m   })\n+        \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n         \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 27 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 28 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 29 |\u001b[39m     \u001b[32m'/console: This is an assert message with a %s'\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n-       Assertion failed: /console: This is an assert message with a template\n-       /console: template(one: one, two: two)\n-       /console: This is a console page. Don't match the codeframe.\n-       /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Assertion failed: /console: This is an assert message with a template\n-       \u001b[0m\u001b[7m Cache \u001b[0m /console: template(one: one, two: two)\n-       \u001b[0m\u001b[7m Cache \u001b[0m /console: This is a console page. Don't match the codeframe.\n-       \u001b[0m\u001b[7m Cache \u001b[0m /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Assertion failed: \u001b[0m\u001b[7m Cache \u001b[0m /console: This is an assert message with a template\n-       \u001b[0m\u001b[7m Cache \u001b[0m Assertion failed: /console: This is an assert message with a template\n-       \u001b[2m/console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m/console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m/console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mError: /console: test\n-           at ConsolePage (app/console/page.tsx:26:17)\n-       \u001b[0m \u001b[90m 24 |\u001b[39m   )\n-        \u001b[90m 25 |\u001b[39m   console\u001b[33m.\u001b[39mwarn(\u001b[32m'/console: not a template'\u001b[39m\u001b[33m,\u001b[39m { foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m })\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 26 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m'/console: test'\u001b[39m))\n+        \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+        \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+       Assertion failed: :::0:err::: /console: This is an assert message with a template\n+       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Assertion failed: :::0:err::: /console: This is an assert message with a template\n+       \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Assertion failed: \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console: This is an assert message with a template\n+       \u001b[0m\u001b[7m Cache \u001b[0m Assertion failed: :::0:err::: /console: This is an assert message with a template\n+       \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       :::1:out::: /console: template(one: one, two: two)\n+       :::1:out::: /console: This is a console page. Don't match the codeframe.\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mError: :::1:err::: /console: test\n+           at ConsolePage (app/console/page.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 42 |\u001b[39m   })\n+        \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n         \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 27 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 28 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 29 |\u001b[39m     \u001b[32m'/console: This is an assert message with a %s'\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m/console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m/console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m/console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m/console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m/console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2mAssertion failed: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m/console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m/console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m/console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mError: /console: test\n-           at ConsolePage (app/console/page.tsx:26:17)\n-       \u001b[0m \u001b[90m 24 |\u001b[39m   )\n-        \u001b[90m 25 |\u001b[39m   console\u001b[33m.\u001b[39mwarn(\u001b[32m'/console: not a template'\u001b[39m\u001b[33m,\u001b[39m { foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m })\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 26 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m'/console: test'\u001b[39m))\n+        \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+        \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Assertion failed: :::1:err::: /console: This is an assert message with a template\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2mAssertion failed: :::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       :::2:out::: /console: template(one: one, two: two)\n+       :::2:out::: /console: This is a console page. Don't match the codeframe.\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mError: :::2:err::: /console: test\n+           at ConsolePage (app/console/page.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 42 |\u001b[39m   })\n+        \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n         \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 27 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 28 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 29 |\u001b[39m     \u001b[32m'/console: This is an assert message with a %s'\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m/console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m/console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m/console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m/console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m/console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2mAssertion failed: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[22m\"\n+        \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+        \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m:::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       :::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Assertion failed: :::2:err::: /console: This is an assert message with a template\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2mAssertion failed: :::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[22m\n+       \"\n       `)\n \n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n-         \"description\": \"/console: test\",\n+         \"description\": \":::0:err::: /console: test\",\n          \"environmentLabel\": \"Prerender\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/console/page.tsx (26:17) @ ConsolePage\n-       > 26 |   console.error(new Error('/console: test'))\n+         \"source\": \"app/console/page.tsx (44:17) @ ConsolePage\n+       > 44 |   console.error(new Error(\\`\\${errBadge} /console: test\\`))\n             |                 ^\",\n          \"stack\": [\n-           \"ConsolePage app/console/page.tsx (26:17)\",\n+           \"ConsolePage app/console/page.tsx (44:17)\",\n            \"ConsolePage <anonymous>\",\n          ],\n        }\n       `)\n     } else {\n-      // prewarm + render + Cache replay\n-      // Neither is dimmed in production\n-      const pageInvocations = Array.from(\n-        next.cliOutput.matchAll(\n-          /\\/console: This is a console page\\. Don't match the codeframe\\./g\n+      try {\n+        await next.build({\n+          env: {\n+            NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n+          },\n+        })\n+      } catch (err) {\n+        const error = new Error(\n+          'Expected build to complete successfully, but it failed'\n+        )\n+        error.cause = err\n+        throw error\n+      }\n+      // do not strip ANSI codes here since we're explicitly testing coloring.\n+      const cliOutputFromPage = next.cliOutput.match(\n+        /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n+      )[1]\n+\n+      const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n+\n+      if (isTurbopack) {\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: /console: template(one: one, two: two)\n+         :::0:out::: /console: This is a console page. Don't match the codeframe.\n+         :::0:out::: /console: template(one: one, two: two)\n+         :::0:out::: /console: This is a console page. Don't match the codeframe.\n+         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::0:err::: /console: test\n+             at e (turbopack:///[project]/app/console/page.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 42 |\u001b[39m   })\n+          \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+          \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+         Assertion failed: :::0:err::: /console: This is an assert message with a template\n+         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: :::0:err::: /console: This is an assert message with a template\n+         :::1:out::: /console: template(one: one, two: two)\n+         :::1:out::: /console: This is a console page. Don't match the codeframe.\n+         :::1:out::: /console: template(one: one, two: two)\n+         :::1:out::: /console: This is a console page. Don't match the codeframe.\n+         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::1:err::: /console: test\n+             at e (turbopack:///[project]/app/console/page.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 42 |\u001b[39m   })\n+          \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+          \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+         Assertion failed: :::1:err::: /console: This is an assert message with a template\n+         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: :::1:err::: /console: This is an assert message with a template\"\n+        `)\n+      } else {\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: /console: template(one: one, two: two)\n+         :::0:out::: /console: This is a console page. Don't match the codeframe.\n+         :::0:out::: /console: template(one: one, two: two)\n+         :::0:out::: /console: This is a console page. Don't match the codeframe.\n+         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::0:err::: /console: test\n+             at g (.next/server/app/console/page.js:<line>:<col>)\n+         Assertion failed: :::0:err::: /console: This is an assert message with a template\n+         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: :::0:err::: /console: This is an assert message with a template\n+         :::1:out::: /console: template(one: one, two: two)\n+         :::1:out::: /console: This is a console page. Don't match the codeframe.\n+         :::1:out::: /console: template(one: one, two: two)\n+         :::1:out::: /console: This is a console page. Don't match the codeframe.\n+         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::1:err::: /console: test\n+             at g (.next/server/app/console/page.js:<line>:<col>)\n+         Assertion failed: :::1:err::: /console: This is an assert message with a template\n+         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: :::1:err::: /console: This is an assert message with a template\"\n+        `)\n+      }\n+    }\n+  })\n+})\n+\n+describe('cache-components - Console Dimming - Logging after Abort in Server', () => {\n+  const { next, skipped, isTurbopack } = nextTestSetup({\n+    env: {\n+      FORCE_COLOR: '1',\n+    },\n+    files: __dirname,\n+    skipDeployment: true,\n+    skipStart: !isNextDev,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('dims console calls after a prerender has aborted', async () => {\n+    const path: string = '/console-after-abort/server'\n+\n+    if (isNextDev) {\n+      const browser = await next.browser(path, {})\n+\n+      await retry(() => {\n+        expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n+      })\n+\n+      // do not strip ANSI codes here since we're explicitly testing coloring.\n+      const cliOutputFromPage = next.cliOutput.match(\n+        new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n+      )[1]\n+\n+      const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n+\n+      expect(reorderedLines).toMatchInlineSnapshot(`\n+       \":::0:out::: logging before trying await headers()\n+       :::0:out::: /console: template(one: one, two: two)\n+       :::0:out::: /console: This is a console page. Don't match the codeframe.\n+       :::0:out::: /console: template(one: one, two: two)\n+       :::0:out::: /console: This is a console page. Don't match the codeframe.\n+       \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console: template(one: one, two: two)\n+       \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console: This is a console page. Don't match the codeframe.\n+       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Error: :::0:err::: /console: test\n+           at ConsolePage (app/console-after-abort/server/page.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 47 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 48 |\u001b[39m   })\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 49 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+        \u001b[90m 50 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 51 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 52 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+       Assertion failed: :::0:err::: /console: This is an assert message with a template\n+       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Assertion failed: :::0:err::: /console: This is an assert message with a template\n+       \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Assertion failed: \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console: This is an assert message with a template\n+       \u001b[0m\u001b[7m Cache \u001b[0m Assertion failed: :::0:err::: /console: This is an assert message with a template\n+       \u001b[2m:::1:out::: logging before trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mError: :::1:err::: /console: test\n+           at ConsolePage (app/console-after-abort/server/page.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 47 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 48 |\u001b[39m   })\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 49 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+        \u001b[90m 50 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 51 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 52 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: logging before trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mError: :::2:err::: /console: test\n+           at ConsolePage (app/console-after-abort/server/page.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 47 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 48 |\u001b[39m   })\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 49 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+        \u001b[90m 50 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 51 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 52 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m:::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       \"\n+      `)\n+\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"description\": \":::0:err::: /console: test\",\n+         \"environmentLabel\": \"Server\",\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/console-after-abort/server/page.tsx (49:17) @ ConsolePage\n+       > 49 |   console.error(new Error(\\`\\${errBadge} /console: test\\`))\n+            |                 ^\",\n+         \"stack\": [\n+           \"ConsolePage app/console-after-abort/server/page.tsx (49:17)\",\n+           \"ConsolePage <anonymous>\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      try {\n+        await next.build({\n+          env: {\n+            NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n+          },\n+        })\n+      } catch (err) {\n+        const error = new Error(\n+          'Expected build to complete successfully, but it failed'\n+        )\n+        error.cause = err\n+        throw error\n+      }\n+\n+      const unorderedLines = next.cliOutput.match(\n+        /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n+      )[1]\n+\n+      const reorderedLines = reorderLinesByBadge(unorderedLines)\n+\n+      if (isTurbopack) {\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: logging before trying await headers()\n+         \u001b[2m:::0:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::0:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::0:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::0:err::: /console: test\n+             at g (turbopack:///[project]/app/console-after-abort/server/page.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 47 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 48 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 49 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 50 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 51 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 52 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+         :::1:out::: logging before trying await headers()\n+         \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::1:err::: /console: test\n+             at g (turbopack:///[project]/app/console-after-abort/server/page.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 47 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 48 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 49 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 50 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 51 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 52 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n+        `)\n+      } else {\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: logging before trying await headers()\n+         \u001b[2m:::0:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::0:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::0:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::0:err::: /console: test\n+             at i (.next/server/app/console-after-abort/server/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+         :::1:out::: logging before trying await headers()\n+         \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::1:err::: /console: test\n+             at i (.next/server/app/console-after-abort/server/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n+        `)\n+      }\n+    }\n+  })\n+})\n+\n+describe('cache-components - Console Dimming - Logging after Abort in Client', () => {\n+  const { next, skipped, isTurbopack } = nextTestSetup({\n+    env: {\n+      FORCE_COLOR: '1',\n+    },\n+    files: __dirname,\n+    skipDeployment: true,\n+    skipStart: !isNextDev,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('dims console calls after a prerender has aborted', async () => {\n+    const path: string = '/console-after-abort/client'\n+\n+    if (isNextDev) {\n+      const browser = await next.browser(path, {})\n+\n+      await retry(() => {\n+        expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n+      })\n+\n+      // do not strip ANSI codes here since we're explicitly testing coloring.\n+      const cliOutputFromPage = next.cliOutput.match(\n+        new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n+      )[1]\n+\n+      const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n+\n+      expect(reorderedLines).toMatchInlineSnapshot(`\n+       \":::0:out::: logging before prerender abort\n+       :::0:out::: logging before prerender aborts in client component\n+       :::0:out::: /console: template(one: one, two: two)\n+       :::0:out::: /console: This is a console page. Don't match the codeframe.\n+       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Error: :::0:err::: /console: test\n+           at log (app/console-after-abort/client/client.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 12 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 13 |\u001b[39m   })\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 14 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+        \u001b[90m 15 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 16 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 17 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+       Assertion failed: :::0:err::: /console: This is an assert message with a template\n+       \u001b[2m:::1:out::: logging before prerender abort\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:out::: logging before prerender aborts in client component\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mError: :::1:err::: /console: test\n+           at log (app/console-after-abort/client/client.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 12 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 13 |\u001b[39m   })\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 14 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+        \u001b[90m 15 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 16 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 17 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: logging before prerender abort\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: logging before prerender aborts in client component\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mError: :::2:err::: /console: test\n+           at log (app/console-after-abort/client/client.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 12 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 13 |\u001b[39m   })\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 14 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+        \u001b[90m 15 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 16 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 17 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m:::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       \"\n+      `)\n+\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"description\": \":::0:err::: /console: test\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/console-after-abort/client/client.tsx (14:17) @ log\n+       > 14 |   console.error(new Error(\\`\\${errBadge} /console: test\\`))\n+            |                 ^\",\n+         \"stack\": [\n+           \"log app/console-after-abort/client/client.tsx (14:17)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      try {\n+        await next.build({\n+          env: {\n+            NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n+          },\n+        })\n+      } catch (err) {\n+        const error = new Error(\n+          'Expected build to complete successfully, but it failed'\n         )\n-      )\n-      expect(pageInvocations).toHaveLength(3)\n+        error.cause = err\n+        throw error\n+      }\n+\n+      const unorderedLines = next.cliOutput.match(\n+        /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n+      )[1]\n+\n+      const reorderedLines = reorderLinesByBadge(unorderedLines)\n+\n+      if (isTurbopack) {\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: logging before prerender abort\n+         :::0:out::: logging before prerender aborts in client component\n+         \u001b[2m:::0:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::0:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::0:err::: /console: test\n+             at c (turbopack:///[project]/app/console-after-abort/client/client.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 12 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 13 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 14 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 15 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 16 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 17 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+         :::1:out::: logging before prerender abort\n+         :::1:out::: logging before prerender aborts in client component\n+         \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::1:err::: /console: test\n+             at c (turbopack:///[project]/app/console-after-abort/client/client.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 12 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 13 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 14 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 15 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 16 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 17 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n+        `)\n+      } else {\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: logging before prerender abort\n+         :::0:out::: logging before prerender aborts in client component\n+         \u001b[2m:::0:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::0:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::0:err::: /console: test\n+             at e (.next/server/app/console-after-abort/client/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+         :::1:out::: logging before prerender abort\n+         :::1:out::: logging before prerender aborts in client component\n+         \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::1:err::: /console: test\n+             at e (.next/server/app/console-after-abort/client/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n+        `)\n+      }\n     }\n   })\n })\n+\n+type RenderGroups = Map<string | null, StreamGroups>\n+type StreamGroups = Map<string | null, Lines>\n+type Lines = Array<string>\n+\n+function reorderLinesByBadge(selectedOutput: string) {\n+  const unorderedLines = selectedOutput\n+    .split('\\n')\n+    .filter(\n+      (l) => !(l.includes('Generating static pages') || l.includes(' GET '))\n+    )\n+    .map((l) => l.replace(/( at .*):\\d+:\\d+/, '$1:<line>:<col>'))\n+\n+  let currentLines: Lines = []\n+  const renderGroups: RenderGroups = new Map([\n+    [null, new Map([[null, currentLines]]) satisfies StreamGroups],\n+  ])\n+\n+  for (let line of unorderedLines) {\n+    let match = line.match(/:::([^: \\n]+):([^: \\n]+):::/)\n+    if (match) {\n+      const [_, render, stream] = match\n+      const streamGroups = renderGroups.get(render)\n+      if (!streamGroups) {\n+        currentLines = []\n+        renderGroups.set(render, new Map([[stream, currentLines]]))\n+      } else {\n+        currentLines = streamGroups.get(stream)\n+        if (!currentLines) {\n+          streamGroups.set(stream, (currentLines = []))\n+        }\n+      }\n+    }\n+    currentLines.push(line)\n+  }\n+\n+  const orderedRenders = Array.from(renderGroups.values())\n+  const orderedStreams = orderedRenders.map((s) =>\n+    Array.from(s.values()).flat()\n+  )\n+\n+  return orderedStreams.flat().join('\\n')\n+}"
        },
        {
            "sha": "eadd7380315881128af94bfaaae31f72a0e21693",
            "filename": "test/production/next-server-nft/next-server-nft.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5a4c295abd974b8655007cc599784099fe8988d1/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts?ref=5a4c295abd974b8655007cc599784099fe8988d1",
            "patch": "@@ -248,9 +248,12 @@ const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n          \"/node_modules/next/dist/lib/constants.js\",\n          \"/node_modules/next/dist/lib/interop-default.js\",\n          \"/node_modules/next/dist/lib/is-error.js\",\n+         \"/node_modules/next/dist/lib/picocolors.js\",\n          \"/node_modules/next/dist/server/app-render/after-task-async-storage-instance.js\",\n          \"/node_modules/next/dist/server/app-render/after-task-async-storage.external.js\",\n          \"/node_modules/next/dist/server/app-render/async-local-storage.js\",\n+         \"/node_modules/next/dist/server/app-render/console-async-storage-instance.js\",\n+         \"/node_modules/next/dist/server/app-render/console-async-storage.external.js\",\n          \"/node_modules/next/dist/server/app-render/work-async-storage-instance.js\",\n          \"/node_modules/next/dist/server/app-render/work-async-storage.external.js\",\n          \"/node_modules/next/dist/server/app-render/work-unit-async-storage-instance.js\",\n@@ -265,6 +268,7 @@ const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n          \"/node_modules/next/dist/server/lib/trace/constants.js\",\n          \"/node_modules/next/dist/server/lib/trace/tracer.js\",\n          \"/node_modules/next/dist/server/load-manifest.external.js\",\n+         \"/node_modules/next/dist/server/node-environment-extensions/console-dim.external.js\",\n          \"/node_modules/next/dist/server/response-cache/types.js\",\n          \"/node_modules/next/dist/server/route-modules/app-page/module.compiled.js\",\n          \"/node_modules/next/dist/server/route-modules/app-page/vendored/contexts/app-router-context.js\","
        }
    ],
    "stats": {
        "total": 1766,
        "additions": 1457,
        "deletions": 309
    }
}