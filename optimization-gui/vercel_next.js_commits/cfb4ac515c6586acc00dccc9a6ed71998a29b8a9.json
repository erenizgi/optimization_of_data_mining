{
    "author": "ztanner",
    "message": "fix: prevent incorrect searchParams being applied on certain navs (#76914)\n\nWhen the router returns an aliased prefetch for URLs to the same path\nbut with different search params, there's the possibility that we\ntrigger an MPA-style navigation if the path doesn't contain a valid\nflight payload (eg: a route handler, a `pages` router page, or an\nexternal URL). The logic to bail out of the alias handling was happening\n_after_ this, which meant the incorrect searchParams would be applied to\nthe final URL.\n\nThis ensures that if we bail out of applying the alias (eg because it's\nnot a valid RSC payload, or the aliased entry has no reusable loading\nsegment), then we re-run the navigation with a non-aliased entry.\n\nFixes #75318\nCloses NDX-804",
    "sha": "cfb4ac515c6586acc00dccc9a6ed71998a29b8a9",
    "files": [
        {
            "sha": "a4f786e9ccba6fee009b7c3a84510e7406498f25",
            "filename": "packages/next/src/client/components/router-reducer/aliased-prefetch-navigations.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts?ref=cfb4ac515c6586acc00dccc9a6ed71998a29b8a9",
            "patch": "@@ -25,7 +25,7 @@ import type { Mutable, ReadonlyReducerState } from './router-reducer-types'\n  */\n export function handleAliasedPrefetchEntry(\n   state: ReadonlyReducerState,\n-  flightData: NormalizedFlightData[],\n+  flightData: string | NormalizedFlightData[],\n   url: URL,\n   mutable: Mutable\n ) {\n@@ -34,6 +34,10 @@ export function handleAliasedPrefetchEntry(\n   const href = createHrefFromUrl(url)\n   let applied\n \n+  if (typeof flightData === 'string') {\n+    return false\n+  }\n+\n   for (const normalizedFlightData of flightData) {\n     // If the segment doesn't have a loading component, we don't need to do anything.\n     if (!hasLoadingComponentInSeedData(normalizedFlightData.seedData)) {"
        },
        {
            "sha": "83a998eeff3f8f0922e666bf6b7e35246e10733f",
            "filename": "packages/next/src/client/components/router-reducer/reducers/navigate-reducer.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 18,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts?ref=cfb4ac515c6586acc00dccc9a6ed71998a29b8a9",
            "patch": "@@ -234,6 +234,24 @@ export function navigateReducer(\n         isFirstRead = true\n       }\n \n+      if (prefetchValues.aliased) {\n+        const result = handleAliasedPrefetchEntry(\n+          state,\n+          flightData,\n+          url,\n+          mutable\n+        )\n+\n+        // We didn't return new router state because we didn't apply the aliased entry for some reason.\n+        // We'll re-invoke the navigation handler but ensure that we don't attempt to use the aliased entry. This\n+        // will create an on-demand prefetch entry.\n+        if (result === false) {\n+          return navigateReducer(state, { ...action, allowAliasing: false })\n+        }\n+\n+        return result\n+      }\n+\n       // Handle case when navigating to page in `pages` from `app`\n       if (typeof flightData === 'string') {\n         return handleExternalUrl(state, mutable, flightData, pendingPush)\n@@ -259,24 +277,6 @@ export function navigateReducer(\n         return handleMutable(state, mutable)\n       }\n \n-      if (prefetchValues.aliased) {\n-        const result = handleAliasedPrefetchEntry(\n-          state,\n-          flightData,\n-          url,\n-          mutable\n-        )\n-\n-        // We didn't return new router state because we didn't apply the aliased entry for some reason.\n-        // We'll re-invoke the navigation handler but ensure that we don't attempt to use the aliased entry. This\n-        // will create an on-demand prefetch entry.\n-        if (result === false) {\n-          return navigateReducer(state, { ...action, allowAliasing: false })\n-        }\n-\n-        return result\n-      }\n-\n       let currentTree = state.tree\n       let currentCache = state.cache\n       let scrollableSegments: FlightSegmentPath[] = []"
        },
        {
            "sha": "56d7496bcee7f465c8e68a280bb755653d47292b",
            "filename": "test/e2e/app-dir/searchparams-reuse-loading/app/mpa-navs/page.tsx",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fapp%2Fmpa-navs%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fapp%2Fmpa-navs%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fapp%2Fmpa-navs%2Fpage.tsx?ref=cfb4ac515c6586acc00dccc9a6ed71998a29b8a9",
            "patch": "@@ -0,0 +1,26 @@\n+import Link from 'next/link'\n+\n+export default function Page() {\n+  return (\n+    <ul>\n+      <li>\n+        <Link href=\"/non-existent-page?id=1\">/non-existent-page?id=1</Link>\n+      </li>\n+      <li>\n+        <Link href=\"/non-existent-page?id=2\">/non-existent-page?id=2</Link>\n+      </li>\n+      <li>\n+        <Link href=\"/pages-dir?param=1\">/pages-dir?param=1</Link>\n+      </li>\n+      <li>\n+        <Link href=\"/pages-dir?param=2\">/pages-dir?param=2</Link>\n+      </li>\n+      <li>\n+        <Link href=\"/route-handler?param=1\">/route-handler?param=1</Link>\n+      </li>\n+      <li>\n+        <Link href=\"/route-handler?param=2\">/route-handler?param=2</Link>\n+      </li>\n+    </ul>\n+  )\n+}"
        },
        {
            "sha": "9f006aa1a4be1d993f3de590c79dc91559f7cffe",
            "filename": "test/e2e/app-dir/searchparams-reuse-loading/app/route-handler/route.ts",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fapp%2Froute-handler%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fapp%2Froute-handler%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fapp%2Froute-handler%2Froute.ts?ref=cfb4ac515c6586acc00dccc9a6ed71998a29b8a9",
            "patch": "@@ -0,0 +1,6 @@\n+import { NextRequest, NextResponse } from 'next/server'\n+\n+export async function GET(req: NextRequest) {\n+  const param = req.nextUrl.searchParams.get('param') as string\n+  return NextResponse.json({ param })\n+}"
        },
        {
            "sha": "dcc1740b85d9c771345cd811ed261b5a905c0db8",
            "filename": "test/e2e/app-dir/searchparams-reuse-loading/app/search/layout.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fapp%2Fsearch%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fapp%2Fsearch%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fapp%2Fsearch%2Flayout.tsx?ref=cfb4ac515c6586acc00dccc9a6ed71998a29b8a9",
            "patch": "@@ -9,5 +9,5 @@ export default function SearchLayout({\n   children: React.ReactNode\n }) {\n   let searchParams = useSearchParams()\n-  return <Fragment key={searchParams.get('q')}>{children}</Fragment>\n+  return <Fragment key={searchParams?.get('q')}>{children}</Fragment>\n }"
        },
        {
            "sha": "ff063bf5f2e16bcdaf082702a3499c6b95491138",
            "filename": "test/e2e/app-dir/searchparams-reuse-loading/pages/pages-dir.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fpages%2Fpages-dir.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fpages%2Fpages-dir.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fpages%2Fpages-dir.tsx?ref=cfb4ac515c6586acc00dccc9a6ed71998a29b8a9",
            "patch": "@@ -0,0 +1,6 @@\n+import { useRouter } from 'next/router'\n+\n+export default function Page() {\n+  const router = useRouter()\n+  return <div>Hello from pages dir! {router.query.param}</div>\n+}"
        },
        {
            "sha": "8a99bc28e74125a21b92b0f94df15caa1323629f",
            "filename": "test/e2e/app-dir/searchparams-reuse-loading/searchparams-reuse-loading.test.ts",
            "status": "modified",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/vercel/next.js/blob/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fsearchparams-reuse-loading.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cfb4ac515c6586acc00dccc9a6ed71998a29b8a9/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fsearchparams-reuse-loading.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fsearchparams-reuse-loading.test.ts?ref=cfb4ac515c6586acc00dccc9a6ed71998a29b8a9",
            "patch": "@@ -87,6 +87,75 @@ describe('searchparams-reuse-loading', () => {\n     )\n   })\n \n+  describe('when aliasing is skipped', () => {\n+    it('should work for not found pages', async () => {\n+      const browser = await next.browser('/mpa-navs')\n+      await browser.elementByCss(\"[href='/non-existent-page?id=1']\").click()\n+\n+      // the first link would have been the \"aliased\" entry since it was prefetched first. Validate that it's the correct URL\n+      await retry(async () => {\n+        expect(await browser.url()).toContain('/non-existent-page?id=1')\n+      })\n+\n+      expect(await browser.elementByCss('h2').text()).toBe(\n+        'This page could not be found.'\n+      )\n+\n+      // The other link would have attempted to use the aliased entry. Ensure the browser ends up on the correct page\n+      await browser.loadPage(`${next.url}/mpa-navs`)\n+      await retry(async () => {\n+        expect(await browser.url()).toContain('/mpa-navs')\n+      })\n+      await browser.elementByCss(\"[href='/non-existent-page?id=2']\").click()\n+      await retry(async () => {\n+        expect(await browser.url()).toContain('/non-existent-page?id=2')\n+      })\n+      expect(await browser.elementByCss('h2').text()).toBe(\n+        'This page could not be found.'\n+      )\n+    })\n+\n+    it('should work for route handlers', async () => {\n+      const browser = await next.browser('/mpa-navs')\n+      await browser.elementByCss(\"[href='/route-handler?param=1']\").click()\n+      await retry(async () => {\n+        expect(await browser.url()).toContain('/route-handler?param=1')\n+      })\n+\n+      await browser.loadPage(`${next.url}/mpa-navs`)\n+      await retry(async () => {\n+        expect(await browser.url()).toContain('/mpa-navs')\n+      })\n+\n+      await browser.elementByCss(\"[href='/route-handler?param=2']\").click()\n+      await retry(async () => {\n+        expect(await browser.url()).toContain('/route-handler?param=2')\n+      })\n+    })\n+\n+    it('should work for navigating to pages dir', async () => {\n+      const browser = await next.browser('/mpa-navs')\n+      await browser.elementByCss(\"[href='/pages-dir?param=1']\").click()\n+\n+      await retry(async () => {\n+        expect(await browser.elementByCss('body').text()).toContain(\n+          'Hello from pages dir! 1'\n+        )\n+        expect(await browser.url()).toContain('/pages-dir?param=1')\n+      })\n+\n+      await browser.loadPage(`${next.url}/mpa-navs`)\n+\n+      await browser.elementByCss(\"[href='/pages-dir?param=2']\").click()\n+      await retry(async () => {\n+        expect(await browser.elementByCss('body').text()).toContain(\n+          'Hello from pages dir! 2'\n+        )\n+        expect(await browser.url()).toContain('/pages-dir?param=2')\n+      })\n+    })\n+  })\n+\n   // Dev doesn't perform prefetching, so this test is skipped, as it relies on intercepting\n   // prefetch network requests.\n   if (!isNextDev) {"
        }
    ],
    "stats": {
        "total": 151,
        "additions": 131,
        "deletions": 20
    }
}