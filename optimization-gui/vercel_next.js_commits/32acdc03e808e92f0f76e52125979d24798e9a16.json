{
    "author": "mischnic",
    "message": "Turbopack: absolute requests in webpack loader (#84575)\n\nRecent sass-loader versions use this heavily: `this.getResolver()(..., \"/Users/foo/..../bar.scss\")`",
    "sha": "32acdc03e808e92f0f76e52125979d24798e9a16",
    "files": [
        {
            "sha": "e00169d31bf3cb2dbe3cf5d8c291d9f34fc26d54",
            "filename": "test/e2e/app-dir/webpack-loader-binary/webpack-loader-binary.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fwebpack-loader-binary.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fwebpack-loader-binary.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fwebpack-loader-binary.test.ts?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -1,11 +1,13 @@\n import { nextTestSetup } from 'e2e-utils'\n \n describe('webpack-loader-ts-transform', () => {\n-  const { next } = nextTestSetup({\n+  const { next, skipped } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n   })\n \n+  if (skipped) return\n+\n   it('should allow passing binary assets to and from a Webpack loader', async () => {\n     const $ = await next.render$('/')\n     expect($('#text').text()).toBe('Got a buffer of 18 bytes')"
        },
        {
            "sha": "52f00ef05b4144728cced2e6d204d6a84fa5e6f1",
            "filename": "test/e2e/app-dir/webpack-loader-conditions/webpack-loader-conditions.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-conditions%2Fwebpack-loader-conditions.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-conditions%2Fwebpack-loader-conditions.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-conditions%2Fwebpack-loader-conditions.test.ts?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -4,11 +4,13 @@ import { nextTestSetup } from 'e2e-utils'\n ;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n   'webpack-loader-conditions',\n   () => {\n-    const { next } = nextTestSetup({\n+    const { next, skipped } = nextTestSetup({\n       files: __dirname,\n       skipDeployment: true,\n     })\n \n+    if (skipped) return\n+\n     it('should render correctly on server site', async () => {\n       const res = await next.fetch('/')\n       const html = (await res.text()).replaceAll(/<!-- -->/g, '')"
        },
        {
            "sha": "080d00918e01c7811d389996e8720503cfa5c641",
            "filename": "test/e2e/app-dir/webpack-loader-fs/webpack-loader-fs.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fwebpack-loader-fs.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fwebpack-loader-fs.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fwebpack-loader-fs.test.ts?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -1,11 +1,13 @@\n import { nextTestSetup } from 'e2e-utils'\n \n describe('webpack-loader-fs', () => {\n-  const { next } = nextTestSetup({\n+  const { next, skipped } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n   })\n \n+  if (skipped) return\n+\n   it('should allow reading the input FS', async () => {\n     const $ = await next.render$('/')\n     expect($('#test').text()).toBe("
        },
        {
            "sha": "1e7743d0f46b0282568e0c7c6f741db1e6b23733",
            "filename": "test/e2e/app-dir/webpack-loader-resolve/app/file.test-file.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fapp%2Ffile.test-file.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fapp%2Ffile.test-file.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fapp%2Ffile.test-file.ts?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -0,0 +1 @@\n+export default 'wrong'"
        },
        {
            "sha": "e7077399c03ce1479a655dc647c0545b64531628",
            "filename": "test/e2e/app-dir/webpack-loader-resolve/app/layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fapp%2Flayout.tsx?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "9f845a3a3f0dfc1728bf41548cc1768db8c9800d",
            "filename": "test/e2e/app-dir/webpack-loader-resolve/app/page.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fapp%2Fpage.js?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -0,0 +1,11 @@\n+import absolute from './file.test-file?absolute=data1'\n+import relative from './file.test-file?relative=data2'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <p id=\"absolute\">{absolute}</p>\n+      <p id=\"relative\">{relative}</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "b4756884837ba328055194a86fe6e0103d71c439",
            "filename": "test/e2e/app-dir/webpack-loader-resolve/data1.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fdata1.js",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fdata1.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fdata1.js?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -0,0 +1 @@\n+export default 'abc'"
        },
        {
            "sha": "2a0a36a4f3197c9ace34d6fc3f94ef0975bb3685",
            "filename": "test/e2e/app-dir/webpack-loader-resolve/data2.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fdata2.js",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fdata2.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fdata2.js?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -0,0 +1 @@\n+export default 'xyz'"
        },
        {
            "sha": "29161a8c7b94a300f887b752b4f820d8d0ec5ac9",
            "filename": "test/e2e/app-dir/webpack-loader-resolve/next.config.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fnext.config.js?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -0,0 +1,19 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  turbopack: {\n+    rules: {\n+      '*.test-file.ts': [require.resolve('./test-file-loader.js')],\n+    },\n+  },\n+  webpack(config) {\n+    config.module.rules.push({\n+      test: /\\.test-file\\.ts/,\n+      use: require.resolve('./test-file-loader.js'),\n+    })\n+    return config\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "8bc4aa870d86652abdd8fb3b455bde167d9421ab",
            "filename": "test/e2e/app-dir/webpack-loader-resolve/test-file-loader.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Ftest-file-loader.js",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Ftest-file-loader.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Ftest-file-loader.js?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -0,0 +1,21 @@\n+const fs = require('fs')\n+const path = require('path')\n+\n+module.exports = async function () {\n+  let params = new URLSearchParams(this.resourceQuery.slice(1))\n+  let file\n+  if (params.has('absolute')) {\n+    file = path.join(__dirname, params.get('absolute'))\n+  } else if (params.has('relative')) {\n+    file = './' + params.get('relative')\n+  } else {\n+    this.callback(null, \"throw new Error('no file specified')\")\n+    return\n+  }\n+\n+  const resolve = this.getResolve({})\n+  const result = await resolve(__dirname, file)\n+  this.addDependency(result)\n+\n+  return fs.readFileSync(result, 'utf8')\n+}"
        },
        {
            "sha": "33d3df56b5e56e7623a8033161706081d5bb4cbf",
            "filename": "test/e2e/app-dir/webpack-loader-resolve/webpack-loader-resolve.test.ts",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fwebpack-loader-resolve.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fwebpack-loader-resolve.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resolve%2Fwebpack-loader-resolve.test.ts?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -0,0 +1,19 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('webpack-loader-resolve', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    // This test is skipped because it's only expected to run in turbopack, which isn't enabled for builds\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should support resolving absolute path via loader getResolve', async () => {\n+    const $ = await next.render$('/')\n+    expect($('#absolute').text()).toBe('abc')\n+    expect($('#relative').text()).toBe('xyz')\n+  })\n+})"
        },
        {
            "sha": "9a2ae523bdcfca5839c5ad6f36e44aa7cde2431b",
            "filename": "test/e2e/app-dir/webpack-loader-resource-query/turbopack-loader-resource-query.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fturbopack-loader-resource-query.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fturbopack-loader-resource-query.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fturbopack-loader-resource-query.test.ts?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -1,12 +1,13 @@\n import { nextTestSetup } from 'e2e-utils'\n \n describe('webpack-loader-resource-query', () => {\n-  const { next } = nextTestSetup({\n+  const { next, skipped } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n   })\n \n-  // Recommended for tests that check HTML. Cheerio is a HTML parser that has a jQuery like API.\n+  if (skipped) return\n+\n   it('should pass query to loader', async () => {\n     await next.render$('/')\n "
        },
        {
            "sha": "fa1a67bd32a4fd387195285d5e9c1c8e39ae1a13",
            "filename": "test/e2e/app-dir/webpack-loader-ts-transform/webpack-loader-ts-transform.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-ts-transform%2Fwebpack-loader-ts-transform.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-ts-transform%2Fwebpack-loader-ts-transform.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-ts-transform%2Fwebpack-loader-ts-transform.test.ts?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -1,16 +1,13 @@\n import { nextTestSetup } from 'e2e-utils'\n \n describe('webpack-loader-ts-transform', () => {\n-  const { next, isTurbopack, skipped } = nextTestSetup({\n+  const { next, skipped } = nextTestSetup({\n     files: __dirname,\n     // This test is skipped because it's only expected to run in turbopack, which isn't enabled for builds\n     skipDeployment: true,\n   })\n \n-  if (!isTurbopack || skipped) {\n-    it('should only run the test in turbopack', () => {})\n-    return\n-  }\n+  if (skipped) return\n \n   it('should accept Typescript returned from Webpack loaders', async () => {\n     const $ = await next.render$('/')"
        },
        {
            "sha": "e72e3065d2be035557c0a01eba1f59785b0dd55b",
            "filename": "turbopack/crates/turbopack-node/js/src/transforms/webpack-loaders.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/32acdc03e808e92f0f76e52125979d24798e9a16/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/32acdc03e808e92f0f76e52125979d24798e9a16/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts?ref=32acdc03e808e92f0f76e52125979d24798e9a16",
            "patch": "@@ -16,6 +16,7 @@ import {\n   type TransformIpc,\n } from './transforms'\n import fs from 'fs'\n+import path from 'path'\n \n export type IpcInfoMessage =\n   | {\n@@ -301,6 +302,22 @@ const transform = (\n               request: string,\n               callback?: (err?: Error, result?: string) => void\n             ) => {\n+              if (path.isAbsolute(request)) {\n+                // Relativize absolute requests. Turbopack disallow them in JS code, but here it's\n+                // generated programatically and there is a smaller problem of\n+                // non-cacheable/non-portable builds.\n+                request = path.relative(lookupPath, request)\n+\n+                // On Windows, the path might be still absolute if it's on a different drive. Just\n+                // let the resolver throw the error in that case.\n+                if (\n+                  !path.isAbsolute(request) &&\n+                  request.split(path.sep)[0] !== '..'\n+                ) {\n+                  request = './' + request\n+                }\n+              }\n+\n               const promise = ipc\n                 .sendRequest({\n                   type: 'resolve',"
        }
    ],
    "stats": {
        "total": 121,
        "additions": 111,
        "deletions": 10
    }
}