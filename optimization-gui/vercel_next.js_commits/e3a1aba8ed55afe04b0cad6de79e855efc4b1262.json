{
    "author": "mischnic",
    "message": "Turbopack: refactor ReadRef deref + clone to the intended pattern (#81537)\n\n```\nast-grep run --pattern '(*$$$X.await?).clone()' --rewrite '$$$X.owned().await?' --lang rust -U\n```",
    "sha": "e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
    "files": [
        {
            "sha": "db88b2ae5b7cf4bd70be6422eec169edfa11dd8d",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 6,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -1288,7 +1288,9 @@ impl Project {\n     async fn edge_middleware_context(self: Vc<Self>) -> Result<Vc<Box<dyn AssetContext>>> {\n         let mut transitions = vec![];\n \n-        let app_dir = (*find_app_dir(self.project_path().await?.clone_value()).await?).clone();\n+        let app_dir = find_app_dir(self.project_path().await?.clone_value())\n+            .owned()\n+            .await?;\n         let app_project = *self.app_project().await?;\n \n         let ecmascript_client_reference_transition_name =\n@@ -1347,7 +1349,9 @@ impl Project {\n     async fn node_middleware_context(self: Vc<Self>) -> Result<Vc<Box<dyn AssetContext>>> {\n         let mut transitions = vec![];\n \n-        let app_dir = (*find_app_dir(self.project_path().await?.clone_value()).await?).clone();\n+        let app_dir = find_app_dir(self.project_path().await?.clone_value())\n+            .owned()\n+            .await?;\n         let app_project = *self.app_project().await?;\n \n         let ecmascript_client_reference_transition_name =\n@@ -1439,7 +1443,9 @@ impl Project {\n             return Ok(Vc::upcast(EmptyEndpoint::new()));\n         };\n         let source = Vc::upcast(FileSource::new(fs_path.clone()));\n-        let app_dir = (*find_app_dir(self.project_path().await?.clone_value()).await?).clone();\n+        let app_dir = find_app_dir(self.project_path().await?.clone_value())\n+            .owned()\n+            .await?;\n         let ecmascript_client_reference_transition_name = (*self.app_project().await?)\n             .as_ref()\n             .map(|_| AppProject::client_transition_name());\n@@ -1459,7 +1465,9 @@ impl Project {\n     async fn node_instrumentation_context(self: Vc<Self>) -> Result<Vc<Box<dyn AssetContext>>> {\n         let mut transitions = vec![];\n \n-        let app_dir = (*find_app_dir(self.project_path().await?.clone_value()).await?).clone();\n+        let app_dir = find_app_dir(self.project_path().await?.clone_value())\n+            .owned()\n+            .await?;\n         let app_project = &*self.app_project().await?;\n \n         let ecmascript_client_reference_transition_name = app_project\n@@ -1518,7 +1526,9 @@ impl Project {\n     async fn edge_instrumentation_context(self: Vc<Self>) -> Result<Vc<Box<dyn AssetContext>>> {\n         let mut transitions = vec![];\n \n-        let app_dir = (*find_app_dir(self.project_path().await?.clone_value()).await?).clone();\n+        let app_dir = find_app_dir(self.project_path().await?.clone_value())\n+            .owned()\n+            .await?;\n         let app_project = &*self.app_project().await?;\n \n         let ecmascript_client_reference_transition_name = app_project\n@@ -1591,7 +1601,9 @@ impl Project {\n             return Ok(Vc::upcast(EmptyEndpoint::new()));\n         };\n         let source = Vc::upcast(FileSource::new(fs_path.clone()));\n-        let app_dir = (*find_app_dir(self.project_path().await?.clone_value()).await?).clone();\n+        let app_dir = find_app_dir(self.project_path().await?.clone_value())\n+            .owned()\n+            .await?;\n         let ecmascript_client_reference_transition_name = (*self.app_project().await?)\n             .as_ref()\n             .map(|_| AppProject::client_transition_name());"
        },
        {
            "sha": "71836f85f418d674d0107790c208b86e6100b4fd",
            "filename": "crates/next-core/src/next_app/app_route_entry.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -38,7 +38,7 @@ pub async fn get_app_route_entry(\n ) -> Result<Vc<AppEntry>> {\n     let segment_from_source = parse_segment_config_from_source(source);\n     let config = if let Some(original_segment_config) = original_segment_config {\n-        let mut segment_config = (*segment_from_source.await?).clone();\n+        let mut segment_config = segment_from_source.owned().await?;\n         segment_config.apply_parent_config(&*original_segment_config.await?);\n         segment_config.into()\n     } else {"
        },
        {
            "sha": "1821e06cc2d28942f8ffa939c0899bafa7e28877",
            "filename": "crates/next-core/src/page_loader.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/crates%2Fnext-core%2Fsrc%2Fpage_loader.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/crates%2Fnext-core%2Fsrc%2Fpage_loader.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fpage_loader.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -138,8 +138,10 @@ impl PageLoaderAsset {\n impl OutputAsset for PageLoaderAsset {\n     #[turbo_tasks::function]\n     async fn path(&self) -> Result<Vc<FileSystemPath>> {\n-        let root = (*self.rebase_prefix_path.await?)\n-            .clone()\n+        let root = self\n+            .rebase_prefix_path\n+            .owned()\n+            .await?\n             .map_or(self.server_root.clone(), |path| path);\n         Ok(root\n             .join(&format!("
        },
        {
            "sha": "a6feed450ecc898f6b9e171bc04b55c7e7e005c0",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -2136,7 +2136,7 @@ impl DirectoryEntry {\n     /// `DirectoryEntry::Directory`.\n     pub async fn resolve_symlink(self) -> Result<Self> {\n         if let DirectoryEntry::Symlink(symlink) = &self {\n-            let real_path = (*symlink.realpath().await?).clone();\n+            let real_path = symlink.realpath().owned().await?;\n             match *real_path.get_type().await? {\n                 FileSystemEntryType::Directory => Ok(DirectoryEntry::Directory(real_path)),\n                 FileSystemEntryType::File => Ok(DirectoryEntry::File(real_path)),\n@@ -2299,7 +2299,7 @@ impl ValueToString for NullFileSystem {\n pub async fn to_sys_path(mut path: FileSystemPath) -> Result<Option<PathBuf>> {\n     loop {\n         if let Some(fs) = Vc::try_resolve_downcast_type::<AttachedFileSystem>(path.fs()).await? {\n-            path = (*fs.get_inner_fs_path(path).await?).clone();\n+            path = fs.get_inner_fs_path(path).owned().await?;\n             continue;\n         }\n \n@@ -2412,7 +2412,7 @@ async fn realpath_with_links(path: FileSystemPath) -> Result<Vc<RealPathResult>>\n         if let LinkContent::Link { target, link_type } = &*current_vc.read_link().await? {\n             symlinks.insert(current_vc.clone());\n             current_vc = if link_type.contains(LinkType::ABSOLUTE) {\n-                (*current_vc.root().await?).clone()\n+                current_vc.root().owned().await?\n             } else {\n                 parent_result.path\n             }"
        },
        {
            "sha": "9c0e768fdc28593b5cc470d143d438cafe6908be",
            "filename": "turbopack/crates/turbo-tasks-fuzz/src/main.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2Fsrc%2Fmain.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -82,11 +82,11 @@ async fn fuzz_fs_watcher(args: FsWatcher) -> anyhow::Result<()> {\n         let project_fs = disk_file_system_operation(fs_root_rcstr.clone())\n             .resolve_strongly_consistent()\n             .await?;\n-        let project_root = (*disk_file_system_root_operation(project_fs)\n+        let project_root = disk_file_system_root_operation(project_fs)\n             .resolve_strongly_consistent()\n             .await?\n-            .await?)\n-            .clone();\n+            .owned()\n+            .await?;\n         create_directory_tree(&mut FxHashSet::default(), &fs_root, args.depth, args.width)?;\n \n         project_fs.await?.start_watching(None).await?;"
        },
        {
            "sha": "cce4528b5a8b2af7937b183109dede5d7441020d",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/evaluate/chunk.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -206,7 +206,7 @@ impl EcmascriptBrowserEvaluateChunk {\n         ident.modifiers.extend(\n             evaluatable_assets\n                 .iter()\n-                .map(|entry| async move { Ok((*entry.ident().to_string().await?).clone()) })\n+                .map(|entry| entry.ident().to_string().owned())\n                 .try_join()\n                 .await?,\n         );\n@@ -215,7 +215,7 @@ impl EcmascriptBrowserEvaluateChunk {\n             self.other_chunks\n                 .await?\n                 .iter()\n-                .map(|chunk| async move { Ok((*chunk.path().to_string().await?).clone()) })\n+                .map(|chunk| chunk.path().to_string().owned())\n                 .try_join()\n                 .await?,\n         );"
        },
        {
            "sha": "a79af4ca943f8f4d1447775b9d0350c13547a689",
            "filename": "turbopack/crates/turbopack-core/src/issue/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -878,11 +878,11 @@ impl PlainIssue {\n         processing_path: Vc<OptionIssueProcessingPathItems>,\n     ) -> Result<Vc<Self>> {\n         let description: Option<StyledString> = match *issue.description().await? {\n-            Some(description) => Some((*description.await?).clone()),\n+            Some(description) => Some(description.owned().await?),\n             None => None,\n         };\n         let detail = match *issue.detail().await? {\n-            Some(detail) => Some((*detail.await?).clone()),\n+            Some(detail) => Some(detail.owned().await?),\n             None => None,\n         };\n         let trait_ref = issue.into_trait_ref().await?;"
        },
        {
            "sha": "4981769bbed53687f5875df23df3e3fdca0f43fa",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -764,7 +764,7 @@ impl SingleModuleGraph {\n     ) -> Result<FxHashMap<ResolvedVc<Box<dyn Issue>>, Vec<ImportTrace>>> {\n         let issue_paths = issues\n             .iter()\n-            .map(|issue| async move { Ok((*issue.file_path().await?).clone()) })\n+            .map(|issue| issue.file_path().owned())\n             .try_join()\n             .await?;\n         let mut file_path_to_traces: FxHashMap<FileSystemPath, Vec<ImportTrace>> =\n@@ -775,14 +775,14 @@ impl SingleModuleGraph {\n         }\n \n         {\n-            let modules = self\n-                .modules\n-                .iter()\n-                .map(|(module, &index)| async move {\n-                    Ok(((*module.ident().path().await?).clone(), index))\n-                })\n-                .try_join()\n-                .await?;\n+            let modules =\n+                self.modules\n+                    .iter()\n+                    .map(|(module, &index)| async move {\n+                        Ok((module.ident().path().owned().await?, index))\n+                    })\n+                    .try_join()\n+                    .await?;\n             // Reverse the graph so we can find paths to roots\n             let reversed_graph = Reversed(&self.graph.0);\n             for (path, module_idx) in modules {"
        },
        {
            "sha": "60d14faee0728936de717de4167a5d28f150b0d4",
            "filename": "turbopack/crates/turbopack-core/src/resolve/options.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Foptions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Foptions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Foptions.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -281,7 +281,10 @@ impl AliasTemplate for Vc<ImportMapping> {\n                         .await?,\n                 ),\n                 ImportMapping::Dynamic(replacement) => {\n-                    (*replacement.replace(Pattern::new(capture.clone())).await?).clone()\n+                    replacement\n+                        .replace(Pattern::new(capture.clone()))\n+                        .owned()\n+                        .await?\n                 }\n             }\n             .resolved_cell())"
        },
        {
            "sha": "ec8d5166713b3f7357f2e147f827bfcab23edf15",
            "filename": "turbopack/crates/turbopack-css/src/process.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -65,7 +65,7 @@ async fn get_lightningcss_browser_targets(\n ) -> Result<Vc<LightningCssTargets>> {\n     match environment {\n         Some(environment) => {\n-            let browserslist_query = (*environment.browserslist_query().await?).clone();\n+            let browserslist_query = environment.browserslist_query().owned().await?;\n             let browserslist_browsers =\n                 lightningcss::targets::Browsers::from_browserslist_with_config(\n                     browserslist_query.split(','),"
        },
        {
            "sha": "162db3d45f05a567b206d0008c5ba74ffc9e05ba",
            "filename": "turbopack/crates/turbopack-ecmascript/src/manifest/loader_item.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Floader_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Floader_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Floader_item.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -95,7 +95,7 @@ impl ChunkItem for ManifestLoaderChunkItem {\n     #[turbo_tasks::function]\n     async fn references(self: Vc<Self>) -> Result<Vc<OutputAssets>> {\n         let this = self.await?;\n-        let mut references = (*this.manifest.manifest_chunks().await?).clone();\n+        let mut references = this.manifest.manifest_chunks().owned().await?;\n         for chunk_data in &*self.chunks_data().await? {\n             references.extend(chunk_data.references().await?);\n         }"
        },
        {
            "sha": "56d30b501af62bbce0aabb7c112a5f1ae68506af",
            "filename": "turbopack/crates/turbopack-resolve/src/typescript.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e3a1aba8ed55afe04b0cad6de79e855efc4b1262/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs?ref=e3a1aba8ed55afe04b0cad6de79e855efc4b1262",
            "patch": "@@ -282,7 +282,7 @@ pub async fn tsconfig_resolve_options(\n     })\n     .await?\n     {\n-        (*base_url.await?).clone()\n+        base_url.owned().await?\n     } else {\n         None\n     };"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 49,
        "deletions": 32
    }
}