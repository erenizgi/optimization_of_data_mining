{
    "author": "eps1lon",
    "message": "[sourcemaps] Fully sourcemap stacks on the Server (#81904)",
    "sha": "c081cf7c88c25bc581e5e67baf31c9afce2b31de",
    "files": [
        {
            "sha": "fea7362a046394cd28eebad5304faa9be534e65d",
            "filename": "packages/next/src/server/app-render/collect-segment-data.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx?ref=c081cf7c88c25bc581e5e67baf31c9afce2b31de",
            "patch": "@@ -69,6 +69,11 @@ const filterStackFrame =\n     ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n         .filterStackFrameDEV\n     : undefined\n+const findSourceMapURL =\n+  process.env.NODE_ENV !== 'production'\n+    ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+        .findSourceMapURLDEV\n+    : undefined\n \n function onSegmentPrerenderError(error: unknown) {\n   const digest = getDigestForWellKnownError(error)\n@@ -98,6 +103,7 @@ export async function collectSegmentData(\n   //\n   try {\n     await createFromReadableStream(streamFromBuffer(fullPageDataBuffer), {\n+      findSourceMapURL,\n       serverConsumerManifest,\n     })\n     await waitAtLeastOneReactRenderTask()\n@@ -179,6 +185,7 @@ async function PrefetchTreeData({\n   const initialRSCPayload: InitialRSCPayload = await createFromReadableStream(\n     createUnclosingPrefetchStream(streamFromBuffer(fullPageDataBuffer)),\n     {\n+      findSourceMapURL,\n       serverConsumerManifest,\n     }\n   )"
        },
        {
            "sha": "a7eb39df53565d24b948d7499d2f97c5c97e18e8",
            "filename": "packages/next/src/server/app-render/encryption.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts?ref=c081cf7c88c25bc581e5e67baf31c9afce2b31de",
            "patch": "@@ -30,6 +30,17 @@ const isEdgeRuntime = process.env.NEXT_RUNTIME === 'edge'\n const textEncoder = new TextEncoder()\n const textDecoder = new TextDecoder()\n \n+const filterStackFrame =\n+  process.env.NODE_ENV !== 'production'\n+    ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+        .filterStackFrameDEV\n+    : undefined\n+const findSourceMapURL =\n+  process.env.NODE_ENV !== 'production'\n+    ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+        .findSourceMapURLDEV\n+    : undefined\n+\n /**\n  * Decrypt the serialized string with the action id as the salt.\n  */\n@@ -140,12 +151,6 @@ export const encryptActionBoundArgs = React.cache(\n       })\n     }\n \n-    const filterStackFrame =\n-      process.env.NODE_ENV !== 'production'\n-        ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n-            .filterStackFrameDEV\n-        : undefined\n-\n     // Using Flight to serialize the args into a string.\n     const serialized = await streamToString(\n       renderToReadableStream(args, clientModules, {\n@@ -282,6 +287,7 @@ export async function decryptActionBoundArgs(\n       },\n     }),\n     {\n+      findSourceMapURL,\n       serverConsumerManifest: {\n         // moduleLoading must be null because we don't want to trigger preloads of ClientReferences\n         // to be added to the current execution. Instead, we'll wait for any ClientReference"
        },
        {
            "sha": "efcb291623f18311874eef6a3233888ec615387f",
            "filename": "packages/next/src/server/app-render/use-flight-response.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx?ref=c081cf7c88c25bc581e5e67baf31c9afce2b31de",
            "patch": "@@ -16,6 +16,12 @@ const INLINE_FLIGHT_PAYLOAD_BINARY = 3\n const flightResponses = new WeakMap<BinaryStreamOf<any>, Promise<any>>()\n const encoder = new TextEncoder()\n \n+const findSourceMapURL =\n+  process.env.NODE_ENV !== 'production'\n+    ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+        .findSourceMapURLDEV\n+    : undefined\n+\n /**\n  * Render Flight stream.\n  * This is only used for renderToHTML, the Flight response does not need additional wrappers.\n@@ -37,6 +43,7 @@ export function useFlightStream<T>(\n     require('react-server-dom-webpack/client') as typeof import('react-server-dom-webpack/client')\n \n   const newResponse = createFromReadableStream<T>(flightStream, {\n+    findSourceMapURL,\n     serverConsumerManifest: {\n       moduleLoading: clientReferenceManifest.moduleLoading,\n       moduleMap: isEdgeRuntime"
        },
        {
            "sha": "3b09ccd4ae46ba42bf36a8e82bd306be965c39af",
            "filename": "packages/next/src/server/lib/source-maps.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts?ref=c081cf7c88c25bc581e5e67baf31c9afce2b31de",
            "patch": "@@ -1,4 +1,5 @@\n import type { SourceMap } from 'module'\n+import { LRUCache } from './lru-cache'\n \n function noSourceMap(): SourceMap | undefined {\n   return undefined\n@@ -164,6 +165,49 @@ export function filterStackFrameDEV(\n   }\n }\n \n+const invalidSourceMap = Symbol('invalid-source-map')\n+const sourceMapURLs = new LRUCache<string | typeof invalidSourceMap>(\n+  512 * 1024 * 1024,\n+  (url) =>\n+    url === invalidSourceMap\n+      ? // Ideally we'd account for key length. So we just guestimate a small source map\n+        // so that we don't create a huge cache with empty source maps.\n+        8 * 1024\n+      : // these URLs contain only ASCII characters so .length is equal to Buffer.byteLength\n+        url.length\n+)\n+export function findSourceMapURLDEV(\n+  scriptNameOrSourceURL: string\n+): string | null {\n+  let sourceMapURL = sourceMapURLs.get(scriptNameOrSourceURL)\n+  if (sourceMapURL === undefined) {\n+    let sourceMapPayload: ModernSourceMapPayload | undefined\n+    try {\n+      sourceMapPayload = findSourceMap(scriptNameOrSourceURL)?.payload\n+    } catch (cause) {\n+      console.error(\n+        `${scriptNameOrSourceURL}: Invalid source map. Only conformant source maps can be used to find the original code. Cause: ${cause}`\n+      )\n+    }\n+\n+    if (sourceMapPayload === undefined) {\n+      sourceMapURL = invalidSourceMap\n+    } else {\n+      // TODO: Might be more efficient to extract the relevant section from Index Maps.\n+      // Unclear if that search is worth the smaller payload we have to stringify.\n+      const sourceMapJSON = JSON.stringify(sourceMapPayload)\n+      const sourceMapURLData = Buffer.from(sourceMapJSON, 'utf8').toString(\n+        'base64'\n+      )\n+      sourceMapURL = `data:application/json;base64,${sourceMapURLData}`\n+    }\n+\n+    sourceMapURLs.set(scriptNameOrSourceURL, sourceMapURL)\n+  }\n+\n+  return sourceMapURL === invalidSourceMap ? null : sourceMapURL\n+}\n+\n export function devirtualizeReactServerURL(sourceURL: string): string {\n   if (sourceURL.startsWith('about://React/')) {\n     // about://React/Server/file://<filename>?42 => file://<filename>"
        },
        {
            "sha": "50a57f745917a94cedc32a3f6f972c0083705a22",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=c081cf7c88c25bc581e5e67baf31c9afce2b31de",
            "patch": "@@ -111,6 +111,11 @@ const filterStackFrame =\n     ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n         .filterStackFrameDEV\n     : undefined\n+const findSourceMapURL =\n+  process.env.NODE_ENV !== 'production'\n+    ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+        .findSourceMapURLDEV\n+    : undefined\n \n function generateCacheEntry(\n   workStore: WorkStore,\n@@ -1469,6 +1474,7 @@ export function cache(\n       }\n \n       return createFromReadableStream(stream, {\n+        findSourceMapURL,\n         serverConsumerManifest,\n         temporaryReferences,\n         replayConsoleLogs,"
        },
        {
            "sha": "946fda28e50012cc484bbbc5ca0d7298e4f77455",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c081cf7c88c25bc581e5e67baf31c9afce2b31de/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=c081cf7c88c25bc581e5e67baf31c9afce2b31de",
            "patch": "@@ -68,9 +68,9 @@ declare module 'react-server-dom-webpack/client' {\n   export function createServerReference(\n     id: string,\n     callServer: CallServerCallback,\n-    encodeFormAction?: EncodeFormActionCallback,\n-    findSourceMapURL?: FindSourceMapURLCallback, // DEV-only\n-    functionName?: string\n+    encodeFormAction: EncodeFormActionCallback | undefined,\n+    findSourceMapURL: FindSourceMapURLCallback | undefined, // DEV-only\n+    functionName: string | undefined\n   ): (...args: unknown[]) => Promise<unknown>\n \n   export function createTemporaryReferenceSet(\n@@ -100,7 +100,8 @@ declare module 'react-server-dom-webpack/client.browser' {\n   export interface Options {\n     callServer?: CallServerCallback\n     environmentName?: string\n-    findSourceMapURL?: FindSourceMapURLCallback\n+    // It's optional but we want to avoid accidentally omitting it.\n+    findSourceMapURL: FindSourceMapURLCallback | undefined\n     replayConsoleLogs?: boolean\n     temporaryReferences?: TemporaryReferenceSet\n   }\n@@ -300,7 +301,8 @@ declare module 'react-server-dom-webpack/client.edge' {\n     nonce?: string\n     encodeFormAction?: EncodeFormActionCallback\n     temporaryReferences?: TemporaryReferenceSet\n-    findSourceMapURL?: FindSourceMapURLCallback\n+    // It's optional but we want to avoid accidentally omitting it.\n+    findSourceMapURL: FindSourceMapURLCallback | undefined\n     replayConsoleLogs?: boolean\n     environmentName?: string\n   }"
        },
        {
            "sha": "8ca74ea361390f743eca742613a301f9fbf3f636",
            "filename": "test/development/app-dir/cache-components-dev-errors/cache-components-dev-errors.test.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 31,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/c081cf7c88c25bc581e5e67baf31c9afce2b31de/test%2Fdevelopment%2Fapp-dir%2Fcache-components-dev-errors%2Fcache-components-dev-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c081cf7c88c25bc581e5e67baf31c9afce2b31de/test%2Fdevelopment%2Fapp-dir%2Fcache-components-dev-errors%2Fcache-components-dev-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fcache-components-dev-errors%2Fcache-components-dev-errors.test.ts?ref=c081cf7c88c25bc581e5e67baf31c9afce2b31de",
            "patch": "@@ -85,37 +85,17 @@ describe('Cache Components Dev Errors', () => {\n       )\n     })\n \n-    if (isTurbopack) {\n-      const normalizedCliOutput = stripAnsi(\n-        next.cliOutput.slice(outputIndex)\n-      ).replaceAll(`file:` + next.testDir, '<FIXME-file-protocol>')\n-\n-      // TODO(veil): Source mapping breaks due to double-encoding of the square\n-      // brackets.\n-      expect(normalizedCliOutput).toContain(\n-        `\\nError: Route \"/no-accessed-data\": ` +\n-          `A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. ` +\n-          `See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense` +\n-          '\\n    at Page (<FIXME-file-protocol>/app/no-accessed-data/page.js:1:31)' +\n-          '\\n> 1 | export default async function Page() {' +\n-          '\\n    |                               ^' +\n-          '\\n  2 |   await new Promise((r) => setTimeout(r, 200))' +\n-          '\\n  3 |   return <p>Page</p>' +\n-          '\\n  4 | }'\n-      )\n-    } else {\n-      expect(stripAnsi(next.cliOutput.slice(outputIndex))).toContain(\n-        `\\nError: Route \"/no-accessed-data\": ` +\n-          `A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. ` +\n-          `See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense` +\n-          '\\n    at Page (app/no-accessed-data/page.js:1:31)' +\n-          '\\n> 1 | export default async function Page() {' +\n-          '\\n    |                               ^' +\n-          '\\n  2 |   await new Promise((r) => setTimeout(r, 200))' +\n-          '\\n  3 |   return <p>Page</p>' +\n-          '\\n  4 | }'\n-      )\n-    }\n+    expect(stripAnsi(next.cliOutput.slice(outputIndex))).toContain(\n+      `\\nError: Route \"/no-accessed-data\": ` +\n+        `A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. ` +\n+        `See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense` +\n+        '\\n    at Page (app/no-accessed-data/page.js:1:31)' +\n+        '\\n> 1 | export default async function Page() {' +\n+        '\\n    |                               ^' +\n+        '\\n  2 |   await new Promise((r) => setTimeout(r, 200))' +\n+        '\\n  3 |   return <p>Page</p>' +\n+        '\\n  4 | }'\n+    )\n \n     await expect(browser).toDisplayCollapsedRedbox(`\n      {"
        },
        {
            "sha": "a433c35e75425d53585a0167aa07e911045b4b26",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c081cf7c88c25bc581e5e67baf31c9afce2b31de/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c081cf7c88c25bc581e5e67baf31c9afce2b31de/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts?ref=c081cf7c88c25bc581e5e67baf31c9afce2b31de",
            "patch": "@@ -416,11 +416,12 @@ describe('app-dir - server source maps', () => {\n         // Expect the invalid sourcemap warning only once per render.\n         // Dynamic I/O renders three times.\n         // One from filterStackFrameDEV.\n+        // One from findSourceMapURLDEV.\n         expect(\n           normalizeCliOutput(next.cliOutput.slice(outputIndex)).split(\n             'Invalid source map.'\n           ).length - 1\n-        ).toEqual(4)\n+        ).toEqual(5)\n       }\n     } else {\n       // Bundlers silently drop invalid sourcemaps."
        }
    ],
    "stats": {
        "total": 139,
        "additions": 96,
        "deletions": 43
    }
}