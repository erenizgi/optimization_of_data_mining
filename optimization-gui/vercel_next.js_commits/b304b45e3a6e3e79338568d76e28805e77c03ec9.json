{
    "author": "ztanner",
    "message": "bugfix (pages): assetPrefix should not cause hard nav in development (#79176)\n\nIn development when handling the page request, we are sending the\nparsedUrl with the basePath stripped but not assetPrefix. As a result,\nwhen setting an assetPrefix, the chunk would 404 which causes a hard\nnav. It'd then recover and work correctly on subsequent navs.\n\nThis applies the exact same handling we had for basePath, but for\nassetPrefix.\n\nFixes #77241",
    "sha": "b304b45e3a6e3e79338568d76e28805e77c03ec9",
    "files": [
        {
            "sha": "4415b500fdd96ffb8902902858ab90a5d84a4793",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/b304b45e3a6e3e79338568d76e28805e77c03ec9/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b304b45e3a6e3e79338568d76e28805e77c03ec9/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=b304b45e3a6e3e79338568d76e28805e77c03ec9",
            "patch": "@@ -327,11 +327,20 @@ export async function initialize(opts: {\n         if (blockCrossSite(req, res, config.allowedDevOrigins, opts.hostname)) {\n           return\n         }\n+\n         const origUrl = req.url || '/'\n \n+        // both the basePath and assetPrefix need to be stripped from the URL\n+        // so that the development bundler can find the correct file\n         if (config.basePath && pathHasPrefix(origUrl, config.basePath)) {\n           req.url = removePathPrefix(origUrl, config.basePath)\n+        } else if (\n+          config.assetPrefix &&\n+          pathHasPrefix(origUrl, config.assetPrefix)\n+        ) {\n+          req.url = removePathPrefix(origUrl, config.assetPrefix)\n         }\n+\n         const parsedUrl = url.parse(req.url || '/')\n \n         const hotReloaderResult = await developmentBundler.hotReloader.run(\n@@ -343,6 +352,7 @@ export async function initialize(opts: {\n         if (hotReloaderResult.finished) {\n           return hotReloaderResult\n         }\n+\n         req.url = origUrl\n       }\n \n@@ -370,6 +380,11 @@ export async function initialize(opts: {\n \n         if (config.basePath && pathHasPrefix(origUrl, config.basePath)) {\n           req.url = removePathPrefix(origUrl, config.basePath)\n+        } else if (\n+          config.assetPrefix &&\n+          pathHasPrefix(origUrl, config.assetPrefix)\n+        ) {\n+          req.url = removePathPrefix(origUrl, config.assetPrefix)\n         }\n \n         if (resHeaders) {"
        },
        {
            "sha": "1dbff4e94ed541bdc92150d84731783d7135381a",
            "filename": "packages/next/src/server/lib/router-utils/resolve-routes.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/b304b45e3a6e3e79338568d76e28805e77c03ec9/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b304b45e3a6e3e79338568d76e28805e77c03ec9/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts?ref=b304b45e3a6e3e79338568d76e28805e77c03ec9",
            "patch": "@@ -189,8 +189,19 @@ export function getResolveRoutes(\n         parsedUrl.pathname || '',\n         config.basePath\n       )\n+      let normalizedPath = parsedUrl.pathname || '/'\n+\n+      if (config.basePath && pathHasPrefix(normalizedPath, config.basePath)) {\n+        normalizedPath = removePathPrefix(normalizedPath, config.basePath)\n+      } else if (\n+        config.assetPrefix &&\n+        pathHasPrefix(normalizedPath, config.assetPrefix)\n+      ) {\n+        normalizedPath = removePathPrefix(normalizedPath, config.assetPrefix)\n+      }\n+\n       initialLocaleResult = normalizeLocalePath(\n-        removePathPrefix(parsedUrl.pathname || '/', config.basePath),\n+        normalizedPath,\n         config.i18n.locales\n       )\n "
        },
        {
            "sha": "2cd82aaa8370fb2bad130430b0aa8f43993636cc",
            "filename": "test/development/basic/asset-prefix/asset-prefix.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/b304b45e3a6e3e79338568d76e28805e77c03ec9/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Fasset-prefix.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b304b45e3a6e3e79338568d76e28805e77c03ec9/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Fasset-prefix.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Fasset-prefix.test.ts?ref=b304b45e3a6e3e79338568d76e28805e77c03ec9",
            "patch": "@@ -1,6 +1,6 @@\n import { join } from 'path'\n import { nextTestSetup } from 'e2e-utils'\n-import { check } from 'next-test-utils'\n+import { check, retry } from 'next-test-utils'\n \n describe('asset-prefix', () => {\n   const { next } = nextTestSetup({\n@@ -11,7 +11,7 @@ describe('asset-prefix', () => {\n     const browser = await next.browser('/')\n     await browser.eval(`window.__v = 1`)\n \n-    expect(await browser.elementByCss('div').text()).toBe('Hello World')\n+    expect(await browser.elementByCss('#text').text()).toBe('Hello World')\n \n     await check(async () => {\n       const logs = await browser.log()\n@@ -24,6 +24,16 @@ describe('asset-prefix', () => {\n     expect(await browser.eval(`window.__v`)).toBe(1)\n   })\n \n+  it('should navigate to another page without hard navigating', async () => {\n+    const browser = await next.browser('/')\n+    await browser.eval(`window.__v = 1`)\n+    await browser.elementByCss('[href=\"/page2\"]').click()\n+    await retry(async () => {\n+      expect(await browser.elementByCss('div').text()).toBe('Page 2')\n+    })\n+    expect(await browser.eval(`window.__v`)).toBe(1)\n+  })\n+\n   describe('rewrites', () => {\n     it('rewrites that do not start with assetPrefix should still work', async () => {\n       const res = await next.fetch('/not-custom-asset-prefix/api/test-json', {})"
        },
        {
            "sha": "b83c3f1ed80c9b442785f8704c0c597518282d4e",
            "filename": "test/development/basic/asset-prefix/fixture/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b304b45e3a6e3e79338568d76e28805e77c03ec9/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Ffixture%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b304b45e3a6e3e79338568d76e28805e77c03ec9/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Ffixture%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Ffixture%2Fnext.config.js?ref=b304b45e3a6e3e79338568d76e28805e77c03ec9",
            "patch": "@@ -1,4 +1,4 @@\n-const ASSET_PREFIX = 'custom-asset-prefix'\n+const ASSET_PREFIX = '/custom-asset-prefix'\n \n module.exports = {\n   assetPrefix: ASSET_PREFIX,"
        },
        {
            "sha": "939aab78da2ecc117bb61d6154c159270ee550c0",
            "filename": "test/development/basic/asset-prefix/fixture/pages/index.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/b304b45e3a6e3e79338568d76e28805e77c03ec9/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Ffixture%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b304b45e3a6e3e79338568d76e28805e77c03ec9/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Ffixture%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Ffixture%2Fpages%2Findex.js?ref=b304b45e3a6e3e79338568d76e28805e77c03ec9",
            "patch": "@@ -1,5 +1,11 @@\n+import Link from 'next/link'\n import React from 'react'\n \n export default function Page() {\n-  return <div>Hello World</div>\n+  return (\n+    <>\n+      <div id=\"text\">Hello World</div>\n+      <Link href=\"/page2\">Page 2</Link>\n+    </>\n+  )\n }"
        },
        {
            "sha": "e5da4a2e4a91e4b3bc5c671d0eb63f08edb1fe99",
            "filename": "test/development/basic/asset-prefix/fixture/pages/page2.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/b304b45e3a6e3e79338568d76e28805e77c03ec9/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Ffixture%2Fpages%2Fpage2.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b304b45e3a6e3e79338568d76e28805e77c03ec9/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Ffixture%2Fpages%2Fpage2.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fasset-prefix%2Ffixture%2Fpages%2Fpage2.js?ref=b304b45e3a6e3e79338568d76e28805e77c03ec9",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page2() {\n+  return <div>Page 2</div>\n+}"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 50,
        "deletions": 5
    }
}