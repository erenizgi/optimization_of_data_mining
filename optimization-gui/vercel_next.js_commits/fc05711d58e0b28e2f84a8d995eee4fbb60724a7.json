{
    "author": "acdlite",
    "message": "Verify cache-busting param during segment prefetch (#79563)\n\nNot all CDNs respect the Vary header when caching. We must assume that\nonly the URL is used to vary the responses. The Next client computes a\nhash of the header values and sends it as a search param.\n\nBefore responding to a request, we must verify that the hash matches the\nexpected value. Neglecting to do this properly can lead to cache\npoisoning attacks on certain CDNs.\n\nIn this initial PR, the verification I've added only runs during per-\nsegment prefetch requests, since those are the only ones that both vary\non a custom header and are also cacheable. But for safety, we should run\nthis verification for all requests, once we confirm the behavior is\ncorrect. Will need to update our test suite, since there are a handful\nof unit tests that send fetch requests with custom headers but without a\ncorresponding cache-busting search param.\n\nIt would be even better if we stopped using custom request headers, and\ninstead fully encoded everything into the search param. At least for\ncacheable requests.",
    "sha": "fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
    "files": [
        {
            "sha": "c82a0ba6c73cf5685495e8569d49ffb2f8bda8cb",
            "filename": "packages/next/src/client/components/router-reducer/set-cache-busting-search-param.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fset-cache-busting-search-param.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fset-cache-busting-search-param.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fset-cache-busting-search-param.ts?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -1,5 +1,6 @@\n 'use client'\n-import { hexHash } from '../../../shared/lib/hash'\n+\n+import { computeCacheBustingSearchParam } from '../../../shared/lib/router/utils/cache-busting-search-param'\n import {\n   NEXT_ROUTER_PREFETCH_HEADER,\n   NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n@@ -29,14 +30,17 @@ export const setCacheBustingSearchParam = (\n   url: URL,\n   headers: RequestHeaders\n ): void => {\n-  const uniqueCacheKey = hexHash(\n-    [\n-      headers[NEXT_ROUTER_PREFETCH_HEADER] || '0',\n-      headers[NEXT_ROUTER_SEGMENT_PREFETCH_HEADER] || '0',\n-      headers[NEXT_ROUTER_STATE_TREE_HEADER],\n-      headers[NEXT_URL],\n-    ].join(',')\n+  const uniqueCacheKey = computeCacheBustingSearchParam(\n+    headers[NEXT_ROUTER_PREFETCH_HEADER],\n+    headers[NEXT_ROUTER_SEGMENT_PREFETCH_HEADER],\n+    headers[NEXT_ROUTER_STATE_TREE_HEADER],\n+    headers[NEXT_URL]\n   )\n+  if (uniqueCacheKey === null) {\n+    // None of our custom request headers are present. We don't need to set a\n+    // cache-busting search param.\n+    return\n+  }\n \n   /**\n    * Note that we intentionally do not use `url.searchParams.set` here:"
        },
        {
            "sha": "97750a7cb663c0c24b353d0a85742d01f89ff6bb",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -178,6 +178,7 @@ import { InvariantError } from '../shared/lib/invariant-error'\n import { decodeQueryPathParameter } from './lib/decode-query-path-parameter'\n import { getCacheHandlers } from './use-cache/handlers'\n import { fixMojibake } from './lib/fix-mojibake'\n+import { computeCacheBustingSearchParam } from '../shared/lib/router/utils/cache-busting-search-param'\n \n export type FindComponentsResult = {\n   components: LoadComponentsReturnType\n@@ -2074,6 +2075,42 @@ export default abstract class Server<\n     const hasGetInitialProps = !!components.Component?.getInitialProps\n     let isSSG = !!components.getStaticProps\n \n+    // Not all CDNs respect the Vary header when caching. We must assume that\n+    // only the URL is used to vary the responses. The Next client computes a\n+    // hash of the header values and sends it as a search param. Before\n+    // responding to a request, we must verify that the hash matches the\n+    // expected value. Neglecting to do this properly can lead to cache\n+    // poisoning attacks on certain CDNs.\n+    // TODO: This is verification only runs during per-segment prefetch\n+    // requests, since those are the only ones that both vary on a custom\n+    // header and are cacheable. But for safety, we should run this\n+    // verification for all requests, once we confirm the behavior is correct.\n+    // Will need to update our test suite, since there are a handlful of unit\n+    // tests that send fetch requests with custom headers but without a\n+    // corresponding cache-busting search param.\n+    // TODO: Consider not using custom request headers at all, and instead fully\n+    // encode everything into the search param.\n+    if (\n+      this.isAppSegmentPrefetchEnabled &&\n+      getRequestMeta(req, 'segmentPrefetchRSCRequest')\n+    ) {\n+      const headers = req.headers\n+      const expectedHash = computeCacheBustingSearchParam(\n+        headers[NEXT_ROUTER_PREFETCH_HEADER.toLowerCase()],\n+        headers[NEXT_ROUTER_SEGMENT_PREFETCH_HEADER.toLowerCase()],\n+        headers[NEXT_ROUTER_STATE_TREE_HEADER.toLowerCase()],\n+        headers[NEXT_URL.toLowerCase()]\n+      )\n+      const actualHash = getRequestMeta(req, 'cacheBustingSearchParam') ?? null\n+      if (expectedHash !== actualHash) {\n+        // The hash sent by the client does not match the expected value.\n+        // Respond with an error.\n+        res.statusCode = 400\n+        res.body('Bad Request').send()\n+        return null\n+      }\n+    }\n+\n     // Compute the iSSG cache key. We use the rewroteUrl since\n     // pages with fallback: false are allowed to be rewritten to\n     // and we need to look up the path by the rewritten path\n@@ -3830,6 +3867,11 @@ export default abstract class Server<\n     let page = pathname\n     const bubbleNoFallback =\n       getRequestMeta(ctx.req, 'bubbleNoFallback') ?? false\n+    addRequestMeta(\n+      ctx.req,\n+      'cacheBustingSearchParam',\n+      query[NEXT_RSC_UNION_QUERY]\n+    )\n     delete query[NEXT_RSC_UNION_QUERY]\n \n     const options: MatchOptions = {"
        },
        {
            "sha": "d6f08d1c22d614f9def3893f8724649499429907",
            "filename": "packages/next/src/server/request-meta.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -90,6 +90,17 @@ export interface RequestMeta {\n    */\n   isRSCRequest?: true\n \n+  /**\n+   * A search param set by the Next.js client when performing RSC requests.\n+   * Because some CDNs do not vary their cache entries on our custom headers,\n+   * this search param represents a hash of the header values. For any cached\n+   * RSC request, we should verify that the hash matches before responding.\n+   * Otherwise this can lead to cache poisoning.\n+   * TODO: Consider not using custom request headers at all, and instead encode\n+   * everything into the search param.\n+   */\n+  cacheBustingSearchParam?: string\n+\n   /**\n    * True when the request is for the `/_next/data` route using the pages\n    * router."
        },
        {
            "sha": "f827c6c438b23365d396d616260b73c9e5bebc18",
            "filename": "packages/next/src/shared/lib/router/utils/cache-busting-search-param.ts",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fcache-busting-search-param.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fcache-busting-search-param.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fcache-busting-search-param.ts?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -0,0 +1,25 @@\n+import { hexHash } from '../../hash'\n+\n+export function computeCacheBustingSearchParam(\n+  prefetchHeader: string | string[] | undefined,\n+  segmentPrefetchHeader: string | string[] | undefined,\n+  stateTreeHeader: string | string[] | undefined,\n+  nextUrlHeader: string | string[] | undefined\n+): string | null {\n+  if (\n+    prefetchHeader === undefined &&\n+    segmentPrefetchHeader === undefined &&\n+    stateTreeHeader === undefined &&\n+    nextUrlHeader === undefined\n+  ) {\n+    return null\n+  }\n+  return hexHash(\n+    [\n+      prefetchHeader || '0',\n+      segmentPrefetchHeader || '0',\n+      stateTreeHeader || '0',\n+      nextUrlHeader || '0',\n+    ].join(',')\n+  )\n+}"
        },
        {
            "sha": "a9f03d649ac0f021c04425316fc4d4fdbc076371",
            "filename": "test/e2e/app-dir/ppr-navigations/simple/app/[locale]/about/page.jsx",
            "status": "removed",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2F%5Blocale%5D%2Fabout%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2F%5Blocale%5D%2Fabout%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2F%5Blocale%5D%2Fabout%2Fpage.jsx?ref=7187dc241723bb94f198bb47e99e664e3a24cc84",
            "patch": "@@ -1,9 +0,0 @@\n-import { TestPage } from '../../../components/page'\n-\n-export default async function Page(props) {\n-  const params = await props.params\n-\n-  const { locale } = params\n-\n-  return <TestPage pathname={`/${locale}/about`} />\n-}"
        },
        {
            "sha": "9a9315cdfd84ecfe65f3b5d59aff7c3d678b2ac6",
            "filename": "test/e2e/app-dir/ppr-navigations/simple/app/[locale]/layout.jsx",
            "status": "removed",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2F%5Blocale%5D%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2F%5Blocale%5D%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2F%5Blocale%5D%2Flayout.jsx?ref=7187dc241723bb94f198bb47e99e664e3a24cc84",
            "patch": "@@ -1,19 +0,0 @@\n-import { locales } from '../../components/page'\n-\n-export async function generateStaticParams() {\n-  return locales.map((locale) => ({ locale }))\n-}\n-\n-export default async function Layout(props) {\n-  const params = await props.params\n-\n-  const { locale } = params\n-\n-  const { children } = props\n-\n-  return (\n-    <html lang={locale}>\n-      <body>{children}</body>\n-    </html>\n-  )\n-}"
        },
        {
            "sha": "873daac7a1ae735e8551edb2d13d42997f7aeda6",
            "filename": "test/e2e/app-dir/ppr-navigations/simple/app/[locale]/page.jsx",
            "status": "removed",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2F%5Blocale%5D%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2F%5Blocale%5D%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2F%5Blocale%5D%2Fpage.jsx?ref=7187dc241723bb94f198bb47e99e664e3a24cc84",
            "patch": "@@ -1,9 +0,0 @@\n-import { TestPage } from '../../components/page'\n-\n-export default async function Page(props) {\n-  const params = await props.params\n-\n-  const { locale } = params\n-\n-  return <TestPage pathname={`/${locale}`} />\n-}"
        },
        {
            "sha": "caaaf5ccdf7b10742cc7ac2301768a9e4099dc74",
            "filename": "test/e2e/app-dir/ppr-navigations/simple/app/layout.jsx",
            "status": "removed",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2Flayout.jsx?ref=7187dc241723bb94f198bb47e99e664e3a24cc84",
            "patch": "@@ -1,3 +0,0 @@\n-export default ({ children }) => {\n-  return children\n-}"
        },
        {
            "sha": "a2fc5a8b040eae701564ee938b26c9c684a113c5",
            "filename": "test/e2e/app-dir/ppr-navigations/simple/app/page.jsx",
            "status": "removed",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fapp%2Fpage.jsx?ref=7187dc241723bb94f198bb47e99e664e3a24cc84",
            "patch": "@@ -1,7 +0,0 @@\n-import { redirect } from 'next/navigation'\n-import { locales } from '../components/page'\n-\n-export default () => {\n-  // Redirect to the default locale\n-  return redirect(`/${locales[0]}`)\n-}"
        },
        {
            "sha": "92b7ea6a07d2f103d7532f8b1eac83a0f09b37fd",
            "filename": "test/e2e/app-dir/ppr-navigations/simple/components/page.jsx",
            "status": "removed",
            "additions": 0,
            "deletions": 40,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fcomponents%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fcomponents%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fcomponents%2Fpage.jsx?ref=7187dc241723bb94f198bb47e99e664e3a24cc84",
            "patch": "@@ -1,40 +0,0 @@\n-import { unstable_noStore } from 'next/cache'\n-import Link from 'next/link'\n-import { Suspense } from 'react'\n-\n-export const locales = ['en', 'fr']\n-\n-export const links = [\n-  { href: '/', text: 'Home' },\n-  ...locales\n-    .map((locale) => {\n-      return [\n-        { href: `/${locale}`, text: locale },\n-        { href: `/${locale}/about`, text: `${locale} - About` },\n-      ]\n-    })\n-    .flat(),\n-]\n-\n-function Dynamic() {\n-  unstable_noStore()\n-  return <div id=\"dynamic\">Dynamic</div>\n-}\n-\n-export function TestPage({ pathname }) {\n-  return (\n-    <div>\n-      <ul>\n-        {links.map(({ href, text }) => (\n-          <li key={href}>\n-            <Link href={href}>{text}</Link>\n-          </li>\n-        ))}\n-      </ul>\n-      <code data-value={pathname}>{pathname}</code>\n-      <Suspense fallback={<div>Loading...</div>}>\n-        <Dynamic />\n-      </Suspense>\n-    </div>\n-  )\n-}"
        },
        {
            "sha": "1f8082a9ba6455c14d61f0d8a28e4306bcf4f87b",
            "filename": "test/e2e/app-dir/ppr-navigations/simple/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fnext.config.js?ref=7187dc241723bb94f198bb47e99e664e3a24cc84",
            "patch": "@@ -1,6 +0,0 @@\n-module.exports = {\n-  experimental: {\n-    ppr: true,\n-    clientSegmentCache: true,\n-  },\n-}"
        },
        {
            "sha": "202d207ceb359dbfce571ce05866b499eaf08aba",
            "filename": "test/e2e/app-dir/ppr-navigations/simple/per-segment-prefetching.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 65,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fper-segment-prefetching.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fper-segment-prefetching.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fper-segment-prefetching.test.ts?ref=7187dc241723bb94f198bb47e99e664e3a24cc84",
            "patch": "@@ -1,65 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-\n-describe('per segment prefetching', () => {\n-  const { next, isNextDev, isNextDeploy } = nextTestSetup({\n-    files: __dirname,\n-  })\n-\n-  if (isNextDev || isNextDeploy) {\n-    test('ppr is disabled', () => {})\n-    return\n-  }\n-\n-  // This feature is only partially implemented; the client does not yet issue\n-  // these types of requests. This tests that the server responds correctly.\n-  // TODO: Replace with e2e tests once more is implemented.\n-\n-  function prefetch(pageUrl, segmentPath) {\n-    return next.fetch(pageUrl, {\n-      headers: {\n-        RSC: '1',\n-        'Next-Router-Prefetch': '1',\n-        'Next-Router-Segment-Prefetch': segmentPath,\n-      },\n-    })\n-  }\n-\n-  function extractPseudoJSONFromFlightResponse(flightText: string) {\n-    // This is a cheat that takes advantage of the fact that the roots of the\n-    // Flight responses in this test are JSON. Again, this is just a temporary\n-    // smoke test until the client part is implemented; we shouldn't rely on\n-    // this as a general testing strategy.\n-    const match = flightText.match(/^0:(.*)$/m)\n-    if (match) {\n-      return JSON.parse(match[1])\n-    }\n-    return null\n-  }\n-\n-  it('basic route tree prefetch', async () => {\n-    // To perform a prefetch a page, the client first fetches the route tree.\n-    // The response is used to construct prefetches of individual segments.\n-    const routeTreeResponse = await prefetch('/en', '/_tree')\n-    const routeTreeResponseText = await routeTreeResponse.text()\n-    const routeTree = extractPseudoJSONFromFlightResponse(routeTreeResponseText)\n-\n-    // Confirm that the prefetch was successful. This is a basic check to ensure\n-    // that the name of an expected field is present in the response.\n-    expect(typeof routeTree.staleTime).toBe('number')\n-\n-    // The root segment is a shared segment. Demonstrate that fetching the root\n-    // segment for two different pages results in the same response.\n-    const enResponse = await prefetch('/en', '/')\n-    const enResponseText = await enResponse.text()\n-    const frResponse = await prefetch('/fr', '/')\n-    const frResponseText = await frResponse.text()\n-    expect(enResponseText).toEqual(frResponseText)\n-  })\n-\n-  it('respond with 204 if the segment does not have prefetch data', async () => {\n-    const response = await prefetch('/en', '/does-not-exist')\n-    expect(response.status).toBe(204)\n-    const responseText = await response.text()\n-    expect(responseText.trim()).toBe('')\n-  })\n-})"
        },
        {
            "sha": "b09008793065e4c463333a942773d4430289794c",
            "filename": "test/e2e/app-dir/ppr-navigations/simple/simple.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 31,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fsimple.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7187dc241723bb94f198bb47e99e664e3a24cc84/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fsimple.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-navigations%2Fsimple%2Fsimple.test.ts?ref=7187dc241723bb94f198bb47e99e664e3a24cc84",
            "patch": "@@ -1,31 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-import { locales } from './components/page'\n-\n-describe('ppr-navigations simple', () => {\n-  const { next } = nextTestSetup({\n-    files: __dirname,\n-  })\n-\n-  it('can navigate between all the links and back', async () => {\n-    const browser = await next.browser('/')\n-\n-    try {\n-      for (const href of ['/fr/about', '/fr', '/en/about', '/en', '/']) {\n-        // Find the link element for the href and click it.\n-        await browser.elementByCss(`a[href=\"${href}\"]`).click()\n-\n-        // Wait for that page to load.\n-        if (href === '/') {\n-          // The root page redirects to the first locale.\n-          await browser.waitForElementByCss(`[data-value=\"/${locales[0]}\"]`)\n-        } else {\n-          await browser.waitForElementByCss(`[data-value=\"${href}\"]`)\n-        }\n-\n-        await browser.elementByCss('#dynamic')\n-      }\n-    } finally {\n-      await browser.close()\n-    }\n-  })\n-})"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/segment-cache/cdn-cache-busting/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fapp%2Flayout.tsx?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "97adcb5effe9bbb3fec5dcfebe2ec4a10fd368f7",
            "filename": "test/e2e/app-dir/segment-cache/cdn-cache-busting/app/page.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fapp%2Fpage.tsx?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -0,0 +1,11 @@\n+import { LinkAccordion } from '../components/link-accordion'\n+\n+export default function Page() {\n+  return (\n+    <ul>\n+      <li>\n+        <LinkAccordion href=\"/target-page\">Target page</LinkAccordion>\n+      </li>\n+    </ul>\n+  )\n+}"
        },
        {
            "sha": "b6cc8264dd6b22755533a7dcfc1774233d082a1d",
            "filename": "test/e2e/app-dir/segment-cache/cdn-cache-busting/app/target-page/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fapp%2Ftarget-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fapp%2Ftarget-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fapp%2Ftarget-page%2Fpage.tsx?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -0,0 +1,3 @@\n+export default function TargetPage() {\n+  return <div id=\"target-page\">Target page</div>\n+}"
        },
        {
            "sha": "41effd6e2ca3ae5c04f0f60f79bcefaf7d962356",
            "filename": "test/e2e/app-dir/segment-cache/cdn-cache-busting/cdn-cache-busting.test.ts",
            "status": "added",
            "additions": 97,
            "deletions": 0,
            "changes": 97,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fcdn-cache-busting.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fcdn-cache-busting.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fcdn-cache-busting.test.ts?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -0,0 +1,97 @@\n+import type * as Playwright from 'playwright'\n+import webdriver from 'next-webdriver'\n+import { createRouterAct } from '../router-act'\n+import { findPort, nextBuild } from 'next-test-utils'\n+import { isNextDeploy, isNextDev } from 'e2e-utils'\n+import { start } from './server.mjs'\n+\n+describe('segment cache (CDN cache busting)', () => {\n+  if (isNextDev || isNextDeploy) {\n+    test('should not run during dev or deploy test runs', () => {})\n+    return\n+  }\n+\n+  // To debug these tests locally, run:\n+  //   node start.mjs\n+  //\n+  // This will start the Next app and also a proxy server that simulates a CDN.\n+  // Like certain real-world CDNs, our fake CDN doesn't respect the Vary header.\n+  // It only uses the URL.\n+  let cleanup: () => Promise<void>\n+  let port: number\n+\n+  beforeAll(async () => {\n+    const appDir = __dirname\n+    await nextBuild(appDir, undefined, { cwd: appDir })\n+    const proxyPort = (port = await findPort())\n+    const nextPort = await findPort()\n+    cleanup = await start(proxyPort, nextPort)\n+  })\n+\n+  afterAll(async () => {\n+    await cleanup()\n+  })\n+\n+  it(\n+    \"perform fully prefetched navigation with a CDN that doesn't respect \" +\n+      'the Vary header',\n+    async () => {\n+      let act\n+      const browser = await webdriver(port, '/', {\n+        beforePageLoad(p: Playwright.Page) {\n+          act = createRouterAct(p)\n+        },\n+      })\n+\n+      // Initiate a prefetch. Each segment will be prefetched individually,\n+      // using the pathname of the target page and a custom header specifying\n+      // the segment. If we didn't also set a cache-busting search param, then\n+      // the fake CDN used by this test suite would incorrectly use the same\n+      // entry for every segment, poisoning the cache.\n+      await act(\n+        async () => {\n+          const linkToggle = await browser.elementByCss(\n+            '[data-link-accordion=\"/target-page\"]'\n+          )\n+          await linkToggle.click()\n+        },\n+        {\n+          includes: 'Target page',\n+        }\n+      )\n+\n+      // Navigate to the prefetched target page.\n+      await act(async () => {\n+        const link = await browser.elementByCss('a[href=\"/target-page\"]')\n+        await link.click()\n+\n+        // The page was prefetched, so we're able to render the target\n+        // page immediately.\n+        const div = await browser.elementById('target-page')\n+        expect(await div.text()).toBe('Target page')\n+      }, 'no-requests')\n+    }\n+  )\n+\n+  it(\n+    'prevent cache poisoning attacks by responding with an error if a custom ' +\n+      'header is sent during a prefetch without a corresponding cache-busting ' +\n+      'search param',\n+    async () => {\n+      const browser = await webdriver(port, '/')\n+      const { status, text } = await browser.eval(async () => {\n+        const res = await fetch('/target-page', {\n+          headers: {\n+            RSC: '1',\n+            'Next-Router-Prefetch': '1',\n+            'Next-Router-Segment-Prefetch': '/_tree',\n+          },\n+        })\n+        return { status: res.status, text: await res.text() }\n+      })\n+\n+      expect(status).toBe(400)\n+      expect(text).toContain('Bad Request')\n+    }\n+  )\n+})"
        },
        {
            "sha": "c735a55918b5489458940dcdd29daa6f2ec50315",
            "filename": "test/e2e/app-dir/segment-cache/cdn-cache-busting/components/link-accordion.tsx",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fcomponents%2Flink-accordion.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fcomponents%2Flink-accordion.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fcomponents%2Flink-accordion.tsx?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -0,0 +1,33 @@\n+'use client'\n+\n+import Link from 'next/link'\n+import { useState } from 'react'\n+\n+export function LinkAccordion({\n+  href,\n+  children,\n+  prefetch,\n+}: {\n+  href: string\n+  children: React.ReactNode\n+  prefetch?: boolean\n+}) {\n+  const [isVisible, setIsVisible] = useState(false)\n+  return (\n+    <>\n+      <input\n+        type=\"checkbox\"\n+        checked={isVisible}\n+        onChange={() => setIsVisible(!isVisible)}\n+        data-link-accordion={href}\n+      />\n+      {isVisible ? (\n+        <Link href={href} prefetch={prefetch}>\n+          {children}\n+        </Link>\n+      ) : (\n+        <>{children} (link is hidden)</>\n+      )}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "95c9aba3059b6ba0e7d3f90a9bf2c1525e40ae23",
            "filename": "test/e2e/app-dir/segment-cache/cdn-cache-busting/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fnext.config.js?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    clientSegmentCache: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "40321a1d960472662aa9b7ad6e20817102c5c802",
            "filename": "test/e2e/app-dir/segment-cache/cdn-cache-busting/server.mjs",
            "status": "added",
            "additions": 154,
            "deletions": 0,
            "changes": 154,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fserver.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fserver.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fserver.mjs?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -0,0 +1,154 @@\n+import { fileURLToPath } from 'url'\n+import { dirname } from 'path'\n+import { spawn } from 'child_process'\n+import { createServer } from 'node:http'\n+import httpProxy from 'http-proxy'\n+import process from 'node:process'\n+import { createGunzip } from 'zlib'\n+\n+const dir = dirname(fileURLToPath(import.meta.url))\n+\n+async function spawnNext(port) {\n+  const child = spawn('pnpm', ['next', 'start', '-p', port, dir], {\n+    env: process.env,\n+    stdio: ['inherit', 'pipe', 'inherit'],\n+  })\n+\n+  child.stdout.pipe(process.stdout)\n+\n+  // Wait until the server is listening.\n+  return new Promise((resolve, reject) => {\n+    child.stdout.on('data', (data) => {\n+      if (data.toString().includes('Ready')) {\n+        resolve(child)\n+      }\n+    })\n+    child.on('exit', (code) => {\n+      if (code === 0) {\n+        resolve(child)\n+      } else {\n+        reject(new Error(`Next.js server exited with code ${code}`))\n+      }\n+    })\n+  })\n+}\n+\n+function isCacheableRequest(req) {\n+  return (\n+    req.method === 'GET' && !req.headers['cache-control']?.includes('no-store')\n+  )\n+}\n+\n+function isCacheableResponse(res) {\n+  return !res.headers['cache-control']?.includes('no-store')\n+}\n+\n+async function createFakeCDN(destPort) {\n+  const fakeCDNCache = new Map()\n+\n+  const proxy = httpProxy.createProxyServer()\n+  const cdnServer = createServer(async (req, res) => {\n+    if (isCacheableRequest(req)) {\n+      // Serve from our fake CDN if there's a matching entry.\n+      const entry = await fakeCDNCache.get(req.url)\n+      if (entry) {\n+        console.log('Serving from fake CDN:', req.url)\n+        res.writeHead(entry.statusCode, entry.statusMessage, entry.headers)\n+        res.end(entry.data)\n+        return\n+      } else {\n+        // No existing entry. Proxy to the Next.js server and then store\n+        // the response in the cache.\n+        proxy.web(req, res, {\n+          target: `http://localhost:${destPort}`,\n+          selfHandleResponse: true,\n+        })\n+      }\n+    } else {\n+      // This request isn't cacheable.\n+      proxy.web(req, res, { target: `http://localhost:${destPort}` })\n+    }\n+  })\n+\n+  proxy.on('proxyRes', function (proxyRes, req, res) {\n+    // If the response is cacheable, store it in a map to simulate a CDN.\n+    //\n+    // Note that we only key the entry on the URL, not any of the headers. i.e.\n+    // we don't respect the Vary header. This is true of certain real CDNs, so\n+    // Next.js must not rely on Vary.\n+    //\n+    // For the purposes of this test we don't respect max-age et al. Every\n+    // entry is cached indefinitely.\n+    if (isCacheableRequest(req) && isCacheableResponse(proxyRes)) {\n+      let resolveCDNEntry\n+      fakeCDNCache.set(req.url, new Promise((res) => (resolveCDNEntry = res)))\n+\n+      // Decompress the original response stream, if needed\n+      let source\n+      if (proxyRes.headers['content-encoding'] === 'gzip') {\n+        source = proxyRes.pipe(createGunzip())\n+        // Just store the uncompressed body and serve that from cache.\n+        // Good enough for the purposes of this test app.\n+        delete proxyRes.headers['content-encoding']\n+      } else {\n+        source = proxyRes\n+      }\n+\n+      const chunks = []\n+      source.on('data', (chunk) => {\n+        chunks.push(chunk)\n+      })\n+      source.on('end', () => {\n+        const data = Buffer.concat(chunks)\n+        // Send response after we've collected all chunks\n+        res.writeHead(\n+          proxyRes.statusCode || 200,\n+          proxyRes.statusMessage,\n+          proxyRes.headers\n+        )\n+        res.end(data)\n+\n+        // Store the raw data for later use\n+        const entry = {\n+          data,\n+          statusCode: proxyRes.statusCode,\n+          statusMessage: proxyRes.statusMessage,\n+          headers: proxyRes.headers,\n+        }\n+        resolveCDNEntry(entry)\n+      })\n+      return\n+    }\n+    // If the response isn't cacheable, pipe it through to the client.\n+    proxyRes.pipe(res)\n+    return\n+  })\n+\n+  return cdnServer\n+}\n+\n+export async function start(cdnPort = 3000, nextPort = cdnPort + 1) {\n+  const next = await spawnNext(nextPort)\n+  const cdnServer = await createFakeCDN(nextPort)\n+\n+  const onTerminate = () => {\n+    cdnServer.close()\n+    next.kill()\n+    process.exit(0)\n+  }\n+  process.on('SIGINT', onTerminate)\n+  process.on('SIGTERM', onTerminate)\n+\n+  const cleanup = async () => {\n+    next.kill()\n+    await new Promise((resolve) => cdnServer.close(resolve))\n+  }\n+\n+  return new Promise((resolve, reject) => {\n+    cdnServer.on('error', reject)\n+    cdnServer.listen(cdnPort, () => {\n+      console.log('Server is listening', cdnPort)\n+      resolve(cleanup)\n+    })\n+  })\n+}"
        },
        {
            "sha": "22779f729504c2e4819d8151fdabb8f70286a1ca",
            "filename": "test/e2e/app-dir/segment-cache/cdn-cache-busting/start.mjs",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fstart.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fstart.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fstart.mjs?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -0,0 +1,3 @@\n+import { start } from './server.mjs'\n+\n+await start()"
        },
        {
            "sha": "fb02abf42d0ab2e6f4531bfe687340a279528e78",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/conflicting-routes.test.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 22,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc05711d58e0b28e2f84a8d995eee4fbb60724a7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts?ref=fc05711d58e0b28e2f84a8d995eee4fbb60724a7",
            "patch": "@@ -1,5 +1,7 @@\n import { nextTestSetup } from 'e2e-utils'\n \n+import { computeCacheBustingSearchParam } from '../../../../../packages/next/src/shared/lib/router/utils/cache-busting-search-param'\n+\n describe('conflicting routes', () => {\n   const { next, isNextDev, isNextDeploy } = nextTestSetup({\n     files: __dirname,\n@@ -9,19 +11,34 @@ describe('conflicting routes', () => {\n     return\n   }\n \n-  it.each([\n-    '/en/vercel/~/monitoring',\n-    '/fr/vercel/~/monitoring',\n-    '/es/vercel/~/monitoring',\n-  ])('%s matches the right route', async (path) => {\n-    const res = await next.fetch(path, {\n+  // The server will reject prefetch requests that don't set a cache-busting\n+  // search param.\n+  // TODO: We should try to avoid unit tests that simulate internal client\n+  // router requests. There are only a handful of cases that do this currently.\n+  // In the meantime, consider moving this into a shared testing utility.\n+  async function segmentPrefetch(url: string, segmentPath: string) {\n+    const fetchUrl = new URL(url, 'http://localhost')\n+    const searchParams = new URLSearchParams(fetchUrl.search)\n+    searchParams.set(\n+      '_rsc',\n+      computeCacheBustingSearchParam('1', segmentPath, undefined, undefined)\n+    )\n+    fetchUrl.search = searchParams.toString()\n+    return await next.fetch(fetchUrl.pathname + fetchUrl.search, {\n       headers: {\n         RSC: '1',\n         'Next-Router-Prefetch': '1',\n-        'Next-Router-Segment-Prefetch': '/_tree',\n+        'Next-Router-Segment-Prefetch': segmentPath,\n       },\n     })\n+  }\n \n+  it.each([\n+    '/en/vercel/~/monitoring',\n+    '/fr/vercel/~/monitoring',\n+    '/es/vercel/~/monitoring',\n+  ])('%s matches the right route', async (path) => {\n+    const res = await segmentPrefetch(path, '/_tree')\n     expect(res.status).toBe(200)\n \n     if (isNextDeploy) {\n@@ -32,14 +49,7 @@ describe('conflicting routes', () => {\n   })\n \n   it('matches the right route when the original route has no dynamic params, is dynamic, and PPR is disabled', async () => {\n-    const res = await next.fetch('/prefetch-tests/dynamic', {\n-      headers: {\n-        RSC: '1',\n-        'Next-Router-Prefetch': '1',\n-        'Next-Router-Segment-Prefetch': '/_tree',\n-      },\n-    })\n-\n+    const res = await segmentPrefetch('/prefetch-tests/dynamic', '/_tree')\n     expect(res.status).toBe(200)\n \n     if (isNextDeploy) {\n@@ -50,13 +60,7 @@ describe('conflicting routes', () => {\n   })\n \n   it('handles conflict between App Router and Pages Router routes', async () => {\n-    const res = await next.fetch('/new/templates', {\n-      headers: {\n-        RSC: '1',\n-        'Next-Router-Prefetch': '1',\n-        'Next-Router-Segment-Prefetch': '/_tree',\n-      },\n-    })\n+    const res = await segmentPrefetch('/new/templates', '/_tree')\n \n     // Should match the route defined at pages/new/templates/[[...slug]].js,\n     // not the one at app/new/[teamSlug]/page.tsx"
        }
    ],
    "stats": {
        "total": 657,
        "additions": 438,
        "deletions": 219
    }
}