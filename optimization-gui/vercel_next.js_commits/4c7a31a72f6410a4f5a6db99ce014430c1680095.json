{
    "author": "unstubbable",
    "message": "Refactor: move `\"use cache\"` revalidation logic out of incremental cache (#77577)\n\nThe `revalidateTag` method of the incremental cache should not also handle the revalidation for the `\"use cache\"` cache handlers.\r\n\r\nThis PR relocates those bits to the revalidation utils module, which was previously used for `after`, and has now been lifted one level up.\r\n\r\nThere should be no behavioral change in this refactoring.",
    "sha": "4c7a31a72f6410a4f5a6db99ce014430c1680095",
    "files": [
        {
            "sha": "d8c1f49a67388aee8942c946fce8c8116d6a58ba",
            "filename": "packages/next/src/server/after/after-context.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Fafter%2Fafter-context.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Fafter%2Fafter-context.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fafter%2Fafter-context.ts?ref=4c7a31a72f6410a4f5a6db99ce014430c1680095",
            "patch": "@@ -4,7 +4,7 @@ import type { AfterCallback, AfterTask } from './after'\n import { InvariantError } from '../../shared/lib/invariant-error'\n import { isThenable } from '../../shared/lib/is-thenable'\n import { workAsyncStorage } from '../app-render/work-async-storage.external'\n-import { withExecuteRevalidates } from './revalidation-utils'\n+import { withExecuteRevalidates } from '../revalidation-utils'\n import { bindSnapshot } from '../app-render/async-local-storage'\n import {\n   workUnitAsyncStorage,"
        },
        {
            "sha": "361a7feda20fcda242cc33592cf9ff677626785b",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=4c7a31a72f6410a4f5a6db99ce014430c1680095",
            "patch": "@@ -49,6 +49,7 @@ import { synchronizeMutableCookies } from '../async-storage/request-store'\n import type { TemporaryReferenceSet } from 'react-server-dom-webpack/server.edge'\n import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\n import { InvariantError } from '../../shared/lib/invariant-error'\n+import { executeRevalidates } from '../revalidation-utils'\n \n function formDataFromSearchQueryString(query: string) {\n   const searchParams = new URLSearchParams(query)\n@@ -517,15 +518,7 @@ export async function handleAction({\n   requestStore.phase = 'action'\n \n   const resolvePendingRevalidations = async () =>\n-    workUnitAsyncStorage.run(requestStore, () =>\n-      Promise.all([\n-        workStore.incrementalCache?.revalidateTag(\n-          workStore.pendingRevalidatedTags || []\n-        ),\n-        ...Object.values(workStore.pendingRevalidates || {}),\n-        ...(workStore.pendingRevalidateWrites || []),\n-      ])\n-    )\n+    workUnitAsyncStorage.run(requestStore, () => executeRevalidates(workStore))\n \n   // When running actions the default is no-store, you can still `cache: 'force-cache'`\n   workStore.fetchCache = 'default-no-store'"
        },
        {
            "sha": "892f47dce21450453297812afbb551295315e7c3",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 14,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=4c7a31a72f6410a4f5a6db99ce014430c1680095",
            "patch": "@@ -187,6 +187,7 @@ import isError from '../../lib/is-error'\n import { isUseCacheTimeoutError } from '../use-cache/use-cache-errors'\n import { createServerInsertedMetadata } from './metadata-insertion/create-server-inserted-metadata'\n import { getPreviouslyRevalidatedTags } from '../server-utils'\n+import { executeRevalidates } from '../revalidation-utils'\n \n export type GetDynamicParamFromSegment = (\n   // [slug] / [[slug]] / [...slug]\n@@ -1413,13 +1414,7 @@ async function renderToHTMLOrFlightImpl(\n       workStore.pendingRevalidateWrites ||\n       workStore.pendingRevalidatedTags\n     ) {\n-      const pendingPromise = Promise.all([\n-        workStore.incrementalCache?.revalidateTag(\n-          workStore.pendingRevalidatedTags || []\n-        ),\n-        ...Object.values(workStore.pendingRevalidates || {}),\n-        ...(workStore.pendingRevalidateWrites || []),\n-      ]).finally(() => {\n+      const pendingPromise = executeRevalidates(workStore).finally(() => {\n         if (process.env.NEXT_PRIVATE_DEBUG_CACHE) {\n           console.log('pending revalidates promise finished for:', url)\n         }\n@@ -1588,13 +1583,7 @@ async function renderToHTMLOrFlightImpl(\n       workStore.pendingRevalidateWrites ||\n       workStore.pendingRevalidatedTags\n     ) {\n-      const pendingPromise = Promise.all([\n-        workStore.incrementalCache?.revalidateTag(\n-          workStore.pendingRevalidatedTags || []\n-        ),\n-        ...Object.values(workStore.pendingRevalidates || {}),\n-        ...(workStore.pendingRevalidateWrites || []),\n-      ]).finally(() => {\n+      const pendingPromise = executeRevalidates(workStore).finally(() => {\n         if (process.env.NEXT_PRIVATE_DEBUG_CACHE) {\n           console.log('pending revalidates promise finished for:', url)\n         }"
        },
        {
            "sha": "8c0753168b1da839f2eee8931b35368de17661cd",
            "filename": "packages/next/src/server/lib/incremental-cache/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 32,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts?ref=4c7a31a72f6410a4f5a6db99ce014430c1680095",
            "patch": "@@ -30,10 +30,8 @@ import {\n   getRenderResumeDataCache,\n   workUnitAsyncStorage,\n } from '../../app-render/work-unit-async-storage.external'\n-import { getCacheHandlers } from '../../use-cache/handlers'\n import { InvariantError } from '../../../shared/lib/invariant-error'\n import type { Revalidate } from '../cache-control'\n-import { updateImplicitTagsExpiration } from '../implicit-tags'\n import { getPreviouslyRevalidatedTags } from '../../server-utils'\n import { workAsyncStorage } from '../../app-render/work-async-storage.external'\n \n@@ -260,36 +258,7 @@ export class IncrementalCache implements IncrementalCacheType {\n   }\n \n   async revalidateTag(tags: string | string[]): Promise<void> {\n-    tags = Array.isArray(tags) ? tags : [tags]\n-\n-    if (tags.length === 0) {\n-      return\n-    }\n-\n-    const promises: Promise<void>[] = []\n-\n-    if (this.cacheHandler?.revalidateTag) {\n-      promises.push(this.cacheHandler.revalidateTag(tags))\n-    }\n-\n-    const handlers = getCacheHandlers()\n-    if (handlers) {\n-      for (const handler of handlers) {\n-        promises.push(handler.expireTags(...tags))\n-      }\n-    }\n-\n-    await Promise.all(promises)\n-\n-    const workUnitStore = workUnitAsyncStorage.getStore()\n-\n-    if (workUnitStore?.implicitTags) {\n-      const tagsSet = new Set(tags)\n-\n-      if (workUnitStore.implicitTags.tags.some((tag) => tagsSet.has(tag))) {\n-        await updateImplicitTagsExpiration(workUnitStore.implicitTags)\n-      }\n-    }\n+    return this.cacheHandler?.revalidateTag(tags)\n   }\n \n   // x-ref: https://github.com/facebook/react/blob/2655c9354d8e1c54ba888444220f63e836925caa/packages/react/src/ReactFetch.js#L23"
        },
        {
            "sha": "bb6d5a421269f49671cf8f5eb035dc4a59d5c8ec",
            "filename": "packages/next/src/server/revalidation-utils.ts",
            "status": "renamed",
            "additions": 51,
            "deletions": 8,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Frevalidation-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Frevalidation-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frevalidation-utils.ts?ref=4c7a31a72f6410a4f5a6db99ce014430c1680095",
            "patch": "@@ -1,4 +1,8 @@\n-import type { WorkStore } from '../app-render/work-async-storage.external'\n+import type { WorkStore } from './app-render/work-async-storage.external'\n+import { workUnitAsyncStorage } from './app-render/work-unit-async-storage.external'\n+import { updateImplicitTagsExpiration } from './lib/implicit-tags'\n+import type { IncrementalCache } from './lib/incremental-cache'\n+import { getCacheHandlers } from './use-cache/handlers'\n \n /** Run a callback, and execute any *new* revalidations added during its runtime. */\n export async function withExecuteRevalidates<T>(\n@@ -63,16 +67,55 @@ function diffRevalidationState(\n   }\n }\n \n-async function executeRevalidates(\n+async function revalidateTags(\n+  tags: string[],\n+  incrementalCache: IncrementalCache | undefined\n+): Promise<void> {\n+  if (tags.length === 0) {\n+    return\n+  }\n+\n+  const promises: Promise<void>[] = []\n+\n+  if (incrementalCache) {\n+    promises.push(incrementalCache.revalidateTag(tags))\n+  }\n+\n+  const handlers = getCacheHandlers()\n+  if (handlers) {\n+    for (const handler of handlers) {\n+      promises.push(handler.expireTags(...tags))\n+    }\n+  }\n+\n+  await Promise.all(promises)\n+\n+  const workUnitStore = workUnitAsyncStorage.getStore()\n+\n+  if (workUnitStore?.implicitTags) {\n+    const tagsSet = new Set(tags)\n+\n+    if (workUnitStore.implicitTags.tags.some((tag) => tagsSet.has(tag))) {\n+      await updateImplicitTagsExpiration(workUnitStore.implicitTags)\n+    }\n+  }\n+}\n+\n+export async function executeRevalidates(\n   workStore: WorkStore,\n-  {\n-    pendingRevalidatedTags,\n-    pendingRevalidates,\n-    pendingRevalidateWrites,\n-  }: RevalidationState\n+  state?: RevalidationState\n ) {\n+  const pendingRevalidatedTags =\n+    state?.pendingRevalidatedTags ?? workStore.pendingRevalidatedTags ?? []\n+\n+  const pendingRevalidates =\n+    state?.pendingRevalidates ?? workStore.pendingRevalidates ?? {}\n+\n+  const pendingRevalidateWrites =\n+    state?.pendingRevalidateWrites ?? workStore.pendingRevalidateWrites ?? []\n+\n   return Promise.all([\n-    workStore.incrementalCache?.revalidateTag(pendingRevalidatedTags),\n+    revalidateTags(pendingRevalidatedTags, workStore.incrementalCache),\n     ...Object.values(pendingRevalidates),\n     ...pendingRevalidateWrites,\n   ])",
            "previous_filename": "packages/next/src/server/after/revalidation-utils.ts"
        },
        {
            "sha": "1413ccd6665aa3e511f5d37b03e2f8349dc5f3de",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4c7a31a72f6410a4f5a6db99ce014430c1680095/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=4c7a31a72f6410a4f5a6db99ce014430c1680095",
            "patch": "@@ -82,6 +82,7 @@ import {\n } from '../../../client/components/http-access-fallback/http-access-fallback'\n import { RedirectStatusCode } from '../../../client/components/redirect-status-code'\n import { INFINITE_CACHE } from '../../../lib/constants'\n+import { executeRevalidates } from '../../revalidation-utils'\n \n export class WrappedNextRouterError {\n   constructor(\n@@ -323,13 +324,9 @@ export class AppRouteRouteModule extends RouteModule<\n     }\n \n     const resolvePendingRevalidations = () => {\n-      context.renderOpts.pendingWaitUntil = Promise.all([\n-        workStore.incrementalCache?.revalidateTag(\n-          workStore.pendingRevalidatedTags || []\n-        ),\n-        ...Object.values(workStore.pendingRevalidates || {}),\n-        ...(workStore.pendingRevalidateWrites || []),\n-      ]).finally(() => {\n+      context.renderOpts.pendingWaitUntil = executeRevalidates(\n+        workStore\n+      ).finally(() => {\n         if (process.env.NEXT_PRIVATE_DEBUG_CACHE) {\n           console.log(\n             'pending revalidates promise finished for:',"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 62,
        "deletions": 71
    }
}