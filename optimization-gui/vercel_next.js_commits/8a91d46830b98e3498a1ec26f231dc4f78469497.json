{
    "author": "bgw",
    "message": "refactor(CI): Merge all four bundler test manifest scripts into one (#76652)\n\nThese scripts were 95% identical, so they can just be one script that\naccepts a few arguments.\n\n```\n$ node test/update-bundler-manifest.js --help\nOptions:\n  --help        Show help                                              [boolean]\n  --version     Show version number                                    [boolean]\n  --bundler     The JavaScript bundler the tests were run against\n                                     [required] [choices: \"turbopack\", \"rspack\"]\n  --test-suite  Test group to update        [required] [choices: \"dev\", \"build\"]\n  --branch      the git branch to filter CI artifacts to\n                                                    [string] [default: \"canary\"]\n  --override    Don't merge with existing test results, allowing tests to\n                transition to a failed state                           [boolean]\n```\n\nTested by running:\n\n```\nnode test/update-bundler-manifest.js --bundler rspack --test-suite dev --override\nnode test/update-bundler-manifest.js --bundler rspack --test-suite build --override\n```",
    "sha": "8a91d46830b98e3498a1ec26f231dc4f78469497",
    "files": [
        {
            "sha": "be27cbff1274f17f2de4945ba7fd2ae1fd407201",
            "filename": ".github/workflows/rspack-update-tests-manifest.yml",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/8a91d46830b98e3498a1ec26f231dc4f78469497/.github%2Fworkflows%2Frspack-update-tests-manifest.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/8a91d46830b98e3498a1ec26f231dc4f78469497/.github%2Fworkflows%2Frspack-update-tests-manifest.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Frspack-update-tests-manifest.yml?ref=8a91d46830b98e3498a1ec26f231dc4f78469497",
            "patch": "@@ -41,7 +41,11 @@ jobs:\n         env:\n           GITHUB_TOKEN: ${{ secrets.GH_TOKEN_PULL_REQUESTS }}\n           BRANCH_NAME: rspack-manifest\n-          SCRIPT: test/build-rspack-dev-tests-manifest.js\n+          # We need to use `--override` for rspack (but not for turbopack).\n+          # We don't currently have any CI running on every PR, so it's quite\n+          # possible for us to regress on tests. We need to skip the\n+          # only-promote-to-passing merge logic.\n+          SCRIPT: test/update_build_manifest.js --bundler rspack --testSuite dev --override\n           PR_TITLE: Update bundler development test manifest\n           PR_BODY: This auto-generated PR updates the development integration test manifest used when testing alternative bundlers.\n   update_build_manifest:\n@@ -77,6 +81,6 @@ jobs:\n         env:\n           GITHUB_TOKEN: ${{ secrets.GH_TOKEN_PULL_REQUESTS }}\n           BRANCH_NAME: rspack-manifest\n-          SCRIPT: test/build-rspack-build-tests-manifest.js\n+          SCRIPT: test/update_build_manifest.js --bundler rspack --testSuite build --override\n           PR_TITLE: Update bundler production test manifest\n           PR_BODY: This auto-generated PR updates the production integration test manifest used when testing alternative bundlers."
        },
        {
            "sha": "6132ba8e7ad074e766c392bf0aec4bc790c6bcec",
            "filename": ".github/workflows/turbopack-update-tests-manifest.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8a91d46830b98e3498a1ec26f231dc4f78469497/.github%2Fworkflows%2Fturbopack-update-tests-manifest.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/8a91d46830b98e3498a1ec26f231dc4f78469497/.github%2Fworkflows%2Fturbopack-update-tests-manifest.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fturbopack-update-tests-manifest.yml?ref=8a91d46830b98e3498a1ec26f231dc4f78469497",
            "patch": "@@ -41,7 +41,7 @@ jobs:\n         env:\n           GITHUB_TOKEN: ${{ secrets.GH_TOKEN_PULL_REQUESTS }}\n           BRANCH_NAME: turbopack-manifest\n-          SCRIPT: test/build-turbopack-dev-tests-manifest.js\n+          SCRIPT: test/update_build_manifest.js --bundler turbopack --testSuite dev\n           PR_TITLE: Update Turbopack development test manifest\n           PR_BODY: This auto-generated PR updates the development integration test manifest used when testing Turbopack.\n   update_build_manifest:\n@@ -77,6 +77,6 @@ jobs:\n         env:\n           GITHUB_TOKEN: ${{ secrets.GH_TOKEN_PULL_REQUESTS }}\n           BRANCH_NAME: turbopack-manifest\n-          SCRIPT: test/build-turbopack-build-tests-manifest.js\n+          SCRIPT: test/update_build_manifest.js --bundler turbopack --testSuite build\n           PR_TITLE: Update Turbopack production test manifest\n           PR_BODY: This auto-generated PR updates the production integration test manifest used when testing Turbopack."
        },
        {
            "sha": "83b7cea5cdde5d915792106f4d4b08ca2b728efb",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8a91d46830b98e3498a1ec26f231dc4f78469497/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a91d46830b98e3498a1ec26f231dc4f78469497/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=8a91d46830b98e3498a1ec26f231dc4f78469497",
            "patch": "@@ -37,6 +37,7 @@ export interface TransformOutput {\n   code: string\n   map?: string\n   output?: string\n+  diagnostics: Array<string>\n }\n export declare function mdxCompile(\n   value: string,"
        },
        {
            "sha": "fe1c6c79e2ffa2c7aa9ff1b5af89951cab084b4b",
            "filename": "test/build-rspack-build-tests-manifest.js",
            "status": "removed",
            "additions": 0,
            "deletions": 302,
            "changes": 302,
            "blob_url": "https://github.com/vercel/next.js/blob/1ba2577a47d96c7ccf02499397bc328c60ca9db9/test%2Fbuild-rspack-build-tests-manifest.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1ba2577a47d96c7ccf02499397bc328c60ca9db9/test%2Fbuild-rspack-build-tests-manifest.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fbuild-rspack-build-tests-manifest.js?ref=1ba2577a47d96c7ccf02499397bc328c60ca9db9",
            "patch": "@@ -1,302 +0,0 @@\n-const fs = require('fs')\n-const os = require('os')\n-const path = require('path')\n-\n-const prettier = require('prettier')\n-const execa = require('execa')\n-const { bold } = require('kleur')\n-\n-async function format(text) {\n-  const options = await prettier.resolveConfig(__filename)\n-  return prettier.format(text, { ...options, parser: 'json' })\n-}\n-\n-const override = process.argv.includes('--override')\n-\n-const PASSING_JSON_PATH = `${__dirname}/rspack-build-tests-manifest.json`\n-const WORKING_PATH = '/root/actions-runner/_work/next.js/next.js/'\n-\n-const INITIALIZING_TEST_CASES = [\n-  'compile successfully',\n-  'should build successfully',\n-]\n-\n-// please make sure this is sorted alphabetically when making changes.\n-const SKIPPED_TEST_SUITES = {}\n-\n-function checkSorted(arr, name) {\n-  const sorted = [...arr].sort()\n-  if (JSON.stringify(arr) !== JSON.stringify(sorted)) {\n-    console.log(`Expected order of ${name}:`)\n-    for (let i = 0; i < arr.length; i++) {\n-      if (arr[i] === sorted[i]) {\n-        console.log(`  ${arr[i]}`)\n-      } else {\n-        console.log(bold().red(`- ${arr[i]}`))\n-        console.log(bold().green(`+ ${sorted[i]}`))\n-      }\n-    }\n-    throw new Error(`${name} is not sorted`)\n-  }\n-}\n-\n-checkSorted(Object.keys(SKIPPED_TEST_SUITES), 'SKIPPED_TEST_SUITES')\n-\n-for (const [key, value] of Object.entries(SKIPPED_TEST_SUITES)) {\n-  checkSorted(value, `SKIPPED_TEST_SUITES['${key}']`)\n-}\n-\n-/**\n- * @param title {string}\n- * @param file {string}\n- * @param args {readonly string[]}\n- * @returns {execa.ExecaChildProcess}\n- */\n-function exec(title, file, args) {\n-  logCommand(title, `${file} ${args.join(' ')}`)\n-\n-  return execa(file, args, {\n-    stderr: 'inherit',\n-  })\n-}\n-\n-/**\n- * @param {string} title\n- * @param {string} [command]\n- */\n-function logCommand(title, command) {\n-  let message = `\\n${bold().underline(title)}\\n`\n-\n-  if (command) {\n-    message += `> ${bold(command)}\\n`\n-  }\n-\n-  console.log(message)\n-}\n-\n-/**\n- * @returns {Promise<Artifact>}\n- */\n-async function fetchLatestTestArtifact() {\n-  const { stdout } = await exec(\n-    'Getting latest test artifacts from GitHub actions',\n-    'gh',\n-    [\n-      'api',\n-      '/repos/vercel/next.js/actions/artifacts?name=test-results-rspack-production',\n-    ]\n-  )\n-\n-  /** @type {ListArtifactsResponse} */\n-  const res = JSON.parse(stdout)\n-\n-  for (const artifact of res.artifacts) {\n-    if (artifact.expired || artifact.workflow_run.head_branch !== 'canary') {\n-      continue\n-    }\n-\n-    return artifact\n-  }\n-\n-  throw new Error('no valid test-results artifact was found for branch canary')\n-}\n-\n-/**\n- * @returns {Promise<TestResultManifest>}\n- */\n-async function fetchTestResults() {\n-  const artifact = await fetchLatestTestArtifact()\n-\n-  const subprocess = exec('Downloading artifact archive', 'gh', [\n-    'api',\n-    `/repos/vercel/next.js/actions/artifacts/${artifact.id}/zip`,\n-  ])\n-\n-  const filePath = path.join(\n-    os.tmpdir(),\n-    `next-test-results.${Math.floor(Math.random() * 1000).toString(16)}.zip`\n-  )\n-\n-  subprocess.stdout.pipe(fs.createWriteStream(filePath))\n-\n-  await subprocess\n-\n-  const { stdout } = await exec('Extracting test results manifest', 'unzip', [\n-    '-pj',\n-    filePath,\n-    'nextjs-test-results.json',\n-  ])\n-\n-  return JSON.parse(stdout)\n-}\n-\n-async function updatePassingTests() {\n-  const results = await fetchTestResults()\n-\n-  logCommand('Processing results...')\n-\n-  const passing = { __proto__: null }\n-  for (const result of results.result) {\n-    const runtimeError = result.data.numRuntimeErrorTestSuites > 0\n-    for (const testResult of result.data.testResults) {\n-      const filepath = stripWorkingPath(testResult.name)\n-\n-      const fileResults = (passing[filepath] ??= {\n-        passed: [],\n-        failed: [],\n-        pending: [],\n-        flakey: [],\n-        runtimeError,\n-      })\n-      const skips = SKIPPED_TEST_SUITES[filepath] ?? []\n-\n-      const skippedPassingNames = []\n-\n-      let initializationFailed = false\n-      for (const testCase of testResult.assertionResults) {\n-        let { fullName, status } = testCase\n-\n-        if (\n-          status === 'failed' &&\n-          INITIALIZING_TEST_CASES.some((name) => fullName.includes(name))\n-        ) {\n-          initializationFailed = true\n-        } else if (initializationFailed) {\n-          status = 'failed'\n-        }\n-        if (shouldSkip(fullName, skips)) {\n-          if (status === 'passed') skippedPassingNames.push(fullName)\n-          status = 'flakey'\n-        }\n-\n-        // treat test-level todo as same as pending\n-        if (status === 'todo') {\n-          status = 'pending'\n-        }\n-\n-        const statusArray = fileResults[status]\n-        if (!statusArray) {\n-          throw new Error(`unexpected status \"${status}\"`)\n-        }\n-        statusArray.push(fullName)\n-      }\n-\n-      if (skippedPassingNames.length > 0) {\n-        console.log(\n-          `${bold().yellow(filepath)} has ${\n-            skippedPassingNames.length\n-          } passing tests that are marked as skipped:\\n${skippedPassingNames\n-            .map((name) => `  - ${name}`)\n-            .join('\\n')}\\n`\n-        )\n-      }\n-    }\n-  }\n-\n-  for (const info of Object.values(passing)) {\n-    info.failed = [...new Set(info.failed)].sort()\n-    info.pending = [...new Set(info.pending)].sort()\n-    info.flakey = [...new Set(info.flakey)].sort()\n-    info.passed = [\n-      ...new Set(info.passed.filter((name) => !info.failed.includes(name))),\n-    ].sort()\n-  }\n-\n-  if (!override) {\n-    const oldPassingData = JSON.parse(\n-      fs.readFileSync(PASSING_JSON_PATH, 'utf8')\n-    )\n-\n-    for (const file of Object.keys(oldPassingData)) {\n-      const newData = passing[file]\n-      const oldData = oldPassingData[file]\n-      if (!newData) continue\n-\n-      // We want to find old passing tests that are now failing, and report them.\n-      // Tests are allowed transition to skipped or flakey.\n-      const shouldPass = new Set(\n-        oldData.passed.filter((name) => newData.failed.includes(name))\n-      )\n-      if (shouldPass.size > 0) {\n-        console.log(\n-          `${bold().red(file)} has ${\n-            shouldPass.size\n-          } test(s) that should pass but failed:\\n${Array.from(shouldPass)\n-            .map((name) => `  - ${name}`)\n-            .join('\\n')}\\n`\n-        )\n-      }\n-      // Merge the old passing tests with the new ones\n-      newData.passed = [...new Set([...shouldPass, ...newData.passed])].sort()\n-      // but remove them also from the failed list\n-      newData.failed = newData.failed\n-        .filter((name) => !shouldPass.has(name))\n-        .sort()\n-\n-      if (!oldData.runtimeError && newData.runtimeError) {\n-        console.log(\n-          `${bold().red(file)} has a runtime error that is shouldn't have\\n`\n-        )\n-        newData.runtimeError = false\n-      }\n-    }\n-  }\n-\n-  // JS keys are ordered, this ensures the tests are written in a consistent order\n-  // https://stackoverflow.com/questions/5467129/sort-javascript-object-by-key\n-  const ordered = Object.keys(passing)\n-    .sort()\n-    .reduce((obj, key) => {\n-      obj[key] = passing[key]\n-      return obj\n-    }, {})\n-\n-  fs.writeFileSync(\n-    PASSING_JSON_PATH,\n-    await format(\n-      JSON.stringify(\n-        {\n-          version: 2,\n-          suites: ordered,\n-          rules: {\n-            include: [\n-              'test/integration/**/*.test.{t,j}s{,x}',\n-              'test/e2e/**/*.test.{t,j}s{,x}',\n-              'test/production/**/*.test.{t,j}s{,x}',\n-            ],\n-            exclude: [],\n-          },\n-        },\n-        null,\n-        2\n-      )\n-    )\n-  )\n-}\n-\n-function shouldSkip(name, skips) {\n-  for (const skip of skips) {\n-    if (typeof skip === 'string') {\n-      // exact match\n-      if (name === skip) return true\n-    } else {\n-      // regex\n-      if (skip.test(name)) return true\n-    }\n-  }\n-  return false\n-}\n-\n-function stripWorkingPath(path) {\n-  if (!path.startsWith(WORKING_PATH)) {\n-    throw new Error(\n-      `found unexpected working path in \"${path}\", expected it to begin with ${WORKING_PATH}`\n-    )\n-  }\n-  return path.slice(WORKING_PATH.length)\n-}\n-\n-updatePassingTests().catch((e) => {\n-  console.error(e)\n-  process.exit(1)\n-})"
        },
        {
            "sha": "22f8401ef7a6a7242b9c7b9829bd9240085f3d77",
            "filename": "test/build-rspack-dev-tests-manifest.js",
            "status": "removed",
            "additions": 0,
            "deletions": 285,
            "changes": 285,
            "blob_url": "https://github.com/vercel/next.js/blob/1ba2577a47d96c7ccf02499397bc328c60ca9db9/test%2Fbuild-rspack-dev-tests-manifest.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1ba2577a47d96c7ccf02499397bc328c60ca9db9/test%2Fbuild-rspack-dev-tests-manifest.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fbuild-rspack-dev-tests-manifest.js?ref=1ba2577a47d96c7ccf02499397bc328c60ca9db9",
            "patch": "@@ -1,285 +0,0 @@\n-const fs = require('fs')\n-const os = require('os')\n-const path = require('path')\n-\n-const prettier = require('prettier')\n-const execa = require('execa')\n-const { bold } = require('kleur')\n-\n-async function format(text) {\n-  const options = await prettier.resolveConfig(__filename)\n-  return prettier.format(text, { ...options, parser: 'json' })\n-}\n-\n-const override = process.argv.includes('--override')\n-\n-const PASSING_JSON_PATH = `${__dirname}/rspack-dev-tests-manifest.json`\n-const WORKING_PATH = '/root/actions-runner/_work/next.js/next.js/'\n-\n-const INITIALIZING_TEST_CASES = [\n-  'compile successfully',\n-  'should build successfully',\n-]\n-\n-// please make sure this is sorted alphabetically when making changes.\n-const SKIPPED_TEST_SUITES = {}\n-\n-function checkSorted(arr, name) {\n-  const sorted = [...arr].sort()\n-  if (JSON.stringify(arr) !== JSON.stringify(sorted)) {\n-    console.log(`Expected order of ${name}:`)\n-    for (let i = 0; i < arr.length; i++) {\n-      if (arr[i] === sorted[i]) {\n-        console.log(`  ${arr[i]}`)\n-      } else {\n-        console.log(bold().red(`- ${arr[i]}`))\n-        console.log(bold().green(`+ ${sorted[i]}`))\n-      }\n-    }\n-    throw new Error(`${name} is not sorted`)\n-  }\n-}\n-\n-checkSorted(Object.keys(SKIPPED_TEST_SUITES), 'SKIPPED_TEST_SUITES')\n-\n-for (const [key, value] of Object.entries(SKIPPED_TEST_SUITES)) {\n-  checkSorted(value, `SKIPPED_TEST_SUITES['${key}']`)\n-}\n-\n-/**\n- * @param title {string}\n- * @param file {string}\n- * @param args {readonly string[]}\n- * @returns {execa.ExecaChildProcess}\n- */\n-function exec(title, file, args) {\n-  logCommand(title, `${file} ${args.join(' ')}`)\n-\n-  return execa(file, args, {\n-    stderr: 'inherit',\n-  })\n-}\n-\n-/**\n- * @param {string} title\n- * @param {string} [command]\n- */\n-function logCommand(title, command) {\n-  let message = `\\n${bold().underline(title)}\\n`\n-\n-  if (command) {\n-    message += `> ${bold(command)}\\n`\n-  }\n-\n-  console.log(message)\n-}\n-\n-/**\n- * @returns {Promise<Artifact>}\n- */\n-async function fetchLatestTestArtifact() {\n-  const { stdout } = await exec(\n-    'Getting latest test artifacts from GitHub actions',\n-    'gh',\n-    [\n-      'api',\n-      '/repos/vercel/next.js/actions/artifacts?name=test-results-rspack-development',\n-    ]\n-  )\n-\n-  /** @type {ListArtifactsResponse} */\n-  const res = JSON.parse(stdout)\n-\n-  for (const artifact of res.artifacts) {\n-    if (artifact.expired || artifact.workflow_run.head_branch !== 'canary') {\n-      continue\n-    }\n-\n-    return artifact\n-  }\n-\n-  throw new Error('no valid test-results artifact was found for branch canary')\n-}\n-\n-/**\n- * @returns {Promise<TestResultManifest>}\n- */\n-async function fetchTestResults() {\n-  const artifact = await fetchLatestTestArtifact()\n-\n-  const subprocess = exec('Downloading artifact archive', 'gh', [\n-    'api',\n-    `/repos/vercel/next.js/actions/artifacts/${artifact.id}/zip`,\n-  ])\n-\n-  const filePath = path.join(\n-    os.tmpdir(),\n-    `next-test-results.${Math.floor(Math.random() * 1000).toString(16)}.zip`\n-  )\n-\n-  subprocess.stdout.pipe(fs.createWriteStream(filePath))\n-\n-  await subprocess\n-\n-  const { stdout } = await exec('Extracting test results manifest', 'unzip', [\n-    '-pj',\n-    filePath,\n-    'nextjs-test-results.json',\n-  ])\n-\n-  return JSON.parse(stdout)\n-}\n-\n-async function updatePassingTests() {\n-  const results = await fetchTestResults()\n-\n-  logCommand('Processing results...')\n-\n-  const passing = { __proto__: null }\n-  for (const result of results.result) {\n-    const runtimeError = result.data.numRuntimeErrorTestSuites > 0\n-    for (const testResult of result.data.testResults) {\n-      const filepath = stripWorkingPath(testResult.name)\n-\n-      const fileResults = (passing[filepath] ??= {\n-        passed: [],\n-        failed: [],\n-        pending: [],\n-        flakey: [],\n-        runtimeError,\n-      })\n-      const skips = SKIPPED_TEST_SUITES[filepath] ?? []\n-\n-      const skippedPassingNames = []\n-\n-      let initializationFailed = false\n-      for (const testCase of testResult.assertionResults) {\n-        let { fullName, status } = testCase\n-\n-        if (\n-          status === 'failed' &&\n-          INITIALIZING_TEST_CASES.some((name) => fullName.includes(name))\n-        ) {\n-          initializationFailed = true\n-        } else if (initializationFailed) {\n-          status = 'failed'\n-        }\n-        if (shouldSkip(fullName, skips)) {\n-          if (status === 'passed') skippedPassingNames.push(fullName)\n-          status = 'flakey'\n-        }\n-\n-        // treat test-level todo as same as pending\n-        if (status === 'todo') {\n-          status = 'pending'\n-        }\n-\n-        const statusArray = fileResults[status]\n-        if (!statusArray) {\n-          throw new Error(`unexpected status \"${status}\"`)\n-        }\n-        statusArray.push(fullName)\n-      }\n-\n-      if (skippedPassingNames.length > 0) {\n-        console.log(\n-          `${bold().yellow(filepath)} has ${\n-            skippedPassingNames.length\n-          } passing tests that are marked as skipped:\\n${skippedPassingNames\n-            .map((name) => `  - ${name}`)\n-            .join('\\n')}\\n`\n-        )\n-      }\n-    }\n-  }\n-\n-  for (const info of Object.values(passing)) {\n-    info.failed = [...new Set(info.failed)].sort()\n-    info.pending = [...new Set(info.pending)].sort()\n-    info.flakey = [...new Set(info.flakey)].sort()\n-    info.passed = [\n-      ...new Set(info.passed.filter((name) => !info.failed.includes(name))),\n-    ].sort()\n-  }\n-\n-  if (!override) {\n-    const oldPassingData = JSON.parse(\n-      fs.readFileSync(PASSING_JSON_PATH, 'utf8')\n-    )\n-\n-    for (const file of Object.keys(oldPassingData)) {\n-      const newData = passing[file]\n-      const oldData = oldPassingData[file]\n-      if (!newData) continue\n-\n-      // We want to find old passing tests that are now failing, and report them.\n-      // Tests are allowed transition to skipped or flakey.\n-      const shouldPass = new Set(\n-        oldData.passed.filter((name) => newData.failed.includes(name))\n-      )\n-      if (shouldPass.size > 0) {\n-        console.log(\n-          `${bold().red(file)} has ${\n-            shouldPass.size\n-          } test(s) that should pass but failed:\\n${Array.from(shouldPass)\n-            .map((name) => `  - ${name}`)\n-            .join('\\n')}\\n`\n-        )\n-      }\n-      // Merge the old passing tests with the new ones\n-      newData.passed = [...new Set([...shouldPass, ...newData.passed])].sort()\n-      // but remove them also from the failed list\n-      newData.failed = newData.failed\n-        .filter((name) => !shouldPass.has(name))\n-        .sort()\n-\n-      if (!oldData.runtimeError && newData.runtimeError) {\n-        console.log(\n-          `${bold().red(file)} has a runtime error that is shouldn't have\\n`\n-        )\n-        newData.runtimeError = false\n-      }\n-    }\n-  }\n-\n-  // JS keys are ordered, this ensures the tests are written in a consistent order\n-  // https://stackoverflow.com/questions/5467129/sort-javascript-object-by-key\n-  const ordered = Object.keys(passing)\n-    .sort()\n-    .reduce((obj, key) => {\n-      obj[key] = passing[key]\n-      return obj\n-    }, {})\n-\n-  fs.writeFileSync(\n-    PASSING_JSON_PATH,\n-    await format(JSON.stringify(ordered, null, 2))\n-  )\n-}\n-\n-function shouldSkip(name, skips) {\n-  for (const skip of skips) {\n-    if (typeof skip === 'string') {\n-      // exact match\n-      if (name === skip) return true\n-    } else {\n-      // regex\n-      if (skip.test(name)) return true\n-    }\n-  }\n-  return false\n-}\n-\n-function stripWorkingPath(path) {\n-  if (!path.startsWith(WORKING_PATH)) {\n-    throw new Error(\n-      `found unexpected working path in \"${path}\", expected it to begin with ${WORKING_PATH}`\n-    )\n-  }\n-  return path.slice(WORKING_PATH.length)\n-}\n-\n-updatePassingTests().catch((e) => {\n-  console.error(e)\n-  process.exit(1)\n-})"
        },
        {
            "sha": "ec8f95c21e9d2ae34a9ff7ee6060258e246bd14c",
            "filename": "test/build-turbopack-build-tests-manifest.js",
            "status": "removed",
            "additions": 0,
            "deletions": 302,
            "changes": 302,
            "blob_url": "https://github.com/vercel/next.js/blob/1ba2577a47d96c7ccf02499397bc328c60ca9db9/test%2Fbuild-turbopack-build-tests-manifest.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1ba2577a47d96c7ccf02499397bc328c60ca9db9/test%2Fbuild-turbopack-build-tests-manifest.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fbuild-turbopack-build-tests-manifest.js?ref=1ba2577a47d96c7ccf02499397bc328c60ca9db9",
            "patch": "@@ -1,302 +0,0 @@\n-const fs = require('fs')\n-const os = require('os')\n-const path = require('path')\n-\n-const prettier = require('prettier')\n-const execa = require('execa')\n-const { bold } = require('kleur')\n-\n-async function format(text) {\n-  const options = await prettier.resolveConfig(__filename)\n-  return prettier.format(text, { ...options, parser: 'json' })\n-}\n-\n-const override = process.argv.includes('--override')\n-\n-const PASSING_JSON_PATH = `${__dirname}/turbopack-build-tests-manifest.json`\n-const WORKING_PATH = '/root/actions-runner/_work/next.js/next.js/'\n-\n-const INITIALIZING_TEST_CASES = [\n-  'compile successfully',\n-  'should build successfully',\n-]\n-\n-// please make sure this is sorted alphabetically when making changes.\n-const SKIPPED_TEST_SUITES = {}\n-\n-function checkSorted(arr, name) {\n-  const sorted = [...arr].sort()\n-  if (JSON.stringify(arr) !== JSON.stringify(sorted)) {\n-    console.log(`Expected order of ${name}:`)\n-    for (let i = 0; i < arr.length; i++) {\n-      if (arr[i] === sorted[i]) {\n-        console.log(`  ${arr[i]}`)\n-      } else {\n-        console.log(bold().red(`- ${arr[i]}`))\n-        console.log(bold().green(`+ ${sorted[i]}`))\n-      }\n-    }\n-    throw new Error(`${name} is not sorted`)\n-  }\n-}\n-\n-checkSorted(Object.keys(SKIPPED_TEST_SUITES), 'SKIPPED_TEST_SUITES')\n-\n-for (const [key, value] of Object.entries(SKIPPED_TEST_SUITES)) {\n-  checkSorted(value, `SKIPPED_TEST_SUITES['${key}']`)\n-}\n-\n-/**\n- * @param title {string}\n- * @param file {string}\n- * @param args {readonly string[]}\n- * @returns {execa.ExecaChildProcess}\n- */\n-function exec(title, file, args) {\n-  logCommand(title, `${file} ${args.join(' ')}`)\n-\n-  return execa(file, args, {\n-    stderr: 'inherit',\n-  })\n-}\n-\n-/**\n- * @param {string} title\n- * @param {string} [command]\n- */\n-function logCommand(title, command) {\n-  let message = `\\n${bold().underline(title)}\\n`\n-\n-  if (command) {\n-    message += `> ${bold(command)}\\n`\n-  }\n-\n-  console.log(message)\n-}\n-\n-/**\n- * @returns {Promise<Artifact>}\n- */\n-async function fetchLatestTestArtifact() {\n-  const { stdout } = await exec(\n-    'Getting latest test artifacts from GitHub actions',\n-    'gh',\n-    [\n-      'api',\n-      '/repos/vercel/next.js/actions/artifacts?name=test-results-turbopack-production',\n-    ]\n-  )\n-\n-  /** @type {ListArtifactsResponse} */\n-  const res = JSON.parse(stdout)\n-\n-  for (const artifact of res.artifacts) {\n-    if (artifact.expired || artifact.workflow_run.head_branch !== 'canary') {\n-      continue\n-    }\n-\n-    return artifact\n-  }\n-\n-  throw new Error('no valid test-results artifact was found for branch canary')\n-}\n-\n-/**\n- * @returns {Promise<TestResultManifest>}\n- */\n-async function fetchTestResults() {\n-  const artifact = await fetchLatestTestArtifact()\n-\n-  const subprocess = exec('Downloading artifact archive', 'gh', [\n-    'api',\n-    `/repos/vercel/next.js/actions/artifacts/${artifact.id}/zip`,\n-  ])\n-\n-  const filePath = path.join(\n-    os.tmpdir(),\n-    `next-test-results.${Math.floor(Math.random() * 1000).toString(16)}.zip`\n-  )\n-\n-  subprocess.stdout.pipe(fs.createWriteStream(filePath))\n-\n-  await subprocess\n-\n-  const { stdout } = await exec('Extracting test results manifest', 'unzip', [\n-    '-pj',\n-    filePath,\n-    'nextjs-test-results.json',\n-  ])\n-\n-  return JSON.parse(stdout)\n-}\n-\n-async function updatePassingTests() {\n-  const results = await fetchTestResults()\n-\n-  logCommand('Processing results...')\n-\n-  const passing = { __proto__: null }\n-  for (const result of results.result) {\n-    const runtimeError = result.data.numRuntimeErrorTestSuites > 0\n-    for (const testResult of result.data.testResults) {\n-      const filepath = stripWorkingPath(testResult.name)\n-\n-      const fileResults = (passing[filepath] ??= {\n-        passed: [],\n-        failed: [],\n-        pending: [],\n-        flakey: [],\n-        runtimeError,\n-      })\n-      const skips = SKIPPED_TEST_SUITES[filepath] ?? []\n-\n-      const skippedPassingNames = []\n-\n-      let initializationFailed = false\n-      for (const testCase of testResult.assertionResults) {\n-        let { fullName, status } = testCase\n-\n-        if (\n-          status === 'failed' &&\n-          INITIALIZING_TEST_CASES.some((name) => fullName.includes(name))\n-        ) {\n-          initializationFailed = true\n-        } else if (initializationFailed) {\n-          status = 'failed'\n-        }\n-        if (shouldSkip(fullName, skips)) {\n-          if (status === 'passed') skippedPassingNames.push(fullName)\n-          status = 'flakey'\n-        }\n-\n-        // treat test-level todo as same as pending\n-        if (status === 'todo') {\n-          status = 'pending'\n-        }\n-\n-        const statusArray = fileResults[status]\n-        if (!statusArray) {\n-          throw new Error(`unexpected status \"${status}\"`)\n-        }\n-        statusArray.push(fullName)\n-      }\n-\n-      if (skippedPassingNames.length > 0) {\n-        console.log(\n-          `${bold().yellow(filepath)} has ${\n-            skippedPassingNames.length\n-          } passing tests that are marked as skipped:\\n${skippedPassingNames\n-            .map((name) => `  - ${name}`)\n-            .join('\\n')}\\n`\n-        )\n-      }\n-    }\n-  }\n-\n-  for (const info of Object.values(passing)) {\n-    info.failed = [...new Set(info.failed)].sort()\n-    info.pending = [...new Set(info.pending)].sort()\n-    info.flakey = [...new Set(info.flakey)].sort()\n-    info.passed = [\n-      ...new Set(info.passed.filter((name) => !info.failed.includes(name))),\n-    ].sort()\n-  }\n-\n-  if (!override) {\n-    const oldPassingData = JSON.parse(\n-      fs.readFileSync(PASSING_JSON_PATH, 'utf8')\n-    )\n-\n-    for (const file of Object.keys(oldPassingData)) {\n-      const newData = passing[file]\n-      const oldData = oldPassingData[file]\n-      if (!newData) continue\n-\n-      // We want to find old passing tests that are now failing, and report them.\n-      // Tests are allowed transition to skipped or flakey.\n-      const shouldPass = new Set(\n-        oldData.passed.filter((name) => newData.failed.includes(name))\n-      )\n-      if (shouldPass.size > 0) {\n-        console.log(\n-          `${bold().red(file)} has ${\n-            shouldPass.size\n-          } test(s) that should pass but failed:\\n${Array.from(shouldPass)\n-            .map((name) => `  - ${name}`)\n-            .join('\\n')}\\n`\n-        )\n-      }\n-      // Merge the old passing tests with the new ones\n-      newData.passed = [...new Set([...shouldPass, ...newData.passed])].sort()\n-      // but remove them also from the failed list\n-      newData.failed = newData.failed\n-        .filter((name) => !shouldPass.has(name))\n-        .sort()\n-\n-      if (!oldData.runtimeError && newData.runtimeError) {\n-        console.log(\n-          `${bold().red(file)} has a runtime error that is shouldn't have\\n`\n-        )\n-        newData.runtimeError = false\n-      }\n-    }\n-  }\n-\n-  // JS keys are ordered, this ensures the tests are written in a consistent order\n-  // https://stackoverflow.com/questions/5467129/sort-javascript-object-by-key\n-  const ordered = Object.keys(passing)\n-    .sort()\n-    .reduce((obj, key) => {\n-      obj[key] = passing[key]\n-      return obj\n-    }, {})\n-\n-  fs.writeFileSync(\n-    PASSING_JSON_PATH,\n-    await format(\n-      JSON.stringify(\n-        {\n-          version: 2,\n-          suites: ordered,\n-          rules: {\n-            include: [\n-              'test/integration/**/*.test.{t,j}s{,x}',\n-              'test/e2e/**/*.test.{t,j}s{,x}',\n-              'test/production/**/*.test.{t,j}s{,x}',\n-            ],\n-            exclude: [],\n-          },\n-        },\n-        null,\n-        2\n-      )\n-    )\n-  )\n-}\n-\n-function shouldSkip(name, skips) {\n-  for (const skip of skips) {\n-    if (typeof skip === 'string') {\n-      // exact match\n-      if (name === skip) return true\n-    } else {\n-      // regex\n-      if (skip.test(name)) return true\n-    }\n-  }\n-  return false\n-}\n-\n-function stripWorkingPath(path) {\n-  if (!path.startsWith(WORKING_PATH)) {\n-    throw new Error(\n-      `found unexpected working path in \"${path}\", expected it to begin with ${WORKING_PATH}`\n-    )\n-  }\n-  return path.slice(WORKING_PATH.length)\n-}\n-\n-updatePassingTests().catch((e) => {\n-  console.error(e)\n-  process.exit(1)\n-})"
        },
        {
            "sha": "e980aa0939d26ccbad08a696e506703267bdf11e",
            "filename": "test/rspack-build-tests-manifest.json",
            "status": "modified",
            "additions": 18843,
            "deletions": 18868,
            "changes": 37711,
            "blob_url": "https://github.com/vercel/next.js/blob/8a91d46830b98e3498a1ec26f231dc4f78469497/test%2Frspack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8a91d46830b98e3498a1ec26f231dc4f78469497/test%2Frspack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-build-tests-manifest.json?ref=8a91d46830b98e3498a1ec26f231dc4f78469497"
        },
        {
            "sha": "17bb6e509fede99b095433d7e03c696a823af9aa",
            "filename": "test/rspack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 62,
            "deletions": 57,
            "changes": 119,
            "blob_url": "https://github.com/vercel/next.js/blob/8a91d46830b98e3498a1ec26f231dc4f78469497/test%2Frspack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8a91d46830b98e3498a1ec26f231dc4f78469497/test%2Frspack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-dev-tests-manifest.json?ref=8a91d46830b98e3498a1ec26f231dc4f78469497",
            "patch": "@@ -2123,11 +2123,12 @@\n       \"ReactRefreshRegression can fast refresh a page with config\",\n       \"ReactRefreshRegression can fast refresh a page with getServerSideProps\",\n       \"ReactRefreshRegression can fast refresh a page with getStaticProps\",\n-      \"ReactRefreshRegression custom loader mdx should have Fast Refresh enabled\",\n       \"ReactRefreshRegression shows an overlay for a server-side error\",\n       \"ReactRefreshRegression styled-components hydration mismatch\"\n     ],\n-    \"failed\": [],\n+    \"failed\": [\n+      \"ReactRefreshRegression custom loader mdx should have Fast Refresh enabled\"\n+    ],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -2160,12 +2161,12 @@\n     \"passed\": [\n       \"pages/ error recovery logbox: can recover from a component error\",\n       \"pages/ error recovery logbox: can recover from a event handler error\",\n-      \"pages/ error recovery render error not shown right after syntax error\",\n-      \"pages/ error recovery stuck error\",\n-      \"pages/ error recovery syntax > runtime error\"\n+      \"pages/ error recovery stuck error\"\n     ],\n     \"failed\": [\n-      \"pages/ error recovery logbox: can recover from a syntax error without losing state\"\n+      \"pages/ error recovery logbox: can recover from a syntax error without losing state\",\n+      \"pages/ error recovery render error not shown right after syntax error\",\n+      \"pages/ error recovery syntax > runtime error\"\n     ],\n     \"pending\": [],\n     \"flakey\": [],\n@@ -2284,8 +2285,8 @@\n     \"runtimeError\": false\n   },\n   \"test/development/app-dir/dev-fetch-hmr/dev-fetch-hmr.test.ts\": {\n-    \"passed\": [\"dev-fetch-hmr should retain module level fetch patching\"],\n-    \"failed\": [],\n+    \"passed\": [],\n+    \"failed\": [\"dev-fetch-hmr should retain module level fetch patching\"],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -2341,12 +2342,12 @@\n   },\n   \"test/development/app-dir/dynamic-io-dev-errors/dynamic-io-dev-errors.test.ts\": {\n     \"passed\": [\n-      \"Dynamic IO Dev Errors should clear segment errors after correcting them\",\n       \"Dynamic IO Dev Errors should not log unhandled rejections for persistently thrown top-level errors\",\n       \"Dynamic IO Dev Errors should show a red box error on client navigations\",\n       \"Dynamic IO Dev Errors should show a red box error on the SSR render\"\n     ],\n     \"failed\": [\n+      \"Dynamic IO Dev Errors should clear segment errors after correcting them\",\n       \"Dynamic IO Dev Errors should display error when component accessed data without suspense boundary\"\n     ],\n     \"pending\": [],\n@@ -2489,7 +2490,7 @@\n     ],\n     \"pending\": [],\n     \"flakey\": [],\n-    \"runtimeError\": false\n+    \"runtimeError\": true\n   },\n   \"test/development/app-dir/logging-incoming-request/logging-incoming-request-false.test.ts\": {\n     \"passed\": [\n@@ -2613,12 +2614,12 @@\n   },\n   \"test/development/app-dir/server-navigation-error/server-navigation-error.test.ts\": {\n     \"passed\": [\n-      \"server-navigation-error pages router should error on navigation API notFound\",\n       \"server-navigation-error pages router should error on navigation API redirect\"\n     ],\n     \"failed\": [\n       \"server-navigation-error middleware should error on navigation API not-found\",\n-      \"server-navigation-error middleware should error on navigation API redirect \"\n+      \"server-navigation-error middleware should error on navigation API redirect \",\n+      \"server-navigation-error pages router should error on navigation API notFound\"\n     ],\n     \"pending\": [],\n     \"flakey\": [],\n@@ -2821,51 +2822,43 @@\n   },\n   \"test/development/basic/hmr/error-recovery.test.ts\": {\n     \"passed\": [\n-      \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should detect syntax errors and recover\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should have client HMR events in trace file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover after a bad return from the render function\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover after an error reported via SSR\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover after exporting an invalid page\",\n-      \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover after loader parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover after undefined exported as default\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover after webpack parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover from 404 after a page has been added\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover from 404 after a page has been added with dynamic segments\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover from errors in getInitialProps in client\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover from errors in the render function\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should show the error on all pages\",\n-      \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should detect syntax errors and recover\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should have client HMR events in trace file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover after a bad return from the render function\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover after an error reported via SSR\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover after exporting an invalid page\",\n-      \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover after loader parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover after undefined exported as default\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover after webpack parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover from 404 after a page has been added\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover from 404 after a page has been added with dynamic segments\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover from errors in getInitialProps in client\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover from errors in the render function\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should show the error on all pages\",\n-      \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should detect syntax errors and recover\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should have client HMR events in trace file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover after a bad return from the render function\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover after an error reported via SSR\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover after exporting an invalid page\",\n-      \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover after loader parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover after undefined exported as default\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover after webpack parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover from 404 after a page has been added\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover from 404 after a page has been added with dynamic segments\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover from errors in getInitialProps in client\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover from errors in the render function\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should show the error on all pages\",\n-      \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should detect syntax errors and recover\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should have client HMR events in trace file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should recover after a bad return from the render function\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should recover after an error reported via SSR\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should recover after exporting an invalid page\",\n-      \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should recover after loader parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should recover after undefined exported as default\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should recover after webpack parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should recover from 404 after a page has been added\",\n@@ -2876,13 +2869,21 @@\n     ],\n     \"failed\": [\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should detect runtime errors on the module scope\",\n+      \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should detect syntax errors and recover\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should not continously poll a custom error page\",\n+      \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '' } should recover after loader parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should detect runtime errors on the module scope\",\n+      \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should detect syntax errors and recover\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should not continously poll a custom error page\",\n+      \"HMR - Error Recovery, nextConfig: { basePath: '', assetPrefix: '/asset-prefix' } should recover after loader parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should detect runtime errors on the module scope\",\n+      \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should detect syntax errors and recover\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should not continously poll a custom error page\",\n+      \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '' } should recover after loader parse error in an imported file\",\n       \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should detect runtime errors on the module scope\",\n-      \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should not continously poll a custom error page\"\n+      \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should detect syntax errors and recover\",\n+      \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should not continously poll a custom error page\",\n+      \"HMR - Error Recovery, nextConfig: { basePath: '/docs', assetPrefix: '/asset-prefix' } should recover after loader parse error in an imported file\"\n     ],\n     \"pending\": [],\n     \"flakey\": [],\n@@ -3321,7 +3322,6 @@\n       \"middleware - development errors when there is a compilation error after boot logs the error correctly\",\n       \"middleware - development errors when there is a compilation error after boot renders the error correctly and recovers\",\n       \"middleware - development errors when there is a compilation error from boot logs the error correctly\",\n-      \"middleware - development errors when there is a compilation error from boot renders the error correctly and recovers\",\n       \"middleware - development errors when there is an unhandled rejection while loading a dependency does not render the error\",\n       \"middleware - development errors when there is an unhandled rejection while loading a dependency logs the error correctly\",\n       \"middleware - development errors when there is an unhandled rejection while loading the module does not render the error\",\n@@ -3332,6 +3332,7 @@\n       \"middleware - development errors when middleware contains an unhandled rejection logs the error correctly\",\n       \"middleware - development errors when middleware throws synchronously logs the error correctly\",\n       \"middleware - development errors when running invalid dynamic code with eval logs the error correctly\",\n+      \"middleware - development errors when there is a compilation error from boot renders the error correctly and recovers\",\n       \"middleware - development errors when throwing while loading the module logs the error correctly\"\n     ],\n     \"pending\": [],\n@@ -3414,7 +3415,6 @@\n       \"Client Navigation resets scroll at the correct time should reset scroll before the new page runs its lifecycles (<Link />)\",\n       \"Client Navigation resets scroll at the correct time should reset scroll before the new page runs its lifecycles (Router#push)\",\n       \"Client Navigation runtime errors should show redbox when a client side error is thrown inside a component\",\n-      \"Client Navigation runtime errors should show redbox when a client side error is thrown outside a component\",\n       \"Client Navigation should emit routeChangeError on hash change cancel\",\n       \"Client Navigation should handle boolean async prop in next/script client-side: false\",\n       \"Client Navigation should handle boolean async prop in next/script client-side: true\",\n@@ -3462,7 +3462,6 @@\n       \"Client Navigation with different types of urls should work with / page\",\n       \"Client Navigation with different types of urls should work with dir/ page\",\n       \"Client Navigation with different types of urls should work with normal page\",\n-      \"Client Navigation with empty getInitialProps() should render a redbox\",\n       \"Client Navigation with getInitialProp redirect should redirect the page via client side\",\n       \"Client Navigation with getInitialProp redirect should redirect the page when loading\",\n       \"Client Navigation with hash changes check hydration mis-match should not have hydration mis-match for hash link\",\n@@ -3516,7 +3515,10 @@\n       \"updating <Head /> with strictNextHead=true while client routing should warn when scripts are in head\",\n       \"updating <Head /> with strictNextHead=true while client routing should warn when stylesheets or scripts are in head\"\n     ],\n-    \"failed\": [],\n+    \"failed\": [\n+      \"Client Navigation runtime errors should show redbox when a client side error is thrown outside a component\",\n+      \"Client Navigation with empty getInitialProps() should render a redbox\"\n+    ],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -3999,7 +4001,7 @@\n     \"failed\": [\"app dir HMR should not cause error when removing loading.js\"],\n     \"pending\": [],\n     \"flakey\": [],\n-    \"runtimeError\": false\n+    \"runtimeError\": true\n   },\n   \"test/e2e/app-dir/app-config-crossorigin/index.test.ts\": {\n     \"passed\": [\n@@ -4341,8 +4343,8 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/app-dir/app-routes-subrequests/app-routes-subrequests.test.ts\": {\n-    \"passed\": [\"app-routes-subrequests shortcuts after 5 subrequests\"],\n-    \"failed\": [],\n+    \"passed\": [],\n+    \"failed\": [\"app-routes-subrequests shortcuts after 5 subrequests\"],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -4727,7 +4729,6 @@\n       \"app dir - basic <Link /> should soft replace\",\n       \"app dir - basic HMR should HMR correctly for client component\",\n       \"app dir - basic HMR should HMR correctly for server component\",\n-      \"app dir - basic bootstrap scripts should fail to bootstrap when using CSP in Dev due to eval\",\n       \"app dir - basic bootstrap scripts should only bootstrap with one script, prinitializing the rest\",\n       \"app dir - basic data fetch with response over 16KB with chunked encoding should load page when fetching a large amount of data\",\n       \"app dir - basic known bugs should handle as on next/link\",\n@@ -4817,6 +4818,7 @@\n     ],\n     \"failed\": [\n       \"app dir - basic <Link /> should navigate to pages dynamic route from pages page if it overlaps with an app page\",\n+      \"app dir - basic bootstrap scripts should fail to bootstrap when using CSP in Dev due to eval\",\n       \"app dir - basic should serve polyfills for browsers that do not support modules\"\n     ],\n     \"pending\": [\n@@ -5342,10 +5344,10 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/app-dir/dynamic-import/dynamic-import.test.ts\": {\n-    \"passed\": [\n+    \"passed\": [],\n+    \"failed\": [\n       \"dynamic-import should render the dynamically imported component\"\n     ],\n-    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -5464,11 +5466,11 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/app-dir/dynamic-io-segment-configs/dynamic-io-segment-configs.test.ts\": {\n-    \"passed\": [\n+    \"passed\": [],\n+    \"failed\": [\n       \"dynamic-io-segment-configs it should error when using segment configs that aren't supported by dynamicIO\",\n       \"dynamic-io-segment-configs should propagate configurations from layouts to pages\"\n     ],\n-    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -5822,17 +5824,16 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/app-dir/error-on-next-codemod-comment/error-on-next-codemod-comment.test.ts\": {\n-    \"passed\": [\n-      \"app-dir - error-on-next-codemod-comment should error with inline comment as well\"\n-    ],\n+    \"passed\": [],\n     \"failed\": [\n       \"app-dir - error-on-next-codemod-comment should disappear the error when you replace with bypass comment\",\n       \"app-dir - error-on-next-codemod-comment should disappear the error when you rre the codemod comment\",\n+      \"app-dir - error-on-next-codemod-comment should error with inline comment as well\",\n       \"app-dir - error-on-next-codemod-comment should error with swc if you have codemod comments left\"\n     ],\n     \"pending\": [],\n     \"flakey\": [],\n-    \"runtimeError\": false\n+    \"runtimeError\": true\n   },\n   \"test/e2e/app-dir/errors/index.test.ts\": {\n     \"passed\": [\n@@ -6182,7 +6183,6 @@\n     \"passed\": [\n       \"app-dir - fetch logging placeholder to satisfy at least one test when isNextDev is false\",\n       \"app-dir - fetch logging should not log requests for HMR refreshes\",\n-      \"app-dir - logging with default logging should not contain metadata internal segments for dynamic metadata routes\",\n       \"app-dir - logging with default logging should not contain trailing word page for app router routes\",\n       \"app-dir - logging with default logging should not log fetch requests at all\",\n       \"app-dir - logging with fetches default logging should exclude Middleware invoked and _rsc requests\",\n@@ -6222,7 +6222,6 @@\n       \"app-dir - logging with verbose logging for edge runtime should log each page request only once\",\n       \"app-dir - logging with verbose logging for edge runtime should log requests for client-side navigations\",\n       \"app-dir - logging with verbose logging for edge runtime should log requests with correct indentation\",\n-      \"app-dir - logging with verbose logging for edge runtime should not contain metadata internal segments for dynamic metadata routes\",\n       \"app-dir - logging with verbose logging for edge runtime should not contain trailing word page for app router routes\",\n       \"app-dir - logging with verbose logging for edge runtime should not limit the number of requests that are logged\",\n       \"app-dir - logging with verbose logging for edge runtime should not log _rsc query for client navigation RSC request\",\n@@ -6231,7 +6230,10 @@\n       \"app-dir - logging with verbose logging for edge runtime should show cache reason of noStore when use with fetch\",\n       \"app-dir - logging with verbose logging for edge runtime when logging.fetches.hmrRefreshes is true should log requests for HMR refreshes\"\n     ],\n-    \"failed\": [],\n+    \"failed\": [\n+      \"app-dir - logging with default logging should not contain metadata internal segments for dynamic metadata routes\",\n+      \"app-dir - logging with verbose logging for edge runtime should not contain metadata internal segments for dynamic metadata routes\"\n+    ],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -7981,10 +7983,11 @@\n       \"app dir - rsc basics should support streaming for flight response\",\n       \"app dir - rsc basics should suspense next/image in server components\",\n       \"app dir - rsc basics should suspense next/legacy/image in server components\",\n-      \"app dir - rsc basics should track client components in dynamic imports\",\n       \"app dir - rsc basics should use canary react for app\"\n     ],\n-    \"failed\": [],\n+    \"failed\": [\n+      \"app dir - rsc basics should track client components in dynamic imports\"\n+    ],\n     \"pending\": [\n       \"app dir - rsc basics should support partial hydration with inlined server data in browser\"\n     ],\n@@ -9157,7 +9160,6 @@\n   \"test/e2e/cancel-request/stream-cancel.test.ts\": {\n     \"passed\": [\n       \"streaming responses cancel inner stream after disconnect edge app route handler cancels stalled stream\",\n-      \"streaming responses cancel inner stream after disconnect edge app route handler cancels stream making progress\",\n       \"streaming responses cancel inner stream after disconnect edge app route handler cancels stream that never sent data\",\n       \"streaming responses cancel inner stream after disconnect edge pages api cancels stalled stream\",\n       \"streaming responses cancel inner stream after disconnect edge pages api cancels stream making progress\",\n@@ -9172,7 +9174,9 @@\n       \"streaming responses cancel inner stream after disconnect node pages api cancels stream making progress\",\n       \"streaming responses cancel inner stream after disconnect node pages api cancels stream that never sent data\"\n     ],\n-    \"failed\": [],\n+    \"failed\": [\n+      \"streaming responses cancel inner stream after disconnect edge app route handler cancels stream making progress\"\n+    ],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -10397,7 +10401,7 @@\n     ],\n     \"pending\": [],\n     \"flakey\": [],\n-    \"runtimeError\": false\n+    \"runtimeError\": true\n   },\n   \"test/e2e/multi-zone/multi-zone.test.ts\": {\n     \"passed\": [\n@@ -10438,17 +10442,17 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/new-link-behavior/material-ui.test.ts\": {\n-    \"passed\": [\n+    \"passed\": [],\n+    \"failed\": [\n       \"New Link Behavior with material-ui should render MuiLink with <a>\"\n     ],\n-    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n   \"test/e2e/new-link-behavior/stitches.test.ts\": {\n-    \"passed\": [\"New Link Behavior with stitches should render <a>\"],\n-    \"failed\": [],\n+    \"passed\": [],\n+    \"failed\": [\"New Link Behavior with stitches should render <a>\"],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -10564,10 +10568,10 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/next-image-forward-ref/index.test.ts\": {\n-    \"passed\": [\n+    \"passed\": [],\n+    \"failed\": [\n       \"next-image-forward-ref allows framer-motion to animate opacity\"\n     ],\n-    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -11763,11 +11767,12 @@\n   },\n   \"test/integration/app-dir-export/test/dynamic-missing-gsp-dev.test.ts\": {\n     \"passed\": [\n-      \"app dir - with output export - dynamic missing gsp dev development mode should error when client component has generateStaticParams\",\n       \"app dir - with output export - dynamic missing gsp dev development mode should error when dynamic route is missing generateStaticParams\",\n       \"app dir - with output export - dynamic missing gsp dev development mode should error when dynamic route is set to true\"\n     ],\n-    \"failed\": [],\n+    \"failed\": [\n+      \"app dir - with output export - dynamic missing gsp dev development mode should error when client component has generateStaticParams\"\n+    ],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -12526,13 +12531,13 @@\n     \"runtimeError\": false\n   },\n   \"test/integration/create-next-app/templates/app-api.test.ts\": {\n-    \"passed\": [\n+    \"passed\": [],\n+    \"failed\": [\n       \"create-next-app --api (Headless App) should create JavaScript project with --js flag\",\n       \"create-next-app --api (Headless App) should create TypeScript project with --ts flag\",\n       \"create-next-app --api (Headless App) should create project inside \\\"src\\\" directory with --src-dir flag\",\n       \"create-next-app --api (Headless App) should enable turbopack dev with --turbopack flag\"\n     ],\n-    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n@@ -13899,15 +13904,15 @@\n       \"Edge runtime code with imports Edge API importing vanilla 3rd party module does not throw in dev at runtime\",\n       \"Edge runtime code with imports Edge API using Buffer polyfill does not throw in dev at runtime\",\n       \"Edge runtime code with imports Middleware importing vanilla 3rd party module does not throw in dev at runtime\",\n-      \"Edge runtime code with imports Middleware statically importing 3rd party module throws not-found module error in dev at runtime and highlights the faulty line\",\n       \"Edge runtime code with imports Middleware using Buffer polyfill does not throw in dev at runtime\"\n     ],\n     \"failed\": [\n       \"Edge runtime code with imports Edge API dynamically importing node.js module development mode throws unsupported module error in dev at runtime and highlights the faulty line\",\n       \"Edge runtime code with imports Edge API dynamically importing node.js module in a lib development mode throws unsupported module error in dev at runtime and highlights the faulty line\",\n       \"Edge runtime code with imports Edge API statically importing 3rd party module throws not-found module error in dev at runtime and highlights the faulty line\",\n       \"Edge runtime code with imports Middleware dynamically importing node.js module development mode throws unsupported module error in dev at runtime and highlights the faulty line\",\n-      \"Edge runtime code with imports Middleware dynamically importing node.js module in a lib development mode throws unsupported module error in dev at runtime and highlights the faulty line\"\n+      \"Edge runtime code with imports Middleware dynamically importing node.js module in a lib development mode throws unsupported module error in dev at runtime and highlights the faulty line\",\n+      \"Edge runtime code with imports Middleware statically importing 3rd party module throws not-found module error in dev at runtime and highlights the faulty line\"\n     ],\n     \"pending\": [\n       \"Edge runtime code with imports Edge API dynamically importing node.js module in a lib production mode throws unsupported module error in production at runtime and prints error on logs\","
        },
        {
            "sha": "e5d3ad09fafa5d4a4fcce1e5f6b65801346ea9c3",
            "filename": "test/update-bundler-manifest.d.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/8a91d46830b98e3498a1ec26f231dc4f78469497/test%2Fupdate-bundler-manifest.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a91d46830b98e3498a1ec26f231dc4f78469497/test%2Fupdate-bundler-manifest.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fupdate-bundler-manifest.d.ts?ref=8a91d46830b98e3498a1ec26f231dc4f78469497",
            "previous_filename": "test/build-turbopack-tests-manifest.d.ts"
        },
        {
            "sha": "3ecfad59f1faa9e050dd3f8ed60bce6a2fca6672",
            "filename": "test/update-bundler-manifest.js",
            "status": "renamed",
            "additions": 54,
            "deletions": 26,
            "changes": 80,
            "blob_url": "https://github.com/vercel/next.js/blob/8a91d46830b98e3498a1ec26f231dc4f78469497/test%2Fupdate-bundler-manifest.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8a91d46830b98e3498a1ec26f231dc4f78469497/test%2Fupdate-bundler-manifest.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fupdate-bundler-manifest.js?ref=8a91d46830b98e3498a1ec26f231dc4f78469497",
            "patch": "@@ -1,19 +1,13 @@\n-const fs = require('fs')\n-const os = require('os')\n-const path = require('path')\n+const fs = require('node:fs/promises')\n+const os = require('node:os')\n+const path = require('node:path')\n \n const prettier = require('prettier')\n const execa = require('execa')\n const { bold } = require('kleur')\n+const yargs = require('yargs/yargs')\n+const { hideBin } = require('yargs/helpers')\n \n-async function format(text) {\n-  const options = await prettier.resolveConfig(__filename)\n-  return prettier.format(text, { ...options, parser: 'json' })\n-}\n-\n-const override = process.argv.includes('--override')\n-\n-const PASSING_JSON_PATH = `${__dirname}/turbopack-dev-tests-manifest.json`\n const WORKING_PATH = '/root/actions-runner/_work/next.js/next.js/'\n \n const INITIALIZING_TEST_CASES = [\n@@ -24,6 +18,29 @@ const INITIALIZING_TEST_CASES = [\n // please make sure this is sorted alphabetically when making changes.\n const SKIPPED_TEST_SUITES = {}\n \n+const { argv } = yargs(hideBin(process.argv))\n+  .choices('bundler', ['turbopack', 'rspack'])\n+  .describe('bundler', 'The JavaScript bundler the tests were run against')\n+  .choices('test-suite', ['dev', 'build'])\n+  .describe('test-suite', 'Test group to update')\n+  .demandOption(['bundler', 'test-suite'])\n+  .string('branch')\n+  .describe('branch', 'the git branch to filter CI artifacts to')\n+  .default('branch', 'canary')\n+  .boolean('override')\n+  .describe(\n+    'override',\n+    \"Don't merge with existing test results, allowing tests to transition to \" +\n+      'a failed state'\n+  )\n+\n+const manifestJsonPath = `${__dirname}/${argv.bundler}-${argv.testSuite}-tests-manifest.json`\n+\n+async function format(text) {\n+  const options = await prettier.resolveConfig(__filename)\n+  return prettier.format(text, { ...options, parser: 'json' })\n+}\n+\n function checkSorted(arr, name) {\n   const sorted = [...arr].sort()\n   if (JSON.stringify(arr) !== JSON.stringify(sorted)) {\n@@ -78,28 +95,28 @@ function logCommand(title, command) {\n  * @returns {Promise<Artifact>}\n  */\n async function fetchLatestTestArtifact() {\n+  const artifactSlug = `test-results-${argv.bundler}-${\n+    argv.testSuite === 'dev' ? 'development' : 'production'\n+  }`\n   const { stdout } = await exec(\n     'Getting latest test artifacts from GitHub actions',\n     'gh',\n-    [\n-      'api',\n-      '/repos/vercel/next.js/actions/artifacts?name=test-results-turbopack-development',\n-    ]\n+    ['api', `/repos/vercel/next.js/actions/artifacts?name=${artifactSlug}`]\n   )\n \n   /** @type {ListArtifactsResponse} */\n   const res = JSON.parse(stdout)\n \n   for (const artifact of res.artifacts) {\n-    if (artifact.expired || artifact.workflow_run.head_branch !== 'canary') {\n+    if (artifact.expired || artifact.workflow_run.head_branch !== argv.branch) {\n       continue\n     }\n \n     return artifact\n   }\n \n   throw new Error(\n-    'no valid test-results-turbopack-development artifact was found for branch canary'\n+    `no valid test-results artifact was found for branch ${argv.branch}`\n   )\n }\n \n@@ -116,19 +133,28 @@ async function fetchTestResults() {\n \n   const filePath = path.join(\n     os.tmpdir(),\n-    `next-test-results.${Math.floor(Math.random() * 1000).toString(16)}.zip`\n+    `next-test-results.${Math.floor(Math.random() * 100000).toString(16)}.zip`\n   )\n \n-  subprocess.stdout.pipe(fs.createWriteStream(filePath))\n+  let file\n+  try {\n+    file = await fs.open(filePath, 'w')\n+\n+    subprocess.stdout.pipe(file.createWriteStream())\n \n-  await subprocess\n+    await subprocess\n+  } finally {\n+    await file.close()\n+  }\n \n   const { stdout } = await exec('Extracting test results manifest', 'unzip', [\n     '-pj',\n     filePath,\n     'nextjs-test-results.json',\n   ])\n \n+  await fs.unlink(filePath)\n+\n   return JSON.parse(stdout)\n }\n \n@@ -204,10 +230,12 @@ async function updatePassingTests() {\n     ].sort()\n   }\n \n-  if (!override) {\n-    const oldPassingData = JSON.parse(\n-      fs.readFileSync(PASSING_JSON_PATH, 'utf8')\n-    )\n+  if (!argv.override) {\n+    let oldPassingData = JSON.parse(await fs.readFile(manifestJsonPath, 'utf8'))\n+\n+    if (oldPassingData.version === 2) {\n+      oldPassingData = oldPassingData.suites\n+    }\n \n     for (const file of Object.keys(oldPassingData)) {\n       const newData = passing[file]\n@@ -253,8 +281,8 @@ async function updatePassingTests() {\n       return obj\n     }, {})\n \n-  fs.writeFileSync(\n-    PASSING_JSON_PATH,\n+  await fs.writeFile(\n+    manifestJsonPath,\n     await format(JSON.stringify(ordered, null, 2))\n   )\n }",
            "previous_filename": "test/build-turbopack-dev-tests-manifest.js"
        }
    ],
    "stats": {
        "total": 38812,
        "additions": 18968,
        "deletions": 19844
    }
}