{
    "author": "sokra",
    "message": "Turbopack: Improve persistent caching test case (#83205)\n\n### What?\n\nImprove persistent caching test cases to cover:\n\n* next config changes\n* env var changes\n* standalone changes and combined changes\n\nAlso improve the performance of the test case and makes it easier to extend.",
    "sha": "90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
    "files": [
        {
            "sha": "07d036da65fa195a144ab1cd58407deb1bf20423",
            "filename": "test/e2e/persistent-caching/app/env/client/page.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fenv%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fenv%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fenv%2Fclient%2Fpage.tsx?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -0,0 +1,10 @@\n+'use client'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>{process.env.NEXT_PUBLIC_ENV_VAR}</p>\n+      <main suppressHydrationWarning>Timestamp</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "275fa9633c144d3029b2655132fbe8ee3a039a5d",
            "filename": "test/e2e/persistent-caching/app/env/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fenv%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fenv%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fenv%2Fpage.tsx?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Page() {\n+  return (\n+    <>\n+      <p>{process.env.NEXT_PUBLIC_ENV_VAR}</p>\n+      <main suppressHydrationWarning>Timestamp</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "dad9ad338274ca667a4c59a758c36f488f8d1b96",
            "filename": "test/e2e/persistent-caching/app/loader/client/page.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Floader%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Floader%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fapp%2Floader%2Fclient%2Fpage.tsx?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -0,0 +1,10 @@\n+'use client'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>Loader</p>\n+      <main suppressHydrationWarning>Timestamp</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "a784a18dfdae5f2f35cea1d750617ce9971c63ad",
            "filename": "test/e2e/persistent-caching/app/loader/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Floader%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Floader%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fapp%2Floader%2Fpage.tsx?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Page() {\n+  return (\n+    <>\n+      <p>Loader</p>\n+      <main suppressHydrationWarning>Timestamp</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "658a9c3d98207b88948845d0c3889306463bba3b",
            "filename": "test/e2e/persistent-caching/app/next-config/client/page.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fnext-config%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fnext-config%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fnext-config%2Fclient%2Fpage.tsx?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -0,0 +1,10 @@\n+'use client'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>{process.env.NEXT_PUBLIC_CONFIG_ENV}</p>\n+      <main suppressHydrationWarning>Timestamp</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "d98c3c5787290a9ac6d09bec80d7b4c8da825e6e",
            "filename": "test/e2e/persistent-caching/app/next-config/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fnext-config%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fnext-config%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fapp%2Fnext-config%2Fpage.tsx?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Page() {\n+  return (\n+    <>\n+      <p>{process.env.NEXT_PUBLIC_CONFIG_ENV}</p>\n+      <main suppressHydrationWarning>Timestamp</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "89f9113e08cb223a76a38fe8f971620dc7583165",
            "filename": "test/e2e/persistent-caching/app/unchanged/page.jsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Funchanged%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fapp%2Funchanged%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fapp%2Funchanged%2Fpage.jsx?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Page() {\n+  return (\n+    <>\n+      <p>hello world</p>\n+      <main suppressHydrationWarning>Timestamp</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "486572da4bbabf362c9d421f718aaa0914568b7d",
            "filename": "test/e2e/persistent-caching/my-loader.js",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fmy-loader.js",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fmy-loader.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fmy-loader.js?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -1,6 +1,4 @@\n module.exports = async function myLoader(source) {\n-  console.log('Loader is running!')\n-  // Make webpack consider the build as large change which makes it persistent cache it sooner\n-  await new Promise((resolve) => setTimeout(resolve, 2000))\n-  return source.replace(/Timestamp/g, `Timestamp = ${Date.now()}`)\n+  console.log(`Run my-loader on ${this.resourcePath}`)\n+  return source.replace(/Loader/g, 'hello world')\n }"
        },
        {
            "sha": "a1e295e19ea36a3cad37b2f61cbf164b04ead4de",
            "filename": "test/e2e/persistent-caching/my-timestamp-loader.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fmy-timestamp-loader.js",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fmy-timestamp-loader.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fmy-timestamp-loader.js?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -0,0 +1,11 @@\n+module.exports = async function myLoader(source) {\n+  console.log(`Run my-timestamp-loader on ${this.resourcePath}`)\n+  if (this._compiler && this._compiler.__extra_delay) {\n+    if (!this._compilation.__extra_delay) {\n+      this._compilation.__extra_delay = true\n+      // Make webpack consider the build as large change which makes it persistent cache it sooner\n+      await new Promise((resolve) => setTimeout(resolve, 2000))\n+    }\n+  }\n+  return source.replace(/Timestamp/g, `Timestamp = ${Date.now()}`)\n+}"
        },
        {
            "sha": "b629b1f4062aab7d53f22aee0e6205f735ce59de",
            "filename": "test/e2e/persistent-caching/next.config.js",
            "status": "modified",
            "additions": 19,
            "deletions": 6,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fnext.config.js?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -4,25 +4,38 @@\n const nextConfig = {\n   turbopack: {\n     rules: {\n-      './app/page.tsx': {\n-        loaders: ['./my-loader.js'],\n+      './app/**/page.{jsx,tsx}': {\n+        loaders: ['./my-timestamp-loader.js'],\n       },\n-      './app/client/page.tsx': {\n+      './app/loader/page.tsx': {\n         loaders: ['./my-loader.js'],\n       },\n       './pages/pages.tsx': {\n-        loaders: ['./my-loader.js'],\n+        loaders: ['./my-timestamp-loader.js'],\n       },\n     },\n   },\n   experimental: {\n     turbopackPersistentCaching: true,\n   },\n-  webpack(config) {\n+  env: {\n+    NEXT_PUBLIC_CONFIG_ENV: 'hello world',\n+  },\n+  webpack(config, { dev }) {\n+    config.module.rules.push({\n+      test: /app(?:\\/.*)?\\/page\\.[tj]sx|pages\\/pages\\.tsx/,\n+      use: ['./my-timestamp-loader.js'],\n+    })\n     config.module.rules.push({\n-      test: /app\\/page\\.tsx|app\\/client\\/page\\.tsx|pages\\/pages\\.tsx/,\n+      test: /app\\/loader(?:\\/client)?\\/page\\.tsx/,\n       use: ['./my-loader.js'],\n     })\n+    if (dev) {\n+      // Make webpack consider the build as large change which makes it persistent cache it sooner\n+      config.plugins.push((compiler) => {\n+        compiler.__extra_delay = true\n+      })\n+    }\n \n     return config\n   },"
        },
        {
            "sha": "8a7f97dd03c4e76dc86709d3ca96d92745e738b8",
            "filename": "test/e2e/persistent-caching/persistent-caching.test.ts",
            "status": "modified",
            "additions": 194,
            "deletions": 102,
            "changes": 296,
            "blob_url": "https://github.com/vercel/next.js/blob/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fpersistent-caching.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/90d4ff74debe7e7f1eb4fb719b9e214c36b3932c/test%2Fe2e%2Fpersistent-caching%2Fpersistent-caching.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching%2Fpersistent-caching.test.ts?ref=90d4ff74debe7e7f1eb4fb719b9e214c36b3932c",
            "patch": "@@ -1,17 +1,27 @@\n-import { nextTestSetup } from 'e2e-utils'\n+import { nextTestSetup, isNextDev } from 'e2e-utils'\n import { waitFor } from 'next-test-utils'\n \n describe('persistent-caching', () => {\n-  process.env.NEXT_DEPLOYMENT_ID = '' + Date.now()\n-  const { skipped, next, isNextDev } = nextTestSetup({\n+  process.env.NEXT_PUBLIC_ENV_VAR = 'hello world'\n+  const { skipped, next, isTurbopack } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n+    // We need to use npm here as pnpms symlinks trigger a weird bug (kernel bug?)\n+    installCommand: 'npm i',\n+    buildCommand: 'npm exec next build',\n+    startCommand: isNextDev ? 'npm exec next dev' : 'npm exec next start',\n   })\n \n   if (skipped) {\n     return\n   }\n \n+  beforeAll(() => {\n+    // We can skip the dev watch delay since this is not an HMR test\n+    ;(next as any).handleDevWatchDelayBeforeChange = () => {}\n+    ;(next as any).handleDevWatchDelayAfterChange = () => {}\n+  })\n+\n   async function restartCycle() {\n     await stop()\n     await start()\n@@ -20,38 +30,42 @@ describe('persistent-caching', () => {\n   async function stop() {\n     if (isNextDev) {\n       // Give Persistent Cache time to write to disk\n-      await waitFor(10000)\n+      // Turbopack has an idle timeout of 2s\n+      // Webpack has an idle timeout (after large changes) of 1s\n+      // and we give time a bit more to allow writing to disk\n+      await waitFor(3000)\n     }\n     await next.stop()\n   }\n \n   async function start() {\n-    if (!isNextDev) {\n-      // TODO workaround for missing content hashing on output static files\n-      // Browser caching would break this test case, but we want to test persistent caching.\n-      process.env.NEXT_DEPLOYMENT_ID = '' + Date.now()\n-    }\n     await next.start()\n   }\n \n   it('should persistent cache loaders', async () => {\n-    let appTimestamp, appClientTimestamp, pagesTimestamp\n+    let appTimestamp, unchangedTimestamp, appClientTimestamp, pagesTimestamp\n     {\n       const browser = await next.browser('/')\n       appTimestamp = await browser.elementByCss('main').text()\n-      expect(appTimestamp).toMatch(/Timestamp = \\d+/)\n+      expect(appTimestamp).toMatch(/Timestamp = \\d+$/)\n+      await browser.close()\n+    }\n+    {\n+      const browser = await next.browser('/unchanged')\n+      unchangedTimestamp = await browser.elementByCss('main').text()\n+      expect(unchangedTimestamp).toMatch(/Timestamp = \\d+$/)\n       await browser.close()\n     }\n     {\n       const browser = await next.browser('/client')\n       appClientTimestamp = await browser.elementByCss('main').text()\n-      expect(appClientTimestamp).toMatch(/Timestamp = \\d+/)\n+      expect(appClientTimestamp).toMatch(/Timestamp = \\d+$/)\n       await browser.close()\n     }\n     {\n       const browser = await next.browser('/pages')\n       pagesTimestamp = await browser.elementByCss('main').text()\n-      expect(pagesTimestamp).toMatch(/Timestamp = \\d+/)\n+      expect(pagesTimestamp).toMatch(/Timestamp = \\d+$/)\n       await browser.close()\n     }\n     await restartCycle()\n@@ -61,6 +75,11 @@ describe('persistent-caching', () => {\n       expect(await browser.elementByCss('main').text()).toBe(appTimestamp)\n       await browser.close()\n     }\n+    {\n+      const browser = await next.browser('/unchanged')\n+      expect(await browser.elementByCss('main').text()).toBe(unchangedTimestamp)\n+      await browser.close()\n+    }\n     {\n       const browser = await next.browser('/client')\n       expect(await browser.elementByCss('main').text()).toBe(appClientTimestamp)\n@@ -73,106 +92,179 @@ describe('persistent-caching', () => {\n     }\n   })\n \n-  it.each([1, 2, 3])(\n-    'should allow to change files while stopped (run %d)',\n-    async (_i) => {\n-      async function checkInitial() {\n-        {\n-          const browser = await next.browser('/')\n-          expect(await browser.elementByCss('p').text()).toBe('hello world')\n-          await browser.close()\n-        }\n-        {\n-          const browser = await next.browser('/client')\n-          expect(await browser.elementByCss('p').text()).toBe('hello world')\n-          await browser.close()\n-        }\n-        {\n-          const browser = await next.browser('/pages')\n-          expect(await browser.elementByCss('p').text()).toBe('hello world')\n-          await browser.close()\n+  function makeTextCheck(url: string, text: string) {\n+    return textCheck.bind(null, url, text)\n+  }\n+\n+  async function textCheck(url: string, text: string) {\n+    const browser = await next.browser(url)\n+    expect(await browser.elementByCss('p').text()).toBe(text)\n+    await browser.close()\n+  }\n+\n+  function makeFileEdit(file: string) {\n+    return async (inner: () => Promise<void>) => {\n+      await next.patchFile(\n+        file,\n+        (content) => {\n+          return content.replace('hello world', 'hello persistent caching')\n+        },\n+        inner\n+      )\n+    }\n+  }\n+\n+  /* eslint-disable jest/no-standalone-expect */\n+  const POTENTIAL_CHANGES = {\n+    'RSC change': {\n+      checkInitial: makeTextCheck('/', 'hello world'),\n+      withChange: makeFileEdit('app/page.tsx'),\n+      checkChanged: makeTextCheck('/', 'hello persistent caching'),\n+    },\n+    'RCC change': {\n+      checkInitial: makeTextCheck('/client', 'hello world'),\n+      withChange: makeFileEdit('app/client/page.tsx'),\n+      checkChanged: makeTextCheck('/client', 'hello persistent caching'),\n+    },\n+    'Pages change': {\n+      checkInitial: makeTextCheck('/pages', 'hello world'),\n+      withChange: makeFileEdit('pages/pages.tsx'),\n+      checkChanged: makeTextCheck('/pages', 'hello persistent caching'),\n+    },\n+    'rename app page': {\n+      checkInitial: makeTextCheck('/remove-me', 'hello world'),\n+      async withChange(inner) {\n+        await next.renameFolder('app/remove-me', 'app/add-me')\n+        try {\n+          await inner()\n+        } finally {\n+          await next.renameFolder('app/add-me', 'app/remove-me')\n         }\n-        {\n-          const browser = await next.browser('/remove-me')\n-          expect(await browser.elementByCss('p').text()).toBe('hello world')\n-          await browser.close()\n+      },\n+      checkChanged: makeTextCheck('/add-me', 'hello world'),\n+    },\n+    // TODO fix this case with Turbopack\n+    ...(isTurbopack\n+      ? {}\n+      : {\n+          'loader change': {\n+            async checkInitial() {\n+              await textCheck('/loader', 'hello world')\n+              await textCheck('/loader/client', 'hello world')\n+            },\n+            withChange: makeFileEdit('my-loader.js'),\n+            async checkChanged() {\n+              await textCheck('/loader', 'hello persistent caching')\n+              await textCheck('/loader/client', 'hello persistent caching')\n+            },\n+            fullInvalidation: !isTurbopack,\n+          },\n+        }),\n+    'next config change': {\n+      async checkInitial() {\n+        await textCheck('/next-config', 'hello world')\n+        await textCheck('/next-config/client', 'hello world')\n+      },\n+      withChange: makeFileEdit('next.config.js'),\n+      async checkChanged() {\n+        await textCheck('/next-config', 'hello persistent caching')\n+        await textCheck('/next-config/client', 'hello persistent caching')\n+      },\n+      fullInvalidation: !isTurbopack,\n+    },\n+    'env var change': {\n+      async checkInitial() {\n+        await textCheck('/env', 'hello world')\n+        await textCheck('/env/client', 'hello world')\n+      },\n+      async withChange(inner) {\n+        process.env.NEXT_PUBLIC_ENV_VAR = 'hello persistent caching'\n+        try {\n+          await inner()\n+        } finally {\n+          process.env.NEXT_PUBLIC_ENV_VAR = 'hello world'\n         }\n+      },\n+      async checkChanged() {\n+        await textCheck('/env', 'hello persistent caching')\n+        await textCheck('/env/client', 'hello persistent caching')\n+      },\n+    },\n+  }\n+  /* eslint-enable jest/no-standalone-expect */\n+\n+  const KEYS = Object.keys(POTENTIAL_CHANGES)\n+  for (let bitset = 1; bitset < 1 << KEYS.length; bitset++) {\n+    let combination = []\n+    for (let i = 0; i < KEYS.length; i++) {\n+      if (bitset & (1 << i)) {\n+        combination.push(KEYS[i])\n       }\n+    }\n+    // Checking only single change and all combined for performance reasons.\n+    if (combination.length !== 1 && combination.length !== KEYS.length) continue\n \n-      await checkInitial()\n+    it(`should allow to change files while stopped (${combination.join(', ')})`, async () => {\n+      let fullInvalidation = false\n+      for (const key of combination) {\n+        await POTENTIAL_CHANGES[key].checkInitial()\n+        if (POTENTIAL_CHANGES[key].fullInvalidation) {\n+          fullInvalidation = true\n+        }\n+      }\n \n-      await stop()\n+      let unchangedTimestamp\n+      if (!fullInvalidation) {\n+        const browser = await next.browser('/unchanged')\n+        unchangedTimestamp = await browser.elementByCss('main').text()\n+        expect(unchangedTimestamp).toMatch(/Timestamp = \\d+$/)\n+        await browser.close()\n+      }\n \n-      async function checkChanges() {\n-        {\n-          const browser = await next.browser('/')\n-          expect(await browser.elementByCss('p').text()).toBe(\n-            'hello persistent caching'\n-          )\n-          await browser.close()\n+      async function checkChanged() {\n+        for (const key of combination) {\n+          await POTENTIAL_CHANGES[key].checkChanged()\n         }\n-        {\n-          const browser = await next.browser('/client')\n-          expect(await browser.elementByCss('p').text()).toBe(\n-            'hello persistent caching'\n-          )\n-          await browser.close()\n-        }\n-        {\n-          const browser = await next.browser('/pages')\n-          expect(await browser.elementByCss('p').text()).toBe(\n-            'hello persistent caching'\n-          )\n-          await browser.close()\n-        }\n-        {\n-          const browser = await next.browser('/add-me')\n-          expect(await browser.elementByCss('p').text()).toBe('hello world')\n+\n+        if (!fullInvalidation) {\n+          const browser = await next.browser('/unchanged')\n+          const timestamp = await browser.elementByCss('main').text()\n+          expect(unchangedTimestamp).toEqual(timestamp)\n           await browser.close()\n         }\n       }\n \n-      await next.patchFile(\n-        'pages/pages.tsx',\n-        (content) => {\n-          return content.replace('hello world', 'hello persistent caching')\n-        },\n-        async () => {\n-          await next.patchFile(\n-            'app/page.tsx',\n-            (content) => {\n-              return content.replace('hello world', 'hello persistent caching')\n-            },\n-            async () => {\n-              await next.patchFile(\n-                'app/client/page.tsx',\n-                (content) => {\n-                  return content.replace(\n-                    'hello world',\n-                    'hello persistent caching'\n-                  )\n-                },\n-                async () => {\n-                  await next.renameFolder('app/remove-me', 'app/add-me')\n-                  try {\n-                    await start()\n-                    await checkChanges()\n-                    // Some no-op change builds\n-                    for (let i = 0; i < 2; i++) {\n-                      await restartCycle()\n-                      await checkChanges()\n-                    }\n-                    await stop()\n-                  } finally {\n-                    await next.renameFolder('app/add-me', 'app/remove-me')\n-                  }\n-                }\n-              )\n-            }\n-          )\n+      await stop()\n+\n+      async function inner() {\n+        await start()\n+        await checkChanged()\n+        // Some no-op change builds\n+        for (let i = 0; i < 2; i++) {\n+          await restartCycle()\n+          await checkChanged()\n         }\n-      )\n+        await stop()\n+      }\n+\n+      let current = inner\n+      for (const key of combination) {\n+        const prev = current\n+        current = () => POTENTIAL_CHANGES[key].withChange(prev)\n+      }\n+      await current()\n+\n       await start()\n-    }\n-  )\n+      for (const key of combination) {\n+        await POTENTIAL_CHANGES[key].checkInitial()\n+      }\n+\n+      if (!fullInvalidation) {\n+        const browser = await next.browser('/unchanged')\n+        const timestamp = await browser.elementByCss('main').text()\n+        expect(unchangedTimestamp).toEqual(timestamp)\n+        await browser.close()\n+      }\n+    }, 200000)\n+  }\n })"
        }
    ],
    "stats": {
        "total": 400,
        "additions": 288,
        "deletions": 112
    }
}