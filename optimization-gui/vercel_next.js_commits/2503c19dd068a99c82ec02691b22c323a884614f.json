{
    "author": "huozhi",
    "message": "[segment explorer] capture defined boundaries (#81232)\n\nCapture defined boundaries (not-found / error / loading) and used to filter which one is available for boundary triggers\r\n\r\nThe trie will now hold all the defined boundaries, but what's different from the existing rendered boundaries is:\r\n\r\nHere's the difference of new defined boundary trie nodes:\r\n```\r\n{\r\n  type: \"boundary:<type>\"\r\n  pagePath: \"<pagePath>@boundary\"\r\n}\r\n```\r\nWe add a `boundary:` prefix to determine if it's node representing existence;\r\nWe add a `@boundary` suffix to the filename cause the <pagePath> part is still need to use for indexing in the trie, but the `@boundary` doesn't matter yet. We'll remove it once we start using the file name in the dropdown panel\r\n\r\nCloses NEXT-4330\r\n\r\n### Example\r\n\r\nWhen there's only one not-found.tsx, allow to trigger the not-found boundary and disable the rest.\r\n\r\nhttps://github.com/user-attachments/assets/eb5c49a7-4fd2-496b-b778-fb66581908b3",
    "sha": "2503c19dd068a99c82ec02691b22c323a884614f",
    "files": [
        {
            "sha": "2a5fa3db67628c83041af18e4855f028aac736e5",
            "filename": "packages/next/src/client/components/layout-router.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx?ref=2503c19dd068a99c82ec02691b22c323a884614f",
            "patch": "@@ -507,6 +507,7 @@ export default function OuterLayoutRouter({\n   forbidden,\n   unauthorized,\n   gracefullyDegrade,\n+  segmentViewBoundaries,\n }: {\n   parallelRouterKey: string\n   error: ErrorComponent | undefined\n@@ -519,6 +520,7 @@ export default function OuterLayoutRouter({\n   forbidden: React.ReactNode | undefined\n   unauthorized: React.ReactNode | undefined\n   gracefullyDegrade?: boolean\n+  segmentViewBoundaries?: React.ReactNode\n }) {\n   const context = useContext(LayoutRouterContext)\n   if (!context) {\n@@ -659,13 +661,14 @@ export default function OuterLayoutRouter({\n     )\n \n     if (process.env.NODE_ENV !== 'production') {\n-      const SegmentStateProvider = (\n+      const { SegmentStateProvider } =\n         require('../../next-devtools/userspace/app/segment-explorer-node') as typeof import('../../next-devtools/userspace/app/segment-explorer-node')\n-      )\n-        .SegmentStateProvider as typeof import('../../next-devtools/userspace/app/segment-explorer-node').SegmentStateProvider as typeof import('../../next-devtools/userspace/app/segment-explorer-node').SegmentStateProvider\n \n       child = (\n-        <SegmentStateProvider key={stateKey}>{child}</SegmentStateProvider>\n+        <SegmentStateProvider key={stateKey}>\n+          {child}\n+          {segmentViewBoundaries}\n+        </SegmentStateProvider>\n       )\n     }\n "
        },
        {
            "sha": "a2658e2ca9033b0648f8a1df26e7d5c9aedd0528",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-boundary-trigger.tsx",
            "status": "modified",
            "additions": 27,
            "deletions": 4,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-boundary-trigger.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-boundary-trigger.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-boundary-trigger.tsx?ref=2503c19dd068a99c82ec02691b22c323a884614f",
            "patch": "@@ -5,9 +5,11 @@ import type { SegmentNodeState } from '../../../userspace/app/segment-explorer-n\n export function SegmentBoundaryTrigger({\n   onSelectBoundary,\n   offset,\n+  boundaries,\n }: {\n   onSelectBoundary: SegmentNodeState['setBoundaryType']\n   offset: number\n+  boundaries: Record<'not-found' | 'loading' | 'error', string | null>\n }) {\n   const [shadowRoot] = useState<ShadowRoot>(() => {\n     const ownerDocument = document\n@@ -17,9 +19,24 @@ export function SegmentBoundaryTrigger({\n   const shadowRootRef = useRef<ShadowRoot>(shadowRoot)\n \n   const triggerOptions = [\n-    { label: 'Trigger Loading', value: 'loading', icon: <LoadingIcon /> },\n-    { label: 'Trigger Error', value: 'error', icon: <ErrorIcon /> },\n-    { label: 'Trigger Not Found', value: 'not-found', icon: <NotFoundIcon /> },\n+    {\n+      label: 'Trigger Loading',\n+      value: 'loading',\n+      icon: <LoadingIcon />,\n+      disabled: !boundaries.loading,\n+    },\n+    {\n+      label: 'Trigger Error',\n+      value: 'error',\n+      icon: <ErrorIcon />,\n+      disabled: !boundaries.error,\n+    },\n+    {\n+      label: 'Trigger Not Found',\n+      value: 'not-found',\n+      icon: <NotFoundIcon />,\n+      disabled: !boundaries['not-found'],\n+    },\n   ]\n \n   const resetOption = {\n@@ -74,6 +91,7 @@ export function SegmentBoundaryTrigger({\n                   key={option.value}\n                   className=\"segment-boundary-dropdown-item\"\n                   onClick={() => handleSelect(option.value)}\n+                  disabled={option.disabled}\n                 >\n                   {option.icon}\n                   {option.label}\n@@ -274,9 +292,14 @@ export const styles = `\n     width: 100%;\n   }\n \n+  .segment-boundary-dropdown-item[data-disabled] {\n+    color: var(--color-gray-400);\n+    cursor: not-allowed;\n+  }\n+\n   .segment-boundary-dropdown-item svg {\n     margin-right: 12px;\n-    color: var(--color-gray-900);\n+    color: currentColor;\n   }\n \n   .segment-boundary-dropdown-item:hover {"
        },
        {
            "sha": "8bdfa7ba1e3f3406bbddfac45ffd78e0501129b9",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-explorer.tsx",
            "status": "modified",
            "additions": 31,
            "deletions": 3,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx?ref=2503c19dd068a99c82ec02691b22c323a884614f",
            "patch": "@@ -10,8 +10,12 @@ import {\n } from './segment-boundary-trigger'\n import { Tooltip } from '../../../components/tooltip'\n import { useRef, useState } from 'react'\n-\n-const BUILTIN_PREFIX = '__next_builtin__'\n+import {\n+  BUILTIN_PREFIX,\n+  getBoundaryOriginFileType,\n+  isBoundaryFile,\n+  normalizeBoundaryFilename,\n+} from '../../../../server/app-render/segment-explorer-path'\n \n const isFileNode = (node: SegmentTrieNode) => {\n   return !!node.value?.type && !!node.value?.pagePath\n@@ -133,6 +137,24 @@ function PageSegmentTreeLayerPresentation({\n   }\n \n   const hasFilesChildren = filesChildrenKeys.length > 0\n+  const boundaries: Record<'not-found' | 'loading' | 'error', string | null> = {\n+    'not-found': null,\n+    loading: null,\n+    error: null,\n+  }\n+\n+  filesChildrenKeys.forEach((childKey) => {\n+    const childNode = node.children[childKey]\n+    if (!childNode || !childNode.value) return\n+    if (isBoundaryFile(childNode.value.type)) {\n+      const boundaryType = getBoundaryOriginFileType(childNode.value.type)\n+\n+      if (boundaryType in boundaries) {\n+        boundaries[boundaryType as keyof typeof boundaries] =\n+          childNode.value.pagePath || null\n+      }\n+    }\n+  })\n \n   return (\n     <>\n@@ -165,10 +187,15 @@ function PageSegmentTreeLayerPresentation({\n                     if (!childNode || !childNode.value) {\n                       return null\n                     }\n+                    // If it's boundary node, which marks the existence of the boundary not the rendered status,\n+                    // we don't need to present in the rendered files.\n+                    if (isBoundaryFile(childNode.value.type)) {\n+                      return null\n+                    }\n                     const filePath = childNode.value.pagePath\n                     const lastSegment = filePath.split('/').pop() || ''\n                     const isBuiltin = filePath.startsWith(BUILTIN_PREFIX)\n-                    const fileName = lastSegment.replace(BUILTIN_PREFIX, '')\n+                    const fileName = normalizeBoundaryFilename(lastSegment)\n \n                     return (\n                       <span\n@@ -208,6 +235,7 @@ function PageSegmentTreeLayerPresentation({\n                 <SegmentBoundaryTrigger\n                   offset={6}\n                   onSelectBoundary={pageChild.value.setBoundaryType}\n+                  boundaries={boundaries}\n                 />\n               )}\n             </div>"
        },
        {
            "sha": "09c73f0a0b02de6a7e1f2098eca0ff2198115b42",
            "filename": "packages/next/src/next-devtools/dev-overlay/segment-explorer-trie.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer-trie.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer-trie.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer-trie.ts?ref=2503c19dd068a99c82ec02691b22c323a884614f",
            "patch": "@@ -97,6 +97,7 @@ function createTrie<Value = string>({\n   function remove(value: Value) {\n     let currentNode = root\n     const segments = getCharacters(value)\n+\n     const stack: TrieNode<Value>[] = []\n     let found = true\n     for (const segment of segments) {"
        },
        {
            "sha": "690a863a6deffbbcb1df02bba1cb3792780b4dfb",
            "filename": "packages/next/src/next-devtools/userspace/app/segment-explorer-node.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fsegment-explorer-node.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fsegment-explorer-node.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fsegment-explorer-node.tsx?ref=2503c19dd068a99c82ec02691b22c323a884614f",
            "patch": "@@ -31,15 +31,14 @@ function SegmentTrieNode({\n   pagePath: string\n }): React.ReactNode {\n   const { boundaryType, setBoundaryType } = useSegmentState()\n-  const nodeState: SegmentNodeState = useMemo(\n-    () => ({\n+  const nodeState: SegmentNodeState = useMemo(() => {\n+    return {\n       type,\n       pagePath,\n       boundaryType,\n       setBoundaryType,\n-    }),\n-    [type, pagePath, boundaryType, setBoundaryType]\n-  )\n+    }\n+  }, [type, pagePath, boundaryType, setBoundaryType])\n \n   // Use `useLayoutEffect` to ensure the state is updated during suspense.\n   // `useEffect` won't work as the state is preserved during suspense.\n@@ -143,7 +142,10 @@ export function SegmentStateProvider({ children }: { children: ReactNode }) {\n   return (\n     <SegmentStateContext.Provider\n       key={errorBoundaryKey}\n-      value={{ boundaryType, setBoundaryType: setBoundaryTypeAndReload }}\n+      value={{\n+        boundaryType,\n+        setBoundaryType: setBoundaryTypeAndReload,\n+      }}\n     >\n       {children}\n     </SegmentStateContext.Provider>"
        },
        {
            "sha": "a7ff2c25d6221d60c2114e52dec86948f2aeb81f",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 49,
            "deletions": 14,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=2503c19dd068a99c82ec02691b22c323a884614f",
            "patch": "@@ -26,7 +26,10 @@ import type {\n   UseCachePageComponentProps,\n } from '../use-cache/use-cache-wrapper'\n import { DEFAULT_SEGMENT_KEY } from '../../shared/lib/segment'\n-import { getConventionPathByType } from './segment-explorer-path'\n+import {\n+  BOUNDARY_PREFIX,\n+  getConventionPathByType,\n+} from './segment-explorer-path'\n \n /**\n  * Use the provided loader tree to create the React Component tree.\n@@ -410,23 +413,24 @@ async function createComponentTreeInternal({\n     <MetadataOutlet ready={getMetadataReady} />\n   )\n \n-  const notFoundElement = await createBoundaryConventionElement({\n-    ctx,\n-    conventionName: 'not-found',\n-    Component: NotFound,\n-    styles: notFoundStyles,\n-    tree,\n-  })\n+  const [notFoundElement, notFoundFilePath] =\n+    await createBoundaryConventionElement({\n+      ctx,\n+      conventionName: 'not-found',\n+      Component: NotFound,\n+      styles: notFoundStyles,\n+      tree,\n+    })\n \n-  const forbiddenElement = await createBoundaryConventionElement({\n+  const [forbiddenElement] = await createBoundaryConventionElement({\n     ctx,\n     conventionName: 'forbidden',\n     Component: Forbidden,\n     styles: forbiddenStyles,\n     tree,\n   })\n \n-  const unauthorizedElement = await createBoundaryConventionElement({\n+  const [unauthorizedElement] = await createBoundaryConventionElement({\n     ctx,\n     conventionName: 'unauthorized',\n     Component: Unauthorized,\n@@ -546,8 +550,8 @@ async function createComponentTreeInternal({\n         )\n \n         const templateFilePath = getConventionPathByType(tree, dir, 'template')\n-\n         const errorFilePath = getConventionPathByType(tree, dir, 'error')\n+        const loadingFilePath = getConventionPathByType(tree, dir, 'loading')\n \n         const wrappedErrorStyles =\n           isSegmentViewEnabled && errorFilePath ? (\n@@ -558,6 +562,34 @@ async function createComponentTreeInternal({\n             errorStyles\n           )\n \n+        // Add a suffix to avoid conflict with the segment view node representing rendered file.\n+        // existence: not-found.tsx@boundary\n+        // rendered: not-found.tsx\n+        const fileNameSuffix = '@boundary'\n+        const segmentViewBoundaries = isSegmentViewEnabled ? (\n+          <>\n+            {notFoundFilePath && (\n+              <SegmentViewNode\n+                type={`${BOUNDARY_PREFIX}not-found`}\n+                pagePath={notFoundFilePath + fileNameSuffix}\n+              />\n+            )}\n+            {loadingFilePath && (\n+              <SegmentViewNode\n+                type={`${BOUNDARY_PREFIX}loading`}\n+                pagePath={loadingFilePath + fileNameSuffix}\n+              />\n+            )}\n+            {errorFilePath && (\n+              <SegmentViewNode\n+                type={`${BOUNDARY_PREFIX}error`}\n+                pagePath={errorFilePath + fileNameSuffix}\n+              />\n+            )}\n+            {/* do not surface forbidden and unauthorized boundaries yet as they're unstable */}\n+          </>\n+        ) : null\n+\n         return [\n           parallelRouteKey,\n           <LayoutRouter\n@@ -581,6 +613,7 @@ async function createComponentTreeInternal({\n             notFound={notFoundComponent}\n             forbidden={forbiddenComponent}\n             unauthorized={unauthorizedComponent}\n+            {...(isSegmentViewEnabled && { segmentViewBoundaries })}\n             // Since gracefullyDegrade only applies to bots, only\n             // pass it when we're in a bot context to avoid extra bytes.\n             {...(gracefullyDegrade && { gracefullyDegrade })}\n@@ -603,8 +636,8 @@ async function createComponentTreeInternal({\n   }\n \n   let loadingElement = Loading ? <Loading key=\"l\" /> : null\n+  const loadingFilePath = getConventionPathByType(tree, dir, 'loading')\n   if (isSegmentViewEnabled && loadingElement) {\n-    const loadingFilePath = getConventionPathByType(tree, dir, 'loading')\n     if (loadingFilePath) {\n       loadingElement = (\n         <SegmentViewNode\n@@ -1098,18 +1131,20 @@ async function createBoundaryConventionElement({\n     </>\n   ) : undefined\n \n+  const pagePath = getConventionPathByType(tree, dir, conventionName)\n+\n   const wrappedElement =\n     isSegmentViewEnabled && element ? (\n       <SegmentViewNode\n         key={cacheNodeKey + '-' + conventionName}\n         type={conventionName}\n-        pagePath={getConventionPathByType(tree, dir, conventionName)!}\n+        pagePath={pagePath!}\n       >\n         {element}\n       </SegmentViewNode>\n     ) : (\n       element\n     )\n \n-  return wrappedElement\n+  return [wrappedElement, pagePath] as const\n }"
        },
        {
            "sha": "d2a02d71c363cffcfca07f3124e35cfc43caf6f5",
            "filename": "packages/next/src/server/app-render/segment-explorer-path.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fsegment-explorer-path.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2503c19dd068a99c82ec02691b22c323a884614f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fsegment-explorer-path.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fsegment-explorer-path.ts?ref=2503c19dd068a99c82ec02691b22c323a884614f",
            "patch": "@@ -1,5 +1,7 @@\n import type { LoaderTree } from '../lib/app-dir-module'\n \n+export const BUILTIN_PREFIX = '__next_builtin__'\n+\n export function normalizeConventionFilePath(\n   projectDir: string,\n   conventionPath: string | undefined\n@@ -22,12 +24,28 @@ export function normalizeConventionFilePath(\n   if (nextInternalPrefixRegex.test(relativePath)) {\n     relativePath = relativePath.replace(nextInternalPrefixRegex, '')\n     // Add a special prefix to let segment explorer know it's a built-in component\n-    relativePath = `__next_builtin__${relativePath}`\n+    relativePath = `${BUILTIN_PREFIX}${relativePath}`\n   }\n \n   return relativePath\n }\n \n+export const BOUNDARY_SUFFIX = '@boundary'\n+export function normalizeBoundaryFilename(filename: string) {\n+  return filename\n+    .replace(new RegExp(`^${BUILTIN_PREFIX}`), '')\n+    .replace(new RegExp(`${BOUNDARY_SUFFIX}$`), '')\n+}\n+\n+export const BOUNDARY_PREFIX = 'boundary:'\n+export function isBoundaryFile(fileType: string) {\n+  return fileType.startsWith(BOUNDARY_PREFIX)\n+}\n+\n+export function getBoundaryOriginFileType(fileType: string) {\n+  return fileType.replace(BOUNDARY_PREFIX, '')\n+}\n+\n export function getConventionPathByType(\n   tree: LoaderTree,\n   dir: string,"
        },
        {
            "sha": "69df6c5f8a4755cc3629097a065f54a680c63633",
            "filename": "test/development/app-dir/segment-explorer/app/parallel-routes/@foo/not-found.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/2503c19dd068a99c82ec02691b22c323a884614f/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fparallel-routes%2F%40foo%2Fnot-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2503c19dd068a99c82ec02691b22c323a884614f/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fparallel-routes%2F%40foo%2Fnot-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fparallel-routes%2F%40foo%2Fnot-found.tsx?ref=2503c19dd068a99c82ec02691b22c323a884614f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function NotFound() {\n+  return <div>Not Found @foo</div>\n+}"
        }
    ],
    "stats": {
        "total": 177,
        "additions": 145,
        "deletions": 32
    }
}