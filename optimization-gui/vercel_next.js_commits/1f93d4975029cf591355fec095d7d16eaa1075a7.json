{
    "author": "lubieowoce",
    "message": "test: try to fix flakiness in amphtml util (#78304)\n\nThis PR modifies the AMP HTML testing util to avoid loading the\nvalidator from the network, which causes random test flakiness. I've\nalso made it use the validator from `next/dist/compiled` to match what\nwe do during builds. This means we can drop `amphtml-validator` from the\nroot package.json.",
    "sha": "1f93d4975029cf591355fec095d7d16eaa1075a7",
    "files": [
        {
            "sha": "9267c5cc39480b3212f4d596e1e03297c4f95545",
            "filename": "package.json",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/1f93d4975029cf591355fec095d7d16eaa1075a7/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/1f93d4975029cf591355fec095d7d16eaa1075a7/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=1f93d4975029cf591355fec095d7d16eaa1075a7",
            "patch": "@@ -144,7 +144,6 @@\n     \"@vercel/og\": \"0.6.8\",\n     \"abort-controller\": \"3.0.0\",\n     \"alex\": \"9.1.0\",\n-    \"amphtml-validator\": \"1.0.38\",\n     \"async-sema\": \"3.0.1\",\n     \"babel-plugin-react-compiler\": \"19.0.0-beta-e552027-20250112\",\n     \"browserslist\": \"4.22.2\","
        },
        {
            "sha": "358f8f84bfb21e5f5a1d303c0cdb0c732cd5ed38",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/1f93d4975029cf591355fec095d7d16eaa1075a7/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/1f93d4975029cf591355fec095d7d16eaa1075a7/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=1f93d4975029cf591355fec095d7d16eaa1075a7",
            "patch": "@@ -219,9 +219,6 @@ importers:\n       alex:\n         specifier: 9.1.0\n         version: 9.1.0\n-      amphtml-validator:\n-        specifier: 1.0.38\n-        version: 1.0.38\n       async-sema:\n         specifier: 3.0.1\n         version: 3.0.1"
        },
        {
            "sha": "accee66810b8631681233164a8d5ab4379f56fd4",
            "filename": "test/lib/amp-test-utils.js",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/1f93d4975029cf591355fec095d7d16eaa1075a7/test%2Flib%2Famp-test-utils.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1f93d4975029cf591355fec095d7d16eaa1075a7/test%2Flib%2Famp-test-utils.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Famp-test-utils.js?ref=1f93d4975029cf591355fec095d7d16eaa1075a7",
            "patch": "@@ -1,8 +1,14 @@\n /* eslint-env jest */\n-import amphtmlValidator from 'amphtml-validator'\n+import amphtmlValidator from 'next/dist/compiled/amphtml-validator'\n \n-export async function validateAMP(html) {\n-  const validator = await amphtmlValidator.getInstance()\n+// Use the same validator that we use for builds.\n+// This avoids trying to load one from the network, which can cause random test flakiness.\n+// (duplicated from 'packages/next/src/export/routes/pages.ts')\n+const validatorPath = require.resolve(\n+  'next/dist/compiled/amphtml-validator/validator_wasm.js'\n+)\n+export async function validateAMP(/** @type {string} */ html) {\n+  const validator = await amphtmlValidator.getInstance(validatorPath)\n   const result = validator.validateString(html)\n   if (result.status !== 'PASS') {\n     for (let ii = 0; ii < result.errors.length; ii++) {"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 9,
        "deletions": 7
    }
}