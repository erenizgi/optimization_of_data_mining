{
    "author": "timneutkens",
    "message": "Turbopack Build: Optimize instrumentation hook generation (#77832)\n\n## For Maintainers\n\n### What?\n\n- Add `compiled in` for middleware and instrumentation in Turbopack dev.\n- Fixed a bug where instrumentation.js was being compiled like a page\nfile, local testing moves bootup from 2.5s to 700ms when you have a\ninstrumentation file.\n\n### How?\n- Added early returns in `hot-reloader-turbopack.ts` for middleware and\ninstrumentation paths when there's no route definition, those cases are\nhandled separately already.\n- Added build status indicators in `turbopack-utils.ts` for middleware\nand instrumentation using `startBuilding` and `finishBuilding` hooks\n- Added proper naming for Node.js and Edge instrumentation in the build\nstatus",
    "sha": "c1f34629f73de4865f9224f192ba998c4a860a48",
    "files": [
        {
            "sha": "b29998c080cf28a83c07094f38a939ba0ab2533a",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/c1f34629f73de4865f9224f192ba998c4a860a48/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1f34629f73de4865f9224f192ba998c4a860a48/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=c1f34629f73de4865f9224f192ba998c4a860a48",
            "patch": "@@ -948,6 +948,15 @@ export async function createHotReloaderTurbopack(\n       isApp,\n       url: requestUrl,\n     }) {\n+      // When there is no route definition this is an internal file not a route the user added.\n+      // Middleware and instrumentation are handled in turbpack-utils.ts handleEntrypoints instead.\n+      if (!definition) {\n+        if (inputPage === '/middleware') return\n+        if (inputPage === '/src/middleware') return\n+        if (inputPage === '/instrumentation') return\n+        if (inputPage === '/src/instrumentation') return\n+      }\n+\n       return hotReloaderSpan\n         .traceChild('ensure-page', {\n           inputPage,"
        },
        {
            "sha": "255e2e88dcda372c239632681d15b912396c57e1",
            "filename": "packages/next/src/server/dev/turbopack-utils.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/c1f34629f73de4865f9224f192ba998c4a860a48/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1f34629f73de4865f9224f192ba998c4a860a48/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts?ref=c1f34629f73de4865f9224f192ba998c4a860a48",
            "patch": "@@ -663,11 +663,21 @@ export async function handleEntrypoints({\n       name: string,\n       prop: 'nodeJs' | 'edge'\n     ) => {\n+      const prettyName = {\n+        nodeJs: 'Node.js',\n+        edge: 'Edge',\n+      }\n+      const finishBuilding = dev.hooks.startBuilding(\n+        `instrumentation ${prettyName[prop]}`,\n+        undefined,\n+        true\n+      )\n       const key = getEntryKey('root', 'server', name)\n \n       const writtenEndpoint = await instrumentation[prop].writeToDisk()\n       dev.hooks.handleWrittenEndpoint(key, writtenEndpoint, false)\n       processIssues(currentEntryIssues, key, writtenEndpoint, false, logErrors)\n+      finishBuilding()\n     }\n     await processInstrumentation('instrumentation.nodeJs', 'nodeJs')\n     await processInstrumentation('instrumentation.edge', 'edge')\n@@ -700,6 +710,11 @@ export async function handleEntrypoints({\n     const endpoint = middleware.endpoint\n \n     async function processMiddleware() {\n+      const finishBuilding = dev.hooks.startBuilding(\n+        'middleware',\n+        undefined,\n+        true\n+      )\n       const writtenEndpoint = await endpoint.writeToDisk()\n       dev.hooks.handleWrittenEndpoint(key, writtenEndpoint, false)\n       processIssues(currentEntryIssues, key, writtenEndpoint, false, logErrors)\n@@ -714,6 +729,7 @@ export async function handleEntrypoints({\n           matchers: middlewareConfig.matchers,\n         }\n       }\n+      finishBuilding()\n     }\n     await processMiddleware()\n "
        }
    ],
    "stats": {
        "total": 25,
        "additions": 25,
        "deletions": 0
    }
}