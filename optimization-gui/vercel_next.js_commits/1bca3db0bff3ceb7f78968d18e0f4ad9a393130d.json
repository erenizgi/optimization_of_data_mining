{
    "author": "ztanner",
    "message": "fix: redirect should always return updated router state (#85533)\n\nWhen a server action triggers a redirect, it will return the RSC payload\nfor the destination state in a single roundtrip. This lets us update the\nUI without needing to waterfall when getting the target page's data. We\nreject the server action with a special error signaling that the form\nstate should be reset, but otherwise the redirect itself is unnecessary,\nsince we already are handling it in the server action reducer.\n\nHowever, when we introduced Activity for bfCache, this meant navigating\nback to the previous page would replay the redirect error that was\nstashed in the `RedirectBoundary`. I incorrectly patched this by just\nreturning the current router state, rather than the redirect\ndestination's state, but this lost the ability to return the updated\nstate in the same roundtrip as the redirect. Instead, this marks the\nerror that gets stashed in the `RedirectBoundary` as being \"handled\".\nRe-activating the hidden subtree will now still correctly reset the\nstate (because the boundary handles it), but won't attempt to perform\nthe redirect again.\n\nCloses NAR-470",
    "sha": "1bca3db0bff3ceb7f78968d18e0f4ad9a393130d",
    "files": [
        {
            "sha": "470acc9ee1ce00cefb159781afcd7116e1fa2a34",
            "filename": "packages/next/src/client/components/redirect-boundary.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fredirect-boundary.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fredirect-boundary.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fredirect-boundary.tsx?ref=1bca3db0bff3ceb7f78968d18e0f4ad9a393130d",
            "patch": "@@ -48,6 +48,13 @@ export class RedirectErrorBoundary extends React.Component<\n     if (isRedirectError(error)) {\n       const url = getURLFromRedirectError(error)\n       const redirectType = getRedirectTypeFromError(error)\n+      if ('handled' in error) {\n+        // The redirect was already handled. We'll still catch the redirect error\n+        // so that we can remount the subtree, but we don't actually need to trigger the\n+        // router.push.\n+        return { redirect: null, redirectType: null }\n+      }\n+\n       return { redirect: url, redirectType }\n     }\n     // Re-throw if error is not for redirect"
        },
        {
            "sha": "b5881bc67020a02fd892d46f95ccb041388dff5f",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 12,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=1bca3db0bff3ceb7f78968d18e0f4ad9a393130d",
            "patch": "@@ -415,19 +415,19 @@ export function serverActionReducer(\n         // the component that called the action as the error boundary will remount the tree.\n         // The status code doesn't matter here as the action handler will have already sent\n         // a response with the correct status code.\n-        reject(\n-          getRedirectError(\n-            hasBasePath(redirectHref)\n-              ? removeBasePath(redirectHref)\n-              : redirectHref,\n-            redirectType || RedirectType.push\n-          )\n+        const redirectError = getRedirectError(\n+          hasBasePath(redirectHref)\n+            ? removeBasePath(redirectHref)\n+            : redirectHref,\n+          redirectType || RedirectType.push\n         )\n-\n-        // TODO: Investigate why this is needed with Activity.\n-        if (process.env.__NEXT_CACHE_COMPONENTS) {\n-          return state\n-        }\n+        // We mark the error as handled because we don't want the redirect to be tried later by\n+        // the RedirectBoundary, in case the user goes back and `Activity` triggers the redirect\n+        // again, as it's run within an effect.\n+        // We don't actually need the RedirectBoundary to do a router.push because we already\n+        // have all the necessary RSC data to render the new page within a single roundtrip.\n+        ;(redirectError as any).handled = true\n+        reject(redirectError)\n       } else {\n         resolve(actionResult)\n       }"
        },
        {
            "sha": "88a202395aba83c7cfdb05c74f92380d311ee0b6",
            "filename": "test/e2e/app-dir/refresh/app/redirect-and-refresh/actions.ts",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Factions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Factions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Factions.ts?ref=1bca3db0bff3ceb7f78968d18e0f4ad9a393130d",
            "patch": "@@ -0,0 +1,31 @@\n+'use server'\n+\n+import { cookies } from 'next/headers'\n+import { refresh } from 'next/cache'\n+import { redirect } from 'next/navigation'\n+\n+export async function addTodoEntry(entry: string) {\n+  // simulate some latency\n+  await new Promise((resolve) => setTimeout(resolve, 500))\n+\n+  const cookieStore = await cookies()\n+  const existing = cookieStore.get('todo-entries')?.value || '[]'\n+  const entries = JSON.parse(existing)\n+  entries.push(entry)\n+  cookieStore.set('todo-entries', JSON.stringify(entries))\n+}\n+\n+export async function getTodoEntries() {\n+  const cookieStore = await cookies()\n+  const existing = cookieStore.get('todo-entries')?.value || '[]'\n+  return JSON.parse(existing) as string[]\n+}\n+\n+export async function addEntryAndRefresh(formData: FormData) {\n+  const entry = formData.get('entry') as string\n+\n+  await addTodoEntry(entry)\n+\n+  refresh()\n+  redirect('/redirect-and-refresh/foo')\n+}"
        },
        {
            "sha": "91a3a3dcd668d4211a558e81151ae2a2cafa2237",
            "filename": "test/e2e/app-dir/refresh/app/redirect-and-refresh/foo/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Ffoo%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Ffoo%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Ffoo%2Fpage.tsx?ref=1bca3db0bff3ceb7f78968d18e0f4ad9a393130d",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Foo() {\n+  return <div id=\"foo-page\">Hello from Foo</div>\n+}"
        },
        {
            "sha": "0b874ec6f3cf1d24e0e2ecd205baf5645de0726e",
            "filename": "test/e2e/app-dir/refresh/app/redirect-and-refresh/layout.tsx",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Flayout.tsx?ref=1bca3db0bff3ceb7f78968d18e0f4ad9a393130d",
            "patch": "@@ -0,0 +1,19 @@\n+import { getTodoEntries } from './actions'\n+\n+export default async function Layout({ children }) {\n+  const entries = await getTodoEntries()\n+\n+  console.log({ entries })\n+  return (\n+    <div>\n+      <div id=\"todo-entries\">\n+        {entries.length > 0 ? (\n+          entries.map((phrase, index) => <div key={index}>{phrase}</div>)\n+        ) : (\n+          <div id=\"no-entries\">No entries</div>\n+        )}\n+      </div>\n+      <div>{children}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "19cbd72f724660bca25ef535e0d99101accef423",
            "filename": "test/e2e/app-dir/refresh/app/redirect-and-refresh/page.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Fredirect-and-refresh%2Fpage.tsx?ref=1bca3db0bff3ceb7f78968d18e0f4ad9a393130d",
            "patch": "@@ -0,0 +1,20 @@\n+import { addEntryAndRefresh } from './actions'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <form action={addEntryAndRefresh}>\n+        <label htmlFor=\"todo-input\">Entry</label>\n+        <input\n+          id=\"todo-input\"\n+          type=\"text\"\n+          name=\"entry\"\n+          placeholder=\"Enter a new entry\"\n+        />\n+        <button id=\"add-button\" type=\"submit\">\n+          Add New Todo Entry\n+        </button>\n+      </form>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "d8db637e2be20e74b43987a2da92e6effef52e79",
            "filename": "test/e2e/app-dir/refresh/next.config.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fnext.config.js?ref=1bca3db0bff3ceb7f78968d18e0f4ad9a393130d",
            "patch": "@@ -0,0 +1,3 @@\n+module.exports = {\n+  cacheComponents: true,\n+}"
        },
        {
            "sha": "6c16c35aa5c47203a1a513ddbbc569bfa66f7ac9",
            "filename": "test/e2e/app-dir/refresh/refresh.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Frefresh.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1bca3db0bff3ceb7f78968d18e0f4ad9a393130d/test%2Fe2e%2Fapp-dir%2Frefresh%2Frefresh.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Frefresh.test.ts?ref=1bca3db0bff3ceb7f78968d18e0f4ad9a393130d",
            "patch": "@@ -80,4 +80,24 @@ describe('app-dir refresh', () => {\n       })\n     }\n   })\n+\n+  it('should let you read your write after a redirect and refresh', async () => {\n+    const browser = await next.browser('/redirect-and-refresh')\n+\n+    const todoEntries = await browser.elementById('todo-entries').text()\n+    expect(todoEntries).toBe('No entries')\n+\n+    const todoInput = await browser.elementById('todo-input')\n+    await todoInput.fill('foo')\n+\n+    await browser.elementById('add-button').click()\n+\n+    await retry(async () => {\n+      const newTodoEntries = await browser.elementById('todo-entries').text()\n+      expect(newTodoEntries).toContain('foo')\n+    })\n+\n+    expect(await browser.hasElementByCssSelector('#foo-page')).toBe(true)\n+    expect(await browser.url()).toContain('/redirect-and-refresh/foo')\n+  })\n })"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 115,
        "deletions": 12
    }
}