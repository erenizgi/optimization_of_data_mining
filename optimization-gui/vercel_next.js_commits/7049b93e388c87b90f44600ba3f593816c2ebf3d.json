{
    "author": "bgw",
    "message": "chore(CI): Split trailing-slashes suite cases into smaller suites, port to more modern e2e framework (#78890)\n\nSame basic idea as https://github.com/vercel/next.js/pull/78787\n\nThis test suite has a lot of timeouts with rspack, which causes it to take a long time to run (though not quite long enough that it breaks the job).\n\nIn general, large test suites are good to break up, because they benefit from parallelism.\n\n---\n\nIn addition to breaking this test suite up, I also ported it to the new framework, as the way it was patching `next.config.js` was causing problems, since the old integration tests are not run in isolated directories.",
    "sha": "7049b93e388c87b90f44600ba3f593816c2ebf3d",
    "files": [
        {
            "sha": "39f32a87fb6726c622047fbafc462665d0ffc103",
            "filename": "test/e2e/trailing-slashes/basepath.test.ts",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fbasepath.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fbasepath.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fbasepath.test.ts?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "patch": "@@ -0,0 +1,34 @@\n+/* eslint-env jest */\n+\n+import {\n+  testShouldRedirect,\n+  testLinkShouldRewriteTo,\n+} from './shared-tests.util'\n+import { nextTestSetup, isNextDev } from 'e2e-utils'\n+\n+// we don't need to exhaustively test this, just do some basic sanity checks\n+// for use in combiantion with basePath\n+;(isNextDev ? describe : describe.skip)(\n+  'Trailing slashes in development mode, with basepath, trailingSlash: true',\n+  () => {\n+    const { next } = nextTestSetup({\n+      files: __dirname,\n+      nextConfig: {\n+        trailingSlash: true,\n+        basePath: '/docs',\n+      },\n+    })\n+\n+    testShouldRedirect(next, [\n+      ['/docs/about', '/docs/about/'],\n+      ['/docs', '/docs/'],\n+      ['/docs/catch-all/hello/world', '/docs/catch-all/hello/world/'],\n+      ['/docs/catch-all/hello.world/', '/docs/catch-all/hello.world'],\n+    ])\n+\n+    testLinkShouldRewriteTo(next, [\n+      ['/docs/linker?href=/about', '/docs/about/'],\n+      ['/docs/linker?href=/', '/docs/'],\n+    ])\n+  }\n+)"
        },
        {
            "sha": "e16cd81e3bee63766ca72085401a353a8eb02d10",
            "filename": "test/e2e/trailing-slashes/pages/404.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2F404.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2F404.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fpages%2F404.js?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "previous_filename": "test/integration/trailing-slashes/pages/404.js"
        },
        {
            "sha": "96d9cd596a3d34eda2121edb910b5ab065bf15e4",
            "filename": "test/e2e/trailing-slashes/pages/about.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fabout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fabout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fabout.js?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "previous_filename": "test/integration/trailing-slashes/pages/about.js"
        },
        {
            "sha": "9fe132da2fa85a5c93bad3471fc6dc371f36a907",
            "filename": "test/e2e/trailing-slashes/pages/catch-all/[...slug].js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fcatch-all%2F%5B...slug%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fcatch-all%2F%5B...slug%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fcatch-all%2F%5B...slug%5D.js?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "previous_filename": "test/integration/trailing-slashes/pages/catch-all/[...slug].js"
        },
        {
            "sha": "91e207d5b256e2ecfce1342c1e7f2b0bab640ef7",
            "filename": "test/e2e/trailing-slashes/pages/external-linker.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fexternal-linker.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fexternal-linker.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fexternal-linker.js?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "previous_filename": "test/integration/trailing-slashes/pages/external-linker.js"
        },
        {
            "sha": "0a476734127b8ef0e2c28c36931e3e90b7b5c1b7",
            "filename": "test/e2e/trailing-slashes/pages/index.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Findex.js?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "previous_filename": "test/integration/trailing-slashes/pages/index.js"
        },
        {
            "sha": "928590b8e1d82ca086744ea6c34ef3c7a9c19738",
            "filename": "test/e2e/trailing-slashes/pages/linker.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Flinker.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Flinker.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Flinker.js?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "previous_filename": "test/integration/trailing-slashes/pages/linker.js"
        },
        {
            "sha": "b945de0c9364149c0ffb88f874729f4ae80c79fc",
            "filename": "test/e2e/trailing-slashes/pages/user/index.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fuser%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fuser%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fpages%2Fuser%2Findex.js?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "previous_filename": "test/integration/trailing-slashes/pages/user/index.js"
        },
        {
            "sha": "380c0aeb4632e3fa23eb582f09e23e24903d17c0",
            "filename": "test/e2e/trailing-slashes/shared-tests.util.ts",
            "status": "added",
            "additions": 122,
            "deletions": 0,
            "changes": 122,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fshared-tests.util.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fshared-tests.util.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fshared-tests.util.ts?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "patch": "@@ -0,0 +1,122 @@\n+/* eslint-env jest */\n+\n+// These tests are defined here and used in `app-dir.test.ts` and\n+// `pages-dir.test.ts` so that both test suites can be run in parallel.\n+\n+import type { Playwright } from 'next-webdriver'\n+\n+import cheerio from 'cheerio'\n+import type { NextInstance } from 'e2e-utils'\n+\n+export function testShouldRedirect(\n+  next: NextInstance,\n+  expectations: [string, string][]\n+) {\n+  it.each(expectations)(\n+    '%s should redirect to %s',\n+    async (route, expectedLocation) => {\n+      const res = await next.fetch(route, { redirect: 'manual' })\n+      expect(res.status).toBe(308)\n+      const { pathname } = new URL(res.headers.get('location'))\n+      expect(pathname).toBe(expectedLocation)\n+    }\n+  )\n+}\n+\n+export function testShouldResolve(\n+  next: NextInstance,\n+  expectations: [string, string, string][]\n+) {\n+  it.each(expectations)(\n+    '%s should resolve to %s, with router path %s',\n+    async (route, expectedPage, expectedRouterPath) => {\n+      const res = await next.fetch(route, { redirect: 'error' })\n+      expect(res.status).toBe(200)\n+      const $ = cheerio.load(await res.text())\n+      expect($('#page-marker').text()).toBe(expectedPage)\n+      expect($('#router-pathname').text()).toBe(expectedRouterPath)\n+    }\n+  )\n+\n+  it.each(expectations)(\n+    '%s should client side render %s, with router path %s',\n+    async (route, expectedPage, expectedRouterPath) => {\n+      let browser: Playwright | undefined\n+      try {\n+        browser = await next.browser(route)\n+\n+        await browser.waitForElementByCss('#hydration-marker')\n+        const text = await browser.elementByCss('#page-marker').text()\n+        expect(text).toBe(expectedPage)\n+        const routerPathname = await browser\n+          .elementByCss('#router-pathname')\n+          .text()\n+        expect(routerPathname).toBe(expectedRouterPath)\n+      } finally {\n+        if (browser) await browser.close()\n+      }\n+    }\n+  )\n+}\n+\n+export function testExternalLinkShouldRewriteTo(\n+  next: NextInstance,\n+  expectations: [string, string][]\n+) {\n+  it.each(expectations)(\n+    '%s should have href %s',\n+    async (linkPage, expectedHref) => {\n+      const $ = await next.render$(linkPage)\n+      expect($('#link').attr('href')).toBe(expectedHref)\n+    }\n+  )\n+}\n+\n+export function testLinkShouldRewriteTo(\n+  next: NextInstance,\n+  expectations: [string, string][]\n+) {\n+  it.each(expectations)(\n+    '%s should have href %s',\n+    async (linkPage, expectedHref) => {\n+      const $ = await next.render$(linkPage)\n+      expect($('#link').attr('href')).toBe(expectedHref)\n+    }\n+  )\n+\n+  it.each(expectations)(\n+    '%s should navigate to %s',\n+    async (linkPage, expectedHref) => {\n+      let browser: Playwright | undefined\n+      try {\n+        browser = await next.browser(linkPage)\n+        await browser.elementByCss('#link').click()\n+\n+        await browser.waitForElementByCss('#hydration-marker')\n+        const url = new URL(await browser.eval('window.location.href'))\n+        const pathname = url.href.slice(url.origin.length)\n+        expect(pathname).toBe(expectedHref)\n+      } finally {\n+        if (browser) await browser.close()\n+      }\n+    }\n+  )\n+\n+  it.each(expectations)(\n+    '%s should push route to %s',\n+    async (linkPage, expectedHref) => {\n+      let browser: Playwright | undefined\n+      try {\n+        browser = await next.browser(linkPage)\n+        await browser.elementByCss('#route-pusher').click()\n+\n+        await browser.waitForElementByCss('#hydration-marker')\n+        const url = new URL(await browser.eval('window.location.href'))\n+        const pathname = url.href.slice(url.origin.length)\n+        expect(pathname).toBe(expectedHref)\n+      } finally {\n+        if (browser) await browser.close()\n+      }\n+    }\n+  )\n+}"
        },
        {
            "sha": "4beb72a1c4c6e60a1e0e8cb7e1c26a008b824f38",
            "filename": "test/e2e/trailing-slashes/with-trailing-slash.test.ts",
            "status": "added",
            "additions": 86,
            "deletions": 0,
            "changes": 86,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fwith-trailing-slash.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fwith-trailing-slash.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fwith-trailing-slash.test.ts?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "patch": "@@ -0,0 +1,86 @@\n+/* eslint-env jest */\n+/* eslint-disable jest/no-standalone-expect */\n+\n+import {\n+  testShouldRedirect,\n+  testLinkShouldRewriteTo,\n+  testShouldResolve,\n+  testExternalLinkShouldRewriteTo,\n+} from './shared-tests.util'\n+import { nextTestSetup } from 'e2e-utils'\n+import { join } from 'path'\n+\n+describe('Trailing slashes with trailingSlash: true', () => {\n+  const { next, isNextStart } = nextTestSetup({\n+    files: __dirname,\n+    nextConfig: {\n+      trailingSlash: true,\n+    },\n+  })\n+\n+  testShouldRedirect(next, [\n+    ['/about', '/about/'],\n+    ['/catch-all/hello/world', '/catch-all/hello/world/'],\n+    ['/catch-all/hello.world/', '/catch-all/hello.world'],\n+  ])\n+\n+  testShouldResolve(next, [\n+    // visited url, expected page, expected router path\n+    ['/', '/index.js', '/'],\n+    ['/about/', '/about.js', '/about'],\n+    [\n+      '/catch-all/hello/world/',\n+      '/catch-all/[...slug].js',\n+      '/catch-all/[...slug]',\n+    ],\n+    ['/about/?hello=world', '/about.js', '/about'],\n+  ])\n+\n+  testLinkShouldRewriteTo(next, [\n+    ['/linker?href=/', '/'],\n+    ['/linker?href=/about', '/about/'],\n+    ['/linker?href=/about/', '/about/'],\n+    ['/linker?href=/about?hello=world', '/about/?hello=world'],\n+    ['/linker?href=/about/?hello=world', '/about/?hello=world'],\n+    ['/linker?href=/catch-all/hello/', '/catch-all/hello/'],\n+    ['/linker?href=/catch-all/hello.world/', '/catch-all/hello.world'],\n+  ])\n+\n+  testExternalLinkShouldRewriteTo(next, [\n+    [\n+      `/external-linker?href=${encodeURI('https://nextjs.org')}`,\n+      'https://nextjs.org',\n+    ],\n+    [\n+      `/external-linker?href=${encodeURI('https://nextjs.org/')}`,\n+      'https://nextjs.org/',\n+    ],\n+  ])\n+\n+  // only prod builds have a manifest\n+  ;(isNextStart ? it : it.skip)(\n+    'should have a trailing redirect in the routesmanifest',\n+    async () => {\n+      const manifest = await next.readJSON(\n+        join('.next', 'routes-manifest.json')\n+      )\n+      expect(manifest).toEqual(\n+        expect.objectContaining({\n+          redirects: expect.arrayContaining([\n+            expect.objectContaining({\n+              source:\n+                '/:file((?!\\\\.well-known(?:/.*)?)(?:[^/]+/)*[^/]+\\\\.\\\\w+)/',\n+              destination: '/:file',\n+              statusCode: 308,\n+            }),\n+            expect.objectContaining({\n+              source: '/:notfile((?!\\\\.well-known(?:/.*)?)(?:[^/]+/)*[^/\\\\.]+)',\n+              destination: '/:notfile/',\n+              statusCode: 308,\n+            }),\n+          ]),\n+        })\n+      )\n+    }\n+  )\n+})"
        },
        {
            "sha": "b9685f768a14d356f68a76028e2621d37cd5b49a",
            "filename": "test/e2e/trailing-slashes/without-trailing-slash.test.ts",
            "status": "added",
            "additions": 80,
            "deletions": 0,
            "changes": 80,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fwithout-trailing-slash.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/test%2Fe2e%2Ftrailing-slashes%2Fwithout-trailing-slash.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftrailing-slashes%2Fwithout-trailing-slash.test.ts?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "patch": "@@ -0,0 +1,80 @@\n+/* eslint-env jest */\n+/* eslint-disable jest/no-standalone-expect */\n+\n+import {\n+  testShouldRedirect,\n+  testLinkShouldRewriteTo,\n+  testShouldResolve,\n+  testExternalLinkShouldRewriteTo,\n+} from './shared-tests.util'\n+import { nextTestSetup } from 'e2e-utils'\n+import { join } from 'path'\n+\n+describe('Trailing slashes with trailingSlash: false', () => {\n+  const { next, isNextStart } = nextTestSetup({\n+    files: __dirname,\n+    nextConfig: {\n+      trailingSlash: false,\n+    },\n+  })\n+\n+  testShouldRedirect(next, [\n+    ['/about/', '/about'],\n+    ['/catch-all/hello/world/', '/catch-all/hello/world'],\n+    ['/catch-all/hello.world/', '/catch-all/hello.world'],\n+  ])\n+\n+  testShouldResolve(next, [\n+    // visited url, expected page, expected router path\n+    ['/', '/index.js', '/'],\n+    ['/about', '/about.js', '/about'],\n+    [\n+      '/catch-all/hello/world',\n+      '/catch-all/[...slug].js',\n+      '/catch-all/[...slug]',\n+    ],\n+    ['/about?hello=world', '/about.js', '/about'],\n+  ])\n+\n+  testLinkShouldRewriteTo(next, [\n+    ['/linker?href=/', '/'],\n+    ['/linker?href=/about', '/about'],\n+    ['/linker?href=/about/', '/about'],\n+    ['/linker?href=/about?hello=world', '/about?hello=world'],\n+    ['/linker?href=/about/?hello=world', '/about?hello=world'],\n+    ['/linker?href=/catch-all/hello/', '/catch-all/hello'],\n+    ['/linker?href=/catch-all/hello.world/', '/catch-all/hello.world'],\n+  ])\n+\n+  testExternalLinkShouldRewriteTo(next, [\n+    [\n+      `/external-linker?href=${encodeURI('https://nextjs.org')}`,\n+      'https://nextjs.org',\n+    ],\n+    [\n+      `/external-linker?href=${encodeURI('https://nextjs.org/')}`,\n+      'https://nextjs.org/',\n+    ],\n+  ])\n+\n+  // only prod builds have a manifest\n+  ;(isNextStart ? it : it.skip)(\n+    'should have a redirect in the routesmanifest',\n+    async () => {\n+      const manifest = await next.readJSON(\n+        join('.next', 'routes-manifest.json')\n+      )\n+      expect(manifest).toEqual(\n+        expect.objectContaining({\n+          redirects: expect.arrayContaining([\n+            expect.objectContaining({\n+              source: '/:path+/',\n+              destination: '/:path+',\n+              statusCode: 308,\n+            }),\n+          ]),\n+        })\n+      )\n+    }\n+  )\n+})"
        },
        {
            "sha": "bca79cff8ff68cca4b96b6c400b9f284573cdcfe",
            "filename": "test/integration/trailing-slashes/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/75658b811513979c74c73c8ef594ab0df825a269/test%2Fintegration%2Ftrailing-slashes%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/75658b811513979c74c73c8ef594ab0df825a269/test%2Fintegration%2Ftrailing-slashes%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftrailing-slashes%2Fnext.config.js?ref=75658b811513979c74c73c8ef594ab0df825a269",
            "patch": "@@ -1,4 +0,0 @@\n-module.exports = {\n-  // trailingSlash: boolean,\n-  // basePath: '/docs',\n-}"
        },
        {
            "sha": "39879fdafe282388970d9827539613bd6389665f",
            "filename": "test/integration/trailing-slashes/test/index.test.js",
            "status": "removed",
            "additions": 0,
            "deletions": 365,
            "changes": 365,
            "blob_url": "https://github.com/vercel/next.js/blob/75658b811513979c74c73c8ef594ab0df825a269/test%2Fintegration%2Ftrailing-slashes%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/75658b811513979c74c73c8ef594ab0df825a269/test%2Fintegration%2Ftrailing-slashes%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftrailing-slashes%2Ftest%2Findex.test.js?ref=75658b811513979c74c73c8ef594ab0df825a269",
            "patch": "@@ -1,365 +0,0 @@\n-/* eslint-env jest */\n-\n-import webdriver from 'next-webdriver'\n-\n-import cheerio from 'cheerio'\n-import fs from 'fs-extra'\n-import {\n-  fetchViaHTTP,\n-  renderViaHTTP,\n-  findPort,\n-  killApp,\n-  launchApp,\n-  nextBuild,\n-  nextStart,\n-  File,\n-} from 'next-test-utils'\n-import { join } from 'path'\n-\n-let app\n-let appPort\n-const appDir = join(__dirname, '../')\n-const nextConfig = new File(join(appDir, 'next.config.js'))\n-\n-function testShouldRedirect(expectations) {\n-  it.each(expectations)(\n-    '%s should redirect to %s',\n-    async (route, expectedLocation) => {\n-      const res = await fetchViaHTTP(appPort, route, {}, { redirect: 'manual' })\n-      expect(res.status).toBe(308)\n-      const { pathname } = new URL(res.headers.get('location'))\n-      expect(pathname).toBe(expectedLocation)\n-    }\n-  )\n-}\n-\n-function testShouldResolve(expectations) {\n-  it.each(expectations)(\n-    '%s should resolve to %s, with router path %s',\n-    async (route, expectedPage, expectedRouterPath) => {\n-      const res = await fetchViaHTTP(appPort, route, {}, { redirect: 'error' })\n-      expect(res.status).toBe(200)\n-      const $ = cheerio.load(await res.text())\n-      expect($('#page-marker').text()).toBe(expectedPage)\n-      expect($('#router-pathname').text()).toBe(expectedRouterPath)\n-    }\n-  )\n-\n-  it.each(expectations)(\n-    '%s should client side render %s, with router path %s',\n-    async (route, expectedPage, expectedRouterPath) => {\n-      let browser\n-      try {\n-        browser = await webdriver(appPort, route)\n-\n-        await browser.waitForElementByCss('#hydration-marker')\n-        const text = await browser.elementByCss('#page-marker').text()\n-        expect(text).toBe(expectedPage)\n-        const routerPathname = await browser\n-          .elementByCss('#router-pathname')\n-          .text()\n-        expect(routerPathname).toBe(expectedRouterPath)\n-      } finally {\n-        if (browser) await browser.close()\n-      }\n-    }\n-  )\n-}\n-\n-function testExternalLinkShouldRewriteTo(expectations) {\n-  it.each(expectations)(\n-    '%s should have href %s',\n-    async (linkPage, expectedHref) => {\n-      const content = await renderViaHTTP(appPort, linkPage)\n-      const $ = cheerio.load(content)\n-      expect($('#link').attr('href')).toBe(expectedHref)\n-    }\n-  )\n-}\n-\n-function testLinkShouldRewriteTo(expectations) {\n-  it.each(expectations)(\n-    '%s should have href %s',\n-    async (linkPage, expectedHref) => {\n-      const content = await renderViaHTTP(appPort, linkPage)\n-      const $ = cheerio.load(content)\n-      expect($('#link').attr('href')).toBe(expectedHref)\n-    }\n-  )\n-\n-  it.each(expectations)(\n-    '%s should navigate to %s',\n-    async (linkPage, expectedHref) => {\n-      let browser\n-      try {\n-        browser = await webdriver(appPort, linkPage)\n-        await browser.elementByCss('#link').click()\n-\n-        await browser.waitForElementByCss('#hydration-marker')\n-        const url = new URL(await browser.eval('window.location.href'))\n-        const pathname = url.href.slice(url.origin.length)\n-        expect(pathname).toBe(expectedHref)\n-      } finally {\n-        if (browser) await browser.close()\n-      }\n-    }\n-  )\n-\n-  it.each(expectations)(\n-    '%s should push route to %s',\n-    async (linkPage, expectedHref) => {\n-      let browser\n-      try {\n-        browser = await webdriver(appPort, linkPage)\n-        await browser.elementByCss('#route-pusher').click()\n-\n-        await browser.waitForElementByCss('#hydration-marker')\n-        const url = new URL(await browser.eval('window.location.href'))\n-        const pathname = url.href.slice(url.origin.length)\n-        expect(pathname).toBe(expectedHref)\n-      } finally {\n-        if (browser) await browser.close()\n-      }\n-    }\n-  )\n-}\n-\n-function testWithoutTrailingSlash() {\n-  testShouldRedirect([\n-    ['/about/', '/about'],\n-    ['/catch-all/hello/world/', '/catch-all/hello/world'],\n-    ['/catch-all/hello.world/', '/catch-all/hello.world'],\n-  ])\n-\n-  testShouldResolve([\n-    // visited url, expected page, expected router path\n-    ['/', '/index.js', '/'],\n-    ['/about', '/about.js', '/about'],\n-    [\n-      '/catch-all/hello/world',\n-      '/catch-all/[...slug].js',\n-      '/catch-all/[...slug]',\n-    ],\n-    ['/about?hello=world', '/about.js', '/about'],\n-  ])\n-\n-  testLinkShouldRewriteTo([\n-    ['/linker?href=/', '/'],\n-    ['/linker?href=/about', '/about'],\n-    ['/linker?href=/about/', '/about'],\n-    ['/linker?href=/about?hello=world', '/about?hello=world'],\n-    ['/linker?href=/about/?hello=world', '/about?hello=world'],\n-    ['/linker?href=/catch-all/hello/', '/catch-all/hello'],\n-    ['/linker?href=/catch-all/hello.world/', '/catch-all/hello.world'],\n-  ])\n-\n-  testExternalLinkShouldRewriteTo([\n-    [\n-      `/external-linker?href=${encodeURI('https://nextjs.org')}`,\n-      'https://nextjs.org',\n-    ],\n-    [\n-      `/external-linker?href=${encodeURI('https://nextjs.org/')}`,\n-      'https://nextjs.org/',\n-    ],\n-  ])\n-}\n-\n-function testWithTrailingSlash() {\n-  testShouldRedirect([\n-    ['/about', '/about/'],\n-    ['/catch-all/hello/world', '/catch-all/hello/world/'],\n-    ['/catch-all/hello.world/', '/catch-all/hello.world'],\n-  ])\n-\n-  testShouldResolve([\n-    // visited url, expected page, expected router path\n-    ['/', '/index.js', '/'],\n-    ['/about/', '/about.js', '/about'],\n-    [\n-      '/catch-all/hello/world/',\n-      '/catch-all/[...slug].js',\n-      '/catch-all/[...slug]',\n-    ],\n-    ['/about/?hello=world', '/about.js', '/about'],\n-  ])\n-\n-  testLinkShouldRewriteTo([\n-    ['/linker?href=/', '/'],\n-    ['/linker?href=/about', '/about/'],\n-    ['/linker?href=/about/', '/about/'],\n-    ['/linker?href=/about?hello=world', '/about/?hello=world'],\n-    ['/linker?href=/about/?hello=world', '/about/?hello=world'],\n-    ['/linker?href=/catch-all/hello/', '/catch-all/hello/'],\n-    ['/linker?href=/catch-all/hello.world/', '/catch-all/hello.world'],\n-  ])\n-\n-  testExternalLinkShouldRewriteTo([\n-    [\n-      `/external-linker?href=${encodeURI('https://nextjs.org')}`,\n-      'https://nextjs.org',\n-    ],\n-    [\n-      `/external-linker?href=${encodeURI('https://nextjs.org/')}`,\n-      'https://nextjs.org/',\n-    ],\n-  ])\n-}\n-\n-describe('Trailing slashes', () => {\n-  describe('development mode, trailingSlash: false', () => {\n-    beforeAll(async () => {\n-      nextConfig.replace('// trailingSlash: boolean', 'trailingSlash: false')\n-      appPort = await findPort()\n-      app = await launchApp(appDir, appPort)\n-    })\n-    afterAll(async () => {\n-      nextConfig.restore()\n-      await killApp(app)\n-    })\n-\n-    testWithoutTrailingSlash()\n-  })\n-\n-  describe('development mode, trailingSlash: true', () => {\n-    beforeAll(async () => {\n-      nextConfig.replace('// trailingSlash: boolean', 'trailingSlash: true')\n-      appPort = await findPort()\n-      app = await launchApp(appDir, appPort)\n-    })\n-    afterAll(async () => {\n-      nextConfig.restore()\n-      await killApp(app)\n-    })\n-\n-    testWithTrailingSlash()\n-  })\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode, trailingSlash: false',\n-    () => {\n-      beforeAll(async () => {\n-        nextConfig.replace('// trailingSlash: boolean', 'trailingSlash: false')\n-        await nextBuild(appDir)\n-        appPort = await findPort()\n-        app = await nextStart(appDir, appPort)\n-      })\n-      afterAll(async () => {\n-        nextConfig.restore()\n-        await killApp(app)\n-      })\n-\n-      testWithoutTrailingSlash()\n-\n-      it('should have a redirect in the routesmanifest', async () => {\n-        const manifest = await fs.readJSON(\n-          join(appDir, '.next', 'routes-manifest.json')\n-        )\n-        expect(manifest).toEqual(\n-          expect.objectContaining({\n-            redirects: expect.arrayContaining([\n-              expect.objectContaining({\n-                source: '/:path+/',\n-                destination: '/:path+',\n-                statusCode: 308,\n-              }),\n-            ]),\n-          })\n-        )\n-      })\n-    }\n-  )\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode, trailingSlash: true',\n-    () => {\n-      beforeAll(async () => {\n-        nextConfig.replace('// trailingSlash: boolean', 'trailingSlash: true')\n-        await nextBuild(appDir)\n-        appPort = await findPort()\n-        app = await nextStart(appDir, appPort)\n-      })\n-      afterAll(async () => {\n-        nextConfig.restore()\n-        await killApp(app)\n-      })\n-\n-      testWithTrailingSlash()\n-\n-      it('should have a trailing redirect in the routesmanifest', async () => {\n-        const manifest = await fs.readJSON(\n-          join(appDir, '.next', 'routes-manifest.json')\n-        )\n-        expect(manifest).toEqual(\n-          expect.objectContaining({\n-            redirects: expect.arrayContaining([\n-              expect.objectContaining({\n-                source:\n-                  '/:file((?!\\\\.well-known(?:/.*)?)(?:[^/]+/)*[^/]+\\\\.\\\\w+)/',\n-                destination: '/:file',\n-                statusCode: 308,\n-              }),\n-              expect.objectContaining({\n-                source:\n-                  '/:notfile((?!\\\\.well-known(?:/.*)?)(?:[^/]+/)*[^/\\\\.]+)',\n-                destination: '/:notfile/',\n-                statusCode: 308,\n-              }),\n-            ]),\n-          })\n-        )\n-      })\n-    }\n-  )\n-\n-  describe('development mode, with basepath, trailingSlash: true', () => {\n-    beforeAll(async () => {\n-      nextConfig.replace('// trailingSlash: boolean', 'trailingSlash: true')\n-      nextConfig.replace('// basePath:', 'basePath:')\n-      appPort = await findPort()\n-      app = await launchApp(appDir, appPort)\n-    })\n-    afterAll(async () => {\n-      nextConfig.restore()\n-      await killApp(app)\n-    })\n-\n-    testShouldRedirect([\n-      ['/docs/about', '/docs/about/'],\n-      ['/docs', '/docs/'],\n-      ['/docs/catch-all/hello/world', '/docs/catch-all/hello/world/'],\n-      ['/docs/catch-all/hello.world/', '/docs/catch-all/hello.world'],\n-    ])\n-\n-    testLinkShouldRewriteTo([\n-      ['/docs/linker?href=/about', '/docs/about/'],\n-      ['/docs/linker?href=/', '/docs/'],\n-    ])\n-  })\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode, with basepath, trailingSlash: true',\n-    () => {\n-      beforeAll(async () => {\n-        nextConfig.replace('// trailingSlash: boolean', 'trailingSlash: true')\n-        nextConfig.replace('// basePath:', 'basePath:')\n-        await nextBuild(appDir)\n-        appPort = await findPort()\n-        app = await nextStart(appDir, appPort)\n-      })\n-      afterAll(async () => {\n-        nextConfig.restore()\n-        await killApp(app)\n-      })\n-\n-      testShouldRedirect([\n-        ['/docs/about', '/docs/about/'],\n-        ['/docs', '/docs/'],\n-        ['/docs/catch-all/hello/world', '/docs/catch-all/hello/world/'],\n-        ['/docs/catch-all/hello.world/', '/docs/catch-all/hello.world'],\n-      ])\n-\n-      testLinkShouldRewriteTo([\n-        ['/docs/linker?href=/about', '/docs/about/'],\n-        ['/docs/linker?href=/', '/docs/'],\n-      ])\n-    }\n-  )\n-})"
        },
        {
            "sha": "ac1cdc984bfb90e2f7ffc0bca56347c1c1e6f593",
            "filename": "tsconfig.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7049b93e388c87b90f44600ba3f593816c2ebf3d/tsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/7049b93e388c87b90f44600ba3f593816c2ebf3d/tsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/tsconfig.json?ref=7049b93e388c87b90f44600ba3f593816c2ebf3d",
            "patch": "@@ -24,6 +24,7 @@\n   \"include\": [\n     \"test/**/*.test.ts\",\n     \"test/**/*.test.tsx\",\n+    \"test/**/*.util.ts\",\n     \"test/e2e/app-dir/use-cache-custom-handler/*.js\",\n     \"test/lib/**/*.ts\",\n     \"turbo/**/*.ts\""
        }
    ],
    "stats": {
        "total": 692,
        "additions": 323,
        "deletions": 369
    }
}