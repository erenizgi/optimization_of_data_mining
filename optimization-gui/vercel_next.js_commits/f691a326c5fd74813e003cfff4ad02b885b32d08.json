{
    "author": "acdlite",
    "message": "Remove useSyncExternalStore from useIsDevRendering (#77651)\n\nuseIsDevRendering is a global pending state for router navigations/\nactions. The idiomatic API for this pattern is useOptimistic.\n\nPreviously, this was implemented using useSyncExternalStore, which led\nto an additional sync render every time a navigation completed. The\nadvantage of useOptimistic is that it gets automatically reverted in the\nsame commit as the transition it's associated with.\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that\nyou follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:",
    "sha": "f691a326c5fd74813e003cfff4ad02b885b32d08",
    "files": [
        {
            "sha": "e3b1bde159e6d41860a6891217a07d4f7c115d11",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/dev-indicator/dev-render-indicator.tsx",
            "status": "modified",
            "additions": 12,
            "deletions": 26,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/f691a326c5fd74813e003cfff4ad02b885b32d08/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fdev-render-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f691a326c5fd74813e003cfff4ad02b885b32d08/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fdev-render-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fdev-render-indicator.tsx?ref=f691a326c5fd74813e003cfff4ad02b885b32d08",
            "patch": "@@ -3,35 +3,21 @@\n  * Used by the dev tools indicator to show render status\n  */\n \n-import { useSyncExternalStore } from 'react'\n+import { useEffect, useOptimistic } from 'react'\n \n-let isVisible = false\n-let listeners: Array<() => void> = []\n-\n-const subscribe = (listener: () => void) => {\n-  listeners.push(listener)\n-  return () => {\n-    listeners = listeners.filter((l) => l !== listener)\n-  }\n-}\n-\n-const getSnapshot = () => isVisible\n-\n-const show = () => {\n-  isVisible = true\n-  listeners.forEach((listener) => listener())\n-}\n-\n-const hide = () => {\n-  isVisible = false\n-  listeners.forEach((listener) => listener())\n-}\n+const optimisticStateSetters = new Set<(boolean: true) => void>()\n \n export function useIsDevRendering() {\n-  return useSyncExternalStore(subscribe, getSnapshot)\n+  const [isDevRendering, setIsDevRendering] = useOptimistic(false)\n+  useEffect(() => {\n+    optimisticStateSetters.add(setIsDevRendering)\n+    return () => {\n+      optimisticStateSetters.delete(setIsDevRendering)\n+    }\n+  }, [setIsDevRendering])\n+  return isDevRendering\n }\n \n-export const devRenderIndicator = {\n-  show,\n-  hide,\n+export function setDevRenderIndicatorPending() {\n+  optimisticStateSetters.forEach((setter) => setter(true))\n }"
        },
        {
            "sha": "354bdf93f076e30c313965dcc29f83ca3a2ccef3",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 16,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator.tsx?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -1,16 +0,0 @@\n-import { useEffect, useTransition } from 'react'\n-import { devRenderIndicator } from './dev-render-indicator'\n-\n-export const useSyncDevRenderIndicator = () => {\n-  const [isPending, startTransition] = useTransition()\n-\n-  useEffect(() => {\n-    if (isPending) {\n-      devRenderIndicator.show()\n-    } else {\n-      devRenderIndicator.hide()\n-    }\n-  }, [isPending])\n-\n-  return startTransition\n-}"
        },
        {
            "sha": "2b03249269e5d7ac1b907c77729c3ec78e57d02c",
            "filename": "packages/next/src/client/components/use-action-queue.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 17,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/f691a326c5fd74813e003cfff4ad02b885b32d08/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f691a326c5fd74813e003cfff4ad02b885b32d08/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts?ref=f691a326c5fd74813e003cfff4ad02b885b32d08",
            "patch": "@@ -1,5 +1,5 @@\n import type { Dispatch } from 'react'\n-import React, { use } from 'react'\n+import React, { startTransition, use } from 'react'\n import { isThenable } from '../../shared/lib/is-thenable'\n import type { AppRouterActionQueue } from './app-router-instance'\n import type {\n@@ -19,6 +19,20 @@ export function dispatchAppRouterAction(action: ReducerActions) {\n       'Internal Next.js error: Router action dispatched before initialization.'\n     )\n   }\n+\n+  if (process.env.NODE_ENV !== 'production') {\n+    // In development, set an pending state on the DevTools indicator\n+    // whenever a router action is in progress. This is backed by useOptimistic,\n+    // so we don't need to set it back to false; it will be automatically reset\n+    // when the transition completes.\n+    const setDevRenderIndicatorPending =\n+      require('./react-dev-overlay/utils/dev-indicator/dev-render-indicator')\n+        .setDevRenderIndicatorPending as typeof import('./react-dev-overlay/utils/dev-indicator/dev-render-indicator').setDevRenderIndicatorPending\n+    startTransition(() => setDevRenderIndicatorPending())\n+  }\n+\n+  // NOTE: This is wrapped in a startTransition internally, but to avoid a\n+  // refactor hazard we should consider wrapping it here instead.\n   dispatch(action)\n }\n \n@@ -34,22 +48,7 @@ export function useActionQueue(\n   // Ideally, what we'd do instead is pass the state as a prop to root.render;\n   // this is conceptually how we're modeling the app router state, despite the\n   // weird implementation details.\n-  if (process.env.NODE_ENV !== 'production') {\n-    const useSyncDevRenderIndicator =\n-      require('./react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator')\n-        .useSyncDevRenderIndicator as typeof import('./react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator').useSyncDevRenderIndicator\n-    // eslint-disable-next-line react-hooks/rules-of-hooks\n-    const syncDevRenderIndicator = useSyncDevRenderIndicator()\n-\n-    dispatch = (action: ReducerActions) => {\n-      syncDevRenderIndicator(() => {\n-        actionQueue.dispatch(action, setState)\n-      })\n-    }\n-  } else {\n-    dispatch = (action: ReducerActions) =>\n-      actionQueue.dispatch(action, setState)\n-  }\n+  dispatch = (action: ReducerActions) => actionQueue.dispatch(action, setState)\n \n   return isThenable(state) ? use(state) : state\n }"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 28,
        "deletions": 59
    }
}