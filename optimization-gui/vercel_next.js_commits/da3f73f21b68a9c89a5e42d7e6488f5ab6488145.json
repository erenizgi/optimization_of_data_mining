{
    "author": "ijjk",
    "message": "Add experimental build mode flag for env (#77089)\n\nThis is an alternative to the `generateOnlyEnv` config which moves it to\na build-mode flag instead for easier running. This also adds a log when\nrunning in compile mode to make it clear the build isn't finalized and\nsaying next step since this is more important now that we don't inline\nenv during compile by default.",
    "sha": "da3f73f21b68a9c89a5e42d7e6488f5ab6488145",
    "files": [
        {
            "sha": "0ae06d2711aa8521c7ff355291ae8be0ca401487",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=da3f73f21b68a9c89a5e42d7e6488f5ab6488145",
            "patch": "@@ -135,7 +135,7 @@ program\n       '--experimental-build-mode [mode]',\n       'Uses an experimental build mode.'\n     )\n-      .choices(['compile', 'generate'])\n+      .choices(['compile', 'generate', 'generate-env'])\n       .default('default')\n   )\n   .option("
        },
        {
            "sha": "98722f9eb9ecc98e216e289b7835e9ab243b5ee8",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 15,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=da3f73f21b68a9c89a5e42d7e6488f5ab6488145",
            "patch": "@@ -819,7 +819,7 @@ export default async function build(\n   noMangling = false,\n   appDirOnly = false,\n   turboNextBuild = false,\n-  experimentalBuildMode: 'default' | 'compile' | 'generate',\n+  experimentalBuildMode: 'default' | 'compile' | 'generate' | 'generate-env',\n   traceUploadUrl: string | undefined\n ): Promise<void> {\n   const isCompileMode = experimentalBuildMode === 'compile'\n@@ -884,6 +884,27 @@ export default async function build(\n       )\n       NextBuildContext.buildId = buildId\n \n+      if (experimentalBuildMode === 'generate-env') {\n+        if (turboNextBuild) {\n+          Log.warn('generate-env is not needed with turbopack')\n+          process.exit(0)\n+        }\n+        Log.info('Inlining static env ...')\n+        await nextBuildSpan\n+          .traceChild('inline-static-env')\n+          .traceAsyncFn(async () => {\n+            await inlineStaticEnv({\n+              distDir,\n+              config,\n+            })\n+          })\n+\n+        Log.info('Complete')\n+        await flushAllTraces()\n+        teardownTraceSubscriber()\n+        process.exit(0)\n+      }\n+\n       // when using compile mode static env isn't inlined so we\n       // need to populate in normal runtime env\n       if (isCompileMode || isGenerateMode) {\n@@ -2255,9 +2276,7 @@ export default async function build(\n                 trustHostHeader: ciEnvironment.hasNextSupport,\n \n                 // @ts-expect-error internal field TODO: fix this, should use a separate mechanism to pass the info.\n-                isExperimentalCompile:\n-                  isCompileMode ||\n-                  (isGenerateMode && config.experimental.generateOnlyEnv),\n+                isExperimentalCompile: isCompileMode,\n               },\n             },\n             appDir: dir,\n@@ -2502,6 +2521,8 @@ export default async function build(\n       // we don't need to inline for turbopack build as\n       // it will handle it's own caching separate of compile\n       if (isGenerateMode && !turboNextBuild) {\n+        Log.info('Inlining static env ...')\n+\n         await nextBuildSpan\n           .traceChild('inline-static-env')\n           .traceAsyncFn(async () => {\n@@ -2510,17 +2531,6 @@ export default async function build(\n               config,\n             })\n           })\n-\n-        // users might only want to inline env during experimental generate\n-        // instead of also prerendering e.g. for test mode so exit after\n-        if (config.experimental.generateOnlyEnv) {\n-          Log.info(\n-            'Inlined static env, exiting due to experimental.generateOnlyEnv'\n-          )\n-          await flushAllTraces()\n-          teardownTraceSubscriber()\n-          process.exit(0)\n-        }\n       }\n \n       const middlewareManifest: MiddlewareManifest = await readManifest(\n@@ -3635,6 +3645,12 @@ export default async function build(\n         buildTracesSpinner = undefined\n       }\n \n+      if (isCompileMode) {\n+        Log.info(\n+          `Build ran with \"compile\" mode, to finalize the build run either \"generate\" or \"generate-env\" mode as well`\n+        )\n+      }\n+\n       if (config.output === 'export') {\n         await writeFullyStaticExport(\n           config,"
        },
        {
            "sha": "189ab633e42b9d5502093e4f55c57cd161bbd7bc",
            "filename": "packages/next/src/cli/next-build.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts?ref=da3f73f21b68a9c89a5e42d7e6488f5ab6488145",
            "patch": "@@ -19,7 +19,7 @@ export type NextBuildOptions = {\n   experimentalDebugMemoryUsage: boolean\n   experimentalAppOnly?: boolean\n   experimentalTurbo?: boolean\n-  experimentalBuildMode: 'default' | 'compile' | 'generate'\n+  experimentalBuildMode: 'default' | 'compile' | 'generate' | 'generate-env'\n   experimentalUploadTrace?: string\n }\n "
        },
        {
            "sha": "d6b960f5cc6cb1c95ed4a25981387d8944282f26",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=da3f73f21b68a9c89a5e42d7e6488f5ab6488145",
            "patch": "@@ -262,7 +262,6 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n     excludeDefaultMomentLocales: z.boolean().optional(),\n     experimental: z\n       .strictObject({\n-        generateOnlyEnv: z.boolean().optional(),\n         nodeMiddleware: z.boolean().optional(),\n         after: z.boolean().optional(),\n         appDocumentPreloading: z.boolean().optional(),"
        },
        {
            "sha": "cb63af82e09e0b4e30ff0255cc93f14194bb2013",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=da3f73f21b68a9c89a5e42d7e6488f5ab6488145",
            "patch": "@@ -257,7 +257,6 @@ export interface LoggingConfig {\n }\n \n export interface ExperimentalConfig {\n-  generateOnlyEnv?: boolean\n   nodeMiddleware?: boolean\n   cacheHandlers?: {\n     default?: string\n@@ -1138,7 +1137,6 @@ export const defaultConfig: NextConfig = {\n   outputFileTracingRoot: process.env.NEXT_PRIVATE_OUTPUT_TRACE_ROOT || '',\n   allowedDevOrigins: [],\n   experimental: {\n-    generateOnlyEnv: false,\n     nodeMiddleware: false,\n     cacheLife: {\n       default: {"
        },
        {
            "sha": "98d6cb9d6462c1523beef547a385f9b1b94da9b9",
            "filename": "test/e2e/app-dir/app/index.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/da3f73f21b68a9c89a5e42d7e6488f5ab6488145/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts?ref=da3f73f21b68a9c89a5e42d7e6488f5ab6488145",
            "patch": "@@ -13,8 +13,15 @@ describe('app dir - basic', () => {\n     nextTestSetup({\n       files: __dirname,\n       buildCommand: process.env.NEXT_EXPERIMENTAL_COMPILE\n-        ? `pnpm next build --experimental-build-mode=compile`\n+        ? 'pnpm compile-mode'\n         : undefined,\n+      packageJson: {\n+        scripts: {\n+          'compile-mode': process.env.NEXT_EXPERIMENTAL_COMPILE\n+            ? `next build --experimental-build-mode=compile && next build --experimental-build-mode=generate-env`\n+            : undefined,\n+        },\n+      },\n       dependencies: {\n         nanoid: '4.0.1',\n       },"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 41,
        "deletions": 21
    }
}