{
    "author": "devjiwonchoi",
    "message": "[devtools] restart server pending state (#80858)\n\nThis PR adds a pending state to the clear bundler cache & server\nrestart.\n\nWhen the user clicks the restart server button, Next.js fetches\n`/__nextjs_server_status` for the current server's execution ID. Then it\nqueries `/__nextjs_restart_dev` middleware to trigger the server\nrestart, then polls the `/__nextjs_server_status` path to confirm the\nserver execution ID differs, which means the new server is online.\n\nWhen the server has restarted, reload the window.\n\nCloses NEXT-4562\nCloses NEXT-4501\n\n---------\n\nCo-authored-by: Jiachi Liu <inbox@huozhi.im>",
    "sha": "e26fad47b2ee1d6fefc2e818c9d3125854482e4b",
    "files": [
        {
            "sha": "114785b688b864c8da603b428a18ba9f047413e0",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/dev-tools-info/user-preferences.tsx",
            "status": "modified",
            "additions": 11,
            "deletions": 17,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/e26fad47b2ee1d6fefc2e818c9d3125854482e4b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e26fad47b2ee1d6fefc2e818c9d3125854482e4b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx?ref=e26fad47b2ee1d6fefc2e818c9d3125854482e4b",
            "patch": "@@ -17,6 +17,7 @@ import {\n   type DevToolsScale,\n } from './preferences'\n import { ShortcutRecorder } from './shortcut-recorder'\n+import { useRestartServer } from '../../error-overlay-toolbar/use-restart-server'\n \n export function UserPreferences({\n   hide,\n@@ -69,6 +70,7 @@ export function UserPreferencesBody({\n   scale: DevToolsScale\n   setScale: (value: DevToolsScale) => void\n }) {\n+  const { restartServer, isPending } = useRestartServer()\n   const [theme, setTheme] = useState(getInitialTheme())\n \n   const handleThemeChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\n@@ -105,21 +107,6 @@ export function UserPreferencesBody({\n     setScale(value)\n   }\n \n-  function handleRestartDevServer(invalidatePersistentCache: boolean) {\n-    let endpoint = '/__nextjs_restart_dev'\n-\n-    if (invalidatePersistentCache) {\n-      endpoint = '/__nextjs_restart_dev?invalidatePersistentCache'\n-    }\n-\n-    fetch(endpoint, {\n-      method: 'POST',\n-    }).then(() => {\n-      // TODO: poll server status and reload when the server is back up.\n-      // https://github.com/vercel/next.js/pull/80005\n-    })\n-  }\n-\n   return (\n     <>\n       <h2 className=\"dev-tools-info-section-title\">General</h2>\n@@ -253,8 +240,9 @@ export function UserPreferencesBody({\n               data-restart-dev-server\n               className=\"action-button\"\n               onClick={() =>\n-                handleRestartDevServer(/*invalidatePersistentCache*/ false)\n+                restartServer({ invalidatePersistentCache: false })\n               }\n+              disabled={isPending}\n             >\n               <span>Restart</span>\n             </button>\n@@ -279,8 +267,9 @@ export function UserPreferencesBody({\n                 data-reset-bundler-cache\n                 className=\"action-button\"\n                 onClick={() =>\n-                  handleRestartDevServer(/*invalidatePersistentCache*/ true)\n+                  restartServer({ invalidatePersistentCache: true })\n                 }\n+                disabled={isPending}\n               >\n                 <span>Reset Cache</span>\n               </button>\n@@ -408,6 +397,11 @@ export const DEV_TOOLS_INFO_USER_PREFERENCES_STYLES = css`\n     }\n   }\n \n+  .preference-section button:disabled {\n+    opacity: 0.6;\n+    cursor: not-allowed;\n+  }\n+\n   :global(.icon) {\n     width: 18px;\n     height: 18px;"
        },
        {
            "sha": "b4758bfc29b24f11cee0c5fc8bf8e0de3788e998",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/restart-server-button.tsx",
            "status": "modified",
            "additions": 31,
            "deletions": 14,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/e26fad47b2ee1d6fefc2e818c9d3125854482e4b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e26fad47b2ee1d6fefc2e818c9d3125854482e4b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx?ref=e26fad47b2ee1d6fefc2e818c9d3125854482e4b",
            "patch": "@@ -5,6 +5,8 @@ import {\n   type OverlayDispatch,\n } from '../../../shared'\n import type { SupportedErrorEvent } from '../../../container/runtime-error/render-error'\n+import { useRestartServer } from './use-restart-server'\n+import { css } from '../../../utils/css'\n \n /**\n  * When the Turbopack persistent cache is enabled, and the user reloads on a\n@@ -14,28 +16,29 @@ import type { SupportedErrorEvent } from '../../../container/runtime-error/rende\n  * telemetry on how often this is used.\n  */\n export function RestartServerButton({ showButton }: { showButton: boolean }) {\n+  const { restartServer, isPending } = useRestartServer()\n+\n   if (!showButton) {\n     return null\n   }\n \n-  function handleClick() {\n-    // TODO: Use Client Action for transition indicator when DevTools is isolated.\n-    fetch('/__nextjs_restart_dev?invalidatePersistentCache', {\n-      method: 'POST',\n-    }).then(() => {\n-      // TODO: poll server status and reload when the server is back up.\n-      // https://github.com/vercel/next.js/pull/80005\n-    })\n-  }\n-\n   return (\n     <button\n       className=\"restart-dev-server-button\"\n-      onClick={handleClick}\n+      onClick={() => restartServer({ invalidatePersistentCache: true })}\n+      disabled={isPending}\n       title=\"Clears the bundler cache and restarts the dev server. Helpful if you are seeing stale errors or changes are not appearing.\"\n     >\n-      <RefreshClockWise width={14} height={14} />\n-      Clear Bundler Cache &amp; Restart\n+      <RefreshClockWise\n+        width={14}\n+        height={14}\n+        style={{\n+          animation: isPending\n+            ? 'refresh-clock-wise-spin 1s linear infinite'\n+            : undefined,\n+        }}\n+      />\n+      Reset Bundler Cache\n     </button>\n   )\n }\n@@ -84,7 +87,7 @@ export function usePersistentCacheErrorDetection({\n   }, [errors, dispatch])\n }\n \n-export const RESTART_SERVER_BUTTON_STYLES = `\n+export const RESTART_SERVER_BUTTON_STYLES = css`\n   .restart-dev-server-button {\n     display: flex;\n     justify-content: center;\n@@ -105,4 +108,18 @@ export const RESTART_SERVER_BUTTON_STYLES = `\n     font-weight: 500;\n     line-height: var(--size-16);\n   }\n+\n+  .restart-dev-server-button:disabled {\n+    opacity: 0.6;\n+    cursor: not-allowed;\n+  }\n+\n+  @keyframes refresh-clock-wise-spin {\n+    from {\n+      transform: rotate(0deg);\n+    }\n+    to {\n+      transform: rotate(360deg);\n+    }\n+  }\n `"
        },
        {
            "sha": "74b5684d76c874601b2ec96434f468809e14e9a0",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/use-restart-server.ts",
            "status": "added",
            "additions": 92,
            "deletions": 0,
            "changes": 92,
            "blob_url": "https://github.com/vercel/next.js/blob/e26fad47b2ee1d6fefc2e818c9d3125854482e4b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fuse-restart-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e26fad47b2ee1d6fefc2e818c9d3125854482e4b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fuse-restart-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fuse-restart-server.ts?ref=e26fad47b2ee1d6fefc2e818c9d3125854482e4b",
            "patch": "@@ -0,0 +1,92 @@\n+import { useState } from 'react'\n+\n+export function useRestartServer() {\n+  const [isPending, setIsPending] = useState(false)\n+\n+  const restartServer = async ({\n+    invalidatePersistentCache,\n+  }: {\n+    invalidatePersistentCache: boolean\n+  }): Promise<void> => {\n+    setIsPending(true)\n+\n+    const url = invalidatePersistentCache\n+      ? '/__nextjs_restart_dev?invalidatePersistentCache=1'\n+      : '/__nextjs_restart_dev'\n+\n+    let serverRestarted = false\n+\n+    try {\n+      const curId = await fetch('/__nextjs_server_status')\n+        .then((res) => res.json())\n+        .then((data) => data.executionId as number)\n+        .catch((error) => {\n+          console.log(\n+            '[Next.js DevTools] Failed to fetch server status while restarting dev server.',\n+            error\n+          )\n+          return null\n+        })\n+\n+      if (!curId) {\n+        console.log(\n+          '[Next.js DevTools] Failed to get the current server execution ID while restarting dev server.'\n+        )\n+        return\n+      }\n+\n+      const restartRes = await fetch(url, {\n+        method: 'POST',\n+      })\n+\n+      if (!restartRes.ok) {\n+        // Use console log to avoid spamming the error overlay which users can't control.\n+        console.log(\n+          '[Next.js DevTools] Failed to fetch restart server endpoint. Status:',\n+          restartRes.status\n+        )\n+        return\n+      }\n+\n+      // Poll for server restart confirmation.\n+      for (let i = 0; i < 10; i++) {\n+        // generous 1 second delay for large apps.\n+        await new Promise((resolveTimeout) => setTimeout(resolveTimeout, 1_000))\n+\n+        try {\n+          const nextId = await fetch('/__nextjs_server_status')\n+            .then((res) => res.json())\n+            .then((data) => data.executionId as number)\n+\n+          // If the execution ID has changed, the server has restarted successfully.\n+          if (curId !== nextId) {\n+            serverRestarted = true\n+            // Reload the page to ensure the connection to the new server.\n+            window.location.reload()\n+            return\n+          }\n+        } catch (e) {\n+          continue\n+        }\n+      }\n+\n+      console.log(\n+        '[Next.js DevTools] Failed to restart server. Exhausted all polling attempts.'\n+      )\n+      return\n+    } catch (error) {\n+      console.log('[Next.js DevTools] Failed to restart server.', error)\n+      return\n+    } finally {\n+      // If server restarted, don't reset isPending since the page will reload.\n+      if (!serverRestarted) {\n+        setIsPending(false)\n+      }\n+    }\n+  }\n+\n+  return {\n+    restartServer,\n+    isPending,\n+  }\n+}"
        },
        {
            "sha": "1c4fb78c12a7dd15f220503c3cd2d0a143f519ad",
            "filename": "packages/next/src/next-devtools/dev-overlay/styles/component-styles.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e26fad47b2ee1d6fefc2e818c9d3125854482e4b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstyles%2Fcomponent-styles.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e26fad47b2ee1d6fefc2e818c9d3125854482e4b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstyles%2Fcomponent-styles.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstyles%2Fcomponent-styles.tsx?ref=e26fad47b2ee1d6fefc2e818c9d3125854482e4b",
            "patch": "@@ -25,6 +25,7 @@ import { CALL_STACK_STYLES } from '../components/call-stack/call-stack'\n import { ISSUE_FEEDBACK_BUTTON_STYLES } from '../components/errors/error-overlay-toolbar/issue-feedback-button'\n import { ERROR_CONTENT_SKELETON_STYLES } from '../container/runtime-error/error-content-skeleton'\n import { SHORTCUT_RECORDER_STYLES } from '../components/errors/dev-tools-indicator/dev-tools-info/shortcut-recorder'\n+\n export function ComponentStyles() {\n   return (\n     <style>"
        }
    ],
    "stats": {
        "total": 166,
        "additions": 135,
        "deletions": 31
    }
}