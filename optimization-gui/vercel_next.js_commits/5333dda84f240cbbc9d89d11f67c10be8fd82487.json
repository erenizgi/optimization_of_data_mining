{
    "author": "devjiwonchoi",
    "message": "[release] add new ci to use changesets/action for stable release (#79037)\n\nThis PR added `.github/workflows/trigger_release_new.yml`, which is a port of `.github/workflows/trigger_release.yml` and modified [publishRelease](https://github.com/vercel/next.js/blob/8223eb86925e575cd641b55626b4bbc4a4d788c6/.github/workflows/build_and_deploy.yml#L529) to use the `changesets/action` to publish to NPM and GitHub Release.\r\n\r\nThis workflow uses [changesets/action](https://github.com/changesets/action) to publish NPM and GitHub Release. The main difference is that the GitHub Release will be published per package.\r\n\r\n### Testing Plan\r\n\r\nTry running `ci:version` and `ci:publish` locally.",
    "sha": "5333dda84f240cbbc9d89d11f67c10be8fd82487",
    "files": [
        {
            "sha": "6a41b44eb06bc3ee51617ee6af43159c0988320e",
            "filename": ".github/workflows/build_and_deploy.yml",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/5333dda84f240cbbc9d89d11f67c10be8fd82487/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/5333dda84f240cbbc9d89d11f67c10be8fd82487/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_deploy.yml?ref=5333dda84f240cbbc9d89d11f67c10be8fd82487",
            "patch": "@@ -19,6 +19,9 @@ env:\n   #\n   # See https://doc.rust-lang.org/rustc/platform-support/apple-darwin.html#os-version for more details\n   MACOSX_DEPLOYMENT_TARGET: 11.0\n+  # This will become \"true\" if the latest commit is\n+  # \"Version Packages\", set from check-is-release.js\n+  __NEW_RELEASE: 'false'\n \n jobs:\n   deploy-target:\n@@ -44,7 +47,12 @@ jobs:\n         # 'staging' for canary branch since that will eventually be published i.e. become the production build.\n         id: deploy-target\n         run: |\n-          if [[ $(node ./scripts/check-is-release.js 2> /dev/null || :) = v* ]];\n+          # TODO: Remove the new release check once the new release workflow is fully replaced.\n+          RELEASE_CHECK=$(node ./scripts/check-is-release.js 2> /dev/null || :)\n+          if [[ $RELEASE_CHECK =~ ^Version\\ Packages$ ]];\n+          then\n+            echo \"__NEW_RELEASE=true\" >> $GITHUB_ENV\n+          elif [[ $RELEASE_CHECK = v* ]];\n           then\n             echo \"value=production\" >> $GITHUB_OUTPUT\n           elif [ '${{ github.ref }}' == 'refs/heads/canary' ]\n@@ -586,10 +594,23 @@ jobs:\n       - run: npm i -g npm@10.4.0 # need latest version for provenance (pinning to avoid bugs)\n       - run: echo \"//registry.npmjs.org/:_authToken=$NPM_TOKEN\" >> ~/.npmrc\n       - run: ./scripts/publish-native.js\n+      # Legacy release process\n       - run: ./scripts/publish-release.js\n+        if: ${{ env.__NEW_RELEASE == 'false' }}\n         env:\n           RELEASE_BOT_GITHUB_TOKEN: ${{ secrets.RELEASE_BOT_GITHUB_TOKEN }}\n \n+      # New release process\n+      - name: Publish to NPM\n+        id: publish-packages\n+        if: ${{ env.__NEW_RELEASE == 'true' }}\n+        uses: changesets/action@v1\n+        with:\n+          publish: pnpm ci:publish\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.RELEASE_BOT_GITHUB_TOKEN }}\n+          NPM_TOKEN: ${{ secrets.NPM_TOKEN_ELEVATED }}\n+\n       - name: Upload npm log artifact\n         uses: actions/upload-artifact@v4\n         if: always()"
        },
        {
            "sha": "86f72bed2bb4bc6d8c1e18363089e19d2c071770",
            "filename": ".github/workflows/trigger_release_new.yml",
            "status": "added",
            "additions": 103,
            "deletions": 0,
            "changes": 103,
            "blob_url": "https://github.com/vercel/next.js/blob/5333dda84f240cbbc9d89d11f67c10be8fd82487/.github%2Fworkflows%2Ftrigger_release_new.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/5333dda84f240cbbc9d89d11f67c10be8fd82487/.github%2Fworkflows%2Ftrigger_release_new.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Ftrigger_release_new.yml?ref=5333dda84f240cbbc9d89d11f67c10be8fd82487",
            "patch": "@@ -0,0 +1,103 @@\n+name: Trigger Release (New)\n+\n+on:\n+  workflow_dispatch:\n+    inputs:\n+      releaseType:\n+        description: Release Type\n+        required: true\n+        type: choice\n+        options:\n+          # TODO: Follow up enable the case.\n+          # - canary\n+          - stable\n+          # TODO: Follow up enable the case.\n+          # - release-candidate\n+\n+      force:\n+        description: Forced Release\n+        default: false\n+        type: boolean\n+\n+concurrency: ${{ github.workflow }}-${{ github.ref }}\n+\n+env:\n+  NAPI_CLI_VERSION: 2.14.7\n+  TURBO_VERSION: 2.3.3\n+  NODE_LTS_VERSION: 20\n+\n+jobs:\n+  start:\n+    if: github.repository_owner == 'vercel'\n+    runs-on: ubuntu-latest\n+    env:\n+      NEXT_TELEMETRY_DISABLED: 1\n+      # we build a dev binary for use in CI so skip downloading\n+      # canary next-swc binaries in the monorepo\n+      NEXT_SKIP_NATIVE_POSTINSTALL: 1\n+\n+    environment: release-${{ github.event.inputs.releaseType }}\n+    steps:\n+      - name: Setup node\n+        uses: actions/setup-node@v4\n+        with:\n+          node-version: ${{ env.NODE_LTS_VERSION }}\n+          check-latest: true\n+\n+      # Since actions/checkout won't include the latest tag information,\n+      # use the old clone workflow while still preserving branch specific\n+      # checkout behavior to support backports.\n+      # x-ref: https://github.com/vercel/next.js/pull/63167\n+      - name: Clone Next.js repository\n+        run: git clone https://github.com/vercel/next.js.git --depth=25 --single-branch --branch ${GITHUB_REF_NAME:-canary} .\n+\n+      - name: Check token\n+        run: gh auth status\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.RELEASE_BOT_GITHUB_TOKEN }}\n+\n+      - name: Get commit of the latest tag\n+        run: echo \"LATEST_TAG_COMMIT=$(git rev-list -n 1 $(git describe --tags --abbrev=0))\" >> $GITHUB_ENV\n+\n+      - name: Get latest commit\n+        run: echo \"LATEST_COMMIT=$(git rev-parse HEAD)\" >> $GITHUB_ENV\n+\n+      - name: Check if new commits since last tag\n+        if: ${{ github.event.inputs.releaseType != 'stable' && github.event.inputs.force != true }}\n+        run: |\n+          if [ \"$LATEST_TAG_COMMIT\" = \"$LATEST_COMMIT\" ]; then\n+            echo \"No new commits. Exiting...\"\n+            exit 1\n+          fi\n+\n+      # https://github.com/actions/virtual-environments/issues/1187\n+      - name: tune linux network\n+        run: sudo ethtool -K eth0 tx off rx off\n+\n+      - name: Setup corepack\n+        run: |\n+          npm i -g corepack@0.31\n+          corepack enable\n+          pnpm --version\n+\n+      - id: get-store-path\n+        run: echo STORE_PATH=$(pnpm store path) >> $GITHUB_OUTPUT\n+\n+      - uses: actions/cache@v4\n+        timeout-minutes: 5\n+        id: cache-pnpm-store\n+        with:\n+          path: ${{ steps.get-store-path.outputs.STORE_PATH }}\n+          key: pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}\n+          restore-keys: |\n+            pnpm-store-\n+            pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}\n+\n+      - run: pnpm install\n+      - run: pnpm run build\n+\n+      - name: Create Release Pull Request\n+        id: version-packages\n+        uses: changesets/action@v1\n+        with:\n+          version: pnpm ci:version"
        },
        {
            "sha": "38bc06a9e422b7c9cc91a7baafaffc4153f1b6ce",
            "filename": "package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5333dda84f240cbbc9d89d11f67c10be8fd82487/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5333dda84f240cbbc9d89d11f67c10be8fd82487/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=5333dda84f240cbbc9d89d11f67c10be8fd82487",
            "patch": "@@ -13,6 +13,8 @@\n     \"lerna\": \"lerna\",\n     \"dev\": \"turbo run dev --parallel\",\n     \"pack-next\": \"tsx scripts/pack-next.ts\",\n+    \"ci:version\": \"changeset version && pnpm install --no-frozen-lockfile\",\n+    \"ci:publish\": \"changeset publish\",\n     \"test-types\": \"tsc\",\n     \"test-unit\": \"jest test/unit/ packages/next/ packages/font\",\n     \"test-dev\": \"cross-env NEXT_TEST_MODE=dev pnpm testheadless\","
        },
        {
            "sha": "ce279e474329562d0aa4921f82ac710aa1dccf9b",
            "filename": "scripts/check-is-release.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5333dda84f240cbbc9d89d11f67c10be8fd82487/scripts%2Fcheck-is-release.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5333dda84f240cbbc9d89d11f67c10be8fd82487/scripts%2Fcheck-is-release.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fcheck-is-release.js?ref=5333dda84f240cbbc9d89d11f67c10be8fd82487",
            "patch": "@@ -13,10 +13,14 @@ const checkIsRelease = async () => {\n \n   const versionString = commitMsg.split(' ').pop().trim()\n   const publishMsgRegex = /^v\\d{1,}\\.\\d{1,}\\.\\d{1,}(-\\w{1,}\\.\\d{1,})?$/\n+  const newPublishMsgRegex = /^Version Packages$/\n \n   if (publishMsgRegex.test(versionString)) {\n     console.log(versionString)\n     process.exit(0)\n+  } else if (newPublishMsgRegex.test(commitMsg)) {\n+    console.log(commitMsg)\n+    process.exit(0)\n   } else {\n     console.log('not publish commit', { commitId, commitMsg, versionString })\n     process.exit(1)"
        }
    ],
    "stats": {
        "total": 132,
        "additions": 131,
        "deletions": 1
    }
}