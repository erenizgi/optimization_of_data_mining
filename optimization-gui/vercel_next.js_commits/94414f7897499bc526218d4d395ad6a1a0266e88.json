{
    "author": "evankirkiles",
    "message": "bugfix: Bad `next.route` on `pages` dir OTel spans for `404`s / `500`s (#77150)\n\n## Issue\n\n- Resolves https://github.com/vercel/next.js/issues/82102\n\n## What it Does\n\nPrevents the root span attribute `next.route` from being overwritten\nonce set for a request. This resolves two issues:\n\n1. Fixes `404`s and `500`s in the `pagesDir` overwriting `next.route` on\nOpenTelemetry root span\n2. Removes redundant `/route` suffixes on `appDir` API Route Handler\nOTel span names\n\n## Background\n\nThe root OTel span (`BaseServer.handleRequest`) for requests in Next.js\nderives its `name` from its `next.route` attr, set by child spans\nthrough the `NextTracerImpl.setRootSpanAttribute` function. The problem\nis, when a page `404`s or `500`s, the rendering of the `404` or `500`\npage *also* sets `next.route`. This scrubs the root span of the original\npage's `next.route`, as if the user had requested the `/_not-found` or\n`/_error` page directly.\n\nFor example, these two traces in `otel-desktop-viewer` are requests to\nthe same URL, with the bottom having received an error thrown in\n`getServerSideProps`:\n\n<img width=\"328\" alt=\"image\"\nsrc=\"https://github.com/user-attachments/assets/855744b6-8720-4c5e-a5e5-b15cb95e43ca\"\n/>\n\nThis is not helpful at all! Further investigation shows that root spans\nall have the following behavior::\n- Successful responses are correctly named after their path, e.g. `GET\n/foo` with `status_code: 200`\n- Not found responses on ALL paths are named `GET /_not-found` with\n`status_code: 404`\n- Erroring responses on ALL paths are named `GET /_error` with\n`status_code: 500`\n\nAs another example, consider which `name` and `status_code` combo is\nmore helpful:\n\n- `name: GET /_not-found`, `status_code: 404`, `http.target:\n/foo?page=10`, `next.route: /_not-found` (current)\n- **`name: GET /foo`**, `status_code: 404`, `http.target: /foo?page=10`,\n`next.route: /foo`, (desired)\n\nClearly, replacing span names with `GET /_not-found` only removes\ninformation, as the \"404\"-ness is already indicated by the `status_code`\nspan attribute.\n\nA search for `setRootSpanAttribute` confirms that this function is only\nused 4 times, all to set `next.route`:\n\n\nhttps://github.com/vercel/next.js/blob/6d7266e329a684b4e254c6a265f5b3ddb6e7b332/packages/next/src/server/api-utils/index.ts?plain=1#L28\n\n\nhttps://github.com/vercel/next.js/blob/6d7266e329a684b4e254c6a265f5b3ddb6e7b332/packages/next/src/server/route-modules/app-route/module.ts?plain=1#L743\n\n\nhttps://github.com/vercel/next.js/blob/6d7266e329a684b4e254c6a265f5b3ddb6e7b332/packages/next/src/server/base-server.ts?plain=1#L3732\n\n\nhttps://github.com/vercel/next.js/blob/6d7266e329a684b4e254c6a265f5b3ddb6e7b332/packages/next/src/server/app-render/app-render.tsx?plain=1#L1333\n\nSo, we need to make sure `setRootSpanAttribute` does not overwrite\n`next.route` if it has already been set. This PR does that, and adds\ntests for `/_not-found` and `/_error` page cases (which were missing\nfrom the `e2e` test suite).\n\n## Repro\n\nRepro: https://github.com/evankirkiles/nextjs-otel-span-name-errors\n\nBefore (using `next.js@canary`):\n\n<img width=\"1773\" height=\"1036\" alt=\"SCR-20250727-suas\"\nsrc=\"https://github.com/user-attachments/assets/94895bc7-8f09-4c55-ba3e-63191ac49ff7\"\n/>\n\nAfter (using changes from this PR):\n\n<img width=\"1728\" height=\"997\" alt=\"image\"\nsrc=\"https://github.com/user-attachments/assets/3f3a1fdd-0acd-4b00-a34d-3e8e3d49e09a\"\n/>\n\n\n## Fixing a bug\n\n- [x] Tests added. See:\nhttps://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs",
    "sha": "94414f7897499bc526218d4d395ad6a1a0266e88",
    "files": [
        {
            "sha": "9e41309c0da84b56f9539d7940edced98a82405a",
            "filename": "packages/next/src/server/lib/trace/tracer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/94414f7897499bc526218d4d395ad6a1a0266e88/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ftrace%2Ftracer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94414f7897499bc526218d4d395ad6a1a0266e88/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ftrace%2Ftracer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ftrace%2Ftracer.ts?ref=94414f7897499bc526218d4d395ad6a1a0266e88",
            "patch": "@@ -456,7 +456,7 @@ class NextTracerImpl implements NextTracer {\n   public setRootSpanAttribute(key: AttributeNames, value: AttributeValue) {\n     const spanId = context.active().getValue(rootSpanIdKey) as number\n     const attributes = rootSpanAttributesStore.get(spanId)\n-    if (attributes) {\n+    if (attributes && !attributes.has(key)) {\n       attributes.set(key, value)\n     }\n   }"
        },
        {
            "sha": "5499309dcaad8a6f7ba756713e2f70ff1ea862c7",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/94414f7897499bc526218d4d395ad6a1a0266e88/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94414f7897499bc526218d4d395ad6a1a0266e88/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=94414f7897499bc526218d4d395ad6a1a0266e88",
            "patch": "@@ -22,7 +22,6 @@ import { getImplicitTags, type ImplicitTags } from '../../lib/implicit-tags'\n import { patchFetch } from '../../lib/patch-fetch'\n import { getTracer } from '../../lib/trace/tracer'\n import { AppRouteRouteHandlersSpan } from '../../lib/trace/constants'\n-import { getPathnameFromAbsolutePath } from './helpers/get-pathname-from-absolute-path'\n import * as Log from '../../../build/output/log'\n import { autoImplementMethods } from './helpers/auto-implement-methods'\n import {\n@@ -765,20 +764,18 @@ export class AppRouteRouteModule extends RouteModule<\n                 this.dynamic satisfies never\n             }\n \n-            // TODO: propagate this pathname from route matcher\n-            const route = getPathnameFromAbsolutePath(this.resolvedPagePath)\n-\n             const tracer = getTracer()\n \n             // Update the root span attribute for the route.\n-            tracer.setRootSpanAttribute('next.route', route)\n+            const { pathname } = this.definition\n+            tracer.setRootSpanAttribute('next.route', pathname)\n \n             return tracer.trace(\n               AppRouteRouteHandlersSpan.runHandler,\n               {\n-                spanName: `executing api route (app) ${route}`,\n+                spanName: `executing api route (app) ${pathname}`,\n                 attributes: {\n-                  'next.route': route,\n+                  'next.route': pathname,\n                 },\n               },\n               async () =>"
        },
        {
            "sha": "8e9ccce474b49ea2dca3d458db38dba18e082f1f",
            "filename": "test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts",
            "status": "modified",
            "additions": 204,
            "deletions": 11,
            "changes": 215,
            "blob_url": "https://github.com/vercel/next.js/blob/94414f7897499bc526218d4d395ad6a1a0266e88/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94414f7897499bc526218d4d395ad6a1a0266e88/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts?ref=94414f7897499bc526218d4d395ad6a1a0266e88",
            "patch": "@@ -394,14 +394,14 @@ describe('opentelemetry', () => {\n \n             await expectTrace(getCollector(), [\n               {\n-                name: 'GET /api/app/[param]/data/route',\n+                name: 'GET /api/app/[param]/data',\n                 attributes: {\n                   'http.method': 'GET',\n-                  'http.route': '/api/app/[param]/data/route',\n+                  'http.route': '/api/app/[param]/data',\n                   'http.status_code': 200,\n                   'http.target': '/api/app/param/data',\n-                  'next.route': '/api/app/[param]/data/route',\n-                  'next.span_name': 'GET /api/app/[param]/data/route',\n+                  'next.route': '/api/app/[param]/data',\n+                  'next.span_name': 'GET /api/app/[param]/data',\n                   'next.span_type': 'BaseServer.handleRequest',\n                 },\n                 kind: 1,\n@@ -410,11 +410,11 @@ describe('opentelemetry', () => {\n                 parentId: env.span.rootParentId,\n                 spans: [\n                   {\n-                    name: 'executing api route (app) /api/app/[param]/data/route',\n+                    name: 'executing api route (app) /api/app/[param]/data',\n                     attributes: {\n-                      'next.route': '/api/app/[param]/data/route',\n+                      'next.route': '/api/app/[param]/data',\n                       'next.span_name':\n-                        'executing api route (app) /api/app/[param]/data/route',\n+                        'executing api route (app) /api/app/[param]/data',\n                       'next.span_type': 'AppRouteRouteHandlers.runHandler',\n                     },\n                     kind: 0,\n@@ -452,11 +452,11 @@ describe('opentelemetry', () => {\n                 runtime: 'edge',\n                 traceId: env.span.traceId,\n                 parentId: env.span.rootParentId,\n-                name: 'executing api route (app) /api/app/[param]/data/edge/route',\n+                name: 'executing api route (app) /api/app/[param]/data/edge',\n                 attributes: {\n-                  'next.route': '/api/app/[param]/data/edge/route',\n+                  'next.route': '/api/app/[param]/data/edge',\n                   'next.span_name':\n-                    'executing api route (app) /api/app/[param]/data/edge/route',\n+                    'executing api route (app) /api/app/[param]/data/edge',\n                   'next.span_type': 'AppRouteRouteHandlers.runHandler',\n                 },\n                 kind: 0,\n@@ -856,6 +856,192 @@ describe('opentelemetry', () => {\n             ])\n           })\n \n+          it('should handle getServerSideProps exceptions', async () => {\n+            await next.fetch(\n+              '/pages/param/getServerSidePropsError',\n+              env.fetchInit\n+            )\n+\n+            await expectTrace(getCollector(), [\n+              {\n+                name: 'GET /pages/[param]/getServerSidePropsError',\n+                attributes: {\n+                  'http.method': 'GET',\n+                  'http.route': '/pages/[param]/getServerSidePropsError',\n+                  'http.status_code': 500,\n+                  'http.target': '/pages/param/getServerSidePropsError',\n+                  'next.route': '/pages/[param]/getServerSidePropsError',\n+                  'next.span_name':\n+                    'GET /pages/[param]/getServerSidePropsError',\n+                  'next.span_type': 'BaseServer.handleRequest',\n+                  'error.type': '500',\n+                },\n+                kind: 1,\n+                status: { code: 2 },\n+                traceId: env.span.traceId,\n+                parentId: env.span.rootParentId,\n+                spans: [\n+                  {\n+                    name: 'getServerSideProps /pages/[param]/getServerSidePropsError',\n+                    attributes: {\n+                      'next.route': '/pages/[param]/getServerSidePropsError',\n+                      'next.span_name':\n+                        'getServerSideProps /pages/[param]/getServerSidePropsError',\n+                      'next.span_type': 'Render.getServerSideProps',\n+                      'error.type': 'Error',\n+                    },\n+                    kind: 0,\n+                    status: {\n+                      code: 2,\n+                      message: 'ServerSideProps error',\n+                    },\n+                    events: [\n+                      {\n+                        name: 'exception',\n+                        attributes: {\n+                          'exception.type': 'Error',\n+                          'exception.message': 'ServerSideProps error',\n+                        },\n+                      },\n+                    ],\n+                  },\n+                  {\n+                    name: 'render route (pages) /_error',\n+                    attributes: {\n+                      'next.route': '/_error',\n+                      'next.span_name': 'render route (pages) /_error',\n+                      'next.span_type': 'Render.renderDocument',\n+                    },\n+                    kind: 0,\n+                    status: { code: 0 },\n+                  },\n+                  {\n+                    name: 'resolve page components',\n+                    attributes: {\n+                      'next.route': '/_error',\n+                      'next.span_name': 'resolve page components',\n+                      'next.span_type': 'NextNodeServer.findPageComponents',\n+                    },\n+                    kind: 0,\n+                    status: { code: 0 },\n+                  },\n+                  ...(isNextDev\n+                    ? []\n+                    : [\n+                        {\n+                          name: 'resolve page components',\n+                          attributes: {\n+                            'next.route': '/500',\n+                            'next.span_name': 'resolve page components',\n+                            'next.span_type':\n+                              'NextNodeServer.findPageComponents',\n+                          },\n+                          kind: 0,\n+                          status: { code: 0 },\n+                        },\n+                        {\n+                          name: 'resolve page components',\n+                          attributes: {\n+                            'next.route': '/500',\n+                            'next.span_name': 'resolve page components',\n+                            'next.span_type':\n+                              'NextNodeServer.findPageComponents',\n+                          },\n+                          kind: 0,\n+                          status: { code: 0 },\n+                        },\n+                      ]),\n+                  {\n+                    name: 'resolve page components',\n+                    attributes: {\n+                      'next.route': '/pages/[param]/getServerSidePropsError',\n+                      'next.span_name': 'resolve page components',\n+                      'next.span_type': 'NextNodeServer.findPageComponents',\n+                    },\n+                    kind: 0,\n+                    status: { code: 0 },\n+                  },\n+                ],\n+              },\n+            ])\n+          })\n+\n+          it('should handle getServerSideProps returning notFound', async () => {\n+            await next.fetch(\n+              '/pages/param/getServerSidePropsNotFound',\n+              env.fetchInit\n+            )\n+\n+            await expectTrace(getCollector(), [\n+              {\n+                name: 'GET /pages/[param]/getServerSidePropsNotFound',\n+                attributes: {\n+                  'http.method': 'GET',\n+                  'http.route': '/pages/[param]/getServerSidePropsNotFound',\n+                  'http.status_code': 404,\n+                  'http.target': '/pages/param/getServerSidePropsNotFound',\n+                  'next.route': '/pages/[param]/getServerSidePropsNotFound',\n+                  'next.span_name':\n+                    'GET /pages/[param]/getServerSidePropsNotFound',\n+                  'next.span_type': 'BaseServer.handleRequest',\n+                },\n+                kind: 1,\n+                status: { code: 0 },\n+                traceId: env.span.traceId,\n+                parentId: env.span.rootParentId,\n+                spans: [\n+                  {\n+                    name: 'getServerSideProps /pages/[param]/getServerSidePropsNotFound',\n+                    attributes: {\n+                      'next.route': '/pages/[param]/getServerSidePropsNotFound',\n+                      'next.span_name':\n+                        'getServerSideProps /pages/[param]/getServerSidePropsNotFound',\n+                      'next.span_type': 'Render.getServerSideProps',\n+                    },\n+                    kind: 0,\n+                    status: {\n+                      code: 0,\n+                    },\n+                  },\n+                  ...(isNextDev\n+                    ? [\n+                        {\n+                          name: 'render route (app) /_not-found',\n+                          attributes: {\n+                            'next.route': '/_not-found',\n+                            'next.span_name': 'render route (app) /_not-found',\n+                            'next.span_type': 'AppRender.getBodyResult',\n+                          },\n+                          kind: 0,\n+                          status: { code: 0 },\n+                        },\n+                      ]\n+                    : []),\n+                  {\n+                    name: 'resolve page components',\n+                    attributes: {\n+                      'next.route': '/_not-found',\n+                      'next.span_name': 'resolve page components',\n+                      'next.span_type': 'NextNodeServer.findPageComponents',\n+                    },\n+                    kind: 0,\n+                    status: { code: 0 },\n+                  },\n+                  {\n+                    name: 'resolve page components',\n+                    attributes: {\n+                      'next.route': '/pages/[param]/getServerSidePropsNotFound',\n+                      'next.span_name': 'resolve page components',\n+                      'next.span_type': 'NextNodeServer.findPageComponents',\n+                    },\n+                    kind: 0,\n+                    status: { code: 0 },\n+                  },\n+                ],\n+              },\n+            ])\n+          })\n+\n           it('should handle api routes in pages', async () => {\n             await next.fetch('/api/pages/param/basic', env.fetchInit)\n \n@@ -1061,10 +1247,17 @@ async function expectTrace(collector: Collector, match: SpanMatch[]) {\n         if (nameDiff !== 0) {\n           return nameDiff\n         }\n-        return (\n+        const segmentDiff =\n           (a.attributes?.['next.segment'] ?? '').localeCompare(\n             b.attributes?.['next.segment'] ?? ''\n           ) ?? 0\n+        if (segmentDiff !== 0) {\n+          return segmentDiff\n+        }\n+        return (\n+          (a.attributes?.['next.route'] ?? '').localeCompare(\n+            b.attributes?.['next.route'] ?? ''\n+          ) ?? 0\n         )\n       })\n     }"
        },
        {
            "sha": "7a89e6db4d559a064d3dc99c6b6c1539d3894980",
            "filename": "test/e2e/opentelemetry/instrumentation/pages/pages/[param]/getServerSidePropsError.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/94414f7897499bc526218d4d395ad6a1a0266e88/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fpages%2Fpages%2F%5Bparam%5D%2FgetServerSidePropsError.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/94414f7897499bc526218d4d395ad6a1a0266e88/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fpages%2Fpages%2F%5Bparam%5D%2FgetServerSidePropsError.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fpages%2Fpages%2F%5Bparam%5D%2FgetServerSidePropsError.tsx?ref=94414f7897499bc526218d4d395ad6a1a0266e88",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Page() {\n+  return <div>Page</div>\n+}\n+\n+export function getServerSideProps() {\n+  throw new Error('ServerSideProps error')\n+}"
        },
        {
            "sha": "a6d521d8f69698af710c96accc1c32fc27c26857",
            "filename": "test/e2e/opentelemetry/instrumentation/pages/pages/[param]/getServerSidePropsNotFound.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/94414f7897499bc526218d4d395ad6a1a0266e88/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fpages%2Fpages%2F%5Bparam%5D%2FgetServerSidePropsNotFound.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/94414f7897499bc526218d4d395ad6a1a0266e88/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fpages%2Fpages%2F%5Bparam%5D%2FgetServerSidePropsNotFound.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fpages%2Fpages%2F%5Bparam%5D%2FgetServerSidePropsNotFound.tsx?ref=94414f7897499bc526218d4d395ad6a1a0266e88",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Page() {\n+  return <div>Page</div>\n+}\n+\n+export function getServerSideProps() {\n+  return { notFound: true }\n+}"
        }
    ],
    "stats": {
        "total": 242,
        "additions": 223,
        "deletions": 19
    }
}