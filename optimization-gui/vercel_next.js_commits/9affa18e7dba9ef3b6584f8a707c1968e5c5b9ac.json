{
    "author": "gnoff",
    "message": "[dynamicIO] Avoid memory leak warning for hanging promises (#77480)\n\nNode.js tries to help you avoid memory leaks by detecting when a lot of\nevent listeners are set for a single AbortSignal. Next.js uses abort\nsignal listeners to do cleanup on hanging promises and so this usage is\nnot a memory leak however to avoid creating concern amongst users we\nneed to work around the listener count limit. This is unfortunate b/c it\nis otherwise useless code to add but our alternative is to turn off this\nleak detection or raise the limit significantly, neither of which are\ngreat options since there may be other uses where this protection is\nuseful to our users.\n\nIn this change I implement the abort listening by a delegated event\nlistener",
    "sha": "9affa18e7dba9ef3b6584f8a707c1968e5c5b9ac",
    "files": [
        {
            "sha": "5f76fa1a51dfe363ebca8197f0106a89e575a3e9",
            "filename": "packages/next/src/server/dynamic-rendering-utils.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 14,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/9affa18e7dba9ef3b6584f8a707c1968e5c5b9ac/packages%2Fnext%2Fsrc%2Fserver%2Fdynamic-rendering-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9affa18e7dba9ef3b6584f8a707c1968e5c5b9ac/packages%2Fnext%2Fsrc%2Fserver%2Fdynamic-rendering-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdynamic-rendering-utils.ts?ref=9affa18e7dba9ef3b6584f8a707c1968e5c5b9ac",
            "patch": "@@ -20,6 +20,9 @@ class HangingPromiseRejectionError extends Error {\n   }\n }\n \n+type AbortListeners = Array<(err: unknown) => void>\n+const abortListenersBySignal = new WeakMap<AbortSignal, AbortListeners>()\n+\n /**\n  * This function constructs a promise that will never resolve. This is primarily\n  * useful for dynamicIO where we use promise resolution timing to determine which\n@@ -31,20 +34,37 @@ export function makeHangingPromise<T>(\n   signal: AbortSignal,\n   expression: string\n ): Promise<T> {\n-  const hangingPromise = new Promise<T>((_, reject) => {\n-    signal.addEventListener(\n-      'abort',\n-      () => {\n-        reject(new HangingPromiseRejectionError(expression))\n-      },\n-      { once: true }\n-    )\n-  })\n-  // We are fine if no one actually awaits this promise. We shouldn't consider this an unhandled rejection so\n-  // we attach a noop catch handler here to suppress this warning. If you actually await somewhere or construct\n-  // your own promise out of it you'll need to ensure you handle the error when it rejects.\n-  hangingPromise.catch(ignoreReject)\n-  return hangingPromise\n+  if (signal.aborted) {\n+    return Promise.reject(new HangingPromiseRejectionError(expression))\n+  } else {\n+    const hangingPromise = new Promise<T>((_, reject) => {\n+      const boundRejection = reject.bind(\n+        null,\n+        new HangingPromiseRejectionError(expression)\n+      )\n+      let currentListeners = abortListenersBySignal.get(signal)\n+      if (currentListeners) {\n+        currentListeners.push(boundRejection)\n+      } else {\n+        const listeners = [boundRejection]\n+        abortListenersBySignal.set(signal, listeners)\n+        signal.addEventListener(\n+          'abort',\n+          () => {\n+            for (let i = 0; i < listeners.length; i++) {\n+              listeners[i]()\n+            }\n+          },\n+          { once: true }\n+        )\n+      }\n+    })\n+    // We are fine if no one actually awaits this promise. We shouldn't consider this an unhandled rejection so\n+    // we attach a noop catch handler here to suppress this warning. If you actually await somewhere or construct\n+    // your own promise out of it you'll need to ensure you handle the error when it rejects.\n+    hangingPromise.catch(ignoreReject)\n+    return hangingPromise\n+  }\n }\n \n function ignoreReject() {}"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 34,
        "deletions": 14
    }
}