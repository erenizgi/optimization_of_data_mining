{
    "author": "lubieowoce",
    "message": "fix: broken deploy test from #77898 (#78692)\n\ni messed up a deployment test thing in\nhttps://github.com/vercel/next.js/pull/77898, had the fix locally but\nforgot to push before merging. the test tries to wait for some initial\nstuff to happen stuff after the deployment finishes, but we should only\nto do that once, it won't work in the second test of the `it.each`, so\nthe test fails.",
    "sha": "9fe8a0c7502f9535eb9758fb554e73a53dfed9ca",
    "files": [
        {
            "sha": "4261e5f2eead8d592441764e5101dbaa0d879ad0",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 22,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/9fe8a0c7502f9535eb9758fb554e73a53dfed9ca/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9fe8a0c7502f9535eb9758fb554e73a53dfed9ca/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=9fe8a0c7502f9535eb9758fb554e73a53dfed9ca",
            "patch": "@@ -740,12 +740,33 @@ describe('use-cache', () => {\n     expect(text).toBe('This page could not be found.')\n   })\n \n-  it.each([\n-    { description: 'js enabled', disableJavaScript: false },\n-    { description: 'js disabled', disableJavaScript: true },\n-  ])(\n-    'should not read nor write cached data when draft mode is enabled: $description',\n-    async ({ disableJavaScript }) => {\n+  describe('should not read nor write cached data when draft mode is enabled', () => {\n+    if (isNextDeploy) {\n+      // Wait for the background revalidation after the deployment to settle.\n+      beforeAll(async () => {\n+        const browser = await next.browser('/draft-mode')\n+        try {\n+          const initialTopLevelValue = await browser\n+            .elementById('top-level')\n+            .text()\n+          await retry(async () => {\n+            await browser.refresh()\n+\n+            expect(await browser.elementById('top-level').text()).not.toBe(\n+              initialTopLevelValue\n+            )\n+          })\n+        } finally {\n+          // we're not in a test, so the browser won't get cleaned up automatically.\n+          await browser.close()\n+        }\n+      })\n+    }\n+\n+    it.each([\n+      { description: 'js enabled', disableJavaScript: false },\n+      { description: 'js disabled', disableJavaScript: true },\n+    ])('$description', async ({ disableJavaScript }) => {\n       const browser = await next.browser('/draft-mode', {\n         // This test relies on a server action to set draft mode.\n         // To ensure that it works for both fetch actions and MPA actions,\n@@ -769,20 +790,7 @@ describe('use-cache', () => {\n         'Enable Draft Mode'\n       )\n \n-      let initialTopLevelValue = await browser.elementById('top-level').text()\n-\n-      if (isNextDeploy) {\n-        await retry(async () => {\n-          // Wait for the background revalidation after the deployment to settle.\n-          await browser.refresh()\n-\n-          expect(await browser.elementById('top-level').text()).not.toBe(\n-            initialTopLevelValue\n-          )\n-        })\n-\n-        initialTopLevelValue = await browser.elementById('top-level').text()\n-      }\n+      const initialTopLevelValue = await browser.elementById('top-level').text()\n \n       // Draft mode is disabled, cached data should be returned on refresh.\n \n@@ -853,8 +861,8 @@ describe('use-cache', () => {\n       expect(await browser.elementById('closure').text()).toBe(\n         initialClosureValue\n       )\n-    }\n-  )\n+    })\n+  })\n \n   if (isNextDev) {\n     it('should not have unhandled rejection of Request data promises when use cache is enabled without dynamicIO', async () => {"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 30,
        "deletions": 22
    }
}