{
    "author": "eps1lon",
    "message": "[node-webstreams] Remove unused PagesApi matching condition when setting react-server (#81037)\n\nThis looked like we were using `react-server` for Pages Router API routes. That wouldn't match Webpack behavior. We have an existing test in `test/e2e/import-conditions/import-conditions.test.ts` that checks the used import conditions in Pages Router API rotues.\r\n\r\nProbably just an oversight when Turbopack started using `react-server` for Middleware and Instrumentation: https://github.com/vercel/next.js/pull/62134/files#diff-611c2f629b9a4c9ccb2fa2f6def7b7bbe8cde6fec2b5e085c3132250f7819803R164-R171\r\n\r\nThe aliasing implementation is now more closer structured to its Webpack counterpart in `packages/next/src/build/create-compiler-aliases.ts`.\r\n\r\nI plan to move them closer together in a follow-up so that future alias work is easier to port between Webpack and Turbopack.",
    "sha": "3c274b743e6e833b3c3568e5b479efd418d56d62",
    "files": [
        {
            "sha": "1636186b8609061d76589b07a33a3f953069d3fc",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 27,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/3c274b743e6e833b3c3568e5b479efd418d56d62/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3c274b743e6e833b3c3568e5b479efd418d56d62/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=3c274b743e6e833b3c3568e5b479efd418d56d62",
            "patch": "@@ -777,9 +777,8 @@ async fn rsc_aliases(\n     });\n \n     if runtime == NextRuntime::NodeJs {\n-        match ty {\n-            ServerContextType::AppSSR { .. } => {\n-                alias.extend(fxindexmap! {\n+        if matches!(ty, ServerContextType::AppSSR { .. }) {\n+            alias.extend(fxindexmap! {\n                     \"react/jsx-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-jsx-runtime\"),\n                     \"react/jsx-dev-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-jsx-dev-runtime\"),\n                     \"react/compiler-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-compiler-runtime\"),\n@@ -788,30 +787,24 @@ async fn rsc_aliases(\n                     \"react-server-dom-webpack/client.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-server-dom-turbopack-client-edge\"),\n                     \"react-server-dom-turbopack/client.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-server-dom-turbopack-client-edge\"),\n                 });\n-            }\n-            ServerContextType::AppRSC { .. }\n-            | ServerContextType::AppRoute { .. }\n-            | ServerContextType::Middleware { .. }\n-            | ServerContextType::Instrumentation { .. } => {\n-                alias.extend(fxindexmap! {\n-                    \"react/jsx-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-runtime\"),\n-                    \"react/jsx-dev-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime\"),\n-                    \"react/compiler-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-compiler-runtime\"),\n-                    \"react\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react\"),\n-                    \"react-dom\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-dom\"),\n-                    \"react-server-dom-webpack/server.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-edge\"),\n-                    \"react-server-dom-webpack/server.node\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-node\"),\n-                    \"react-server-dom-webpack/static.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-static-edge\"),\n-                    \"react-server-dom-turbopack/server.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-edge\"),\n-                    \"react-server-dom-turbopack/server.node\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-node\"),\n-                    \"react-server-dom-turbopack/static.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-static-edge\"),\n-                    \"next/navigation\" => format!(\"next/dist/api/navigation.react-server\"),\n-\n-                    // Needed to make `react-dom/server` work.\n-                    \"next/dist/compiled/react\" => format!(\"next/dist/compiled/react/index.js\"),\n-                });\n-            }\n-            _ => {}\n+        } else if ty.supports_react_server() {\n+            alias.extend(fxindexmap! {\n+                \"react/jsx-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-runtime\"),\n+                \"react/jsx-dev-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime\"),\n+                \"react/compiler-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-compiler-runtime\"),\n+                \"react\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react\"),\n+                \"react-dom\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-dom\"),\n+                \"react-server-dom-webpack/server.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-edge\"),\n+                \"react-server-dom-webpack/server.node\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-node\"),\n+                \"react-server-dom-webpack/static.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-static-edge\"),\n+                \"react-server-dom-turbopack/server.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-edge\"),\n+                \"react-server-dom-turbopack/server.node\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-node\"),\n+                \"react-server-dom-turbopack/static.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-static-edge\"),\n+                \"next/navigation\" => format!(\"next/dist/api/navigation.react-server\"),\n+\n+                // Needed to make `react-dom/server` work.\n+                \"next/dist/compiled/react\" => format!(\"next/dist/compiled/react/index.js\"),\n+            });\n         }\n     }\n "
        },
        {
            "sha": "89a7e3c293914896372760cb3f72288234fde09a",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3c274b743e6e833b3c3568e5b479efd418d56d62/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3c274b743e6e833b3c3568e5b479efd418d56d62/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=3c274b743e6e833b3c3568e5b479efd418d56d62",
            "patch": "@@ -118,7 +118,6 @@ impl ServerContextType {\n             self,\n             ServerContextType::AppRSC { .. }\n                 | ServerContextType::AppRoute { .. }\n-                | ServerContextType::PagesApi { .. }\n                 | ServerContextType::Middleware { .. }\n                 | ServerContextType::Instrumentation { .. }\n         )"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 20,
        "deletions": 28
    }
}