{
    "author": "huozhi",
    "message": "fix: static not-found missing in prerender manifest (#82199)",
    "sha": "686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5",
    "files": [
        {
            "sha": "53ab14ff2ba314b4a57c2dcb78fe15f77af86f84",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 9,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5",
            "patch": "@@ -76,8 +76,8 @@ import {\n   MIDDLEWARE_REACT_LOADABLE_MANIFEST,\n   SERVER_REFERENCE_MANIFEST,\n   FUNCTIONS_CONFIG_MANIFEST,\n-  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n   UNDERSCORE_NOT_FOUND_ROUTE,\n+  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n   DYNAMIC_CSS_MANIFEST,\n   TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST,\n } from '../shared/lib/constants'\n@@ -3090,12 +3090,6 @@ export default async function build(\n             ]\n \n             for (const prerenderedRoute of prerenderedRoutes) {\n-              // TODO: check if still needed?\n-              // Exclude the /_not-found route.\n-              if (prerenderedRoute.pathname === UNDERSCORE_NOT_FOUND_ROUTE) {\n-                continue\n-              }\n-\n               if (\n                 isRoutePPREnabled &&\n                 prerenderedRoute.fallbackRouteParams &&\n@@ -3114,7 +3108,6 @@ export default async function build(\n             // Handle all the static routes.\n             for (const route of staticPrerenderedRoutes) {\n               if (isDynamicRoute(page) && route.pathname === page) continue\n-              if (route.pathname === UNDERSCORE_NOT_FOUND_ROUTE) continue\n \n               const {\n                 metadata = {},\n@@ -3164,9 +3157,13 @@ export default async function build(\n                 }\n \n                 const meta = collectMeta(metadata)\n+                const status =\n+                  route.pathname === UNDERSCORE_NOT_FOUND_ROUTE\n+                    ? 404\n+                    : meta.status\n \n                 prerenderManifest.routes[route.pathname] = {\n-                  initialStatus: meta.status,\n+                  initialStatus: status,\n                   initialHeaders: meta.headers,\n                   renderingMode: isAppPPREnabled\n                     ? isRoutePPREnabled"
        },
        {
            "sha": "d3788dc3595dfbe783faf38570414881f2d92cba",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5",
            "patch": "@@ -763,6 +763,10 @@ async function exportAppImpl(\n   if (!options.buildExport && prerenderManifest) {\n     await Promise.all(\n       Object.keys(prerenderManifest.routes).map(async (unnormalizedRoute) => {\n+        // Skip handling /_not-found route, it will copy the 404.html file later\n+        if (unnormalizedRoute === '/_not-found') {\n+          return\n+        }\n         const { srcRoute } = prerenderManifest!.routes[unnormalizedRoute]\n         const appPageName = mapAppRouteToPage.get(srcRoute || '')\n         const pageName = appPageName || srcRoute || unnormalizedRoute"
        },
        {
            "sha": "0548ec591adca2b384e32464d1bf72657714b690",
            "filename": "test/e2e/app-dir/app-static/app-static.test.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts?ref=686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5",
            "patch": "@@ -987,6 +987,31 @@ describe('app-dir static/dynamic handling', () => {\n            \"initialRevalidateSeconds\": false,\n            \"srcRoute\": \"/\",\n          },\n+         \"/_not-found\": {\n+           \"allowHeader\": [\n+             \"host\",\n+             \"x-matched-path\",\n+             \"x-prerender-revalidate\",\n+             \"x-prerender-revalidate-if-generated\",\n+             \"x-next-revalidated-tags\",\n+             \"x-next-revalidate-tag-token\",\n+           ],\n+           \"dataRoute\": \"/_not-found.rsc\",\n+           \"experimentalBypassFor\": [\n+             {\n+               \"key\": \"next-action\",\n+               \"type\": \"header\",\n+             },\n+             {\n+               \"key\": \"content-type\",\n+               \"type\": \"header\",\n+               \"value\": \"multipart/form-data;.*\",\n+             },\n+           ],\n+           \"initialRevalidateSeconds\": false,\n+           \"initialStatus\": 404,\n+           \"srcRoute\": \"/_not-found\",\n+         },\n          \"/api/large-data\": {\n            \"allowHeader\": [\n              \"host\","
        },
        {
            "sha": "7b96136984f610f3b1bec5c4a582d988bcfb9c56",
            "filename": "test/e2e/app-dir/cache-components-dynamic-imports/cache-components-dynamic-imports.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fcache-components-dynamic-imports.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fcache-components-dynamic-imports.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fcache-components-dynamic-imports.test.ts?ref=686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5",
            "patch": "@@ -39,6 +39,7 @@ describe('async imports in cacheComponents', () => {\n \n       expect(prerenderedRoutes).toMatchInlineSnapshot(`\n        [\n+         \"/_not-found\",\n          \"/inside-render/client/async-module\",\n          \"/inside-render/client/sync-module\",\n          \"/inside-render/route-handler/async-module\","
        },
        {
            "sha": "03960b5789a84679980173cc2e605c072ea35f55",
            "filename": "test/e2e/app-dir/metadata-static-generation/metadata-static-generation.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/test%2Fe2e%2Fapp-dir%2Fmetadata-static-generation%2Fmetadata-static-generation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/test%2Fe2e%2Fapp-dir%2Fmetadata-static-generation%2Fmetadata-static-generation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-static-generation%2Fmetadata-static-generation.test.ts?ref=686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5",
            "patch": "@@ -24,6 +24,7 @@ const isPPREnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n         const staticRoutes = prerenderManifest.routes\n         expect(Object.keys(staticRoutes).sort()).toEqual([\n           '/',\n+          '/_not-found',\n           '/suspenseful/static',\n         ])\n       })"
        },
        {
            "sha": "7800c4548774d294d08b370e59a6b7298b80085f",
            "filename": "test/e2e/app-dir/metadata-streaming-static-generation/metadata-streaming-static-generation.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fmetadata-streaming-static-generation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fmetadata-streaming-static-generation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fmetadata-streaming-static-generation.test.ts?ref=686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5",
            "patch": "@@ -22,6 +22,7 @@ const isPPREnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n         const staticRoutes = prerenderManifest.routes\n         expect(Object.keys(staticRoutes).sort()).toEqual([\n           '/',\n+          '/_not-found',\n           '/slow/static',\n           '/suspenseful/static',\n         ])"
        },
        {
            "sha": "3f2ea8c44d2b87440150099131357cdcc4cc6b56",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=686ba5bd6b4ef2ca9f7059047cfb72700e3e0ef5",
            "patch": "@@ -473,6 +473,7 @@ describe('use-cache', () => {\n \n       expect(prerenderedRouteKeys).toEqual(\n         [\n+          '/_not-found',\n           // [id] route, first entry in generateStaticParams\n           expect.stringMatching(/\\/a\\d/),\n           withCacheComponents && '/api',"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 39,
        "deletions": 9
    }
}