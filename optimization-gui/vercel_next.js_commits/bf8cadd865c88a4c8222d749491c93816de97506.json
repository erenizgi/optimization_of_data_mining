{
    "author": "acdlite",
    "message": "[Segment Cache] Add refresh URL to reused default segments (#84627)\n\nWhen segment is reused in the \"default\" parallel route slot, it is not\npart of the new page. So if the page is refreshed, we must fetch its\ndata from the previous URL, not the new URL. To track this we add the\nprevious URL to a special field in the FlightRouterState.\n\nCurrently this field is added by\naddRefreshMarkerToActiveParallelSegments; this updates the\n\"ppr-navigations\" module to add it during the main traversal used by\nnavigations, so we can eventually get rid\naddRefreshMarkerToActiveParallelSegments.\n\nNote that we don't need to add the marker to _all_ page segments, just\nthe ones that are not part of the new page.",
    "sha": "bf8cadd865c88a4c8222d749491c93816de97506",
    "files": [
        {
            "sha": "b88dc0ba9ded13332a0f8558e7908b17b1d50195",
            "filename": "packages/next/src/client/components/router-reducer/ppr-navigations.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 4,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/bf8cadd865c88a4c8222d749491c93816de97506/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fppr-navigations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bf8cadd865c88a4c8222d749491c93816de97506/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fppr-navigations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fppr-navigations.ts?ref=bf8cadd865c88a4c8222d749491c93816de97506",
            "patch": "@@ -15,6 +15,7 @@ import type {\n } from '../../../shared/lib/app-router-types'\n import { DEFAULT_SEGMENT_KEY } from '../../../shared/lib/segment'\n import { matchSegment } from '../match-segments'\n+import { createHrefFromUrl } from './create-href-from-url'\n import { createRouterCacheKey } from './create-router-cache-key'\n import type { FetchServerResponseResult } from './fetch-server-response'\n import { isNavigatingToNewRootLayout } from './is-navigating-to-new-root-layout'\n@@ -91,6 +92,7 @@ export type Task = SPANavigationTask | MPANavigationTask\n // can be reused without initiating a server request.\n export function startPPRNavigation(\n   navigatedAt: number,\n+  oldUrl: URL,\n   oldCacheNode: CacheNode,\n   oldRouterState: FlightRouterState,\n   newRouterState: FlightRouterState,\n@@ -103,6 +105,7 @@ export function startPPRNavigation(\n   const segmentPath: Array<FlightSegmentPath> = []\n   return updateCacheNodeOnNavigation(\n     navigatedAt,\n+    oldUrl,\n     oldCacheNode,\n     oldRouterState,\n     newRouterState,\n@@ -118,6 +121,7 @@ export function startPPRNavigation(\n \n function updateCacheNodeOnNavigation(\n   navigatedAt: number,\n+  oldUrl: URL,\n   oldCacheNode: CacheNode,\n   oldRouterState: FlightRouterState,\n   newRouterState: FlightRouterState,\n@@ -230,7 +234,7 @@ function updateCacheNodeOnNavigation(\n         // Reuse the existing Router State for this segment. We spawn a \"task\"\n         // just to keep track of the updated router state; unlike most, it's\n         // already fulfilled and won't be affected by the dynamic response.\n-        taskChild = spawnReusedTask(oldRouterStateChild)\n+        taskChild = reuseActiveSegmentInDefaultSlot(oldUrl, oldRouterStateChild)\n       } else {\n         // There's no currently active segment. Switch to the \"create\" path.\n         taskChild = beginRenderingNewRouteTree(\n@@ -299,6 +303,7 @@ function updateCacheNodeOnNavigation(\n         // the children.\n         taskChild = updateCacheNodeOnNavigation(\n           navigatedAt,\n+          oldUrl,\n           oldCacheNodeChild,\n           oldRouterStateChild,\n           newRouterStateChild,\n@@ -726,9 +731,37 @@ function spawnPendingTask(\n   return newTask\n }\n \n-function spawnReusedTask(reusedRouterState: FlightRouterState): Task {\n-  // Create a task that reuses an existing segment, e.g. when reusing\n-  // the current active segment in place of a default route.\n+function reuseActiveSegmentInDefaultSlot(\n+  oldUrl: URL,\n+  oldRouterState: FlightRouterState\n+): Task {\n+  // This is a \"default\" segment. These are never sent by the server during a\n+  // soft navigation; instead, the client reuses whatever segment was already\n+  // active in that slot on the previous route. This means if we later need to\n+  // refresh the segment, it will have to be refetched from the previous route's\n+  // URL. We store it in the Flight Router State.\n+  //\n+  // TODO: We also mark the segment with a \"refresh\" marker but I think we can\n+  // get rid of that eventually by making sure we only add URLs to page segments\n+  // that are reused. Then the presence of the URL alone is enough.\n+  let reusedRouterState\n+\n+  const oldRefreshMarker = oldRouterState[3]\n+  if (oldRefreshMarker === 'refresh') {\n+    // This segment was already reused from an even older route. Keep its\n+    // existing URL and refresh marker.\n+    reusedRouterState = oldRouterState\n+  } else {\n+    // This segment was not previously reused, and it's not on the new route.\n+    // So it must have been delivered in the old route.\n+    reusedRouterState = patchRouterStateWithNewChildren(\n+      oldRouterState,\n+      oldRouterState[1]\n+    )\n+    reusedRouterState[2] = createHrefFromUrl(oldUrl)\n+    reusedRouterState[3] = 'refresh'\n+  }\n+\n   return {\n     route: reusedRouterState,\n     node: null,"
        },
        {
            "sha": "ff6edc1e5e49736f90162ae28b262b489ad1f900",
            "filename": "packages/next/src/client/components/router-reducer/reducers/navigate-reducer.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/bf8cadd865c88a4c8222d749491c93816de97506/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bf8cadd865c88a4c8222d749491c93816de97506/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts?ref=bf8cadd865c88a4c8222d749491c93816de97506",
            "patch": "@@ -203,8 +203,10 @@ export function navigateReducer(\n     // Temporary glue code between the router reducer and the new navigation\n     // implementation. Eventually we'll rewrite the router reducer to a\n     // state machine.\n+    const currentUrl = new URL(state.canonicalUrl, location.origin)\n     const result = navigateUsingSegmentCache(\n       url,\n+      currentUrl,\n       state.cache,\n       state.tree,\n       state.nextUrl,\n@@ -267,13 +269,14 @@ export function navigateReducer(\n         return handleExternalUrl(state, mutable, flightData, pendingPush)\n       }\n \n+      const oldCanonicalUrl = state.canonicalUrl\n       const updatedCanonicalUrl = canonicalUrlOverride\n         ? createHrefFromUrl(canonicalUrlOverride)\n         : href\n \n       const onlyHashChange =\n         !!hash &&\n-        state.canonicalUrl.split('#', 1)[0] ===\n+        oldCanonicalUrl.split('#', 1)[0] ===\n           updatedCanonicalUrl.split('#', 1)[0]\n \n       // If only the hash has changed, the server hasn't sent us any new data. We can just update\n@@ -339,6 +342,7 @@ export function navigateReducer(\n           ) {\n             const task = startPPRNavigation(\n               navigatedAt,\n+              new URL(oldCanonicalUrl, url.origin),\n               currentCache,\n               currentTree,\n               treePatch,"
        },
        {
            "sha": "9d802bdfb9b19134768d60d913dd38c4e43a90fb",
            "filename": "packages/next/src/client/components/segment-cache-impl/navigation.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/bf8cadd865c88a4c8222d749491c93816de97506/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bf8cadd865c88a4c8222d749491c93816de97506/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts?ref=bf8cadd865c88a4c8222d749491c93816de97506",
            "patch": "@@ -77,6 +77,7 @@ export type NavigationResult =\n  */\n export function navigate(\n   url: URL,\n+  currentUrl: URL,\n   currentCacheNode: CacheNode,\n   currentFlightRouterState: FlightRouterState,\n   nextUrl: string | null,\n@@ -124,6 +125,7 @@ export function navigate(\n     return navigateUsingPrefetchedRouteTree(\n       now,\n       url,\n+      currentUrl,\n       nextUrl,\n       isSamePageNavigation,\n       currentCacheNode,\n@@ -156,6 +158,7 @@ export function navigate(\n     return navigateUsingPrefetchedRouteTree(\n       now,\n       url,\n+      currentUrl,\n       nextUrl,\n       isSamePageNavigation,\n       currentCacheNode,\n@@ -176,6 +179,7 @@ export function navigate(\n     data: navigateDynamicallyWithNoPrefetch(\n       now,\n       url,\n+      currentUrl,\n       nextUrl,\n       isSamePageNavigation,\n       currentCacheNode,\n@@ -189,6 +193,7 @@ export function navigate(\n function navigateUsingPrefetchedRouteTree(\n   now: number,\n   url: URL,\n+  currentUrl: URL,\n   nextUrl: string | null,\n   isSamePageNavigation: boolean,\n   currentCacheNode: CacheNode,\n@@ -210,6 +215,7 @@ function navigateUsingPrefetchedRouteTree(\n   const scrollableSegments: Array<FlightSegmentPath> = []\n   const task = startPPRNavigation(\n     now,\n+    currentUrl,\n     currentCacheNode,\n     currentFlightRouterState,\n     prefetchFlightRouterState,\n@@ -383,6 +389,7 @@ function readRenderSnapshotFromCache(\n async function navigateDynamicallyWithNoPrefetch(\n   now: number,\n   url: URL,\n+  currentUrl: URL,\n   nextUrl: string | null,\n   isSamePageNavigation: boolean,\n   currentCacheNode: CacheNode,\n@@ -442,6 +449,7 @@ async function navigateDynamicallyWithNoPrefetch(\n   const scrollableSegments: Array<FlightSegmentPath> = []\n   const task = startPPRNavigation(\n     now,\n+    currentUrl,\n     currentCacheNode,\n     currentFlightRouterState,\n     prefetchFlightRouterState,"
        },
        {
            "sha": "c43cdcebb447f7aeb6889dfa74002b397bf2e69c",
            "filename": "test/client-segment-cache-tests-manifest.json",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/bf8cadd865c88a4c8222d749491c93816de97506/test%2Fclient-segment-cache-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/bf8cadd865c88a4c8222d749491c93816de97506/test%2Fclient-segment-cache-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fclient-segment-cache-tests-manifest.json?ref=bf8cadd865c88a4c8222d749491c93816de97506",
            "patch": "@@ -18,13 +18,6 @@\n     },\n     \"test/e2e/app-dir/parallel-routes-revalidation/parallel-routes-revalidation.test.ts\": {\n       \"failed\": [\n-        \"parallel-routes-revalidation router.refresh (dynamic) - searchParams: false should correctly refresh data for previously intercepted modal and active page slot\",\n-        \"parallel-routes-revalidation router.refresh (dynamic) - searchParams: true should correctly refresh data for previously intercepted modal and active page slot\",\n-        \"parallel-routes-revalidation router.refresh (dynamic) - searchParams: true should correctly refresh data for the intercepted route and previously active page slot\",\n-        \"parallel-routes-revalidation router.refresh (regular) - searchParams: false should correctly refresh data for previously intercepted modal and active page slot\",\n-        \"parallel-routes-revalidation router.refresh (regular) - searchParams: true should correctly refresh data for previously intercepted modal and active page slot\",\n-        \"parallel-routes-revalidation router.refresh (regular) - searchParams: true should correctly refresh data for the intercepted route and previously active page slot\",\n-        \"parallel-routes-revalidation server action revalidation handles refreshing when multiple parallel slots are active\",\n         \"parallel-routes-revalidation server action revalidation should not trigger a refresh for the page that is being redirected to\"\n       ]\n     },"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 50,
        "deletions": 12
    }
}