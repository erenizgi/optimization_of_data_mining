{
    "author": "bgw",
    "message": "Turbopack: Lower the IO concurrency limit in CI tests (#84508)\n\n@lukesandberg pointed out that we have test flakes from too many file descriptors open.\n\nI think we should significantly raise these limits on the ci runners (@ijjk?), but given that we run 8 tests in parallel, it's probably good anyways for Turbopack to be less aggressive with file IO in our CI.",
    "sha": "844f0a62430dd697f4757d2f5eeef75da81f6e81",
    "files": [
        {
            "sha": "8c65fc3ba7ab55e71594316c51dcb9be0dc560ff",
            "filename": ".github/workflows/build_reusable.yml",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/844f0a62430dd697f4757d2f5eeef75da81f6e81/.github%2Fworkflows%2Fbuild_reusable.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/844f0a62430dd697f4757d2f5eeef75da81f6e81/.github%2Fworkflows%2Fbuild_reusable.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_reusable.yml?ref=844f0a62430dd697f4757d2f5eeef75da81f6e81",
            "patch": "@@ -110,6 +110,9 @@ env:\n   NEXT_CI_RUNNER: ${{ inputs.runs_on_labels }}\n   NEXT_TEST_PROXY_ADDRESS: ${{ inputs.overrideProxyAddress || '' }}\n \n+  # defaults to 256, but we run a lot of tests in parallel, so the limit should be lower\n+  NEXT_TURBOPACK_IO_CONCURRENCY: 64\n+\n jobs:\n   build:\n     timeout-minutes: ${{ inputs.timeout_minutes }}"
        },
        {
            "sha": "080af9eb7eb793d11dcf028a415a33dfcbdbfffc",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/844f0a62430dd697f4757d2f5eeef75da81f6e81/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/844f0a62430dd697f4757d2f5eeef75da81f6e81/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=844f0a62430dd697f4757d2f5eeef75da81f6e81",
            "patch": "@@ -31,6 +31,7 @@ mod watcher;\n use std::{\n     borrow::Cow,\n     cmp::{Ordering, min},\n+    env,\n     fmt::{self, Debug, Display, Formatter},\n     fs::FileType,\n     future::Future,\n@@ -193,7 +194,20 @@ where\n }\n \n fn create_semaphore() -> tokio::sync::Semaphore {\n-    tokio::sync::Semaphore::new(256)\n+    // the semaphore isn't serialized, and we assume the environment variable doesn't change during\n+    // runtime, so it's okay to access it in this untracked way.\n+    static NEXT_TURBOPACK_IO_CONCURRENCY: LazyLock<usize> = LazyLock::new(|| {\n+        env::var(\"NEXT_TURBOPACK_IO_CONCURRENCY\")\n+            .ok()\n+            .filter(|val| !val.is_empty())\n+            .map(|val| {\n+                val.parse()\n+                    .expect(\"NEXT_TURBOPACK_IO_CONCURRENCY must be a valid integer\")\n+            })\n+            .filter(|val| *val != 0)\n+            .unwrap_or(256)\n+    });\n+    tokio::sync::Semaphore::new(*NEXT_TURBOPACK_IO_CONCURRENCY)\n }\n \n #[turbo_tasks::value_trait]"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 18,
        "deletions": 1
    }
}