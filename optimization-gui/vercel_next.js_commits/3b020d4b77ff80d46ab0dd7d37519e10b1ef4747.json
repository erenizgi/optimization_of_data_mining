{
    "author": "mischnic",
    "message": "Turbopack: normalize ref type for external tracing (#78226)\n\nFixes duplicate `CachedExternalModule`s, due to different result depending on the reference type:\n\nAs opposed to adding the whole reference type to the external's `AssetIdent`, normalize the reference type, tracing an external with `EcmaScriptModules(ImportPart(Evaluation))` (which returns nothing for side-effect-free packages) is strange anyway.\n\n```\nrequest: \"@emotion/react\"\nreference_type: EcmaScriptModules(ImportPart(Evaluation))\ntracing_resolve_result: [] \ntracing_resolve_affecting: [\"[project]/node_modules/.pnpm/@emotion+react@11.11.1_@types+react@19.1.1_react@19.2.0-canary-1d6c8168-20250411/node_modules/@emotion/react/package.json\", \"[project]/node_modules/@emotion/react\"]\n```\n\n```\nrequest: \"@emotion/react\"\nreference_type: EcmaScriptModules(ImportPart(Export(\"CacheProvider\")))\ntracing_resolve_result: [\"[project]/node_modules/.pnpm/@emotion+react@11.11.1_@types+react@19.1.1_react@19.2.0-canary-1d6c8168-20250411/node_modules/@emotion/react/dist/emotion-react.cjs.mjs [externals-tracing] (ecmascript)\"]\ntracing_resolve_affecting: [\"[project]/node_modules/.pnpm/@emotion+react@11.11.1_@types+react@19.1.1_react@19.2.0-canary-1d6c8168-20250411/node_modules/@emotion/react/package.json\", \"[project]/node_modules/@emotion/react\"]\n```",
    "sha": "3b020d4b77ff80d46ab0dd7d37519e10b1ef4747",
    "files": [
        {
            "sha": "dd5fe4e5e53e0a7e83592591e25cd4ffbaf21e8c",
            "filename": "turbopack/crates/turbopack-core/src/reference_type.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/3b020d4b77ff80d46ab0dd7d37519e10b1ef4747/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3b020d4b77ff80d46ab0dd7d37519e10b1ef4747/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs?ref=3b020d4b77ff80d46ab0dd7d37519e10b1ef4747",
            "patch": "@@ -28,9 +28,10 @@ impl InnerAssets {\n // behavior.\n \n #[turbo_tasks::value(serialization = \"auto_for_input\")]\n-#[derive(Debug, Clone, Hash)]\n+#[derive(Debug, Default, Clone, Hash)]\n pub enum CommonJsReferenceSubType {\n     Custom(u8),\n+    #[default]\n     Undefined,\n }\n \n@@ -170,7 +171,7 @@ impl ImportContext {\n }\n \n #[turbo_tasks::value(serialization = \"auto_for_input\")]\n-#[derive(Debug, Clone, Hash)]\n+#[derive(Debug, Default, Clone, Hash)]\n pub enum CssReferenceSubType {\n     AtImport(Option<ResolvedVc<ImportContext>>),\n     /// Reference from ModuleCssAsset to an imported ModuleCssAsset for retrieving the composed\n@@ -181,15 +182,17 @@ pub enum CssReferenceSubType {\n     /// Used for generating the list of classes in a ModuleCssAsset\n     Analyze,\n     Custom(u8),\n+    #[default]\n     Undefined,\n }\n \n #[turbo_tasks::value(serialization = \"auto_for_input\")]\n-#[derive(Debug, Clone, Hash)]\n+#[derive(Debug, Default, Clone, Hash)]\n pub enum UrlReferenceSubType {\n     EcmaScriptNewUrl,\n     CssUrl,\n     Custom(u8),\n+    #[default]\n     Undefined,\n }\n \n@@ -229,7 +232,7 @@ pub enum EntryReferenceSubType {\n }\n \n #[turbo_tasks::value(serialization = \"auto_for_input\")]\n-#[derive(Debug, Clone, Hash)]\n+#[derive(Debug, Default, Clone, Hash)]\n pub enum ReferenceType {\n     CommonJs(CommonJsReferenceSubType),\n     EcmaScriptModules(EcmaScriptModulesReferenceSubType),\n@@ -241,6 +244,7 @@ pub enum ReferenceType {\n     Runtime,\n     Internal(ResolvedVc<InnerAssets>),\n     Custom(u8),\n+    #[default]\n     Undefined,\n }\n "
        },
        {
            "sha": "022f3e15cdb298f610c71e349dcb1929bef0b8ba",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/3b020d4b77ff80d46ab0dd7d37519e10b1ef4747/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3b020d4b77ff80d46ab0dd7d37519e10b1ef4747/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=3b020d4b77ff80d46ab0dd7d37519e10b1ef4747",
            "patch": "@@ -799,6 +799,27 @@ impl AssetContext for ModuleAssetContext {\n                                     let externals_context = externals_tracing_module_context(ty);\n                                     let root_origin = tracing_root.join(\"_\".into());\n \n+                                    // Normalize reference type, there is no such thing as a\n+                                    // `ReferenceType::EcmaScriptModules(ImportPart(Evaluation))`\n+                                    // for externals (and otherwise, this causes duplicate\n+                                    // CachedExternalModules for both `ImportPart(Evaluation)` and\n+                                    // `ImportPart(Export(\"CacheProvider\"))`)\n+                                    let reference_type = Value::new(match &*reference_type {\n+                                        ReferenceType::EcmaScriptModules(_) => {\n+                                            ReferenceType::EcmaScriptModules(Default::default())\n+                                        }\n+                                        ReferenceType::CommonJs(_) => {\n+                                            ReferenceType::CommonJs(Default::default())\n+                                        }\n+                                        ReferenceType::Css(_) => {\n+                                            ReferenceType::Css(Default::default())\n+                                        }\n+                                        ReferenceType::Url(_) => {\n+                                            ReferenceType::Url(Default::default())\n+                                        }\n+                                        _ => ReferenceType::Undefined,\n+                                    });\n+\n                                     let external_result = externals_context\n                                         .resolve_asset(\n                                             root_origin,\n@@ -822,6 +843,7 @@ impl AssetContext for ModuleAssetContext {\n                                         );\n \n                                     modules\n+                                        .into_iter()\n                                         .map(|s| {\n                                             Vc::upcast::<Box<dyn ModuleReference>>(\n                                                 TracedModuleReference::new(s),"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 30,
        "deletions": 4
    }
}