{
    "author": "mischnic",
    "message": "[test] app-basepath less agressive request reading (#86740)\n\nHopefully helps with this\n```\n  ● app dir - basepath › should properly stream an internal server action redirect() with a relative URL\n\n    request.allHeaders: Target page, context or browser has been closed\n\n      77 |         beforePageLoad(page) {\n      78 |           page.on('request', (request) => {\n    > 79 |             return request.allHeaders().then((headers) => {\n         |                            ^\n      80 |               if (\n      81 |                 headers['rsc'] === '1' &&\n      82 |                 // Prefetches also include `rsc`\n\n      at Page.allHeaders (e2e/app-dir/app-basepath/index.test.ts:79:28)\n```",
    "sha": "ebc435d887264ee8bc17cc9a8628405d168b0fe5",
    "files": [
        {
            "sha": "e272695bb49a3a731af73126f95a598b3977a605",
            "filename": "test/e2e/app-dir/app-basepath/index.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc435d887264ee8bc17cc9a8628405d168b0fe5/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc435d887264ee8bc17cc9a8628405d168b0fe5/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts?ref=ebc435d887264ee8bc17cc9a8628405d168b0fe5",
            "patch": "@@ -75,16 +75,29 @@ describe('app dir - basepath', () => {\n       let rscRequests = []\n       const browser = await next.browser(path, {\n         beforePageLoad(page) {\n-          page.on('request', (request) => {\n-            return request.allHeaders().then((headers) => {\n+          page.on('request', async (request) => {\n+            let headers: { [key: string]: string }\n+            try {\n+              headers = await request.allHeaders()\n+            } catch (e) {\n               if (\n-                headers['rsc'] === '1' &&\n-                // Prefetches also include `rsc`\n-                headers['next-router-prefetch'] !== '1'\n+                e.message.includes(\n+                  'Target page, context or browser has been closed'\n+                )\n               ) {\n-                rscRequests.push(request.url())\n+                // Ignore errors caused by closed browser during test teardown\n+                return\n               }\n-            })\n+              throw e\n+            }\n+\n+            if (\n+              headers['rsc'] === '1' &&\n+              // Prefetches also include `rsc`\n+              headers['next-router-prefetch'] !== '1'\n+            ) {\n+              rscRequests.push(request.url())\n+            }\n           })\n         },\n       })"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 20,
        "deletions": 7
    }
}