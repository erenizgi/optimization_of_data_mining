{
    "author": "wyattjoh",
    "message": "ci: optimize e2e deploy test performance and resource usage (#83058)\n\n### What?\n\nOptimize CI workflow performance by moving e2e test project reset to a\nweekly cron schedule and increasing deploy test parallelization.\n\n### Why?\n\nThe current workflow runs project reset on every deploy test execution,\nmaking parallel investigations by manual dispatch impossible.\nAdditionally, deploy tests were limited to 6 parallel groups, creating a\nbottleneck.\n\n### How?\n\n- Created new weekly cron workflow (`test_e2e_project_reset_cron.yml`)\nthat runs every Sunday at 5AM UTC\n- Removed inline project reset step from deploy test workflow\n- Increased deploy test matrix from 6 to 8 parallel groups for faster\nexecution\n- Added manual workflow dispatch option for emergency resets",
    "sha": "1a4bd7050ce9353f6d4e1b496e80df39abe19a57",
    "files": [
        {
            "sha": "863c4fd77da7b46297a59cca75fd98ad6c9c6c21",
            "filename": ".github/workflows/test_e2e_deploy_release.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/1a4bd7050ce9353f6d4e1b496e80df39abe19a57/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/1a4bd7050ce9353f6d4e1b496e80df39abe19a57/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml?ref=1a4bd7050ce9353f6d4e1b496e80df39abe19a57",
            "patch": "@@ -64,12 +64,6 @@ jobs:\n         name: Extract `next` version\n         run: echo 'value=${{ fromJson(steps.nextPackageInfo.outputs.value).version }}' >> \"$GITHUB_OUTPUT\"\n \n-      - name: Setup test project\n-        run: |\n-          pnpm install\n-          pnpm run build\n-          node scripts/run-e2e-test-project-reset.mjs\n-\n   test-deploy:\n     name: Run Deploy Tests\n     needs: setup\n@@ -78,7 +72,7 @@ jobs:\n     strategy:\n       fail-fast: false\n       matrix:\n-        group: [1/6, 2/6, 3/6, 4/6, 5/6, 6/6]\n+        group: [1/8, 2/8, 3/8, 4/8, 5/8, 6/8, 7/8, 8/8]\n     with:\n       afterBuild: npm i -g vercel@latest && NEXT_E2E_TEST_TIMEOUT=240000 NEXT_TEST_MODE=deploy NEXT_EXTERNAL_TESTS_FILTERS=\"test/deploy-tests-manifest.json\" NEXT_TEST_VERSION=\"${{ github.event.inputs.nextVersion || 'canary' }}\" VERCEL_CLI_VERSION=\"${{ github.event.inputs.vercelCliVersion || 'vercel@latest' }}\" node run-tests.js --timings -g ${{ matrix.group }} -c 2 --type e2e\n       skipNativeBuild: 'yes'"
        },
        {
            "sha": "17adc0e1c97df0aae7070f0cc8ad99db8a7b9034",
            "filename": ".github/workflows/test_e2e_project_reset_cron.yml",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/1a4bd7050ce9353f6d4e1b496e80df39abe19a57/.github%2Fworkflows%2Ftest_e2e_project_reset_cron.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/1a4bd7050ce9353f6d4e1b496e80df39abe19a57/.github%2Fworkflows%2Ftest_e2e_project_reset_cron.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Ftest_e2e_project_reset_cron.yml?ref=1a4bd7050ce9353f6d4e1b496e80df39abe19a57",
            "patch": "@@ -0,0 +1,46 @@\n+name: test-e2e-project-reset-cron\n+\n+on:\n+  # Run every Sunday at 5AM UTC\n+  schedule:\n+    - cron: '0 5 * * 0'\n+  # Allow manual triggering for emergency resets\n+  workflow_dispatch:\n+\n+env:\n+  VERCEL_TEST_TEAM: vtest314-next-e2e-tests\n+  VERCEL_TEST_TOKEN: ${{ secrets.VERCEL_TEST_TOKEN }}\n+  TURBO_TEAM: 'vercel'\n+  TURBO_CACHE: 'remote:rw'\n+  TURBO_API: ${{ secrets.HOSTED_TURBO_API }}\n+  TURBO_TOKEN: ${{ secrets.HOSTED_TURBO_TOKEN }}\n+  NODE_LTS_VERSION: 20\n+\n+run-name: test-e2e-project-reset (scheduled)\n+\n+jobs:\n+  reset-test-project:\n+    runs-on: ubuntu-latest\n+    if: github.repository_owner == 'vercel'\n+    steps:\n+      - name: Setup Node.js\n+        uses: actions/setup-node@v4\n+        with:\n+          node-version: ${{ env.NODE_LTS_VERSION }}\n+          check-latest: true\n+\n+      - name: Setup pnpm\n+        run: |\n+          npm i -g corepack@0.31\n+          corepack enable\n+\n+      - name: Checkout\n+        uses: actions/checkout@v4\n+        with:\n+          fetch-depth: 25\n+\n+      - name: Install dependencies\n+        run: pnpm install\n+\n+      - name: Reset test project\n+        run: node scripts/run-e2e-test-project-reset.mjs"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 47,
        "deletions": 7
    }
}