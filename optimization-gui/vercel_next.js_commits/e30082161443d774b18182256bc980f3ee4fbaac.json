{
    "author": "huozhi",
    "message": "[mcp] capture next config schema errors (#84832)",
    "sha": "e30082161443d774b18182256bc980f3ee4fbaac",
    "files": [
        {
            "sha": "cf09af2bc32ba54b2815a571a0dddf18f9391de5",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 5,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/e30082161443d774b18182256bc980f3ee4fbaac/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e30082161443d774b18182256bc980f3ee4fbaac/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=e30082161443d774b18182256bc980f3ee4fbaac",
            "patch": "@@ -46,6 +46,7 @@ import { interopDefault } from '../lib/interop-default'\n import { djb2Hash } from '../shared/lib/hash'\n import type { NextAdapter } from '../build/adapter/build-complete'\n import { HardDeprecatedConfigError } from '../shared/lib/errors/hard-deprecated-config-error'\n+import { NextInstanceErrorState } from './mcp/tools/next-instance-error-state'\n \n export { normalizeConfig } from './config-shared'\n export type { DomainLocale, NextConfig } from './config-shared'\n@@ -1302,16 +1303,18 @@ function getCacheKey(\n   dir: string,\n   customConfig?: object | null,\n   reactProductionProfiling?: boolean,\n-  debugPrerender?: boolean\n+  debugPrerender?: boolean,\n+  pid?: number\n ): string {\n   // The next.config.js is unique per project, so we can use the dir as the major key\n-  // to generate the unique config key.\n+  // to generate the unique config key. Include PID to invalidate on server restart.\n   const keyData = JSON.stringify({\n     dir,\n     phase,\n     hasCustomConfig: Boolean(customConfig),\n     reactProductionProfiling: Boolean(reactProductionProfiling),\n     debugPrerender: Boolean(debugPrerender),\n+    pid: pid || 0,\n   })\n \n   return djb2Hash(keyData).toString(36)\n@@ -1338,12 +1341,14 @@ export default async function loadConfig(\n   } = {}\n ): Promise<NextConfigComplete> {\n   // Generate cache key based on parameters that affect config output\n+  // Include process.pid to invalidate cache on server restart\n   const cacheKey = getCacheKey(\n     phase,\n     dir,\n     customConfig,\n     reactProductionProfiling,\n-    debugPrerender\n+    debugPrerender,\n+    process.pid\n   )\n \n   // Check if we have a cached result\n@@ -1360,6 +1365,10 @@ export default async function loadConfig(\n     }\n \n     return cachedResult.config\n+  } else {\n+    // Reset next.config errors before loading config\n+    // This happens on every config load to ensure fresh validation\n+    NextInstanceErrorState.nextConfig = []\n   }\n \n   // Original implementation continues below...\n@@ -1486,6 +1495,9 @@ export default async function loadConfig(\n         return userConfigModule\n       }\n     } catch (err) {\n+      // Capture the error for MCP tool reporting\n+      NextInstanceErrorState.nextConfig.push(err)\n+\n       // TODO: Modify docs to add cases of failing next.config.ts transformation\n       curLog.error(\n         `Failed to load ${configFileName}, see more info here https://nextjs.org/docs/messages/next-config-error`\n@@ -1527,7 +1539,18 @@ export default async function loadConfig(\n \n     // Always validate the config against schema in non minimal mode\n     if (!process.env.NEXT_MINIMAL && !silent) {\n-      validateConfigSchema(userConfig, configFileName, curLog.warn)\n+      await validateConfigSchema(\n+        userConfig,\n+        configFileName,\n+        curLog.warn,\n+        (messages) => {\n+          // Capture validation messages for MCP error reporting\n+          if (messages.length > 0) {\n+            const fullMessage = messages.join('\\n')\n+            NextInstanceErrorState.nextConfig.push(new Error(fullMessage))\n+          }\n+        }\n+      )\n     }\n \n     if ((userConfig as any).target && (userConfig as any).target !== 'server') {\n@@ -1906,7 +1929,8 @@ function cloneObject(obj: any): any {\n async function validateConfigSchema(\n   userConfig: NextConfig,\n   configFileName: string,\n-  warn: (message: string) => void\n+  warn: (message: string) => void,\n+  onValidationMessages?: (messages: string[]) => void\n ) {\n   // We only validate the config against schema in non minimal mode\n   const { configSchema } =\n@@ -1930,6 +1954,11 @@ async function validateConfigSchema(\n       'See more info here: https://nextjs.org/docs/messages/invalid-next-config'\n     )\n \n+    // Call the callback with validation messages if provided\n+    if (onValidationMessages) {\n+      onValidationMessages(messages)\n+    }\n+\n     if (shouldExit) {\n       for (const message of messages) {\n         console.error(message)"
        },
        {
            "sha": "a720a5152e2dea1182217262aaddb3a95e91af3e",
            "filename": "packages/next/src/server/mcp/tools/get-errors.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 10,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/e30082161443d774b18182256bc980f3ee4fbaac/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e30082161443d774b18182256bc980f3ee4fbaac/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts?ref=e30082161443d774b18182256bc980f3ee4fbaac",
            "patch": "@@ -1,13 +1,17 @@\n /**\n- * MCP tool for retrieving browser error state.\n+ * MCP tool for retrieving error state from Next.js dev server.\n  *\n- * This tool demonstrates server-to-browser communication in Next.js dev mode.\n- * It leverages the existing HMR infrastructure rather than creating new channels.\n+ * This tool provides comprehensive error reporting including:\n+ * - Next.js global errors (e.g., next.config validation errors)\n+ * - Browser runtime errors with source-mapped stack traces\n+ * - Build errors from webpack/turbopack compilation\n+ *\n+ * For browser errors, it leverages the HMR infrastructure for server-to-browser communication.\n  *\n  * Flow:\n  *   MCP client → server generates request ID → HMR message to browser →\n  *   browser queries error overlay state → HMR response back → server performs source mapping →\n- *   formatted output.\n+ *   combined with global errors → formatted output.\n  */\n import type { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n import type { OverlayState } from '../../../next-devtools/dev-overlay/shared'\n@@ -21,6 +25,7 @@ import {\n   handleBrowserPageResponse,\n   DEFAULT_BROWSER_REQUEST_TIMEOUT_MS,\n } from './utils/browser-communication'\n+import { NextInstanceErrorState } from './next-instance-error-state'\n \n export function registerGetErrorsTool(\n   server: McpServer,\n@@ -31,7 +36,7 @@ export function registerGetErrorsTool(\n     'get_errors',\n     {\n       description:\n-        'Get the current error state of the app when rendered in the browser, including any build or runtime errors with source-mapped stack traces',\n+        'Get the current error state from the Next.js dev server, including Next.js global errors (e.g., next.config validation), browser runtime errors, and build errors with source-mapped stack traces',\n       inputSchema: {},\n     },\n     async (_request) => {\n@@ -55,18 +60,21 @@ export function registerGetErrorsTool(\n           DEFAULT_BROWSER_REQUEST_TIMEOUT_MS\n         )\n \n-        const errorsByUrl = new Map<string, OverlayState>()\n+        // The error state for each route\n+        // key is the route path, value is the error state\n+        const routesErrorState = new Map<string, OverlayState>()\n         for (const response of responses) {\n           if (response.data) {\n-            errorsByUrl.set(response.url, response.data)\n+            routesErrorState.set(response.url, response.data)\n           }\n         }\n \n-        const hasErrors = Array.from(errorsByUrl.values()).some(\n+        const hasRouteErrors = Array.from(routesErrorState.values()).some(\n           (state) => state.errors.length > 0 || !!state.buildError\n         )\n+        const hasInstanceErrors = NextInstanceErrorState.nextConfig.length > 0\n \n-        if (!hasErrors) {\n+        if (!hasRouteErrors && !hasInstanceErrors) {\n           return {\n             content: [\n               {\n@@ -80,7 +88,10 @@ export function registerGetErrorsTool(\n           }\n         }\n \n-        const output = await formatErrors(errorsByUrl)\n+        const output = await formatErrors(\n+          routesErrorState,\n+          NextInstanceErrorState\n+        )\n \n         return {\n           content: ["
        },
        {
            "sha": "75ef4da1db4bfc25acd8b012b6efe2953717f4ab",
            "filename": "packages/next/src/server/mcp/tools/next-instance-error-state.ts",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/e30082161443d774b18182256bc980f3ee4fbaac/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fnext-instance-error-state.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e30082161443d774b18182256bc980f3ee4fbaac/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fnext-instance-error-state.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fnext-instance-error-state.ts?ref=e30082161443d774b18182256bc980f3ee4fbaac",
            "patch": "@@ -0,0 +1,22 @@\n+/**\n+ * Global error state for Next.js instance-level errors that are not associated\n+ * with a specific browser session or route. This state is exposed through the MCP server's `get_errors`\n+ * tool as well. This covers the errors that are global to the Next.js instance, such as errors in next.config.js.\n+ *\n+ *\n+ * ## Usage\n+ *\n+ * This state is directly manipulated by various parts of the Next.js dev server:\n+ *\n+ * // Reset the error state\n+ * NextInstanceErrorState.[errorType] = []\n+ *\n+ * // Capture an error for a specific error type\n+ * NextInstanceErrorState.[errorType].push(err)\n+ *\n+ */\n+export const NextInstanceErrorState: {\n+  nextConfig: unknown[]\n+} = {\n+  nextConfig: [],\n+}"
        },
        {
            "sha": "f9ce2f087ed7d3cb23a9ffd580e9f41f0f5a189f",
            "filename": "packages/next/src/server/mcp/tools/utils/format-errors.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 33,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/e30082161443d774b18182256bc980f3ee4fbaac/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Futils%2Fformat-errors.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e30082161443d774b18182256bc980f3ee4fbaac/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Futils%2Fformat-errors.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Futils%2Fformat-errors.ts?ref=e30082161443d774b18182256bc980f3ee4fbaac",
            "patch": "@@ -125,47 +125,75 @@ async function formatRuntimeError(\n }\n \n export async function formatErrors(\n-  errorsByUrl: Map<string, OverlayState>\n+  errorsByUrl: Map<string, OverlayState>,\n+  nextInstanceErrors: { nextConfig: unknown[] } = { nextConfig: [] }\n ): Promise<string> {\n-  let output = `# Found errors in ${errorsByUrl.size} browser session(s)\\n\\n`\n+  let output = ''\n \n-  for (const [url, overlayState] of errorsByUrl) {\n-    const totalErrorCount =\n-      overlayState.errors.length + (overlayState.buildError ? 1 : 0)\n+  // Format Next.js instance errors first (e.g., next.config.js errors)\n+  if (nextInstanceErrors.nextConfig.length > 0) {\n+    output += `# Next.js Configuration Errors\\n\\n`\n+    output += `**${nextInstanceErrors.nextConfig.length} error(s) found in next.config**\\n\\n`\n \n-    if (totalErrorCount === 0) continue\n-\n-    let displayUrl = url\n-    try {\n-      const urlObj = new URL(url)\n-      displayUrl = urlObj.pathname + urlObj.search + urlObj.hash\n-    } catch {\n-      // If URL parsing fails, use the original URL\n-    }\n-\n-    output += `## Session: ${displayUrl}\\n\\n`\n-    output += `**${totalErrorCount} error(s) found**\\n\\n`\n-\n-    // Build errors\n-    if (overlayState.buildError) {\n-      output += '### Build Error\\n\\n'\n+    nextInstanceErrors.nextConfig.forEach((error, index) => {\n+      output += `## Error ${index + 1}\\n\\n`\n       output += '```\\n'\n-      output += overlayState.buildError\n+      if (error instanceof Error) {\n+        output += `${error.name}: ${error.message}\\n`\n+        if (error.stack) {\n+          output += error.stack\n+        }\n+      } else {\n+        output += String(error)\n+      }\n       output += '\\n```\\n\\n'\n-    }\n-\n-    // Runtime errors with source-mapped stack traces\n-    if (overlayState.errors.length > 0) {\n-      const runtimeErrors = await formatRuntimeError(\n-        overlayState.errors,\n-        overlayState.routerType === 'app'\n-      )\n-      output += runtimeErrors\n-      output += '\\n'\n-    }\n+    })\n \n     output += '---\\n\\n'\n   }\n \n+  // Format browser session errors\n+  if (errorsByUrl.size > 0) {\n+    output += `# Found errors in ${errorsByUrl.size} browser session(s)\\n\\n`\n+\n+    for (const [url, overlayState] of errorsByUrl) {\n+      const totalErrorCount =\n+        overlayState.errors.length + (overlayState.buildError ? 1 : 0)\n+\n+      if (totalErrorCount === 0) continue\n+\n+      let displayUrl = url\n+      try {\n+        const urlObj = new URL(url)\n+        displayUrl = urlObj.pathname + urlObj.search + urlObj.hash\n+      } catch {\n+        // If URL parsing fails, use the original URL\n+      }\n+\n+      output += `## Session: ${displayUrl}\\n\\n`\n+      output += `**${totalErrorCount} error(s) found**\\n\\n`\n+\n+      // Build errors\n+      if (overlayState.buildError) {\n+        output += '### Build Error\\n\\n'\n+        output += '```\\n'\n+        output += overlayState.buildError\n+        output += '\\n```\\n\\n'\n+      }\n+\n+      // Runtime errors with source-mapped stack traces\n+      if (overlayState.errors.length > 0) {\n+        const runtimeErrors = await formatRuntimeError(\n+          overlayState.errors,\n+          overlayState.routerType === 'app'\n+        )\n+        output += runtimeErrors\n+        output += '\\n'\n+      }\n+\n+      output += '---\\n\\n'\n+    }\n+  }\n+\n   return output.trim()\n }"
        },
        {
            "sha": "b2b16d919ad4eed96b106b49fae39dff32242a01",
            "filename": "test/development/mcp-server/mcp-server-get-errors.test.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/e30082161443d774b18182256bc980f3ee4fbaac/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e30082161443d774b18182256bc980f3ee4fbaac/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-errors.test.ts?ref=e30082161443d774b18182256bc980f3ee4fbaac",
            "patch": "@@ -312,6 +312,59 @@ describe('mcp-server get_errors tool', () => {\n       await s2.close()\n     }\n   })\n+\n+  it('should capture next.config errors and clear when fixed', async () => {\n+    // Read the original config\n+    const originalConfig = await next.readFile('next.config.js')\n+\n+    // Stop server, write invalid config, and restart\n+    await next.stop()\n+    await next.patchFile(\n+      'next.config.js',\n+      `module.exports = {\n+  experimental: {\n+    mcpServer: true,\n+    invalidTestProperty: 'this should cause a validation warning',\n+  },\n+}`\n+    )\n+    await next.start()\n+\n+    // Open a browser session\n+    await next.browser('/')\n+\n+    // Check that the config error is captured\n+    let errors: string = ''\n+    await retry(async () => {\n+      const sessionId = 'test-config-error-' + Date.now()\n+      errors = await callGetErrors(sessionId)\n+      expect(errors).toContain('Next.js Configuration Errors')\n+      expect(errors).toContain('error(s) found in next.config')\n+    })\n+\n+    const strippedErrors = stripAnsi(errors)\n+    expect(strippedErrors).toContain('Next.js Configuration Errors')\n+    expect(strippedErrors).toContain('Invalid next.config.js options detected')\n+    expect(strippedErrors).toContain('invalidTestProperty')\n+\n+    // Stop server, fix the config, and restart\n+    await next.stop()\n+    await next.patchFile('next.config.js', originalConfig)\n+    await next.start()\n+\n+    // Open a browser session\n+    await next.browser('/')\n+\n+    // Verify the config error is now gone\n+    await retry(async () => {\n+      const sessionId = 'test-config-fixed-' + Date.now()\n+      const fixedErrors = await callGetErrors(sessionId)\n+      const strippedFixed = stripAnsi(fixedErrors)\n+      expect(strippedFixed).not.toContain('Next.js Configuration Errors')\n+      expect(strippedFixed).not.toContain('invalidTestProperty')\n+      expect(strippedFixed).toContain('No errors detected')\n+    })\n+  })\n })\n \n /**"
        }
    ],
    "stats": {
        "total": 239,
        "additions": 191,
        "deletions": 48
    }
}