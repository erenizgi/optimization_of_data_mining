{
    "author": "lubieowoce",
    "message": "add unstable_isUnrecognizedActionError (#78933)\n\n`unstable_isUnrecognizedActionError` is a new API that lets user code\ncheck if a server action call failed because the action id wasn't\nrecognized by the server. This usually happens as a result of version\nskew between client and server.\n\nExample usage:\n\n ```ts\n try {\n   await myServerAction();\n } catch (err) {\n   if (unstable_isUnrecognizedActionError(err)) {\n     // The client is from a different deployment than the server.\n     // Reloading the page will fix this mismatch.\n     window.alert(\"Please refresh the page and try again\");\n     return;\n   }\n }\n ```\nIt can also be used to create a special error boundary, like we do in\nthe tests added here.\n\nNote that this API is not a complete solution to this problem, as it\ndoesn't allow handling failures for MPA actions (sent without JS). We\nmight add a more complete API for this in the future to address that.",
    "sha": "2dc45422a1c61952a9d8503341cd88d68d674d77",
    "files": [
        {
            "sha": "446ab7c30b06ce91663234587c55ec8a070b2720",
            "filename": "crates/next-custom-transforms/src/transforms/react_server_components.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2dc45422a1c61952a9d8503341cd88d68d674d77/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2dc45422a1c61952a9d8503341cd88d68d674d77/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs?ref=2dc45422a1c61952a9d8503341cd88d68d674d77",
            "patch": "@@ -624,6 +624,7 @@ impl ReactServerComponentValidator {\n                         \"useRouter\",\n                         \"useServerInsertedHTML\",\n                         \"ServerInsertedHTMLContext\",\n+                        \"unstable_isUnrecognizedActionError\",\n                     ],\n                 ),\n                 (\"next/link\", vec![\"useLinkStatus\"]),"
        },
        {
            "sha": "f4d8527048ec8d4fba344932d9d62638f5e21776",
            "filename": "crates/next-error-code-swc-plugin/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2dc45422a1c61952a9d8503341cd88d68d674d77/crates%2Fnext-error-code-swc-plugin%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2dc45422a1c61952a9d8503341cd88d68d674d77/crates%2Fnext-error-code-swc-plugin%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-error-code-swc-plugin%2Fsrc%2Flib.rs?ref=2dc45422a1c61952a9d8503341cd88d68d674d77",
            "patch": "@@ -54,6 +54,7 @@ fn is_error_class_name(name: &str) -> bool {\n         || name == \"SerializableError\"\n         || name == \"StaticGenBailoutError\"\n         || name == \"TimeoutError\"\n+        || name == \"UnrecognizedActionError\"\n         || name == \"Warning\"\n }\n "
        },
        {
            "sha": "4497bfbfbb7437ea6fb1548e8643ae42b862deb4",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=2dc45422a1c61952a9d8503341cd88d68d674d77",
            "patch": "@@ -773,5 +773,6 @@\n   \"772\": \"FetchStrategy.PPRRuntime should never be used when `experimental.clientSegmentCache` is disabled\",\n   \"773\": \"Missing workStore in createPrerenderParamsForClientSegment\",\n   \"774\": \"Route %s used %s outside of a Server Component. This is not allowed.\",\n-  \"775\": \"Node.js instrumentation extensions should not be loaded in the Edge runtime.\"\n+  \"775\": \"Node.js instrumentation extensions should not be loaded in the Edge runtime.\",\n+  \"776\": \"`unstable_isUnrecognizedActionError` can only be used on the client.\"\n }"
        },
        {
            "sha": "98316090c50195d7bfa5d0cc628d1075bca05d3b",
            "filename": "packages/next/next_error_code_swc_plugin.wasm",
            "status": "modified",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Fnext_error_code_swc_plugin.wasm",
            "raw_url": "https://github.com/vercel/next.js/raw/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Fnext_error_code_swc_plugin.wasm",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fnext_error_code_swc_plugin.wasm?ref=2dc45422a1c61952a9d8503341cd88d68d674d77"
        },
        {
            "sha": "eb7a009da17909599b3330c91b2fbfde542609e9",
            "filename": "packages/next/src/client/components/navigation.react-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.react-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.react-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.react-server.ts?ref=2dc45422a1c61952a9d8503341cd88d68d674d77",
            "patch": "@@ -26,6 +26,12 @@ class ReadonlyURLSearchParams extends URLSearchParams {\n   }\n }\n \n+export function unstable_isUnrecognizedActionError(): boolean {\n+  throw new Error(\n+    '`unstable_isUnrecognizedActionError` can only be used on the client.'\n+  )\n+}\n+\n export { redirect, permanentRedirect } from './redirect'\n export { RedirectType } from './redirect-error'\n export { notFound } from './not-found'"
        },
        {
            "sha": "5ba95f31474862725782d83bf17065c3e8cf66d3",
            "filename": "packages/next/src/client/components/navigation.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts?ref=2dc45422a1c61952a9d8503341cd88d68d674d77",
            "patch": "@@ -272,6 +272,8 @@ export function useSelectedLayoutSegment(\n     : selectedLayoutSegment\n }\n \n+export { unstable_isUnrecognizedActionError } from './unrecognized-action-error'\n+\n // Shared components APIs\n export {\n   notFound,"
        },
        {
            "sha": "d608c54705265e7081d37abae9d81513f60d86be",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=2dc45422a1c61952a9d8503341cd88d68d674d77",
            "patch": "@@ -12,6 +12,7 @@ import {\n   NEXT_URL,\n   RSC_CONTENT_TYPE_HEADER,\n } from '../../app-router-headers'\n+import { UnrecognizedActionError } from '../../unrecognized-action-error'\n \n // TODO: Explicitly import from client.browser\n // eslint-disable-next-line import/no-extraneous-dependencies\n@@ -114,7 +115,7 @@ async function fetchServerAction(\n   // Handle server actions that the server didn't recognize.\n   const unrecognizedActionHeader = res.headers.get(NEXT_ACTION_NOT_FOUND_HEADER)\n   if (unrecognizedActionHeader === '1') {\n-    throw new Error(\n+    throw new UnrecognizedActionError(\n       `Server Action \"${actionId}\" was not found on the server. \\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action`\n     )\n   }"
        },
        {
            "sha": "33b6dc62761e2362c77cb915fbca45c625545464",
            "filename": "packages/next/src/client/components/unrecognized-action-error.ts",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funrecognized-action-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2dc45422a1c61952a9d8503341cd88d68d674d77/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funrecognized-action-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funrecognized-action-error.ts?ref=2dc45422a1c61952a9d8503341cd88d68d674d77",
            "patch": "@@ -0,0 +1,34 @@\n+export class UnrecognizedActionError extends Error {\n+  constructor(...args: ConstructorParameters<typeof Error>) {\n+    super(...args)\n+    this.name = 'UnrecognizedActionError'\n+  }\n+}\n+\n+/**\n+ * Check whether a server action call failed because the server action was not recognized by the server.\n+ * This can happen if the client and the server are not from the same deployment.\n+ *\n+ * Example usage:\n+ * ```ts\n+ * try {\n+ *   await myServerAction();\n+ * } catch (err) {\n+ *   if (unstable_isUnrecognizedActionError(err)) {\n+ *     // The client is from a different deployment than the server.\n+ *     // Reloading the page will fix this mismatch.\n+ *     window.alert(\"Please refresh the page and try again\");\n+ *     return;\n+ *   }\n+ * }\n+ * ```\n+ * */\n+export function unstable_isUnrecognizedActionError(\n+  error: unknown\n+): error is UnrecognizedActionError {\n+  return !!(\n+    error &&\n+    typeof error === 'object' &&\n+    error instanceof UnrecognizedActionError\n+  )\n+}"
        },
        {
            "sha": "7826652508844ed2b297b96b9c45d755120f864e",
            "filename": "test/e2e/app-dir/actions-unrecognized/app/nodejs/unrecognized-action/client.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/2dc45422a1c61952a9d8503341cd88d68d674d77/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Fapp%2Fnodejs%2Funrecognized-action%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2dc45422a1c61952a9d8503341cd88d68d674d77/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Fapp%2Fnodejs%2Funrecognized-action%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Fapp%2Fnodejs%2Funrecognized-action%2Fclient.tsx?ref=2dc45422a1c61952a9d8503341cd88d68d674d77",
            "patch": "@@ -1,6 +1,7 @@\n 'use client'\n import * as React from 'react'\n import { useActionState } from 'react'\n+import { unstable_isUnrecognizedActionError as isUnrecognizedActionError } from 'next/navigation'\n \n export function FormWithArg<T>({\n   action,\n@@ -41,12 +42,16 @@ export function Form({\n   )\n }\n \n-export class ErrorBoundary extends React.Component<{\n+export class UnrecognizedActionBoundary extends React.Component<{\n   children: React.ReactNode\n }> {\n   state = { error: null }\n   static getDerivedStateFromError(error) {\n-    return { error }\n+    if (isUnrecognizedActionError(error)) {\n+      return { error }\n+    } else {\n+      throw error\n+    }\n   }\n   render() {\n     if (this.state.error) {"
        },
        {
            "sha": "5924ba4d09abc3db3ad33f9533c33d7197f44097",
            "filename": "test/e2e/app-dir/actions-unrecognized/app/nodejs/unrecognized-action/page.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/2dc45422a1c61952a9d8503341cd88d68d674d77/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Fapp%2Fnodejs%2Funrecognized-action%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2dc45422a1c61952a9d8503341cd88d68d674d77/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Fapp%2Fnodejs%2Funrecognized-action%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Fapp%2Fnodejs%2Funrecognized-action%2Fpage.tsx?ref=2dc45422a1c61952a9d8503341cd88d68d674d77",
            "patch": "@@ -1,5 +1,5 @@\n import * as React from 'react'\n-import { FormWithArg, Form, ErrorBoundary } from './client'\n+import { FormWithArg, Form, UnrecognizedActionBoundary } from './client'\n \n const action = async (...args: any[]) => {\n   'use server'\n@@ -14,31 +14,31 @@ export default function Page() {\n   return (\n     <div>\n       <div>\n-        <ErrorBoundary>\n+        <UnrecognizedActionBoundary>\n           <Form action={action} />\n-        </ErrorBoundary>\n+        </UnrecognizedActionBoundary>\n       </div>\n       <div>\n-        <ErrorBoundary>\n+        <UnrecognizedActionBoundary>\n           <FormWithArg\n             action={action}\n             id=\"form-simple-argument\"\n             argument={{ foo: 'bar' }}\n           >\n             Submit client form with simple argument\n           </FormWithArg>\n-        </ErrorBoundary>\n+        </UnrecognizedActionBoundary>\n       </div>\n       <div>\n-        <ErrorBoundary>\n+        <UnrecognizedActionBoundary>\n           <FormWithArg\n             action={action}\n             id=\"form-complex-argument\"\n             argument={new Map([['foo', Promise.resolve('bar')]])}\n           >\n             Submit client form with complex argument\n           </FormWithArg>\n-        </ErrorBoundary>\n+        </UnrecognizedActionBoundary>\n       </div>\n     </div>\n   )"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 62,
        "deletions": 11
    }
}