{
    "author": "mischnic",
    "message": "Turbopack: instrument scope hoisting with tracing spans (#81078)\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that you follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the PR.\n- Read the Docs Contribution Guide to ensure your contribution follows the docs guidelines: https://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc https://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See https://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See: https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature request has been accepted for implementation before opening a PR. (A discussion must be opened, see https://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added (https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to understand the PR)\n- When linking to a Slack thread, you might want to share details of the conclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic behind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "b3a6dcba71563b7e958e4524d99bd7d136d57f29",
    "files": [
        {
            "sha": "072d71e0719140064071d2c7d8ae24dbc7302f2b",
            "filename": "turbopack/crates/turbopack-cli/benches/small_apps.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b3a6dcba71563b7e958e4524d99bd7d136d57f29/turbopack%2Fcrates%2Fturbopack-cli%2Fbenches%2Fsmall_apps.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b3a6dcba71563b7e958e4524d99bd7d136d57f29/turbopack%2Fcrates%2Fturbopack-cli%2Fbenches%2Fsmall_apps.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fbenches%2Fsmall_apps.rs?ref=b3a6dcba71563b7e958e4524d99bd7d136d57f29",
            "patch": "@@ -83,6 +83,7 @@ fn bench_small_apps(c: &mut Criterion) {\n                             no_sourcemap: false,\n                             no_minify: false,\n                             force_memory_cleanup: true,\n+                            no_scope_hoist: false,\n                         })\n                         .await\n                     })"
        },
        {
            "sha": "b01247b3bf1a1d29462af645aa8cc4c48d4d39ee",
            "filename": "turbopack/crates/turbopack-cli/src/arguments.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/b3a6dcba71563b7e958e4524d99bd7d136d57f29/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Farguments.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b3a6dcba71563b7e958e4524d99bd7d136d57f29/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Farguments.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Farguments.rs?ref=b3a6dcba71563b7e958e4524d99bd7d136d57f29",
            "patch": "@@ -136,6 +136,10 @@ pub struct BuildArguments {\n     #[clap(long)]\n     pub no_minify: bool,\n \n+    /// Don't perform scope hoisting.\n+    #[clap(long)]\n+    pub no_scope_hoist: bool,\n+\n     /// Drop the `TurboTasks` object upon exit. By default we intentionally leak this memory, as\n     /// we're about to exit the process anyways, but that can cause issues with valgrind or other\n     /// leak detectors."
        },
        {
            "sha": "522f2eeb7cc5fae777cc0e3e7484ebdafb9b47c1",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/b3a6dcba71563b7e958e4524d99bd7d136d57f29/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b3a6dcba71563b7e958e4524d99bd7d136d57f29/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=b3a6dcba71563b7e958e4524d99bd7d136d57f29",
            "patch": "@@ -76,6 +76,7 @@ pub struct TurbopackBuildBuilder {\n     source_maps_type: SourceMapsType,\n     minify_type: MinifyType,\n     target: Target,\n+    scope_hoist: bool,\n }\n \n impl TurbopackBuildBuilder {\n@@ -96,6 +97,7 @@ impl TurbopackBuildBuilder {\n                 mangle: Some(MangleType::OptimalSize),\n             },\n             target: Target::Node,\n+            scope_hoist: true,\n         }\n     }\n \n@@ -134,6 +136,11 @@ impl TurbopackBuildBuilder {\n         self\n     }\n \n+    pub fn scope_hoist(mut self, scope_hoist: bool) -> Self {\n+        self.scope_hoist = scope_hoist;\n+        self\n+    }\n+\n     pub fn target(mut self, target: Target) -> Self {\n         self.target = target;\n         self\n@@ -149,6 +156,7 @@ impl TurbopackBuildBuilder {\n                 self.source_maps_type,\n                 self.minify_type,\n                 self.target,\n+                self.scope_hoist,\n             );\n \n             // Await the result to propagate any errors.\n@@ -196,6 +204,7 @@ async fn build_internal(\n     source_maps_type: SourceMapsType,\n     minify_type: MinifyType,\n     target: Target,\n+    scope_hoist: bool,\n ) -> Result<Vc<()>> {\n     let output_fs = output_fs(project_dir.clone());\n     let project_fs = project_fs(root_dir.clone(), /* watch= */ false);\n@@ -359,7 +368,7 @@ async fn build_internal(\n                             },\n                         )\n                         .use_content_hashing(ContentHashing::Direct { length: 16 })\n-                        .module_merging(true);\n+                        .module_merging(scope_hoist);\n                 }\n             }\n \n@@ -404,7 +413,7 @@ async fn build_internal(\n                                 ..Default::default()\n                             },\n                         )\n-                        .module_merging(true);\n+                        .module_merging(scope_hoist);\n                 }\n             }\n \n@@ -533,6 +542,7 @@ pub async fn build(args: &BuildArguments) -> Result<()> {\n                 mangle: Some(MangleType::OptimalSize),\n             }\n         })\n+        .scope_hoist(!args.no_scope_hoist)\n         .target(args.common.target.unwrap_or(Target::Node))\n         .show_all(args.common.show_all);\n "
        },
        {
            "sha": "668a7726b398b5e1bc12d7b8ec3ad8e9f35e1152",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 115,
            "deletions": 93,
            "changes": 208,
            "blob_url": "https://github.com/vercel/next.js/blob/b3a6dcba71563b7e958e4524d99bd7d136d57f29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b3a6dcba71563b7e958e4524d99bd7d136d57f29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=b3a6dcba71563b7e958e4524d99bd7d136d57f29",
            "patch": "@@ -77,7 +77,7 @@ use swc_core::{\n     },\n     quote,\n };\n-use tracing::Instrument;\n+use tracing::{Instrument, Level, instrument};\n pub use transform::{\n     CustomTransformer, EcmascriptInputTransform, EcmascriptInputTransforms, TransformContext,\n     TransformPlugin, UnsupportedServerActionIssue,\n@@ -1066,106 +1066,121 @@ impl EcmascriptModuleContent {\n         module_options: Vec<Vc<EcmascriptModuleContentOptions>>,\n         entry_points: Vec<ResolvedVc<Box<dyn EcmascriptAnalyzable>>>,\n     ) -> Result<Vc<Self>> {\n-        let modules = modules\n-            .into_iter()\n-            .map(|(m, exposed)| {\n-                (\n-                    ResolvedVc::try_sidecast::<Box<dyn EcmascriptChunkPlaceable>>(m).unwrap(),\n-                    exposed,\n-                )\n-            })\n-            .collect::<FxIndexMap<_, _>>();\n-        let entry_points = entry_points\n-            .into_iter()\n-            .map(|m| {\n-                let m = ResolvedVc::try_sidecast::<Box<dyn EcmascriptChunkPlaceable>>(m).unwrap();\n-                (m, modules.get_index_of(&m).unwrap())\n-            })\n-            .collect::<Vec<_>>();\n+        async {\n+            let modules = modules\n+                .into_iter()\n+                .map(|(m, exposed)| {\n+                    (\n+                        ResolvedVc::try_sidecast::<Box<dyn EcmascriptChunkPlaceable>>(m).unwrap(),\n+                        exposed,\n+                    )\n+                })\n+                .collect::<FxIndexMap<_, _>>();\n+            let entry_points = entry_points\n+                .into_iter()\n+                .map(|m| {\n+                    let m =\n+                        ResolvedVc::try_sidecast::<Box<dyn EcmascriptChunkPlaceable>>(m).unwrap();\n+                    (m, modules.get_index_of(&m).unwrap())\n+                })\n+                .collect::<Vec<_>>();\n \n-        let globals_merged = Globals::default();\n+            let globals_merged = Globals::default();\n \n-        let contents = module_options\n-            .iter()\n-            .zip(modules.keys().copied())\n-            .map(async |(options, module)| {\n-                let options = options.await?;\n-                let EcmascriptModuleContentOptions {\n-                    chunking_context,\n-                    parsed,\n-                    ident,\n-                    specified_module_type,\n-                    generate_source_map,\n-                    original_source_map,\n-                    ..\n-                } = &*options;\n-\n-                let result = process_parse_result(\n-                    *parsed,\n-                    **ident,\n-                    *specified_module_type,\n-                    *generate_source_map,\n-                    *original_source_map,\n-                    *chunking_context.minify_type().await?,\n-                    Some(&*options),\n-                    Some(ScopeHoistingOptions {\n-                        module,\n-                        modules: &modules,\n-                    }),\n-                )\n-                .await?;\n+            let contents = module_options\n+                .iter()\n+                .zip(modules.keys().copied())\n+                .map(async |(options, module)| {\n+                    async {\n+                        let options = options.await?;\n+                        let EcmascriptModuleContentOptions {\n+                            chunking_context,\n+                            parsed,\n+                            ident,\n+                            specified_module_type,\n+                            generate_source_map,\n+                            original_source_map,\n+                            ..\n+                        } = &*options;\n+\n+                        let result = process_parse_result(\n+                            *parsed,\n+                            **ident,\n+                            *specified_module_type,\n+                            *generate_source_map,\n+                            *original_source_map,\n+                            *chunking_context.minify_type().await?,\n+                            Some(&*options),\n+                            Some(ScopeHoistingOptions {\n+                                module,\n+                                modules: &modules,\n+                            }),\n+                        )\n+                        .await?;\n \n-                Ok((module, result))\n-            })\n-            .try_join()\n-            .await?;\n+                        Ok((module, result))\n+                    }\n+                    .instrument(tracing::trace_span!(\"process individual module\"))\n+                    .await\n+                })\n+                .try_join()\n+                .await?;\n \n-        let (merged_ast, comments, source_maps, original_source_maps) =\n-            merge_modules(contents, &entry_points, &globals_merged).await?;\n+            let (merged_ast, comments, source_maps, original_source_maps) =\n+                merge_modules(contents, &entry_points, &globals_merged).await?;\n \n-        // Use the options from an arbitrary module, since they should all be the same with regards\n-        // to minify_type and chunking_context.\n-        let options = module_options.last().unwrap().await?;\n+            // Use the options from an arbitrary module, since they should all be the same with\n+            // regards to minify_type and chunking_context.\n+            let options = module_options.last().unwrap().await?;\n \n-        let modules_header_width = modules.len().next_power_of_two().trailing_zeros();\n-        let content = CodeGenResult {\n-            program: merged_ast,\n-            source_map: CodeGenResultSourceMap::ScopeHoisting {\n-                modules_header_width,\n-                source_maps,\n-            },\n-            comments: CodeGenResultComments::ScopeHoisting {\n-                modules_header_width,\n-                comments,\n-            },\n-            export_contexts: None,\n-            is_esm: true,\n-            strict: true,\n-            original_source_map: CodeGenResultOriginalSourceMap::ScopeHoisting(\n-                original_source_maps,\n-            ),\n-            minify: *options.chunking_context.minify_type().await?,\n-            scope_hoisting_syntax_contexts: None,\n-        };\n+            let modules_header_width = modules.len().next_power_of_two().trailing_zeros();\n+            let content = CodeGenResult {\n+                program: merged_ast,\n+                source_map: CodeGenResultSourceMap::ScopeHoisting {\n+                    modules_header_width,\n+                    source_maps,\n+                },\n+                comments: CodeGenResultComments::ScopeHoisting {\n+                    modules_header_width,\n+                    comments,\n+                },\n+                export_contexts: None,\n+                is_esm: true,\n+                strict: true,\n+                original_source_map: CodeGenResultOriginalSourceMap::ScopeHoisting(\n+                    original_source_maps,\n+                ),\n+                minify: *options.chunking_context.minify_type().await?,\n+                scope_hoisting_syntax_contexts: None,\n+            };\n \n-        let first_entry = entry_points.first().unwrap().0;\n-        let additional_ids = modules\n-            .keys()\n-            // Additionally set this module factory for all modules that are exposed. The whole\n-            // group might be imported via a different entry import in different chunks (we only\n-            // ensure that the modules are in the same order, not that they form a subgraph that is\n-            // always imported from the same root module).\n-            //\n-            // Also skip the first entry, which is the name of the chunk item.\n-            .filter(|m| {\n-                **m != first_entry && *modules.get(*m).unwrap() == MergeableModuleExposure::External\n-            })\n-            .map(|m| m.chunk_item_id(*options.chunking_context).to_resolved())\n-            .try_join()\n-            .await?\n-            .into();\n+            let first_entry = entry_points.first().unwrap().0;\n+            let additional_ids = modules\n+                .keys()\n+                // Additionally set this module factory for all modules that are exposed. The whole\n+                // group might be imported via a different entry import in different chunks (we only\n+                // ensure that the modules are in the same order, not that they form a subgraph that\n+                // is always imported from the same root module).\n+                //\n+                // Also skip the first entry, which is the name of the chunk item.\n+                .filter(|m| {\n+                    **m != first_entry\n+                        && *modules.get(*m).unwrap() == MergeableModuleExposure::External\n+                })\n+                .map(|m| m.chunk_item_id(*options.chunking_context).to_resolved())\n+                .try_join()\n+                .await?\n+                .into();\n \n-        emit_content(content, additional_ids).await\n+            emit_content(content, additional_ids)\n+                .instrument(tracing::info_span!(\"emit\"))\n+                .await\n+        }\n+        .instrument(tracing::info_span!(\n+            \"merged EcmascriptModuleContent\",\n+            modules = module_options.len()\n+        ))\n+        .await\n     }\n }\n \n@@ -1177,6 +1192,7 @@ impl EcmascriptModuleContent {\n /// - `sym` being the name of the import.\n ///\n /// This is then used to map back to the variable name and context of the exporting module.\n+#[instrument(level = Level::TRACE, skip_all, name = \"merge\")]\n #[allow(clippy::type_complexity)]\n async fn merge_modules(\n     mut contents: Vec<(ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>, CodeGenResult)>,\n@@ -1314,13 +1330,15 @@ async fn merge_modules(\n         .collect::<Result<FxHashMap<_, _>>>()?;\n \n     let (merged_ast, inserted) = GLOBALS.set(globals_merged, || {\n+        let _ = tracing::trace_span!(\"merge inner\").entered();\n         // As an optimization, assume an average number of 5 contexts per module.\n         let mut unique_contexts_cache =\n             FxHashMap::with_capacity_and_hasher(contents.len() * 5, Default::default());\n \n         let mut prepare_module =\n             |(module, content): &(ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>, CodeGenResult),\n              program: &mut Program| {\n+                let _ = tracing::trace_span!(\"prepare module\").entered();\n                 if let CodeGenResult {\n                     scope_hoisting_syntax_contexts: Some(module_contexts),\n                     ..\n@@ -1366,6 +1384,7 @@ async fn merge_modules(\n \n         let mut inserted_imports = FxHashMap::default();\n \n+        let span = tracing::trace_span!(\"merge ASTs\");\n         // Replace inserted `__turbopack_merged_esm__(i);` statements with the corresponding\n         // ith-module.\n         let mut queue = entry_points\n@@ -1438,13 +1457,16 @@ async fn merge_modules(\n \n             result.push(item);\n         }\n+        drop(span);\n \n+        let span = tracing::trace_span!(\"hygiene\").entered();\n         let mut merged_ast = Program::Module(swc_core::ecma::ast::Module {\n             body: result,\n             span: DUMMY_SP,\n             shebang: None,\n         });\n         merged_ast.visit_mut_with(&mut swc_core::ecma::transforms::base::hygiene::hygiene());\n+        drop(span);\n \n         anyhow::Ok((merged_ast, inserted))\n     })?;"
        }
    ],
    "stats": {
        "total": 227,
        "additions": 132,
        "deletions": 95
    }
}