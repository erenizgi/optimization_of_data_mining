{
    "author": "lubieowoce",
    "message": "test: fix snapshots in failing tests (#79254)",
    "sha": "733e4d6413ca65c7c03c1d0da0204c22af2c8854",
    "files": [
        {
            "sha": "ccb2c4ab091a39df4fea2d5b516624e8ad4fe60c",
            "filename": "test/development/acceptance-app/error-recovery.test.ts",
            "status": "modified",
            "additions": 63,
            "deletions": 21,
            "changes": 84,
            "blob_url": "https://github.com/vercel/next.js/blob/733e4d6413ca65c7c03c1d0da0204c22af2c8854/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/733e4d6413ca65c7c03c1d0da0204c22af2c8854/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts?ref=733e4d6413ca65c7c03c1d0da0204c22af2c8854",
            "patch": "@@ -1,7 +1,14 @@\n /* eslint-env jest */\n import { createSandbox } from 'development-sandbox'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n-import { check } from 'next-test-utils'\n+import {\n+  assertHasRedbox,\n+  check,\n+  getRedboxCallStack,\n+  getRedboxDescription,\n+  getRedboxEnvironmentLabel,\n+  getRedboxSource,\n+} from 'next-test-utils'\n import path from 'path'\n import { outdent } from 'outdent'\n \n@@ -375,20 +382,55 @@ describe('Error recovery app', () => {\n         `\n     )\n \n-    await expect(browser).toDisplayRedbox(`\n-     {\n-       \"description\": \"oops\",\n-       \"environmentLabel\": \"Server\",\n-       \"label\": \"Runtime Error\",\n-       \"source\": \"child.js (3:9) @ Child\n-     > 3 |   throw new Error('oops')\n-         |         ^\",\n-       \"stack\": [\n-         \"Child child.js (3:9)\",\n-         \"Page app/server/page.js (3:10)\",\n-       ],\n-     }\n-    `)\n+    {\n+      // FIXME: `label` is flaking between \"Runtime Error\" and \"Recoverable Error\",\n+      // so we have to snapshot the redbox manually we figure out why\n+\n+      // await expect(browser).toDisplayRedbox(`\n+      //  {\n+      //    \"description\": \"oops\",\n+      //    \"environmentLabel\": \"Server\",\n+      //    \"label\": \"Recoverable Error\",\n+      //    \"source\": \"child.js (3:9) @ Child\n+      //  > 3 |   throw new Error('oops')\n+      //      |         ^\",\n+      //    \"stack\": [\n+      //      \"Child child.js (3:9)\",\n+      //      \"Page app/server/page.js (3:10)\",\n+      //    ],\n+      //  }\n+      // `)\n+\n+      await assertHasRedbox(browser)\n+      const redbox = await Promise.all([\n+        getRedboxDescription(browser),\n+        getRedboxEnvironmentLabel(browser),\n+        getRedboxSource(browser),\n+        getRedboxCallStack(browser),\n+      ]).then(([description, environmentLabel, source, stack]) => ({\n+        description,\n+        environmentLabel,\n+        source,\n+        stack,\n+      }))\n+      expect(redbox).toMatchInlineSnapshot(`\n+      {\n+        \"description\": \"oops\",\n+        \"environmentLabel\": \"Server\",\n+        \"source\": \"child.js (3:9) @ Child\n+\n+        1 | // hello\n+        2 | export default function Child() {\n+      > 3 |   throw new Error('oops')\n+          |         ^\n+        4 | }\",\n+        \"stack\": [\n+          \"Child child.js (3:9)\",\n+          \"Page app/server/page.js (3:10)\",\n+        ],\n+      }\n+      `)\n+    }\n \n     // TODO-APP: re-enable when error recovery doesn't reload the page.\n     /* const didNotReload = */ await session.patch(\n@@ -580,10 +622,10 @@ describe('Error recovery app', () => {\n          \"description\": \"Parsing ecmascript source code failed\",\n          \"environmentLabel\": null,\n          \"label\": \"Build Error\",\n-         \"source\": \"./index.js (7:41)\n+         \"source\": \"./index.js (10:41)\n        Parsing ecmascript source code failed\n-       > 7 | export default function FunctionNamed() {\n-           |                                         ^\",\n+       > 10 | export default function FunctionNamed() {\n+            |                                         ^\",\n          \"stack\": [],\n        }\n       `)\n@@ -617,10 +659,10 @@ describe('Error recovery app', () => {\n          \"description\": \"Parsing ecmascript source code failed\",\n          \"environmentLabel\": null,\n          \"label\": \"Build Error\",\n-         \"source\": \"./index.js (7:41)\n+         \"source\": \"./index.js (10:41)\n        Parsing ecmascript source code failed\n-       > 7 | export default function FunctionNamed() {\n-           |                                         ^\",\n+       > 10 | export default function FunctionNamed() {\n+            |                                         ^\",\n          \"stack\": [],\n        }\n       `)"
        },
        {
            "sha": "0ad089b31b265e1c2c06c50927381abab8a94320",
            "filename": "test/development/app-dir/use-cache-errors/use-cache-errors.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/733e4d6413ca65c7c03c1d0da0204c22af2c8854/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/733e4d6413ca65c7c03c1d0da0204c22af2c8854/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts?ref=733e4d6413ca65c7c03c1d0da0204c22af2c8854",
            "patch": "@@ -5,6 +5,7 @@ describe('use-cache-errors', () => {\n   const { next, isTurbopack } = nextTestSetup({\n     files: __dirname,\n   })\n+  const isRspack = Boolean(process.env.NEXT_RSPACK)\n \n   it('should not show a false-positive compiler error about a misplaced \"use cache\" directive', async () => {\n     // This is a regression test to ensure that an injected React Refresh\n@@ -35,6 +36,21 @@ describe('use-cache-errors', () => {\n          ],\n        }\n       `)\n+    } else if (isRspack) {\n+      // TODO: the source is missing and the stack leaks rspack internals\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"Attempted to call useStuff() from the server but useStuff is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n+         \"environmentLabel\": \"Cache\",\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [\n+           \"<FIXME-file-protocol>\",\n+           \"useCachedStuff rsc:/Cache/webpack-internal:///(action-browser)/app/module-with-use-cache.ts (25:68)\",\n+           \"Page ./app/page.tsx\",\n+         ],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 79,
        "deletions": 21
    }
}