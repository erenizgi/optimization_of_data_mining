{
    "author": "bgw",
    "message": "Turbopack: Document new advanced `turbopack.rule.*.condition` config options (#83246)\n\n~I'm looking for review/feedback, but **DO NOT MERGE UNTIL NEXT 16.0 IS RELEASED.** These APIs are not available on 15.5, and merging it now would be confusing to users. If you want to try it out, use a recent canary release.~ I've been informed that docs are not currently tracking canary, so this is safe to merge.\n\nDocumented the new configuration syntax added in https://github.com/vercel/next.js/pull/82857 that should ship with Next 16.0.\n\n## Rendered\n\n<details>\n<summary>Toggle</summary>\n<img src=\"https://app.graphite.dev/user-attachments/assets/b2404001-6e3f-47c9-9704-160fcfb1438d.png\" width=1000>\n</details>",
    "sha": "0761a925146d45b11bbadf8c87141968c48a1160",
    "files": [
        {
            "sha": "bcb5952b3868a6441bcb1f8b36327944d690be14",
            "filename": "crates/next-core/src/next_shared/webpack_rules/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/0761a925146d45b11bbadf8c87141968c48a1160/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0761a925146d45b11bbadf8c87141968c48a1160/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs?ref=0761a925146d45b11bbadf8c87141968c48a1160",
            "patch": "@@ -30,6 +30,7 @@ pub(crate) mod sass;\n // Note: If you add a field here, make sure to also add it in:\n // - The typescript definition in `packages/next/src/server/config-shared.ts`\n // - The zod schema in `packages/next/src/server/config-schema.ts`\n+// - The documentation in `docs/01-app/03-api-reference/05-config/01-next-config-js/turbopack.mdx`\n //\n // Note: Sets of conditions could be stored more efficiently as a bitset, but it's probably not used\n // in enough places for it to matter."
        },
        {
            "sha": "3e2bad257a96210591cc7923273def6bbaa31552",
            "filename": "docs/01-app/03-api-reference/05-config/01-next-config-js/turbopack.mdx",
            "status": "modified",
            "additions": 82,
            "deletions": 3,
            "changes": 85,
            "blob_url": "https://github.com/vercel/next.js/blob/0761a925146d45b11bbadf8c87141968c48a1160/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2Fturbopack.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/0761a925146d45b11bbadf8c87141968c48a1160/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2Fturbopack.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2Fturbopack.mdx?ref=0761a925146d45b11bbadf8c87141968c48a1160",
            "patch": "@@ -42,7 +42,7 @@ module.exports = nextConfig\n \n ### Options\n \n-The following options are available for the `turbo` configuration:\n+The following options are available for the `turbopack` configuration:\n \n | Option              | Description                                                             |\n | ------------------- | ----------------------------------------------------------------------- |\n@@ -97,7 +97,7 @@ If you need loader support beyond what's built in, many webpack loaders already\n - Only loaders that return JavaScript code are supported. Loaders that transform files like stylesheets or images are not currently supported.\n - Options passed to webpack loaders must be plain JavaScript primitives, objects, and arrays. For example, it's not possible to pass `require()` plugin modules as option values.\n \n-To configure loaders, add the names of the loaders you've installed and any options in `next.config.js`, mapping file extensions to a list of loaders.\n+To configure loaders, add the names of the loaders you've installed and any options in `next.config.js`, mapping file extensions to a list of loaders. Rules are evaluated in order.\n \n Here is an example below using the [`@svgr/webpack`](https://www.npmjs.com/package/@svgr/webpack) loader, which enables importing `.svg` files and rendering them as React components.\n \n@@ -114,6 +114,10 @@ module.exports = {\n }\n ```\n \n+> **Good to know**: Globs used in the `rules` object match based on file name, unless the glob contains a `/` character, which will cause it to match based on the full project-relative file path. Windows file paths are normalized to use unix-style `/` path separators.\n+>\n+> Turbopack uses a modified version of the [Rust `globset` library](https://docs.rs/globset/latest/globset/).\n+\n For loaders that require configuration options, you can use an object format instead of a string:\n \n ```js filename=\"next.config.js\"\n@@ -136,7 +140,81 @@ module.exports = {\n }\n ```\n \n-> **Good to know**: Prior to Next.js version 13.4.4, `turbo.rules` was named `turbo.loaders` and only accepted file extensions like `.mdx` instead of `*.mdx`.\n+> **Good to know**: Prior to Next.js version 13.4.4, `turbopack.rules` was named `turbo.loaders` and only accepted file extensions like `.mdx` instead of `*.mdx`.\n+\n+### Advanced webpack loader conditions\n+\n+You can further restrict where a loader runs using the advanced `condition` syntax:\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  turbopack: {\n+    rules: {\n+      // '*' will match all file paths, but we restrict where our\n+      // rule runs with a condition.\n+      '*': {\n+        condition: {\n+          all: [\n+            // 'foreign' is a built-in condition.\n+            { not: 'foreign' },\n+            // 'path' can be a RegExp or a glob string. A RegExp matches\n+            // anywhere in the full project-relative file path.\n+            { path: /^img\\/[0-9]{3}\\// },\n+            {\n+              any: [\n+                { path: '*.svg' },\n+                // 'content' is always a RegExp, and can match\n+                // anywhere in the file.\n+                { content: /\\<svg\\W/ },\n+              ],\n+            },\n+          ],\n+        },\n+        loaders: ['@svgr/webpack'],\n+        as: '*.js',\n+      },\n+    },\n+  },\n+}\n+```\n+\n+- Supported boolean operators are `{all: [...]}`, `{any: [...]}` and `{not: ...}`.\n+- Supported customizable operators are `{path: string | RegExp}` and `{content: RegExp}`. If `path` and `content` are specified in the same object, it acts as an implicit `and`.\n+\n+In addition, a number of built-in conditions are supported:\n+\n+- `default`: Always matched. A no-op.\n+- `browser`: Matches code that will execute on the client. Server code can be matched using `{not: 'browser'}`.\n+- `foreign`: Matches code in `node_modules`, as well as some Next.js internals. Usually you'll want to restrict loaders to `{not: 'foreign'}`. This can improve performance by reducing the number of files the loader is invoked on.\n+- `development`: Matches when using `next dev --turbopack`.\n+- `production`: Matches when using `next build --turbopack`.\n+- `node`: Matches code that will run on the default Node.js runtime.\n+- `edge-light`: Matches code that will run on the [Edge runtime](/docs/app/api-reference/edge).\n+\n+Rules can be an object or an array of objects. An array is often useful for modeling disjoint conditions:\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  turbopack: {\n+    rules: {\n+      '*.svg': [\n+        {\n+          condition: 'browser',\n+          loaders: ['@svgr/webpack'],\n+          as: '*.js',\n+        },\n+        {\n+          condition: { not: 'browser' },\n+          loaders: [require.resolve('./custom-svg-loader.js')],\n+          as: '*.js',\n+        },\n+      ],\n+    },\n+  },\n+}\n+```\n+\n+> **Good to know**: All matching rules are executed in order.\n \n ### Resolving aliases\n \n@@ -181,5 +259,6 @@ For more information and guidance for how to migrate your app to Turbopack from\n \n | Version  | Changes                                         |\n | -------- | ----------------------------------------------- |\n+| `16.0.0` | `turbopack.rules.*.condition` was added.        |\n | `15.3.0` | `experimental.turbo` is changed to `turbopack`. |\n | `13.0.0` | `experimental.turbo` introduced.                |"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 83,
        "deletions": 3
    }
}