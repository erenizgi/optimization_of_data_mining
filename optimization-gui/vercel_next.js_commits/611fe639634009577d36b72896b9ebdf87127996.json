{
    "author": "timneutkens",
    "message": "Development: Remove matchers.reload() on each request (#83829)\n\n## What?\n\nRe-apply #83720. It was reverted because of tests flaking significantly\nmore often.\n\nDug into this with @mischnic and @sokra yesterday and we found that it's\na race condition because of the two separate watchers. In\n`setup-dev-bundler.ts` there's a Watchpack instance and Turbopack has\nit's own watcher. The specific case where it caused flakes is when the\nwatchpack aggregate event runs before Turbopack's watcher has emitted a\nchange event. Since the watchpack aggregate callback emits `ADDED_PAGE`\n/ `REMOVED_PAGE` over the websocket it would end up triggering the\nbrowser `location.reload()` too early, before the Turbopack side has the\nupdated list of routes.\n\nThe right solution is to move the `matchers.reload()` and `ADDED_PAGE` /\n`REMOVED_PAGE` events to where Turbopack emits that the list of routes\n(entrypoints) has updated.",
    "sha": "611fe639634009577d36b72896b9ebdf87127996",
    "files": [
        {
            "sha": "b221a9506bc8d20f3ace2f061df21d9c2e899698",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/611fe639634009577d36b72896b9ebdf87127996/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/611fe639634009577d36b72896b9ebdf87127996/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=611fe639634009577d36b72896b9ebdf87127996",
            "patch": "@@ -606,6 +606,10 @@ export default abstract class Server<\n     this.responseCache = this.getResponseCache({ dev })\n   }\n \n+  protected reloadMatchers() {\n+    return this.matchers.reload()\n+  }\n+\n   private handleRSCRequest: RouteHandler<ServerRequest, ServerResponse> = (\n     req,\n     _res,"
        },
        {
            "sha": "7938455a5d97ada8ea4a105ca23fd1572a17f08c",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/611fe639634009577d36b72896b9ebdf87127996/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/611fe639634009577d36b72896b9ebdf87127996/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=611fe639634009577d36b72896b9ebdf87127996",
            "patch": "@@ -612,6 +612,19 @@ export async function createHotReloaderTurbopack(\n         )\n       }\n \n+      const existingRoutes = [\n+        ...currentEntrypoints.app.keys(),\n+        ...currentEntrypoints.page.keys(),\n+      ]\n+      const newRoutes = [...entrypoints.routes.keys()]\n+\n+      const addedRoutes = newRoutes.filter(\n+        (route) => !existingRoutes.includes(route)\n+      )\n+      const removedRoutes = existingRoutes.filter(\n+        (route) => !newRoutes.includes(route)\n+      )\n+\n       processTopLevelIssues(currentTopLevelIssues, entrypoints)\n \n       await handleEntrypoints({\n@@ -647,6 +660,35 @@ export async function createHotReloaderTurbopack(\n         },\n       })\n \n+      // Reload matchers when the files have been compiled\n+      await propagateServerField(opts, 'reloadMatchers', undefined)\n+\n+      if (addedRoutes.length > 0 || removedRoutes.length > 0) {\n+        // When the list of routes changes a new manifest should be fetched for Pages Router.\n+        hotReloader.send({\n+          type: HMR_MESSAGE_SENT_TO_BROWSER.DEV_PAGES_MANIFEST_UPDATE,\n+          data: [\n+            {\n+              devPagesManifest: true,\n+            },\n+          ],\n+        })\n+      }\n+\n+      for (const route of addedRoutes) {\n+        hotReloader.send({\n+          type: HMR_MESSAGE_SENT_TO_BROWSER.ADDED_PAGE,\n+          data: [route],\n+        })\n+      }\n+\n+      for (const route of removedRoutes) {\n+        hotReloader.send({\n+          type: HMR_MESSAGE_SENT_TO_BROWSER.REMOVED_PAGE,\n+          data: [route],\n+        })\n+      }\n+\n       currentEntriesHandlingResolve!()\n       currentEntriesHandlingResolve = undefined\n     }"
        },
        {
            "sha": "0f5492b6fe571ac7a1c430c4c8c95cc5cc09fe6c",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 29,
            "changes": 66,
            "blob_url": "https://github.com/vercel/next.js/blob/611fe639634009577d36b72896b9ebdf87127996/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/611fe639634009577d36b72896b9ebdf87127996/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=611fe639634009577d36b72896b9ebdf87127996",
            "patch": "@@ -1045,37 +1045,49 @@ async function startWatcher(\n         }\n         opts.fsChecker.dynamicRoutes.unshift(...dataRoutes)\n \n-        if (!prevSortedRoutes?.every((val, idx) => val === sortedRoutes[idx])) {\n-          const addedRoutes = sortedRoutes.filter(\n-            (route) => !prevSortedRoutes.includes(route)\n-          )\n-          const removedRoutes = prevSortedRoutes.filter(\n-            (route) => !sortedRoutes.includes(route)\n-          )\n+        // For Turbopack ADDED_PAGE and REMOVED_PAGE are implemented in hot-reloader-turbopack.ts\n+        // in order to avoid a race condition where ADDED_PAGE and REMOVED_PAGE are sent before Turbopack picked up the file change.\n+        if (!opts.turbo) {\n+          // Reload the matchers. The filesystem would have been written to,\n+          // and the matchers need to re-scan it to update the router.\n+          // Reloading the matchers should happen before `ADDED_PAGE` or `REMOVED_PAGE` is sent over the websocket\n+          // otherwise it sends the event too early.\n+          await propagateServerField(opts, 'reloadMatchers', undefined)\n \n-          // emit the change so clients fetch the update\n-          hotReloader.send({\n-            type: HMR_MESSAGE_SENT_TO_BROWSER.DEV_PAGES_MANIFEST_UPDATE,\n-            data: [\n-              {\n-                devPagesManifest: true,\n-              },\n-            ],\n-          })\n+          if (\n+            !prevSortedRoutes?.every((val, idx) => val === sortedRoutes[idx])\n+          ) {\n+            const addedRoutes = sortedRoutes.filter(\n+              (route) => !prevSortedRoutes.includes(route)\n+            )\n+            const removedRoutes = prevSortedRoutes.filter(\n+              (route) => !sortedRoutes.includes(route)\n+            )\n \n-          addedRoutes.forEach((route) => {\n+            // emit the change so clients fetch the update\n             hotReloader.send({\n-              type: HMR_MESSAGE_SENT_TO_BROWSER.ADDED_PAGE,\n-              data: [route],\n+              type: HMR_MESSAGE_SENT_TO_BROWSER.DEV_PAGES_MANIFEST_UPDATE,\n+              data: [\n+                {\n+                  devPagesManifest: true,\n+                },\n+              ],\n             })\n-          })\n \n-          removedRoutes.forEach((route) => {\n-            hotReloader.send({\n-              type: HMR_MESSAGE_SENT_TO_BROWSER.REMOVED_PAGE,\n-              data: [route],\n+            addedRoutes.forEach((route) => {\n+              hotReloader.send({\n+                type: HMR_MESSAGE_SENT_TO_BROWSER.ADDED_PAGE,\n+                data: [route],\n+              })\n             })\n-          })\n+\n+            removedRoutes.forEach((route) => {\n+              hotReloader.send({\n+                type: HMR_MESSAGE_SENT_TO_BROWSER.REMOVED_PAGE,\n+                data: [route],\n+              })\n+            })\n+          }\n         }\n         prevSortedRoutes = sortedRoutes\n \n@@ -1114,10 +1126,6 @@ async function startWatcher(\n         } else {\n           Log.warn('Failed to reload dynamic routes:', e)\n         }\n-      } finally {\n-        // Reload the matchers. The filesystem would have been written to,\n-        // and the matchers need to re-scan it to update the router.\n-        await propagateServerField(opts, 'reloadMatchers', undefined)\n       }\n     })\n "
        },
        {
            "sha": "12f98c2118deade084afa63b3b68a677547378e8",
            "filename": "packages/next/src/server/route-matcher-managers/dev-route-matcher-manager.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/611fe639634009577d36b72896b9ebdf87127996/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-managers%2Fdev-route-matcher-manager.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/611fe639634009577d36b72896b9ebdf87127996/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-managers%2Fdev-route-matcher-manager.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-managers%2Fdev-route-matcher-manager.ts?ref=611fe639634009577d36b72896b9ebdf87127996",
            "patch": "@@ -65,10 +65,6 @@ export class DevRouteMatcherManager extends DefaultRouteMatcherManager {\n     pathname: string,\n     options: MatchOptions\n   ): AsyncGenerator<RouteMatch<RouteDefinition<RouteKind>>, null, undefined> {\n-    // Compile the development routes.\n-    // TODO: we may want to only run this during testing, users won't be fast enough to require this many dir scans\n-    await super.reload()\n-\n     // Iterate over the development matches to see if one of them match the\n     // request path.\n     for await (const developmentMatch of super.matchAll(pathname, options)) {"
        },
        {
            "sha": "f65e84342a503492a5cda1774deb823dc4987d23",
            "filename": "test/integration/custom-error/test/index.test.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/611fe639634009577d36b72896b9ebdf87127996/test%2Fintegration%2Fcustom-error%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/611fe639634009577d36b72896b9ebdf87127996/test%2Fintegration%2Fcustom-error%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcustom-error%2Ftest%2Findex.test.js?ref=611fe639634009577d36b72896b9ebdf87127996",
            "patch": "@@ -10,6 +10,7 @@ import {\n   killApp,\n   launchApp,\n   retry,\n+  waitFor,\n } from 'next-test-utils'\n \n const appDir = join(__dirname, '..')\n@@ -47,6 +48,8 @@ describe('Custom _error', () => {\n         })\n       } finally {\n         await fs.remove(page404)\n+        // Matches `next-dev.ts` patchFileDelay\n+        await waitFor(1000)\n       }\n     })\n   })\n@@ -76,6 +79,8 @@ describe('Custom _error', () => {\n         })\n       } finally {\n         await fs.remove(page404)\n+        // Matches `next-dev.ts` patchFileDelay\n+        await waitFor(1000)\n       }\n     })\n "
        }
    ],
    "stats": {
        "total": 121,
        "additions": 88,
        "deletions": 33
    }
}