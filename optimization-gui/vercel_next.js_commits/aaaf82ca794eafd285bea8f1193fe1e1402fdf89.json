{
    "author": "bgw",
    "message": "Turbopack: Suggest using system certs when a TLS error occurs (#85009)\n\nWe don't really want to document this flag because 99% of developers won't need it, but we can detect this situation and suggest the flag.\n\nBased on this user getting stuck: https://x.com/_bgwoodruff/status/1978493219068371330",
    "sha": "aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
    "files": [
        {
            "sha": "df6343a56cea2e76bb80aa6d9e8d56bb6f2c7b82",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 73,
            "deletions": 58,
            "changes": 131,
            "blob_url": "https://github.com/vercel/next.js/blob/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
            "patch": "@@ -1408,6 +1408,16 @@ dependencies = [\n  \"libc\",\n ]\n \n+[[package]]\n+name = \"core-foundation\"\n+version = \"0.10.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"b2a6cd9ae233e7f62ba4e9353e81a88df7fc8a5987b8d445b4d90c879bd156f6\"\n+dependencies = [\n+ \"core-foundation-sys\",\n+ \"libc\",\n+]\n+\n [[package]]\n name = \"core-foundation-sys\"\n version = \"0.8.7\"\n@@ -2801,9 +2811,9 @@ checksum = \"9a3a5bfb195931eeb336b2a7b4d761daec841b97f947d34394601737a7bba5e4\"\n \n [[package]]\n name = \"hyper\"\n-version = \"0.14.28\"\n+version = \"0.14.32\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"bf96e135eb83a2a8ddf766e426a841d8ddd7449d5f00d34ea02b41d2f19eef80\"\n+checksum = \"41dfc780fdec9373c01bae43289ea34c972e40ee3c9f6b3c8801a35f35586ce7\"\n dependencies = [\n  \"bytes\",\n  \"futures-channel\",\n@@ -2899,7 +2909,7 @@ version = \"0.9.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"880b8b1c98a5ec2a505c7c90db6d3f6f1f480af5655d9c5b55facc9382a5a5b5\"\n dependencies = [\n- \"hyper 0.14.28\",\n+ \"hyper 0.14.32\",\n  \"pin-project\",\n  \"tokio\",\n  \"tokio-tungstenite\",\n@@ -2908,9 +2918,9 @@ dependencies = [\n \n [[package]]\n name = \"hyper-util\"\n-version = \"0.1.14\"\n+version = \"0.1.17\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"dc2fdfdbff08affe55bb779f33b053aa1fe5dd5b54c257343c17edfa55711bdb\"\n+checksum = \"3c6995591a8f1380fcb4ba966a252a4b29188d51d2b89e3a252f5305be65aea8\"\n dependencies = [\n  \"base64 0.22.1\",\n  \"bytes\",\n@@ -3839,15 +3849,6 @@ dependencies = [\n  \"zerocopy-derive\",\n ]\n \n-[[package]]\n-name = \"malloc_buf\"\n-version = \"0.0.6\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"62bb907fe88d54d8d9ce32a3cceab4218ed2f6b7d35617cafe9adf84e43919cb\"\n-dependencies = [\n- \"libc\",\n-]\n-\n [[package]]\n name = \"managed\"\n version = \"0.8.0\"\n@@ -4193,7 +4194,7 @@ dependencies = [\n  \"openssl-probe\",\n  \"openssl-sys\",\n  \"schannel\",\n- \"security-framework\",\n+ \"security-framework 2.8.2\",\n  \"security-framework-sys\",\n  \"tempfile\",\n ]\n@@ -4642,12 +4643,28 @@ dependencies = [\n ]\n \n [[package]]\n-name = \"objc\"\n-version = \"0.2.7\"\n+name = \"objc2\"\n+version = \"0.6.3\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"b7c2599ce0ec54857b29ce62166b0ed9b4f6f1a70ccc9a71165b6154caca8c05\"\n+dependencies = [\n+ \"objc2-encode\",\n+]\n+\n+[[package]]\n+name = \"objc2-encode\"\n+version = \"4.1.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"915b1b472bc21c53464d6c8461c9d3af805ba1ef837e1cac254428f4a77177b1\"\n+checksum = \"ef25abbcd74fb2609453eb695bd2f860d389e457f67dc17cafc8b8cbc89d0c33\"\n+\n+[[package]]\n+name = \"objc2-foundation\"\n+version = \"0.3.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"e3e0adef53c21f888deb4fa59fc59f7eb17404926ee8a6f59f5df0fd7f9f3272\"\n dependencies = [\n- \"malloc_buf\",\n+ \"bitflags 2.9.1\",\n+ \"objc2\",\n ]\n \n [[package]]\n@@ -4713,9 +4730,9 @@ dependencies = [\n \n [[package]]\n name = \"openssl-probe\"\n-version = \"0.1.5\"\n+version = \"0.1.6\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"ff011a302c396a5197692431fc1948019154afc178baf7d8e37367442a4601cf\"\n+checksum = \"d05e27ee213611ffe7d6348b942e8f942b37114c00cc03cec254295a4a17852e\"\n \n [[package]]\n name = \"openssl-sys\"\n@@ -5650,12 +5667,6 @@ dependencies = [\n  \"rgb\",\n ]\n \n-[[package]]\n-name = \"raw-window-handle\"\n-version = \"0.5.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"f2ff9a1f06a88b01621b7ae906ef0211290d1c8a168a15542486a8f61c0833b9\"\n-\n [[package]]\n name = \"rayon\"\n version = \"1.10.0\"\n@@ -5844,9 +5855,9 @@ checksum = \"e3a8614ee435691de62bcffcf4a66d91b3594bf1428a5722e79103249a095690\"\n \n [[package]]\n name = \"reqwest\"\n-version = \"0.12.22\"\n+version = \"0.12.24\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"cbc931937e6ca3a06e3b6c0aa7841849b160a90351d6ab467a8b9b9959767531\"\n+checksum = \"9d0946410b9f7b082a427e4ef5c8ff541a88b357bc6c637c40db3a68ac70a36f\"\n dependencies = [\n  \"base64 0.22.1\",\n  \"bytes\",\n@@ -6095,9 +6106,9 @@ dependencies = [\n \n [[package]]\n name = \"rustls\"\n-version = \"0.23.20\"\n+version = \"0.23.33\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"5065c3f250cbd332cd894be57c40fa52387247659b14a2d6041d121547903b1b\"\n+checksum = \"751e04a496ca00bb97a5e043158d23d66b5aabf2e1d5aa2a0aaebb1aafe6f82c\"\n dependencies = [\n  \"once_cell\",\n  \"ring\",\n@@ -6109,40 +6120,31 @@ dependencies = [\n \n [[package]]\n name = \"rustls-native-certs\"\n-version = \"0.8.0\"\n+version = \"0.8.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"fcaf18a4f2be7326cd874a5fa579fae794320a0f388d365dca7e480e55f83f8a\"\n+checksum = \"9980d917ebb0c0536119ba501e90834767bffc3d60641457fd84a1f3fd337923\"\n dependencies = [\n  \"openssl-probe\",\n- \"rustls-pemfile\",\n  \"rustls-pki-types\",\n  \"schannel\",\n- \"security-framework\",\n-]\n-\n-[[package]]\n-name = \"rustls-pemfile\"\n-version = \"2.2.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"dce314e5fee3f39953d46bb63bb8a46d40c2f8fb7cc5a3b6cab2bde9721d6e50\"\n-dependencies = [\n- \"rustls-pki-types\",\n+ \"security-framework 3.5.1\",\n ]\n \n [[package]]\n name = \"rustls-pki-types\"\n-version = \"1.10.1\"\n+version = \"1.12.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"d2bf47e6ff922db3825eb750c4e2ff784c6ff8fb9e13046ef6a1d1c5401b0b37\"\n+checksum = \"229a4a4c221013e7e1f1a043678c5cc39fe5171437c88fb47151a21e6f5b5c79\"\n dependencies = [\n  \"web-time\",\n+ \"zeroize\",\n ]\n \n [[package]]\n name = \"rustls-webpki\"\n-version = \"0.102.8\"\n+version = \"0.103.7\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"64ca1bc8749bd4cf37b5ce386cc146580777b4e8572c7b97baf22c83f444bee9\"\n+checksum = \"e10b3f4191e8a80e6b43eebabfac91e5dcecebb27a71f04e820c47ec41d314bf\"\n dependencies = [\n  \"ring\",\n  \"rustls-pki-types\",\n@@ -6294,17 +6296,30 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"a332be01508d814fed64bf28f798a146d73792121129962fdf335bb3c49a4254\"\n dependencies = [\n  \"bitflags 1.3.2\",\n- \"core-foundation\",\n+ \"core-foundation 0.9.4\",\n+ \"core-foundation-sys\",\n+ \"libc\",\n+ \"security-framework-sys\",\n+]\n+\n+[[package]]\n+name = \"security-framework\"\n+version = \"3.5.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"b3297343eaf830f66ede390ea39da1d462b6b0c1b000f420d0a83f898bbbe6ef\"\n+dependencies = [\n+ \"bitflags 2.9.1\",\n+ \"core-foundation 0.10.1\",\n  \"core-foundation-sys\",\n  \"libc\",\n  \"security-framework-sys\",\n ]\n \n [[package]]\n name = \"security-framework-sys\"\n-version = \"2.8.0\"\n+version = \"2.15.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"31c9bb296072e961fcbd8853511dd39c2d8be2deb1e17c6860b1d30732b323b4\"\n+checksum = \"cc1f0cbffaac4852523ce30d8bd3c5cdc873501d96ff467ca09b6767bb8cd5c0\"\n dependencies = [\n  \"core-foundation-sys\",\n  \"libc\",\n@@ -9286,6 +9301,7 @@ dependencies = [\n  \"mockito\",\n  \"quick_cache\",\n  \"reqwest\",\n+ \"rustls\",\n  \"serde\",\n  \"tokio\",\n  \"turbo-rcstr\",\n@@ -9645,7 +9661,7 @@ dependencies = [\n  \"async-compression\",\n  \"auto-hash-map\",\n  \"futures\",\n- \"hyper 0.14.28\",\n+ \"hyper 0.14.32\",\n  \"hyper-tungstenite\",\n  \"mime\",\n  \"mime_guess\",\n@@ -11043,17 +11059,16 @@ dependencies = [\n \n [[package]]\n name = \"webbrowser\"\n-version = \"0.8.15\"\n+version = \"1.0.6\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"db67ae75a9405634f5882791678772c94ff5f16a66535aae186e26aa0841fc8b\"\n+checksum = \"00f1243ef785213e3a32fa0396093424a3a6ea566f9948497e5a2309261a4c97\"\n dependencies = [\n- \"core-foundation\",\n- \"home\",\n+ \"core-foundation 0.10.1\",\n  \"jni\",\n  \"log\",\n  \"ndk-context\",\n- \"objc\",\n- \"raw-window-handle\",\n+ \"objc2\",\n+ \"objc2-foundation\",\n  \"url\",\n  \"web-sys\",\n ]"
        },
        {
            "sha": "5ee9dfffa09e4d52532c799765aed16904e77458",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
            "patch": "@@ -414,7 +414,7 @@ rand = \"0.9.0\"\n rayon = \"1.10.0\"\n regex = \"1.10.6\"\n regress = \"0.10.4\"\n-reqwest = { version = \"0.12.22\", default-features = false }\n+reqwest = { version = \"0.12.24\", default-features = false }\n ringmap = \"0.1.3\"\n roaring = \"0.10.10\"\n rstest = \"0.16.0\"\n@@ -451,7 +451,7 @@ urlencoding = \"2.1.2\"\n uuid = \"1.18.1\"\n vergen = { version = \"9.0.6\", features = [\"cargo\"] }\n vergen-gitcl = { version = \"1.0.8\", features = [\"cargo\"] }\n-webbrowser = \"0.8.7\"\n+webbrowser = \"1.0.6\"\n inventory = \"0.3.21\"\n \n [patch.crates-io]"
        },
        {
            "sha": "b915c62d6ac451736108d96707aac36f95fff01f",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
            "patch": "@@ -10,7 +10,7 @@ use turbo_tasks::{\n     trace::TraceRawVcs,\n };\n use turbo_tasks_env::{EnvMap, ProcessEnv};\n-use turbo_tasks_fetch::FetchClient;\n+use turbo_tasks_fetch::FetchClientConfig;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::module_options::{\n     ConditionItem, ConditionPath, LoaderRuleItem, WebpackRules,\n@@ -1914,7 +1914,10 @@ impl NextConfig {\n     }\n \n     #[turbo_tasks::function]\n-    pub async fn fetch_client(&self, env: Vc<Box<dyn ProcessEnv>>) -> Result<Vc<FetchClient>> {\n+    pub async fn fetch_client(\n+        &self,\n+        env: Vc<Box<dyn ProcessEnv>>,\n+    ) -> Result<Vc<FetchClientConfig>> {\n         // Support both an env var and the experimental flag to provide more flexibility to\n         // developers on locked down systems, depending on if they want to configure this on a\n         // per-system or per-project basis.\n@@ -1928,7 +1931,7 @@ impl NextConfig {\n             })\n             .or(self.experimental.turbopack_use_system_tls_certs)\n             .unwrap_or(false);\n-        Ok(FetchClient {\n+        Ok(FetchClientConfig {\n             tls_built_in_webpki_certs: !use_system_tls_certs,\n             tls_built_in_native_certs: use_system_tls_certs,\n         }"
        },
        {
            "sha": "a9dbb51683e47fc02aba2f272bfce934c943d492",
            "filename": "crates/next-core/src/next_font/google/mod.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs?ref=aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
            "patch": "@@ -10,7 +10,7 @@ use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{Completion, FxIndexMap, ResolvedVc, Vc};\n use turbo_tasks_bytes::stream::SingleValue;\n use turbo_tasks_env::{CommandLineProcessEnv, ProcessEnv};\n-use turbo_tasks_fetch::{FetchClient, HttpResponseBody};\n+use turbo_tasks_fetch::{FetchClientConfig, HttpResponseBody};\n use turbo_tasks_fs::{\n     DiskFileSystem, File, FileContent, FileSystem, FileSystemPath,\n     json::parse_json_with_source_context,\n@@ -183,7 +183,7 @@ pub struct NextFontGoogleCssModuleReplacer {\n     project_path: FileSystemPath,\n     execution_context: ResolvedVc<ExecutionContext>,\n     next_mode: ResolvedVc<NextMode>,\n-    fetch_client: ResolvedVc<FetchClient>,\n+    fetch_client: ResolvedVc<FetchClientConfig>,\n }\n \n #[turbo_tasks::value_impl]\n@@ -193,7 +193,7 @@ impl NextFontGoogleCssModuleReplacer {\n         project_path: FileSystemPath,\n         execution_context: ResolvedVc<ExecutionContext>,\n         next_mode: ResolvedVc<NextMode>,\n-        fetch_client: ResolvedVc<FetchClient>,\n+        fetch_client: ResolvedVc<FetchClientConfig>,\n     ) -> Vc<Self> {\n         Self::cell(NextFontGoogleCssModuleReplacer {\n             project_path,\n@@ -376,13 +376,16 @@ struct NextFontGoogleFontFileOptions {\n #[turbo_tasks::value(shared)]\n pub struct NextFontGoogleFontFileReplacer {\n     project_path: FileSystemPath,\n-    fetch_client: ResolvedVc<FetchClient>,\n+    fetch_client: ResolvedVc<FetchClientConfig>,\n }\n \n #[turbo_tasks::value_impl]\n impl NextFontGoogleFontFileReplacer {\n     #[turbo_tasks::function]\n-    pub fn new(project_path: FileSystemPath, fetch_client: ResolvedVc<FetchClient>) -> Vc<Self> {\n+    pub fn new(\n+        project_path: FileSystemPath,\n+        fetch_client: ResolvedVc<FetchClientConfig>,\n+    ) -> Vc<Self> {\n         Self::cell(NextFontGoogleFontFileReplacer {\n             project_path,\n             fetch_client,\n@@ -670,7 +673,7 @@ fn font_file_options_from_query_map(query: &RcStr) -> Result<NextFontGoogleFontF\n }\n \n async fn fetch_real_stylesheet(\n-    fetch_client: Vc<FetchClient>,\n+    fetch_client: Vc<FetchClientConfig>,\n     stylesheet_url: RcStr,\n     css_virtual_path: FileSystemPath,\n ) -> Result<Option<Vc<RcStr>>> {\n@@ -680,7 +683,7 @@ async fn fetch_real_stylesheet(\n }\n \n async fn fetch_from_google_fonts(\n-    fetch_client: Vc<FetchClient>,\n+    fetch_client: Vc<FetchClientConfig>,\n     url: RcStr,\n     virtual_path: FileSystemPath,\n ) -> Result<Option<Vc<HttpResponseBody>>> {"
        },
        {
            "sha": "80f947b169189b486944bac1cd4f8c14de19cc02",
            "filename": "turbopack/crates/turbo-tasks-fetch/Cargo.toml",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbo-tasks-fetch%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbo-tasks-fetch%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2FCargo.toml?ref=aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
            "patch": "@@ -20,9 +20,12 @@ workspace = true\n [target.'cfg(all(target_os = \"windows\", target_arch = \"aarch64\"))'.dependencies]\n reqwest = { workspace = true, features = [\"native-tls\"] }\n \n-# If you modify this cfg, make sure you update `FetchClient::try_build_uncached_reqwest_client`.\n+# If you modify this cfg, make sure you update `FetchClient::try_build_uncached_reqwest_client`,\n+# `has_rustls_cause`, and `errors_on_tls_connection`\n [target.'cfg(not(any(all(target_os = \"windows\", target_arch = \"aarch64\"), target_arch=\"wasm32\")))'.dependencies]\n reqwest = { workspace = true, features = [\"rustls-tls-webpki-roots\", \"rustls-tls-native-roots\"] }\n+# we just need the `rustls::Error` type (no default features)\n+rustls = { version = \"0.23.0\", default-features = false }\n \n [dependencies]\n anyhow = { workspace = true }"
        },
        {
            "sha": "1f3e285040de09454cbbeb0aa66787ad098016d3",
            "filename": "turbopack/crates/turbo-tasks-fetch/src/client.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 10,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Fclient.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Fclient.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Fclient.rs?ref=aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
            "patch": "@@ -11,7 +11,7 @@ use turbo_tasks::{\n use crate::{FetchError, FetchResult, HttpResponse, HttpResponseBody};\n \n const MAX_CLIENTS: usize = 16;\n-static CLIENT_CACHE: LazyLock<Cache<ReadRef<FetchClient>, reqwest::Client>> =\n+static CLIENT_CACHE: LazyLock<Cache<ReadRef<FetchClientConfig>, reqwest::Client>> =\n     LazyLock::new(|| Cache::new(MAX_CLIENTS));\n \n #[derive(Hash, PartialEq, Eq, Serialize, Deserialize, NonLocalValue, Debug, TraceRawVcs)]\n@@ -29,7 +29,7 @@ pub enum ProxyConfig {\n /// factory cannot be a closure because closures do not implement `Eq` or `Hash`.\n #[turbo_tasks::value(shared)]\n #[derive(Hash)]\n-pub struct FetchClient {\n+pub struct FetchClientConfig {\n     /// Whether to load embedded webpki root certs with rustls. Default is true.\n     ///\n     /// Ignored for:\n@@ -45,7 +45,7 @@ pub struct FetchClient {\n     pub tls_built_in_native_certs: bool,\n }\n \n-impl Default for FetchClient {\n+impl Default for FetchClientConfig {\n     fn default() -> Self {\n         Self {\n             tls_built_in_webpki_certs: true,\n@@ -54,7 +54,7 @@ impl Default for FetchClient {\n     }\n }\n \n-impl FetchClient {\n+impl FetchClientConfig {\n     /// Returns a cached instance of `reqwest::Client` it exists, otherwise constructs a new one.\n     ///\n     /// The cache is bound in size to prevent accidental blowups or leaks. However, in practice,\n@@ -68,7 +68,7 @@ impl FetchClient {\n     /// cached for some amount of time, but ultimately transient (e.g. using\n     /// [`turbo_tasks::mark_session_dependent`]).\n     pub fn try_get_cached_reqwest_client(\n-        self: ReadRef<FetchClient>,\n+        self: ReadRef<FetchClientConfig>,\n     ) -> reqwest::Result<reqwest::Client> {\n         CLIENT_CACHE.get_or_insert_with(&self, {\n             let this = ReadRef::clone(&self);\n@@ -85,6 +85,7 @@ impl FetchClient {\n             target_arch = \"wasm32\"\n         )))]\n         let client_builder = client_builder\n+            .use_rustls_tls()\n             .tls_built_in_root_certs(false)\n             .tls_built_in_webpki_certs(self.tls_built_in_webpki_certs)\n             .tls_built_in_native_certs(self.tls_built_in_native_certs);\n@@ -94,15 +95,16 @@ impl FetchClient {\n }\n \n #[turbo_tasks::value_impl]\n-impl FetchClient {\n+impl FetchClientConfig {\n     #[turbo_tasks::function(network)]\n     pub async fn fetch(\n-        self: Vc<FetchClient>,\n+        self: Vc<FetchClientConfig>,\n         url: RcStr,\n         user_agent: Option<RcStr>,\n     ) -> Result<Vc<FetchResult>> {\n         let url_ref = &*url;\n         let this = self.await?;\n+        let tls_built_in_native_certs = this.tls_built_in_native_certs;\n         let response_result: reqwest::Result<HttpResponse> = async move {\n             let reqwest_client = this.try_get_cached_reqwest_client()?;\n \n@@ -137,9 +139,12 @@ impl FetchClient {\n             Err(err) => {\n                 // the client failed to construct or the HTTP request failed\n                 mark_session_dependent();\n-                Ok(Vc::cell(Err(\n-                    FetchError::from_reqwest_error(&err, &url).resolved_cell()\n-                )))\n+                Ok(Vc::cell(Err(FetchError::from_reqwest_error(\n+                    &err,\n+                    &url,\n+                    tls_built_in_native_certs,\n+                )\n+                .resolved_cell())))\n             }\n         }\n     }"
        },
        {
            "sha": "eee81e1a352e6ea9adf49e37eb8942dd99ee18e2",
            "filename": "turbopack/crates/turbo-tasks-fetch/src/error.rs",
            "status": "modified",
            "additions": 97,
            "deletions": 15,
            "changes": 112,
            "blob_url": "https://github.com/vercel/next.js/blob/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Ferror.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Ferror.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Ferror.rs?ref=aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
            "patch": "@@ -7,7 +7,10 @@ use turbopack_core::issue::{Issue, IssueSeverity, IssueStage, OptionStyledString\n #[derive(Debug)]\n #[turbo_tasks::value(shared)]\n pub enum FetchErrorKind {\n-    Connect,\n+    Connect {\n+        has_system_certs: bool,\n+        has_rustls_cause: bool,\n+    },\n     Timeout,\n     Status(u16),\n     Other,\n@@ -20,10 +23,51 @@ pub struct FetchError {\n     pub detail: ResolvedVc<StyledString>,\n }\n \n+/// Attempt to determine if there's a `rustls::Error` in the error's source chain.\n+///\n+/// This logic is fragile (e.g. depends that our copy of rustls and the version that reqwest uses\n+/// match exactly), but it's covered by unit tests. This seems slightly better than using `Display`\n+/// or `Debug` and inspecting the string.\n+fn has_rustls_cause(err: &reqwest::Error) -> bool {\n+    // make sure this cfg matches the one in `Cargo.toml`!\n+    #[cfg(not(any(\n+        all(target_os = \"windows\", target_arch = \"aarch64\"),\n+        target_arch = \"wasm32\"\n+    )))]\n+    {\n+        let mut source = std::error::Error::source(err);\n+        while let Some(err) = source {\n+            if err.downcast_ref::<rustls::Error>().is_some() {\n+                return true;\n+            }\n+            if let Some(err) = err.downcast_ref::<std::io::Error>() {\n+                // `std::io::Error`'s `source` implementation returns the source of the wrapped\n+                // error instead of the wrapped error itself, so we need to special-case this,\n+                // otherwise we risk skipping over the rustls error.\n+                source = err.get_ref().map(|e| e as &dyn std::error::Error);\n+            } else {\n+                source = std::error::Error::source(err);\n+            }\n+        }\n+        return false;\n+    };\n+\n+    // uses native-tls\n+    #[cfg(all(target_os = \"windows\", target_arch = \"aarch64\"))]\n+    return false;\n+}\n+\n impl FetchError {\n-    pub(crate) fn from_reqwest_error(error: &reqwest::Error, url: &str) -> FetchError {\n+    pub(crate) fn from_reqwest_error(\n+        error: &reqwest::Error,\n+        url: &str,\n+        webpki_certs_only: bool,\n+    ) -> FetchError {\n         let kind = if error.is_connect() {\n-            FetchErrorKind::Connect\n+            FetchErrorKind::Connect {\n+                has_system_certs: webpki_certs_only,\n+                has_rustls_cause: has_rustls_cause(error),\n+            }\n         } else if error.is_timeout() {\n             FetchErrorKind::Timeout\n         } else if let Some(status) = error.status() {\n@@ -95,19 +139,57 @@ impl Issue for FetchIssue {\n         let kind = &*self.kind.await?;\n \n         Ok(Vc::cell(Some(\n-            StyledString::Text(match kind {\n-                FetchErrorKind::Connect => {\n-                    format!(\"There was an issue establishing a connection while requesting {url}.\")\n-                        .into()\n-                }\n-                FetchErrorKind::Status(status) => {\n-                    format!(\"Received response with status {status} when requesting {url}\").into()\n-                }\n-                FetchErrorKind::Timeout => {\n-                    format!(\"Connection timed out when requesting {url}\").into()\n+            match kind {\n+                FetchErrorKind::Connect {\n+                    has_system_certs,\n+                    has_rustls_cause,\n+                } => {\n+                    let base_message = StyledString::Line(vec![\n+                        StyledString::Text(rcstr!(\n+                            \"There was an issue establishing a connection while requesting \"\n+                        )),\n+                        StyledString::Code(url.clone()),\n+                    ]);\n+                    if !*has_system_certs && *has_rustls_cause {\n+                        StyledString::Stack(vec![\n+                            base_message,\n+                            StyledString::Line(vec![\n+                                StyledString::Strong(rcstr!(\"Hint: \")),\n+                                StyledString::Text(rcstr!(\n+                                    \"It looks like this error was TLS-related. Try enabling \\\n+                                     system TLS certificates with \"\n+                                )),\n+                                StyledString::Code(rcstr!(\n+                                    \"NEXT_TURBOPACK_EXPERIMENTAL_USE_SYSTEM_TLS_CERTS=1\"\n+                                )),\n+                                StyledString::Text(rcstr!(\" as an environment variable, or set \")),\n+                                StyledString::Code(rcstr!(\n+                                    \"experimental.turbopackUseSystemTlsCerts\"\n+                                )),\n+                                StyledString::Text(rcstr!(\" in your \")),\n+                                StyledString::Code(rcstr!(\"next.config.js\")),\n+                                StyledString::Text(rcstr!(\" file.\")),\n+                            ]),\n+                        ])\n+                    } else {\n+                        base_message\n+                    }\n                 }\n-                FetchErrorKind::Other => format!(\"There was an issue requesting {url}\").into(),\n-            })\n+                FetchErrorKind::Status(status) => StyledString::Line(vec![\n+                    StyledString::Text(rcstr!(\"Received response with status \")),\n+                    StyledString::Code(RcStr::from(status.to_string())),\n+                    StyledString::Text(rcstr!(\" when requesting \")),\n+                    StyledString::Code(url.clone()),\n+                ]),\n+                FetchErrorKind::Timeout => StyledString::Line(vec![\n+                    StyledString::Text(rcstr!(\"Connection timed out when requesting \")),\n+                    StyledString::Code(url.clone()),\n+                ]),\n+                FetchErrorKind::Other => StyledString::Line(vec![\n+                    StyledString::Text(rcstr!(\"There was an issue requesting \")),\n+                    StyledString::Code(url.clone()),\n+                ]),\n+            }\n             .resolved_cell(),\n         )))\n     }"
        },
        {
            "sha": "2a9444b3f0b5b37245f558949e844de7f3ee3816",
            "filename": "turbopack/crates/turbo-tasks-fetch/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Flib.rs?ref=aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
            "patch": "@@ -8,8 +8,8 @@ mod response;\n \n pub use crate::{\n     client::{\n-        __test_only_reqwest_client_cache_clear, __test_only_reqwest_client_cache_len, FetchClient,\n-        ProxyConfig,\n+        __test_only_reqwest_client_cache_clear, __test_only_reqwest_client_cache_len,\n+        FetchClientConfig, ProxyConfig,\n     },\n     error::{FetchError, FetchErrorKind, FetchIssue},\n     response::{FetchResult, HttpResponse, HttpResponseBody},"
        },
        {
            "sha": "0f39f76f56334c6e5d983700b600dfe9e1805d3d",
            "filename": "turbopack/crates/turbo-tasks-fetch/tests/fetch.rs",
            "status": "modified",
            "additions": 86,
            "deletions": 24,
            "changes": 110,
            "blob_url": "https://github.com/vercel/next.js/blob/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ffetch.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ffetch.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ffetch.rs?ref=aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
            "patch": "@@ -5,12 +5,12 @@ use tokio::sync::Mutex as TokioMutex;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::Vc;\n use turbo_tasks_fetch::{\n-    __test_only_reqwest_client_cache_clear, __test_only_reqwest_client_cache_len, FetchClient,\n-    FetchErrorKind,\n+    __test_only_reqwest_client_cache_clear, __test_only_reqwest_client_cache_len,\n+    FetchClientConfig, FetchErrorKind,\n };\n use turbo_tasks_fs::{DiskFileSystem, FileSystem, FileSystemPath};\n use turbo_tasks_testing::{Registration, register, run_once};\n-use turbopack_core::issue::{Issue, IssueSeverity, StyledString};\n+use turbopack_core::issue::{Issue, IssueSeverity};\n \n static REGISTRATION: Registration = register!(turbo_tasks_fetch::register);\n \n@@ -29,7 +29,7 @@ async fn basic_get() {\n             .create_async()\n             .await;\n \n-        let client_vc = FetchClient::default().cell();\n+        let client_vc = FetchClientConfig::default().cell();\n         let response = &*client_vc\n             .fetch(\n                 RcStr::from(format!(\"{}/foo.woff\", server.url())),\n@@ -61,9 +61,7 @@ async fn sends_user_agent() {\n             .create_async()\n             .await;\n \n-        eprintln!(\"{}\", server.url());\n-\n-        let client_vc = FetchClient::default().cell();\n+        let client_vc = FetchClientConfig::default().cell();\n         let response = &*client_vc\n             .fetch(\n                 RcStr::from(format!(\"{}/foo.woff\", server.url())),\n@@ -98,7 +96,7 @@ async fn invalidation_does_not_invalidate() {\n             .await;\n \n         let url = RcStr::from(format!(\"{}/foo.woff\", server.url()));\n-        let client_vc = FetchClient::default().cell();\n+        let client_vc = FetchClientConfig::default().cell();\n         let response = &*client_vc\n             .fetch(url.clone(), /* user_agent */ None)\n             .await?\n@@ -138,22 +136,30 @@ async fn errors_on_failed_connection() {\n         // `ECONNREFUSED`.\n         // Other values (e.g. domain name, reserved IP address block) may result in long timeouts.\n         let url = rcstr!(\"http://127.0.0.1:0/foo.woff\");\n-        let client_vc = FetchClient::default().cell();\n+        let client_vc = FetchClientConfig::default().cell();\n         let response_vc = client_vc.fetch(url.clone(), None);\n         let err_vc = &*response_vc.await?.unwrap_err();\n         let err = err_vc.await?;\n \n-        assert_eq!(*err.kind.await?, FetchErrorKind::Connect);\n+        assert!(matches!(\n+            *err.kind.await?,\n+            FetchErrorKind::Connect {\n+                has_rustls_cause: false,\n+                ..\n+            }\n+        ));\n         assert_eq!(*err.url.await?, url);\n \n         let issue = err_vc.to_issue(IssueSeverity::Error, get_issue_context().owned().await?);\n         assert_eq!(issue.await?.severity(), IssueSeverity::Error);\n         assert_eq!(\n-            *issue.description().await?.unwrap().await?,\n-            StyledString::Text(rcstr!(\n-                \"There was an issue establishing a connection while requesting \\\n-                http://127.0.0.1:0/foo.woff.\"\n-            ))\n+            issue\n+                .description()\n+                .await?\n+                .unwrap()\n+                .await?\n+                .to_unstyled_string(),\n+            \"There was an issue establishing a connection while requesting http://127.0.0.1:0/foo.woff\"\n         );\n         anyhow::Ok(())\n     })\n@@ -173,7 +179,7 @@ async fn errors_on_404() {\n             .await;\n \n         let url = RcStr::from(server.url());\n-        let client_vc = FetchClient::default().cell();\n+        let client_vc = FetchClientConfig::default().cell();\n         let response_vc = client_vc.fetch(url.clone(), None);\n         let err_vc = &*response_vc.await?.unwrap_err();\n         let err = err_vc.await?;\n@@ -185,21 +191,77 @@ async fn errors_on_404() {\n         let issue = err_vc.to_issue(IssueSeverity::Error, get_issue_context().owned().await?);\n         assert_eq!(issue.await?.severity(), IssueSeverity::Error);\n         assert_eq!(\n-            *issue.description().await?.unwrap().await?,\n-            StyledString::Text(RcStr::from(format!(\n-                \"Received response with status 404 when requesting {url}\"\n-            )))\n+            issue\n+                .description()\n+                .await?\n+                .unwrap()\n+                .await?\n+                .to_unstyled_string(),\n+            format!(\"Received response with status 404 when requesting {url}\")\n         );\n         anyhow::Ok(())\n     })\n     .await\n     .unwrap()\n }\n \n+#[cfg(not(any(\n+    all(target_os = \"windows\", target_arch = \"aarch64\"),\n+    target_arch = \"wasm32\"\n+)))]\n+#[tokio::test(flavor = \"multi_thread\", worker_threads = 2)]\n+async fn errors_on_tls_connection() {\n+    let _guard = GLOBAL_TEST_LOCK.lock().await;\n+    run_once(&REGISTRATION, || async {\n+        let mut server = mockito::Server::new_async().await;\n+        let _resource_mock = server\n+            .mock(\"GET\", \"/\")\n+            .with_body(\"responsebody\")\n+            .create_async()\n+            .await;\n+\n+        // construct an HTTPS url, but mockito runs an HTTP server, so this should fail to connect\n+        let url = RcStr::from(format!(\"https://{}\", server.socket_address()));\n+\n+        let client_vc = FetchClientConfig {\n+            tls_built_in_webpki_certs: true,\n+            tls_built_in_native_certs: false,\n+        }\n+        .cell();\n+\n+        let response_vc = client_vc.fetch(url.clone(), None);\n+        let err_vc = &*response_vc.await?.unwrap_err();\n+        let err = err_vc.await?;\n+\n+        assert_eq!(\n+            *err.kind.await?,\n+            FetchErrorKind::Connect {\n+                has_rustls_cause: true,\n+                has_system_certs: false,\n+            }\n+        );\n+\n+        let issue = err_vc.to_issue(IssueSeverity::Error, get_issue_context().owned().await?);\n+        let description = issue\n+            .description()\n+            .await?\n+            .unwrap()\n+            .await?\n+            .to_unstyled_string();\n+\n+        assert!(description.contains(\"NEXT_TURBOPACK_EXPERIMENTAL_USE_SYSTEM_TLS_CERTS=1\"));\n+        assert!(description.contains(\"experimental.turbopackUseSystemTlsCerts\"));\n+\n+        anyhow::Ok(())\n+    })\n+    .await\n+    .unwrap()\n+}\n+\n #[tokio::test(flavor = \"multi_thread\", worker_threads = 2)]\n async fn client_cache() {\n     // a simple fetch that should always succeed\n-    async fn simple_fetch(path: &str, client: FetchClient) -> anyhow::Result<()> {\n+    async fn simple_fetch(path: &str, client: FetchClientConfig) -> anyhow::Result<()> {\n         let mut server = mockito::Server::new_async().await;\n         let _resource_mock = server\n             .mock(\"GET\", &*format!(\"/{path}\"))\n@@ -233,7 +295,7 @@ async fn client_cache() {\n \n         simple_fetch(\n             \"/foo\",\n-            FetchClient {\n+            FetchClientConfig {\n                 tls_built_in_native_certs: false,\n                 ..Default::default()\n             },\n@@ -245,7 +307,7 @@ async fn client_cache() {\n         // the client is reused if the config is the same (by equality)\n         simple_fetch(\n             \"/bar\",\n-            FetchClient {\n+            FetchClientConfig {\n                 tls_built_in_native_certs: false,\n                 ..Default::default()\n             },\n@@ -257,7 +319,7 @@ async fn client_cache() {\n         // the client is recreated if the config is different\n         simple_fetch(\n             \"/bar\",\n-            FetchClient {\n+            FetchClientConfig {\n                 tls_built_in_native_certs: true,\n                 ..Default::default()\n             },"
        },
        {
            "sha": "afd7822d4397abe27dbd66a732358d7fd6b66e0b",
            "filename": "turbopack/crates/turbopack-core/src/issue/mod.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/aaaf82ca794eafd285bea8f1193fe1e1402fdf89/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs?ref=aaaf82ca794eafd285bea8f1193fe1e1402fdf89",
            "patch": "@@ -98,6 +98,26 @@ pub enum StyledString {\n     Strong(RcStr),\n }\n \n+impl StyledString {\n+    pub fn to_unstyled_string(&self) -> String {\n+        match self {\n+            StyledString::Line(items) => items\n+                .iter()\n+                .map(|item| item.to_unstyled_string())\n+                .collect::<Vec<_>>()\n+                .join(\"\"),\n+            StyledString::Stack(items) => items\n+                .iter()\n+                .map(|item| item.to_unstyled_string())\n+                .collect::<Vec<_>>()\n+                .join(\"\\n\"),\n+            StyledString::Text(s) | StyledString::Code(s) | StyledString::Strong(s) => {\n+                s.to_string()\n+            }\n+        }\n+    }\n+}\n+\n #[turbo_tasks::value_trait]\n pub trait Issue {\n     /// Severity allows the user to filter out unimportant issues, with Bug"
        }
    ],
    "stats": {
        "total": 437,
        "additions": 315,
        "deletions": 122
    }
}