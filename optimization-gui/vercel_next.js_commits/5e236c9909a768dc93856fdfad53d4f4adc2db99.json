{
    "author": "mischnic",
    "message": "Turbopack: ignore invalid sourcemaps for now (#76215)\n\nhttps://github.com/vercel/next.js/pull/75791 made the sourcemap handling stricter, it caused this when encountering invalid input source maps (i.e. the ones that are published to npm).\nLet's keep the old behavior for now (which is also what Webpack does). \n```\nCaused by:\n    0: Execution of run_inner_operation failed\n    1: Execution of run_test_operation failed\n    2: Execution of ModuleGraph::from_modules failed\n    3: Execution of SingleModuleGraph::new_with_entries failed\n    4: [project]/turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/input/index.js [test] (ecmascript)\n    5: Execution of primary_chunkable_referenced_modules failed\n    6: Execution of <EcmascriptModuleAsset as Module>::references failed\n    7: Execution of analyse_ecmascript_module failed\n    8: failed to analyse ecmascript module '[project]/turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/input/index.js [test] (ecmascript)'\n    9: Execution of <SourceMapReference as GenerateSourceMap>::generate_source_map failed\n   10: invalid type: string \"use client\", expected struct SourceMapJson at line 1 column 12\n```",
    "sha": "5e236c9909a768dc93856fdfad53d4f4adc2db99",
    "files": [
        {
            "sha": "4e192992f154b148a4223412fbdd97be30ce55a4",
            "filename": "turbopack/crates/turbopack-core/src/source_map/utils.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs?ref=5e236c9909a768dc93856fdfad53d4f4adc2db99",
            "patch": "@@ -41,6 +41,8 @@ struct SourceMapSectionItemJson {\n     map: SourceMapJson,\n }\n \n+// TODO this could be made (much) more efficient by not even de- and serializing other fields\n+// (apart from `sources`) and just keep storing them as strings.\n #[derive(Serialize, Deserialize)]\n #[serde(rename_all = \"camelCase\")]\n struct SourceMapJson {\n@@ -137,7 +139,10 @@ pub async fn resolve_source_map_sources(\n         return Ok(None);\n     };\n \n-    let mut map: SourceMapJson = serde_json::from_reader(map.read())?;\n+    let Ok(mut map): serde_json::Result<SourceMapJson> = serde_json::from_reader(map.read()) else {\n+        // Silently ignore invalid sourcemaps\n+        return Ok(None);\n+    };\n \n     resolve_map(&mut map, origin).await?;\n     for section in map.sections.iter_mut().flatten() {\n@@ -158,17 +163,18 @@ pub async fn fileify_source_map(\n         return Ok(None);\n     };\n \n+    let Ok(mut map): serde_json::Result<SourceMapJson> = serde_json::from_reader(map.read()) else {\n+        // Silently ignore invalid sourcemaps\n+        return Ok(None);\n+    };\n+\n     let context_fs = context_path.fs();\n     let context_fs = &*Vc::try_resolve_downcast_type::<DiskFileSystem>(context_fs)\n         .await?\n         .context(\"Expected the chunking context to have a DiskFileSystem\")?\n         .await?;\n     let prefix = format!(\"{}///[{}]/\", SOURCE_URL_PROTOCOL, context_fs.name());\n \n-    // TODO this could be made (much) more efficient by not even de- and serializing other fields\n-    // (apart from `sources`) and just keep storing them as strings.\n-    let mut map: SourceMapJson = serde_json::from_reader(map.read())?;\n-\n     let transform_source = async |src: &mut Option<String>| {\n         if let Some(src) = src {\n             if let Some(src_rest) = src.strip_prefix(&prefix) {"
        },
        {
            "sha": "31d54e21661c495d8ad53e38f1728c48a5e50015",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/input/index.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Finput%2Findex.js?ref=5e236c9909a768dc93856fdfad53d4f4adc2db99",
            "patch": "@@ -0,0 +1,2 @@\n+console.log(\"test\")\n+//# sourceMappingURL=index.js.map"
        },
        {
            "sha": "7153406af520afee1c2f0de4f33c1c18b3563131",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/input/index.js.map",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Finput%2Findex.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Finput%2Findex.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Finput%2Findex.js.map?ref=5e236c9909a768dc93856fdfad53d4f4adc2db99",
            "patch": "@@ -0,0 +1,4 @@\n+\"use client\";\n+{\n+  \"version\": 3\n+}"
        },
        {
            "sha": "997fd23f36abb197147b42b8769d6ada831c880b",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/output/4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_66486b.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_66486b.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_66486b.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_66486b.js?ref=5e236c9909a768dc93856fdfad53d4f4adc2db99",
            "patch": "@@ -0,0 +1,6 @@\n+(globalThis.TURBOPACK = globalThis.TURBOPACK || []).push([\n+    \"output/4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_66486b.js\",\n+    {},\n+    {\"otherChunks\":[\"output/4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js\"],\"runtimeModuleIds\":[\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/input/index.js [test] (ecmascript)\"]}\n+]);\n+// Dummy runtime\n\\ No newline at end of file"
        },
        {
            "sha": "c15d7ec00382d3604310ddb8b53cbdb90d9e1942",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/output/4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_66486b.js.map",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_66486b.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_66486b.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_66486b.js.map?ref=5e236c9909a768dc93856fdfad53d4f4adc2db99",
            "patch": "@@ -0,0 +1,5 @@\n+{\n+  \"version\": 3,\n+  \"sources\": [],\n+  \"sections\": []\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "1fb89598d117798ff36f3c59ec49532189e20547",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/output/4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js?ref=5e236c9909a768dc93856fdfad53d4f4adc2db99",
            "patch": "@@ -0,0 +1,12 @@\n+(globalThis.TURBOPACK = globalThis.TURBOPACK || []).push([\"output/4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js\", {\n+\n+\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/input/index.js [test] (ecmascript)\": (function(__turbopack_context__) {\n+\n+var { g: global, d: __dirname, m: module, e: exports } = __turbopack_context__;\n+{\n+console.log(\"test\") //# sourceMappingURL=index.js.map\n+;\n+}}),\n+}]);\n+\n+//# sourceMappingURL=4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js.map\n\\ No newline at end of file"
        },
        {
            "sha": "be7cbfe39152a51875d384e649b78151fe0e0bd9",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/output/4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js.map",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/5e236c9909a768dc93856fdfad53d4f4adc2db99/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finvalid%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_source_maps_invalid_input_index_fc734e.js.map?ref=5e236c9909a768dc93856fdfad53d4f4adc2db99",
            "patch": "@@ -0,0 +1,7 @@\n+{\n+  \"version\": 3,\n+  \"sources\": [],\n+  \"sections\": [\n+    {\"offset\": {\"line\": 6, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/source_maps/invalid/input/index.js\"],\"sourcesContent\":[\"console.log(\\\"test\\\")\\n//# sourceMappingURL=index.js.map\\n\"],\"names\":[],\"mappings\":\"AAAA,QAAQ,GAAG,CAAC,QACZ,iCAAiC\"}},\n+    {\"offset\": {\"line\": 8, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[],\"names\":[],\"mappings\":\"A\"}}]\n+}\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 47,
        "deletions": 5
    }
}