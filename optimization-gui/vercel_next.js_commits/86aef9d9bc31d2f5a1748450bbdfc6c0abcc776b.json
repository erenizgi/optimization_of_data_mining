{
    "author": "eps1lon",
    "message": "Only log unrecoverable SSR shell errors once (#76484)",
    "sha": "86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b",
    "files": [
        {
            "sha": "5858284a196959c707076fe35432abf632569459",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 35,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b",
            "patch": "@@ -26,8 +26,6 @@ import { createInitialRouterState } from './components/router-reducer/create-ini\n import { MissingSlotContext } from '../shared/lib/app-router-context.shared-runtime'\n import { setAppBuildId } from './app-build-id'\n import { shouldRenderRootLevelErrorOverlay } from './lib/is-error-thrown-while-rendering-rsc'\n-import { handleClientError } from './components/errors/use-error-handler'\n-import { isNextRouterError } from './components/is-next-router-error'\n \n /// <reference types=\"react-dom/experimental\" />\n \n@@ -231,16 +229,6 @@ function Root({ children }: React.PropsWithChildren<{}>) {\n     }, [])\n   }\n \n-  if (process.env.NODE_ENV !== 'production') {\n-    const ssrError = devQueueSsrError()\n-    // eslint-disable-next-line react-hooks/rules-of-hooks\n-    React.useEffect(() => {\n-      if (ssrError) {\n-        handleClientError(ssrError, [])\n-      }\n-    }, [ssrError])\n-  }\n-\n   return children\n }\n \n@@ -295,26 +283,3 @@ export function hydrate() {\n     linkGc()\n   }\n }\n-\n-function devQueueSsrError(): Error | undefined {\n-  const ssrErrorTemplateTag = document.querySelector(\n-    'template[data-next-error-message]'\n-  )\n-  if (ssrErrorTemplateTag) {\n-    const message: string = ssrErrorTemplateTag.getAttribute(\n-      'data-next-error-message'\n-    )!\n-    const stack = ssrErrorTemplateTag.getAttribute('data-next-error-stack')\n-    const digest = ssrErrorTemplateTag.getAttribute('data-next-error-digest')\n-    const error = new Error(message)\n-    if (digest) {\n-      ;(error as any).digest = digest\n-    }\n-    // Skip Next.js SSR'd internal errors that which will be handled by the error boundaries.\n-    if (isNextRouterError(error)) {\n-      return\n-    }\n-    error.stack = stack || ''\n-    return error\n-  }\n-}"
        },
        {
            "sha": "b03ae197521893632cef5145cdea05d5a592d296",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/app-dev-overlay.tsx",
            "status": "modified",
            "additions": 54,
            "deletions": 1,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay.tsx?ref=86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b",
            "patch": "@@ -1,10 +1,62 @@\n import type { OverlayState } from '../shared'\n import type { GlobalErrorComponent } from '../../error-boundary'\n \n-import { useState } from 'react'\n+import { useEffect, useState } from 'react'\n import { AppDevOverlayErrorBoundary } from './app-dev-overlay-error-boundary'\n import { FontStyles } from '../font/font-styles'\n import { DevOverlay } from '../ui/dev-overlay'\n+import { handleClientError } from '../../errors/use-error-handler'\n+import { isNextRouterError } from '../../is-next-router-error'\n+\n+function readSsrError(): Error | null {\n+  if (typeof document === 'undefined') {\n+    return null\n+  }\n+\n+  const ssrErrorTemplateTag = document.querySelector(\n+    'template[data-next-error-message]'\n+  )\n+  if (ssrErrorTemplateTag) {\n+    const message: string = ssrErrorTemplateTag.getAttribute(\n+      'data-next-error-message'\n+    )!\n+    const stack = ssrErrorTemplateTag.getAttribute('data-next-error-stack')\n+    const digest = ssrErrorTemplateTag.getAttribute('data-next-error-digest')\n+    const error = new Error(message)\n+    if (digest) {\n+      ;(error as any).digest = digest\n+    }\n+    // Skip Next.js SSR'd internal errors that which will be handled by the error boundaries.\n+    if (isNextRouterError(error)) {\n+      return null\n+    }\n+    error.stack = stack || ''\n+    return error\n+  }\n+\n+  return null\n+}\n+\n+// Needs to be in the same error boundary as the shell.\n+// If it commits, we know we recovered from an SSR error.\n+// If it doesn't commit, we errored again and React will take care of error reporting.\n+function ReplaySsrOnlyErrors() {\n+  if (process.env.NODE_ENV !== 'production') {\n+    // Need to read during render. The attributes will be gone after commit.\n+    const ssrError = readSsrError()\n+    // eslint-disable-next-line react-hooks/rules-of-hooks\n+    useEffect(() => {\n+      if (ssrError !== null) {\n+        // TODO(veil): Produces wrong Owner Stack\n+        // TODO(veil): Mark as recoverable error\n+        // TODO(veil): console.error\n+        handleClientError(ssrError, [])\n+      }\n+    }, [ssrError])\n+  }\n+\n+  return null\n+}\n \n export function AppDevOverlay({\n   state,\n@@ -23,6 +75,7 @@ export function AppDevOverlay({\n         globalError={globalError}\n         onError={setIsErrorOverlayOpen}\n       >\n+        <ReplaySsrOnlyErrors />\n         {children}\n       </AppDevOverlayErrorBoundary>\n "
        },
        {
            "sha": "7f4d3aa2a145b68bdbe8184b776144632260c9f2",
            "filename": "test/development/acceptance-app/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts?ref=86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b",
            "patch": "@@ -90,7 +90,7 @@ describe('ReactRefreshLogBox app', () => {\n     if (isTurbopack) {\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"count\": 2,\n+         \"count\": 1,\n          \"description\": \"Error: no\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n@@ -106,7 +106,7 @@ describe('ReactRefreshLogBox app', () => {\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"count\": 3,\n+         \"count\": 2,\n          \"description\": \"Error: no\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n@@ -363,7 +363,7 @@ describe('ReactRefreshLogBox app', () => {\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"count\": 2,\n+         \"count\": 1,\n          \"description\": \"Error: \",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n@@ -1642,7 +1642,7 @@ export default function Home() {\n       // FIXME: display the sourcemapped stack frames\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"count\": 2,\n+         \"count\": 1,\n          \"description\": \"Error: utils error\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n@@ -1659,7 +1659,7 @@ export default function Home() {\n       // FIXME: Webpack stack frames are not source mapped\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"count\": 3,\n+         \"count\": 2,\n          \"description\": \"Error: utils error\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\","
        },
        {
            "sha": "967033683ce4cc8594da28c8ac23d73bbc88efcc",
            "filename": "test/development/acceptance-app/hydration-error.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts?ref=86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b",
            "patch": "@@ -217,6 +217,7 @@ describe('Error overlay for hydration errors in App router', () => {\n            <HotReload assetPrefix=\"\" globalError={[...]}>\n              <AppDevOverlay state={{nextId:1, ...}} globalError={[...]}>\n                <AppDevOverlayErrorBoundary globalError={[...]} onError={function bound dispatchSetState}>\n+                 <ReplaySsrOnlyErrors>\n                  <DevRootHTTPAccessFallbackBoundary>\n                    <HTTPAccessFallbackBoundary notFound={<NotAllowedRootHTTPFallbackError>}>\n                      <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<NotAllowedRootHTTPFallbackError>} ...>\n@@ -240,6 +241,7 @@ describe('Error overlay for hydration errors in App router', () => {\n            <HotReload assetPrefix=\"\" globalError={[...]}>\n              <AppDevOverlay state={{nextId:1, ...}} globalError={[...]}>\n                <AppDevOverlayErrorBoundary globalError={[...]} onError={function bound dispatchSetState}>\n+                 <ReplaySsrOnlyErrors>\n                  <DevRootHTTPAccessFallbackBoundary>\n                    <HTTPAccessFallbackBoundary notFound={<NotAllowedRootHTTPFallbackError>}>\n                      <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<NotAllowedRootHTTPFallbackError>} ...>"
        },
        {
            "sha": "896a92cd559bdf596c406ea137d80fc562161202",
            "filename": "test/development/app-dir/owner-stack/owner-stack.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fdevelopment%2Fapp-dir%2Fowner-stack%2Fowner-stack.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fdevelopment%2Fapp-dir%2Fowner-stack%2Fowner-stack.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fowner-stack%2Fowner-stack.test.ts?ref=86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b",
            "patch": "@@ -139,10 +139,9 @@ describe('app-dir - owner-stack', () => {\n       },\n     })\n \n-    // TODO(veil): Should only display one error.\n     await expect(browser).toDisplayRedbox(`\n      {\n-       \"count\": 2,\n+       \"count\": 1,\n        \"description\": \"Error: ssr error\",\n        \"environmentLabel\": null,\n        \"label\": \"Unhandled Runtime Error\","
        },
        {
            "sha": "5e59212e602d378b47279177587e5ca960ac0ed3",
            "filename": "test/development/app-dir/ssr-only-error/app/page.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fapp%2Fpage.tsx?ref=86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b",
            "patch": "@@ -1,8 +1,12 @@\n 'use client'\n \n-export default function Page() {\n+function Component() {\n   if (typeof window === 'undefined') {\n     throw new Error('SSR only error')\n   }\n   return <p>hello world</p>\n }\n+\n+export default function Page() {\n+  return <Component />\n+}"
        },
        {
            "sha": "12f99708ddbe837d6e063e6b09e152409eda5f38",
            "filename": "test/development/app-dir/ssr-only-error/ssr-only-error.test.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 27,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fssr-only-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fssr-only-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fssr-only-error.test.ts?ref=86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b",
            "patch": "@@ -1,11 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import {\n-  assertNoRedbox,\n-  getRedboxDescription,\n-  getRedboxSource,\n-  hasErrorToast,\n-  openRedbox,\n-} from 'next-test-utils'\n+import { assertNoRedbox, hasErrorToast } from 'next-test-utils'\n \n describe('ssr-only-error', () => {\n   const { next } = nextTestSetup({\n@@ -15,29 +9,19 @@ describe('ssr-only-error', () => {\n   it('should show ssr only error in error overlay', async () => {\n     const browser = await next.browser('/')\n \n-    // Ensure it's not like server error that is shown by default\n-    await hasErrorToast(browser)\n-\n-    await openRedbox(browser)\n-\n-    const description = await getRedboxDescription(browser)\n-    const source = await getRedboxSource(browser)\n-\n-    expect({\n-      description,\n-      source,\n-    }).toMatchInlineSnapshot(`\n+    // TODO(veil): Missing Owner Stack\n+    await expect(browser).toDisplayCollapsedRedbox(`\n      {\n+       \"count\": 1,\n        \"description\": \"Error: SSR only error\",\n-       \"source\": \"app/page.tsx (5:11) @ Page\n-\n-       3 | export default function Page() {\n-       4 |   if (typeof window === 'undefined') {\n+       \"environmentLabel\": null,\n+       \"label\": \"Unhandled Runtime Error\",\n+       \"source\": \"app/page.tsx (5:11) @ Component\n      > 5 |     throw new Error('SSR only error')\n-         |           ^\n-       6 |   }\n-       7 |   return <p>hello world</p>\n-       8 | }\",\n+         |           ^\",\n+       \"stack\": [\n+         \"Component app/page.tsx (5:11)\",\n+       ],\n      }\n     `)\n   })"
        },
        {
            "sha": "6e26cc757d250dae5bdb7f2bea38eea55a21827c",
            "filename": "test/e2e/next-link-errors/next-link-errors.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fe2e%2Fnext-link-errors%2Fnext-link-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b/test%2Fe2e%2Fnext-link-errors%2Fnext-link-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-link-errors%2Fnext-link-errors.test.ts?ref=86aef9d9bc31d2f5a1748450bbdfc6c0abcc776b",
            "patch": "@@ -13,11 +13,10 @@ describe('next-link', () => {\n     const browser = await webdriver(next.appPort, '/invalid-href')\n \n     if (isNextDev) {\n-      // TODO(veil): Should be a single error\n       // TODO(veil): https://linear.app/vercel/issue/NDX-554/hide-the-anonymous-frames-which-are-between-2-ignored-frames\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"count\": 2,\n+         \"count\": 1,\n          \"description\": \"Error: Failed prop type: The prop \\`href\\` expects a \\`string\\` or \\`object\\` in \\`<Link>\\`, but got \\`undefined\\` instead.\n        Open your browser's console to view the Component stack trace.\",\n          \"environmentLabel\": null,\n@@ -41,11 +40,10 @@ describe('next-link', () => {\n     const browser = await webdriver(next.appPort, '/no-children')\n \n     if (isNextDev) {\n-      // TODO(veil): Should be a single error\n       // TODO(veil): https://linear.app/vercel/issue/NDX-554/hide-the-anonymous-frames-which-are-between-2-ignored-frames\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"count\": 2,\n+         \"count\": 1,\n          \"description\": \"Error: No children were passed to <Link> with \\`href\\` of \\`/about\\` but one child is required https://nextjs.org/docs/messages/link-no-children\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n@@ -67,11 +65,10 @@ describe('next-link', () => {\n     const browser = await webdriver(next.appPort, '/multiple-children')\n \n     if (isNextDev) {\n-      // TODO(veil): Should be a single error\n       // TODO(veil): https://linear.app/vercel/issue/NDX-554/hide-the-anonymous-frames-which-are-between-2-ignored-frames\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"count\": 2,\n+         \"count\": 1,\n          \"description\": \"Error: Multiple children were passed to <Link> with \\`href\\` of \\`/\\` but only one child is supported https://nextjs.org/docs/messages/link-multiple-children \n        Open your browser's console to view the Component stack trace.\",\n          \"environmentLabel\": null,"
        }
    ],
    "stats": {
        "total": 158,
        "additions": 81,
        "deletions": 77
    }
}