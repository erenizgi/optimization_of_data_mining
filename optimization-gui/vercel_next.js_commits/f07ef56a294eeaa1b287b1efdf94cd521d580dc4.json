{
    "author": "ijjk",
    "message": "Add handling for setting deployment id via cookie (#78841)\n\nAs discussed this adds a flag to allow setting deployment ID via a\ncookie instead of in query string on asset requests which allows for\nbetter caching with the trade-off of users potentially staying on older\ndeployments longer until the ID is no longer accepted or the session\ncookie is cleared.",
    "sha": "f07ef56a294eeaa1b287b1efdf94cd521d580dc4",
    "files": [
        {
            "sha": "5a5fa39421e9a650c87bd65d28664f25ebbbb5a6",
            "filename": "packages/next/src/build/webpack/plugins/define-env-plugin.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts?ref=f07ef56a294eeaa1b287b1efdf94cd521d580dc4",
            "patch": "@@ -155,7 +155,10 @@ export function getDefineEnv({\n     'process.env.__NEXT_PPR': isPPREnabled,\n     'process.env.__NEXT_DYNAMIC_IO': isDynamicIOEnabled,\n     'process.env.__NEXT_USE_CACHE': isUseCacheEnabled,\n-    'process.env.NEXT_DEPLOYMENT_ID': config.deploymentId || false,\n+\n+    'process.env.NEXT_DEPLOYMENT_ID': config.experimental?.useSkewCookie\n+      ? false\n+      : config.deploymentId || false,\n     // Propagates the `__NEXT_EXPERIMENTAL_STATIC_SHELL_DEBUGGING` environment\n     // variable to the client.\n     'process.env.__NEXT_EXPERIMENTAL_STATIC_SHELL_DEBUGGING':"
        },
        {
            "sha": "c2f42930575c0e8dfac8bd7c125ba252720e3d6f",
            "filename": "packages/next/src/lib/load-custom-routes.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/packages%2Fnext%2Fsrc%2Flib%2Fload-custom-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/packages%2Fnext%2Fsrc%2Flib%2Fload-custom-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fload-custom-routes.ts?ref=f07ef56a294eeaa1b287b1efdf94cd521d580dc4",
            "patch": "@@ -719,6 +719,18 @@ export default async function loadCustomRoutes(\n     )\n   }\n \n+  if (config.experimental?.useSkewCookie && config.deploymentId) {\n+    headers.unshift({\n+      source: '/:path*',\n+      headers: [\n+        {\n+          key: 'Set-Cookie',\n+          value: `__vdpl=${config.deploymentId}; Path=/; HttpOnly`,\n+        },\n+      ],\n+    })\n+  }\n+\n   if (!config.skipTrailingSlashRedirect) {\n     if (config.trailingSlash) {\n       redirects.unshift("
        },
        {
            "sha": "83b701116d279dee0b9073b46628b1a29c57316a",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=f07ef56a294eeaa1b287b1efdf94cd521d580dc4",
            "patch": "@@ -315,6 +315,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n     excludeDefaultMomentLocales: z.boolean().optional(),\n     experimental: z\n       .strictObject({\n+        useSkewCookie: z.boolean().optional(),\n         nodeMiddleware: z.boolean().optional(),\n         after: z.boolean().optional(),\n         appDocumentPreloading: z.boolean().optional(),"
        },
        {
            "sha": "0f271f03cfc21c99c89afd1e2c158d081eadb771",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=f07ef56a294eeaa1b287b1efdf94cd521d580dc4",
            "patch": "@@ -273,6 +273,7 @@ export interface LoggingConfig {\n }\n \n export interface ExperimentalConfig {\n+  useSkewCookie?: boolean\n   nodeMiddleware?: boolean\n   cacheHandlers?: {\n     default?: string\n@@ -1237,6 +1238,7 @@ export const defaultConfig: NextConfig = {\n   outputFileTracingRoot: process.env.NEXT_PRIVATE_OUTPUT_TRACE_ROOT || '',\n   allowedDevOrigins: undefined,\n   experimental: {\n+    useSkewCookie: false,\n     nodeMiddleware: false,\n     cacheLife: {\n       default: {"
        },
        {
            "sha": "3b1f371050a7dc36ce818af815660b5b40bcc033",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=f07ef56a294eeaa1b287b1efdf94cd521d580dc4",
            "patch": "@@ -284,7 +284,9 @@ export default class NextNodeServer extends BaseServer<\n     if (this.renderOpts.nextScriptWorkers) {\n       process.env.__NEXT_SCRIPT_WORKERS = JSON.stringify(true)\n     }\n-    process.env.NEXT_DEPLOYMENT_ID = this.nextConfig.deploymentId || ''\n+    process.env.NEXT_DEPLOYMENT_ID = this.nextConfig.experimental.useSkewCookie\n+      ? ''\n+      : this.nextConfig.deploymentId || ''\n \n     if (!this.minimalMode) {\n       this.imageResponseCache = new ResponseCache(this.minimalMode)"
        },
        {
            "sha": "b4839c0d3f9627b02e96ba325d6b650e531516b5",
            "filename": "test/production/deployment-id-handling/app/next.config.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/test%2Fproduction%2Fdeployment-id-handling%2Fapp%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/test%2Fproduction%2Fdeployment-id-handling%2Fapp%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeployment-id-handling%2Fapp%2Fnext.config.js?ref=f07ef56a294eeaa1b287b1efdf94cd521d580dc4",
            "patch": "@@ -1,4 +1,7 @@\n /** @type {import('next').NextConfig} */\n module.exports = {\n   deploymentId: process.env.CUSTOM_DEPLOYMENT_ID,\n+  experimental: {\n+    useSkewCookie: Boolean(process.env.COOKIE_SKEW),\n+  },\n }"
        },
        {
            "sha": "83955f69fff45de94b73622b81e4b2e4cb9a22b3",
            "filename": "test/production/deployment-id-handling/deployment-id-cookie-handling.test.ts",
            "status": "added",
            "additions": 79,
            "deletions": 0,
            "changes": 79,
            "blob_url": "https://github.com/vercel/next.js/blob/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-cookie-handling.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f07ef56a294eeaa1b287b1efdf94cd521d580dc4/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-cookie-handling.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-cookie-handling.test.ts?ref=f07ef56a294eeaa1b287b1efdf94cd521d580dc4",
            "patch": "@@ -0,0 +1,79 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { check } from 'next-test-utils'\n+import { join } from 'node:path'\n+\n+describe('deployment-id-handling disabled', () => {\n+  const deploymentId = Date.now() + ''\n+  const { next } = nextTestSetup({\n+    files: join(__dirname, 'app'),\n+    env: {\n+      COOKIE_SKEW: '1',\n+      NEXT_DEPLOYMENT_ID: 'thankyounext',\n+    },\n+  })\n+\n+  it('should set set-cookie header correctly', async () => {\n+    const res = await next.fetch('/')\n+    expect(res.headers.get('set-cookie')).toBe(\n+      '__vdpl=thankyounext; Path=/; HttpOnly'\n+    )\n+  })\n+\n+  it.each([\n+    { urlPath: '/' },\n+    { urlPath: '/pages-edge' },\n+    { urlPath: '/from-app' },\n+    { urlPath: '/from-app/edge' },\n+  ])(\n+    'should not append dpl query to all assets for $urlPath',\n+    async ({ urlPath }) => {\n+      const $ = await next.render$(urlPath)\n+\n+      expect($('#deploymentId').text()).not.toBe(deploymentId)\n+\n+      const scripts = Array.from($('script'))\n+      expect(scripts.length).toBeGreaterThan(0)\n+\n+      for (const script of scripts) {\n+        if (script.attribs.src) {\n+          expect(script.attribs.src).not.toContain('dpl=' + deploymentId)\n+        }\n+      }\n+\n+      const links = Array.from($('link'))\n+      expect(links.length).toBeGreaterThan(0)\n+\n+      for (const link of links) {\n+        if (link.attribs.href) {\n+          if (link.attribs.as === 'font') {\n+            expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n+          } else {\n+            expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n+          }\n+        }\n+      }\n+\n+      const browser = await next.browser(urlPath)\n+      const requests = []\n+\n+      browser.on('request', (req) => {\n+        requests.push(req.url())\n+      })\n+\n+      await browser.elementByCss('#dynamic-import').click()\n+\n+      await check(\n+        () => (requests.length > 0 ? 'success' : JSON.stringify(requests)),\n+        'success'\n+      )\n+\n+      try {\n+        expect(\n+          requests.every((item) => !item.includes('dpl=' + deploymentId))\n+        ).toBe(true)\n+      } finally {\n+        require('console').error('requests', requests)\n+      }\n+    }\n+  )\n+})"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 104,
        "deletions": 2
    }
}