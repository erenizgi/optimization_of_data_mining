{
    "author": "mischnic",
    "message": "[test] Improve app-basepath assertion error (#86725)\n\nTo make it print out what the second request is when this flake happens:\n```\n\n  ● app dir - basepath › should only make a single RSC call to the current page (/base/refresh?foo=bar)\n\n    expect(received).toBe(expected) // Object.is equality\n\n    Expected: 1\n    Received: 2\n\n      91 |       await browser.elementByCss('button').click()\n      92 |       await retry(async () => {\n    > 93 |         expect(rscRequests.length).toBe(1)\n         |                                    ^\n      94 |         expect(rscRequests[0]).toContain(`${next.url}${path}`)\n      95 |       })\n      96 |     }\n\n      at toBe (e2e/app-dir/app-basepath/index.test.ts:93:36)\n      at fn (lib/next-test-utils.ts:797:20)\n      at e2e/app-dir/app-basepath/index.test.ts:92:7\n```",
    "sha": "b8b62f1d4d0f0ff369fe54397534b927b6c460ac",
    "files": [
        {
            "sha": "0aaf7692b2d7dd1890ded3209d5278244fa2c70f",
            "filename": "test/e2e/app-dir/app-basepath/index.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 8,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/b8b62f1d4d0f0ff369fe54397534b927b6c460ac/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b8b62f1d4d0f0ff369fe54397534b927b6c460ac/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts?ref=b8b62f1d4d0f0ff369fe54397534b927b6c460ac",
            "patch": "@@ -1,5 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { check, retry } from 'next-test-utils'\n+import { retry } from 'next-test-utils'\n import type { Request, Response } from 'playwright'\n \n describe('app dir - basepath', () => {\n@@ -88,10 +88,12 @@ describe('app dir - basepath', () => {\n           })\n         },\n       })\n+\n       await browser.elementByCss('button').click()\n       await retry(async () => {\n-        expect(rscRequests.length).toBe(1)\n-        expect(rscRequests[0]).toContain(`${next.url}${path}`)\n+        expect(rscRequests).toEqual([\n+          expect.stringContaining(`${next.url}${path}`),\n+        ])\n       })\n     }\n   )\n@@ -133,7 +135,9 @@ describe('app dir - basepath', () => {\n       })\n \n       await browser.elementById(buttonId).click()\n-      await check(() => browser.url(), /\\/base\\/another/)\n+      await retry(async () =>\n+        expect(await browser.url()).toContain('/base/another')\n+      )\n \n       expect(await browser.waitForElementByCss('#page-2').text()).toBe(`Page 2`)\n \n@@ -149,8 +153,8 @@ describe('app dir - basepath', () => {\n       const request = requests[0]\n       const response = responses[0]\n \n-      expect(request.method()).toEqual('POST')\n       expect(request.url()).toEqual(`${next.url}${initialPagePath}`)\n+      expect(request.method()).toEqual('POST')\n       expect(response.status()).toEqual(303)\n     }\n   )\n@@ -181,7 +185,9 @@ describe('app dir - basepath', () => {\n     })\n \n     await browser.elementById('redirect-absolute-external').click()\n-    await check(() => browser.url(), /\\/outsideBasePath/)\n+    await retry(async () =>\n+      expect(await browser.url()).toContain('/outsideBasePath')\n+    )\n \n     // We expect to see two requests, first a POST invoking the server\n     // action. And second a GET request resolving the redirect.\n@@ -191,11 +197,11 @@ describe('app dir - basepath', () => {\n     const [firstRequest, secondRequest] = requests\n     const [firstResponse, secondResponse] = responses\n \n-    expect(firstRequest.method()).toEqual('POST')\n     expect(firstRequest.url()).toEqual(`${next.url}${initialPagePath}`)\n+    expect(firstRequest.method()).toEqual('POST')\n \n-    expect(secondRequest.method()).toEqual('GET')\n     expect(secondRequest.url()).toEqual(`${next.url}${destinationPagePath}`)\n+    expect(secondRequest.method()).toEqual('GET')\n \n     expect(firstResponse.status()).toEqual(303)\n     // Since this is an external request to a resource outside of NextJS"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 14,
        "deletions": 8
    }
}