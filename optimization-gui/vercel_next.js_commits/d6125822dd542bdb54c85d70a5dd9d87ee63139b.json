{
    "author": "unstubbable",
    "message": "[test] Overhaul `Undefined default export` test suite (#84235)\n\nThe test suite is now using fixture files instead of sandboxes, same principle as in #83398. I also removed two test cases that didn't test anything novel, compared to the other tests. They were originally moved from another test suite into this one in #66916.\r\n\r\nThis is done in preparation for adding build-time assertions.\r\n\r\n> [!TIP]\r\n> Best reviewed with hidden whitespace changes.",
    "sha": "d6125822dd542bdb54c85d70a5dd9d87ee63139b",
    "files": [
        {
            "sha": "5cc11a91590e4e6f1f7197aa7251a779f51b491f",
            "filename": "test/development/acceptance-app/fixtures/undefined-default-export/app/(group)/specific-path/1/page.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2F(group)%2Fspecific-path%2F1%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2F(group)%2Fspecific-path%2F1%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2F(group)%2Fspecific-path%2F1%2Fpage.js?ref=d6125822dd542bdb54c85d70a5dd9d87ee63139b",
            "patch": "@@ -0,0 +1 @@\n+export const a = 123"
        },
        {
            "sha": "5cc11a91590e4e6f1f7197aa7251a779f51b491f",
            "filename": "test/development/acceptance-app/fixtures/undefined-default-export/app/(group)/specific-path/2/layout.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2F(group)%2Fspecific-path%2F2%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2F(group)%2Fspecific-path%2F2%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2F(group)%2Fspecific-path%2F2%2Flayout.js?ref=d6125822dd542bdb54c85d70a5dd9d87ee63139b",
            "patch": "@@ -0,0 +1 @@\n+export const a = 123"
        },
        {
            "sha": "6ee683e94022b66f69c3d03652b637c3b6bb2528",
            "filename": "test/development/acceptance-app/fixtures/undefined-default-export/app/(group)/specific-path/2/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2F(group)%2Fspecific-path%2F2%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2F(group)%2Fspecific-path%2F2%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2F(group)%2Fspecific-path%2F2%2Fpage.js?ref=d6125822dd542bdb54c85d70a5dd9d87ee63139b",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <div>Hello</div>\n+}"
        },
        {
            "sha": "a3a86a5ca1e12cd18b557ea38532170ea1e49622",
            "filename": "test/development/acceptance-app/fixtures/undefined-default-export/app/layout.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2Flayout.js?ref=d6125822dd542bdb54c85d70a5dd9d87ee63139b",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Root({ children }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "5cc11a91590e4e6f1f7197aa7251a779f51b491f",
            "filename": "test/development/acceptance-app/fixtures/undefined-default-export/app/will-not-found/not-found.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2Fwill-not-found%2Fnot-found.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2Fwill-not-found%2Fnot-found.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2Fwill-not-found%2Fnot-found.js?ref=d6125822dd542bdb54c85d70a5dd9d87ee63139b",
            "patch": "@@ -0,0 +1 @@\n+export const a = 123"
        },
        {
            "sha": "97ea65b48340c456c3866bbe589b642d6ca978ba",
            "filename": "test/development/acceptance-app/fixtures/undefined-default-export/app/will-not-found/page.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2Fwill-not-found%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2Fwill-not-found%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fundefined-default-export%2Fapp%2Fwill-not-found%2Fpage.js?ref=d6125822dd542bdb54c85d70a5dd9d87ee63139b",
            "patch": "@@ -0,0 +1,5 @@\n+import { notFound } from 'next/navigation'\n+\n+export default function Page() {\n+  notFound()\n+}"
        },
        {
            "sha": "192163f6e13b32d6f1acaabe0505a9bd5c748c98",
            "filename": "test/development/acceptance-app/undefined-default-export.test.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 127,
            "changes": 177,
            "blob_url": "https://github.com/vercel/next.js/blob/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Fundefined-default-export.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6125822dd542bdb54c85d70a5dd9d87ee63139b/test%2Fdevelopment%2Facceptance-app%2Fundefined-default-export.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fundefined-default-export.test.ts?ref=d6125822dd542bdb54c85d70a5dd9d87ee63139b",
            "patch": "@@ -1,134 +1,57 @@\n import path from 'path'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n-import { createSandbox } from 'development-sandbox'\n-import { retry } from 'next-test-utils'\n \n describe('Undefined default export', () => {\n-  const { next } = nextTestSetup({\n-    files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n+  const { next, isNextDev } = nextTestSetup({\n+    files: new FileRef(\n+      path.join(__dirname, 'fixtures', 'undefined-default-export')\n+    ),\n   })\n \n-  it('should error if page component does not have default export', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        ['app/(group)/specific-path/server/page.js', 'export const a = 123'],\n-      ]),\n-      '/specific-path/server'\n-    )\n-    const { browser } = sandbox\n-\n-    await expect(browser).toDisplayRedbox(`\n-     {\n-       \"description\": \"The default export is not a React Component in \"/specific-path/server/page\"\",\n-       \"environmentLabel\": null,\n-       \"label\": \"Runtime Error\",\n-       \"source\": null,\n-       \"stack\": [],\n-     }\n-    `)\n-  })\n-\n-  it('should error if layout component does not have default export', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        ['app/(group)/specific-path/server/layout.js', 'export const a = 123'],\n-        [\n-          'app/(group)/specific-path/server/page.js',\n-          'export default function Page() { return <div>Hello</div> }',\n-        ],\n-      ]),\n-      '/specific-path/server'\n-    )\n-    const { browser } = sandbox\n-\n-    await expect(browser).toDisplayRedbox(`\n-     {\n-       \"description\": \"The default export is not a React Component in \"/specific-path/server/layout\"\",\n-       \"environmentLabel\": null,\n-       \"label\": \"Runtime Error\",\n-       \"source\": null,\n-       \"stack\": [],\n-     }\n-    `)\n-  })\n-\n-  it('should error if not-found component does not have default export when trigger not-found boundary', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/will-not-found/page.js',\n-          `\n-          import { notFound } from 'next/navigation'\n-          export default function Page() { notFound() }\n-          `,\n-        ],\n-        ['app/will-not-found/not-found.js', 'export const a = 123'],\n-      ]),\n-      '/will-not-found'\n-    )\n-    const { browser } = sandbox\n-\n-    await expect(browser).toDisplayRedbox(`\n-     {\n-       \"description\": \"The default export is not a React Component in \"/will-not-found/not-found\"\",\n-       \"environmentLabel\": null,\n-       \"label\": \"Runtime Error\",\n-       \"source\": null,\n-       \"stack\": [],\n-     }\n-    `)\n-  })\n-\n-  it('should error when page component export is not valid', async () => {\n-    await using sandbox = await createSandbox(next, undefined, '/')\n-    const { browser } = sandbox\n-    const cliOutputLength = next.cliOutput.length\n-\n-    await next.patchFile('app/page.js', 'const a = 123')\n-\n-    // The page will fail build and navigate to /_error route of pages router.\n-    // We wait for the error page to be compiled before asserting the redbox.\n-    await retry(async () => {\n-      expect(next.cliOutput.slice(cliOutputLength)).toContain(\n-        'âœ“ Compiled /_error'\n-      )\n-    }, 10_000)\n-\n-    await expect(browser).toDisplayRedbox(`\n-     {\n-       \"description\": \"The default export is not a React Component in \"/page\"\",\n-       \"environmentLabel\": null,\n-       \"label\": \"Runtime Error\",\n-       \"source\": null,\n-       \"stack\": [],\n-     }\n-    `)\n-  })\n-\n-  it('should error when page component export is not valid on initial load', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/server-with-errors/page-export-initial-error/page.js',\n-          'export const a = 123',\n-        ],\n-      ]),\n-      '/server-with-errors/page-export-initial-error'\n-    )\n-    const { browser } = sandbox\n-\n-    await expect(browser).toDisplayRedbox(`\n-     {\n-       \"description\": \"The default export is not a React Component in \"/server-with-errors/page-export-initial-error/page\"\",\n-       \"environmentLabel\": null,\n-       \"label\": \"Runtime Error\",\n-       \"source\": null,\n-       \"stack\": [],\n-     }\n-    `)\n-  })\n+  // TODO: This is currently always true. It's just here to already indent the\n+  // code, so that git blame is preserved in the subsequent commit, when we're\n+  // moving the file.\n+  if (isNextDev) {\n+    it('should error if page component does not have default export', async () => {\n+      const browser = await next.browser('/specific-path/1')\n+\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"The default export is not a React Component in \"/specific-path/1/page\"\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    })\n+\n+    it('should error if layout component does not have default export', async () => {\n+      const browser = await next.browser('/specific-path/2')\n+\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"The default export is not a React Component in \"/specific-path/2/layout\"\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    })\n+\n+    it('should error if not-found component does not have default export when trigger not-found boundary', async () => {\n+      const browser = await next.browser('/will-not-found')\n+\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"The default export is not a React Component in \"/will-not-found/not-found\"\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    })\n+  }\n })"
        }
    ],
    "stats": {
        "total": 195,
        "additions": 68,
        "deletions": 127
    }
}