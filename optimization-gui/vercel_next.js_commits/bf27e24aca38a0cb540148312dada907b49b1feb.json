{
    "author": "ztanner",
    "message": "fix: cacheMaxMemorySize should not disable dev HMR cache (#86164)\n\nWhen configuring `cacheMaxMemorySize` to disable memory caching\n(typically used for setups to adjust production caching behavior,\nespecially in multi-process self-hosted setups), this inadvertently also\ndisabled dev HMR caches which are intended as a performance\noptimization. As a result of this, the dev console would be spammed with\n\"Single item size exceeds maxsize\".\n\nIt's still possible to use this configuration to set a larger cache, but\notherwise it will have a minimum set to the previous default.\n\nFixes NAR-463\nx-ref:\nhttps://github.com/vercel/next.js/pull/85153#issuecomment-3429636751",
    "sha": "bf27e24aca38a0cb540148312dada907b49b1feb",
    "files": [
        {
            "sha": "6498d060a4c1276866cfb662b9488f7e9570a470",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bf27e24aca38a0cb540148312dada907b49b1feb/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bf27e24aca38a0cb540148312dada907b49b1feb/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=bf27e24aca38a0cb540148312dada907b49b1feb",
            "patch": "@@ -48,6 +48,7 @@ import { loadDefaultErrorComponents } from '../load-default-error-components'\n import { DecodeError, MiddlewareNotFoundError } from '../../shared/lib/utils'\n import * as Log from '../../build/output/log'\n import isError, { getProperError } from '../../lib/is-error'\n+import { defaultConfig } from '../config-shared'\n import { isMiddlewareFile } from '../../build/utils'\n import { formatServerError } from '../../lib/format-server-error'\n import { DevRouteMatcherManager } from '../route-matcher-managers/dev-route-matcher-manager'\n@@ -185,8 +186,14 @@ export default class DevServer extends Server {\n     this.appDir = appDir\n \n     if (this.nextConfig.experimental.serverComponentsHmrCache) {\n-      this.serverComponentsHmrCache = new LRUCache(\n+      // Ensure HMR cache has a minimum size equal to the default cacheMaxMemorySize,\n+      // but allow it to grow if the user has configured a larger value.\n+      const hmrCacheSize = Math.max(\n         this.nextConfig.cacheMaxMemorySize,\n+        defaultConfig.cacheMaxMemorySize\n+      )\n+      this.serverComponentsHmrCache = new LRUCache(\n+        hmrCacheSize,\n         function length(value) {\n           return JSON.stringify(value).length\n         }"
        },
        {
            "sha": "4e847fb88f3485404ec13a495b329b0a2eaa8fc5",
            "filename": "test/development/app-dir/server-components-hmr-cache/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/bf27e24aca38a0cb540148312dada907b49b1feb/test%2Fdevelopment%2Fapp-dir%2Fserver-components-hmr-cache%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bf27e24aca38a0cb540148312dada907b49b1feb/test%2Fdevelopment%2Fapp-dir%2Fserver-components-hmr-cache%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fserver-components-hmr-cache%2Fnext.config.js?ref=bf27e24aca38a0cb540148312dada907b49b1feb",
            "patch": "@@ -2,6 +2,7 @@\n  * @type {import('next').NextConfig}\n  */\n const nextConfig = {\n+  // cacheMaxMemorySize: 0,\n   experimental: {\n     // serverComponentsHmrCache: false,\n   },"
        },
        {
            "sha": "d1971364942e4c3d21329d9bb20dcf50b2d64788",
            "filename": "test/development/app-dir/server-components-hmr-cache/server-components-hmr-cache.test.ts",
            "status": "modified",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/bf27e24aca38a0cb540148312dada907b49b1feb/test%2Fdevelopment%2Fapp-dir%2Fserver-components-hmr-cache%2Fserver-components-hmr-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bf27e24aca38a0cb540148312dada907b49b1feb/test%2Fdevelopment%2Fapp-dir%2Fserver-components-hmr-cache%2Fserver-components-hmr-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fserver-components-hmr-cache%2Fserver-components-hmr-cache.test.ts?ref=bf27e24aca38a0cb540148312dada907b49b1feb",
            "patch": "@@ -91,6 +91,61 @@ describe('server-components-hmr-cache', () => {\n       })\n     })\n \n+    describe('with cacheMaxMemorySize set to 0', () => {\n+      beforeAll(async () => {\n+        await next.patchFile('next.config.js', (content) =>\n+          content.replace('// cacheMaxMemorySize: 0,', 'cacheMaxMemorySize: 0,')\n+        )\n+      })\n+\n+      afterAll(async () => {\n+        await next.patchFile('next.config.js', (content) =>\n+          content.replace('cacheMaxMemorySize: 0,', '// cacheMaxMemorySize: 0,')\n+        )\n+      })\n+\n+      it('should not warn about \"Single item size exceeds maxSize\"', async () => {\n+        const initialOutputLength = next.cliOutput.length\n+        const browser = await next.browser(`/${runtime}`)\n+        await browser.elementById('value').text()\n+\n+        await next.patchFile(\n+          'components/shared-page.tsx',\n+          (content) => content.replace('foo', 'bar'),\n+          async () => {\n+            await retry(async () => {\n+              const updatedContent = await browser.elementById('content').text()\n+              expect(updatedContent).toBe('bar')\n+            }, 5000)\n+\n+            // Verify the warning does not appear\n+            const newOutput = next.cliOutput.slice(initialOutputLength)\n+            expect(newOutput).not.toContain('Single item size exceeds maxSize')\n+          }\n+        )\n+      })\n+\n+      it('should still use cached fetch calls for fast refresh requests', async () => {\n+        const browser = await next.browser(`/${runtime}`)\n+        const valueBeforePatch = await browser.elementById('value').text()\n+\n+        await next.patchFile(\n+          'components/shared-page.tsx',\n+          (content) => content.replace('foo', 'bar'),\n+          async () => {\n+            await retry(async () => {\n+              const updatedContent = await browser.elementById('content').text()\n+              expect(updatedContent).toBe('bar')\n+            }, 5000)\n+\n+            // HMR cache should still work even with cacheMaxMemorySize: 0\n+            const valueAfterPatch = await browser.elementById('value').text()\n+            expect(valueBeforePatch).toEqual(valueAfterPatch)\n+          }\n+        )\n+      })\n+    })\n+\n     describe('with experimental.serverComponentsHmrCache disabled', () => {\n       beforeAll(async () => {\n         await next.patchFile('next.config.js', (content) =>"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 64,
        "deletions": 1
    }
}