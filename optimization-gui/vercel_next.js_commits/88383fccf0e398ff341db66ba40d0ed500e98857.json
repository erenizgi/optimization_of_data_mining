{
    "author": "unstubbable",
    "message": "Fix fetch logging after revalidation via server action (#82643)\n\nWhen revalidating a tag or path with a server action, we do want to log\nany fetches that are made during the subsequent rerendering, when [fetch\nlogging](https://nextjs.org/docs/app/api-reference/config/next-config-js/logging#fetching)\nis enabled.\n\nThis got accidentally broken in #64746, where we wrote:\n\n> [...] this ensures we don't keep tracking fetch metrics after the\nrequest has ended as we only report on request end\n\nThat's incorrect though, because we report fetch metrics when the\n_response_ is closed, and not the request:\n\n\nhttps://github.com/vercel/next.js/blob/0bd7423844e218b19537880a7fa4314749fdf57d/packages/next/src/server/dev/next-dev-server.ts#L530-L546\n\nThis is crucial for server actions, when the request is likely already\nclosed while we're rerendering and streaming the response to the client.\n\nfixes #80444\ncloses NAR-307",
    "sha": "88383fccf0e398ff341db66ba40d0ed500e98857",
    "files": [
        {
            "sha": "2c6fe0a8013b2332fc4786514c51270a7df4b315",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/88383fccf0e398ff341db66ba40d0ed500e98857/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88383fccf0e398ff341db66ba40d0ed500e98857/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=88383fccf0e398ff341db66ba40d0ed500e98857",
            "patch": "@@ -1454,7 +1454,6 @@ async function renderToHTMLOrFlightImpl(\n   renderOpts: RenderOpts,\n   workStore: WorkStore,\n   parsedRequestHeaders: ParsedRequestHeaders,\n-  requestEndedState: { ended?: boolean },\n   postponedState: PostponedState | null,\n   serverComponentsHmrCache: ServerComponentsHmrCache | undefined,\n   sharedContext: AppSharedContext,\n@@ -1555,9 +1554,13 @@ async function renderToHTMLOrFlightImpl(\n     process.env.NEXT_RUNTIME !== 'edge' &&\n     isNodeNextRequest(req)\n   ) {\n-    req.originalRequest.on('end', () => {\n-      requestEndedState.ended = true\n+    res.onClose(() => {\n+      // We stop tracking fetch metrics when the response closes, since we\n+      // report them at that time.\n+      workStore.shouldTrackFetchMetrics = false\n+    })\n \n+    req.originalRequest.on('end', () => {\n       if ('performance' in globalThis) {\n         const metrics = getClientComponentLoaderMetrics({ reset: true })\n         if (metrics) {\n@@ -1966,7 +1969,6 @@ export const renderToHTMLOrFlight: AppPageRender = (\n \n   const { isPrefetchRequest, previouslyRevalidatedTags } = parsedRequestHeaders\n \n-  const requestEndedState = { ended: false }\n   let postponedState: PostponedState | null = null\n \n   // If provided, the postpone state should be parsed so it can be provided to\n@@ -1996,7 +1998,6 @@ export const renderToHTMLOrFlight: AppPageRender = (\n   const workStore = createWorkStore({\n     page: renderOpts.routeModule.definition.page,\n     renderOpts,\n-    requestEndedState,\n     // @TODO move to workUnitStore of type Request\n     isPrefetchRequest,\n     buildId: sharedContext.buildId,\n@@ -2016,7 +2017,6 @@ export const renderToHTMLOrFlight: AppPageRender = (\n     renderOpts,\n     workStore,\n     parsedRequestHeaders,\n-    requestEndedState,\n     postponedState,\n     serverComponentsHmrCache,\n     sharedContext,"
        },
        {
            "sha": "4c5f4116437f10c9cc3c8dc1ffcbbd99e22ecd8d",
            "filename": "packages/next/src/server/app-render/work-async-storage.external.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/88383fccf0e398ff341db66ba40d0ed500e98857/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88383fccf0e398ff341db66ba40d0ed500e98857/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts?ref=88383fccf0e398ff341db66ba40d0ed500e98857",
            "patch": "@@ -85,13 +85,12 @@ export interface WorkStore {\n   readonly refreshTagsByCacheKind: Map<string, LazyResult<void>>\n \n   fetchMetrics?: FetchMetrics\n+  shouldTrackFetchMetrics: boolean\n \n   isDraftMode?: boolean\n   isUnstableNoStore?: boolean\n   isPrefetchRequest?: boolean\n \n-  requestEndedState?: { ended?: boolean }\n-\n   buildId: string\n \n   readonly reactLoadableManifest?: DeepReadonly<"
        },
        {
            "sha": "1146c53e84d324b242c827bdfdf7ba2941bdf587",
            "filename": "packages/next/src/server/async-storage/work-store.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/88383fccf0e398ff341db66ba40d0ed500e98857/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88383fccf0e398ff341db66ba40d0ed500e98857/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts?ref=88383fccf0e398ff341db66ba40d0ed500e98857",
            "patch": "@@ -19,7 +19,6 @@ export type WorkStoreContext = {\n    */\n   page: string\n \n-  requestEndedState?: { ended?: boolean }\n   isPrefetchRequest?: boolean\n   renderOpts: {\n     cacheLifeProfiles?: { [profile: string]: CacheLife }\n@@ -77,7 +76,6 @@ export type WorkStoreContext = {\n export function createWorkStore({\n   page,\n   renderOpts,\n-  requestEndedState,\n   isPrefetchRequest,\n   buildId,\n   previouslyRevalidatedTags,\n@@ -105,6 +103,17 @@ export function createWorkStore({\n     !renderOpts.isDraftMode &&\n     !renderOpts.isPossibleServerAction\n \n+  const isDevelopment = renderOpts.dev ?? false\n+\n+  const shouldTrackFetchMetrics =\n+    isDevelopment ||\n+    // The only times we want to track fetch metrics outside of development is\n+    // when we are performing a static generation and we either are in debug\n+    // mode, or tracking fetch metrics was specifically opted into.\n+    (isStaticGeneration &&\n+      (!!process.env.NEXT_DEBUG_BUILD ||\n+        process.env.NEXT_SSG_FETCH_METRICS === '1'))\n+\n   const store: WorkStore = {\n     isStaticGeneration,\n     page,\n@@ -122,18 +131,18 @@ export function createWorkStore({\n \n     isDraftMode: renderOpts.isDraftMode,\n \n-    requestEndedState,\n     isPrefetchRequest,\n     buildId,\n     reactLoadableManifest: renderOpts?.reactLoadableManifest || {},\n     assetPrefix: renderOpts?.assetPrefix || '',\n \n     afterContext: createAfterContext(renderOpts),\n     cacheComponentsEnabled: renderOpts.experimental.cacheComponents,\n-    dev: renderOpts.dev ?? false,\n+    dev: isDevelopment,\n     previouslyRevalidatedTags,\n     refreshTagsByCacheKind: createRefreshTagsByCacheKind(),\n     runInCleanSnapshot: createSnapshot(),\n+    shouldTrackFetchMetrics,\n   }\n \n   // TODO: remove this when we resolve accessing the store outside the execution context"
        },
        {
            "sha": "6855b60bd3774cc696bc9663989a4a4750ead763",
            "filename": "packages/next/src/server/lib/patch-fetch.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 16,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/88383fccf0e398ff341db66ba40d0ed500e98857/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88383fccf0e398ff341db66ba40d0ed500e98857/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts?ref=88383fccf0e398ff341db66ba40d0ed500e98857",
            "patch": "@@ -121,22 +121,7 @@ function trackFetchMetric(\n   workStore: WorkStore,\n   ctx: Omit<FetchMetric, 'end' | 'idx'>\n ) {\n-  // If the static generation store is not available, we can't track the fetch\n-  if (!workStore) return\n-  if (workStore.requestEndedState?.ended) return\n-\n-  const isDebugBuild =\n-    (!!process.env.NEXT_DEBUG_BUILD ||\n-      process.env.NEXT_SSG_FETCH_METRICS === '1') &&\n-    workStore.isStaticGeneration\n-  const isDevelopment = process.env.NODE_ENV === 'development'\n-\n-  if (\n-    // The only time we want to track fetch metrics outside of development is when\n-    // we are performing a static generation & we are in debug mode.\n-    !isDebugBuild &&\n-    !isDevelopment\n-  ) {\n+  if (!workStore.shouldTrackFetchMetrics) {\n     return\n   }\n "
        },
        {
            "sha": "a7b51e7d9ce221bd68d8a37654afa5e405298ca8",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/88383fccf0e398ff341db66ba40d0ed500e98857/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88383fccf0e398ff341db66ba40d0ed500e98857/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=88383fccf0e398ff341db66ba40d0ed500e98857",
            "patch": "@@ -297,7 +297,6 @@ export async function adapter(\n                 onClose: closeController.onClose.bind(closeController),\n                 onAfterTaskError: undefined,\n               },\n-              requestEndedState: { ended: false },\n               isPrefetchRequest:\n                 request.headers.get(NEXT_ROUTER_PREFETCH_HEADER) === '1',\n               buildId: buildId ?? '',"
        },
        {
            "sha": "b58db456d943d77aec3e40c326415109a08a8697",
            "filename": "test/e2e/app-dir/logging/app/default-cache/page.js",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/88383fccf0e398ff341db66ba40d0ed500e98857/test%2Fe2e%2Fapp-dir%2Flogging%2Fapp%2Fdefault-cache%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/88383fccf0e398ff341db66ba40d0ed500e98857/test%2Fe2e%2Fapp-dir%2Flogging%2Fapp%2Fdefault-cache%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Flogging%2Fapp%2Fdefault-cache%2Fpage.js?ref=88383fccf0e398ff341db66ba40d0ed500e98857",
            "patch": "@@ -1,3 +1,5 @@\n+import { revalidateTag } from 'next/cache'\n+\n export const fetchCache = 'default-cache'\n \n async function AnotherRsc() {\n@@ -55,7 +57,8 @@ async function FirstRsc() {\n   ).then((res) => res.text())\n \n   const dataAutoCache = await fetch(\n-    'https://next-data-api-endpoint.vercel.app/api/random?auto-cache'\n+    'https://next-data-api-endpoint.vercel.app/api/random?auto-cache',\n+    { next: { tags: ['test-tag'] } }\n   ).then((res) => res.text())\n \n   return (\n@@ -72,12 +75,26 @@ async function FirstRsc() {\n   )\n }\n \n+function RevalidateForm() {\n+  return (\n+    <form\n+      action={async () => {\n+        'use server'\n+        revalidateTag('test-tag')\n+      }}\n+    >\n+      <button id=\"revalidate-button\">Revalidate</button>\n+    </form>\n+  )\n+}\n+\n export default async function Page() {\n   return (\n     <>\n       <h1>Default Cache</h1>\n       <FirstRsc />\n       <AnotherRsc />\n+      <RevalidateForm />\n     </>\n   )\n }"
        },
        {
            "sha": "9cc7de200b599e3289f39cd7b83225f9a6d53ac0",
            "filename": "test/e2e/app-dir/logging/fetch-logging.test.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/88383fccf0e398ff341db66ba40d0ed500e98857/test%2Fe2e%2Fapp-dir%2Flogging%2Ffetch-logging.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88383fccf0e398ff341db66ba40d0ed500e98857/test%2Fe2e%2Fapp-dir%2Flogging%2Ffetch-logging.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Flogging%2Ffetch-logging.test.ts?ref=88383fccf0e398ff341db66ba40d0ed500e98857",
            "patch": "@@ -267,6 +267,29 @@ describe('app-dir - logging', () => {\n           })\n         })\n \n+        it('should log requests for after revalidation via server action', async () => {\n+          let outputIndex = next.cliOutput.length\n+          const browser = await next.browser('/default-cache')\n+\n+          const expectedUrl = withFullUrlFetches\n+            ? 'https://next-data-api-endpoint.vercel.app/api/random'\n+            : 'https://next-data-api-en../api/random'\n+\n+          await retry(() => {\n+            const logs = stripAnsi(next.cliOutput.slice(outputIndex))\n+            expect(logs).toIncludeRepeated(` │ GET ${expectedUrl}`, 7)\n+          })\n+\n+          outputIndex = next.cliOutput.length\n+\n+          await browser.elementById('revalidate-button').click()\n+\n+          await retry(() => {\n+            const logs = stripAnsi(next.cliOutput.slice(outputIndex))\n+            expect(logs).toIncludeRepeated(` │ GET ${expectedUrl}`, 7)\n+          })\n+        })\n+\n         describe('when logging.fetches.hmrRefreshes is true', () => {\n           beforeAll(async () => {\n             await next.patchFile('next.config.js', (content) =>"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 62,
        "deletions": 30
    }
}