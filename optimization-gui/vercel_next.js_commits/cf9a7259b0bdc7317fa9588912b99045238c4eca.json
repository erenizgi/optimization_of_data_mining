{
    "author": "lukesandberg",
    "message": "make withRspack idempotent (#84482)\n\n`loadConfig` can get called multiple times in a build or dev session.\n\nin `dev` it gets called multiple times at the end of a session and of course whenever a session restarts\nin `build` it can get called multiple times due to build workers\n\nFor that reason it needs to be idempotent, so change `withRspack` to detect if it has  already run and short circuit.  Otherwise it will always fail the second time complaining that you passed `--wepack` (because the first run deleted the TURBOPACK env var).\n\nSee discussion: https://github.com/vercel/next.js/pull/84394#issuecomment-3364615461",
    "sha": "cf9a7259b0bdc7317fa9588912b99045238c4eca",
    "files": [
        {
            "sha": "8de5fb31c36015d59c22e7f91785908221db3511",
            "filename": "packages/next-rspack/index.js",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/cf9a7259b0bdc7317fa9588912b99045238c4eca/packages%2Fnext-rspack%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/cf9a7259b0bdc7317fa9588912b99045238c4eca/packages%2Fnext-rspack%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-rspack%2Findex.js?ref=cf9a7259b0bdc7317fa9588912b99045238c4eca",
            "patch": "@@ -1,11 +1,16 @@\n+Error.stackTraceLimit = 100\n module.exports = function withRspack(config) {\n-  process.env.NEXT_RSPACK = 'true'\n-  process.env.RSPACK_CONFIG_VALIDATE = 'loose-silent'\n+  if (process.env.NEXT_RSPACK === 'true') {\n+    // we have already been called.  This can happen when using build workers.\n+    return config\n+  }\n   if (process.env.TURBOPACK === 'auto') {\n-    // If next has defaulted to turbopack, override it.\n     delete process.env.TURBOPACK\n+    process.env.RSPACK_CONFIG_VALIDATE = 'loose-silent'\n+    process.env.NEXT_RSPACK = 'true'\n   } else {\n-    console.error(\n+    // Either The TURBOPACK flag wasn't set which means --wepack was, or the TURBOPACK flag was set to 1 because --turbopack was passed.\n+    console.trace(\n       `Cannot call withRspack and pass the ${process.env.TURBOPACK ? '--turbopack' : '--webpack'} flag.`\n     )\n     console.error('Please configure only one bundler.')"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 9,
        "deletions": 4
    }
}