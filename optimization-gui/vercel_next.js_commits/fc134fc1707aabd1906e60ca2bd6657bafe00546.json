{
    "author": "ztanner",
    "message": "fix: ensure app router not found works when deployed with pages i18n config (#77905)\n\nWhen using both pages & app routers, during `next dev` and `next start`,\nif a function triggers a 404 error, we serve the app router not found\npage rather than the pages router one.\n\nWhen paired with the `i18n` configuration in `next.config`, the Next.js\nbuilder ignores the app router 404 and bundles the localized pages\nrouter 404 pages with the deployed functions. This leads to a 500 error,\nand is fixed in https://github.com/vercel/vercel/pull/13222\n\nHowever, to match the dev/start handling, we also need to update the\n`pages-manifest` so the builder knows to resolve `/404.html` and not the\npages router variant when deployed.\n\nFixes NEXT-4045\n\nValidation:\n[vtest314-e2e-tests-bkc89ab40-ztanner.vercel.app/app-dir/foo](https://vtest314-e2e-tests-bkc89ab40-ztanner.vercel.app/app-dir/foo)",
    "sha": "fc134fc1707aabd1906e60ca2bd6657bafe00546",
    "files": [
        {
            "sha": "f7cbf822fff768321c667c80f9adfd6f740180de",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/fc134fc1707aabd1906e60ca2bd6657bafe00546/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc134fc1707aabd1906e60ca2bd6657bafe00546/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=fc134fc1707aabd1906e60ca2bd6657bafe00546",
            "patch": "@@ -3301,6 +3301,16 @@ export default async function build(\n                     orig,\n                     path.join(distDir, 'server', updatedRelativeDest)\n                   )\n+\n+                  // since the app router not found is prioritized over pages router,\n+                  // we have to ensure the app router entries are available for all locales\n+                  if (i18n) {\n+                    for (const locale of i18n.locales) {\n+                      const curPath = `/${locale}/404`\n+                      pagesManifest[curPath] = updatedRelativeDest\n+                    }\n+                  }\n+\n                   pagesManifest['/404'] = updatedRelativeDest\n                 }\n               })"
        },
        {
            "sha": "84e51b866c7753fe5335c303ff30f18a97318a86",
            "filename": "test/e2e/app-dir/not-found-with-pages-i18n/app/app-dir/[[...slug]]/page.tsx",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fapp%2Fapp-dir%2F%5B%5B...slug%5D%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fapp%2Fapp-dir%2F%5B%5B...slug%5D%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fapp%2Fapp-dir%2F%5B%5B...slug%5D%5D%2Fpage.tsx?ref=fc134fc1707aabd1906e60ca2bd6657bafe00546",
            "patch": "@@ -0,0 +1,44 @@\n+import { notFound } from 'next/navigation'\n+\n+export async function generateStaticParams() {\n+  return []\n+}\n+\n+async function validateSlug(slug: string[]) {\n+  try {\n+    const isValidPath =\n+      slug.length === 1 && (slug[0] === 'about' || slug[0] === 'contact')\n+\n+    if (!isValidPath) {\n+      return false\n+    }\n+\n+    return true\n+  } catch (error) {\n+    throw error\n+  }\n+}\n+\n+export default async function CatchAll({\n+  params,\n+}: {\n+  params: Promise<{ slug: string[] }>\n+}) {\n+  const { slug } = await params\n+  const slugArray = Array.isArray(slug) ? slug : [slug]\n+\n+  // Validate the slug\n+  const isValid = await validateSlug(slugArray)\n+\n+  // If not valid, show 404\n+  if (!isValid) {\n+    notFound()\n+  }\n+\n+  return (\n+    <div>\n+      <h1>Catch All</h1>\n+      <p>This is a catch all page added to the APP router</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "a14e64fcd5e33e9399d0e823434b0ab3095d5b75",
            "filename": "test/e2e/app-dir/not-found-with-pages-i18n/app/layout.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fapp%2Flayout.tsx?ref=fc134fc1707aabd1906e60ca2bd6657bafe00546",
            "patch": "@@ -0,0 +1,16 @@\n+export const metadata = {\n+  title: 'Next.js',\n+  description: 'Generated by Next.js',\n+}\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "9e2f20f4cca7c19478c0b58ac2b0874acc0e31f7",
            "filename": "test/e2e/app-dir/not-found-with-pages-i18n/app/not-found.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fapp%2Fnot-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fapp%2Fnot-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fapp%2Fnot-found.tsx?ref=fc134fc1707aabd1906e60ca2bd6657bafe00546",
            "patch": "@@ -0,0 +1,10 @@\n+import React from 'react'\n+\n+const NotFound = () => (\n+  <div>\n+    <h1>APP ROUTER - 404 PAGE</h1>\n+    <p>This page is using the APP ROUTER</p>\n+  </div>\n+)\n+\n+export default NotFound"
        },
        {
            "sha": "ee7663cef2d2b28b94b26c49860b97ba70443280",
            "filename": "test/e2e/app-dir/not-found-with-pages-i18n/next.config.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fnext.config.js?ref=fc134fc1707aabd1906e60ca2bd6657bafe00546",
            "patch": "@@ -0,0 +1,12 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  i18n: {\n+    locales: ['en-GB', 'en'],\n+    defaultLocale: 'en',\n+    localeDetection: false,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "5b6a635bd3d6bac90581a06a3f9bfa1beab11a6b",
            "filename": "test/e2e/app-dir/not-found-with-pages-i18n/not-found-with-pages.test.ts",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fnot-found-with-pages.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fnot-found-with-pages.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fnot-found-with-pages.test.ts?ref=fc134fc1707aabd1906e60ca2bd6657bafe00546",
            "patch": "@@ -0,0 +1,31 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('not-found-with-pages', () => {\n+  const { next, isNextStart } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  if (isNextStart) {\n+    it('should write all locales to the pages manifest', async () => {\n+      const pagesManifest = JSON.parse(\n+        await next.readFile('.next/server/pages-manifest.json')\n+      )\n+\n+      expect(pagesManifest['/404']).toBe('pages/404.html')\n+      expect(pagesManifest['/en/404']).toBe('pages/404.html')\n+      expect(pagesManifest['/en-GB/404']).toBe('pages/404.html')\n+    })\n+  }\n+\n+  it('should prefer the app router 404 over the pages router 404 when both are present', async () => {\n+    const browser = await next.browser('/app-dir/foo')\n+    expect(await browser.elementByCss('h1').text()).toBe(\n+      'APP ROUTER - 404 PAGE'\n+    )\n+\n+    await browser.loadPage(next.url)\n+    expect(await browser.elementByCss('h1').text()).toBe(\n+      'APP ROUTER - 404 PAGE'\n+    )\n+  })\n+})"
        },
        {
            "sha": "be5a6a9368ef293c4b91a7533ece89bbeb006db5",
            "filename": "test/e2e/app-dir/not-found-with-pages-i18n/pages/404.tsx",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fpages%2F404.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fpages%2F404.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fpages%2F404.tsx?ref=fc134fc1707aabd1906e60ca2bd6657bafe00546",
            "patch": "@@ -0,0 +1,24 @@\n+import React from 'react'\n+import { GetStaticProps } from 'next'\n+\n+interface NotFoundProps {\n+  message: string\n+}\n+\n+const NotFound = ({ message }: NotFoundProps) => (\n+  <div>\n+    <h1>PAGES ROUTER - 404 PAGE</h1>\n+    <p>This page is using the PAGES ROUTER</p>\n+    <p>{message}</p>\n+  </div>\n+)\n+\n+export const getStaticProps: GetStaticProps<NotFoundProps> = async () => {\n+  return {\n+    props: {\n+      message: 'Custom message fetched at build time',\n+    },\n+  }\n+}\n+\n+export default NotFound"
        },
        {
            "sha": "2da5fd5f318d552787de011b5ea17ceeaffab9eb",
            "filename": "test/e2e/app-dir/not-found-with-pages-i18n/pages/[[...slug]].tsx",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fpages%2F%5B%5B...slug%5D%5D.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc134fc1707aabd1906e60ca2bd6657bafe00546/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fpages%2F%5B%5B...slug%5D%5D.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnot-found-with-pages-i18n%2Fpages%2F%5B%5B...slug%5D%5D.tsx?ref=fc134fc1707aabd1906e60ca2bd6657bafe00546",
            "patch": "@@ -0,0 +1,39 @@\n+import React from 'react'\n+\n+export const getStaticProps = ({ params }: { params: { slug: string[] } }) => {\n+  try {\n+    const slugArray = Array.isArray(params.slug) ? params.slug : [params.slug]\n+\n+    const isValidPath =\n+      slugArray.length === 1 &&\n+      (slugArray[0] === 'about' || slugArray[0] === 'contact')\n+\n+    if (!isValidPath) {\n+      return {\n+        notFound: true,\n+      }\n+    }\n+\n+    return {\n+      props: {\n+        slug: params.slug,\n+      },\n+    }\n+  } catch (error) {\n+    throw error\n+  }\n+}\n+\n+export const getStaticPaths = async () => ({\n+  paths: [],\n+  fallback: 'blocking',\n+})\n+\n+const CatchAll = () => (\n+  <div>\n+    <h1>Catch All</h1>\n+    <p>This is a catch all page added to the pages router</p>\n+  </div>\n+)\n+\n+export default CatchAll"
        }
    ],
    "stats": {
        "total": 186,
        "additions": 186,
        "deletions": 0
    }
}