{
    "author": "mhart",
    "message": "Ensure getServerInsertedHTML skips rendering correctly (#85394)\n\n### Problem\n\nBoth `polyfillTags` and `traceMetaTags` are only rendered if they\nhaven't already been flushed, however the current check to skip\nrendering (lines 81-89) doesn't take this into account – only the render\nlogic does (lines 93-98).\n\nThis results in `renderToReadableStream` being called (potentially\nthousands of times – [for each\nchunk](https://github.com/vercel/next.js/blob/498349c375e2602f526f64e8366992066cfa872c/packages/next/src/server/stream-utils/node-web-streams-helper.ts#L368)\nin the [head insertion transform stream in the transformer\nchain](https://github.com/vercel/next.js/blob/498349c375e2602f526f64e8366992066cfa872c/packages/next/src/server/stream-utils/node-web-streams-helper.ts#L834)),\nconstructing new `ReadableStream`s each time, just to render empty\nstrings.\n\nIt's present in canary/v16 and I suspect it was introduced in v15 (so\ncan be backported). The logic check for v14 looks correct.\n\n### Solution\n\nThis PR ensures the shortcut check lines up with the render logic by\njust zeroing tag arrays after they've been used. There are a number of\nways to achieve the same result – including just adding the\n`hasFlushedInitially` check to the shortcut logic – however this would\nresult in the logic still being split in two places, so I've chosen one\nway to ensure the logic is centralized. Happy with whatever method is\npreferred here.\n\n### Results\n\nThis results in a 10-38% perf improvement end-to-end, especially for\nlarge renders. Eg, in [theo's\nbenchmark](https://github.com/t3dotgg/cf-vs-vercel-bench/tree/main/next-bench)\nit brings the number of `renderToReadableStream` calls from 1745 here\ndown to just 1, which has a noticeable impact on end-to-end performance\n\nI've [created a repo to highlight/reproduce the\nproblem](https://github.com/mhart/next-server-inserted-fix) based off\nthat benchmark. The results from there:\n\n- Node.js: 1.18x faster\n- Deno: 1.38x faster\n- workerd: 1.24x faster\n- Bun: 1.15x faster\n\n---------\n\nCo-authored-by: Josh Story <story@hey.com>",
    "sha": "0bcdbe488f66761f669806b503e67762579b689b",
    "files": [
        {
            "sha": "70b3f0187324cadf629a17251f8e7a5f1cbb850d",
            "filename": "packages/next/src/server/app-render/make-get-server-inserted-html.tsx",
            "status": "modified",
            "additions": 10,
            "deletions": 15,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/0bcdbe488f66761f669806b503e67762579b689b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmake-get-server-inserted-html.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0bcdbe488f66761f669806b503e67762579b689b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmake-get-server-inserted-html.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmake-get-server-inserted-html.tsx?ref=0bcdbe488f66761f669806b503e67762579b689b",
            "patch": "@@ -26,12 +26,14 @@ export function makeGetServerInsertedHTML({\n   basePath: string\n }) {\n   let flushedErrorMetaTagsUntilIndex = 0\n-  // flag for static content that only needs to be flushed once\n-  let hasFlushedInitially = false\n \n-  const polyfillTags = polyfills.map((polyfill) => {\n+  // These only need to be rendered once, they'll be set to empty arrays once flushed.\n+  let polyfillTags = polyfills.map((polyfill) => {\n     return <script key={polyfill.src} {...polyfill} />\n   })\n+  let traceMetaTags = (tracingMetadata || []).map(({ key, value }, index) => (\n+    <meta key={`next-trace-data-${index}`} name={key} content={value} />\n+  ))\n \n   return async function getServerInsertedHTML() {\n     // Loop through all the errors that have been captured but not yet\n@@ -69,12 +71,6 @@ export function makeGetServerInsertedHTML({\n       }\n     }\n \n-    const traceMetaTags = (tracingMetadata || []).map(\n-      ({ key, value }, index) => (\n-        <meta key={`next-trace-data-${index}`} name={key} content={value} />\n-      )\n-    )\n-\n     const serverInsertedHTML = renderServerInsertedHTML()\n \n     // Skip React rendering if we know the content is empty.\n@@ -90,12 +86,9 @@ export function makeGetServerInsertedHTML({\n \n     const stream = await renderToReadableStream(\n       <>\n-        {\n-          /* Insert the polyfills if they haven't been flushed yet. */\n-          hasFlushedInitially ? null : polyfillTags\n-        }\n+        {polyfillTags}\n         {serverInsertedHTML}\n-        {hasFlushedInitially ? null : traceMetaTags}\n+        {traceMetaTags}\n         {errorMetaTags}\n       </>,\n       {\n@@ -105,7 +98,9 @@ export function makeGetServerInsertedHTML({\n       }\n     )\n \n-    hasFlushedInitially = true\n+    // The polyfills and trace metadata have been flushed, so they don't need to be rendered again\n+    polyfillTags = []\n+    traceMetaTags = []\n \n     // There's no need to wait for the stream to be ready\n     // e.g. calling `await stream.allReady` because `streamToString` will"
        },
        {
            "sha": "179630e478ea8b57a0f3f60b9f0699a173b31e6a",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/0bcdbe488f66761f669806b503e67762579b689b/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0bcdbe488f66761f669806b503e67762579b689b/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=0bcdbe488f66761f669806b503e67762579b689b",
            "patch": "@@ -3251,13 +3251,13 @@ describe('Cache Components Errors', () => {\n                      at ScrollAndFocusHandler (bundler:///<next-src>)\n                      at RenderFromTemplateContext (bundler:///<next-src>)\n                      at OuterLayoutRouter (bundler:///<next-src>)\n-                   339 |  */\n-                   340 | function InnerLayoutRouter({\n-                 > 341 |   tree,\n+                   332 |  */\n+                   333 | function InnerLayoutRouter({\n+                 > 334 |   tree,\n                        |   ^\n-                   342 |   segmentPath,\n-                   343 |   debugNameContext,\n-                   344 |   cacheNode,\n+                   335 |   segmentPath,\n+                   336 |   debugNameContext,\n+                   337 |   cacheNode,\n                  To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-without-suspense\" in your browser to investigate the error.\n                  Error occurred prerendering page \"/use-cache-private-without-suspense\". Read more: https://nextjs.org/docs/messages/prerender-error\n "
        }
    ],
    "stats": {
        "total": 37,
        "additions": 16,
        "deletions": 21
    }
}