{
    "author": "devjiwonchoi",
    "message": "CI: Enable `experimental.isolatedDevBuild` for `test-integration` (#84558)\n\nEnabling `experimental.isolatedDevBuild` required many changes to the\ncurrent workflow, so we will incrementally roll out to the tests.\n\nEnabling on test-integration instead of test-experimental-integration\nbecause `-experimental` CIs are filtered via\n`experimental-tests-manifest.json` and they don't cover all tests. We\nwant to enable this feature by default so we should ensure this\nincremental rollout is covered on all test cases.\n\n1. ~~test-experimental-dev\n([link](https://github.com/vercel/next.js/pull/84099))~~\n2. test-dev ([link](https://github.com/vercel/next.js/pull/84562))\n2. test-prod ([link](https://github.com/vercel/next.js/pull/84556))\n3. test-integration (here)\n4. test-unit\n5. Enable by default, remove the flag, and update the rest\n\nx-ref: https://github.com/vercel/next.js/pull/84043",
    "sha": "f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
    "files": [
        {
            "sha": "b89e9d3a8c23e936d5b74613252604d475520702",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -888,6 +888,7 @@ jobs:\n       afterBuild: |\n         export IS_WEBPACK_TEST=1\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n+        export __NEXT_EXPERIMENTAL_ISOLATED_DEV_BUILD=true\n \n         node run-tests.js \\\n           --timings \\"
        },
        {
            "sha": "0ee059bf0dcaa8a571b5dac5510754dbe5521913",
            "filename": "test/integration/api-support/test/index.test.js",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fapi-support%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fapi-support%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapi-support%2Ftest%2Findex.test.js?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -19,12 +19,21 @@ import {\n import json from '../big.json'\n \n const appDir = join(__dirname, '../')\n+const originalIsNextDev = global.isNextDev\n let appPort\n let stderr\n let mode\n let app\n \n function runTests(dev = false) {\n+  beforeAll(() => {\n+    // isNextDev is used for getDistDir, where it is used for reading the build manifest files.\n+    global.isNextDev = dev\n+  })\n+  afterAll(() => {\n+    global.isNextDev = originalIsNextDev\n+  })\n+\n   it('should not strip .json from API route', async () => {\n     const res = await fetchViaHTTP(appPort, '/api/hello.json')\n     expect(res.status).toBe(200)"
        },
        {
            "sha": "46569866cb0a8b5378266761d2b64d1e135f261a",
            "filename": "test/integration/dist-dir/test/index.test.js",
            "status": "modified",
            "additions": 18,
            "deletions": 6,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fdist-dir%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fdist-dir%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fdist-dir%2Ftest%2Findex.test.js?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -10,6 +10,7 @@ import {\n   killApp,\n   renderViaHTTP,\n   launchApp,\n+  getDistDir,\n } from 'next-test-utils'\n \n const appDir = join(__dirname, '../')\n@@ -42,7 +43,9 @@ describe('distDir', () => {\n           ).toBeTruthy()\n         })\n         it('should not build the app within the default `.next` directory', async () => {\n-          expect(await fs.exists(join(__dirname, '/../.next'))).toBeFalsy()\n+          expect(\n+            await fs.exists(join(__dirname, `/../${getDistDir()}`))\n+          ).toBeFalsy()\n         })\n       }\n     )\n@@ -51,7 +54,7 @@ describe('distDir', () => {\n     'development mode',\n     () => {\n       beforeAll(async () => {\n-        await fs.remove(join(appDir, '.next'))\n+        await fs.remove(join(appDir, getDistDir()))\n         await fs.remove(join(appDir, 'dist'))\n         appPort = await findPort()\n         app = await launchApp(appDir, appPort)\n@@ -64,12 +67,21 @@ describe('distDir', () => {\n       })\n \n       it('should build the app within the given `dist` directory', async () => {\n-        expect(\n-          await fs.exists(join(__dirname, `/../dist/${BUILD_MANIFEST}`))\n-        ).toBeTruthy()\n+        // In isolated dev build, the distDir for development is `distDir/dev`\n+        if (process.env.__NEXT_EXPERIMENTAL_ISOLATED_DEV_BUILD === 'true') {\n+          expect(\n+            await fs.exists(join(__dirname, `/../dist/dev/${BUILD_MANIFEST}`))\n+          ).toBeTruthy()\n+        } else {\n+          expect(\n+            await fs.exists(join(__dirname, `/../dist/${BUILD_MANIFEST}`))\n+          ).toBeTruthy()\n+        }\n       })\n       it('should not build the app within the default `.next` directory', async () => {\n-        expect(await fs.exists(join(__dirname, '/../.next'))).toBeFalsy()\n+        expect(\n+          await fs.exists(join(__dirname, `/../${getDistDir()}`))\n+        ).toBeFalsy()\n       })\n     }\n   )"
        },
        {
            "sha": "75335fc5c9abe6681f39bd056ef5607224db637a",
            "filename": "test/integration/externals-pages-bundle/test/externals.test.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fexternals-pages-bundle%2Ftest%2Fexternals.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fexternals-pages-bundle%2Ftest%2Fexternals.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fexternals-pages-bundle%2Ftest%2Fexternals.test.js?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -8,6 +8,7 @@ import {\n   findPort,\n   File,\n   renderViaHTTP,\n+  getDistDir,\n } from 'next-test-utils'\n \n const appDir = join(__dirname, '../')\n@@ -17,11 +18,14 @@ describe('default', () => {\n     const port = await findPort()\n     const config = new File(join(appDir, 'next.config.js'))\n     config.delete()\n+    const originalIsNextDev = global.isNextDev\n     try {\n+      // launchApp is for dev mode, and isNextDev is used in getDistDir\n+      global.isNextDev = true\n       const app = await launchApp(appDir, port)\n       await renderViaHTTP(port, '/')\n       if (process.env.IS_TURBOPACK_TEST) {\n-        const ssrPath = join(appDir, '.next/server/chunks/ssr')\n+        const ssrPath = join(appDir, `${getDistDir()}/server/chunks/ssr`)\n         const pageBundleBasenames = (await fs.readdir(ssrPath)).filter((p) =>\n           p.match(/\\.js$/)\n         )\n@@ -37,14 +41,15 @@ describe('default', () => {\n         expect(allBundles).not.toContain('\"external-package content\"')\n       } else {\n         const output = await fs.readFile(\n-          join(appDir, '.next/server/pages/index.js'),\n+          join(appDir, `${getDistDir()}/server/pages/index.js`),\n           'utf8'\n         )\n         expect(output).toContain('require(\"external-package\")')\n       }\n       await killApp(app)\n     } finally {\n       config.restore()\n+      global.isNextDev = originalIsNextDev\n     }\n   })\n })"
        },
        {
            "sha": "3e99e56f4ff9c4790f55ea337ed4398d6ae6353e",
            "filename": "test/integration/image-optimizer/test/content-disposition-type.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fcontent-disposition-type.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fcontent-disposition-type.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fcontent-disposition-type.test.ts?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -2,12 +2,10 @@ import { join } from 'path'\n import { setupTests } from './util'\n \n const appDir = join(__dirname, '../app')\n-const imagesDir = join(appDir, '.next', 'cache', 'images')\n \n describe('with contentDispositionType inline', () => {\n   setupTests({\n     nextConfigImages: { contentDispositionType: 'inline' },\n     appDir,\n-    imagesDir,\n   })\n })"
        },
        {
            "sha": "059840526bc93f2bfd3516fdc719e13f67ce7c48",
            "filename": "test/integration/image-optimizer/test/dangerously-allow-svg.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fdangerously-allow-svg.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fdangerously-allow-svg.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fdangerously-allow-svg.test.ts?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -2,12 +2,10 @@ import { join } from 'path'\n import { setupTests } from './util'\n \n const appDir = join(__dirname, '../app')\n-const imagesDir = join(appDir, '.next', 'cache', 'images')\n \n describe('with dangerouslyAllowSVG config', () => {\n   setupTests({\n     nextConfigImages: { dangerouslyAllowSVG: true },\n     appDir,\n-    imagesDir,\n   })\n })"
        },
        {
            "sha": "2d5efd9c188a3e8330c5413a2122bd5092f2b6a5",
            "filename": "test/integration/image-optimizer/test/disable-write-to-cache-dir.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fdisable-write-to-cache-dir.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fdisable-write-to-cache-dir.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fdisable-write-to-cache-dir.test.ts?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -2,12 +2,10 @@ import { join } from 'path'\n import { setupTests } from './util'\n \n const appDir = join(__dirname, '../app')\n-const imagesDir = join(appDir, '.next', 'cache', 'images')\n \n describe('with isrFlushToDisk false config', () => {\n   setupTests({\n     appDir,\n-    imagesDir,\n     nextConfigExperimental: { isrFlushToDisk: false },\n   })\n })"
        },
        {
            "sha": "1dc50d83ba50a5d42abdffa9d28967e60a339ba1",
            "filename": "test/integration/image-optimizer/test/index.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 8,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Findex.test.ts?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -10,12 +10,13 @@ import {\n   nextStart,\n   retry,\n   waitFor,\n+  getDistDir,\n } from 'next-test-utils'\n import { join } from 'path'\n import { cleanImagesDir, expectWidth, fsToJson } from './util'\n \n const appDir = join(__dirname, '../app')\n-const imagesDir = join(appDir, '.next', 'cache', 'images')\n+const imagesDir = join(appDir, getDistDir(), 'cache', 'images')\n const nextConfig = new File(join(appDir, 'next.config.js'))\n const largeSize = 1080 // defaults defined in server/config.ts\n \n@@ -718,7 +719,7 @@ describe('Image Optimizer', () => {\n       }`\n           )\n           await nextBuild(appDir)\n-          await cleanImagesDir({ imagesDir })\n+          await cleanImagesDir(imagesDir)\n           appPort = await findPort()\n           app = await nextStart(appDir, appPort)\n         })\n@@ -786,7 +787,7 @@ describe('Image Optimizer', () => {\n         },\n       })\n       nextConfig.replace('{ /* replaceme */ }', json)\n-      await cleanImagesDir({ imagesDir })\n+      await cleanImagesDir(imagesDir)\n       appPort = await findPort()\n       app = await launchApp(appDir, appPort)\n     })\n@@ -816,7 +817,7 @@ describe('Image Optimizer', () => {\n           },\n         })\n       )\n-      await cleanImagesDir({ imagesDir })\n+      await cleanImagesDir(imagesDir)\n       appPort = await findPort()\n       app = await launchApp(appDir, appPort)\n     })\n@@ -846,7 +847,7 @@ describe('Image Optimizer', () => {\n           },\n         })\n       )\n-      await cleanImagesDir({ imagesDir })\n+      await cleanImagesDir(imagesDir)\n       appPort = await findPort()\n       app = await launchApp(appDir, appPort)\n     })\n@@ -884,7 +885,7 @@ describe('Image Optimizer', () => {\n       }`\n           nextConfig.replace('{ /* replaceme */ }', newConfig)\n           await nextBuild(appDir)\n-          await cleanImagesDir({ imagesDir })\n+          await cleanImagesDir(imagesDir)\n           appPort = await findPort()\n           app = await nextStart(appDir, appPort)\n         })\n@@ -894,7 +895,7 @@ describe('Image Optimizer', () => {\n         })\n \n         it('should return response when image is served from an external rewrite', async () => {\n-          await cleanImagesDir({ imagesDir })\n+          await cleanImagesDir(imagesDir)\n \n           const query = { url: '/next-js/next-js-bg.png', w: 64, q: 75 }\n           const opts = { headers: { accept: 'image/webp' } }\n@@ -943,7 +944,7 @@ describe('Image Optimizer', () => {\n         },\n       })\n       nextConfig.replace('{ /* replaceme */ }', json)\n-      await cleanImagesDir({ imagesDir })\n+      await cleanImagesDir(imagesDir)\n       appPort = await findPort()\n       app = await launchApp(appDir, appPort)\n     })"
        },
        {
            "sha": "73c2c810621e12d247c1ed65d616d7e30a065453",
            "filename": "test/integration/image-optimizer/test/minimum-cache-ttl.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fminimum-cache-ttl.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fminimum-cache-ttl.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fminimum-cache-ttl.test.ts?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -2,7 +2,6 @@ import { join } from 'path'\n import { setupTests } from './util'\n \n const appDir = join(__dirname, '../app')\n-const imagesDir = join(appDir, '.next', 'cache', 'images')\n \n describe('with minimumCacheTTL of 5 sec', () => {\n   setupTests({\n@@ -21,6 +20,5 @@ describe('with minimumCacheTTL of 5 sec', () => {\n       minimumCacheTTL: 5,\n     },\n     appDir,\n-    imagesDir,\n   })\n })"
        },
        {
            "sha": "2a48ccd71568ff4e74211b26ccb2ac7d45295368",
            "filename": "test/integration/image-optimizer/test/sharp.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fsharp.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fsharp.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fsharp.test.ts?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -2,8 +2,7 @@ import { join } from 'path'\n import { setupTests } from './util'\n \n const appDir = join(__dirname, '../app')\n-const imagesDir = join(appDir, '.next', 'cache', 'images')\n \n describe('with latest sharp', () => {\n-  setupTests({ appDir, imagesDir })\n+  setupTests({ appDir })\n })"
        },
        {
            "sha": "dbc96e1116e91ba41e58f7be22c132c96720e6f5",
            "filename": "test/integration/image-optimizer/test/util.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 18,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -8,6 +8,7 @@ import {\n   fetchViaHTTP,\n   File,\n   findPort,\n+  getDistDir,\n   killApp,\n   launchApp,\n   nextBuild,\n@@ -20,7 +21,6 @@ import type { NextConfig } from 'next'\n \n type SetupTestsCtx = {\n   appDir: string\n-  imagesDir: string\n   nextConfigImages?: Partial<import('next').NextConfig['images']>\n   nextConfigExperimental?: Partial<import('next').NextConfig['experimental']>\n   isDev?: boolean\n@@ -29,6 +29,7 @@ type SetupTestsCtx = {\n type RunTestsCtx = SetupTestsCtx & {\n   w: number\n   q: number\n+  imagesDir: string\n   app?: import('child_process').ChildProcess\n   appDir?: string\n   appPort?: number\n@@ -98,9 +99,9 @@ export async function expectWidth(res, w, { expectAnimated = false } = {}) {\n   expect(isAnimated(buffer)).toBe(expectAnimated)\n }\n \n-export const cleanImagesDir = async (ctx: { imagesDir: string }) => {\n-  console.warn('Cleaning', ctx.imagesDir)\n-  await fs.remove(ctx.imagesDir)\n+export const cleanImagesDir = async (imagesDir) => {\n+  console.warn('Cleaning', imagesDir)\n+  await fs.remove(imagesDir)\n }\n \n async function expectAvifSmallerThanWebp(\n@@ -156,7 +157,7 @@ async function fetchWithDuration(\n }\n \n export function runTests(ctx: RunTestsCtx) {\n-  const { isDev, nextConfigImages } = ctx\n+  const { isDev, nextConfigImages, imagesDir } = ctx\n   const {\n     contentDispositionType = 'attachment',\n     domains = [],\n@@ -932,7 +933,7 @@ export function runTests(ctx: RunTestsCtx) {\n       if (ctx.nextConfigExperimental?.isrFlushToDisk === false) {\n         return // this test is not applicable when we don't write the cache\n       }\n-      await cleanImagesDir(ctx)\n+      await cleanImagesDir(imagesDir)\n       const delay = 500\n \n       const url = `http://localhost:${slowImageServer.port}/slow.png?delay=${delay}`\n@@ -1154,7 +1155,7 @@ export function runTests(ctx: RunTestsCtx) {\n     if (ctx.nextConfigExperimental?.isrFlushToDisk === false) {\n       return // this test is not applicable when we don't write the cache\n     }\n-    await cleanImagesDir(ctx)\n+    await cleanImagesDir(imagesDir)\n \n     const query = {\n       url: '/api/stateful/test.png',\n@@ -1261,7 +1262,7 @@ export function runTests(ctx: RunTestsCtx) {\n \n   if (ctx.nextConfigImages?.dangerouslyAllowSVG) {\n     it('should use cached image file when parameters are the same for svg', async () => {\n-      await cleanImagesDir(ctx)\n+      await cleanImagesDir(imagesDir)\n \n       const query = { url: '/test.svg', w: ctx.w, q: ctx.q }\n       const opts = { headers: { accept: 'image/webp' } }\n@@ -1301,7 +1302,7 @@ export function runTests(ctx: RunTestsCtx) {\n     if (ctx.nextConfigExperimental?.isrFlushToDisk === false) {\n       return // this test is not applicable when we don't write the cache\n     }\n-    await cleanImagesDir(ctx)\n+    await cleanImagesDir(imagesDir)\n \n     const query = { url: '/animated.gif', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n@@ -1490,7 +1491,7 @@ export function runTests(ctx: RunTestsCtx) {\n \n   if (domains.length > 0) {\n     it('should handle concurrent requests', async () => {\n-      await cleanImagesDir(ctx)\n+      await cleanImagesDir(ctx.imagesDir)\n       const delay = 500\n       const query = {\n         url: `http://localhost:${slowImageServer.port}/slow.png?delay=${delay}`,\n@@ -1552,17 +1553,28 @@ export function runTests(ctx: RunTestsCtx) {\n export const setupTests = (ctx: SetupTestsCtx) => {\n   const nextConfig = new File(join(ctx.appDir, 'next.config.js'))\n \n+  const originalIsNextDev = (global as any).isNextDev\n+  afterAll(() => {\n+    ;(global as any).isNextDev = originalIsNextDev\n+  })\n+\n   describe('dev support w/o next.config.js', () => {\n     if (ctx.nextConfigImages) {\n       // skip this test because it requires next.config.js\n       return\n     }\n+\n+    const isDev = true\n+    // Set global.isNextDev for getDistDir()\n+    ;(global as any).isNextDev = isDev\n+    const imagesDir = join(ctx.appDir, getDistDir(), 'cache', 'images')\n     const size = 384 // defaults defined in server/config.ts\n     const curCtx: RunTestsCtx = {\n       ...ctx,\n       w: size,\n       q: 75,\n-      isDev: true,\n+      isDev,\n+      imagesDir,\n     }\n \n     beforeAll(async () => {\n@@ -1580,7 +1592,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n         },\n         cwd: curCtx.appDir,\n       })\n-      await cleanImagesDir(ctx)\n+      await cleanImagesDir(imagesDir)\n     })\n     afterAll(async () => {\n       nextConfig.restore()\n@@ -1591,12 +1603,16 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n   })\n \n   describe('dev support with next.config.js', () => {\n+    const isDev = true\n+    // Set global.isNextDev for getDistDir()\n+    ;(global as any).isNextDev = isDev\n+    const imagesDir = join(ctx.appDir, getDistDir(), 'cache', 'images')\n     const size = 400\n     const curCtx: RunTestsCtx = {\n       ...ctx,\n       w: size,\n       q: 100,\n-      isDev: true,\n+      isDev,\n       nextConfigImages: {\n         domains: [\n           'localhost',\n@@ -1611,6 +1627,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n         qualities: [50, 75, 100],\n         ...ctx.nextConfigImages,\n       },\n+      imagesDir,\n     }\n     beforeAll(async () => {\n       const json = JSON.stringify({\n@@ -1621,7 +1638,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n       } satisfies NextConfig)\n       curCtx.nextOutput = ''\n       nextConfig.replace('{ /* replaceme */ }', json)\n-      await cleanImagesDir(ctx)\n+      await cleanImagesDir(imagesDir)\n       curCtx.appPort = await findPort()\n       curCtx.app = await launchApp(curCtx.appDir, curCtx.appPort, {\n         onStderr(msg) {\n@@ -1644,12 +1661,16 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n       // skip this test because it requires next.config.js\n       return\n     }\n+    const isDev = false\n+    ;(global as any).isNextDev = isDev\n+    const imagesDir = join(ctx.appDir, getDistDir(), 'cache', 'images')\n     const size = 384 // defaults defined in server/config.ts\n     const curCtx: RunTestsCtx = {\n       ...ctx,\n       w: size,\n       q: 75,\n-      isDev: false,\n+      isDev,\n+      imagesDir,\n     }\n     beforeAll(async () => {\n       const json = JSON.stringify({\n@@ -1660,7 +1681,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n       nextConfig.replace('{ /* replaceme */ }', json)\n       curCtx.nextOutput = ''\n       await nextBuild(curCtx.appDir)\n-      await cleanImagesDir(ctx)\n+      await cleanImagesDir(imagesDir)\n       curCtx.appPort = await findPort()\n       curCtx.app = await nextStart(curCtx.appDir, curCtx.appPort, {\n         onStderr(msg) {\n@@ -1679,12 +1700,15 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n   ;(process.env.TURBOPACK_DEV || process.env.TURBOPACK_BUILD\n     ? describe.skip\n     : describe)('Production Mode Server support with next.config.js', () => {\n+    const isDev = false\n+    ;(global as any).isNextDev = isDev\n+    const imagesDir = join(ctx.appDir, getDistDir(), 'cache', 'images')\n     const size = 399\n     const curCtx: RunTestsCtx = {\n       ...ctx,\n       w: size,\n       q: 100,\n-      isDev: false,\n+      isDev,\n       nextConfigImages: {\n         domains: [\n           'localhost',\n@@ -1698,6 +1722,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n         qualities: [50, 75, 100],\n         ...ctx.nextConfigImages,\n       },\n+      imagesDir,\n     }\n     beforeAll(async () => {\n       const json = JSON.stringify({\n@@ -1709,7 +1734,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n       curCtx.nextOutput = ''\n       nextConfig.replace('{ /* replaceme */ }', json)\n       await nextBuild(curCtx.appDir)\n-      await cleanImagesDir(ctx)\n+      await cleanImagesDir(imagesDir)\n       curCtx.appPort = await findPort()\n       curCtx.app = await nextStart(curCtx.appDir, curCtx.appPort, {\n         onStderr(msg) {"
        },
        {
            "sha": "0ade9334d827956bfde71af55a0be0ecb8cf5438",
            "filename": "test/integration/ondemand/test/index.test.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fondemand%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Fondemand%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fondemand%2Ftest%2Findex.test.js?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -33,10 +33,15 @@ const startServer = async (optEnv = {}, opts) => {\n   'On Demand Entries',\n   () => {\n     it('should pass', () => {})\n+    const originalIsNextDev = global.isNextDev\n     beforeAll(async () => {\n+      // The server.js sets \"dev\" via process.env.NODE_ENV.\n+      // isNextDev is used for getDistDir, where it is used for reading the build manifest files.\n+      global.isNextDev = process.env.NODE_ENV !== 'production'\n       await startServer()\n     })\n     afterAll(async () => {\n+      global.isNextDev = originalIsNextDev\n       await killApp(context.server)\n     })\n "
        },
        {
            "sha": "cbb9179a787590385db5822ff4356a01a3a972dc",
            "filename": "test/integration/trailing-slash-dist/test/index.test.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Ftrailing-slash-dist%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Ftrailing-slash-dist%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftrailing-slash-dist%2Ftest%2Findex.test.js?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -11,11 +11,17 @@ import {\n } from 'next-test-utils'\n \n const appDir = join(__dirname, '../')\n-\n+const originalIsNextDev = global.isNextDev\n let appPort\n let app\n \n const runTest = (mode = 'server') => {\n+  beforeAll(() => {\n+    global.isNextDev = mode === 'dev'\n+  })\n+  afterAll(() => {\n+    global.isNextDev = originalIsNextDev\n+  })\n   it('supports trailing slash', async () => {\n     // Make sure the page is built before getting the file\n     await renderViaHTTP(appPort, '/')"
        },
        {
            "sha": "eb5a0a98b32fa8498fcd0d37d243f01d7bd31351",
            "filename": "test/integration/typescript-app-type-declarations/test/index.test.js",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.js?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -8,6 +8,18 @@ const appDir = join(__dirname, '..')\n const appTypeDeclarations = join(appDir, 'next-env.d.ts')\n \n describe('TypeScript App Type Declarations', () => {\n+  if (process.env.__NEXT_EXPERIMENTAL_ISOLATED_DEV_BUILD === 'true') {\n+    it.skip('should skip on isolated dev build', () => {\n+      // We use static fixture \"next-env.d.ts\" but the content should differ\n+      // based on the isolated dev build flag. We can't do something like\n+      // \"next-env-dev.d.ts\" because Next.js Types Plugin emits a file\n+      // \"next-env.d.ts\", and we have to change its behavior for this test case.\n+      // Rather than that, just skip the test as we're going to remove this flag soon.\n+      // Then modify the content to be \".next/dev/types/routes.d.ts\"\n+    })\n+    return\n+  }\n+\n   it('should write a new next-env.d.ts if none exist', async () => {\n     const prevContent = await fs.readFile(appTypeDeclarations, 'utf8')\n     try {"
        },
        {
            "sha": "740ea159e1f319a920ee43c7bc108bc2e9062dae",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 13,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=f9ca4b5ccd3b9c5ae08bbf14467cb7f85eb9f9af",
            "patch": "@@ -1226,11 +1226,11 @@ function readJson(path: string) {\n }\n \n export function getBuildManifest(dir: string) {\n-  return readJson(path.join(dir, '.next/build-manifest.json'))\n+  return readJson(path.join(dir, getDistDir(), 'build-manifest.json'))\n }\n \n export function getImagesManifest(dir: string) {\n-  return readJson(path.join(dir, '.next/images-manifest.json'))\n+  return readJson(path.join(dir, getDistDir(), 'images-manifest.json'))\n }\n \n export function getPageFilesFromBuildManifest(dir: string, page: string) {\n@@ -1250,7 +1250,7 @@ export function getContentOfPageFilesFromBuildManifest(\n   const pageFiles = getPageFilesFromBuildManifest(dir, page)\n \n   return pageFiles\n-    .map((file) => readFileSync(path.join(dir, '.next', file), 'utf8'))\n+    .map((file) => readFileSync(path.join(dir, getDistDir(), file), 'utf8'))\n     .join('\\n')\n }\n \n@@ -1271,17 +1271,17 @@ export function getPageFileFromBuildManifest(dir: string, page: string) {\n \n export function readNextBuildClientPageFile(appDir: string, page: string) {\n   const pageFile = getPageFileFromBuildManifest(appDir, page)\n-  return readFileSync(path.join(appDir, '.next', pageFile), 'utf8')\n+  return readFileSync(path.join(appDir, getDistDir(), pageFile), 'utf8')\n }\n \n export function getPagesManifest(dir: string) {\n-  const serverFile = path.join(dir, '.next/server/pages-manifest.json')\n+  const serverFile = path.join(dir, getDistDir(), 'server/pages-manifest.json')\n \n   return readJson(serverFile)\n }\n \n export function updatePagesManifest(dir: string, content: any) {\n-  const serverFile = path.join(dir, '.next/server/pages-manifest.json')\n+  const serverFile = path.join(dir, getDistDir(), 'server/pages-manifest.json')\n \n   return writeFile(serverFile, content)\n }\n@@ -1298,13 +1298,16 @@ export function getPageFileFromPagesManifest(dir: string, page: string) {\n \n export function readNextBuildServerPageFile(appDir: string, page: string) {\n   const pageFile = getPageFileFromPagesManifest(appDir, page)\n-  return readFileSync(path.join(appDir, '.next', 'server', pageFile), 'utf8')\n+  return readFileSync(\n+    path.join(appDir, getDistDir(), 'server', pageFile),\n+    'utf8'\n+  )\n }\n \n export function getClientBuildManifest(dir: string) {\n-  let buildId = readFileSync(path.join(dir, '.next/BUILD_ID'), 'utf8')\n+  let buildId = readFileSync(path.join(dir, getDistDir(), 'BUILD_ID'), 'utf8')\n   let code = readFileSync(\n-    path.join(dir, '.next/static', buildId, '_buildManifest.js'),\n+    path.join(dir, getDistDir(), 'static', buildId, '_buildManifest.js'),\n     'utf8'\n   )\n   // eslint-disable-next-line no-eval\n@@ -1887,11 +1890,10 @@ export function normalizeManifest<T>(\n   )\n }\n \n-export function getDistDir(isNextDev?: boolean): '.next' | '.next/dev' {\n+export function getDistDir(): '.next' | '.next/dev' {\n   // global.isNextDev is set in e2e/development/production tests.\n-  // TODO: If a test utils that are used in integration/unit tests can set\n-  // global.isNextDev flag, we could possibly remove the parameter.\n-  return (isNextDev ?? (global as any).isNextDev) &&\n+  // NEXT_TEST_MODE is set in CI or local test-* commands.\n+  return ((global as any).isNextDev || process.env.NEXT_TEST_MODE === 'dev') &&\n     // Flag for incremental rollout of isolated dev build, set in CI.\n     process.env.__NEXT_EXPERIMENTAL_ISOLATED_DEV_BUILD === 'true'\n     ? '.next/dev'"
        }
    ],
    "stats": {
        "total": 185,
        "additions": 127,
        "deletions": 58
    }
}