{
    "author": "wyattjoh",
    "message": "fix: handle parsing destination with patterns in hostname (#75973)\n\nThis handles when the rewrite destination is not a valid URL (as it's a\npattern anyways, containing characters like `:` for patterns like\n`:subdomain.google.com` which wouldn't be valid). This uses the existing\nescaping behaviour to extract the url parts.\n\nFixes https://github.com/vercel/next.js/issues/75956",
    "sha": "26bf734494709f76d11acf9411a02af9ec965b2e",
    "files": [
        {
            "sha": "8b62bd2880c98f14f29f799f672369c14abb701c",
            "filename": "packages/next/src/server/lib/router-utils/resolve-routes.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/26bf734494709f76d11acf9411a02af9ec965b2e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/26bf734494709f76d11acf9411a02af9ec965b2e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts?ref=26bf734494709f76d11acf9411a02af9ec965b2e",
            "patch": "@@ -33,6 +33,7 @@ import { addRequestMeta } from '../../request-meta'\n import {\n   compileNonPath,\n   matchHas,\n+  parseDestination,\n   prepareDestination,\n } from '../../../shared/lib/router/utils/prepare-destination'\n import type { TLSSocket } from 'tls'\n@@ -45,7 +46,6 @@ import {\n import { getSelectedParams } from '../../../client/components/router-reducer/compute-changed-path'\n import { isInterceptionRouteRewrite } from '../../../lib/generate-interception-routes-rewrites'\n import { parseAndValidateFlightRouterState } from '../../app-render/parse-and-validate-flight-router-state'\n-import { parseUrl } from '../../../shared/lib/router/utils/parse-url'\n \n const debug = setupDebug('next:router-server:resolve-routes')\n \n@@ -737,7 +737,11 @@ export function getResolveRoutes(\n           // the response headers. We don't want to use the following\n           // `parsedDestination` as the query object is mutated.\n           const { search: destinationSearch, pathname: destinationPathname } =\n-            parseUrl(route.destination)\n+            parseDestination({\n+              destination: route.destination,\n+              params: rewriteParams,\n+              query: parsedUrl.query,\n+            })\n \n           const { parsedDestination } = prepareDestination({\n             appendParamsToQuery: true,"
        },
        {
            "sha": "cbe9921f3e28db547073cda51f2f2343b64228e5",
            "filename": "packages/next/src/shared/lib/router/utils/prepare-destination.test.ts",
            "status": "added",
            "additions": 78,
            "deletions": 0,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/26bf734494709f76d11acf9411a02af9ec965b2e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/26bf734494709f76d11acf9411a02af9ec965b2e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts?ref=26bf734494709f76d11acf9411a02af9ec965b2e",
            "patch": "@@ -0,0 +1,78 @@\n+import { parseDestination } from './prepare-destination'\n+\n+describe('parseDestination', () => {\n+  it('should parse the destination', () => {\n+    const destination = '/hello/:name'\n+    const params = { name: 'world' }\n+    const query = { foo: 'bar' }\n+\n+    const result = parseDestination({\n+      destination,\n+      params,\n+      query,\n+    })\n+\n+    expect(result).toMatchInlineSnapshot(`\n+     {\n+       \"hash\": \"\",\n+       \"hostname\": undefined,\n+       \"href\": \"/hello/:name\",\n+       \"pathname\": \"/hello/:name\",\n+       \"query\": {},\n+       \"search\": \"\",\n+     }\n+    `)\n+  })\n+\n+  it('should parse the destination with a hash', () => {\n+    const destination = 'https://o:foo.com/hello/:name#bar'\n+    const params = { name: 'world' }\n+    const query = { foo: 'bar' }\n+\n+    const result = parseDestination({\n+      destination,\n+      params,\n+      query,\n+    })\n+\n+    expect(result).toMatchInlineSnapshot(`\n+     {\n+       \"hash\": \"#bar\",\n+       \"hostname\": \"o:foo.com\",\n+       \"href\": \"https://o:foo.com/hello/:name#bar\",\n+       \"pathname\": \"/hello/:name\",\n+       \"port\": \"\",\n+       \"protocol\": \"https:\",\n+       \"query\": {},\n+       \"search\": \"\",\n+     }\n+    `)\n+  })\n+\n+  it('should parse the destination with a host', () => {\n+    const destination = 'https://o:foo.com/hello/:name?foo=:bar'\n+    const params = { name: 'world' }\n+    const query = { foo: 'bar' }\n+\n+    const result = parseDestination({\n+      destination,\n+      params,\n+      query,\n+    })\n+\n+    expect(result).toMatchInlineSnapshot(`\n+     {\n+       \"hash\": \"\",\n+       \"hostname\": \"o:foo.com\",\n+       \"href\": \"https://o:foo.com/hello/:name?foo=:bar\",\n+       \"pathname\": \"/hello/:name\",\n+       \"port\": \"\",\n+       \"protocol\": \"https:\",\n+       \"query\": {\n+         \"foo\": \":bar\",\n+       },\n+       \"search\": \"?foo=:bar\",\n+     }\n+    `)\n+  })\n+})"
        },
        {
            "sha": "bfcae83b01230d65be70ee4c87d052401b2c8387",
            "filename": "packages/next/src/shared/lib/router/utils/prepare-destination.ts",
            "status": "modified",
            "additions": 70,
            "deletions": 19,
            "changes": 89,
            "blob_url": "https://github.com/vercel/next.js/blob/26bf734494709f76d11acf9411a02af9ec965b2e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/26bf734494709f76d11acf9411a02af9ec965b2e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts?ref=26bf734494709f76d11acf9411a02af9ec965b2e",
            "patch": "@@ -160,6 +160,49 @@ export function compileNonPath(value: string, params: Params): string {\n   return compile(`/${value}`, { validate: false })(params).slice(1)\n }\n \n+export function parseDestination(args: {\n+  destination: string\n+  params: Readonly<Params>\n+  query: Readonly<NextParsedUrlQuery>\n+}) {\n+  let escaped = args.destination\n+  for (const param of Object.keys({ ...args.params, ...args.query })) {\n+    if (!param) continue\n+\n+    escaped = escapeSegment(escaped, param)\n+  }\n+\n+  const parsed = parseUrl(escaped)\n+\n+  let pathname = parsed.pathname\n+  if (pathname) {\n+    pathname = unescapeSegments(pathname)\n+  }\n+\n+  let href = parsed.href\n+  if (href) {\n+    href = unescapeSegments(href)\n+  }\n+\n+  let hostname = parsed.hostname\n+  if (hostname) {\n+    hostname = unescapeSegments(hostname)\n+  }\n+\n+  let hash = parsed.hash\n+  if (hash) {\n+    hash = unescapeSegments(hash)\n+  }\n+\n+  return {\n+    ...parsed,\n+    pathname,\n+    hostname,\n+    href,\n+    hash,\n+  }\n+}\n+\n export function prepareDestination(args: {\n   appendParamsToQuery: boolean\n   destination: string\n@@ -169,29 +212,32 @@ export function prepareDestination(args: {\n   const query = Object.assign({}, args.query)\n   delete query[NEXT_RSC_UNION_QUERY]\n \n-  let escapedDestination = args.destination\n+  const parsedDestination = parseDestination(args)\n+\n+  const { hostname: destHostname, query: destQuery } = parsedDestination\n \n-  for (const param of Object.keys({ ...args.params, ...query })) {\n-    escapedDestination = param\n-      ? escapeSegment(escapedDestination, param)\n-      : escapedDestination\n+  // The following code assumes that the pathname here includes the hash if it's\n+  // present.\n+  let destPath = parsedDestination.pathname\n+  if (parsedDestination.hash) {\n+    destPath = `${destPath}${parsedDestination.hash}`\n   }\n \n-  const parsedDestination = parseUrl(escapedDestination)\n-  const destQuery = parsedDestination.query\n-  const destPath = unescapeSegments(\n-    `${parsedDestination.pathname!}${parsedDestination.hash || ''}`\n-  )\n-  const destHostname = unescapeSegments(parsedDestination.hostname || '')\n+  const destParams: (string | number)[] = []\n+\n   const destPathParamKeys: Key[] = []\n-  const destHostnameParamKeys: Key[] = []\n   pathToRegexp(destPath, destPathParamKeys)\n-  pathToRegexp(destHostname, destHostnameParamKeys)\n-\n-  const destParams: (string | number)[] = []\n+  for (const key of destPathParamKeys) {\n+    destParams.push(key.name)\n+  }\n \n-  destPathParamKeys.forEach((key) => destParams.push(key.name))\n-  destHostnameParamKeys.forEach((key) => destParams.push(key.name))\n+  if (destHostname) {\n+    const destHostnameParamKeys: Key[] = []\n+    pathToRegexp(destHostname, destHostnameParamKeys)\n+    for (const key of destHostnameParamKeys) {\n+      destParams.push(key.name)\n+    }\n+  }\n \n   const destPathCompiler = compile(\n     destPath,\n@@ -204,7 +250,10 @@ export function prepareDestination(args: {\n     { validate: false }\n   )\n \n-  const destHostnameCompiler = compile(destHostname, { validate: false })\n+  let destHostnameCompiler\n+  if (destHostname) {\n+    destHostnameCompiler = compile(destHostname, { validate: false })\n+  }\n \n   // update any params in query values\n   for (const [key, strOrArray] of Object.entries(destQuery)) {\n@@ -261,7 +310,9 @@ export function prepareDestination(args: {\n     newUrl = destPathCompiler(args.params)\n \n     const [pathname, hash] = newUrl.split('#', 2)\n-    parsedDestination.hostname = destHostnameCompiler(args.params)\n+    if (destHostnameCompiler) {\n+      parsedDestination.hostname = destHostnameCompiler(args.params)\n+    }\n     parsedDestination.pathname = pathname\n     parsedDestination.hash = `${hash ? '#' : ''}${hash || ''}`\n     delete (parsedDestination as any).search"
        }
    ],
    "stats": {
        "total": 175,
        "additions": 154,
        "deletions": 21
    }
}