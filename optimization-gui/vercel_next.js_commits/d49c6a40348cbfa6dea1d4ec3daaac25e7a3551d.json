{
    "author": "gaojude",
    "message": "overwrite redirect SSG meta.status to 200 for RSC requests (#80391)\n\nFor a static route that simply returns a `redirect`:\n```\nexport default function Page() {\n  redirect(\"/about\");\n}\n```\nthe SSG generates a `.meta` file for the route at build time, that looks\nlike:\n```\n{\n  \"status\": 307,\n  \"headers\": {\n    \"location\": \"/about\"\n  }\n}\n```\nOn `next start`, if a request matches this route, the status code is\nretrieved from the file and returned to the response. This is perfectly\nfine for DOC requests. However, if the request is an RSC request, its\nRSC payload should have already encoded the redirect instruction:\n```\n1:\"$Sreact.fragment\"\n2:I[657,[],\"\"]\n3:I[8597,[],\"\"]\n5:I[5975,[],\"OutletBoundary\"]\n8:I[4429,[],\"AsyncMetadataOutlet\"]\na:I[5975,[],\"ViewportBoundary\"]\nc:I[5975,[],\"MetadataBoundary\"]\ne:I[1363,[],\"\"]\n0:{\"P\":null,\"b\":\"gelhztYnmFGzccJ4F6F4T\",\"p\":\"\",\"c\":[\"\",\"rsc-redirect\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"rsc-redirect\",{\"children\":[\"__PAGE__\",{}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]]}],{\"children\":[\"rsc-redirect\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L4\",null,[\"$\",\"$L5\",null,{\"children\":[\"$L6\",\"$L7\",[\"$\",\"$L8\",null,{\"promise\":\"$@9\"}]]}]]}],{},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"0db7ba866b0656c433aa56ad545d5b104626108ev\",{\"children\":[[\"$\",\"$La\",null,{\"children\":\"$Lb\"}],null]}],[\"$\",\"$Lc\",null,{\"children\":\"$Ld\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$e\",\"$undefined\"],\"s\":false,\"S\":true}\n4:E{\"digest\":\"NEXT_REDIRECT;replace;/about;307;\"}\nf:\"$Sreact.suspense\"\n10:I[4429,[],\"AsyncMetadata\"]\nd:[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$f\",null,{\"fallback\":null,\"children\":[\"$\",\"$L10\",null,{\"promise\":\"$@11\"}]}]}]\n7:null\nb:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n6:null\n9:{\"metadata\":[],\"error\":null,\"digest\":\"$undefined\"}\n11:{\"metadata\":\"$9:metadata\",\"error\":null,\"digest\":\"$undefined\"}\n```\n\nSpecifically,\n```\n4:E{\"digest\":\"NEXT_REDIRECT;replace;/about;307;\"}\n```\n\nHence, it would be fine to simply return 200 status code.\n\nThere are two motivations for this change:\n1. This new behaviour is consistent with Next.js apps hosted on Vercel.\n(I.e., it returns 200 for static RSC even if the `meta.status = 307`)\n2. 307 redirect on RSC payload is an obstacle to enabling [RSC\nvalidation](https://github.com/vercel/next.js/pull/80157)",
    "sha": "d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d",
    "files": [
        {
            "sha": "aad1b98bfade066c7371a137f5319f5cf786205c",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d",
            "patch": "@@ -83,6 +83,7 @@ export const __next_app__ = {\n }\n \n import * as entryBase from '../../server/app-render/entry-base' with { 'turbopack-transition': 'next-server-utility' }\n+import { RedirectStatusCode } from '../../client/components/redirect-status-code'\n \n export * from '../../server/app-render/entry-base' with { 'turbopack-transition': 'next-server-utility' }\n \n@@ -999,6 +1000,16 @@ export async function handler(\n         res.statusCode = cachedData.status\n       }\n \n+      // Redirect information is encoded in RSC payload, so we don't need to use redirect status codes\n+      if (\n+        !minimalMode &&\n+        cachedData.status &&\n+        RedirectStatusCode[cachedData.status] &&\n+        isRSCRequest\n+      ) {\n+        res.statusCode = 200\n+      }\n+\n       // Mark that the request did postpone.\n       if (didPostpone) {\n         res.setHeader(NEXT_DID_POSTPONE_HEADER, '1')"
        },
        {
            "sha": "821179b23c0d8e1bea5f9e7be19e1b08531211e2",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d",
            "patch": "@@ -170,6 +170,7 @@ import { NoFallbackError } from '../shared/lib/no-fallback-error.external'\n import { getCacheHandlers } from './use-cache/handlers'\n import { fixMojibake } from './lib/fix-mojibake'\n import { computeCacheBustingSearchParam } from '../shared/lib/router/utils/cache-busting-search-param'\n+import { RedirectStatusCode } from '../client/components/redirect-status-code'\n \n export type FindComponentsResult = {\n   components: LoadComponentsReturnType\n@@ -3516,6 +3517,16 @@ export default abstract class Server<\n         res.statusCode = cachedData.status\n       }\n \n+      // Redirect information is encoded in RSC payload, so we don't need to use redirect status codes\n+      if (\n+        !this.minimalMode &&\n+        cachedData.status &&\n+        RedirectStatusCode[cachedData.status] &&\n+        isRSCRequest\n+      ) {\n+        res.statusCode = 200\n+      }\n+\n       // Mark that the request did postpone.\n       if (didPostpone) {\n         res.setHeader(NEXT_DID_POSTPONE_HEADER, '1')"
        },
        {
            "sha": "2734b67341498ed05dfb4f15c6b6a4cb87e97bcd",
            "filename": "test/e2e/app-dir/rsc-redirect/app/dest/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fdest%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fdest%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fdest%2Fpage.tsx?ref=d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d",
            "patch": "@@ -0,0 +1,9 @@\n+import React from 'react'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <h1>Destination</h1>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "9dfde1627512b37a73ed3912c0b31e351276e718",
            "filename": "test/e2e/app-dir/rsc-redirect/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Flayout.tsx?ref=d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d",
            "patch": "@@ -0,0 +1,9 @@\n+import React, { ReactNode } from 'react'\n+\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "9666763e75762d33ab7928e72137310bbaf2915c",
            "filename": "test/e2e/app-dir/rsc-redirect/app/origin/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Forigin%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Forigin%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Forigin%2Fpage.tsx?ref=d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d",
            "patch": "@@ -0,0 +1,5 @@\n+import { redirect } from 'next/navigation'\n+\n+export default function Page() {\n+  redirect('/dest')\n+}"
        },
        {
            "sha": "c0d0c27bb542651b6eb0c3dcf2cceae5cf35a12d",
            "filename": "test/e2e/app-dir/rsc-redirect/app/page.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fpage.tsx?ref=d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d",
            "patch": "@@ -0,0 +1,11 @@\n+import React from 'react'\n+import Link from 'next/link'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <h1>Home</h1>\n+      <Link href=\"/origin\">Go to Origin</Link>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "fd6f065421fa3e6a569d3deb396c980aeb2f3978",
            "filename": "test/e2e/app-dir/rsc-redirect/rsc-redirect.test.ts",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Frsc-redirect.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Frsc-redirect.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Frsc-redirect.test.ts?ref=d49c6a40348cbfa6dea1d4ec3daaac25e7a3551d",
            "patch": "@@ -0,0 +1,26 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { fetchViaHTTP } from 'next-test-utils'\n+\n+describe('rsc-redirect', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should get 307 status code for document request', async () => {\n+    const response = await fetchViaHTTP(next.url, '/origin', undefined, {\n+      redirect: 'manual',\n+    })\n+    expect(response.status).toBe(307)\n+  })\n+\n+  it('should get 200 status code for rsc request', async () => {\n+    // TODO: add RSC cache busting query param\n+    const response = await fetchViaHTTP(next.url, '/origin', undefined, {\n+      redirect: 'manual',\n+      headers: {\n+        RSC: '1',\n+      },\n+    })\n+    expect(response.status).toBe(200)\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 82,
        "deletions": 0
    }
}