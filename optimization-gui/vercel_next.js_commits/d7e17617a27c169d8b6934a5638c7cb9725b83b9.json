{
    "author": "ztanner",
    "message": "add debug logs to onSegmentPrerenderError (#86358)\n\nAdds logs to collectSegmentError when verbose logging is enabled to help\nidentify errors that occur during this phase.",
    "sha": "d7e17617a27c169d8b6934a5638c7cb9725b83b9",
    "files": [
        {
            "sha": "91dfce18d06327a768cdf992d7d56019a18494aa",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d7e17617a27c169d8b6934a5638c7cb9725b83b9/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d7e17617a27c169d8b6934a5638c7cb9725b83b9/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=d7e17617a27c169d8b6934a5638c7cb9725b83b9",
            "patch": "@@ -946,5 +946,6 @@\n   \"945\": \"createNodeStreamFromChunks cannot be used in the edge runtime\",\n   \"946\": \"Failed to deserialize errors.\",\n   \"947\": \"Expected `sendErrorsToBrowser` to be defined in renderOpts.\",\n-  \"948\": \"Failed to serialize errors.\"\n+  \"948\": \"Failed to serialize errors.\",\n+  \"949\": \"Route %s errored during %s. These errors are normally ignored and may not prevent the route from prerendering but are logged here because build debugging is enabled.\\n          \\nOriginal Error: %s\"\n }"
        },
        {
            "sha": "9382af5802590308c33e02c0a9a28a49a84da1dd",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 44,
            "deletions": 9,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/d7e17617a27c169d8b6934a5638c7cb9725b83b9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d7e17617a27c169d8b6934a5638c7cb9725b83b9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=d7e17617a27c169d8b6934a5638c7cb9725b83b9",
            "patch": "@@ -170,7 +170,10 @@ import {\n   createReactServerPrerenderResultFromRender,\n   prerenderAndAbortInSequentialTasks,\n } from './app-render-prerender-utils'\n-import { printDebugThrownValueForProspectiveRender } from './prospective-render-utils'\n+import {\n+  Phase,\n+  printDebugThrownValueForProspectiveRender,\n+} from './prospective-render-utils'\n import {\n   pipelineInSequentialTasks,\n   scheduleInSequentialTasks,\n@@ -1073,7 +1076,11 @@ async function prospectiveRuntimeServerPrerender(\n           process.env.NEXT_DEBUG_BUILD ||\n           process.env.__NEXT_VERBOSE_LOGGING\n         ) {\n-          printDebugThrownValueForProspectiveRender(err, workStore.route)\n+          printDebugThrownValueForProspectiveRender(\n+            err,\n+            workStore.route,\n+            Phase.ProspectiveRender\n+          )\n         }\n       },\n       // We don't want to stop rendering until the cacheSignal is complete so we pass\n@@ -1110,7 +1117,11 @@ async function prospectiveRuntimeServerPrerender(\n     ) {\n       // We don't normally log these errors because we are going to retry anyway but\n       // it can be useful for debugging Next.js itself to get visibility here when needed\n-      printDebugThrownValueForProspectiveRender(err, workStore.route)\n+      printDebugThrownValueForProspectiveRender(\n+        err,\n+        workStore.route,\n+        Phase.ProspectiveRender\n+      )\n     }\n     return null\n   }\n@@ -3832,7 +3843,11 @@ async function warmupModuleCacheForRuntimeValidationInDev(\n         ) {\n           // We don't normally log these errors because we are going to retry anyway but\n           // it can be useful for debugging Next.js itself to get visibility here when needed\n-          printDebugThrownValueForProspectiveRender(err, workStore.route)\n+          printDebugThrownValueForProspectiveRender(\n+            err,\n+            workStore.route,\n+            Phase.ProspectiveRender\n+          )\n         }\n       },\n       // We don't need bootstrap scripts in this prerender\n@@ -3863,7 +3878,11 @@ async function warmupModuleCacheForRuntimeValidationInDev(\n     ) {\n       // We don't normally log these errors because we are going to retry anyway but\n       // it can be useful for debugging Next.js itself to get visibility here when needed\n-      printDebugThrownValueForProspectiveRender(err, workStore.route)\n+      printDebugThrownValueForProspectiveRender(\n+        err,\n+        workStore.route,\n+        Phase.ProspectiveRender\n+      )\n     }\n   })\n \n@@ -4350,7 +4369,11 @@ async function prerenderToStream(\n               process.env.NEXT_DEBUG_BUILD ||\n               process.env.__NEXT_VERBOSE_LOGGING\n             ) {\n-              printDebugThrownValueForProspectiveRender(err, workStore.route)\n+              printDebugThrownValueForProspectiveRender(\n+                err,\n+                workStore.route,\n+                Phase.ProspectiveRender\n+              )\n             }\n           },\n           // We don't want to stop rendering until the cacheSignal is complete so we pass\n@@ -4402,7 +4425,11 @@ async function prerenderToStream(\n         ) {\n           // We don't normally log these errors because we are going to retry anyway but\n           // it can be useful for debugging Next.js itself to get visibility here when needed\n-          printDebugThrownValueForProspectiveRender(err, workStore.route)\n+          printDebugThrownValueForProspectiveRender(\n+            err,\n+            workStore.route,\n+            Phase.ProspectiveRender\n+          )\n         }\n       }\n \n@@ -4473,7 +4500,11 @@ async function prerenderToStream(\n               ) {\n                 // We don't normally log these errors because we are going to retry anyway but\n                 // it can be useful for debugging Next.js itself to get visibility here when needed\n-                printDebugThrownValueForProspectiveRender(err, workStore.route)\n+                printDebugThrownValueForProspectiveRender(\n+                  err,\n+                  workStore.route,\n+                  Phase.ProspectiveRender\n+                )\n               }\n             },\n             bootstrapScripts: [bootstrapScript],\n@@ -4503,7 +4534,11 @@ async function prerenderToStream(\n           ) {\n             // We don't normally log these errors because we are going to retry anyway but\n             // it can be useful for debugging Next.js itself to get visibility here when needed\n-            printDebugThrownValueForProspectiveRender(err, workStore.route)\n+            printDebugThrownValueForProspectiveRender(\n+              err,\n+              workStore.route,\n+              Phase.ProspectiveRender\n+            )\n           }\n         })\n "
        },
        {
            "sha": "3e54fad94d09440c148c410d3fd8f26940602a18",
            "filename": "packages/next/src/server/app-render/collect-segment-data.tsx",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/d7e17617a27c169d8b6934a5638c7cb9725b83b9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d7e17617a27c169d8b6934a5638c7cb9725b83b9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx?ref=d7e17617a27c169d8b6934a5638c7cb9725b83b9",
            "patch": "@@ -27,6 +27,11 @@ import {\n   HEAD_REQUEST_KEY,\n } from '../../shared/lib/segment-cache/segment-value-encoding'\n import { getDigestForWellKnownError } from './create-error-handler'\n+import {\n+  Phase,\n+  printDebugThrownValueForProspectiveRender,\n+} from './prospective-render-utils'\n+import { workAsyncStorage } from './work-async-storage.external'\n \n // Contains metadata about the route tree. The client must fetch this before\n // it can fetch any actual segment data.\n@@ -85,6 +90,14 @@ function onSegmentPrerenderError(error: unknown) {\n   }\n   // We don't need to log the errors because we would have already done that\n   // when generating the original Flight stream for the whole page.\n+  if (process.env.NEXT_DEBUG_BUILD || process.env.__NEXT_VERBOSE_LOGGING) {\n+    const workStore = workAsyncStorage.getStore()\n+    printDebugThrownValueForProspectiveRender(\n+      error,\n+      workStore?.route ?? 'unknown route',\n+      Phase.SegmentCollection\n+    )\n+  }\n }\n \n export async function collectSegmentData("
        },
        {
            "sha": "265d891dc5ec1c8291de1dafd7e91e1e75002ed8",
            "filename": "packages/next/src/server/app-render/prospective-render-utils.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/d7e17617a27c169d8b6934a5638c7cb9725b83b9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fprospective-render-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7e17617a27c169d8b6934a5638c7cb9725b83b9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fprospective-render-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fprospective-render-utils.ts?ref=d7e17617a27c169d8b6934a5638c7cb9725b83b9",
            "patch": "@@ -1,9 +1,15 @@\n import { getDigestForWellKnownError } from './create-error-handler'\n import { isReactLargeShellError } from './react-large-shell-error'\n \n+export enum Phase {\n+  ProspectiveRender = 'the prospective render',\n+  SegmentCollection = 'segment collection',\n+}\n+\n export function printDebugThrownValueForProspectiveRender(\n   thrownValue: unknown,\n-  route: string\n+  route: string,\n+  phase: Phase\n ) {\n   // We don't need to print well-known Next.js errors.\n   if (getDigestForWellKnownError(thrownValue)) {\n@@ -28,7 +34,7 @@ export function printDebugThrownValueForProspectiveRender(\n       const stackStart = originalErrorStack.indexOf('\\n')\n       if (stackStart > -1) {\n         const error = new Error(\n-          `Route ${route} errored during the prospective render. These errors are normally ignored and may not prevent the route from prerendering but are logged here because build debugging is enabled.\n+          `Route ${route} errored during ${phase}. These errors are normally ignored and may not prevent the route from prerendering but are logged here because build debugging is enabled.\n           \n Original Error: ${message}`\n         )\n@@ -43,14 +49,14 @@ Original Error: ${message}`\n   }\n \n   if (message) {\n-    console.error(`Route ${route} errored during the prospective render. These errors are normally ignored and may not prevent the route from prerendering but are logged here because build debugging is enabled. No stack was provided.\n+    console.error(`Route ${route} errored during ${phase}. These errors are normally ignored and may not prevent the route from prerendering but are logged here because build debugging is enabled. No stack was provided.\n           \n Original Message: ${message}`)\n     return\n   }\n \n   console.error(\n-    `Route ${route} errored during the prospective render. These errors are normally ignored and may not prevent the route from prerendering but are logged here because build debugging is enabled. The thrown value is logged just following this message`\n+    `Route ${route} errored during ${phase}. These errors are normally ignored and may not prevent the route from prerendering but are logged here because build debugging is enabled. The thrown value is logged just following this message`\n   )\n   console.error(thrownValue)\n   return"
        },
        {
            "sha": "02c305f041cee5c4aea2ca1bf67e8044a79494e0",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/d7e17617a27c169d8b6934a5638c7cb9725b83b9/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7e17617a27c169d8b6934a5638c7cb9725b83b9/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=d7e17617a27c169d8b6934a5638c7cb9725b83b9",
            "patch": "@@ -31,7 +31,10 @@ import {\n import { HeadersAdapter } from '../../web/spec-extension/adapters/headers'\n import { RequestCookiesAdapter } from '../../web/spec-extension/adapters/request-cookies'\n import { parsedUrlQueryToParams } from './helpers/parsed-url-query-to-params'\n-import { printDebugThrownValueForProspectiveRender } from '../../app-render/prospective-render-utils'\n+import {\n+  Phase,\n+  printDebugThrownValueForProspectiveRender,\n+} from '../../app-render/prospective-render-utils'\n \n import * as serverHooks from '../../../client/components/hooks-server-context'\n import { DynamicServerError } from '../../../client/components/hooks-server-context'\n@@ -432,7 +435,11 @@ export class AppRouteRouteModule extends RouteModule<\n               process.env.NEXT_DEBUG_BUILD ||\n               process.env.__NEXT_VERBOSE_LOGGING\n             ) {\n-              printDebugThrownValueForProspectiveRender(err, workStore.route)\n+              printDebugThrownValueForProspectiveRender(\n+                err,\n+                workStore.route,\n+                Phase.ProspectiveRender\n+              )\n             }\n           }\n           if (\n@@ -452,7 +459,8 @@ export class AppRouteRouteModule extends RouteModule<\n                 } else if (process.env.NEXT_DEBUG_BUILD) {\n                   printDebugThrownValueForProspectiveRender(\n                     err,\n-                    workStore.route\n+                    workStore.route,\n+                    Phase.ProspectiveRender\n                   )\n                 }\n               }"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 80,
        "deletions": 17
    }
}