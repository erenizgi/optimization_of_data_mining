{
    "author": "ijjk",
    "message": "Fix pages API rewrite case (#78644)\n\nFixes case failing in\nhttps://github.com/vercel/vercel/actions/runs/14716507754/job/41302495247?pr=13276\nwe were missing the default locale handling necessary to process rewrite\nparams for i18n pages API routes.\n\n<details>\n\n<summary>validated test case</summary>\n\n![CleanShot 2025-04-28 at 16 05\n57@2x](https://github.com/user-attachments/assets/a30e24fe-da95-4f27-a304-ed5e6a9fc6f6)\n\n</details>",
    "sha": "6db97ef1369c532c46537e8801ef5f01119beb77",
    "files": [
        {
            "sha": "3d558d0622734669e41d337bc0e9f6669a13f1ad",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/6db97ef1369c532c46537e8801ef5f01119beb77/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6db97ef1369c532c46537e8801ef5f01119beb77/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=6db97ef1369c532c46537e8801ef5f01119beb77",
            "patch": "@@ -1321,6 +1321,11 @@ export default async function build(\n               buildCustomRoute('redirect', r, restrictedRedirectPaths)\n             ),\n             headers: headers.map((r) => buildCustomRoute('header', r)),\n+            rewrites: {\n+              beforeFiles: [],\n+              afterFiles: [],\n+              fallback: [],\n+            },\n             dynamicRoutes,\n             staticRoutes,\n             dataRoutes: [],\n@@ -1343,11 +1348,6 @@ export default async function build(\n               pathHeader: NEXT_REWRITTEN_PATH_HEADER,\n               queryHeader: NEXT_REWRITTEN_QUERY_HEADER,\n             },\n-            rewrites: {\n-              beforeFiles: [],\n-              afterFiles: [],\n-              fallback: [],\n-            },\n             skipMiddlewareUrlNormalize: config.skipMiddlewareUrlNormalize,\n             ppr: isAppPPREnabled\n               ? {"
        },
        {
            "sha": "db93517ff9899b560f7818100f5751f3278e3780",
            "filename": "packages/next/src/build/templates/pages-api.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 3,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/6db97ef1369c532c46537e8801ef5f01119beb77/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6db97ef1369c532c46537e8801ef5f01119beb77/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts?ref=6db97ef1369c532c46537e8801ef5f01119beb77",
            "patch": "@@ -28,8 +28,13 @@ import {\n   routerServerGlobal,\n } from '../../server/lib/router-utils/router-server-context'\n import { removePathPrefix } from '../../shared/lib/router/utils/remove-path-prefix'\n-import { normalizeLocalePath } from '../../shared/lib/i18n/normalize-locale-path'\n+import {\n+  normalizeLocalePath,\n+  type PathLocale,\n+} from '../../shared/lib/i18n/normalize-locale-path'\n import { loadManifestFromRelativePath } from '../../server/load-manifest.external'\n+import { getHostname } from '../../shared/lib/get-hostname'\n+import { detectDomainLocale } from '../../shared/lib/i18n/detect-domain-locale'\n \n // Re-export the handler (should be the default export).\n export default hoist(userland, 'default')\n@@ -91,9 +96,11 @@ export async function handler(\n     req.url = removePathPrefix(req.url || '/', basePath)\n   }\n \n+  let localeResult: PathLocale | undefined\n+\n   if (i18n) {\n     const urlParts = (req.url || '/').split('?')\n-    const localeResult = normalizeLocalePath(urlParts[0] || '/', i18n.locales)\n+    localeResult = normalizeLocalePath(urlParts[0] || '/', i18n.locales)\n \n     if (localeResult.detectedLocale) {\n       req.url = `${localeResult.pathname}${\n@@ -114,6 +121,21 @@ export async function handler(\n     trailingSlash: process.env.__NEXT_TRAILING_SLASH as any as boolean,\n     caseSensitive: Boolean(routesManifest.caseSensitive),\n   })\n+\n+  const domainLocale = detectDomainLocale(\n+    i18n?.domains,\n+    getHostname(parsedUrl, req.headers),\n+    localeResult?.detectedLocale\n+  )\n+\n+  const defaultLocale = domainLocale?.defaultLocale || i18n?.defaultLocale\n+\n+  // Ensure parsedUrl.pathname includes locale before processing\n+  // rewrites or they won't match correctly.\n+  if (defaultLocale && !localeResult?.detectedLocale) {\n+    parsedUrl.pathname = `/${defaultLocale}${parsedUrl.pathname}`\n+  }\n+\n   const rewriteParamKeys = Object.keys(\n     serverUtils.handleRewrites(req, parsedUrl)\n   )\n@@ -124,7 +146,9 @@ export async function handler(\n \n   const params: Record<string, undefined | string | string[]> =\n     serverUtils.dynamicRouteMatcher\n-      ? serverUtils.dynamicRouteMatcher(parsedUrl.pathname || '') || {}\n+      ? serverUtils.dynamicRouteMatcher(\n+          localeResult?.pathname || parsedUrl.pathname || ''\n+        ) || {}\n       : {}\n \n   const query = {"
        },
        {
            "sha": "1ed750f94a5814533fdc4bec121c942c8c89a78b",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 20,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/6db97ef1369c532c46537e8801ef5f01119beb77/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6db97ef1369c532c46537e8801ef5f01119beb77/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=6db97ef1369c532c46537e8801ef5f01119beb77",
            "patch": "@@ -11,7 +11,7 @@ import {\n import type { MiddlewareManifest } from '../build/webpack/plugins/middleware-plugin'\n import type RenderResult from './render-result'\n import type { FetchEventResult } from './web/types'\n-import type { PrerenderManifest } from '../build'\n+import type { PrerenderManifest, RoutesManifest } from '../build'\n import type { PagesManifest } from '../build/webpack/plugins/pages-manifest-plugin'\n import type { NextParsedUrlQuery, NextUrlWithParsedQuery } from './request-meta'\n import type { Params } from './request/params'\n@@ -1866,25 +1866,10 @@ export default class NextNodeServer extends BaseServer<\n   }\n \n   protected getRoutesManifest(): NormalizedRouteManifest | undefined {\n-    return getTracer().trace(NextNodeServerSpan.getRoutesManifest, () => {\n-      const manifest = loadManifest(join(this.distDir, ROUTES_MANIFEST)) as any\n-\n-      let rewrites = manifest.rewrites ?? {\n-        beforeFiles: [],\n-        afterFiles: [],\n-        fallback: [],\n-      }\n-\n-      if (Array.isArray(rewrites)) {\n-        rewrites = {\n-          beforeFiles: [],\n-          afterFiles: rewrites,\n-          fallback: [],\n-        }\n-      }\n-\n-      return { ...manifest, rewrites }\n-    })\n+    return getTracer().trace(\n+      NextNodeServerSpan.getRoutesManifest,\n+      () => loadManifest(join(this.distDir, ROUTES_MANIFEST)) as RoutesManifest\n+    )\n   }\n \n   protected attachRequestMeta("
        }
    ],
    "stats": {
        "total": 65,
        "additions": 37,
        "deletions": 28
    }
}