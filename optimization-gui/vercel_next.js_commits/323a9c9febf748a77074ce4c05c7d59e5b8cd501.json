{
    "author": "lubieowoce",
    "message": "patch react via recast instead of string replacements (#78916)\n\nIn #78838, we've seen that patching react via string replacements is\nproblematic, because we accidentally replaced a `setTimeout` in a string\nliteral (emitted into HTML by Fizz). This PR converts most of our react\npatching to use `recast` instead. This also lets us be smarter about how\nwe convert `setTimeout` to `setTimeoutOrImmediate` -- i'm removing the\nduration arg, and potentially preserving `setTimeout(fn, 0,\n...ARGS_FOR_CALLBACK)`",
    "sha": "323a9c9febf748a77074ce4c05c7d59e5b8cd501",
    "files": [
        {
            "sha": "be5da70812d07f9b4c7450a635ed6bad219536e9",
            "filename": "packages/next/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fpackage.json?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -304,6 +304,7 @@\n     \"querystring-es3\": \"0.2.1\",\n     \"raw-body\": \"2.4.1\",\n     \"react-refresh\": \"0.12.0\",\n+    \"recast\": \"0.23.11\",\n     \"regenerator-runtime\": \"0.13.4\",\n     \"sass-loader\": \"15.0.0\",\n     \"schema-utils2\": \"npm:schema-utils@2.7.1\","
        },
        {
            "sha": "0990d97633b0bba9bd798144b4393b5886831a55",
            "filename": "packages/next/src/compiled/react-dom-experimental/cjs/react-dom-server.edge.development.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom-experimental%2Fcjs%2Freact-dom-server.edge.development.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom-experimental%2Fcjs%2Freact-dom-server.edge.development.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom-experimental%2Fcjs%2Freact-dom-server.edge.development.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -35,6 +35,15 @@\n \"use strict\";\n \"production\" !== process.env.NODE_ENV &&\n   (function () {\n+    // This is a patch added by Next.js\n+    const setTimeoutOrImmediate =\n+      typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+      // edge runtime sandbox defines a stub for setImmediate\n+      // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+      // but it's made non-enumerable, so we can detect it\n+      globalThis.propertyIsEnumerable(\"setImmediate\")\n+        ? globalThis[\"set\" + \"Immediate\"]\n+        : (callback, ...args) => setTimeout(callback, 0, ...args);\n     function styleReplacer(match, prefix, s, suffix) {\n       return \"\" + prefix + (\"s\" === s ? \"\\\\73 \" : \"\\\\53 \") + suffix;\n     }\n@@ -4903,7 +4912,7 @@\n             })\n           : setTimeoutOrImmediate(function () {\n               return performWork(request);\n-            }, 0));\n+            }));\n     }\n     function createSuspenseBoundary(\n       request,\n@@ -8473,7 +8482,7 @@\n                 request\n               )\n             : enqueueEarlyPreloadsAfterInitialWork(request));\n-      }, 0);\n+      });\n     }\n     function enqueueEarlyPreloadsAfterInitialWork(request) {\n       safelyEmitEarlyPreloads(request, 0 === request.pendingRootTasks);\n@@ -8488,7 +8497,7 @@\n           destination\n             ? flushCompletedQueues(request, destination)\n             : (request.flushScheduled = !1);\n-        }, 0));\n+        }));\n     }\n     function startFlowing(request, destination) {\n       if (13 === request.status)\n@@ -10392,16 +10401,5 @@\n         startWork(request);\n       });\n     };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n     exports.version = \"19.2.0-experimental-197d6a04-20250424\";\n   })();"
        },
        {
            "sha": "8d3fe9168ca2dcd4a549358c1e00e51118522157",
            "filename": "packages/next/src/compiled/react-dom-experimental/cjs/react-dom-server.edge.production.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom-experimental%2Fcjs%2Freact-dom-server.edge.production.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom-experimental%2Fcjs%2Freact-dom-server.edge.production.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom-experimental%2Fcjs%2Freact-dom-server.edge.production.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -1,3 +1,12 @@\n+// This is a patch added by Next.js\n+const setTimeoutOrImmediate =\n+  typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+  // edge runtime sandbox defines a stub for setImmediate\n+  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+  // but it's made non-enumerable, so we can detect it\n+  globalThis.propertyIsEnumerable(\"setImmediate\")\n+    ? globalThis[\"set\" + \"Immediate\"]\n+    : (callback, ...args) => setTimeout(callback, 0, ...args);\n /**\n  * @license React\n  * react-dom-server.edge.production.js\n@@ -4411,7 +4420,7 @@ function pingTask(request, task) {\n         })\n       : setTimeoutOrImmediate(function () {\n           return performWork(request);\n-        }, 0));\n+        }));\n }\n function createSuspenseBoundary(\n   request,\n@@ -6936,7 +6945,7 @@ function startWork(request) {\n             request\n           )\n         : enqueueEarlyPreloadsAfterInitialWork(request));\n-  }, 0);\n+  });\n }\n function enqueueEarlyPreloadsAfterInitialWork(request) {\n   safelyEmitEarlyPreloads(request, 0 === request.pendingRootTasks);\n@@ -6951,7 +6960,7 @@ function enqueueFlush(request) {\n       destination\n         ? flushCompletedQueues(request, destination)\n         : (request.flushScheduled = !1);\n-    }, 0));\n+    }));\n }\n function startFlowing(request, destination) {\n   if (13 === request.status)\n@@ -7305,15 +7314,4 @@ exports.resumeAndPrerender = function (children, postponedState, options) {\n     startWork(request);\n   });\n };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n exports.version = \"19.2.0-experimental-197d6a04-20250424\";"
        },
        {
            "sha": "14ab76a21058656ff25226ba41018a47daa7fbef",
            "filename": "packages/next/src/compiled/react-dom/cjs/react-dom-server.edge.development.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom%2Fcjs%2Freact-dom-server.edge.development.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom%2Fcjs%2Freact-dom-server.edge.development.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom%2Fcjs%2Freact-dom-server.edge.development.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -35,6 +35,15 @@\n \"use strict\";\n \"production\" !== process.env.NODE_ENV &&\n   (function () {\n+    // This is a patch added by Next.js\n+    const setTimeoutOrImmediate =\n+      typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+      // edge runtime sandbox defines a stub for setImmediate\n+      // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+      // but it's made non-enumerable, so we can detect it\n+      globalThis.propertyIsEnumerable(\"setImmediate\")\n+        ? globalThis[\"set\" + \"Immediate\"]\n+        : (callback, ...args) => setTimeout(callback, 0, ...args);\n     function styleReplacer(match, prefix, s, suffix) {\n       return \"\" + prefix + (\"s\" === s ? \"\\\\73 \" : \"\\\\53 \") + suffix;\n     }\n@@ -4565,7 +4574,7 @@\n             })\n           : setTimeoutOrImmediate(function () {\n               return performWork(request);\n-            }, 0));\n+            }));\n     }\n     function createSuspenseBoundary(\n       request,\n@@ -7704,7 +7713,7 @@\n                 request\n               )\n             : enqueueEarlyPreloadsAfterInitialWork(request));\n-      }, 0);\n+      });\n     }\n     function enqueueEarlyPreloadsAfterInitialWork(request) {\n       safelyEmitEarlyPreloads(request, 0 === request.pendingRootTasks);\n@@ -7719,7 +7728,7 @@\n           destination\n             ? flushCompletedQueues(request, destination)\n             : (request.flushScheduled = !1);\n-        }, 0));\n+        }));\n     }\n     function startFlowing(request, destination) {\n       if (13 === request.status)\n@@ -9439,16 +9448,5 @@\n         startWork(request);\n       });\n     };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n     exports.version = \"19.2.0-canary-197d6a04-20250424\";\n   })();"
        },
        {
            "sha": "9a68913b21de90ea5221df5485fcd08ee882a960",
            "filename": "packages/next/src/compiled/react-dom/cjs/react-dom-server.edge.production.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom%2Fcjs%2Freact-dom-server.edge.production.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom%2Fcjs%2Freact-dom-server.edge.production.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-dom%2Fcjs%2Freact-dom-server.edge.production.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -1,3 +1,12 @@\n+// This is a patch added by Next.js\n+const setTimeoutOrImmediate =\n+  typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+  // edge runtime sandbox defines a stub for setImmediate\n+  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+  // but it's made non-enumerable, so we can detect it\n+  globalThis.propertyIsEnumerable(\"setImmediate\")\n+    ? globalThis[\"set\" + \"Immediate\"]\n+    : (callback, ...args) => setTimeout(callback, 0, ...args);\n /**\n  * @license React\n  * react-dom-server.edge.production.js\n@@ -4078,7 +4087,7 @@ function pingTask(request, task) {\n         })\n       : setTimeoutOrImmediate(function () {\n           return performWork(request);\n-        }, 0));\n+        }));\n }\n function createSuspenseBoundary(\n   request,\n@@ -6262,7 +6271,7 @@ function startWork(request) {\n             request\n           )\n         : enqueueEarlyPreloadsAfterInitialWork(request));\n-  }, 0);\n+  });\n }\n function enqueueEarlyPreloadsAfterInitialWork(request) {\n   safelyEmitEarlyPreloads(request, 0 === request.pendingRootTasks);\n@@ -6277,7 +6286,7 @@ function enqueueFlush(request) {\n       destination\n         ? flushCompletedQueues(request, destination)\n         : (request.flushScheduled = !1);\n-    }, 0));\n+    }));\n }\n function startFlowing(request, destination) {\n   if (13 === request.status)\n@@ -6468,15 +6477,4 @@ exports.renderToReadableStream = function (children, options) {\n     startWork(request);\n   });\n };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n exports.version = \"19.2.0-canary-197d6a04-20250424\";"
        },
        {
            "sha": "8b8739ab0e141edee0e5980cd10cf1073e31fc42",
            "filename": "packages/next/src/compiled/react-server-dom-turbopack-experimental/cjs/react-server-dom-turbopack-server.edge.development.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack-experimental%2Fcjs%2Freact-server-dom-turbopack-server.edge.development.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack-experimental%2Fcjs%2Freact-server-dom-turbopack-server.edge.development.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack-experimental%2Fcjs%2Freact-server-dom-turbopack-server.edge.development.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -11,6 +11,15 @@\n \"use strict\";\n \"production\" !== process.env.NODE_ENV &&\n   (function () {\n+    // This is a patch added by Next.js\n+    const setTimeoutOrImmediate =\n+      typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+      // edge runtime sandbox defines a stub for setImmediate\n+      // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+      // but it's made non-enumerable, so we can detect it\n+      globalThis.propertyIsEnumerable(\"setImmediate\")\n+        ? globalThis[\"set\" + \"Immediate\"]\n+        : (callback, ...args) => setTimeout(callback, 0, ...args);\n     function voidHandler() {}\n     function getIteratorFn(maybeIterable) {\n       if (null === maybeIterable || \"object\" !== typeof maybeIterable)\n@@ -1445,7 +1454,7 @@\n             })\n           : setTimeoutOrImmediate(function () {\n               return performWork(request);\n-            }, 0));\n+            }));\n     }\n     function createTask(\n       request,\n@@ -2826,7 +2835,7 @@\n           });\n       setTimeoutOrImmediate(function () {\n         request.status === OPENING && (request.status = 11);\n-      }, 0);\n+      });\n     }\n     function enqueueFlush(request) {\n       !1 === request.flushScheduled &&\n@@ -2837,7 +2846,7 @@\n           request.flushScheduled = !1;\n           var destination = request.destination;\n           destination && flushCompletedChunks(request, destination);\n-        }, 0));\n+        }));\n     }\n     function callOnAllReadyIfReady(request) {\n       if (\n@@ -4303,17 +4312,6 @@\n         bind: { value: bind, configurable: !0 }\n       });\n     };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n     exports.renderToReadableStream = function (model, turbopackMap, options) {\n       var request = createRequest(\n         model,"
        },
        {
            "sha": "620dc0df307c04b0e0df1e4bb8b26a10d22ca000",
            "filename": "packages/next/src/compiled/react-server-dom-turbopack-experimental/cjs/react-server-dom-turbopack-server.edge.production.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack-experimental%2Fcjs%2Freact-server-dom-turbopack-server.edge.production.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack-experimental%2Fcjs%2Freact-server-dom-turbopack-server.edge.production.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack-experimental%2Fcjs%2Freact-server-dom-turbopack-server.edge.production.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -1,3 +1,12 @@\n+// This is a patch added by Next.js\n+const setTimeoutOrImmediate =\n+  typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+  // edge runtime sandbox defines a stub for setImmediate\n+  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+  // but it's made non-enumerable, so we can detect it\n+  globalThis.propertyIsEnumerable(\"setImmediate\")\n+    ? globalThis[\"set\" + \"Immediate\"]\n+    : (callback, ...args) => setTimeout(callback, 0, ...args);\n /**\n  * @license React\n  * react-server-dom-turbopack-server.edge.production.js\n@@ -1144,7 +1153,7 @@ function pingTask(request, task) {\n         })\n       : setTimeoutOrImmediate(function () {\n           return performWork(request);\n-        }, 0));\n+        }));\n }\n function createTask(request, model, keyPath, implicitSlot, abortSet) {\n   request.pendingChunks++;\n@@ -1949,7 +1958,7 @@ function startWork(request) {\n       });\n   setTimeoutOrImmediate(function () {\n     10 === request.status && (request.status = 11);\n-  }, 0);\n+  });\n }\n function enqueueFlush(request) {\n   !1 === request.flushScheduled &&\n@@ -1960,7 +1969,7 @@ function enqueueFlush(request) {\n       request.flushScheduled = !1;\n       var destination = request.destination;\n       destination && flushCompletedChunks(request, destination);\n-    }, 0));\n+    }));\n }\n function callOnAllReadyIfReady(request) {\n   if (0 === request.abortableTasks.size && 0 === request.abortListeners.size)\n@@ -2881,17 +2890,6 @@ exports.registerServerReference = function (reference, id, exportName) {\n     bind: { value: bind, configurable: !0 }\n   });\n };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n exports.renderToReadableStream = function (model, turbopackMap, options) {\n   var request = new RequestInstance(\n     20,"
        },
        {
            "sha": "04a09df7a494c6cbb616f28eda97ec6de4f7c64a",
            "filename": "packages/next/src/compiled/react-server-dom-turbopack/cjs/react-server-dom-turbopack-server.edge.development.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack%2Fcjs%2Freact-server-dom-turbopack-server.edge.development.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack%2Fcjs%2Freact-server-dom-turbopack-server.edge.development.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack%2Fcjs%2Freact-server-dom-turbopack-server.edge.development.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -11,6 +11,15 @@\n \"use strict\";\n \"production\" !== process.env.NODE_ENV &&\n   (function () {\n+    // This is a patch added by Next.js\n+    const setTimeoutOrImmediate =\n+      typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+      // edge runtime sandbox defines a stub for setImmediate\n+      // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+      // but it's made non-enumerable, so we can detect it\n+      globalThis.propertyIsEnumerable(\"setImmediate\")\n+        ? globalThis[\"set\" + \"Immediate\"]\n+        : (callback, ...args) => setTimeout(callback, 0, ...args);\n     function voidHandler() {}\n     function getIteratorFn(maybeIterable) {\n       if (null === maybeIterable || \"object\" !== typeof maybeIterable)\n@@ -1415,7 +1424,7 @@\n             })\n           : setTimeoutOrImmediate(function () {\n               return performWork(request);\n-            }, 0));\n+            }));\n     }\n     function createTask(\n       request,\n@@ -2667,7 +2676,7 @@\n           });\n       setTimeoutOrImmediate(function () {\n         request.status === OPENING && (request.status = 11);\n-      }, 0);\n+      });\n     }\n     function enqueueFlush(request) {\n       !1 === request.flushScheduled &&\n@@ -2678,7 +2687,7 @@\n           request.flushScheduled = !1;\n           var destination = request.destination;\n           destination && flushCompletedChunks(request, destination);\n-        }, 0));\n+        }));\n     }\n     function callOnAllReadyIfReady(request) {\n       if (\n@@ -4102,17 +4111,6 @@\n         bind: { value: bind, configurable: !0 }\n       });\n     };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n     exports.renderToReadableStream = function (model, turbopackMap, options) {\n       var request = createRequest(\n         model,"
        },
        {
            "sha": "feec70823829e9c7239647fcdf0e1f02d5790b47",
            "filename": "packages/next/src/compiled/react-server-dom-turbopack/cjs/react-server-dom-turbopack-server.edge.production.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack%2Fcjs%2Freact-server-dom-turbopack-server.edge.production.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack%2Fcjs%2Freact-server-dom-turbopack-server.edge.production.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-turbopack%2Fcjs%2Freact-server-dom-turbopack-server.edge.production.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -1,3 +1,12 @@\n+// This is a patch added by Next.js\n+const setTimeoutOrImmediate =\n+  typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+  // edge runtime sandbox defines a stub for setImmediate\n+  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+  // but it's made non-enumerable, so we can detect it\n+  globalThis.propertyIsEnumerable(\"setImmediate\")\n+    ? globalThis[\"set\" + \"Immediate\"]\n+    : (callback, ...args) => setTimeout(callback, 0, ...args);\n /**\n  * @license React\n  * react-server-dom-turbopack-server.edge.production.js\n@@ -1112,7 +1121,7 @@ function pingTask(request, task) {\n         })\n       : setTimeoutOrImmediate(function () {\n           return performWork(request);\n-        }, 0));\n+        }));\n }\n function createTask(request, model, keyPath, implicitSlot, abortSet) {\n   request.pendingChunks++;\n@@ -1840,7 +1849,7 @@ function startWork(request) {\n       });\n   setTimeoutOrImmediate(function () {\n     10 === request.status && (request.status = 11);\n-  }, 0);\n+  });\n }\n function enqueueFlush(request) {\n   !1 === request.flushScheduled &&\n@@ -1851,7 +1860,7 @@ function enqueueFlush(request) {\n       request.flushScheduled = !1;\n       var destination = request.destination;\n       destination && flushCompletedChunks(request, destination);\n-    }, 0));\n+    }));\n }\n function callOnAllReadyIfReady(request) {\n   if (0 === request.abortableTasks.size && 0 === request.abortListeners.size)\n@@ -2754,17 +2763,6 @@ exports.registerServerReference = function (reference, id, exportName) {\n     bind: { value: bind, configurable: !0 }\n   });\n };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n exports.renderToReadableStream = function (model, turbopackMap, options) {\n   var request = new RequestInstance(\n     20,"
        },
        {
            "sha": "54989fa74bfdbe3ad6151bd39a6f9c681a2c7791",
            "filename": "packages/next/src/compiled/react-server-dom-webpack-experimental/cjs/react-server-dom-webpack-server.edge.development.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack-experimental%2Fcjs%2Freact-server-dom-webpack-server.edge.development.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack-experimental%2Fcjs%2Freact-server-dom-webpack-server.edge.development.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack-experimental%2Fcjs%2Freact-server-dom-webpack-server.edge.development.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -11,6 +11,15 @@\n \"use strict\";\n \"production\" !== process.env.NODE_ENV &&\n   (function () {\n+    // This is a patch added by Next.js\n+    const setTimeoutOrImmediate =\n+      typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+      // edge runtime sandbox defines a stub for setImmediate\n+      // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+      // but it's made non-enumerable, so we can detect it\n+      globalThis.propertyIsEnumerable(\"setImmediate\")\n+        ? globalThis[\"set\" + \"Immediate\"]\n+        : (callback, ...args) => setTimeout(callback, 0, ...args);\n     function voidHandler() {}\n     function getIteratorFn(maybeIterable) {\n       if (null === maybeIterable || \"object\" !== typeof maybeIterable)\n@@ -1445,7 +1454,7 @@\n             })\n           : setTimeoutOrImmediate(function () {\n               return performWork(request);\n-            }, 0));\n+            }));\n     }\n     function createTask(\n       request,\n@@ -2826,7 +2835,7 @@\n           });\n       setTimeoutOrImmediate(function () {\n         request.status === OPENING && (request.status = 11);\n-      }, 0);\n+      });\n     }\n     function enqueueFlush(request) {\n       !1 === request.flushScheduled &&\n@@ -2837,7 +2846,7 @@\n           request.flushScheduled = !1;\n           var destination = request.destination;\n           destination && flushCompletedChunks(request, destination);\n-        }, 0));\n+        }));\n     }\n     function callOnAllReadyIfReady(request) {\n       if (\n@@ -4306,17 +4315,6 @@\n         bind: { value: bind, configurable: !0 }\n       });\n     };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n     exports.renderToReadableStream = function (model, webpackMap, options) {\n       var request = createRequest(\n         model,"
        },
        {
            "sha": "c917a9c618b983168240642867e9296340e4e2eb",
            "filename": "packages/next/src/compiled/react-server-dom-webpack-experimental/cjs/react-server-dom-webpack-server.edge.production.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack-experimental%2Fcjs%2Freact-server-dom-webpack-server.edge.production.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack-experimental%2Fcjs%2Freact-server-dom-webpack-server.edge.production.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack-experimental%2Fcjs%2Freact-server-dom-webpack-server.edge.production.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -1,3 +1,12 @@\n+// This is a patch added by Next.js\n+const setTimeoutOrImmediate =\n+  typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+  // edge runtime sandbox defines a stub for setImmediate\n+  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+  // but it's made non-enumerable, so we can detect it\n+  globalThis.propertyIsEnumerable(\"setImmediate\")\n+    ? globalThis[\"set\" + \"Immediate\"]\n+    : (callback, ...args) => setTimeout(callback, 0, ...args);\n /**\n  * @license React\n  * react-server-dom-webpack-server.edge.production.js\n@@ -1144,7 +1153,7 @@ function pingTask(request, task) {\n         })\n       : setTimeoutOrImmediate(function () {\n           return performWork(request);\n-        }, 0));\n+        }));\n }\n function createTask(request, model, keyPath, implicitSlot, abortSet) {\n   request.pendingChunks++;\n@@ -1949,7 +1958,7 @@ function startWork(request) {\n       });\n   setTimeoutOrImmediate(function () {\n     10 === request.status && (request.status = 11);\n-  }, 0);\n+  });\n }\n function enqueueFlush(request) {\n   !1 === request.flushScheduled &&\n@@ -1960,7 +1969,7 @@ function enqueueFlush(request) {\n       request.flushScheduled = !1;\n       var destination = request.destination;\n       destination && flushCompletedChunks(request, destination);\n-    }, 0));\n+    }));\n }\n function callOnAllReadyIfReady(request) {\n   if (0 === request.abortableTasks.size && 0 === request.abortListeners.size)\n@@ -2884,17 +2893,6 @@ exports.registerServerReference = function (reference, id, exportName) {\n     bind: { value: bind, configurable: !0 }\n   });\n };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n exports.renderToReadableStream = function (model, webpackMap, options) {\n   var request = new RequestInstance(\n     20,"
        },
        {
            "sha": "08c37d2f1cb686152c3aadda518519ef44409d0c",
            "filename": "packages/next/src/compiled/react-server-dom-webpack/cjs/react-server-dom-webpack-server.edge.development.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack%2Fcjs%2Freact-server-dom-webpack-server.edge.development.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack%2Fcjs%2Freact-server-dom-webpack-server.edge.development.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack%2Fcjs%2Freact-server-dom-webpack-server.edge.development.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -11,6 +11,15 @@\n \"use strict\";\n \"production\" !== process.env.NODE_ENV &&\n   (function () {\n+    // This is a patch added by Next.js\n+    const setTimeoutOrImmediate =\n+      typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+      // edge runtime sandbox defines a stub for setImmediate\n+      // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+      // but it's made non-enumerable, so we can detect it\n+      globalThis.propertyIsEnumerable(\"setImmediate\")\n+        ? globalThis[\"set\" + \"Immediate\"]\n+        : (callback, ...args) => setTimeout(callback, 0, ...args);\n     function voidHandler() {}\n     function getIteratorFn(maybeIterable) {\n       if (null === maybeIterable || \"object\" !== typeof maybeIterable)\n@@ -1415,7 +1424,7 @@\n             })\n           : setTimeoutOrImmediate(function () {\n               return performWork(request);\n-            }, 0));\n+            }));\n     }\n     function createTask(\n       request,\n@@ -2667,7 +2676,7 @@\n           });\n       setTimeoutOrImmediate(function () {\n         request.status === OPENING && (request.status = 11);\n-      }, 0);\n+      });\n     }\n     function enqueueFlush(request) {\n       !1 === request.flushScheduled &&\n@@ -2678,7 +2687,7 @@\n           request.flushScheduled = !1;\n           var destination = request.destination;\n           destination && flushCompletedChunks(request, destination);\n-        }, 0));\n+        }));\n     }\n     function callOnAllReadyIfReady(request) {\n       if (\n@@ -4105,17 +4114,6 @@\n         bind: { value: bind, configurable: !0 }\n       });\n     };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n     exports.renderToReadableStream = function (model, webpackMap, options) {\n       var request = createRequest(\n         model,"
        },
        {
            "sha": "6470f6ba70bd52e778b88a9a7209eb20203e5fdb",
            "filename": "packages/next/src/compiled/react-server-dom-webpack/cjs/react-server-dom-webpack-server.edge.production.js",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack%2Fcjs%2Freact-server-dom-webpack-server.edge.production.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack%2Fcjs%2Freact-server-dom-webpack-server.edge.production.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Freact-server-dom-webpack%2Fcjs%2Freact-server-dom-webpack-server.edge.production.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -1,3 +1,12 @@\n+// This is a patch added by Next.js\n+const setTimeoutOrImmediate =\n+  typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+  // edge runtime sandbox defines a stub for setImmediate\n+  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+  // but it's made non-enumerable, so we can detect it\n+  globalThis.propertyIsEnumerable(\"setImmediate\")\n+    ? globalThis[\"set\" + \"Immediate\"]\n+    : (callback, ...args) => setTimeout(callback, 0, ...args);\n /**\n  * @license React\n  * react-server-dom-webpack-server.edge.production.js\n@@ -1112,7 +1121,7 @@ function pingTask(request, task) {\n         })\n       : setTimeoutOrImmediate(function () {\n           return performWork(request);\n-        }, 0));\n+        }));\n }\n function createTask(request, model, keyPath, implicitSlot, abortSet) {\n   request.pendingChunks++;\n@@ -1840,7 +1849,7 @@ function startWork(request) {\n       });\n   setTimeoutOrImmediate(function () {\n     10 === request.status && (request.status = 11);\n-  }, 0);\n+  });\n }\n function enqueueFlush(request) {\n   !1 === request.flushScheduled &&\n@@ -1851,7 +1860,7 @@ function enqueueFlush(request) {\n       request.flushScheduled = !1;\n       var destination = request.destination;\n       destination && flushCompletedChunks(request, destination);\n-    }, 0));\n+    }));\n }\n function callOnAllReadyIfReady(request) {\n   if (0 === request.abortableTasks.size && 0 === request.abortListeners.size)\n@@ -2757,17 +2766,6 @@ exports.registerServerReference = function (reference, id, exportName) {\n     bind: { value: bind, configurable: !0 }\n   });\n };\n-\n-// This is a patch added by Next.js\n-const setTimeoutOrImmediate =\n-  typeof globalThis['set' + 'Immediate'] === 'function' &&\n-  // edge runtime sandbox defines a stub for setImmediate\n-  // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-  // but it's made non-enumerable, so we can detect it\n-  globalThis.propertyIsEnumerable('setImmediate')\n-    ? globalThis['set' + 'Immediate']\n-    : setTimeout;\n-\n exports.renderToReadableStream = function (model, webpackMap, options) {\n   var request = new RequestInstance(\n     20,"
        },
        {
            "sha": "90cdbb3de2b4f80a690da3e473e548b26de87300",
            "filename": "packages/next/taskfile.js",
            "status": "modified",
            "additions": 199,
            "deletions": 61,
            "changes": 260,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Ftaskfile.js",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/packages%2Fnext%2Ftaskfile.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftaskfile.js?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -8,6 +8,7 @@ const fs = require('fs/promises')\n const resolveFrom = require('resolve-from')\n const execa = require('execa')\n const process = require('process')\n+const recast = require('recast')\n \n export async function next__polyfill_nomodule(task, opts) {\n   await task\n@@ -1633,11 +1634,11 @@ export async function copy_vendor_react(task_) {\n             filepath\n           )\n         ) {\n-          newSource = replaceSetTimeout({\n-            code: newSource,\n-            file: filepath,\n-            insertBefore: /\\n\\s*exports\\.version =/,\n+          const ast = parseFile(newSource, {\n+            sourceFileName: filepath,\n           })\n+          replaceSetTimeoutInAst(ast, filepath)\n+          newSource = recast.print(ast).code\n         }\n \n         file.data = newSource\n@@ -1647,11 +1648,10 @@ export async function copy_vendor_react(task_) {\n       })\n       .target(`src/compiled/react-dom${packageSuffix}/cjs`)\n \n-    function replaceSetTimeout({\n-      code,\n-      file,\n-      insertBefore: insertBeforePattern,\n-    }) {\n+    function replaceSetTimeoutInAst(\n+      /** @type {recast.types.namedTypes.File} */ ast,\n+      /** @type {string} */ filepath\n+    ) {\n       // FIXME: we need this hack until we can use the Node build of 'react-dom/server'\n       //\n       // We're currently using the Edge builds of 'react-dom/server' and 'react-server-dom-{webpack,turbopack}' everywhere.\n@@ -1665,41 +1665,166 @@ export async function copy_vendor_react(task_) {\n       //   setTimeout(() => ..., 0)\n       // into this:\n       //   setImmediate(() => ...)\n-      //\n-      // ReactDOM only ever calls `setTimeout` with `0` (and no further arguments),\n-      // so we can just naively replace `setTimeout` with `setImmediate`.\n-      // Technically the `0` will then be passed to the callback as an argument,\n-      // but the callbacks will always ignore it anyway.\n \n-      // NOTE: we have to replace these before inserting the definition of `setTimeoutOrImmediate`,\n-      // otherwise we'd break it!\n-      code = code.replaceAll(`setTimeout`, `setTimeoutOrImmediate`)\n+      recast.types.namedTypes.File.assert(ast)\n+      const definitionStr = outdent`\n+        // This is a patch added by Next.js\n+        const setTimeoutOrImmediate =\n+          typeof globalThis[\"set\" + \"Immediate\"] === \"function\" &&\n+          // edge runtime sandbox defines a stub for setImmediate\n+          // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n+          // but it's made non-enumerable, so we can detect it\n+          globalThis.propertyIsEnumerable(\"setImmediate\")\n+            ? globalThis[\"set\" + \"Immediate\"]\n+            : (callback, ...args) => setTimeout(callback, 0, ...args);\n+\n+      `\n+      const getDefinitionStmt = () => {\n+        const fileAst = /** @type {recast.types.namedTypes.File} */ (\n+          recast.parse(definitionStr)\n+        )\n+        return fileAst.program.body[0]\n+      }\n+\n+      let needsDefinition = false\n+      recast.visit(ast, {\n+        visitCallExpression(path) {\n+          const { callee, arguments: args } = path.node\n+\n+          if (callee.type === 'Identifier' && callee.name === 'setTimeout') {\n+            const durationArg = args.length >= 2 ? args[1] : undefined\n+            if (\n+              // `setTimeout(fn)`\n+              !durationArg ||\n+              // `setTimeout(fn, 0, ...)`\n+              (durationArg.type === 'Literal' && durationArg.value === 0) ||\n+              // `setTimeout(fn, undefined, ...)`\n+              (durationArg.type === 'Identifier' &&\n+                durationArg.name === 'undefined')\n+            ) {\n+              needsDefinition = true\n+              // setTimeout(fn, 0, ...) ->\n+              // setTimeoutOrImmediate(fn, ...)\n+              callee.name = 'setTimeoutOrImmediate'\n+              path.node.arguments = [args[0], ...args.slice(2)]\n+            }\n+          }\n+          this.traverse(path)\n+        },\n+      })\n+\n+      if (!needsDefinition) {\n+        return\n+      }\n \n-      const insertionPoint = code.search(insertBeforePattern)\n-      if (insertionPoint === -1) {\n+      let didInsertDefinition = false\n+      recast.visit(ast, {\n+        visitAssignmentExpression(path) {\n+          // we should only insert the definition of `setTimeoutOrImmediate` once.\n+          if (didInsertDefinition) {\n+            return false\n+          }\n+\n+          // Find the first `exports.NAME = ...` assignment\n+          const { left: target } = path.node\n+          if (\n+            target.type === 'MemberExpression' &&\n+            target.object.type === 'Identifier' &&\n+            target.object.name === 'exports' &&\n+            // we don't care about which export is being assigned.\n+            target.property.type === 'Identifier'\n+          ) {\n+            didInsertDefinition = true\n+            // We expect `exports` assignments to happen:\n+            // - at the top level for prod builds of react\n+            // - inside an IIFE for dev builds of react\n+            // In either case, we now need find an ancestor node we can insert the definition into.\n+            const blocklikeAncestor = findBlocklikeAncestor(\n+              /** @type {recast.types.NodePath} */ (path)\n+            )\n+            if (!blocklikeAncestor) {\n+              throw new Error('Could not find a block to insert definition')\n+            }\n+            blocklikeAncestor.insertAt(0, getDefinitionStmt())\n+          }\n+\n+          // we don't care about any assignment expressions that might happen in the RHS,\n+          // React doesn't do that\n+          return false\n+        },\n+      })\n+      if (!didInsertDefinition) {\n         throw new Error(\n-          `Cannot find insertion point for setTimeoutOrImmediate in ${file}`\n+          `Failed to find an insertion point for \\`setTimeout\\` replacement in '${filepath}'`\n         )\n       }\n \n-      const toInsert =\n-        '\\n\\n' +\n-        outdent`\n-          // This is a patch added by Next.js\n-          const setTimeoutOrImmediate =\n-            typeof globalThis['set' + 'Immediate'] === 'function' &&\n-            // edge runtime sandbox defines a stub for setImmediate\n-            // (see 'addStub' in packages/next/src/server/web/sandbox/context.ts)\n-            // but it's made non-enumerable, so we can detect it\n-            globalThis.propertyIsEnumerable('setImmediate')\n-              ? globalThis['set' + 'Immediate']\n-              : setTimeout;\n-        ` +\n-        '\\n'\n-\n-      return (\n-        code.slice(0, insertionPoint) + toInsert + code.slice(insertionPoint)\n-      )\n+      function findBlocklikeAncestor(\n+        /** @type {recast.types.NodePath} */ path\n+      ) {\n+        /** @type {recast.types.NodePath | null} */\n+        let current = path\n+        while (current) {\n+          if (\n+            recast.types.namedTypes.BlockStatement.check(current.node) ||\n+            recast.types.namedTypes.Program.check(current.node)\n+          ) {\n+            break\n+          } else {\n+            current = current.parentPath\n+          }\n+        }\n+        return current\n+      }\n+    }\n+\n+    function replaceIdentifiersInAst(\n+      /** @type {recast.types.namedTypes.File} */ ast,\n+      /** @type {Map<string, ExpressionKind>} */ replacements\n+    ) {\n+      recast.types.namedTypes.File.assert(ast)\n+      recast.visit(ast, {\n+        visitIdentifier(path) {\n+          const replacement = replacements.get(path.node.name)\n+          if (replacement !== undefined) {\n+            path.replace(replacement)\n+          }\n+          this.traverse(path)\n+        },\n+      })\n+    }\n+\n+    function parseFile(\n+      /** @type {string} */ code,\n+      /** @type {recast.Options} */ opts\n+    ) {\n+      /** @type {recast.types.namedTypes.File} */\n+      const file = recast.parse(code, {\n+        parser: {\n+          parse(source, options) {\n+            return require('recast/parsers/acorn').parse(source, {\n+              ...options,\n+              // allow `import()` in `react-server-dom-{webpack,turbopack}-client.node.unbundled.development.js`\n+              ecmaVersion: 'latest',\n+              sourceType: 'script',\n+            })\n+          },\n+        },\n+        ...opts,\n+      })\n+      return file\n+    }\n+\n+    /** @typedef {ReturnType<typeof parseExpression>} ExpressionKind */\n+\n+    function parseExpression(/** @type {string} */ exprCode) {\n+      /** @type {recast.types.namedTypes.File} */\n+      const ast = recast.parse(`(${exprCode});`)\n+      const statement =\n+        /** @type {recast.types.namedTypes.ExpressionStatement} */ (\n+          ast.program.body[0]\n+        )\n+      return statement.expression\n     }\n \n     // Remove unused files\n@@ -1753,19 +1878,22 @@ export async function copy_vendor_react(task_) {\n           (file.base.startsWith('react-server-dom-webpack-server') &&\n             !file.base.startsWith('react-server-dom-webpack-server.browser'))\n         ) {\n+          const filepath = file.dir + '/' + file.base\n           const source = file.data.toString()\n-          let newSource = source.replace(\n-            /__webpack_require__/g,\n-            'globalThis.__next_require__'\n+          const ast = parseFile(source, { sourceFileName: filepath })\n+          replaceIdentifiersInAst(\n+            ast,\n+            new Map([\n+              [\n+                '__webpack_require__',\n+                parseExpression('globalThis.__next_require__'),\n+              ],\n+            ])\n           )\n           if (file.base.startsWith('react-server-dom-webpack-server.edge')) {\n-            newSource = replaceSetTimeout({\n-              code: newSource,\n-              file: file.base,\n-              insertBefore: /\\n\\s*exports\\.renderToReadableStream =/,\n-            })\n+            replaceSetTimeoutInAst(ast, filepath)\n           }\n-          file.data = newSource\n+          file.data = recast.print(ast).code\n         } else if (file.base === 'package.json') {\n           file.data = overridePackageName(file.data)\n         }\n@@ -1803,31 +1931,41 @@ export async function copy_vendor_react(task_) {\n \n         if (file.base.startsWith('react-server-dom-turbopack-client.browser')) {\n           const source = file.data.toString()\n-          let newSource = source.replace(\n-            /__turbopack_load__/g,\n-            '__turbopack_load_by_url__'\n+          const filepath = file.dir + '/' + file.base\n+          const ast = parseFile(source, { sourceFileName: filepath })\n+          replaceIdentifiersInAst(\n+            ast,\n+            new Map([['__turbopack_load__', '__turbopack_load_by_url__']])\n           )\n-\n-          file.data = newSource\n+          file.data = recast.print(ast).code\n         } else if (\n           file.base.startsWith('react-server-dom-turbopack-client') ||\n           (file.base.startsWith('react-server-dom-turbopack-server') &&\n             !file.base.startsWith('react-server-dom-turbopack-server.browser'))\n         ) {\n           const source = file.data.toString()\n-          let newSource = source\n-            .replace(/__turbopack_load__/g, 'globalThis.__next_chunk_load__')\n-            .replace(/__turbopack_require__/g, 'globalThis.__next_require__')\n+          const filepath = file.dir + '/' + file.base\n+          const ast = parseFile(source, { sourceFileName: filepath })\n+\n+          replaceIdentifiersInAst(\n+            ast,\n+            new Map([\n+              [\n+                '__turbopack_load__',\n+                parseExpression('globalThis.__next_chunk_load__'),\n+              ],\n+              [\n+                '__turbopack_require__',\n+                parseExpression('globalThis.__next_require__'),\n+              ],\n+            ])\n+          )\n \n           if (file.base.startsWith('react-server-dom-turbopack-server.edge')) {\n-            newSource = replaceSetTimeout({\n-              code: newSource,\n-              file: file.base,\n-              insertBefore: /\\n\\s*exports\\.renderToReadableStream =/,\n-            })\n+            replaceSetTimeoutInAst(ast, filepath)\n           }\n \n-          file.data = newSource\n+          file.data = recast.print(ast).code\n         } else if (file.base === 'package.json') {\n           file.data = overridePackageName(file.data)\n         }"
        },
        {
            "sha": "65453c038abfb6fa9bbd9dce9008e6d415643d35",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/323a9c9febf748a77074ce4c05c7d59e5b8cd501/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/323a9c9febf748a77074ce4c05c7d59e5b8cd501/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=323a9c9febf748a77074ce4c05c7d59e5b8cd501",
            "patch": "@@ -1432,6 +1432,9 @@ importers:\n       react-refresh:\n         specifier: 0.12.0\n         version: 0.12.0\n+      recast:\n+        specifier: 0.23.11\n+        version: 0.23.11\n       regenerator-runtime:\n         specifier: 0.13.4\n         version: 0.13.4\n@@ -13692,6 +13695,7 @@ packages:\n     engines: {node: '>=0.6.0', teleport: '>=0.2.0'}\n     deprecated: |-\n       You or someone you depend on is using Q, the JavaScript Promise library that gave JavaScript developers strong feelings about promises. They can almost certainly migrate to the native JavaScript promise now. Thank you literally everyone for joining me in this bet against the odds. Be excellent to each other.\n+\n       (For a CapTP with native promises, see @endo/eventual-send and @endo/captp)\n \n   qs@6.11.0:\n@@ -14000,6 +14004,10 @@ packages:\n     resolution: {integrity: sha512-E5qICoPoNL4yU0H0NoBDntNB0Q5oMSNh9usFctYniLBluTthi3RsQVBXIJNbApOlvSwW/RGxIuokPcAc59J5fQ==}\n     engines: {node: '>= 4'}\n \n+  recast@0.23.11:\n+    resolution: {integrity: sha512-YTUo+Flmw4ZXiWfQKGcwwc11KnoRAYgzAE2E7mXKCjSviTKShtxBsN6YUUBB2gtaBzKzeKunxhUwNHQuRryhWA==}\n+    engines: {node: '>= 4'}\n+\n   recast@0.23.9:\n     resolution: {integrity: sha512-Hx/BGIbwj+Des3+xy5uAtAbdCyqK9y9wbBcDFDYanLS9JnMqf7OeF87HQwUimE87OEc72mr6tkKUKMBBL+hF9Q==}\n     engines: {node: '>= 4'}\n@@ -20404,7 +20412,7 @@ snapshots:\n       esbuild-register: 3.6.0(esbuild@0.24.2)\n       jsdoc-type-pratt-parser: 4.0.0\n       process: 0.11.10\n-      recast: 0.23.9\n+      recast: 0.23.11\n       semver: 7.6.3\n       util: 0.12.5\n       ws: 8.2.3\n@@ -31887,6 +31895,14 @@ snapshots:\n       source-map: 0.6.1\n       tslib: 2.8.1\n \n+  recast@0.23.11:\n+    dependencies:\n+      ast-types: 0.16.1\n+      esprima: 4.0.1\n+      source-map: 0.6.1\n+      tiny-invariant: 1.3.3\n+      tslib: 2.8.1\n+\n   recast@0.23.9:\n     dependencies:\n       ast-types: 0.16.1"
        }
    ],
    "stats": {
        "total": 591,
        "additions": 361,
        "deletions": 230
    }
}