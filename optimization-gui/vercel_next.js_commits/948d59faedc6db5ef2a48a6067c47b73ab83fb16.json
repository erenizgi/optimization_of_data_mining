{
    "author": "ztanner",
    "message": "exclude images and static media from dev origin check (#77417)\n\nExcludes `/_next/image` and `/_next/static/media` as they don't contain sensitive information and prevents complications loading them in cases where they are inlined in CSS, as they'll be requested with `sec-fetch-mode: no-cors`. \r\n\r\nx-ref: https://github.com/vercel/next.js/issues/77344",
    "sha": "948d59faedc6db5ef2a48a6067c47b73ab83fb16",
    "files": [
        {
            "sha": "0ea728fef158fcfb10a5efb823f0c6fed8cf5ea6",
            "filename": "packages/next/src/server/lib/router-utils/block-cross-site.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/948d59faedc6db5ef2a48a6067c47b73ab83fb16/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/948d59faedc6db5ef2a48a6067c47b73ab83fb16/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts?ref=948d59faedc6db5ef2a48a6067c47b73ab83fb16",
            "patch": "@@ -31,6 +31,25 @@ function warnOrBlockRequest(\n   return true\n }\n \n+function isInternalDevEndpoint(req: IncomingMessage): boolean {\n+  if (!req.url) return false\n+\n+  try {\n+    // TODO: We should standardize on a single prefix for this\n+    const isMiddlewareRequest = req.url.includes('/__nextjs')\n+    const isInternalAsset = req.url.includes('/_next')\n+    // Static media requests are excluded, as they might be loaded via CSS and would fail\n+    // CORS checks.\n+    const isIgnoredRequest =\n+      req.url.includes('/_next/image') ||\n+      req.url.includes('/_next/static/media')\n+\n+    return !isIgnoredRequest && (isInternalAsset || isMiddlewareRequest)\n+  } catch (err) {\n+    return false\n+  }\n+}\n+\n export const blockCrossSite = (\n   req: IncomingMessage,\n   res: ServerResponse | Duplex,\n@@ -51,8 +70,7 @@ export const blockCrossSite = (\n   }\n \n   // only process internal URLs/middleware\n-  // TODO: We should standardize on a single prefix for this\n-  if (!req.url?.includes('/_next') && !req.url?.includes('/__nextjs')) {\n+  if (!isInternalDevEndpoint(req)) {\n     return false\n   }\n   // block non-cors request from cross-site e.g. script tag on"
        },
        {
            "sha": "81dcce643296e0162bf743e0f18657c146470a47",
            "filename": "test/development/basic/allowed-dev-origins.test.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/948d59faedc6db5ef2a48a6067c47b73ab83fb16/test%2Fdevelopment%2Fbasic%2Fallowed-dev-origins.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/948d59faedc6db5ef2a48a6067c47b73ab83fb16/test%2Fdevelopment%2Fbasic%2Fallowed-dev-origins.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fallowed-dev-origins.test.ts?ref=948d59faedc6db5ef2a48a6067c47b73ab83fb16",
            "patch": "@@ -318,6 +318,37 @@ describe.each([['', '/docs']])(\n           server.close()\n         }\n       })\n+\n+      it('should load images regardless of allowed origins', async () => {\n+        const { server, port } = await createHostServer()\n+        try {\n+          const browser = await webdriver(`http://127.0.0.1:${port}`, '/about')\n+\n+          const imageSnippet = `(() => {\n+            const statusEl = document.createElement('p')\n+            statusEl.id = 'status'\n+            document.querySelector('body').appendChild(statusEl)\n+\n+            const image = document.createElement('img')\n+            image.src = \"${next.url}/_next/image?url=%2Fimage.png&w=256&q=75\"\n+            document.querySelector('body').appendChild(image)\n+            image.onload = () => {\n+              statusEl.innerText = 'OK'\n+            }\n+            image.onerror = () => {\n+              statusEl.innerText = 'Unauthorized'\n+            }\n+          })()`\n+\n+          await browser.eval(imageSnippet)\n+\n+          await retry(async () => {\n+            expect(await browser.elementByCss('#status').text()).toBe('OK')\n+          })\n+        } finally {\n+          server.close()\n+        }\n+      })\n     })\n   }\n )"
        },
        {
            "sha": "7cbc1d26733614b83dcc25b9cfcd5e06dffb147c",
            "filename": "test/development/basic/misc/public/image.png",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/948d59faedc6db5ef2a48a6067c47b73ab83fb16/test%2Fdevelopment%2Fbasic%2Fmisc%2Fpublic%2Fimage.png",
            "raw_url": "https://github.com/vercel/next.js/raw/948d59faedc6db5ef2a48a6067c47b73ab83fb16/test%2Fdevelopment%2Fbasic%2Fmisc%2Fpublic%2Fimage.png",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fmisc%2Fpublic%2Fimage.png?ref=948d59faedc6db5ef2a48a6067c47b73ab83fb16"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 51,
        "deletions": 2
    }
}