{
    "author": "mischnic",
    "message": "Turbopack: escape colon in output names (#88273)",
    "sha": "6bd4aaca8d265bb77ae42fa3c1f28fff06eeb33a",
    "files": [
        {
            "sha": "f31b500d248411ef0998bb0838b5eb002cf4631f",
            "filename": "turbopack/crates/turbopack-core/src/ident.rs",
            "status": "modified",
            "additions": 35,
            "deletions": 4,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/6bd4aaca8d265bb77ae42fa3c1f28fff06eeb33a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fident.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6bd4aaca8d265bb77ae42fa3c1f28fff06eeb33a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fident.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fident.rs?ref=6bd4aaca8d265bb77ae42fa3c1f28fff06eeb33a",
            "patch": "@@ -223,9 +223,9 @@ impl AssetIdent {\n         // For clippy -- This explicit deref is necessary\n         let path = &self.path;\n         let mut name = if let Some(inner) = context_path.get_path_to(path) {\n-            clean_separators(inner)\n+            escape_file_path(inner)\n         } else {\n-            clean_separators(&self.path.value_to_string().await?)\n+            escape_file_path(&self.path.value_to_string().await?)\n         };\n         let removed_extension = name.ends_with(&*expected_extension);\n         if removed_extension {\n@@ -433,11 +433,42 @@ impl ValueToString for AssetIdent {\n     }\n }\n \n-fn clean_separators(s: &str) -> String {\n-    static SEPARATOR_REGEX: Lazy<Regex> = Lazy::new(|| Regex::new(r\"[/#?]\").unwrap());\n+fn escape_file_path(s: &str) -> String {\n+    static SEPARATOR_REGEX: Lazy<Regex> = Lazy::new(|| Regex::new(r\"[/#?:]\").unwrap());\n     SEPARATOR_REGEX.replace_all(s, \"_\").to_string()\n }\n \n fn clean_additional_extensions(s: &str) -> String {\n     s.replace('.', \"_\")\n }\n+\n+#[cfg(test)]\n+pub mod tests {\n+    use turbo_rcstr::rcstr;\n+    use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n+    use turbo_tasks_fs::{FileSystem, VirtualFileSystem};\n+\n+    use crate::ident::AssetIdent;\n+\n+    #[tokio::test(flavor = \"multi_thread\", worker_threads = 2)]\n+    async fn test_output_name_escaping() {\n+        let tt = turbo_tasks::TurboTasks::new(TurboTasksBackend::new(\n+            BackendOptions::default(),\n+            noop_backing_storage(),\n+        ));\n+        tt.run_once(async move {\n+            let fs = VirtualFileSystem::new_with_name(rcstr!(\"test\"));\n+            let root = fs.root().owned().await?;\n+\n+            let asset_ident = AssetIdent::from_path(root.join(\"a:b?c#d.js\")?);\n+            let output_name = asset_ident\n+                .output_name(root.clone(), Some(rcstr!(\"prefix\")), rcstr!(\".js\"))\n+                .await?;\n+            assert_eq!(&*output_name, \"prefix-a_b_c_d.js\");\n+\n+            Ok(())\n+        })\n+        .await\n+        .unwrap();\n+    }\n+}"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 35,
        "deletions": 4
    }
}