{
    "author": "lukesandberg",
    "message": "[turbopack] Enable debug assertions in CI (#80739)\n\n## Enable debug assertions in CI\n\n### What?\nBuild using `--profile release-with-assertions` for all tests in CI.  A previous PR (https://github.com/vercel/next.js/pull/80511) enabled them for unit tests, this completes the effort for e2e tests run in CI.\n\nThere is one exception. The production tests currently have a failing assertion for duplicate modules, so a new env var (`TURBOPACK_TEMP_DISABLE_DUPLICATE_MODULES_CHECK`) is introduced to disable that exact check to allow this to be landed.\n\n### Why?\nDebug assertions help catch bugs early by validating assumptions in the code. By enabling them in tests, we can improve quality\n\n### How?\n- Added a new `rustBuildProfile` parameter to the reusable build workflow to control the build profile\n- Created a new `build-native-release-with-assertions` script in next-swc to set the cargo profile\n- Updated the turbopack production tests to set the opt out variable\n\nPart-of PACK-4578",
    "sha": "5c15979bccbbebebfb33194ad8b1bdf62f8be18a",
    "files": [
        {
            "sha": "a2fe5c97dba764e0a47c54b0d8f56b5e432ee065",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c15979bccbbebebfb33194ad8b1bdf62f8be18a/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/5c15979bccbbebebfb33194ad8b1bdf62f8be18a/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=5c15979bccbbebebfb33194ad8b1bdf62f8be18a",
            "patch": "@@ -315,6 +315,8 @@ jobs:\n         export TURBOPACK_BUILD=1\n         export NEXT_TEST_MODE=start\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n+        # TODO(PACK-4578): Remove\n+        export TURBOPACK_TEMP_DISABLE_DUPLICATE_MODULES_CHECK=1\n \n         node run-tests.js --timings -g ${{ matrix.group }} --type production\n       stepName: 'test-turbopack-production-react-${{ matrix.react }}-${{ matrix.group }}'"
        },
        {
            "sha": "a0b290e27d38f45a2b370479352fb254271cdc66",
            "filename": ".github/workflows/build_reusable.yml",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5c15979bccbbebebfb33194ad8b1bdf62f8be18a/.github%2Fworkflows%2Fbuild_reusable.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/5c15979bccbbebebfb33194ad8b1bdf62f8be18a/.github%2Fworkflows%2Fbuild_reusable.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_reusable.yml?ref=5c15979bccbbebebfb33194ad8b1bdf62f8be18a",
            "patch": "@@ -42,6 +42,11 @@ on:\n         required: false\n         description: 'if nextest rust dep is needed'\n         type: string\n+      rustBuildProfile:\n+        required: false\n+        description: 'The profile to use for the build, default is `release-with-assertions`, also supports `` for debug and `release` for normal release'\n+        type: string\n+        default: 'release-with-assertions'\n       uploadSwcArtifact:\n         required: false\n         description: 'if swc artifact needs uploading'\n@@ -179,7 +184,7 @@ jobs:\n         with:\n           cache-provider: 'turbo'\n           save-if: ${{ github.ref_name == 'canary' }}\n-          shared-key: ${{ inputs.rustCacheKey }}-${{ inputs.buildNativeTarget }}-build-${{ hashFiles('.cargo/config.toml') }}\n+          shared-key: ${{ inputs.rustCacheKey }}-${{ inputs.buildNativeTarget }}-build-${{ inputs.rustBuildProfile }}-${{ hashFiles('.cargo/config.toml') }}\n \n       # clean up any previous artifacts to avoid hitting disk space limits\n       - run: git clean -xdf && rm -rf /tmp/next-repo-*; rm -rf /tmp/next-install-* /tmp/yarn-* /tmp/ncc-cache target\n@@ -197,7 +202,7 @@ jobs:\n       - run: node scripts/normalize-version-bump.js\n         name: normalize versions\n \n-      - run: pnpm dlx turbo@${TURBO_VERSION} run build-native-release -v --env-mode loose --remote-cache-timeout 90 --summarize -- --target ${{ inputs.buildNativeTarget }}\n+      - run: pnpm dlx turbo@${TURBO_VERSION} run build-native-${{ inputs.rustBuildProfile }} -v --env-mode loose --remote-cache-timeout 90 --summarize -- --target ${{ inputs.buildNativeTarget }}\n         if: ${{ inputs.skipNativeBuild != 'yes' }}\n \n       - name: Upload next-swc artifact"
        },
        {
            "sha": "d1e68363f4be8e8fb3b74e564e2a9ef6781d1b3e",
            "filename": "packages/next-swc/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5c15979bccbbebebfb33194ad8b1bdf62f8be18a/packages%2Fnext-swc%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5c15979bccbbebebfb33194ad8b1bdf62f8be18a/packages%2Fnext-swc%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-swc%2Fpackage.json?ref=5c15979bccbbebebfb33194ad8b1bdf62f8be18a",
            "patch": "@@ -9,6 +9,7 @@\n     \"clean\": \"node ../../scripts/rm.mjs native\",\n     \"build-native\": \"napi build --platform -p next-swc-napi --cargo-cwd ../../ --cargo-name next_swc_napi --features plugin,image-extended --js false native\",\n     \"build-native-release\": \"napi build --platform -p next-swc-napi --cargo-cwd ../../ --cargo-name next_swc_napi --release --features plugin,image-extended,tracing/release_max_level_info --js false native\",\n+    \"build-native-release-with-assertions\": \"napi build --platform -p next-swc-napi --cargo-cwd ../../ --cargo-name next_swc_napi --profile release-with-assertions --features plugin,image-extended,tracing/release_max_level_info --js false native\",\n     \"build-native-no-plugin\": \"napi build --platform -p next-swc-napi --cargo-cwd ../../ --cargo-name next_swc_napi --features image-webp --js false native\",\n     \"build-native-no-plugin-release\": \"napi build --platform -p next-swc-napi --cargo-cwd ../../ --cargo-name next_swc_napi --release --features image-webp,tracing/release_max_level_info --js false native\",\n     \"build-native-wasi\": \"npx --package=@napi-rs/cli@3.0.0-alpha.45 napi build --platform --target wasm32-wasip1-threads -p next-swc-napi --cwd ../../ --output-dir packages/next-swc/native --no-default-features\","
        },
        {
            "sha": "dde214ce4d7667462e37433097d0087e9cc0c749",
            "filename": "packages/next-swc/turbo.json",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/5c15979bccbbebebfb33194ad8b1bdf62f8be18a/packages%2Fnext-swc%2Fturbo.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5c15979bccbbebebfb33194ad8b1bdf62f8be18a/packages%2Fnext-swc%2Fturbo.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-swc%2Fturbo.json?ref=5c15979bccbbebebfb33194ad8b1bdf62f8be18a",
            "patch": "@@ -28,6 +28,19 @@\n       \"env\": [\"CI\"],\n       \"outputs\": [\"native/*.node\"]\n     },\n+    \"build-native-release-with-assertions\": {\n+      \"inputs\": [\n+        \"../../.cargo/**\",\n+        \"../../crates/**\",\n+        \"../../turbopack/crates/**\",\n+        \"../../**/Cargo.toml\",\n+        \"../../**/Cargo.lock\",\n+        \"../../.github/workflows/build_and_deploy.yml\",\n+        \"../../rust-toolchain\"\n+      ],\n+      \"env\": [\"CI\"],\n+      \"outputs\": [\"native/*.node\"]\n+    },\n     \"build-native-no-plugin\": {\n       \"inputs\": [\n         \"../../.cargo/**\","
        },
        {
            "sha": "e7e72dc1bab5b03ebe81d9b4d31b7fe9fb104559",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 9,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/5c15979bccbbebebfb33194ad8b1bdf62f8be18a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c15979bccbbebebfb33194ad8b1bdf62f8be18a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=5c15979bccbbebebfb33194ad8b1bdf62f8be18a",
            "patch": "@@ -344,16 +344,27 @@ impl SingleModuleGraph {\n \n         #[cfg(debug_assertions)]\n         {\n-            let mut duplicates = Vec::new();\n-            let mut set = FxHashSet::default();\n-            for &module in modules.keys() {\n-                let ident = module.ident().to_string().await?;\n-                if !set.insert(ident.clone()) {\n-                    duplicates.push(ident)\n+            use once_cell::sync::Lazy;\n+\n+            // TODO(PACK-4578): This is temporary while the last issues are being addressed.\n+            static CHECK_FOR_DUPLICATE_MODULES: Lazy<bool> = Lazy::new(|| {\n+                match std::env::var_os(\"TURBOPACK_TEMP_DISABLE_DUPLICATE_MODULES_CHECK\") {\n+                    Some(v) => v != \"1\" && v != \"true\",\n+                    None => true,\n+                }\n+            });\n+            if *CHECK_FOR_DUPLICATE_MODULES {\n+                let mut duplicates = Vec::new();\n+                let mut set = FxHashSet::default();\n+                for &module in modules.keys() {\n+                    let ident = module.ident().to_string().await?;\n+                    if !set.insert(ident.clone()) {\n+                        duplicates.push(ident)\n+                    }\n+                }\n+                if !duplicates.is_empty() {\n+                    panic!(\"Duplicate module idents in graph: {duplicates:#?}\");\n                 }\n-            }\n-            if !duplicates.is_empty() {\n-                panic!(\"Duplicate module idents in graph: {duplicates:#?}\");\n             }\n         }\n "
        }
    ],
    "stats": {
        "total": 54,
        "additions": 43,
        "deletions": 11
    }
}