{
    "author": "gaojude",
    "message": "Fix RSC hash validation for middleware external rewrites (#82176)",
    "sha": "9c120306afd437b6640c9b9964abcfffbf459f52",
    "files": [
        {
            "sha": "85ef84dbbc6ce9b5b5af7f105186373375abd752",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/9c120306afd437b6640c9b9964abcfffbf459f52/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9c120306afd437b6640c9b9964abcfffbf459f52/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=9c120306afd437b6640c9b9964abcfffbf459f52",
            "patch": "@@ -19,6 +19,7 @@ import {\n   FLIGHT_HEADERS,\n   NEXT_REWRITTEN_PATH_HEADER,\n   NEXT_REWRITTEN_QUERY_HEADER,\n+  NEXT_RSC_UNION_QUERY,\n   RSC_HEADER,\n } from '../../client/components/app-router-headers'\n import { ensureInstrumentationRegistered } from './globals'\n@@ -166,6 +167,8 @@ export async function adapter(\n     ? new URL(params.request.url)\n     : requestURL\n \n+  const rscHash = normalizeURL.searchParams.get(NEXT_RSC_UNION_QUERY)\n+\n   const request = new NextRequestHint({\n     page: params.page,\n     // Strip internal query parameters off the request.\n@@ -397,6 +400,24 @@ export async function adapter(\n     }\n   }\n \n+  /**\n+   * Always forward the `_rsc` search parameter to the rewritten URL for RSC requests,\n+   * unless it's already present. This is necessary to ensure that RSC hash validation\n+   * works correctly after a rewrite. For internal rewrites, the server can validate the\n+   * RSC hash using the original URL, so forwarding the `_rsc` parameter is less critical.\n+   * However, for external rewrites (where the request is proxied to another Next.js server),\n+   * the external server does not have access to the original URL or its search parameters.\n+   * In these cases, forwarding the `_rsc` parameter is essential so that the external server\n+   * can perform the correct RSC hash validation.\n+   */\n+  if (response && rewrite && isRSCRequest && rscHash) {\n+    const rewriteURL = new URL(rewrite)\n+    if (!rewriteURL.searchParams.has(NEXT_RSC_UNION_QUERY)) {\n+      rewriteURL.searchParams.set(NEXT_RSC_UNION_QUERY, rscHash)\n+      response.headers.set('x-middleware-rewrite', rewriteURL.toString())\n+    }\n+  }\n+\n   /**\n    * For redirects we will not include the locale in case when it is the\n    * default and we must also make sure the outgoing URL is a data one if"
        },
        {
            "sha": "31b07b00ce26195ae6633d29df60800db10ff3d3",
            "filename": "packages/next/src/server/web/sandbox/sandbox.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9c120306afd437b6640c9b9964abcfffbf459f52/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9c120306afd437b6640c9b9964abcfffbf459f52/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts?ref=9c120306afd437b6640c9b9964abcfffbf459f52",
            "patch": "@@ -7,7 +7,6 @@ import {\n   edgeSandboxNextRequestContext,\n } from './context'\n import { requestToBodyStream } from '../../body-streams'\n-import { NEXT_RSC_UNION_QUERY } from '../../../client/components/app-router-headers'\n import type { ServerComponentsHmrCache } from '../../response-cache'\n import {\n   getBuiltinRequestContext,\n@@ -117,7 +116,6 @@ export const run = withTaggedErrors(async function runWithTaggedErrors(params) {\n \n   const KUint8Array = runtime.evaluate('Uint8Array')\n   const urlInstance = new URL(params.request.url)\n-  urlInstance.searchParams.delete(NEXT_RSC_UNION_QUERY)\n \n   params.request.url = urlInstance.toString()\n "
        },
        {
            "sha": "6470e5afdf1c83285b374cd9d189f4af42f7e887",
            "filename": "test/e2e/app-dir/middleware-rsc-external-rewrite/app/about/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fapp%2Fabout%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fapp%2Fabout%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fapp%2Fabout%2Fpage.tsx?ref=9c120306afd437b6640c9b9964abcfffbf459f52",
            "patch": "@@ -0,0 +1,9 @@\n+// This page won't actually be served due to middleware rewrite\n+export default function AboutPage() {\n+  return (\n+    <div>\n+      <h1>About Page (This should not be seen)</h1>\n+      <p>This page should be rewritten to external server</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/middleware-rsc-external-rewrite/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fapp%2Flayout.tsx?ref=9c120306afd437b6640c9b9964abcfffbf459f52",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "2f1569b7e79a756ad231ba2ca43e22a03036c016",
            "filename": "test/e2e/app-dir/middleware-rsc-external-rewrite/app/page.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fapp%2Fpage.tsx?ref=9c120306afd437b6640c9b9964abcfffbf459f52",
            "patch": "@@ -0,0 +1,15 @@\n+import Link from 'next/link'\n+\n+export default function HomePage() {\n+  return (\n+    <div>\n+      <h1>Home Page</h1>\n+      <div id=\"home-content\">\n+        <p>This is the home page</p>\n+        <Link href=\"/about\" id=\"about-link\">\n+          Go to About Page\n+        </Link>\n+      </div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "33b138cc64c32cb5d48d39f19d8e3e2dcba16f54",
            "filename": "test/e2e/app-dir/middleware-rsc-external-rewrite/external-server.mjs",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fexternal-server.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fexternal-server.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fexternal-server.mjs?ref=9c120306afd437b6640c9b9964abcfffbf459f52",
            "patch": "@@ -0,0 +1,49 @@\n+import { createServer } from 'node:http'\n+\n+let receivedRequests = []\n+\n+function createExternalServer() {\n+  const server = createServer((req, res) => {\n+    const requestUrl = `${req.url}`\n+    console.log('External server received request:', requestUrl)\n+\n+    // Store the request for testing\n+    receivedRequests.push({\n+      url: requestUrl,\n+      method: req.method,\n+      headers: req.headers,\n+      timestamp: Date.now(),\n+    })\n+\n+    // Simple response\n+    res.writeHead(200, { 'Content-Type': 'text/html' })\n+    res.end(`\n+      <html>\n+        <body>\n+          <h1>External Server Response</h1>\n+          <p>Request URL: ${requestUrl}</p>\n+          <div id=\"external-response\">External server handled the request</div>\n+        </body>\n+      </html>\n+    `)\n+  })\n+\n+  return server\n+}\n+\n+export async function startExternalServer(port) {\n+  receivedRequests = [] // Reset requests\n+  const server = createExternalServer()\n+\n+  const cleanup = async () => {\n+    await new Promise((resolve) => server.close(resolve))\n+  }\n+\n+  return new Promise((resolve, reject) => {\n+    server.on('error', reject)\n+    server.listen(port, () => {\n+      console.log('External server listening on port', port)\n+      resolve({ cleanup, getReceivedRequests: () => receivedRequests })\n+    })\n+  })\n+}"
        },
        {
            "sha": "8ab8361deb967081767d8fba72491149ee9eb15d",
            "filename": "test/e2e/app-dir/middleware-rsc-external-rewrite/middleware-rsc-external-rewrite.test.ts",
            "status": "added",
            "additions": 101,
            "deletions": 0,
            "changes": 101,
            "blob_url": "https://github.com/vercel/next.js/blob/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fmiddleware-rsc-external-rewrite.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fmiddleware-rsc-external-rewrite.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fmiddleware-rsc-external-rewrite.test.ts?ref=9c120306afd437b6640c9b9964abcfffbf459f52",
            "patch": "@@ -0,0 +1,101 @@\n+import webdriver from 'next-webdriver'\n+import { findPort, nextBuild, nextStart } from 'next-test-utils'\n+import { isNextDeploy, isNextDev } from 'e2e-utils'\n+import { startExternalServer } from './external-server.mjs'\n+\n+describe('middleware RSC external rewrite', () => {\n+  if (isNextDev || isNextDeploy) {\n+    test('should not run during dev or deploy test runs', () => {})\n+    return\n+  }\n+\n+  let cleanup: () => Promise<void>\n+  let nextPort: number\n+  let externalServerManager: {\n+    cleanup: () => Promise<void>\n+    getReceivedRequests: () => any[]\n+  }\n+\n+  beforeAll(async () => {\n+    const appDir = __dirname\n+    await nextBuild(appDir, undefined, { cwd: appDir })\n+\n+    // Start external server first\n+    const externalPort = await findPort()\n+    process.env.EXTERNAL_SERVER_PORT = externalPort.toString()\n+    externalServerManager = await startExternalServer(externalPort)\n+\n+    // Start Next.js server\n+    nextPort = await findPort()\n+    const nextApp = await nextStart(appDir, nextPort, {\n+      env: {\n+        ...process.env,\n+        EXTERNAL_SERVER_PORT: externalPort.toString(),\n+      },\n+    })\n+\n+    cleanup = async () => {\n+      await nextApp.kill()\n+      await externalServerManager.cleanup()\n+    }\n+  })\n+\n+  afterAll(async () => {\n+    if (cleanup) {\n+      await cleanup()\n+    }\n+  })\n+\n+  test('should forward _rsc parameter to external server on RSC navigation', async () => {\n+    let browser\n+\n+    try {\n+      browser = await webdriver(nextPort, '/')\n+\n+      // Verify we're on the home page\n+      const homeContent = await browser.elementById('home-content')\n+      expect(await homeContent.text()).toContain('This is the home page')\n+\n+      // Clear any previous requests\n+      const initialRequests = externalServerManager.getReceivedRequests()\n+      console.log('Initial requests before navigation:', initialRequests.length)\n+\n+      // Click the link to /about which should trigger RSC navigation\n+      const aboutLink = await browser.elementById('about-link')\n+      await aboutLink.click()\n+\n+      // Wait a bit for the request to be processed\n+      await browser.waitForElementByCss('#external-response', 5000)\n+\n+      // Check that external server received the request\n+      const receivedRequests = externalServerManager.getReceivedRequests()\n+      console.log('Total requests received:', receivedRequests.length)\n+      console.log(\n+        'Received requests:',\n+        receivedRequests.map((r) => ({ url: r.url, method: r.method }))\n+      )\n+\n+      // Find requests that contain _rsc parameter\n+      const rscRequests = receivedRequests.filter((req) =>\n+        req.url.includes('_rsc=')\n+      )\n+      console.log(\n+        'RSC requests:',\n+        rscRequests.map((r) => r.url)\n+      )\n+\n+      // Verify that at least one request contains the _rsc parameter\n+      expect(rscRequests.length).toBeGreaterThan(0)\n+\n+      // Verify the external server response is displayed\n+      const externalResponse = await browser.elementById('external-response')\n+      expect(await externalResponse.text()).toBe(\n+        'External server handled the request'\n+      )\n+    } finally {\n+      if (browser) {\n+        await browser.close()\n+      }\n+    }\n+  })\n+})"
        },
        {
            "sha": "7b87fed7b63daf6e7460447acd348f5ad28061d3",
            "filename": "test/e2e/app-dir/middleware-rsc-external-rewrite/middleware.ts",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fmiddleware.ts?ref=9c120306afd437b6640c9b9964abcfffbf459f52",
            "patch": "@@ -0,0 +1,22 @@\n+import { NextRequest, NextResponse } from 'next/server'\n+\n+export function middleware(request: NextRequest) {\n+  const url = request.nextUrl.clone()\n+\n+  if (url.pathname === '/about') {\n+    // Get the external server port from environment or default\n+    const externalPort = process.env.EXTERNAL_SERVER_PORT || '3001'\n+    const externalUrl = `http://localhost:${externalPort}/about`\n+\n+    console.log('Middleware rewriting /about to:', externalUrl)\n+\n+    // Rewrite to external server\n+    return NextResponse.rewrite(externalUrl)\n+  }\n+\n+  return NextResponse.next()\n+}\n+\n+export const config = {\n+  matcher: ['/about'],\n+}"
        },
        {
            "sha": "a603ad028e86c4e05bd001badea237bfda61d532",
            "filename": "test/e2e/app-dir/middleware-rsc-external-rewrite/next.config.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9c120306afd437b6640c9b9964abcfffbf459f52/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rsc-external-rewrite%2Fnext.config.js?ref=9c120306afd437b6640c9b9964abcfffbf459f52",
            "patch": "@@ -0,0 +1,12 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    logging: {\n+      level: 'verbose',\n+    },\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 242,
        "additions": 240,
        "deletions": 2
    }
}