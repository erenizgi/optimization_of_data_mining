{
    "author": "ztanner",
    "message": "ensure /__next middleware URLs are included in the origin check (#77416)\n\nWe have special development endpoints that are also prefixed under `/__nextjs`. This updates the origin checking logic to account for those in addition to `/_next`, and adds a test.",
    "sha": "74ff4f68a45af7ec7d3d952cb6b26236b04698aa",
    "files": [
        {
            "sha": "f4bd72b56d2be677aee0d33b33a7dda92312a9e4",
            "filename": "packages/next/src/server/lib/router-utils/block-cross-site.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/74ff4f68a45af7ec7d3d952cb6b26236b04698aa/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/74ff4f68a45af7ec7d3d952cb6b26236b04698aa/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts?ref=74ff4f68a45af7ec7d3d952cb6b26236b04698aa",
            "patch": "@@ -50,8 +50,9 @@ export const blockCrossSite = (\n     allowedOrigins.push(hostname)\n   }\n \n-  // only process _next URLs\n-  if (!req.url?.includes('/_next')) {\n+  // only process internal URLs/middleware\n+  // TODO: We should standardize on a single prefix for this\n+  if (!req.url?.includes('/_next') && !req.url?.includes('/__nextjs')) {\n     return false\n   }\n   // block non-cors request from cross-site e.g. script tag on"
        },
        {
            "sha": "b0b25aa20c03ae40dbef3128dca5c1edfae28bc3",
            "filename": "test/development/basic/allowed-dev-origins.test.ts",
            "status": "modified",
            "additions": 103,
            "deletions": 57,
            "changes": 160,
            "blob_url": "https://github.com/vercel/next.js/blob/74ff4f68a45af7ec7d3d952cb6b26236b04698aa/test%2Fdevelopment%2Fbasic%2Fallowed-dev-origins.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/74ff4f68a45af7ec7d3d952cb6b26236b04698aa/test%2Fdevelopment%2Fbasic%2Fallowed-dev-origins.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fallowed-dev-origins.test.ts?ref=74ff4f68a45af7ec7d3d952cb6b26236b04698aa",
            "patch": "@@ -5,6 +5,29 @@ import { createNext, FileRef } from 'e2e-utils'\n import { NextInstance } from 'e2e-utils'\n import { fetchViaHTTP, findPort, retry } from 'next-test-utils'\n \n+async function createHostServer() {\n+  const server = http.createServer((req, res) => {\n+    res.end(`\n+      <html>\n+        <head>\n+          <title>testing cross-site</title> \n+        </head>\n+        <body></body>\n+      </html>\n+    `)\n+  })\n+\n+  const port = await findPort()\n+  await new Promise<void>((res) => {\n+    server.listen(port, () => res())\n+  })\n+\n+  return {\n+    server,\n+    port,\n+  }\n+}\n+\n describe.each([['', '/docs']])(\n   'allowed-dev-origins, basePath: %p',\n   (basePath: string) => {\n@@ -34,21 +57,8 @@ describe.each([['', '/docs']])(\n       afterAll(() => next.destroy())\n \n       it('should warn about WebSocket from cross-site', async () => {\n-        let server = http.createServer((req, res) => {\n-          res.end(`\n-              <html>\n-                <head>\n-                  <title>testing cross-site</title>\n-                </head>\n-                <body></body>\n-              </html>\n-            `)\n-        })\n+        const { server, port } = await createHostServer()\n         try {\n-          const port = await findPort()\n-          await new Promise<void>((res) => {\n-            server.listen(port, () => res())\n-          })\n           const websocketSnippet = `(() => {\n               const statusEl = document.createElement('p')\n               statusEl.id = 'status'\n@@ -88,22 +98,10 @@ describe.each([['', '/docs']])(\n         }\n       })\n \n-      it('should not allow loading scripts from cross-site', async () => {\n-        let server = http.createServer((req, res) => {\n-          res.end(`\n-              <html>\n-                <head>\n-                  <title>testing cross-site</title>\n-                </head>\n-                <body></body>\n-              </html>\n-            `)\n-        })\n+      it('should warn about loading scripts from cross-site', async () => {\n+        const { server, port } = await createHostServer()\n+\n         try {\n-          const port = await findPort()\n-          await new Promise<void>((res) => {\n-            server.listen(port, () => res())\n-          })\n           const scriptSnippet = `(() => {\n               const statusEl = document.createElement('p')\n               statusEl.id = 'status'\n@@ -146,6 +144,46 @@ describe.each([['', '/docs']])(\n           server.close()\n         }\n       })\n+\n+      it('should warn about loading internal middleware from cross-site', async () => {\n+        const { server, port } = await createHostServer()\n+        try {\n+          const browser = await webdriver(`http://127.0.0.1:${port}`, '/about')\n+\n+          const middlewareSnippet = `(() => {\n+            const statusEl = document.createElement('p')\n+            statusEl.id = 'status'\n+            document.querySelector('body').appendChild(statusEl)\n+\n+            const xhr = new XMLHttpRequest()\n+            xhr.open('GET', '${next.url}/__nextjs_error_feedback?errorCode=0&wasHelpful=true', true)\n+            xhr.send()\n+\n+            xhr.onload = () => {\n+              statusEl.innerText = \"OK\"\n+            }\n+            xhr.onerror = () => {\n+              statusEl.innerText = \"Unauthorized\"\n+            }\n+          })()`\n+\n+          await browser.eval(middlewareSnippet)\n+\n+          await retry(async () => {\n+            // TODO: These requests seem to be blocked regardless of our handling only when running with Turbopack\n+            // Investigate why this is the case\n+            if (!process.env.TURBOPACK) {\n+              expect(await browser.elementByCss('#status').text()).toBe('OK')\n+            }\n+\n+            expect(next.cliOutput).toContain(\n+              'Cross origin request detected from'\n+            )\n+          })\n+        } finally {\n+          server.close()\n+        }\n+      })\n     })\n \n     describe('block mode', () => {\n@@ -173,21 +211,8 @@ describe.each([['', '/docs']])(\n       afterAll(() => next.destroy())\n \n       it('should not allow dev WebSocket from cross-site', async () => {\n-        let server = http.createServer((req, res) => {\n-          res.end(`\n-              <html>\n-                <head>\n-                  <title>testing cross-site</title>\n-                </head>\n-                <body></body>\n-              </html>\n-            `)\n-        })\n+        const { server, port } = await createHostServer()\n         try {\n-          const port = await findPort()\n-          await new Promise<void>((res) => {\n-            server.listen(port, () => res())\n-          })\n           const websocketSnippet = `(() => {\n               const statusEl = document.createElement('p')\n               statusEl.id = 'status'\n@@ -222,21 +247,8 @@ describe.each([['', '/docs']])(\n       })\n \n       it('should not allow loading scripts from cross-site', async () => {\n-        let server = http.createServer((req, res) => {\n-          res.end(`\n-              <html>\n-                <head>\n-                  <title>testing cross-site</title>\n-                </head>\n-                <body></body>\n-              </html>\n-            `)\n-        })\n+        const { server, port } = await createHostServer()\n         try {\n-          const port = await findPort()\n-          await new Promise<void>((res) => {\n-            server.listen(port, () => res())\n-          })\n           const scriptSnippet = `(() => {\n               const statusEl = document.createElement('p')\n               statusEl.id = 'status'\n@@ -272,6 +284,40 @@ describe.each([['', '/docs']])(\n           server.close()\n         }\n       })\n+\n+      it('should not allow loading internal middleware from cross-site', async () => {\n+        const { server, port } = await createHostServer()\n+        try {\n+          const browser = await webdriver(`http://127.0.0.1:${port}`, '/about')\n+\n+          const middlewareSnippet = `(() => {\n+            const statusEl = document.createElement('p')\n+            statusEl.id = 'status'\n+            document.querySelector('body').appendChild(statusEl)\n+\n+            const xhr = new XMLHttpRequest()\n+            xhr.open('GET', '${next.url}/__nextjs_error_feedback?errorCode=0&wasHelpful=true', true)\n+            xhr.send()\n+\n+            xhr.onload = () => {\n+              statusEl.innerText = \"OK\"\n+            }\n+            xhr.onerror = () => {\n+              statusEl.innerText = \"Unauthorized\"\n+            }\n+          })()`\n+\n+          await browser.eval(middlewareSnippet)\n+\n+          await retry(async () => {\n+            expect(await browser.elementByCss('#status').text()).toBe(\n+              'Unauthorized'\n+            )\n+          })\n+        } finally {\n+          server.close()\n+        }\n+      })\n     })\n   }\n )"
        }
    ],
    "stats": {
        "total": 165,
        "additions": 106,
        "deletions": 59
    }
}