{
    "author": "jamesdaniels",
    "message": "Deployment adapter: fix metadata for \"/\" route (#85820)\n\nUpdates cases where `/` isn't normalized fully when interpolating into\ndata paths and adds regression tests.\n\n---------\n\nCo-authored-by: vercel[bot] <35613825+vercel[bot]@users.noreply.github.com>\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "28a14da5010ad3147a06abbabc99a119d009f733",
    "files": [
        {
            "sha": "89bbe88bcf6fb37c7d6437218a86a35f8213d373",
            "filename": "packages/next/src/build/adapter/build-complete.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 14,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/28a14da5010ad3147a06abbabc99a119d009f733/packages%2Fnext%2Fsrc%2Fbuild%2Fadapter%2Fbuild-complete.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/28a14da5010ad3147a06abbabc99a119d009f733/packages%2Fnext%2Fsrc%2Fbuild%2Fadapter%2Fbuild-complete.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fadapter%2Fbuild-complete.ts?ref=28a14da5010ad3147a06abbabc99a119d009f733",
            "patch": "@@ -727,8 +727,7 @@ export async function handleBuildComplete({\n \n         // need to add matching .rsc output\n         if (isAppPage) {\n-          const rscPathname =\n-            (output.pathname === '/' ? '/index' : output.pathname) + '.rsc'\n+          const rscPathname = normalizePagePath(output.pathname) + '.rsc'\n           outputs.appPages.push({\n             ...output,\n             pathname: rscPathname,\n@@ -864,7 +863,7 @@ export async function handleBuildComplete({\n             const dataPathname = path.posix.join(\n               '/_next/data',\n               buildId,\n-              page + '.json'\n+              normalizePagePath(page) + '.json'\n             )\n             outputs.pages.push({\n               ...output,\n@@ -1002,9 +1001,8 @@ export async function handleBuildComplete({\n           if (output.type === AdapterOutputType.APP_PAGE) {\n             outputs.appPages.push({\n               ...output,\n-              pathname:\n-                (output.pathname === '/' ? '/index' : output.pathname) + '.rsc',\n-              id: (output.id === '/' ? '/index' : output.pathname) + '.rsc',\n+              pathname: normalizePagePath(output.pathname) + '.rsc',\n+              id: normalizePagePath(output.pathname) + '.rsc',\n             })\n             outputs.appPages.push(output)\n           } else {\n@@ -1058,15 +1056,18 @@ export async function handleBuildComplete({\n         }\n \n         if (meta?.segmentPaths) {\n+          const normalizedRoute = normalizePagePath(route)\n           const segmentsDir = path.join(\n             appDistDir,\n-            `${route}${prefetchSegmentDirSuffix}`\n+            `${normalizedRoute}${prefetchSegmentDirSuffix}`\n           )\n \n           for (const segmentPath of meta.segmentPaths) {\n             const outputSegmentPath =\n-              path.join(route + prefetchSegmentDirSuffix, segmentPath) +\n-              prefetchSegmentSuffix\n+              path.join(\n+                normalizedRoute + prefetchSegmentDirSuffix,\n+                segmentPath\n+              ) + prefetchSegmentSuffix\n \n             const fallbackPathname = path.join(\n               segmentsDir,\n@@ -1114,10 +1115,11 @@ export async function handleBuildComplete({\n         route: string,\n         isAppPage: boolean\n       ): Promise<AppRouteMeta> => {\n+        const basename = route.endsWith('/') ? `${route}index` : route\n         const meta: AppRouteMeta = isAppPage\n           ? JSON.parse(\n               await fs\n-                .readFile(path.join(appDistDir, `${route}.meta`), 'utf8')\n+                .readFile(path.join(appDistDir, `${basename}.meta`), 'utf8')\n                 .catch(() => '{}')\n             )\n           : {}\n@@ -1192,7 +1194,7 @@ export async function handleBuildComplete({\n \n         let filePath = path.join(\n           isAppPage ? appDistDir : pagesDistDir,\n-          `${route === '/' ? 'index' : route}.${isAppPage && !dataRoute ? 'body' : 'html'}`\n+          `${normalizePagePath(route)}.${isAppPage && !dataRoute ? 'body' : 'html'}`\n         )\n \n         // we use the static 404 for notFound: true if available\n@@ -1268,7 +1270,7 @@ export async function handleBuildComplete({\n         if (dataRoute) {\n           let dataFilePath = path.join(\n             pagesDistDir,\n-            `${route === '/' ? 'index' : route}.json`\n+            `${normalizePagePath(route)}.json`\n           )\n \n           if (isAppPage) {\n@@ -1593,16 +1595,18 @@ export async function handleBuildComplete({\n           prefixRouteKeys: true,\n           includeSuffix: true,\n         })\n+        const isDataRoute = dataRoutePages.has(page)\n+\n         const destination = path.posix.join(\n           '/',\n           config.basePath,\n-          ...(dataRoutePages.has(page) ? [`_next/data`, buildId] : ''),\n+          ...(isDataRoute ? [`_next/data`, buildId] : ''),\n           ...(page === '/'\n             ? [shouldLocalize ? '$nextLocale.json' : 'index.json']\n             : [\n                 shouldLocalize ? '$nextLocale' : '',\n                 page +\n-                  '.json' +\n+                  (isDataRoute ? '.json' : '') +\n                   getDestinationQuery(routeRegex.routeKeys || {}),\n               ])\n         )"
        },
        {
            "sha": "cbb52730512049ca69facf4f6f3bcae9398a0753",
            "filename": "test/production/adapter-config/adapter-config.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/28a14da5010ad3147a06abbabc99a119d009f733/test%2Fproduction%2Fadapter-config%2Fadapter-config.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/28a14da5010ad3147a06abbabc99a119d009f733/test%2Fproduction%2Fadapter-config%2Fadapter-config.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fadapter-config%2Fadapter-config.test.ts?ref=28a14da5010ad3147a06abbabc99a119d009f733",
            "patch": "@@ -99,6 +99,8 @@ describe('adapter-config', () => {\n       } else {\n         expect(output.pathname).toStartWith('/docs/_next/static')\n       }\n+      // ensure / -> /index normalizing is correct\n+      expect(output.pathname.includes('/.')).toBe(false)\n \n       const stats = await fs.promises.stat(output.filePath)\n       expect(stats.isFile()).toBe(true)\n@@ -118,18 +120,35 @@ describe('adapter-config', () => {\n         expect(typeof prerenderOutput.config.bypassToken).toBe('string')\n         expect(Array.isArray(prerenderOutput.config.allowHeader)).toBe(true)\n         expect(Array.isArray(prerenderOutput.config.allowQuery)).toBe(true)\n+        // ensure / -> /index normalizing is correct\n+        expect(prerenderOutput.pathname.includes('/.')).toBe(false)\n       } catch (err) {\n         require('console').error(`invalid prerender ${prerenderOutput.id}`, err)\n         throw err\n       }\n     }\n \n+    const indexPrerender = prerenderOutputs.find(\n+      (item) => item.pathname === '/docs'\n+    )\n+\n+    expect(indexPrerender?.fallback?.initialHeaders).toEqual({\n+      'content-type': 'text/html; charset=utf-8',\n+      vary: 'rsc, next-router-state-tree, next-router-prefetch, next-router-segment-prefetch',\n+      'x-next-cache-tags': '_N_T_/layout,_N_T_/page,_N_T_/,_N_T_/index',\n+      'x-nextjs-prerender': '1',\n+      'x-nextjs-stale-time': '300',\n+    })\n+    expect(indexPrerender?.fallback?.initialRevalidate).toBe(false)\n+\n     for (const route of nodeOutputs) {\n       try {\n         expect(route.id).toBeString()\n         expect(route.config).toBeObject()\n         expect(route.pathname).toBeString()\n         expect(route.runtime).toBe('nodejs')\n+        // ensure / -> /index normalizing is correct\n+        expect(route.pathname.includes('/.')).toBe(false)\n \n         const stats = await fs.promises.stat(route.filePath)\n         expect(stats.isFile()).toBe(true)\n@@ -154,6 +173,8 @@ describe('adapter-config', () => {\n         expect(route.id).toBeString()\n         expect(route.config).toBeObject()\n         expect(route.pathname).toBeString()\n+        // ensure / -> /index normalizing is correct\n+        expect(route.pathname.includes('/.')).toBe(false)\n         expect(route.runtime).toBe('edge')\n         expect(route.config.env).toEqual(\n           expect.objectContaining({"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 39,
        "deletions": 14
    }
}