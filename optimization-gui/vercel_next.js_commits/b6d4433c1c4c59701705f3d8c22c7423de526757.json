{
    "author": "ztanner",
    "message": "loader tree: add special segment name to virtual parallel route segments (#82383)\n\nWhen constructing the loader tree for parallel route segments, we inject\na `children` segment, which could contain things like slot level\nlayout/error/loading files. We want a way to distinguish between these\nvirtual segments that exist just for organizational purposes rather than\nrelying on `children`. This updates the loader tree construction code to\ngive these more unique names. In the future, we should see if we can\nremove the need for this virtual segment if there are no special files\nneeded at that segment of the tree.",
    "sha": "b6d4433c1c4c59701705f3d8c22c7423de526757",
    "files": [
        {
            "sha": "5949d5774fa563dbba1f4f6c7d11cb59a1cdbc04",
            "filename": "crates/next-core/src/app_structure.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/b6d4433c1c4c59701705f3d8c22c7423de526757/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b6d4433c1c4c59701705f3d8c22c7423de526757/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs?ref=b6d4433c1c4c59701705f3d8c22c7423de526757",
            "patch": "@@ -1054,7 +1054,7 @@ async fn directory_tree_to_loader_tree_internal(\n     let current_level_is_parallel_route = is_parallel_route(&directory_name);\n \n     if current_level_is_parallel_route {\n-        tree.segment = rcstr!(\"children\");\n+        tree.segment = rcstr!(\"__virtual_segment__\");\n     }\n \n     if let Some(page) = (app_path == for_app_path || app_path.is_catchall())\n@@ -1075,10 +1075,6 @@ async fn directory_tree_to_loader_tree_internal(\n                 global_metadata: global_metadata.to_resolved().await?,\n             },\n         );\n-\n-        if current_level_is_parallel_route {\n-            tree.segment = rcstr!(\"page$\");\n-        }\n     }\n \n     let mut duplicate = FxHashMap::default();"
        },
        {
            "sha": "21fa3ef174eaef3e7802821cf74832574b8b77bc",
            "filename": "packages/next/src/build/webpack/loaders/next-app-loader/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/b6d4433c1c4c59701705f3d8c22c7423de526757/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b6d4433c1c4c59701705f3d8c22c7423de526757/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts?ref=b6d4433c1c4c59701705f3d8c22c7423de526757",
            "patch": "@@ -77,7 +77,7 @@ const FILE_TYPES = {\n const GLOBAL_ERROR_FILE_TYPE = 'global-error'\n const GLOBAL_NOT_FOUND_FILE_TYPE = 'global-not-found'\n const PAGE_SEGMENT = 'page$'\n-const PARALLEL_CHILDREN_SEGMENT = 'children$'\n+const PARALLEL_VIRTUAL_SEGMENT = 'slot$'\n \n const defaultGlobalErrorPath =\n   'next/dist/client/components/builtin/global-error.js'\n@@ -275,7 +275,7 @@ async function createTreeCodeFromPath(\n \n       if (\n         normalizedParallelSegment !== PAGE_SEGMENT &&\n-        normalizedParallelSegment !== PARALLEL_CHILDREN_SEGMENT\n+        normalizedParallelSegment !== PARALLEL_VIRTUAL_SEGMENT\n       ) {\n         // If we don't have a page segment, nor a special $children marker, it means we need to traverse the next directory\n         // (ie, `normalizedParallelSegment` would correspond with the folder that contains the next level of pages/layout/etc)\n@@ -396,8 +396,8 @@ async function createTreeCodeFromPath(\n       // earlier logic (such as children$ and page$). These should never appear in the loader tree, and\n       // should instead be the corresponding segment keys (ie `__PAGE__`) or the `children` parallel route.\n       parallelSegmentKey =\n-        parallelSegmentKey === PARALLEL_CHILDREN_SEGMENT\n-          ? 'children'\n+        parallelSegmentKey === PARALLEL_VIRTUAL_SEGMENT\n+          ? '__virtual_segment__'\n           : parallelSegmentKey === PAGE_SEGMENT\n             ? PAGE_SEGMENT_KEY\n             : parallelSegmentKey\n@@ -624,7 +624,7 @@ const nextAppLoader: AppLoader = async function nextAppLoader() {\n           // If it was a parallel route but we weren't able to find the page segment (ie, maybe the page is nested further)\n           // we first insert a special marker to ensure that we still process layout/default/etc at the slot level prior to continuing\n           // on to the page segment.\n-          matched[rest[0]] = [PARALLEL_CHILDREN_SEGMENT, ...rest.slice(1)]\n+          matched[rest[0]] = [PARALLEL_VIRTUAL_SEGMENT, ...rest.slice(1)]\n           continue\n         }\n "
        }
    ],
    "stats": {
        "total": 16,
        "additions": 6,
        "deletions": 10
    }
}