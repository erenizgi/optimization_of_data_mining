{
    "author": "eps1lon",
    "message": "[test] Deflake `use-cache-router-handler-only` in deploy tests (#86678)",
    "sha": "53ab225ca205f7e7acd0ec94e58a0fb057731290",
    "files": [
        {
            "sha": "e9a642169c8cabcc6a52d13ffad3627aa19edcda",
            "filename": "test/e2e/app-dir/use-cache-route-handler-only/use-cache-route-handler-only.test.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/53ab225ca205f7e7acd0ec94e58a0fb057731290/test%2Fe2e%2Fapp-dir%2Fuse-cache-route-handler-only%2Fuse-cache-route-handler-only.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/53ab225ca205f7e7acd0ec94e58a0fb057731290/test%2Fe2e%2Fapp-dir%2Fuse-cache-route-handler-only%2Fuse-cache-route-handler-only.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-route-handler-only%2Fuse-cache-route-handler-only.test.ts?ref=53ab225ca205f7e7acd0ec94e58a0fb057731290",
            "patch": "@@ -1,9 +1,10 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n \n // Explicitly don't mix route handlers with pages in this test app, to make sure\n // that this also works in isolation.\n describe('use-cache-route-handler-only', () => {\n-  const { next } = nextTestSetup({\n+  const { next, isNextDeploy } = nextTestSetup({\n     files: __dirname,\n   })\n \n@@ -18,14 +19,20 @@ describe('use-cache-route-handler-only', () => {\n     const response1 = await next.fetch('/node')\n     const { date1: date1a } = await response1.json()\n \n-    // Revalidate the prerendered response.\n-    await next.fetch('/revalidate', { method: 'POST' })\n+    const attemptOnce: typeof retry = async (fn) => fn()\n+    const retryIfDeployed = isNextDeploy ? retry : attemptOnce\n \n-    // Fetch the response again. This should trigger a blocking revalidation.\n-    const response2 = await next.fetch('/node')\n-    expect(response2.status).toBe(200)\n+    // Revalidation on Vercel isn't instant.\n+    await retryIfDeployed(async () => {\n+      // Revalidate the prerendered response.\n+      await next.fetch('/revalidate', { method: 'POST' })\n \n-    const { date1: date1b } = await response2.json()\n-    expect(date1a).not.toBe(date1b)\n+      // Fetch the response again. This should trigger a blocking revalidation.\n+      const response2 = await next.fetch('/node')\n+      expect(response2.status).toBe(200)\n+\n+      const { date1: date1b } = await response2.json()\n+      expect(date1a).not.toBe(date1b)\n+    })\n   })\n })"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 15,
        "deletions": 8
    }
}