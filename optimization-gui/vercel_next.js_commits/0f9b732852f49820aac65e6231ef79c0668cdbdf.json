{
    "author": "ijjk",
    "message": "Fix relative same host redirects in node middleware (#88253)\n\nThis ensures we properly relativize URLs in node middleware when\ndeployed and local. Tests weren't catching this previously as none were\nasserting the raw Location header value due to node-fetch auto-resolving\nthe value.\n\nFixes: https://github.com/vercel/next.js/issues/87950\nCloses: NEXT-4826",
    "sha": "0f9b732852f49820aac65e6231ef79c0668cdbdf",
    "files": [
        {
            "sha": "a2a71ff53288d75e7c5b4811c0f9cd8c35748659",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/0f9b732852f49820aac65e6231ef79c0668cdbdf/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0f9b732852f49820aac65e6231ef79c0668cdbdf/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=0f9b732852f49820aac65e6231ef79c0668cdbdf",
            "patch": "@@ -455,7 +455,10 @@ export async function adapter(\n     if (!process.env.__NEXT_NO_MIDDLEWARE_URL_NORMALIZE) {\n       if (redirectURL.host === requestURL.host) {\n         redirectURL.buildId = buildId || redirectURL.buildId\n-        response.headers.set('Location', redirectURL.toString())\n+        response.headers.set(\n+          'Location',\n+          getRelativeURL(redirectURL, requestURL)\n+        )\n       }\n     }\n "
        },
        {
            "sha": "b16ae0134d9e993a5331e321727ecaff37ed57a9",
            "filename": "test/e2e/middleware-redirects/app/middleware.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0f9b732852f49820aac65e6231ef79c0668cdbdf/test%2Fe2e%2Fmiddleware-redirects%2Fapp%2Fmiddleware.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0f9b732852f49820aac65e6231ef79c0668cdbdf/test%2Fe2e%2Fmiddleware-redirects%2Fapp%2Fmiddleware.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-redirects%2Fapp%2Fmiddleware.js?ref=0f9b732852f49820aac65e6231ef79c0668cdbdf",
            "patch": "@@ -1,6 +1,6 @@\n import { NextResponse } from 'next/server'\n \n-export async function middleware(request) {\n+export default async function middleware(request) {\n   const url = request.nextUrl\n \n   // this is needed for tests to get the BUILD_ID"
        },
        {
            "sha": "a97a4b08e025665f7abdbcb7c51734e34823cb09",
            "filename": "test/e2e/middleware-redirects/test/index.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/0f9b732852f49820aac65e6231ef79c0668cdbdf/test%2Fe2e%2Fmiddleware-redirects%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0f9b732852f49820aac65e6231ef79c0668cdbdf/test%2Fe2e%2Fmiddleware-redirects%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-redirects%2Ftest%2Findex.test.ts?ref=0f9b732852f49820aac65e6231ef79c0668cdbdf",
            "patch": "@@ -15,7 +15,15 @@ describe('Middleware Redirect', () => {\n     next = await createNext({\n       files: {\n         pages: new FileRef(join(__dirname, '../app/pages')),\n-        'middleware.js': new FileRef(join(__dirname, '../app/middleware.js')),\n+        ...(process.env.TEST_NODE_MIDDLEWARE\n+          ? {\n+              'proxy.js': new FileRef(join(__dirname, '../app/middleware.js')),\n+            }\n+          : {\n+              'middleware.js': new FileRef(\n+                join(__dirname, '../app/middleware.js')\n+              ),\n+            }),\n         'next.config.js': new FileRef(join(__dirname, '../app/next.config.js')),\n       },\n     })\n@@ -39,6 +47,15 @@ describe('Middleware Redirect', () => {\n       )\n     })\n \n+    it('should have relative path for same host redirect', async () => {\n+      const res = await next.fetch('/to?pathname=/another', {\n+        // workaround for https://github.com/node-fetch/node-fetch/issues/417\n+        redirect: 'manual-dont-change' as any,\n+      })\n+      expect(res.status).toBe(302)\n+      expect(res.headers.get('Location')).toBe('/another')\n+    })\n+\n     it(`should redirect to data urls with data requests and internal redirects`, async () => {\n       const res = await fetchViaHTTP(\n         next.url,"
        },
        {
            "sha": "28fdbfc88b2ec7e7c52ac039168a46110246e385",
            "filename": "test/e2e/middleware-redirects/test/node-runtime.test.ts",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0f9b732852f49820aac65e6231ef79c0668cdbdf/test%2Fe2e%2Fmiddleware-redirects%2Ftest%2Fnode-runtime.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0f9b732852f49820aac65e6231ef79c0668cdbdf/test%2Fe2e%2Fmiddleware-redirects%2Ftest%2Fnode-runtime.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-redirects%2Ftest%2Fnode-runtime.test.ts?ref=0f9b732852f49820aac65e6231ef79c0668cdbdf",
            "patch": "@@ -0,0 +1,3 @@\n+process.env.TEST_NODE_MIDDLEWARE = 'true'\n+\n+require('./index.test')"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 26,
        "deletions": 3
    }
}