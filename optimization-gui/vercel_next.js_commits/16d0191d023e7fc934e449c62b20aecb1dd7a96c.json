{
    "author": "gnoff",
    "message": "[Cache Components] Allow unstable prefix for cacheLife and cacheTag (#84934)\n\nThese are now stable but to allow for graceful upgrading we still export\nunstable versions. The unstable version includes a once-warning that\nindicates you should upgrade to the stable name.",
    "sha": "16d0191d023e7fc934e449c62b20aecb1dd7a96c",
    "files": [
        {
            "sha": "6ec1058aa7537ec97a0b0c2c3ccdfbe4a1364c41",
            "filename": "crates/next-custom-transforms/src/transforms/react_server_components.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/16d0191d023e7fc934e449c62b20aecb1dd7a96c/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/16d0191d023e7fc934e449c62b20aecb1dd7a96c/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs?ref=16d0191d023e7fc934e449c62b20aecb1dd7a96c",
            "patch": "@@ -653,7 +653,9 @@ impl ReactServerComponentValidator {\n                         \"revalidateTag\",\n                         // \"unstable_cache\", // useless in client, but doesn't technically error\n                         \"cacheLife\",\n+                        \"unstable_cacheLife\",\n                         \"cacheTag\",\n+                        \"unstable_cacheTag\",\n                         // \"unstable_noStore\" // no-op in client, but allowed for legacy reasons\n                     ],\n                 ),"
        },
        {
            "sha": "e52839fc42a3648a674da431306171eb05c4792d",
            "filename": "packages/next/cache.d.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/16d0191d023e7fc934e449c62b20aecb1dd7a96c/packages%2Fnext%2Fcache.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/16d0191d023e7fc934e449c62b20aecb1dd7a96c/packages%2Fnext%2Fcache.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fcache.d.ts?ref=16d0191d023e7fc934e449c62b20aecb1dd7a96c",
            "patch": "@@ -9,7 +9,9 @@ export {\n \n export { unstable_noStore } from 'next/dist/server/web/spec-extension/unstable-no-store'\n \n-export { cacheTag } from 'next/dist/server/use-cache/cache-tag'\n+import { cacheTag } from 'next/dist/server/use-cache/cache-tag'\n+\n+export { cacheTag }\n \n /**\n  * Cache this `\"use cache\"` for a timespan defined by the `\"default\"` profile.\n@@ -147,3 +149,6 @@ export function cacheLife(profile: {\n    */\n   expire?: number\n }): void\n+\n+export const unstable_cacheLife: typeof cacheLife\n+export const unstable_cacheTag: typeof cacheTag"
        },
        {
            "sha": "d78dd4238f317ef639898850e74286a885c97721",
            "filename": "packages/next/cache.js",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/16d0191d023e7fc934e449c62b20aecb1dd7a96c/packages%2Fnext%2Fcache.js",
            "raw_url": "https://github.com/vercel/next.js/raw/16d0191d023e7fc934e449c62b20aecb1dd7a96c/packages%2Fnext%2Fcache.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fcache.js?ref=16d0191d023e7fc934e449c62b20aecb1dd7a96c",
            "patch": "@@ -19,6 +19,33 @@ const cacheExports = {\n   cacheTag: require('next/dist/server/use-cache/cache-tag').cacheTag,\n }\n \n+let didWarnCacheLife = false\n+function unstable_cacheLife() {\n+  if (!didWarnCacheLife) {\n+    didWarnCacheLife = true\n+    const error = new Error(\n+      '`unstable_cacheLife` was recently stabilized and should be imported as `cacheLife`. The `unstable` prefixed form will be removed in a future version of Next.js.'\n+    )\n+    console.error(error)\n+  }\n+  return cacheExports.cacheLife.apply(this, arguments)\n+}\n+\n+let didWarnCacheTag = false\n+function unstable_cacheTag() {\n+  if (!didWarnCacheTag) {\n+    didWarnCacheTag = true\n+    const error = new Error(\n+      '`unstable_cacheTag` was recently stabilized and should be imported as `cacheTag`. The `unstable` prefixed form will be removed in a future version of Next.js.'\n+    )\n+    console.error(error)\n+  }\n+  return cacheExports.cacheTag.apply(this, arguments)\n+}\n+\n+cacheExports.unstable_cacheLife = unstable_cacheLife\n+cacheExports.unstable_cacheTag = unstable_cacheTag\n+\n // https://nodejs.org/api/esm.html#commonjs-namespaces\n // When importing CommonJS modules, the module.exports object is provided as the default export\n module.exports = cacheExports\n@@ -30,5 +57,7 @@ exports.revalidateTag = cacheExports.revalidateTag\n exports.updateTag = cacheExports.updateTag\n exports.unstable_noStore = cacheExports.unstable_noStore\n exports.cacheLife = cacheExports.cacheLife\n+exports.unstable_cacheLife = cacheExports.unstable_cacheLife\n exports.cacheTag = cacheExports.cacheTag\n+exports.unstable_cacheTag = cacheExports.unstable_cacheTag\n exports.refresh = cacheExports.refresh"
        },
        {
            "sha": "a300424a93a0e1e94fdd0c34e9645186e07803d4",
            "filename": "packages/next/src/build/webpack/plugins/next-types-plugin/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/16d0191d023e7fc934e449c62b20aecb1dd7a96c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/16d0191d023e7fc934e449c62b20aecb1dd7a96c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts?ref=16d0191d023e7fc934e449c62b20aecb1dd7a96c",
            "patch": "@@ -538,7 +538,11 @@ declare module 'next/cache' {\n \n   ${overloads}\n \n-  export { cacheTag } from 'next/dist/server/use-cache/cache-tag'\n+  import { cacheTag } from 'next/dist/server/use-cache/cache-tag'\n+  export { cacheTag }\n+\n+  export const unstable_cacheTag: typeof cacheTag\n+  export const unstable_cacheLife: typeof cacheLife\n }\n `\n }"
        },
        {
            "sha": "a3eeeb6e3f9dd84bab202c7f98c423cbf300f2ef",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-unstable-deprecations.test.ts",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-unstable-deprecations.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-unstable-deprecations.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-unstable-deprecations.test.ts?ref=16d0191d023e7fc934e449c62b20aecb1dd7a96c",
            "patch": "@@ -0,0 +1,40 @@\n+import { isNextDev, nextTestSetup } from 'e2e-utils'\n+\n+describe('Cache Components Errors', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname + '/fixtures/unstable-deprecations',\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  describe('Deprecating `unstable` prefix for `cacheLife` and `cacheTag`', () => {\n+    it('warns if you use `cacheLife` through `unstable_cacheLife`', async () => {\n+      if (isNextDev) {\n+        await next.browser('/life')\n+\n+        expect(next.cliOutput).toContain(\n+          'Error: `unstable_cacheLife` was recently stabilized'\n+        )\n+      } else {\n+        expect(next.cliOutput).toContain(\n+          'Error: `unstable_cacheLife` was recently stabilized'\n+        )\n+      }\n+    })\n+    it('warns if you use `cacheTag` through `unstable_cacheTag`', async () => {\n+      if (isNextDev) {\n+        await next.browser('/tag')\n+\n+        expect(next.cliOutput).toContain(\n+          'Error: `unstable_cacheTag` was recently stabilized'\n+        )\n+      } else {\n+        expect(next.cliOutput).toContain(\n+          'Error: `unstable_cacheTag` was recently stabilized'\n+        )\n+      }\n+    })\n+  })\n+})"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/unstable-deprecations/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fapp%2Flayout.tsx?ref=16d0191d023e7fc934e449c62b20aecb1dd7a96c",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "9f67d308b0ecef8f7a069bcc7be7ffed694b415a",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/unstable-deprecations/app/life/page.tsx",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fapp%2Flife%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fapp%2Flife%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fapp%2Flife%2Fpage.tsx?ref=16d0191d023e7fc934e449c62b20aecb1dd7a96c",
            "patch": "@@ -0,0 +1,37 @@\n+import { unstable_cacheLife, cacheLife } from 'next/cache'\n+\n+export default async function Page() {\n+  const stable = await stableLife()\n+  const unstable1 = await unstableLife1()\n+  const unstable2 = await unstableLife2()\n+  return (\n+    <>\n+      <div>\n+        This page calls a \"use cache\" function that uses the unstable_cacheLife\n+        API twice. We expect to see a warning once per server lifetime when\n+        using unstable_cacheLife.\n+      </div>\n+      <div>{stable}</div>\n+      <div>{unstable1}</div>\n+      <div>{unstable2}</div>\n+    </>\n+  )\n+}\n+\n+async function unstableLife1() {\n+  'use cache'\n+  unstable_cacheLife('minutes')\n+  return Math.random()\n+}\n+\n+async function unstableLife2() {\n+  'use cache'\n+  unstable_cacheLife('minutes')\n+  return Math.random()\n+}\n+\n+async function stableLife() {\n+  'use cache'\n+  cacheLife('minutes')\n+  return Math.random()\n+}"
        },
        {
            "sha": "10bd802d32b61ab107f45f9ed1823ad3fd7da14b",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/unstable-deprecations/app/tag/page.tsx",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fapp%2Ftag%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fapp%2Ftag%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fapp%2Ftag%2Fpage.tsx?ref=16d0191d023e7fc934e449c62b20aecb1dd7a96c",
            "patch": "@@ -0,0 +1,37 @@\n+import { unstable_cacheTag, cacheTag } from 'next/cache'\n+\n+export default async function Page() {\n+  const stable = await stableTag()\n+  const unstable1 = await unstableTag1()\n+  const unstable2 = await unstableTag2()\n+  return (\n+    <>\n+      <div>\n+        This page calls a \"use cache\" function that uses the unstable_cacheTag\n+        API twice. We expect to see a warning once per server lifetime when\n+        using unstable_cacheTag.\n+      </div>\n+      <div>{stable}</div>\n+      <div>{unstable1}</div>\n+      <div>{unstable2}</div>\n+    </>\n+  )\n+}\n+\n+async function unstableTag1() {\n+  'use cache'\n+  unstable_cacheTag('tag')\n+  return Math.random()\n+}\n+\n+async function unstableTag2() {\n+  'use cache'\n+  unstable_cacheTag('tag')\n+  return Math.random()\n+}\n+\n+async function stableTag() {\n+  'use cache'\n+  cacheTag('tag')\n+  return Math.random()\n+}"
        },
        {
            "sha": "30a826fdacc568ffb8cd6641fe15330a3c9d618d",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/unstable-deprecations/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fnext.config.js?ref=16d0191d023e7fc934e449c62b20aecb1dd7a96c",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    cacheComponents: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "7fdbc48695b20d6d47091c7da6b02c0f3e350318",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/unstable-deprecations/patch-console.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fpatch-console.js",
            "raw_url": "https://github.com/vercel/next.js/raw/16d0191d023e7fc934e449c62b20aecb1dd7a96c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fpatch-console.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Funstable-deprecations%2Fpatch-console.js?ref=16d0191d023e7fc934e449c62b20aecb1dd7a96c",
            "patch": "@@ -0,0 +1,12 @@\n+const originalLog = console.log.bind(console)\n+\n+console.log = (...args) => {\n+  new Date()\n+  Math.random()\n+  if (typeof args[0] === 'string') {\n+    const firstArg = '[<timestamp>] ' + args[0]\n+    originalLog(firstArg, ...args.slice(1))\n+  } else {\n+    originalLog('[<timestamp>] ', ...args)\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 189,
        "additions": 187,
        "deletions": 2
    }
}