{
    "author": "bgw",
    "message": "Turbopack: bincode: Migrate TaskInput serialization to bincode (#86631)\n\nhttps://github.com/vercel/next.js/pull/86338 switches cell storage to use bincode, but it uses a compatibility shim for storing `TaskInput`s using `serde` + `pot`. This PR completes the migration by switching `TaskInput` to use `bincode` as well.\n\n## Benchmark Summary\n\n`next build` is consistently faster across a variety of repositories when persistent caching is enabled, and the resulting cache size is consistently smaller.\n\n![Screenshot 2025-12-01 at 9.07.20 PM.png](https://app.graphite.com/user-attachments/assets/2e19f83a-5810-4c55-b67a-aa0dd1c5da22.png)\n\n`cargo build` runs only slightly faster, but there's potential for improving this further by removing unused `serde` macro derives.\n\n## Benchmarking Notes\n\nPerformance measurements (aside from cargo build) are taken using `next build`​. This should have proportional benefits for `next dev`​ too, but `next build`​ is more reproducible and easier to measure. `canary` refers to `a8f7b5467485647def4c0f4479a0a83bc4a3673a`.\n\nThese numbers are taken with persistent caching enabled with an empty cache, so it's the worst-case scenario for the serialization codepath. We don't care nearly as much about the performance of deserialization because it's less common.\n\n## `cargo build -p next-swc-napi`\n\nThis makes builds _slightly_ faster. This branch doesn't clean up the serde derives yet, so there's a bunch of unused macro expansion here, so I think this number is actually pretty good.\n\n```\n~/next.js $ hyperfine -w 1 -r 5 -p 'git co a8f7b5467485647def4c0f4479a0a83bc4a3673a && cargo clean' -p 'git co bgw/bincode-task-inputs && cargo clean' 'cargo build -p next-swc-napi' 'cargo build -p next-swc-napi'\nBenchmark 1: cargo build -p next-swc-napi\n  Time (mean ± σ):     237.476 s ±  1.420 s    [User: 2001.820 s, System: 84.957 s]\n  Range (min … max):   235.294 s … 238.862 s    5 runs\n\nBenchmark 2: cargo build -p next-swc-napi\n  Time (mean ± σ):     232.366 s ±  1.549 s    [User: 1945.355 s, System: 83.940 s]\n  Range (min … max):   230.550 s … 234.485 s    5 runs\n\nSummary\n  cargo build -p next-swc-napi ran\n    1.02 ± 0.01 times faster than cargo build -p next-swc-napi\n```\n\n## next-site\n\nUsing `~/front/apps/next-site` on macos with a M2 Pro. Nothing else was running on the machine.\n\n```\nhyperfine -p 'rm -rf .next' -w 2 -r 20 'TURBOPACK_PERSISTENT_CACHE=1 TURBO_ENGINE_IGNORE_DIRTY=1 pnpm next build --turbopack --experimental-build-mode=compile'\ndu -sh .next/cache/turbopack/\ndu -s .next/cache/turbopack/\n```\n\n#### Canary\n\n```\nBenchmark 1: TURBOPACK_PERSISTENT_CACHE=1 TURBO_ENGINE_IGNORE_DIRTY=1 pnpm next build --turbopack --experimental-build-mode=compile\n  Time (mean ± σ):     14.999 s ±  0.258 s    [User: 84.137 s, System: 8.683 s]\n  Range (min … max):   14.400 s … 15.509 s    20 runs\n```\n\n```\n855M    .next/cache/turbopack/\n1751640 .next/cache/turbopack/    (Note: macos measures size in 512B blocks)\n```\n\n#### This Branch\n\n```\nBenchmark 1: TURBOPACK_PERSISTENT_CACHE=1 TURBO_ENGINE_IGNORE_DIRTY=1 pnpm next build --turbopack --experimental-build-mode=compile\n  Time (mean ± σ):     14.106 s ±  0.255 s    [User: 79.976 s, System: 8.421 s]\n  Range (min … max):   13.829 s … 14.939 s    20 runs\n```\n\n```\n767M    .next/cache/turbopack/\n1571072 .next/cache/turbopack/    (Note: macos measures size in 512B blocks)\n```\n\n## vercel-site\n\nUsing `~/front/apps/vercel-site` on macos with a M2 Pro. Nothing else was running on the machine.\n\n```\nhyperfine -p 'rm -rf .next' -w 2 -r 20 'TURBOPACK_PERSISTENT_CACHE=1 TURBO_ENGINE_IGNORE_DIRTY=1 pnpm next build --turbopack --experimental-build-mode=compile'\ndu -sh .next/cache/turbopack/\ndu -s .next/cache/turbopack/\n```\n\n#### Canary\n\n```\nBenchmark 1: TURBOPACK_PERSISTENT_CACHE=1 TURBO_ENGINE_IGNORE_DIRTY=1 pnpm next build --turbopack --experimental-build-mode=compile\n  Time (mean ± σ):     93.274 s ±  1.630 s    [User: 671.120 s, System: 57.888 s]\n  Range (min … max):   91.111 s … 96.881 s    10 runs\n```\n\n```\n4.3G    .next/cache/turbopack/\n9002568 .next/cache/turbopack/    (Note: macos measures size in 512B blocks)\n```\n\n#### This Branch\n\n```\nBenchmark 1: TURBOPACK_PERSISTENT_CACHE=1 TURBO_ENGINE_IGNORE_DIRTY=1 pnpm next build --turbopack --experimental-build-mode=compile\n  Time (mean ± σ):     88.694 s ±  0.963 s    [User: 633.801 s, System: 54.576 s]\n  Range (min … max):   87.357 s … 90.037 s    10 runs\n```\n\n```\n3.7G    .next/cache/turbopack/\n7788472 .next/cache/turbopack/    (Note: macos measures size in 512B blocks)\n```\n\n## shadcn/ui\n\nUsing a low-noise Linux machine: https://github.com/bgw/benchmark-scripts/\n\n```\ndiff --git a/apps/v4/next.config.mjs b/apps/v4/next.config.mjs\nindex 7fa0f012..d1137d01 100644\n--- a/apps/v4/next.config.mjs\n+++ b/apps/v4/next.config.mjs\n@@ -27,6 +27,7 @@ const nextConfig = {\n   },\n   experimental: {\n     turbopackFileSystemCacheForDev: true,\n+    turbopackFileSystemCacheForBuild: true,\n   },\n   redirects() {\n     return [\n```\n\n```\ncd ~/shadcn-ui/apps/v4\nhyperfine -p 'rm -rf .next' -w 2 'pnpm next build --turbopack --experimental-build-mode=compile'\ndu -sh .next/cache/turbopack/\ndu -s .next/cache/turbopack/\n```\n\n#### Canary\n\n```\nBenchmark 1: pnpm next build --turbopack --experimental-build-mode=compile\n  Time (mean ± σ):     62.772 s ±  0.939 s    [User: 163.153 s, System: 11.170 s]\n  Range (min … max):   60.739 s … 64.220 s    10 runs\n```\n\n```\n596M    .next/cache/turbopack/\n609636  .next/cache/turbopack/    (Note: Linux measures size in 1024B blocks)\n```\n\n#### This Branch\n\n```\nBenchmark 1: pnpm next build --turbopack --experimental-build-mode=compile\n  Time (mean ± σ):     59.017 s ±  1.014 s    [User: 151.359 s, System: 9.978 s]\n  Range (min … max):   57.124 s … 60.343 s    10 runs\n```\n\n```\n491M    .next/cache/turbopack/\n502240  .next/cache/turbopack/    (Note: Linux measures size in 1024B blocks)\n```",
    "sha": "85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
    "files": [
        {
            "sha": "5823ff9081cb8e440fc445e875877de7bd34d414",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -9238,7 +9238,6 @@ dependencies = [\n  \"turbo-tasks-macros\",\n  \"turbo-tasks-malloc\",\n  \"unsize\",\n- \"unty\",\n ]\n \n [[package]]\n@@ -9288,6 +9287,7 @@ dependencies = [\n  \"afl\",\n  \"anyhow\",\n  \"arbitrary\",\n+ \"bincode 2.0.1\",\n  \"libfuzzer-sys\",\n  \"once_cell\",\n  \"serde\",\n@@ -9426,6 +9426,7 @@ name = \"turbo-tasks-macros-tests\"\n version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n+ \"bincode 2.0.1\",\n  \"serde\",\n  \"tokio\",\n  \"trybuild\",\n@@ -9566,6 +9567,7 @@ name = \"turbopack-cli\"\n version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n+ \"bincode 2.0.1\",\n  \"clap\",\n  \"codspeed-criterion-compat\",\n  \"console-subscriber\","
        },
        {
            "sha": "69db45d689276587f2506426909bf7c64b1a64ed",
            "filename": "crates/next-api/src/operation.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-api%2Fsrc%2Foperation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-api%2Fsrc%2Foperation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Foperation.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -123,6 +123,8 @@ fn pick_route(entrypoints: OperationVc<Entrypoints>, key: RcStr, route: &Route)\n     ValueDebugFormat,\n     NonLocalValue,\n     OperationValue,\n+    Encode,\n+    Decode,\n )]\n enum EndpointSelector {\n     RoutePageHtml(RcStr),"
        },
        {
            "sha": "b22e209135faa600785afa7dd21a1f80618a2fe6",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 24,
            "deletions": 2,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -612,7 +612,18 @@ enum PageEndpointType {\n }\n \n #[derive(\n-    Copy, Clone, Serialize, Deserialize, PartialEq, Eq, Hash, Debug, TaskInput, TraceRawVcs,\n+    Copy,\n+    Clone,\n+    Serialize,\n+    Deserialize,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    Debug,\n+    TaskInput,\n+    TraceRawVcs,\n+    Encode,\n+    Decode,\n )]\n enum SsrChunkType {\n     Page,\n@@ -621,7 +632,18 @@ enum SsrChunkType {\n }\n \n #[derive(\n-    Copy, Clone, Debug, PartialEq, Eq, Hash, Serialize, Deserialize, TaskInput, TraceRawVcs,\n+    Copy,\n+    Clone,\n+    Debug,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    Serialize,\n+    Deserialize,\n+    TaskInput,\n+    TraceRawVcs,\n+    Encode,\n+    Decode,\n )]\n enum EmitManifests {\n     /// Don't emit any manifests"
        },
        {
            "sha": "d686ee592944d113ebb9b25c1e52b88d572f8216",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -209,10 +209,6 @@ pub struct ProjectOptions {\n     pub current_node_js_version: RcStr,\n }\n \n-#[derive(\n-    Debug, Serialize, Deserialize, Clone, TaskInput, PartialEq, Eq, Hash, TraceRawVcs, NonLocalValue,\n-)]\n-#[serde(rename_all = \"camelCase\")]\n pub struct PartialProjectOptions {\n     /// A root path from which all files must be nested under. Trying to access\n     /// a file outside this root will fail. Think of this as a chroot."
        },
        {
            "sha": "22746215bc9b84dc9dc1a341f46a848ae5159558",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,6 +1,7 @@\n use std::collections::BTreeSet;\n \n use anyhow::Result;\n+use bincode::{Decode, Encode};\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, TaskInput, Vc, trace::TraceRawVcs};\n@@ -32,11 +33,13 @@ use turbopack_node::{\n };\n use turbopack_resolve::resolve_options_context::ResolveOptionsContext;\n \n-use super::transforms::get_next_client_transforms_rules;\n use crate::{\n     mode::NextMode,\n     next_build::get_postcss_package_mapping,\n-    next_client::runtime_entry::{RuntimeEntries, RuntimeEntry},\n+    next_client::{\n+        runtime_entry::{RuntimeEntries, RuntimeEntry},\n+        transforms::get_next_client_transforms_rules,\n+    },\n     next_config::NextConfig,\n     next_font::local::NextFontLocalResolvePlugin,\n     next_import_map::{\n@@ -405,7 +408,19 @@ pub async fn get_client_module_options_context(\n     Ok(module_options_context)\n }\n \n-#[derive(Clone, Debug, PartialEq, Eq, Hash, TaskInput, TraceRawVcs, Serialize, Deserialize)]\n+#[derive(\n+    Clone,\n+    Debug,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    TaskInput,\n+    TraceRawVcs,\n+    Serialize,\n+    Deserialize,\n+    Encode,\n+    Decode,\n+)]\n pub struct ClientChunkingContextOptions {\n     pub mode: Vc<NextMode>,\n     pub root_path: FileSystemPath,"
        },
        {
            "sha": "347dcf1924b09709abf504524363e6f908b98bea",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,4 +1,5 @@\n use anyhow::Result;\n+use bincode::{Decode, Encode};\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, TaskInput, Vc, trace::TraceRawVcs};\n@@ -196,7 +197,19 @@ pub async fn get_edge_resolve_options_context(\n     .cell())\n }\n \n-#[derive(Clone, Debug, PartialEq, Eq, Hash, TaskInput, TraceRawVcs, Serialize, Deserialize)]\n+#[derive(\n+    Clone,\n+    Debug,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    TaskInput,\n+    TraceRawVcs,\n+    Serialize,\n+    Deserialize,\n+    Encode,\n+    Decode,\n+)]\n pub struct EdgeChunkingContextOptions {\n     pub mode: Vc<NextMode>,\n     pub root_path: FileSystemPath,"
        },
        {
            "sha": "6cd37016a738f681b04a750c3cb542e4683f7673",
            "filename": "crates/next-core/src/next_root_params/mod.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-core%2Fsrc%2Fnext_root_params%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-core%2Fsrc%2Fnext_root_params%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_root_params%2Fmod.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -5,7 +5,7 @@ use either::Either;\n use indoc::formatdoc;\n use itertools::Itertools;\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{ResolvedVc, Vc};\n+use turbo_tasks::{EitherTaskInput, ResolvedVc, Vc};\n use turbo_tasks_fs::{FileContent, FileSystemPath};\n use turbopack_core::{\n     asset::AssetContent,\n@@ -36,17 +36,21 @@ pub async fn insert_next_root_params_mapping(\n ) -> Result<()> {\n     import_map.insert_exact_alias(\n         \"next/root-params\",\n-        get_next_root_params_mapping(is_root_params_enabled, ty, collected_root_params)\n-            .to_resolved()\n-            .await?,\n+        get_next_root_params_mapping(\n+            is_root_params_enabled,\n+            EitherTaskInput(ty),\n+            collected_root_params,\n+        )\n+        .to_resolved()\n+        .await?,\n     );\n     Ok(())\n }\n \n #[turbo_tasks::function]\n async fn get_next_root_params_mapping(\n     is_root_params_enabled: Vc<bool>,\n-    ty: Either<ServerContextType, ClientContextType>,\n+    ty: EitherTaskInput<ServerContextType, ClientContextType>,\n     collected_root_params: Option<Vc<CollectedRootParams>>,\n ) -> Result<Vc<ImportMapping>> {\n     // This mapping goes into the global resolve options, so we want to avoid invalidating it if\n@@ -77,12 +81,12 @@ impl NextRootParamsMapper {\n     #[turbo_tasks::function]\n     pub fn new(\n         is_root_params_enabled: ResolvedVc<bool>,\n-        context_type: Either<ServerContextType, ClientContextType>,\n+        context_type: EitherTaskInput<ServerContextType, ClientContextType>,\n         collected_root_params: Option<ResolvedVc<CollectedRootParams>>,\n     ) -> Vc<Self> {\n         NextRootParamsMapper {\n             is_root_params_enabled,\n-            context_type,\n+            context_type: context_type.0,\n             collected_root_params,\n         }\n         .cell()"
        },
        {
            "sha": "e5c677f5c004d0b28cf0294daf5db922cef6501e",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 6,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,6 +1,7 @@\n use std::collections::BTreeSet;\n \n use anyhow::{Result, bail};\n+use bincode::{Decode, Encode};\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, TaskInput, Vc, trace::TraceRawVcs};\n@@ -38,18 +39,17 @@ use turbopack_node::{\n use turbopack_nodejs::NodeJsChunkingContext;\n use turbopack_resolve::resolve_options_context::ResolveOptionsContext;\n \n-use super::{\n-    resolve::ExternalCjsModulesResolvePlugin,\n-    transforms::{get_next_server_internal_transforms_rules, get_next_server_transforms_rules},\n-};\n use crate::{\n     app_structure::CollectedRootParams,\n     mode::NextMode,\n     next_build::get_postcss_package_mapping,\n     next_config::NextConfig,\n     next_font::local::NextFontLocalResolvePlugin,\n     next_import_map::{get_next_edge_and_server_fallback_import_map, get_next_server_import_map},\n-    next_server::resolve::ExternalPredicate,\n+    next_server::{\n+        resolve::{ExternalCjsModulesResolvePlugin, ExternalPredicate},\n+        transforms::{get_next_server_internal_transforms_rules, get_next_server_transforms_rules},\n+    },\n     next_shared::{\n         resolve::{\n             ModuleFeatureReportResolvePlugin, NextExternalResolvePlugin,\n@@ -981,7 +981,19 @@ pub async fn get_server_module_options_context(\n     Ok(module_options_context)\n }\n \n-#[derive(Clone, Debug, PartialEq, Eq, Hash, TaskInput, TraceRawVcs, Serialize, Deserialize)]\n+#[derive(\n+    Clone,\n+    Debug,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    TaskInput,\n+    TraceRawVcs,\n+    Serialize,\n+    Deserialize,\n+    Encode,\n+    Decode,\n+)]\n pub struct ServerChunkingContextOptions {\n     pub mode: Vc<NextMode>,\n     pub root_path: FileSystemPath,"
        },
        {
            "sha": "2c42b87912dcabeb513867e6e4f56c167c802b9b",
            "filename": "crates/next-core/src/util.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Futil.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -59,7 +59,18 @@ pub fn defines(define_env: &FxIndexMap<RcStr, Option<RcStr>>) -> CompileTimeDefi\n }\n \n #[derive(\n-    Debug, Clone, Copy, PartialEq, Eq, Hash, TaskInput, Serialize, Deserialize, TraceRawVcs,\n+    Debug,\n+    Clone,\n+    Copy,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    TaskInput,\n+    Serialize,\n+    Deserialize,\n+    TraceRawVcs,\n+    Encode,\n+    Decode,\n )]\n pub enum PathType {\n     PagesPage,"
        },
        {
            "sha": "af6b399e8f59d7bce31f6ef3b07885dbf8b8f120",
            "filename": "turbopack/crates/turbo-bincode/src/lib.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-bincode%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-bincode%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-bincode%2Fsrc%2Flib.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,7 +1,7 @@\n #[doc(hidden)]\n pub mod macro_helpers;\n \n-use std::ptr::copy_nonoverlapping;\n+use std::{any::Any, ptr::copy_nonoverlapping};\n \n use ::smallvec::SmallVec;\n use bincode::{\n@@ -17,6 +17,8 @@ pub type TurboBincodeEncoder<'a> =\n     EncoderImpl<TurboBincodeWriter<'a>, bincode::config::Configuration>;\n pub type TurboBincodeDecoder<'a> =\n     DecoderImpl<TurboBincodeReader<'a>, bincode::config::Configuration, ()>;\n+pub type AnyEncodeFn = fn(&dyn Any, &mut TurboBincodeEncoder<'_>) -> Result<(), EncodeError>;\n+pub type AnyDecodeFn<T> = fn(&mut TurboBincodeDecoder<'_>) -> Result<T, DecodeError>;\n \n fn new_turbo_bincode_encoder(buf: &mut TurboBincodeBuffer) -> TurboBincodeEncoder<'_> {\n     EncoderImpl::new(TurboBincodeWriter::new(buf), TURBO_BINCODE_CONFIG)"
        },
        {
            "sha": "bdea8685817f77d6b46a1d0b133c32ef6827ea17",
            "filename": "turbopack/crates/turbo-tasks-backend/fuzz/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2FCargo.toml?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -11,6 +11,7 @@ cargo-fuzz = true\n afl = \"0.15.18\"\n anyhow = { workspace = true }\n arbitrary = { version = \"1.4.1\", features = [\"derive\"] }\n+bincode = { workspace = true }\n libfuzzer-sys = \"0.4.9\"\n once_cell = { workspace = true }\n serde = { workspace = true }"
        },
        {
            "sha": "d4f25897d920f8cc20e3addb3f3fe28584fe5e46",
            "filename": "turbopack/crates/turbo-tasks-backend/fuzz/src/graph.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fsrc%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fsrc%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fsrc%2Fgraph.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -2,6 +2,7 @@ use std::sync::Arc;\n \n use anyhow::Result;\n use arbitrary::Arbitrary;\n+use bincode::{Decode, Encode};\n use once_cell::sync::Lazy;\n use serde::{Deserialize, Serialize};\n use turbo_tasks::{self, NonLocalValue, State, TaskInput, TurboTasks, Vc, trace::TraceRawVcs};\n@@ -19,6 +20,8 @@ use turbo_tasks_malloc::TurboMalloc;\n     Deserialize,\n     TraceRawVcs,\n     TaskInput,\n+    Encode,\n+    Decode,\n )]\n pub struct TaskReferenceSpec {\n     task: u16,\n@@ -39,6 +42,8 @@ pub struct TaskReferenceSpec {\n     Deserialize,\n     TraceRawVcs,\n     TaskInput,\n+    Encode,\n+    Decode,\n )]\n pub struct TaskSpec {\n     references: Vec<TaskReferenceSpec>,"
        },
        {
            "sha": "d8a2cfac4963b41fed8023e7385a21d5ea3d6dd5",
            "filename": "turbopack/crates/turbo-tasks-backend/src/kv_backing_storage.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -604,17 +604,6 @@ fn encode_task_type(\n     buffer: &mut TurboBincodeBuffer,\n     task_id: Option<TaskId>,\n ) -> Result<()> {\n-    // DO NOT REMOVE THE `inline(never)` ATTRIBUTE!\n-    // CachedTaskType's `Encode`/`Decode` implementations use `pot` internally for `TaskInput`s.\n-    // TODO: remove `serde` and `pot`, make `TaskInput: Encode + Decode`.\n-    //\n-    // `pot` uses the pointer address of `&'static str` to deduplicate Symbols.\n-    // If this function is inlined into multiple different callsites it might inline the Serialize\n-    // implementation too, which can pull a `&'static str` from another crate into this crate.\n-    // Since string deduplication between crates is not guaranteed, it can lead to behavior changes\n-    // due to the pointer addresses. This can lead to lookup path and store path creating different\n-    // serialization of the same task type, which breaks task cache lookups.\n-    #[inline(never)]\n     fn encode_once_into(\n         task_type: &CachedTaskType,\n         buffer: &mut TurboBincodeBuffer,"
        },
        {
            "sha": "24e3329b8b1d506e3f4ed9d3fa9c803d1ea484a1",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/trace_transient.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftrace_transient.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftrace_transient.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftrace_transient.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -2,7 +2,7 @@\n #![feature(arbitrary_self_types_pointers)]\n \n use anyhow::Result;\n-use serde::{Deserialize, Serialize};\n+use bincode::{Decode, Encode};\n use turbo_tasks::{NonLocalValue, ResolvedVc, TaskInput, Vc, trace::TraceRawVcs};\n use turbo_tasks_testing::{Registration, register, run_once_without_cache_check};\n \n@@ -62,9 +62,7 @@ async fn read_incorrect_task_input_operation(value: IncorrectTaskInput) -> Resul\n \n /// Has an intentionally incorrect `TaskInput` implementation, representing some code that the debug\n /// tracing might be particularly useful with.\n-#[derive(\n-    Copy, Clone, Debug, PartialEq, Eq, Hash, TraceRawVcs, Serialize, Deserialize, NonLocalValue,\n-)]\n+#[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, TraceRawVcs, Encode, Decode, NonLocalValue)]\n struct IncorrectTaskInput(ResolvedVc<u64>);\n \n impl TaskInput for IncorrectTaskInput {"
        },
        {
            "sha": "542a843c39bc26ca1c0bbc914567dadd1d083ba8",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/transient_collectible.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftransient_collectible.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftransient_collectible.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftransient_collectible.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,7 +1,7 @@\n #![feature(arbitrary_self_types)]\n #![feature(arbitrary_self_types_pointers)]\n \n-use serde::{Deserialize, Serialize};\n+use bincode::{Decode, Encode};\n use turbo_tasks::{NonLocalValue, ResolvedVc, TaskInput, trace::TraceRawVcs};\n use turbo_tasks_testing::{Registration, register, run_once_without_cache_check};\n \n@@ -30,9 +30,7 @@ fn emit_incorrect_task_input_operation(value: IncorrectTaskInput) {\n }\n \n /// Has an intentionally incorrect `TaskInput` implementation\n-#[derive(\n-    Copy, Clone, Debug, PartialEq, Eq, Hash, TraceRawVcs, Serialize, Deserialize, NonLocalValue,\n-)]\n+#[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, TraceRawVcs, Encode, Decode, NonLocalValue)]\n struct IncorrectTaskInput(ResolvedVc<U32Wrapper>);\n \n impl TaskInput for IncorrectTaskInput {"
        },
        {
            "sha": "ed6db780e27295946780897dcc6a3630ed076b36",
            "filename": "turbopack/crates/turbo-tasks-macros-tests/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2FCargo.toml?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -7,6 +7,7 @@ edition = \"2024\"\n \n [dev-dependencies]\n anyhow = { workspace = true }\n+bincode = { workspace = true }\n serde = { workspace = true }\n tokio = { workspace = true }\n trybuild = { version = \"1.0.104\" }"
        },
        {
            "sha": "d1f74e888a99875bae6274c8ad90970b47ea0752",
            "filename": "turbopack/crates/turbo-tasks-macros-tests/tests/task_input.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ftask_input.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ftask_input.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ftask_input.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -3,13 +3,13 @@\n //! macro and the `#[turbo_tasks::function]` macro.\n #![allow(clippy::needless_return)] // tokio macro-generated code doesn't respect this\n \n-use serde::{Deserialize, Serialize};\n+use bincode::{Decode, Encode};\n use turbo_tasks::{Completion, ReadRef, TaskInput, Vc, trace::TraceRawVcs};\n use turbo_tasks_testing::{Registration, register, run_once};\n \n static REGISTRATION: Registration = register!();\n \n-#[derive(Clone, TaskInput, Debug, PartialEq, Eq, Hash, Serialize, Deserialize, TraceRawVcs)]\n+#[derive(Clone, TaskInput, Debug, PartialEq, Eq, Hash, Encode, Decode, TraceRawVcs)]\n struct OneUnnamedField(u32);\n \n #[turbo_tasks::function]"
        },
        {
            "sha": "5697a6b28b5753a96147b595946a0708fa8dfbe6",
            "filename": "turbopack/crates/turbo-tasks/Cargo.toml",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -56,7 +56,6 @@ turbo-tasks-hash = { workspace = true }\n turbo-tasks-macros = { workspace = true }\n turbo-tasks-malloc = { workspace = true }\n unsize = { workspace = true }\n-unty = { workspace = true }\n pot = \"3.0.0\"\n \n [dev-dependencies]"
        },
        {
            "sha": "a43300a7e7e4a84736e7885e0bad29de960e3db9",
            "filename": "turbopack/crates/turbo-tasks/src/backend.rs",
            "status": "modified",
            "additions": 37,
            "deletions": 121,
            "changes": 158,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -13,10 +13,14 @@ use auto_hash_map::AutoMap;\n use bincode::{\n     Decode, Encode,\n     error::{DecodeError, EncodeError},\n+    impl_borrow_decode,\n };\n use rustc_hash::FxHasher;\n use tracing::Span;\n-use turbo_bincode::{TurboBincodeDecoder, TurboBincodeEncoder};\n+use turbo_bincode::{\n+    TurboBincodeDecode, TurboBincodeDecoder, TurboBincodeEncode, TurboBincodeEncoder,\n+    impl_decode_for_turbo_bincode_decode, impl_encode_for_turbo_bincode_encode,\n+};\n use turbo_rcstr::RcStr;\n \n use crate::{\n@@ -77,6 +81,38 @@ impl CachedTaskType {\n     }\n }\n \n+impl TurboBincodeEncode for CachedTaskType {\n+    fn encode(&self, encoder: &mut TurboBincodeEncoder) -> Result<(), EncodeError> {\n+        Encode::encode(&registry::get_function_id(self.native_fn), encoder)?;\n+\n+        let (encode_arg_any, _) = self.native_fn.arg_meta.bincode;\n+        Encode::encode(&self.this, encoder)?;\n+        encode_arg_any(&*self.arg, encoder)?;\n+\n+        Ok(())\n+    }\n+}\n+\n+impl<Context> TurboBincodeDecode<Context> for CachedTaskType {\n+    fn decode(decoder: &mut TurboBincodeDecoder) -> Result<Self, DecodeError> {\n+        let native_fn = registry::get_native_function(Decode::decode(decoder)?);\n+\n+        let (_, decode_arg_any) = native_fn.arg_meta.bincode;\n+        let this = Decode::decode(decoder)?;\n+        let arg = decode_arg_any(decoder)?;\n+\n+        Ok(Self {\n+            native_fn,\n+            this,\n+            arg,\n+        })\n+    }\n+}\n+\n+impl_encode_for_turbo_bincode_encode!(CachedTaskType);\n+impl_decode_for_turbo_bincode_decode!(CachedTaskType);\n+impl_borrow_decode!(CachedTaskType);\n+\n // Manual implementation is needed because of a borrow issue with `Box<dyn Trait>`:\n // https://github.com/rust-lang/rust/issues/31740\n impl PartialEq for CachedTaskType {\n@@ -102,126 +138,6 @@ impl Display for CachedTaskType {\n     }\n }\n \n-mod ser {\n-    use bincode::{\n-        de::{Decoder, read::Reader},\n-        enc::Encoder,\n-    };\n-    use serde::{Deserialize, Deserializer, Serialize, Serializer, ser::SerializeSeq};\n-\n-    use super::*;\n-\n-    const POT_CONFIG: pot::Config = pot::Config::new().compatibility(pot::Compatibility::V4);\n-\n-    struct FunctionAndArgBorrowed<'a> {\n-        native_fn: &'static NativeFunction,\n-        arg: &'a dyn MagicAny,\n-    }\n-    struct FunctionAndArgOwned {\n-        native_fn: &'static NativeFunction,\n-        arg: Box<dyn MagicAny>,\n-    }\n-\n-    impl Serialize for FunctionAndArgBorrowed<'_> {\n-        fn serialize<S>(&self, serializer: S) -> Result<S::Ok, S::Error>\n-        where\n-            S: Serializer,\n-        {\n-            let Self { native_fn, arg } = self;\n-            let mut state = serializer.serialize_seq(Some(2))?;\n-            state.serialize_element(&registry::get_function_id(native_fn))?;\n-            let arg = *arg;\n-            let arg = native_fn.arg_meta.as_serialize(arg);\n-            state.serialize_element(arg)?;\n-            state.end()\n-        }\n-    }\n-\n-    impl<'de> Deserialize<'de> for FunctionAndArgOwned {\n-        fn deserialize<D: Deserializer<'de>>(deserializer: D) -> Result<Self, D::Error> {\n-            struct Visitor;\n-            impl<'de> serde::de::Visitor<'de> for Visitor {\n-                type Value = FunctionAndArgOwned;\n-\n-                fn expecting(&self, formatter: &mut fmt::Formatter) -> fmt::Result {\n-                    write!(formatter, \"a valid FunctionAndArgOwned\")\n-                }\n-\n-                fn visit_seq<A>(self, mut seq: A) -> Result<Self::Value, A::Error>\n-                where\n-                    A: serde::de::SeqAccess<'de>,\n-                {\n-                    let fn_id = seq\n-                        .next_element()?\n-                        .ok_or_else(|| serde::de::Error::invalid_length(0, &self))?;\n-                    let native_fn = registry::get_native_function(fn_id);\n-                    let seed = native_fn.arg_meta.deserialization_seed();\n-                    let arg = seq\n-                        .next_element_seed(seed)?\n-                        .ok_or_else(|| serde::de::Error::invalid_length(1, &self))?;\n-                    Ok(FunctionAndArgOwned { native_fn, arg })\n-                }\n-            }\n-            deserializer.deserialize_seq(Visitor)\n-        }\n-    }\n-\n-    // HACK: We don't yet require `TaskInput: Encode + Decode`, so use a pot serializer for the\n-    // function arguments, and bincode for everything else.\n-    impl Encode for CachedTaskType {\n-        fn encode<E: Encoder>(&self, encoder: &mut E) -> Result<(), EncodeError> {\n-            struct BincodeWriterWrapper<W: bincode::enc::write::Writer>(W);\n-            impl<W: bincode::enc::write::Writer> std::io::Write for BincodeWriterWrapper<W> {\n-                fn write(&mut self, buf: &[u8]) -> std::io::Result<usize> {\n-                    self.write_all(buf)?;\n-                    Ok(buf.len())\n-                }\n-                fn write_all(&mut self, buf: &[u8]) -> std::io::Result<()> {\n-                    self.0.write(buf).map_err(std::io::Error::other)\n-                }\n-                fn flush(&mut self) -> std::io::Result<()> {\n-                    Ok(())\n-                }\n-            }\n-            let function_and_arg = FunctionAndArgBorrowed {\n-                native_fn: self.native_fn,\n-                arg: &*self.arg,\n-            };\n-            POT_CONFIG\n-                .serialize_into(\n-                    &function_and_arg,\n-                    &mut BincodeWriterWrapper(encoder.writer()),\n-                )\n-                .map_err(|e| EncodeError::OtherString(e.to_string()))?;\n-            Encode::encode(&self.this, encoder)\n-        }\n-    }\n-\n-    impl<Context> Decode<Context> for CachedTaskType {\n-        fn decode<D: Decoder<Context = Context>>(decoder: &mut D) -> Result<Self, DecodeError> {\n-            struct BincodeReaderWrapper<R: Reader>(R);\n-            impl<R: Reader> std::io::Read for BincodeReaderWrapper<R> {\n-                fn read(&mut self, buf: &mut [u8]) -> std::io::Result<usize> {\n-                    self.read_exact(buf)?;\n-                    Ok(buf.len())\n-                }\n-                fn read_exact(&mut self, buf: &mut [u8]) -> std::io::Result<()> {\n-                    self.0.read(buf).map_err(std::io::Error::other)\n-                }\n-            }\n-            let FunctionAndArgOwned { native_fn, arg } = POT_CONFIG\n-                .deserialize_from(BincodeReaderWrapper(decoder.reader()))\n-                .map_err(|e| DecodeError::OtherString(e.to_string()))?;\n-            let this: Option<RawVc> = Decode::decode(decoder)?;\n-            Ok(CachedTaskType {\n-                native_fn,\n-                this,\n-                arg,\n-            })\n-        }\n-    }\n-}\n-\n pub struct TaskExecutionSpec<'a> {\n     pub future: Pin<Box<dyn Future<Output = Result<RawVc>> + Send + 'a>>,\n     pub span: Span,"
        },
        {
            "sha": "62fc4f773e25c603e5a70e8da9e89e4771488630",
            "filename": "turbopack/crates/turbo-tasks/src/lib.rs",
            "status": "modified",
            "additions": 42,
            "deletions": 37,
            "changes": 79,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -91,46 +91,51 @@ use std::hash::BuildHasherDefault;\n \n pub use anyhow::{Error, Result};\n use auto_hash_map::AutoSet;\n-pub use capture_future::TurboTasksPanic;\n-pub use collectibles::CollectiblesSource;\n-pub use completion::{Completion, Completions};\n-pub use display::ValueToString;\n-pub use effect::{ApplyEffectsContext, Effects, apply_effects, effect, get_effects};\n-pub use id::{ExecutionId, LocalTaskId, TRANSIENT_TASK_BIT, TaskId, TraitTypeId, ValueTypeId};\n-pub use invalidation::{\n-    InvalidationReason, InvalidationReasonKind, InvalidationReasonSet, Invalidator, get_invalidator,\n-};\n-pub use join_iter_ext::{JoinIterExt, TryFlatJoinIterExt, TryJoinIterExt};\n-pub use key_value_pair::KeyValuePair;\n-pub use magic_any::MagicAny;\n-pub use manager::{\n-    CurrentCellRef, ReadConsistency, ReadTracking, TaskPersistence, TurboTasks, TurboTasksApi,\n-    TurboTasksBackendApi, TurboTasksCallApi, Unused, UpdateInfo, dynamic_call, emit, mark_finished,\n-    mark_root, mark_session_dependent, mark_stateful, prevent_gc, run, run_once,\n-    run_once_with_reason, trait_call, turbo_tasks, turbo_tasks_scope,\n-};\n-pub use output::OutputContent;\n-pub use raw_vc::{CellId, RawVc, ReadRawVcFuture, ResolveTypeError};\n-pub use read_options::{ReadCellOptions, ReadOutputOptions};\n-pub use read_ref::ReadRef;\n use rustc_hash::FxHasher;\n-pub use serialization_invalidation::SerializationInvalidator;\n pub use shrink_to_fit::ShrinkToFit;\n-pub use spawn::{\n-    JoinHandle, block_for_future, block_in_place, spawn, spawn_blocking, spawn_thread,\n-};\n-pub use state::{State, TransientState};\n-pub use task::{SharedReference, TypedSharedReference, task_input::TaskInput};\n-pub use task_execution_reason::TaskExecutionReason;\n-pub use trait_ref::{IntoTraitRef, TraitRef};\n pub use turbo_tasks_macros::{TaskInput, function, value_impl};\n-pub use value::{TransientInstance, TransientValue};\n-pub use value_type::{TraitMethod, TraitType, ValueType};\n-pub use vc::{\n-    Dynamic, NonLocalValue, OperationValue, OperationVc, OptionVcExt, ReadVcFuture, ResolvedVc,\n-    Upcast, UpcastStrict, ValueDefault, Vc, VcCast, VcCellCompareMode, VcCellNewMode,\n-    VcDefaultRead, VcRead, VcTransparentRead, VcValueTrait, VcValueTraitCast, VcValueType,\n-    VcValueTypeCast,\n+\n+pub use crate::{\n+    capture_future::TurboTasksPanic,\n+    collectibles::CollectiblesSource,\n+    completion::{Completion, Completions},\n+    display::ValueToString,\n+    effect::{ApplyEffectsContext, Effects, apply_effects, effect, get_effects},\n+    id::{ExecutionId, LocalTaskId, TRANSIENT_TASK_BIT, TaskId, TraitTypeId, ValueTypeId},\n+    invalidation::{\n+        InvalidationReason, InvalidationReasonKind, InvalidationReasonSet, Invalidator,\n+        get_invalidator,\n+    },\n+    join_iter_ext::{JoinIterExt, TryFlatJoinIterExt, TryJoinIterExt},\n+    key_value_pair::KeyValuePair,\n+    magic_any::MagicAny,\n+    manager::{\n+        CurrentCellRef, ReadConsistency, ReadTracking, TaskPersistence, TurboTasks, TurboTasksApi,\n+        TurboTasksBackendApi, TurboTasksCallApi, Unused, UpdateInfo, dynamic_call, emit,\n+        mark_finished, mark_root, mark_session_dependent, mark_stateful, prevent_gc, run, run_once,\n+        run_once_with_reason, trait_call, turbo_tasks, turbo_tasks_scope,\n+    },\n+    output::OutputContent,\n+    raw_vc::{CellId, RawVc, ReadRawVcFuture, ResolveTypeError},\n+    read_options::{ReadCellOptions, ReadOutputOptions},\n+    read_ref::ReadRef,\n+    serialization_invalidation::SerializationInvalidator,\n+    spawn::{JoinHandle, block_for_future, block_in_place, spawn, spawn_blocking, spawn_thread},\n+    state::{State, TransientState},\n+    task::{\n+        SharedReference, TypedSharedReference,\n+        task_input::{EitherTaskInput, TaskInput},\n+    },\n+    task_execution_reason::TaskExecutionReason,\n+    trait_ref::{IntoTraitRef, TraitRef},\n+    value::{TransientInstance, TransientValue},\n+    value_type::{TraitMethod, TraitType, ValueType},\n+    vc::{\n+        Dynamic, NonLocalValue, OperationValue, OperationVc, OptionVcExt, ReadVcFuture, ResolvedVc,\n+        Upcast, UpcastStrict, ValueDefault, Vc, VcCast, VcCellCompareMode, VcCellNewMode,\n+        VcDefaultRead, VcRead, VcTransparentRead, VcValueTrait, VcValueTraitCast, VcValueType,\n+        VcValueTypeCast,\n+    },\n };\n \n pub type SliceMap<K, V> = Box<[(K, V)]>;"
        },
        {
            "sha": "95e54a04c8fe69b49229e5cfaad8db8c82be237f",
            "filename": "turbopack/crates/turbo-tasks/src/magic_any.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 82,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,6 +1,9 @@\n-use std::{any::Any, fmt::Debug, hash::Hash};\n+use std::{\n+    any::{Any, type_name},\n+    fmt::Debug,\n+    hash::Hash,\n+};\n \n-use serde::{Deserialize, Serialize, de::DeserializeSeed};\n use turbo_dyn_eq_hash::{\n     DynEq, DynHash, impl_eq_for_dyn, impl_hash_for_dyn, impl_partial_eq_for_dyn,\n };\n@@ -26,85 +29,12 @@ impl_partial_eq_for_dyn!(dyn MagicAny);\n impl_eq_for_dyn!(dyn MagicAny);\n impl_hash_for_dyn!(dyn MagicAny);\n \n-impl dyn MagicAny {\n-    pub fn as_serialize<T: Debug + Eq + Hash + Serialize + Send + Sync + TraceRawVcs + 'static>(\n-        &self,\n-    ) -> &dyn erased_serde::Serialize {\n-        if let Some(r) = (self as &dyn Any).downcast_ref::<T>() {\n-            r\n-        } else {\n-            #[cfg(debug_assertions)]\n-            panic!(\n-                \"MagicAny::as_serializable broken: got {} but expected {}\",\n-                self.magic_type_name(),\n-                std::any::type_name::<T>(),\n-            );\n-            #[cfg(not(debug_assertions))]\n-            panic!(\"MagicAny::as_serializable bug\");\n-        }\n-    }\n-}\n-\n-type MagicAnySerializeFunctor = fn(&dyn MagicAny) -> &dyn erased_serde::Serialize;\n-\n-#[derive(Clone, Copy)]\n-pub struct MagicAnySerializeSeed {\n-    functor: MagicAnySerializeFunctor,\n-}\n-\n-impl MagicAnySerializeSeed {\n-    pub fn new<T: Debug + Eq + Hash + Serialize + Send + Sync + TraceRawVcs + 'static>() -> Self {\n-        fn serialize<T: Debug + Eq + Hash + Serialize + Send + Sync + TraceRawVcs + 'static>(\n-            value: &dyn MagicAny,\n-        ) -> &dyn erased_serde::Serialize {\n-            value.as_serialize::<T>()\n-        }\n-        Self {\n-            functor: serialize::<T>,\n-        }\n-    }\n-\n-    pub fn as_serialize<'a>(&self, value: &'a dyn MagicAny) -> &'a dyn erased_serde::Serialize {\n-        (self.functor)(value)\n-    }\n-}\n-\n-type MagicAnyDeserializeSeedFunctor =\n-    fn(&mut dyn erased_serde::Deserializer<'_>) -> Result<Box<dyn MagicAny>, erased_serde::Error>;\n-\n-#[derive(Clone, Copy)]\n-pub struct MagicAnyDeserializeSeed {\n-    functor: MagicAnyDeserializeSeedFunctor,\n-}\n-\n-impl MagicAnyDeserializeSeed {\n-    pub fn new<T>() -> Self\n-    where\n-        T: for<'de> Deserialize<'de> + Debug + Eq + Hash + Send + Sync + TraceRawVcs + 'static,\n-    {\n-        fn deserialize<T>(\n-            deserializer: &mut dyn erased_serde::Deserializer<'_>,\n-        ) -> Result<Box<dyn MagicAny>, erased_serde::Error>\n-        where\n-            T: for<'de> Deserialize<'de> + Debug + Eq + Hash + Send + Sync + TraceRawVcs + 'static,\n-        {\n-            let value: T = erased_serde::deserialize(deserializer)?;\n-            Ok(Box::new(value))\n-        }\n-        Self {\n-            functor: deserialize::<T>,\n-        }\n-    }\n-}\n-\n-impl<'de> DeserializeSeed<'de> for MagicAnyDeserializeSeed {\n-    type Value = Box<dyn MagicAny>;\n-\n-    fn deserialize<D>(self, deserializer: D) -> Result<Self::Value, D::Error>\n-    where\n-        D: serde::Deserializer<'de>,\n-    {\n-        let mut deserializer = <dyn erased_serde::Deserializer>::erase(deserializer);\n-        (self.functor)(&mut deserializer).map_err(serde::de::Error::custom)\n+pub fn any_as_encode<T: Any>(this: &dyn Any) -> &T {\n+    if let Some(enc) = this.downcast_ref::<T>() {\n+        return enc;\n     }\n+    unreachable!(\n+        \"any_as_encode::<{}> called with invalid type\",\n+        type_name::<T>()\n+    );\n }"
        },
        {
            "sha": "413b7315d0d694d0f9a49b0879c6434baef786de",
            "filename": "turbopack/crates/turbo-tasks/src/native_function.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 19,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,14 +1,15 @@\n use std::{any::Any, fmt::Debug, hash::Hash, pin::Pin};\n \n use anyhow::Result;\n+use bincode::{Decode, Encode};\n use futures::Future;\n use once_cell::sync::Lazy;\n-use serde::{Deserialize, Serialize};\n use tracing::Span;\n+use turbo_bincode::{AnyDecodeFn, AnyEncodeFn};\n \n use crate::{\n     RawVc, TaskExecutionReason, TaskInput, TaskPersistence,\n-    magic_any::{MagicAny, MagicAnyDeserializeSeed, MagicAnySerializeSeed},\n+    magic_any::{MagicAny, any_as_encode},\n     task::{\n         IntoTaskFn, TaskFn,\n         function::{IntoTaskFnWithThis, NativeTaskFuture},\n@@ -24,8 +25,8 @@ type FilterOwnedArgsFunctor = for<'a> fn(Box<dyn MagicAny>) -> Box<dyn MagicAny>\n type FilterAndResolveFunctor = ResolveFunctor;\n \n pub struct ArgMeta {\n-    serializer: MagicAnySerializeSeed,\n-    deserializer: MagicAnyDeserializeSeed,\n+    // TODO: This should be an `Option` with `None` for transient tasks. We can skip some codegen.\n+    pub bincode: (AnyEncodeFn, AnyDecodeFn<Box<dyn MagicAny>>),\n     is_resolved: IsResolvedFunctor,\n     resolve: ResolveFunctor,\n     /// Used for trait methods, filters out unused arguments.\n@@ -43,7 +44,7 @@ pub struct ArgMeta {\n impl ArgMeta {\n     pub fn new<T>() -> Self\n     where\n-        T: TaskInput + Serialize + for<'de> Deserialize<'de> + 'static,\n+        T: TaskInput + Encode + Decode<()> + 'static,\n     {\n         fn noop_filter_args(args: Box<dyn MagicAny>) -> Box<dyn MagicAny> {\n             args\n@@ -56,26 +57,26 @@ impl ArgMeta {\n         filter_and_resolve: FilterAndResolveFunctor,\n     ) -> Self\n     where\n-        T: TaskInput + Serialize + for<'de> Deserialize<'de> + 'static,\n+        T: TaskInput + Encode + Decode<()> + 'static,\n     {\n         Self {\n-            serializer: MagicAnySerializeSeed::new::<T>(),\n-            deserializer: MagicAnyDeserializeSeed::new::<T>(),\n+            bincode: (\n+                |this, enc| {\n+                    T::encode(any_as_encode::<T>(this), enc)?;\n+                    Ok(())\n+                },\n+                |dec| {\n+                    let val = T::decode(dec)?;\n+                    Ok(Box::new(val))\n+                },\n+            ),\n             is_resolved: |value| downcast_args_ref::<T>(value).is_resolved(),\n             resolve: resolve_functor_impl::<T>,\n             filter_owned,\n             filter_and_resolve,\n         }\n     }\n \n-    pub fn deserialization_seed(&self) -> MagicAnyDeserializeSeed {\n-        self.deserializer\n-    }\n-\n-    pub fn as_serialize<'a>(&self, value: &'a dyn MagicAny) -> &'a dyn erased_serde::Serialize {\n-        self.serializer.as_serialize(value)\n-    }\n-\n     pub fn is_resolved(&self, value: &dyn MagicAny) -> bool {\n         (self.is_resolved)(value)\n     }\n@@ -174,7 +175,7 @@ impl NativeFunction {\n         implementation: impl IntoTaskFn<Mode, Inputs>,\n     ) -> Self\n     where\n-        Inputs: TaskInput + Serialize + for<'de> Deserialize<'de> + 'static,\n+        Inputs: TaskInput + Encode + Decode<()> + 'static,\n     {\n         Self {\n             name,\n@@ -191,7 +192,7 @@ impl NativeFunction {\n         implementation: I,\n     ) -> Self\n     where\n-        Inputs: TaskInput + Serialize + for<'de> Deserialize<'de> + 'static,\n+        Inputs: TaskInput + Encode + Decode<()> + 'static,\n         I: IntoTaskFn<Mode, Inputs>,\n     {\n         Self {\n@@ -214,7 +215,7 @@ impl NativeFunction {\n     ) -> Self\n     where\n         This: Sync + Send + 'static,\n-        Inputs: TaskInput + Serialize + for<'de> Deserialize<'de> + 'static,\n+        Inputs: TaskInput + Encode + Decode<()> + 'static,\n         I: IntoTaskFnWithThis<Mode, This, Inputs>,\n     {\n         Self {"
        },
        {
            "sha": "0973989632efdaa45e93a07ccfa2e8d7d8bbdcf6",
            "filename": "turbopack/crates/turbo-tasks/src/task/shared_reference.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 74,
            "changes": 92,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Fshared_reference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Fshared_reference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Fshared_reference.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -8,13 +8,12 @@ use std::{\n use anyhow::Result;\n use bincode::{\n     Decode, Encode,\n-    de::Decoder,\n-    enc::Encoder,\n     error::{DecodeError, EncodeError},\n     impl_borrow_decode,\n };\n use turbo_bincode::{\n-    TurboBincodeDecoder, TurboBincodeEncoder, turbo_bincode_decode, turbo_bincode_encode,\n+    TurboBincodeDecode, TurboBincodeDecoder, TurboBincodeEncode, TurboBincodeEncoder,\n+    impl_decode_for_turbo_bincode_decode, impl_encode_for_turbo_bincode_encode,\n };\n use unsize::CoerceUnsize;\n \n@@ -64,99 +63,44 @@ impl TypedSharedReference {\n     pub fn into_untyped(self) -> SharedReference {\n         self.reference\n     }\n+}\n \n-    fn encode(&self, enc: &mut TurboBincodeEncoder) -> Result<(), EncodeError> {\n+impl TurboBincodeEncode for TypedSharedReference {\n+    fn encode(&self, encoder: &mut TurboBincodeEncoder) -> Result<(), EncodeError> {\n         let Self { type_id, reference } = self;\n         let value_type = registry::get_value_type(*type_id);\n         if let Some(bincode) = value_type.bincode {\n-            type_id.encode(enc)?;\n-            bincode.0(&*reference.0, enc)?;\n+            type_id.encode(encoder)?;\n+            bincode.0(&*reference.0, encoder)?;\n             Ok(())\n         } else {\n             Err(EncodeError::OtherString(format!(\n-                \"{:?} is not serializable\",\n+                \"{} is not encodable\",\n                 value_type.global_name\n             )))\n         }\n     }\n+}\n \n-    fn decode(dec: &mut TurboBincodeDecoder) -> Result<Self, DecodeError> {\n-        let type_id = ValueTypeId::decode(dec)?;\n+impl<Context> TurboBincodeDecode<Context> for TypedSharedReference {\n+    fn decode(decoder: &mut TurboBincodeDecoder) -> Result<Self, DecodeError> {\n+        let type_id = ValueTypeId::decode(decoder)?;\n         let value_type = registry::get_value_type(type_id);\n         if let Some(bincode) = value_type.bincode {\n-            let reference = bincode.1(dec)?;\n+            let reference = bincode.1(decoder)?;\n             Ok(Self { type_id, reference })\n         } else {\n             #[cold]\n-            fn not_deserializable(value_type: &ValueType) -> DecodeError {\n-                DecodeError::OtherString(format!(\"{value_type} is not deserializable\"))\n-            }\n-            Err(not_deserializable(value_type))\n-        }\n-    }\n-}\n-\n-impl Encode for TypedSharedReference {\n-    fn encode<'a, E: Encoder>(&self, encoder: &'a mut E) -> Result<(), EncodeError> {\n-        let maybe_turbo_encoder = if unty::type_equal::<E, TurboBincodeEncoder>() {\n-            // SAFETY: Transmute is safe because `&mut E` is `&mut TurboBincodeEncoder`:\n-            // - `unty::type_equal::<E, TurboBincodeEncoder>()` does not check lifetimes, but does\n-            //   check the type and layout, so we know those are correct.\n-            // - The transmuted encoder cannot escape this function, and we know that the lifetime\n-            //   of `'f` is at least as long as the function.\n-            // - Lifetimes don't change layout. This is not guaranteed, but if this assumption is\n-            //   broken, we'd have a different type id, `type_equal` would return `false` and we'd\n-            //   fall back to a slower codepath, and wouldn't violate memory safety.\n-            // - Two mutable references have the same layout and alignment when they reference\n-            //   exactly the same type.\n-            // - The explicit lifetime ('a) avoids creating an implitly unbounded lifetime.\n-            Ok(unsafe { std::mem::transmute::<&'a mut E, &'a mut TurboBincodeEncoder>(encoder) })\n-        } else {\n-            Err(encoder)\n-        };\n-        match maybe_turbo_encoder {\n-            Ok(turbo_encoder) => TypedSharedReference::encode(self, turbo_encoder),\n-            Err(generic_encoder) => {\n-                // The underlying `SharedReference` can only be serialized using\n-                // `TurboBincodeEncoder` because the encoder function pointer cannot take type\n-                // parameters. This is okay, because we expect any hot codepaths to use\n-                // `TurboBincodeEncoder`.\n-                //\n-                // Create a `TurboBincodeEncoder` and encode this as a nested byte array. We must\n-                // redundantly store a size here, otherwise we won't be able to determine what size\n-                // buffer to use for `TurboBincodeReader`.\n-                let buffer = turbo_bincode_encode(self)?;\n-                buffer.encode(generic_encoder)\n-            }\n-        }\n-    }\n-}\n-\n-impl<Context> Decode<Context> for TypedSharedReference {\n-    fn decode<'a, D: Decoder<Context = Context>>(decoder: &mut D) -> Result<Self, DecodeError> {\n-        let maybe_turbo_decoder = if unty::type_equal::<D, TurboBincodeDecoder>() {\n-            // SAFETY: See notes on the `Encode::encode` implementation above.\n-            Ok(unsafe { std::mem::transmute::<&mut D, &mut TurboBincodeDecoder<'a>>(decoder) })\n-        } else {\n-            Err(decoder)\n-        };\n-        match maybe_turbo_decoder {\n-            Ok(turbo_decoder) => TypedSharedReference::decode(turbo_decoder),\n-            Err(generic_decoder) => {\n-                // The underlying `SharedReference` can only be deserialized using\n-                // `TurboBincodeDecoder` because the decoder function pointer cannot take type\n-                // parameters. This is okay, because we expect any hot codepaths to use\n-                // `TurboBincodeDecoder`.\n-                //\n-                // Decode the nested byte array that was created during encoding, then use a\n-                // `TurboBincodeDecoder` to decode the contents.\n-                let buffer: Vec<u8> = Decode::decode(generic_decoder)?;\n-                turbo_bincode_decode(&buffer)\n+            fn not_decodable(value_type: &ValueType) -> DecodeError {\n+                DecodeError::OtherString(format!(\"{} is not decodable\", value_type.global_name))\n             }\n+            Err(not_decodable(value_type))\n         }\n     }\n }\n \n+impl_encode_for_turbo_bincode_encode!(TypedSharedReference);\n+impl_decode_for_turbo_bincode_decode!(TypedSharedReference);\n impl_borrow_decode!(TypedSharedReference);\n \n impl Deref for TypedSharedReference {"
        },
        {
            "sha": "1a466303d5abe457d9816a4b6680913a2027c11e",
            "filename": "turbopack/crates/turbo-tasks/src/task/task_input.rs",
            "status": "modified",
            "additions": 102,
            "deletions": 94,
            "changes": 196,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ftask_input.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ftask_input.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ftask_input.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -3,15 +3,24 @@ use std::{\n     fmt::Debug,\n     future::Future,\n     hash::Hash,\n+    ops::{Deref, DerefMut},\n     sync::Arc,\n     time::Duration,\n };\n \n use anyhow::Result;\n+use bincode::{\n+    Decode, Encode,\n+    de::Decoder,\n+    enc::Encoder,\n+    error::{DecodeError, EncodeError},\n+};\n use either::Either;\n-use serde::{Deserialize, Serialize};\n use turbo_rcstr::RcStr;\n \n+// This import is necessary for derive macros to work, as their expansion refers to the crate\n+// name directly.\n+use crate as turbo_tasks;\n use crate::{\n     MagicAny, ReadRef, ResolvedVc, TaskId, TransientInstance, TransientValue, ValueTypeId, Vc,\n     trace::TraceRawVcs,\n@@ -20,9 +29,14 @@ use crate::{\n /// Trait to implement in order for a type to be accepted as a\n /// [`#[turbo_tasks::function]`][crate::function] argument.\n ///\n-/// Serialization must be deterministic and compatible with `eq` comparisons.  If two `TaskInputs`\n-/// compare equal they must also serialize to the same bytes.\n-pub trait TaskInput: Send + Sync + Clone + Debug + PartialEq + Eq + Hash + TraceRawVcs {\n+/// Transient task inputs are required to implement [`Encode`] and [`Decode`], but are allowed to\n+/// panic at runtime. This requirement could be lifted in the future.\n+///\n+/// Bincode encoding must be deterministic and compatible with [`Eq`] comparisons. If two\n+/// `TaskInput`s compare equal they must also encode to the same bytes.\n+pub trait TaskInput:\n+    Send + Sync + Clone + Debug + PartialEq + Eq + Hash + TraceRawVcs + Encode + Decode<()>\n+{\n     fn resolve_input(&self) -> impl Future<Output = Result<Self>> + Send + '_ {\n         async { Ok(self.clone()) }\n     }\n@@ -205,31 +219,15 @@ where\n     }\n }\n \n-impl<T> Serialize for TransientValue<T>\n-where\n-    T: MagicAny + Clone + 'static,\n-{\n-    fn serialize<S>(&self, _serializer: S) -> Result<S::Ok, S::Error>\n-    where\n-        S: serde::Serializer,\n-    {\n-        Err(serde::ser::Error::custom(\n-            \"cannot serialize transient task inputs\",\n-        ))\n+impl<T> Encode for TransientValue<T> {\n+    fn encode<E: Encoder>(&self, _encoder: &mut E) -> Result<(), EncodeError> {\n+        Err(EncodeError::Other(\"cannot encode transient task inputs\"))\n     }\n }\n \n-impl<'de, T> Deserialize<'de> for TransientValue<T>\n-where\n-    T: MagicAny + Clone + 'static,\n-{\n-    fn deserialize<D>(_deserializer: D) -> Result<Self, D::Error>\n-    where\n-        D: serde::Deserializer<'de>,\n-    {\n-        Err(serde::de::Error::custom(\n-            \"cannot deserialize transient task inputs\",\n-        ))\n+impl<Context, T> Decode<Context> for TransientValue<T> {\n+    fn decode<D: Decoder<Context = Context>>(_decoder: &mut D) -> Result<Self, DecodeError> {\n+        Err(DecodeError::Other(\"cannot decode transient task inputs\"))\n     }\n }\n \n@@ -242,48 +240,15 @@ where\n     }\n }\n \n-impl<T> Serialize for TransientInstance<T> {\n-    fn serialize<S>(&self, _serializer: S) -> Result<S::Ok, S::Error>\n-    where\n-        S: serde::Serializer,\n-    {\n-        Err(serde::ser::Error::custom(\n-            \"cannot serialize transient task inputs\",\n-        ))\n+impl<T> Encode for TransientInstance<T> {\n+    fn encode<E: Encoder>(&self, _encoder: &mut E) -> Result<(), EncodeError> {\n+        Err(EncodeError::Other(\"cannot encode transient task inputs\"))\n     }\n }\n \n-impl<'de, T> Deserialize<'de> for TransientInstance<T> {\n-    fn deserialize<D>(_deserializer: D) -> Result<Self, D::Error>\n-    where\n-        D: serde::Deserializer<'de>,\n-    {\n-        Err(serde::de::Error::custom(\n-            \"cannot deserialize transient task inputs\",\n-        ))\n-    }\n-}\n-\n-impl<L, R> TaskInput for Either<L, R>\n-where\n-    L: TaskInput,\n-    R: TaskInput,\n-{\n-    fn resolve_input(&self) -> impl Future<Output = Result<Self>> + Send + '_ {\n-        self.as_ref().map_either(\n-            |l| async move { anyhow::Ok(Either::Left(l.resolve_input().await?)) },\n-            |r| async move { anyhow::Ok(Either::Right(r.resolve_input().await?)) },\n-        )\n-    }\n-\n-    fn is_resolved(&self) -> bool {\n-        self.as_ref()\n-            .either(TaskInput::is_resolved, TaskInput::is_resolved)\n-    }\n-\n-    fn is_transient(&self) -> bool {\n-        self.as_ref()\n-            .either(TaskInput::is_transient, TaskInput::is_transient)\n+impl<Context, T> Decode<Context> for TransientInstance<T> {\n+    fn decode<D: Decoder<Context = Context>>(_decoder: &mut D) -> Result<Self, DecodeError> {\n+        Err(DecodeError::Other(\"cannot decode transient task inputs\"))\n     }\n }\n \n@@ -335,6 +300,68 @@ where\n     }\n }\n \n+/// A thin wrapper around [`Either`] that implements the traits required by [`TaskInput`], notably\n+/// [`Encode`] and [`Decode`].\n+#[derive(Clone, Debug, PartialEq, Eq, Hash, TraceRawVcs)]\n+pub struct EitherTaskInput<L, R>(pub Either<L, R>);\n+\n+impl<L, R> Deref for EitherTaskInput<L, R> {\n+    type Target = Either<L, R>;\n+\n+    fn deref(&self) -> &Self::Target {\n+        &self.0\n+    }\n+}\n+\n+impl<L, R> DerefMut for EitherTaskInput<L, R> {\n+    fn deref_mut(&mut self) -> &mut Self::Target {\n+        &mut self.0\n+    }\n+}\n+\n+impl<L, R> Encode for EitherTaskInput<L, R>\n+where\n+    L: Encode,\n+    R: Encode,\n+{\n+    fn encode<E: Encoder>(&self, encoder: &mut E) -> Result<(), EncodeError> {\n+        turbo_bincode::either::encode(self, encoder)\n+    }\n+}\n+\n+impl<Context, L, R> Decode<Context> for EitherTaskInput<L, R>\n+where\n+    L: Decode<Context>,\n+    R: Decode<Context>,\n+{\n+    fn decode<D: Decoder<Context = Context>>(decoder: &mut D) -> Result<Self, DecodeError> {\n+        turbo_bincode::either::decode(decoder).map(Self)\n+    }\n+}\n+\n+impl<L, R> TaskInput for EitherTaskInput<L, R>\n+where\n+    L: TaskInput,\n+    R: TaskInput,\n+{\n+    fn resolve_input(&self) -> impl Future<Output = Result<Self>> + Send + '_ {\n+        self.as_ref().map_either(\n+            |l| async move { anyhow::Ok(Self(Either::Left(l.resolve_input().await?))) },\n+            |r| async move { anyhow::Ok(Self(Either::Right(r.resolve_input().await?))) },\n+        )\n+    }\n+\n+    fn is_resolved(&self) -> bool {\n+        self.as_ref()\n+            .either(TaskInput::is_resolved, TaskInput::is_resolved)\n+    }\n+\n+    fn is_transient(&self) -> bool {\n+        self.as_ref()\n+            .either(TaskInput::is_transient, TaskInput::is_transient)\n+    }\n+}\n+\n macro_rules! tuple_impls {\n     ( $( $name:ident )+ ) => {\n         impl<$($name: TaskInput),+> TaskInput for ($($name,)+)\n@@ -381,9 +408,6 @@ mod tests {\n     use turbo_tasks_macros::TaskInput;\n \n     use super::*;\n-    // This is necessary for the derive macro to work, as its expansion refers to\n-    // the crate name directly.\n-    use crate as turbo_tasks;\n \n     fn assert_task_input<T>(_: T)\n     where\n@@ -393,9 +417,7 @@ mod tests {\n \n     #[test]\n     fn test_no_fields() -> Result<()> {\n-        #[derive(\n-            Clone, TaskInput, Eq, PartialEq, Hash, Debug, Serialize, Deserialize, TraceRawVcs,\n-        )]\n+        #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Encode, Decode, TraceRawVcs)]\n         struct NoFields;\n \n         assert_task_input(NoFields);\n@@ -404,9 +426,7 @@ mod tests {\n \n     #[test]\n     fn test_one_unnamed_field() -> Result<()> {\n-        #[derive(\n-            Clone, TaskInput, Eq, PartialEq, Hash, Debug, Serialize, Deserialize, TraceRawVcs,\n-        )]\n+        #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Encode, Decode, TraceRawVcs)]\n         struct OneUnnamedField(u32);\n \n         assert_task_input(OneUnnamedField(42));\n@@ -415,9 +435,7 @@ mod tests {\n \n     #[test]\n     fn test_multiple_unnamed_fields() -> Result<()> {\n-        #[derive(\n-            Clone, TaskInput, Eq, PartialEq, Hash, Debug, Serialize, Deserialize, TraceRawVcs,\n-        )]\n+        #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Encode, Decode, TraceRawVcs)]\n         struct MultipleUnnamedFields(u32, RcStr);\n \n         assert_task_input(MultipleUnnamedFields(42, rcstr!(\"42\")));\n@@ -426,9 +444,7 @@ mod tests {\n \n     #[test]\n     fn test_one_named_field() -> Result<()> {\n-        #[derive(\n-            Clone, TaskInput, Eq, PartialEq, Hash, Debug, Serialize, Deserialize, TraceRawVcs,\n-        )]\n+        #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Encode, Decode, TraceRawVcs)]\n         struct OneNamedField {\n             named: u32,\n         }\n@@ -439,9 +455,7 @@ mod tests {\n \n     #[test]\n     fn test_multiple_named_fields() -> Result<()> {\n-        #[derive(\n-            Clone, TaskInput, Eq, PartialEq, Hash, Debug, Serialize, Deserialize, TraceRawVcs,\n-        )]\n+        #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Encode, Decode, TraceRawVcs)]\n         struct MultipleNamedFields {\n             named: u32,\n             other: RcStr,\n@@ -456,17 +470,15 @@ mod tests {\n \n     #[test]\n     fn test_generic_field() -> Result<()> {\n-        #[derive(\n-            Clone, TaskInput, Eq, PartialEq, Hash, Debug, Serialize, Deserialize, TraceRawVcs,\n-        )]\n+        #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Encode, Decode, TraceRawVcs)]\n         struct GenericField<T>(T);\n \n         assert_task_input(GenericField(42));\n         assert_task_input(GenericField(rcstr!(\"42\")));\n         Ok(())\n     }\n \n-    #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Serialize, Deserialize, TraceRawVcs)]\n+    #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Encode, Decode, TraceRawVcs)]\n     enum OneVariant {\n         Variant,\n     }\n@@ -479,9 +491,7 @@ mod tests {\n \n     #[test]\n     fn test_multiple_variants() -> Result<()> {\n-        #[derive(\n-            Clone, TaskInput, PartialEq, Eq, Hash, Debug, Serialize, Deserialize, TraceRawVcs,\n-        )]\n+        #[derive(Clone, TaskInput, PartialEq, Eq, Hash, Debug, Encode, Decode, TraceRawVcs)]\n         enum MultipleVariants {\n             Variant1,\n             Variant2,\n@@ -491,7 +501,7 @@ mod tests {\n         Ok(())\n     }\n \n-    #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Serialize, Deserialize, TraceRawVcs)]\n+    #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Encode, Decode, TraceRawVcs)]\n     enum MultipleVariantsAndHeterogeneousFields {\n         Variant1,\n         Variant2(u32),\n@@ -511,9 +521,7 @@ mod tests {\n \n     #[test]\n     fn test_nested_variants() -> Result<()> {\n-        #[derive(\n-            Clone, TaskInput, Eq, PartialEq, Hash, Debug, Serialize, Deserialize, TraceRawVcs,\n-        )]\n+        #[derive(Clone, TaskInput, Eq, PartialEq, Hash, Debug, Encode, Decode, TraceRawVcs)]\n         enum NestedVariants {\n             Variant1,\n             Variant2(MultipleVariantsAndHeterogeneousFields),"
        },
        {
            "sha": "66fc73c1f48759dc07c92711c73d4416093927e4",
            "filename": "turbopack/crates/turbo-tasks/src/value_type.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 23,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvalue_type.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvalue_type.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvalue_type.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,27 +1,21 @@\n use std::{\n-    any::{Any, type_name},\n     fmt::{self, Debug, Display, Formatter},\n     hash::Hash,\n };\n \n use auto_hash_map::{AutoMap, AutoSet};\n-use bincode::{\n-    Decode, Encode,\n-    error::{DecodeError, EncodeError},\n-};\n+use bincode::{Decode, Encode};\n use tracing::Span;\n-use turbo_bincode::{TurboBincodeDecoder, TurboBincodeEncoder};\n+use turbo_bincode::{AnyDecodeFn, AnyEncodeFn};\n \n use crate::{\n-    RawVc, SharedReference, VcValueType, id::TraitTypeId, macro_helpers::NativeFunction, registry,\n-    task::shared_reference::TypedSharedReference, vc::VcCellMode,\n+    RawVc, SharedReference, VcValueType, id::TraitTypeId, macro_helpers::NativeFunction,\n+    magic_any::any_as_encode, registry, task::shared_reference::TypedSharedReference,\n+    vc::VcCellMode,\n };\n \n type RawCellFactoryFn = fn(TypedSharedReference) -> RawVc;\n \n-type AnyEncodeFn = fn(&dyn Any, &mut TurboBincodeEncoder<'_>) -> Result<(), EncodeError>;\n-type AnyDecodeFn = fn(&mut TurboBincodeDecoder<'_>) -> Result<SharedReference, DecodeError>;\n-\n // TODO this type need some refactoring when multiple languages are added to\n // turbo-task In this case a trait_method might be of a different function type.\n // It probably need to be a Vc<Function>.\n@@ -42,7 +36,7 @@ pub struct ValueType {\n     trait_methods: AutoMap<&'static TraitMethod, &'static NativeFunction>,\n \n     /// Functions to convert to write the type to a buffer or read it from a buffer.\n-    pub bincode: Option<(AnyEncodeFn, AnyDecodeFn)>,\n+    pub bincode: Option<(AnyEncodeFn, AnyDecodeFn<SharedReference>)>,\n \n     /// An implementation of\n     /// [`VcCellMode::raw_cell`][crate::vc::VcCellMode::raw_cell].\n@@ -91,16 +85,6 @@ impl Display for ValueType {\n     }\n }\n \n-pub fn any_as_encode<T: Any>(this: &dyn Any) -> &T {\n-    if let Some(enc) = this.downcast_ref::<T>() {\n-        return enc;\n-    }\n-    unreachable!(\n-        \"any_as_encode::<{}> called with invalid type\",\n-        type_name::<T>()\n-    );\n-}\n-\n pub trait ManualEncodeWrapper: Encode {\n     type Value;\n \n@@ -171,7 +155,7 @@ impl ValueType {\n     // Helper for other constructor functions\n     fn new_inner<T: VcValueType>(\n         global_name: &'static str,\n-        bincode: Option<(AnyEncodeFn, AnyDecodeFn)>,\n+        bincode: Option<(AnyEncodeFn, AnyDecodeFn<SharedReference>)>,\n     ) -> Self {\n         Self {\n             name: std::any::type_name::<T>(),"
        },
        {
            "sha": "d86ef5f2155270779b4ab3f2082a1180a7583210",
            "filename": "turbopack/crates/turbopack-cli/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-cli%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-cli%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2FCargo.toml?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -38,6 +38,7 @@ workspace = true\n \n [dependencies]\n anyhow = { workspace = true }\n+bincode = { workspace = true }\n clap = { workspace = true, features = [\"derive\", \"env\"] }\n console-subscriber = { workspace = true, optional = true }\n dunce = { workspace = true }"
        },
        {
            "sha": "b3a2228192fdc8b7f7e61e6bd571cbf6b4e12da4",
            "filename": "turbopack/crates/turbopack-cli/src/arguments.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Farguments.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Farguments.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Farguments.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -5,6 +5,7 @@ use std::{\n };\n \n use anyhow::anyhow;\n+use bincode::{Decode, Encode};\n use clap::{Args, Parser, ValueEnum};\n use serde::{Deserialize, Serialize};\n use turbo_tasks::{NonLocalValue, TaskInput, trace::TraceRawVcs};\n@@ -48,6 +49,8 @@ impl Arguments {\n     TaskInput,\n     NonLocalValue,\n     TraceRawVcs,\n+    Encode,\n+    Decode,\n )]\n pub enum Target {\n     Browser,"
        },
        {
            "sha": "3219d566c66356e057301191cd421ae27977ac6f",
            "filename": "turbopack/crates/turbopack-cli/src/util.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Futil.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,14 +1,26 @@\n use std::{env::current_dir, path::PathBuf};\n \n use anyhow::{Context, Result};\n+use bincode::{Decode, Encode};\n use dunce::canonicalize;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{NonLocalValue, TaskInput, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n \n #[derive(\n-    Clone, Debug, TaskInput, Hash, PartialEq, Eq, NonLocalValue, Serialize, Deserialize, TraceRawVcs,\n+    Clone,\n+    Debug,\n+    TaskInput,\n+    Hash,\n+    PartialEq,\n+    Eq,\n+    NonLocalValue,\n+    Serialize,\n+    Deserialize,\n+    TraceRawVcs,\n+    Encode,\n+    Decode,\n )]\n pub enum EntryRequest {\n     Relative(RcStr),"
        },
        {
            "sha": "ce5f068fd5632dd3b911d619938bcec437a521ed",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/style_groups.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fstyle_groups.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fstyle_groups.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fstyle_groups.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,6 +1,7 @@\n use std::cmp::Reverse;\n \n use anyhow::Result;\n+use bincode::{Decode, Encode};\n use indexmap::map::Entry;\n use rustc_hash::{FxHashMap, FxHashSet};\n use serde::{Deserialize, Serialize};\n@@ -23,7 +24,18 @@ use crate::{\n };\n \n #[derive(\n-    TaskInput, Debug, Clone, PartialEq, Eq, Hash, Serialize, Deserialize, NonLocalValue, TraceRawVcs,\n+    TaskInput,\n+    Debug,\n+    Clone,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    Serialize,\n+    Deserialize,\n+    NonLocalValue,\n+    TraceRawVcs,\n+    Encode,\n+    Decode,\n )]\n pub struct StyleGroupsConfig {\n     pub max_chunk_size: usize,"
        },
        {
            "sha": "311cfcebdf10a0c81b0c1d6b2b78ce40656b28e3",
            "filename": "turbopack/crates/turbopack-dev-server/src/source/headers.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fheaders.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fheaders.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fheaders.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,5 +1,6 @@\n use std::{collections::BTreeMap, hash::Hash, mem::replace, ops::DerefMut};\n \n+use bincode::{Decode, Encode};\n use serde::{Deserialize, Serialize};\n use turbo_tasks::{NonLocalValue, TaskInput, trace::TraceRawVcs};\n \n@@ -16,14 +17,27 @@ use turbo_tasks::{NonLocalValue, TaskInput, trace::TraceRawVcs};\n     Deserialize,\n     NonLocalValue,\n     TaskInput,\n+    Encode,\n+    Decode,\n )]\n #[serde(transparent)]\n pub struct Headers(BTreeMap<String, HeaderValue>);\n \n /// The value of an http header. HTTP headers might contain non-utf-8 bytes. An\n /// header might also occur multiple times.\n #[derive(\n-    Clone, Debug, PartialEq, Eq, Hash, TraceRawVcs, Serialize, Deserialize, NonLocalValue, TaskInput,\n+    Clone,\n+    Debug,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    TraceRawVcs,\n+    Serialize,\n+    Deserialize,\n+    NonLocalValue,\n+    TaskInput,\n+    Encode,\n+    Decode,\n )]\n #[serde(untagged)]\n pub enum HeaderValue {"
        },
        {
            "sha": "24eb3d43086edbaa75fdba50804b88c7d1336b86",
            "filename": "turbopack/crates/turbopack-dev-server/src/source/mod.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fmod.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -28,7 +28,7 @@ use turbo_tasks_fs::FileSystemPath;\n use turbo_tasks_hash::{DeterministicHash, DeterministicHasher, Xxh3Hash64Hasher};\n use turbopack_core::version::{Version, VersionedContent};\n \n-use self::{\n+use crate::source::{\n     headers::Headers, issue_context::IssueFilePathContentSource, query::Query,\n     route_tree::RouteTree,\n };\n@@ -192,6 +192,8 @@ impl HeaderList {\n     Hash,\n     Default,\n     TaskInput,\n+    Encode,\n+    Decode,\n )]\n pub struct ContentSourceData {\n     /// HTTP method, if requested."
        },
        {
            "sha": "1733d3a2c65430d3f0fd23c13fd641821bdd9480",
            "filename": "turbopack/crates/turbopack-dev-server/src/source/query.rs",
            "status": "modified",
            "additions": 27,
            "deletions": 3,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fquery.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fquery.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fquery.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,13 +1,25 @@\n use std::{collections::BTreeMap, hash::Hash, ops::DerefMut};\n \n+use bincode::{Decode, Encode};\n use serde::{Deserialize, Serialize};\n use turbo_tasks::{NonLocalValue, TaskInput, trace::TraceRawVcs};\n \n-use super::ContentSourceDataFilter;\n+use crate::source::ContentSourceDataFilter;\n \n /// A parsed query string from a http request\n #[derive(\n-    Clone, Debug, PartialEq, Eq, Default, Hash, TraceRawVcs, Serialize, Deserialize, NonLocalValue,\n+    Clone,\n+    Debug,\n+    PartialEq,\n+    Eq,\n+    Default,\n+    Hash,\n+    TraceRawVcs,\n+    Serialize,\n+    Deserialize,\n+    NonLocalValue,\n+    Encode,\n+    Decode,\n )]\n #[serde(transparent)]\n pub struct Query(BTreeMap<String, QueryValue>);\n@@ -44,7 +56,19 @@ impl DerefMut for Query {\n     }\n }\n \n-#[derive(Clone, Debug, PartialEq, Eq, Hash, TraceRawVcs, Serialize, Deserialize, NonLocalValue)]\n+#[derive(\n+    Clone,\n+    Debug,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    TraceRawVcs,\n+    Serialize,\n+    Deserialize,\n+    NonLocalValue,\n+    Encode,\n+    Decode,\n+)]\n #[serde(untagged)]\n pub enum QueryValue {\n     /// Simple string value, might be an empty string when there is no value"
        },
        {
            "sha": "f2821ee77a63590adede105f049009052fb93127",
            "filename": "turbopack/crates/turbopack-dev-server/src/source/route_tree.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Froute_tree.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Froute_tree.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Froute_tree.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -14,7 +14,18 @@ use crate::source::{GetContentSourceContent, GetContentSourceContents};\n /// The type of the route. This will decide about the remaining segments of the\n /// route after the base.\n #[derive(\n-    TaskInput, Clone, Debug, PartialEq, Eq, Hash, Serialize, Deserialize, TraceRawVcs, NonLocalValue,\n+    TaskInput,\n+    Clone,\n+    Debug,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    Serialize,\n+    Deserialize,\n+    TraceRawVcs,\n+    NonLocalValue,\n+    Encode,\n+    Decode,\n )]\n pub enum RouteType {\n     Exact,"
        },
        {
            "sha": "d6204e64a4bd7d6cbe8b1ccf1757fe375f3568e7",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/pattern_mapping.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fpattern_mapping.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fpattern_mapping.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fpattern_mapping.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -109,6 +109,8 @@ pub(crate) enum PatternMapping {\n     TraceRawVcs,\n     TaskInput,\n     NonLocalValue,\n+    Encode,\n+    Decode,\n )]\n pub(crate) enum ResolveType {\n     AsyncChunkLoader,"
        },
        {
            "sha": "cc3bc140a8cd5b1495b2bebcfeec425f034de3c9",
            "filename": "turbopack/crates/turbopack-node/src/evaluate.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -1,6 +1,7 @@\n use std::{borrow::Cow, iter, sync::Arc, thread::available_parallelism, time::Duration};\n \n use anyhow::{Result, bail};\n+use bincode::{Decode, Encode};\n use futures_retry::{FutureRetry, RetryPolicy};\n use serde::{Deserialize, Serialize, de::DeserializeOwned};\n use serde_json::Value as JsonValue;\n@@ -143,6 +144,8 @@ async fn emit_evaluate_pool_assets_with_effects_operation(\n     TaskInput,\n     NonLocalValue,\n     TraceRawVcs,\n+    Encode,\n+    Decode,\n )]\n pub enum EnvVarTracking {\n     WholeEnvTracked,\n@@ -509,7 +512,6 @@ async fn pull_operation<T: EvaluateContext>(\n     }\n }\n \n-#[derive(Clone, PartialEq, Eq, Hash, TaskInput, Debug, Serialize, Deserialize, TraceRawVcs)]\n struct BasicEvaluateContext {\n     entries: ResolvedVc<EvaluateEntries>,\n     cwd: FileSystemPath,"
        },
        {
            "sha": "34047af1d32ef3f4fabb964b9e24f9474799aaac",
            "filename": "turbopack/crates/turbopack-node/src/transforms/webpack.rs",
            "status": "modified",
            "additions": 26,
            "deletions": 2,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85c3f2e7d7b31ea26a304c80ca24db920c9469c5/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs?ref=85c3f2e7d7b31ea26a304c80ca24db920c9469c5",
            "patch": "@@ -395,7 +395,19 @@ pub enum InfoMessage {\n     },\n }\n \n-#[derive(Debug, Clone, TaskInput, Hash, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs)]\n+#[derive(\n+    Debug,\n+    Clone,\n+    TaskInput,\n+    Hash,\n+    PartialEq,\n+    Eq,\n+    Serialize,\n+    Deserialize,\n+    TraceRawVcs,\n+    Encode,\n+    Decode,\n+)]\n #[serde(rename_all = \"camelCase\")]\n pub struct WebpackResolveOptions {\n     alias_fields: Option<Vec<RcStr>>,\n@@ -430,7 +442,19 @@ pub enum ResponseMessage {\n     TrackFileRead {},\n }\n \n-#[derive(Clone, PartialEq, Eq, Hash, TaskInput, Serialize, Deserialize, Debug, TraceRawVcs)]\n+#[derive(\n+    Clone,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    TaskInput,\n+    Serialize,\n+    Deserialize,\n+    Debug,\n+    TraceRawVcs,\n+    Encode,\n+    Decode,\n+)]\n pub struct WebpackLoaderContext {\n     pub entries: ResolvedVc<EvaluateEntries>,\n     pub cwd: FileSystemPath,"
        }
    ],
    "stats": {
        "total": 983,
        "additions": 474,
        "deletions": 509
    }
}