{
    "author": "timneutkens",
    "message": "Development: Move all TypeScript related work in watcher together (#83912)\n\n## What?\n\nWork in progress. Checking if tests fail.\n\nMoving these `.d.ts` file writes and TS checks together so that they can\nbe moved to not block in a follow-up PR.",
    "sha": "21f4c9f479f0635b262ea429263055c163d00a48",
    "files": [
        {
            "sha": "2c5bd0438d00295206e0812d06d34b35b96a0048",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/21f4c9f479f0635b262ea429263055c163d00a48/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/21f4c9f479f0635b262ea429263055c163d00a48/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=21f4c9f479f0635b262ea429263055c163d00a48",
            "patch": "@@ -406,7 +406,7 @@ export default abstract class Server<\n \n   protected abstract loadEnvConfig(params: {\n     dev: boolean\n-    forceReload?: boolean\n+    forceReload: boolean\n   }): void\n \n   // TODO-APP: (wyattjoh): Make protected again. Used for turbopack in route-resolver.ts right now.\n@@ -448,7 +448,7 @@ export default abstract class Server<\n     this.dir = path.resolve(/* turbopackIgnore: true */ dir)\n \n     this.quiet = quiet\n-    this.loadEnvConfig({ dev })\n+    this.loadEnvConfig({ dev, forceReload: false })\n \n     // TODO: should conf be normalized to prevent missing\n     // values from causing issues as this can be user provided"
        },
        {
            "sha": "19b3b83373745afe483896e103c7b2e934aee89d",
            "filename": "packages/next/src/server/lib/experimental/create-env-definitions.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/21f4c9f479f0635b262ea429263055c163d00a48/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fexperimental%2Fcreate-env-definitions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/21f4c9f479f0635b262ea429263055c163d00a48/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fexperimental%2Fcreate-env-definitions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fexperimental%2Fcreate-env-definitions.ts?ref=21f4c9f479f0635b262ea429263055c163d00a48",
            "patch": "@@ -40,8 +40,7 @@ export {}`\n   try {\n     // we expect the types directory to already exist\n     const envDtsPath = join(distDir, 'types', 'env.d.ts')\n-    // do not await, this is not essential for further process\n-    writeFile(envDtsPath, definitionStr, 'utf-8')\n+    await writeFile(envDtsPath, definitionStr, 'utf-8')\n   } catch (e) {\n     console.error('Failed to write env.d.ts:', e)\n   }"
        },
        {
            "sha": "f2921f825a6c996f129274d1cab9ddce27aa0bc0",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 137,
            "deletions": 135,
            "changes": 272,
            "blob_url": "https://github.com/vercel/next.js/blob/21f4c9f479f0635b262ea429263055c163d00a48/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/21f4c9f479f0635b262ea429263055c163d00a48/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=21f4c9f479f0635b262ea429263055c163d00a48",
            "patch": "@@ -353,6 +353,7 @@ async function startWatcher(\n     const validatorFilePath = path.join(distDir, 'types', 'validator.ts')\n \n     wp.on('aggregated', async () => {\n+      let writeEnvDefinitions = false\n       let typescriptStatusFromLastAggregation = enabledTypeScript\n       let middlewareMatchers: MiddlewareMatcher[] | undefined\n       const routedPages: string[] = []\n@@ -726,70 +727,14 @@ async function startWatcher(\n         }\n       }\n \n-      // Using === false to make the check clearer.\n-      if (typescriptStatusFromLastAggregation === false && enabledTypeScript) {\n-        // we tolerate the error here as this is best effort\n-        // and the manual install command will be shown\n-        await verifyTypeScript(opts)\n-          .then(() => {\n-            tsconfigChange = true\n-          })\n-          .catch(() => {})\n-      }\n-\n       if (envChange || tsconfigChange) {\n         if (envChange) {\n-          const loadEnvConfig = (\n-            require('@next/env') as typeof import('@next/env')\n-          ).loadEnvConfig\n-          const { loadedEnvFiles } = loadEnvConfig(\n-            dir,\n-            process.env.NODE_ENV === 'development',\n-            Log,\n-            true,\n-            (envFilePath) => {\n-              Log.info(`Reload env: ${envFilePath}`)\n-            }\n-          )\n-\n-          if (enabledTypeScript && nextConfig.experimental?.typedEnv) {\n-            // do not await, this is not essential for further process\n-            createEnvDefinitions({\n-              distDir,\n-              loadedEnvFiles: [\n-                ...loadedEnvFiles,\n-                {\n-                  path: nextConfig.configFileName,\n-                  env: nextConfig.env,\n-                  contents: '',\n-                },\n-              ],\n-            })\n-          }\n+          writeEnvDefinitions = true\n \n           await propagateServerField(opts, 'loadEnvConfig', [\n-            { dev: true, forceReload: true, silent: true },\n+            { dev: true, forceReload: true },\n           ])\n         }\n-        let tsconfigResult:\n-          | UnwrapPromise<\n-              ReturnType<typeof import('../../../build/load-jsconfig').default>\n-            >\n-          | undefined\n-\n-        // This is not relevant for Turbopack because tsconfig/jsconfig is handled internally.\n-        if (!hotReloader.turbopackProject) {\n-          if (tsconfigChange) {\n-            try {\n-              const loadJsConfig = (\n-                require('../../../build/load-jsconfig') as typeof import('../../../build/load-jsconfig')\n-              ).default\n-              tsconfigResult = await loadJsConfig(dir, nextConfig)\n-            } catch (_) {\n-              /* do we want to log if there are syntax errors in tsconfig while editing? */\n-            }\n-          }\n-        }\n \n         if (hotReloader.turbopackProject) {\n           const hasRewrites =\n@@ -819,92 +764,112 @@ async function startWatcher(\n             rootPath,\n             projectPath: normalizePath(path.relative(rootPath, dir)),\n           })\n-        }\n-\n-        hotReloader.activeWebpackConfigs?.forEach((config, idx) => {\n-          const isClient = idx === 0\n-          const isNodeServer = idx === 1\n-          const isEdgeServer = idx === 2\n-          const hasRewrites =\n-            opts.fsChecker.rewrites.afterFiles.length > 0 ||\n-            opts.fsChecker.rewrites.beforeFiles.length > 0 ||\n-            opts.fsChecker.rewrites.fallback.length > 0\n-\n+        } else {\n+          let tsconfigResult:\n+            | UnwrapPromise<\n+                ReturnType<\n+                  typeof import('../../../build/load-jsconfig').default\n+                >\n+              >\n+            | undefined\n+          // This is not relevant for Turbopack because tsconfig/jsconfig is handled internally.\n           if (tsconfigChange) {\n-            config.resolve?.plugins?.forEach((plugin: any) => {\n-              // look for the JsConfigPathsPlugin and update with\n-              // the latest paths/baseUrl config\n-              if (plugin instanceof JsConfigPathsPlugin && tsconfigResult) {\n-                const { resolvedBaseUrl, jsConfig } = tsconfigResult\n-                const currentResolvedBaseUrl = plugin.resolvedBaseUrl\n-                const resolvedUrlIndex = config.resolve?.modules?.findIndex(\n-                  (item) => item === currentResolvedBaseUrl?.baseUrl\n-                )\n+            try {\n+              const loadJsConfig = (\n+                require('../../../build/load-jsconfig') as typeof import('../../../build/load-jsconfig')\n+              ).default\n+              tsconfigResult = await loadJsConfig(dir, nextConfig)\n+            } catch (_) {\n+              /* do we want to log if there are syntax errors in tsconfig while editing? */\n+            }\n+          }\n \n-                if (resolvedBaseUrl) {\n-                  if (\n-                    resolvedBaseUrl.baseUrl !== currentResolvedBaseUrl?.baseUrl\n-                  ) {\n-                    // remove old baseUrl and add new one\n-                    if (resolvedUrlIndex && resolvedUrlIndex > -1) {\n-                      config.resolve?.modules?.splice(resolvedUrlIndex, 1)\n-                    }\n+          hotReloader.activeWebpackConfigs?.forEach((config, idx) => {\n+            const isClient = idx === 0\n+            const isNodeServer = idx === 1\n+            const isEdgeServer = idx === 2\n+            const hasRewrites =\n+              opts.fsChecker.rewrites.afterFiles.length > 0 ||\n+              opts.fsChecker.rewrites.beforeFiles.length > 0 ||\n+              opts.fsChecker.rewrites.fallback.length > 0\n+\n+            if (tsconfigChange) {\n+              config.resolve?.plugins?.forEach((plugin: any) => {\n+                // look for the JsConfigPathsPlugin and update with\n+                // the latest paths/baseUrl config\n+                if (plugin instanceof JsConfigPathsPlugin && tsconfigResult) {\n+                  const { resolvedBaseUrl, jsConfig } = tsconfigResult\n+                  const currentResolvedBaseUrl = plugin.resolvedBaseUrl\n+                  const resolvedUrlIndex = config.resolve?.modules?.findIndex(\n+                    (item) => item === currentResolvedBaseUrl?.baseUrl\n+                  )\n \n-                    // If the resolvedBaseUrl is implicit we only remove the previous value.\n-                    // Only add the baseUrl if it's explicitly set in tsconfig/jsconfig\n-                    if (!resolvedBaseUrl.isImplicit) {\n-                      config.resolve?.modules?.push(resolvedBaseUrl.baseUrl)\n+                  if (resolvedBaseUrl) {\n+                    if (\n+                      resolvedBaseUrl.baseUrl !==\n+                      currentResolvedBaseUrl?.baseUrl\n+                    ) {\n+                      // remove old baseUrl and add new one\n+                      if (resolvedUrlIndex && resolvedUrlIndex > -1) {\n+                        config.resolve?.modules?.splice(resolvedUrlIndex, 1)\n+                      }\n+\n+                      // If the resolvedBaseUrl is implicit we only remove the previous value.\n+                      // Only add the baseUrl if it's explicitly set in tsconfig/jsconfig\n+                      if (!resolvedBaseUrl.isImplicit) {\n+                        config.resolve?.modules?.push(resolvedBaseUrl.baseUrl)\n+                      }\n                     }\n                   }\n+\n+                  if (jsConfig?.compilerOptions?.paths && resolvedBaseUrl) {\n+                    Object.keys(plugin.paths).forEach((key) => {\n+                      delete plugin.paths[key]\n+                    })\n+                    Object.assign(plugin.paths, jsConfig.compilerOptions.paths)\n+                    plugin.resolvedBaseUrl = resolvedBaseUrl\n+                  }\n                 }\n+              })\n+            }\n \n-                if (jsConfig?.compilerOptions?.paths && resolvedBaseUrl) {\n-                  Object.keys(plugin.paths).forEach((key) => {\n-                    delete plugin.paths[key]\n+            if (envChange) {\n+              config.plugins?.forEach((plugin: any) => {\n+                // we look for the DefinePlugin definitions so we can\n+                // update them on the active compilers\n+                if (\n+                  plugin &&\n+                  typeof plugin.definitions === 'object' &&\n+                  plugin.definitions.__NEXT_DEFINE_ENV\n+                ) {\n+                  const newDefine = getDefineEnv({\n+                    isTurbopack: false,\n+                    clientRouterFilters,\n+                    config: nextConfig,\n+                    dev: true,\n+                    distDir,\n+                    fetchCacheKeyPrefix:\n+                      opts.nextConfig.experimental.fetchCacheKeyPrefix,\n+                    hasRewrites,\n+                    isClient,\n+                    isEdgeServer,\n+                    isNodeServer,\n+                    middlewareMatchers: undefined,\n+                    projectPath: opts.dir,\n+                    rewrites: opts.fsChecker.rewrites,\n                   })\n-                  Object.assign(plugin.paths, jsConfig.compilerOptions.paths)\n-                  plugin.resolvedBaseUrl = resolvedBaseUrl\n-                }\n-              }\n-            })\n-          }\n \n-          if (envChange) {\n-            config.plugins?.forEach((plugin: any) => {\n-              // we look for the DefinePlugin definitions so we can\n-              // update them on the active compilers\n-              if (\n-                plugin &&\n-                typeof plugin.definitions === 'object' &&\n-                plugin.definitions.__NEXT_DEFINE_ENV\n-              ) {\n-                const newDefine = getDefineEnv({\n-                  isTurbopack: false,\n-                  clientRouterFilters,\n-                  config: nextConfig,\n-                  dev: true,\n-                  distDir,\n-                  fetchCacheKeyPrefix:\n-                    opts.nextConfig.experimental.fetchCacheKeyPrefix,\n-                  hasRewrites,\n-                  isClient,\n-                  isEdgeServer,\n-                  isNodeServer,\n-                  middlewareMatchers: undefined,\n-                  projectPath: opts.dir,\n-                  rewrites: opts.fsChecker.rewrites,\n-                })\n-\n-                Object.keys(plugin.definitions).forEach((key) => {\n-                  if (!(key in newDefine)) {\n-                    delete plugin.definitions[key]\n-                  }\n-                })\n-                Object.assign(plugin.definitions, newDefine)\n-              }\n-            })\n-          }\n-        })\n+                  Object.keys(plugin.definitions).forEach((key) => {\n+                    if (!(key in newDefine)) {\n+                      delete plugin.definitions[key]\n+                    }\n+                  })\n+                  Object.assign(plugin.definitions, newDefine)\n+                }\n+              })\n+            }\n+          })\n+        }\n         await hotReloader.invalidate({\n           reloadAfterInvalidation: envChange,\n         })\n@@ -1091,6 +1056,43 @@ async function startWatcher(\n         prevSortedRoutes = sortedRoutes\n \n         if (enabledTypeScript) {\n+          // Using === false to make the check clearer.\n+          if (typescriptStatusFromLastAggregation === false) {\n+            // we tolerate the error here as this is best effort\n+            // and the manual install command will be shown\n+            await verifyTypeScript(opts)\n+              .then(() => {\n+                tsconfigChange = true\n+              })\n+              .catch(() => {})\n+          }\n+\n+          if (writeEnvDefinitions && nextConfig.experimental?.typedEnv) {\n+            // TODO: The call to propagateServerField 'loadEnvConfig' causes the env to be loaded twice on env file changes.\n+            const loadEnvConfig = (\n+              require('@next/env') as typeof import('@next/env')\n+            ).loadEnvConfig\n+            const { loadedEnvFiles } = loadEnvConfig(\n+              dir,\n+              process.env.NODE_ENV === 'development',\n+              // Silent as it's the second time `loadEnvConfig` is called in this pass.\n+              undefined,\n+              true\n+            )\n+\n+            await createEnvDefinitions({\n+              distDir,\n+              loadedEnvFiles: [\n+                ...loadedEnvFiles,\n+                {\n+                  path: nextConfig.configFileName,\n+                  env: nextConfig.env,\n+                  contents: '',\n+                },\n+              ],\n+            })\n+          }\n+\n           const routeTypesManifest = await createRouteTypesManifest({\n             dir,\n             pageRoutes,"
        },
        {
            "sha": "2f7cc16a54a95640a8d85a8b88c5688c18a9d08b",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/21f4c9f479f0635b262ea429263055c163d00a48/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/21f4c9f479f0635b262ea429263055c163d00a48/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=21f4c9f479f0635b262ea429263055c163d00a48",
            "patch": "@@ -434,17 +434,20 @@ export default class NextNodeServer extends BaseServer<\n   protected loadEnvConfig({\n     dev,\n     forceReload,\n-    silent,\n   }: {\n     dev: boolean\n-    forceReload?: boolean\n-    silent?: boolean\n+    forceReload: boolean\n   }) {\n     loadEnvConfig(\n       this.dir,\n       dev,\n-      silent ? { info: () => {}, error: () => {} } : Log,\n+      Log,\n+      forceReload,\n       forceReload\n+        ? (envFilePath) => {\n+            Log.info(`Reload env: ${envFilePath}`)\n+          }\n+        : undefined\n     )\n   }\n "
        }
    ],
    "stats": {
        "total": 290,
        "additions": 147,
        "deletions": 143
    }
}