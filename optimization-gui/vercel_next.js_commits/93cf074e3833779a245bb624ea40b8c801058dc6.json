{
    "author": "eps1lon",
    "message": "[test] Move off of as much `url.parse` as possible (#87286)\n\n`url.parse` is deprecated in favor of WHATWG URLs. \n\nAlmost all tests don't actually test integration with `url.parse`.\n\nThe remaining places test integration with the Next.js request handler\nwhich does accept `url.parse` values.\n\nWe may deprecate that specific signature in favor of accepting WHATWG\nURLs instead.",
    "sha": "93cf074e3833779a245bb624ea40b8c801058dc6",
    "files": [
        {
            "sha": "10de4fed59905c47974da53bf4c8cb537ea162f5",
            "filename": "test/development/basic/misc.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fdevelopment%2Fbasic%2Fmisc.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fdevelopment%2Fbasic%2Fmisc.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fmisc.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,4 +1,3 @@\n-import url from 'url'\n import { join } from 'path'\n import webdriver from 'next-webdriver'\n import { createNext, FileRef } from 'e2e-utils'\n@@ -69,7 +68,7 @@ describe.each([[''], ['/docs']])(\n           }\n         )\n \n-        const { pathname, hostname } = url.parse(\n+        const { pathname, hostname } = new URL(\n           res.headers.get('location') || ''\n         )\n         expect(res.status).toBe(308)"
        },
        {
            "sha": "4dd4398d13d269a8739a98cfe20050b26851c78b",
            "filename": "test/development/pages-dir/client-navigation/rendering.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -6,7 +6,6 @@ import { fetchViaHTTP, getDistDir, renderViaHTTP } from 'next-test-utils'\n import webdriver from 'next-webdriver'\n import { BUILD_MANIFEST, REACT_LOADABLE_MANIFEST } from 'next/constants'\n import path from 'path'\n-import url from 'url'\n \n const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n \n@@ -47,7 +46,7 @@ describe('Client Navigation rendering', () => {\n     it('should should not contain scripts that are not js', async () => {\n       const $ = await get$('/')\n       $('script[src]').each((_index, element) => {\n-        const parsedUrl = url.parse($(element).attr('src'))\n+        const parsedUrl = new URL($(element).attr('src'), next.url)\n         if (!parsedUrl.pathname.endsWith('.js')) {\n           throw new Error(\n             `Page includes script that is not a javascript file ${parsedUrl.pathname}`"
        },
        {
            "sha": "e65c0e4e991e2e47125dc09e5418b63f996bde44",
            "filename": "test/e2e/app-dir/app-fetch-deduping/app-fetch-deduping.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fe2e%2Fapp-dir%2Fapp-fetch-deduping%2Fapp-fetch-deduping.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fe2e%2Fapp-dir%2Fapp-fetch-deduping%2Fapp-fetch-deduping.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-fetch-deduping%2Fapp-fetch-deduping.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,6 +1,5 @@\n import { findPort, retry } from 'next-test-utils'\n import http from 'http'\n-import url from 'url'\n import { outdent } from 'outdent'\n import { isNextDev, isNextStart, nextTestSetup } from 'e2e-utils'\n \n@@ -15,8 +14,11 @@ describe('app-fetch-deduping', () => {\n       beforeAll(async () => {\n         externalServerPort = await findPort()\n         externalServer = http.createServer((req, res) => {\n-          const parsedUrl = url.parse(req.url, true)\n-          const overrideStatus = parsedUrl.query.status\n+          const parsedUrl = new URL(\n+            req.url,\n+            `http://localhost:${externalServerPort}`\n+          )\n+          const overrideStatus = parsedUrl.searchParams.get('status')\n \n           // if the requested url has a \"status\" search param, override the response status\n           if (overrideStatus) {"
        },
        {
            "sha": "4d71ff41e9e45a1a5cc2b1fc04d0b0e8a2ee31e9",
            "filename": "test/e2e/basepath/basepath.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,4 +1,3 @@\n-import url from 'url'\n import assert from 'assert'\n import cheerio from 'cheerio'\n import webdriver from 'next-webdriver'\n@@ -456,14 +455,14 @@ describe('basePath', () => {\n   it('should have correct href for a link', async () => {\n     const browser = await webdriver(next.url, `${basePath}/hello`)\n     const href = await browser.elementByCss('a').getAttribute('href')\n-    const { pathname } = url.parse(href)\n+    const { pathname } = new URL(href, await browser.url())\n     expect(pathname).toBe(`${basePath}/other-page`)\n   })\n \n   it('should have correct href for a link to /', async () => {\n     const browser = await webdriver(next.url, `${basePath}/link-to-root`)\n     const href = await browser.elementByCss('#link-back').getAttribute('href')\n-    const { pathname } = url.parse(href)\n+    const { pathname } = new URL(href, await browser.url())\n     expect(pathname).toBe(`${basePath}`)\n   })\n "
        },
        {
            "sha": "87f886652ae069f20a9a313ac2c91ea1dfc85a36",
            "filename": "test/e2e/basepath/redirect-and-rewrite.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fe2e%2Fbasepath%2Fredirect-and-rewrite.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fe2e%2Fbasepath%2Fredirect-and-rewrite.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbasepath%2Fredirect-and-rewrite.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,4 +1,3 @@\n-import url from 'url'\n import { nextTestSetup } from 'e2e-utils'\n import { fetchViaHTTP, renderViaHTTP } from 'next-test-utils'\n \n@@ -110,7 +109,7 @@ describe('basePath', () => {\n         redirect: 'manual',\n       }\n     )\n-    const { pathname } = url.parse(res.headers.get('location') || '')\n+    const { pathname } = new URL(res.headers.get('location') || '')\n     expect(pathname).toBe(`${basePath}/somewhere-else`)\n     expect(res.status).toBe(307)\n     const text = await res.text()\n@@ -144,7 +143,7 @@ describe('basePath', () => {\n         redirect: 'manual',\n       }\n     )\n-    const { pathname } = url.parse(res.headers.get('location') || '')\n+    const { pathname } = new URL(res.headers.get('location') || '')\n     expect(pathname).toBe('/another-destination')\n     expect(res.status).toBe(307)\n     const text = await res.text()"
        },
        {
            "sha": "90eefa77dfc98ab9a853efe4f1bd942f18060d3b",
            "filename": "test/integration/basepath-root-catch-all/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fbasepath-root-catch-all%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fbasepath-root-catch-all%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fbasepath-root-catch-all%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -8,7 +8,6 @@ import {\n import webdriver from 'next-webdriver'\n import { join } from 'path'\n import fs from 'fs-extra'\n-import url from 'url'\n \n let app\n let appPort\n@@ -22,7 +21,7 @@ const runTests = () => {\n     await browser.waitForElementByCss('#url')\n \n     const dataUrl = await browser.elementByCss('#url').text()\n-    const { pathname } = url.parse(dataUrl)\n+    const { pathname } = new URL(dataUrl, await browser.url())\n     expect(pathname).toBe(`/_next/data/${buildId}/root/catch-all.json`)\n   })\n }"
        },
        {
            "sha": "8a637797e585685e4904d2ac346cb0d15764ab83",
            "filename": "test/integration/custom-routes-i18n-index-redirect/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fcustom-routes-i18n-index-redirect%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fcustom-routes-i18n-index-redirect%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcustom-routes-i18n-index-redirect%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,6 +1,5 @@\n /* eslint-env jest */\n \n-import url from 'url'\n import http from 'http'\n import { join } from 'path'\n import {\n@@ -35,9 +34,9 @@ const runTests = () => {\n         const text = await res.text()\n         expect(text).toEqual(dest)\n         if (dest.startsWith('/')) {\n-          const parsed = url.parse(res.headers.get('location'))\n+          const parsed = new URL(res.headers.get('location'))\n           expect(parsed.pathname).toBe(dest)\n-          expect(parsed.query).toBe(null)\n+          expect(parsed.search).toBe('')\n         } else {\n           expect(res.headers.get('location')).toBe(dest)\n         }"
        },
        {
            "sha": "23e76336a6b3675f451272d9b3fd90b177fad31a",
            "filename": "test/integration/custom-routes-i18n/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fcustom-routes-i18n%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fcustom-routes-i18n%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcustom-routes-i18n%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,6 +1,5 @@\n /* eslint-env jest */\n \n-import url from 'url'\n import http from 'http'\n import { join } from 'path'\n import cheerio from 'cheerio'\n@@ -42,9 +41,9 @@ const runTests = () => {\n         const text = await res.text()\n         expect(text).toEqual(dest)\n         if (dest.startsWith('/')) {\n-          const parsed = url.parse(res.headers.get('location'))\n+          const parsed = new URL(res.headers.get('location'))\n           expect(parsed.pathname).toBe(dest)\n-          expect(parsed.query).toBe(null)\n+          expect(parsed.search).toBe('')\n         } else {\n           expect(res.headers.get('location')).toBe(dest)\n         }"
        },
        {
            "sha": "66b95359a7ba1445ff71c48cc22b487e3e37978a",
            "filename": "test/integration/custom-routes/test/index.test.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 40,
            "changes": 93,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fcustom-routes%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fcustom-routes%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcustom-routes%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,7 +1,6 @@\n /* eslint-env jest */\n \n import http from 'http'\n-import url from 'url'\n import stripAnsi from 'strip-ansi'\n import fs from 'fs-extra'\n import { join } from 'path'\n@@ -392,21 +391,24 @@ const runTests = (isDev = false) => {\n     const res1 = await fetchViaHTTP(appPort, '/redir-chain1', undefined, {\n       redirect: 'manual',\n     })\n-    const res1location = url.parse(res1.headers.get('location')).pathname\n+    const res1location = new URL(res1.headers.get('location'), res1.url)\n+      .pathname\n     expect(res1.status).toBe(301)\n     expect(res1location).toBe('/redir-chain2')\n \n     const res2 = await fetchViaHTTP(appPort, res1location, undefined, {\n       redirect: 'manual',\n     })\n-    const res2location = url.parse(res2.headers.get('location')).pathname\n+    const res2location = new URL(res2.headers.get('location'), res2.url)\n+      .pathname\n     expect(res2.status).toBe(302)\n     expect(res2location).toBe('/redir-chain3')\n \n     const res3 = await fetchViaHTTP(appPort, res2location, undefined, {\n       redirect: 'manual',\n     })\n-    const res3location = url.parse(res3.headers.get('location')).pathname\n+    const res3location = new URL(res3.headers.get('location'), res3.url)\n+      .pathname\n     expect(res3.status).toBe(303)\n     expect(res3location).toBe('/')\n   })\n@@ -443,7 +445,7 @@ const runTests = (isDev = false) => {\n     const res = await fetchViaHTTP(appPort, '/redirect1', undefined, {\n       redirect: 'manual',\n     })\n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'), res.url)\n     expect(res.status).toBe(307)\n     expect(pathname).toBe('/')\n   })\n@@ -452,7 +454,7 @@ const runTests = (isDev = false) => {\n     const res = await fetchViaHTTP(appPort, '/hello/123/another', undefined, {\n       redirect: 'manual',\n     })\n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'), res.url)\n     expect(res.status).toBe(307)\n     expect(pathname).toBe('/blog/123')\n   })\n@@ -466,24 +468,24 @@ const runTests = (isDev = false) => {\n         redirect: 'manual',\n       }\n     )\n-    const { pathname, hash, query } = url.parse(\n+    const { pathname, hash, search } = new URL(\n       res.headers.get('location'),\n-      true\n+      res.url\n     )\n     expect(res.status).toBe(301)\n     expect(pathname).toBe('/docs/v2/network/status-codes')\n     expect(hash).toBe('#500')\n-    expect(query).toEqual({})\n+    expect(search).toEqual('')\n   })\n \n   it('should redirect successfully with provided statusCode', async () => {\n     const res = await fetchViaHTTP(appPort, '/redirect2', undefined, {\n       redirect: 'manual',\n     })\n-    const { pathname, query } = url.parse(res.headers.get('location'), true)\n+    const { pathname, search } = new URL(res.headers.get('location'), res.url)\n     expect(res.status).toBe(301)\n     expect(pathname).toBe('/')\n-    expect(query).toEqual({})\n+    expect(search).toEqual('')\n   })\n \n   it('should redirect successfully with catchall', async () => {\n@@ -495,10 +497,10 @@ const runTests = (isDev = false) => {\n         redirect: 'manual',\n       }\n     )\n-    const { pathname, query } = url.parse(res.headers.get('location'), true)\n+    const { pathname, search } = new URL(res.headers.get('location'), res.url)\n     expect(res.status).toBe(307)\n     expect(pathname).toBe('/somewhere')\n-    expect(query).toEqual({})\n+    expect(search).toEqual('')\n   })\n \n   it('should server static files through a rewrite', async () => {\n@@ -583,10 +585,13 @@ const runTests = (isDev = false) => {\n         redirect: 'manual',\n       }\n     )\n-    const { pathname, query } = url.parse(res.headers.get('location'), true)\n+    const { pathname, searchParams } = new URL(\n+      res.headers.get('location'),\n+      res.url\n+    )\n     expect(res.status).toBe(307)\n     expect(pathname).toBe('/with-params')\n-    expect(query).toEqual({\n+    expect(Object.fromEntries(searchParams)).toEqual({\n       first: 'hello',\n       second: 'world',\n       a: 'b',\n@@ -602,11 +607,14 @@ const runTests = (isDev = false) => {\n         redirect: 'manual',\n       }\n     )\n-    const { pathname, query } = url.parse(res.headers.get('location'), true)\n+    const { pathname, searchParams } = new URL(\n+      res.headers.get('location'),\n+      res.url\n+    )\n     expect(res.status).toBe(307)\n     expect(pathname).toBe('/with-params')\n-    expect(query).toEqual({\n-      // this should be decoded since url.parse decodes query values\n+    expect(Object.fromEntries(searchParams)).toEqual({\n+      // this should be decoded since new URL decodes query values\n       first: 'hello world?w=24&focalpoint=center',\n       second: 'world',\n       a: 'b',\n@@ -652,7 +660,7 @@ const runTests = (isDev = false) => {\n     const res = await fetchViaHTTP(appPort, '/redirect-override', undefined, {\n       redirect: 'manual',\n     })\n-    const { pathname } = url.parse(res.headers.get('location') || '')\n+    const { pathname } = new URL(res.headers.get('location') || '', res.url)\n     expect(res.status).toBe(307)\n     expect(pathname).toBe('/thank-you-next')\n   })\n@@ -809,10 +817,10 @@ const runTests = (isDev = false) => {\n     expect(res.status).toBe(200)\n     expect(\n       [...externalServerHits].map((u) => {\n-        const { pathname, query } = url.parse(u, true)\n+        const { pathname, searchParams } = new URL(u, res.url)\n         return {\n           pathname,\n-          query,\n+          query: Object.fromEntries(searchParams),\n         }\n       })\n     ).toEqual([\n@@ -833,7 +841,7 @@ const runTests = (isDev = false) => {\n     const res = await fetchViaHTTP(appPort, '/unnamed/first/final', undefined, {\n       redirect: 'manual',\n     })\n-    const { pathname } = url.parse(res.headers.get('location') || '')\n+    const { pathname } = new URL(res.headers.get('location') || '', res.url)\n     expect(res.status).toBe(307)\n     expect(pathname).toBe('/got-unnamed')\n   })\n@@ -847,7 +855,7 @@ const runTests = (isDev = false) => {\n         redirect: 'manual',\n       }\n     )\n-    const { pathname } = url.parse(res.headers.get('location') || '')\n+    const { pathname } = new URL(res.headers.get('location') || '', res.url)\n     expect(res.status).toBe(307)\n     expect(pathname).toBe('/first')\n   })\n@@ -909,14 +917,14 @@ const runTests = (isDev = false) => {\n       }\n     )\n \n-    const { pathname, hostname, query } = url.parse(\n+    const { pathname, hostname, searchParams } = new URL(\n       res.headers.get('location') || '',\n-      true\n+      res.url\n     )\n     expect(res.status).toBe(307)\n     expect(pathname).toBe(encodeURI('/\\\\google.com/about'))\n     expect(hostname).not.toBe('google.com')\n-    expect(query).toEqual({})\n+    expect(Object.fromEntries(searchParams)).toEqual({})\n   })\n \n   it('should handle unnamed parameters with multi-match successfully', async () => {\n@@ -937,7 +945,7 @@ const runTests = (isDev = false) => {\n         redirect: 'manual',\n       }\n     )\n-    const { pathname } = url.parse(res.headers.get('location') || '')\n+    const { pathname } = new URL(res.headers.get('location') || '', res.url)\n     expect(res.status).toBe(307)\n     expect(pathname).toBe('/integrations/-some/thing')\n   })\n@@ -1278,10 +1286,10 @@ const runTests = (isDev = false) => {\n     })\n \n     expect(res.status).toBe(307)\n-    const parsed = url.parse(res.headers.get('location'), true)\n+    const parsed = new URL(res.headers.get('location'), res.url)\n \n     expect(parsed.pathname).toBe('/another')\n-    expect(parsed.query).toEqual({\n+    expect(Object.fromEntries(parsed.searchParams)).toEqual({\n       myHeader: 'hello world!!',\n     })\n \n@@ -1304,10 +1312,10 @@ const runTests = (isDev = false) => {\n     )\n \n     expect(res.status).toBe(307)\n-    const parsed = url.parse(res.headers.get('location'), true)\n+    const parsed = new URL(res.headers.get('location'), res.url)\n \n     expect(parsed.pathname).toBe('/another')\n-    expect(parsed.query).toEqual({\n+    expect(Object.fromEntries(parsed.searchParams)).toEqual({\n       value: 'hellooo',\n       'my-query': 'hellooo',\n     })\n@@ -1327,10 +1335,10 @@ const runTests = (isDev = false) => {\n     })\n \n     expect(res.status).toBe(307)\n-    const parsed = url.parse(res.headers.get('location'), true)\n+    const parsed = new URL(res.headers.get('location'), res.url)\n \n     expect(parsed.pathname).toBe('/another')\n-    expect(parsed.query).toEqual({\n+    expect(Object.fromEntries(parsed.searchParams)).toEqual({\n       authorized: '1',\n     })\n \n@@ -1354,10 +1362,10 @@ const runTests = (isDev = false) => {\n     })\n \n     expect(res.status).toBe(307)\n-    const parsed = url.parse(res.headers.get('location'), true)\n+    const parsed = new URL(res.headers.get('location'), res.url)\n \n     expect(parsed.pathname).toBe('/another')\n-    expect(parsed.query).toEqual({\n+    expect(Object.fromEntries(parsed.searchParams)).toEqual({\n       host: '1',\n     })\n   })\n@@ -1376,12 +1384,12 @@ const runTests = (isDev = false) => {\n     })\n \n     expect(res.status).toBe(307)\n-    const parsed = url.parse(res.headers.get('location'), true)\n+    const parsed = new URL(res.headers.get('location'), res.url)\n \n     expect(parsed.protocol).toBe('https:')\n     expect(parsed.hostname).toBe('hello.example.com')\n     expect(parsed.pathname).toBe('/some-path/end')\n-    expect(parsed.query).toEqual({\n+    expect(Object.fromEntries(parsed.searchParams)).toEqual({\n       a: 'b',\n     })\n   })\n@@ -1396,10 +1404,15 @@ const runTests = (isDev = false) => {\n       }\n     )\n     expect(res.status).toBe(307)\n-    const parsed = url.parse(res.headers.get('location'), true)\n+    const parsed = new URL(res.headers.get('location'), res.url)\n \n     expect(parsed.pathname).toBe('/somewhere')\n-    expect(parsed.query).toEqual({\n+    const query = {}\n+    for (const key of parsed.searchParams.keys()) {\n+      const values = parsed.searchParams.getAll(key)\n+      query[key] = values.length > 1 ? values : values[0]\n+    }\n+    expect(query).toEqual({\n       hello: ['world', 'another'],\n       value: 'another',\n     })\n@@ -2745,7 +2758,7 @@ describe('Custom routes', () => {\n         expect(res.headers.get('x-custom-header')).toBeFalsy()\n         expect(res.headers.get('x-another-header')).toBeFalsy()\n \n-        const { pathname } = url.parse(res2.headers.get('location'))\n+        const { pathname } = new URL(res2.headers.get('location'), res.url)\n         expect(res2.status).toBe(301)\n         expect(pathname).toBe('/docs/v2/advanced/now-for-github')\n "
        },
        {
            "sha": "8c7effc58fa06015f8bcab4697791a6461b3dcb7",
            "filename": "test/integration/dynamic-routing/test/index.test.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 20,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fdynamic-routing%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fdynamic-routing%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fdynamic-routing%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,9 +1,8 @@\n /* eslint-env jest */\n \n-import webdriver from 'next-webdriver'\n+import webdriver, { type Playwright } from 'next-webdriver'\n import { join, dirname } from 'path'\n import fs from 'fs-extra'\n-import url from 'url'\n import {\n   waitForRedbox,\n   renderViaHTTP,\n@@ -234,12 +233,14 @@ function runTests({ dev }) {\n     ]) {\n       const { id, pathname, query, hash, navQuery } = expectedValues\n \n-      const parsedHref = url.parse(\n+      const parsedHref = new URL(\n         await browser.elementByCss(`#${id}`).getAttribute('href'),\n-        true\n+        await browser.url()\n       )\n       expect(parsedHref.pathname).toBe(pathname)\n-      expect(parsedHref.query || {}).toEqual(query)\n+      expect(Object.fromEntries(parsedHref.searchParams.entries())).toEqual(\n+        query\n+      )\n       expect(parsedHref.hash || '').toBe(hash)\n \n       await browser.eval('window.beforeNav = 1')\n@@ -262,25 +263,25 @@ function runTests({ dev }) {\n \n   it('should handle only hash on dynamic route', async () => {\n     const browser = await webdriver(appPort, '/post-1')\n-    const parsedHref = url.parse(\n+    const parsedHref = new URL(\n       await browser\n         .elementByCss('#dynamic-route-only-hash')\n         .getAttribute('href'),\n-      true\n+      await browser.url()\n     )\n     expect(parsedHref.pathname).toBe('/post-1')\n     expect(parsedHref.hash).toBe('#only-hash')\n-    expect(parsedHref.query || {}).toEqual({})\n+    expect(Object.fromEntries(parsedHref.searchParams.entries())).toEqual({})\n \n-    const parsedHref2 = url.parse(\n+    const parsedHref2 = new URL(\n       await browser\n         .elementByCss('#dynamic-route-only-hash-obj')\n         .getAttribute('href'),\n-      true\n+      await browser.url()\n     )\n     expect(parsedHref2.pathname).toBe('/post-1')\n     expect(parsedHref2.hash).toBe('#only-hash-obj')\n-    expect(parsedHref2.query || {}).toEqual({})\n+    expect(Object.fromEntries(parsedHref2.searchParams.entries())).toEqual({})\n \n     expect(await browser.eval('window.location.hash')).toBe('')\n \n@@ -543,9 +544,9 @@ function runTests({ dev }) {\n         .elementByCss('#view-post-1-interpolated')\n         .getAttribute('href')\n \n-      const parsedHref = url.parse(href, true)\n+      const parsedHref = new URL(href, await browser.url())\n       expect(parsedHref.pathname).toBe('/post-1')\n-      expect(parsedHref.query).toEqual({})\n+      expect(Object.fromEntries(parsedHref.searchParams.entries())).toEqual({})\n \n       await browser.elementByCss('#view-post-1-interpolated').click()\n       await browser.waitForElementByCss('#asdf')\n@@ -569,10 +570,11 @@ function runTests({ dev }) {\n         .elementByCss('#view-post-1-interpolated-more-query')\n         .getAttribute('href')\n \n-      const parsedHref = url.parse(href, true)\n+      const parsedHref = new URL(href, await browser.url())\n       expect(parsedHref.pathname).toBe('/post-1')\n-      expect(parsedHref.query).toEqual({ another: 'value' })\n-\n+      expect(Object.fromEntries(parsedHref.searchParams.entries())).toEqual({\n+        another: 'value',\n+      })\n       await browser.elementByCss('#view-post-1-interpolated-more-query').click()\n       await browser.waitForElementByCss('#asdf')\n \n@@ -672,7 +674,9 @@ function runTests({ dev }) {\n         .elementByCss('#view-post-1-comment-1-interpolated')\n         .getAttribute('href')\n \n-      expect(url.parse(href).pathname).toBe('/post-1/comment-1')\n+      expect(new URL(href, await browser.url()).pathname).toBe(\n+        '/post-1/comment-1'\n+      )\n \n       await browser.elementByCss('#view-post-1-comment-1-interpolated').click()\n       await browser.waitForElementByCss('#asdf')\n@@ -904,7 +908,9 @@ function runTests({ dev }) {\n         .elementByCss('#ssg-catch-all-single-interpolated')\n         .getAttribute('href')\n \n-      expect(url.parse(href).pathname).toBe('/p1/p2/all-ssg/hello')\n+      expect(new URL(href, await browser.url()).pathname).toBe(\n+        '/p1/p2/all-ssg/hello'\n+      )\n \n       await browser.elementByCss('#ssg-catch-all-single-interpolated').click()\n       await browser.waitForElementByCss('#all-ssg-content')\n@@ -953,7 +959,7 @@ function runTests({ dev }) {\n   })\n \n   it('[ssg: catch-all] should pass params in getStaticProps during client navigation (multi interpolated)', async () => {\n-    let browser\n+    let browser: Playwright\n     try {\n       browser = await webdriver(appPort, '/')\n       await browser.eval('window.beforeNav = 1')\n@@ -962,7 +968,9 @@ function runTests({ dev }) {\n         .elementByCss('#ssg-catch-all-multi-interpolated')\n         .getAttribute('href')\n \n-      expect(url.parse(href).pathname).toBe('/p1/p2/all-ssg/hello1/hello2')\n+      expect(new URL(href, await browser.url()).pathname).toBe(\n+        '/p1/p2/all-ssg/hello1/hello2'\n+      )\n \n       await browser.elementByCss('#ssg-catch-all-multi-interpolated').click()\n       await browser.waitForElementByCss('#all-ssg-content')"
        },
        {
            "sha": "4aebbb64c3da3f49b547587c3830b1e217259a72",
            "filename": "test/integration/env-config/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fenv-config%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fenv-config%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fenv-config%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,6 +1,5 @@\n /* eslint-env jest */\n \n-import url from 'url'\n import fs from 'fs-extra'\n import { join } from 'path'\n import cheerio from 'cheerio'\n@@ -79,7 +78,7 @@ const runTests = (mode = 'dev', didReload = false) => {\n     const res = await fetchViaHTTP(appPort, '/hello', undefined, {\n       redirect: 'manual',\n     })\n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'))\n \n     expect(res.status).toBe(307)\n     expect(pathname).toBe('/another')"
        },
        {
            "sha": "9126f9373ffac4d0bbfbf8a6c5781e03492d7773",
            "filename": "test/integration/file-serving/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Ffile-serving%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Ffile-serving%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ffile-serving%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,7 +1,6 @@\n /* eslint-env jest */\n \n /* eslint-disable jest/no-identical-title */\n-import url from 'url'\n import fs from 'fs-extra'\n import { join } from 'path'\n import {\n@@ -23,7 +22,7 @@ const expectStatus = async (path) => {\n   const checkRes = async (res) => {\n     if (res.status === 308) {\n       const redirectDest = res.headers.get('location')\n-      const parsedUrl = url.parse(redirectDest, true)\n+      const parsedUrl = new URL(redirectDest)\n       expect(parsedUrl.hostname).toBeOneOf(['localhost', '127.0.0.1'])\n     } else {\n       try {"
        },
        {
            "sha": "cd7124325e5daa39ea8a39b3dc3080fba5d7d72d",
            "filename": "test/integration/gssp-redirect-base-path/test/index.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 21,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fgssp-redirect-base-path%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fgssp-redirect-base-path%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fgssp-redirect-base-path%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,5 +1,4 @@\n /* eslint-env jest */\n-import url from 'url'\n import fs from 'fs-extra'\n import webdriver from 'next-webdriver'\n import { join } from 'path'\n@@ -32,7 +31,7 @@ const runTests = (isDev: boolean) => {\n     )\n     expect(res.status).toBe(307)\n \n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'))\n \n     expect(pathname).toBe(`${basePath}/404`)\n   })\n@@ -51,7 +50,7 @@ const runTests = (isDev: boolean) => {\n     const text = await res.text()\n     expect(text).toEqual(`/404`)\n \n-    const parsedUrl = url.parse(res.headers.get('location'))\n+    const parsedUrl = new URL(res.headers.get('location'))\n     expect(parsedUrl.pathname).toBe(`/404`)\n \n     const browser = await webdriver(appPort, `${basePath}`)\n@@ -61,7 +60,7 @@ const runTests = (isDev: boolean) => {\n       /oops not found/\n     )\n \n-    const parsedUrl2 = url.parse(await browser.eval('window.location.href'))\n+    const parsedUrl2 = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl2.pathname).toBe('/404')\n   })\n \n@@ -79,7 +78,7 @@ const runTests = (isDev: boolean) => {\n     const text = await res.text()\n     expect(text).toEqual(`${basePath}/404`)\n \n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'))\n \n     expect(pathname).toBe(`${basePath}/404`)\n     expect(res.headers.get('refresh')).toContain(`url=${basePath}/404`)\n@@ -99,7 +98,7 @@ const runTests = (isDev: boolean) => {\n     const text = await res.text()\n     expect(text).toEqual(`${basePath}/404`)\n \n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'))\n \n     expect(pathname).toBe(`${basePath}/404`)\n     expect(res.headers.get('refresh')).toBe(null)\n@@ -119,7 +118,7 @@ const runTests = (isDev: boolean) => {\n     const text = await res.text()\n     expect(text).toEqual(`${basePath}/404`)\n \n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'))\n \n     expect(pathname).toBe(`${basePath}/404`)\n     expect(res.headers.get('refresh')).toBe(null)\n@@ -143,7 +142,7 @@ const runTests = (isDev: boolean) => {\n       },\n     })\n     const initialHref = await browser.eval(() => (window as any).initialHref)\n-    const { pathname } = url.parse(initialHref)\n+    const { pathname } = new URL(initialHref)\n     expect(pathname).toBe(`${basePath}/gsp-blog/redirect-dest-_gsp-blog_first`)\n   })\n \n@@ -166,7 +165,7 @@ const runTests = (isDev: boolean) => {\n         },\n       })\n       const initialHref = await browser.eval(() => (window as any).initialHref)\n-      const { pathname } = url.parse(initialHref)\n+      const { pathname } = new URL(initialHref)\n       // since it was cached the initial value is now the redirect\n       // result\n       expect(pathname).toBe(`${basePath}/gsp-blog/first`)\n@@ -185,7 +184,7 @@ const runTests = (isDev: boolean) => {\n     await browser.waitForElementByCss('#index')\n \n     const initialHref = await browser.eval(() => (window as any).initialHref)\n-    const { pathname } = url.parse(initialHref)\n+    const { pathname } = new URL(initialHref)\n     expect(pathname).toBe(`${basePath}/gsp-blog/redirect-dest-_`)\n   })\n \n@@ -202,7 +201,7 @@ const runTests = (isDev: boolean) => {\n       await browser.waitForElementByCss('#index')\n \n       const initialHref = await browser.eval(() => (window as any).initialHref)\n-      const { pathname } = url.parse(initialHref)\n+      const { pathname } = new URL(initialHref)\n       expect(pathname).toBe(`${basePath}`)\n     })\n   }\n@@ -225,7 +224,7 @@ const runTests = (isDev: boolean) => {\n     expect(initialHref).toBeFalsy()\n \n     const curUrl = await browser.url()\n-    const { pathname } = url.parse(curUrl)\n+    const { pathname } = new URL(curUrl)\n     expect(pathname).toBe('/docs/missing')\n   })\n \n@@ -274,7 +273,7 @@ const runTests = (isDev: boolean) => {\n     )\n     expect(res.status).toBe(307)\n \n-    const parsed = url.parse(res.headers.get('location'))\n+    const parsed = new URL(res.headers.get('location'))\n     expect(parsed.hostname).toBe('example.vercel.sh')\n     expect(parsed.pathname).toBe('/')\n   })\n@@ -390,8 +389,8 @@ const runTests = (isDev: boolean) => {\n     })()`)\n \n     const curUrl = await browser.url()\n-    const { path } = url.parse(curUrl)\n-    expect(path).toEqual(`${basePath}`)\n+    const { pathname, search } = new URL(curUrl)\n+    expect(pathname + search).toEqual(`${basePath}`)\n   })\n \n   it('should not replace history of the origin page when GSSP page is navigated to client-side (external)', async () => {\n@@ -418,8 +417,8 @@ const runTests = (isDev: boolean) => {\n     })()`)\n \n     const curUrl = await browser.url()\n-    const { path } = url.parse(curUrl)\n-    expect(path).toEqual(`${basePath}`)\n+    const { pathname, search } = new URL(curUrl)\n+    expect(pathname + search).toEqual(`${basePath}`)\n   })\n \n   it('should not replace history of the origin page when GSP page is navigated to client-side (internal)', async () => {\n@@ -446,8 +445,8 @@ const runTests = (isDev: boolean) => {\n     })()`)\n \n     const curUrl = await browser.url()\n-    const { path } = url.parse(curUrl)\n-    expect(path).toEqual(`${basePath}`)\n+    const { pathname, search } = new URL(curUrl)\n+    expect(pathname + search).toEqual(`${basePath}`)\n   })\n \n   it('should not replace history of the origin page when GSP page is navigated to client-side (external)', async () => {\n@@ -474,8 +473,8 @@ const runTests = (isDev: boolean) => {\n     })()`)\n \n     const curUrl = await browser.url()\n-    const { path } = url.parse(curUrl)\n-    expect(path).toEqual(`${basePath}`)\n+    const { pathname, search } = new URL(curUrl)\n+    expect(pathname + search).toEqual(`${basePath}`)\n   })\n }\n "
        },
        {
            "sha": "90dfdd05c5f009ef8eb331f408f2684732bc4e69",
            "filename": "test/integration/gssp-redirect/test/index.test.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 23,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fgssp-redirect%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fgssp-redirect%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fgssp-redirect%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,5 +1,4 @@\n /* eslint-env jest */\n-import url from 'url'\n import fs from 'fs-extra'\n import webdriver from 'next-webdriver'\n import { join } from 'path'\n@@ -30,7 +29,7 @@ const runTests = (isDev: boolean) => {\n     )\n     expect(res.status).toBe(307)\n \n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'))\n \n     expect(pathname).toBe('/404')\n   })\n@@ -46,7 +45,7 @@ const runTests = (isDev: boolean) => {\n     )\n     expect(res.status).toBe(308)\n \n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'))\n \n     expect(pathname).toBe('/404')\n     expect(res.headers.get('refresh')).toMatch(/url=\\/404/)\n@@ -63,7 +62,7 @@ const runTests = (isDev: boolean) => {\n     )\n     expect(res.status).toBe(301)\n \n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'))\n \n     expect(pathname).toBe('/404')\n     expect(res.headers.get('refresh')).toBe(null)\n@@ -80,7 +79,7 @@ const runTests = (isDev: boolean) => {\n     )\n     expect(res.status).toBe(303)\n \n-    const { pathname } = url.parse(res.headers.get('location'))\n+    const { pathname } = new URL(res.headers.get('location'))\n \n     expect(pathname).toBe('/404')\n     expect(res.headers.get('refresh')).toBe(null)\n@@ -104,7 +103,7 @@ const runTests = (isDev: boolean) => {\n       },\n     })\n     const initialHref = await browser.eval(() => (window as any).initialHref)\n-    const { pathname } = url.parse(initialHref)\n+    const { pathname } = new URL(initialHref)\n     expect(pathname).toBe('/gsp-blog/redirect-dest-_gsp-blog_first')\n   })\n \n@@ -126,7 +125,7 @@ const runTests = (isDev: boolean) => {\n       },\n     })\n     const initialHref = await browser.eval(() => (window as any).initialHref)\n-    const { pathname } = url.parse(initialHref)\n+    const { pathname } = new URL(initialHref)\n     expect(pathname).toBe('/gsp-blog/first')\n   })\n \n@@ -148,7 +147,7 @@ const runTests = (isDev: boolean) => {\n       },\n     })\n     const initialHref = await browser.eval(() => (window as any).initialHref)\n-    const { pathname } = url.parse(initialHref)\n+    const { pathname } = new URL(initialHref)\n     expect(pathname).toBe('/gsp-blog/first')\n   })\n \n@@ -170,7 +169,7 @@ const runTests = (isDev: boolean) => {\n       },\n     })\n     const initialHref = await browser.eval(() => (window as any).initialHref)\n-    const { pathname } = url.parse(initialHref)\n+    const { pathname } = new URL(initialHref)\n     expect(pathname).toBe('/gsp-blog/first')\n   })\n \n@@ -192,7 +191,7 @@ const runTests = (isDev: boolean) => {\n       },\n     })\n     const initialHref = await browser.eval(() => (window as any).initialHref)\n-    const { pathname } = url.parse(initialHref)\n+    const { pathname } = new URL(initialHref)\n     expect(pathname).toBe('/gsp-blog/first')\n   })\n \n@@ -215,7 +214,7 @@ const runTests = (isDev: boolean) => {\n         },\n       })\n       const initialHref = await browser.eval(() => (window as any).initialHref)\n-      const { pathname } = url.parse(initialHref)\n+      const { pathname } = new URL(initialHref)\n       // since it was cached the initial value is now the redirect\n       // result\n       expect(pathname).toBe('/gsp-blog/first')\n@@ -230,7 +229,7 @@ const runTests = (isDev: boolean) => {\n     await browser.waitForElementByCss('#index')\n \n     const initialHref = await browser.eval(() => (window as any).initialHref)\n-    const { pathname } = url.parse(initialHref)\n+    const { pathname } = new URL(initialHref)\n     expect(pathname).toBe('/gsp-blog/redirect-dest-_')\n   })\n \n@@ -243,7 +242,7 @@ const runTests = (isDev: boolean) => {\n       await browser.waitForElementByCss('#index')\n \n       const initialHref = await browser.eval(() => (window as any).initialHref)\n-      const { pathname } = url.parse(initialHref)\n+      const { pathname } = new URL(initialHref)\n       expect(pathname).toBe('/')\n     })\n   }\n@@ -266,7 +265,7 @@ const runTests = (isDev: boolean) => {\n     expect(initialHref).toBeFalsy()\n \n     const curUrl = await browser.url()\n-    const { pathname } = url.parse(curUrl)\n+    const { pathname } = new URL(curUrl)\n     expect(pathname).toBe('/missing')\n   })\n \n@@ -315,7 +314,7 @@ const runTests = (isDev: boolean) => {\n     )\n     expect(res.status).toBe(307)\n \n-    const parsed = url.parse(res.headers.get('location'))\n+    const parsed = new URL(res.headers.get('location'))\n     expect(parsed.hostname).toBe('example.vercel.sh')\n     expect(parsed.pathname).toBe('/')\n   })\n@@ -427,8 +426,8 @@ const runTests = (isDev: boolean) => {\n     })()`)\n \n     const curUrl = await browser.url()\n-    const { path } = url.parse(curUrl)\n-    expect(path).toEqual('/')\n+    const { pathname, search } = new URL(curUrl)\n+    expect(pathname + search).toEqual('/')\n   })\n \n   it('should not replace history of the origin page when GSSP page is navigated to client-side (external)', async () => {\n@@ -451,8 +450,8 @@ const runTests = (isDev: boolean) => {\n     })()`)\n \n     const curUrl = await browser.url()\n-    const { path } = url.parse(curUrl)\n-    expect(path).toEqual('/')\n+    const { pathname, search } = new URL(curUrl)\n+    expect(pathname + search).toEqual('/')\n   })\n \n   it('should not replace history of the origin page when GSP page is navigated to client-side (internal)', async () => {\n@@ -475,8 +474,8 @@ const runTests = (isDev: boolean) => {\n     })()`)\n \n     const curUrl = await browser.url()\n-    const { path } = url.parse(curUrl)\n-    expect(path).toEqual('/')\n+    const { pathname, search } = new URL(curUrl)\n+    expect(pathname + search).toEqual('/')\n   })\n \n   it('should not replace history of the origin page when GSP page is navigated to client-side (external)', async () => {\n@@ -499,8 +498,8 @@ const runTests = (isDev: boolean) => {\n     })()`)\n \n     const curUrl = await browser.url()\n-    const { path } = url.parse(curUrl)\n-    expect(path).toEqual('/')\n+    const { pathname, search } = new URL(curUrl)\n+    expect(pathname + search).toEqual('/')\n   })\n }\n "
        },
        {
            "sha": "1265148d64a2237edf823157602e82360a714d38",
            "filename": "test/integration/i18n-support/test/index.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fi18n-support%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fi18n-support%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fi18n-support%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,4 +1,3 @@\n-import url from 'url'\n import http from 'http'\n import fs from 'fs-extra'\n import { join } from 'path'\n@@ -238,9 +237,10 @@ describe('i18n Support', () => {\n             )\n             hrefs.sort()\n \n+            const baseURL = await browser.url()\n             assert.deepEqual(\n               hrefs.map((href) =>\n-                new URL(href).pathname\n+                new URL(href, baseURL).pathname\n                   .replace(ctx.basePath, '')\n                   .replace(/^\\/_next\\/data\\/[^/]+/, '')\n               ),\n@@ -287,9 +287,11 @@ describe('i18n Support', () => {\n           } else {\n             expect(res.status).toBe(307)\n \n-            const parsed = url.parse(res.headers.get('location'), true)\n+            const parsed = new URL(res.headers.get('location'), res.url)\n             expect(parsed.pathname).toBe(`/${locale}/`)\n-            expect(parsed.query).toEqual({})\n+            expect(Object.fromEntries(parsed.searchParams.entries())).toEqual(\n+              {}\n+            )\n           }\n         }\n       })\n@@ -485,9 +487,11 @@ describe('i18n Support', () => {\n           } else {\n             expect(res.status).toBe(307)\n \n-            const parsed = url.parse(res.headers.get('location'), true)\n+            const parsed = new URL(res.headers.get('location'), res.url)\n             expect(parsed.pathname).toBe(`/${locale}`)\n-            expect(parsed.query).toEqual({})\n+            expect(Object.fromEntries(parsed.searchParams.entries())).toEqual(\n+              {}\n+            )\n           }\n         }\n       })"
        },
        {
            "sha": "560b828e0fa0051d3d7935a950a348a37ab9ac50",
            "filename": "test/integration/i18n-support/test/shared.ts",
            "status": "renamed",
            "additions": 77,
            "deletions": 80,
            "changes": 157,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fi18n-support%2Ftest%2Fshared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Fi18n-support%2Ftest%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fi18n-support%2Ftest%2Fshared.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,6 +1,5 @@\n /* eslint-env jest */\n \n-import url from 'url'\n import glob from 'glob'\n import fs from 'fs-extra'\n import cheerio from 'cheerio'\n@@ -372,7 +371,10 @@ export function runTests(ctx) {\n       ctx.basePath || '/'\n     )\n \n-    await browser.get(browser.initUrl)\n+    await browser.get(\n+      // @ts-expect-error found when converting to TypeScript\n+      browser.initUrl\n+    )\n     await browser.waitForElementByCss('#index')\n \n     await browser.eval(`(function() {\n@@ -483,6 +485,7 @@ export function runTests(ctx) {\n       `${ctx.basePath || ''}/links?nextLocale=go`\n     )\n \n+    let baseURL = await browser.url()\n     for (const [element, pathname] of [\n       ['#to-another', '/another'],\n       ['#to-gsp', '/gsp'],\n@@ -492,7 +495,7 @@ export function runTests(ctx) {\n       ['#to-gssp-slug', '/gssp/first'],\n     ]) {\n       const href = await browser.elementByCss(element).getAttribute('href')\n-      const { hostname, pathname: hrefPathname } = url.parse(href)\n+      const { hostname, pathname: hrefPathname } = new URL(href, baseURL)\n       expect(hostname).not.toBe('example.com')\n       expect(hrefPathname).toBe(`${ctx.basePath || ''}/go${pathname}`)\n     }\n@@ -502,6 +505,7 @@ export function runTests(ctx) {\n       `${ctx.basePath || ''}/links?nextLocale=go-BE`\n     )\n \n+    baseURL = await browser.url()\n     for (const [element, pathname] of [\n       ['#to-another', '/another'],\n       ['#to-gsp', '/gsp'],\n@@ -511,7 +515,7 @@ export function runTests(ctx) {\n       ['#to-gssp-slug', '/gssp/first'],\n     ]) {\n       const href = await browser.elementByCss(element).getAttribute('href')\n-      const { hostname, pathname: hrefPathname } = url.parse(href)\n+      const { hostname, pathname: hrefPathname } = new URL(href, baseURL)\n       expect(hostname).not.toBe('example.com')\n       expect(hrefPathname).toBe(`${ctx.basePath || ''}/go-BE${pathname}`)\n     }\n@@ -1891,21 +1895,21 @@ export function runTests(ctx) {\n       ['/en/another/', '/en/another', 'localhost', {}],\n       ['/fr/', '/fr', 'localhost', {}],\n       ['/fr/another/', '/fr/another', 'localhost', {}],\n-    ]) {\n+    ] as const) {\n       const res = await fetchViaHTTP(ctx.appPort, testPath, undefined, {\n         redirect: 'manual',\n       })\n       expect(res.status).toBe(308)\n \n-      const parsed = url.parse(res.headers.get('location'), true)\n+      const parsed = new URL(res.headers.get('location'))\n       expect(parsed.pathname).toBe(path)\n \n       if (hostname === 'localhost') {\n         expect(parsed.hostname).toBeOneOf([hostname, '127.0.0.1'])\n       } else {\n         expect(parsed.hostname).toBe(hostname)\n       }\n-      expect(parsed.query).toEqual(query)\n+      expect(Object.fromEntries(parsed.searchParams.entries())).toEqual(query)\n     }\n   })\n \n@@ -1933,11 +1937,11 @@ export function runTests(ctx) {\n       expect(res.status).toBe(shouldRedirect ? 307 : 200)\n \n       if (shouldRedirect) {\n-        const parsed = url.parse(res.headers.get('location'), true)\n+        const parsed = new URL(res.headers.get('location'))\n         expect(parsed.pathname).toBe(\n           `${ctx.basePath}${locale || ''}${pathname || '/somewhere-else'}`\n         )\n-        expect(parsed.query).toEqual({})\n+        expect(Object.fromEntries(parsed.searchParams.entries())).toEqual({})\n       }\n     }\n   })\n@@ -1951,7 +1955,7 @@ export function runTests(ctx) {\n       ['/add-header-3', true],\n       ['/en/add-header-3', true],\n       ['/nl-NL/add-header-3', true],\n-    ]) {\n+    ] as const) {\n       const res = await fetchViaHTTP(\n         ctx.appPort,\n         `${ctx.basePath}${path}`,\n@@ -2201,9 +2205,9 @@ export function runTests(ctx) {\n     ).toEqual({})\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('fr')\n \n-    let parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    let parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/fr/another`)\n-    expect(parsedUrl.query).toEqual({})\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n \n     await browser.eval('window.history.back()')\n     await browser.waitForElementByCss('#links')\n@@ -2223,9 +2227,11 @@ export function runTests(ctx) {\n       'en-US'\n     )\n \n-    parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/links`)\n-    expect(parsedUrl.query).toEqual({ nextLocale: 'fr' })\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({\n+      nextLocale: 'fr',\n+    })\n \n     await browser.eval('window.history.forward()')\n     await browser.waitForElementByCss('#another')\n@@ -2245,9 +2251,9 @@ export function runTests(ctx) {\n     ).toEqual({})\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('fr')\n \n-    parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/fr/another`)\n-    expect(parsedUrl.query).toEqual({})\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n     expect(await browser.eval('window.beforeNav')).toBe(1)\n     expect(await browser.eval('window.caughtWarns')).toEqual([])\n   })\n@@ -2293,9 +2299,9 @@ export function runTests(ctx) {\n     ).toEqual({ slug: 'first' })\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('nl')\n \n-    let parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    let parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/nl/gsp/fallback/first`)\n-    expect(parsedUrl.query).toEqual({})\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n \n     await browser.eval('window.history.back()')\n     await browser.waitForElementByCss('#links')\n@@ -2315,9 +2321,11 @@ export function runTests(ctx) {\n       'en-US'\n     )\n \n-    parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/links`)\n-    expect(parsedUrl.query).toEqual({ nextLocale: 'nl' })\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({\n+      nextLocale: 'nl',\n+    })\n \n     await browser.eval('window.history.forward()')\n     await browser.waitForElementByCss('#gsp')\n@@ -2337,9 +2345,9 @@ export function runTests(ctx) {\n     ).toEqual({ slug: 'first' })\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('nl')\n \n-    parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/nl/gsp/fallback/first`)\n-    expect(parsedUrl.query).toEqual({})\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n     expect(await browser.eval('window.beforeNav')).toBe(1)\n     expect(await browser.eval('window.caughtWarns')).toEqual([])\n   })\n@@ -2415,9 +2423,9 @@ export function runTests(ctx) {\n     ).toEqual({})\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('fr')\n \n-    let parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    let parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/fr/another`)\n-    expect(parsedUrl.query).toEqual({})\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n \n     await browser.eval('window.history.back()')\n     await browser.waitForElementByCss('#links')\n@@ -2439,9 +2447,11 @@ export function runTests(ctx) {\n       'en-US'\n     )\n \n-    parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/locale-false`)\n-    expect(parsedUrl.query).toEqual({ nextLocale: 'fr' })\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({\n+      nextLocale: 'fr',\n+    })\n \n     await browser.eval('window.history.forward()')\n     await browser.waitForElementByCss('#another')\n@@ -2461,9 +2471,9 @@ export function runTests(ctx) {\n     ).toEqual({})\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('fr')\n \n-    parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/fr/another`)\n-    expect(parsedUrl.query).toEqual({})\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n     expect(await browser.eval('window.beforeNav')).toBe(1)\n     expect(await browser.eval('window.caughtWarns')).toEqual([])\n   })\n@@ -2511,9 +2521,9 @@ export function runTests(ctx) {\n     ).toEqual({ slug: 'first' })\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('nl')\n \n-    let parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    let parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/nl/gsp/fallback/first`)\n-    expect(parsedUrl.query).toEqual({})\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n \n     await browser.eval('window.history.back()')\n     await browser.waitForElementByCss('#links')\n@@ -2535,9 +2545,11 @@ export function runTests(ctx) {\n       'en-US'\n     )\n \n-    parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/locale-false`)\n-    expect(parsedUrl.query).toEqual({ nextLocale: 'nl' })\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({\n+      nextLocale: 'nl',\n+    })\n \n     await browser.eval('window.history.forward()')\n     await browser.waitForElementByCss('#gsp')\n@@ -2557,9 +2569,9 @@ export function runTests(ctx) {\n     ).toEqual({ slug: 'first' })\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('nl')\n \n-    parsedUrl = url.parse(await browser.eval('window.location.href'), true)\n+    parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/nl/gsp/fallback/first`)\n-    expect(parsedUrl.query).toEqual({})\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n     expect(await browser.eval('window.beforeNav')).toBe(1)\n     expect(await browser.eval('window.caughtWarns')).toEqual([])\n   })\n@@ -2666,7 +2678,7 @@ export function runTests(ctx) {\n \n     expect(res.status).toBe(200)\n \n-    // const result = url.parse(res.headers.get('location'), true)\n+    // const result = new URL(res.headers.get('location'), true)\n     // expect(result.pathname).toBe('/')\n     // expect(result.query).toEqual({})\n \n@@ -2684,7 +2696,7 @@ export function runTests(ctx) {\n \n     expect(res2.status).toBe(200)\n \n-    // const result2 = url.parse(res2.headers.get('location'), true)\n+    // const result2 = new URL(res2.headers.get('location'), true)\n     // expect(result2.pathname).toBe('/')\n     // expect(result2.query).toEqual({})\n   })\n@@ -2699,7 +2711,7 @@ export function runTests(ctx) {\n \n   //   expect(res.status).toBe(307)\n \n-  //   const parsedUrl = url.parse(res.headers.get('location'), true)\n+  //   const parsedUrl = new URL(res.headers.get('location'), true)\n   //   expect(parsedUrl.pathname).toBe('/')\n   //   expect(parsedUrl.query).toEqual({})\n   //   expect(res.headers.get('set-cookie')).toContain('NEXT_LOCALE=en-US')\n@@ -2814,13 +2826,15 @@ export function runTests(ctx) {\n           }\n \n           if (shouldRedirect) {\n-            const parsedUrl = url.parse(res.headers.get('location'), true)\n+            const parsedUrl = new URL(res.headers.get('location'))\n \n             const expectedPathname = `/${\n               expectedDomainItem.defaultLocale === locale ? '' : locale\n             }`\n             expect(parsedUrl.pathname).toBe(expectedPathname)\n-            expect(parsedUrl.query).toEqual({})\n+            expect(\n+              Object.fromEntries(parsedUrl.searchParams.entries())\n+            ).toEqual({})\n             expect(parsedUrl.hostname).toBe(expectedDomainItem.domain)\n           } else {\n             const html = await res.text()\n@@ -2939,8 +2953,8 @@ export function runTests(ctx) {\n         const pagePath = join(ctx.buildPagesDir, locale, 'not-found.html')\n         const dataPath = join(ctx.buildPagesDir, locale, 'not-found.json')\n         console.log(pagePath)\n-        expect(await fs.exists(pagePath)).toBe(!skippedLocales.includes(locale))\n-        expect(await fs.exists(dataPath)).toBe(!skippedLocales.includes(locale))\n+        expect(fs.existsSync(pagePath)).toBe(!skippedLocales.includes(locale))\n+        expect(fs.existsSync(dataPath)).toBe(!skippedLocales.includes(locale))\n       }\n     })\n   }\n@@ -2972,12 +2986,9 @@ export function runTests(ctx) {\n         expect(props.is404).toBe(true)\n         expect(props.locale).toBe(locale)\n \n-        const parsedUrl = url.parse(\n-          await browser.eval('window.location.href'),\n-          true\n-        )\n+        const parsedUrl = new URL(await browser.eval('window.location.href'))\n         expect(parsedUrl.pathname).toBe(`${ctx.basePath}/${locale}/not-found`)\n-        expect(parsedUrl.query).toEqual({})\n+        expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n       }\n     }\n   })\n@@ -3004,7 +3015,7 @@ export function runTests(ctx) {\n     expect(await browser.elementByCss('#router-pathname').text()).toBe('/frank')\n     expect(await browser.elementByCss('#router-as-path').text()).toBe('/frank')\n     expect(\n-      url.parse(await browser.eval(() => window.location.href)).pathname\n+      new URL(await browser.eval(() => window.location.href)).pathname\n     ).toBe(`${ctx.basePath}/fr/frank`)\n     expect(await browser.eval('window.beforeNav')).toBe(1)\n   })\n@@ -3048,15 +3059,11 @@ export function runTests(ctx) {\n     expect(props.locale).toBe('en')\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('en')\n \n-    const parsedUrl = url.parse(\n-      await browser.eval('window.location.href'),\n-      true\n-    )\n+    const parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(\n       `${ctx.basePath}/en/not-found/fallback/first`\n     )\n-    expect(parsedUrl.query).toEqual({})\n-\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n     if (ctx.isDev) {\n       // make sure page doesn't reload un-necessarily in development\n       await waitFor(10 * 1000)\n@@ -3084,15 +3091,11 @@ export function runTests(ctx) {\n     expect(props.locale).toBe('en')\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('en')\n \n-    const parsedUrl = url.parse(\n-      await browser.eval('window.location.href'),\n-      true\n-    )\n+    const parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(\n       `${ctx.basePath}/en/not-found/fallback/first`\n     )\n-    expect(parsedUrl.query).toEqual({})\n-\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n     if (ctx.isDev) {\n       // make sure page doesn't reload un-necessarily in development\n       await waitFor(10 * 1000)\n@@ -3119,15 +3122,11 @@ export function runTests(ctx) {\n     expect(props.locale).toBe('en')\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('en')\n \n-    const parsedUrl = url.parse(\n-      await browser.eval('window.location.href'),\n-      true\n-    )\n+    const parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(\n       `${ctx.basePath}/en/not-found/blocking-fallback/first`\n     )\n-    expect(parsedUrl.query).toEqual({})\n-\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n     if (ctx.isDev) {\n       // make sure page doesn't reload un-necessarily in development\n       await waitFor(10 * 1000)\n@@ -3155,15 +3154,11 @@ export function runTests(ctx) {\n     expect(props.locale).toBe('en')\n     expect(await browser.elementByCss('html').getAttribute('lang')).toBe('en')\n \n-    const parsedUrl = url.parse(\n-      await browser.eval('window.location.href'),\n-      true\n-    )\n+    const parsedUrl = new URL(await browser.eval('window.location.href'))\n     expect(parsedUrl.pathname).toBe(\n       `${ctx.basePath}/en/not-found/blocking-fallback/first`\n     )\n-    expect(parsedUrl.query).toEqual({})\n-\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n     if (ctx.isDev) {\n       // make sure page doesn't reload un-necessarily in development\n       await waitFor(10 * 1000)\n@@ -3186,7 +3181,7 @@ export function runTests(ctx) {\n \n     expect(res.status).toBe(200)\n \n-    // const parsedUrl = url.parse(res.headers.get('location'), true)\n+    // const parsedUrl = new URL(res.headers.get('location'), true)\n \n     // expect(parsedUrl.pathname).toBe('/')\n     // expect(parsedUrl.query).toEqual({})\n@@ -3206,7 +3201,7 @@ export function runTests(ctx) {\n \n     expect(res2.status).toBe(200)\n \n-    // const parsedUrl2 = url.parse(res.headers.get('location'), true)\n+    // const parsedUrl2 = new URL(res.headers.get('location'), true)\n \n     // expect(parsedUrl2.pathname).toBe('/')\n     // expect(parsedUrl2.query).toEqual({})\n@@ -3290,9 +3285,9 @@ export function runTests(ctx) {\n     )\n     expect(res.status).toBe(307)\n \n-    const parsedUrl = url.parse(res.headers.get('location'), true)\n+    const parsedUrl = new URL(res.headers.get('location'))\n     expect(parsedUrl.pathname).toBe(`${ctx.basePath}/nl-NL`)\n-    expect(parsedUrl.query).toEqual({})\n+    expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n \n     const res2 = await fetchViaHTTP(\n       ctx.appPort,\n@@ -3307,9 +3302,11 @@ export function runTests(ctx) {\n     )\n     expect(res2.status).toBe(307)\n \n-    const parsedUrl2 = url.parse(res2.headers.get('location'), true)\n+    const parsedUrl2 = new URL(res2.headers.get('location'))\n     expect(parsedUrl2.pathname).toBe(`${ctx.basePath}/en`)\n-    expect(parsedUrl2.query).toEqual({ hello: 'world' })\n+    expect(Object.fromEntries(parsedUrl2.searchParams.entries())).toEqual({\n+      hello: 'world',\n+    })\n   })\n \n   it('should use default locale for / without accept-language', async () => {\n@@ -3450,7 +3447,7 @@ export function runTests(ctx) {\n       expect(await browser.elementByCss('#router-pathname').text()).toBe('/')\n       expect(await browser.elementByCss('#router-as-path').text()).toBe('/')\n       expect(\n-        url.parse(await browser.eval(() => window.location.href)).pathname\n+        new URL(await browser.eval(() => window.location.href)).pathname\n       ).toBe(`${ctx.basePath || '/'}`)\n     }\n \n@@ -3478,7 +3475,7 @@ export function runTests(ctx) {\n       '/another'\n     )\n     expect(\n-      url.parse(await browser.eval(() => window.location.href)).pathname\n+      new URL(await browser.eval(() => window.location.href)).pathname\n     ).toBe(`${ctx.basePath}/another`)\n \n     await browser.elementByCss('#to-index').click()\n@@ -3504,7 +3501,7 @@ export function runTests(ctx) {\n     expect(await browser.elementByCss('#router-pathname').text()).toBe('/gsp')\n     expect(await browser.elementByCss('#router-as-path').text()).toBe('/gsp')\n     expect(\n-      url.parse(await browser.eval(() => window.location.href)).pathname\n+      new URL(await browser.eval(() => window.location.href)).pathname\n     ).toBe(`${ctx.basePath}/gsp`)\n \n     await browser.elementByCss('#to-index').click()",
            "previous_filename": "test/integration/i18n-support/test/shared.js"
        },
        {
            "sha": "533be7c5469ff64f7bd79fd311a3e00ba56768e0",
            "filename": "test/integration/repeated-slashes/test/index.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 15,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Frepeated-slashes%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fintegration%2Frepeated-slashes%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Frepeated-slashes%2Ftest%2Findex.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,7 +1,6 @@\n /* eslint-env jest */\n import { join } from 'path'\n import fs from 'fs-extra'\n-import url from 'url'\n import webdriver from 'next-webdriver'\n import escapeRegex from 'escape-string-regexp'\n import {\n@@ -66,11 +65,11 @@ function runTests({ isDev = false, isExport = false, isPages404 = false }) {\n       )\n \n       expect(res.status).toBe(307)\n-      const parsedUrl = url.parse(res.headers.get('location'), true)\n+      const parsedUrl = new URL(res.headers.get('location'))\n \n       expect(parsedUrl.hostname).toBeOneOf(['localhost', '127.0.0.1'])\n       expect(parsedUrl.pathname).toBe('/test/google.com')\n-      expect(parsedUrl.query).toEqual({})\n+      expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n       expect(await res.text()).toBe('/test/google.com')\n \n       const res2 = await fetchViaHTTP(\n@@ -83,11 +82,11 @@ function runTests({ isDev = false, isExport = false, isPages404 = false }) {\n       )\n \n       expect(res2.status).toBe(307)\n-      const parsedUrl2 = url.parse(res2.headers.get('location'), true)\n+      const parsedUrl2 = new URL(res2.headers.get('location'))\n \n       expect(parsedUrl2.hostname).toBeOneOf(['localhost', '127.0.0.1'])\n       expect(parsedUrl2.pathname).toBe('/test/google.com')\n-      expect(parsedUrl2.query).toEqual({})\n+      expect(Object.fromEntries(parsedUrl2.searchParams.entries())).toEqual({})\n       expect(await res2.text()).toBe('/test/google.com')\n     })\n   }\n@@ -99,10 +98,10 @@ function runTests({ isDev = false, isExport = false, isPages404 = false }) {\n       })\n       expect(res.status).toBe(308)\n \n-      const parsedUrl = url.parse(res.headers.get('location'), true)\n+      const parsedUrl = new URL(res.headers.get('location'))\n       expect(parsedUrl.pathname).toBe('/google.com')\n       expect(parsedUrl.hostname).toBeOneOf(['localhost', '127.0.0.1'])\n-      expect(parsedUrl.query).toEqual({})\n+      expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n     }\n \n     const browser = await webdriver(appPort, '//google.com')\n@@ -128,10 +127,12 @@ function runTests({ isDev = false, isExport = false, isPages404 = false }) {\n         }\n       )\n       expect(res.status).toBe(308)\n-      const parsedUrl = url.parse(res.headers.get('location'), true)\n+      const parsedUrl = new URL(res.headers.get('location'))\n       expect(parsedUrl.pathname).toBe('/google.com')\n       expect(parsedUrl.hostname).toBeOneOf(['localhost', '127.0.0.1'])\n-      expect(parsedUrl.query).toEqual({ h: '1' })\n+      expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({\n+        h: '1',\n+      })\n     }\n \n     const browser = await webdriver(appPort, '//google.com?h=1')\n@@ -152,10 +153,10 @@ function runTests({ isDev = false, isExport = false, isPages404 = false }) {\n         redirect: 'manual',\n       })\n       expect(res.status).toBe(308)\n-      const parsedUrl = url.parse(res.headers.get('location'), true)\n+      const parsedUrl = new URL(res.headers.get('location'))\n       expect(parsedUrl.pathname).toBe('/google.com')\n       expect(parsedUrl.hostname).toBeOneOf(['localhost', '127.0.0.1'])\n-      expect(parsedUrl.query).toEqual({})\n+      expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n     }\n \n     const browser = await webdriver(appPort, '//google.com#hello')\n@@ -240,10 +241,10 @@ function runTests({ isDev = false, isExport = false, isPages404 = false }) {\n         redirect: 'manual',\n       })\n       expect(res.status).toBe(308)\n-      const parsedUrl = url.parse(res.headers.get('location'), true)\n+      const parsedUrl = new URL(res.headers.get('location'))\n       expect(parsedUrl.pathname).toBe('/google.com')\n       expect(parsedUrl.hostname).toBeOneOf(['localhost', '127.0.0.1'])\n-      expect(parsedUrl.query).toEqual({})\n+      expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n       expect(await res.text()).toBe('/google.com')\n     }\n \n@@ -265,10 +266,10 @@ function runTests({ isDev = false, isExport = false, isPages404 = false }) {\n         redirect: 'manual',\n       })\n       expect(res.status).toBe(308)\n-      const parsedUrl = url.parse(res.headers.get('location'), true)\n+      const parsedUrl = new URL(res.headers.get('location'))\n       expect(parsedUrl.pathname).toBe(isExport ? '//google.com' : '/google.com')\n       expect(parsedUrl.hostname).toBeOneOf(['localhost', '127.0.0.1'])\n-      expect(parsedUrl.query).toEqual({})\n+      expect(Object.fromEntries(parsedUrl.searchParams.entries())).toEqual({})\n       expect(await res.text()).toBe('/google.com')\n     }\n "
        },
        {
            "sha": "8b9b14e4cdc9809cf86d3750ccf75e645cc7d1bd",
            "filename": "test/production/app-dir/app-edge-middleware/app-edge-middleware.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fproduction%2Fapp-dir%2Fapp-edge-middleware%2Fapp-edge-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fproduction%2Fapp-dir%2Fapp-edge-middleware%2Fapp-edge-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fapp-edge-middleware%2Fapp-edge-middleware.test.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -54,7 +54,7 @@ describe('app edge middleware', () => {\n         `,\n         'middleware.js': `\n           import { NextResponse } from 'next/server';\n-          import { parse } from 'url';\n+          import { URL } from 'url';\n           export async function middleware() { \n             return NextResponse.next() \n           }"
        },
        {
            "sha": "0a1cb266d129f8f4f6f2013757d9d25392959917",
            "filename": "test/production/custom-server/server.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fproduction%2Fcustom-server%2Fserver.js",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fproduction%2Fcustom-server%2Fserver.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fserver.js?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -42,6 +42,7 @@ async function main() {\n             await app.render(req, res, '/page-error')\n           } else {\n             parsedUrl.pathname = pathname\n+            // TODO: Accept WHATWG URLs in Next.js request handlers\n             await handle(req, res, parsedUrl)\n           }\n         } catch (err) {"
        },
        {
            "sha": "5fcce76bee23f5bd5bc92fa5070662baaa2031f6",
            "filename": "test/production/pages-dir/production/fixture/pages/another.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fproduction%2Fpages-dir%2Fproduction%2Ffixture%2Fpages%2Fanother.js",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fproduction%2Fpages-dir%2Fproduction%2Ffixture%2Fpages%2Fanother.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fpages-dir%2Fproduction%2Ffixture%2Fpages%2Fanother.js?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -1,7 +1,9 @@\n import url from 'url'\n import Link from 'next/link'\n \n-console.log(url.parse('https://example.com'))\n+// `url` is shimmed partially by Next.js in the browser so we have to test a method\n+// that's not deprected in Node.js but also available in the shim.\n+console.log(url.resolve('/one/two/three', 'four'))\n \n export default () => (\n   <div>"
        },
        {
            "sha": "00faa1d4bcf26a99574034f0eaa785615ecc6865",
            "filename": "test/production/pages-dir/production/test/security.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 18,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Fsecurity.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93cf074e3833779a245bb624ea40b8c801058dc6/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Fsecurity.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Fsecurity.ts?ref=93cf074e3833779a245bb624ea40b8c801058dc6",
            "patch": "@@ -2,7 +2,6 @@\n import webdriver from 'next-webdriver'\n import { readFileSync } from 'fs'\n import http from 'http'\n-import url from 'url'\n import { join } from 'path'\n import { getBrowserBodyText, waitFor, fetchViaHTTP } from 'next-test-utils'\n import { recursiveReadDir } from 'next/dist/lib/recursive-readdir'\n@@ -215,9 +214,7 @@ export default (next: NextInstance) => {\n         }\n       )\n \n-      const { pathname, hostname } = url.parse(\n-        res.headers.get('location') || ''\n-      )\n+      const { pathname, hostname } = new URL(res.headers.get('location') || '')\n       expect(res.status).toBe(307)\n       expect(pathname).toBe(encodeURI('/\\\\google.com/about'))\n       expect(hostname).toBeOneOf(['localhost', '127.0.0.1'])\n@@ -233,9 +230,7 @@ export default (next: NextInstance) => {\n         }\n       )\n \n-      const { pathname, hostname } = url.parse(\n-        res.headers.get('location') || ''\n-      )\n+      const { pathname, hostname } = new URL(res.headers.get('location') || '')\n       expect(res.status).toBe(307)\n       expect(pathname).toBe('/%25google.com/about')\n       expect(hostname).toBeOneOf(['localhost', '127.0.0.1'])\n@@ -251,14 +246,14 @@ export default (next: NextInstance) => {\n         }\n       )\n \n-      const { pathname, hostname, query } = url.parse(\n+      const { pathname, hostname, search } = new URL(\n         res.headers.get('location') || ''\n       )\n       expect(res.status).toBe(308)\n       expect(pathname).toBe('/trailing-redirect')\n       expect(hostname).toBeOneOf(['localhost', '127.0.0.1'])\n-      expect(query).toBe(\n-        'url=https%3A%2F%2Fgoogle.com%2Fimage%3Fcrop%3Dfocalpoint%26w%3D24&w=1200&q=100'\n+      expect(search).toBe(\n+        '?url=https%3A%2F%2Fgoogle.com%2Fimage%3Fcrop%3Dfocalpoint%26w%3D24&w=1200&q=100'\n       )\n     })\n \n@@ -272,9 +267,7 @@ export default (next: NextInstance) => {\n         }\n       )\n \n-      const { pathname, hostname } = url.parse(\n-        res.headers.get('location') || ''\n-      )\n+      const { pathname, hostname } = new URL(res.headers.get('location') || '')\n       expect(res.status).toBe(307)\n       expect(pathname).toBe('/%2fgoogle.com/about')\n       expect(hostname).not.toBe('google.com')\n@@ -290,12 +283,12 @@ export default (next: NextInstance) => {\n         }\n       )\n \n-      const { pathname, hostname, query } = url.parse(\n+      const { pathname, hostname, search } = new URL(\n         res.headers.get('location') || ''\n       )\n       expect(res.status).toBe(307)\n       expect(pathname).toBe('/about')\n-      expect(query).toBe('foo=%2Fgoogle.com')\n+      expect(search).toBe('?foo=%2Fgoogle.com')\n       expect(hostname).not.toBe('google.com')\n       expect(hostname).not.toMatch(/google/)\n     })\n@@ -308,9 +301,7 @@ export default (next: NextInstance) => {\n         { redirect: 'manual' }\n       )\n \n-      const { pathname, hostname } = url.parse(\n-        res.headers.get('location') || ''\n-      )\n+      const { pathname, hostname } = new URL(res.headers.get('location') || '')\n       expect(res.status).toBe(308)\n       expect(pathname).toBe('/%2fexample.com')\n       expect(hostname).not.toBe('example.com')"
        }
    ],
    "stats": {
        "total": 508,
        "additions": 258,
        "deletions": 250
    }
}