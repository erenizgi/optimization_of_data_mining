{
    "author": "wbinnssmith",
    "message": "Built-in app loader plugin for additional bundler (#76017)\n\nPorted from https://github.com/vercel/next.js/tree/wbinnssmith/try-ci-test, originally by @hardfist.\n\nAdds support for a built-in app loader through the `BUILTIN_APP_LOADER` environment variable.",
    "sha": "b32b656a6bf6442259916415091be5e66bf9c5b9",
    "files": [
        {
            "sha": "aa424a41731f9825a66e2b169bc143208ec83e70",
            "filename": "packages/next/src/build/entries.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/b32b656a6bf6442259916415091be5e66bf9c5b9/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b32b656a6bf6442259916415091be5e66bf9c5b9/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts?ref=b32b656a6bf6442259916415091be5e66bf9c5b9",
            "patch": "@@ -13,7 +13,7 @@ import * as Log from './output/log'\n import type { LoadedEnvFiles } from '@next/env'\n import type { AppLoaderOptions } from './webpack/loaders/next-app-loader'\n \n-import { posix, join, dirname, extname } from 'path'\n+import { posix, join, dirname, extname, normalize } from 'path'\n import { stringify } from 'querystring'\n import fs from 'fs'\n import {\n@@ -474,9 +474,18 @@ export function getInstrumentationEntry(opts: {\n   }\n }\n \n+export function getAppLoader() {\n+  return process.env.BUILTIN_APP_LOADER\n+    ? `builtin:next-app-loader`\n+    : 'next-app-loader'\n+}\n+\n export function getAppEntry(opts: Readonly<AppLoaderOptions>) {\n+  if (process.env.NEXT_RSPACK && process.env.BUILTIN_APP_LOADER) {\n+    ;(opts as any).projectRoot = normalize(join(__dirname, '../../..'))\n+  }\n   return {\n-    import: `next-app-loader?${stringify(opts)}!`,\n+    import: `${getAppLoader()}?${stringify(opts)}!`,\n     layer: WEBPACK_LAYERS.reactServerComponents,\n   }\n }"
        },
        {
            "sha": "eb394740fcf44f5105f7bc97adf10a6c4d0406b5",
            "filename": "packages/next/src/build/webpack/plugins/wellknown-errors-plugin/parseNextAppLoaderError.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/b32b656a6bf6442259916415091be5e66bf9c5b9/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fwellknown-errors-plugin%2FparseNextAppLoaderError.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b32b656a6bf6442259916415091be5e66bf9c5b9/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fwellknown-errors-plugin%2FparseNextAppLoaderError.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fwellknown-errors-plugin%2FparseNextAppLoaderError.ts?ref=b32b656a6bf6442259916415091be5e66bf9c5b9",
            "patch": "@@ -1,14 +1,15 @@\n import type { webpack } from 'next/dist/compiled/webpack/webpack'\n import { relative } from 'path'\n import { SimpleWebpackError } from './simpleWebpackError'\n+import { getAppLoader } from '../../../entries'\n \n export function getNextAppLoaderError(\n   err: Error,\n   module: any,\n   compiler: webpack.Compiler\n ): SimpleWebpackError | false {\n   try {\n-    if (!module.loaders[0].loader.includes('next-app-loader')) {\n+    if (!module.loaders[0].loader.includes(getAppLoader())) {\n       return false\n     }\n "
        },
        {
            "sha": "bdee72f299ec23d22b7f17e322bf40bfa8cc4a51",
            "filename": "packages/next/src/build/webpack/utils.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/b32b656a6bf6442259916415091be5e66bf9c5b9/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b32b656a6bf6442259916415091be5e66bf9c5b9/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Futils.ts?ref=b32b656a6bf6442259916415091be5e66bf9c5b9",
            "patch": "@@ -7,6 +7,7 @@ import type {\n   ModuleGraph,\n } from 'webpack'\n import type { ModuleGraphConnection } from 'webpack'\n+import { getAppLoader } from '../entries'\n \n export function traverseModules(\n   compilation: Compilation,\n@@ -61,7 +62,7 @@ export function forEachEntryModule(\n     if (\n       !request.startsWith('next-edge-ssr-loader?') &&\n       !request.startsWith('next-edge-app-route-loader?') &&\n-      !request.startsWith('next-app-loader?')\n+      !request.startsWith(`${getAppLoader()}?`)\n     )\n       continue\n \n@@ -74,7 +75,7 @@ export function forEachEntryModule(\n     ) {\n       entryModule.dependencies.forEach((dependency) => {\n         const modRequest: string | undefined = (dependency as any).request\n-        if (modRequest?.includes('next-app-loader')) {\n+        if (modRequest?.includes(getAppLoader())) {\n           entryModule = compilation.moduleGraph.getResolvedModule(dependency)\n         }\n       })"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 16,
        "deletions": 5
    }
}