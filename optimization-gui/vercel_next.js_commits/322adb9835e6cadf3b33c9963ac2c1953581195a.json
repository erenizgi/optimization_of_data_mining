{
    "author": "eps1lon",
    "message": "[devtools] Fix Turbopack indicator (#80753)",
    "sha": "322adb9835e6cadf3b33c9963ac2c1953581195a",
    "files": [
        {
            "sha": "e9a3a45d94c85c02a16b45997cd2060dcf3e1cb3",
            "filename": "packages/next/next-devtools.webpack-config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/322adb9835e6cadf3b33c9963ac2c1953581195a/packages%2Fnext%2Fnext-devtools.webpack-config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/322adb9835e6cadf3b33c9963ac2c1953581195a/packages%2Fnext%2Fnext-devtools.webpack-config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fnext-devtools.webpack-config.js?ref=322adb9835e6cadf3b33c9963ac2c1953581195a",
            "patch": "@@ -18,7 +18,6 @@ function shouldIgnorePath(modulePath) {\n  */\n module.exports = ({ dev, ...rest }) => {\n   const experimental = false\n-  const turbo = false\n \n   const bundledReactChannel = experimental ? '-experimental' : ''\n \n@@ -52,24 +51,6 @@ module.exports = ({ dev, ...rest }) => {\n     plugins: [\n       // TODO: React Compiler\n       new DevToolsIgnoreListPlugin({ shouldIgnorePath }),\n-      new webpack.DefinePlugin({\n-        // TODO: Hardcode it and ensure module resolution resolves to .node entrypoint in Node.js\n-        // 'typeof window': JSON.stringify('object'),\n-        'process.env.NEXT_MINIMAL': JSON.stringify('true'),\n-        'this.serverOptions.experimentalTestProxy': JSON.stringify(false),\n-        'this.minimalMode': JSON.stringify(true),\n-        'this.renderOpts.dev': JSON.stringify(dev),\n-        'renderOpts.dev': JSON.stringify(dev),\n-        'process.env.NODE_ENV': JSON.stringify(\n-          dev ? 'development' : 'production'\n-        ),\n-        'process.env.__NEXT_EXPERIMENTAL_REACT': JSON.stringify(\n-          experimental ? true : false\n-        ),\n-        'process.env.NEXT_RUNTIME': JSON.stringify('nodejs'),\n-        'process.turbopack': JSON.stringify(turbo),\n-        'process.env.TURBOPACK': JSON.stringify(turbo),\n-      }),\n     ].filter(Boolean),\n     stats: {\n       optimizationBailout: true,"
        },
        {
            "sha": "6936f67e944b39c3187eaf3cb7d40d47713b7ead",
            "filename": "test/development/client-dev-overlay/index.test.ts",
            "status": "modified",
            "additions": 74,
            "deletions": 44,
            "changes": 118,
            "blob_url": "https://github.com/vercel/next.js/blob/322adb9835e6cadf3b33c9963ac2c1953581195a/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/322adb9835e6cadf3b33c9963ac2c1953581195a/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts?ref=322adb9835e6cadf3b33c9963ac2c1953581195a",
            "patch": "@@ -1,32 +1,26 @@\n-import { createNext, FileRef } from 'e2e-utils'\n-import webdriver, { Playwright } from 'next-webdriver'\n-import { NextInstance } from 'e2e-utils'\n+import { FileRef } from 'e2e-utils'\n+import { Playwright } from 'next-webdriver'\n+import { nextTestSetup } from 'e2e-utils'\n import { join } from 'path'\n-import { retry } from 'next-test-utils'\n+import { openDevToolsIndicatorPopover, retry } from 'next-test-utils'\n \n describe('client-dev-overlay', () => {\n-  let next: NextInstance\n-  let browser: Playwright\n-\n-  beforeAll(async () => {\n-    next = await createNext({\n-      files: {\n-        pages: new FileRef(join(__dirname, 'app/pages')),\n-      },\n-      env: {\n-        // Disable the cooldown period for the dev indicator so that hiding the indicator in a test doesn't\n-        // impact subsequent tests.\n-        __NEXT_DEV_INDICATOR_COOLDOWN_MS: '0',\n-      },\n-    })\n-  })\n-  beforeEach(async () => {\n-    browser = await webdriver(next.url, '')\n+  const { next, isTurbopack } = nextTestSetup({\n+    files: {\n+      pages: new FileRef(join(__dirname, 'app/pages')),\n+    },\n+    env: {\n+      // Disable the cooldown period for the dev indicator so that hiding the indicator in a test doesn't\n+      // impact subsequent tests.\n+      __NEXT_DEV_INDICATOR_COOLDOWN_MS: '0',\n+    },\n   })\n-  afterAll(() => next.destroy())\n \n   // The `Playwright.hasElementByCssSelector` cannot be used for elements inside a shadow DOM.\n-  function elementExistsInNextJSPortalShadowDOM(selector: string) {\n+  function elementExistsInNextJSPortalShadowDOM(\n+    browser: Playwright,\n+    selector: string\n+  ) {\n     return browser.eval(\n       `!!document.querySelector('nextjs-portal').shadowRoot.querySelector('${selector}')`\n     ) as any\n@@ -40,45 +34,51 @@ describe('client-dev-overlay', () => {\n     preferencesButton: '[data-preferences]',\n     hideButton: '[data-hide-dev-tools]',\n   }\n-  function getToast() {\n+  function getToast(browser: Playwright) {\n     return browser.elementByCss(selectors.toast)\n   }\n-  function getPopover() {\n+  function getPopover(browser: Playwright) {\n     return browser.elementByCss(selectors.popover)\n   }\n-  function getMinimizeButton() {\n+  function getMinimizeButton(browser: Playwright) {\n     return browser.elementByCss(selectors.minimizeButton)\n   }\n-  function getHideButton() {\n+  function getHideButton(browser: Playwright) {\n     return browser.elementByCss(selectors.hideButton)\n   }\n-  function getPreferencesButton() {\n+  function getPreferencesButton(browser: Playwright) {\n     return browser.elementByCss(selectors.preferencesButton)\n   }\n \n   it('should be able to fullscreen the minimized overlay', async () => {\n-    await getMinimizeButton().click()\n-    await getToast().click()\n+    const browser = await next.browser('/')\n+    await getMinimizeButton(browser).click()\n+    await getToast(browser).click()\n \n     await retry(async () => {\n       expect(\n-        await elementExistsInNextJSPortalShadowDOM(selectors.fullScreenDialog)\n+        await elementExistsInNextJSPortalShadowDOM(\n+          browser,\n+          selectors.fullScreenDialog\n+        )\n       ).toBe(true)\n     })\n   })\n \n   it('should be able to minimize the fullscreen overlay', async () => {\n-    await getMinimizeButton().click()\n-    expect(await elementExistsInNextJSPortalShadowDOM(selectors.toast)).toBe(\n-      true\n-    )\n+    const browser = await next.browser('/')\n+    await getMinimizeButton(browser).click()\n+    expect(\n+      await elementExistsInNextJSPortalShadowDOM(browser, selectors.toast)\n+    ).toBe(true)\n   })\n \n   it('should keep the error indicator visible when there are errors', async () => {\n-    await getMinimizeButton().click()\n-    await getPopover().click()\n-    await getPreferencesButton().click()\n-    await getHideButton().click()\n+    const browser = await next.browser('/')\n+    await getMinimizeButton(browser).click()\n+    await getPopover(browser).click()\n+    await getPreferencesButton(browser).click()\n+    await getHideButton(browser).click()\n \n     await retry(async () => {\n       const display = await browser.eval(\n@@ -89,16 +89,17 @@ describe('client-dev-overlay', () => {\n   })\n \n   it('should be possible to hide the minimized overlay when there are no errors', async () => {\n+    const browser = await next.browser('/')\n     const originalContent = await next.readFile('pages/index.js')\n     try {\n       await next.patchFile('pages/index.js', (content) => {\n         return content.replace(`throw Error('example runtime error')`, '')\n       })\n \n-      await getMinimizeButton().click()\n-      await getPopover().click()\n-      await getPreferencesButton().click()\n-      await getHideButton().click()\n+      await getMinimizeButton(browser).click()\n+      await getPopover(browser).click()\n+      await getPreferencesButton(browser).click()\n+      await getHideButton(browser).click()\n \n       await retry(async () => {\n         const display = await browser.eval(\n@@ -112,10 +113,39 @@ describe('client-dev-overlay', () => {\n   })\n \n   it('should have a role of \"dialog\" if the page is focused', async () => {\n+    const browser = await next.browser('/')\n     await retry(async () => {\n       expect(\n-        await elementExistsInNextJSPortalShadowDOM('[role=\"dialog\"]')\n+        await elementExistsInNextJSPortalShadowDOM(browser, '[role=\"dialog\"]')\n       ).toBe(true)\n     })\n   })\n+\n+  it('should nudge to use Turbopack unless Turbopack is disabled', async () => {\n+    const browser = await next.browser('/')\n+\n+    await openDevToolsIndicatorPopover(browser)\n+\n+    const devtoolsMenu = await browser.elementByCss('#nextjs-dev-tools-menu')\n+    if (isTurbopack) {\n+      expect(await devtoolsMenu.innerText()).toMatchInlineSnapshot(`\n+       \"Issues\n+       1\n+       Route\n+       Static\n+       Turbopack\n+       Enabled\n+       Preferences\"\n+      `)\n+    } else {\n+      expect(await devtoolsMenu.innerText()).toMatchInlineSnapshot(`\n+       \"Issues\n+       1\n+       Route\n+       Static\n+       Try Turbopack\n+       Preferences\"\n+      `)\n+    }\n+  })\n })"
        }
    ],
    "stats": {
        "total": 137,
        "additions": 74,
        "deletions": 63
    }
}