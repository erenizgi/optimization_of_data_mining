{
    "author": "lubieowoce",
    "message": "fix: make webpack handle \"use cache\" in node_modules  (#78606)\n\nTurbopack applies the \"use cache\" transform in node_modules, but Webpack\nwasn't doing that. This is due to a sneaky little regex that controls\nwhether files in node_modules are passed to SWC for transforming or not\n-- `use client` and `use server` were included there, but `use cache`\nwasn't. This PR fixes that.\n\n(I don't really expect NPM packages to use `\"use cache\"` because it's\npretty application-specific, but it might be relevant in a monorepo\nsituation where shared utils that use the directive can live in a\nseparate package)\n\n---------\n\nCo-authored-by: Hendrik Liebau <mail@hendrik-liebau.de>",
    "sha": "a598b5ba3825569da92af6704ed52014fd056267",
    "files": [
        {
            "sha": "15206613a5d72b6b50f561f73ebfdba76823ae25",
            "filename": "packages/next/src/build/webpack/loaders/next-swc-loader.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a598b5ba3825569da92af6704ed52014fd056267/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a598b5ba3825569da92af6704ed52014fd056267/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts?ref=a598b5ba3825569da92af6704ed52014fd056267",
            "patch": "@@ -75,7 +75,7 @@ export interface SWCLoaderOptions {\n // these are exact code conditions checked\n // for to force transpiling a `node_module`\n const FORCE_TRANSPILE_CONDITIONS =\n-  /(next\\/font|next\\/dynamic|use server|use client)/\n+  /next\\/font|next\\/dynamic|use server|use client|use cache/\n \n async function loaderTransform(\n   this: LoaderContext<SWCLoaderOptions> & TelemetryLoaderContext,"
        },
        {
            "sha": "70329c3e4665d7c3ac1568905a9845fcbbc57d74",
            "filename": "packages/next/src/server/request/search-params.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/a598b5ba3825569da92af6704ed52014fd056267/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a598b5ba3825569da92af6704ed52014fd056267/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts?ref=a598b5ba3825569da92af6704ed52014fd056267",
            "patch": "@@ -449,7 +449,7 @@ export function makeErroringExoticSearchParamsForUseCache(\n   const promise = Promise.resolve({})\n \n   const proxiedPromise = new Proxy(promise, {\n-    get(target, prop, receiver) {\n+    get: function get(target, prop, receiver) {\n       if (Object.hasOwn(promise, prop)) {\n         // The promise has this property directly. we must return it. We know it\n         // isn't a dynamic access because it can only be something that was\n@@ -462,12 +462,12 @@ export function makeErroringExoticSearchParamsForUseCache(\n         typeof prop === 'string' &&\n         (prop === 'then' || !wellKnownProperties.has(prop))\n       ) {\n-        throwForSearchParamsAccessInUseCache(workStore)\n+        throwForSearchParamsAccessInUseCache(workStore, get)\n       }\n \n       return ReflectAdapter.get(target, prop, receiver)\n     },\n-    has(target, prop) {\n+    has: function has(target, prop) {\n       // We don't expect key checking to be used except for testing the existence of\n       // searchParams so we make all has tests throw an error. this means that `promise.then`\n       // can resolve to the then function on the Promise prototype but 'then' in promise will assume\n@@ -476,13 +476,13 @@ export function makeErroringExoticSearchParamsForUseCache(\n         typeof prop === 'string' &&\n         (prop === 'then' || !wellKnownProperties.has(prop))\n       ) {\n-        throwForSearchParamsAccessInUseCache(workStore)\n+        throwForSearchParamsAccessInUseCache(workStore, has)\n       }\n \n       return ReflectAdapter.has(target, prop)\n     },\n-    ownKeys() {\n-      throwForSearchParamsAccessInUseCache(workStore)\n+    ownKeys: function ownKeys() {\n+      throwForSearchParamsAccessInUseCache(workStore, ownKeys)\n     },\n   })\n "
        },
        {
            "sha": "e6d007b2605be276cd092701c0557338023556cc",
            "filename": "packages/next/src/server/request/utils.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a598b5ba3825569da92af6704ed52014fd056267/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a598b5ba3825569da92af6704ed52014fd056267/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Futils.ts?ref=a598b5ba3825569da92af6704ed52014fd056267",
            "patch": "@@ -21,12 +21,14 @@ export function throwWithStaticGenerationBailoutErrorWithDynamicError(\n }\n \n export function throwForSearchParamsAccessInUseCache(\n-  workStore: WorkStore\n+  workStore: WorkStore,\n+  constructorOpt: Function\n ): never {\n   const error = new Error(\n     `Route ${workStore.route} used \"searchParams\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"searchParams\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n   )\n \n+  Error.captureStackTrace(error, constructorOpt)\n   workStore.invalidUsageError ??= error\n \n   throw error"
        },
        {
            "sha": "5096cbc1cd10de989fd542f755a9ced69af673ca",
            "filename": "test/e2e/app-dir/use-cache/app/directive-in-node-modules/with-handler/page.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/a598b5ba3825569da92af6704ed52014fd056267/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdirective-in-node-modules%2Fwith-handler%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a598b5ba3825569da92af6704ed52014fd056267/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdirective-in-node-modules%2Fwith-handler%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdirective-in-node-modules%2Fwith-handler%2Fpage.tsx?ref=a598b5ba3825569da92af6704ed52014fd056267",
            "patch": "@@ -0,0 +1,17 @@\n+import { getCachedRandomWithHandler } from 'my-pkg'\n+\n+export default async function Page() {\n+  const one = await getCachedRandomWithHandler()\n+  const two = await getCachedRandomWithHandler()\n+  return (\n+    <main>\n+      <div>\n+        One: <span id=\"one\">{one}</span>\n+      </div>\n+      <div>\n+        Two: <span id=\"two\">{two}</span>\n+      </div>\n+      {one === two ? '✅ Cached' : '❌ Not cached'}\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "df35cb873583e971550acd5a4784c933aac2e380",
            "filename": "test/e2e/app-dir/use-cache/app/directive-in-node-modules/without-handler/page.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/a598b5ba3825569da92af6704ed52014fd056267/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdirective-in-node-modules%2Fwithout-handler%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a598b5ba3825569da92af6704ed52014fd056267/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdirective-in-node-modules%2Fwithout-handler%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdirective-in-node-modules%2Fwithout-handler%2Fpage.tsx?ref=a598b5ba3825569da92af6704ed52014fd056267",
            "patch": "@@ -0,0 +1,17 @@\n+import { getCachedRandom } from 'my-pkg'\n+\n+export default async function Page() {\n+  const one = await getCachedRandom()\n+  const two = await getCachedRandom()\n+  return (\n+    <main>\n+      <div>\n+        One: <span id=\"one\">{one}</span>\n+      </div>\n+      <div>\n+        Two: <span id=\"two\">{two}</span>\n+      </div>\n+      {one === two ? '✅ Cached' : '❌ Not cached'}\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "e69bbc6627feca453579b52c6a71f6256281d5fb",
            "filename": "test/e2e/app-dir/use-cache/node_modules/my-pkg/index.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a598b5ba3825569da92af6704ed52014fd056267/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnode_modules%2Fmy-pkg%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a598b5ba3825569da92af6704ed52014fd056267/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnode_modules%2Fmy-pkg%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnode_modules%2Fmy-pkg%2Findex.js?ref=a598b5ba3825569da92af6704ed52014fd056267",
            "patch": "@@ -0,0 +1,9 @@\n+export async function getCachedRandom() {\n+  'use cache'\n+  return Math.random()\n+}\n+\n+export async function getCachedRandomWithHandler() {\n+  'use cache: default'\n+  return Math.random()\n+}"
        },
        {
            "sha": "7f86a75af94dbc0424cde430f14c549b55aeeaf8",
            "filename": "test/e2e/app-dir/use-cache/node_modules/my-pkg/package.json",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/a598b5ba3825569da92af6704ed52014fd056267/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnode_modules%2Fmy-pkg%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/a598b5ba3825569da92af6704ed52014fd056267/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnode_modules%2Fmy-pkg%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnode_modules%2Fmy-pkg%2Fpackage.json?ref=a598b5ba3825569da92af6704ed52014fd056267",
            "patch": "@@ -0,0 +1,7 @@\n+{\n+  \"name\": \"my-pkg\",\n+  \"type\": \"module\",\n+  \"exports\": {\n+    \".\": \"./index.js\"\n+  }\n+}"
        },
        {
            "sha": "772d472764376d27b0e0e75cca42a7c75da715a2",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/a598b5ba3825569da92af6704ed52014fd056267/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a598b5ba3825569da92af6704ed52014fd056267/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=a598b5ba3825569da92af6704ed52014fd056267",
            "patch": "@@ -503,6 +503,8 @@ describe('use-cache', () => {\n         '/cache-fetch-no-store',\n         '/cache-life',\n         '/cache-tag',\n+        '/directive-in-node-modules/with-handler',\n+        '/directive-in-node-modules/without-handler',\n         '/draft-mode',\n         '/form',\n         '/imported-from-client',\n@@ -913,6 +915,25 @@ describe('use-cache', () => {\n       ])\n     })\n   }\n+\n+  describe('usage in node_modules', () => {\n+    it('should cache results when using a directive without a handler', async () => {\n+      const browser = await next.browser(\n+        '/directive-in-node-modules/without-handler'\n+      )\n+      const randomOne = await browser.elementByCss('#one').text()\n+      const randomTwo = await browser.elementByCss('#two').text()\n+      expect(randomOne).toBe(randomTwo)\n+    })\n+    it('should cache results when using a directive with a handler', async () => {\n+      const browser = await next.browser(\n+        '/directive-in-node-modules/with-handler'\n+      )\n+      const randomOne = await browser.elementByCss('#one').text()\n+      const randomTwo = await browser.elementByCss('#two').text()\n+      expect(randomOne).toBe(randomTwo)\n+    })\n+  })\n })\n \n async function getSanitizedLogs(browser: Playwright): Promise<string[]> {"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 81,
        "deletions": 8
    }
}