{
    "author": "mischnic",
    "message": "Turbopack: run styled-jsx after typescript transform (#82359)\n\nCloses PACK-5183\n\nBased on https://github.com/swc-project/swc/issues/10944#issuecomment-3120775091, we need to run styled-jsx after typescript\n\n\nFixes this crash\n```\nentered unreachable code: This visitor does not support TypeScript. This method fails for optimization purposes. Encountered in unreachable visitor: visit_ts_interface_decl\n```\n\nThis has become more pressing as swc seems to have turned the debug_assertion into a proper panic/crash in recent versions (I was seeing SIGSEGV when building some app): https://vercel.slack.com/archives/C03EWR7LGEN/p1754390155508789?thread_ts=1753477535.369549&cid=C03EWR7LGEN\n\n\nWe now have three phases/stages:\n- preprocess: to strip typescript/decorators (so to normalize the syntax)\n- main: for transforms that want to operate on \"standard\" EcmaScript (though still with raw JSX)\n- postprocess: react transform, preset-env, etc (so low level \"codegen\")",
    "sha": "fb83b8345fe63838e5e5efc46b772b5c9eb76717",
    "files": [
        {
            "sha": "99d607e7d53c7945047fe1a41c77c1c3da56425c",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -58,7 +58,7 @@ use crate::{\n             get_invalid_styled_jsx_resolve_plugin,\n         },\n         transforms::{\n-            emotion::get_emotion_transform_rule, get_ecma_transform_rule,\n+            EcmascriptTransformStage, emotion::get_emotion_transform_rule, get_ecma_transform_rule,\n             next_react_server_components::get_next_react_server_components_transform_rule,\n             react_remove_properties::get_react_remove_properties_transform_rule,\n             relay::get_relay_transform_rule, remove_console::get_remove_console_transform_rule,\n@@ -768,7 +768,7 @@ pub async fn get_server_module_options_context(\n                         ecmascript_client_reference_transition_name,\n                     )),\n                     enable_mdx_rs.is_some(),\n-                    true,\n+                    EcmascriptTransformStage::Preprocess,\n                 ));\n             }\n \n@@ -844,7 +844,7 @@ pub async fn get_server_module_options_context(\n                         ecmascript_client_reference_transition_name,\n                     )),\n                     enable_mdx_rs.is_some(),\n-                    true,\n+                    EcmascriptTransformStage::Preprocess,\n                 ));\n             }\n \n@@ -922,15 +922,15 @@ pub async fn get_server_module_options_context(\n                         ecmascript_client_reference_transition_name,\n                     )),\n                     enable_mdx_rs.is_some(),\n-                    true,\n+                    EcmascriptTransformStage::Preprocess,\n                 ));\n             } else {\n                 custom_source_transform_rules.push(get_ecma_transform_rule(\n                     Box::new(ClientDisallowedDirectiveTransformer::new(\n                         \"next/dist/client/use-client-disallowed.js\".to_string(),\n                     )),\n                     enable_mdx_rs.is_some(),\n-                    true,\n+                    EcmascriptTransformStage::Preprocess,\n                 ));\n             }\n "
        },
        {
            "sha": "7664fd190da3b1a7502d0d00b55af0533086b5d3",
            "filename": "crates/next-core/src/next_shared/transforms/debug_fn_name.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fdebug_fn_name.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fdebug_fn_name.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fdebug_fn_name.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -16,8 +16,9 @@ pub fn get_debug_fn_name_rule(enable_mdx_rs: bool) -> ModuleRule {\n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![debug_fn_name_transform]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![debug_fn_name_transform]),\n         }],\n     )\n }"
        },
        {
            "sha": "6fd4d324b7b72621469519f12ba1269b2682dc6e",
            "filename": "crates/next-core/src/next_shared/transforms/emotion.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Femotion.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Femotion.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Femotion.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -4,7 +4,10 @@ use turbopack::module_options::ModuleRule;\n use turbopack_ecmascript_plugins::transform::emotion::EmotionTransformer;\n \n use super::get_ecma_transform_rule;\n-use crate::next_config::{EmotionTransformOptionsOrBoolean, NextConfig};\n+use crate::{\n+    next_config::{EmotionTransformOptionsOrBoolean, NextConfig},\n+    next_shared::transforms::EcmascriptTransformStage,\n+};\n \n pub async fn get_emotion_transform_rule(next_config: Vc<NextConfig>) -> Result<Option<ModuleRule>> {\n     let enable_mdx_rs = next_config.mdx_rs().await?.is_some();\n@@ -20,7 +23,13 @@ pub async fn get_emotion_transform_rule(next_config: Vc<NextConfig>) -> Result<O\n             EmotionTransformOptionsOrBoolean::Options(value) => EmotionTransformer::new(value),\n             _ => None,\n         })\n-        .map(|transformer| get_ecma_transform_rule(Box::new(transformer), enable_mdx_rs, true));\n+        .map(|transformer| {\n+            get_ecma_transform_rule(\n+                Box::new(transformer),\n+                enable_mdx_rs,\n+                EcmascriptTransformStage::Main,\n+            )\n+        });\n \n     Ok(module_rule)\n }"
        },
        {
            "sha": "071e89f33cb227c66370c4a35fdfb73f81dfd8c5",
            "filename": "crates/next-core/src/next_shared/transforms/mod.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 12,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -134,28 +134,32 @@ pub(crate) fn module_rule_match_pages_page_file(\n     ])\n }\n \n+pub(crate) enum EcmascriptTransformStage {\n+    Preprocess,\n+    Main,\n+    Postprocess,\n+}\n+\n /// Create a new module rule for the given ecmatransform, runs against\n /// any ecmascript (with mdx if enabled) except url reference type\n pub(crate) fn get_ecma_transform_rule(\n     transformer: Box<dyn CustomTransformer + Send + Sync>,\n     enable_mdx_rs: bool,\n-    prepend: bool,\n+    stage: EcmascriptTransformStage,\n ) -> ModuleRule {\n     let transformer = EcmascriptInputTransform::Plugin(ResolvedVc::cell(transformer as _));\n-    let (prepend, append) = if prepend {\n-        (\n-            ResolvedVc::cell(vec![transformer]),\n-            ResolvedVc::cell(vec![]),\n-        )\n-    } else {\n-        (\n-            ResolvedVc::cell(vec![]),\n-            ResolvedVc::cell(vec![transformer]),\n-        )\n+    let (preprocess, main, postprocess) = match stage {\n+        EcmascriptTransformStage::Preprocess => (vec![transformer], vec![], vec![]),\n+        EcmascriptTransformStage::Main => (vec![], vec![transformer], vec![]),\n+        EcmascriptTransformStage::Postprocess => (vec![], vec![], vec![transformer]),\n     };\n \n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n-        vec![ModuleRuleEffect::ExtendEcmascriptTransforms { prepend, append }],\n+        vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n+            preprocess: ResolvedVc::cell(preprocess),\n+            main: ResolvedVc::cell(main),\n+            postprocess: ResolvedVc::cell(postprocess),\n+        }],\n     )\n }"
        },
        {
            "sha": "50e9298a42a0cd44c11ee3d099a2f3686ad047b4",
            "filename": "crates/next-core/src/next_shared/transforms/modularize_imports.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmodularize_imports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmodularize_imports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmodularize_imports.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -63,8 +63,9 @@ pub fn get_next_modularize_imports_rule(\n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![transformer]),\n         }],\n     )\n }"
        },
        {
            "sha": "3d0128750d4ff61c4aa51d2584ae303f22756a70",
            "filename": "crates/next-core/src/next_shared/transforms/next_amp_attributes.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_amp_attributes.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_amp_attributes.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_amp_attributes.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -14,8 +14,9 @@ pub fn get_next_amp_attr_rule(enable_mdx_rs: bool) -> ModuleRule {\n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![transformer]),\n+            postprocess: ResolvedVc::cell(vec![]),\n         }],\n     )\n }"
        },
        {
            "sha": "6ad13957c82dbd47f3e334bc1b276a6111231de9",
            "filename": "crates/next-core/src/next_shared/transforms/next_cjs_optimizer.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_cjs_optimizer.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_cjs_optimizer.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_cjs_optimizer.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -54,8 +54,9 @@ pub fn get_next_cjs_optimizer_rule(enable_mdx_rs: bool) -> ModuleRule {\n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![transformer]),\n         }],\n     )\n }"
        },
        {
            "sha": "a581a16f8c6eef44f979966a7fcedab35118a8af",
            "filename": "crates/next-core/src/next_shared/transforms/next_disallow_re_export_all_in_page.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_disallow_re_export_all_in_page.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_disallow_re_export_all_in_page.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_disallow_re_export_all_in_page.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -19,8 +19,9 @@ pub fn get_next_disallow_export_all_in_page_rule(\n     ModuleRule::new(\n         module_rule_match_pages_page_file(enable_mdx_rs, pages_dir),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![transformer]),\n         }],\n     )\n }"
        },
        {
            "sha": "ceb173230be762cbb95d420c9dfa4785faa64750",
            "filename": "crates/next-core/src/next_shared/transforms/next_dynamic.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_dynamic.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_dynamic.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_dynamic.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -27,8 +27,9 @@ pub async fn get_next_dynamic_transform_rule(\n     Ok(ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![dynamic_transform]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![dynamic_transform]),\n         }],\n     ))\n }"
        },
        {
            "sha": "5ebd7ceb70c1f4828dd3661be5170ea0ceea5523",
            "filename": "crates/next-core/src/next_shared/transforms/next_edge_node_api_assert.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_edge_node_api_assert.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_edge_node_api_assert.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_edge_node_api_assert.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -24,8 +24,9 @@ pub fn next_edge_node_api_assert(\n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![transformer]),\n         }],\n     )\n }"
        },
        {
            "sha": "b40bcf080ff1c10ef2f05fdd994532f0e890529f",
            "filename": "crates/next-core/src/next_shared/transforms/next_font.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_font.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_font.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_font.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -28,8 +28,9 @@ pub fn get_next_font_transform_rule(enable_mdx_rs: bool) -> ModuleRule {\n         // TODO: Only match in pages (not pages/api), app/, etc.\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![transformer]),\n         }],\n     )\n }"
        },
        {
            "sha": "453e962683837070ae69d64180906387a89bb9e0",
            "filename": "crates/next-core/src/next_shared/transforms/next_lint.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_lint.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_lint.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_lint.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -6,9 +6,14 @@ use turbopack::module_options::ModuleRule;\n use turbopack_ecmascript::{CustomTransformer, TransformContext};\n \n use super::get_ecma_transform_rule;\n+use crate::next_shared::transforms::EcmascriptTransformStage;\n \n pub fn get_next_lint_transform_rule(enable_mdx_rs: bool) -> ModuleRule {\n-    get_ecma_transform_rule(Box::new(LintTransformer {}), enable_mdx_rs, true)\n+    get_ecma_transform_rule(\n+        Box::new(LintTransformer {}),\n+        enable_mdx_rs,\n+        EcmascriptTransformStage::Preprocess,\n+    )\n }\n \n #[derive(Debug)]"
        },
        {
            "sha": "cc6eadc459329cddb80714d0a440c34dd6dc08c9",
            "filename": "crates/next-core/src/next_shared/transforms/next_middleware_dynamic_assert.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_middleware_dynamic_assert.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_middleware_dynamic_assert.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_middleware_dynamic_assert.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -15,8 +15,9 @@ pub fn get_middleware_dynamic_assert_rule(enable_mdx_rs: bool) -> ModuleRule {\n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![transformer]),\n         }],\n     )\n }"
        },
        {
            "sha": "5e5340e15e7be1b8f894f8568cd76ce5b70fed95",
            "filename": "crates/next-core/src/next_shared/transforms/next_optimize_server_react.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_optimize_server_react.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_optimize_server_react.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_optimize_server_react.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -20,8 +20,9 @@ pub fn get_next_optimize_server_react_rule(\n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![transformer]),\n         }],\n     )\n }"
        },
        {
            "sha": "a2914c96674bb054cfa1aa487619b06bcea6fdbc",
            "filename": "crates/next-core/src/next_shared/transforms/next_page_config.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_page_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_page_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_page_config.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -17,8 +17,9 @@ pub fn get_next_page_config_rule(enable_mdx_rs: bool, pages_dir: FileSystemPath)\n     ModuleRule::new(\n         module_rule_match_pages_page_file(enable_mdx_rs, pages_dir),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![transformer]),\n         }],\n     )\n }"
        },
        {
            "sha": "3217f8847b163ce27efc62a82ada7fcf5e704e90",
            "filename": "crates/next-core/src/next_shared/transforms/next_page_static_info.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_page_static_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_page_static_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_page_static_info.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -39,8 +39,9 @@ pub fn get_next_page_static_info_assert_rule(\n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![transformer]),\n-            append: ResolvedVc::cell(vec![]),\n+            preprocess: ResolvedVc::cell(vec![transformer]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![]),\n         }],\n     )\n }"
        },
        {
            "sha": "31baeca2947d4200cbee185825e53e923a8385f1",
            "filename": "crates/next-core/src/next_shared/transforms/next_pure.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_pure.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_pure.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_pure.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -14,8 +14,9 @@ pub fn get_next_pure_rule(enable_mdx_rs: bool) -> ModuleRule {\n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![transformer]),\n         }],\n     )\n }"
        },
        {
            "sha": "89a3e3ba984e5d7fbf304a100f255aa6bfd91f72",
            "filename": "crates/next-core/src/next_shared/transforms/next_react_server_components.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_react_server_components.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_react_server_components.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_react_server_components.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -11,7 +11,7 @@ use turbopack::module_options::ModuleRule;\n use turbopack_ecmascript::{CustomTransformer, TransformContext};\n \n use super::get_ecma_transform_rule;\n-use crate::next_config::NextConfig;\n+use crate::{next_config::NextConfig, next_shared::transforms::EcmascriptTransformStage};\n \n /// Returns a rule which applies the Next.js react server components transform.\n /// This transform owns responsibility to assert various import / usage\n@@ -44,7 +44,7 @@ pub async fn get_next_react_server_components_transform_rule(\n             app_dir,\n         )),\n         enable_mdx_rs,\n-        true,\n+        EcmascriptTransformStage::Preprocess,\n     ))\n }\n "
        },
        {
            "sha": "9a1bc958bfb94feffaa99e69f292d6e5d306dc28",
            "filename": "crates/next-core/src/next_shared/transforms/next_shake_exports.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_shake_exports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_shake_exports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_shake_exports.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -16,8 +16,9 @@ pub fn get_next_shake_exports_rule(enable_mdx_rs: bool, ignore: Vec<String>) ->\n     ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![transformer]),\n         }],\n     )\n }"
        },
        {
            "sha": "94c150bcf307fb12865e694b3faa62a68fc378b1",
            "filename": "crates/next-core/src/next_shared/transforms/next_strip_page_exports.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_strip_page_exports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_strip_page_exports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_strip_page_exports.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -40,8 +40,9 @@ pub async fn get_next_pages_transforms_rule(\n             module_rule_match_js_no_url(enable_mdx_rs),\n         ]),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![strip_transform]),\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![strip_transform]),\n         }],\n     ))\n }"
        },
        {
            "sha": "abcec227dfc54d250d00a895964ea4d306401e82",
            "filename": "crates/next-core/src/next_shared/transforms/next_track_dynamic_imports.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_track_dynamic_imports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_track_dynamic_imports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_track_dynamic_imports.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -6,9 +6,14 @@ use turbopack::module_options::ModuleRule;\n use turbopack_ecmascript::{CustomTransformer, TransformContext};\n \n use super::get_ecma_transform_rule;\n+use crate::next_shared::transforms::EcmascriptTransformStage;\n \n pub fn get_next_track_dynamic_imports_transform_rule(mdx_rs: bool) -> ModuleRule {\n-    get_ecma_transform_rule(Box::new(NextTrackDynamicImports {}), mdx_rs, false)\n+    get_ecma_transform_rule(\n+        Box::new(NextTrackDynamicImports {}),\n+        mdx_rs,\n+        EcmascriptTransformStage::Postprocess,\n+    )\n }\n \n #[derive(Debug)]"
        },
        {
            "sha": "47a783211fd63e084eb13b1c9b7f77946b4031dc",
            "filename": "crates/next-core/src/next_shared/transforms/react_remove_properties.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Freact_remove_properties.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Freact_remove_properties.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Freact_remove_properties.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -6,7 +6,10 @@ use turbopack::module_options::ModuleRule;\n use turbopack_ecmascript::{CustomTransformer, TransformContext};\n \n use super::get_ecma_transform_rule;\n-use crate::next_config::{NextConfig, ReactRemoveProperties};\n+use crate::{\n+    next_config::{NextConfig, ReactRemoveProperties},\n+    next_shared::transforms::EcmascriptTransformStage,\n+};\n \n /// Returns a rule which applies the react_remove_properties transform.\n pub async fn get_react_remove_properties_transform_rule(\n@@ -34,7 +37,7 @@ pub async fn get_react_remove_properties_transform_rule(\n             get_ecma_transform_rule(\n                 Box::new(ReactRemovePropertiesTransformer { config }),\n                 enable_mdx_rs,\n-                true,\n+                EcmascriptTransformStage::Preprocess,\n             )\n         });\n "
        },
        {
            "sha": "51d22a30b3b72586285b3bfa9522723ca876de1b",
            "filename": "crates/next-core/src/next_shared/transforms/relay.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Frelay.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Frelay.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Frelay.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -5,7 +5,7 @@ use turbopack::module_options::ModuleRule;\n use turbopack_ecmascript_plugins::transform::relay::RelayTransformer;\n \n use super::get_ecma_transform_rule;\n-use crate::next_config::NextConfig;\n+use crate::{next_config::NextConfig, next_shared::transforms::EcmascriptTransformStage};\n \n /// Returns a transform rule for the relay graphql transform.\n pub async fn get_relay_transform_rule(\n@@ -17,7 +17,7 @@ pub async fn get_relay_transform_rule(\n         get_ecma_transform_rule(\n             Box::new(RelayTransformer::new(config, &project_path)),\n             enable_mdx_rs,\n-            true,\n+            EcmascriptTransformStage::Preprocess,\n         )\n     });\n "
        },
        {
            "sha": "f454e86e461685f7d6e8a466ecb40ba4e1bc51e5",
            "filename": "crates/next-core/src/next_shared/transforms/remove_console.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fremove_console.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fremove_console.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fremove_console.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -6,7 +6,10 @@ use turbopack::module_options::ModuleRule;\n use turbopack_ecmascript::{CustomTransformer, TransformContext};\n \n use super::get_ecma_transform_rule;\n-use crate::next_config::{NextConfig, RemoveConsoleConfig};\n+use crate::{\n+    next_config::{NextConfig, RemoveConsoleConfig},\n+    next_shared::transforms::EcmascriptTransformStage,\n+};\n \n /// Returns a rule which applies the remove_console transform.\n pub async fn get_remove_console_transform_rule(\n@@ -37,7 +40,7 @@ pub async fn get_remove_console_transform_rule(\n             get_ecma_transform_rule(\n                 Box::new(RemoveConsoleTransformer { config }),\n                 enable_mdx_rs,\n-                true,\n+                EcmascriptTransformStage::Preprocess,\n             )\n         });\n "
        },
        {
            "sha": "12ba811184ed90e6c8c438cf5662dcc281092976",
            "filename": "crates/next-core/src/next_shared/transforms/server_actions.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fserver_actions.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -40,8 +40,9 @@ pub async fn get_server_actions_transform_rule(\n     Ok(ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![transformer]),\n-            append: ResolvedVc::cell(vec![]),\n+            preprocess: ResolvedVc::cell(vec![transformer]),\n+            main: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![]),\n         }],\n     ))\n }"
        },
        {
            "sha": "ac3f5ef65d41fa2371b332c6763f90baa7b390df",
            "filename": "crates/next-core/src/next_shared/transforms/styled_components.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fstyled_components.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fstyled_components.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fstyled_components.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -5,7 +5,7 @@ use turbopack_ecmascript_plugins::transform::styled_components::StyledComponents\n \n use crate::{\n     next_config::{NextConfig, StyledComponentsTransformOptionsOrBoolean},\n-    next_shared::transforms::get_ecma_transform_rule,\n+    next_shared::transforms::{EcmascriptTransformStage, get_ecma_transform_rule},\n };\n \n pub async fn get_styled_components_transform_rule(\n@@ -27,7 +27,13 @@ pub async fn get_styled_components_transform_rule(\n             }\n             _ => None,\n         })\n-        .map(|transformer| get_ecma_transform_rule(Box::new(transformer), enable_mdx_rs, true));\n+        .map(|transformer| {\n+            get_ecma_transform_rule(\n+                Box::new(transformer),\n+                enable_mdx_rs,\n+                EcmascriptTransformStage::Main,\n+            )\n+        });\n \n     Ok(module_rule)\n }"
        },
        {
            "sha": "28fdcf49fec3f97e7afa178bd5c7c01b9775cde5",
            "filename": "crates/next-core/src/next_shared/transforms/styled_jsx.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fstyled_jsx.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fstyled_jsx.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fstyled_jsx.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -5,7 +5,7 @@ use turbopack_core::environment::RuntimeVersions;\n use turbopack_ecmascript_plugins::transform::styled_jsx::StyledJsxTransformer;\n \n use super::get_ecma_transform_rule;\n-use crate::next_config::NextConfig;\n+use crate::{next_config::NextConfig, next_shared::transforms::EcmascriptTransformStage};\n \n /// Returns a transform rule for the styled jsx transform.\n pub async fn get_styled_jsx_transform_rule(\n@@ -19,6 +19,6 @@ pub async fn get_styled_jsx_transform_rule(\n     Ok(Some(get_ecma_transform_rule(\n         Box::new(transformer),\n         enable_mdx_rs,\n-        true,\n+        EcmascriptTransformStage::Main,\n     )))\n }"
        },
        {
            "sha": "78fc1e0ca51f4feb07c2825c6b16dc06cdd02363",
            "filename": "crates/next-core/src/next_shared/transforms/swc_ecma_transform_plugins.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -48,7 +48,7 @@ pub async fn get_swc_ecma_transform_rule_impl(\n         SwcEcmaTransformPluginsTransformer, SwcPluginModule,\n     };\n \n-    use crate::next_shared::transforms::get_ecma_transform_rule;\n+    use crate::next_shared::transforms::{EcmascriptTransformStage, get_ecma_transform_rule};\n \n     let plugins = plugin_configs\n         .iter()\n@@ -116,6 +116,6 @@ pub async fn get_swc_ecma_transform_rule_impl(\n     Ok(Some(get_ecma_transform_rule(\n         Box::new(SwcEcmaTransformPluginsTransformer::new(plugins)),\n         enable_mdx_rs,\n-        true,\n+        EcmascriptTransformStage::Main,\n     )))\n }"
        },
        {
            "sha": "c3f39f2c72abeea5076651c62a34bcaefeb5c5e6",
            "filename": "test/e2e/styled-jsx/index.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/test%2Fe2e%2Fstyled-jsx%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/test%2Fe2e%2Fstyled-jsx%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fstyled-jsx%2Findex.test.ts?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -41,4 +41,13 @@ describe('styled-jsx', () => {\n     const html = await next.render('/amp')\n     expect(html).toMatch(/color:.*?cyan/)\n   })\n+\n+  it('should render styles inside TypeScript', async () => {\n+    const browser = await next.browser('/typescript')\n+    const color = await browser.eval(\n+      `getComputedStyle(document.querySelector('button')).color`\n+    )\n+\n+    expect(color).toMatch('255, 0, 0')\n+  })\n })"
        },
        {
            "sha": "1dfbf4409eef2bf746a98c9e4bbc302f7f3a04d8",
            "filename": "test/e2e/styled-jsx/pages/typescript.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/test%2Fe2e%2Fstyled-jsx%2Fpages%2Ftypescript.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/test%2Fe2e%2Fstyled-jsx%2Fpages%2Ftypescript.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fstyled-jsx%2Fpages%2Ftypescript.tsx?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -0,0 +1,20 @@\n+interface Props {\n+  color: string\n+}\n+\n+function Test(p: Props) {\n+  return (\n+    <div>\n+      <button>test</button>\n+      <style jsx>{`\n+        button {\n+          color: ${p.color};\n+        }\n+      `}</style>\n+    </div>\n+  )\n+}\n+\n+export default function Page() {\n+  return <Test color=\"red\" />\n+}"
        },
        {
            "sha": "a00803a23ac109be3e0eff7584b4607ce50b191f",
            "filename": "turbopack/crates/turbopack-cli/src/contexts.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 18,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fcontexts.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -8,8 +8,8 @@ use turbopack::{\n     ModuleAssetContext,\n     ecmascript::TreeShakingMode,\n     module_options::{\n-        EcmascriptOptionsContext, JsxTransformOptions, ModuleOptionsContext, ModuleRule,\n-        ModuleRuleEffect, RuleCondition, TypescriptTransformOptions,\n+        EcmascriptOptionsContext, JsxTransformOptions, ModuleOptionsContext,\n+        TypescriptTransformOptions,\n     },\n };\n use turbopack_browser::react_refresh::assert_can_resolve_react_refresh;\n@@ -135,21 +135,6 @@ async fn get_client_module_options_context(\n         .resolved_cell(),\n     );\n \n-    let conditions = RuleCondition::any(vec![\n-        RuleCondition::ResourcePathEndsWith(\".js\".to_string()),\n-        RuleCondition::ResourcePathEndsWith(\".jsx\".to_string()),\n-        RuleCondition::ResourcePathEndsWith(\".ts\".to_string()),\n-        RuleCondition::ResourcePathEndsWith(\".tsx\".to_string()),\n-    ]);\n-\n-    let module_rules = ModuleRule::new(\n-        conditions,\n-        vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![]),\n-        }],\n-    );\n-\n     let module_options_context = ModuleOptionsContext {\n         ecmascript: EcmascriptOptionsContext {\n             enable_jsx,\n@@ -164,7 +149,6 @@ async fn get_client_module_options_context(\n             foreign_code_context_condition(),\n             module_options_context.clone().resolved_cell(),\n         )],\n-        module_rules: vec![module_rules],\n         ..module_options_context\n     }\n     .cell();"
        },
        {
            "sha": "bd58646e492f58d89c5282c07636e0deba7fe716",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -321,7 +321,8 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n     let module_rules = ModuleRule::new(\n         conditions,\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![\n+            preprocess: ResolvedVc::cell(vec![]),\n+            main: ResolvedVc::cell(vec![\n                 EcmascriptInputTransform::Plugin(ResolvedVc::cell(Box::new(\n                     EmotionTransformer::new(&EmotionTransformConfig::default())\n                         .expect(\"Should be able to create emotion transformer\"),\n@@ -330,7 +331,7 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n                     StyledComponentsTransformer::new(&StyledComponentsTransformConfig::default()),\n                 ) as _)),\n             ]),\n-            append: ResolvedVc::cell(vec![]),\n+            postprocess: ResolvedVc::cell(vec![]),\n         }],\n     );\n     let asset_context: Vc<Box<dyn AssetContext>> = Vc::upcast(ModuleAssetContext::new("
        },
        {
            "sha": "98130b4c42c86c45e5a1e8042ea6a189d31dc012",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 39,
            "deletions": 13,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -80,17 +80,23 @@ async fn apply_module_type(\n     let module_type = &*module_type.await?;\n     Ok(ProcessResult::Module(match module_type {\n         ModuleType::Ecmascript {\n-            transforms,\n+            preprocess,\n+            main,\n+            postprocess,\n             options,\n         }\n         | ModuleType::Typescript {\n-            transforms,\n+            preprocess,\n+            main,\n+            postprocess,\n             tsx: _,\n             analyze_types: _,\n             options,\n         }\n         | ModuleType::TypescriptDeclaration {\n-            transforms,\n+            preprocess,\n+            main,\n+            postprocess,\n             options,\n         } => {\n             let context_for_module = match module_type {\n@@ -107,7 +113,11 @@ async fn apply_module_type(\n             let mut builder = EcmascriptModuleAsset::builder(\n                 source,\n                 ResolvedVc::upcast(context_for_module),\n-                *transforms,\n+                preprocess\n+                    .extend(**main)\n+                    .extend(**postprocess)\n+                    .to_resolved()\n+                    .await?,\n                 *options,\n                 module_asset_context\n                     .compile_time_info()\n@@ -555,28 +565,44 @@ async fn process_default_internal(\n                     ModuleRuleEffect::ModuleType(module) => {\n                         current_module_type = Some(module.clone());\n                     }\n-                    ModuleRuleEffect::ExtendEcmascriptTransforms { prepend, append } => {\n+                    ModuleRuleEffect::ExtendEcmascriptTransforms {\n+                        preprocess: extend_preprocess,\n+                        main: extend_main,\n+                        postprocess: extend_postprocess,\n+                    } => {\n                         current_module_type = match current_module_type {\n                             Some(ModuleType::Ecmascript {\n-                                transforms,\n+                                preprocess,\n+                                main,\n+                                postprocess,\n                                 options,\n                             }) => Some(ModuleType::Ecmascript {\n-                                transforms: prepend\n-                                    .extend(*transforms)\n-                                    .extend(**append)\n+                                preprocess: extend_preprocess\n+                                    .extend(*preprocess)\n+                                    .to_resolved()\n+                                    .await?,\n+                                main: extend_main.extend(*main).to_resolved().await?,\n+                                postprocess: postprocess\n+                                    .extend(**extend_postprocess)\n                                     .to_resolved()\n                                     .await?,\n                                 options,\n                             }),\n                             Some(ModuleType::Typescript {\n-                                transforms,\n+                                preprocess,\n+                                main,\n+                                postprocess,\n                                 tsx,\n                                 analyze_types,\n                                 options,\n                             }) => Some(ModuleType::Typescript {\n-                                transforms: prepend\n-                                    .extend(*transforms)\n-                                    .extend(**append)\n+                                preprocess: extend_preprocess\n+                                    .extend(*preprocess)\n+                                    .to_resolved()\n+                                    .await?,\n+                                main: extend_main.extend(*main).to_resolved().await?,\n+                                postprocess: postprocess\n+                                    .extend(**extend_postprocess)\n                                     .to_resolved()\n                                     .await?,\n                                 tsx,"
        },
        {
            "sha": "e946dfe47fffd63c55e1dcc6048c5fc25fe15306",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 60,
            "deletions": 49,
            "changes": 109,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -149,7 +149,9 @@ impl ModuleOptions {\n             ..\n         } = *module_options_context.await?;\n \n-        let mut transforms = vec![];\n+        let mut ts_preprocess = vec![];\n+        let mut ecma_preprocess = vec![];\n+        let mut postprocess = vec![];\n \n         // Order of transforms is important. e.g. if the React transform occurs before\n         // Styled JSX, there won't be JSX nodes for Styled JSX to transform.\n@@ -158,7 +160,7 @@ impl ModuleOptions {\n         if let Some(enable_jsx) = enable_jsx {\n             let jsx = enable_jsx.await?;\n \n-            transforms.push(EcmascriptInputTransform::React {\n+            postprocess.push(EcmascriptInputTransform::React {\n                 development: jsx.development,\n                 refresh: jsx.react_refresh,\n                 import_source: ResolvedVc::cell(jsx.import_source.clone()),\n@@ -178,11 +180,11 @@ impl ModuleOptions {\n         let ecmascript_options_vc = ecmascript_options.resolved_cell();\n \n         if let Some(environment) = environment {\n-            transforms.push(EcmascriptInputTransform::PresetEnv(environment));\n+            postprocess.push(EcmascriptInputTransform::PresetEnv(environment));\n         }\n \n         if let Some(enable_typeof_window_inlining) = enable_typeof_window_inlining {\n-            transforms.push(EcmascriptInputTransform::GlobalTypeofs {\n+            postprocess.push(EcmascriptInputTransform::GlobalTypeofs {\n                 window_value: match enable_typeof_window_inlining {\n                     TypeofWindow::Object => rcstr!(\"object\"),\n                     TypeofWindow::Undefined => rcstr!(\"undefined\"),\n@@ -214,43 +216,30 @@ impl ModuleOptions {\n             None\n         };\n \n-        let vendor_transforms = Vc::<EcmascriptInputTransforms>::cell(vec![]);\n-        let ts_app_transforms = if let Some(transform) = &ts_transform {\n-            let base_transforms = if let Some(decorators_transform) = &decorators_transform {\n-                vec![decorators_transform.clone(), transform.clone()]\n-            } else {\n-                vec![transform.clone()]\n-            };\n-            Vc::<EcmascriptInputTransforms>::cell(\n-                base_transforms\n-                    .iter()\n-                    .cloned()\n-                    .chain(transforms.iter().cloned())\n-                    .collect(),\n-            )\n-        } else {\n-            Vc::cell(transforms.clone())\n-        };\n-\n-        // Apply decorators transform for the ModuleType::Ecmascript as well after\n-        // constructing ts_app_transforms. Ecmascript can have decorators for\n-        // the cases of 1. using jsconfig, to enable ts-specific runtime\n-        // decorators (i.e legacy) 2. ecma spec decorators\n-        //\n-        // Since typescript transform (`ts_app_transforms`) needs to apply decorators\n-        // _before_ stripping types, we create ts_app_transforms first in a\n-        // specific order with typescript, then apply decorators to app_transforms.\n-        let app_transforms = Vc::<EcmascriptInputTransforms>::cell(\n+        if let Some(ts_transform) = &ts_transform {\n             if let Some(decorators_transform) = &decorators_transform {\n-                vec![decorators_transform.clone()]\n+                ts_preprocess.splice(0..0, [decorators_transform.clone(), ts_transform.clone()]);\n             } else {\n-                vec![]\n+                ts_preprocess.splice(0..0, [ts_transform.clone()]);\n             }\n-            .iter()\n-            .cloned()\n-            .chain(transforms.iter().cloned())\n-            .collect(),\n-        );\n+        }\n+        if let Some(decorators_transform) = &decorators_transform {\n+            // Apply decorators transform for the ModuleType::Ecmascript as well after\n+            // constructing ts_app_transforms. Ecmascript can have decorators for\n+            // the cases of 1. using jsconfig, to enable ts-specific runtime\n+            // decorators (i.e legacy) 2. ecma spec decorators\n+            //\n+            // Since typescript transform (`ts_app_transforms`) needs to apply decorators\n+            // _before_ stripping types, we create ts_app_transforms first in a\n+            // specific order with typescript, then apply decorators to app_transforms.\n+            ecma_preprocess.splice(0..0, [decorators_transform.clone()]);\n+        }\n+\n+        let ts_preprocess = ResolvedVc::cell(ts_preprocess);\n+        let ecma_preprocess = ResolvedVc::cell(ecma_preprocess);\n+        let main = ResolvedVc::<EcmascriptInputTransforms>::cell(vec![]);\n+        let postprocess = ResolvedVc::cell(postprocess);\n+        let empty = ResolvedVc::<EcmascriptInputTransforms>::cell(vec![]);\n \n         let mut rules = vec![\n             ModuleRule::new_all(\n@@ -268,14 +257,18 @@ impl ModuleOptions {\n                     RuleCondition::ContentTypeStartsWith(\"text/javascript\".to_string()),\n                 ]),\n                 vec![ModuleRuleEffect::ModuleType(ModuleType::Ecmascript {\n-                    transforms: app_transforms.to_resolved().await?,\n+                    preprocess: ecma_preprocess,\n+                    main,\n+                    postprocess,\n                     options: ecmascript_options_vc,\n                 })],\n             ),\n             ModuleRule::new_all(\n                 RuleCondition::ResourcePathEndsWith(\".mjs\".to_string()),\n                 vec![ModuleRuleEffect::ModuleType(ModuleType::Ecmascript {\n-                    transforms: app_transforms.to_resolved().await?,\n+                    preprocess: ecma_preprocess,\n+                    main,\n+                    postprocess,\n                     options: EcmascriptOptions {\n                         specified_module_type: SpecifiedModuleType::EcmaScript,\n                         ..ecmascript_options\n@@ -286,7 +279,9 @@ impl ModuleOptions {\n             ModuleRule::new_all(\n                 RuleCondition::ResourcePathEndsWith(\".cjs\".to_string()),\n                 vec![ModuleRuleEffect::ModuleType(ModuleType::Ecmascript {\n-                    transforms: app_transforms.to_resolved().await?,\n+                    preprocess: ecma_preprocess,\n+                    main,\n+                    postprocess,\n                     options: EcmascriptOptions {\n                         specified_module_type: SpecifiedModuleType::CommonJs,\n                         ..ecmascript_options\n@@ -297,7 +292,9 @@ impl ModuleOptions {\n             ModuleRule::new_all(\n                 RuleCondition::ResourcePathEndsWith(\".ts\".to_string()),\n                 vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    transforms: ts_app_transforms.to_resolved().await?,\n+                    preprocess: ts_preprocess,\n+                    main,\n+                    postprocess,\n                     tsx: false,\n                     analyze_types: enable_types,\n                     options: ecmascript_options_vc,\n@@ -306,7 +303,9 @@ impl ModuleOptions {\n             ModuleRule::new_all(\n                 RuleCondition::ResourcePathEndsWith(\".tsx\".to_string()),\n                 vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    transforms: ts_app_transforms.to_resolved().await?,\n+                    preprocess: ts_preprocess,\n+                    main,\n+                    postprocess,\n                     tsx: true,\n                     analyze_types: enable_types,\n                     options: ecmascript_options_vc,\n@@ -315,7 +314,9 @@ impl ModuleOptions {\n             ModuleRule::new_all(\n                 RuleCondition::ResourcePathEndsWith(\".mts\".to_string()),\n                 vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    transforms: ts_app_transforms.to_resolved().await?,\n+                    preprocess: ts_preprocess,\n+                    main,\n+                    postprocess,\n                     tsx: false,\n                     analyze_types: enable_types,\n                     options: EcmascriptOptions {\n@@ -328,7 +329,9 @@ impl ModuleOptions {\n             ModuleRule::new_all(\n                 RuleCondition::ResourcePathEndsWith(\".mtsx\".to_string()),\n                 vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    transforms: ts_app_transforms.to_resolved().await?,\n+                    preprocess: ts_preprocess,\n+                    main,\n+                    postprocess,\n                     tsx: true,\n                     analyze_types: enable_types,\n                     options: EcmascriptOptions {\n@@ -341,7 +344,9 @@ impl ModuleOptions {\n             ModuleRule::new_all(\n                 RuleCondition::ResourcePathEndsWith(\".cts\".to_string()),\n                 vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    transforms: ts_app_transforms.to_resolved().await?,\n+                    preprocess: ts_preprocess,\n+                    main,\n+                    postprocess,\n                     tsx: false,\n                     analyze_types: enable_types,\n                     options: EcmascriptOptions {\n@@ -354,7 +359,9 @@ impl ModuleOptions {\n             ModuleRule::new_all(\n                 RuleCondition::ResourcePathEndsWith(\".ctsx\".to_string()),\n                 vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    transforms: ts_app_transforms.to_resolved().await?,\n+                    preprocess: ts_preprocess,\n+                    main,\n+                    postprocess,\n                     tsx: true,\n                     analyze_types: enable_types,\n                     options: EcmascriptOptions {\n@@ -368,7 +375,9 @@ impl ModuleOptions {\n                 RuleCondition::ResourcePathEndsWith(\".d.ts\".to_string()),\n                 vec![ModuleRuleEffect::ModuleType(\n                     ModuleType::TypescriptDeclaration {\n-                        transforms: vendor_transforms.to_resolved().await?,\n+                        preprocess: empty,\n+                        main: empty,\n+                        postprocess: empty,\n                         options: ecmascript_options_vc,\n                     },\n                 )],\n@@ -404,7 +413,9 @@ impl ModuleOptions {\n                     RuleCondition::ContentTypeEmpty,\n                 ]),\n                 vec![ModuleRuleEffect::ModuleType(ModuleType::Ecmascript {\n-                    transforms: vendor_transforms.to_resolved().await?,\n+                    preprocess: empty,\n+                    main: empty,\n+                    postprocess: empty,\n                     options: ecmascript_options_vc,\n                 })],\n             ),"
        },
        {
            "sha": "9cf9f48fcb44cca478fe4d9cd2a0d0fac1fbd980",
            "filename": "turbopack/crates/turbopack/src/module_options/module_rule.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 7,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/fb83b8345fe63838e5e5efc46b772b5c9eb76717/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fb83b8345fe63838e5e5efc46b772b5c9eb76717/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs?ref=fb83b8345fe63838e5e5efc46b772b5c9eb76717",
            "patch": "@@ -67,11 +67,14 @@ impl ModuleRule {\n pub enum ModuleRuleEffect {\n     ModuleType(ModuleType),\n     /// Allow to extend an existing Ecmascript module rules for the additional\n-    /// transforms. First argument will prepend the existing transforms, and\n-    /// the second argument will append the new transforms.\n+    /// transforms\n     ExtendEcmascriptTransforms {\n-        prepend: ResolvedVc<EcmascriptInputTransforms>,\n-        append: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to run first: transpile TypeScript, decorators, ...\n+        preprocess: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to execute on standard EcmaScript (plus JSX): styled-jsx, swc plugins, ...\n+        main: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to run last: JSX, preset-env, scan for imports, ...\n+        postprocess: ResolvedVc<EcmascriptInputTransforms>,\n     },\n     SourceTransforms(ResolvedVc<SourceTransforms>),\n     Ignore,\n@@ -81,12 +84,22 @@ pub enum ModuleRuleEffect {\n #[derive(Hash, Debug, Clone)]\n pub enum ModuleType {\n     Ecmascript {\n-        transforms: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to run first: transpile TypeScript, decorators, ...\n+        preprocess: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to execute on standard EcmaScript (plus JSX): styled-jsx, swc plugins, ...\n+        main: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to run last: JSX, preset-env, scan for imports, ...\n+        postprocess: ResolvedVc<EcmascriptInputTransforms>,\n         #[turbo_tasks(trace_ignore)]\n         options: ResolvedVc<EcmascriptOptions>,\n     },\n     Typescript {\n-        transforms: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to run first: transpile TypeScript, decorators, ...\n+        preprocess: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to execute on standard EcmaScript (plus JSX): styled-jsx, swc plugins, ...\n+        main: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to run last: JSX, preset-env, scan for imports, ...\n+        postprocess: ResolvedVc<EcmascriptInputTransforms>,\n         // parse JSX syntax.\n         tsx: bool,\n         // follow references to imported types.\n@@ -95,7 +108,12 @@ pub enum ModuleType {\n         options: ResolvedVc<EcmascriptOptions>,\n     },\n     TypescriptDeclaration {\n-        transforms: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to run first: transpile TypeScript, decorators, ...\n+        preprocess: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to execute on standard EcmaScript (plus JSX): styled-jsx, swc plugins, ...\n+        main: ResolvedVc<EcmascriptInputTransforms>,\n+        /// Transforms to run last: JSX, preset-env, scan for imports, ...\n+        postprocess: ResolvedVc<EcmascriptInputTransforms>,\n         #[turbo_tasks(trace_ignore)]\n         options: ResolvedVc<EcmascriptOptions>,\n     },"
        }
    ],
    "stats": {
        "total": 432,
        "additions": 276,
        "deletions": 156
    }
}