{
    "author": "Cy-Tek",
    "message": "fix(turbopack): Next.js package not found panics in Turbopack (#79572)\n\n## Warn when multiple lockfiles are found and use highest level lockfile\n\n### What?\nThis PR enhances the lockfile detection logic to identify multiple\nlockfiles in a project hierarchy and use the highest level one as the\ntracing root.\n\n### Why?\nWhen multiple lockfiles exist in a project, it can cause confusion and\npotential issues. By detecting this situation, we can warn users about\nredundant lockfiles and consistently use the highest level one.\n\n### How?\n- Modified `findRootDir` to recursively search for lockfiles up the\ndirectory tree\n- Added a warning when multiple lockfiles are detected, showing the\npaths to redundant lockfiles\n- Updated comment in config.ts to clarify we use the \"highest level\nlockfile\" rather than \"closest lockfile\"\n- Added support for passing root directory as an argument in telemetry\nflush\n\nFixes #3980\n\nThis is a draft PR currently because the logging is duplicated across\nprocesses which I am currently working on a fix for.",
    "sha": "9305b89a89e7f629d2cbc6e1f4c14d329850a7e2",
    "files": [
        {
            "sha": "0d3235b2332b71d3ec27a8d0af1079502985779d",
            "filename": "packages/next/src/lib/find-root.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/9305b89a89e7f629d2cbc6e1f4c14d329850a7e2/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9305b89a89e7f629d2cbc6e1f4c14d329850a7e2/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts?ref=9305b89a89e7f629d2cbc6e1f4c14d329850a7e2",
            "patch": "@@ -1,5 +1,6 @@\n import { dirname } from 'path'\n import findUp from 'next/dist/compiled/find-up'\n+import * as Log from '../build/output/log'\n \n export function findRootLockFile(cwd: string) {\n   return findUp.sync(\n@@ -18,5 +19,29 @@ export function findRootLockFile(cwd: string) {\n \n export function findRootDir(cwd: string) {\n   const lockFile = findRootLockFile(cwd)\n-  return lockFile ? dirname(lockFile) : undefined\n+  if (!lockFile) return undefined\n+\n+  const lockFiles = [lockFile]\n+  while (true) {\n+    const nextDir = dirname(dirname(lockFiles[lockFiles.length - 1]))\n+    const newLockFile = findRootLockFile(nextDir)\n+\n+    if (newLockFile) {\n+      lockFiles.push(newLockFile)\n+    } else {\n+      break\n+    }\n+  }\n+\n+  // Only warn if not in a build worker to avoid duplicate warnings\n+  if (typeof process.send !== 'function' && lockFiles.length > 1) {\n+    Log.warnOnce(\n+      `Warning: Found multiple lockfiles. Consider removing the lockfiles at ${lockFiles\n+        .slice(0, lockFiles.length - 1)\n+        .map((str) => '\\n   * ' + str)\n+        .join('')}\\n`\n+    )\n+  }\n+\n+  return dirname(lockFile)\n }"
        },
        {
            "sha": "3c624efc9642d1ca9485a8787d5adaeb49b47f26",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9305b89a89e7f629d2cbc6e1f4c14d329850a7e2/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9305b89a89e7f629d2cbc6e1f4c14d329850a7e2/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=9305b89a89e7f629d2cbc6e1f4c14d329850a7e2",
            "patch": "@@ -699,7 +699,7 @@ function assignDefaults(\n     dset(result, ['turbopack', 'root'], result.outputFileTracingRoot)\n   }\n \n-  // use the closest lockfile as tracing root\n+  // use the highest level lockfile as tracing root\n   if (!result?.outputFileTracingRoot || !result?.turbopack?.root) {\n     let rootDir = findRootDir(dir)\n "
        }
    ],
    "stats": {
        "total": 29,
        "additions": 27,
        "deletions": 2
    }
}