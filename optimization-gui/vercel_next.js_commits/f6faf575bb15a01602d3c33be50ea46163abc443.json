{
    "author": "acdlite",
    "message": "Remove unnecessary indirections around dispatch-related methods (#77423)\n\nBest to review commit by commit.\n\nThe App Router's state lives outside of React, so we don't need to pass\nthe dispatch method around via props/context. We can import it directly\ninto each module that needs it.\n\nWe have to be a bit clever and assign the dispatch method to a global\nvariable on initialization. This is more complicated than it should be\nbecause of a known issue that requires us to decode Flight streams\nduring the render phase.\n\nIdeally, we would store the action queue and dispatch method entirely\noutside of React and pass the state into React as a prop using\n`root.render`; conceptually, this is how we're modeling it despite the\nweird implementation details.\n\n(We were already using this approach in several places, so it's not new\nto this PR; I'm just explaining it here for context.)\n\nThe first commit moves dispatch to a global. The rest of the PR cleans\nup indirections that can be removed by importing and calling the\ndispatch method directly.",
    "sha": "f6faf575bb15a01602d3c33be50ea46163abc443",
    "files": [
        {
            "sha": "9438e63ec047c6174dc4c98feb04e20aec4b9ddb",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=f6faf575bb15a01602d3c33be50ea46163abc443",
            "patch": "@@ -665,5 +665,6 @@\n   \"664\": \"Missing 'next-action' header.\",\n   \"665\": \"Failed to find Server Action \\\"%s\\\". This request might be from an older or newer deployment.\\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\",\n   \"666\": \"Turbopack builds are only available in canary builds of Next.js.\",\n-  \"667\": \"receiveExpiredTags is deprecated, and not expected to be called.\"\n+  \"667\": \"receiveExpiredTags is deprecated, and not expected to be called.\",\n+  \"668\": \"Internal Next.js error: Router action dispatched before initialization.\"\n }"
        },
        {
            "sha": "c447e163828affca7a7ae962f66b169aaf228368",
            "filename": "packages/next/src/client/app-call-server.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 36,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fclient%2Fapp-call-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fclient%2Fapp-call-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-call-server.ts?ref=f6faf575bb15a01602d3c33be50ea46163abc443",
            "patch": "@@ -1,42 +1,17 @@\n-import { startTransition, useCallback } from 'react'\n-import {\n-  ACTION_SERVER_ACTION,\n-  type ReducerActions,\n-  type ServerActionDispatcher,\n-} from './components/router-reducer/router-reducer-types'\n-\n-let globalServerActionDispatcher = null as ServerActionDispatcher | null\n-\n-export function useServerActionDispatcher(\n-  dispatch: React.Dispatch<ReducerActions>\n-) {\n-  const serverActionDispatcher: ServerActionDispatcher = useCallback(\n-    (actionPayload) => {\n-      startTransition(() => {\n-        dispatch({\n-          ...actionPayload,\n-          type: ACTION_SERVER_ACTION,\n-        })\n-      })\n-    },\n-    [dispatch]\n-  )\n-  globalServerActionDispatcher = serverActionDispatcher\n-}\n+import { startTransition } from 'react'\n+import { ACTION_SERVER_ACTION } from './components/router-reducer/router-reducer-types'\n+import { dispatchAppRouterAction } from './components/use-action-queue'\n \n export async function callServer(actionId: string, actionArgs: any[]) {\n-  const actionDispatcher = globalServerActionDispatcher\n-\n-  if (!actionDispatcher) {\n-    throw new Error('Invariant: missing action dispatcher.')\n-  }\n-\n   return new Promise((resolve, reject) => {\n-    actionDispatcher({\n-      actionId,\n-      actionArgs,\n-      resolve,\n-      reject,\n+    startTransition(() => {\n+      dispatchAppRouterAction({\n+        type: ACTION_SERVER_ACTION,\n+        actionId,\n+        actionArgs,\n+        resolve,\n+        reject,\n+      })\n     })\n   })\n }"
        },
        {
            "sha": "e68d9cd35207776f9ac722d33da82c14ca1b89d2",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 39,
            "deletions": 70,
            "changes": 109,
            "blob_url": "https://github.com/vercel/next.js/blob/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=f6faf575bb15a01602d3c33be50ea46163abc443",
            "patch": "@@ -4,7 +4,6 @@ import React, {\n   use,\n   useEffect,\n   useMemo,\n-  useCallback,\n   startTransition,\n   useInsertionEffect,\n   useDeferredValue,\n@@ -24,22 +23,19 @@ import {\n   ACTION_PREFETCH,\n   ACTION_REFRESH,\n   ACTION_RESTORE,\n-  ACTION_SERVER_PATCH,\n   PrefetchKind,\n } from './router-reducer/router-reducer-types'\n import type {\n   AppRouterState,\n-  ReducerActions,\n-  RouterChangeByServerResponse,\n-  RouterNavigate,\n+  NavigateAction,\n } from './router-reducer/router-reducer-types'\n import { createHrefFromUrl } from './router-reducer/create-href-from-url'\n import {\n   SearchParamsContext,\n   PathnameContext,\n   PathParamsContext,\n } from '../../shared/lib/hooks-client-context.shared-runtime'\n-import { useReducer, useUnwrapState } from './use-reducer'\n+import { dispatchAppRouterAction, useActionQueue } from './use-action-queue'\n import {\n   default as DefaultGlobalError,\n   ErrorBoundary,\n@@ -56,7 +52,6 @@ import { hasBasePath } from '../has-base-path'\n import { getSelectedParams } from './router-reducer/compute-changed-path'\n import type { FlightRouterState } from '../../server/app-render/types'\n import { useNavFailureHandler } from './nav-failure-handler'\n-import { useServerActionDispatcher } from '../app-call-server'\n import type { AppRouterActionQueue } from '../../shared/lib/router/action-queue'\n import { prefetch as prefetchWithSegmentCache } from './segment-cache'\n import { getRedirectTypeFromError, getURLFromRedirectError } from './redirect'\n@@ -169,47 +164,26 @@ export function createEmptyCacheNode(): CacheNode {\n   }\n }\n \n-/**\n- * Server response that only patches the cache and tree.\n- */\n-function useChangeByServerResponse(\n-  dispatch: React.Dispatch<ReducerActions>\n-): RouterChangeByServerResponse {\n-  return useCallback(\n-    ({ previousTree, serverResponse }) => {\n-      startTransition(() => {\n-        dispatch({\n-          type: ACTION_SERVER_PATCH,\n-          previousTree,\n-          serverResponse,\n-        })\n-      })\n-    },\n-    [dispatch]\n-  )\n-}\n-\n-function useNavigate(dispatch: React.Dispatch<ReducerActions>): RouterNavigate {\n-  return useCallback(\n-    (href, navigateType, shouldScroll) => {\n-      const url = new URL(addBasePath(href), location.href)\n-\n-      if (process.env.__NEXT_APP_NAV_FAIL_HANDLING) {\n-        window.next.__pendingUrl = url\n-      }\n-\n-      return dispatch({\n-        type: ACTION_NAVIGATE,\n-        url,\n-        isExternalUrl: isExternalURL(url),\n-        locationSearch: location.search,\n-        shouldScroll: shouldScroll ?? true,\n-        navigateType,\n-        allowAliasing: true,\n-      })\n-    },\n-    [dispatch]\n-  )\n+function dispatchNavigateAction(\n+  href: string,\n+  navigateType: NavigateAction['navigateType'],\n+  shouldScroll: boolean\n+): void {\n+  // TODO: This stuff could just go into the reducer. Leaving as-is for now\n+  // since we're about to rewrite all the router reducer stuff anyway.\n+  const url = new URL(addBasePath(href), location.href)\n+  if (process.env.__NEXT_APP_NAV_FAIL_HANDLING) {\n+    window.next.__pendingUrl = url\n+  }\n+  dispatchAppRouterAction({\n+    type: ACTION_NAVIGATE,\n+    url,\n+    isExternalUrl: isExternalURL(url),\n+    locationSearch: location.search,\n+    shouldScroll,\n+    navigateType,\n+    allowAliasing: true,\n+  })\n }\n \n function copyNextJsInternalHistoryState(data: any) {\n@@ -261,8 +235,8 @@ function Router({\n   assetPrefix: string\n   globalError: [GlobalErrorComponent, React.ReactNode]\n }) {\n-  const [state, dispatch] = useReducer(actionQueue)\n-  const { canonicalUrl } = useUnwrapState(state)\n+  const state = useActionQueue(actionQueue)\n+  const { canonicalUrl } = state\n   // Add memoized pathname/query for useSearchParams and usePathname.\n   const { searchParams, pathname } = useMemo(() => {\n     const url = new URL(\n@@ -279,10 +253,6 @@ function Router({\n     }\n   }, [canonicalUrl])\n \n-  const changeByServerResponse = useChangeByServerResponse(dispatch)\n-  const navigate = useNavigate(dispatch)\n-  useServerActionDispatcher(dispatch)\n-\n   /**\n    * The app router that is exposed through `useRouter`. It's only concerned with dispatching actions to the reducer, does not hold state.\n    */\n@@ -320,17 +290,17 @@ function Router({\n           },\n       replace: (href, options = {}) => {\n         startTransition(() => {\n-          navigate(href, 'replace', options.scroll ?? true)\n+          dispatchNavigateAction(href, 'replace', options.scroll ?? true)\n         })\n       },\n       push: (href, options = {}) => {\n         startTransition(() => {\n-          navigate(href, 'push', options.scroll ?? true)\n+          dispatchNavigateAction(href, 'push', options.scroll ?? true)\n         })\n       },\n       refresh: () => {\n         startTransition(() => {\n-          dispatch({\n+          dispatchAppRouterAction({\n             type: ACTION_REFRESH,\n             origin: window.location.origin,\n           })\n@@ -343,7 +313,7 @@ function Router({\n           )\n         } else {\n           startTransition(() => {\n-            dispatch({\n+            dispatchAppRouterAction({\n               type: ACTION_HMR_REFRESH,\n               origin: window.location.origin,\n             })\n@@ -353,7 +323,7 @@ function Router({\n     }\n \n     return routerInstance\n-  }, [actionQueue, dispatch, navigate])\n+  }, [actionQueue])\n \n   useEffect(() => {\n     // Exists for debugging purposes. Don't use in application code.\n@@ -364,7 +334,7 @@ function Router({\n \n   if (process.env.NODE_ENV !== 'production') {\n     // eslint-disable-next-line react-hooks/rules-of-hooks\n-    const { cache, prefetchCache, tree } = useUnwrapState(state)\n+    const { cache, prefetchCache, tree } = state\n \n     // This hook is in a conditional but that is ok because `process.env.NODE_ENV` never changes\n     // eslint-disable-next-line react-hooks/rules-of-hooks\n@@ -399,7 +369,7 @@ function Router({\n       // of the last MPA navigation.\n       globalMutable.pendingMpaPath = undefined\n \n-      dispatch({\n+      dispatchAppRouterAction({\n         type: ACTION_RESTORE,\n         url: new URL(window.location.href),\n         tree: window.history.state.__PRIVATE_NEXTJS_INTERNALS_TREE,\n@@ -411,7 +381,7 @@ function Router({\n     return () => {\n       window.removeEventListener('pageshow', handlePageShow)\n     }\n-  }, [dispatch])\n+  }, [])\n \n   useEffect(() => {\n     // Ensure that any redirect errors that bubble up outside of the RedirectBoundary\n@@ -450,7 +420,7 @@ function Router({\n   // probably safe because we know this is a singleton component and it's never\n   // in <Offscreen>. At least I hope so. (It will run twice in dev strict mode,\n   // but that's... fine?)\n-  const { pushRef } = useUnwrapState(state)\n+  const { pushRef } = state\n   if (pushRef.mpaNavigation) {\n     // if there's a re-render, we don't want to trigger another redirect if one is already in flight to the same URL\n     if (globalMutable.pendingMpaPath !== canonicalUrl) {\n@@ -484,7 +454,7 @@ function Router({\n         window.history.state?.__PRIVATE_NEXTJS_INTERNALS_TREE\n \n       startTransition(() => {\n-        dispatch({\n+        dispatchAppRouterAction({\n           type: ACTION_RESTORE,\n           url: new URL(url ?? href, href),\n           tree,\n@@ -558,7 +528,7 @@ function Router({\n       // TODO-APP: Ideally the back button should not use startTransition as it should apply the updates synchronously\n       // Without startTransition works if the cache is there for this path\n       startTransition(() => {\n-        dispatch({\n+        dispatchAppRouterAction({\n           type: ACTION_RESTORE,\n           url: new URL(window.location.href),\n           tree: event.state.__PRIVATE_NEXTJS_INTERNALS_TREE,\n@@ -573,9 +543,9 @@ function Router({\n       window.history.replaceState = originalReplaceState\n       window.removeEventListener('popstate', onPopState)\n     }\n-  }, [dispatch])\n+  }, [])\n \n-  const { cache, tree, nextUrl, focusAndScrollRef } = useUnwrapState(state)\n+  const { cache, tree, nextUrl, focusAndScrollRef } = state\n \n   const matchingHead = useMemo(() => {\n     return findHeadInCache(cache, tree[1])\n@@ -599,12 +569,11 @@ function Router({\n \n   const globalLayoutRouterContext = useMemo(() => {\n     return {\n-      changeByServerResponse,\n       tree,\n       focusAndScrollRef,\n       nextUrl,\n     }\n-  }, [changeByServerResponse, tree, focusAndScrollRef, nextUrl])\n+  }, [tree, focusAndScrollRef, nextUrl])\n \n   let head\n   if (matchingHead !== null) {\n@@ -666,7 +635,7 @@ function Router({\n \n   return (\n     <>\n-      <HistoryUpdater appRouterState={useUnwrapState(state)} />\n+      <HistoryUpdater appRouterState={state} />\n       <RuntimeStyles />\n       <PathParamsContext.Provider value={pathParams}>\n         <PathnameContext.Provider value={pathname}>"
        },
        {
            "sha": "574ca764a02f5905dfa73b638d9a30c34480d9f4",
            "filename": "packages/next/src/client/components/layout-router.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx?ref=f6faf575bb15a01602d3c33be50ea46163abc443",
            "patch": "@@ -10,7 +10,10 @@ import type {\n   FlightSegmentPath,\n } from '../../server/app-render/types'\n import type { ErrorComponent } from './error-boundary'\n-import type { FocusAndScrollRef } from './router-reducer/router-reducer-types'\n+import {\n+  ACTION_SERVER_PATCH,\n+  type FocusAndScrollRef,\n+} from './router-reducer/router-reducer-types'\n \n import React, {\n   useContext,\n@@ -35,6 +38,7 @@ import { RedirectBoundary } from './redirect-boundary'\n import { HTTPAccessFallbackBoundary } from './http-access-fallback/error-boundary'\n import { createRouterCacheKey } from './router-reducer/create-router-cache-key'\n import { hasInterceptionRouteInCurrentTree } from './router-reducer/reducers/has-interception-route-in-current-tree'\n+import { dispatchAppRouterAction } from './use-action-queue'\n \n /**\n  * Add refetch marker to router state at the point of the current layout segment.\n@@ -337,7 +341,7 @@ function InnerLayoutRouter({\n     throw new Error('invariant global layout router not mounted')\n   }\n \n-  const { changeByServerResponse, tree: fullTree } = context\n+  const { tree: fullTree } = context\n \n   // `rsc` represents the renderable node for this segment.\n \n@@ -385,7 +389,8 @@ function InnerLayoutRouter({\n         }\n       ).then((serverResponse) => {\n         startTransition(() => {\n-          changeByServerResponse({\n+          dispatchAppRouterAction({\n+            type: ACTION_SERVER_PATCH,\n             previousTree: fullTree,\n             serverResponse,\n           })"
        },
        {
            "sha": "8047598f8ca91772021c4ddadbbf024e85183540",
            "filename": "packages/next/src/client/components/router-reducer/router-reducer-types.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frouter-reducer-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frouter-reducer-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frouter-reducer-types.ts?ref=f6faf575bb15a01602d3c33be50ea46163abc443",
            "patch": "@@ -21,12 +21,6 @@ export type RouterChangeByServerResponse = ({\n   serverResponse: FetchServerResponseResult\n }) => void\n \n-export type RouterNavigate = (\n-  href: string,\n-  navigateType: 'push' | 'replace',\n-  shouldScroll: boolean\n-) => void\n-\n export interface Mutable {\n   mpaNavigation?: boolean\n   patchedTree?: FlightRouterState"
        },
        {
            "sha": "228232b07ab65f96006c31cf719bb302cfb87bb8",
            "filename": "packages/next/src/client/components/use-action-queue.ts",
            "status": "added",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts?ref=f6faf575bb15a01602d3c33be50ea46163abc443",
            "patch": "@@ -0,0 +1,55 @@\n+import type { Dispatch } from 'react'\n+import React, { use } from 'react'\n+import { isThenable } from '../../shared/lib/is-thenable'\n+import type { AppRouterActionQueue } from '../../shared/lib/router/action-queue'\n+import type {\n+  AppRouterState,\n+  ReducerActions,\n+  ReducerState,\n+} from './router-reducer/router-reducer-types'\n+\n+// The app router state lives outside of React, so we can import the dispatch\n+// method directly wherever we need it, rather than passing it around via props\n+// or context.\n+let dispatch: Dispatch<ReducerActions> | null = null\n+\n+export function dispatchAppRouterAction(action: ReducerActions) {\n+  if (dispatch === null) {\n+    throw new Error(\n+      'Internal Next.js error: Router action dispatched before initialization.'\n+    )\n+  }\n+  dispatch(action)\n+}\n+\n+export function useActionQueue(\n+  actionQueue: AppRouterActionQueue\n+): AppRouterState {\n+  const [state, setState] = React.useState<ReducerState>(actionQueue.state)\n+\n+  // Because of a known issue that requires to decode Flight streams inside the\n+  // render phase, we have to be a bit clever and assign the dispatch method to\n+  // a module-level variable upon initialization. The useState hook in this\n+  // module only exists to synchronize state that lives outside of React.\n+  // Ideally, what we'd do instead is pass the state as a prop to root.render;\n+  // this is conceptually how we're modeling the app router state, despite the\n+  // weird implementation details.\n+  if (process.env.NODE_ENV !== 'production') {\n+    const useSyncDevRenderIndicator =\n+      require('./react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator')\n+        .useSyncDevRenderIndicator as typeof import('./react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator').useSyncDevRenderIndicator\n+    // eslint-disable-next-line react-hooks/rules-of-hooks\n+    const syncDevRenderIndicator = useSyncDevRenderIndicator()\n+\n+    dispatch = (action: ReducerActions) => {\n+      syncDevRenderIndicator(() => {\n+        actionQueue.dispatch(action, setState)\n+      })\n+    }\n+  } else {\n+    dispatch = (action: ReducerActions) =>\n+      actionQueue.dispatch(action, setState)\n+  }\n+\n+  return isThenable(state) ? use(state) : state\n+}"
        },
        {
            "sha": "672f30d6a3cb2258229d4b5bf92f2a215cb14b11",
            "filename": "packages/next/src/client/components/use-reducer.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 54,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/e529cf2bce8783daf58b327854f3ebf1ac9c9a9e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e529cf2bce8783daf58b327854f3ebf1ac9c9a9e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-reducer.ts?ref=e529cf2bce8783daf58b327854f3ebf1ac9c9a9e",
            "patch": "@@ -1,54 +0,0 @@\n-import type { Dispatch } from 'react'\n-import React, { use, useCallback } from 'react'\n-import { isThenable } from '../../shared/lib/is-thenable'\n-import type { AppRouterActionQueue } from '../../shared/lib/router/action-queue'\n-import type {\n-  AppRouterState,\n-  ReducerActions,\n-  ReducerState,\n-} from './router-reducer/router-reducer-types'\n-\n-export function useUnwrapState(state: ReducerState): AppRouterState {\n-  // reducer actions can be async, so sometimes we need to suspend until the state is resolved\n-  if (isThenable(state)) {\n-    const result = use(state)\n-    return result\n-  }\n-\n-  return state\n-}\n-export function useReducer(\n-  actionQueue: AppRouterActionQueue\n-): [ReducerState, Dispatch<ReducerActions>] {\n-  const [state, setState] = React.useState<ReducerState>(actionQueue.state)\n-\n-  const syncDevRenderIndicatorInDevelopment =\n-    useSyncDevRenderIndicatorInDevelopment()\n-\n-  const dispatch = useCallback(\n-    (action: ReducerActions) => {\n-      syncDevRenderIndicatorInDevelopment(() =>\n-        actionQueue.dispatch(action, setState)\n-      )\n-    },\n-    [actionQueue, syncDevRenderIndicatorInDevelopment]\n-  )\n-\n-  return [state, dispatch]\n-}\n-\n-const PASS_THROUGH = (fn: () => void) => fn()\n-\n-const useSyncDevRenderIndicatorInDevelopment = () => {\n-  if (process.env.NODE_ENV !== 'production') {\n-    const useSyncDevRenderIndicator =\n-      require('./react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator')\n-        .useSyncDevRenderIndicator as typeof import('./react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator').useSyncDevRenderIndicator\n-\n-    // eslint-disable-next-line react-hooks/rules-of-hooks\n-    const syncDevRenderIndicator = useSyncDevRenderIndicator()\n-    return syncDevRenderIndicator\n-  } else {\n-    return PASS_THROUGH\n-  }\n-}"
        },
        {
            "sha": "28770eeb3e8063bf5a7c7ea840ed0e65d3c3c8b7",
            "filename": "packages/next/src/shared/lib/app-router-context.shared-runtime.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-context.shared-runtime.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f6faf575bb15a01602d3c33be50ea46163abc443/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-context.shared-runtime.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-context.shared-runtime.ts?ref=f6faf575bb15a01602d3c33be50ea46163abc443",
            "patch": "@@ -4,7 +4,6 @@ import type { FetchServerResponseResult } from '../../client/components/router-r\n import type {\n   FocusAndScrollRef,\n   PrefetchKind,\n-  RouterChangeByServerResponse,\n } from '../../client/components/router-reducer/router-reducer-types'\n import type {\n   FlightRouterState,\n@@ -162,7 +161,6 @@ export const LayoutRouterContext = React.createContext<{\n \n export const GlobalLayoutRouterContext = React.createContext<{\n   tree: FlightRouterState\n-  changeByServerResponse: RouterChangeByServerResponse\n   focusAndScrollRef: FocusAndScrollRef\n   nextUrl: string | null\n }>(null as any)"
        },
        {
            "sha": "5701cb51be02476dd2e6b198c51a89fe12d8af4b",
            "filename": "test/development/app-dir/error-overlay/error-ignored-frames/error-ignored-frames.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f6faf575bb15a01602d3c33be50ea46163abc443/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Ferror-ignored-frames%2Ferror-ignored-frames.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f6faf575bb15a01602d3c33be50ea46163abc443/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Ferror-ignored-frames%2Ferror-ignored-frames.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Ferror-ignored-frames%2Ferror-ignored-frames.test.ts?ref=f6faf575bb15a01602d3c33be50ea46163abc443",
            "patch": "@@ -45,8 +45,8 @@ describe('error-ignored-frames', () => {\n        at processFullStringRow ()\n        at processFullBinaryRow ()\n        at progress ()\n-       at InnerLayoutRouter (../src/client/components/layout-router.tsx (408:5))\n-       at OuterLayoutRouter (../src/client/components/layout-router.tsx (607:19))\"\n+       at InnerLayoutRouter (../src/client/components/layout-router.tsx (413:5))\n+       at OuterLayoutRouter (../src/client/components/layout-router.tsx (612:19))\"\n       `)\n     }\n   })"
        }
    ],
    "stats": {
        "total": 291,
        "additions": 117,
        "deletions": 174
    }
}