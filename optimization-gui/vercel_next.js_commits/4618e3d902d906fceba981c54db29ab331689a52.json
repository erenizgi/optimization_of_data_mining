{
    "author": "eps1lon",
    "message": "Hide <anonymous> stackframes if sandwiched between two ignore-listed frames (#81067)",
    "sha": "4618e3d902d906fceba981c54db29ab331689a52",
    "files": [
        {
            "sha": "918c01110e6f61d38933eed4881487c869726694",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/call-stack-frame/call-stack-frame.stories.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fcall-stack-frame%2Fcall-stack-frame.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fcall-stack-frame%2Fcall-stack-frame.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fcall-stack-frame%2Fcall-stack-frame.stories.tsx?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -29,6 +29,7 @@ export default meta\n type Story = StoryObj<typeof CallStackFrame>\n \n const frame = {\n+  originalCodeFrame: null,\n   originalStackFrame: {\n     file: './app/page.tsx',\n     methodName: 'MyComponent',"
        },
        {
            "sha": "f31390c86553675e6552d423dceacb8293aa7c61",
            "filename": "packages/next/src/next-devtools/dev-overlay/container/errors.stories.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcontainer%2Ferrors.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcontainer%2Ferrors.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcontainer%2Ferrors.stories.tsx?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -91,6 +91,8 @@ export const WithHydrationWarning: Story = {\n               reason: 'First error message',\n               external: false,\n               ignored: false,\n+              originalStackFrame: null,\n+              originalCodeFrame: null,\n               sourceStackFrame: {\n                 file: 'app/page.tsx',\n                 methodName: 'Home',"
        },
        {
            "sha": "42b7226fce75c73a571de5f363e1ebd0fc90377a",
            "filename": "packages/next/src/next-devtools/server/shared.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 2,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Fshared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Fshared.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -1,6 +1,7 @@\n import type { StackFrame } from 'stacktrace-parser'\n import { codeFrameColumns } from 'next/dist/compiled/babel/code-frame'\n import isInternal from '../../shared/lib/is-internal'\n+import { ignoreListAnonymousStackFramesIfSandwiched as ignoreListAnonymousStackFramesIfSandwichedGeneric } from '../../server/lib/source-maps'\n \n export interface OriginalStackFramesRequest {\n   frames: StackFrame[]\n@@ -15,8 +16,41 @@ export type OriginalStackFrameResponseResult =\n   PromiseSettledResult<OriginalStackFrameResponse>\n \n export interface OriginalStackFrameResponse {\n-  originalStackFrame?: (StackFrame & { ignored: boolean }) | null\n-  originalCodeFrame?: string | null\n+  originalStackFrame: (StackFrame & { ignored: boolean }) | null\n+  originalCodeFrame: string | null\n+}\n+\n+export function ignoreListAnonymousStackFramesIfSandwiched(\n+  responses: OriginalStackFramesResponse\n+): void {\n+  ignoreListAnonymousStackFramesIfSandwichedGeneric(\n+    responses,\n+    (response) => {\n+      return (\n+        response.status === 'fulfilled' &&\n+        response.value.originalStackFrame !== null &&\n+        response.value.originalStackFrame.file === '<anonymous>'\n+      )\n+    },\n+    (response) => {\n+      return (\n+        response.status === 'fulfilled' &&\n+        response.value.originalStackFrame !== null &&\n+        response.value.originalStackFrame.ignored === true\n+      )\n+    },\n+    (response) => {\n+      return response.status === 'fulfilled' &&\n+        response.value.originalStackFrame !== null\n+        ? response.value.originalStackFrame.methodName\n+        : ''\n+    },\n+    (response) => {\n+      ;(\n+        response as PromiseFulfilledResult<OriginalStackFrameResponse>\n+      ).value.originalStackFrame!.ignored = true\n+    }\n+  )\n }\n \n /**"
        },
        {
            "sha": "a2a31c0c86b6b9d4f0491c718da5d82c7152bc60",
            "filename": "packages/next/src/server/dev/middleware-turbopack.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -1,6 +1,7 @@\n import type { IncomingMessage, ServerResponse } from 'http'\n import {\n   getOriginalCodeFrame,\n+  ignoreListAnonymousStackFramesIfSandwiched,\n   type OriginalStackFrameResponse,\n   type OriginalStackFramesRequest,\n   type OriginalStackFramesResponse,\n@@ -358,6 +359,8 @@ export function getOverlayMiddleware({\n         isAppDirectory: request.isAppDirectory,\n       })\n \n+      ignoreListAnonymousStackFramesIfSandwiched(result)\n+\n       return middlewareResponse.json(res, result)\n     } else if (pathname === '/__nextjs_launch-editor') {\n       const isAppRelativePath = searchParams.get('isAppRelativePath') === '1'"
        },
        {
            "sha": "ed240ca886c5ea1c329d2e7cf91b2e6621e601e5",
            "filename": "packages/next/src/server/dev/middleware-webpack.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 25,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -14,6 +14,7 @@ import {\n import { openFileInEditor } from '../../next-devtools/server/launch-editor'\n import {\n   getOriginalCodeFrame,\n+  ignoreListAnonymousStackFramesIfSandwiched,\n   type OriginalStackFrameResponse,\n   type OriginalStackFramesRequest,\n   type OriginalStackFramesResponse,\n@@ -373,7 +374,7 @@ async function getSource(\n   return undefined\n }\n \n-export function getOriginalStackFrames({\n+export async function getOriginalStackFrames({\n   isServer,\n   isEdgeServer,\n   isAppDirectory,\n@@ -392,33 +393,38 @@ export function getOriginalStackFrames({\n   edgeServerStats: () => webpack.Stats | null\n   rootDirectory: string\n }): Promise<OriginalStackFramesResponse> {\n-  return Promise.all(\n-    frames.map((frame) =>\n-      getOriginalStackFrame({\n-        isServer,\n-        isEdgeServer,\n-        isAppDirectory,\n-        frame,\n-        clientStats,\n-        serverStats,\n-        edgeServerStats,\n-        rootDirectory,\n-      }).then(\n-        (value) => {\n-          return {\n-            status: 'fulfilled' as const,\n-            value,\n-          }\n-        },\n-        (reason) => {\n-          return {\n-            status: 'rejected' as const,\n-            reason: inspect(reason, { colors: false }),\n+  const frameResponses = await Promise.all(\n+    frames.map(\n+      (frame): Promise<OriginalStackFramesResponse[number]> =>\n+        getOriginalStackFrame({\n+          isServer,\n+          isEdgeServer,\n+          isAppDirectory,\n+          frame,\n+          clientStats,\n+          serverStats,\n+          edgeServerStats,\n+          rootDirectory,\n+        }).then(\n+          (value) => {\n+            return {\n+              status: 'fulfilled',\n+              value,\n+            }\n+          },\n+          (reason) => {\n+            return {\n+              status: 'rejected',\n+              reason: inspect(reason, { colors: false }),\n+            }\n           }\n-        }\n-      )\n+        )\n     )\n   )\n+\n+  ignoreListAnonymousStackFramesIfSandwiched(frameResponses)\n+\n+  return frameResponses\n }\n \n async function getOriginalStackFrame({"
        },
        {
            "sha": "c532691a43b13fccc3ef86ae6e3aeabeacbd8f80",
            "filename": "packages/next/src/server/lib/source-maps.test.ts",
            "status": "added",
            "additions": 228,
            "deletions": 0,
            "changes": 228,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.test.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -0,0 +1,228 @@\n+import { ignoreListAnonymousStackFramesIfSandwiched } from './source-maps'\n+\n+type StackFrame = null | {\n+  file: string\n+  methodName: string\n+  ignored: boolean\n+}\n+\n+// Reference implementation with nullable frames.\n+function ignoreList(frames: StackFrame[]) {\n+  ignoreListAnonymousStackFramesIfSandwiched(\n+    frames,\n+    (frame) => frame !== null && frame.file === '<anonymous>',\n+    (frame) => frame !== null && frame.ignored,\n+    (frame) => (frame === null ? '' : frame.methodName),\n+    (frame) => {\n+      frame!.ignored = true\n+    }\n+  )\n+}\n+\n+test('hides small sandwiches', () => {\n+  const frames: StackFrame[] = [\n+    { ignored: true, file: 'file1.js', methodName: 'Page' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: 'file2.js', methodName: 'render' },\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    { ignored: true, file: 'file1.js', methodName: 'Page' },\n+    { ignored: true, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: 'file2.js', methodName: 'render' },\n+  ])\n+})\n+\n+test('hides big sandwiches', () => {\n+  const frames: StackFrame[] = [\n+    { ignored: true, file: 'file1.js', methodName: 'Page' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: 'file2.js', methodName: 'render' },\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    { file: 'file1.js', methodName: 'Page', ignored: true },\n+    { ignored: true, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: 'file2.js', methodName: 'render' },\n+  ])\n+})\n+\n+it('hides big macs', () => {\n+  const frames: StackFrame[] = [\n+    { ignored: true, file: 'file1.js', methodName: 'query' },\n+    { ignored: false, file: '<anonymous>', methodName: 'Set.forEach' },\n+    { ignored: true, file: 'file1.js', methodName: 'tryUser' },\n+    { ignored: false, file: '<anonymous>', methodName: 'Array.forEach' },\n+    { ignored: true, file: 'file1.js', methodName: 'getUser' },\n+    { ignored: false, file: 'page.js', methodName: 'Component' },\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    { ignored: true, file: 'file1.js', methodName: 'query' },\n+    { ignored: true, file: '<anonymous>', methodName: 'Set.forEach' },\n+    { ignored: true, file: 'file1.js', methodName: 'tryUser' },\n+    { ignored: true, file: '<anonymous>', methodName: 'Array.forEach' },\n+    { ignored: true, file: 'file1.js', methodName: 'getUser' },\n+    { ignored: false, file: 'page.js', methodName: 'Component' },\n+  ])\n+})\n+\n+test('does not hide sandwiches without a lid', () => {\n+  const frames: StackFrame[] = [\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: 'file2.js', methodName: 'render' },\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: 'file2.js', methodName: 'render' },\n+  ])\n+})\n+\n+test('does not ignore list anonymous frames where the bottom is shown', () => {\n+  const frames: StackFrame[] = [\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: 'file2.js', methodName: 'render' },\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: 'file2.js', methodName: 'render' },\n+  ])\n+})\n+\n+test('does not ignore list anonymous frames by default', () => {\n+  const frames: StackFrame[] = [\n+    { ignored: false, file: 'file1.js', methodName: 'Page' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: 'file2.js', methodName: 'render' },\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    { ignored: false, file: 'file1.js', methodName: 'Page' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: 'file2.js', methodName: 'render' },\n+  ])\n+})\n+\n+test('does not ignore list if bottom is not ignore-listed', () => {\n+  const frames: StackFrame[] = [\n+    { ignored: true, file: 'file1.js', methodName: 'Page' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: 'file2.js', methodName: 'render' },\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    { ignored: true, file: 'file1.js', methodName: 'Page' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: 'file2.js', methodName: 'render' },\n+  ])\n+})\n+\n+test('does not ignore list if top is not ignore-listed', () => {\n+  const frames: StackFrame[] = [\n+    { ignored: false, file: 'file1.js', methodName: 'Page' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: 'file2.js', methodName: 'render' },\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    { ignored: false, file: 'file1.js', methodName: 'Page' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: 'file2.js', methodName: 'render' },\n+  ])\n+})\n+\n+test('does not ignore list if top is unknown', () => {\n+  const frames: StackFrame[] = [\n+    null,\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: 'file2.js', methodName: 'JSON.parse' },\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    null,\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: true, file: 'file2.js', methodName: 'JSON.parse' },\n+  ])\n+})\n+\n+test('does not ignore list if bottom is unknown', () => {\n+  const frames: StackFrame[] = [\n+    { ignored: true, file: 'file1.js', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    null,\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    { ignored: true, file: 'file1.js', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    { ignored: false, file: '<anonymous>', methodName: 'JSON.parse' },\n+    null,\n+  ])\n+})\n+\n+test('does not ignore list anonymous frames that are not likely JS native methods', () => {\n+  const frames: StackFrame[] = [\n+    { ignored: true, file: 'file1.js', methodName: 'Page' },\n+    { ignored: false, file: '<anonymous>', methodName: 'body' },\n+    { ignored: false, file: '<anonymous>', methodName: 'html' },\n+    { ignored: true, file: 'file2.js', methodName: 'render' },\n+  ]\n+\n+  ignoreList(frames)\n+\n+  expect(frames).toEqual([\n+    { ignored: true, file: 'file1.js', methodName: 'Page' },\n+    { ignored: false, file: '<anonymous>', methodName: 'body' },\n+    { ignored: false, file: '<anonymous>', methodName: 'html' },\n+    { ignored: true, file: 'file2.js', methodName: 'render' },\n+  ])\n+})"
        },
        {
            "sha": "6fb439bed1eac9f82c1dd7eb62fd67775067253f",
            "filename": "packages/next/src/server/lib/source-maps.ts",
            "status": "modified",
            "additions": 66,
            "deletions": 0,
            "changes": 66,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -168,3 +168,69 @@ export function devirtualizeReactServerURL(sourceURL: string): string {\n   }\n   return sourceURL\n }\n+\n+function isAnonymousFrameLikelyJSNative(methodName: string): boolean {\n+  // Anonymous frames can also be produced in React parent stacks either from\n+  // host components or Server Components. We don't want to ignore those.\n+  // This could hide user-space methods that are named like native JS methods but\n+  // should you really do that?\n+  return (\n+    // e.g. JSON.parse\n+    methodName.startsWith('JSON.') ||\n+    // E.g. Promise.withResolves\n+    methodName.startsWith('Function.') ||\n+    // various JS built-ins\n+    methodName.startsWith('Promise.') ||\n+    methodName.startsWith('Array.') ||\n+    methodName.startsWith('Set.') ||\n+    methodName.startsWith('Map.')\n+  )\n+}\n+\n+export function ignoreListAnonymousStackFramesIfSandwiched<Frame>(\n+  frames: Frame[],\n+  isAnonymousFrame: (frame: Frame) => boolean,\n+  isIgnoredFrame: (frame: Frame) => boolean,\n+  getMethodName: (frame: Frame) => string,\n+  /** only passes frames for which `isAnonymousFrame` and their method is a native JS method or `isIgnoredFrame` return true */\n+  ignoreFrame: (frame: Frame) => void\n+): void {\n+  for (let i = 1; i < frames.length; i++) {\n+    const currentFrame = frames[i]\n+    if (\n+      !(\n+        isAnonymousFrame(currentFrame) &&\n+        isAnonymousFrameLikelyJSNative(getMethodName(currentFrame))\n+      )\n+    ) {\n+      continue\n+    }\n+\n+    const previousFrameIsIgnored = isIgnoredFrame(frames[i - 1])\n+    if (previousFrameIsIgnored && i < frames.length - 1) {\n+      let ignoreSandwich = false\n+      let j = i + 1\n+      for (j; j < frames.length; j++) {\n+        const nextFrame = frames[j]\n+        const nextFrameIsAnonymous =\n+          isAnonymousFrame(nextFrame) &&\n+          isAnonymousFrameLikelyJSNative(getMethodName(nextFrame))\n+        if (nextFrameIsAnonymous) {\n+          continue\n+        }\n+\n+        const nextFrameIsIgnored = isIgnoredFrame(nextFrame)\n+        if (nextFrameIsIgnored) {\n+          ignoreSandwich = true\n+          break\n+        }\n+      }\n+\n+      if (ignoreSandwich) {\n+        for (i; i < j; i++) {\n+          ignoreFrame(frames[i])\n+        }\n+      }\n+    }\n+  }\n+}"
        },
        {
            "sha": "ebdfc75a0273539c70bc8d3fde49d6758ccd0f4f",
            "filename": "packages/next/src/server/patch-error-inspect.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 10,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -7,6 +7,7 @@ import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n import {\n   type ModernSourceMapPayload,\n   findApplicableSourceMapPayload,\n+  ignoreListAnonymousStackFramesIfSandwiched as ignoreListAnonymousStackFramesIfSandwichedGeneric,\n   sourceMapIgnoreListsEverything,\n } from './lib/source-maps'\n import { parseStack } from './lib/parse-stack'\n@@ -120,6 +121,23 @@ function createUnsourcemappedFrame(\n   }\n }\n \n+function ignoreListAnonymousStackFramesIfSandwiched(\n+  sourceMappedFrames: Array<{\n+    stack: IgnoreableStackFrame\n+    code: string | null\n+  }>\n+) {\n+  return ignoreListAnonymousStackFramesIfSandwichedGeneric(\n+    sourceMappedFrames,\n+    (frame) => frame.stack.file === '<anonymous>',\n+    (frame) => frame.stack.ignored,\n+    (frame) => frame.stack.methodName,\n+    (frame) => {\n+      frame.stack.ignored = true\n+    }\n+  )\n+}\n+\n /**\n  * @param frame\n  * @param sourceMapCache\n@@ -324,19 +342,36 @@ function parseAndSourceMap(\n   const unsourcemappedStack = parseStack(unparsedStack)\n   const sourceMapCache: SourceMapCache = new Map()\n \n-  let sourceMappedStack = ''\n+  const sourceMappedFrames: Array<{\n+    stack: IgnoreableStackFrame\n+    code: string | null\n+  }> = []\n   let sourceFrame: null | string = null\n   for (const frame of unsourcemappedStack) {\n     if (frame.file === null) {\n-      sourceMappedStack += '\\n' + frameToString(frame)\n+      sourceMappedFrames.push({\n+        code: null,\n+        stack: {\n+          arguments: frame.arguments,\n+          column: frame.column,\n+          file: frame.file,\n+          lineNumber: frame.lineNumber,\n+          methodName: frame.methodName,\n+          ignored: false,\n+        },\n+      })\n     } else {\n       const sourcemappedFrame = getSourcemappedFrameIfPossible(\n         // We narrowed this earlier by bailing if `frame.file` is null.\n         frame as SourcemappableStackFrame,\n         sourceMapCache,\n         inspectOptions\n       )\n+      sourceMappedFrames.push(sourcemappedFrame)\n \n+      // We can determine the sourceframe here.\n+      // anonymous frames won't have a sourceframe so we don't need to scan\n+      // all stacks again to check if they are sandwiched between ignored frames.\n       if (\n         sourceFrame === null &&\n         // TODO: Is this the right choice?\n@@ -345,14 +380,19 @@ function parseAndSourceMap(\n       ) {\n         sourceFrame = sourcemappedFrame.code\n       }\n-      if (!sourcemappedFrame.stack.ignored) {\n-        // TODO: Consider what happens if every frame is ignore listed.\n-        sourceMappedStack += '\\n' + frameToString(sourcemappedFrame.stack)\n-      } else if (showIgnoreListed && !inspectOptions.colors) {\n-        sourceMappedStack += '\\n' + frameToString(sourcemappedFrame.stack)\n-      } else if (showIgnoreListed) {\n-        sourceMappedStack += '\\n' + dim(frameToString(sourcemappedFrame.stack))\n-      }\n+    }\n+  }\n+\n+  ignoreListAnonymousStackFramesIfSandwiched(sourceMappedFrames)\n+\n+  let sourceMappedStack = ''\n+  for (let i = 0; i < sourceMappedFrames.length; i++) {\n+    const frame = sourceMappedFrames[i]\n+\n+    if (!frame.stack.ignored) {\n+      sourceMappedStack += '\\n' + frameToString(frame.stack)\n+    } else if (showIgnoreListed) {\n+      sourceMappedStack += '\\n' + dim(frameToString(frame.stack))\n     }\n   }\n "
        },
        {
            "sha": "6203985c7a1fbc6a34adf4a405475446f8dfee87",
            "filename": "test/development/acceptance-app/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -932,7 +932,6 @@ describe('ReactRefreshLogBox app', () => {\n     )\n \n     if (isTurbopack) {\n-      // Set.forEach: https://linear.app/vercel/issue/NDX-554/\n       // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -945,7 +944,6 @@ describe('ReactRefreshLogBox app', () => {\n            |           ^\",\n          \"stack\": [\n            \"{default export} index.js (3:11)\",\n-           \"Set.forEach <anonymous>\",\n            \"<FIXME-file-protocol>\",\n            \"<FIXME-file-protocol>\",\n            \"Page app/page.js (2:1)\",\n@@ -1038,7 +1036,6 @@ describe('ReactRefreshLogBox app', () => {\n     // Render error should \"win\" and show up in fullscreen\n     // TODO(veil): Why Owner Stack location different?\n     if (isTurbopack) {\n-      // Set.forEach: https://linear.app/vercel/issue/NDX-554/\n       // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -1050,7 +1047,6 @@ describe('ReactRefreshLogBox app', () => {\n            |                                            ^\",\n          \"stack\": [\n            \"Index index.js (2:44)\",\n-           \"Set.forEach <anonymous>\",\n            \"<FIXME-file-protocol>\",\n            \"<FIXME-file-protocol>\",\n            \"Page index.js (16:8)\","
        },
        {
            "sha": "6da4dd1c7557b31efa2ad27aec435e82c57a87b3",
            "filename": "test/development/acceptance-app/error-recovery.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -475,7 +475,6 @@ describe('Error recovery app', () => {\n     )\n \n     if (isTurbopack) {\n-      // Set.forEach: https://linear.app/vercel/issue/NDX-554/\n       // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -487,7 +486,6 @@ describe('Error recovery app', () => {\n            |         ^\",\n          \"stack\": [\n            \"Child child.js (3:9)\",\n-           \"Set.forEach <anonymous>\",\n            \"<FIXME-file-protocol>\",\n            \"<FIXME-file-protocol>\",\n            \"Index index.js (6:7)\",\n@@ -733,7 +731,6 @@ describe('Error recovery app', () => {\n \n     // We get an error because Foo didn't import React. Fair.\n     if (isTurbopack) {\n-      // Set.forEach: https://linear.app/vercel/issue/NDX-554/\n       // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -745,7 +742,6 @@ describe('Error recovery app', () => {\n            |   ^\",\n          \"stack\": [\n            \"Foo Foo.js (3:3)\",\n-           \"Set.forEach <anonymous>\",\n            \"<FIXME-file-protocol>\",\n            \"<FIXME-file-protocol>\",\n            \"FunctionDefault index.js (4:10)\",\n@@ -968,7 +964,6 @@ describe('Error recovery app', () => {\n     )\n     if (isTurbopack) {\n       // TODO(veil): Location of Page should be app/page.js\n-      // Set.forEach: https://linear.app/vercel/issue/NDX-554/\n       // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -980,7 +975,6 @@ describe('Error recovery app', () => {\n            |           ^\",\n          \"stack\": [\n            \"ClassDefault.render index.js (5:11)\",\n-           \"Set.forEach <anonymous>\",\n            \"<FIXME-file-protocol>\",\n            \"<FIXME-file-protocol>\",\n            \"Page index.js (10:16)\","
        },
        {
            "sha": "8cb664619f7dec2bc545d3778a818b0acd4867be",
            "filename": "test/development/acceptance/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -267,7 +267,6 @@ describe('ReactRefreshLogBox', () => {\n            |                                                   ^\",\n            \"stack\": [\n              \"FunctionDefault FunctionDefault.js (1:51)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -281,7 +280,6 @@ describe('ReactRefreshLogBox', () => {\n            |                                                   ^\",\n            \"stack\": [\n              \"FunctionDefault FunctionDefault.js (1:51)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -300,7 +298,6 @@ describe('ReactRefreshLogBox', () => {\n              |                                                   ^\",\n            \"stack\": [\n              \"FunctionDefault FunctionDefault.js (1:51)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -317,7 +314,6 @@ describe('ReactRefreshLogBox', () => {\n              |                                                   ^\",\n            \"stack\": [\n              \"FunctionDefault FunctionDefault.js (1:51)\",\n-             \"Set.forEach <anonymous>\",\n            ],\n          }\n         `)\n@@ -484,7 +480,6 @@ describe('ReactRefreshLogBox', () => {\n            |           ^\",\n            \"stack\": [\n              \"ClickCount.render Child.js (4:11)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -498,7 +493,6 @@ describe('ReactRefreshLogBox', () => {\n            |           ^\",\n            \"stack\": [\n              \"ClickCount.render Child.js (4:11)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -517,7 +511,6 @@ describe('ReactRefreshLogBox', () => {\n              |           ^\",\n            \"stack\": [\n              \"ClickCount.render Child.js (4:11)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -534,7 +527,6 @@ describe('ReactRefreshLogBox', () => {\n              |           ^\",\n            \"stack\": [\n              \"ClickCount.render Child.js (4:11)\",\n-             \"Set.forEach <anonymous>\",\n            ],\n          }\n         `)"
        },
        {
            "sha": "d2db5c9422784241ec91d7f83beb31a776b4f467",
            "filename": "test/development/acceptance/error-recovery.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -258,7 +258,6 @@ describe('pages/ error recovery', () => {\n            |         ^\",\n            \"stack\": [\n              \"Child child.js (3:9)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -272,7 +271,6 @@ describe('pages/ error recovery', () => {\n            |         ^\",\n            \"stack\": [\n              \"Child child.js (3:9)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -291,7 +289,6 @@ describe('pages/ error recovery', () => {\n              |         ^\",\n            \"stack\": [\n              \"Child child.js (3:9)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -308,7 +305,6 @@ describe('pages/ error recovery', () => {\n              |         ^\",\n            \"stack\": [\n              \"Child child.js (3:9)\",\n-             \"Set.forEach <anonymous>\",\n            ],\n          }\n         `)\n@@ -562,7 +558,6 @@ describe('pages/ error recovery', () => {\n            |           ^\",\n            \"stack\": [\n              \"ClassDefault.render index.js (5:11)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -576,7 +571,6 @@ describe('pages/ error recovery', () => {\n            |           ^\",\n            \"stack\": [\n              \"ClassDefault.render index.js (5:11)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -610,7 +604,6 @@ describe('pages/ error recovery', () => {\n                |           ^\",\n              \"stack\": [\n                \"ClassDefault.render index.js (5:11)\",\n-               \"Set.forEach <anonymous>\",\n                \"<FIXME-file-protocol>\",\n                \"<FIXME-file-protocol>\",\n              ],\n@@ -627,7 +620,6 @@ describe('pages/ error recovery', () => {\n                |           ^\",\n              \"stack\": [\n                \"ClassDefault.render index.js (5:11)\",\n-               \"Set.forEach <anonymous>\",\n              ],\n            }\n           `)\n@@ -694,7 +686,6 @@ describe('pages/ error recovery', () => {\n            |   ^\",\n            \"stack\": [\n              \"Foo Foo.js (3:3)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -708,7 +699,6 @@ describe('pages/ error recovery', () => {\n            |   ^\",\n            \"stack\": [\n              \"Foo Foo.js (3:3)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -727,7 +717,6 @@ describe('pages/ error recovery', () => {\n              |   ^\",\n            \"stack\": [\n              \"Foo Foo.js (3:3)\",\n-             \"Set.forEach <anonymous>\",\n              \"<FIXME-file-protocol>\",\n              \"<FIXME-file-protocol>\",\n            ],\n@@ -744,7 +733,6 @@ describe('pages/ error recovery', () => {\n              |   ^\",\n            \"stack\": [\n              \"Foo Foo.js (3:3)\",\n-             \"Set.forEach <anonymous>\",\n            ],\n          }\n         `)"
        },
        {
            "sha": "aaecbbe6ff55b27b65ab158cf5c4200fdd4e3a66",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/app/rsc-anonymous-stack-frame-sandwich/page.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Frsc-anonymous-stack-frame-sandwich%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Frsc-anonymous-stack-frame-sandwich%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Frsc-anonymous-stack-frame-sandwich%2Fpage.js?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -0,0 +1,9 @@\n+import { runHiddenSetOfSets as runHiddenSetOfSetsExternal } from 'external-pkg/sourcemapped'\n+import { runHiddenSetOfSets as runHiddenSetOfSetsInternal } from 'internal-pkg/ignored'\n+\n+export default function Page() {\n+  runHiddenSetOfSetsExternal('rsc-anonymous-stack-frame-sandwich: external')\n+  runHiddenSetOfSetsInternal('rsc-anonymous-stack-frame-sandwich: internal')\n+\n+  return null\n+}"
        },
        {
            "sha": "069d75a869320a31bf468a7932e19abad9c98c2e",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/app/ssr-anonymous-stack-frame-sandwich/page.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fssr-anonymous-stack-frame-sandwich%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fssr-anonymous-stack-frame-sandwich%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fssr-anonymous-stack-frame-sandwich%2Fpage.js?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -0,0 +1,10 @@\n+'use client'\n+import { runHiddenSetOfSets as runHiddenSetOfSetsExternal } from 'external-pkg/sourcemapped'\n+import { runHiddenSetOfSets as runHiddenSetOfSetsInternal } from 'internal-pkg/sourcemapped'\n+\n+export default function Page() {\n+  runHiddenSetOfSetsExternal('ssr-anonymous-stack-frame-sandwich: external')\n+  runHiddenSetOfSetsInternal('ssr-anonymous-stack-frame-sandwich: internal')\n+\n+  return null\n+}"
        },
        {
            "sha": "f5dbe7f7934c6e6f5a3dbc44511209e165eaa3c2",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/external-pkg/sourcemapped.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fexternal-pkg%2Fsourcemapped.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fexternal-pkg%2Fsourcemapped.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fexternal-pkg%2Fsourcemapped.js?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -1,4 +1,14 @@\n export function runExternalSourceMapped(fn) {\n     return fn();\n }\n+export function runSetOfSets(setOfSets) {\n+    setOfSets.forEach((set) => {\n+        set.forEach((fn) => {\n+            fn();\n+        });\n+    });\n+}\n+export function runHiddenSetOfSets(message) {\n+    runSetOfSets(new Set([new Set([() => console.error(new Error(message))])]));\n+}\n //# sourceMappingURL=sourcemapped.js.map\n\\ No newline at end of file"
        },
        {
            "sha": "9d5420e509aaae3bb23cc19af66dce957b566e90",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/external-pkg/sourcemapped.js.map",
            "status": "modified",
            "additions": 1,
            "deletions": 10,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fexternal-pkg%2Fsourcemapped.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fexternal-pkg%2Fsourcemapped.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fexternal-pkg%2Fsourcemapped.js.map?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -1,10 +1 @@\n-{\n-  \"version\": 3,\n-  \"file\": \"sourcemapped.js\",\n-  \"sourceRoot\": \"\",\n-  \"sources\": [\n-    \"sourcemapped.ts\"\n-  ],\n-  \"names\": [],\n-  \"mappings\": \"AAGA,MAAM,UAAU,uBAAuB,CAAI,EAAS;IAClD,OAAO,EAAE,EAAE,CAAA;AACb,CAAC\"\n-}\n+{\"version\":3,\"file\":\"sourcemapped.js\",\"sourceRoot\":\"\",\"sources\":[\"sourcemapped.ts\"],\"names\":[],\"mappings\":\"AAGA,MAAM,UAAU,uBAAuB,CAAI,EAAS;IAClD,OAAO,EAAE,EAAE,CAAA;AACb,CAAC;AAED,MAAM,UAAU,YAAY,CAAC,SAA4B;IACvD,SAAS,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE;QACxB,GAAG,CAAC,OAAO,CAAC,CAAC,EAAE,EAAE,EAAE;YACjB,EAAE,EAAE,CAAA;QACN,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;AACJ,CAAC;AAED,MAAM,UAAU,kBAAkB,CAAC,OAAe;IAChD,YAAY,CAAC,IAAI,GAAG,CAAC,CAAC,IAAI,GAAG,CAAC,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAA;AAC7E,CAAC\"}\n\\ No newline at end of file"
        },
        {
            "sha": "5a3fc192581fc691d3425573a5465f0bd72449b2",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/external-pkg/sourcemapped.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fexternal-pkg%2Fsourcemapped.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fexternal-pkg%2Fsourcemapped.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fexternal-pkg%2Fsourcemapped.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -4,3 +4,15 @@ type Fn<T> = () => T\n export function runExternalSourceMapped<T>(fn: Fn<T>): T {\n   return fn()\n }\n+\n+export function runSetOfSets(setOfSets: Set<Set<Fn<any>>>): void {\n+  setOfSets.forEach((set) => {\n+    set.forEach((fn) => {\n+      fn()\n+    })\n+  })\n+}\n+\n+export function runHiddenSetOfSets(message: string): void {\n+  runSetOfSets(new Set([new Set([() => console.error(new Error(message))])]))\n+}"
        },
        {
            "sha": "4f5dacff81d107d8a01a7ef330efd8608e95577f",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/ignored.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fignored.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fignored.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fignored.js?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -1,4 +1,14 @@\n export function runInternalIgnored(fn) {\n     return fn();\n }\n+export function runSetOfSets(setOfSets) {\n+    setOfSets.forEach((set) => {\n+        set.forEach((fn) => {\n+            fn();\n+        });\n+    });\n+}\n+export function runHiddenSetOfSets(message) {\n+    runSetOfSets(new Set([new Set([() => console.error(new Error(message))])]));\n+}\n //# sourceMappingURL=ignored.js.map\n\\ No newline at end of file"
        },
        {
            "sha": "7fc55dd0e0549e4c267b1051b537a24d9abe379b",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/ignored.js.map",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fignored.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fignored.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fignored.js.map?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -9,5 +9,5 @@\n     0\n   ],\n   \"names\": [],\n-  \"mappings\": \"AAIA,MAAM,UAAU,kBAAkB,CAAI,EAAS;IAC7C,OAAO,EAAE,EAAE,CAAA;AACb,CAAC\"\n+  \"mappings\": \"AAIA,MAAM,UAAU,kBAAkB,CAAI,EAAS;IAC7C,OAAO,EAAE,EAAE,CAAA;AACb,CAAC;AAED,MAAM,UAAU,YAAY,CAAC,SAA4B;IACvD,SAAS,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE;QACxB,GAAG,CAAC,OAAO,CAAC,CAAC,EAAE,EAAE,EAAE;YACjB,EAAE,EAAE,CAAA;QACN,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;AACJ,CAAC;AAED,MAAM,UAAU,kBAAkB,CAAC,OAAe;IAChD,YAAY,CAAC,IAAI,GAAG,CAAC,CAAC,IAAI,GAAG,CAAC,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAA;AAC7E,CAAC\"\n }"
        },
        {
            "sha": "725af7d4bdfd3038db5cdf4451b499869a3f3fb4",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/ignored.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fignored.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fignored.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fignored.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -5,3 +5,15 @@ type Fn<T> = () => T\n export function runInternalIgnored<T>(fn: Fn<T>): T {\n   return fn()\n }\n+\n+export function runSetOfSets(setOfSets: Set<Set<Fn<any>>>): void {\n+  setOfSets.forEach((set) => {\n+    set.forEach((fn) => {\n+      fn()\n+    })\n+  })\n+}\n+\n+export function runHiddenSetOfSets(message: string): void {\n+  runSetOfSets(new Set([new Set([() => console.error(new Error(message))])]))\n+}"
        },
        {
            "sha": "0e8f03f70a34315e98f75e260ce39982df6d1329",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/sourcemapped.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fsourcemapped.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fsourcemapped.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fsourcemapped.js?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -1,4 +1,14 @@\n export function runInternalSourceMapped(fn) {\n     return fn();\n }\n+export function runSetOfSets(setOfSets) {\n+    setOfSets.forEach((set) => {\n+        set.forEach((fn) => {\n+            fn();\n+        });\n+    });\n+}\n+export function runHiddenSetOfSets() {\n+    runSetOfSets(new Set([new Set([() => console.error(new Error('ignore-listed frames'))])]));\n+}\n //# sourceMappingURL=sourcemapped.js.map\n\\ No newline at end of file"
        },
        {
            "sha": "2d8667764fe790e41de899275094480b72346a4c",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/sourcemapped.js.map",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fsourcemapped.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fsourcemapped.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Finternal-pkg%2Fsourcemapped.js.map?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -1 +1 @@\n-{\"version\":3,\"file\":\"sourcemapped.js\",\"sourceRoot\":\"\",\"sources\":[\"sourcemapped.ts\"],\"names\":[],\"mappings\":\"AAGA,MAAM,UAAU,uBAAuB,CAAI,EAAS;IAClD,OAAO,EAAE,EAAE,CAAA;AACb,CAAC\"}\n\\ No newline at end of file\n+{\"version\":3,\"file\":\"sourcemapped.js\",\"sourceRoot\":\"\",\"sources\":[\"sourcemapped.ts\"],\"names\":[],\"mappings\":\"AAGA,MAAM,UAAU,uBAAuB,CAAI,EAAS;IAClD,OAAO,EAAE,EAAE,CAAA;AACb,CAAC;AAED,MAAM,UAAU,YAAY,CAAC,SAA4B;IACvD,SAAS,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE;QACxB,GAAG,CAAC,OAAO,CAAC,CAAC,EAAE,EAAE,EAAE;YACjB,EAAE,EAAE,CAAA;QACN,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;AACJ,CAAC;AAED,MAAM,UAAU,kBAAkB;IAChC,YAAY,CACV,IAAI,GAAG,CAAC,CAAC,IAAI,GAAG,CAAC,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAC7E,CAAA;AACH,CAAC\"}\n\\ No newline at end of file"
        },
        {
            "sha": "48fc74efed53636cd63222aa40ddc3ab8dffc7d2",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps.test.ts",
            "status": "modified",
            "additions": 210,
            "deletions": 8,
            "changes": 218,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -5,7 +5,13 @@ import stripAnsi from 'strip-ansi'\n import { retry } from 'next-test-utils'\n \n function normalizeCliOutput(output: string) {\n-  return stripAnsi(output)\n+  return (\n+    stripAnsi(output)\n+      // TODO(veil): Should not appear in sourcemapped stackframes.\n+      .replaceAll('webpack:///', 'bundler:///')\n+      .replaceAll('turbopack:///[project]/', 'bundler:///')\n+      .replaceAll(/at [a-zA-Z] \\(/g, 'at <mangled> (')\n+  )\n }\n \n describe('app-dir - server source maps', () => {\n@@ -52,7 +58,7 @@ describe('app-dir - server source maps', () => {\n         // TODO(veil): Sourcemap names\n         // TODO(veil): relative paths\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n-          '(turbopack:///[project]/app/rsc-error-log/page.js:4:16)'\n+          '(bundler:///app/rsc-error-log/page.js:4:16)'\n         )\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n           '' +\n@@ -101,10 +107,10 @@ describe('app-dir - server source maps', () => {\n         // TODO(veil): Sourcemap names\n         // TODO(veil): relative paths\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n-          '(turbopack:///[project]/app/rsc-error-log-cause/page.js:2:16)'\n+          '(bundler:///app/rsc-error-log-cause/page.js:2:16)'\n         )\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n-          '(turbopack:///[project]/app/rsc-error-log-cause/page.js:7:16)'\n+          '(bundler:///app/rsc-error-log-cause/page.js:7:16)'\n         )\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n           '' +\n@@ -228,7 +234,7 @@ describe('app-dir - server source maps', () => {\n         // TODO(veil): Sourcemap names\n         // TODO(veil): relative paths\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n-          '(turbopack:///[project]/app/ssr-error-log-ignore-listed/page.js:24:2)'\n+          '(bundler:///app/ssr-error-log-ignore-listed/page.js:24:2)'\n         )\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n           '\\n> 24 |   })\\n     |  ^'\n@@ -292,7 +298,7 @@ describe('app-dir - server source maps', () => {\n         // TODO(veil): Sourcemap names\n         // TODO(veil): relative paths\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n-          'at <unknown> (turbopack:///[project]/app/rsc-error-log-ignore-listed/page.js:8:16)'\n+          'at <unknown> (bundler:///app/rsc-error-log-ignore-listed/page.js:8:16)'\n         )\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n           '' +\n@@ -510,7 +516,7 @@ describe('app-dir - server source maps', () => {\n         ).toContain(\n           '' +\n             '\\nError: module-evaluation' +\n-            '\\n    at <TurbopackModuleID> (turbopack:///[project]/app/module-evaluation/module.js:1:21)' +\n+            '\\n    at <TurbopackModuleID> (bundler:///app/module-evaluation/module.js:1:21)' +\n             // TODO(veil): Turbopack internals. Feel free to update. Tracked in https://linear.app/vercel/issue/NEXT-4362\n             '\\n    at Object.<anonymous>'\n         )\n@@ -529,9 +535,205 @@ describe('app-dir - server source maps', () => {\n           '' +\n             '\\nError: module-evaluation' +\n             // TODO(veil): column numbers are flaky in Webpack\n-            '\\n    at <WebpackModuleID> (webpack:///app/module-evaluation/module.js:1:'\n+            '\\n    at <WebpackModuleID> (bundler:///app/module-evaluation/module.js:1:'\n         )\n       }\n     }\n   })\n+\n+  it('ignore-lists anonymous rsc stack frame sandwiches', async () => {\n+    if (isNextDev) {\n+      const outputIndex = next.cliOutput.length\n+      const browser = await next.browser('/rsc-anonymous-stack-frame-sandwich')\n+\n+      // TODO(veil): Implement sandwich heuristic in `filterStackFrameDEV`\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"rsc-anonymous-stack-frame-sandwich: external\",\n+             \"environmentLabel\": \"Prerender\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/rsc-anonymous-stack-frame-sandwich/page.js (5:29) @ Page\n+         > 5 |   runHiddenSetOfSetsExternal('rsc-anonymous-stack-frame-sandwich: external')\n+             |                             ^\",\n+             \"stack\": [\n+               \"Set.forEach <anonymous>\",\n+               \"Set.forEach <anonymous>\",\n+               \"Page app/rsc-anonymous-stack-frame-sandwich/page.js (5:29)\",\n+               \"Page <anonymous>\",\n+             ],\n+           },\n+           {\n+             \"description\": \"rsc-anonymous-stack-frame-sandwich: internal\",\n+             \"environmentLabel\": \"Prerender\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/rsc-anonymous-stack-frame-sandwich/page.js (6:29) @ Page\n+         > 6 |   runHiddenSetOfSetsInternal('rsc-anonymous-stack-frame-sandwich: internal')\n+             |                             ^\",\n+             \"stack\": [\n+               \"Set.forEach <anonymous>\",\n+               \"Set.forEach <anonymous>\",\n+               \"Page app/rsc-anonymous-stack-frame-sandwich/page.js (6:29)\",\n+               \"Page <anonymous>\",\n+             ],\n+           },\n+         ]\n+        `)\n+      } else {\n+        // 2nd error from runHiddenSetOfSetsInternal hits https://linear.app/vercel/issue/NEXT-4412\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"rsc-anonymous-stack-frame-sandwich: external\",\n+             \"environmentLabel\": \"Prerender\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/rsc-anonymous-stack-frame-sandwich/page.js (5:29) @ Page\n+         > 5 |   runHiddenSetOfSetsExternal('rsc-anonymous-stack-frame-sandwich: external')\n+             |                             ^\",\n+             \"stack\": [\n+               \"Set.forEach <anonymous>\",\n+               \"Set.forEach <anonymous>\",\n+               \"Page app/rsc-anonymous-stack-frame-sandwich/page.js (5:29)\",\n+               \"Page <anonymous>\",\n+             ],\n+           },\n+           {\n+             \"description\": \"rsc-anonymous-stack-frame-sandwich: internal\",\n+             \"environmentLabel\": \"Prerender\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/rsc-anonymous-stack-frame-sandwich/page.js (6:29) @ Page\n+         > 6 |   runHiddenSetOfSetsInternal('rsc-anonymous-stack-frame-sandwich: internal')\n+             |                             ^\",\n+             \"stack\": [\n+               \"eval webpack-internal:/(rsc)/internal-pkg/ignored.ts (18:54)\",\n+               \"eval webpack-internal:/(rsc)/internal-pkg/ignored.ts (12:7)\",\n+               \"Set.forEach <anonymous>\",\n+               \"eval webpack-internal:/(rsc)/internal-pkg/ignored.ts (11:9)\",\n+               \"Set.forEach <anonymous>\",\n+               \"runSetOfSets webpack-internal:/(rsc)/internal-pkg/ignored.ts (10:13)\",\n+               \"runHiddenSetOfSets webpack-internal:/(rsc)/internal-pkg/ignored.ts (18:3)\",\n+               \"Page app/rsc-anonymous-stack-frame-sandwich/page.js (6:29)\",\n+               \"Page <anonymous>\",\n+             ],\n+           },\n+         ]\n+        `)\n+      }\n+\n+      expect(normalizeCliOutput(next.cliOutput.slice(outputIndex))).toContain(\n+        '' +\n+          '\\nError: rsc-anonymous-stack-frame-sandwich: external' +\n+          '\\n    at Page (app/rsc-anonymous-stack-frame-sandwich/page.js:5:29)' +\n+          '\\n  3 |' +\n+          '\\n  4 | export default function Page() {' +\n+          \"\\n> 5 |   runHiddenSetOfSetsExternal('rsc-anonymous-stack-frame-sandwich: external')\" +\n+          '\\n    |                             ^'\n+      )\n+      // TODO: assert on 2nd error once that's bug free\n+    } else {\n+      // TODO(veil): assert on 1st error once cursor position is consistent\n+      // TODO(veil): assert on 2nd error once that's bug free\n+    }\n+  })\n+\n+  it('ignore-lists anonymous ssr stack frame sandwiches', async () => {\n+    if (isNextDev) {\n+      const outputIndex = next.cliOutput.length\n+      const browser = await next.browser('/ssr-anonymous-stack-frame-sandwich')\n+\n+      if (isTurbopack) {\n+        // TODO(veil): https://linear.app/vercel/issue/NEXT-4410/\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"ssr-anonymous-stack-frame-sandwich: external\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/ssr-anonymous-stack-frame-sandwich/page.js (6:28) @ Page\n+         > 6 |   runHiddenSetOfSetsExternal('ssr-anonymous-stack-frame-sandwich: external')\n+             |                            ^\",\n+             \"stack\": [\n+               \"<FIXME-file-protocol>\",\n+               \"<FIXME-file-protocol>\",\n+               \"Set.forEach <anonymous>\",\n+               \"<FIXME-file-protocol>\",\n+               \"Set.forEach <anonymous>\",\n+               \"<FIXME-file-protocol>\",\n+               \"<FIXME-file-protocol>\",\n+               \"Page app/ssr-anonymous-stack-frame-sandwich/page.js (6:28)\",\n+             ],\n+           },\n+           {\n+             \"description\": \"ignore-listed frames\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/ssr-anonymous-stack-frame-sandwich/page.js (7:28) @ Page\n+         >  7 |   runHiddenSetOfSetsInternal('ssr-anonymous-stack-frame-sandwich: internal')\n+              |                            ^\",\n+             \"stack\": [\n+               \"<FIXME-file-protocol>\",\n+               \"<FIXME-file-protocol>\",\n+               \"Set.forEach <anonymous>\",\n+               \"<FIXME-file-protocol>\",\n+               \"Set.forEach <anonymous>\",\n+               \"<FIXME-file-protocol>\",\n+               \"<FIXME-file-protocol>\",\n+               \"Page app/ssr-anonymous-stack-frame-sandwich/page.js (7:28)\",\n+             ],\n+           },\n+         ]\n+        `)\n+      } else {\n+        // 2nd error from runHiddenSetOfSetsInternal hits https://linear.app/vercel/issue/NEXT-4412\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"ssr-anonymous-stack-frame-sandwich: external\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/ssr-anonymous-stack-frame-sandwich/page.js (6:29) @ Page\n+         > 6 |   runHiddenSetOfSetsExternal('ssr-anonymous-stack-frame-sandwich: external')\n+             |                             ^\",\n+             \"stack\": [\n+               \"Page app/ssr-anonymous-stack-frame-sandwich/page.js (6:29)\",\n+             ],\n+           },\n+           {\n+             \"description\": \"ignore-listed frames\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/ssr-anonymous-stack-frame-sandwich/page.js (7:29) @ Page\n+         >  7 |   runHiddenSetOfSetsInternal('ssr-anonymous-stack-frame-sandwich: internal')\n+              |                             ^\",\n+             \"stack\": [\n+               \"eval sourcemapped.ts (18:43)\",\n+               \"eval sourcemapped.ts (11:7)\",\n+               \"Set.forEach <anonymous>\",\n+               \"eval sourcemapped.ts (10:9)\",\n+               \"Set.forEach <anonymous>\",\n+               \"runSetOfSets sourcemapped.ts (9:13)\",\n+               \"runHiddenSetOfSets sourcemapped.ts (17:3)\",\n+               \"Page app/ssr-anonymous-stack-frame-sandwich/page.js (7:29)\",\n+             ],\n+           },\n+         ]\n+        `)\n+      }\n+\n+      expect(normalizeCliOutput(next.cliOutput.slice(outputIndex))).toContain(\n+        '' +\n+          '\\nError: ssr-anonymous-stack-frame-sandwich: external' +\n+          '\\n    at Page (app/ssr-anonymous-stack-frame-sandwich/page.js:6:29)' +\n+          '\\n  4 |' +\n+          '\\n  5 | export default function Page() {' +\n+          \"\\n> 6 |   runHiddenSetOfSetsExternal('ssr-anonymous-stack-frame-sandwich: external')\" +\n+          '\\n    |                             ^'\n+      )\n+      // TODO(veil): assert on 2nd error once that's bug free\n+    } else {\n+      // TODO(veil): assert on 1st error once cursor position is consistent\n+      // TODO(veil): assert on 2nd error once that's bug free\n+    }\n+  })\n })"
        },
        {
            "sha": "6e47795198c5d6d34a535ed539365d62208e939e",
            "filename": "test/e2e/next-link-errors/next-link-errors.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fnext-link-errors%2Fnext-link-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Fe2e%2Fnext-link-errors%2Fnext-link-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-link-errors%2Fnext-link-errors.test.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -13,7 +13,6 @@ describe('next-link', () => {\n     const browser = await webdriver(next.appPort, '/invalid-href')\n \n     if (isNextDev) {\n-      // TODO(veil): https://linear.app/vercel/issue/NDX-554/hide-the-anonymous-frames-which-are-between-2-ignored-frames\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"Failed prop type: The prop \\`href\\` expects a \\`string\\` or \\`object\\` in \\`<Link>\\`, but got \\`undefined\\` instead.\n@@ -24,7 +23,6 @@ describe('next-link', () => {\n        > 6 |   return <Link>Hello, Dave!</Link>\n            |          ^\",\n          \"stack\": [\n-           \"Array.forEach <anonymous>\",\n            \"Hello app/invalid-href/page.js (6:10)\",\n          ],\n        }\n@@ -39,7 +37,6 @@ describe('next-link', () => {\n     const browser = await webdriver(next.appPort, '/no-children')\n \n     if (isNextDev) {\n-      // TODO(veil): https://linear.app/vercel/issue/NDX-554/hide-the-anonymous-frames-which-are-between-2-ignored-frames\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"No children were passed to <Link> with \\`href\\` of \\`/about\\` but one child is required https://nextjs.org/docs/messages/link-no-children\",\n@@ -63,7 +60,6 @@ describe('next-link', () => {\n     const browser = await webdriver(next.appPort, '/multiple-children')\n \n     if (isNextDev) {\n-      // TODO(veil): https://linear.app/vercel/issue/NDX-554/hide-the-anonymous-frames-which-are-between-2-ignored-frames\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"Multiple children were passed to <Link> with \\`href\\` of \\`/\\` but only one child is supported https://nextjs.org/docs/messages/link-multiple-children \n@@ -88,7 +84,6 @@ describe('next-link', () => {\n     const browser = await webdriver(next.appPort, '/invalid-prefetch')\n \n     if (isNextDev) {\n-      // TODO(veil): https://linear.app/vercel/issue/NDX-554/hide-the-anonymous-frames-which-are-between-2-ignored-frames\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"Failed prop type: The prop \\`prefetch\\` expects a \\`boolean | \"auto\"\\` in \\`<Link>\\`, but got \\`string\\` instead.\n@@ -99,7 +94,6 @@ describe('next-link', () => {\n        >  7 |     <Link prefetch=\"unknown\" href=\"https://nextjs.org/\">\n             |     ^\",\n          \"stack\": [\n-           \"Array.forEach <anonymous>\",\n            \"Hello app/invalid-prefetch/page.js (7:5)\",\n          ],\n        }"
        },
        {
            "sha": "55fcce63b05f7f5f21944b1569341aae07e9e61a",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/4618e3d902d906fceba981c54db29ab331689a52/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4618e3d902d906fceba981c54db29ab331689a52/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=4618e3d902d906fceba981c54db29ab331689a52",
            "patch": "@@ -1449,10 +1449,6 @@ export async function getRedboxCallStack(\n           stack.push('<FIXME-file-protocol>')\n         } else if (frame.includes('.next/')) {\n           stack.push('<FIXME-next-dist-dir>')\n-        } else if (frame === 'JSON.parse <anonymous>') {\n-          // TODO(veil): These frames will be ignore-listed soon. Until then, we\n-          // remove them here, because their occurrence seems to be\n-          // non-deterministic. They come from React's RSC parsing.\n         } else {\n           stack.push(frame)\n         }"
        }
    ],
    "stats": {
        "total": 800,
        "additions": 703,
        "deletions": 97
    }
}