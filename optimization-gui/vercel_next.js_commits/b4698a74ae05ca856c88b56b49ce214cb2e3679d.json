{
    "author": "ijjk",
    "message": "Update matching query and route param handling (#81209)\n\nValidated this is un-necessary and handling an edge case we don't need\nto be worried about and it's better to leave the query param for this\ncase instead\n\nDeploy tests checked\nhttps://github.com/vercel/vercel/actions/runs/16058085256/job/45317414336?pr=13522\nand\nhttps://github.com/vercel/next.js/actions/runs/16059083218/job/45320691422",
    "sha": "b4698a74ae05ca856c88b56b49ce214cb2e3679d",
    "files": [
        {
            "sha": "25722dd06b729c601f4904c46f8432d715dce592",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b4698a74ae05ca856c88b56b49ce214cb2e3679d/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b4698a74ae05ca856c88b56b49ce214cb2e3679d/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=b4698a74ae05ca856c88b56b49ce214cb2e3679d",
            "patch": "@@ -195,6 +195,7 @@ export async function handler(\n   }\n   const nodeNextReq = new NodeNextRequest(req)\n   const nodeNextRes = new NodeNextResponse(res)\n+\n   const nextReq = NextRequestAdapter.fromNodeNextRequest(\n     nodeNextReq,\n     signalFromNodeResponse(res)"
        },
        {
            "sha": "7b0643bd157c673331afd49636163ed294cb78e6",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b4698a74ae05ca856c88b56b49ce214cb2e3679d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b4698a74ae05ca856c88b56b49ce214cb2e3679d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=b4698a74ae05ca856c88b56b49ce214cb2e3679d",
            "patch": "@@ -228,6 +228,7 @@ export class AppRouteRouteModule extends RouteModule<\n     // Automatically implement some methods if they aren't implemented by the\n     // userland module.\n     this.methods = autoImplementMethods(userland)\n+    this.isAppRouter = true\n \n     // Get the non-static methods for this route.\n     this.hasNonStaticMethods = hasNonStaticMethods(userland)"
        },
        {
            "sha": "6913a05c7fa57af5f6bc657ffb1bab37008be1cb",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 19,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/b4698a74ae05ca856c88b56b49ce214cb2e3679d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b4698a74ae05ca856c88b56b49ce214cb2e3679d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=b4698a74ae05ca856c88b56b49ce214cb2e3679d",
            "patch": "@@ -641,25 +641,34 @@ export abstract class RouteModule<\n     }\n \n     const routeParamKeys = new Set<string>()\n-    const combinedParamKeys = [...routeParamKeys]\n-\n-    for (const key of rewriteParamKeys) {\n-      // We only want to filter rewrite param keys from the URL\n-      // if they are matches from the URL e.g. the key/value matches\n-      // before and after applying the rewrites /:path for /hello and\n-      // { path: 'hello' } but not for { path: 'another' } and /hello\n-      // TODO: we should prefix rewrite param keys the same as we do\n-      // for dynamic routes so we can identify them properly\n-      const originalValue = Array.isArray(originalQuery[key])\n-        ? originalQuery[key].join('')\n-        : originalQuery[key]\n-\n-      const queryValue = Array.isArray(query[key])\n-        ? query[key].join('')\n-        : query[key]\n-\n-      if (!(key in originalQuery) || originalValue === queryValue) {\n-        combinedParamKeys.push(key)\n+    const combinedParamKeys = []\n+\n+    // we don't include rewriteParamKeys in the combinedParamKeys\n+    // for app router since the searchParams is populated from the\n+    // URL so we don't want to strip the rewrite params from the URL\n+    // so that searchParams can include them\n+    if (!this.isAppRouter) {\n+      for (const key of [\n+        ...rewriteParamKeys,\n+        ...Object.keys(serverUtils.defaultRouteMatches || {}),\n+      ]) {\n+        // We only want to filter rewrite param keys from the URL\n+        // if they are matches from the URL e.g. the key/value matches\n+        // before and after applying the rewrites /:path for /hello and\n+        // { path: 'hello' } but not for { path: 'another' } and /hello\n+        // TODO: we should prefix rewrite param keys the same as we do\n+        // for dynamic routes so we can identify them properly\n+        const originalValue = Array.isArray(originalQuery[key])\n+          ? originalQuery[key].join('')\n+          : originalQuery[key]\n+\n+        const queryValue = Array.isArray(query[key])\n+          ? query[key].join('')\n+          : query[key]\n+\n+        if (!(key in originalQuery) || originalValue === queryValue) {\n+          combinedParamKeys.push(key)\n+        }\n       }\n     }\n "
        },
        {
            "sha": "60f9b937e7f6ea264016dde401ed23fc5ce0b26c",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 9,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/b4698a74ae05ca856c88b56b49ce214cb2e3679d/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b4698a74ae05ca856c88b56b49ce214cb2e3679d/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=b4698a74ae05ca856c88b56b49ce214cb2e3679d",
            "patch": "@@ -34,8 +34,7 @@ import { getSelectedParams } from '../client/components/router-reducer/compute-c\n \n function filterInternalQuery(\n   query: Record<string, undefined | string | string[]>,\n-  paramKeys: string[],\n-  defaultRouteRegex: ReturnType<typeof getNamedRouteRegex> | undefined\n+  paramKeys: string[]\n ) {\n   // this is used to pass query information in rewrites\n   // but should not be exposed in final query\n@@ -52,8 +51,7 @@ function filterInternalQuery(\n     if (\n       isNextQueryPrefix ||\n       isNextInterceptionMarkerPrefix ||\n-      paramKeys.includes(key) ||\n-      (defaultRouteRegex && Object.keys(defaultRouteRegex.groups).includes(key))\n+      paramKeys.includes(key)\n     ) {\n       delete query[key]\n     }\n@@ -62,8 +60,7 @@ function filterInternalQuery(\n \n export function normalizeCdnUrl(\n   req: BaseNextRequest | IncomingMessage,\n-  paramKeys: string[],\n-  defaultRouteRegex: ReturnType<typeof getNamedRouteRegex> | undefined\n+  paramKeys: string[]\n ) {\n   // make sure to normalize req.url from CDNs to strip dynamic and rewrite\n   // params from the query which are added during routing\n@@ -74,7 +71,7 @@ export function normalizeCdnUrl(\n     return req.url\n   }\n   delete (_parsedUrl as any).search\n-  filterInternalQuery(_parsedUrl.query, paramKeys, defaultRouteRegex)\n+  filterInternalQuery(_parsedUrl.query, paramKeys)\n \n   req.url = formatUrl(_parsedUrl)\n }\n@@ -484,15 +481,15 @@ export function getServerUtils({\n     normalizeCdnUrl: (\n       req: BaseNextRequest | IncomingMessage,\n       paramKeys: string[]\n-    ) => normalizeCdnUrl(req, paramKeys, defaultRouteRegex),\n+    ) => normalizeCdnUrl(req, paramKeys),\n \n     interpolateDynamicPath: (\n       pathname: string,\n       params: Record<string, undefined | string | string[]>\n     ) => interpolateDynamicPath(pathname, params, defaultRouteRegex),\n \n     filterInternalQuery: (query: ParsedUrlQuery, paramKeys: string[]) =>\n-      filterInternalQuery(query, paramKeys, defaultRouteRegex),\n+      filterInternalQuery(query, paramKeys),\n   }\n }\n "
        },
        {
            "sha": "5791868170cfa9f21faa64847443144b951e0070",
            "filename": "packages/next/src/server/web-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b4698a74ae05ca856c88b56b49ce214cb2e3679d/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b4698a74ae05ca856c88b56b49ce214cb2e3679d/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts?ref=b4698a74ae05ca856c88b56b49ce214cb2e3679d",
            "patch": "@@ -186,7 +186,7 @@ export default class NextWebServer extends BaseServer<\n           normalizedParams,\n           routeRegex\n         )\n-        normalizeCdnUrl(req, Object.keys(routeRegex.routeKeys), routeRegex)\n+        normalizeCdnUrl(req, Object.keys(routeRegex.routeKeys))\n       }\n     }\n "
        }
    ],
    "stats": {
        "total": 66,
        "additions": 37,
        "deletions": 29
    }
}