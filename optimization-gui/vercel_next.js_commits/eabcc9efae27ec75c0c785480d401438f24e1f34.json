{
    "author": "devjiwonchoi",
    "message": "fix: display multiple lockfile warn if neither `outputFileTracingRoot` or `turbopack.root` option is provided (#82164)\n\n> Better to be reviewed with \"Hide whitespace\".\n\nThis PR fixed a bug where `findRootDir()` was called and displayed\nmultiple lockfile warnings even if the app had `turbopack.root`, as\nthere was no `outputFileTracingRoot`.\n\nx-ref:\nhttps://github.com/vercel/next.js/pull/82164#discussion_r2240470772\n\nAlso, added information about the `outputFileTracingRoot` option and its\ndocs to the warning, as it was omitted from\nhttps://github.com/vercel/next.js/pull/82052.\n\nCloses https://github.com/vercel/next.js/issues/81864\nCloses https://github.com/vercel/next.js/issues/82096",
    "sha": "eabcc9efae27ec75c0c785480d401438f24e1f34",
    "files": [
        {
            "sha": "755b52aa91a91490a765b8beed29da2b41da82c7",
            "filename": "packages/next/src/lib/find-root.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 8,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/eabcc9efae27ec75c0c785480d401438f24e1f34/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eabcc9efae27ec75c0c785480d401438f24e1f34/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts?ref=eabcc9efae27ec75c0c785480d401438f24e1f34",
            "patch": "@@ -40,14 +40,25 @@ export function findRootDir(cwd: string) {\n       .map((str) => '\\n   * ' + str)\n       .join('')\n \n-    Log.warnOnce(\n-      `Warning: Next.js inferred your workspace root, but it may not be correct.\\n` +\n-        ` We detected multiple lockfiles and selected ${lockFiles[lockFiles.length - 1]} as the root directory.\\n` +\n-        ` To silence this warning, set turbopack.root in your Next.js config, or consider ` +\n-        `removing one of the lockfiles if it's not needed.\\n` +\n-        `   See https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack#root-directory for more information.\\n` +\n-        ` Detected additional lockfiles: ${additionalLockFiles}\\n`\n-    )\n+    if (process.env.TURBOPACK) {\n+      Log.warnOnce(\n+        `Warning: Next.js inferred your workspace root, but it may not be correct.\\n` +\n+          ` We detected multiple lockfiles and selected the directory of ${lockFiles[lockFiles.length - 1]} as the root directory.\\n` +\n+          ` To silence this warning, set \\`turbopack.root\\` in your Next.js config, or consider ` +\n+          `removing one of the lockfiles if it's not needed.\\n` +\n+          `   See https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack#root-directory for more information.\\n` +\n+          ` Detected additional lockfiles: ${additionalLockFiles}\\n`\n+      )\n+    } else {\n+      Log.warnOnce(\n+        `Warning: Next.js inferred your workspace root, but it may not be correct.\\n` +\n+          ` We detected multiple lockfiles and selected the directory of ${lockFiles[lockFiles.length - 1]} as the root directory.\\n` +\n+          ` To silence this warning, set \\`outputFileTracingRoot\\` in your Next.js config, or consider ` +\n+          `removing one of the lockfiles if it's not needed.\\n` +\n+          `   See https://nextjs.org/docs/app/api-reference/config/next-config-js/output#caveats for more information.\\n` +\n+          ` Detected additional lockfiles: ${additionalLockFiles}\\n`\n+      )\n+    }\n   }\n \n   return dirname(lockFile)"
        },
        {
            "sha": "f2d9ba9e6e3b02fda70eb85a2fee4a36e556b1f2",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/eabcc9efae27ec75c0c785480d401438f24e1f34/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eabcc9efae27ec75c0c785480d401438f24e1f34/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=eabcc9efae27ec75c0c785480d401438f24e1f34",
            "patch": "@@ -711,17 +711,12 @@ function assignDefaults(\n   }\n \n   // use the highest level lockfile as tracing root\n-  if (!result?.outputFileTracingRoot || !result?.turbopack?.root) {\n+  if (!result?.outputFileTracingRoot && !result?.turbopack?.root) {\n     let rootDir = findRootDir(dir)\n \n     if (rootDir) {\n-      if (!result?.outputFileTracingRoot) {\n-        result.outputFileTracingRoot = rootDir\n-      }\n-\n-      if (!result?.turbopack?.root) {\n-        dset(result, ['turbopack', 'root'], rootDir)\n-      }\n+      result.outputFileTracingRoot = rootDir\n+      dset(result, ['turbopack', 'root'], rootDir)\n     }\n   }\n "
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/multiple-lockfiles/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/eabcc9efae27ec75c0c785480d401438f24e1f34/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/eabcc9efae27ec75c0c785480d401438f24e1f34/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fapp%2Flayout.tsx?ref=eabcc9efae27ec75c0c785480d401438f24e1f34",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/multiple-lockfiles/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/eabcc9efae27ec75c0c785480d401438f24e1f34/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/eabcc9efae27ec75c0c785480d401438f24e1f34/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fapp%2Fpage.tsx?ref=eabcc9efae27ec75c0c785480d401438f24e1f34",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "a9b33266fcd5cde05ebec417c48b796ae113d300",
            "filename": "test/e2e/app-dir/multiple-lockfiles/multiple-lockfiles-with-output-file-tracing-root.test.ts",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/eabcc9efae27ec75c0c785480d401438f24e1f34/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-output-file-tracing-root.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eabcc9efae27ec75c0c785480d401438f24e1f34/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-output-file-tracing-root.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-output-file-tracing-root.test.ts?ref=eabcc9efae27ec75c0c785480d401438f24e1f34",
            "patch": "@@ -0,0 +1,36 @@\n+import { join } from 'path'\n+import { unlink } from 'fs/promises'\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n+\n+describe('multiple-lockfiles - has-output-file-tracing-root', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: {\n+      app: new FileRef(join(__dirname, 'app')),\n+      // This will silence the multiple lockfiles warning.\n+      'next.config.js': `module.exports = { outputFileTracingRoot: __dirname }`,\n+      // Write a package-lock.json file to the parent directory to simulate\n+      // multiple lockfiles.\n+      '../package-lock.json': JSON.stringify({\n+        name: 'parent-workspace',\n+        version: '1.0.0',\n+        lockfileVersion: 3,\n+      }),\n+    },\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  afterAll(async () => {\n+    // Cleanup to ensure it doesn't affect other tests.\n+    await unlink(join(next.testDir, '../package-lock.json'))\n+  })\n+\n+  it('should not have multiple lockfiles warnings', async () => {\n+    expect(next.cliOutput).not.toMatch(\n+      /We detected multiple lockfiles and selected the directory of .+ as the root directory\\./\n+    )\n+  })\n+})"
        },
        {
            "sha": "69172632d2eaa34f998e67da80037b6f0d59fd2e",
            "filename": "test/e2e/app-dir/multiple-lockfiles/multiple-lockfiles-with-turbo-root.test.ts",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/eabcc9efae27ec75c0c785480d401438f24e1f34/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-turbo-root.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eabcc9efae27ec75c0c785480d401438f24e1f34/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-turbo-root.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-turbo-root.test.ts?ref=eabcc9efae27ec75c0c785480d401438f24e1f34",
            "patch": "@@ -0,0 +1,36 @@\n+import { join } from 'path'\n+import { unlink } from 'fs/promises'\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n+\n+describe('multiple-lockfiles - has-turbo-root', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: {\n+      app: new FileRef(join(__dirname, 'app')),\n+      // This will silence the multiple lockfiles warning.\n+      'next.config.js': `module.exports = { turbopack: { root: __dirname } }`,\n+      // Write a package-lock.json file to the parent directory to simulate\n+      // multiple lockfiles.\n+      '../package-lock.json': JSON.stringify({\n+        name: 'parent-workspace',\n+        version: '1.0.0',\n+        lockfileVersion: 3,\n+      }),\n+    },\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  afterAll(async () => {\n+    // Cleanup to ensure it doesn't affect other tests.\n+    await unlink(join(next.testDir, '../package-lock.json'))\n+  })\n+\n+  it('should not have multiple lockfiles warnings', async () => {\n+    expect(next.cliOutput).not.toMatch(\n+      /We detected multiple lockfiles and selected the directory of .+ as the root directory\\./\n+    )\n+  })\n+})"
        },
        {
            "sha": "edb67b4155676472153414221503710d6dcbe531",
            "filename": "test/e2e/app-dir/multiple-lockfiles/multiple-lockfiles.test.ts",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/eabcc9efae27ec75c0c785480d401438f24e1f34/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eabcc9efae27ec75c0c785480d401438f24e1f34/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles.test.ts?ref=eabcc9efae27ec75c0c785480d401438f24e1f34",
            "patch": "@@ -0,0 +1,44 @@\n+import { join } from 'path'\n+import { unlink } from 'fs/promises'\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n+\n+describe('multiple-lockfiles', () => {\n+  const { next, skipped, isTurbopack } = nextTestSetup({\n+    files: {\n+      app: new FileRef(join(__dirname, 'app')),\n+      // Write a package-lock.json file to the parent directory to simulate\n+      // multiple lockfiles.\n+      '../package-lock.json': JSON.stringify({\n+        name: 'parent-workspace',\n+        version: '1.0.0',\n+        lockfileVersion: 3,\n+      }),\n+    },\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  afterAll(async () => {\n+    // Cleanup to ensure it doesn't affect other tests.\n+    await unlink(join(next.testDir, '../package-lock.json'))\n+  })\n+\n+  it('should have multiple lockfiles warnings', async () => {\n+    expect(next.cliOutput).toMatch(\n+      /We detected multiple lockfiles and selected the directory of .+ as the root directory\\./\n+    )\n+\n+    if (isTurbopack) {\n+      expect(next.cliOutput).toMatch(\n+        /To silence this warning, set `turbopack\\.root` in your Next\\.js config, or consider removing one of the lockfiles if it's not needed\\./\n+      )\n+    } else {\n+      expect(next.cliOutput).toMatch(\n+        /To silence this warning, set `outputFileTracingRoot` in your Next\\.js config, or consider removing one of the lockfiles if it's not needed\\./\n+      )\n+    }\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 165,
        "additions": 149,
        "deletions": 16
    }
}