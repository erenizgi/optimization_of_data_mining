{
    "author": "timneutkens",
    "message": "Development: Only load HotReloaderWebpack when it is used (#83609)\n\n## What?\n\nCurrently both hot-reloader paths are loaded, this ensures\nHotReloaderWebpack does not get loaded when using Turbopack.\n\nNote: This does not solve webpack being required because it's still\nloaded in `config-shared`, that's for a future follow-up.",
    "sha": "318aacca9029831beccb5dedd8c73fbcdb0cf317",
    "files": [
        {
            "sha": "dc1c6f8ce72c95babdc3034deed2da2ff3aaf172",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 19,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/318aacca9029831beccb5dedd8c73fbcdb0cf317/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/318aacca9029831beccb5dedd8c73fbcdb0cf317/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=318aacca9029831beccb5dedd8c73fbcdb0cf317",
            "patch": "@@ -13,11 +13,9 @@ import url from 'url'\n import path from 'path'\n import qs from 'querystring'\n import Watchpack from 'next/dist/compiled/watchpack'\n-import { loadEnvConfig } from '@next/env'\n import findUp from 'next/dist/compiled/find-up'\n import { buildCustomRoute } from './filesystem'\n import * as Log from '../../../build/output/log'\n-import HotReloaderWebpack from '../../dev/hot-reloader-webpack'\n import { setGlobal } from '../../../trace/shared'\n import type { Telemetry } from '../../../telemetry/storage'\n import type { IncomingMessage, ServerResponse } from 'http'\n@@ -63,7 +61,6 @@ import { devPageFiles } from '../../../build/webpack/plugins/next-types-plugin/s\n import type { LazyRenderServerInstance } from '../router-server'\n import { HMR_MESSAGE_SENT_TO_BROWSER } from '../../dev/hot-reloader-types'\n import { PAGE_TYPES } from '../../../lib/page-types'\n-import { createHotReloaderTurbopack } from '../../dev/hot-reloader-turbopack'\n import { generateEncryptionKeyBase64 } from '../../app-render/encryption-utils-server'\n import { isMetadataRouteFile } from '../../../lib/metadata/is-metadata-route'\n import { normalizeMetadataPageToRoute } from '../../../lib/metadata/get-metadata-route'\n@@ -186,23 +183,38 @@ async function startWatcher(\n   })\n \n   const hotReloader: NextJsHotReloaderInterface = opts.turbo\n-    ? await createHotReloaderTurbopack(opts, serverFields, distDir, resetFetch)\n-    : new HotReloaderWebpack(opts.dir, {\n-        isSrcDir: opts.isSrcDir,\n-        appDir,\n-        pagesDir,\n-        distDir,\n-        config: opts.nextConfig,\n-        buildId: 'development',\n-        encryptionKey: await generateEncryptionKeyBase64({\n-          isBuild: false,\n+    ? await (async () => {\n+        const createHotReloaderTurbopack = (\n+          require('../../dev/hot-reloader-turbopack') as typeof import('../../dev/hot-reloader-turbopack')\n+        ).createHotReloaderTurbopack\n+        return await createHotReloaderTurbopack(\n+          opts,\n+          serverFields,\n           distDir,\n-        }),\n-        telemetry: opts.telemetry,\n-        rewrites: opts.fsChecker.rewrites,\n-        previewProps: opts.fsChecker.prerenderManifest.preview,\n-        resetFetch,\n-      })\n+          resetFetch\n+        )\n+      })()\n+    : await (async () => {\n+        const HotReloaderWebpack = (\n+          require('../../dev/hot-reloader-webpack') as typeof import('../../dev/hot-reloader-webpack')\n+        ).default\n+        return new HotReloaderWebpack(opts.dir, {\n+          isSrcDir: opts.isSrcDir,\n+          appDir,\n+          pagesDir,\n+          distDir,\n+          config: opts.nextConfig,\n+          buildId: 'development',\n+          encryptionKey: await generateEncryptionKeyBase64({\n+            isBuild: false,\n+            distDir,\n+          }),\n+          telemetry: opts.telemetry,\n+          rewrites: opts.fsChecker.rewrites,\n+          previewProps: opts.fsChecker.prerenderManifest.preview,\n+          resetFetch,\n+        })\n+      })()\n \n   await hotReloader.start()\n \n@@ -718,6 +730,9 @@ async function startWatcher(\n \n       if (envChange || tsconfigChange) {\n         if (envChange) {\n+          const loadEnvConfig = (\n+            require('@next/env') as typeof import('@next/env')\n+          ).loadEnvConfig\n           const { loadedEnvFiles } = loadEnvConfig(\n             dir,\n             process.env.NODE_ENV === 'development',"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 34,
        "deletions": 19
    }
}