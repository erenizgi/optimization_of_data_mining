{
    "author": "ztanner",
    "message": "Remove urlencoded action handling & harden action ID checks (#87082)\n\n- Removes support for urlencoded actions\n- Errors when a server action request is received in apps that have no\nserver actions\n- validate action ID in MPA actions before proceeding\n\n---------\n\nCo-authored-by: Josh Story <story@hey.com>",
    "sha": "d43d57afd0ff3b0b327adb0329c693e333cd830a",
    "files": [
        {
            "sha": "261ef90e04e22d6792bc7f99e82e40533c01fd56",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d43d57afd0ff3b0b327adb0329c693e333cd830a/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d43d57afd0ff3b0b327adb0329c693e333cd830a/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=d43d57afd0ff3b0b327adb0329c693e333cd830a",
            "patch": "@@ -970,5 +970,8 @@\n   \"969\": \"Invariant: nextConfig couldn't be loaded\",\n   \"970\": \"process.env.NEXT_DEPLOYMENT_ID is missing but runtimeServerDeploymentId is enabled\",\n   \"971\": \"The NEXT_DEPLOYMENT_ID environment variable value \\\"%s\\\" does not match the provided deploymentId \\\"%s\\\" in the config.\",\n-  \"972\": \"Failed to resolve pattern \\\"%s\\\": %s\"\n+  \"972\": \"Failed to resolve pattern \\\"%s\\\": %s\",\n+  \"973\": \"Server Actions are not enabled for this application. This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\",\n+  \"974\": \"Failed to find Server Action%s. This request might be from an older or newer deployment.\\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\",\n+  \"975\": \"Failed to find Server Action. This request might be from an older or newer deployment.\\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\"\n }"
        },
        {
            "sha": "3dd3c4a81e9b56ddb75d1afd6f28cebec8faea2e",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 206,
            "deletions": 65,
            "changes": 271,
            "blob_url": "https://github.com/vercel/next.js/blob/d43d57afd0ff3b0b327adb0329c693e333cd830a/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d43d57afd0ff3b0b327adb0329c693e333cd830a/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=d43d57afd0ff3b0b327adb0329c693e333cd830a",
            "patch": "@@ -53,6 +53,8 @@ import { fromNodeOutgoingHttpHeaders } from '../web/utils'\n import {\n   selectWorkerForForwarding,\n   type ServerModuleMap,\n+  getServerActionsManifest,\n+  getServerModuleMap,\n } from './manifests-singleton'\n import { isNodeNextRequest, isWebNextRequest } from '../base-http/helpers'\n import { RedirectStatusCode } from '../../client/components/redirect-status-code'\n@@ -63,19 +65,21 @@ import { InvariantError } from '../../shared/lib/invariant-error'\n import { executeRevalidates } from '../revalidation-utils'\n import { getRequestMeta } from '../request-meta'\n import { setCacheBustingSearchParam } from '../../client/components/router-reducer/set-cache-busting-search-param'\n-import { getServerModuleMap } from './manifests-singleton'\n import {\n   ActionDidNotRevalidate,\n   ActionDidRevalidateStaticAndDynamic,\n } from '../../shared/lib/action-revalidation-kind'\n \n-function formDataFromSearchQueryString(query: string) {\n-  const searchParams = new URLSearchParams(query)\n-  const formData = new FormData()\n-  for (const [key, value] of searchParams) {\n-    formData.append(key, value)\n-  }\n-  return formData\n+/**\n+ * Checks if the app has any server actions defined in any runtime.\n+ */\n+function hasServerActions() {\n+  const serverActionsManifest = getServerActionsManifest()\n+\n+  return (\n+    Object.keys(serverActionsManifest.node).length > 0 ||\n+    Object.keys(serverActionsManifest.edge).length > 0\n+  )\n }\n \n function nodeHeadersToRecord(\n@@ -539,19 +543,55 @@ export async function handleAction({\n \n   const {\n     actionId,\n-    isURLEncodedAction,\n     isMultipartAction,\n     isFetchAction,\n+    isURLEncodedAction,\n     isPossibleServerAction,\n   } = getServerActionRequestMetadata(req)\n \n+  const handleUnrecognizedFetchAction = (err: unknown): HandleActionResult => {\n+    // If the deployment doesn't have skew protection, this is expected to occasionally happen,\n+    // so we use a warning instead of an error.\n+    console.warn(err)\n+\n+    // Return an empty response with a header that the client router will interpret.\n+    // We don't need to waste time encoding a flight response, and using a blank body + header\n+    // means that unrecognized actions can also be handled at the infra level\n+    // (i.e. without needing to invoke a lambda)\n+    res.setHeader(NEXT_ACTION_NOT_FOUND_HEADER, '1')\n+    res.setHeader('content-type', 'text/plain')\n+    res.statusCode = 404\n+    return {\n+      type: 'done',\n+      result: RenderResult.fromStatic('Server action not found.', 'text/plain'),\n+    }\n+  }\n+\n   // If it can't be a Server Action, skip handling.\n   // Note that this can be a false positive -- any multipart/urlencoded POST can get us here,\n   // But won't know if it's an MPA action or not until we call `decodeAction` below.\n   if (!isPossibleServerAction) {\n     return null\n   }\n \n+  // We don't currently support URL encoded actions, so we bail out early.\n+  // Depending on if it's a fetch action or an MPA, we return a different response.\n+  if (isURLEncodedAction) {\n+    if (isFetchAction) {\n+      return {\n+        type: 'not-found',\n+      }\n+    } else {\n+      // This is an MPA action, so we return null\n+      return null\n+    }\n+  }\n+\n+  // If the app has no server actions at all, we can 404 early.\n+  if (!hasServerActions()) {\n+    return handleUnrecognizedFetchAction(getActionNotFoundError(actionId))\n+  }\n+\n   if (workStore.isStaticGeneration) {\n     throw new Error(\n       \"Invariant: server actions can't be handled during static rendering\"\n@@ -670,24 +710,6 @@ export async function handleAction({\n     }\n   }\n \n-  const handleUnrecognizedFetchAction = (err: unknown): HandleActionResult => {\n-    // If the deployment doesn't have skew protection, this is expected to occasionally happen,\n-    // so we use a warning instead of an error.\n-    console.warn(err)\n-\n-    // Return an empty response with a header that the client router will interpret.\n-    // We don't need to waste time encoding a flight response, and using a blank body + header\n-    // means that unrecognized actions can also be handled at the infra level\n-    // (i.e. without needing to invoke a lambda)\n-    res.setHeader(NEXT_ACTION_NOT_FOUND_HEADER, '1')\n-    res.setHeader('content-type', 'text/plain')\n-    res.statusCode = 404\n-    return {\n-      type: 'done',\n-      result: RenderResult.fromStatic('Server action not found.', 'text/plain'),\n-    }\n-  }\n-\n   try {\n     return await actionAsyncStorage.run(\n       { isAction: true },\n@@ -723,6 +745,13 @@ export async function handleAction({\n             const formData = await req.request.formData()\n             if (isFetchAction) {\n               // A fetch action with a multipart body.\n+\n+              try {\n+                actionModId = getActionModIdOrError(actionId, serverModuleMap)\n+              } catch (err) {\n+                return handleUnrecognizedFetchAction(err)\n+              }\n+\n               boundActionArguments = await decodeReply(\n                 formData,\n                 serverModuleMap,\n@@ -731,6 +760,14 @@ export async function handleAction({\n             } else {\n               // Multipart POST, but not a fetch action.\n               // Potentially an MPA action, we have to try decoding it to check.\n+              if (areAllActionIdsValid(formData, serverModuleMap) === false) {\n+                // TODO: This can be from skew or manipulated input. We should handle this case\n+                // more gracefully but this preserves the prior behavior where decodeAction would throw instead.\n+                throw new Error(\n+                  `Failed to find Server Action. This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action`\n+                )\n+              }\n+\n               const action = await decodeAction(formData, serverModuleMap)\n               if (typeof action === 'function') {\n                 // an MPA action.\n@@ -796,20 +833,11 @@ export async function handleAction({\n \n             const actionData = Buffer.concat(chunks).toString('utf-8')\n \n-            if (isURLEncodedAction) {\n-              const formData = formDataFromSearchQueryString(actionData)\n-              boundActionArguments = await decodeReply(\n-                formData,\n-                serverModuleMap,\n-                { temporaryReferences }\n-              )\n-            } else {\n-              boundActionArguments = await decodeReply(\n-                actionData,\n-                serverModuleMap,\n-                { temporaryReferences }\n-              )\n-            }\n+            boundActionArguments = await decodeReply(\n+              actionData,\n+              serverModuleMap,\n+              { temporaryReferences }\n+            )\n           }\n         } else if (\n           // The type check here ensures that `req` is correctly typed, and the\n@@ -877,6 +905,12 @@ export async function handleAction({\n             if (isFetchAction) {\n               // A fetch action with a multipart body.\n \n+              try {\n+                actionModId = getActionModIdOrError(actionId, serverModuleMap)\n+              } catch (err) {\n+                return handleUnrecognizedFetchAction(err)\n+              }\n+\n               const busboy = (\n                 require('next/dist/compiled/busboy') as typeof import('next/dist/compiled/busboy')\n               )({\n@@ -924,7 +958,19 @@ export async function handleAction({\n                 }),\n                 duplex: 'half',\n               })\n+\n               const formData = await fakeRequest.formData()\n+\n+              if (areAllActionIdsValid(formData, serverModuleMap) === false) {\n+                // TODO: This can be from skew or manipulated input. We should handle this case\n+                // more gracefully but this preserves the prior behavior where decodeAction would throw instead.\n+                throw new Error(\n+                  `Failed to find Server Action. This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action`\n+                )\n+              }\n+\n+              // TODO: Refactor so it is harder to accidentally decode an action before you have validated that the\n+              // action referred to is available.\n               const action = await decodeAction(formData, serverModuleMap)\n               if (typeof action === 'function') {\n                 // an MPA action.\n@@ -984,20 +1030,11 @@ export async function handleAction({\n \n             const actionData = Buffer.concat(chunks).toString('utf-8')\n \n-            if (isURLEncodedAction) {\n-              const formData = formDataFromSearchQueryString(actionData)\n-              boundActionArguments = await decodeReply(\n-                formData,\n-                serverModuleMap,\n-                { temporaryReferences }\n-              )\n-            } else {\n-              boundActionArguments = await decodeReply(\n-                actionData,\n-                serverModuleMap,\n-                { temporaryReferences }\n-              )\n-            }\n+            boundActionArguments = await decodeReply(\n+              actionData,\n+              serverModuleMap,\n+              { temporaryReferences }\n+            )\n           }\n         } else {\n           throw new Error('Invariant: Unknown request type.')\n@@ -1015,13 +1052,6 @@ export async function handleAction({\n         // / -> fire action -> POST / -> appRender1 -> modId for the action file\n         // /foo -> fire action -> POST /foo -> appRender2 -> modId for the action file\n \n-        try {\n-          actionModId =\n-            actionModId ?? getActionModIdOrError(actionId, serverModuleMap)\n-        } catch (err) {\n-          return handleUnrecognizedFetchAction(err)\n-        }\n-\n         const actionMod = (await ComponentMod.__next_app__.require(\n           actionModId\n         )) as Record<string, (...args: unknown[]) => Promise<unknown>>\n@@ -1235,10 +1265,121 @@ function getActionModIdOrError(\n   const actionModId = serverModuleMap[actionId]?.id\n \n   if (!actionModId) {\n-    throw new Error(\n-      `Failed to find Server Action \"${actionId}\". This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action`\n-    )\n+    throw getActionNotFoundError(actionId)\n   }\n \n   return actionModId\n }\n+\n+function getActionNotFoundError(actionId: string | null): Error {\n+  return new Error(\n+    `Failed to find Server Action${actionId ? ` \"${actionId}\"` : ''}. This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action`\n+  )\n+}\n+\n+const $ACTION_ = '$ACTION_'\n+const $ACTION_REF_ = '$ACTION_REF_'\n+const $ACTION_ID_ = '$ACTION_ID_'\n+const ACTION_ID_EXPECTED_LENGTH = 42\n+\n+/**\n+ * This function mirrors logic inside React's decodeAction and should be kept in sync with that.\n+ * It pre-parses the FormData to ensure that any action IDs referred to are actual action IDs for\n+ * this Next.js application.\n+ */\n+function areAllActionIdsValid(\n+  mpaFormData: FormData,\n+  serverModuleMap: ServerModuleMap\n+): boolean {\n+  let hasAtLeastOneAction = false\n+  // Before we attempt to decode the payload for a possible MPA action, assert that all\n+  // action IDs are valid IDs. If not we should disregard the payload\n+  for (let key of mpaFormData.keys()) {\n+    if (!key.startsWith($ACTION_)) {\n+      // not a relevant field\n+      continue\n+    }\n+\n+    if (key.startsWith($ACTION_ID_)) {\n+      // No Bound args case\n+      if (isInvalidActionIdFieldName(key, serverModuleMap)) {\n+        return false\n+      }\n+\n+      hasAtLeastOneAction = true\n+    } else if (key.startsWith($ACTION_REF_)) {\n+      // Bound args case\n+      const actionDescriptorField =\n+        $ACTION_ + key.slice($ACTION_REF_.length) + ':0'\n+      const actionFields = mpaFormData.getAll(actionDescriptorField)\n+      if (actionFields.length !== 1) {\n+        return false\n+      }\n+      const actionField = actionFields[0]\n+      if (typeof actionField !== 'string') {\n+        return false\n+      }\n+\n+      if (isInvalidStringActionDescriptor(actionField, serverModuleMap)) {\n+        return false\n+      }\n+      hasAtLeastOneAction = true\n+    }\n+  }\n+  return hasAtLeastOneAction\n+}\n+\n+const ACTION_DESCRIPTOR_ID_PREFIX = '{\"id\":\"'\n+function isInvalidStringActionDescriptor(\n+  actionDescriptor: string,\n+  serverModuleMap: ServerModuleMap\n+): unknown {\n+  if (actionDescriptor.startsWith(ACTION_DESCRIPTOR_ID_PREFIX) === false) {\n+    return true\n+  }\n+\n+  const from = ACTION_DESCRIPTOR_ID_PREFIX.length\n+  const to = from + ACTION_ID_EXPECTED_LENGTH\n+\n+  // We expect actionDescriptor to be '{\"id\":\"<actionId>\",...}'\n+  const actionId = actionDescriptor.slice(from, to)\n+  if (\n+    actionId.length !== ACTION_ID_EXPECTED_LENGTH ||\n+    actionDescriptor[to] !== '\"'\n+  ) {\n+    return true\n+  }\n+\n+  const entry = serverModuleMap[actionId]\n+\n+  if (entry == null) {\n+    return true\n+  }\n+\n+  return false\n+}\n+\n+function isInvalidActionIdFieldName(\n+  actionIdFieldName: string,\n+  serverModuleMap: ServerModuleMap\n+): boolean {\n+  // The field name must always start with $ACTION_ID_ but since it is\n+  // the id is extracted from the key of the field we have already validated\n+  // this before entering this function\n+  if (\n+    actionIdFieldName.length !==\n+    $ACTION_ID_.length + ACTION_ID_EXPECTED_LENGTH\n+  ) {\n+    // this field name has too few or too many characters\n+    return true\n+  }\n+\n+  const actionId = actionIdFieldName.slice($ACTION_ID_.length)\n+  const entry = serverModuleMap[actionId]\n+\n+  if (entry == null) {\n+    return true\n+  }\n+\n+  return false\n+}"
        },
        {
            "sha": "bd68b69144d3039455d296090b1a03a54e6f7d5a",
            "filename": "packages/next/src/server/lib/server-action-request-meta.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d43d57afd0ff3b0b327adb0329c693e333cd830a/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fserver-action-request-meta.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d43d57afd0ff3b0b327adb0329c693e333cd830a/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fserver-action-request-meta.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fserver-action-request-meta.ts?ref=d43d57afd0ff3b0b327adb0329c693e333cd830a",
            "patch": "@@ -23,6 +23,9 @@ export function getServerActionRequestMetadata(\n     contentType = req.headers['content-type'] ?? null\n   }\n \n+  // We don't actually support URL encoded actions, and the action handler will bail out if it sees one.\n+  // But we still want it to flow through to the action handler, to prevent changes in behavior when a regular\n+  // page component tries to handle a POST.\n   const isURLEncodedAction = Boolean(\n     req.method === 'POST' && contentType === 'application/x-www-form-urlencoded'\n   )"
        },
        {
            "sha": "9119acf4380d735404fb432d3816abf20ea1807d",
            "filename": "test/e2e/app-dir/actions-unrecognized/actions-unrecognized.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 11,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/d43d57afd0ff3b0b327adb0329c693e333cd830a/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d43d57afd0ff3b0b327adb0329c693e333cd830a/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts?ref=d43d57afd0ff3b0b327adb0329c693e333cd830a",
            "patch": "@@ -54,15 +54,6 @@ describe('unrecognized server actions', () => {\n           body: new FormData(),\n         },\n       },\n-      {\n-        // we never use urlencoded actions, but we currently have codepaths for it in `handleAction`,\n-        // so might as well test them.\n-        name: 'urlencoded',\n-        request: {\n-          contentType: 'application/x-www-form-urlencoded',\n-          body: 'foo=bar',\n-        },\n-      },\n     ])(\n       'should 404 when POSTing a server action with an unrecognized id to a nonexistent page: $name',\n       async ({ request: { contentType, body } }) => {\n@@ -91,6 +82,19 @@ describe('unrecognized server actions', () => {\n     )\n   }\n \n+  it('should 404 when POSTing a urlencoded action to a nonexistent page', async () => {\n+    const res = await next.fetch('/non-existent-route', {\n+      method: 'POST',\n+      headers: {\n+        'next-action': '123',\n+        'content-type': 'application/x-www-form-urlencoded',\n+      },\n+      body: 'foo=bar',\n+    })\n+\n+    expect(res.status).toBe(404)\n+  })\n+\n   describe.each(['nodejs', 'edge'])(\n     'should error and log a warning when submitting a server action with an unrecognized ID - %s',\n     (runtime) => {\n@@ -178,10 +182,9 @@ describe('unrecognized server actions', () => {\n             }\n \n             if (!isNextDeploy) {\n-              // FIXME: For an MPA action, the logs currently show the error thrown by React instead of our custom message with a link to a docs page.\n               await retry(async () =>\n                 expect(getLogs()).toInclude(\n-                  `Error: Could not find the module \"decafc0ffeebad01\" in the React Server Manifest. This is probably a bug in the React Server Components bundler`\n+                  `Error: Failed to find Server Action. This request might be from an older or newer deployment`\n                 )\n               )\n             }"
        },
        {
            "sha": "c7295294439d6f927620e7678ae9e9b007480c93",
            "filename": "test/e2e/app-dir/no-server-actions/app/layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d43d57afd0ff3b0b327adb0329c693e333cd830a/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d43d57afd0ff3b0b327adb0329c693e333cd830a/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fapp%2Flayout.tsx?ref=d43d57afd0ff3b0b327adb0329c693e333cd830a",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Layout({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "69dd5c59ccfcba4aab8cc01efd2850a716cbbb74",
            "filename": "test/e2e/app-dir/no-server-actions/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d43d57afd0ff3b0b327adb0329c693e333cd830a/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d43d57afd0ff3b0b327adb0329c693e333cd830a/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fapp%2Fpage.tsx?ref=d43d57afd0ff3b0b327adb0329c693e333cd830a",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>Hello World</p>\n+}"
        },
        {
            "sha": "7ca18c69084b7cad63e1d91e54659fb5aa6d8c02",
            "filename": "test/e2e/app-dir/no-server-actions/no-server-actions.test.ts",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/d43d57afd0ff3b0b327adb0329c693e333cd830a/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fno-server-actions.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d43d57afd0ff3b0b327adb0329c693e333cd830a/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fno-server-actions.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fno-server-actions.test.ts?ref=d43d57afd0ff3b0b327adb0329c693e333cd830a",
            "patch": "@@ -0,0 +1,42 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('app-dir - no server actions', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should 404 when triggering a fetch action on an app with no server actions', async () => {\n+    const res = await next.fetch('/', {\n+      method: 'POST',\n+      headers: {\n+        'Next-Action': 'abc123',\n+      },\n+    })\n+\n+    expect(res.status).toBe(404)\n+    expect(res.headers.get('x-nextjs-action-not-found')).toBe('1')\n+    expect(next.cliOutput).toContain(\n+      'Failed to find Server Action \"abc123\". This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action'\n+    )\n+  })\n+\n+  it('should 404 when triggering an MPA action on an app with no server actions', async () => {\n+    const formData = new FormData()\n+    formData.append('test', 'value')\n+\n+    const res = await next.fetch('/', {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'multipart/form-data',\n+      },\n+      // @ts-expect-error: node-fetch types don't seem to like FormData\n+      body: formData,\n+    })\n+\n+    expect(res.status).toBe(404)\n+    expect(res.headers.get('x-nextjs-action-not-found')).toBe('1')\n+    expect(next.cliOutput).toContain(\n+      'Failed to find Server Action. This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action'\n+    )\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 356,
        "additions": 279,
        "deletions": 77
    }
}