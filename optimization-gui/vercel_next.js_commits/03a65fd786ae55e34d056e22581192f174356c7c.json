{
    "author": "lukesandberg",
    "message": "Share logic across our two transforms (#78680)\n\nThis reduces a small bit of duplication between our two transforms (`toPath` and `fromPath`) and fixes a small bug in `postcss` where we didn't register the environment variables it read as dependencies which could cause persistence issues.\n\nFinally, batch `log` messages sent by webpack transforms, the turbopack side doesn't read them until the end anyway and we can reduce overhead a touch by sending them in a single batch.",
    "sha": "03a65fd786ae55e34d056e22581192f174356c7c",
    "files": [
        {
            "sha": "653a2668a5af8bde78cfa69a06d4d587bdfbae70",
            "filename": "turbopack/crates/turbo-tasks-fs/src/embed/dir.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fembed%2Fdir.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fembed%2Fdir.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fembed%2Fdir.rs?ref=03a65fd786ae55e34d056e22581192f174356c7c",
            "patch": "@@ -69,8 +69,8 @@ macro_rules! embed_directory_internal {\n         // make sure the types the `include_dir!` proc macro refers to are in scope\n         use turbo_tasks_fs::embed::include_dir;\n \n-        static dir: include_dir::Dir<'static> = turbo_tasks_fs::embed::include_dir!($path);\n+        static DIR: include_dir::Dir<'static> = turbo_tasks_fs::embed::include_dir!($path);\n \n-        turbo_tasks_fs::embed::directory_from_include_dir($name.into(), &dir)\n+        turbo_tasks_fs::embed::directory_from_include_dir($name.into(), &DIR)\n     }};\n }"
        },
        {
            "sha": "83f29f3296a8a4c1dc259701f8f1f90dafb90698",
            "filename": "turbopack/crates/turbopack-node/js/src/ipc/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Fipc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Fipc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Fipc%2Findex.ts?ref=03a65fd786ae55e34d056e22581192f174356c7c",
            "patch": "@@ -11,13 +11,13 @@ export type StructuredError = {\n   cause: StructuredError | undefined\n }\n \n-export function structuredError(e: Error): StructuredError {\n+export function structuredError(e: unknown): StructuredError {\n   e = getProperError(e)\n \n   return {\n     name: e.name,\n     message: e.message,\n-    stack: typeof e.stack === 'string' ? parseStackTrace(e.stack!) : [],\n+    stack: typeof e.stack === 'string' ? parseStackTrace(e.stack) : [],\n     cause: e.cause ? structuredError(getProperError(e.cause)) : undefined,\n   }\n }\n@@ -34,7 +34,7 @@ type State =\n export type Ipc<TIncoming, TOutgoing> = {\n   recv(): Promise<TIncoming>\n   send(message: TOutgoing): Promise<void>\n-  sendError(error: Error): Promise<never>\n+  sendError(error: Error | string): Promise<never>\n   sendReady(): Promise<void>\n }\n \n@@ -121,7 +121,7 @@ function createIpc<TIncoming, TOutgoing>(\n \n   // TODO(lukesandberg): some of the messages being sent are very large and contain lots\n   //  of redundant information.  Consider adding gzip compression to our stream.\n-  function doSend(message: any): Promise<void> {\n+  function doSend(message: string): Promise<void> {\n     return new Promise((resolve, reject) => {\n       // Reserve 4 bytes for our length prefix, we will over-write after encoding.\n       const packet = Buffer.from('0000' + message, 'utf8')"
        },
        {
            "sha": "6bfbbac60b550e02376618ce82b61845f6b5e708",
            "filename": "turbopack/crates/turbopack-node/js/src/transforms/postcss.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 17,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fpostcss.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fpostcss.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fpostcss.ts?ref=03a65fd786ae55e34d056e22581192f174356c7c",
            "patch": "@@ -10,25 +10,11 @@ import type { Processor } from 'postcss'\n import postcss from '@vercel/turbopack/postcss'\n // @ts-ignore\n import importedConfig from 'CONFIG'\n-import { relative, isAbsolute, sep } from 'path'\n-import type { Ipc } from '../ipc/evaluate'\n-import type { IpcInfoMessage, IpcRequestMessage } from './webpack-loaders'\n-\n-const contextDir = process.cwd()\n-\n-function toPath(file: string) {\n-  const relPath = relative(contextDir, file)\n-  if (isAbsolute(relPath)) {\n-    throw new Error(\n-      `Cannot depend on path (${file}) outside of root directory (${contextDir})`\n-    )\n-  }\n-  return sep !== '/' ? relPath.replaceAll(sep, '/') : relPath\n-}\n+import { getReadEnvVariables, toPath, type TransformIpc } from './transforms'\n \n let processor: Processor | undefined\n \n-export const init = async (ipc: Ipc<IpcInfoMessage, IpcRequestMessage>) => {\n+export const init = async (ipc: TransformIpc) => {\n   let config = importedConfig\n   if (typeof config === 'function') {\n     config = await config({ env: 'development' })\n@@ -76,7 +62,7 @@ export const init = async (ipc: Ipc<IpcInfoMessage, IpcRequestMessage>) => {\n }\n \n export default async function transform(\n-  ipc: Ipc<IpcInfoMessage, IpcRequestMessage>,\n+  ipc: TransformIpc,\n   cssContent: string,\n   name: string,\n   sourceMap: boolean\n@@ -134,6 +120,7 @@ export default async function transform(\n     filePaths,\n     directories,\n     buildFilePaths,\n+    envVariables: getReadEnvVariables(),\n   })\n   return {\n     css,"
        },
        {
            "sha": "f07aca33ad3d3a1585a6c48a4f89b6d165c380dc",
            "filename": "turbopack/crates/turbopack-node/js/src/transforms/transforms.ts",
            "status": "added",
            "additions": 74,
            "deletions": 0,
            "changes": 74,
            "blob_url": "https://github.com/vercel/next.js/blob/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Ftransforms.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Ftransforms.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Ftransforms.ts?ref=03a65fd786ae55e34d056e22581192f174356c7c",
            "patch": "@@ -0,0 +1,74 @@\n+/**\n+ * Shared utilities for our 2 transform implementations.\n+ */\n+\n+import type { Ipc } from '../ipc/evaluate'\n+import { relative, isAbsolute, join, sep } from 'path'\n+import { type StructuredError } from '../ipc'\n+import { type StackFrame } from '../compiled/stacktrace-parser'\n+\n+export type IpcInfoMessage =\n+  | {\n+      type: 'dependencies'\n+      envVariables?: string[]\n+      directories?: Array<[string, string]>\n+      filePaths?: string[]\n+      buildFilePaths?: string[]\n+    }\n+  | {\n+      type: 'emittedError'\n+      severity: 'warning' | 'error'\n+      error: StructuredError\n+    }\n+  | {\n+      type: 'log'\n+      logs: Array<{\n+        time: number\n+        logType: string\n+        args: any[]\n+        trace?: StackFrame[]\n+      }>\n+    }\n+\n+export type IpcRequestMessage = {\n+  type: 'resolve'\n+  options: any\n+  lookupPath: string\n+  request: string\n+}\n+\n+export type TransformIpc = Ipc<IpcInfoMessage, IpcRequestMessage>\n+\n+const contextDir = process.cwd()\n+export const toPath = (file: string) => {\n+  const relPath = relative(contextDir, file)\n+  if (isAbsolute(relPath)) {\n+    throw new Error(\n+      `Cannot depend on path (${file}) outside of root directory (${contextDir})`\n+    )\n+  }\n+  return sep !== '/' ? relPath.replaceAll(sep, '/') : relPath\n+}\n+export const fromPath = (path: string) => {\n+  return join(contextDir, sep !== '/' ? path.replaceAll('/', sep) : path)\n+}\n+\n+// Patch process.env to track which env vars are read\n+const originalEnv = process.env\n+const readEnvVars = new Set<string>()\n+process.env = new Proxy(originalEnv, {\n+  get(target, prop) {\n+    if (typeof prop === 'string') {\n+      // We register the env var as dependency on the\n+      // current transform and all future transforms\n+      // since the env var might be cached in module scope\n+      // and influence them all\n+      readEnvVars.add(prop)\n+    }\n+    return Reflect.get(target, prop)\n+  },\n+})\n+\n+export function getReadEnvVariables(): string[] {\n+  return Array.from(readEnvVars)\n+}"
        },
        {
            "sha": "36568d794681db0e6ddbc0773f619929d602ead2",
            "filename": "turbopack/crates/turbopack-node/js/src/transforms/webpack-loaders.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 62,
            "changes": 93,
            "blob_url": "https://github.com/vercel/next.js/blob/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts?ref=03a65fd786ae55e34d056e22581192f174356c7c",
            "patch": "@@ -3,19 +3,18 @@ declare const __turbopack_external_require__: {\n } & ((id: string, thunk: () => any, esm?: boolean) => any)\n \n import type { Ipc } from '../ipc/evaluate'\n-import {\n-  relative,\n-  isAbsolute,\n-  join,\n-  sep,\n-  dirname,\n-  resolve as pathResolve,\n-} from 'path'\n+import { dirname, resolve as pathResolve } from 'path'\n import {\n   StackFrame,\n   parse as parseStackTrace,\n } from '../compiled/stacktrace-parser'\n-import { type StructuredError } from 'src/ipc'\n+import { structuredError, type StructuredError } from '../ipc'\n+import {\n+  fromPath,\n+  getReadEnvVariables,\n+  toPath,\n+  type TransformIpc,\n+} from './transforms'\n \n export type IpcInfoMessage =\n   | {\n@@ -32,10 +31,12 @@ export type IpcInfoMessage =\n     }\n   | {\n       type: 'log'\n-      time: number\n-      logType: string\n-      args: any[]\n-      trace?: StackFrame[]\n+      logs: Array<{\n+        time: number\n+        logType: string\n+        args: any[]\n+        trace?: StackFrame[]\n+      }>\n     }\n \n export type IpcRequestMessage = {\n@@ -57,18 +58,6 @@ const {\n }: typeof import('loader-runner') = require('@vercel/turbopack/loader-runner')\n \n const contextDir = process.cwd()\n-const toPath = (file: string) => {\n-  const relPath = relative(contextDir, file)\n-  if (isAbsolute(relPath)) {\n-    throw new Error(\n-      `Cannot depend on path (${file}) outside of root directory (${contextDir})`\n-    )\n-  }\n-  return sep !== '/' ? relPath.replaceAll(sep, '/') : relPath\n-}\n-const fromPath = (path: string) => {\n-  return join(contextDir, sep !== '/' ? path.replaceAll('/', sep) : path)\n-}\n \n const LogType = Object.freeze({\n   error: 'error',\n@@ -155,24 +144,8 @@ type ResolveOptions = {\n   importFields?: string[]\n }\n \n-// Patch process.env to track which env vars are read\n-const originalEnv = process.env\n-const readEnvVars = new Set<string>()\n-process.env = new Proxy(originalEnv, {\n-  get(target, prop) {\n-    if (typeof prop === 'string' && !readEnvVars.has(prop)) {\n-      // We register the env var as dependency on the\n-      // current transform and all future transforms\n-      // since the env var might be cached in module scope\n-      // and influence them all\n-      readEnvVars.add(prop)\n-    }\n-    return Reflect.get(target, prop)\n-  },\n-})\n-\n const transform = (\n-  ipc: Ipc<IpcInfoMessage, IpcRequestMessage>,\n+  ipc: TransformIpc,\n   content: string | { binary: string },\n   name: string,\n   query: string,\n@@ -187,6 +160,13 @@ const transform = (\n       typeof loader === 'string' ? { loader, options: {} } : loader\n     )\n \n+    const logs: Array<{\n+      time: number\n+      logType: string\n+      args: unknown[]\n+      trace: StackFrame[] | undefined\n+    }> = []\n+\n     runLoaders(\n       {\n         resource: resource + query,\n@@ -337,7 +317,7 @@ const transform = (\n           emitError: makeErrorEmitter('error', ipc),\n           getLogger(name: unknown) {\n             const logFn = (logType: string, ...args: unknown[]) => {\n-              let trace\n+              let trace: StackFrame[] | undefined\n               switch (logType) {\n                 case LogType.warn:\n                 case LogType.error:\n@@ -354,10 +334,8 @@ const transform = (\n                   // TODO: do we need to handle this?\n                   break\n               }\n-              // TODO(lukesandberg): should we batch these and flush lazily?\n-              // turbopack just collects these and reports them when finishing the task.\n-              ipc.sendInfo({\n-                type: 'log',\n+              // Batch logs messages to be sent at the end\n+              logs.push({\n                 time: Date.now(),\n                 logType,\n                 args,\n@@ -464,9 +442,13 @@ const transform = (\n         },\n       },\n       (err, result) => {\n+        if (logs.length) {\n+          ipc.sendInfo({ type: 'log', logs: logs })\n+          logs.length = 0\n+        }\n         ipc.sendInfo({\n           type: 'dependencies',\n-          envVariables: Array.from(readEnvVars),\n+          envVariables: getReadEnvVariables(),\n           filePaths: result.fileDependencies.map(toPath),\n           directories: result.contextDependencies.map((dep) => [\n             toPath(dep),\n@@ -502,20 +484,7 @@ function makeErrorEmitter(\n     ipc.sendInfo({\n       type: 'emittedError',\n       severity: severity,\n-      error:\n-        error instanceof Error\n-          ? {\n-              name: error.name,\n-              message: error.message,\n-              stack: error.stack ? parseStackTrace(error.stack) : [],\n-              cause: undefined,\n-            }\n-          : {\n-              name: 'Error',\n-              message: error,\n-              stack: [],\n-              cause: undefined,\n-            },\n+      error: structuredError(error),\n     })\n   }\n }"
        },
        {
            "sha": "62e5a14679a79ecc9bc5d75d55daf90550e3ca68",
            "filename": "turbopack/crates/turbopack-node/src/transforms/postcss.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 10,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fpostcss.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fpostcss.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fpostcss.rs?ref=03a65fd786ae55e34d056e22581192f174356c7c",
            "patch": "@@ -33,7 +33,7 @@ use super::{\n     webpack::WebpackLoaderContext,\n };\n use crate::{\n-    embed_js::embed_file, execution_context::ExecutionContext,\n+    embed_js::embed_file_path, execution_context::ExecutionContext,\n     transforms::webpack::evaluate_webpack_loader,\n };\n \n@@ -410,15 +410,9 @@ async fn postcss_executor(\n         .await?;\n \n     Ok(asset_context.process(\n-        Vc::upcast(VirtualSource::new(\n-            postcss_config_path.join(\"transform.ts\".into()),\n-            AssetContent::File(\n-                embed_file(\"transforms/postcss.ts\".into())\n-                    .to_resolved()\n-                    .await?,\n-            )\n-            .cell(),\n-        )),\n+        Vc::upcast(FileSource::new(embed_file_path(\n+            \"transforms/postcss.ts\".into(),\n+        ))),\n         Value::new(ReferenceType::Internal(ResolvedVc::cell(fxindexmap! {\n             \"CONFIG\".into() => config_asset\n         }))),"
        },
        {
            "sha": "d618fd7bc5f797e9e1ff5727e58f37a0cce19669",
            "filename": "turbopack/crates/turbopack-node/src/transforms/webpack.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/03a65fd786ae55e34d056e22581192f174356c7c/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs?ref=03a65fd786ae55e34d056e22581192f174356c7c",
            "patch": "@@ -378,7 +378,9 @@ pub enum InfoMessage {\n         severity: IssueSeverity,\n         error: StructuredError,\n     },\n-    Log(LogInfo),\n+    Log {\n+        logs: Vec<LogInfo>,\n+    },\n }\n \n #[derive(Debug, Clone, TaskInput, Hash, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs)]\n@@ -546,8 +548,8 @@ impl EvaluateContext for WebpackLoaderContext {\n                 .resolved_cell()\n                 .emit();\n             }\n-            InfoMessage::Log(log) => {\n-                state.push(log);\n+            InfoMessage::Log { logs } => {\n+                state.extend(logs);\n             }\n         }\n         Ok(())"
        }
    ],
    "stats": {
        "total": 222,
        "additions": 124,
        "deletions": 98
    }
}