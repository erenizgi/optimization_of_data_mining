{
    "author": "kdy1",
    "message": "perf(turbopack): Remove extra indirection (#79553)\n\n### What?\n\nRemove `VisitorFactory` in favor of directly using `AstModifier`.\n\n### Why?\n\nWe don't need to allocate twice in this case.",
    "sha": "5f3868b284bbd9d1743cc4e9c4af37f441ff5f8e",
    "files": [
        {
            "sha": "8f39e6b8645ff9c8f6d7a66e4da0327b6121ad2e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/code_gen.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 19,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/5f3868b284bbd9d1743cc4e9c4af37f441ff5f8e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5f3868b284bbd9d1743cc4e9c4af37f441ff5f8e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs?ref=5f3868b284bbd9d1743cc4e9c4af37f441ff5f8e",
            "patch": "@@ -39,7 +39,7 @@ use crate::references::{\n pub struct CodeGeneration {\n     /// ast nodes matching the span will be visitor by the visitor\n     pub root_visitors: Vec<Box<dyn PassFactory>>,\n-    pub visitors: Vec<(Vec<AstParentKind>, Box<dyn VisitorFactory>)>,\n+    pub visitors: Vec<(Vec<AstParentKind>, Box<dyn AstModifier>)>,\n     pub hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n     pub early_hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n }\n@@ -53,7 +53,7 @@ impl CodeGeneration {\n \n     pub fn new(\n         root_visitors: Vec<Box<dyn PassFactory>>,\n-        visitors: Vec<(Vec<AstParentKind>, Box<dyn VisitorFactory>)>,\n+        visitors: Vec<(Vec<AstParentKind>, Box<dyn AstModifier>)>,\n         hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n         early_hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n     ) -> Self {\n@@ -72,7 +72,7 @@ impl CodeGeneration {\n         }\n     }\n \n-    pub fn visitors(visitors: Vec<(Vec<AstParentKind>, Box<dyn VisitorFactory>)>) -> Self {\n+    pub fn visitors(visitors: Vec<(Vec<AstParentKind>, Box<dyn AstModifier>)>) -> Self {\n         #[cfg(debug_assertions)]\n         for (path, _) in visitors.iter() {\n             if path.is_empty() {\n@@ -113,10 +113,6 @@ impl CodeGenerationHoistedStmt {\n     }\n }\n \n-pub trait VisitorFactory: Send + Sync {\n-    fn create<'a>(&'a self) -> Box<dyn AstModifier + 'a>;\n-}\n-\n pub trait PassFactory: Send + Sync {\n     fn create<'a>(&'a self) -> Box<dyn Pass + Send + Sync + 'a>;\n }\n@@ -279,16 +275,8 @@ macro_rules! create_visitor {\n             $name: T,\n         }\n \n-        impl<T: Fn(&mut swc_core::ecma::ast::$ty) + Send + Sync> $crate::code_gen::VisitorFactory\n-            for Box<Visitor<T>>\n-        {\n-            fn create<'a>(&'a self) -> Box<dyn $crate::code_gen::AstModifier + 'a> {\n-                Box::new(&**self)\n-            }\n-        }\n-\n-        impl<'a, T: Fn(&mut swc_core::ecma::ast::$ty) + Send + Sync> $crate::code_gen::AstModifier\n-            for &'a Visitor<T>\n+        impl<T: Fn(&mut swc_core::ecma::ast::$ty) + Send + Sync> $crate::code_gen::AstModifier\n+            for Visitor<T>\n         {\n             fn $name(&self, $arg: &mut swc_core::ecma::ast::$ty) {\n                 (self.$name)($arg);\n@@ -303,9 +291,9 @@ macro_rules! create_visitor {\n \n             (\n                 $ast_path,\n-                Box::new(Box::new(Visitor {\n+                Box::new(Visitor {\n                     $name: move |$arg: &mut swc_core::ecma::ast::$ty| $b,\n-                })) as Box<dyn $crate::code_gen::VisitorFactory>,\n+                }) as Box<dyn $crate::code_gen::AstModifier>,\n             )\n         }\n     }};"
        },
        {
            "sha": "d192af46f29392d8f805a9dcafda6e46246717f3",
            "filename": "turbopack/crates/turbopack-ecmascript/src/path_visitor.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 18,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/5f3868b284bbd9d1743cc4e9c4af37f441ff5f8e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fpath_visitor.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5f3868b284bbd9d1743cc4e9c4af37f441ff5f8e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fpath_visitor.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fpath_visitor.rs?ref=5f3868b284bbd9d1743cc4e9c4af37f441ff5f8e",
            "patch": "@@ -8,26 +8,26 @@ use swc_core::{\n     },\n };\n \n-use crate::code_gen::{ModifiableAst, VisitorFactory};\n+use crate::code_gen::{AstModifier, ModifiableAst};\n \n pub type AstPath = Vec<AstParentKind>;\n \n // Invariant: Each [AstPath] in `visitors` contains a value at position `index`.\n pub struct ApplyVisitors<'a, 'b> {\n     /// `VisitMut` should be shallow. In other words, it should not visit\n     /// children of the node.\n-    visitors: Cow<'b, [(&'a AstPath, &'a dyn VisitorFactory)]>,\n+    visitors: Cow<'b, [(&'a AstPath, &'a dyn AstModifier)]>,\n \n     index: usize,\n }\n \n /// Do two binary searches to find the sub-slice that has `path[index] == kind`.\n /// Returns None if no item matches that. `visitors` need to be sorted by path.\n fn find_range<'a, 'b>(\n-    visitors: &'b [(&'a AstPath, &'a dyn VisitorFactory)],\n+    visitors: &'b [(&'a AstPath, &'a dyn AstModifier)],\n     kind: &AstParentKind,\n     index: usize,\n-) -> Option<&'b [(&'a AstPath, &'a dyn VisitorFactory)]> {\n+) -> Option<&'b [(&'a AstPath, &'a dyn AstModifier)]> {\n     // Precondition: visitors is never empty\n     if visitors.first().unwrap().0[index] > *kind || visitors.last().unwrap().0[index] < *kind {\n         // Fast path: If ast path of the first visitor is already out of range, then we\n@@ -67,7 +67,7 @@ fn find_range<'a, 'b>(\n \n impl<'a> ApplyVisitors<'a, '_> {\n     /// `visitors` must have an non-empty [AstPath].\n-    pub fn new(mut visitors: Vec<(&'a AstPath, &'a dyn VisitorFactory)>) -> Self {\n+    pub fn new(mut visitors: Vec<(&'a AstPath, &'a dyn AstModifier)>) -> Self {\n         assert!(!visitors.is_empty());\n         visitors.sort_by_key(|(path, _)| *path);\n         Self {\n@@ -109,7 +109,7 @@ impl<'a> ApplyVisitors<'a, '_> {\n                         );\n                     }\n                     for (_, visitor) in visitors[..nested_visitors_start].iter() {\n-                        n.modify(&*visitor.create());\n+                        n.modify(&**visitor);\n                     }\n                     return;\n                 } else {\n@@ -172,8 +172,7 @@ mod tests {\n         testing::run_test,\n     };\n \n-    use super::{ApplyVisitors, VisitorFactory};\n-    use crate::code_gen::AstModifier;\n+    use super::{ApplyVisitors, AstModifier};\n \n     fn parse(fm: &SourceFile) -> Module {\n         let mut m = parse_file_as_module(\n@@ -198,20 +197,14 @@ mod tests {\n         to: &'a str,\n     }\n \n-    impl VisitorFactory for Box<StrReplacer<'_>> {\n-        fn create<'a>(&'a self) -> Box<dyn AstModifier + 'a> {\n-            Box::new(&**self)\n-        }\n-    }\n-\n-    impl AstModifier for &'_ StrReplacer<'_> {\n+    impl AstModifier for StrReplacer<'_> {\n         fn visit_mut_str(&self, s: &mut Str) {\n             s.value = s.value.replace(self.from, self.to).into();\n             s.raw = None;\n         }\n     }\n \n-    fn replacer(from: &'static str, to: &'static str) -> impl VisitorFactory {\n+    fn replacer(from: &'static str, to: &'static str) -> Box<dyn AstModifier + 'static> {\n         Box::new(StrReplacer { from, to })\n     }\n \n@@ -264,7 +257,7 @@ mod tests {\n \n                 let mut m = m.clone();\n                 m.visit_mut_with_ast_path(\n-                    &mut ApplyVisitors::new(vec![(&path, &bar_replacer)]),\n+                    &mut ApplyVisitors::new(vec![(&path, &*bar_replacer)]),\n                     &mut Default::default(),\n                 );\n \n@@ -289,7 +282,7 @@ mod tests {\n \n                 let mut m = m.clone();\n                 m.visit_mut_with_ast_path(\n-                    &mut ApplyVisitors::new(vec![(&wrong_path, &bar_replacer)]),\n+                    &mut ApplyVisitors::new(vec![(&wrong_path, &*bar_replacer)]),\n                     &mut Default::default(),\n                 );\n "
        }
    ],
    "stats": {
        "total": 55,
        "additions": 18,
        "deletions": 37
    }
}