{
    "author": "mischnic",
    "message": "Add test for output determinism (#86737)\n\nThese PRs are needed to get the test to pass\r\n- [x] https://github.com/vercel/next.js/pull/86736\r\n- [x] https://github.com/vercel/next.js/pull/86727\r\n- [x] https://github.com/vercel/next.js/pull/86769\r\n- [x] https://github.com/vercel/next.js/pull/86865",
    "sha": "24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
    "files": [
        {
            "sha": "d50f3977c27ae26d64913c26af8cfd4c02f0d1ce",
            "filename": "test/production/deterministic-build/app/app-page/client.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fapp-page%2Fclient.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fapp-page%2Fclient.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fapp-page%2Fclient.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export function Client() {\n+  return 'Client Reference'\n+}"
        },
        {
            "sha": "7d0bc84d736363148f76d8bc883f1e364e8c4eff",
            "filename": "test/production/deterministic-build/app/app-page/page.js",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fapp-page%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fapp-page%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fapp-page%2Fpage.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -1,3 +1,10 @@\n+import { Client } from './client'\n+\n export default function Page() {\n-  return 'app-page (node)'\n+  return (\n+    <>\n+      app-page (node)\n+      <Client />\n+    </>\n+  )\n }"
        },
        {
            "sha": "cfb11889fa262f0fbdc67c4c3f75f619aee29232",
            "filename": "test/production/deterministic-build/app/app-route/route.js",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fapp-route%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fapp-route%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fapp-route%2Froute.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -1,5 +1,3 @@\n export function GET() {\n   return new Response('app-route (node)')\n }\n-\n-export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "4d6fdccfface94ab05549429922bc210c48719a6",
            "filename": "test/production/deterministic-build/app/force-dynamic/app-page/edge/page.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-page%2Fedge%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-page%2Fedge%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-page%2Fedge%2Fpage.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -0,0 +1,5 @@\n+export default function Page() {\n+  return 'app-page (edge)'\n+}\n+\n+export const runtime = 'edge'"
        },
        {
            "sha": "ad1654219282e6e8a4480d135d9b04348d9e37c9",
            "filename": "test/production/deterministic-build/app/force-dynamic/app-page/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-page%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-page%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-page%2Fpage.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'app-page (node)'\n+}"
        },
        {
            "sha": "fc4a0205deaabee4276f68c35a4dddaccee087c8",
            "filename": "test/production/deterministic-build/app/force-dynamic/app-route/edge/route.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-route%2Fedge%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-route%2Fedge%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-route%2Fedge%2Froute.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -0,0 +1,5 @@\n+export function GET() {\n+  return new Response('app-route (edge)')\n+}\n+\n+export const runtime = 'edge'"
        },
        {
            "sha": "b01445578f89d004e7458f9723a53b31b2afb576",
            "filename": "test/production/deterministic-build/app/force-dynamic/app-route/route.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-route%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-route%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Fapp-route%2Froute.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -0,0 +1,5 @@\n+export function GET() {\n+  return new Response('app-route (node)')\n+}\n+\n+export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "08cbdfa07dffa86b0fa1d31d62e9a59daac1b850",
            "filename": "test/production/deterministic-build/app/force-dynamic/layout.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fapp%2Fforce-dynamic%2Flayout.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -0,0 +1,5 @@\n+export default function Layout({ children }) {\n+  return children\n+}\n+\n+export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "750eb927b198012c9652be0ed7c342f1dc6ec1d9",
            "filename": "test/production/deterministic-build/app/layout.js",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fapp%2Flayout.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -5,5 +5,3 @@ export default function Layout({ children }) {\n     </html>\n   )\n }\n-\n-export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "3ddb2c5c3b97e7acddc6413659da6139cffbbb30",
            "filename": "test/production/deterministic-build/deployment-id.test.ts",
            "status": "added",
            "additions": 116,
            "deletions": 0,
            "changes": 116,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fdeployment-id.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fdeployment-id.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fdeployment-id.test.ts?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -0,0 +1,116 @@\n+import { FileRef, NextInstance, nextTestSetup } from 'e2e-utils'\n+import path from 'path'\n+import { promisify } from 'util'\n+\n+import globOrig from 'glob'\n+import { diff } from 'jest-diff'\n+const glob = promisify(globOrig)\n+\n+// These are cosmetic files which aren't deployed.\n+const IGNORE = /trace|trace-build/\n+\n+async function readFiles(next: NextInstance) {\n+  const files = (\n+    (await glob('**/*', {\n+      cwd: path.join(next.testDir, next.distDir),\n+      nodir: true,\n+    })) as string[]\n+  )\n+    .filter((f) => !IGNORE.test(f))\n+    .sort()\n+\n+  return Promise.all(\n+    files.map(async (filePath) => {\n+      const content = next.readFileSync(path.join(next.distDir, filePath))\n+      return [filePath, content] as const\n+    })\n+  )\n+}\n+\n+// TODO we need to fix these case\n+// - static/chunks client chunks are content hashed and have the deployment id inlined\n+const IGNORE_NAME = /^static\\/chunks\\//\n+const IGNORE_CONTENT = new RegExp(\n+  [\n+    // These contain content-hashed browser or edge chunk urls (including the deployment id query param)\n+    '.*\\\\.html',\n+    '.*\\\\.rsc',\n+    'page_client-reference-manifest\\\\.js',\n+    // These contain the content-hashed browser chunk names (but they might not actually be deployed in the serverless function)\n+    '_buildManifest\\\\.js',\n+    'build-manifest\\\\.json',\n+    'client-build-manifest\\\\.json',\n+    'fallback-build-manifest\\\\.json',\n+    'middleware-build-manifest\\\\.js',\n+  ]\n+    .map((v) => '(?:\\\\/|^)' + v + '$')\n+    .join('|')\n+)\n+\n+// Webpack itself isn't deterministic\n+;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n+  'deterministic build - changing deployment id',\n+  () => {\n+    const { next } = nextTestSetup({\n+      files: {\n+        app: new FileRef(path.join(__dirname, 'app')),\n+        pages: new FileRef(path.join(__dirname, 'pages')),\n+        // TODO constant generateBuildId isn't entirely representative of the real world\n+        'next.config.js': `module.exports = {\n+          generateBuildId: async () => 'default-build-id',\n+          // Enable these when debugging to get readable diffs\n+          // experimental: {\n+          //   turbopackMinify: false,\n+          //   turbopackModuleIds: 'named',\n+          //   turbopackScopeHoisting: false,\n+          // },\n+        }`,\n+      },\n+      env: {\n+        NOW_BUILDER: '1',\n+      },\n+      skipStart: true,\n+    })\n+\n+    it('should produce identical build outputs even when changing deployment id', async () => {\n+      // First build\n+      next.env['NEXT_DEPLOYMENT_ID'] = 'foo-dpl-id'\n+      await next.build()\n+      let run1 = await readFiles(next)\n+\n+      // Second build\n+      next.env['NEXT_DEPLOYMENT_ID'] = 'bar-dpl-id'\n+      await next.build()\n+      let run2 = await readFiles(next)\n+\n+      run1 = run1.filter(([f, _]) => !IGNORE_NAME.test(f))\n+      run2 = run2.filter(([f, _]) => !IGNORE_NAME.test(f))\n+\n+      // First, compare file names\n+      let run1FileNames = run1.map(([f, _]) => f)\n+      let run2FileNames = run2.map(([f, _]) => f)\n+      expect(run1FileNames).toEqual(run2FileNames)\n+\n+      // Then, compare the file contents\n+      run1 = run1.filter(([f, _]) => !IGNORE_CONTENT.test(f))\n+      run2 = run2.filter(([f, _]) => !IGNORE_CONTENT.test(f))\n+\n+      let run1Map = new Map(run1)\n+      let run2Map = new Map(run2)\n+\n+      let errors = []\n+      for (const [fileName, content1] of run1Map) {\n+        const content2 = run2Map.get(fileName)\n+        if (content1 !== content2) {\n+          errors.push(\n+            `File content mismatch for ${fileName}\\n\\n` +\n+              diff(content1, content2)\n+          )\n+        }\n+      }\n+      if (errors.length > 0) {\n+        throw new Error(errors.join('\\n\\n'))\n+      }\n+    })\n+  }\n+)"
        },
        {
            "sha": "4a886c668aeb487d49816686f552e82d3ea9ef16",
            "filename": "test/production/deterministic-build/no-change.test.ts",
            "status": "renamed",
            "additions": 13,
            "deletions": 15,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fno-change.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fno-change.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fno-change.test.ts?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "patch": "@@ -27,10 +27,10 @@ function getNodeFileHashes(next: NextInstance): RouteFileHashRecords {\n }\n \n const nodeFilePaths = [\n-  'app/app-page/page',\n-  'app/app-route/route',\n+  'app/force-dynamic/app-page/page',\n+  'app/force-dynamic/app-route/route',\n   'pages/api/pages-api',\n-  'pages/pages-page',\n+  'pages/dynamic/pages-page',\n ]\n \n function getEdgeRouteFileHashes(next: NextInstance): RouteFileHashRecords {\n@@ -57,23 +57,23 @@ interface Runs {\n   run2: RouteFileHashRecords\n }\n \n-describe('deterministic build', () => {\n+describe('deterministic build - no-change build', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,\n     skipStart: true,\n   })\n \n-  const edgeBuildFileMd5Hashes: Runs = {\n-    run1: {},\n-    run2: {},\n-  }\n+  it('should have same md5 file across build', async () => {\n+    const edgeBuildFileMd5Hashes: Runs = {\n+      run1: {},\n+      run2: {},\n+    }\n \n-  const nodeBuildFileMd5Hashes: Runs = {\n-    run1: {},\n-    run2: {},\n-  }\n+    const nodeBuildFileMd5Hashes: Runs = {\n+      run1: {},\n+      run2: {},\n+    }\n \n-  beforeAll(async () => {\n     // First build\n     await next.build()\n     edgeBuildFileMd5Hashes.run1 = getEdgeRouteFileHashes(next)\n@@ -83,9 +83,7 @@ describe('deterministic build', () => {\n     await next.build()\n     edgeBuildFileMd5Hashes.run2 = getEdgeRouteFileHashes(next)\n     nodeBuildFileMd5Hashes.run2 = getNodeFileHashes(next)\n-  })\n \n-  it('should have same md5 file across build', async () => {\n     expect(edgeBuildFileMd5Hashes.run1).toEqual(edgeBuildFileMd5Hashes.run2)\n     expect(nodeBuildFileMd5Hashes.run1).toEqual(nodeBuildFileMd5Hashes.run2)\n   })",
            "previous_filename": "test/production/deterministic-build/index.test.ts"
        },
        {
            "sha": "a227e8796424f21a38211057083abaae852db5f1",
            "filename": "test/production/deterministic-build/pages/dynamic/pages-page/edge/index.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fpages%2Fdynamic%2Fpages-page%2Fedge%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fpages%2Fdynamic%2Fpages-page%2Fedge%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fpages%2Fdynamic%2Fpages-page%2Fedge%2Findex.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "previous_filename": "test/production/deterministic-build/pages/pages-page/edge/index.js"
        },
        {
            "sha": "fcfcc0a629ec79a7de69300bd1112c3a1c37a53a",
            "filename": "test/production/deterministic-build/pages/dynamic/pages-page/index.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fpages%2Fdynamic%2Fpages-page%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/24ccec0505c22c7cbe7c8f767e26aa56a6016e96/test%2Fproduction%2Fdeterministic-build%2Fpages%2Fdynamic%2Fpages-page%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeterministic-build%2Fpages%2Fdynamic%2Fpages-page%2Findex.js?ref=24ccec0505c22c7cbe7c8f767e26aa56a6016e96",
            "previous_filename": "test/production/deterministic-build/pages/pages-page/index.js"
        }
    ],
    "stats": {
        "total": 185,
        "additions": 165,
        "deletions": 20
    }
}