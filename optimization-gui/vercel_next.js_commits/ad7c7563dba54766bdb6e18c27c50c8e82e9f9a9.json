{
    "author": "lubieowoce",
    "message": "[Cache Components] allow using headers() in runtime prefetches (#83838)\n\nThis PR allows usage of `headers()` in runtime prefetches and private\ncaches. The implementation is basically analogous to `cookies()`.\n\nCloses NAR-353",
    "sha": "ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
    "files": [
        {
            "sha": "7ebad8e808308b8d961645034460120e74857857",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -676,6 +676,7 @@ async function generateRuntimePrefetchResult(\n     prerenderResumeDataCache,\n     renderResumeDataCache,\n     rootParams,\n+    requestStore.headers,\n     requestStore.cookies,\n     requestStore.draftMode\n   )\n@@ -686,6 +687,7 @@ async function generateRuntimePrefetchResult(\n     prerenderResumeDataCache,\n     renderResumeDataCache,\n     rootParams,\n+    requestStore.headers,\n     requestStore.cookies,\n     requestStore.draftMode,\n     onError\n@@ -707,6 +709,7 @@ async function prospectiveRuntimeServerPrerender(\n   prerenderResumeDataCache: PrerenderResumeDataCache | null,\n   renderResumeDataCache: RenderResumeDataCache | null,\n   rootParams: Params,\n+  headers: PrerenderStoreModernRuntime['headers'],\n   cookies: PrerenderStoreModernRuntime['cookies'],\n   draftMode: PrerenderStoreModernRuntime['draftMode']\n ) {\n@@ -757,6 +760,7 @@ async function prospectiveRuntimeServerPrerender(\n     // We only need task sequencing in the final prerender.\n     runtimeStagePromise: null,\n     // These are not present in regular prerenders, but allowed in a runtime prerender.\n+    headers,\n     cookies,\n     draftMode,\n   }\n@@ -842,6 +846,7 @@ async function finalRuntimeServerPrerender(\n   prerenderResumeDataCache: PrerenderResumeDataCache | null,\n   renderResumeDataCache: RenderResumeDataCache | null,\n   rootParams: Params,\n+  headers: PrerenderStoreModernRuntime['headers'],\n   cookies: PrerenderStoreModernRuntime['cookies'],\n   draftMode: PrerenderStoreModernRuntime['draftMode'],\n   onError: (err: unknown) => string | undefined\n@@ -892,6 +897,7 @@ async function finalRuntimeServerPrerender(\n     // Used to separate the \"Static\" stage from the \"Runtime\" stage.\n     runtimeStagePromise,\n     // These are not present in regular prerenders, but allowed in a runtime prerender.\n+    headers,\n     cookies,\n     draftMode,\n   }"
        },
        {
            "sha": "50870fa103c64be7571bbd07922fe26d21c2ece2",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -120,6 +120,7 @@ export interface PrerenderStoreModernRuntime\n    */\n   readonly runtimeStagePromise: Promise<void> | null\n \n+  readonly headers: RequestStore['headers']\n   readonly cookies: RequestStore['cookies']\n   readonly draftMode: RequestStore['draftMode']\n }\n@@ -294,10 +295,7 @@ export interface PrivateUseCacheStore extends CommonUseCacheStore {\n    */\n   readonly runtimeStagePromise: Promise<void> | null\n \n-  /**\n-   * As opposed to the public cache store, the private cache store is allowed to\n-   * access the request cookies.\n-   */\n+  readonly headers: ReadonlyHeaders\n   readonly cookies: ReadonlyRequestCookies\n \n   /**"
        },
        {
            "sha": "269484074262daf097717b720d8fa8d1674f8e77",
            "filename": "packages/next/src/server/request/cookies.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -126,10 +126,11 @@ export function cookies(): Promise<ReadonlyRequestCookies> {\n             makeUntrackedCookies(workUnitStore.cookies)\n           )\n         case 'private-cache':\n+          // Private caches are delayed until the runtime stage in use-cache-wrapper,\n+          // so we don't need an additional delay here.\n           if (process.env.__NEXT_CACHE_COMPONENTS) {\n             return makeUntrackedCookies(workUnitStore.cookies)\n           }\n-\n           return makeUntrackedExoticCookies(workUnitStore.cookies)\n         case 'request':\n           trackDynamicDataInDynamicRender(workUnitStore)"
        },
        {
            "sha": "aad290f479068cd9549a411b522f295387604c03",
            "filename": "packages/next/src/server/request/headers.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 9,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -12,6 +12,7 @@ import {\n   type PrerenderStoreModern,\n } from '../app-render/work-unit-async-storage.external'\n import {\n+  delayUntilRuntimeStage,\n   postponeWithTracking,\n   throwToInterruptStaticGeneration,\n   trackDynamicDataInDynamicRender,\n@@ -92,20 +93,13 @@ export function headers(): Promise<ReadonlyHeaders> {\n           workStore.invalidDynamicUsageError ??= error\n           throw error\n         }\n-        case 'private-cache': {\n-          const error = new Error(\n-            `Route ${workStore.route} used \"headers\" inside \"use cache: private\". Accessing \"headers\" inside a private cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n-          )\n-          Error.captureStackTrace(error, headers)\n-          workStore.invalidDynamicUsageError ??= error\n-          throw error\n-        }\n         case 'unstable-cache':\n           throw new Error(\n             `Route ${workStore.route} used \"headers\" inside a function cached with \"unstable_cache(...)\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/app/api-reference/functions/unstable_cache`\n           )\n         case 'prerender':\n         case 'prerender-client':\n+        case 'private-cache':\n         case 'prerender-runtime':\n         case 'prerender-ppr':\n         case 'prerender-legacy':\n@@ -125,7 +119,6 @@ export function headers(): Promise<ReadonlyHeaders> {\n     if (workUnitStore) {\n       switch (workUnitStore.type) {\n         case 'prerender':\n-        case 'prerender-runtime':\n           return makeHangingHeaders(workStore, workUnitStore)\n         case 'prerender-client':\n           const exportName = '`headers`'\n@@ -152,6 +145,18 @@ export function headers(): Promise<ReadonlyHeaders> {\n             workStore,\n             workUnitStore\n           )\n+        case 'prerender-runtime':\n+          return delayUntilRuntimeStage(\n+            workUnitStore,\n+            makeUntrackedHeaders(workUnitStore.headers)\n+          )\n+        case 'private-cache':\n+          // Private caches are delayed until the runtime stage in use-cache-wrapper,\n+          // so we don't need an additional delay here.\n+          if (process.env.__NEXT_CACHE_COMPONENTS) {\n+            return makeUntrackedHeaders(workUnitStore.headers)\n+          }\n+          return makeUntrackedExoticHeaders(workUnitStore.headers)\n         case 'request':\n           trackDynamicDataInDynamicRender(workUnitStore)\n "
        },
        {
            "sha": "85a505d0e50e683b26b9971e991510f50480f54a",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -211,6 +211,7 @@ function createUseCacheStore(\n         outerWorkUnitStore\n       ),\n       rootParams: outerWorkUnitStore.rootParams,\n+      headers: outerWorkUnitStore.headers,\n       cookies: outerWorkUnitStore.cookies,\n     }\n   } else {"
        },
        {
            "sha": "4875e6c6616c14410e39a60b06012cc44e870928",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 57,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -3406,63 +3406,6 @@ describe('Cache Components Errors', () => {\n           })\n         }\n       })\n-\n-      describe('with `headers()`', () => {\n-        if (isNextDev) {\n-          it('should show a redbox error', async () => {\n-            const browser = await next.browser('/use-cache-private-headers')\n-\n-            if (isTurbopack) {\n-              await expect(browser).toDisplayRedbox(`\n-               {\n-                 \"description\": \"Route /use-cache-private-headers used \"headers\" inside \"use cache: private\". Accessing \"headers\" inside a private cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n-                 \"environmentLabel\": null,\n-                 \"label\": \"Runtime Error\",\n-                 \"source\": \"app/use-cache-private-headers/page.tsx (25:18) @ Private\n-               > 25 |     await headers()\n-                    |                  ^\",\n-                 \"stack\": [\n-                   \"Private app/use-cache-private-headers/page.tsx (25:18)\",\n-                 ],\n-               }\n-              `)\n-            } else {\n-              await expect(browser).toDisplayRedbox(`\n-               {\n-                 \"description\": \"Route /use-cache-private-headers used \"headers\" inside \"use cache: private\". Accessing \"headers\" inside a private cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n-                 \"environmentLabel\": null,\n-                 \"label\": \"Runtime Error\",\n-                 \"source\": \"app/use-cache-private-headers/page.tsx (25:18) @ Private\n-               > 25 |     await headers()\n-                    |                  ^\",\n-                 \"stack\": [\n-                   \"Private app/use-cache-private-headers/page.tsx (25:18)\",\n-                 ],\n-               }\n-              `)\n-            }\n-          })\n-        } else {\n-          // TODO: With prefetch sentinels this should yield a build error.\n-          it('should not fail the build and show no runtime error (caught in userland)', async () => {\n-            await prerender('/use-cache-private-headers')\n-            await next.start({ skipBuild: true })\n-            cliOutputLength = next.cliOutput.length\n-\n-            const browser = await next.browser('/use-cache-private-headers', {\n-              pushErrorAsConsoleLog: true,\n-            })\n-\n-            expect(await browser.elementById('private').text()).toBe('Private')\n-\n-            expect(await browser.log()).not.toContainEqual(\n-              expect.objectContaining({ source: 'error' })\n-            )\n-\n-            expect(next.cliOutput.slice(cliOutputLength)).not.toInclude('Error')\n-          })\n-        }\n-      })\n     })\n \n     describe('Sync IO - Current Time - Date()', () => {"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-headers/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Flayout.tsx?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -1,9 +0,0 @@\n-export default function Root({ children }: { children: React.ReactNode }) {\n-  return (\n-    <html>\n-      <body>\n-        <main>{children}</main>\n-      </body>\n-    </html>\n-  )\n-}"
        },
        {
            "sha": "ea3db2a9b0f2b418c1d35202376b9a606618beed",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-headers/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 29,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Fpage.tsx?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -1,29 +0,0 @@\n-import { headers } from 'next/headers'\n-import { Suspense } from 'react'\n-\n-export default function Page() {\n-  return (\n-    <>\n-      <p>\n-        This page uses `headers()` inside `'use cache: private'`, which triggers\n-        an error at runtime.\n-      </p>\n-      <Suspense fallback={<p>Loading...</p>}>\n-        <Private />\n-      </Suspense>\n-    </>\n-  )\n-}\n-\n-async function Private() {\n-  'use cache: private'\n-\n-  // Reading headers in a cache context is not allowed. We're try/catching here\n-  // to ensure that, in dev mode, this error is shown even when it's caught in\n-  // userland.\n-  try {\n-    await headers()\n-  } catch {}\n-\n-  return <p id=\"private\">Private</p>\n-}"
        },
        {
            "sha": "e28378a63b623405800b7064cb0bcecefe772cc5",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/errors/page.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Ferrors%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Ferrors%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Ferrors%2Fpage.tsx?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -23,6 +23,12 @@ export default async function Page() {\n             prefetch={true}\n           />\n         </li>\n+        <li>\n+          <DebugLinkAccordion\n+            href=\"/errors/sync-io-after-runtime-api/headers\"\n+            prefetch={true}\n+          />\n+        </li>\n         <li>\n           <DebugLinkAccordion\n             href=\"/errors/sync-io-after-runtime-api/dynamic-params/123\""
        },
        {
            "sha": "e411e577e84ba8f6f96de4ea143c52e54d0acef2",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/errors/sync-io-after-runtime-api/headers/page.tsx",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Ferrors%2Fsync-io-after-runtime-api%2Fheaders%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Ferrors%2Fsync-io-after-runtime-api%2Fheaders%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Ferrors%2Fsync-io-after-runtime-api%2Fheaders%2Fpage.tsx?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -0,0 +1,23 @@\n+import { headers } from 'next/headers'\n+import { Suspense } from 'react'\n+import { DebugRenderKind } from '../../../../shared'\n+\n+export default async function Page() {\n+  return (\n+    <main>\n+      <DebugRenderKind />\n+      <p id=\"intro\">\n+        This page performs sync IO after a headers() call, so we should only see\n+        the error in a runtime prefetch\n+      </p>\n+      <Suspense fallback={<div style={{ color: 'grey' }}>Loading 1...</div>}>\n+        <RuntimePrefetchable />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function RuntimePrefetchable() {\n+  await headers()\n+  return <div id=\"timestamp\">Timestamp: {Date.now()}</div>\n+}"
        },
        {
            "sha": "22b40e7af4bfc11c66db3534356e1657c71c26dc",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-page/headers/page.tsx",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fheaders%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fheaders%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fheaders%2Fpage.tsx?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -0,0 +1,45 @@\n+import { headers } from 'next/headers'\n+import { Suspense } from 'react'\n+import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../shared'\n+import { connection } from 'next/server'\n+\n+export const unstable_prefetch = 'unstable_runtime'\n+\n+export default async function Page() {\n+  return (\n+    <main>\n+      <DebugRenderKind />\n+      <p>\n+        This page uses headers and some uncached IO, so parts of it should be\n+        runtime-prefetchable.\n+      </p>\n+      <Suspense fallback={<div style={{ color: 'grey' }}>Loading 1...</div>}>\n+        <RuntimePrefetchable />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function RuntimePrefetchable() {\n+  const headersStore = await headers()\n+  const headerValue = headersStore.get('host') === null ? 'missing' : 'present'\n+  await cachedDelay([__filename, headerValue])\n+  return (\n+    <div style={{ border: '1px solid blue', padding: '1em' }}>\n+      <div id=\"header-value\">{`Header: ${headerValue}`}</div>\n+      <Suspense fallback={<div style={{ color: 'grey' }}>Loading 2...</div>}>\n+        <Dynamic />\n+      </Suspense>\n+    </div>\n+  )\n+}\n+\n+async function Dynamic() {\n+  await uncachedIO()\n+  await connection()\n+  return (\n+    <div style={{ border: '1px solid tomato', padding: '1em' }}>\n+      <div id=\"dynamic-content\">Dynamic content</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "947bfe37f57e7c6a269c6124f5d5e43a8df14139",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-private-cache/headers/page.tsx",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fheaders%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fheaders%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fheaders%2Fpage.tsx?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -0,0 +1,51 @@\n+import { headers } from 'next/headers'\n+import { Suspense } from 'react'\n+import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../shared'\n+import { connection } from 'next/server'\n+\n+export const unstable_prefetch = 'unstable_runtime'\n+\n+export default async function Page() {\n+  return (\n+    <main>\n+      <DebugRenderKind />\n+      <p>\n+        This page uses headers (from inside a private cache) and some uncached\n+        IO, so parts of it should be runtime-prefetchable.\n+      </p>\n+      <Suspense fallback={<div style={{ color: 'grey' }}>Loading 1...</div>}>\n+        <RuntimePrefetchable />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function RuntimePrefetchable() {\n+  const headerValue = await privateCache()\n+  return (\n+    <div style={{ border: '1px solid blue', padding: '1em' }}>\n+      <div id=\"header-value\">{`Header: ${headerValue}`}</div>\n+      <Suspense fallback={<div style={{ color: 'grey' }}>Loading 2...</div>}>\n+        <Dynamic />\n+      </Suspense>\n+    </div>\n+  )\n+}\n+\n+async function privateCache() {\n+  'use cache: private'\n+  const headersStore = await headers()\n+  const headerValue = headersStore.get('host') === null ? 'missing' : 'present'\n+  await cachedDelay([__filename, headerValue])\n+  return headerValue\n+}\n+\n+async function Dynamic() {\n+  await uncachedIO()\n+  await connection()\n+  return (\n+    <div style={{ border: '1px solid tomato', padding: '1em' }}>\n+      <div id=\"dynamic-content\">Dynamic content</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "c8042f4d3c0888388b74096096cc4f1464d0ebac",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/page.tsx",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpage.tsx?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -16,6 +16,15 @@ export default async function Page() {\n           </ul>\n         </li>\n \n+        <li>\n+          headers + dynamic content\n+          <ul>\n+            <li>\n+              <DebugLinkAccordion href=\"/in-page/headers\" />\n+            </li>\n+          </ul>\n+        </li>\n+\n         <li>\n           search params + dynamic content\n           <ul>\n@@ -60,6 +69,14 @@ export default async function Page() {\n             </li>\n           </ul>\n         </li>\n+        <li>\n+          headers in private cache + dynamic content\n+          <ul>\n+            <li>\n+              <DebugLinkAccordion href=\"/in-private-cache/headers\" />\n+            </li>\n+          </ul>\n+        </li>\n         <li>\n           dynamic params in private cache + dynamic content\n           <ul>\n@@ -112,6 +129,14 @@ export default async function Page() {\n             </li>\n           </ul>\n         </li>\n+        <li>\n+          headers() promise passed to public cache + dynamic content\n+          <ul>\n+            <li>\n+              <DebugLinkAccordion href=\"/passed-to-public-cache/headers\" />\n+            </li>\n+          </ul>\n+        </li>\n         <li>\n           dynamic params promise passed to public cache + dynamic content\n           <ul>"
        },
        {
            "sha": "d278f9f78f3381af15a811bb497dfb1f1e31a578",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/passed-to-public-cache/headers/page.tsx",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fheaders%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fheaders%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fheaders%2Fpage.tsx?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -0,0 +1,57 @@\n+import { headers } from 'next/headers'\n+import { Suspense } from 'react'\n+import { cachedDelay, DebugRenderKind } from '../../../shared'\n+import { connection } from 'next/server'\n+\n+export const unstable_prefetch = 'unstable_runtime'\n+\n+export default async function Page() {\n+  return (\n+    <main>\n+      <DebugRenderKind />\n+      <p>\n+        This page passes headers to a public cache, and uses some uncached IO,\n+        so parts of it should be prefetchable with a runtime prefetch.\n+      </p>\n+      <Suspense fallback={<div style={{ color: 'grey' }}>Loading 1...</div>}>\n+        <RuntimePrefetchable />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function RuntimePrefetchable() {\n+  await headers() // Guard from being statically prerendered, which would make the cache hang\n+\n+  // We've already awaited headers, but we still want to make sure\n+  // that the cache doesn't consider them a hanging promise\n+  const headerValue = await publicCache(\n+    headers().then((headersStore) =>\n+      headersStore.get('host') === null ? 'missing' : 'present'\n+    )\n+  )\n+  return (\n+    <div style={{ border: '1px solid blue', padding: '1em' }}>\n+      <div id=\"header-value\">{`Header: ${headerValue}`}</div>\n+      <Suspense fallback={<div style={{ color: 'grey' }}>Loading 2...</div>}>\n+        <Dynamic />\n+      </Suspense>\n+    </div>\n+  )\n+}\n+\n+async function publicCache(headerPromise: Promise<string>) {\n+  'use cache'\n+  const headerValue = await headerPromise\n+  await cachedDelay([__filename, headerValue])\n+  return headerValue\n+}\n+\n+async function Dynamic() {\n+  await connection()\n+  return (\n+    <div style={{ border: '1px solid tomato', padding: '1em' }}>\n+      <div id=\"dynamic-content\">Dynamic content</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "873a8457daf96bc1c76a6814fe45e8b79a60737c",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/prefetch-runtime.test.ts",
            "status": "modified",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts?ref=ad7c7563dba54766bdb6e18c27c50c8e82e9f9a9",
            "patch": "@@ -376,6 +376,59 @@ describe('runtime prefetching', () => {\n       )\n     })\n \n+    it('includes headers, but not dynamic content', async () => {\n+      let page: Playwright.Page\n+      const browser = await next.browser('/', {\n+        beforePageLoad(p: Playwright.Page) {\n+          page = p\n+        },\n+      })\n+      const act = createRouterAct(page)\n+\n+      // Reveal the link to trigger a runtime prefetch for one value of the search param\n+      await act(async () => {\n+        const linkToggle = await browser.elementByCss(\n+          `input[data-link-accordion=\"/${prefix}/headers\"]`\n+        )\n+        await linkToggle.click()\n+      }, [\n+        // Should allow reading headers\n+        {\n+          includes: 'Header: present',\n+        },\n+        // Should not prefetch the dynamic content\n+        {\n+          includes: 'Dynamic content',\n+          block: 'reject',\n+        },\n+      ])\n+\n+      // Navigate to the page\n+      await act(async () => {\n+        await act(\n+          async () => {\n+            await browser.elementByCss(`a[href=\"/${prefix}/headers\"]`).click()\n+          },\n+          {\n+            // Temporarily block the navigation request.\n+            // The runtime-prefetched parts of the tree should be visible before it finishes.\n+            includes: 'Dynamic content',\n+            block: true,\n+          }\n+        )\n+        expect(await browser.elementById('header-value').text()).toEqual(\n+          'Header: present'\n+        )\n+      })\n+      // After navigating, we should see both the parts that we prefetched and dynamic content.\n+      expect(await browser.elementById('header-value').text()).toEqual(\n+        'Header: present'\n+      )\n+      expect(await browser.elementById('dynamic-content').text()).toEqual(\n+        'Dynamic content'\n+      )\n+    })\n+\n     it('includes cookies, but not dynamic content', async () => {\n       let page: Playwright.Page\n       const browser = await next.browser('/', {\n@@ -983,6 +1036,10 @@ describe('runtime prefetching', () => {\n         description: 'when sync IO is used after awaiting cookies()',\n         path: '/errors/sync-io-after-runtime-api/cookies',\n       },\n+      {\n+        description: 'when sync IO is used after awaiting headers()',\n+        path: '/errors/sync-io-after-runtime-api/headers',\n+      },\n       // TODO(dynamic-ppr):\n       // A tree prefetch for \"/dynamic-params/123\" currently causes it to be prerendered on demand,\n       // meaning that we end up statically prerendering it with all the params included."
        }
    ],
    "stats": {
        "total": 398,
        "additions": 289,
        "deletions": 109
    }
}